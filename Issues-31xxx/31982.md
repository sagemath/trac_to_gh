# Issue 31982: MultiCoordFunction: Make it the element class of the free module over ChartFunctionRing

archive/issues_031745.json:
```json
{
    "body": "Currently, `MultiCoordFunction` is not an element class.\n\n```\nsage: M = Manifold(2, 'M', structure='topological')\nsage: X.<x,y> = M.chart()\nsage: FR = X.function_ring()\nsage: f = X.multifunction(x+y, sin(x*y), x^2 + 3*y); f\nCoordinate functions (x + y, sin(x*y), x^2 + 3*y) on the Chart (M, (x, y))\nsage: f.parent()\n<class 'sage.manifolds.chart_func.MultiCoordFunction'>\nsage: FR^3                                                 # with #31721\nAmbient free module of rank 3 over Ring of chart functions on Chart (M, (x, y))\nsage: f in FR^3\nFalse\n```\n\nWe change the function `sage.modules.free_module.element_class` so that it uses the element class `Vector_symbolic_dense` not only for free modules over the ring `SR` but also for free modules over any commutative ring whose base ring is `SR`.\n\nIn fact, we dispatch through a new method `_free_module_element_class_dense`. `ChartFunction` provides a specialized implementation, which makes sure that `MultiCoordFunction` (now a subclass of `Vector_symbolic_dense`) is used as the element class.\n\nThis simplifies the implementation of `MultiCoordFunction` and also  makes the elementwise symbolic methods `simplify` etc. available.\n\n\nFollow-up:\n- We could move the method `MultiCoordFunction.jacobian` to the superclass, making it more generally available.\n\n\nCC:  @egourgoulhon @mjungmath @tscrim\n\nWork_Issues: rebase on #31999; fix pickling issue\n\nAuthor: Matthias Koeppe\n\nBranch: u/mkoeppe/multicoordfunction__make_it_the_element_class_of_the_free_module_over_chartfunctionring\n\nStatus: needs_work\n\nDependencies: #31721, #31999\n\nCommit: fb318025fc34666c8d78a40459c2e31cf9e83ea1\n\nIssue created by migration from https://trac.sagemath.org/ticket/31982\n\n",
    "created_at": "2021-06-14T01:27:38Z",
    "labels": [
        "component: manifolds"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "MultiCoordFunction: Make it the element class of the free module over ChartFunctionRing",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31982",
    "user": "https://github.com/mkoeppe"
}
```
Currently, `MultiCoordFunction` is not an element class.

```
sage: M = Manifold(2, 'M', structure='topological')
sage: X.<x,y> = M.chart()
sage: FR = X.function_ring()
sage: f = X.multifunction(x+y, sin(x*y), x^2 + 3*y); f
Coordinate functions (x + y, sin(x*y), x^2 + 3*y) on the Chart (M, (x, y))
sage: f.parent()
<class 'sage.manifolds.chart_func.MultiCoordFunction'>
sage: FR^3                                                 # with #31721
Ambient free module of rank 3 over Ring of chart functions on Chart (M, (x, y))
sage: f in FR^3
False
```

We change the function `sage.modules.free_module.element_class` so that it uses the element class `Vector_symbolic_dense` not only for free modules over the ring `SR` but also for free modules over any commutative ring whose base ring is `SR`.

In fact, we dispatch through a new method `_free_module_element_class_dense`. `ChartFunction` provides a specialized implementation, which makes sure that `MultiCoordFunction` (now a subclass of `Vector_symbolic_dense`) is used as the element class.

This simplifies the implementation of `MultiCoordFunction` and also  makes the elementwise symbolic methods `simplify` etc. available.


Follow-up:
- We could move the method `MultiCoordFunction.jacobian` to the superclass, making it more generally available.


CC:  @egourgoulhon @mjungmath @tscrim

Work_Issues: rebase on #31999; fix pickling issue

Author: Matthias Koeppe

Branch: u/mkoeppe/multicoordfunction__make_it_the_element_class_of_the_free_module_over_chartfunctionring

Status: needs_work

Dependencies: #31721, #31999

Commit: fb318025fc34666c8d78a40459c2e31cf9e83ea1

Issue created by migration from https://trac.sagemath.org/ticket/31982





---

archive/issue_comments_636292.json:
```json
{
    "body": "Changing branch from \"\" to \"u/mkoeppe/multicoordfunction__make_it_the_element_class_of_the_free_module_over_chartfunctionring\"",
    "created_at": "2021-06-14T02:01:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31982#issuecomment-636292",
    "user": "https://github.com/mkoeppe"
}
```

Changing branch from "" to "u/mkoeppe/multicoordfunction__make_it_the_element_class_of_the_free_module_over_chartfunctionring"



---

archive/issue_comments_636293.json:
```json
{
    "body": "Changing commit from \"\" to \"dbfe7ac1fe65a76f8e61a6632b9ad9a096f1cf69\"",
    "created_at": "2021-06-14T02:27:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31982#issuecomment-636293",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "" to "dbfe7ac1fe65a76f8e61a6632b9ad9a096f1cf69"



---

archive/issue_comments_636294.json:
```json
{
    "body": "<a id='comment:2'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                                                                                                 |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------|\n|[dbfe7ac](https://git.sagemath.org/sage.git/commit/?id=dbfe7ac1fe65a76f8e61a6632b9ad9a096f1cf69)|`src/sage/modules/free_module.py: Update copyright years according to 'git blame -w --date=format:%Y src/sage/modules/free_module.py | sort -k2'`|",
    "created_at": "2021-06-14T02:27:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31982#issuecomment-636294",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                                                                                                 |
|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------|
|[dbfe7ac](https://git.sagemath.org/sage.git/commit/?id=dbfe7ac1fe65a76f8e61a6632b9ad9a096f1cf69)|`src/sage/modules/free_module.py: Update copyright years according to 'git blame -w --date=format:%Y src/sage/modules/free_module.py | sort -k2'`|



---

archive/issue_comments_636295.json:
```json
{
    "body": "Changing commit from \"dbfe7ac1fe65a76f8e61a6632b9ad9a096f1cf69\" to \"cfd813b06b7973cc1acc9d3055f192a584326662\"",
    "created_at": "2021-06-14T03:17:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31982#issuecomment-636295",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "dbfe7ac1fe65a76f8e61a6632b9ad9a096f1cf69" to "cfd813b06b7973cc1acc9d3055f192a584326662"



---

archive/issue_comments_636296.json:
```json
{
    "body": "<a id='comment:3'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                                                                              |\n|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------|\n|[cfd813b](https://git.sagemath.org/sage.git/commit/?id=cfd813b06b7973cc1acc9d3055f192a584326662)|`sage.modules.free_module.element_class: For rings with SR base ring, delegate to new method _free_module_element_class_dense`|",
    "created_at": "2021-06-14T03:17:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31982#issuecomment-636296",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                                                                              |
|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------|
|[cfd813b](https://git.sagemath.org/sage.git/commit/?id=cfd813b06b7973cc1acc9d3055f192a584326662)|`sage.modules.free_module.element_class: For rings with SR base ring, delegate to new method _free_module_element_class_dense`|



---

archive/issue_comments_636297.json:
```json
{
    "body": "<a id='comment:4'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                   |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------|\n|[278aa2b](https://git.sagemath.org/sage.git/commit/?id=278aa2b389783b3500797ddf235b8c7c41872244)|`CallableSymbolicExpressionRing_class: Fix doctest`|",
    "created_at": "2021-06-14T03:21:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31982#issuecomment-636297",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                   |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------|
|[278aa2b](https://git.sagemath.org/sage.git/commit/?id=278aa2b389783b3500797ddf235b8c7c41872244)|`CallableSymbolicExpressionRing_class: Fix doctest`|



---

archive/issue_comments_636298.json:
```json
{
    "body": "Changing commit from \"cfd813b06b7973cc1acc9d3055f192a584326662\" to \"278aa2b389783b3500797ddf235b8c7c41872244\"",
    "created_at": "2021-06-14T03:21:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31982#issuecomment-636298",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "cfd813b06b7973cc1acc9d3055f192a584326662" to "278aa2b389783b3500797ddf235b8c7c41872244"



---

archive/issue_comments_636299.json:
```json
{
    "body": "Changing commit from \"278aa2b389783b3500797ddf235b8c7c41872244\" to \"7bbb5f840b6c1fa5f8842b22efda9f01daa0f540\"",
    "created_at": "2021-06-14T05:50:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31982#issuecomment-636299",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "278aa2b389783b3500797ddf235b8c7c41872244" to "7bbb5f840b6c1fa5f8842b22efda9f01daa0f540"



---

archive/issue_comments_636300.json:
```json
{
    "body": "<a id='comment:5'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                              |\n|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------|\n|[7bbb5f8](https://git.sagemath.org/sage.git/commit/?id=7bbb5f840b6c1fa5f8842b22efda9f01daa0f540)|`MultiCoordFunction: Make it an element class`|",
    "created_at": "2021-06-14T05:50:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31982#issuecomment-636300",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                              |
|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------|
|[7bbb5f8](https://git.sagemath.org/sage.git/commit/?id=7bbb5f840b6c1fa5f8842b22efda9f01daa0f540)|`MultiCoordFunction: Make it an element class`|



---

archive/issue_comments_636301.json:
```json
{
    "body": "<a id='comment:6'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                        |\n|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------|\n|[fa5057c](https://git.sagemath.org/sage.git/commit/?id=fa5057ce25fcc2d7dc6e7d22a9881470f341fe7a)|`Trac 31721: __pow__ method for parents`|\n|[27422d3](https://git.sagemath.org/sage.git/commit/?id=27422d323a7db31f3fc2068f6aeb3100b3e4d6ae)|`31721: more comments`|\n|[e8d3427](https://git.sagemath.org/sage.git/commit/?id=e8d34270e0b74d33776f958360a0cdad60a0b74c)|`clarify comment and doctest for multiple inheritance`|\n|[b873bcb](https://git.sagemath.org/sage.git/commit/?id=b873bcbe33571dc020c08b05c0390777148b1b53)|`some doc`|\n|[27e3889](https://git.sagemath.org/sage.git/commit/?id=27e3889566fe6e1559c1b4e75c4ec180e8523ae4)|`Merge #31721`|",
    "created_at": "2021-06-14T05:51:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31982#issuecomment-636301",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                        |
|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------|
|[fa5057c](https://git.sagemath.org/sage.git/commit/?id=fa5057ce25fcc2d7dc6e7d22a9881470f341fe7a)|`Trac 31721: __pow__ method for parents`|
|[27422d3](https://git.sagemath.org/sage.git/commit/?id=27422d323a7db31f3fc2068f6aeb3100b3e4d6ae)|`31721: more comments`|
|[e8d3427](https://git.sagemath.org/sage.git/commit/?id=e8d34270e0b74d33776f958360a0cdad60a0b74c)|`clarify comment and doctest for multiple inheritance`|
|[b873bcb](https://git.sagemath.org/sage.git/commit/?id=b873bcbe33571dc020c08b05c0390777148b1b53)|`some doc`|
|[27e3889](https://git.sagemath.org/sage.git/commit/?id=27e3889566fe6e1559c1b4e75c4ec180e8523ae4)|`Merge #31721`|



---

archive/issue_comments_636302.json:
```json
{
    "body": "Changing commit from \"7bbb5f840b6c1fa5f8842b22efda9f01daa0f540\" to \"27e3889566fe6e1559c1b4e75c4ec180e8523ae4\"",
    "created_at": "2021-06-14T05:51:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31982#issuecomment-636302",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "7bbb5f840b6c1fa5f8842b22efda9f01daa0f540" to "27e3889566fe6e1559c1b4e75c4ec180e8523ae4"



---

archive/issue_comments_636303.json:
```json
{
    "body": "Changing commit from \"27e3889566fe6e1559c1b4e75c4ec180e8523ae4\" to \"3c36bd23497862675a1ca296637a242673e8bb8f\"",
    "created_at": "2021-06-14T06:03:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31982#issuecomment-636303",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "27e3889566fe6e1559c1b4e75c4ec180e8523ae4" to "3c36bd23497862675a1ca296637a242673e8bb8f"



---

archive/issue_comments_636304.json:
```json
{
    "body": "<a id='comment:7'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                |\n|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------|\n|[3c36bd2](https://git.sagemath.org/sage.git/commit/?id=3c36bd23497862675a1ca296637a242673e8bb8f)|`Eliminate use of MultiCoordFunction._functions`|",
    "created_at": "2021-06-14T06:03:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31982#issuecomment-636304",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                |
|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------|
|[3c36bd2](https://git.sagemath.org/sage.git/commit/?id=3c36bd23497862675a1ca296637a242673e8bb8f)|`Eliminate use of MultiCoordFunction._functions`|



---

archive/issue_comments_636305.json:
```json
{
    "body": "<a id='comment:8'></a>\nLooks nice. However, the pickling of continuous maps fails with the new code for `MultiCoordFunction`. More precisely, the equality test of the pickling fails when attempting to compare the `MultiCoordFunction`'s describing the continuous maps is a given pair of charts, with the error\n\n```\nFile \"/home/eric/sage/9.4.develop/local/lib/python3.8/site-packages/sage/manifolds/continuous_map.py\", \nline 577, in __eq__\n...\nAttributeError: 'sage.modules.free_module_element.FreeModuleElement_generic_dense'\nobject  has no attribute 'expr'\n```",
    "created_at": "2021-06-14T20:34:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31982#issuecomment-636305",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:8'></a>
Looks nice. However, the pickling of continuous maps fails with the new code for `MultiCoordFunction`. More precisely, the equality test of the pickling fails when attempting to compare the `MultiCoordFunction`'s describing the continuous maps is a given pair of charts, with the error

```
File "/home/eric/sage/9.4.develop/local/lib/python3.8/site-packages/sage/manifolds/continuous_map.py", 
line 577, in __eq__
...
AttributeError: 'sage.modules.free_module_element.FreeModuleElement_generic_dense'
object  has no attribute 'expr'
```



---

archive/issue_comments_636306.json:
```json
{
    "body": "<a id='comment:9'></a>\nThanks for taking a look! Because of these errors I hadn't set the ticket to \"needs review\" yet. I'll revise it in the next few days, but help is welcome.",
    "created_at": "2021-06-14T21:36:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31982#issuecomment-636306",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'></a>
Thanks for taking a look! Because of these errors I hadn't set the ticket to "needs review" yet. I'll revise it in the next few days, but help is welcome.



---

archive/issue_comments_636307.json:
```json
{
    "body": "Changing commit from \"3c36bd23497862675a1ca296637a242673e8bb8f\" to \"fb318025fc34666c8d78a40459c2e31cf9e83ea1\"",
    "created_at": "2021-06-14T23:43:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31982#issuecomment-636307",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "3c36bd23497862675a1ca296637a242673e8bb8f" to "fb318025fc34666c8d78a40459c2e31cf9e83ea1"



---

archive/issue_comments_636308.json:
```json
{
    "body": "<a id='comment:10'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                     |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------|\n|[49f63a4](https://git.sagemath.org/sage.git/commit/?id=49f63a47a4000fce7b8080e0493897fde98ae9ce)|`Vector_symbolic_dense: Fix pickling`|\n|[dcdd412](https://git.sagemath.org/sage.git/commit/?id=dcdd4126170cd4206b270bbc5ab3afd2cfde5e07)|`src/sage/manifolds/continuous_map.py: Update doctest output`|\n|[fb31802](https://git.sagemath.org/sage.git/commit/?id=fb318025fc34666c8d78a40459c2e31cf9e83ea1)|`src/sage/manifolds/chart.py: Update doctest output`|",
    "created_at": "2021-06-14T23:43:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31982#issuecomment-636308",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                     |
|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------|
|[49f63a4](https://git.sagemath.org/sage.git/commit/?id=49f63a47a4000fce7b8080e0493897fde98ae9ce)|`Vector_symbolic_dense: Fix pickling`|
|[dcdd412](https://git.sagemath.org/sage.git/commit/?id=dcdd4126170cd4206b270bbc5ab3afd2cfde5e07)|`src/sage/manifolds/continuous_map.py: Update doctest output`|
|[fb31802](https://git.sagemath.org/sage.git/commit/?id=fb318025fc34666c8d78a40459c2e31cf9e83ea1)|`src/sage/manifolds/chart.py: Update doctest output`|



---

archive/issue_comments_636309.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -16,9 +16,11 @@\n \n We change the function `sage.modules.free_module.element_class` so that it uses the element class `Vector_symbolic_dense` not only for free modules over the ring `SR` but also for free modules over any commutative ring whose base ring is `SR`.\n \n-This makes the elementwise symbolic methods `simplify` etc. available.\n+In fact, we dispatch through a new method `_free_module_element_class_dense`. `ChartFunction` provides a specialized implementation, which makes sure that `MultiCoordFunction` (now a subclass of `Vector_symbolic_dense`) is used as the element class.\n \n-We make `MultiCoordFunction` a subclass of `Vector_symbolic_dense`, moving the method `MultiCoordFunction.jacobian` to the superclass, making it more generally available.\n+This simplifies the implementation of `MultiCoordFunction` and also  makes the elementwise symbolic methods `simplify` etc. available.\n \n-Finally, we create a parent class `MultiCoordFunctionModule` (subclassing `FreeModule_ambient`) with element class `MultiCoordFunction`.\n \n+Follow-up:\n+- We could move the method `MultiCoordFunction.jacobian` to the superclass, making it more generally available.\n+\n``````\n",
    "created_at": "2021-06-14T23:53:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31982#issuecomment-636309",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -16,9 +16,11 @@
 
 We change the function `sage.modules.free_module.element_class` so that it uses the element class `Vector_symbolic_dense` not only for free modules over the ring `SR` but also for free modules over any commutative ring whose base ring is `SR`.
 
-This makes the elementwise symbolic methods `simplify` etc. available.
+In fact, we dispatch through a new method `_free_module_element_class_dense`. `ChartFunction` provides a specialized implementation, which makes sure that `MultiCoordFunction` (now a subclass of `Vector_symbolic_dense`) is used as the element class.
 
-We make `MultiCoordFunction` a subclass of `Vector_symbolic_dense`, moving the method `MultiCoordFunction.jacobian` to the superclass, making it more generally available.
+This simplifies the implementation of `MultiCoordFunction` and also  makes the elementwise symbolic methods `simplify` etc. available.
 
-Finally, we create a parent class `MultiCoordFunctionModule` (subclassing `FreeModule_ambient`) with element class `MultiCoordFunction`.
 
+Follow-up:
+- We could move the method `MultiCoordFunction.jacobian` to the superclass, making it more generally available.
+
``````




---

archive/issue_comments_636310.json:
```json
{
    "body": "Changing author from \"\" to \"Matthias Koeppe\"",
    "created_at": "2021-06-14T23:53:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31982#issuecomment-636310",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "" to "Matthias Koeppe"



---

archive/issue_comments_636311.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-06-14T23:53:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31982#issuecomment-636311",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_636312.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-06-16T06:16:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31982#issuecomment-636312",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_636313.json:
```json
{
    "body": "<a id='comment:12'></a>\n\n```\nsage -t --long --random-seed=0 src/sage/algebras/lie_algebras/quotient.py  # 1 doctest failed\nsage -t --long --random-seed=0 src/sage/modules/free_module_element.pyx  # 1 doctest failed\n```",
    "created_at": "2021-06-16T06:16:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31982#issuecomment-636313",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:12'></a>

```
sage -t --long --random-seed=0 src/sage/algebras/lie_algebras/quotient.py  # 1 doctest failed
sage -t --long --random-seed=0 src/sage/modules/free_module_element.pyx  # 1 doctest failed
```



---

archive/issue_comments_636314.json:
```json
{
    "body": "<a id='comment:13'></a>\nI think I could use some help from a pickling expert here...",
    "created_at": "2021-06-16T15:44:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31982#issuecomment-636314",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>
I think I could use some help from a pickling expert here...



---

archive/issue_comments_636315.json:
```json
{
    "body": "<a id='comment:14'></a>\nI bet this is related to #31182.",
    "created_at": "2021-06-16T16:41:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31982#issuecomment-636315",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:14'></a>
I bet this is related to #31182.



---

archive/issue_comments_636316.json:
```json
{
    "body": "<a id='comment:15'></a>\nOkay, maybe not.",
    "created_at": "2021-06-16T16:50:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31982#issuecomment-636316",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:15'></a>
Okay, maybe not.



---

archive/issue_comments_636317.json:
```json
{
    "body": "<a id='comment:16'></a>\nReplying to [mkoeppe](#comment%3A13):\n> I think I could use some help from a pickling expert here...\n\n\nSorry I am definitely not such an expert and therefore cannot offer help here. Instead, let me ask about the motivation of this ticket. I understand that, from a mathematical point of view, `MultiCoordFunction`'s belong to the free module `FR^n` (`FR` being the ring of chart functions associated to a given chart and `n` the manifold's dimension) and that implementing this simplifies (a little) the code by relying on some code already implemented for `Vector_symbolic_dense`. This, by itself, is a motivation. However, I would say this is not a strong one, because no use is made in the manifold code of the *module* structure of the set of `MultiCoordFunction`'s over a given chart. Indeed, in the current implementation, the class `MultiCoordFunction` is used only to store\n\n1. the coordinate expression of a continous map in a given pair of charts;\n2. the transition map between two charts.\n\nIn both cases, there is no meaning in the basic module operations `m1 + m2` and `f*m1`, where `m1` and `m2` are two `MultiCoordFunction`'s and `f` is a chart function. Hence, the motivation to provide a parent with a module structure seems pretty weak, given the current use of the class `MultiCoordFunction`. So maybe it is not worth to pursue the effort and keep `MultiCoordFunction` as a simple technical storage class (by opposition to a \"mathematical\" class), not relying on sophisticated parts of Sage, with complicated pickling and possibly less efficient in terms of CPU time.",
    "created_at": "2021-06-16T18:11:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31982#issuecomment-636317",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:16'></a>
Replying to [mkoeppe](#comment%3A13):
> I think I could use some help from a pickling expert here...


Sorry I am definitely not such an expert and therefore cannot offer help here. Instead, let me ask about the motivation of this ticket. I understand that, from a mathematical point of view, `MultiCoordFunction`'s belong to the free module `FR^n` (`FR` being the ring of chart functions associated to a given chart and `n` the manifold's dimension) and that implementing this simplifies (a little) the code by relying on some code already implemented for `Vector_symbolic_dense`. This, by itself, is a motivation. However, I would say this is not a strong one, because no use is made in the manifold code of the *module* structure of the set of `MultiCoordFunction`'s over a given chart. Indeed, in the current implementation, the class `MultiCoordFunction` is used only to store

1. the coordinate expression of a continous map in a given pair of charts;
2. the transition map between two charts.

In both cases, there is no meaning in the basic module operations `m1 + m2` and `f*m1`, where `m1` and `m2` are two `MultiCoordFunction`'s and `f` is a chart function. Hence, the motivation to provide a parent with a module structure seems pretty weak, given the current use of the class `MultiCoordFunction`. So maybe it is not worth to pursue the effort and keep `MultiCoordFunction` as a simple technical storage class (by opposition to a "mathematical" class), not relying on sophisticated parts of Sage, with complicated pickling and possibly less efficient in terms of CPU time.



---

archive/issue_comments_636318.json:
```json
{
    "body": "<a id='comment:17'></a>\nMy main motivation for the present ticket is for defining (not necessarily smooth) vector-valued (and later matrix-valued #31988) functions on manifolds (for #31981). If another class is better suited for this, I'd be interested to know.\n\nSome fixes here on the ticket are needed to make free module elements over the ring of coordinate functions work properly. Then I realized that `MultiCoordFunction` could just be the element class, giving some mild simplifications of the code. I agree that it is not essential to change `MultiCoordFunction` -- but whether I use that or a new class as the element class, I will need to fix the pickling of the elements.",
    "created_at": "2021-06-16T18:34:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31982#issuecomment-636318",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'></a>
My main motivation for the present ticket is for defining (not necessarily smooth) vector-valued (and later matrix-valued #31988) functions on manifolds (for #31981). If another class is better suited for this, I'd be interested to know.

Some fixes here on the ticket are needed to make free module elements over the ring of coordinate functions work properly. Then I realized that `MultiCoordFunction` could just be the element class, giving some mild simplifications of the code. I agree that it is not essential to change `MultiCoordFunction` -- but whether I use that or a new class as the element class, I will need to fix the pickling of the elements.



---

archive/issue_comments_636319.json:
```json
{
    "body": "<a id='comment:18'></a>\nRegarding the pickling, can you spot after which commit the error occurred; more precisely, which lines caused it?",
    "created_at": "2021-06-16T18:43:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31982#issuecomment-636319",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:18'></a>
Regarding the pickling, can you spot after which commit the error occurred; more precisely, which lines caused it?



---

archive/issue_comments_636320.json:
```json
{
    "body": "<a id='comment:19'></a>\nReplying to [mkoeppe](#comment%3A17):\n> My main motivation for the present ticket is for defining (not necessarily smooth) vector-valued (and later matrix-valued #31988) functions on manifolds (for #31981). \n\n\nThanks for your quick reply. This sounds a strong motivation for a module structure!\n\n>If another class is better suited for this, I'd be interested to know.\n\n\nWouldn't a kind of `MultiScalarField` be better suited? In some sense, for vector-valued functions, this already exists through the class `Components`. \n \n> Some fixes here on the ticket are needed to make free module elements over the ring of coordinate functions work properly. Then I realized that `MultiCoordFunction` could just be the element class, giving some mild simplifications of the code. I agree that it is not essential to change `MultiCoordFunction` -- but whether I use that or a new class as the element class, I will need to fix the pickling of the elements.\n\n\nThanks for these explanations.",
    "created_at": "2021-06-16T18:48:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31982#issuecomment-636320",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:19'></a>
Replying to [mkoeppe](#comment%3A17):
> My main motivation for the present ticket is for defining (not necessarily smooth) vector-valued (and later matrix-valued #31988) functions on manifolds (for #31981). 


Thanks for your quick reply. This sounds a strong motivation for a module structure!

>If another class is better suited for this, I'd be interested to know.


Wouldn't a kind of `MultiScalarField` be better suited? In some sense, for vector-valued functions, this already exists through the class `Components`. 
 
> Some fixes here on the ticket are needed to make free module elements over the ring of coordinate functions work properly. Then I realized that `MultiCoordFunction` could just be the element class, giving some mild simplifications of the code. I agree that it is not essential to change `MultiCoordFunction` -- but whether I use that or a new class as the element class, I will need to fix the pickling of the elements.


Thanks for these explanations.



---

archive/issue_comments_636321.json:
```json
{
    "body": "<a id='comment:20'></a>\nReplying to [egourgoulhon](#comment%3A19):\n> Replying to [mkoeppe](#comment%3A17):\n> > My main motivation for the present ticket is for defining (not necessarily smooth) vector-valued (and later matrix-valued #31988) functions on manifolds (for #31981). \n\n> \n> Thanks for your quick reply. This sounds a strong motivation for a module structure!\n> \n> >If another class is better suited for this, I'd be interested to know.\n\n> \n> Wouldn't a kind of `MultiScalarField` be better suited? In some sense, for vector-valued functions, this already exists through the class `Components`. \n\n\nYou are probably right about this. I guess a tricky point is regarding the required smoothness of scalar fields. I like to think of the domain as a smooth manifold, but the functions that I want to define on them often are less smooth - typically only piecewise C<sup>1</sup>, with Lipschitz gradients. See for example https://www.cvxpy.org/api_reference/cvxpy.atoms.elementwise.html",
    "created_at": "2021-06-16T19:12:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31982#issuecomment-636321",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'></a>
Replying to [egourgoulhon](#comment%3A19):
> Replying to [mkoeppe](#comment%3A17):
> > My main motivation for the present ticket is for defining (not necessarily smooth) vector-valued (and later matrix-valued #31988) functions on manifolds (for #31981). 

> 
> Thanks for your quick reply. This sounds a strong motivation for a module structure!
> 
> >If another class is better suited for this, I'd be interested to know.

> 
> Wouldn't a kind of `MultiScalarField` be better suited? In some sense, for vector-valued functions, this already exists through the class `Components`. 


You are probably right about this. I guess a tricky point is regarding the required smoothness of scalar fields. I like to think of the domain as a smooth manifold, but the functions that I want to define on them often are less smooth - typically only piecewise C<sup>1</sup>, with Lipschitz gradients. See for example https://www.cvxpy.org/api_reference/cvxpy.atoms.elementwise.html



---

archive/issue_comments_636322.json:
```json
{
    "body": "Changing dependencies from \"#31721\" to \"#31721, #31999\"",
    "created_at": "2021-06-17T18:08:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31982#issuecomment-636322",
    "user": "https://github.com/mkoeppe"
}
```

Changing dependencies from "#31721" to "#31721, #31999"



---

archive/issue_comments_636323.json:
```json
{
    "body": "Changing work_issues from \"\" to \"rebase on #31999; fix pickling issue\"",
    "created_at": "2021-06-17T18:39:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31982#issuecomment-636323",
    "user": "https://github.com/mkoeppe"
}
```

Changing work_issues from "" to "rebase on #31999; fix pickling issue"



---

archive/issue_events_084560.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31982#event-84560"
}
```



---

archive/issue_comments_636324.json:
```json
{
    "body": "<a id='comment:23'></a>\nSetting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31982#issuecomment-636324",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:23'></a>
Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_events_084561.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-14T02:04:49Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31982#event-84561"
}
```



---

archive/issue_events_084562.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-14T02:04:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31982#event-84562"
}
```



---

archive/issue_events_084563.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-05T00:06:20Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31982#event-84563"
}
```



---

archive/issue_events_084564.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-05T00:06:20Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31982#event-84564"
}
```



---

archive/issue_events_084565.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31982#event-84565"
}
```



---

archive/issue_events_084566.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31982",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31982#event-84566"
}
```
