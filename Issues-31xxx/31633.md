# Issue 31633: Simplify VectorField.__call__

archive/issues_031396.json:
```json
{
    "body": "The method `VectorField.__call__` implements the action *v(f)* of a vector field *v* on a scalar field *f*, as a derivation. It is reimplemented here to simply return *df(v)*, i.e. the differential of *f* acting on *v* as a 1-form. Actually, the current code of this method contains the comment:\n\n```\n        #!# Could it be simply\n        # return scalar.differential()(self)\n        # ?\n```\ngit blame reveals that this comment dates back to 2015. It is time to make the change, thereby simplifying the code and avoiding some code duplication. \n\nCC:  @tscrim @mjungmath\n\nKeywords: vector field, scalar field\n\nBranch/Commit: bc257815fcd42a6ba49eb0639ad1dc7e6a172f03\n\nReviewer: Michael Jung\n\nAuthor: Eric Gourgoulhon\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/31633\n\n",
    "closed_at": "2021-06-06T13:18:17Z",
    "created_at": "2021-04-09T16:53:49Z",
    "labels": [
        "component: manifolds"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "Simplify VectorField.__call__",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31633",
    "user": "https://github.com/egourgoulhon"
}
```
The method `VectorField.__call__` implements the action *v(f)* of a vector field *v* on a scalar field *f*, as a derivation. It is reimplemented here to simply return *df(v)*, i.e. the differential of *f* acting on *v* as a 1-form. Actually, the current code of this method contains the comment:

```
        #!# Could it be simply
        # return scalar.differential()(self)
        # ?
```
git blame reveals that this comment dates back to 2015. It is time to make the change, thereby simplifying the code and avoiding some code duplication. 

CC:  @tscrim @mjungmath

Keywords: vector field, scalar field

Branch/Commit: bc257815fcd42a6ba49eb0639ad1dc7e6a172f03

Reviewer: Michael Jung

Author: Eric Gourgoulhon

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/31633





---

archive/issue_comments_629590.json:
```json
{
    "body": "Changing commit from \"\" to \"c921e9738ac5d828eec7f8a0b0cbd60eba81a9f0\"",
    "created_at": "2021-04-09T16:56:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31633#issuecomment-629590",
    "user": "https://github.com/egourgoulhon"
}
```

Changing commit from "" to "c921e9738ac5d828eec7f8a0b0cbd60eba81a9f0"



---

archive/issue_comments_629591.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-04-09T16:56:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31633#issuecomment-629591",
    "user": "https://github.com/egourgoulhon"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_629592.json:
```json
{
    "body": "Changing branch from \"\" to \"public/manifolds/vector_field_call_31633\"",
    "created_at": "2021-04-09T16:56:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31633#issuecomment-629592",
    "user": "https://github.com/egourgoulhon"
}
```

Changing branch from "" to "public/manifolds/vector_field_call_31633"



---

archive/issue_comments_629593.json:
```json
{
    "body": "<a id='comment:1'></a>\nNew commits:\n|                                                                                                                                          |                               |\n|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------|\n|[c921e97](https://github.com/sagemath/sagetrac-mirror/commit/c921e9738ac5d828eec7f8a0b0cbd60eba81a9f0)|`Simplify VectorField.__call__`|",
    "created_at": "2021-04-09T16:56:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31633#issuecomment-629593",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:1'></a>
New commits:
|                                                                                                                                          |                               |
|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------|
|[c921e97](https://github.com/sagemath/sagetrac-mirror/commit/c921e9738ac5d828eec7f8a0b0cbd60eba81a9f0)|`Simplify VectorField.__call__`|



---

archive/issue_comments_629594.json:
```json
{
    "body": "<a id='comment:2'></a>\nNice! It's good to reduce code and get rid of duplication!\n\nTwo things:\n\n- What exactly caused the change\n\n   {{{#!diff\n     sage: isinstance(Tp, FiniteRankFreeModule)\n     True\n     sage: sorted(Tp.bases(), key=str)\n-    [Basis (d/dr,d/dph) on the Tangent space at Point p on the Euclidean plane E^2,\n-     Basis (e_r,e_ph) on the Tangent space at Point p on the Euclidean plane E^2,\n+    [Basis (e_r,e_ph) on the Tangent space at Point p on the Euclidean plane E^2,\n      Basis (e_x,e_y) on the Tangent space at Point p on the Euclidean plane E^2]\n   }}}\n\n- It is possible to combine raw strings and f-strings:\n\n   {{{#!diff\n-                latex_name = r\"{}\\left({}\\right)\".format(self._latex_name,\n-                                                         scalar._latex_name)\n+                latex_name = fr\"{self._latex_name}\\left({scalar._latex_name}\\right)\"\n   }}}",
    "created_at": "2021-04-09T18:21:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31633#issuecomment-629594",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:2'></a>
Nice! It's good to reduce code and get rid of duplication!

Two things:

- What exactly caused the change

   {{{#!diff
     sage: isinstance(Tp, FiniteRankFreeModule)
     True
     sage: sorted(Tp.bases(), key=str)
-    [Basis (d/dr,d/dph) on the Tangent space at Point p on the Euclidean plane E^2,
-     Basis (e_r,e_ph) on the Tangent space at Point p on the Euclidean plane E^2,
+    [Basis (e_r,e_ph) on the Tangent space at Point p on the Euclidean plane E^2,
      Basis (e_x,e_y) on the Tangent space at Point p on the Euclidean plane E^2]
   }}}

- It is possible to combine raw strings and f-strings:

   {{{#!diff
-                latex_name = r"{}\left({}\right)".format(self._latex_name,
-                                                         scalar._latex_name)
+                latex_name = fr"{self._latex_name}\left({scalar._latex_name}\right)"
   }}}



---

archive/issue_comments_629595.json:
```json
{
    "body": "<a id='comment:3'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                         |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------|\n|[bc25781](https://github.com/sagemath/sagetrac-mirror/commit/bc257815fcd42a6ba49eb0639ad1dc7e6a172f03)|`Combine raw string and f-string in VectorField.__call__`|",
    "created_at": "2021-04-09T19:59:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31633#issuecomment-629595",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                         |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------|
|[bc25781](https://github.com/sagemath/sagetrac-mirror/commit/bc257815fcd42a6ba49eb0639ad1dc7e6a172f03)|`Combine raw string and f-string in VectorField.__call__`|



---

archive/issue_comments_629596.json:
```json
{
    "body": "Changing commit from \"c921e9738ac5d828eec7f8a0b0cbd60eba81a9f0\" to \"bc257815fcd42a6ba49eb0639ad1dc7e6a172f03\"",
    "created_at": "2021-04-09T19:59:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31633#issuecomment-629596",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "c921e9738ac5d828eec7f8a0b0cbd60eba81a9f0" to "bc257815fcd42a6ba49eb0639ad1dc7e6a172f03"



---

archive/issue_comments_629597.json:
```json
{
    "body": "<a id='comment:4'></a>\nReplying to [gh-mjungmath](#comment%3A2):\n\nThanks for your comments.\n\n> \n> - What exactly caused the change\n> \n>    {{{#!diff\n>      sage: isinstance(Tp, FiniteRankFreeModule)\n>      True\n>      sage: sorted(Tp.bases(), key=str)\n> -    [Basis (d/dr,d/dph) on the Tangent space at Point p on the Euclidean plane E^2,\n> -     Basis (e_r,e_ph) on the Tangent space at Point p on the Euclidean plane E^2,\n> +    [Basis (e_r,e_ph) on the Tangent space at Point p on the Euclidean plane E^2,\n>       Basis (e_x,e_y) on the Tangent space at Point p on the Euclidean plane E^2]\n>    }}}\n> \n\n\nIt's because in the previous `VectorFieldParal.__call__` code, the computation was performed as v<sup>i</sup> df/dx<sup>i</sup> in all possible coordinate frames d/dx<sup>i</sup>, thereby triggering the evaluation of v in these frames. In the new code, the computation is performed as (df)<sub>i</sub> v<sup>i</sup> in a single frame (and not necessarily a coordinate one). In the specific example above, `v(F)` in line 577 of `src/doc/en/thematic_tutorials/vector_calculus/vector_calc_plane.rst` triggered the computation of v in the coordinate frame `(d/dr, d/dph)`; this was done in line 1779 of the old (i.e. 9.3.rc2) file `vectorfield.py`:\n\n```\n                self_r.comp(chart._frame)\n```\nThen `vp = v.at(p)` in line 634 of `vector_calc_plane.rst` created the basis `(d/dr, d/dph)` in `Tp`; this was done by `frame.at(point)` in line 2109 of `tensorfield_paral.py`:\n\n```\n            comp_resu = resu.add_comp(frame.at(point))\n```\nThis explains why `Tp` had the extra basis `(d/dr, d/dph)` with the old code. It was a side effect of an unnecessary calculation in the old `VectorFieldParal.__call__`.\n\n\n\n> - It is possible to combine raw strings and f-strings:\n> \n>    {{{#!diff\n> -                latex_name = r\"{}\\left({}\\right)\".format(self._latex_name,\n> -                                                         scalar._latex_name)\n> +                latex_name = fr\"{self._latex_name}\\left({scalar._latex_name}\\right)\"\n>    }}}\n\n\nDone in the last commit.",
    "created_at": "2021-04-09T20:27:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31633#issuecomment-629597",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:4'></a>
Replying to [gh-mjungmath](#comment%3A2):

Thanks for your comments.

> 
> - What exactly caused the change
> 
>    {{{#!diff
>      sage: isinstance(Tp, FiniteRankFreeModule)
>      True
>      sage: sorted(Tp.bases(), key=str)
> -    [Basis (d/dr,d/dph) on the Tangent space at Point p on the Euclidean plane E^2,
> -     Basis (e_r,e_ph) on the Tangent space at Point p on the Euclidean plane E^2,
> +    [Basis (e_r,e_ph) on the Tangent space at Point p on the Euclidean plane E^2,
>       Basis (e_x,e_y) on the Tangent space at Point p on the Euclidean plane E^2]
>    }}}
> 


It's because in the previous `VectorFieldParal.__call__` code, the computation was performed as v<sup>i</sup> df/dx<sup>i</sup> in all possible coordinate frames d/dx<sup>i</sup>, thereby triggering the evaluation of v in these frames. In the new code, the computation is performed as (df)<sub>i</sub> v<sup>i</sup> in a single frame (and not necessarily a coordinate one). In the specific example above, `v(F)` in line 577 of `src/doc/en/thematic_tutorials/vector_calculus/vector_calc_plane.rst` triggered the computation of v in the coordinate frame `(d/dr, d/dph)`; this was done in line 1779 of the old (i.e. 9.3.rc2) file `vectorfield.py`:

```
                self_r.comp(chart._frame)
```
Then `vp = v.at(p)` in line 634 of `vector_calc_plane.rst` created the basis `(d/dr, d/dph)` in `Tp`; this was done by `frame.at(point)` in line 2109 of `tensorfield_paral.py`:

```
            comp_resu = resu.add_comp(frame.at(point))
```
This explains why `Tp` had the extra basis `(d/dr, d/dph)` with the old code. It was a side effect of an unnecessary calculation in the old `VectorFieldParal.__call__`.



> - It is possible to combine raw strings and f-strings:
> 
>    {{{#!diff
> -                latex_name = r"{}\left({}\right)".format(self._latex_name,
> -                                                         scalar._latex_name)
> +                latex_name = fr"{self._latex_name}\left({scalar._latex_name}\right)"
>    }}}


Done in the last commit.



---

archive/issue_comments_629598.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [egourgoulhon](#comment%3A4):\n> It's because in the previous `VectorFieldParal.__call__` code, the computation was performed as v<sup>i</sup> df/dx<sup>i</sup> in all possible coordinate frames d/dx<sup>i</sup>, thereby triggering the evaluation of v in these frames. In the new code, the computation is performed as (df)<sub>i</sub> v<sup>i</sup> in a single frame (and not necessarily a coordinate one). In the specific example above, `v(F)` in line 577 of `src/doc/en/thematic_tutorials/vector_calculus/vector_calc_plane.rst` triggered the computation of v in the coordinate frame `(d/dr, d/dph)`; this was done in line 1779 of the old (i.e. 9.3.rc2) file `vectorfield.py`:\n> \n> ```\n>                 self_r.comp(chart._frame)\n> ```\n> Then `vp = v.at(p)` in line 634 of `vector_calc_plane.rst` created the basis `(d/dr, d/dph)` in `Tp`; this was done by `frame.at(point)` in line 2109 of `tensorfield_paral.py`:\n> \n> ```\n>             comp_resu = resu.add_comp(frame.at(point))\n> ```\n> This explains why `Tp` had the extra basis `(d/dr, d/dph)` with the old code. It was a side effect of an unnecessary calculation in the old `VectorFieldParal.__call__`.\n\n\nThat's indeed an improvement. Sweet!\n\n> > - It is possible to combine raw strings and f-strings:\n> > \n> >    {{{#!diff\n> > -                latex_name = r\"{}\\left({}\\right)\".format(self._latex_name,\n> > -                                                         scalar._latex_name)\n> > +                latex_name = fr\"{self._latex_name}\\left({scalar._latex_name}\\right)\"\n> >    }}}\n\n> \n> Done in the last commit.\n\n\nGreat. I'll give it a positive review as soon as patchbot is green.",
    "created_at": "2021-04-09T20:52:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31633#issuecomment-629598",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:5'></a>
Replying to [egourgoulhon](#comment%3A4):
> It's because in the previous `VectorFieldParal.__call__` code, the computation was performed as v<sup>i</sup> df/dx<sup>i</sup> in all possible coordinate frames d/dx<sup>i</sup>, thereby triggering the evaluation of v in these frames. In the new code, the computation is performed as (df)<sub>i</sub> v<sup>i</sup> in a single frame (and not necessarily a coordinate one). In the specific example above, `v(F)` in line 577 of `src/doc/en/thematic_tutorials/vector_calculus/vector_calc_plane.rst` triggered the computation of v in the coordinate frame `(d/dr, d/dph)`; this was done in line 1779 of the old (i.e. 9.3.rc2) file `vectorfield.py`:
> 
> ```
>                 self_r.comp(chart._frame)
> ```
> Then `vp = v.at(p)` in line 634 of `vector_calc_plane.rst` created the basis `(d/dr, d/dph)` in `Tp`; this was done by `frame.at(point)` in line 2109 of `tensorfield_paral.py`:
> 
> ```
>             comp_resu = resu.add_comp(frame.at(point))
> ```
> This explains why `Tp` had the extra basis `(d/dr, d/dph)` with the old code. It was a side effect of an unnecessary calculation in the old `VectorFieldParal.__call__`.


That's indeed an improvement. Sweet!

> > - It is possible to combine raw strings and f-strings:
> > 
> >    {{{#!diff
> > -                latex_name = r"{}\left({}\right)".format(self._latex_name,
> > -                                                         scalar._latex_name)
> > +                latex_name = fr"{self._latex_name}\left({scalar._latex_name}\right)"
> >    }}}

> 
> Done in the last commit.


Great. I'll give it a positive review as soon as patchbot is green.



---

archive/issue_comments_629599.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Michael Jung\"",
    "created_at": "2021-04-09T22:37:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31633#issuecomment-629599",
    "user": "https://github.com/mjungmath"
}
```

Changing reviewer from "" to "Michael Jung"



---

archive/issue_comments_629600.json:
```json
{
    "body": "<a id='comment:6'></a>\nPatchbot green. LGTM.",
    "created_at": "2021-04-09T22:37:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31633#issuecomment-629600",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:6'></a>
Patchbot green. LGTM.



---

archive/issue_comments_629601.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-04-09T22:37:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31633#issuecomment-629601",
    "user": "https://github.com/mjungmath"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_629602.json:
```json
{
    "body": "<a id='comment:7'></a>\nThank you for the review!",
    "created_at": "2021-04-10T09:10:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31633#issuecomment-629602",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:7'></a>
Thank you for the review!



---

archive/issue_events_093770.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-06-06T13:18:17Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31633",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31633#event-93770"
}
```



---

archive/issue_comments_629603.json:
```json
{
    "body": "Changing branch from \"public/manifolds/vector_field_call_31633\" to \"bc257815fcd42a6ba49eb0639ad1dc7e6a172f03\"",
    "created_at": "2021-06-06T13:18:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31633#issuecomment-629603",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/manifolds/vector_field_call_31633" to "bc257815fcd42a6ba49eb0639ad1dc7e6a172f03"



---

archive/issue_comments_629604.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-06-06T13:18:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31633#issuecomment-629604",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
