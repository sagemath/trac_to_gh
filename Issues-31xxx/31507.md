# Issue 31507: Checking if an element is in a subgroup can raise 'TypeError'

archive/issues_031270.json:
```json
{
    "body": "In Sage 9.2, after defining:\n\n```\nsage: G = AbelianGroup(2, gens_orders=[16, 16])\nsage: f0, f1 = G.gens()\nsage: H = G.subgroup ([f0*f1^3])\n```\nthe following correctly determines non-membership:\n\n```\nsage: f0*f1^2 in H\nFalse\n```\nbut the following gives a type error:\n\n```\nsage: f0 in H\nTypeError: no conversion of this rational to integer\n```\n\nThe error seems to come from the `__contains__` method\nof `src/sage/groups/abelian_gps/abelian_group.py`\n(around line 1715), in particular the `if-else`\nstatements of lines 1740-1743.\n\n\nCC:  @slel\n\nKeywords: groups\n\nBranch/Commit: [c790824d16de58c00c2a3361e0cbe19d5ae432d1](https://github.com/sagemath/sagetrac-mirror/commit/c790824d16de58c00c2a3361e0cbe19d5ae432d1)\n\nReviewer: Dave Morris, Samuel Leli\u00e8vre\n\nAuthor: Maarten Derickx\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/31507\n\n",
    "closed_at": "2021-12-05T11:15:11Z",
    "created_at": "2021-03-17T10:14:32Z",
    "labels": [
        "component: group theory",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Checking if an element is in a subgroup can raise 'TypeError'",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31507",
    "user": "https://trac.sagemath.org/admin/accounts/users/bouvier"
}
```
In Sage 9.2, after defining:

```
sage: G = AbelianGroup(2, gens_orders=[16, 16])
sage: f0, f1 = G.gens()
sage: H = G.subgroup ([f0*f1^3])
```
the following correctly determines non-membership:

```
sage: f0*f1^2 in H
False
```
but the following gives a type error:

```
sage: f0 in H
TypeError: no conversion of this rational to integer
```

The error seems to come from the `__contains__` method
of `src/sage/groups/abelian_gps/abelian_group.py`
(around line 1715), in particular the `if-else`
statements of lines 1740-1743.


CC:  @slel

Keywords: groups

Branch/Commit: [c790824d16de58c00c2a3361e0cbe19d5ae432d1](https://github.com/sagemath/sagetrac-mirror/commit/c790824d16de58c00c2a3361e0cbe19d5ae432d1)

Reviewer: Dave Morris, Samuel Leli√®vre

Author: Maarten Derickx

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/31507





---

archive/issue_comments_626405.json:
```json
{
    "body": "<a id='comment:1'></a>\nMoving to 9.4, as 9.3 has been released.",
    "created_at": "2021-05-10T17:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31507#issuecomment-626405",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:1'></a>
Moving to 9.4, as 9.3 has been released.



---

archive/issue_events_093184.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-05-10T17:42:09Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31507",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31507#event-93184"
}
```



---

archive/issue_events_093185.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-22T20:35:10Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31507",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31507#event-93185"
}
```



---

archive/issue_events_093186.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-22T20:35:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31507",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31507#event-93186"
}
```



---

archive/issue_comments_626406.json:
```json
{
    "body": "<a id='comment:3'></a>\nFrom #32910:\n\nOk, I don't have a development version of sage yet. And I have trouble getting one. But here is some code I wrote that I used to monkey patch\n`sage.groups.abelian_gps.abelian_group.AbelianGroup_subgroup.__contains__` and it seems to work like a charm for my application.\n\n```\ndef __contains__(self, x):\n    \"\"\"\n    Test whether ``x`` is an element of this subgroup.\n\n    EXAMPLES::\n\n        sage: G.<a,b> = AbelianGroup(2)\n        sage: A = G.subgroup([a])\n        sage: a in G\n        True\n        sage: a in A\n        True\n\n    TESTS:\n\n    Check that :trac:`32910` is fixed::\n\n        sage: Zmstar.<a,b> = AbelianGroup(2,[4,576])\n        sage: Hgens =  [a**2,a*b**2]\n        sage: H = Zmstar.subgroup(Hgens)\n        sage: g = Zmstar.gen(1)**3\n        sage: g in H\n        True\n\n    \"\"\"\n    amb_inv = self.ambient_group().gens_orders()\n    inv_basis = diagonal_matrix(ZZ,amb_inv)\n    gens_basis = matrix(\n        ZZ, len(self._gens), len(amb_inv), [g.list() for g in self._gens]\n    )\n    return vector(ZZ, x.list()) in inv_basis.stack(gens_basis).row_module()\n\nsage.groups.abelian_gps.abelian_group.AbelianGroup_subgroup.__contains__ = __contains__\n```",
    "created_at": "2021-11-21T12:26:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31507#issuecomment-626406",
    "user": "https://github.com/koffie"
}
```

<a id='comment:3'></a>
From #32910:

Ok, I don't have a development version of sage yet. And I have trouble getting one. But here is some code I wrote that I used to monkey patch
`sage.groups.abelian_gps.abelian_group.AbelianGroup_subgroup.__contains__` and it seems to work like a charm for my application.

```
def __contains__(self, x):
    """
    Test whether ``x`` is an element of this subgroup.

    EXAMPLES::

        sage: G.<a,b> = AbelianGroup(2)
        sage: A = G.subgroup([a])
        sage: a in G
        True
        sage: a in A
        True

    TESTS:

    Check that :trac:`32910` is fixed::

        sage: Zmstar.<a,b> = AbelianGroup(2,[4,576])
        sage: Hgens =  [a**2,a*b**2]
        sage: H = Zmstar.subgroup(Hgens)
        sage: g = Zmstar.gen(1)**3
        sage: g in H
        True

    """
    amb_inv = self.ambient_group().gens_orders()
    inv_basis = diagonal_matrix(ZZ,amb_inv)
    gens_basis = matrix(
        ZZ, len(self._gens), len(amb_inv), [g.list() for g in self._gens]
    )
    return vector(ZZ, x.list()) in inv_basis.stack(gens_basis).row_module()

sage.groups.abelian_gps.abelian_group.AbelianGroup_subgroup.__contains__ = __contains__
```



---

archive/issue_comments_626407.json:
```json
{
    "body": "Changing branch from \"\" to \"public/31507\"",
    "created_at": "2021-11-21T19:06:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31507#issuecomment-626407",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing branch from "" to "public/31507"



---

archive/issue_comments_626408.json:
```json
{
    "body": "Changing author from \"\" to \"Maarten Derickx\"",
    "created_at": "2021-11-21T19:19:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31507#issuecomment-626408",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing author from "" to "Maarten Derickx"



---

archive/issue_comments_626409.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-11-21T19:19:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31507#issuecomment-626409",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_626410.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Dave Morris\"",
    "created_at": "2021-11-21T19:19:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31507#issuecomment-626410",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing reviewer from "" to "Dave Morris"



---

archive/issue_comments_626411.json:
```json
{
    "body": "Changing commit from \"\" to \"de1d131ddcc64a22086bd51d8c4755c9ae1d47ae\"",
    "created_at": "2021-11-21T19:19:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31507#issuecomment-626411",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing commit from "" to "de1d131ddcc64a22086bd51d8c4755c9ae1d47ae"



---

archive/issue_comments_626412.json:
```json
{
    "body": "<a id='comment:5'></a>\nHere is a branch that implements the patch. I made a few reviewer changes: I kept some of the original code at the start of the method, I added some import statements, and I think the doctest was wrong (the correct answer is `False`, not `True`).\n\nThe other option would be to fix the bug in the original code. However, I think it makes sense to use this simpler code (which delegates the work to ZZ-module methods), because it is easier to understand and to maintain.\n\nThe example from this ticket should probably be added as an additional doctest, but I forgot to do that. I am setting to \"needs review\" to start getting comments from humans and patchbots.  I will do the review myself if we don't hear from anyone.\n\n---\nNew commits:\n|                                                                                                                                          |                              |\n|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------|\n|[de1d131](https://github.com/sagemath/sagetrac-mirror/commit/de1d131ddcc64a22086bd51d8c4755c9ae1d47ae)|`trac 31507 subgroup contains`|",
    "created_at": "2021-11-21T19:19:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31507#issuecomment-626412",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:5'></a>
Here is a branch that implements the patch. I made a few reviewer changes: I kept some of the original code at the start of the method, I added some import statements, and I think the doctest was wrong (the correct answer is `False`, not `True`).

The other option would be to fix the bug in the original code. However, I think it makes sense to use this simpler code (which delegates the work to ZZ-module methods), because it is easier to understand and to maintain.

The example from this ticket should probably be added as an additional doctest, but I forgot to do that. I am setting to "needs review" to start getting comments from humans and patchbots.  I will do the review myself if we don't hear from anyone.

---
New commits:
|                                                                                                                                          |                              |
|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------|
|[de1d131](https://github.com/sagemath/sagetrac-mirror/commit/de1d131ddcc64a22086bd51d8c4755c9ae1d47ae)|`trac 31507 subgroup contains`|



---

archive/issue_comments_626413.json:
```json
{
    "body": "Changing commit from \"de1d131ddcc64a22086bd51d8c4755c9ae1d47ae\" to \"a384184c6e8edccb2cc5c1e0b8c75d6e394ef635\"",
    "created_at": "2021-11-21T19:31:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31507#issuecomment-626413",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "de1d131ddcc64a22086bd51d8c4755c9ae1d47ae" to "a384184c6e8edccb2cc5c1e0b8c75d6e394ef635"



---

archive/issue_comments_626414.json:
```json
{
    "body": "<a id='comment:6'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                     |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------|\n|[a384184](https://github.com/sagemath/sagetrac-mirror/commit/a384184c6e8edccb2cc5c1e0b8c75d6e394ef635)|`additional doctests`|",
    "created_at": "2021-11-21T19:31:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31507#issuecomment-626414",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                     |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------|
|[a384184](https://github.com/sagemath/sagetrac-mirror/commit/a384184c6e8edccb2cc5c1e0b8c75d6e394ef635)|`additional doctests`|



---

archive/issue_comments_626415.json:
```json
{
    "body": "<a id='comment:7'></a>\nHi Dave,\n\nThanks for turning this into a git branch and making sure that the non algorithmic part of the code like the `is_instance` check are still there. And indeed you are right it should return False.\n\nIs there a reason to do the imports inside of the function and not at the top of the file? Was there a problem with circular imports?",
    "created_at": "2021-11-21T20:35:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31507#issuecomment-626415",
    "user": "https://github.com/koffie"
}
```

<a id='comment:7'></a>
Hi Dave,

Thanks for turning this into a git branch and making sure that the non algorithmic part of the code like the `is_instance` check are still there. And indeed you are right it should return False.

Is there a reason to do the imports inside of the function and not at the top of the file? Was there a problem with circular imports?



---

archive/issue_comments_626416.json:
```json
{
    "body": "<a id='comment:8'></a>\nThe following suggestions are to\n\n- use Sage preparsing of `^` to `**` in doctests,\n- use `b` rather than `Zmstar.gen(1)`,\n- rename `Zmstar` to `G`,\n- increase test density.\n\n```diff\n-            sage: Zmstar.<a,b> = AbelianGroup(2, [4, 576])\n+            sage: G.<a,b> = AbelianGroup(2, [4, 576])\n-            sage: Hgens =  [a**2,a*b**2]\n+            sage: Hgens = [a^2, a*b^2]\n-            sage: g = Zmstar.gen(1)**3\n-            sage: g in H\n-            False\n-            sage: a^3*b^2 in H\n-            True\n+            sage: [g in H for g in (a^3, b^2, b^3, a^3*b^2)]\n+            [False, False, False, True]\n```\n\n```diff\n-            sage: f0*f1^2 in H\n-            False\n-            sage: f0 in H\n-            False\n+            sage: [g in H for g in (f0, f0*f1^2, f0*f1^3, f0*f1^4)]\n+            [False, False, True, False]\n```\n\nAnother cosmetic change I would make, but maybe my pep8 is off:\n\n```diff\n-            gens_basis = matrix(\n-                ZZ, len(self._gens), len(amb_inv), [g.list() for g in self._gens]\n-                )\n+            gens_basis = matrix(ZZ, len(self._gens), len(amb_inv),\n+                                [g.list() for g in self._gens])\n```\n\nFeel free to ignore these minor comments.",
    "created_at": "2021-11-21T21:13:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31507#issuecomment-626416",
    "user": "https://github.com/slel"
}
```

<a id='comment:8'></a>
The following suggestions are to

- use Sage preparsing of `^` to `**` in doctests,
- use `b` rather than `Zmstar.gen(1)`,
- rename `Zmstar` to `G`,
- increase test density.

```diff
-            sage: Zmstar.<a,b> = AbelianGroup(2, [4, 576])
+            sage: G.<a,b> = AbelianGroup(2, [4, 576])
-            sage: Hgens =  [a**2,a*b**2]
+            sage: Hgens = [a^2, a*b^2]
-            sage: g = Zmstar.gen(1)**3
-            sage: g in H
-            False
-            sage: a^3*b^2 in H
-            True
+            sage: [g in H for g in (a^3, b^2, b^3, a^3*b^2)]
+            [False, False, False, True]
```

```diff
-            sage: f0*f1^2 in H
-            False
-            sage: f0 in H
-            False
+            sage: [g in H for g in (f0, f0*f1^2, f0*f1^3, f0*f1^4)]
+            [False, False, True, False]
```

Another cosmetic change I would make, but maybe my pep8 is off:

```diff
-            gens_basis = matrix(
-                ZZ, len(self._gens), len(amb_inv), [g.list() for g in self._gens]
-                )
+            gens_basis = matrix(ZZ, len(self._gens), len(amb_inv),
+                                [g.list() for g in self._gens])
```

Feel free to ignore these minor comments.



---

archive/issue_comments_626417.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,20 +1,25 @@\n-When running the following code in Sage 9.2\n+In Sage 9.2, after defining:\n \n ```\n-G = AbelianGroup(2, gens_orders=[16, 16])\n-f0,f1 = G.gens()\n-\n-H = G.subgroup ([f0*f1^3])\n-\n-f0*f1^2 in H\n-f0 in H\n+sage: G = AbelianGroup(2, gens_orders=[16, 16])\n+sage: f0, f1 = G.gens()\n+sage: H = G.subgroup ([f0*f1^3])\n ```\n-\n-the last line raised a TypeError (note that the previous line correctly determines that the other element is not in the subgroup):\n-\n+the following correctly determines non-membership:\n \n ```\n+sage: f0*f1^2 in H\n+False\n+```\n+but the following gives a type error:\n+\n+```\n+sage: f0 in H\n TypeError: no conversion of this rational to integer\n ```\n \n-The error seems to come from the `__contains__` method of `src/sage/groups/abelian_gps/abelian_group.py` (around line 1715), in particular the `if-else` statements of lines 1740-1743.\n+The error seems to come from the `__contains__` method\n+of `src/sage/groups/abelian_gps/abelian_group.py`\n+(around line 1715), in particular the `if-else`\n+statements of lines 1740-1743.\n+\n``````\n",
    "created_at": "2021-11-21T21:13:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31507#issuecomment-626417",
    "user": "https://github.com/slel"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,20 +1,25 @@
-When running the following code in Sage 9.2
+In Sage 9.2, after defining:
 
 ```
-G = AbelianGroup(2, gens_orders=[16, 16])
-f0,f1 = G.gens()
-
-H = G.subgroup ([f0*f1^3])
-
-f0*f1^2 in H
-f0 in H
+sage: G = AbelianGroup(2, gens_orders=[16, 16])
+sage: f0, f1 = G.gens()
+sage: H = G.subgroup ([f0*f1^3])
 ```
-
-the last line raised a TypeError (note that the previous line correctly determines that the other element is not in the subgroup):
-
+the following correctly determines non-membership:
 
 ```
+sage: f0*f1^2 in H
+False
+```
+but the following gives a type error:
+
+```
+sage: f0 in H
 TypeError: no conversion of this rational to integer
 ```
 
-The error seems to come from the `__contains__` method of `src/sage/groups/abelian_gps/abelian_group.py` (around line 1715), in particular the `if-else` statements of lines 1740-1743.
+The error seems to come from the `__contains__` method
+of `src/sage/groups/abelian_gps/abelian_group.py`
+(around line 1715), in particular the `if-else`
+statements of lines 1740-1743.
+
``````




---

archive/issue_comments_626418.json:
```json
{
    "body": "<a id='comment:9'></a>\nI went for this simpler implementation because I had trouble understanding what the original code was trying to do. I am guessing that maybe the divisions had to be integer divisions `//`. And I also had the feeling that the original code was relying on the self._gens being in some sort of standard form so that the algorithm is able to reduce `x` to 1 if and only if x is in self. However as the code below shows, there is nothing guaranteeing that H._gens is in any sort of standard from. It is just what was passed during construction.\n\n```\nsage: Zmstar.<a,b> = AbelianGroup(2)   \n....: Hgens =  [a**5*b, a**3, a*b, b**7]   \n....: H = Zmstar.subgroup(Hgens)  \n....: H._gens                                                                                      \n(a^5*b, a^3, a*b, b^7)\n```\n\nThe following piece of code show a more subtle (i.e. not even raising an error) way that the old code can fail.\n\n```\nsage: G.<a,b> = AbelianGroup(2)   \n....: Hgens =  [a*b, a*b^-1]   \n....: H = G.subgroup(Hgens)  \n....: b**2 in H                                                                 \nFalse\nsage: H.gen(0)/H.gen(1)==b**2                                                   \nTrue\n```",
    "created_at": "2021-11-21T21:16:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31507#issuecomment-626418",
    "user": "https://github.com/koffie"
}
```

<a id='comment:9'></a>
I went for this simpler implementation because I had trouble understanding what the original code was trying to do. I am guessing that maybe the divisions had to be integer divisions `//`. And I also had the feeling that the original code was relying on the self._gens being in some sort of standard form so that the algorithm is able to reduce `x` to 1 if and only if x is in self. However as the code below shows, there is nothing guaranteeing that H._gens is in any sort of standard from. It is just what was passed during construction.

```
sage: Zmstar.<a,b> = AbelianGroup(2)   
....: Hgens =  [a**5*b, a**3, a*b, b**7]   
....: H = Zmstar.subgroup(Hgens)  
....: H._gens                                                                                      
(a^5*b, a^3, a*b, b^7)
```

The following piece of code show a more subtle (i.e. not even raising an error) way that the old code can fail.

```
sage: G.<a,b> = AbelianGroup(2)   
....: Hgens =  [a*b, a*b^-1]   
....: H = G.subgroup(Hgens)  
....: b**2 in H                                                                 
False
sage: H.gen(0)/H.gen(1)==b**2                                                   
True
```



---

archive/issue_comments_626419.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [slelievre](#comment%3A8):\n> Another cosmetic change I would make, but maybe my pep8 is off:\n> \n> ```diff\n> -            gens_basis = matrix(\n> -                ZZ, len(self._gens), len(amb_inv), [g.list() for g in self._gens]\n> -                )\n> +            gens_basis = matrix(ZZ, len(self._gens), len(amb_inv),\n> +                                [g.list() for g in self._gens])\n> ```\n> \n\n\nI actually let my code be formatted by black whose output is guaranteed to be pep8 compatible. And black proposed the above linebreak so at least the original is pep8 compatible. Although black does put the closing parenthesis unindented.",
    "created_at": "2021-11-21T21:24:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31507#issuecomment-626419",
    "user": "https://github.com/koffie"
}
```

<a id='comment:10'></a>
Replying to [slelievre](#comment%3A8):
> Another cosmetic change I would make, but maybe my pep8 is off:
> 
> ```diff
> -            gens_basis = matrix(
> -                ZZ, len(self._gens), len(amb_inv), [g.list() for g in self._gens]
> -                )
> +            gens_basis = matrix(ZZ, len(self._gens), len(amb_inv),
> +                                [g.list() for g in self._gens])
> ```
> 


I actually let my code be formatted by black whose output is guaranteed to be pep8 compatible. And black proposed the above linebreak so at least the original is pep8 compatible. Although black does put the closing parenthesis unindented.



---

archive/issue_comments_626420.json:
```json
{
    "body": "Changing commit from \"a384184c6e8edccb2cc5c1e0b8c75d6e394ef635\" to \"ef7bd6d93085c81ca52aa96170429e7b2697d51e\"",
    "created_at": "2021-11-21T23:48:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31507#issuecomment-626420",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "a384184c6e8edccb2cc5c1e0b8c75d6e394ef635" to "ef7bd6d93085c81ca52aa96170429e7b2697d51e"



---

archive/issue_comments_626421.json:
```json
{
    "body": "<a id='comment:11'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                      |\n|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------|\n|[ef7bd6d](https://github.com/sagemath/sagetrac-mirror/commit/ef7bd6d93085c81ca52aa96170429e7b2697d51e)|`reviewer suggestions`|",
    "created_at": "2021-11-21T23:48:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31507#issuecomment-626421",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                      |
|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------|
|[ef7bd6d](https://github.com/sagemath/sagetrac-mirror/commit/ef7bd6d93085c81ca52aa96170429e7b2697d51e)|`reviewer suggestions`|



---

archive/issue_comments_626422.json:
```json
{
    "body": "Changing commit from \"ef7bd6d93085c81ca52aa96170429e7b2697d51e\" to \"c790824d16de58c00c2a3361e0cbe19d5ae432d1\"",
    "created_at": "2021-11-22T00:05:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31507#issuecomment-626422",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "ef7bd6d93085c81ca52aa96170429e7b2697d51e" to "c790824d16de58c00c2a3361e0cbe19d5ae432d1"



---

archive/issue_comments_626423.json:
```json
{
    "body": "<a id='comment:12'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                        |\n|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------|\n|[c790824](https://github.com/sagemath/sagetrac-mirror/commit/c790824d16de58c00c2a3361e0cbe19d5ae432d1)|`change another ** to ^`|",
    "created_at": "2021-11-22T00:05:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31507#issuecomment-626423",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                        |
|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------|
|[c790824](https://github.com/sagemath/sagetrac-mirror/commit/c790824d16de58c00c2a3361e0cbe19d5ae432d1)|`change another ** to ^`|



---

archive/issue_comments_626424.json:
```json
{
    "body": "<a id='comment:13'></a>\nI think this update implements all of the suggestions.\n\nI also broke two lines that were more than 80 characters, and added a check for whether \"junk\" is in H in the first test, because the method should not choke on stupid input.\n\nAnd I added the last example of[comment:9](#comment%3A9) as another test. I think that example is very strong evidence that this ticket takes the right approach by getting rid of code duplication.\n\nI apologize for the python style errors -- I am not fluent.  PEP8 says \"Imports are always put at the top of the file...\" so I moved them there.  It also says \"The closing brace/bracket/parenthesis on multi-line constructs may either line up under the first non-whitespace character of the last line of list ... or it may be lined up under the first character of the line that starts the multi-line construct ...\". So (regarding[comment:10](#comment%3A10)) I left the closing parenthesis on its own line (but reduced the indent to match the author's original code that black liked).\n\nFurther comments or corrections (or corrections to my implementations of the corrections) are welcome, of course.  If there aren't any, and the patchbot comes back green again, then I think we are done.",
    "created_at": "2021-11-22T00:07:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31507#issuecomment-626424",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:13'></a>
I think this update implements all of the suggestions.

I also broke two lines that were more than 80 characters, and added a check for whether "junk" is in H in the first test, because the method should not choke on stupid input.

And I added the last example of[comment:9](#comment%3A9) as another test. I think that example is very strong evidence that this ticket takes the right approach by getting rid of code duplication.

I apologize for the python style errors -- I am not fluent.  PEP8 says "Imports are always put at the top of the file..." so I moved them there.  It also says "The closing brace/bracket/parenthesis on multi-line constructs may either line up under the first non-whitespace character of the last line of list ... or it may be lined up under the first character of the line that starts the multi-line construct ...". So (regarding[comment:10](#comment%3A10)) I left the closing parenthesis on its own line (but reduced the indent to match the author's original code that black liked).

Further comments or corrections (or corrections to my implementations of the corrections) are welcome, of course.  If there aren't any, and the patchbot comes back green again, then I think we are done.



---

archive/issue_comments_626425.json:
```json
{
    "body": "<a id='comment:14'></a>\nThanks for this! Form my part it looks good to go.",
    "created_at": "2021-11-22T09:05:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31507#issuecomment-626425",
    "user": "https://github.com/koffie"
}
```

<a id='comment:14'></a>
Thanks for this! Form my part it looks good to go.



---

archive/issue_comments_626426.json:
```json
{
    "body": "Changing reviewer from \"Dave Morris\" to \"Dave Morris, Samuel Leli\u00e8vre\"",
    "created_at": "2021-11-22T22:22:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31507#issuecomment-626426",
    "user": "https://github.com/slel"
}
```

Changing reviewer from "Dave Morris" to "Dave Morris, Samuel Leli√®vre"



---

archive/issue_comments_626427.json:
```json
{
    "body": "<a id='comment:15'></a>\nLikewise. And green light from a patchbot.",
    "created_at": "2021-11-22T22:22:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31507#issuecomment-626427",
    "user": "https://github.com/slel"
}
```

<a id='comment:15'></a>
Likewise. And green light from a patchbot.



---

archive/issue_comments_626428.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-11-22T22:22:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31507#issuecomment-626428",
    "user": "https://github.com/slel"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_626429.json:
```json
{
    "body": "<a id='comment:16'></a>\nThanks to both of you for the code, the comments and suggestions, and the review!",
    "created_at": "2021-11-22T23:28:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31507#issuecomment-626429",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:16'></a>
Thanks to both of you for the code, the comments and suggestions, and the review!



---

archive/issue_comments_626430.json:
```json
{
    "body": "Changing branch from \"public/31507\" to \"c790824d16de58c00c2a3361e0cbe19d5ae432d1\"",
    "created_at": "2021-12-05T11:15:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31507#issuecomment-626430",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/31507" to "c790824d16de58c00c2a3361e0cbe19d5ae432d1"



---

archive/issue_events_093187.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-12-05T11:15:11Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31507",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31507#event-93187"
}
```



---

archive/issue_comments_626431.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-12-05T11:15:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31507#issuecomment-626431",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
