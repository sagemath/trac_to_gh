# Issue 31548: Create matrix class for FLINT's nmod_mat module

archive/issues_031311.json:
```json
{
    "body": "This tickets adds a new class for dense matrices over `Zmod(N)` implemented using FLINT's `nmod_mat_t` type, along with some supporting ancillary changes:\n\n* Changed echelon form over `Zmod(N)` for composite `N` to return the Howell form (see the introduction and Chapter 4 of [Storjohann's thesis](https://cs.uwaterloo.ca/~astorjoh/diss2up.pdf)).  Since this echelon form can have more rows than the input matrix, made some supporting changes including a new method `_echelon_copy`.\n* Changed rank over `Zmod(N)` to return the number of leading 1s in Howell form (it raised a `NotImplementedError` before), and `pivots` to be the locations of these leading 1s.  There is also a method `_pivots` for accessing the columns where the leading entry is not 1.\n* Matrices modulo composite `N` have improved speed and functionality for inversion, `charpoly`, `det`, `minpoly`, `echelon_form`, `solve_right` and `right_kernel_matrix`.  There is also a new method `minpoly_ideal` for the ideal vanishing on a matrix (the natural generalization of the minimal polynomial, which generates this ideal when it is principal).\n* Changed `stack` and `augment` to return a matrix over a common base ring of the two inputs, rather than just using the top/left matrix to determine the base ring.\n* A new method `_change_implementation` on matrices, together with rough heuristics for matrices on matrices mod `N` in determining when it's worth switching between FLINT and linbox (linbox is faster for large matrices, FLINT for smaller, and FLINT offers extra functionality for matrices modulo composite integers).\n* Support multiplication of matrices with different implementations\n* Add FLINT's `ulong_extras` for number theoretic functions on longs\n* Add some iterators related to split primes in cyclotomic fields in support of changes to `matrix_cyclo_dense` (which uses a multimodular approach), and moved the `_reduction_matrix` method to the base field which will yield better caching behavior.\n* Fix some doctests that relate to choosing different solutions in `solve_right` and getting different random matrices with a different implementation.\n\nCC:  @edgarcosta\n\nReviewer: Travis Scrimshaw\n\nAuthor: David Roe, Edgar Costa\n\nBranch: u/roed/nmod_mat\n\nStatus: needs_work\n\nDependencies: #31069\n\nCommit: a3c8e38bc674e3e7fa8c93ab04f71548fd28aac8\n\nIssue created by migration from https://trac.sagemath.org/ticket/31548\n\n",
    "created_at": "2021-03-24T15:54:33Z",
    "labels": [
        "component: linear algebra"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Create matrix class for FLINT's nmod_mat module",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31548",
    "user": "https://github.com/roed314"
}
```
This tickets adds a new class for dense matrices over `Zmod(N)` implemented using FLINT's `nmod_mat_t` type, along with some supporting ancillary changes:

* Changed echelon form over `Zmod(N)` for composite `N` to return the Howell form (see the introduction and Chapter 4 of [Storjohann's thesis](https://cs.uwaterloo.ca/~astorjoh/diss2up.pdf)).  Since this echelon form can have more rows than the input matrix, made some supporting changes including a new method `_echelon_copy`.
* Changed rank over `Zmod(N)` to return the number of leading 1s in Howell form (it raised a `NotImplementedError` before), and `pivots` to be the locations of these leading 1s.  There is also a method `_pivots` for accessing the columns where the leading entry is not 1.
* Matrices modulo composite `N` have improved speed and functionality for inversion, `charpoly`, `det`, `minpoly`, `echelon_form`, `solve_right` and `right_kernel_matrix`.  There is also a new method `minpoly_ideal` for the ideal vanishing on a matrix (the natural generalization of the minimal polynomial, which generates this ideal when it is principal).
* Changed `stack` and `augment` to return a matrix over a common base ring of the two inputs, rather than just using the top/left matrix to determine the base ring.
* A new method `_change_implementation` on matrices, together with rough heuristics for matrices on matrices mod `N` in determining when it's worth switching between FLINT and linbox (linbox is faster for large matrices, FLINT for smaller, and FLINT offers extra functionality for matrices modulo composite integers).
* Support multiplication of matrices with different implementations
* Add FLINT's `ulong_extras` for number theoretic functions on longs
* Add some iterators related to split primes in cyclotomic fields in support of changes to `matrix_cyclo_dense` (which uses a multimodular approach), and moved the `_reduction_matrix` method to the base field which will yield better caching behavior.
* Fix some doctests that relate to choosing different solutions in `solve_right` and getting different random matrices with a different implementation.

CC:  @edgarcosta

Reviewer: Travis Scrimshaw

Author: David Roe, Edgar Costa

Branch: u/roed/nmod_mat

Status: needs_work

Dependencies: #31069

Commit: a3c8e38bc674e3e7fa8c93ab04f71548fd28aac8

Issue created by migration from https://trac.sagemath.org/ticket/31548





---

archive/issue_comments_447069.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-24T16:08:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31548#issuecomment-447069",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_447070.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-24T18:28:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31548#issuecomment-447070",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_447071.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-24T19:03:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31548#issuecomment-447071",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_447072.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-24T19:45:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31548#issuecomment-447072",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_447073.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-24T19:47:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31548#issuecomment-447073",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_447074.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-24T19:49:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31548#issuecomment-447074",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_447075.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-25T16:41:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31548#issuecomment-447075",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_447076.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-26T17:17:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31548#issuecomment-447076",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_events_082913.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-27T02:13:38Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31548#event-82913"
}
```



---

archive/issue_comments_447077.json:
```json
{
    "body": "<a id='comment:10'></a>Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-03-27T02:13:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31548#issuecomment-447077",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'></a>Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_447078.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2021-03-29T21:17:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31548#issuecomment-447078",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_447079.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-30T17:51:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31548#issuecomment-447079",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_447080.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-07T07:05:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31548#issuecomment-447080",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_447081.json:
```json
{
    "body": "<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-08T21:05:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31548#issuecomment-447081",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_447082.json:
```json
{
    "body": "<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-13T17:56:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31548#issuecomment-447082",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_447083.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-16T19:04:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31548#issuecomment-447083",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_447084.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-16T22:25:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31548#issuecomment-447084",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_447085.json:
```json
{
    "body": "<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-20T07:40:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31548#issuecomment-447085",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_447086.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-04-20T07:41:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31548#issuecomment-447086",
    "user": "https://github.com/roed314"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_447087.json:
```json
{
    "body": "<a id='comment:20'></a>Marking for patchbot to test....",
    "created_at": "2021-04-20T07:41:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31548#issuecomment-447087",
    "user": "https://github.com/roed314"
}
```

<a id='comment:20'></a>Marking for patchbot to test....



---

archive/issue_comments_447088.json:
```json
{
    "body": "<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-22T19:47:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31548#issuecomment-447088",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_447089.json:
```json
{
    "body": "<a id='comment:22'></a>If you aren't yet ready for comments, I apologize. However, I made a quick skim over things before I realized you set this as needs review for the patchbot.\n\nFor `def _change_implementation`, wouldn't it make more sense to be `cdef` or `cpdef` since it should be called entirely from internal stuff? Also, in that implementation, I don't think we should use `self.list()` for spare matrices. I also generally find using `sage.matrix.matrix_space.MatrixSpace` unstable and think it is better to have a direct import.\n\nI know you said this is for the patchbot, but it would be good to have doctests for `_solve_right_modn`. I would also add\n\n```\ncdef list X\ncdef Py_ssize_t n\n```\nchange\n\n```diff\n-            X = self.matrix_space(B.ncols(), self.ncols())(X)\n-            return X.T\n+            return self.matrix_space(B.ncols(), self.ncols())(X).T\n```\n(perhaps casting the result as a matrix too), and mark `B` as a `Matrix`.\n\nI am not sure about the name of the files being `matrix_nmod_dense` and the subsequently the name of the class. It conflicts with the `matrix_modn_*` files and I feel it is too generic given that it is for a specific implementation.\n\nWhy is `poly_crt` in the matrix file?\n\n`can't` -> `cannot` as we want to make the writing formal.\n\nIt would be good to implement a `get_is_zero_unsafe` method.",
    "created_at": "2021-04-23T01:40:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31548#issuecomment-447089",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:22'></a>If you aren't yet ready for comments, I apologize. However, I made a quick skim over things before I realized you set this as needs review for the patchbot.

For `def _change_implementation`, wouldn't it make more sense to be `cdef` or `cpdef` since it should be called entirely from internal stuff? Also, in that implementation, I don't think we should use `self.list()` for spare matrices. I also generally find using `sage.matrix.matrix_space.MatrixSpace` unstable and think it is better to have a direct import.

I know you said this is for the patchbot, but it would be good to have doctests for `_solve_right_modn`. I would also add

```
cdef list X
cdef Py_ssize_t n
```
change

```diff
-            X = self.matrix_space(B.ncols(), self.ncols())(X)
-            return X.T
+            return self.matrix_space(B.ncols(), self.ncols())(X).T
```
(perhaps casting the result as a matrix too), and mark `B` as a `Matrix`.

I am not sure about the name of the files being `matrix_nmod_dense` and the subsequently the name of the class. It conflicts with the `matrix_modn_*` files and I feel it is too generic given that it is for a specific implementation.

Why is `poly_crt` in the matrix file?

`can't` -> `cannot` as we want to make the writing formal.

It would be good to implement a `get_is_zero_unsafe` method.



---

archive/issue_comments_447090.json:
```json
{
    "body": "<a id='comment:23'></a>No problem!  I'm still working on stuff, so comments are easily incorporated.  I also realized that the patchbot won't test this since it relies on spkgs until #31069 is merged.\n\nDo you think `matrix_modn_flint` and `Matrix_modn_flint` would be better?\n\nThe `poly_crt` function is left over from an earlier implementation of `charpoly` or `minpoly` (I forget which).  I will take care of it.\n\nThanks!",
    "created_at": "2021-04-23T02:08:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31548#issuecomment-447090",
    "user": "https://github.com/roed314"
}
```

<a id='comment:23'></a>No problem!  I'm still working on stuff, so comments are easily incorporated.  I also realized that the patchbot won't test this since it relies on spkgs until #31069 is merged.

Do you think `matrix_modn_flint` and `Matrix_modn_flint` would be better?

The `poly_crt` function is left over from an earlier implementation of `charpoly` or `minpoly` (I forget which).  I will take care of it.

Thanks!



---

archive/issue_comments_447091.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:23 roed]:\n> No problem!  I'm still working on stuff, so comments are easily incorporated.  I also realized that the patchbot won't test this since it relies on spkgs until #31069 is merged.\n\n\nYea, I didn't quite realize that either. ^^;;\n\n> Do you think `matrix_modn_flint` and `Matrix_modn_flint` would be better?\n\n\nThe former for the name of the file, the latter for the name of the class considering the other matrix classes in Sage.\n\nLet me know if there is anything I can do to help too.",
    "created_at": "2021-04-23T02:16:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31548#issuecomment-447091",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:24'></a>Replying to [comment:23 roed]:
> No problem!  I'm still working on stuff, so comments are easily incorporated.  I also realized that the patchbot won't test this since it relies on spkgs until #31069 is merged.


Yea, I didn't quite realize that either. ^^;;

> Do you think `matrix_modn_flint` and `Matrix_modn_flint` would be better?


The former for the name of the file, the latter for the name of the class considering the other matrix classes in Sage.

Let me know if there is anything I can do to help too.



---

archive/issue_comments_447092.json:
```json
{
    "body": "<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-26T18:11:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31548#issuecomment-447092",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_447093.json:
```json
{
    "body": "<a id='comment:26'></a>Replying to [comment:22 tscrim]:\n> For `def _change_implementation`, wouldn't it make more sense to be `cdef` or `cpdef` since it should be called entirely from internal stuff? Also, in that implementation, I don't think we should use `self.list()` for spare matrices. I also generally find using `sage.matrix.matrix_space.MatrixSpace` unstable and think it is better to have a direct import.\n\n\nEven for a 2 by 2 matrix where the calling overhead is most substantial, changing to `cpdef` makes a negligible difference:\n\n```\nsage: A = random_matrix(Zmod(120), 2)                                                                                                               \nsage: A                                                                                                                                             \n[ 32 108]\n[  2 112]\nsage: %time B = A._change_implementation(\"linbox\") # using def                                                                                                \nCPU times: user 339 \u00b5s, sys: 8 \u00b5s, total: 347 \u00b5s\nWall time: 350 \u00b5s\n```\n\n```\nsage: A = random_matrix(Zmod(120), 2) # using cpdef                                                                                                                                                                                                                       \nsage: %time B = A._change_implementation(\"linbox\")                                                                                                                                                                                                            \nCPU times: user 334 \u00b5s, sys: 5 \u00b5s, total: 339 \u00b5s\nWall time: 343 \u00b5s\n```\nI don't think it's worth the cost of recompiling everything depending on `matrix0.pxd`, and the risk of developers accidentally using `def` instead of `cpdef` on a matrix class in the future.\n\nI agree about sparse matrices, but currently in `sage.matrix.matrix_space.get_matrix_class` we don't allow the `implementation` keyword for sparse matrices, so the issue is moot.  I'd be happy to have more sparse matrices in Sage eventually, but for now there's no way to even test a version of `_change_implementation` in `Matrix_sparse`.\n\nI'm not sure what you mean by using `sage.matrix.matrix_space.MatrixSpace` unstable.  Do you mean switching to `from sage.matrix.matrix_space import MatrixSpace`?  I was just copying what's done a couple dozen lines above in `matrix2.pyx`, but I'm happy to make this change if desired.\n> \n> I know you said this is for the patchbot, but it would be good to have doctests for `_solve_right_modn`. \n\n\nAgreed.  I've added them.\n\n> I would also add\n> \n> ```\n> cdef list X\n> cdef Py_ssize_t n\n> ```\n> change\n> \n> ```diff\n> -            X = self.matrix_space(B.ncols(), self.ncols())(X)\n> -            return X.T\n> +            return self.matrix_space(B.ncols(), self.ncols())(X).T\n> ```\n> (perhaps casting the result as a matrix too), and mark `B` as a `Matrix`.\n\n\nI've added the `cdef Py_ssize_t n` since that can speed up the loop, and made the change you suggested in the diff.  I don't think it's necessary to mark `X` as a list or `B` as a matrix, since I'm not calling any functions that will benefit from knowing the types (and the runtime is surely dominated by the call to Pari's `matsolvemod`)\n\n> I am not sure about the name of the files being `matrix_nmod_dense` and the subsequently the name of the class. It conflicts with the `matrix_modn_*` files and I feel it is too generic given that it is for a specific implementation.\n\n\nAgreed.  I've changed it to `matrix_modn_dense_flint`.\n\n> Why is `poly_crt` in the matrix file?\n\n\nI've created #31731 and removed it from this ticket.\n\n> `can't` -> `cannot` as we want to make the writing formal.\n> \n> It would be good to implement a `get_is_zero_unsafe` method.\n\n\nBoth done.",
    "created_at": "2021-04-26T19:01:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31548#issuecomment-447093",
    "user": "https://github.com/roed314"
}
```

<a id='comment:26'></a>Replying to [comment:22 tscrim]:
> For `def _change_implementation`, wouldn't it make more sense to be `cdef` or `cpdef` since it should be called entirely from internal stuff? Also, in that implementation, I don't think we should use `self.list()` for spare matrices. I also generally find using `sage.matrix.matrix_space.MatrixSpace` unstable and think it is better to have a direct import.


Even for a 2 by 2 matrix where the calling overhead is most substantial, changing to `cpdef` makes a negligible difference:

```
sage: A = random_matrix(Zmod(120), 2)                                                                                                               
sage: A                                                                                                                                             
[ 32 108]
[  2 112]
sage: %time B = A._change_implementation("linbox") # using def                                                                                                
CPU times: user 339 µs, sys: 8 µs, total: 347 µs
Wall time: 350 µs
```

```
sage: A = random_matrix(Zmod(120), 2) # using cpdef                                                                                                                                                                                                                       
sage: %time B = A._change_implementation("linbox")                                                                                                                                                                                                            
CPU times: user 334 µs, sys: 5 µs, total: 339 µs
Wall time: 343 µs
```
I don't think it's worth the cost of recompiling everything depending on `matrix0.pxd`, and the risk of developers accidentally using `def` instead of `cpdef` on a matrix class in the future.

I agree about sparse matrices, but currently in `sage.matrix.matrix_space.get_matrix_class` we don't allow the `implementation` keyword for sparse matrices, so the issue is moot.  I'd be happy to have more sparse matrices in Sage eventually, but for now there's no way to even test a version of `_change_implementation` in `Matrix_sparse`.

I'm not sure what you mean by using `sage.matrix.matrix_space.MatrixSpace` unstable.  Do you mean switching to `from sage.matrix.matrix_space import MatrixSpace`?  I was just copying what's done a couple dozen lines above in `matrix2.pyx`, but I'm happy to make this change if desired.
> 
> I know you said this is for the patchbot, but it would be good to have doctests for `_solve_right_modn`. 


Agreed.  I've added them.

> I would also add
> 
> ```
> cdef list X
> cdef Py_ssize_t n
> ```
> change
> 
> ```diff
> -            X = self.matrix_space(B.ncols(), self.ncols())(X)
> -            return X.T
> +            return self.matrix_space(B.ncols(), self.ncols())(X).T
> ```
> (perhaps casting the result as a matrix too), and mark `B` as a `Matrix`.


I've added the `cdef Py_ssize_t n` since that can speed up the loop, and made the change you suggested in the diff.  I don't think it's necessary to mark `X` as a list or `B` as a matrix, since I'm not calling any functions that will benefit from knowing the types (and the runtime is surely dominated by the call to Pari's `matsolvemod`)

> I am not sure about the name of the files being `matrix_nmod_dense` and the subsequently the name of the class. It conflicts with the `matrix_modn_*` files and I feel it is too generic given that it is for a specific implementation.


Agreed.  I've changed it to `matrix_modn_dense_flint`.

> Why is `poly_crt` in the matrix file?


I've created #31731 and removed it from this ticket.

> `can't` -> `cannot` as we want to make the writing formal.
> 
> It would be good to implement a `get_is_zero_unsafe` method.


Both done.



---

archive/issue_comments_447094.json:
```json
{
    "body": "<a id='comment:27'></a>All tests pass in `matrix modules rings modular crypto`.  I'm happy to run tests on all of Sage if people are happy with the changes in principle.",
    "created_at": "2021-04-26T19:11:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31548#issuecomment-447094",
    "user": "https://github.com/roed314"
}
```

<a id='comment:27'></a>All tests pass in `matrix modules rings modular crypto`.  I'm happy to run tests on all of Sage if people are happy with the changes in principle.



---

archive/issue_comments_447095.json:
```json
{
    "body": "<a id='comment:28'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-26T19:40:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31548#issuecomment-447095",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:28'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_447096.json:
```json
{
    "body": "<a id='comment:29'></a>(I accidentally made a comment instead of editing the ticket description)\n\n---\nNew commits:",
    "created_at": "2021-04-26T19:42:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31548#issuecomment-447096",
    "user": "https://github.com/roed314"
}
```

<a id='comment:29'></a>(I accidentally made a comment instead of editing the ticket description)

---
New commits:



---

archive/issue_comments_447097.json:
```json
{
    "body": "<a id='comment:30'></a>This ticket is now actually ready for review, though the patchbot won't run currently (since it depends on #31069 which changes spkgs).",
    "created_at": "2021-04-26T19:43:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31548#issuecomment-447097",
    "user": "https://github.com/roed314"
}
```

<a id='comment:30'></a>This ticket is now actually ready for review, though the patchbot won't run currently (since it depends on #31069 which changes spkgs).



---

archive/issue_comments_447098.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-06-24T23:20:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31548#issuecomment-447098",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_447099.json:
```json
{
    "body": "<a id='comment:33'></a>Needs rebase.",
    "created_at": "2021-06-24T23:20:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31548#issuecomment-447099",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:33'></a>Needs rebase.



---

archive/issue_comments_447100.json:
```json
{
    "body": "<a id='comment:34'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-25T15:37:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31548#issuecomment-447100",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:34'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_events_082914.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31548#event-82914"
}
```



---

archive/issue_events_082915.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31548#event-82915"
}
```



---

archive/issue_comments_447101.json:
```json
{
    "body": "<a id='comment:35'></a>Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31548#issuecomment-447101",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:35'></a>Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_events_082916.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:24:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31548#event-82916"
}
```



---

archive/issue_events_082917.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:24:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31548#event-82917"
}
```



---

archive/issue_events_082918.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-02T20:27:49Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31548#event-82918"
}
```



---

archive/issue_events_082919.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-02T20:27:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31548#event-82919"
}
```



---

archive/issue_events_082920.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31548#event-82920"
}
```



---

archive/issue_events_082921.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31548",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31548#event-82921"
}
```
