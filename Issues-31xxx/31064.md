# Issue 31064: ci-cygwin*.yml: delegate to tox, add more stages, use more specific SAGE_LOCAL

archive/issues_030827.json:
```json
{
    "body": "We revise the CI workflows for Cygwin, now going through `SAGE_ROOT/tox.ini` for the package installation and invoking the new system package scripts from there.\n\nWe also add more stages to make the workflow more robust; this was originally done in #29152.\n\nWe also make another improvement that was easy to do:\nThe build now uses `SAGE_LOCAL=/opt/sage-$COMMIT` instead of `/sage/local`.\nThis will make it easier to download and install several versions of Sage.\n\n\n\nCC:  @seblabbe @kliem @antonio-rojas @embray @slel\n\nBranch/Commit: 42f4458e3ae857f82759b3c9490ab34306a15f4d\n\nReviewer: Dima Pasechnik\n\nAuthor: Matthias Koeppe\n\nDependencies: #29124, #30944, #31062, #31084\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/31064\n\n",
    "closed_at": "2021-02-20T10:46:44Z",
    "created_at": "2020-12-16T22:28:04Z",
    "labels": [
        "component: porting: cygwin",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "ci-cygwin*.yml: delegate to tox, add more stages, use more specific SAGE_LOCAL",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31064",
    "user": "https://github.com/mkoeppe"
}
```
We revise the CI workflows for Cygwin, now going through `SAGE_ROOT/tox.ini` for the package installation and invoking the new system package scripts from there.

We also add more stages to make the workflow more robust; this was originally done in #29152.

We also make another improvement that was easy to do:
The build now uses `SAGE_LOCAL=/opt/sage-$COMMIT` instead of `/sage/local`.
This will make it easier to download and install several versions of Sage.



CC:  @seblabbe @kliem @antonio-rojas @embray @slel

Branch/Commit: 42f4458e3ae857f82759b3c9490ab34306a15f4d

Reviewer: Dima Pasechnik

Author: Matthias Koeppe

Dependencies: #29124, #30944, #31062, #31084

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/31064





---

archive/issue_comments_470052.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -7,7 +7,7 @@\n Package name is required. Please pass at least one package name to install.\n Error: Process completed with exit code 1.\n ```\n-We fix it in this ticket.\n+We fix it in this ticket by going through `SAGE_ROOT/tox.ini` for the package installation and invoking the new system package scripts from there.\n \n Dependencies: #29124\n \n``````\n",
    "created_at": "2020-12-17T05:55:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470052",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -7,7 +7,7 @@
 Package name is required. Please pass at least one package name to install.
 Error: Process completed with exit code 1.
 ```
-We fix it in this ticket.
+We fix it in this ticket by going through `SAGE_ROOT/tox.ini` for the package installation and invoking the new system package scripts from there.
 
 Dependencies: #29124
 
``````




---

archive/issue_comments_470053.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-12-17T05:55:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470053",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_470054.json:
```json
{
    "body": "<a id='comment:3'></a>Last 10 new commits:",
    "created_at": "2020-12-17T05:55:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470054",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'></a>Last 10 new commits:



---

archive/issue_comments_470055.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-12-17T18:44:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470055",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_470056.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-18T00:28:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470056",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470057.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-12-18T00:28:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470057",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_470058.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-12-18T06:50:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470058",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_470059.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-18T18:15:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470059",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470060.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-18T21:14:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470060",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470061.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-19T03:12:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470061",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470062.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-12-19T03:34:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470062",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_470063.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,18 @@\n+#29124 moved the files `build/pkgs/*.txt` to new locations but forgot to update the CI scripts for Cygwin, leading to failures like this (https://github.com/mkoeppe/sage/runs/1561097256):\n+\n+```\n+sed: can't read ./build/pkgs/cygwin.txt: No such file or directory\n+sed: can't read ./build/pkgs/cygwin-bootstrap.txt: No such file or directory\n+Chocolatey v0.10.15\n+Package name is required. Please pass at least one package name to install.\n+Error: Process completed with exit code 1.\n+```\n+We fix it in this ticket by going through `SAGE_ROOT/tox.ini` for the package installation and invoking the new system package scripts from there.\n+\n+We also make another improvement that was easy to do:\n+The build now uses `SAGE_LOCAL=/opt/sage-$COMMIT` instead of `/sage/local`.\n+This will make it easier to download and install several versions of Sage.\n+\n \n \n Dependencies: #29124\n``````\n",
    "created_at": "2020-12-19T03:39:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470063",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,18 @@
+#29124 moved the files `build/pkgs/*.txt` to new locations but forgot to update the CI scripts for Cygwin, leading to failures like this (https://github.com/mkoeppe/sage/runs/1561097256):
+
+```
+sed: can't read ./build/pkgs/cygwin.txt: No such file or directory
+sed: can't read ./build/pkgs/cygwin-bootstrap.txt: No such file or directory
+Chocolatey v0.10.15
+Package name is required. Please pass at least one package name to install.
+Error: Process completed with exit code 1.
+```
+We fix it in this ticket by going through `SAGE_ROOT/tox.ini` for the package installation and invoking the new system package scripts from there.
+
+We also make another improvement that was easy to do:
+The build now uses `SAGE_LOCAL=/opt/sage-$COMMIT` instead of `/sage/local`.
+This will make it easier to download and install several versions of Sage.
+
 
 
 Dependencies: #29124
``````




---

archive/issue_comments_470064.json:
```json
{
    "body": "<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-19T17:53:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470064",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470065.json:
```json
{
    "body": "<a id='comment:16'></a>Merged #31062 to fix a merge conflict",
    "created_at": "2020-12-19T17:53:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470065",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:16'></a>Merged #31062 to fix a merge conflict



---

archive/issue_comments_470066.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-19T18:10:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470066",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470067.json:
```json
{
    "body": "<a id='comment:18'></a>Integrated the workflow changes from #29152",
    "created_at": "2020-12-19T18:25:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470067",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:18'></a>Integrated the workflow changes from #29152



---

archive/issue_comments_470068.json:
```json
{
    "body": "<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-19T19:46:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470068",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470069.json:
```json
{
    "body": "<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-20T18:29:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470069",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470070.json:
```json
{
    "body": "<a id='comment:24'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-12-20T18:31:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470070",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:24'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_470071.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-12-21T18:42:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470071",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_470072.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-12-22T01:27:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470072",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_470073.json:
```json
{
    "body": "<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-22T07:45:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470073",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470074.json:
```json
{
    "body": "<a id='comment:31'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2020-12-29T19:10:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470074",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:31'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_470075.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,11 @@\n+We revise the CI workflows for Cygwin, now going through `SAGE_ROOT/tox.ini` for the package installation and invoking the new system package scripts from there.\n+\n+We also add more stages to make the workflow more robust; this was originally done in #29152.\n+\n+We also make another improvement that was easy to do:\n+The build now uses `SAGE_LOCAL=/opt/sage-$COMMIT` instead of `/sage/local`.\n+This will make it easier to download and install several versions of Sage.\n+\n \n \n Dependencies: #29124\n``````\n",
    "created_at": "2020-12-29T19:19:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470075",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,11 @@
+We revise the CI workflows for Cygwin, now going through `SAGE_ROOT/tox.ini` for the package installation and invoking the new system package scripts from there.
+
+We also add more stages to make the workflow more robust; this was originally done in #29152.
+
+We also make another improvement that was easy to do:
+The build now uses `SAGE_LOCAL=/opt/sage-$COMMIT` instead of `/sage/local`.
+This will make it easier to download and install several versions of Sage.
+
 
 
 Dependencies: #29124
``````




---

archive/issue_comments_470076.json:
```json
{
    "body": "<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-29T19:19:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470076",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_470077.json:
```json
{
    "body": "<a id='comment:34'></a>Follow-up: #31211",
    "created_at": "2021-01-08T18:28:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470077",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:34'></a>Follow-up: #31211



---

archive/issue_comments_470078.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-01-09T12:46:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470078",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_470079.json:
```json
{
    "body": "<a id='comment:35'></a>A few remarks after skimming the changes:\n\n> +        PACKAGES=\"python38 python38-pip\"\n\n\nI think it's better to install python using the python action, which brings a few goodies along: https://github.com/marketplace/actions/setup-python\n\n> +        C:\\tools\\cygwin\\bin\\bash -l -x -c\n\nCan you try to put this as `shell: C:\\\\tools\\\\cygwin\\\\bin\\\\bash -l -x -c {0}`? Would make the workflow easier to read.\n\n\nAnd then my usual rant about using tox for this ;-). I know you are a big fan of using tox, and this is fine. But I still think it's not the best tool for github workflows. You are cramping a lot of things into one command, which makes it hard to see at which stake the workflow fails. I would propose to add helper scripts so that the workflow looks like\n- Install dependencies:\n  `choco install (build/bin/get-dependencies cygwin) --source cygwin`\n- Build: \n  `build/bin/build-local` (with the script that is currently in tox: local, running bootstrap, configure and make)\n- Test:\n  `tox` (running all python tests)\n\nThe scripts can of course be reused in `tox.ini` still giving you the chance to locally use tox for this (although I find it counterintuitive that tox might change my system installation).",
    "created_at": "2021-01-09T12:46:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470079",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:35'></a>A few remarks after skimming the changes:

> +        PACKAGES="python38 python38-pip"


I think it's better to install python using the python action, which brings a few goodies along: https://github.com/marketplace/actions/setup-python

> +        C:\tools\cygwin\bin\bash -l -x -c

Can you try to put this as `shell: C:\\tools\\cygwin\\bin\\bash -l -x -c {0}`? Would make the workflow easier to read.


And then my usual rant about using tox for this ;-). I know you are a big fan of using tox, and this is fine. But I still think it's not the best tool for github workflows. You are cramping a lot of things into one command, which makes it hard to see at which stake the workflow fails. I would propose to add helper scripts so that the workflow looks like
- Install dependencies:
  `choco install (build/bin/get-dependencies cygwin) --source cygwin`
- Build: 
  `build/bin/build-local` (with the script that is currently in tox: local, running bootstrap, configure and make)
- Test:
  `tox` (running all python tests)

The scripts can of course be reused in `tox.ini` still giving you the chance to locally use tox for this (although I find it counterintuitive that tox might change my system installation).



---

archive/issue_comments_470080.json:
```json
{
    "body": "<a id='comment:36'></a>Replying to [comment:35 gh-tobiasdiez]:\n> > +        C:\\tools\\cygwin\\bin\\bash -l -x -c\n\n> Can you try to put this as `shell: C:\\\\tools\\\\cygwin\\\\bin\\\\bash -l -x -c {0}`? Would make the workflow easier to read.\n\nI'm pretty sure I went through several iterations, including use of the shell directive, before settling on something that actually works",
    "created_at": "2021-01-09T18:08:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470080",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:36'></a>Replying to [comment:35 gh-tobiasdiez]:
> > +        C:\tools\cygwin\bin\bash -l -x -c

> Can you try to put this as `shell: C:\\tools\\cygwin\\bin\\bash -l -x -c {0}`? Would make the workflow easier to read.

I'm pretty sure I went through several iterations, including use of the shell directive, before settling on something that actually works



---

archive/issue_comments_470081.json:
```json
{
    "body": "<a id='comment:37'></a>Replying to [comment:35 gh-tobiasdiez]:\n> You are cramping a lot of things into one command, which makes it hard to see at which stake the workflow fails. \n\n\nThis has not been a problem in my experience.",
    "created_at": "2021-01-09T18:10:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470081",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:37'></a>Replying to [comment:35 gh-tobiasdiez]:
> You are cramping a lot of things into one command, which makes it hard to see at which stake the workflow fails. 


This has not been a problem in my experience.



---

archive/issue_comments_470082.json:
```json
{
    "body": "<a id='comment:38'></a>Let me explain again why I like to use `tox` to drive as much as possible in our CI. `tox` is a stable tool that has been under long term maintenance.  For context, before we (well, I) started to use GH Actions, we (well, individual developers many of whom no longer have sufficient time) used buildbot, Circle CI, Travis CI, [GitLab](GitLab) pipelines, ... Because our project is surfing on \"free compute\", the available technologies are changing faster than our project can sustain. Therefore it is important not to spend too much effort on development specific to the CI platform. \n\nThe present ticket consolidates GH Actions-specific code for installing Cygwin to just become part of the tox workflow. It is not enough to just factor through scripts that \"could\" also be run by developers on a local Windows machine: We currently do not even have any developers who do that. By using tox inside the GH Actions workflow, we actually make sure that these scripts are usable (and remain usable when changes are made) outside of a GH Actions environment.",
    "created_at": "2021-01-09T18:28:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470082",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:38'></a>Let me explain again why I like to use `tox` to drive as much as possible in our CI. `tox` is a stable tool that has been under long term maintenance.  For context, before we (well, I) started to use GH Actions, we (well, individual developers many of whom no longer have sufficient time) used buildbot, Circle CI, Travis CI, [GitLab](GitLab) pipelines, ... Because our project is surfing on "free compute", the available technologies are changing faster than our project can sustain. Therefore it is important not to spend too much effort on development specific to the CI platform. 

The present ticket consolidates GH Actions-specific code for installing Cygwin to just become part of the tox workflow. It is not enough to just factor through scripts that "could" also be run by developers on a local Windows machine: We currently do not even have any developers who do that. By using tox inside the GH Actions workflow, we actually make sure that these scripts are usable (and remain usable when changes are made) outside of a GH Actions environment.



---

archive/issue_comments_470083.json:
```json
{
    "body": "<a id='comment:39'></a>Replying to [comment:35 gh-tobiasdiez]:\n> A few remarks after skimming the changes:\n> \n> > +        PACKAGES=\"python38 python38-pip\"\n\n> \n> I think it's better to install python using the python action, which brings a few goodies along: https://github.com/marketplace/actions/setup-python\n\n\nThis is used in `choco install $PACKAGES --source cygwin` to install Cygwin and then these package in Cygwin.\n\nI don't think the setup-python action can do that.",
    "created_at": "2021-01-09T18:45:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470083",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:39'></a>Replying to [comment:35 gh-tobiasdiez]:
> A few remarks after skimming the changes:
> 
> > +        PACKAGES="python38 python38-pip"

> 
> I think it's better to install python using the python action, which brings a few goodies along: https://github.com/marketplace/actions/setup-python


This is used in `choco install $PACKAGES --source cygwin` to install Cygwin and then these package in Cygwin.

I don't think the setup-python action can do that.



---

archive/issue_comments_470084.json:
```json
{
    "body": "<a id='comment:40'></a>Thanks for the explanation. That's indeed something I understand and appreciate. My only problem is that managing the user system locally using tox is not very handy in my experience.\n\nHere is an example I was experiencing the last few hours:\nThe tox run encountered problems in the docbuild stage. The reason was/is a that ecl under wsl 1 has some problems and I needed to play around installing/deinstalling it combined with other changes. However, I couldn't use the tox command that the GH workflow uses since this installs ecl again. What I ended up doing was to copy & paste the commands printed by the tox run on github. That worked to some extend, but was a rather awful experience.\n\nI think it is good to have an easy way for developers to investigate problems in the GH workflow on their local system. And for this, it is in my opinion crucial that they can quickly recreate the state that is used. In my opinion a clearer separation in system-setup, build and test is helpful in this regard. If this can be done using tox, sure why not.",
    "created_at": "2021-01-09T18:46:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470084",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:40'></a>Thanks for the explanation. That's indeed something I understand and appreciate. My only problem is that managing the user system locally using tox is not very handy in my experience.

Here is an example I was experiencing the last few hours:
The tox run encountered problems in the docbuild stage. The reason was/is a that ecl under wsl 1 has some problems and I needed to play around installing/deinstalling it combined with other changes. However, I couldn't use the tox command that the GH workflow uses since this installs ecl again. What I ended up doing was to copy & paste the commands printed by the tox run on github. That worked to some extend, but was a rather awful experience.

I think it is good to have an easy way for developers to investigate problems in the GH workflow on their local system. And for this, it is in my opinion crucial that they can quickly recreate the state that is used. In my opinion a clearer separation in system-setup, build and test is helpful in this regard. If this can be done using tox, sure why not.



---

archive/issue_comments_470085.json:
```json
{
    "body": "<a id='comment:41'></a>Replying to [comment:40 gh-tobiasdiez]:\n> managing the user system locally using tox is not very handy in my experience.\n\n\nRight. Managing the global installation of Cygwin is not the final form of this development. What I would actually prefer (but have not had time to figure out -- any help is welcome) is to have the `local-cygwin` tox environment make an isolated installation of Cygwin. (I do this for the `local-conda` and `local-homebrew` environments.)",
    "created_at": "2021-01-09T18:53:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470085",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:41'></a>Replying to [comment:40 gh-tobiasdiez]:
> managing the user system locally using tox is not very handy in my experience.


Right. Managing the global installation of Cygwin is not the final form of this development. What I would actually prefer (but have not had time to figure out -- any help is welcome) is to have the `local-cygwin` tox environment make an isolated installation of Cygwin. (I do this for the `local-conda` and `local-homebrew` environments.)



---

archive/issue_comments_470086.json:
```json
{
    "body": "<a id='comment:42'></a>Replying to [comment:40 gh-tobiasdiez]:\n> Here is an example I was experiencing the last few hours:\n> The tox run encountered problems in the docbuild stage. The reason was/is a that ecl under wsl 1 has some problems and I needed to play around installing/deinstalling it combined with other changes. However, I couldn't use the tox command that the GH workflow uses since this installs ecl again. What I ended up doing was to copy & paste the commands printed by the tox run on github. That worked to some extend, but was a rather awful experience.\n\n\nOK, I have run into this situation too. I think what is needed for the `local-...` environments is:\n- an environment variable that can be passed to tox to disable system package installs\n- a target or environment variable to give an interactive shell.\n\nI will open a ticket for this.",
    "created_at": "2021-01-09T19:02:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470086",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:42'></a>Replying to [comment:40 gh-tobiasdiez]:
> Here is an example I was experiencing the last few hours:
> The tox run encountered problems in the docbuild stage. The reason was/is a that ecl under wsl 1 has some problems and I needed to play around installing/deinstalling it combined with other changes. However, I couldn't use the tox command that the GH workflow uses since this installs ecl again. What I ended up doing was to copy & paste the commands printed by the tox run on github. That worked to some extend, but was a rather awful experience.


OK, I have run into this situation too. I think what is needed for the `local-...` environments is:
- an environment variable that can be passed to tox to disable system package installs
- a target or environment variable to give an interactive shell.

I will open a ticket for this.



---

archive/issue_comments_470087.json:
```json
{
    "body": "<a id='comment:43'></a>That would also work, thanks! Please also give a thought to my suggestion to extract some of the scripts in tox.ini to scripts that can be called independently of tox.",
    "created_at": "2021-01-09T19:09:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470087",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:43'></a>That would also work, thanks! Please also give a thought to my suggestion to extract some of the scripts in tox.ini to scripts that can be called independently of tox.



---

archive/issue_comments_470088.json:
```json
{
    "body": "<a id='comment:44'></a>This is now #31216",
    "created_at": "2021-01-09T19:19:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470088",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:44'></a>This is now #31216



---

archive/issue_comments_470089.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-01-09T19:20:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470089",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_470090.json:
```json
{
    "body": "<a id='comment:46'></a>Replying to [comment:43 gh-tobiasdiez]:\n> Please also give a thought to my suggestion to extract some of the scripts in tox.ini to scripts that can be called independently of tox.\n\n\nI see two directions of improvement here:\n- Moving stuff from `tox.ini` (for `tox -e local-...`) and `build/bin/write-dockerfile.sh` (for `tox -e docker-...`) into our top-level `Makefile`. For example, the complicated rule for the commands of `local` consists entirely of workarounds for things that should really be fixed/improved there.\n- Improving the system package information scripts such as `sage-print-system-package-command` further.\nMeta-ticket #29146 keeps track of such improvements, let's continue there.\n\nOn the other hand, I would be reluctant to add more scripts that developers can use to set up their system automatically. As I have written elsewhere, I think the current approach of printing command lines to educate developers about how to do things on their system is better for the Sage community than trying to provide scripts that do things automagically.",
    "created_at": "2021-01-10T00:02:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470090",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:46'></a>Replying to [comment:43 gh-tobiasdiez]:
> Please also give a thought to my suggestion to extract some of the scripts in tox.ini to scripts that can be called independently of tox.


I see two directions of improvement here:
- Moving stuff from `tox.ini` (for `tox -e local-...`) and `build/bin/write-dockerfile.sh` (for `tox -e docker-...`) into our top-level `Makefile`. For example, the complicated rule for the commands of `local` consists entirely of workarounds for things that should really be fixed/improved there.
- Improving the system package information scripts such as `sage-print-system-package-command` further.
Meta-ticket #29146 keeps track of such improvements, let's continue there.

On the other hand, I would be reluctant to add more scripts that developers can use to set up their system automatically. As I have written elsewhere, I think the current approach of printing command lines to educate developers about how to do things on their system is better for the Sage community than trying to provide scripts that do things automagically.



---

archive/issue_comments_470091.json:
```json
{
    "body": "<a id='comment:47'></a>Replying to [comment:46 mkoeppe]:\n> I see two directions of improvement here: \n> Meta-ticket #29146 keeps track of such improvements, let's continue there.\n\n\nSounds good to me! Sorry for starting this somewhat off-topic discussion, but I very much appreciate your detailed explanations. It's always good to learn more about sage's inner workings ;-). I'll review this ticket as soon as the dependencies are merged (as it's hard to see right now which changes are coming from this ticket).",
    "created_at": "2021-01-10T12:38:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470091",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:47'></a>Replying to [comment:46 mkoeppe]:
> I see two directions of improvement here: 
> Meta-ticket #29146 keeps track of such improvements, let's continue there.


Sounds good to me! Sorry for starting this somewhat off-topic discussion, but I very much appreciate your detailed explanations. It's always good to learn more about sage's inner workings ;-). I'll review this ticket as soon as the dependencies are merged (as it's hard to see right now which changes are coming from this ticket).



---

archive/issue_comments_470092.json:
```json
{
    "body": "<a id='comment:48'></a>Great, and thanks for the discussion.",
    "created_at": "2021-01-10T18:25:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470092",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:48'></a>Great, and thanks for the discussion.



---

archive/issue_comments_470093.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-02-02T16:19:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470093",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_470094.json:
```json
{
    "body": "<a id='comment:49'></a>lgtm",
    "created_at": "2021-02-02T16:19:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470094",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:49'></a>lgtm



---

archive/issue_comments_470095.json:
```json
{
    "body": "<a id='comment:50'></a>Thank you!",
    "created_at": "2021-02-02T17:37:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470095",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:50'></a>Thank you!



---

archive/issue_comments_470096.json:
```json
{
    "body": "<a id='comment:51'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2021-02-07T20:44:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470096",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:51'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_470097.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2021-02-07T20:44:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470097",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_470098.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-02-07T20:44:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470098",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_470099.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-02-20T10:46:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31064#issuecomment-470099",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_081102.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-02-20T10:46:44Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31064",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31064#event-81102"
}
```
