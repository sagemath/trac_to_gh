# Issue 31132: homebrew: Unused packages (singular, pari, ...) in /usr/local leak into build when using homebrew's python3

archive/issues_030895.json:
```json
{
    "assignees": [],
    "body": "As previously discussed in #30745, `/usr/local` is leaking into our build, through wrong orders of include and/or library directives.\n\nIn #30745, this problem was not fixed but rather some more packages were found to be usable on homebrew, so distro information was added.\n\nThe problem has been reported again with `pari` (building `cypari2`) in #31029/#30589.\n\nThis is caused by a misconfigured `python3`. In this ticket, we add code to detect this problem when looking for the system python at configure time.\n\n```\nChecking whether SageMath should install SPKG python3...\nchecking whether any of libpng bzip2 xz libffi is installed as or will be installed as SPKG... no\nchecking for python3 >= 3.6.0, < 3.10.0 with modules sqlite3, ctypes, math, hashlib, crypt, readline, socket, zlib, distutils.core... \nchecking ... whether /usr/local/bin/python3 is good... no, this is a misconfigured Python whose sysconfig compiler/linker flags contain -I or -L options, which may cause wrong versions of libraries to leak into the build of Python packages - see https://trac.sagemath.org/ticket/31132; to use it anyway, use ./configure --with-python=/usr/local/bin/python3\nchecking ... whether /usr/bin/python3 is good... yes\nchecking for python3 >= 3.6.0, < 3.10.0 with modules sqlite3, ctypes, math, hashlib, crypt, readline, socket, zlib, distutils.core... /usr/bin/python3\nconfigure: will use system package and not install SPKG python3\n```\nWhen `--with-python=...` is used, only a warning is issued.\n\n\nSee also:\n- #30770 cython_aliases: Use ecl-config to determine compiler/linker flags for ecl\n- #25993 Upgrade Singular\n\nRelated homebrew issues and pull requests:\n- https://github.com/Homebrew/homebrew-core/issues/68352\n- https://github.com/Homebrew/homebrew-core/pull/68528\n- https://github.com/Homebrew/homebrew-core/issues/67388\n- https://github.com/Homebrew/homebrew-core/pull/67718\n\nDepends on #30589\n\nCC:  @orlitzky @jhpalmieri @zlscherr @kiwifb @NathanDunfield @kliem\n\nBranch: **[76d5fd1](https://github.com/sagemath/sagetrac-mirror/commit/76d5fd15f9bcc50a478471182f70ba8d46bf4319)**\n\nUpstream: **Reported upstream. No feedback yet.**\n\nReviewer: **Zachary Scherr**\n\nAuthor: **Matthias Koeppe**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/31132_\n\n",
    "closed_at": "2021-01-24T10:38:03Z",
    "created_at": "2020-12-29T19:43:03Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20build",
        "https://github.com/sagemath/sage/labels/p2%20%E2%80%93%20critical",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.3",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "homebrew: Unused packages (singular, pari, ...) in /usr/local leak into build when using homebrew's python3",
    "type": "issue",
    "updated_at": "2021-09-25T01:51:26Z",
    "url": "https://github.com/sagemath/sage/issues/31132",
    "user": "https://github.com/mkoeppe"
}
```
As previously discussed in #30745, `/usr/local` is leaking into our build, through wrong orders of include and/or library directives.

In #30745, this problem was not fixed but rather some more packages were found to be usable on homebrew, so distro information was added.

The problem has been reported again with `pari` (building `cypari2`) in #31029/#30589.

This is caused by a misconfigured `python3`. In this ticket, we add code to detect this problem when looking for the system python at configure time.

```
Checking whether SageMath should install SPKG python3...
checking whether any of libpng bzip2 xz libffi is installed as or will be installed as SPKG... no
checking for python3 >= 3.6.0, < 3.10.0 with modules sqlite3, ctypes, math, hashlib, crypt, readline, socket, zlib, distutils.core... 
checking ... whether /usr/local/bin/python3 is good... no, this is a misconfigured Python whose sysconfig compiler/linker flags contain -I or -L options, which may cause wrong versions of libraries to leak into the build of Python packages - see https://trac.sagemath.org/ticket/31132; to use it anyway, use ./configure --with-python=/usr/local/bin/python3
checking ... whether /usr/bin/python3 is good... yes
checking for python3 >= 3.6.0, < 3.10.0 with modules sqlite3, ctypes, math, hashlib, crypt, readline, socket, zlib, distutils.core... /usr/bin/python3
configure: will use system package and not install SPKG python3
```
When `--with-python=...` is used, only a warning is issued.


See also:
- #30770 cython_aliases: Use ecl-config to determine compiler/linker flags for ecl
- #25993 Upgrade Singular

Related homebrew issues and pull requests:
- https://github.com/Homebrew/homebrew-core/issues/68352
- https://github.com/Homebrew/homebrew-core/pull/68528
- https://github.com/Homebrew/homebrew-core/issues/67388
- https://github.com/Homebrew/homebrew-core/pull/67718

Depends on #30589

CC:  @orlitzky @jhpalmieri @zlscherr @kiwifb @NathanDunfield @kliem

Branch: **[76d5fd1](https://github.com/sagemath/sagetrac-mirror/commit/76d5fd15f9bcc50a478471182f70ba8d46bf4319)**

Upstream: **Reported upstream. No feedback yet.**

Reviewer: **Zachary Scherr**

Author: **Matthias Koeppe**

_Issue created by migration from https://trac.sagemath.org/ticket/31132_





---

archive/issue_events_410989.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-12-29T19:43:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31132#event-410989"
}
```



---

archive/issue_events_410990.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-12-29T19:43:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20build",
    "label_color": "000080",
    "label_name": "component: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31132#event-410990"
}
```



---

archive/issue_events_410991.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-12-29T19:43:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "label": "https://github.com/sagemath/sage/labels/p2%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31132#event-410991"
}
```



---

archive/issue_events_410992.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-12-29T19:43:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31132#event-410992"
}
```



---

archive/issue_comments_501898.json:
```json
{
    "body": "<a id='comment:1'>Comment 1:</a>\nI discovered another annoying leak while testing.  I have octave installed via homebrew and one of its dependencies is qhull.  With qhull installed via homebrew if I build sage and run\n\n\n```\n./sage -tp 8 --long --warn-long 31.1 --random-seed=0 src/sage/plot/plot3d/list_plot3d.py\n```\n\nthen it crashes with\n\n\n```\nsage: m = matrix(RDF, 6, [sin(i^2 + j^2) for i in [0,pi/5,..,pi] for j in [0,pi/5,..,pi]]) ## line 379 ##\nsage: list_plot3d(m, color='yellow', interpolation_type='linear', num_points=5) # indirect doctest ## line 380 ##\nQH6249 qh_lib_check: Incorrect qhull library called.  Size of qhT for caller is 2896, but for library is 2792.\nQH6256 qh_lib_check: Cannot continue.  Library 'qhull 7.2.0 (2015.2 2016/01/18)' uses a static qhT (e.g., libqhull.so)\n```\n\nI was able to track the problem down to matplotlib.  If I do:\n\nmake matplotlib-clean\\\\\nbrew unlink qhull\\\\\nmake matplotlib\\\\\nbrew link qhull\\\\\n\nthen the tests pass without any issues.",
    "created_at": "2020-12-31T19:48:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501898",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:1'>Comment 1:</a>
I discovered another annoying leak while testing.  I have octave installed via homebrew and one of its dependencies is qhull.  With qhull installed via homebrew if I build sage and run


```
./sage -tp 8 --long --warn-long 31.1 --random-seed=0 src/sage/plot/plot3d/list_plot3d.py
```

then it crashes with


```
sage: m = matrix(RDF, 6, [sin(i^2 + j^2) for i in [0,pi/5,..,pi] for j in [0,pi/5,..,pi]]) ## line 379 ##
sage: list_plot3d(m, color='yellow', interpolation_type='linear', num_points=5) # indirect doctest ## line 380 ##
QH6249 qh_lib_check: Incorrect qhull library called.  Size of qhT for caller is 2896, but for library is 2792.
QH6256 qh_lib_check: Cannot continue.  Library 'qhull 7.2.0 (2015.2 2016/01/18)' uses a static qhT (e.g., libqhull.so)
```

I was able to track the problem down to matplotlib.  If I do:

make matplotlib-clean\\
brew unlink qhull\\
make matplotlib\\
brew link qhull\\

then the tests pass without any issues.



---

archive/issue_comments_501899.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nI think I'll open an issue with matplotlib since it's not really a sage problem.",
    "created_at": "2020-12-31T20:04:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501899",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:2'>Comment 2:</a>
I think I'll open an issue with matplotlib since it's not really a sage problem.



---

archive/issue_comments_501900.json:
```json
{
    "body": "<a id='comment:3'>Comment 3:</a>\nI created #31148 to use system qhull when building matplotlib if it is present.  This should fix these issues.",
    "created_at": "2021-01-02T05:42:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501900",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:3'>Comment 3:</a>
I created #31148 to use system qhull when building matplotlib if it is present.  This should fix these issues.



---

archive/issue_comments_501901.json:
```json
{
    "body": "<a id='comment:4'>Comment 4:</a>\nIn #31180, @NathanDunfield pointed out that if we use `python3` from homebrew, `/usr/local/include` ends up on the front of the include search path via sysconfig `CFLAGS`.\n\n```\n>>> import sysconfig\n>>> sysconfig.get_config_var('CFLAGS')\n'-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -I/usr/local/include -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk -I/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include -I/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/System/Library/Frameworks/Tk.framework/Versions/8.5/Headers'\n```",
    "created_at": "2021-01-07T03:25:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501901",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'>Comment 4:</a>
In #31180, @NathanDunfield pointed out that if we use `python3` from homebrew, `/usr/local/include` ends up on the front of the include search path via sysconfig `CFLAGS`.

```
>>> import sysconfig
>>> sysconfig.get_config_var('CFLAGS')
'-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -I/usr/local/include -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk -I/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include -I/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/System/Library/Frameworks/Tk.framework/Versions/8.5/Headers'
```



---

archive/issue_comments_501902.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\nHappening in `setuptools._distutils.sysconfig.customize_compiler` (https://github.com/pypa/setuptools/blob/main/setuptools/_distutils/sysconfig.py#L185) via `__init_posix`",
    "created_at": "2021-01-07T04:58:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501902",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'>Comment 5:</a>
Happening in `setuptools._distutils.sysconfig.customize_compiler` (https://github.com/pypa/setuptools/blob/main/setuptools/_distutils/sysconfig.py#L185) via `__init_posix`



---

archive/issue_comments_501903.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nBy setting environment variables, one cannot override these flags, only append.",
    "created_at": "2021-01-07T05:08:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501903",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'>Comment 6:</a>
By setting environment variables, one cannot override these flags, only append.



---

archive/issue_comments_501904.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nI think this is really a packaging bug in homebrew's python3.",
    "created_at": "2021-01-07T05:08:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501904",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'>Comment 7:</a>
I think this is really a packaging bug in homebrew's python3.



---

archive/issue_comments_501905.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\nI agree that this is a packaging bug in homebrew.  I checked four other Python 3 .* packages (Ubuntu 20.04, CentOS 7, Python.org's macOS installer, Conda) and none of them have `-Iincludes` in `sysconfig.get_config_var('CFLAGS')`.",
    "created_at": "2021-01-07T15:17:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501905",
    "user": "https://github.com/NathanDunfield"
}
```

<a id='comment:8'>Comment 8:</a>
I agree that this is a packaging bug in homebrew.  I checked four other Python 3 .* packages (Ubuntu 20.04, CentOS 7, Python.org's macOS installer, Conda) and none of them have `-Iincludes` in `sysconfig.get_config_var('CFLAGS')`.



---

archive/issue_comments_501906.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nhomebrew issue: https://github.com/Homebrew/homebrew-core/issues/68352",
    "created_at": "2021-01-07T20:18:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501906",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'>Comment 9:</a>
homebrew issue: https://github.com/Homebrew/homebrew-core/issues/68352



---

archive/issue_comments_501907.json:
```json
{
    "body": "Upstream: **Reported upstream. No feedback yet.**",
    "created_at": "2021-01-07T20:29:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501907",
    "user": "https://github.com/mkoeppe"
}
```

Upstream: **Reported upstream. No feedback yet.**



---

archive/issue_events_410993.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-01-07T21:07:34Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "title_is": "homebrew: Unused packages (singular, pari, ...) in /usr/local leak into build when using homebrew's python3",
    "title_was": "homebrew: Unused packages (singular, pari, ...) in /usr/local leak into build",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31132#event-410993"
}
```



---

archive/issue_comments_501908.json:
```json
{
    "body": "Branch: **[u/mkoeppe/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_build_when_using_homebrew_s_python3](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_build_when_using_homebrew_s_python3)**",
    "created_at": "2021-01-08T02:41:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501908",
    "user": "https://github.com/mkoeppe"
}
```

Branch: **[u/mkoeppe/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_build_when_using_homebrew_s_python3](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_build_when_using_homebrew_s_python3)**



---

archive/issue_comments_501909.json:
```json
{
    "body": "Commit: **[2c60025](https://github.com/sagemath/sagetrac-mirror/commit/2c6002555d21e242ab5d1e25e4d1f3851e246532)**",
    "created_at": "2021-01-08T02:43:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501909",
    "user": "https://github.com/mkoeppe"
}
```

Commit: **[2c60025](https://github.com/sagemath/sagetrac-mirror/commit/2c6002555d21e242ab5d1e25e4d1f3851e246532)**



---

archive/issue_comments_501910.json:
```json
{
    "body": "Author: **Matthias Koeppe**",
    "created_at": "2021-01-08T02:43:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501910",
    "user": "https://github.com/mkoeppe"
}
```

Author: **Matthias Koeppe**



---

archive/issue_comments_501911.json:
```json
{
    "body": "<a id='comment:13'>Comment 13:</a>\nLet's see what the homebrew maintainers do with this.\n\nFor now the best thing we can do is detect the issue and print a warning (or we could reject the homebrew python with this issue entirely.)\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2c6002555d21e242ab5d1e25e4d1f3851e246532\">2c60025</a></td><td><code>m4/sage_check_python_for_venv.m4: Warn if python3 is misconfigured like it is currently in homebrew</code></td></tr></table>\n",
    "created_at": "2021-01-08T02:43:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501911",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'>Comment 13:</a>
Let's see what the homebrew maintainers do with this.

For now the best thing we can do is detect the issue and print a warning (or we could reject the homebrew python with this issue entirely.)

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2c6002555d21e242ab5d1e25e4d1f3851e246532">2c60025</a></td><td><code>m4/sage_check_python_for_venv.m4: Warn if python3 is misconfigured like it is currently in homebrew</code></td></tr></table>




---

archive/issue_events_410994.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-01-08T02:43:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31132#event-410994"
}
```



---

archive/issue_comments_501912.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -4,7 +4,7 @@\n \n The problem has been reported again with `pari` (building `cypari2`) in #31029/#30589.\n \n-As noted in #30745, the change in #29697 (`sage_include_directories`: Do not add another copy of `SAGE_INC`, `SAGE_LOCAL/lib` to include dirs, library dirs) may need careful reconsideration.\n+This is caused by a misconfigured `python3`. In this ticket, we add code to detect this problem when looking for the system python at configure time, and issue a warning.\n \n See also:\n - #30770 cython_aliases: Use ecl-config to determine compiler/linker flags for ecl\n``````\n",
    "created_at": "2021-01-08T02:56:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501912",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -4,7 +4,7 @@
 
 The problem has been reported again with `pari` (building `cypari2`) in #31029/#30589.
 
-As noted in #30745, the change in #29697 (`sage_include_directories`: Do not add another copy of `SAGE_INC`, `SAGE_LOCAL/lib` to include dirs, library dirs) may need careful reconsideration.
+This is caused by a misconfigured `python3`. In this ticket, we add code to detect this problem when looking for the system python at configure time, and issue a warning.
 
 See also:
 - #30770 cython_aliases: Use ecl-config to determine compiler/linker flags for ecl
``````




---

archive/issue_comments_501913.json:
```json
{
    "body": "<a id='comment:16'>Comment 16:</a>\nThis warning is buried in `config.log`. Would it be better to print it at the end, along with the instructions for what additional packages should be installed, or is that too hard to implement.",
    "created_at": "2021-01-08T06:48:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501913",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:16'>Comment 16:</a>
This warning is buried in `config.log`. Would it be better to print it at the end, along with the instructions for what additional packages should be installed, or is that too hard to implement.



---

archive/issue_comments_501914.json:
```json
{
    "body": "Changed commit from **[2c60025](https://github.com/sagemath/sagetrac-mirror/commit/2c6002555d21e242ab5d1e25e4d1f3851e246532)** to **[ee679bd](https://github.com/sagemath/sagetrac-mirror/commit/ee679bd57302d8e422e76b422d73f83ab87a4293)**",
    "created_at": "2021-01-08T17:49:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501914",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[2c60025](https://github.com/sagemath/sagetrac-mirror/commit/2c6002555d21e242ab5d1e25e4d1f3851e246532)** to **[ee679bd](https://github.com/sagemath/sagetrac-mirror/commit/ee679bd57302d8e422e76b422d73f83ab87a4293)**



---

archive/issue_comments_501915.json:
```json
{
    "body": "<a id='comment:17'>Comment 17:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ee679bd57302d8e422e76b422d73f83ab87a4293\">ee679bd</a></td><td><code>build/pkgs/python3/spkg-configure.m4: Do not check sysconfig CPPFLAGS so that /usr/bin/python3 is accepted on macOS; reject broken homebrew python3 unless requested explicitly with configgure --with-python=...</code></td></tr></table>\n",
    "created_at": "2021-01-08T17:49:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501915",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:17'>Comment 17:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ee679bd57302d8e422e76b422d73f83ab87a4293">ee679bd</a></td><td><code>build/pkgs/python3/spkg-configure.m4: Do not check sysconfig CPPFLAGS so that /usr/bin/python3 is accepted on macOS; reject broken homebrew python3 unless requested explicitly with configgure --with-python=...</code></td></tr></table>




---

archive/issue_comments_501916.json:
```json
{
    "body": "<a id='comment:18'>Comment 18:</a>\nHere's a different approach. Now actually rejecting the broken homebrew python3.\n\nFor any package, to see the reasons why a system package is rejected, one needs to scroll up in the configure output (or look into config.log)",
    "created_at": "2021-01-08T17:52:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501916",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:18'>Comment 18:</a>
Here's a different approach. Now actually rejecting the broken homebrew python3.

For any package, to see the reasons why a system package is rejected, one needs to scroll up in the configure output (or look into config.log)



---

archive/issue_comments_501917.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -4,7 +4,19 @@\n \n The problem has been reported again with `pari` (building `cypari2`) in #31029/#30589.\n \n-This is caused by a misconfigured `python3`. In this ticket, we add code to detect this problem when looking for the system python at configure time, and issue a warning.\n+This is caused by a misconfigured `python3`. In this ticket, we add code to detect this problem when looking for the system python at configure time.\n+\n+```\n+Checking whether SageMath should install SPKG python3...\n+checking whether any of libpng bzip2 xz libffi is installed as or will be installed as SPKG... no\n+checking for python3 >= 3.6.0, < 3.10.0 with modules sqlite3, ctypes, math, hashlib, crypt, readline, socket, zlib, distutils.core... \n+checking ... whether /usr/local/bin/python3 is good... no, this is a misconfigured Python whose sysconfig compiler/linker flags contain -I or -L options, which may cause wrong versions of libraries to leak into the build of Python packages - see https://trac.sagemath.org/ticket/31132; to use it anyway, use ./configure --with-python=/usr/local/bin/python3\n+checking ... whether /usr/bin/python3 is good... yes\n+checking for python3 >= 3.6.0, < 3.10.0 with modules sqlite3, ctypes, math, hashlib, crypt, readline, socket, zlib, distutils.core... /usr/bin/python3\n+configure: will use system package and not install SPKG python3\n+```\n+When `--with-python=...` is used, only a warning is issued.\n+\n \n See also:\n - #30770 cython_aliases: Use ecl-config to determine compiler/linker flags for ecl\n``````\n",
    "created_at": "2021-01-08T17:56:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501917",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -4,7 +4,19 @@
 
 The problem has been reported again with `pari` (building `cypari2`) in #31029/#30589.
 
-This is caused by a misconfigured `python3`. In this ticket, we add code to detect this problem when looking for the system python at configure time, and issue a warning.
+This is caused by a misconfigured `python3`. In this ticket, we add code to detect this problem when looking for the system python at configure time.
+
+```
+Checking whether SageMath should install SPKG python3...
+checking whether any of libpng bzip2 xz libffi is installed as or will be installed as SPKG... no
+checking for python3 >= 3.6.0, < 3.10.0 with modules sqlite3, ctypes, math, hashlib, crypt, readline, socket, zlib, distutils.core... 
+checking ... whether /usr/local/bin/python3 is good... no, this is a misconfigured Python whose sysconfig compiler/linker flags contain -I or -L options, which may cause wrong versions of libraries to leak into the build of Python packages - see https://trac.sagemath.org/ticket/31132; to use it anyway, use ./configure --with-python=/usr/local/bin/python3
+checking ... whether /usr/bin/python3 is good... yes
+checking for python3 >= 3.6.0, < 3.10.0 with modules sqlite3, ctypes, math, hashlib, crypt, readline, socket, zlib, distutils.core... /usr/bin/python3
+configure: will use system package and not install SPKG python3
+```
+When `--with-python=...` is used, only a warning is issued.
+
 
 See also:
 - #30770 cython_aliases: Use ecl-config to determine compiler/linker flags for ecl
``````




---

archive/issue_comments_501918.json:
```json
{
    "body": "<a id='comment:20'>Comment 20:</a>\nLooks okay to me. It took one machine about 30 seconds longer to build Sage when it had to build its own Python (just one iteration, so not very scientific), so avoiding homebrew's Python for now is not placing a huge burden on developers.",
    "created_at": "2021-01-09T04:11:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501918",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:20'>Comment 20:</a>
Looks okay to me. It took one machine about 30 seconds longer to build Sage when it had to build its own Python (just one iteration, so not very scientific), so avoiding homebrew's Python for now is not placing a huge burden on developers.



---

archive/issue_comments_501919.json:
```json
{
    "body": "<a id='comment:21'>Comment 21:</a>\nOn my machine (I'm still running Catalina), it accepts `/usr/bin/python3`.",
    "created_at": "2021-01-10T19:55:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501919",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:21'>Comment 21:</a>
On my machine (I'm still running Catalina), it accepts `/usr/bin/python3`.



---

archive/issue_comments_501920.json:
```json
{
    "body": "<a id='comment:22'>Comment 22:</a>\nLet's get this in please",
    "created_at": "2021-01-10T19:55:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501920",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:22'>Comment 22:</a>
Let's get this in please



---

archive/issue_comments_501921.json:
```json
{
    "body": "<a id='comment:23'>Comment 23:</a>\nlooks good to me on Mac.  Big Sur also has /usr/bin/python3 which gets picked up and accepted.",
    "created_at": "2021-01-11T00:27:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501921",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:23'>Comment 23:</a>
looks good to me on Mac.  Big Sur also has /usr/bin/python3 which gets picked up and accepted.



---

archive/issue_events_410995.json:
```json
{
    "actor": "https://github.com/zlscherr",
    "created_at": "2021-01-11T00:28:00Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31132#event-410995"
}
```



---

archive/issue_events_410996.json:
```json
{
    "actor": "https://github.com/zlscherr",
    "created_at": "2021-01-11T00:28:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31132#event-410996"
}
```



---

archive/issue_comments_501922.json:
```json
{
    "body": "Reviewer: **Zachary Scherr**",
    "created_at": "2021-01-11T00:28:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501922",
    "user": "https://github.com/zlscherr"
}
```

Reviewer: **Zachary Scherr**



---

archive/issue_comments_501923.json:
```json
{
    "body": "<a id='comment:25'>Comment 25:</a>\nsorry, might be premature in a positive review.  I'll take a second look later on.",
    "created_at": "2021-01-11T00:31:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501923",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:25'>Comment 25:</a>
sorry, might be premature in a positive review.  I'll take a second look later on.



---

archive/issue_events_410997.json:
```json
{
    "actor": "https://github.com/zlscherr",
    "created_at": "2021-01-11T00:31:41Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31132#event-410997"
}
```



---

archive/issue_events_410998.json:
```json
{
    "actor": "https://github.com/zlscherr",
    "created_at": "2021-01-11T00:31:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31132#event-410998"
}
```



---

archive/issue_comments_501924.json:
```json
{
    "body": "<a id='comment:26'>Comment 26:</a>\nReplying to [@mkoeppe](#comment%3A21):\n> On my machine (I'm still running Catalina), it accepts `/usr/bin/python3`.\n\nNot for me:\n\n```\n% ./configure --with-python=/usr/bin/python3\n...\nchecking for /usr/bin/python3... /usr/bin/python3\nchecking ... whether /usr/bin/python3 is good... no, the version is in the supported range, and the modules can be imported, but distutils cannot build a C extension\nconfigure: error: the python3 selected using --with-python=/usr/bin/python3 is not suitable\n```\n\n(This is on a machine running Catalina.)",
    "created_at": "2021-01-11T00:33:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501924",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:26'>Comment 26:</a>
Replying to [@mkoeppe](#comment%3A21):
> On my machine (I'm still running Catalina), it accepts `/usr/bin/python3`.

Not for me:

```
% ./configure --with-python=/usr/bin/python3
...
checking for /usr/bin/python3... /usr/bin/python3
checking ... whether /usr/bin/python3 is good... no, the version is in the supported range, and the modules can be imported, but distutils cannot build a C extension
configure: error: the python3 selected using --with-python=/usr/bin/python3 is not suitable
```

(This is on a machine running Catalina.)



---

archive/issue_comments_501925.json:
```json
{
    "body": "<a id='comment:27'>Comment 27:</a>\nI think that building using the included version of Python 3 on OS X is not required for this \u2014\u00a0Sage can just build its own Python \u2014 but in case anyone wants to help troubleshoot, here is an excerpt from `config.log`:\n\n```\n## -------------------------------------------------------- ##\n## Checking whether SageMath should install SPKG python3... ##\n## -------------------------------------------------------- ##\nconfigure:31741: checking whether any of libpng bzip2 xz libffi is installed as or will be installed as SPKG\nconfigure:31750: result: no\nconfigure:31756: checking for python3 >= 3.6.0, < 3.10.0 with modules sqlite3, ctypes, math, hashlib, crypt, readline, socket, zlib, distutils.core\nconfigure:31763: result: \nconfigure:31767: checking for /usr/bin/python3\nconfigure:31797: result: /usr/bin/python3\nconfigure:31812: checking ... whether /usr/bin/python3 is good\nCC=gcc CXX=g++ -std=gnu++11 conftest_venv/bin/python3 conftest.py --verbose build --build-base=conftest.dir\nrunning build\nrunning build_ext\nbuilding 'config_check_distutils' extension\ncreating conftest.dir\ncreating conftest.dir/temp.macosx-10.14.6-x86_64-3.8\ngcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64 -I/Users/jpalmier/Desktop/Sage/git/sage/conftest_venv/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -c conftest.c -o conftest.dir/temp.macosx-10.14.6-x86_64-3.8/conftest.o\nIn file included from conftest.c:66:\nIn file included from /Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8/Python.h:11:\nIn file included from /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/clang/12.0.0/include/limits.h:21:\nIn file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/limits.h:63:\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/cdefs.h:807:2: error: Unsupported architecture\n#error Unsupported architecture\n ^\nIn file included from conftest.c:66:\nIn file included from /Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8/Python.h:11:\nIn file included from /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/clang/12.0.0/include/limits.h:21:\nIn file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/limits.h:64:\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/machine/limits.h:8:2: error: architecture not supported\n#error architecture not supported\n ^\nIn file included from conftest.c:66:\nIn file included from /Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8/Python.h:25:\nIn file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/stdio.h:64:\nIn file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/_stdio.h:71:\nIn file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/_types.h:27:\nIn file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:33:\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/machine/_types.h:34:2: error: architecture not supported\n#error architecture not supported\n ^\nIn file included from conftest.c:66:\nIn file included from /Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8/Python.h:25:\nIn file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/stdio.h:64:\nIn file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/_stdio.h:71:\nIn file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/_types.h:27:\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:55:9: error: unknown type name '__int64_t'\ntypedef __int64_t       __darwin_blkcnt_t;      /* total blocks */\n        ^\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:56:9: error: unknown type name '__int32_t'; did you mean '__int128_t'?\ntypedef __int32_t       __darwin_blksize_t;     /* preferred block size */\n        ^\nnote: '__int128_t' declared here\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:57:9: error: unknown type name '__int32_t'; did you mean '__int128_t'?\ntypedef __int32_t       __darwin_dev_t;         /* dev_t */\n        ^\nnote: '__int128_t' declared here\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:60:9: error: unknown type name '__uint32_t'; did you mean '__uint128_t'?\ntypedef __uint32_t      __darwin_gid_t;         /* [???] process and group IDs */\n        ^\nnote: '__uint128_t' declared here\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:61:9: error: unknown type name '__uint32_t'; did you mean '__uint128_t'?\ntypedef __uint32_t      __darwin_id_t;          /* [XSI] pid_t, uid_t, or gid_t*/\n        ^\nnote: '__uint128_t' declared here\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:62:9: error: unknown type name '__uint64_t'\ntypedef __uint64_t      __darwin_ino64_t;       /* [???] Used for 64 bit inodes */\n        ^\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:68:9: error: unknown type name '__darwin_natural_t'\ntypedef __darwin_natural_t __darwin_mach_port_name_t; /* Used by mach */\n        ^\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:70:9: error: unknown type name '__uint16_t'; did you mean '__uint128_t'?\ntypedef __uint16_t      __darwin_mode_t;        /* [???] Some file attributes */\n        ^\nnote: '__uint128_t' declared here\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:71:9: error: unknown type name '__int64_t'\ntypedef __int64_t       __darwin_off_t;         /* [???] Used for file sizes */\n        ^\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:72:9: error: unknown type name '__int32_t'; did you mean '__int128_t'?\ntypedef __int32_t       __darwin_pid_t;         /* [???] process and group IDs */\n        ^\nnote: '__int128_t' declared here\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:73:9: error: unknown type name '__uint32_t'; did you mean '__uint128_t'?\ntypedef __uint32_t      __darwin_sigset_t;      /* [???] signal set */\n        ^\nnote: '__uint128_t' declared here\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:74:9: error: unknown type name '__int32_t'; did you mean '__int128_t'?\ntypedef __int32_t       __darwin_suseconds_t;   /* [???] microseconds */\n        ^\nnote: '__int128_t' declared here\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:75:9: error: unknown type name '__uint32_t'; did you mean '__uint128_t'?\ntypedef __uint32_t      __darwin_uid_t;         /* [???] user IDs */\n        ^\nnote: '__uint128_t' declared here\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:76:9: error: unknown type name '__uint32_t'; did you mean '__uint128_t'?\ntypedef __uint32_t      __darwin_useconds_t;    /* [???] microseconds */\n        ^\nnote: '__uint128_t' declared here\nIn file included from conftest.c:66:\nIn file included from /Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8/Python.h:25:\nIn file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/stdio.h:64:\nIn file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/_stdio.h:71:\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/_types.h:43:9: error: unknown type name '__uint32_t'; did you mean '__uint128_t'?\ntypedef __uint32_t      __darwin_wctype_t;\n        ^\nnote: '__uint128_t' declared here\nIn file included from conftest.c:66:\nIn file included from /Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8/Python.h:25:\nIn file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/stdio.h:64:\nIn file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/_stdio.h:75:\nIn file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types/_va_list.h:31:\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/machine/types.h:37:2: error: architecture not supported\n#error architecture not supported\n ^\nfatal error: too many errors emitted, stopping now [-ferror-limit=]\n20 errors generated.\nerror: command 'gcc' failed with exit status 1\nconfigure:32019: result: no, the version is in the supported range, and the modules can be imported, but distutils cannot build a C extension\nconfigure:32062: error: the python3 selected using --with-python=/usr/bin/python3 is not suitable\n```",
    "created_at": "2021-01-11T00:37:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501925",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:27'>Comment 27:</a>
I think that building using the included version of Python 3 on OS X is not required for this — Sage can just build its own Python — but in case anyone wants to help troubleshoot, here is an excerpt from `config.log`:

```
## -------------------------------------------------------- ##
## Checking whether SageMath should install SPKG python3... ##
## -------------------------------------------------------- ##
configure:31741: checking whether any of libpng bzip2 xz libffi is installed as or will be installed as SPKG
configure:31750: result: no
configure:31756: checking for python3 >= 3.6.0, < 3.10.0 with modules sqlite3, ctypes, math, hashlib, crypt, readline, socket, zlib, distutils.core
configure:31763: result: 
configure:31767: checking for /usr/bin/python3
configure:31797: result: /usr/bin/python3
configure:31812: checking ... whether /usr/bin/python3 is good
CC=gcc CXX=g++ -std=gnu++11 conftest_venv/bin/python3 conftest.py --verbose build --build-base=conftest.dir
running build
running build_ext
building 'config_check_distutils' extension
creating conftest.dir
creating conftest.dir/temp.macosx-10.14.6-x86_64-3.8
gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64 -I/Users/jpalmier/Desktop/Sage/git/sage/conftest_venv/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -c conftest.c -o conftest.dir/temp.macosx-10.14.6-x86_64-3.8/conftest.o
In file included from conftest.c:66:
In file included from /Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8/Python.h:11:
In file included from /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/clang/12.0.0/include/limits.h:21:
In file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/limits.h:63:
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/cdefs.h:807:2: error: Unsupported architecture
#error Unsupported architecture
 ^
In file included from conftest.c:66:
In file included from /Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8/Python.h:11:
In file included from /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/clang/12.0.0/include/limits.h:21:
In file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/limits.h:64:
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/machine/limits.h:8:2: error: architecture not supported
#error architecture not supported
 ^
In file included from conftest.c:66:
In file included from /Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8/Python.h:25:
In file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/stdio.h:64:
In file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/_stdio.h:71:
In file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/_types.h:27:
In file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:33:
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/machine/_types.h:34:2: error: architecture not supported
#error architecture not supported
 ^
In file included from conftest.c:66:
In file included from /Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8/Python.h:25:
In file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/stdio.h:64:
In file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/_stdio.h:71:
In file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/_types.h:27:
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:55:9: error: unknown type name '__int64_t'
typedef __int64_t       __darwin_blkcnt_t;      /* total blocks */
        ^
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:56:9: error: unknown type name '__int32_t'; did you mean '__int128_t'?
typedef __int32_t       __darwin_blksize_t;     /* preferred block size */
        ^
note: '__int128_t' declared here
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:57:9: error: unknown type name '__int32_t'; did you mean '__int128_t'?
typedef __int32_t       __darwin_dev_t;         /* dev_t */
        ^
note: '__int128_t' declared here
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:60:9: error: unknown type name '__uint32_t'; did you mean '__uint128_t'?
typedef __uint32_t      __darwin_gid_t;         /* [???] process and group IDs */
        ^
note: '__uint128_t' declared here
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:61:9: error: unknown type name '__uint32_t'; did you mean '__uint128_t'?
typedef __uint32_t      __darwin_id_t;          /* [XSI] pid_t, uid_t, or gid_t*/
        ^
note: '__uint128_t' declared here
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:62:9: error: unknown type name '__uint64_t'
typedef __uint64_t      __darwin_ino64_t;       /* [???] Used for 64 bit inodes */
        ^
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:68:9: error: unknown type name '__darwin_natural_t'
typedef __darwin_natural_t __darwin_mach_port_name_t; /* Used by mach */
        ^
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:70:9: error: unknown type name '__uint16_t'; did you mean '__uint128_t'?
typedef __uint16_t      __darwin_mode_t;        /* [???] Some file attributes */
        ^
note: '__uint128_t' declared here
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:71:9: error: unknown type name '__int64_t'
typedef __int64_t       __darwin_off_t;         /* [???] Used for file sizes */
        ^
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:72:9: error: unknown type name '__int32_t'; did you mean '__int128_t'?
typedef __int32_t       __darwin_pid_t;         /* [???] process and group IDs */
        ^
note: '__int128_t' declared here
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:73:9: error: unknown type name '__uint32_t'; did you mean '__uint128_t'?
typedef __uint32_t      __darwin_sigset_t;      /* [???] signal set */
        ^
note: '__uint128_t' declared here
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:74:9: error: unknown type name '__int32_t'; did you mean '__int128_t'?
typedef __int32_t       __darwin_suseconds_t;   /* [???] microseconds */
        ^
note: '__int128_t' declared here
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:75:9: error: unknown type name '__uint32_t'; did you mean '__uint128_t'?
typedef __uint32_t      __darwin_uid_t;         /* [???] user IDs */
        ^
note: '__uint128_t' declared here
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:76:9: error: unknown type name '__uint32_t'; did you mean '__uint128_t'?
typedef __uint32_t      __darwin_useconds_t;    /* [???] microseconds */
        ^
note: '__uint128_t' declared here
In file included from conftest.c:66:
In file included from /Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8/Python.h:25:
In file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/stdio.h:64:
In file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/_stdio.h:71:
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/_types.h:43:9: error: unknown type name '__uint32_t'; did you mean '__uint128_t'?
typedef __uint32_t      __darwin_wctype_t;
        ^
note: '__uint128_t' declared here
In file included from conftest.c:66:
In file included from /Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8/Python.h:25:
In file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/stdio.h:64:
In file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/_stdio.h:75:
In file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types/_va_list.h:31:
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/machine/types.h:37:2: error: architecture not supported
#error architecture not supported
 ^
fatal error: too many errors emitted, stopping now [-ferror-limit=]
20 errors generated.
error: command 'gcc' failed with exit status 1
configure:32019: result: no, the version is in the supported range, and the modules can be imported, but distutils cannot build a C extension
configure:32062: error: the python3 selected using --with-python=/usr/bin/python3 is not suitable
```



---

archive/issue_comments_501926.json:
```json
{
    "body": "<a id='comment:28'>Comment 28:</a>\non Big Sur, configure allowed me to use /usr/bin/python3 but then Cython failed to build.\n\n\n```\n  gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64 -O2 -g -march=native -I/Users/zscherr/sage/develop/local/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -c /private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-p2i1cj72/Cython/Plex/Scanners.c -o build/temp.macosx-10.14.6-x86_64-3.8/private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-p2i1cj72/Cython/Plex/Scanners.o\n  clang: error: the clang compiler does not support '-march=native'\n  error: command 'gcc' failed with exit status 1\n```",
    "created_at": "2021-01-11T00:44:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501926",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:28'>Comment 28:</a>
on Big Sur, configure allowed me to use /usr/bin/python3 but then Cython failed to build.


```
  gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64 -O2 -g -march=native -I/Users/zscherr/sage/develop/local/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -c /private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-p2i1cj72/Cython/Plex/Scanners.c -o build/temp.macosx-10.14.6-x86_64-3.8/private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-p2i1cj72/Cython/Plex/Scanners.o
  clang: error: the clang compiler does not support '-march=native'
  error: command 'gcc' failed with exit status 1
```



---

archive/issue_comments_501927.json:
```json
{
    "body": "<a id='comment:29'>Comment 29:</a>\nAlso on Big Sur I am not able to build python3 through sage (with or without this ticket).  Doing\n\nsource .homebrew-build-env\\\\\n./configure --with-system-python3=no\\\\\nmake python3\\\\\n\nends with an error\n\n\n```\n[python3-3.8.5] ld: warning: dylib (/usr/local/lib/libintl.dylib) was built for newer macOS version (10.15) than being linked (10.9)\n[python3-3.8.5] sed -e \"s,@EXENAME@,/Users/zscherr/sage/develop/local/bin/python3.8,\" < ./Misc/python-config.in >python-config.py\n[python3-3.8.5] LC_ALL=C sed -e 's,\\$(\\([A-Za-z0-9_]*\\)),\\$\\{\\1\\},g' < Misc/python-config.sh >python-config\n[python3-3.8.5] Testing importing of various modules...\n[python3-3.8.5] ctypes module imported OK\n[python3-3.8.5] math module imported OK\n[python3-3.8.5] hashlib module imported OK\n[python3-3.8.5] crypt module imported OK\n[python3-3.8.5] Traceback (most recent call last):\n[python3-3.8.5]   File \"<string>\", line 1, in <module>\n[python3-3.8.5] ModuleNotFoundError: No module named 'readline'\n[python3-3.8.5] readline module failed to import\n[python3-3.8.5] socket module imported OK\n[python3-3.8.5] Traceback (most recent call last):\n[python3-3.8.5]   File \"<string>\", line 1, in <module>\n[python3-3.8.5] ModuleNotFoundError: No module named 'zlib'\n[python3-3.8.5] zlib module failed to import\n[python3-3.8.5] sqlite3 module imported OK\n[python3-3.8.5] _scproxy module imported OK\n[python3-3.8.5] Error: One or more modules failed to import.\n```\n\nI don't think I've ever tried building python3 from scratch since I always have relied on homebrew's version, so I'm not sure where this is coming from.",
    "created_at": "2021-01-11T02:34:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501927",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:29'>Comment 29:</a>
Also on Big Sur I am not able to build python3 through sage (with or without this ticket).  Doing

source .homebrew-build-env\\
./configure --with-system-python3=no\\
make python3\\

ends with an error


```
[python3-3.8.5] ld: warning: dylib (/usr/local/lib/libintl.dylib) was built for newer macOS version (10.15) than being linked (10.9)
[python3-3.8.5] sed -e "s,@EXENAME@,/Users/zscherr/sage/develop/local/bin/python3.8," < ./Misc/python-config.in >python-config.py
[python3-3.8.5] LC_ALL=C sed -e 's,\$(\([A-Za-z0-9_]*\)),\$\{\1\},g' < Misc/python-config.sh >python-config
[python3-3.8.5] Testing importing of various modules...
[python3-3.8.5] ctypes module imported OK
[python3-3.8.5] math module imported OK
[python3-3.8.5] hashlib module imported OK
[python3-3.8.5] crypt module imported OK
[python3-3.8.5] Traceback (most recent call last):
[python3-3.8.5]   File "<string>", line 1, in <module>
[python3-3.8.5] ModuleNotFoundError: No module named 'readline'
[python3-3.8.5] readline module failed to import
[python3-3.8.5] socket module imported OK
[python3-3.8.5] Traceback (most recent call last):
[python3-3.8.5]   File "<string>", line 1, in <module>
[python3-3.8.5] ModuleNotFoundError: No module named 'zlib'
[python3-3.8.5] zlib module failed to import
[python3-3.8.5] sqlite3 module imported OK
[python3-3.8.5] _scproxy module imported OK
[python3-3.8.5] Error: One or more modules failed to import.
```

I don't think I've ever tried building python3 from scratch since I always have relied on homebrew's version, so I'm not sure where this is coming from.



---

archive/issue_comments_501928.json:
```json
{
    "body": "<a id='comment:30'>Comment 30:</a>\nReplying to [@zlscherr](#comment%3A28):\n> on Big Sur, configure allowed me to use /usr/bin/python3 but then Cython failed to build.\n> \n> \n> ```\n>   gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64 -O2 -g -march=native -I/Users/zscherr/sage/develop/local/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -c /private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-p2i1cj72/Cython/Plex/Scanners.c -o build/temp.macosx-10.14.6-x86_64-3.8/private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-p2i1cj72/Cython/Plex/Scanners.o\n>   clang: error: the clang compiler does not support '-march=native'\n>   error: command 'gcc' failed with exit status 1\n> ```\n\nThis looks like a complication that may have come in through #27122",
    "created_at": "2021-01-11T03:12:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501928",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:30'>Comment 30:</a>
Replying to [@zlscherr](#comment%3A28):
> on Big Sur, configure allowed me to use /usr/bin/python3 but then Cython failed to build.
> 
> 
> ```
>   gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64 -O2 -g -march=native -I/Users/zscherr/sage/develop/local/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -c /private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-p2i1cj72/Cython/Plex/Scanners.c -o build/temp.macosx-10.14.6-x86_64-3.8/private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-p2i1cj72/Cython/Plex/Scanners.o
>   clang: error: the clang compiler does not support '-march=native'
>   error: command 'gcc' failed with exit status 1
> ```

This looks like a complication that may have come in through #27122



---

archive/issue_comments_501929.json:
```json
{
    "body": "<a id='comment:31'>Comment 31:</a>\nReplying to [@zlscherr](#comment%3A29):\n> Also on Big Sur I am not able to build python3 through sage (with or without this ticket).  \n\nI think we need the upgrade to python 3.9 for this in #30589",
    "created_at": "2021-01-11T03:15:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501929",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:31'>Comment 31:</a>
Replying to [@zlscherr](#comment%3A29):
> Also on Big Sur I am not able to build python3 through sage (with or without this ticket).  

I think we need the upgrade to python 3.9 for this in #30589



---

archive/issue_comments_501930.json:
```json
{
    "body": "<a id='comment:32'>Comment 32:</a>\nReplying to [@zlscherr](#comment%3A29):\n> I don't think I've ever tried building python3 from scratch since I always have relied on homebrew's version, so I'm not sure where this is coming from.\n\nLooks like there are two missing libraries, readline and zlib.  For brew, readline is \"keg only\", and I get the following message when I install it:\n\n```\nreadline is keg-only, which means it was not symlinked into /usr/local,\nbecause macOS provides BSD libedit.\n\nFor compilers to find readline you may need to set:\n  export LDFLAGS=\"-L/usr/local/opt/readline/lib\"\n  export CPPFLAGS=\"-I/usr/local/opt/readline/include\"\n\nFor pkg-config to find readline you may need to set:\n  export PKG_CONFIG_PATH=\"/usr/local/opt/readline/lib/pkgconfig\"\n```\nI didn't check, but likely zlib is similar. The fix should be to tell `configure` to look in `/usr/local/opt/readline` in addition to `/usr/local`.",
    "created_at": "2021-01-11T03:16:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501930",
    "user": "https://github.com/NathanDunfield"
}
```

<a id='comment:32'>Comment 32:</a>
Replying to [@zlscherr](#comment%3A29):
> I don't think I've ever tried building python3 from scratch since I always have relied on homebrew's version, so I'm not sure where this is coming from.

Looks like there are two missing libraries, readline and zlib.  For brew, readline is "keg only", and I get the following message when I install it:

```
readline is keg-only, which means it was not symlinked into /usr/local,
because macOS provides BSD libedit.

For compilers to find readline you may need to set:
  export LDFLAGS="-L/usr/local/opt/readline/lib"
  export CPPFLAGS="-I/usr/local/opt/readline/include"

For pkg-config to find readline you may need to set:
  export PKG_CONFIG_PATH="/usr/local/opt/readline/lib/pkgconfig"
```
I didn't check, but likely zlib is similar. The fix should be to tell `configure` to look in `/usr/local/opt/readline` in addition to `/usr/local`.



---

archive/issue_comments_501931.json:
```json
{
    "body": "<a id='comment:33'>Comment 33:</a>\nReplying to [@jhpalmieri](#comment%3A27):\n> I think that building using the included version of Python 3 on OS X is not required for this \u2014\u00a0Sage can just build its own Python \u2014 but in case anyone wants to help troubleshoot, here is an excerpt from `config.log`:\n> \n> ```\n> ## -------------------------------------------------------- ##\n> ## Checking whether SageMath should install SPKG python3... ##\n> ## -------------------------------------------------------- ##\n> configure:31741: checking whether any of libpng bzip2 xz libffi is installed as or will be installed as SPKG\n> configure:31750: result: no\n> configure:31756: checking for python3 >= 3.6.0, < 3.10.0 with modules sqlite3, ctypes, math, hashlib, crypt, readline, socket, zlib, distutils.core\n> configure:31763: result: \n> configure:31767: checking for /usr/bin/python3\n> configure:31797: result: /usr/bin/python3\n> configure:31812: checking ... whether /usr/bin/python3 is good\n> CC=gcc CXX=g++ -std=gnu++11 conftest_venv/bin/python3 conftest.py --verbose build --build-base=conftest.dir\n> running build\n> running build_ext\n> building 'config_check_distutils' extension\n> creating conftest.dir\n> creating conftest.dir/temp.macosx-10.14.6-x86_64-3.8\n> gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64 -I/Users/jpalmier/Desktop/Sage/git/sage/conftest_venv/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -c conftest.c -o conftest.dir/temp.macosx-10.14.6-x86_64-3.8/conftest.o\n> ```\n\nThe `-arch arm64 -arch x86_64` there looks scary.\n\nCould you post the whole config.log please",
    "created_at": "2021-01-11T03:30:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501931",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:33'>Comment 33:</a>
Replying to [@jhpalmieri](#comment%3A27):
> I think that building using the included version of Python 3 on OS X is not required for this — Sage can just build its own Python — but in case anyone wants to help troubleshoot, here is an excerpt from `config.log`:
> 
> ```
> ## -------------------------------------------------------- ##
> ## Checking whether SageMath should install SPKG python3... ##
> ## -------------------------------------------------------- ##
> configure:31741: checking whether any of libpng bzip2 xz libffi is installed as or will be installed as SPKG
> configure:31750: result: no
> configure:31756: checking for python3 >= 3.6.0, < 3.10.0 with modules sqlite3, ctypes, math, hashlib, crypt, readline, socket, zlib, distutils.core
> configure:31763: result: 
> configure:31767: checking for /usr/bin/python3
> configure:31797: result: /usr/bin/python3
> configure:31812: checking ... whether /usr/bin/python3 is good
> CC=gcc CXX=g++ -std=gnu++11 conftest_venv/bin/python3 conftest.py --verbose build --build-base=conftest.dir
> running build
> running build_ext
> building 'config_check_distutils' extension
> creating conftest.dir
> creating conftest.dir/temp.macosx-10.14.6-x86_64-3.8
> gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64 -I/Users/jpalmier/Desktop/Sage/git/sage/conftest_venv/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -c conftest.c -o conftest.dir/temp.macosx-10.14.6-x86_64-3.8/conftest.o
> ```

The `-arch arm64 -arch x86_64` there looks scary.

Could you post the whole config.log please



---

archive/issue_comments_501932.json:
```json
{
    "body": "<a id='comment:34'>Comment 34:</a>\nReplying to [@NathanDunfield](#comment%3A32):\n> Looks like there are two missing libraries, readline and zlib.  For brew, readline is \"keg only\", and I get the following message when I install it:\n> \n> ```\n> readline is keg-only, which means it was not symlinked into /usr/local,\n> because macOS provides BSD libedit.\n> \n> For compilers to find readline you may need to set:\n>   export LDFLAGS=\"-L/usr/local/opt/readline/lib\"\n>   export CPPFLAGS=\"-I/usr/local/opt/readline/include\"\n> \n> For pkg-config to find readline you may need to set:\n>   export PKG_CONFIG_PATH=\"/usr/local/opt/readline/lib/pkgconfig\"\n> ```\n> I didn't check, but likely zlib is similar. The fix should be to tell `configure` to look in `/usr/local/opt/readline` in addition to `/usr/local`.\n\nWe already do that in `.homebrew-build-env`",
    "created_at": "2021-01-11T03:32:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501932",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:34'>Comment 34:</a>
Replying to [@NathanDunfield](#comment%3A32):
> Looks like there are two missing libraries, readline and zlib.  For brew, readline is "keg only", and I get the following message when I install it:
> 
> ```
> readline is keg-only, which means it was not symlinked into /usr/local,
> because macOS provides BSD libedit.
> 
> For compilers to find readline you may need to set:
>   export LDFLAGS="-L/usr/local/opt/readline/lib"
>   export CPPFLAGS="-I/usr/local/opt/readline/include"
> 
> For pkg-config to find readline you may need to set:
>   export PKG_CONFIG_PATH="/usr/local/opt/readline/lib/pkgconfig"
> ```
> I didn't check, but likely zlib is similar. The fix should be to tell `configure` to look in `/usr/local/opt/readline` in addition to `/usr/local`.

We already do that in `.homebrew-build-env`



---

archive/issue_comments_501933.json:
```json
{
    "body": "<a id='comment:35'>Comment 35:</a>\nI just wanted to confirm that on Big Sur I have no trouble building sage's python and Cython using ticket #30589, provided that I run configure with --with-system-python3=no.",
    "created_at": "2021-01-11T05:41:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501933",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:35'>Comment 35:</a>
I just wanted to confirm that on Big Sur I have no trouble building sage's python and Cython using ticket #30589, provided that I run configure with --with-system-python3=no.



---

archive/issue_comments_501934.json:
```json
{
    "body": "<a id='comment:36'>Comment 36:</a>\nAttachment: **[config.log](https://github.com/sagemath/sage/files/ticket31132/config.log)**\n\nReplying to [@mkoeppe](#comment%3A33):\n> \n> The `-arch arm64 -arch x86_64` there looks scary.\n> \n> Could you post the whole config.log please\n\nHere it is.",
    "created_at": "2021-01-11T18:15:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501934",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:36'>Comment 36:</a>
Attachment: **[config.log](https://github.com/sagemath/sage/files/ticket31132/config.log)**

Replying to [@mkoeppe](#comment%3A33):
> 
> The `-arch arm64 -arch x86_64` there looks scary.
> 
> Could you post the whole config.log please

Here it is.



---

archive/issue_comments_501935.json:
```json
{
    "body": "<a id='comment:37'>Comment 37:</a>\nI don't know anything about this, but my guess is that `-arch arm64 -arch x86_64` is because Mac is pushing to build universal binaries, so it may have been introduced in the latest Xcode/CLT on Big Sur.",
    "created_at": "2021-01-11T19:49:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501935",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:37'>Comment 37:</a>
I don't know anything about this, but my guess is that `-arch arm64 -arch x86_64` is because Mac is pushing to build universal binaries, so it may have been introduced in the latest Xcode/CLT on Big Sur.



---

archive/issue_comments_501936.json:
```json
{
    "body": "<a id='comment:38'>Comment 38:</a>\nReplying to [@zlscherr](#comment%3A37):\n> I don't know anything about this, but my guess is that `-arch arm64 -arch x86_64` is because Mac is pushing to build universal binaries, so it may have been introduced in the latest Xcode/CLT on Big Sur.\n\nYes, I have just updated my CLT to 12.3 and now also see this on my machine. (Still running on Catalina.)",
    "created_at": "2021-01-13T00:56:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501936",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:38'>Comment 38:</a>
Replying to [@zlscherr](#comment%3A37):
> I don't know anything about this, but my guess is that `-arch arm64 -arch x86_64` is because Mac is pushing to build universal binaries, so it may have been introduced in the latest Xcode/CLT on Big Sur.

Yes, I have just updated my CLT to 12.3 and now also see this on my machine. (Still running on Catalina.)



---

archive/issue_comments_501937.json:
```json
{
    "body": "<a id='comment:39'>Comment 39:</a>\nA workaround from https://github.com/tensorflow/io/pull/1168/files\nis to pass `ARCHFLAGS=\"-arch x86_64\"`",
    "created_at": "2021-01-13T00:59:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501937",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:39'>Comment 39:</a>
A workaround from https://github.com/tensorflow/io/pull/1168/files
is to pass `ARCHFLAGS="-arch x86_64"`



---

archive/issue_comments_501938.json:
```json
{
    "body": "<a id='comment:40'>Comment 40:</a>\nAlso `ARCHFLAGS=\"\"` works for me.",
    "created_at": "2021-01-13T01:02:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501938",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:40'>Comment 40:</a>
Also `ARCHFLAGS=""` works for me.



---

archive/issue_comments_501939.json:
```json
{
    "body": "<a id='comment:41'>Comment 41:</a>\nLast time `ARCHFLAGS` was touched - #29408",
    "created_at": "2021-01-13T01:07:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501939",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:41'>Comment 41:</a>
Last time `ARCHFLAGS` was touched - #29408



---

archive/issue_comments_501940.json:
```json
{
    "body": "<a id='comment:42'>Comment 42:</a>\nI have opened #31227 for trying to make python3 from CLT 12.3 usable.",
    "created_at": "2021-01-13T01:39:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501940",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:42'>Comment 42:</a>
I have opened #31227 for trying to make python3 from CLT 12.3 usable.



---

archive/issue_comments_501941.json:
```json
{
    "body": "Dependencies: **#30589**",
    "created_at": "2021-01-13T01:40:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501941",
    "user": "https://github.com/mkoeppe"
}
```

Dependencies: **#30589**



---

archive/issue_comments_501942.json:
```json
{
    "body": "Changed commit from **[ee679bd](https://github.com/sagemath/sagetrac-mirror/commit/ee679bd57302d8e422e76b422d73f83ab87a4293)** to **[76d5fd1](https://github.com/sagemath/sagetrac-mirror/commit/76d5fd15f9bcc50a478471182f70ba8d46bf4319)**",
    "created_at": "2021-01-13T01:42:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501942",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[ee679bd](https://github.com/sagemath/sagetrac-mirror/commit/ee679bd57302d8e422e76b422d73f83ab87a4293)** to **[76d5fd1](https://github.com/sagemath/sagetrac-mirror/commit/76d5fd15f9bcc50a478471182f70ba8d46bf4319)**



---

archive/issue_comments_501943.json:
```json
{
    "body": "<a id='comment:44'>Comment 44:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/29aee87fc01f6fce3cc4356c98f27c44e4ce2b5b\">29aee87</a></td><td><code>build/pkgs/python3: Update to 3.9.0rc2</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e61d464292262d80c43895c64fce4f48a6895822\">e61d464</a></td><td><code>build/pkgs/python3: Update to 3.9.0</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f8bb56d16600c8cfe1bab1d127f3931ca280dff0\">f8bb56d</a></td><td><code>build/pkgs/python3: Update to 3.9.1</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0e3513fcb3e2efa1832db8bd7957a93ad75b215c\">0e3513f</a></td><td><code>build/pkgs/pip: Update to 20.3.3</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/41d7e7a74441e5f9deb3e7a93adfccf486dde417\">41d7e7a</a></td><td><code>Merge branch 'u/jhpalmieri/new_wheel' of git://trac.sagemath.org/sage into t/30589/upgrade-python-3.9</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/76d5fd15f9bcc50a478471182f70ba8d46bf4319\">76d5fd1</a></td><td><code>Merge branch 't/30589/upgrade-python-3.9' into t/31132/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_build_when_using_homebrew_s_python3</code></td></tr></table>\n",
    "created_at": "2021-01-13T01:42:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501943",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:44'>Comment 44:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/29aee87fc01f6fce3cc4356c98f27c44e4ce2b5b">29aee87</a></td><td><code>build/pkgs/python3: Update to 3.9.0rc2</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e61d464292262d80c43895c64fce4f48a6895822">e61d464</a></td><td><code>build/pkgs/python3: Update to 3.9.0</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f8bb56d16600c8cfe1bab1d127f3931ca280dff0">f8bb56d</a></td><td><code>build/pkgs/python3: Update to 3.9.1</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0e3513fcb3e2efa1832db8bd7957a93ad75b215c">0e3513f</a></td><td><code>build/pkgs/pip: Update to 20.3.3</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/41d7e7a74441e5f9deb3e7a93adfccf486dde417">41d7e7a</a></td><td><code>Merge branch 'u/jhpalmieri/new_wheel' of git://trac.sagemath.org/sage into t/30589/upgrade-python-3.9</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/76d5fd15f9bcc50a478471182f70ba8d46bf4319">76d5fd1</a></td><td><code>Merge branch 't/30589/upgrade-python-3.9' into t/31132/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_build_when_using_homebrew_s_python3</code></td></tr></table>




---

archive/issue_comments_501944.json:
```json
{
    "body": "<a id='comment:45'>Comment 45:</a>\nReplying to [@mkoeppe](#comment%3A30):\n> Replying to [@zlscherr](#comment%3A28):\n> > on Big Sur, configure allowed me to use /usr/bin/python3 but then Cython failed to build.\n> > \n> > \n> > ```\n> >   gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64 -O2 -g -march=native -I/Users/zscherr/sage/develop/local/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -c /private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-p2i1cj72/Cython/Plex/Scanners.c -o build/temp.macosx-10.14.6-x86_64-3.8/private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-p2i1cj72/Cython/Plex/Scanners.o\n> >   clang: error: the clang compiler does not support '-march=native'\n> >   error: command 'gcc' failed with exit status 1\n> > ```\n\n> \n> This looks like a complication that may have come in through #27122\n\nI have opened #31228 for this.",
    "created_at": "2021-01-13T01:52:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501944",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:45'>Comment 45:</a>
Replying to [@mkoeppe](#comment%3A30):
> Replying to [@zlscherr](#comment%3A28):
> > on Big Sur, configure allowed me to use /usr/bin/python3 but then Cython failed to build.
> > 
> > 
> > ```
> >   gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64 -O2 -g -march=native -I/Users/zscherr/sage/develop/local/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -c /private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-p2i1cj72/Cython/Plex/Scanners.c -o build/temp.macosx-10.14.6-x86_64-3.8/private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-p2i1cj72/Cython/Plex/Scanners.o
> >   clang: error: the clang compiler does not support '-march=native'
> >   error: command 'gcc' failed with exit status 1
> > ```

> 
> This looks like a complication that may have come in through #27122

I have opened #31228 for this.



---

archive/issue_events_410999.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-01-13T01:53:03Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31132#event-410999"
}
```



---

archive/issue_events_411000.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-01-13T01:53:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31132#event-411000"
}
```



---

archive/issue_comments_501945.json:
```json
{
    "body": "<a id='comment:46'>Comment 46:</a>\nI have merged the Python 3.9 upgrade ticket (#30589). \nDoes anything else need changing on this ticket?",
    "created_at": "2021-01-13T01:53:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501945",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:46'>Comment 46:</a>
I have merged the Python 3.9 upgrade ticket (#30589). 
Does anything else need changing on this ticket?



---

archive/issue_comments_501946.json:
```json
{
    "body": "<a id='comment:47'>Comment 47:</a>\nI tested this by installing as many homebrew packages as I can, and then building with --with-system-python3=no and everything builds correctly at least on Big Sur.  Of course --with-system-python3=no is currently necessary since otherwise configure will use /usr/bin/python3 which needs #31228 to work.\n\nOn another note, when I test I see lots of warnings of the form:\n\n\n```\nld: warning: dylib (/usr/local/lib/libmpfr.dylib) was built for newer macOS version (10.15) than being linked (10.9)\nld: warning: dylib (/usr/local/lib/libgmp.dylib) was built for newer macOS version (10.15) than being linked (10.9)\nld: warning: dylib (/usr/local/lib/libgmpxx.dylib) was built for newer macOS version (10.15) than being linked (10.9)\nld: warning: dylib (/usr/local/lib/libgsl.dylib) was built for newer macOS version (10.15) than being linked (10.9)\nld: warning: dylib (/usr/local/lib/libntl.dylib) was built for newer macOS version (10.15) than being linked (10.9)\n```\n\nI did a little bit of poking, and it appears this might be caused by src/bin/sage-env setting MACOSX_DEPLOYMENT_TARGET to 10.9.  Maybe we can open a ticket for this? The source code for sage-env mentions that this was done in response to #7095, which is a ticket from 11 years ago.",
    "created_at": "2021-01-14T00:20:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501946",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:47'>Comment 47:</a>
I tested this by installing as many homebrew packages as I can, and then building with --with-system-python3=no and everything builds correctly at least on Big Sur.  Of course --with-system-python3=no is currently necessary since otherwise configure will use /usr/bin/python3 which needs #31228 to work.

On another note, when I test I see lots of warnings of the form:


```
ld: warning: dylib (/usr/local/lib/libmpfr.dylib) was built for newer macOS version (10.15) than being linked (10.9)
ld: warning: dylib (/usr/local/lib/libgmp.dylib) was built for newer macOS version (10.15) than being linked (10.9)
ld: warning: dylib (/usr/local/lib/libgmpxx.dylib) was built for newer macOS version (10.15) than being linked (10.9)
ld: warning: dylib (/usr/local/lib/libgsl.dylib) was built for newer macOS version (10.15) than being linked (10.9)
ld: warning: dylib (/usr/local/lib/libntl.dylib) was built for newer macOS version (10.15) than being linked (10.9)
```

I did a little bit of poking, and it appears this might be caused by src/bin/sage-env setting MACOSX_DEPLOYMENT_TARGET to 10.9.  Maybe we can open a ticket for this? The source code for sage-env mentions that this was done in response to #7095, which is a ticket from 11 years ago.



---

archive/issue_comments_501947.json:
```json
{
    "body": "<a id='comment:48'>Comment 48:</a>\n#31204 silences some of those \"ld: warning: ...\" messages. I agree that we should also explore the proper setting (or unsetting) of `MACOSX_DEPLOYMENT_TARGET`.",
    "created_at": "2021-01-14T00:22:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501947",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:48'>Comment 48:</a>
#31204 silences some of those "ld: warning: ..." messages. I agree that we should also explore the proper setting (or unsetting) of `MACOSX_DEPLOYMENT_TARGET`.



---

archive/issue_comments_501948.json:
```json
{
    "body": "<a id='comment:49'>Comment 49:</a>\nI don't know anything about m4 files (something to learn I guess!) but I think this is caused by build/pkgs/python3/spkg-configure.m4.  It appears to set \n\n```\nSAGE_MACOSX_DEPLOYMENT_TARGET='legacy'\n```\n\nwhich is then picked up by sage-env.",
    "created_at": "2021-01-14T00:29:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501948",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:49'>Comment 49:</a>
I don't know anything about m4 files (something to learn I guess!) but I think this is caused by build/pkgs/python3/spkg-configure.m4.  It appears to set 

```
SAGE_MACOSX_DEPLOYMENT_TARGET='legacy'
```

which is then picked up by sage-env.



---

archive/issue_comments_501949.json:
```json
{
    "body": "<a id='comment:50'>Comment 50:</a>\nWe have ticket #30711 (`src/bin/sage-env`: Update `MACOSX_DEPLOYMENT_TARGET` in builds with python3 from SPKG) for this task.",
    "created_at": "2021-01-14T00:48:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501949",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:50'>Comment 50:</a>
We have ticket #30711 (`src/bin/sage-env`: Update `MACOSX_DEPLOYMENT_TARGET` in builds with python3 from SPKG) for this task.



---

archive/issue_comments_501950.json:
```json
{
    "body": "<a id='comment:51'>Comment 51:</a>\nThanks.  I'm happy to give this ticket a positive review since it seems to fix all issues of homebrew leaking into the builds.  It would be good to sort out using /usr/bin/python3 on mac, but as far as I can tell this ticket fixes the leaking.",
    "created_at": "2021-01-14T00:56:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501950",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:51'>Comment 51:</a>
Thanks.  I'm happy to give this ticket a positive review since it seems to fix all issues of homebrew leaking into the builds.  It would be good to sort out using /usr/bin/python3 on mac, but as far as I can tell this ticket fixes the leaking.



---

archive/issue_events_411001.json:
```json
{
    "actor": "https://github.com/zlscherr",
    "created_at": "2021-01-14T00:56:27Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31132#event-411001"
}
```



---

archive/issue_events_411002.json:
```json
{
    "actor": "https://github.com/zlscherr",
    "created_at": "2021-01-14T00:56:27Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31132#event-411002"
}
```



---

archive/issue_comments_501951.json:
```json
{
    "body": "<a id='comment:53'>Comment 53:</a>\nReplying to [@zlscherr](#comment%3A49):\n> I think this is caused by build/pkgs/python3/spkg-configure.m4.  It appears to set \n> \n> ```\n> SAGE_MACOSX_DEPLOYMENT_TARGET='legacy'\n> ```\n> \n> which is then picked up by sage-env.  \n\nThat's right, this mechanism deactivates the old code in `sage-env` when we use system python3 instead of building our own python.",
    "created_at": "2021-01-14T00:56:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501951",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:53'>Comment 53:</a>
Replying to [@zlscherr](#comment%3A49):
> I think this is caused by build/pkgs/python3/spkg-configure.m4.  It appears to set 
> 
> ```
> SAGE_MACOSX_DEPLOYMENT_TARGET='legacy'
> ```
> 
> which is then picked up by sage-env.  

That's right, this mechanism deactivates the old code in `sage-env` when we use system python3 instead of building our own python.



---

archive/issue_comments_501952.json:
```json
{
    "body": "<a id='comment:54'>Comment 54:</a>\nThanks!",
    "created_at": "2021-01-14T00:57:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501952",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:54'>Comment 54:</a>
Thanks!



---

archive/issue_comments_501953.json:
```json
{
    "body": "<a id='comment:55'>Comment 55:</a>\nThe Homebrew python maintainers are still struggling to fix up their python builds. I have added some links to the ticket description to track these efforts.",
    "created_at": "2021-01-14T01:03:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501953",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:55'>Comment 55:</a>
The Homebrew python maintainers are still struggling to fix up their python builds. I have added some links to the ticket description to track these efforts.



---

archive/issue_comments_501954.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -22,4 +22,8 @@\n - #30770 cython_aliases: Use ecl-config to determine compiler/linker flags for ecl\n - #25993 Upgrade Singular\n \n-\n+Related homebrew issues and pull requests:\n+- https://github.com/Homebrew/homebrew-core/issues/68352\n+- https://github.com/Homebrew/homebrew-core/pull/68528\n+- https://github.com/Homebrew/homebrew-core/issues/67388\n+- https://github.com/Homebrew/homebrew-core/pull/67718\n``````\n",
    "created_at": "2021-01-14T01:03:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501954",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -22,4 +22,8 @@
 - #30770 cython_aliases: Use ecl-config to determine compiler/linker flags for ecl
 - #25993 Upgrade Singular
 
-
+Related homebrew issues and pull requests:
+- https://github.com/Homebrew/homebrew-core/issues/68352
+- https://github.com/Homebrew/homebrew-core/pull/68528
+- https://github.com/Homebrew/homebrew-core/issues/67388
+- https://github.com/Homebrew/homebrew-core/pull/67718
``````




---

archive/issue_comments_501955.json:
```json
{
    "body": "<a id='comment:56'>Comment 56:</a>\nReplying to [@mkoeppe](#comment%3A45):\n> Replying to [@mkoeppe](#comment%3A30):\n> > Replying to [@zlscherr](#comment%3A28):\n> > > on Big Sur, configure allowed me to use /usr/bin/python3 but then Cython failed to build.\n> > > \n> > > \n> > > ```\n> > >   gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64 -O2 -g -march=native -I/Users/zscherr/sage/develop/local/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -c /private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-p2i1cj72/Cython/Plex/Scanners.c -o build/temp.macosx-10.14.6-x86_64-3.8/private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-p2i1cj72/Cython/Plex/Scanners.o\n> > >   clang: error: the clang compiler does not support '-march=native'\n> > >   error: command 'gcc' failed with exit status 1\n> > > ```\n\n> > \n> > This looks like a complication that may have come in through #27122\n\n> \n> I have opened #31228 for this.\n\nSee also #30725.",
    "created_at": "2021-01-16T18:07:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501955",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:56'>Comment 56:</a>
Replying to [@mkoeppe](#comment%3A45):
> Replying to [@mkoeppe](#comment%3A30):
> > Replying to [@zlscherr](#comment%3A28):
> > > on Big Sur, configure allowed me to use /usr/bin/python3 but then Cython failed to build.
> > > 
> > > 
> > > ```
> > >   gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64 -O2 -g -march=native -I/Users/zscherr/sage/develop/local/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -c /private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-p2i1cj72/Cython/Plex/Scanners.c -o build/temp.macosx-10.14.6-x86_64-3.8/private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-p2i1cj72/Cython/Plex/Scanners.o
> > >   clang: error: the clang compiler does not support '-march=native'
> > >   error: command 'gcc' failed with exit status 1
> > > ```

> > 
> > This looks like a complication that may have come in through #27122

> 
> I have opened #31228 for this.

See also #30725.



---

archive/issue_events_411003.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-01-24T10:38:03Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31132#event-411003"
}
```



---

archive/issue_events_411004.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "77d9d52abf6c188a9f309a4c9dd9ac418534379c",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2021-01-24T10:38:03Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31132#event-411004"
}
```



---

archive/issue_comments_501956.json:
```json
{
    "body": "Changed branch from **[u/mkoeppe/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_build_when_using_homebrew_s_python3](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_build_when_using_homebrew_s_python3)** to **[76d5fd1](https://github.com/sagemath/sagetrac-mirror/commit/76d5fd15f9bcc50a478471182f70ba8d46bf4319)**",
    "created_at": "2021-01-24T10:38:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501956",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/mkoeppe/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_build_when_using_homebrew_s_python3](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_build_when_using_homebrew_s_python3)** to **[76d5fd1](https://github.com/sagemath/sagetrac-mirror/commit/76d5fd15f9bcc50a478471182f70ba8d46bf4319)**



---

archive/issue_comments_501957.json:
```json
{
    "body": "Changed commit from **[76d5fd1](https://github.com/sagemath/sagetrac-mirror/commit/76d5fd15f9bcc50a478471182f70ba8d46bf4319)** to none",
    "created_at": "2021-02-03T06:44:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501957",
    "user": "https://github.com/mkoeppe"
}
```

Changed commit from **[76d5fd1](https://github.com/sagemath/sagetrac-mirror/commit/76d5fd15f9bcc50a478471182f70ba8d46bf4319)** to none



---

archive/issue_comments_501958.json:
```json
{
    "body": "<a id='comment:58'>Comment 58:</a>\nA fix has just been merged into homebrew master https://github.com/Homebrew/homebrew-core/commit/784d29205ee5bd27fed226a5f96837428e171825",
    "created_at": "2021-02-03T06:44:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501958",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:58'>Comment 58:</a>
A fix has just been merged into homebrew master https://github.com/Homebrew/homebrew-core/commit/784d29205ee5bd27fed226a5f96837428e171825



---

archive/issue_comments_501959.json:
```json
{
    "body": "<a id='comment:59'>Comment 59:</a>\nAnd indeed the upgrade of `python3` to `3.9.1_7` has repaired it.",
    "created_at": "2021-02-03T07:04:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501959",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:59'>Comment 59:</a>
And indeed the upgrade of `python3` to `3.9.1_7` has repaired it.



---

archive/issue_comments_501960.json:
```json
{
    "body": "<a id='comment:60'>Comment 60:</a>\n`brew info python@3.9` tells me that I have 3.9.1_7 installed, but I still see this in `config.log`:\n\n```\n\tCFLAGS = \"-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -I/usr/local/include -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk -I/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include\"\n\tLDFLAGS = \"-L/usr/local/lib -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk\"\nconfigure:32994: result: no, this is a misconfigured Python whose sysconfig compiler/linker flags contain -I or -L options, which may cause wrong versions of libraries to leak into the build of Python packages - see https://trac.sagemath.org/ticket/31132; to use it anyway, use ./configure --with-python=/usr/local/bin/python3\n```",
    "created_at": "2021-02-03T21:52:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501960",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:60'>Comment 60:</a>
`brew info python@3.9` tells me that I have 3.9.1_7 installed, but I still see this in `config.log`:

```
	CFLAGS = "-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -I/usr/local/include -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk -I/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include"
	LDFLAGS = "-L/usr/local/lib -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk"
configure:32994: result: no, this is a misconfigured Python whose sysconfig compiler/linker flags contain -I or -L options, which may cause wrong versions of libraries to leak into the build of Python packages - see https://trac.sagemath.org/ticket/31132; to use it anyway, use ./configure --with-python=/usr/local/bin/python3
```



---

archive/issue_comments_501961.json:
```json
{
    "body": "<a id='comment:61'>Comment 61:</a>\nvery bizarre.  I had to do:\n\nbrew reinstall python@3.9 --build-from-source\n\nand that fixed it for me.  Maybe the bottle hasn't been updated yet?",
    "created_at": "2021-02-03T22:01:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501961",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:61'>Comment 61:</a>
very bizarre.  I had to do:

brew reinstall python@3.9 --build-from-source

and that fixed it for me.  Maybe the bottle hasn't been updated yet?



---

archive/issue_comments_501962.json:
```json
{
    "body": "<a id='comment:62'>Comment 62:</a>\nAlthough I'm not sure if I needed the --build-from-source.  Maybe just try brew reinstall first?",
    "created_at": "2021-02-03T22:13:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501962",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:62'>Comment 62:</a>
Although I'm not sure if I needed the --build-from-source.  Maybe just try brew reinstall first?



---

archive/issue_comments_501963.json:
```json
{
    "body": "<a id='comment:63'>Comment 63:</a>\nI tried `brew reinstall python@3.9` and that seems to have worked.",
    "created_at": "2021-02-03T22:17:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501963",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:63'>Comment 63:</a>
I tried `brew reinstall python@3.9` and that seems to have worked.



---

archive/issue_comments_501964.json:
```json
{
    "body": "<a id='comment:64'>Comment 64:</a>\nI mentioned this on the thread and it\u2019s because they forgot to bump the version number I guess from 7 to 8.  The next time it upgrades everything should be good without needing to reinstall.",
    "created_at": "2021-02-03T22:27:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501964",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:64'>Comment 64:</a>
I mentioned this on the thread and it’s because they forgot to bump the version number I guess from 7 to 8.  The next time it upgrades everything should be good without needing to reinstall.



---

archive/issue_comments_501965.json:
```json
{
    "body": "<a id='comment:65'>Comment 65:</a>\nHas anyone else tried building sage with the newest homebrew python? Configure now accepts it, but I still have issues with /usr/local leaking into the builds.  Not sure why that happens now that python3-config no longer remembers /usr/local.",
    "created_at": "2021-02-04T01:25:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501965",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:65'>Comment 65:</a>
Has anyone else tried building sage with the newest homebrew python? Configure now accepts it, but I still have issues with /usr/local leaking into the builds.  Not sure why that happens now that python3-config no longer remembers /usr/local.



---

archive/issue_comments_501966.json:
```json
{
    "body": "<a id='comment:66'>Comment 66:</a>\nAlthough I should add that cypari build fine even with homebrew's pari was installed.  The problem was that singular and pari were leaking into building sagelib, and then ecl leaked into building the manifolds documentation.",
    "created_at": "2021-02-04T01:30:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501966",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:66'>Comment 66:</a>
Although I should add that cypari build fine even with homebrew's pari was installed.  The problem was that singular and pari were leaking into building sagelib, and then ecl leaked into building the manifolds documentation.



---

archive/issue_comments_501967.json:
```json
{
    "body": "<a id='comment:67'>Comment 67:</a>\nFollow up in #31335.",
    "created_at": "2021-02-04T02:32:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501967",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:67'>Comment 67:</a>
Follow up in #31335.



---

archive/issue_comments_501968.json:
```json
{
    "body": "<a id='comment:68'>Comment 68:</a>\nReplying to [@jhpalmieri](#comment%3A63):\n> I tried `brew reinstall python@3.9` and that seems to have worked.\n\nThis worked on one machine (Big Sur) but not another (Catalina). I deleted the cached download and it still didn't work, and neither did `brew reinstall python@3.9 -s`. Oh well, maybe 3.9.1_8 will work on this machine.",
    "created_at": "2021-02-04T06:02:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501968",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:68'>Comment 68:</a>
Replying to [@jhpalmieri](#comment%3A63):
> I tried `brew reinstall python@3.9` and that seems to have worked.

This worked on one machine (Big Sur) but not another (Catalina). I deleted the cached download and it still didn't work, and neither did `brew reinstall python@3.9 -s`. Oh well, maybe 3.9.1_8 will work on this machine.



---

archive/issue_comments_501969.json:
```json
{
    "body": "<a id='comment:69'>Comment 69:</a>\nI think I had to do `brew update` first, which displayed some instructions regarding unshallowing, after which I ran `brew update` again.",
    "created_at": "2021-02-04T06:12:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501969",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:69'>Comment 69:</a>
I think I had to do `brew update` first, which displayed some instructions regarding unshallowing, after which I ran `brew update` again.



---

archive/issue_comments_501970.json:
```json
{
    "body": "<a id='comment:70'>Comment 70:</a>\nDoing `brew upgrade` and then forcing the upgrade to Python worked, although maybe that's because it's now version 3.9.1_8. (Pro-tip: if you've forced Sage to build with homebrew's Python, don't upgrade that Python in the middle of doctesting, at least if you want doctesting to go well.)",
    "created_at": "2021-02-04T17:26:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501970",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:70'>Comment 70:</a>
Doing `brew upgrade` and then forcing the upgrade to Python worked, although maybe that's because it's now version 3.9.1_8. (Pro-tip: if you've forced Sage to build with homebrew's Python, don't upgrade that Python in the middle of doctesting, at least if you want doctesting to go well.)



---

archive/issue_comments_501971.json:
```json
{
    "body": "<a id='comment:71'>Comment 71:</a>\nThis is now rejecting the system python on Gentoo, I guess because of the `-L` in `LDFLAGS`:\n\n```\n$ python3 -m sysconfig\n...\nCONFIGURE_LDFLAGS = \"-Wl,-O1 -Wl,--as-needed -L.\"\nLDFLAGS = \"-Wl,-O1 -Wl,--as-needed -L.\"\n```\n\nThat is added to our python build for obsolete reasons (there is no Gentoo/FreeBSD anymore):\n\n```\n# Set LDFLAGS so we link modules with -lpython3.2 correctly.                                                                                                             \n# Needed on FreeBSD unless Python 3.2 is already installed.                                                                                                              \n# Please query BSD team before removing this!                                                                                                                            \nappend-ldflags \"-L.\"\n```\n\nCan someone briefly summarize the problem that this `-L.` causes, so that I can get it removed?",
    "created_at": "2021-02-11T13:51:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501971",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:71'>Comment 71:</a>
This is now rejecting the system python on Gentoo, I guess because of the `-L` in `LDFLAGS`:

```
$ python3 -m sysconfig
...
CONFIGURE_LDFLAGS = "-Wl,-O1 -Wl,--as-needed -L."
LDFLAGS = "-Wl,-O1 -Wl,--as-needed -L."
```

That is added to our python build for obsolete reasons (there is no Gentoo/FreeBSD anymore):

```
# Set LDFLAGS so we link modules with -lpython3.2 correctly.                                                                                                             
# Needed on FreeBSD unless Python 3.2 is already installed.                                                                                                              
# Please query BSD team before removing this!                                                                                                                            
append-ldflags "-L."
```

Can someone briefly summarize the problem that this `-L.` causes, so that I can get it removed?



---

archive/issue_comments_501972.json:
```json
{
    "body": "<a id='comment:73'>Comment 73:</a>\nReplying to [@orlitzky](#comment%3A71):\n> Can someone briefly summarize the problem that this `-L.` causes, so that I can get it removed?\n\nWhen building a C/C++ extension module for Python in the standard way (distutils/setuptools), compiler and linker flags are pulled from `sysconfig`.  While you can specify additional flags for such a module, the ones in sysconfig come first in the compile/link commands, meaning that they take precedence.  In the present case, that means if there is a copy of a library in `.` there is no way to instead use a version located elsewhere, e.g. in `/usr/lib`.",
    "created_at": "2021-02-11T14:47:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501972",
    "user": "https://github.com/NathanDunfield"
}
```

<a id='comment:73'>Comment 73:</a>
Replying to [@orlitzky](#comment%3A71):
> Can someone briefly summarize the problem that this `-L.` causes, so that I can get it removed?

When building a C/C++ extension module for Python in the standard way (distutils/setuptools), compiler and linker flags are pulled from `sysconfig`.  While you can specify additional flags for such a module, the ones in sysconfig come first in the compile/link commands, meaning that they take precedence.  In the present case, that means if there is a copy of a library in `.` there is no way to instead use a version located elsewhere, e.g. in `/usr/lib`.



---

archive/issue_comments_501973.json:
```json
{
    "body": "<a id='comment:74'>Comment 74:</a>\nGreat, thanks. Fix is in progress.",
    "created_at": "2021-02-11T14:47:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501973",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:74'>Comment 74:</a>
Great, thanks. Fix is in progress.



---

archive/issue_comments_501974.json:
```json
{
    "body": "<a id='comment:75'>Comment 75:</a>\nException for `-L.` was done in #31358",
    "created_at": "2021-02-11T17:00:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501974",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:75'>Comment 75:</a>
Exception for `-L.` was done in #31358



---

archive/issue_comments_501975.json:
```json
{
    "body": "<a id='comment:76'>Comment 76:</a>\nCan't this be fixed by stripping `CFLAGS` and `LDSHARED` of `-I` and `-L` flags and then appending them to `CFLAGS` and `LDFLAGS` env variables?",
    "created_at": "2021-09-24T21:02:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501975",
    "user": "https://github.com/isuruf"
}
```

<a id='comment:76'>Comment 76:</a>
Can't this be fixed by stripping `CFLAGS` and `LDSHARED` of `-I` and `-L` flags and then appending them to `CFLAGS` and `LDFLAGS` env variables?



---

archive/issue_comments_501976.json:
```json
{
    "body": "<a id='comment:77'>Comment 77:</a>\n`-I` can't be stripped, but `-L` can be stripped by setting `LDSHARED` env variable. This would fix the conda-forge issue as conda-forge only use `-L` and doesn't use `-I`.",
    "created_at": "2021-09-24T21:05:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501976",
    "user": "https://github.com/isuruf"
}
```

<a id='comment:77'>Comment 77:</a>
`-I` can't be stripped, but `-L` can be stripped by setting `LDSHARED` env variable. This would fix the conda-forge issue as conda-forge only use `-L` and doesn't use `-I`.



---

archive/issue_comments_501977.json:
```json
{
    "body": "<a id='comment:78'>Comment 78:</a>\nLet's discuss this in #31539",
    "created_at": "2021-09-25T01:51:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31132#issuecomment-501977",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:78'>Comment 78:</a>
Let's discuss this in #31539
