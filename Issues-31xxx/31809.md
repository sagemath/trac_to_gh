# Issue 31809: WeilPolynomials segfault with squarefree=True

archive/issues_031572.json:
```json
{
    "body": "\n```\nsage: from sage.rings.polynomial.weil.weil_polynomials import WeilPolynomials\nsage: foo = list(WeilPolynomials(12, 3, lead=(1,0,9,2,46), squarefree=False))\nsage: bar = list(WeilPolynomials(12, 3, lead=(1,0,9,2,46), squarefree=True))\nException (fmpz_divexact_si). Division by zero.\n------------------------------------------------------------------------\n(no backtrace available)\n------------------------------------------------------------------------\nUnhandled SIGABRT: An abort() occurred.\nThis probably occurred because a *compiled* module has a bug\nin it and is not properly wrapped with sig_on(), sig_off().\nPython will now terminate.\n------------------------------------------------------------------------\n/Applications/sage-dev/src/bin/sage-python: line 2:  2188 Abort trap: 6           sage -python \"$@\"\n```\nFor a full core dump see: https://gist.github.com/edgarcosta/ef611a40bee98da46bcac50781324620 (comes from another machine)\n\n**CC:**  @kedlaya @roed314\n\n**Branch/Commit:** [06a469e494a5de312fb4f083577f811371994aca](https://github.com/sagemath/sagetrac-mirror/commit/06a469e494a5de312fb4f083577f811371994aca)\n\n**Reviewer:** David Roe, Edgar Costa\n\n**Author:** Kiran Kedlaya\n\nIssue created by migration from https://trac.sagemath.org/ticket/31809\n\n",
    "closed_at": "2021-06-19T20:57:33Z",
    "created_at": "2021-05-11T01:46:04Z",
    "labels": [
        "component: algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "WeilPolynomials segfault with squarefree=True",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31809",
    "user": "https://github.com/edgarcosta"
}
```

```
sage: from sage.rings.polynomial.weil.weil_polynomials import WeilPolynomials
sage: foo = list(WeilPolynomials(12, 3, lead=(1,0,9,2,46), squarefree=False))
sage: bar = list(WeilPolynomials(12, 3, lead=(1,0,9,2,46), squarefree=True))
Exception (fmpz_divexact_si). Division by zero.
------------------------------------------------------------------------
(no backtrace available)
------------------------------------------------------------------------
Unhandled SIGABRT: An abort() occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------
/Applications/sage-dev/src/bin/sage-python: line 2:  2188 Abort trap: 6           sage -python "$@"
```
For a full core dump see: https://gist.github.com/edgarcosta/ef611a40bee98da46bcac50781324620 (comes from another machine)

**CC:**  @kedlaya @roed314

**Branch/Commit:** [06a469e494a5de312fb4f083577f811371994aca](https://github.com/sagemath/sagetrac-mirror/commit/06a469e494a5de312fb4f083577f811371994aca)

**Reviewer:** David Roe, Edgar Costa

**Author:** Kiran Kedlaya

Issue created by migration from https://trac.sagemath.org/ticket/31809





---

archive/issue_comments_604470.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,20 +1,17 @@\n+\n ```\n sage: from sage.rings.polynomial.weil.weil_polynomials import WeilPolynomials\n sage: foo = list(WeilPolynomials(12, 3, lead=(1,0,9,2,46), squarefree=False))\n sage: bar = list(WeilPolynomials(12, 3, lead=(1,0,9,2,46), squarefree=True))\n Exception (fmpz_divexact_si). Division by zero.\n-\n----\n+------------------------------------------------------------------------\n (no backtrace available)\n-\n----\n+------------------------------------------------------------------------\n Unhandled SIGABRT: An abort() occurred.\n This probably occurred because a *compiled* module has a bug\n in it and is not properly wrapped with sig_on(), sig_off().\n Python will now terminate.\n-\n----\n+------------------------------------------------------------------------\n /Applications/sage-dev/src/bin/sage-python: line 2:  2188 Abort trap: 6           sage -python \"$@\"\n ```\n-\n For a full core dump see: https://gist.github.com/edgarcosta/ef611a40bee98da46bcac50781324620 (comes from another machine)\n``````\n",
    "created_at": "2021-05-11T01:46:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-604470",
    "user": "https://github.com/edgarcosta"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,20 +1,17 @@
+
 ```
 sage: from sage.rings.polynomial.weil.weil_polynomials import WeilPolynomials
 sage: foo = list(WeilPolynomials(12, 3, lead=(1,0,9,2,46), squarefree=False))
 sage: bar = list(WeilPolynomials(12, 3, lead=(1,0,9,2,46), squarefree=True))
 Exception (fmpz_divexact_si). Division by zero.
-
----
+------------------------------------------------------------------------
 (no backtrace available)
-
----
+------------------------------------------------------------------------
 Unhandled SIGABRT: An abort() occurred.
 This probably occurred because a *compiled* module has a bug
 in it and is not properly wrapped with sig_on(), sig_off().
 Python will now terminate.
-
----
+------------------------------------------------------------------------
 /Applications/sage-dev/src/bin/sage-python: line 2:  2188 Abort trap: 6           sage -python "$@"
 ```
-
 For a full core dump see: https://gist.github.com/edgarcosta/ef611a40bee98da46bcac50781324620 (comes from another machine)
``````




---

archive/issue_comments_604471.json:
```json
{
    "body": "<a id='comment:2'></a>\nI think the issue is this block\n\n```\n    if (!force_squarefree && _fmpz_vec_is_zero(f0, n)) return(1);\n\n    /* If we miss any one sign change, we cannot have enough. */\n    if (fmpz_sgn(f0+n-1) != sgn0_l) return(0);\n\n    if (n==1) return(1); /* If f0 is a scalar, it is nonzero and we win. */\n\n    /* Extract content from f0; in practice, this seems to do better than\n       an explicit subresultant computation. */\n    _fmpz_vec_content(c, f0, n);\n    _fmpz_vec_scalar_divexact_fmpz(f0, f0, n, c);\n```\nref: https://github.com/sagemath/sage/blob/develop/src/sage/rings/polynomial/weil/power_sums.c#L77-L87\n\nbecause  `force_squarefree = True` we don't run `return (1)`, but then in the last line we try to divide by the content of that vector which is 0.",
    "created_at": "2021-05-11T19:08:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-604471",
    "user": "https://github.com/edgarcosta"
}
```

<a id='comment:2'></a>
I think the issue is this block

```
    if (!force_squarefree && _fmpz_vec_is_zero(f0, n)) return(1);

    /* If we miss any one sign change, we cannot have enough. */
    if (fmpz_sgn(f0+n-1) != sgn0_l) return(0);

    if (n==1) return(1); /* If f0 is a scalar, it is nonzero and we win. */

    /* Extract content from f0; in practice, this seems to do better than
       an explicit subresultant computation. */
    _fmpz_vec_content(c, f0, n);
    _fmpz_vec_scalar_divexact_fmpz(f0, f0, n, c);
```
ref: https://github.com/sagemath/sage/blob/develop/src/sage/rings/polynomial/weil/power_sums.c#L77-L87

because  `force_squarefree = True` we don't run `return (1)`, but then in the last line we try to divide by the content of that vector which is 0.



---

archive/issue_comments_604472.json:
```json
{
    "body": "<a id='comment:3'></a>\nI think this is a problem with sanitizing input: the line\n\n```\n    if (fmpz_sgn(f0+n-1) != sgn0_l) return(0);\n```\nis supposed to rule out the zero polynomial, but that fails if the initial polynomial is somehow specified with leading zeroes. \n\nI'm not sure how that never came up before, but it's easy enough to fix by adjusting `n` at the outset. Patch to follow shortly.",
    "created_at": "2021-05-12T01:30:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-604472",
    "user": "https://github.com/kedlaya"
}
```

<a id='comment:3'></a>
I think this is a problem with sanitizing input: the line

```
    if (fmpz_sgn(f0+n-1) != sgn0_l) return(0);
```
is supposed to rule out the zero polynomial, but that fails if the initial polynomial is somehow specified with leading zeroes. 

I'm not sure how that never came up before, but it's easy enough to fix by adjusting `n` at the outset. Patch to follow shortly.



---

archive/issue_comments_604473.json:
```json
{
    "body": "**Branch:** [u/kedlaya/weilpolynomials_segfault_with_squarefree_true](https://github.com/sagemath/sagetrac-mirror/tree/u/kedlaya/weilpolynomials_segfault_with_squarefree_true)",
    "created_at": "2021-05-12T01:33:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-604473",
    "user": "https://github.com/kedlaya"
}
```

**Branch:** [u/kedlaya/weilpolynomials_segfault_with_squarefree_true](https://github.com/sagemath/sagetrac-mirror/tree/u/kedlaya/weilpolynomials_segfault_with_squarefree_true)



---

archive/issue_comments_604474.json:
```json
{
    "body": "**Author:** Kiran Kedlaya",
    "created_at": "2021-05-12T01:39:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-604474",
    "user": "https://github.com/kedlaya"
}
```

**Author:** Kiran Kedlaya



---

archive/issue_comments_604475.json:
```json
{
    "body": "<a id='comment:5'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/06a469e494a5de312fb4f083577f811371994aca\">06a469e</a></td><td><code>Fix segfault in Weil polynomials</code></td></tr></table>\n",
    "created_at": "2021-05-12T01:39:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-604475",
    "user": "https://github.com/kedlaya"
}
```

<a id='comment:5'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/06a469e494a5de312fb4f083577f811371994aca">06a469e</a></td><td><code>Fix segfault in Weil polynomials</code></td></tr></table>




---

archive/issue_comments_604476.json:
```json
{
    "body": "**Commit:** [06a469e494a5de312fb4f083577f811371994aca](https://github.com/sagemath/sagetrac-mirror/commit/06a469e494a5de312fb4f083577f811371994aca)",
    "created_at": "2021-05-12T01:39:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-604476",
    "user": "https://github.com/kedlaya"
}
```

**Commit:** [06a469e494a5de312fb4f083577f811371994aca](https://github.com/sagemath/sagetrac-mirror/commit/06a469e494a5de312fb4f083577f811371994aca)



---

archive/issue_comments_604477.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2021-05-12T01:39:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-604477",
    "user": "https://github.com/kedlaya"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_604478.json:
```json
{
    "body": "<a id='comment:6'></a>\nLooks good to me once tests pass.",
    "created_at": "2021-05-12T02:19:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-604478",
    "user": "https://github.com/roed314"
}
```

<a id='comment:6'></a>
Looks good to me once tests pass.



---

archive/issue_comments_604479.json:
```json
{
    "body": "**Reviewer:** David Roe",
    "created_at": "2021-05-12T02:19:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-604479",
    "user": "https://github.com/roed314"
}
```

**Reviewer:** David Roe



---

archive/issue_comments_604480.json:
```json
{
    "body": "**Changing reviewer** from \"David Roe\" to \"David Roe, Edgar Costa\".",
    "created_at": "2021-05-12T12:37:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-604480",
    "user": "https://github.com/edgarcosta"
}
```

**Changing reviewer** from "David Roe" to "David Roe, Edgar Costa".



---

archive/issue_comments_604481.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2021-05-12T12:37:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-604481",
    "user": "https://github.com/edgarcosta"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_events_094239.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-06-19T20:57:33Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31809#event-94239"
}
```



---

archive/issue_comments_604482.json:
```json
{
    "body": "**Changing branch** from \"[u/kedlaya/weilpolynomials_segfault_with_squarefree_true](https://github.com/sagemath/sagetrac-mirror/tree/u/kedlaya/weilpolynomials_segfault_with_squarefree_true)\" to \"[06a469e494a5de312fb4f083577f811371994aca](https://github.com/sagemath/sagetrac-mirror/commit/06a469e494a5de312fb4f083577f811371994aca)\".",
    "created_at": "2021-06-19T20:57:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31809",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31809#issuecomment-604482",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/kedlaya/weilpolynomials_segfault_with_squarefree_true](https://github.com/sagemath/sagetrac-mirror/tree/u/kedlaya/weilpolynomials_segfault_with_squarefree_true)" to "[06a469e494a5de312fb4f083577f811371994aca](https://github.com/sagemath/sagetrac-mirror/commit/06a469e494a5de312fb4f083577f811371994aca)".
