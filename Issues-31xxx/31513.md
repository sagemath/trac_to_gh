# Issue 31513: jupyter: "%display latex" completely breaks @interact (and all of ipywidgets)

archive/issues_031276.json:
```json
{
    "body": "In sage-9.1, this works fine with Jupyter:\n\n```\n%display latex\n\nthen in another cell\n\n@interact\ndef f(n=10):\n    print(n)\n```\nHowever, in sage-9.2, the output of Interact is **displayed as latex**, i.e., somebody changed %display latex in such a way that it also breaks widgets. \n\n```\n\ud835\ude78\ud835\ude97\ud835\ude9d\ud835\ude8e\ud835\ude9b\ud835\ude8a\ud835\ude8c\ud835\ude9d\ud835\ude92\ud835\ude9f\ud835\ude8e\ud835\ude8f\ud835\ude9e\ud835\ude97\ud835\ude8c\ud835\ude9d\ud835\ude92\ud835\ude98\ud835\ude97<\ud835\ude8f\ud835\ude9e\ud835\ude97\ud835\ude8c\ud835\ude9d\ud835\ude92\ud835\ude98\ud835\ude97\ud835\ude8f\ud835\ude8a\ud835\ude9d\ud835\udff6\ud835\udea1\ud835\udffd\ud835\ude8f\ud835\ude8f\ud835\udff9\ud835\ude8a\ud835\ude8a\ud835\udff8\ud835\udfff\ud835\ude8b\ud835\ude8f\ud835\udffd\ud835\udff6>\ud835\udea0\ud835\ude92\ud835\ude9d\ud835\ude91\ud835\udff7\ud835\udea0\ud835\ude92\ud835\ude8d\ud835\ude90\ud835\ude8e\ud835\ude9d\ud835\ude97:\ud835\ude78\ud835\ude97\ud835\ude9d\ud835\ude82\ud835\ude95\ud835\ude92\ud835\ude8d\ud835\ude8e\ud835\ude9b(\ud835\ude9f\ud835\ude8a\ud835\ude95\ud835\ude9e\ud835\ude8e=\ud835\udff7\ud835\udff6,\ud835\ude8d\ud835\ude8e\ud835\ude9c\ud835\ude8c\ud835\ude9b\ud835\ude92\ud835\ude99\ud835\ude9d\ud835\ude92\ud835\ude98\ud835\ude97='\ud835\ude97',\ud835\ude96\ud835\ude8a\ud835\udea1=\ud835\udff9\ud835\udff6,\ud835\ude96\ud835\ude92\ud835\ude97=\u23af\ud835\udff7\ud835\udff6)\n```\n\nThis is a really serious bug, since not only is `@`interact broken, in fact all of ipywidgets stops working the second you do \"%display latex\".\n\n\n**CC:**  @dimpase @kwankyu @enriqueartal @jcamp0x2a @slel @vbraun\n\n**Reviewer:** Kwankyu Lee\n\n**Dependencies:** #31536\n\nIssue created by migration from https://trac.sagemath.org/ticket/31513\n\n",
    "closed_at": "2021-05-23T08:30:57Z",
    "created_at": "2021-03-18T18:22:34Z",
    "labels": [
        "component: notebook",
        "bug",
        "invalid"
    ],
    "title": "jupyter: \"%display latex\" completely breaks @interact (and all of ipywidgets)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31513",
    "user": "https://github.com/williamstein"
}
```
In sage-9.1, this works fine with Jupyter:

```
%display latex

then in another cell

@interact
def f(n=10):
    print(n)
```
However, in sage-9.2, the output of Interact is **displayed as latex**, i.e., somebody changed %display latex in such a way that it also breaks widgets. 

```
𝙸𝚗𝚝𝚎𝚛𝚊𝚌𝚝𝚒𝚟𝚎𝚏𝚞𝚗𝚌𝚝𝚒𝚘𝚗<𝚏𝚞𝚗𝚌𝚝𝚒𝚘𝚗𝚏𝚊𝚝𝟶𝚡𝟽𝚏𝚏𝟹𝚊𝚊𝟸𝟿𝚋𝚏𝟽𝟶>𝚠𝚒𝚝𝚑𝟷𝚠𝚒𝚍𝚐𝚎𝚝𝚗:𝙸𝚗𝚝𝚂𝚕𝚒𝚍𝚎𝚛(𝚟𝚊𝚕𝚞𝚎=𝟷𝟶,𝚍𝚎𝚜𝚌𝚛𝚒𝚙𝚝𝚒𝚘𝚗='𝚗',𝚖𝚊𝚡=𝟹𝟶,𝚖𝚒𝚗=⎯𝟷𝟶)
```

This is a really serious bug, since not only is `@`interact broken, in fact all of ipywidgets stops working the second you do "%display latex".


**CC:**  @dimpase @kwankyu @enriqueartal @jcamp0x2a @slel @vbraun

**Reviewer:** Kwankyu Lee

**Dependencies:** #31536

Issue created by migration from https://trac.sagemath.org/ticket/31513





---

archive/attachments_021485.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "Screen Shot 2021-03-18 at 11.22.11 AM.png",
    "asset_url": "tarball://root/attachments/some-uuid/ticket31513/Screen Shot 2021-03-18 at 11.22.11 AM.png",
    "created_at": "2021-03-18T18:22:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.png",
    "user": "https://github.com/williamstein"
}
```



---

archive/issue_comments_510500.json:
```json
{
    "body": "Screenshot illustrating this bug.",
    "created_at": "2021-03-18T18:22:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31513#issuecomment-510500",
    "user": "https://github.com/williamstein"
}
```

Screenshot illustrating this bug.



---

archive/issue_comments_510501.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -15,3 +15,5 @@\n \ud835\ude78\ud835\ude97\ud835\ude9d\ud835\ude8e\ud835\ude9b\ud835\ude8a\ud835\ude8c\ud835\ude9d\ud835\ude92\ud835\ude9f\ud835\ude8e\ud835\ude8f\ud835\ude9e\ud835\ude97\ud835\ude8c\ud835\ude9d\ud835\ude92\ud835\ude98\ud835\ude97<\ud835\ude8f\ud835\ude9e\ud835\ude97\ud835\ude8c\ud835\ude9d\ud835\ude92\ud835\ude98\ud835\ude97\ud835\ude8f\ud835\ude8a\ud835\ude9d\ud835\udff6\ud835\udea1\ud835\udffd\ud835\ude8f\ud835\ude8f\ud835\udff9\ud835\ude8a\ud835\ude8a\ud835\udff8\ud835\udfff\ud835\ude8b\ud835\ude8f\ud835\udffd\ud835\udff6>\ud835\udea0\ud835\ude92\ud835\ude9d\ud835\ude91\ud835\udff7\ud835\udea0\ud835\ude92\ud835\ude8d\ud835\ude90\ud835\ude8e\ud835\ude9d\ud835\ude97:\ud835\ude78\ud835\ude97\ud835\ude9d\ud835\ude82\ud835\ude95\ud835\ude92\ud835\ude8d\ud835\ude8e\ud835\ude9b(\ud835\ude9f\ud835\ude8a\ud835\ude95\ud835\ude9e\ud835\ude8e=\ud835\udff7\ud835\udff6,\ud835\ude8d\ud835\ude8e\ud835\ude9c\ud835\ude8c\ud835\ude9b\ud835\ude92\ud835\ude99\ud835\ude9d\ud835\ude92\ud835\ude98\ud835\ude97='\ud835\ude97',\ud835\ude96\ud835\ude8a\ud835\udea1=\ud835\udff9\ud835\udff6,\ud835\ude96\ud835\ude92\ud835\ude97=\u23af\ud835\udff7\ud835\udff6)\n ```\n \n+This is a really serious bug, since not only is `@`interact broken, in fact all of ipywidgets stops working the second you do \"%display latex\".\n+\n``````\n",
    "created_at": "2021-03-18T18:25:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31513#issuecomment-510501",
    "user": "https://github.com/williamstein"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -15,3 +15,5 @@
 𝙸𝚗𝚝𝚎𝚛𝚊𝚌𝚝𝚒𝚟𝚎𝚏𝚞𝚗𝚌𝚝𝚒𝚘𝚗<𝚏𝚞𝚗𝚌𝚝𝚒𝚘𝚗𝚏𝚊𝚝𝟶𝚡𝟽𝚏𝚏𝟹𝚊𝚊𝟸𝟿𝚋𝚏𝟽𝟶>𝚠𝚒𝚝𝚑𝟷𝚠𝚒𝚍𝚐𝚎𝚝𝚗:𝙸𝚗𝚝𝚂𝚕𝚒𝚍𝚎𝚛(𝚟𝚊𝚕𝚞𝚎=𝟷𝟶,𝚍𝚎𝚜𝚌𝚛𝚒𝚙𝚝𝚒𝚘𝚗='𝚗',𝚖𝚊𝚡=𝟹𝟶,𝚖𝚒𝚗=⎯𝟷𝟶)
 ```
 
+This is a really serious bug, since not only is `@`interact broken, in fact all of ipywidgets stops working the second you do "%display latex".
+
``````




---

archive/issue_events_287403.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2021-03-18T18:25:22Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "rename": {
        "from": "jupyter: \"%display latex\" completely breaks @interact",
        "to": "jupyter: \"%display latex\" completely breaks @interact (and all of ipywidgets)"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31513#event-287403"
}
```



---

archive/issue_events_287404.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-18T19:14:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "label": "blocker",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31513#event-287404"
}
```



---

archive/issue_comments_510502.json:
```json
{
    "body": "<a id='comment:4'></a>\nPerhaps introduced by ipython upgrade in #28197?",
    "created_at": "2021-03-19T05:01:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31513#issuecomment-510502",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:4'></a>
Perhaps introduced by ipython upgrade in #28197?



---

archive/issue_comments_510503.json:
```json
{
    "body": "<a id='comment:6'></a>\nFWIW, `%display latex` also breaks `%matplotlib notebook`. For instance the following cell in a Jupyter notebook\n\n```\n%display latex\n%matplotlib notebook\nimport matplotlib.pyplot as plt\nplt.plot([1, 2, 3, 4])\nplt.ylabel('some numbers')\nplt.show()\n```\nyields\n\n```\n<\ud835\ude78\ud835\ude7f\ud835\udea2\ud835\ude9d\ud835\ude91\ud835\ude98\ud835\ude97.\ud835\ude8c\ud835\ude98\ud835\ude9b\ud835\ude8e.\ud835\ude8d\ud835\ude92\ud835\ude9c\ud835\ude99\ud835\ude95\ud835\ude8a\ud835\udea2.\ud835\ude79\ud835\ude8a\ud835\ude9f\ud835\ude8a\ud835\ude9c\ud835\ude8c\ud835\ude9b\ud835\ude92\ud835\ude99\ud835\ude9d\ud835\ude98\ud835\ude8b\ud835\ude93\ud835\ude8e\ud835\ude8c\ud835\ude9d>\n<\ud835\ude78\ud835\ude7f\ud835\udea2\ud835\ude9d\ud835\ude91\ud835\ude98\ud835\ude97.\ud835\ude8c\ud835\ude98\ud835\ude9b\ud835\ude8e.\ud835\ude8d\ud835\ude92\ud835\ude9c\ud835\ude99\ud835\ude95\ud835\ude8a\ud835\udea2.\ud835\ude77\ud835\ude83\ud835\ude7c\ud835\ude7b\ud835\ude98\ud835\ude8b\ud835\ude93\ud835\ude8e\ud835\ude8c\ud835\ude9d>\n```\ninstead of the pyplot window.\nIf one suppresses `%display latex` or replaces it by `%display plain`, then everything is fine: the interactive pyplot window appears, with the requested plot. \n\nContrary to the issue with `@interact`, this one is also there in Sage 9.1, except that the output is only\n\n```\n<\ud835\ude78\ud835\ude7f\ud835\udea2\ud835\ude9d\ud835\ude91\ud835\ude98\ud835\ude97.\ud835\ude8c\ud835\ude98\ud835\ude9b\ud835\ude8e.\ud835\ude8d\ud835\ude92\ud835\ude9c\ud835\ude99\ud835\ude95\ud835\ude8a\ud835\udea2.\ud835\ude77\ud835\ude83\ud835\ude7c\ud835\ude7b\ud835\ude98\ud835\ude8b\ud835\ude93\ud835\ude8e\ud835\ude8c\ud835\ude9d>\n```",
    "created_at": "2021-03-24T20:16:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31513#issuecomment-510503",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:6'></a>
FWIW, `%display latex` also breaks `%matplotlib notebook`. For instance the following cell in a Jupyter notebook

```
%display latex
%matplotlib notebook
import matplotlib.pyplot as plt
plt.plot([1, 2, 3, 4])
plt.ylabel('some numbers')
plt.show()
```
yields

```
<𝙸𝙿𝚢𝚝𝚑𝚘𝚗.𝚌𝚘𝚛𝚎.𝚍𝚒𝚜𝚙𝚕𝚊𝚢.𝙹𝚊𝚟𝚊𝚜𝚌𝚛𝚒𝚙𝚝𝚘𝚋𝚓𝚎𝚌𝚝>
<𝙸𝙿𝚢𝚝𝚑𝚘𝚗.𝚌𝚘𝚛𝚎.𝚍𝚒𝚜𝚙𝚕𝚊𝚢.𝙷𝚃𝙼𝙻𝚘𝚋𝚓𝚎𝚌𝚝>
```
instead of the pyplot window.
If one suppresses `%display latex` or replaces it by `%display plain`, then everything is fine: the interactive pyplot window appears, with the requested plot. 

Contrary to the issue with `@interact`, this one is also there in Sage 9.1, except that the output is only

```
<𝙸𝙿𝚢𝚝𝚑𝚘𝚗.𝚌𝚘𝚛𝚎.𝚍𝚒𝚜𝚙𝚕𝚊𝚢.𝙷𝚃𝙼𝙻𝚘𝚋𝚓𝚎𝚌𝚝>
```



---

archive/issue_comments_510504.json:
```json
{
    "body": "<a id='comment:7'></a>\nHere is the bug.\n\nhttps://trac.sagemath.org/ticket/23330\n\n```diff\ndiff --git a/src/sage/repl/rich_output/backend_ipython.py b/src/sage/repl/rich_output/backend_ipython.py\nindex a2c17e2841..38ae60ce70 100644\n--- a/src/sage/repl/rich_output/backend_ipython.py\n+++ b/src/sage/repl/rich_output/backend_ipython.py\n@@ -544,6 +544,7 @@ class BackendIPythonNotebook(BackendIPython):\n             return ({u'text/plain': rich_output.unicode_art.get_unicode()}, {})\n         elif isinstance(rich_output, OutputLatex):\n             return ({u'text/html':  rich_output.mathjax(),\n+                     u'text/latex': rich_output.inline_equation(),\n                      u'text/plain': plain_text.text.get_unicode(),\n             }, {})\n         elif isinstance(rich_output, OutputHtml):\n```",
    "created_at": "2021-03-25T05:50:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31513#issuecomment-510504",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:7'></a>
Here is the bug.

https://trac.sagemath.org/ticket/23330

```diff
diff --git a/src/sage/repl/rich_output/backend_ipython.py b/src/sage/repl/rich_output/backend_ipython.py
index a2c17e2841..38ae60ce70 100644
--- a/src/sage/repl/rich_output/backend_ipython.py
+++ b/src/sage/repl/rich_output/backend_ipython.py
@@ -544,6 +544,7 @@ class BackendIPythonNotebook(BackendIPython):
             return ({u'text/plain': rich_output.unicode_art.get_unicode()}, {})
         elif isinstance(rich_output, OutputLatex):
             return ({u'text/html':  rich_output.mathjax(),
+                     u'text/latex': rich_output.inline_equation(),
                      u'text/plain': plain_text.text.get_unicode(),
             }, {})
         elif isinstance(rich_output, OutputHtml):
```



---

archive/issue_comments_510505.json:
```json
{
    "body": "<a id='comment:8'></a>\nReplying to [klee](#comment%3A7):\n> Here is the bug.\n> \n> https://trac.sagemath.org/ticket/23330\n> \n\nShall we revert #23330? It looks more important to have ipywidgets working than a correct pdf export.",
    "created_at": "2021-03-25T07:16:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31513#issuecomment-510505",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:8'></a>
Replying to [klee](#comment%3A7):
> Here is the bug.
> 
> https://trac.sagemath.org/ticket/23330
> 

Shall we revert #23330? It looks more important to have ipywidgets working than a correct pdf export.



---

archive/issue_comments_510506.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [egourgoulhon](#comment%3A8):\n> Replying to [klee](#comment%3A7):\n> > Here is the bug.\n> > \n> > https://trac.sagemath.org/ticket/23330\n> > \n\n> Shall we revert #23330? It looks more important to have ipywidgets working than a correct pdf export. \n\nMoreover, in the spirit of #31536, `tex/latex` mime type is to be deprecated in favor of `tex/html`.",
    "created_at": "2021-03-25T07:24:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31513#issuecomment-510506",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:9'></a>
Replying to [egourgoulhon](#comment%3A8):
> Replying to [klee](#comment%3A7):
> > Here is the bug.
> > 
> > https://trac.sagemath.org/ticket/23330
> > 

> Shall we revert #23330? It looks more important to have ipywidgets working than a correct pdf export. 

Moreover, in the spirit of #31536, `tex/latex` mime type is to be deprecated in favor of `tex/html`.



---

archive/issue_comments_510507.json:
```json
{
    "body": "<a id='comment:10'></a>\nBTW, this points to the need to move to the default Jupyter rich output display for latex (i.e. use `_repr_latex_` instead of `%display latex`), since the pdf export works out of the box with `_repr_latex_` and there is no interference with ipywidgets.",
    "created_at": "2021-03-25T07:38:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31513#issuecomment-510507",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:10'></a>
BTW, this points to the need to move to the default Jupyter rich output display for latex (i.e. use `_repr_latex_` instead of `%display latex`), since the pdf export works out of the box with `_repr_latex_` and there is no interference with ipywidgets.



---

archive/issue_comments_510508.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [klee](#comment%3A9):\n> Replying to [egourgoulhon](#comment%3A8):\n> > Replying to [klee](#comment%3A7):\n> > > Here is the bug.\n> > > \n> > > https://trac.sagemath.org/ticket/23330\n> > > \n\n> > Shall we revert #23330? It looks more important to have ipywidgets working than a correct pdf export. \n> \n> Moreover, in the spirit of #31536, `tex/latex` mime type is to be deprecated in favor of `tex/html`.\n\n\nBut then, there cannot be pdf export of latex-typeset formulas from `text/html`.",
    "created_at": "2021-03-25T08:03:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31513#issuecomment-510508",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:11'></a>
Replying to [klee](#comment%3A9):
> Replying to [egourgoulhon](#comment%3A8):
> > Replying to [klee](#comment%3A7):
> > > Here is the bug.
> > > 
> > > https://trac.sagemath.org/ticket/23330
> > > 

> > Shall we revert #23330? It looks more important to have ipywidgets working than a correct pdf export. 
> 
> Moreover, in the spirit of #31536, `tex/latex` mime type is to be deprecated in favor of `tex/html`.


But then, there cannot be pdf export of latex-typeset formulas from `text/html`.



---

archive/issue_comments_510509.json:
```json
{
    "body": "**Author:** Eric Gourgoulhon",
    "created_at": "2021-03-26T11:40:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31513#issuecomment-510509",
    "user": "https://github.com/egourgoulhon"
}
```

**Author:** Eric Gourgoulhon



---

archive/issue_events_287405.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2021-03-26T11:40:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31513#event-287405"
}
```



---

archive/issue_comments_510510.json:
```json
{
    "body": "**Commit:** [046892eee8198c4112c45bf52f96131d8be9a40f](https://github.com/sagemath/sagetrac-mirror/commit/046892eee8198c4112c45bf52f96131d8be9a40f)",
    "created_at": "2021-03-26T11:40:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31513#issuecomment-510510",
    "user": "https://github.com/egourgoulhon"
}
```

**Commit:** [046892eee8198c4112c45bf52f96131d8be9a40f](https://github.com/sagemath/sagetrac-mirror/commit/046892eee8198c4112c45bf52f96131d8be9a40f)



---

archive/issue_comments_510511.json:
```json
{
    "body": "**Branch:** [public/trac31513_display_latex_ipywidgets](https://github.com/sagemath/sagetrac-mirror/tree/public/trac31513_display_latex_ipywidgets)",
    "created_at": "2021-03-26T11:40:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31513#issuecomment-510511",
    "user": "https://github.com/egourgoulhon"
}
```

**Branch:** [public/trac31513_display_latex_ipywidgets](https://github.com/sagemath/sagetrac-mirror/tree/public/trac31513_display_latex_ipywidgets)



---

archive/issue_comments_510512.json:
```json
{
    "body": "<a id='comment:12'></a>\nHere is a possible fix, which does not revert the pdf export fix introduced in #23330. I have instead modified `sage.repl.display.formatter.SageDisplayFormatter.format` so that IPython widgets are tried before Sage rich output. I've performed a few tests and things seem OK, but I am not completly sure about possible side effects of this fix. So please test it on your side. \n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/046892eee8198c4112c45bf52f96131d8be9a40f\">046892e</a></td><td><code>Change the order of IPython widgets and Sage rich output in SageDisplayFormatter.format</code></td></tr></table>\n",
    "created_at": "2021-03-26T11:40:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31513#issuecomment-510512",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:12'></a>
Here is a possible fix, which does not revert the pdf export fix introduced in #23330. I have instead modified `sage.repl.display.formatter.SageDisplayFormatter.format` so that IPython widgets are tried before Sage rich output. I've performed a few tests and things seem OK, but I am not completly sure about possible side effects of this fix. So please test it on your side. 

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/046892eee8198c4112c45bf52f96131d8be9a40f">046892e</a></td><td><code>Change the order of IPython widgets and Sage rich output in SageDisplayFormatter.format</code></td></tr></table>




---

archive/issue_comments_510513.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [egourgoulhon](#comment%3A11):\n> Replying to [klee](#comment%3A9):\n> > Moreover, in the spirit of #31536, `tex/latex` mime type is to be deprecated in favor of `tex/html`.\n\n> \n> But then, there cannot be pdf export of latex-typeset formulas from `text/html`.\n\n\nRight. `tex/latex` is the right mime type for pdf output. What I don't like is the use of `latex` for mathjax+html. I misdirected my arrow.",
    "created_at": "2021-03-26T15:42:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31513#issuecomment-510513",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:13'></a>
Replying to [egourgoulhon](#comment%3A11):
> Replying to [klee](#comment%3A9):
> > Moreover, in the spirit of #31536, `tex/latex` mime type is to be deprecated in favor of `tex/html`.

> 
> But then, there cannot be pdf export of latex-typeset formulas from `text/html`.


Right. `tex/latex` is the right mime type for pdf output. What I don't like is the use of `latex` for mathjax+html. I misdirected my arrow.



---

archive/issue_comments_510514.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [egourgoulhon](#comment%3A12):\n> Here is a possible fix, which does not revert the pdf export fix introduced in #23330. I have instead modified `sage.repl.display.formatter.SageDisplayFormatter.format` so that IPython widgets are tried before Sage rich output. I've performed a few tests and things seem OK, but I am not completly sure about possible side effects of this fix. So please test it on your side. \n\n\nThen you bypass the test `set(sage_format.keys()).issubset(self.default_mime())` checked before calling `self.ipython_display_formatter(obj)`. I guess the author (Volker?) of the test thought the test is necessary before resorting to ipython for output.\n\nDo you understand the logic of the test? I don't. If you do, would you explain? As it is practically impossible to check all side effects of the change, I think we need to understand the logic correctly and be sure it is safe to bypass the test.",
    "created_at": "2021-03-26T15:58:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31513#issuecomment-510514",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:14'></a>
Replying to [egourgoulhon](#comment%3A12):
> Here is a possible fix, which does not revert the pdf export fix introduced in #23330. I have instead modified `sage.repl.display.formatter.SageDisplayFormatter.format` so that IPython widgets are tried before Sage rich output. I've performed a few tests and things seem OK, but I am not completly sure about possible side effects of this fix. So please test it on your side. 


Then you bypass the test `set(sage_format.keys()).issubset(self.default_mime())` checked before calling `self.ipython_display_formatter(obj)`. I guess the author (Volker?) of the test thought the test is necessary before resorting to ipython for output.

Do you understand the logic of the test? I don't. If you do, would you explain? As it is practically impossible to check all side effects of the change, I think we need to understand the logic correctly and be sure it is safe to bypass the test.



---

archive/issue_comments_510515.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [klee](#comment%3A14):\n> \n> Then you bypass the test `set(sage_format.keys()).issubset(self.default_mime())` checked before calling `self.ipython_display_formatter(obj)`. I guess the author (Volker?) of the test thought the test is necessary before resorting to ipython for output.\n> \n> Do you understand the logic of the test? \n\n\nNo. I have to look deeper. Certainly Volker should check this.",
    "created_at": "2021-03-26T17:20:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31513#issuecomment-510515",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:15'></a>
Replying to [klee](#comment%3A14):
> 
> Then you bypass the test `set(sage_format.keys()).issubset(self.default_mime())` checked before calling `self.ipython_display_formatter(obj)`. I guess the author (Volker?) of the test thought the test is necessary before resorting to ipython for output.
> 
> Do you understand the logic of the test? 


No. I have to look deeper. Certainly Volker should check this.



---

archive/issue_comments_510516.json:
```json
{
    "body": "<a id='comment:16'></a>\nNow #31536 also contains fixes both for jupyter pdf export problem and this ticket.\n\nHope for no unexpected side effects..",
    "created_at": "2021-03-27T02:12:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31513#issuecomment-510516",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:16'></a>
Now #31536 also contains fixes both for jupyter pdf export problem and this ticket.

Hope for no unexpected side effects..



---

archive/issue_comments_510517.json:
```json
{
    "body": "<a id='comment:17'></a>\nReplying to [klee](#comment%3A16):\n> Now #31536 also contains fixes both for jupyter pdf export problem and this ticket.\n> \n\n\nThis sounds nice! I'll look at it today.",
    "created_at": "2021-03-27T09:55:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31513#issuecomment-510517",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:17'></a>
Replying to [klee](#comment%3A16):
> Now #31536 also contains fixes both for jupyter pdf export problem and this ticket.
> 


This sounds nice! I'll look at it today.



---

archive/issue_comments_510518.json:
```json
{
    "body": "<a id='comment:18'></a>\nMorally thats wrong, we should prefer our own formatter which gives e.g. the emacs backend a chance of handling things correctly. The problem is that ipython/jupyter doesn't have a blessed way of recognizing interact output, and moreover keeps adding more magic methods over time. The proposed patch is reasonable to me, hopefully the jupyter guys can keep `ipython_display_formatter` sufficently specific that only output is captured that is 100% ipython specific (like the current `@interact`s which cannot work anywhere else)\n\nNote that I didn't actually check this ticket for regressions.",
    "created_at": "2021-03-28T09:27:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31513#issuecomment-510518",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:18'></a>
Morally thats wrong, we should prefer our own formatter which gives e.g. the emacs backend a chance of handling things correctly. The problem is that ipython/jupyter doesn't have a blessed way of recognizing interact output, and moreover keeps adding more magic methods over time. The proposed patch is reasonable to me, hopefully the jupyter guys can keep `ipython_display_formatter` sufficently specific that only output is captured that is 100% ipython specific (like the current `@interact`s which cannot work anywhere else)

Note that I didn't actually check this ticket for regressions.



---

archive/issue_comments_510519.json:
```json
{
    "body": "<a id='comment:19'></a>\nReplying to [vbraun](#comment%3A18):\n> Morally thats wrong, we should prefer our own formatter which gives e.g. the emacs backend a chance of handling things correctly. The problem is that ipython/jupyter doesn't have a blessed way of recognizing interact output, and moreover keeps adding more magic methods over time. The proposed patch is reasonable to me, hopefully the jupyter guys can keep `ipython_display_formatter` sufficently specific that only output is captured that is 100% ipython specific (like the current `@interact`s which cannot work anywhere else)\n> \n\nThanks for your feedback.",
    "created_at": "2021-03-28T14:45:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31513#issuecomment-510519",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:19'></a>
Replying to [vbraun](#comment%3A18):
> Morally thats wrong, we should prefer our own formatter which gives e.g. the emacs backend a chance of handling things correctly. The problem is that ipython/jupyter doesn't have a blessed way of recognizing interact output, and moreover keeps adding more magic methods over time. The proposed patch is reasonable to me, hopefully the jupyter guys can keep `ipython_display_formatter` sufficently specific that only output is captured that is 100% ipython specific (like the current `@interact`s which cannot work anywhere else)
> 

Thanks for your feedback.



---

archive/issue_comments_510520.json:
```json
{
    "body": "<a id='comment:20'></a>\n#31536 seems in a good shape and would be a better fix for the issue reported here.",
    "created_at": "2021-03-30T10:14:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31513#issuecomment-510520",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:20'></a>
#31536 seems in a good shape and would be a better fix for the issue reported here.



---

archive/issue_events_287406.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2021-03-30T10:14:13Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31513#event-287406"
}
```



---

archive/issue_events_287407.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2021-03-30T10:14:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "label": "needs info",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31513#event-287407"
}
```



---

archive/issue_comments_510521.json:
```json
{
    "body": "**Changing branch** from \"[public/trac31513_display_latex_ipywidgets](https://github.com/sagemath/sagetrac-mirror/tree/public/trac31513_display_latex_ipywidgets)\" to \"\".",
    "created_at": "2021-03-31T07:37:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31513#issuecomment-510521",
    "user": "https://github.com/egourgoulhon"
}
```

**Changing branch** from "[public/trac31513_display_latex_ipywidgets](https://github.com/sagemath/sagetrac-mirror/tree/public/trac31513_display_latex_ipywidgets)" to "".



---

archive/issue_comments_510522.json:
```json
{
    "body": "<a id='comment:21'></a>\nNow that #31536 is ready, we should use it to fix the issue reported here. In particular, #31536 complies with the moral behaviour expressed in [comment:18](#comment%3A18).",
    "created_at": "2021-03-31T07:37:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31513#issuecomment-510522",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:21'></a>
Now that #31536 is ready, we should use it to fix the issue reported here. In particular, #31536 complies with the moral behaviour expressed in [comment:18](#comment%3A18).



---

archive/issue_events_287408.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2021-03-31T07:37:15Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "label": "needs info",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31513#event-287408"
}
```



---

archive/issue_events_287409.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2021-03-31T07:37:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31513#event-287409"
}
```



---

archive/issue_comments_510523.json:
```json
{
    "body": "**Changing author** from \"Eric Gourgoulhon\" to \"\".",
    "created_at": "2021-03-31T07:37:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31513#issuecomment-510523",
    "user": "https://github.com/egourgoulhon"
}
```

**Changing author** from "Eric Gourgoulhon" to "".



---

archive/issue_events_287410.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2021-03-31T07:37:15Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31513#event-287410"
}
```



---

archive/issue_events_287411.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2021-03-31T07:37:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "label": "duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31513#event-287411"
}
```



---

archive/issue_comments_510524.json:
```json
{
    "body": "**Changing commit** from \"[046892eee8198c4112c45bf52f96131d8be9a40f](https://github.com/sagemath/sagetrac-mirror/commit/046892eee8198c4112c45bf52f96131d8be9a40f)\" to \"\".",
    "created_at": "2021-03-31T07:37:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31513#issuecomment-510524",
    "user": "https://github.com/egourgoulhon"
}
```

**Changing commit** from "[046892eee8198c4112c45bf52f96131d8be9a40f](https://github.com/sagemath/sagetrac-mirror/commit/046892eee8198c4112c45bf52f96131d8be9a40f)" to "".



---

archive/issue_events_287412.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-31T17:00:12Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "label": "blocker",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31513#event-287412"
}
```



---

archive/issue_comments_510525.json:
```json
{
    "body": "**Dependencies:** #31536",
    "created_at": "2021-03-31T17:00:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31513#issuecomment-510525",
    "user": "https://github.com/mkoeppe"
}
```

**Dependencies:** #31536



---

archive/issue_events_287413.json:
```json
{
    "actor": "https://github.com/kwankyu",
    "created_at": "2021-04-07T02:15:56Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31513#event-287413"
}
```



---

archive/issue_events_287414.json:
```json
{
    "actor": "https://github.com/kwankyu",
    "created_at": "2021-04-07T02:15:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31513#event-287414"
}
```



---

archive/issue_comments_510526.json:
```json
{
    "body": "<a id='comment:23'></a>\nfixed in Sage 9.3.rc2",
    "created_at": "2021-04-07T02:15:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31513#issuecomment-510526",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:23'></a>
fixed in Sage 9.3.rc2



---

archive/issue_comments_510527.json:
```json
{
    "body": "**Reviewer:** Kwankyu Lee",
    "created_at": "2021-05-23T08:30:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31513#issuecomment-510527",
    "user": "https://github.com/slel"
}
```

**Reviewer:** Kwankyu Lee



---

archive/issue_events_287415.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2021-05-23T08:30:57Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31513#event-287415"
}
```



---

archive/issue_events_287416.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2021-05-23T08:30:57Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31513",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31513#event-287416"
}
```
