# Issue 31901: Chart: Implement pickling via __getstate__/__setstate__

archive/issues_031664.json:
```json
{
    "assignees": [],
    "body": "In this ticket, we implement the pickling protocol using `__getstate__` and `__setstate__`\n\n\nDepends on #31894\n\nCC:  @egourgoulhon @tscrim @mjungmath\n\nBranch/Commit: **[u/mkoeppe/chart__no_longer_use_uniquerepresentation__implement___getstate_____setstate__](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/chart__no_longer_use_uniquerepresentation__implement___getstate_____setstate__) @ [`30a5d0b`](https://github.com/sagemath/sagetrac-mirror/commit/30a5d0ba21f277044eebe7dfe6e3b463bcd0c5c5)**\n\nWork Issues: **redo on top of #31894**\n\nComponent: **manifolds**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/31901_\n\n",
    "created_at": "2021-06-03T21:51:56Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20manifolds",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/enhancement",
        "https://github.com/sagemath/sage/labels/wishlist%20item"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Chart: Implement pickling via __getstate__/__setstate__",
    "type": "issue",
    "updated_at": "2021-07-13T00:24:18Z",
    "url": "https://github.com/sagemath/sage/issues/31901",
    "user": "https://github.com/mkoeppe"
}
```
In this ticket, we implement the pickling protocol using `__getstate__` and `__setstate__`


Depends on #31894

CC:  @egourgoulhon @tscrim @mjungmath

Branch/Commit: **[u/mkoeppe/chart__no_longer_use_uniquerepresentation__implement___getstate_____setstate__](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/chart__no_longer_use_uniquerepresentation__implement___getstate_____setstate__) @ [`30a5d0b`](https://github.com/sagemath/sagetrac-mirror/commit/30a5d0ba21f277044eebe7dfe6e3b463bcd0c5c5)**

Work Issues: **redo on top of #31894**

Component: **manifolds**

_Issue created by migration from https://trac.sagemath.org/ticket/31901_





---

archive/issue_events_436661.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-06-03T21:51:56Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31901#event-436661"
}
```



---

archive/issue_events_436662.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-06-03T21:51:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20manifolds",
    "label_color": "0000ff",
    "label_name": "c: manifolds",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31901#event-436662"
}
```



---

archive/issue_events_436663.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-06-03T21:51:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31901#event-436663"
}
```



---

archive/issue_events_436664.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-06-03T21:51:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31901#event-436664"
}
```



---

archive/issue_comments_512948.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,7 @@\n-Chart is missing `__classcall__` to normalize init arguments.\n+Because of the method `add_restrictions` (which changes `self` by adding codomain restrictions), `Chart` needs to be considered as a mutable class. The current pickling based on `UniqueRepresentation` therefore cannot work correctly. \n \n-Perhaps all string parsing in `_init_coordinates` should already be done in `__classcall__`.\n+In this ticket,\n+- we make it possible to pass the codomain restrictions already when initializing the chart\n+- we implement the pickling protocol using `__getstate__` and `__setstate__`\n+- we implement the mutability protocol\n \n``````\n",
    "created_at": "2021-06-20T05:14:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512948",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,7 @@
-Chart is missing `__classcall__` to normalize init arguments.
+Because of the method `add_restrictions` (which changes `self` by adding codomain restrictions), `Chart` needs to be considered as a mutable class. The current pickling based on `UniqueRepresentation` therefore cannot work correctly. 
 
-Perhaps all string parsing in `_init_coordinates` should already be done in `__classcall__`.
+In this ticket,
+- we make it possible to pass the codomain restrictions already when initializing the chart
+- we implement the pickling protocol using `__getstate__` and `__setstate__`
+- we implement the mutability protocol
 
``````




---

archive/issue_events_436665.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-06-20T05:14:09Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "title_is": "Chart: No longer use UniqueRepresentation; implement __getstate__/__setstate__",
    "title_was": "Chart: UniqueRepresentation fixes",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31901#event-436665"
}
```



---

archive/issue_comments_512949.json:
```json
{
    "body": "Replying to [ticket:31901 mkoeppe]:\n> In this ticket,\n> - we make it possible to pass the codomain restrictions already when initializing the chart\n\nThis would be nice! In the early stages of the manifold project, I did not manage to do it simply, i.e. without changing Sage's preparser, since\n\n```\nsage: D = Manifold(2, 'D')                                                                          \nsage: X.<x,y> = D.chart(restrictions=x^2 + y^2 < 1)                                                 \n```\nwould generate `NameError: name 'y' is not defined`. Of course, one could replace `x^2 + y^2 < 1` by the string `\"x^2 + y^2 < 1\"`, but this is not very user-friendly. Do you already have some solution in mind?",
    "created_at": "2021-06-24T10:46:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512949",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [ticket:31901 mkoeppe]:
> In this ticket,
> - we make it possible to pass the codomain restrictions already when initializing the chart

This would be nice! In the early stages of the manifold project, I did not manage to do it simply, i.e. without changing Sage's preparser, since

```
sage: D = Manifold(2, 'D')                                                                          
sage: X.<x,y> = D.chart(restrictions=x^2 + y^2 < 1)                                                 
```
would generate `NameError: name 'y' is not defined`. Of course, one could replace `x^2 + y^2 < 1` by the string `"x^2 + y^2 < 1"`, but this is not very user-friendly. Do you already have some solution in mind?



---

archive/issue_comments_512950.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nSome thought: if `UniqueRepresentation` is abandoned for charts, it may be desirable to maintain `WithEqualityById` (one of the two mother classes of `UniqueRepresentation`) to have a fast equality operator. Indeed charts are heavily used as dictionary keys: for coordinates of manifold points, for coordinate expressions of scalar fields (the latter being used, among other things, to store the components of tensor fields), for coordinate expressions of continuous maps between manifolds (the keys being pairs of charts in that case), etc. Certainly `WithEqualityById` is the fastest equality operator and thus provides a fast access to the above dictionaries.",
    "created_at": "2021-06-24T12:36:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512950",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:3" align="right">comment:3</div>

Some thought: if `UniqueRepresentation` is abandoned for charts, it may be desirable to maintain `WithEqualityById` (one of the two mother classes of `UniqueRepresentation`) to have a fast equality operator. Indeed charts are heavily used as dictionary keys: for coordinates of manifold points, for coordinate expressions of scalar fields (the latter being used, among other things, to store the components of tensor fields), for coordinate expressions of continuous maps between manifolds (the keys being pairs of charts in that case), etc. Certainly `WithEqualityById` is the fastest equality operator and thus provides a fast access to the above dictionaries.



---

archive/issue_comments_512951.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nReplying to [@egourgoulhon](#comment:2):\n> Replying to [ticket:31901 mkoeppe]:\n> \n> ```\n> sage: D = Manifold(2, 'D')                                                                          \n> sage: X.<x,y> = D.chart(restrictions=x^2 + y^2 < 1)                                                 \n> ```\n> would generate `NameError: name 'y' is not defined`. Of course, one could replace `x^2 + y^2 < 1` by the string `\"x^2 + y^2 < 1\"`, but this is not very user-friendly. Do you already have some solution in mind?\n>  \n\nAh! That's of course a problem, I didn't realize this",
    "created_at": "2021-06-24T16:58:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512951",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:4" align="right">comment:4</div>

Replying to [@egourgoulhon](#comment:2):
> Replying to [ticket:31901 mkoeppe]:
> 
> ```
> sage: D = Manifold(2, 'D')                                                                          
> sage: X.<x,y> = D.chart(restrictions=x^2 + y^2 < 1)                                                 
> ```
> would generate `NameError: name 'y' is not defined`. Of course, one could replace `x^2 + y^2 < 1` by the string `"x^2 + y^2 < 1"`, but this is not very user-friendly. Do you already have some solution in mind?
>  

Ah! That's of course a problem, I didn't realize this



---

archive/issue_comments_512952.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,7 +1,6 @@\n Because of the method `add_restrictions` (which changes `self` by adding codomain restrictions), `Chart` needs to be considered as a mutable class. The current pickling based on `UniqueRepresentation` therefore cannot work correctly. \n \n In this ticket,\n-- we make it possible to pass the codomain restrictions already when initializing the chart\n - we implement the pickling protocol using `__getstate__` and `__setstate__`\n - we implement the mutability protocol\n \n``````\n",
    "created_at": "2021-06-24T16:58:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512952",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,7 +1,6 @@
 Because of the method `add_restrictions` (which changes `self` by adding codomain restrictions), `Chart` needs to be considered as a mutable class. The current pickling based on `UniqueRepresentation` therefore cannot work correctly. 
 
 In this ticket,
-- we make it possible to pass the codomain restrictions already when initializing the chart
 - we implement the pickling protocol using `__getstate__` and `__setstate__`
 - we implement the mutability protocol
 
``````




---

archive/issue_comments_512953.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nMaybe a chart should become immutable \"upon first use\"?",
    "created_at": "2021-06-24T17:11:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512953",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:6" align="right">comment:6</div>

Maybe a chart should become immutable "upon first use"?



---

archive/issue_comments_512954.json:
```json
{
    "body": "Branch: **[u/mkoeppe/chart__no_longer_use_uniquerepresentation__implement___getstate_____setstate__](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/chart__no_longer_use_uniquerepresentation__implement___getstate_____setstate__)**",
    "created_at": "2021-06-24T18:37:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512954",
    "user": "https://github.com/mkoeppe"
}
```

Branch: **[u/mkoeppe/chart__no_longer_use_uniquerepresentation__implement___getstate_____setstate__](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/chart__no_longer_use_uniquerepresentation__implement___getstate_____setstate__)**



---

archive/issue_comments_512955.json:
```json
{
    "body": "<div id=\"comment:8\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5215e93549135b378736ad9da655af2577bf06bf\"><code>5215e93</code></a></td><td><code>Chart: WIP WithEqualityById instead of UniqueRepresentation; disambiguate _restrictions -> _coordinate_restrictions</code></td></tr></table>\n",
    "created_at": "2021-06-24T18:38:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512955",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:8"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5215e93549135b378736ad9da655af2577bf06bf"><code>5215e93</code></a></td><td><code>Chart: WIP WithEqualityById instead of UniqueRepresentation; disambiguate _restrictions -> _coordinate_restrictions</code></td></tr></table>




---

archive/issue_comments_512956.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -4,3 +4,5 @@\n - we implement the pickling protocol using `__getstate__` and `__setstate__`\n - we implement the mutability protocol\n \n+This is also preparation for #31894.\n+\n``````\n",
    "created_at": "2021-06-24T18:38:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512956",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -4,3 +4,5 @@
 - we implement the pickling protocol using `__getstate__` and `__setstate__`
 - we implement the mutability protocol
 
+This is also preparation for #31894.
+
``````




---

archive/issue_comments_512957.json:
```json
{
    "body": "Commit: **[`5215e93`](https://github.com/sagemath/sagetrac-mirror/commit/5215e93549135b378736ad9da655af2577bf06bf)**",
    "created_at": "2021-06-24T18:38:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512957",
    "user": "https://github.com/mkoeppe"
}
```

Commit: **[`5215e93`](https://github.com/sagemath/sagetrac-mirror/commit/5215e93549135b378736ad9da655af2577bf06bf)**



---

archive/issue_comments_512958.json:
```json
{
    "body": "<div id=\"comment:9\"></div>\n\nBranch pushed to git repo; I updated commit sha1. Last 10 new commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/facad9753750e64d39d5cc6087be292edff94beb\"><code>facad97</code></a></td><td><code>ContinuousMap.preimage: Handle identity_map specially</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c2ecf3ebd9d00b2fac2fe8e5d4aca0b3da1ea1ae\"><code>c2ecf3e</code></a></td><td><code>ScalarField.preimage: Handle the case of the zero scalar field</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3b1c4280d4b9d935e8b9fdcd7868343899ab2544\"><code>3b1c428</code></a></td><td><code>ManifoldSubsetPullback: Make codomain_subset required 2nd init arg; fix pycodestyle/pyflakes warnings</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d321b93a9a40effb0c67aae593fc6915e7fd9417\"><code>d321b93</code></a></td><td><code>ContinuousMap: Return domain if the map's codomain is contained in the given subset</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/07aba9eba1d82d3d0c85e819224b99aabe280d81\"><code>07aba9e</code></a></td><td><code>ManifoldSubsetPullback.is_closed: Preimage of finite sets is closed</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/653c651ca9477afdac82c2448b2507ffa85c1235\"><code>653c651</code></a></td><td><code>src/sage/manifolds/subsets/pullback.py: Fix docstring markup</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0f2e018734b66718008fb7a2a83e47ff460009f8\"><code>0f2e018</code></a></td><td><code>Merge #31688</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e3e38cae8185f2c3c288b05c70c7c1626015bd8e\"><code>e3e38ca</code></a></td><td><code>Chart.__init__: Move code that attaches self to the domain to TopologicalManifold.chart</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3581c75f3a0a17664edb38a34f8d6c9e663d5380\"><code>3581c75</code></a></td><td><code>Chart.function_ring: Cache via @cached_method, not UniqueRepresentation</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/869599d9b2177ae7376cf8480ff0aafb01239563\"><code>869599d</code></a></td><td><code>Chart: WIP equality/immutability/pickling</code></td></tr></table>\n",
    "created_at": "2021-06-30T02:17:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512958",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:9"></div>

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/facad9753750e64d39d5cc6087be292edff94beb"><code>facad97</code></a></td><td><code>ContinuousMap.preimage: Handle identity_map specially</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c2ecf3ebd9d00b2fac2fe8e5d4aca0b3da1ea1ae"><code>c2ecf3e</code></a></td><td><code>ScalarField.preimage: Handle the case of the zero scalar field</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3b1c4280d4b9d935e8b9fdcd7868343899ab2544"><code>3b1c428</code></a></td><td><code>ManifoldSubsetPullback: Make codomain_subset required 2nd init arg; fix pycodestyle/pyflakes warnings</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d321b93a9a40effb0c67aae593fc6915e7fd9417"><code>d321b93</code></a></td><td><code>ContinuousMap: Return domain if the map's codomain is contained in the given subset</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/07aba9eba1d82d3d0c85e819224b99aabe280d81"><code>07aba9e</code></a></td><td><code>ManifoldSubsetPullback.is_closed: Preimage of finite sets is closed</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/653c651ca9477afdac82c2448b2507ffa85c1235"><code>653c651</code></a></td><td><code>src/sage/manifolds/subsets/pullback.py: Fix docstring markup</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0f2e018734b66718008fb7a2a83e47ff460009f8"><code>0f2e018</code></a></td><td><code>Merge #31688</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e3e38cae8185f2c3c288b05c70c7c1626015bd8e"><code>e3e38ca</code></a></td><td><code>Chart.__init__: Move code that attaches self to the domain to TopologicalManifold.chart</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3581c75f3a0a17664edb38a34f8d6c9e663d5380"><code>3581c75</code></a></td><td><code>Chart.function_ring: Cache via @cached_method, not UniqueRepresentation</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/869599d9b2177ae7376cf8480ff0aafb01239563"><code>869599d</code></a></td><td><code>Chart: WIP equality/immutability/pickling</code></td></tr></table>




---

archive/issue_comments_512959.json:
```json
{
    "body": "Changed commit from **[`5215e93`](https://github.com/sagemath/sagetrac-mirror/commit/5215e93549135b378736ad9da655af2577bf06bf)** to **[`869599d`](https://github.com/sagemath/sagetrac-mirror/commit/869599d9b2177ae7376cf8480ff0aafb01239563)**",
    "created_at": "2021-06-30T02:17:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512959",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`5215e93`](https://github.com/sagemath/sagetrac-mirror/commit/5215e93549135b378736ad9da655af2577bf06bf)** to **[`869599d`](https://github.com/sagemath/sagetrac-mirror/commit/869599d9b2177ae7376cf8480ff0aafb01239563)**



---

archive/issue_comments_512960.json:
```json
{
    "body": "Dependencies: **#31688**",
    "created_at": "2021-06-30T02:18:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512960",
    "user": "https://github.com/mkoeppe"
}
```

Dependencies: **#31688**



---

archive/issue_comments_512961.json:
```json
{
    "body": "Changed commit from **[`869599d`](https://github.com/sagemath/sagetrac-mirror/commit/869599d9b2177ae7376cf8480ff0aafb01239563)** to **[`d071d56`](https://github.com/sagemath/sagetrac-mirror/commit/d071d56c3c25abb47f04ad9731dfd08c188c22c7)**",
    "created_at": "2021-06-30T02:19:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512961",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`869599d`](https://github.com/sagemath/sagetrac-mirror/commit/869599d9b2177ae7376cf8480ff0aafb01239563)** to **[`d071d56`](https://github.com/sagemath/sagetrac-mirror/commit/d071d56c3c25abb47f04ad9731dfd08c188c22c7)**



---

archive/issue_comments_512962.json:
```json
{
    "body": "<div id=\"comment:11\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d071d56c3c25abb47f04ad9731dfd08c188c22c7\"><code>d071d56</code></a></td><td><code>TopologicalSubmanifold: Adjust to renamed chart attribute _coord_restrictions</code></td></tr></table>\n",
    "created_at": "2021-06-30T02:19:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512962",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:11"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d071d56c3c25abb47f04ad9731dfd08c188c22c7"><code>d071d56</code></a></td><td><code>TopologicalSubmanifold: Adjust to renamed chart attribute _coord_restrictions</code></td></tr></table>




---

archive/issue_comments_512963.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nThe last obstacle is this code which tries to hash a chart when it is still mutable.\n\n```\n        # The null and one functions of the coordinates:\n        # Expression in self of the zero and one scalar fields of open sets\n        # containing the domain of self:\n        for dom in self.open_supersets():\n            dom._zero_scalar_field._express[chart] = chart.function_ring().zero()\n            dom._one_scalar_field._express[chart] = chart.function_ring().one()\n```",
    "created_at": "2021-06-30T02:21:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512963",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:12" align="right">comment:12</div>

The last obstacle is this code which tries to hash a chart when it is still mutable.

```
        # The null and one functions of the coordinates:
        # Expression in self of the zero and one scalar fields of open sets
        # containing the domain of self:
        for dom in self.open_supersets():
            dom._zero_scalar_field._express[chart] = chart.function_ring().zero()
            dom._one_scalar_field._express[chart] = chart.function_ring().one()
```



---

archive/issue_comments_512964.json:
```json
{
    "body": "Changed commit from **[`d071d56`](https://github.com/sagemath/sagetrac-mirror/commit/d071d56c3c25abb47f04ad9731dfd08c188c22c7)** to **[`7b822b4`](https://github.com/sagemath/sagetrac-mirror/commit/7b822b4f5efbb138bddfd779051fe0c29b73d7c7)**",
    "created_at": "2021-06-30T05:40:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512964",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`d071d56`](https://github.com/sagemath/sagetrac-mirror/commit/d071d56c3c25abb47f04ad9731dfd08c188c22c7)** to **[`7b822b4`](https://github.com/sagemath/sagetrac-mirror/commit/7b822b4f5efbb138bddfd779051fe0c29b73d7c7)**



---

archive/issue_comments_512965.json:
```json
{
    "body": "<div id=\"comment:13\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7b822b4f5efbb138bddfd779051fe0c29b73d7c7\"><code>7b822b4</code></a></td><td><code>Fixup</code></td></tr></table>\n",
    "created_at": "2021-06-30T05:40:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512965",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:13"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7b822b4f5efbb138bddfd779051fe0c29b73d7c7"><code>7b822b4</code></a></td><td><code>Fixup</code></td></tr></table>




---

archive/issue_comments_512966.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@mkoeppe](#comment:6):\n> Maybe a chart should become immutable \"upon first use\"? \n\nThis is the approach that I have been trying out in this branch. \nBut it does not work in examples like this one:\n\n```\n            sage: M = Manifold(2, 'M', structure='topological')\n            sage: X.<x,y> = M.chart()\n            sage: U = M.open_subset('U', coord_def={X: [x>1, y<pi]})\n```\nbecause `X` in `coord_def` is unhashable, leading to an error.\n\nSo perhaps an API change is needed, after all...",
    "created_at": "2021-06-30T05:47:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512966",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@mkoeppe](#comment:6):
> Maybe a chart should become immutable "upon first use"? 

This is the approach that I have been trying out in this branch. 
But it does not work in examples like this one:

```
            sage: M = Manifold(2, 'M', structure='topological')
            sage: X.<x,y> = M.chart()
            sage: U = M.open_subset('U', coord_def={X: [x>1, y<pi]})
```
because `X` in `coord_def` is unhashable, leading to an error.

So perhaps an API change is needed, after all...



---

archive/issue_comments_512967.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nIn the current branch, `Chart` inherits from `WithEqualityById` but redefines `__eq__` (in a rather complicated and possibly CPU time consuming way). Doesn't this defeat the purpose? In particular in view of [comment:3](#comment:3).\n\nIn the code of `__hash__`, isn't\n\n```\nif not self.is_immutable():\n    raise TypeError('Charts are unhashable until set_immutable() has been called')\n```\nan unnecessary limitation? \nMore generally, why do you want to make `Chart` mutable? It is logically immutable: a chart is entirely defined by its domain and its coordinates (i.e. a tuple of symbolic variables). Coordinate restrictions, which can be added only after `__init__` via `add_restrictions` in the current implementation, do not (mathematically) modify the object: there cannot be two charts with the same domain and the same coordinates, but with different coordinate restrictions.",
    "created_at": "2021-06-30T07:12:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512967",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:15" align="right">comment:15</div>

In the current branch, `Chart` inherits from `WithEqualityById` but redefines `__eq__` (in a rather complicated and possibly CPU time consuming way). Doesn't this defeat the purpose? In particular in view of [comment:3](#comment:3).

In the code of `__hash__`, isn't

```
if not self.is_immutable():
    raise TypeError('Charts are unhashable until set_immutable() has been called')
```
an unnecessary limitation? 
More generally, why do you want to make `Chart` mutable? It is logically immutable: a chart is entirely defined by its domain and its coordinates (i.e. a tuple of symbolic variables). Coordinate restrictions, which can be added only after `__init__` via `add_restrictions` in the current implementation, do not (mathematically) modify the object: there cannot be two charts with the same domain and the same coordinates, but with different coordinate restrictions.



---

archive/issue_comments_512968.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nA possible option to get rid of the 2-stages construction of a chart (i.e. to get rid of the requirement of invoking `add_restriction` after `__init__`) could be to add the keyword argument `restrictions` to `Chart.__init__`, which can be either \n- a string (case with no predefined coordinate variables, i.e. chart created from scratch)\n- a nested list/tuple of symbolic expressions (case of a chart created from another one, as in `Chart.restrict`)\nAfter all, when creating a chart from scratch, we are already passing a string if we want to specify the coordinate ranges and LaTeX symbols; so maybe we could admit having a second string...\nFor instance, we could have something like\n\n```\nsage: H = Manifold(2, 'H')  # half-disk\nsage: X.<x,y> = H.chart(r\"x y:(0,+oo)\", restrictions=\"x^2 + y^2 < 1\")\n```\nor equivalently\n\n```\nsage: X.<x,y> = H.chart(restrictions=\"[x^2 + y^2 < 1, y>0]\")\n```\nThen we could get rid of the method `add_restriction` and consider that the chart is a fully immutable object (of course, technically speaking, the sheafy attributes can be muted).",
    "created_at": "2021-06-30T10:22:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512968",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:16" align="right">comment:16</div>

A possible option to get rid of the 2-stages construction of a chart (i.e. to get rid of the requirement of invoking `add_restriction` after `__init__`) could be to add the keyword argument `restrictions` to `Chart.__init__`, which can be either 
- a string (case with no predefined coordinate variables, i.e. chart created from scratch)
- a nested list/tuple of symbolic expressions (case of a chart created from another one, as in `Chart.restrict`)
After all, when creating a chart from scratch, we are already passing a string if we want to specify the coordinate ranges and LaTeX symbols; so maybe we could admit having a second string...
For instance, we could have something like

```
sage: H = Manifold(2, 'H')  # half-disk
sage: X.<x,y> = H.chart(r"x y:(0,+oo)", restrictions="x^2 + y^2 < 1")
```
or equivalently

```
sage: X.<x,y> = H.chart(restrictions="[x^2 + y^2 < 1, y>0]")
```
Then we could get rid of the method `add_restriction` and consider that the chart is a fully immutable object (of course, technically speaking, the sheafy attributes can be muted).



---

archive/issue_comments_512969.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@egourgoulhon](#comment:15):\n> In the current branch, `Chart` inherits from `WithEqualityById` but redefines `__eq__` (in a rather complicated and possibly CPU time consuming way). Doesn't this defeat the purpose? \n\nYes, this part is not finished. I started with `WithEqualityById` as per your suggestion, but I wanted to implement actual pickling (not just passing the pickling-related testsuite) as a step to actual pickling of manifolds. Then the identity and unique-representation tricks are not sufficient any more, and one needs to implement full comparison.\n\nOne can still have a fast path for equality using id, and fast lookup in sets etc. via a fast hash.",
    "created_at": "2021-07-02T18:01:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512969",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@egourgoulhon](#comment:15):
> In the current branch, `Chart` inherits from `WithEqualityById` but redefines `__eq__` (in a rather complicated and possibly CPU time consuming way). Doesn't this defeat the purpose? 

Yes, this part is not finished. I started with `WithEqualityById` as per your suggestion, but I wanted to implement actual pickling (not just passing the pickling-related testsuite) as a step to actual pickling of manifolds. Then the identity and unique-representation tricks are not sufficient any more, and one needs to implement full comparison.

One can still have a fast path for equality using id, and fast lookup in sets etc. via a fast hash.



---

archive/issue_comments_512970.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@egourgoulhon](#comment:15):\n> More generally, why do you want to make `Chart` mutable? \n\nI don't really, it was just an attempt to keep the current API (initialization, followed by `add_restrictions`) but implementing pickling.",
    "created_at": "2021-07-02T18:05:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512970",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@egourgoulhon](#comment:15):
> More generally, why do you want to make `Chart` mutable? 

I don't really, it was just an attempt to keep the current API (initialization, followed by `add_restrictions`) but implementing pickling.



---

archive/issue_comments_512971.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nWhen discussing a possible redesign of chart initialization, I think a relevant issue is the current use of the symbolic assumptions facility for the coordinates.\n\nAre two charts with a different tuple of variables allowed to share some variables? If yes, does the shared variable have to have the same global assumptions and periodicity?\n\nAlso I note that creating a `RealChart` puts global assumptions on the variables of the chart. So creating a subchart will affect simplification of expressions that relate to computation on the original chart. This should probably be revised.",
    "created_at": "2021-07-02T18:16:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512971",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:19" align="right">comment:19</div>

When discussing a possible redesign of chart initialization, I think a relevant issue is the current use of the symbolic assumptions facility for the coordinates.

Are two charts with a different tuple of variables allowed to share some variables? If yes, does the shared variable have to have the same global assumptions and periodicity?

Also I note that creating a `RealChart` puts global assumptions on the variables of the chart. So creating a subchart will affect simplification of expressions that relate to computation on the original chart. This should probably be revised.



---

archive/issue_comments_512972.json:
```json
{
    "body": "<div id=\"comment:20\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4b930ffd8509e1e9553d683787dad57ba9e81995\"><code>4b930ff</code></a></td><td><code>Merge tag '9.4.beta4' into t/31688/pullbacks_of_manifold_subsets_under_continuous_maps</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/96e1fbf0e91282303a7996a3e33788a8e9dd5daa\"><code>96e1fbf</code></a></td><td><code>Merge branch 't/31688/pullbacks_of_manifold_subsets_under_continuous_maps' into t/31901/chart__no_longer_use_uniquerepresentation__implement___getstate_____setstate__</code></td></tr></table>\n",
    "created_at": "2021-07-02T18:19:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512972",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:20"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4b930ffd8509e1e9553d683787dad57ba9e81995"><code>4b930ff</code></a></td><td><code>Merge tag '9.4.beta4' into t/31688/pullbacks_of_manifold_subsets_under_continuous_maps</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/96e1fbf0e91282303a7996a3e33788a8e9dd5daa"><code>96e1fbf</code></a></td><td><code>Merge branch 't/31688/pullbacks_of_manifold_subsets_under_continuous_maps' into t/31901/chart__no_longer_use_uniquerepresentation__implement___getstate_____setstate__</code></td></tr></table>




---

archive/issue_comments_512973.json:
```json
{
    "body": "Changed commit from **[`7b822b4`](https://github.com/sagemath/sagetrac-mirror/commit/7b822b4f5efbb138bddfd779051fe0c29b73d7c7)** to **[`96e1fbf`](https://github.com/sagemath/sagetrac-mirror/commit/96e1fbf0e91282303a7996a3e33788a8e9dd5daa)**",
    "created_at": "2021-07-02T18:19:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512973",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`7b822b4`](https://github.com/sagemath/sagetrac-mirror/commit/7b822b4f5efbb138bddfd779051fe0c29b73d7c7)** to **[`96e1fbf`](https://github.com/sagemath/sagetrac-mirror/commit/96e1fbf0e91282303a7996a3e33788a8e9dd5daa)**



---

archive/issue_comments_512974.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nReplying to [@mkoeppe](#comment:19):\n> When discussing a possible redesign of chart initialization, I think a relevant issue is the current use of the symbolic assumptions facility for the coordinates.\n> \n> Are two charts with a different tuple of variables allowed to share some variables? \n\nYes, definitely. This is a desirable feature.\n\n> If yes, does the shared variable have to have the same global assumptions and periodicity?\n\nNo (see below).\n> \n> Also I note that creating a `RealChart` puts global assumptions on the variables of the chart. So creating a subchart will affect simplification of expressions that relate to computation on the original chart. This should probably be revised.\n\nYes, absolutely. This is something I have in mind for a long time but did not find the time to work on it. The assumptions should not be global but chart-wise. The way Sage's symbolic calculus is implemented, I guess this means that they should be switched on (via `assume`) before each calculus at the chart function level and switched off once the calculus is done (via `forget`). \n\nA connected question is how to pass these chart-based assumptions to SymPy, in case the latter has been chosen as the default symbolic backend on the manifold (via `M.set_calculus_method('sympy')`) or on a given chart `X` (via `X.calculus_method().set('sympy')`). For the time being, calculus with SymPy is possible but the assumptions are not taken into account on the SymPy side...\n\n>",
    "created_at": "2021-07-02T20:03:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512974",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:21" align="right">comment:21</div>

Replying to [@mkoeppe](#comment:19):
> When discussing a possible redesign of chart initialization, I think a relevant issue is the current use of the symbolic assumptions facility for the coordinates.
> 
> Are two charts with a different tuple of variables allowed to share some variables? 

Yes, definitely. This is a desirable feature.

> If yes, does the shared variable have to have the same global assumptions and periodicity?

No (see below).
> 
> Also I note that creating a `RealChart` puts global assumptions on the variables of the chart. So creating a subchart will affect simplification of expressions that relate to computation on the original chart. This should probably be revised.

Yes, absolutely. This is something I have in mind for a long time but did not find the time to work on it. The assumptions should not be global but chart-wise. The way Sage's symbolic calculus is implemented, I guess this means that they should be switched on (via `assume`) before each calculus at the chart function level and switched off once the calculus is done (via `forget`). 

A connected question is how to pass these chart-based assumptions to SymPy, in case the latter has been chosen as the default symbolic backend on the manifold (via `M.set_calculus_method('sympy')`) or on a given chart `X` (via `X.calculus_method().set('sympy')`). For the time being, calculus with SymPy is possible but the assumptions are not taken into account on the SymPy side...

>



---

archive/issue_comments_512975.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nReplying to [@egourgoulhon](#comment:21):\n> Replying to [@mkoeppe](#comment:19):\n> > When discussing a possible redesign of chart initialization, I think a relevant issue is the current use of the symbolic assumptions facility for the coordinates.\n> > \n> > Are two charts with a different tuple of variables allowed to share some variables? \n\n> \n> Yes, definitely. This is a desirable feature.\n> \n> > If yes, does the shared variable have to have the same global assumptions and periodicity?\n\n> \n> No (see below).\n\nOK. Then I think there is little point in trying to provide better syntax for creating the variables than asking the user to do `var('x, y, z')` before creating a chart with coordinate restrictions.\n\nThen the restrictions can just be passed as symbolic inequalities to the constructor. (I don't think going the string route would be an improvement.)\n\nWe could deprecate `add_restrictions` then.",
    "created_at": "2021-07-02T20:23:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512975",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:22" align="right">comment:22</div>

Replying to [@egourgoulhon](#comment:21):
> Replying to [@mkoeppe](#comment:19):
> > When discussing a possible redesign of chart initialization, I think a relevant issue is the current use of the symbolic assumptions facility for the coordinates.
> > 
> > Are two charts with a different tuple of variables allowed to share some variables? 

> 
> Yes, definitely. This is a desirable feature.
> 
> > If yes, does the shared variable have to have the same global assumptions and periodicity?

> 
> No (see below).

OK. Then I think there is little point in trying to provide better syntax for creating the variables than asking the user to do `var('x, y, z')` before creating a chart with coordinate restrictions.

Then the restrictions can just be passed as symbolic inequalities to the constructor. (I don't think going the string route would be an improvement.)

We could deprecate `add_restrictions` then.



---

archive/issue_comments_512976.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nReplying to [@egourgoulhon](#comment:21):\n> Replying to [@mkoeppe](#comment:19):\n> > Also I note that creating a `RealChart` puts global assumptions on the variables of the chart. [...]\n\n> Yes, absolutely. This is something I have in mind for a long time but did not find the time to work on it. The assumptions should not be global but chart-wise. The way Sage's symbolic calculus is implemented, I guess this means that they should be switched on (via `assume`) before each calculus at the chart function level and switched off once the calculus is done (via `forget`). \n\nThere is already a context manager `assuming` for that. We could create it at initialization and invoke it using `with` whenever computations are done with this chart.\n\nThe tricky bit is when two charts are involved with overlapping variables. Then some renaming may have to be done first. A possible route is through #32089.",
    "created_at": "2021-07-02T20:27:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512976",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:23" align="right">comment:23</div>

Replying to [@egourgoulhon](#comment:21):
> Replying to [@mkoeppe](#comment:19):
> > Also I note that creating a `RealChart` puts global assumptions on the variables of the chart. [...]

> Yes, absolutely. This is something I have in mind for a long time but did not find the time to work on it. The assumptions should not be global but chart-wise. The way Sage's symbolic calculus is implemented, I guess this means that they should be switched on (via `assume`) before each calculus at the chart function level and switched off once the calculus is done (via `forget`). 

There is already a context manager `assuming` for that. We could create it at initialization and invoke it using `with` whenever computations are done with this chart.

The tricky bit is when two charts are involved with overlapping variables. Then some renaming may have to be done first. A possible route is through #32089.



---

archive/issue_comments_512977.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nI have opened #32102 (`Chart`: Add init argument `coord_restrictions`, deprecate method `add_restrictions`)",
    "created_at": "2021-07-02T20:39:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512977",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:24" align="right">comment:24</div>

I have opened #32102 (`Chart`: Add init argument `coord_restrictions`, deprecate method `add_restrictions`)



---

archive/issue_comments_512978.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nReplying to [@egourgoulhon](#comment:21):\n> A connected question is how to pass these chart-based assumptions to SymPy, in case the latter has been chosen as the default symbolic backend on the manifold (via `M.set_calculus_method('sympy')`) or on a given chart `X` (via `X.calculus_method().set('sympy')`). For the time being, calculus with SymPy is possible but the assumptions are not taken into account on the SymPy side...\n\nI suppose we can go through a new method `assuming` of `CalculusMethod` that dispatches in the same way as the `simplify` method does.",
    "created_at": "2021-07-02T20:58:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512978",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:25" align="right">comment:25</div>

Replying to [@egourgoulhon](#comment:21):
> A connected question is how to pass these chart-based assumptions to SymPy, in case the latter has been chosen as the default symbolic backend on the manifold (via `M.set_calculus_method('sympy')`) or on a given chart `X` (via `X.calculus_method().set('sympy')`). For the time being, calculus with SymPy is possible but the assumptions are not taken into account on the SymPy side...

I suppose we can go through a new method `assuming` of `CalculusMethod` that dispatches in the same way as the `simplify` method does.



---

archive/issue_comments_512979.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nReplying to [@mkoeppe](#comment:22):\n> \n> OK. Then I think there is little point in trying to provide better syntax for creating the variables than asking the user to do `var('x, y, z')` before creating a chart with coordinate restrictions.\n\nThe issue here is that on real manifolds (by far the most used ones), the symbolic variables are created with the extra parameter `domain='real'` (cf. `RealChart._init_coordinates`), so the user must actually do `var('x y z', domain='real')`, which is not very intuitive. For some reason, it is not equivalent to `assume(x, 'real')`, which is performed in `RealChart._init_coordinates` as well. Both proved to be necessary for some simplifications.\n\n> \n> Then the restrictions can just be passed as symbolic inequalities to the constructor. (I don't think going the string route would be an improvement.)\n\nI don't like strings either, but I would prefer this to a 2-stage declaration involving `var`. Anyway, let us continue the discussion on #32102.\n> \n> We could deprecate `add_restrictions` then.\n\nYes.",
    "created_at": "2021-07-02T21:26:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512979",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:26" align="right">comment:26</div>

Replying to [@mkoeppe](#comment:22):
> 
> OK. Then I think there is little point in trying to provide better syntax for creating the variables than asking the user to do `var('x, y, z')` before creating a chart with coordinate restrictions.

The issue here is that on real manifolds (by far the most used ones), the symbolic variables are created with the extra parameter `domain='real'` (cf. `RealChart._init_coordinates`), so the user must actually do `var('x y z', domain='real')`, which is not very intuitive. For some reason, it is not equivalent to `assume(x, 'real')`, which is performed in `RealChart._init_coordinates` as well. Both proved to be necessary for some simplifications.

> 
> Then the restrictions can just be passed as symbolic inequalities to the constructor. (I don't think going the string route would be an improvement.)

I don't like strings either, but I would prefer this to a 2-stage declaration involving `var`. Anyway, let us continue the discussion on #32102.
> 
> We could deprecate `add_restrictions` then.

Yes.



---

archive/issue_comments_512980.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nReplying to [@mkoeppe](#comment:23):\n> Replying to [@egourgoulhon](#comment:21):\n> > Replying to [@mkoeppe](#comment:19):\n> > > Also I note that creating a `RealChart` puts global assumptions on the variables of the chart. [...]\n\n> > Yes, absolutely. This is something I have in mind for a long time but did not find the time to work on it. The assumptions should not be global but chart-wise. The way Sage's symbolic calculus is implemented, I guess this means that they should be switched on (via `assume`) before each calculus at the chart function level and switched off once the calculus is done (via `forget`). \n\n> \n> There is already a context manager `assuming` for that. We could create it at initialization and invoke it using `with` whenever computations are done with this chart.\n> \n> The tricky bit is when two charts are involved with overlapping variables. Then some renaming may have to be done first. \n\nI don't see why: two computations on two distinct charts can set different assumptions on the same variable. There is no ambiguity as long as assumptions are tied to charts.",
    "created_at": "2021-07-02T21:32:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512980",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:27" align="right">comment:27</div>

Replying to [@mkoeppe](#comment:23):
> Replying to [@egourgoulhon](#comment:21):
> > Replying to [@mkoeppe](#comment:19):
> > > Also I note that creating a `RealChart` puts global assumptions on the variables of the chart. [...]

> > Yes, absolutely. This is something I have in mind for a long time but did not find the time to work on it. The assumptions should not be global but chart-wise. The way Sage's symbolic calculus is implemented, I guess this means that they should be switched on (via `assume`) before each calculus at the chart function level and switched off once the calculus is done (via `forget`). 

> 
> There is already a context manager `assuming` for that. We could create it at initialization and invoke it using `with` whenever computations are done with this chart.
> 
> The tricky bit is when two charts are involved with overlapping variables. Then some renaming may have to be done first. 

I don't see why: two computations on two distinct charts can set different assumptions on the same variable. There is no ambiguity as long as assumptions are tied to charts.



---

archive/issue_comments_512981.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nReplying to [@egourgoulhon](#comment:21):\n> Replying to [@mkoeppe](#comment:19):\n> > When discussing a possible redesign of chart initialization, I think a relevant issue is the current use of the symbolic assumptions facility for the coordinates.\n> > \n> > Are two charts with a different tuple of variables allowed to share some variables? \n\n> \n> Yes, definitely. This is a desirable feature.\n\nA follow-up question on this:\n\n```\nsage: M = Manifold(2, 'M', structure='topological')\n....: U = M.open_subset('U')\n....: V = M.open_subset('V')\nsage: XU = U.chart(names=(\"x\", \"y\"))\nsage: XV = V.chart(names=(\"x\", \"y\"))\nsage: M.atlas()\n[Chart (U, (x, y)), Chart (V, (x, y))]\nsage: M.top_charts()\n[Chart (U, (x, y))]\n```\nClearly something went wrong here. \nShould there have been a declaration of something on `M` regarding the intention to declare charts with the coordinate pair `(x,y)` on subsets?",
    "created_at": "2021-07-03T00:35:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512981",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:28" align="right">comment:28</div>

Replying to [@egourgoulhon](#comment:21):
> Replying to [@mkoeppe](#comment:19):
> > When discussing a possible redesign of chart initialization, I think a relevant issue is the current use of the symbolic assumptions facility for the coordinates.
> > 
> > Are two charts with a different tuple of variables allowed to share some variables? 

> 
> Yes, definitely. This is a desirable feature.

A follow-up question on this:

```
sage: M = Manifold(2, 'M', structure='topological')
....: U = M.open_subset('U')
....: V = M.open_subset('V')
sage: XU = U.chart(names=("x", "y"))
sage: XV = V.chart(names=("x", "y"))
sage: M.atlas()
[Chart (U, (x, y)), Chart (V, (x, y))]
sage: M.top_charts()
[Chart (U, (x, y))]
```
Clearly something went wrong here. 
Should there have been a declaration of something on `M` regarding the intention to declare charts with the coordinate pair `(x,y)` on subsets?



---

archive/issue_comments_512982.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nReplying to [@egourgoulhon](#comment:26):\n> Replying to [@mkoeppe](#comment:22):\n> I think there is little point in trying to provide better syntax for creating the variables than asking the user to do `var('x, y, z')` before creating a chart with coordinate restrictions.\n> \n> The issue here is that on real manifolds (by far the most used ones), the symbolic variables are created with the extra parameter `domain='real'` (cf. `RealChart._init_coordinates`), so the user must actually do `var('x y z', domain='real')`, which is not very intuitive. \n\nHow about something like `M.var('x y z')` then?",
    "created_at": "2021-07-03T01:18:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512982",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:29" align="right">comment:29</div>

Replying to [@egourgoulhon](#comment:26):
> Replying to [@mkoeppe](#comment:22):
> I think there is little point in trying to provide better syntax for creating the variables than asking the user to do `var('x, y, z')` before creating a chart with coordinate restrictions.
> 
> The issue here is that on real manifolds (by far the most used ones), the symbolic variables are created with the extra parameter `domain='real'` (cf. `RealChart._init_coordinates`), so the user must actually do `var('x y z', domain='real')`, which is not very intuitive. 

How about something like `M.var('x y z')` then?



---

archive/issue_comments_512983.json:
```json
{
    "body": "Changed dependencies from **#31688** to **#31688, #32102**",
    "created_at": "2021-07-03T01:19:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512983",
    "user": "https://github.com/mkoeppe"
}
```

Changed dependencies from **#31688** to **#31688, #32102**



---

archive/issue_comments_512984.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nReplying to [@mkoeppe](#comment:28):\n> \n> A follow-up question on this:\n> \n> ```\n> sage: M = Manifold(2, 'M', structure='topological')\n> ....: U = M.open_subset('U')\n> ....: V = M.open_subset('V')\n> sage: XU = U.chart(names=(\"x\", \"y\"))\n> sage: XV = V.chart(names=(\"x\", \"y\"))\n> sage: M.atlas()\n> [Chart (U, (x, y)), Chart (V, (x, y))]\n> sage: M.top_charts()\n> [Chart (U, (x, y))]\n> ```\n> Clearly something went wrong here. \n\nGood catch!\n\n> Should there have been a declaration of something on `M` regarding the intention to declare charts with the coordinate pair `(x,y)` on subsets?\n\nNo, the above is actually a bug in `Chart.__init__`. I've opened #32112 for it and submitted a fix there.",
    "created_at": "2021-07-03T14:53:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512984",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:31" align="right">comment:31</div>

Replying to [@mkoeppe](#comment:28):
> 
> A follow-up question on this:
> 
> ```
> sage: M = Manifold(2, 'M', structure='topological')
> ....: U = M.open_subset('U')
> ....: V = M.open_subset('V')
> sage: XU = U.chart(names=("x", "y"))
> sage: XV = V.chart(names=("x", "y"))
> sage: M.atlas()
> [Chart (U, (x, y)), Chart (V, (x, y))]
> sage: M.top_charts()
> [Chart (U, (x, y))]
> ```
> Clearly something went wrong here. 

Good catch!

> Should there have been a declaration of something on `M` regarding the intention to declare charts with the coordinate pair `(x,y)` on subsets?

No, the above is actually a bug in `Chart.__init__`. I've opened #32112 for it and submitted a fix there.



---

archive/issue_comments_512985.json:
```json
{
    "body": "Changed commit from **[`96e1fbf`](https://github.com/sagemath/sagetrac-mirror/commit/96e1fbf0e91282303a7996a3e33788a8e9dd5daa)** to **[`d2e3ff7`](https://github.com/sagemath/sagetrac-mirror/commit/d2e3ff79b13cec3ff8a20218c4bb4a2bdbc47fc4)**",
    "created_at": "2021-07-03T18:25:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512985",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`96e1fbf`](https://github.com/sagemath/sagetrac-mirror/commit/96e1fbf0e91282303a7996a3e33788a8e9dd5daa)** to **[`d2e3ff7`](https://github.com/sagemath/sagetrac-mirror/commit/d2e3ff79b13cec3ff8a20218c4bb4a2bdbc47fc4)**



---

archive/issue_comments_512986.json:
```json
{
    "body": "<div id=\"comment:32\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4e316e9f4e3e714192568594197afb34cfd8121f\"><code>4e316e9</code></a></td><td><code>Fix bug in Chart.__init__ regarding the determination of top charts (Trac #32112)</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d2e3ff79b13cec3ff8a20218c4bb4a2bdbc47fc4\"><code>d2e3ff7</code></a></td><td><code>Merge #32112</code></td></tr></table>\n",
    "created_at": "2021-07-03T18:25:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512986",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:32"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4e316e9f4e3e714192568594197afb34cfd8121f"><code>4e316e9</code></a></td><td><code>Fix bug in Chart.__init__ regarding the determination of top charts (Trac #32112)</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d2e3ff79b13cec3ff8a20218c4bb4a2bdbc47fc4"><code>d2e3ff7</code></a></td><td><code>Merge #32112</code></td></tr></table>




---

archive/issue_comments_512987.json:
```json
{
    "body": "Changed dependencies from **#31688, #32102** to **#31688, #32112, #32102**",
    "created_at": "2021-07-03T18:25:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512987",
    "user": "https://github.com/mkoeppe"
}
```

Changed dependencies from **#31688, #32102** to **#31688, #32112, #32102**



---

archive/issue_comments_512988.json:
```json
{
    "body": "Changed commit from **[`d2e3ff7`](https://github.com/sagemath/sagetrac-mirror/commit/d2e3ff79b13cec3ff8a20218c4bb4a2bdbc47fc4)** to **[`a328e91`](https://github.com/sagemath/sagetrac-mirror/commit/a328e9199ae63de7976d2ccf4951a2172083ffbf)**",
    "created_at": "2021-07-03T18:30:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512988",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`d2e3ff7`](https://github.com/sagemath/sagetrac-mirror/commit/d2e3ff79b13cec3ff8a20218c4bb4a2bdbc47fc4)** to **[`a328e91`](https://github.com/sagemath/sagetrac-mirror/commit/a328e9199ae63de7976d2ccf4951a2172083ffbf)**



---

archive/issue_comments_512989.json:
```json
{
    "body": "<div id=\"comment:34\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a328e9199ae63de7976d2ccf4951a2172083ffbf\"><code>a328e91</code></a></td><td><code>Merge #32112</code></td></tr></table>\n",
    "created_at": "2021-07-03T18:30:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512989",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:34"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a328e9199ae63de7976d2ccf4951a2172083ffbf"><code>a328e91</code></a></td><td><code>Merge #32112</code></td></tr></table>




---

archive/issue_comments_512990.json:
```json
{
    "body": "Work Issues: **redo without mutability on top of #32102**",
    "created_at": "2021-07-03T20:05:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512990",
    "user": "https://github.com/mkoeppe"
}
```

Work Issues: **redo without mutability on top of #32102**



---

archive/issue_comments_512991.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nReplying to [@egourgoulhon](#comment:21):\n> > creating a `RealChart` puts global assumptions on the variables of the chart. So creating a subchart will affect simplification of expressions that relate to computation on the original chart.\n\n> \n> The assumptions should not be global but chart-wise. \n\nI've opened #32120 (Chart-wise assumptions) for this.",
    "created_at": "2021-07-04T00:03:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512991",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:36" align="right">comment:36</div>

Replying to [@egourgoulhon](#comment:21):
> > creating a `RealChart` puts global assumptions on the variables of the chart. So creating a subchart will affect simplification of expressions that relate to computation on the original chart.

> 
> The assumptions should not be global but chart-wise. 

I've opened #32120 (Chart-wise assumptions) for this.



---

archive/issue_comments_512992.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nReplying to [@egourgoulhon](#comment:27):\n> Replying to [@mkoeppe](#comment:23):\n> > The tricky bit is when two charts are involved with overlapping variables. Then some renaming may have to be done first. \n\n> \n> I don't see why: two computations on two distinct charts can set different assumptions on the same variable. There is no ambiguity as long as assumptions are tied to charts.  \n\nI was thinking of computations with coordinate changes here, which involve two charts simultaneously.",
    "created_at": "2021-07-04T00:04:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512992",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:37" align="right">comment:37</div>

Replying to [@egourgoulhon](#comment:27):
> Replying to [@mkoeppe](#comment:23):
> > The tricky bit is when two charts are involved with overlapping variables. Then some renaming may have to be done first. 

> 
> I don't see why: two computations on two distinct charts can set different assumptions on the same variable. There is no ambiguity as long as assumptions are tied to charts.  

I was thinking of computations with coordinate changes here, which involve two charts simultaneously.



---

archive/issue_comments_512993.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nReplying to [@egourgoulhon](#comment:21):\n> A connected question is how to pass these chart-based assumptions to SymPy, in case the latter has been chosen as the default symbolic backend on the manifold (via `M.set_calculus_method('sympy')`) or on a given chart `X` (via `X.calculus_method().set('sympy')`). For the time being, calculus with SymPy is possible but the assumptions are not taken into account on the SymPy side...\n\nWe already have a meta-ticket for this, #31958 (Use the SymPy assumptions facility). I was surprised that SymPy's assumptions are not really well connected to SymPy's sets (for which I have been building some glue code in #31926).",
    "created_at": "2021-07-04T00:07:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512993",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:38" align="right">comment:38</div>

Replying to [@egourgoulhon](#comment:21):
> A connected question is how to pass these chart-based assumptions to SymPy, in case the latter has been chosen as the default symbolic backend on the manifold (via `M.set_calculus_method('sympy')`) or on a given chart `X` (via `X.calculus_method().set('sympy')`). For the time being, calculus with SymPy is possible but the assumptions are not taken into account on the SymPy side...

We already have a meta-ticket for this, #31958 (Use the SymPy assumptions facility). I was surprised that SymPy's assumptions are not really well connected to SymPy's sets (for which I have been building some glue code in #31926).



---

archive/issue_events_436666.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-04T00:11:28Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31901#event-436666"
}
```



---

archive/issue_events_436667.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-04T00:11:28Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "label": "https://github.com/sagemath/sage/labels/wishlist%20item",
    "label_color": "e81ff9",
    "label_name": "wishlist item",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31901#event-436667"
}
```



---

archive/issue_comments_512994.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nGiven that #32102 is making mutability unnecessary, it seems we can keep `UniqueRepresentation` for charts for now (until we see another reason to drop it - such as unbounded memory) and pickle through that.\n\nI'm setting the ticket to \"sage-wishlist\" for this reason.",
    "created_at": "2021-07-04T00:11:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512994",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:39" align="right">comment:39</div>

Given that #32102 is making mutability unnecessary, it seems we can keep `UniqueRepresentation` for charts for now (until we see another reason to drop it - such as unbounded memory) and pickle through that.

I'm setting the ticket to "sage-wishlist" for this reason.



---

archive/issue_comments_512995.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nReplying to [@mkoeppe](#comment:37):\n> Replying to [@egourgoulhon](#comment:27):\n> > Replying to [@mkoeppe](#comment:23):\n> > > The tricky bit is when two charts are involved with overlapping variables. Then some renaming may have to be done first. \n\n> > \n> > I don't see why: two computations on two distinct charts can set different assumptions on the same variable. There is no ambiguity as long as assumptions are tied to charts.  \n\n> \n> I was thinking of computations with coordinate changes here, which involve two charts simultaneously.\n\nThere should not by any issue with coordinate changes: a coordinate change `X1 --> X2` involves only a set of chart functions based on `X1` (stored as a `MultiCoordFunction` in the attribute `CoordChange._transf`). So only assumptions relative to `X1` will be invoked in calculus involving the coordinate change `X1 --> X2` (such as the Jacobian matrix). An exception is the\ncomputation of the inverse in `CoordChange.inverse`. There only assumptions on `X2` should matter. However, if `X1` and `X2` share the same variables, the inverse is trivial. To summarize, I don't think there is a case where both sets of assumptions are required simultaneously in coordinate changes.",
    "created_at": "2021-07-04T16:09:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512995",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:40" align="right">comment:40</div>

Replying to [@mkoeppe](#comment:37):
> Replying to [@egourgoulhon](#comment:27):
> > Replying to [@mkoeppe](#comment:23):
> > > The tricky bit is when two charts are involved with overlapping variables. Then some renaming may have to be done first. 

> > 
> > I don't see why: two computations on two distinct charts can set different assumptions on the same variable. There is no ambiguity as long as assumptions are tied to charts.  

> 
> I was thinking of computations with coordinate changes here, which involve two charts simultaneously.

There should not by any issue with coordinate changes: a coordinate change `X1 --> X2` involves only a set of chart functions based on `X1` (stored as a `MultiCoordFunction` in the attribute `CoordChange._transf`). So only assumptions relative to `X1` will be invoked in calculus involving the coordinate change `X1 --> X2` (such as the Jacobian matrix). An exception is the
computation of the inverse in `CoordChange.inverse`. There only assumptions on `X2` should matter. However, if `X1` and `X2` share the same variables, the inverse is trivial. To summarize, I don't think there is a case where both sets of assumptions are required simultaneously in coordinate changes.



---

archive/issue_comments_512996.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\nThanks for the explanation, that's good news.",
    "created_at": "2021-07-04T16:21:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512996",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:41" align="right">comment:41</div>

Thanks for the explanation, that's good news.



---

archive/issue_comments_512997.json:
```json
{
    "body": "Changed commit from **[`a328e91`](https://github.com/sagemath/sagetrac-mirror/commit/a328e9199ae63de7976d2ccf4951a2172083ffbf)** to **[`30a5d0b`](https://github.com/sagemath/sagetrac-mirror/commit/30a5d0ba21f277044eebe7dfe6e3b463bcd0c5c5)**",
    "created_at": "2021-07-12T20:46:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512997",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`a328e91`](https://github.com/sagemath/sagetrac-mirror/commit/a328e9199ae63de7976d2ccf4951a2172083ffbf)** to **[`30a5d0b`](https://github.com/sagemath/sagetrac-mirror/commit/30a5d0ba21f277044eebe7dfe6e3b463bcd0c5c5)**



---

archive/issue_comments_512998.json:
```json
{
    "body": "<div id=\"comment:42\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bf62543e71954a3ad3acecd4a3089692a4eea9f5\"><code>bf62543</code></a></td><td><code>Merge branch 't/32089/conditionset__conditionset_callable_symbolic_expression' into t/32009/eliminate_direct_use_of_the_chart__domain_attribute</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2f47485e84ed7cd921cf008c3fe7e067f08d963b\"><code>2f47485</code></a></td><td><code>Merge #32009</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/21297f385dc82a71d3b28ee43aa75b684189718e\"><code>21297f3</code></a></td><td><code>Merge #32009</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/deace8334e03bb4f722c5fa50787da723567be03\"><code>deace83</code></a></td><td><code>Chart: Replace _init_coordinates by _parse_coordinates</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4db499543d24006d4ea3b87c956baa5f0bee03a7\"><code>4db4995</code></a></td><td><code>Chart: Fix up `__classcall__` and _parse_coordinates by avoiding unhashable things</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/fc59c9d6d46faeefd12626ab9946631de2608424\"><code>fc59c9d</code></a></td><td><code>Chart.__classcall__: Add doctest</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1742fdccd1e491fa6c15b18acf9990178a8495c0\"><code>1742fdc</code></a></td><td><code>Merge #32009</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9ac183438b80e55d6d994d61f5d92a7c5e056026\"><code>9ac1834</code></a></td><td><code>src/sage/manifolds/chart.py: Add raw string marker</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d7f9d17c608fd461b3361b4e9a3a482230d8f8d9\"><code>d7f9d17</code></a></td><td><code>Merge #32116</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/30a5d0ba21f277044eebe7dfe6e3b463bcd0c5c5\"><code>30a5d0b</code></a></td><td><code>Chart: WIP getstate/setstate, no UniqueRepresentation</code></td></tr></table>\n",
    "created_at": "2021-07-12T20:46:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512998",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:42"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bf62543e71954a3ad3acecd4a3089692a4eea9f5"><code>bf62543</code></a></td><td><code>Merge branch 't/32089/conditionset__conditionset_callable_symbolic_expression' into t/32009/eliminate_direct_use_of_the_chart__domain_attribute</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2f47485e84ed7cd921cf008c3fe7e067f08d963b"><code>2f47485</code></a></td><td><code>Merge #32009</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/21297f385dc82a71d3b28ee43aa75b684189718e"><code>21297f3</code></a></td><td><code>Merge #32009</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/deace8334e03bb4f722c5fa50787da723567be03"><code>deace83</code></a></td><td><code>Chart: Replace _init_coordinates by _parse_coordinates</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4db499543d24006d4ea3b87c956baa5f0bee03a7"><code>4db4995</code></a></td><td><code>Chart: Fix up `__classcall__` and _parse_coordinates by avoiding unhashable things</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/fc59c9d6d46faeefd12626ab9946631de2608424"><code>fc59c9d</code></a></td><td><code>Chart.__classcall__: Add doctest</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1742fdccd1e491fa6c15b18acf9990178a8495c0"><code>1742fdc</code></a></td><td><code>Merge #32009</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9ac183438b80e55d6d994d61f5d92a7c5e056026"><code>9ac1834</code></a></td><td><code>src/sage/manifolds/chart.py: Add raw string marker</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d7f9d17c608fd461b3361b4e9a3a482230d8f8d9"><code>d7f9d17</code></a></td><td><code>Merge #32116</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/30a5d0ba21f277044eebe7dfe6e3b463bcd0c5c5"><code>30a5d0b</code></a></td><td><code>Chart: WIP getstate/setstate, no UniqueRepresentation</code></td></tr></table>




---

archive/issue_comments_512999.json:
```json
{
    "body": "Changed dependencies from **#31688, #32112, #32102** to **#31894**",
    "created_at": "2021-07-13T00:24:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-512999",
    "user": "https://github.com/mkoeppe"
}
```

Changed dependencies from **#31688, #32112, #32102** to **#31894**



---

archive/issue_events_436668.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-13T00:24:18Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "title_is": "Chart: Implement pickling via __getstate__/__setstate__",
    "title_was": "Chart: No longer use UniqueRepresentation; implement __getstate__/__setstate__",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31901#event-436668"
}
```



---

archive/issue_comments_513000.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,8 +1,2 @@\n-Because of the method `add_restrictions` (which changes `self` by adding codomain restrictions), `Chart` needs to be considered as a mutable class. The current pickling based on `UniqueRepresentation` therefore cannot work correctly. \n+In this ticket, we implement the pickling protocol using `__getstate__` and `__setstate__`\n \n-In this ticket,\n-- we implement the pickling protocol using `__getstate__` and `__setstate__`\n-- we implement the mutability protocol\n-\n-This is also preparation for #31894.\n-\n``````\n",
    "created_at": "2021-07-13T00:24:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-513000",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,8 +1,2 @@
-Because of the method `add_restrictions` (which changes `self` by adding codomain restrictions), `Chart` needs to be considered as a mutable class. The current pickling based on `UniqueRepresentation` therefore cannot work correctly. 
+In this ticket, we implement the pickling protocol using `__getstate__` and `__setstate__`
 
-In this ticket,
-- we implement the pickling protocol using `__getstate__` and `__setstate__`
-- we implement the mutability protocol
-
-This is also preparation for #31894.
-
``````




---

archive/issue_comments_513001.json:
```json
{
    "body": "Changed work issues from **redo without mutability on top of #32102** to **redo on top of #31894**",
    "created_at": "2021-07-13T00:24:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31901#issuecomment-513001",
    "user": "https://github.com/mkoeppe"
}
```

Changed work issues from **redo without mutability on top of #32102** to **redo on top of #31894**
