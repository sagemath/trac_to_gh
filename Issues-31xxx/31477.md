# Issue 31477: Error in pynac's numeric::gcd method

archive/issues_031240.json:
```json
{
    "body": "Functions in pynac expect the `gcd` of two rational numbers `p` and `q` to be the largest number `d`, such that `p/d` and `q/d` are integers (except that `gcd(0,0) = 0`). But pynac's `numeric::gcd` method says that `gcd(p,1) = 1` for all `p`, which does not have to be true when `p` is not an integer.\n\nRelated ticket: #24880\n\nKeywords: gcd, pynac\n\nBranch: [public/31477](https://github.com/sagemath/sagetrac-mirror/tree/public/31477)\n\nCommit: [77bf8ced66673b76ca9a28cfa9c55d8b0f55a58b](https://github.com/sagemath/sagetrac-mirror/commit/77bf8ced66673b76ca9a28cfa9c55d8b0f55a58b)\n\nAuthor: Dave Morris\n\nStatus: needs_work\n\nIssue created by migration from https://trac.sagemath.org/ticket/31477\n\n",
    "created_at": "2021-03-10T06:19:09Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Error in pynac's numeric::gcd method",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31477",
    "user": "https://github.com/DaveWitteMorris"
}
```
Functions in pynac expect the `gcd` of two rational numbers `p` and `q` to be the largest number `d`, such that `p/d` and `q/d` are integers (except that `gcd(0,0) = 0`). But pynac's `numeric::gcd` method says that `gcd(p,1) = 1` for all `p`, which does not have to be true when `p` is not an integer.

Related ticket: #24880

Keywords: gcd, pynac

Branch: [public/31477](https://github.com/sagemath/sagetrac-mirror/tree/public/31477)

Commit: [77bf8ced66673b76ca9a28cfa9c55d8b0f55a58b](https://github.com/sagemath/sagetrac-mirror/commit/77bf8ced66673b76ca9a28cfa9c55d8b0f55a58b)

Author: Dave Morris

Status: needs_work

Issue created by migration from https://trac.sagemath.org/ticket/31477





---

archive/issue_comments_625781.json:
```json
{
    "body": "Changing branch from \"\" to \"public/31477\"",
    "created_at": "2021-03-10T06:21:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31477",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31477#issuecomment-625781",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing branch from "" to "public/31477"



---

archive/issue_comments_625782.json:
```json
{
    "body": "<a id='comment:2'></a>\nThis is part of metaticket #31478.\n\n---\nNew commits:\n|                                                                                                                                          |                               |\n|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------|\n|[bf1ab79](https://github.com/sagemath/sagetrac-mirror/commit/bf1ab79e7a0bfb758d55ad0a9bdbd35ac400c39d)|`trac 31477 fix pynac gcd(p,1)`|",
    "created_at": "2021-03-10T06:44:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31477",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31477#issuecomment-625782",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:2'></a>
This is part of metaticket #31478.

---
New commits:
|                                                                                                                                          |                               |
|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------|
|[bf1ab79](https://github.com/sagemath/sagetrac-mirror/commit/bf1ab79e7a0bfb758d55ad0a9bdbd35ac400c39d)|`trac 31477 fix pynac gcd(p,1)`|



---

archive/issue_comments_625783.json:
```json
{
    "body": "Changing commit from \"\" to \"bf1ab79e7a0bfb758d55ad0a9bdbd35ac400c39d\"",
    "created_at": "2021-03-10T06:44:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31477",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31477#issuecomment-625783",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing commit from "" to "bf1ab79e7a0bfb758d55ad0a9bdbd35ac400c39d"



---

archive/issue_comments_625784.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-03-10T06:44:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31477",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31477#issuecomment-625784",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_625785.json:
```json
{
    "body": "<a id='comment:3'></a>\nWouldn't it make sense to check that if `a.is_one()` you return the denominator of `b` (and vice versa) so you don't completely loose the special case optimizations?",
    "created_at": "2021-04-19T00:53:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31477",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31477#issuecomment-625785",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:3'></a>
Wouldn't it make sense to check that if `a.is_one()` you return the denominator of `b` (and vice versa) so you don't completely loose the special case optimizations?



---

archive/issue_comments_625786.json:
```json
{
    "body": "<a id='comment:4'></a>\nMoving to 9.4, as 9.3 has been released.",
    "created_at": "2021-05-10T17:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31477",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31477#issuecomment-625786",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>
Moving to 9.4, as 9.3 has been released.



---

archive/issue_events_093041.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-05-10T17:42:09Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31477",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31477#event-93041"
}
```



---

archive/issue_comments_625787.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-06-28T04:39:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31477",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31477#issuecomment-625787",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_625788.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [tscrim](#comment%3A3):\n> Wouldn't it make sense to check that if `a.is_one()` you return the denominator of `b` (and vice versa) so you don't completely loose the special case optimizations?\n\n\nThat seems reasonable, but needs some thought, because it will change the value of the function in some cases. Without the change you suggest, I think `1.gcd(b)` will return `1` whenever `b` is a `PyObject` (such as a complex number), even if the denominator of `b` is not `1` (for example, if `b` is a rational multiple of `I`). \n\nI think your change is probably correct (so the rest of the `numeric::gcd` code should be modified to match this), but this should be verified by looking at the uses of the `gcd` function to see what behaviour is expected.\n\nRelated ticket: #31884.\n\nPS. Once the correct behaviour has been implemented, the description of the `gcd(const numeric &a, const numeric &b)` function (in this same file) should be corrected. It currently says \"return  The GCD of two numbers if both are integer, a numerical 1 if they are not.\"",
    "created_at": "2021-06-28T04:39:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31477",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31477#issuecomment-625788",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:5'></a>
Replying to [tscrim](#comment%3A3):
> Wouldn't it make sense to check that if `a.is_one()` you return the denominator of `b` (and vice versa) so you don't completely loose the special case optimizations?


That seems reasonable, but needs some thought, because it will change the value of the function in some cases. Without the change you suggest, I think `1.gcd(b)` will return `1` whenever `b` is a `PyObject` (such as a complex number), even if the denominator of `b` is not `1` (for example, if `b` is a rational multiple of `I`). 

I think your change is probably correct (so the rest of the `numeric::gcd` code should be modified to match this), but this should be verified by looking at the uses of the `gcd` function to see what behaviour is expected.

Related ticket: #31884.

PS. Once the correct behaviour has been implemented, the description of the `gcd(const numeric &a, const numeric &b)` function (in this same file) should be corrected. It currently says "return  The GCD of two numbers if both are integer, a numerical 1 if they are not."



---

archive/issue_comments_625789.json:
```json
{
    "body": "<a id='comment:6'></a>\nWith #32386, the new patch can just be applied to the merged-in sources",
    "created_at": "2021-08-16T22:06:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31477",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31477#issuecomment-625789",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>
With #32386, the new patch can just be applied to the merged-in sources



---

archive/issue_events_093042.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-22T20:35:10Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31477",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31477#event-93042"
}
```



---

archive/issue_events_093043.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-22T20:35:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31477",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31477#event-93043"
}
```



---

archive/issue_comments_625790.json:
```json
{
    "body": "<a id='comment:8'></a>\n... by doing `(cd src/sage/symbolic && patch -p1) < build/pkgs/pynac/patches/gcd1.patch`",
    "created_at": "2021-09-04T01:22:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31477",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31477#issuecomment-625790",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>
... by doing `(cd src/sage/symbolic && patch -p1) < build/pkgs/pynac/patches/gcd1.patch`



---

archive/issue_comments_625791.json:
```json
{
    "body": "Changing commit from \"bf1ab79e7a0bfb758d55ad0a9bdbd35ac400c39d\" to \"77bf8ced66673b76ca9a28cfa9c55d8b0f55a58b\"",
    "created_at": "2021-09-26T17:57:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31477",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31477#issuecomment-625791",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "bf1ab79e7a0bfb758d55ad0a9bdbd35ac400c39d" to "77bf8ced66673b76ca9a28cfa9c55d8b0f55a58b"



---

archive/issue_comments_625792.json:
```json
{
    "body": "<a id='comment:9'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                           |                    |\n|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------|\n|[77bf8ce](https://github.com/sagemath/sagetrac-mirror/commit/77bf8ced66673b76ca9a28cfa9c55d8b0f55a58b)|`fix pynac gcd(p,1)`|",
    "created_at": "2021-09-26T17:57:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31477",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31477#issuecomment-625792",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                           |                    |
|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------|
|[77bf8ce](https://github.com/sagemath/sagetrac-mirror/commit/77bf8ced66673b76ca9a28cfa9c55d8b0f55a58b)|`fix pynac gcd(p,1)`|



---

archive/issue_comments_625793.json:
```json
{
    "body": "<a id='comment:10'></a>\n9.5.beta2 has merged #32386, so I have applied your patch as indicated in[comment:8](#comment%3A8)",
    "created_at": "2021-09-26T17:58:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31477",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31477#issuecomment-625793",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'></a>
9.5.beta2 has merged #32386, so I have applied your patch as indicated in[comment:8](#comment%3A8)



---

archive/issue_events_093044.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-21T17:38:37Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31477",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31477#event-93044"
}
```



---

archive/issue_events_093045.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-21T17:38:37Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31477",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31477#event-93045"
}
```



---

archive/issue_events_093046.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:19:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31477",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31477#event-93046"
}
```



---

archive/issue_events_093047.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:19:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31477",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31477#event-93047"
}
```



---

archive/issue_events_093048.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31477",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31477#event-93048"
}
```



---

archive/issue_events_093049.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31477",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31477#event-93049"
}
```
