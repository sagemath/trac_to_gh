# Issue 31921: Knotinfo db interface looks for the wrong python module

archive/issues_031684.json:
```json
{
    "assignees": [],
    "body": "Ticket #30352 included a new optional database and its interface in sage. As all new optional package of this kind, whether to use it or not is detected at runtime by the feature framework.\n\nIn #30352 presence was implemented by looking if the sage interface python module is installed. Which is always true since this interface is shipped in the standard sagelib. Instead it should have searched for the module installed by the `database_knotinfo` package itself.\n\nFurthermore, it sets user writable cache under `SAGE_SHARE` which is a system location for any system wide installation of sage. \n\nThe problem is not clearly visible in vanilla sage as there are no direct consequence for a private user installation. But for system installation or distro installation which are sandboxed, there are consequences as sage will try to create files in system location.\nSee https://github.com/cschwan/sage-on-gentoo/issues/639 for example.\n\nCC:  @soehms @tscrim @antonio-rojas\n\nBranch: **[`9907095`](https://github.com/sagemath/sagetrac-mirror/commit/99070951e1888e5a0bafd19cd1d88215536b67e3)**\n\nReviewer: **Sebastian Oehms**\n\nAuthor: **Fran\u00e7ois Bissey**\n\nComponent: **packages: optional**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/31921_\n\n",
    "closed_at": "2021-06-19T20:58:49Z",
    "created_at": "2021-06-07T03:55:18Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20packages%3A%20optional",
        "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.4",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Knotinfo db interface looks for the wrong python module",
    "type": "issue",
    "updated_at": "2021-07-02T16:37:37Z",
    "url": "https://github.com/sagemath/sage/issues/31921",
    "user": "https://github.com/kiwifb"
}
```
Ticket #30352 included a new optional database and its interface in sage. As all new optional package of this kind, whether to use it or not is detected at runtime by the feature framework.

In #30352 presence was implemented by looking if the sage interface python module is installed. Which is always true since this interface is shipped in the standard sagelib. Instead it should have searched for the module installed by the `database_knotinfo` package itself.

Furthermore, it sets user writable cache under `SAGE_SHARE` which is a system location for any system wide installation of sage. 

The problem is not clearly visible in vanilla sage as there are no direct consequence for a private user installation. But for system installation or distro installation which are sandboxed, there are consequences as sage will try to create files in system location.
See https://github.com/cschwan/sage-on-gentoo/issues/639 for example.

CC:  @soehms @tscrim @antonio-rojas

Branch: **[`9907095`](https://github.com/sagemath/sagetrac-mirror/commit/99070951e1888e5a0bafd19cd1d88215536b67e3)**

Reviewer: **Sebastian Oehms**

Author: **François Bissey**

Component: **packages: optional**

_Issue created by migration from https://trac.sagemath.org/ticket/31921_





---

archive/issue_events_442290.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2021-06-07T03:55:18Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31921#event-442290"
}
```



---

archive/issue_events_442291.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2021-06-07T03:55:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20packages%3A%20optional",
    "label_color": "000080",
    "label_name": "c: packages: optional",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31921#event-442291"
}
```



---

archive/issue_events_442292.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2021-06-07T03:55:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "label": "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p: 1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31921#event-442292"
}
```



---

archive/issue_events_442293.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2021-06-07T03:55:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31921#event-442293"
}
```



---

archive/issue_comments_513362.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nAttach branch with patch currently tested in sage-on-gentoo. That allows documentation to be built, I am currently running doctests. The next test would be to make sure it behaves properly with the knotinfo package installed.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7fe6cf9eba3c30bc6157ce3de897eb2f6363cb26\"><code>7fe6cf9</code></a></td><td><code>Replace PythonModule feature by StaticFile feature.</code></td></tr></table>\n",
    "created_at": "2021-06-07T04:05:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31921#issuecomment-513362",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:2" align="right">comment:2</div>

Attach branch with patch currently tested in sage-on-gentoo. That allows documentation to be built, I am currently running doctests. The next test would be to make sure it behaves properly with the knotinfo package installed.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7fe6cf9eba3c30bc6157ce3de897eb2f6363cb26"><code>7fe6cf9</code></a></td><td><code>Replace PythonModule feature by StaticFile feature.</code></td></tr></table>




---

archive/issue_comments_513363.json:
```json
{
    "body": "Branch: **[u/fbissey/knotinfo_feature](https://github.com/sagemath/sagetrac-mirror/tree/u/fbissey/knotinfo_feature)**",
    "created_at": "2021-06-07T04:05:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31921#issuecomment-513363",
    "user": "https://github.com/kiwifb"
}
```

Branch: **[u/fbissey/knotinfo_feature](https://github.com/sagemath/sagetrac-mirror/tree/u/fbissey/knotinfo_feature)**



---

archive/issue_events_442294.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2021-06-07T04:05:59Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31921#event-442294"
}
```



---

archive/issue_comments_513364.json:
```json
{
    "body": "Author: **Fran\u00e7ois Bissey**",
    "created_at": "2021-06-07T04:05:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31921#issuecomment-513364",
    "user": "https://github.com/kiwifb"
}
```

Author: **François Bissey**



---

archive/issue_comments_513365.json:
```json
{
    "body": "Commit: **[`7fe6cf9`](https://github.com/sagemath/sagetrac-mirror/commit/7fe6cf9eba3c30bc6157ce3de897eb2f6363cb26)**",
    "created_at": "2021-06-07T04:05:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31921#issuecomment-513365",
    "user": "https://github.com/kiwifb"
}
```

Commit: **[`7fe6cf9`](https://github.com/sagemath/sagetrac-mirror/commit/7fe6cf9eba3c30bc6157ce3de897eb2f6363cb26)**



---

archive/issue_comments_513366.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nThis is not the right fix. The database is provided by a Python package so it should be looked up via import machinery.\n\nJust change:\n{{{ #!diff\n- PythonModule.__init__(self, 'sage.knots.knotinfo', spkg='database_knotinfo',)\n+ PythonModule.__init__(self, 'database_knotinfo', spkg='database_knotinfo')\n}}}\n\nand set `self._sobj_path` to something like `database_knotinfo.__file__`",
    "created_at": "2021-06-07T04:19:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31921#issuecomment-513366",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:3" align="right">comment:3</div>

This is not the right fix. The database is provided by a Python package so it should be looked up via import machinery.

Just change:
{{{ #!diff
- PythonModule.__init__(self, 'sage.knots.knotinfo', spkg='database_knotinfo',)
+ PythonModule.__init__(self, 'database_knotinfo', spkg='database_knotinfo')
}}}

and set `self._sobj_path` to something like `database_knotinfo.__file__`



---

archive/issue_comments_513367.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nReplying to [@mkoeppe](#comment:3):\n> This is not the right fix. The database is provided by a Python package so it should be looked up via import machinery.\n> \n> Just change:\n> {{{ #!diff\n> - PythonModule.__init__(self, 'sage.knots.knotinfo', spkg='database_knotinfo',)\n> + PythonModule.__init__(self, 'database_knotinfo', spkg='database_knotinfo')\n> }}}\n> \n\nI understand, the wrong python module was looked up. Of course you cannot know that without installing the package or reading the ticket very, very, carefully.\n\nI will put up a corrected branch later today.",
    "created_at": "2021-06-07T04:32:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31921#issuecomment-513367",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:4" align="right">comment:4</div>

Replying to [@mkoeppe](#comment:3):
> This is not the right fix. The database is provided by a Python package so it should be looked up via import machinery.
> 
> Just change:
> {{{ #!diff
> - PythonModule.__init__(self, 'sage.knots.knotinfo', spkg='database_knotinfo',)
> + PythonModule.__init__(self, 'database_knotinfo', spkg='database_knotinfo')
> }}}
> 

I understand, the wrong python module was looked up. Of course you cannot know that without installing the package or reading the ticket very, very, carefully.

I will put up a corrected branch later today.



---

archive/issue_comments_513368.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nReplying to [@mkoeppe](#comment:3):\n> and set `self._sobj_path` to something like `database_knotinfo.__file__`\n\nPython detail, do you need to import `database_knotinfo` before being able to query that path?",
    "created_at": "2021-06-07T04:37:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31921#issuecomment-513368",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:5" align="right">comment:5</div>

Replying to [@mkoeppe](#comment:3):
> and set `self._sobj_path` to something like `database_knotinfo.__file__`

Python detail, do you need to import `database_knotinfo` before being able to query that path?



---

archive/issue_comments_513369.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nyes, it needs to be imported",
    "created_at": "2021-06-07T05:00:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31921#issuecomment-513369",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:6" align="right">comment:6</div>

yes, it needs to be imported



---

archive/issue_comments_513370.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nHum, I have to package this to make sure I understand, but it looks to me that the current location of `_sobj_path` and what you suggest to do with `.__file__` will be a quite different location. One should go under `site-packages` while the other will be under `share`.",
    "created_at": "2021-06-07T05:07:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31921#issuecomment-513370",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:7" align="right">comment:7</div>

Hum, I have to package this to make sure I understand, but it looks to me that the current location of `_sobj_path` and what you suggest to do with `.__file__` will be a quite different location. One should go under `site-packages` while the other will be under `share`.



---

archive/issue_comments_513371.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nOK, the `_sobj_path` is actually something else. It is a location of a cache that is created from the csv files distributed in the Python package. It's probably best to move this to a different location that is writable by users (somewhere in ~/.sage?)",
    "created_at": "2021-06-07T05:26:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31921#issuecomment-513371",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:8" align="right">comment:8</div>

OK, the `_sobj_path` is actually something else. It is a location of a cache that is created from the csv files distributed in the Python package. It's probably best to move this to a different location that is writable by users (somewhere in ~/.sage?)



---

archive/issue_comments_513372.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nReplying to [@mkoeppe](#comment:8):\n> OK, the `_sobj_path` is actually something else. It is a location of a cache that is created from the csv files distributed in the Python package. It's probably best to move this to a different location that is writable by users (somewhere in ~/.sage?)\n\nUnder `~/.sage` should be the default for that kind of things yes. Should we put it in its own subfolder? I don't think it is necessary, as there seems to be only one object.",
    "created_at": "2021-06-07T06:09:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31921#issuecomment-513372",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:9" align="right">comment:9</div>

Replying to [@mkoeppe](#comment:8):
> OK, the `_sobj_path` is actually something else. It is a location of a cache that is created from the csv files distributed in the Python package. It's probably best to move this to a different location that is writable by users (somewhere in ~/.sage?)

Under `~/.sage` should be the default for that kind of things yes. Should we put it in its own subfolder? I don't think it is necessary, as there seems to be only one object.



---

archive/issue_comments_513373.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nReplying to [@kiwifb](#comment:9):\n> Replying to [@mkoeppe](#comment:8):\n> > OK, the `_sobj_path` is actually something else. It is a location of a cache that is created from the csv files distributed in the Python package. It's probably best to move this to a different location that is writable by users (somewhere in ~/.sage?)\n\n> \n> Under `~/.sage` should be the default for that kind of things yes. Should we put it in its own subfolder? I don't think it is necessary, as there seems to be only one object.\n\nThere are more files, so that should be a separate folder.\n\nSorry for causing this trouble. I already had `SAGE_DB` (`.sage/db`) in mind instead of `SAGE_SHARE` when I did the last change in #30352. But since everything worked fine for me I let it as is.\n\nI can do the tests but maybe not today!",
    "created_at": "2021-06-07T06:50:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31921#issuecomment-513373",
    "user": "https://github.com/soehms"
}
```

<div id="comment:11" align="right">comment:11</div>

Replying to [@kiwifb](#comment:9):
> Replying to [@mkoeppe](#comment:8):
> > OK, the `_sobj_path` is actually something else. It is a location of a cache that is created from the csv files distributed in the Python package. It's probably best to move this to a different location that is writable by users (somewhere in ~/.sage?)

> 
> Under `~/.sage` should be the default for that kind of things yes. Should we put it in its own subfolder? I don't think it is necessary, as there seems to be only one object.

There are more files, so that should be a separate folder.

Sorry for causing this trouble. I already had `SAGE_DB` (`.sage/db`) in mind instead of `SAGE_SHARE` when I did the last change in #30352. But since everything worked fine for me I let it as is.

I can do the tests but maybe not today!



---

archive/issue_comments_513374.json:
```json
{
    "body": "Changed commit from **[`7fe6cf9`](https://github.com/sagemath/sagetrac-mirror/commit/7fe6cf9eba3c30bc6157ce3de897eb2f6363cb26)** to **[`0091a4e`](https://github.com/sagemath/sagetrac-mirror/commit/0091a4e879a1c10e7eb0feb4f0408337ab7ad04f)**",
    "created_at": "2021-06-07T07:18:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31921#issuecomment-513374",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`7fe6cf9`](https://github.com/sagemath/sagetrac-mirror/commit/7fe6cf9eba3c30bc6157ce3de897eb2f6363cb26)** to **[`0091a4e`](https://github.com/sagemath/sagetrac-mirror/commit/0091a4e879a1c10e7eb0feb4f0408337ab7ad04f)**



---

archive/issue_comments_513375.json:
```json
{
    "body": "<div id=\"comment:12\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0091a4e879a1c10e7eb0feb4f0408337ab7ad04f\"><code>0091a4e</code></a></td><td><code>Use PythonModule, but this time the right one</code></td></tr></table>\n",
    "created_at": "2021-06-07T07:18:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31921#issuecomment-513375",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:12"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0091a4e879a1c10e7eb0feb4f0408337ab7ad04f"><code>0091a4e</code></a></td><td><code>Use PythonModule, but this time the right one</code></td></tr></table>




---

archive/issue_events_442295.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2021-06-07T07:22:48Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31921#event-442295"
}
```



---

archive/issue_events_442296.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2021-06-07T07:22:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31921#event-442296"
}
```



---

archive/issue_comments_513376.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nI am now understanding my confusion in full. All the other databases test for `StaticFile` and there was a file defined there in a \"system location\".\n\nI'll add that since it is a user location, it doesn't really belongs to `feature`. Ideally, it would be defined in the package `database_knotinfo` itself. Let's find a location in sage for it for now, but we should keep it in mind next time the package is upgraded.",
    "created_at": "2021-06-07T07:22:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31921#issuecomment-513376",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:13" align="right">comment:13</div>

I am now understanding my confusion in full. All the other databases test for `StaticFile` and there was a file defined there in a "system location".

I'll add that since it is a user location, it doesn't really belongs to `feature`. Ideally, it would be defined in the package `database_knotinfo` itself. Let's find a location in sage for it for now, but we should keep it in mind next time the package is upgraded.



---

archive/issue_comments_513377.json:
```json
{
    "body": "<div id=\"comment:14\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/99070951e1888e5a0bafd19cd1d88215536b67e3\"><code>9907095</code></a></td><td><code>Define _sobj_path in knotinfo_db.py itself</code></td></tr></table>\n",
    "created_at": "2021-06-07T07:29:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31921#issuecomment-513377",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:14"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/99070951e1888e5a0bafd19cd1d88215536b67e3"><code>9907095</code></a></td><td><code>Define _sobj_path in knotinfo_db.py itself</code></td></tr></table>




---

archive/issue_comments_513378.json:
```json
{
    "body": "Changed commit from **[`0091a4e`](https://github.com/sagemath/sagetrac-mirror/commit/0091a4e879a1c10e7eb0feb4f0408337ab7ad04f)** to **[`9907095`](https://github.com/sagemath/sagetrac-mirror/commit/99070951e1888e5a0bafd19cd1d88215536b67e3)**",
    "created_at": "2021-06-07T07:29:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31921#issuecomment-513378",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`0091a4e`](https://github.com/sagemath/sagetrac-mirror/commit/0091a4e879a1c10e7eb0feb4f0408337ab7ad04f)** to **[`9907095`](https://github.com/sagemath/sagetrac-mirror/commit/99070951e1888e5a0bafd19cd1d88215536b67e3)**



---

archive/issue_comments_513379.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nNeed to rewrite the description but it should be a testable state now.",
    "created_at": "2021-06-07T07:30:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31921#issuecomment-513379",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:15" align="right">comment:15</div>

Need to rewrite the description but it should be a testable state now.



---

archive/issue_events_442297.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2021-06-07T08:47:24Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31921#event-442297"
}
```



---

archive/issue_events_442298.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2021-06-07T08:47:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31921#event-442298"
}
```



---

archive/issue_comments_513380.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,8 @@\n Ticket #30352 included a new optional database and its interface in sage. As all new optional package of this kind, whether to use it or not is detected at runtime by the feature framework.\n \n-In #30352 presence was implemented by looking if the sage interface python module is installed. Which is always true since this interface is shipped in the standard sagelib. Instead it should have detected whether the database file was present.\n+In #30352 presence was implemented by looking if the sage interface python module is installed. Which is always true since this interface is shipped in the standard sagelib. Instead it should have searched for the module installed by the `database_knotinfo` package itself.\n \n-The problem is not clearly visible in vanilla sage as there are no direct consequence for a private user installation. But for system installation or distro installation which are sandboxed there are consequences as sage will try to create files in system location.\n+Furthermore, it sets user writable cache under `SAGE_SHARE` which is a system location for any system wide installation of sage. \n+\n+The problem is not clearly visible in vanilla sage as there are no direct consequence for a private user installation. But for system installation or distro installation which are sandboxed, there are consequences as sage will try to create files in system location.\n See https://github.com/cschwan/sage-on-gentoo/issues/639 for example.\n``````\n",
    "created_at": "2021-06-07T08:47:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31921#issuecomment-513380",
    "user": "https://github.com/kiwifb"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,8 @@
 Ticket #30352 included a new optional database and its interface in sage. As all new optional package of this kind, whether to use it or not is detected at runtime by the feature framework.
 
-In #30352 presence was implemented by looking if the sage interface python module is installed. Which is always true since this interface is shipped in the standard sagelib. Instead it should have detected whether the database file was present.
+In #30352 presence was implemented by looking if the sage interface python module is installed. Which is always true since this interface is shipped in the standard sagelib. Instead it should have searched for the module installed by the `database_knotinfo` package itself.
 
-The problem is not clearly visible in vanilla sage as there are no direct consequence for a private user installation. But for system installation or distro installation which are sandboxed there are consequences as sage will try to create files in system location.
+Furthermore, it sets user writable cache under `SAGE_SHARE` which is a system location for any system wide installation of sage. 
+
+The problem is not clearly visible in vanilla sage as there are no direct consequence for a private user installation. But for system installation or distro installation which are sandboxed, there are consequences as sage will try to create files in system location.
 See https://github.com/cschwan/sage-on-gentoo/issues/639 for example.
``````




---

archive/issue_events_442299.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2021-06-07T08:50:18Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "title_is": "Knotinfo db interface looks for the wrong python module",
    "title_was": "The knotinfo db should use the StaticFile feature, not PythonModule",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31921#event-442299"
}
```



---

archive/issue_events_442300.json:
```json
{
    "actor": "https://github.com/soehms",
    "created_at": "2021-06-07T16:56:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31921#event-442300"
}
```



---

archive/issue_events_442301.json:
```json
{
    "actor": "https://github.com/soehms",
    "created_at": "2021-06-07T16:56:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31921#event-442301"
}
```



---

archive/issue_comments_513381.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nThe patch looks good to me!\n\nAnother question: It seems that we have a new feature within our doctests, right now, which produces the following failure (independent on this branch):\n\n```bash\nsage -t --random-seed=0 src/sage/databases/knotinfo_db.py\n    [90 tests, 0.06 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 0.2 seconds\n    cpu time: 0.0 seconds\n    cumulative wall time: 0.1 seconds\n================================================================================================================================== test session starts ===================================================================================================================================\nplatform linux -- Python 3.9.2, pytest-6.2.4, py-1.10.0, pluggy-0.13.1\nrootdir: /home/sebastian/devel/sage/src, configfile: tox.ini\ncollected 0 items / 1 error\n\n========================================================================================================================================= ERRORS =========================================================================================================================================\n_____________________________________________________________________________________________________________________ ERROR collecting sage/databases/knotinfo_db.py _____________________________________________________________________________________________________________________\nsrc/sage/databases/knotinfo_db.py:330: in <module>\n    class KnotInfoDataBase(SageObject, UniqueRepresentation):\nsage/misc/nested_class.pyx:318: in sage.misc.nested_class.NestedClassMetaclass.__init__ (build/cythonized/sage/misc/nested_class.c:2327)\n    ???\nE   KeyError: 'knotinfo_db'\n================================================================================================================================ short test summary info =================================================================================================================================\nERROR src/sage/databases/knotinfo_db.py - KeyError: 'knotinfo_db'\n!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 1 error during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n==================================================================================================================================== 1 error in 0.73s ====================================================================================================================================\n```\n\nWhat is the reason for this? How can I fix it? Any hints are welcome!",
    "created_at": "2021-06-07T16:56:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31921#issuecomment-513381",
    "user": "https://github.com/soehms"
}
```

<div id="comment:18" align="right">comment:18</div>

The patch looks good to me!

Another question: It seems that we have a new feature within our doctests, right now, which produces the following failure (independent on this branch):

```bash
sage -t --random-seed=0 src/sage/databases/knotinfo_db.py
    [90 tests, 0.06 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 0.2 seconds
    cpu time: 0.0 seconds
    cumulative wall time: 0.1 seconds
================================================================================================================================== test session starts ===================================================================================================================================
platform linux -- Python 3.9.2, pytest-6.2.4, py-1.10.0, pluggy-0.13.1
rootdir: /home/sebastian/devel/sage/src, configfile: tox.ini
collected 0 items / 1 error

========================================================================================================================================= ERRORS =========================================================================================================================================
_____________________________________________________________________________________________________________________ ERROR collecting sage/databases/knotinfo_db.py _____________________________________________________________________________________________________________________
src/sage/databases/knotinfo_db.py:330: in <module>
    class KnotInfoDataBase(SageObject, UniqueRepresentation):
sage/misc/nested_class.pyx:318: in sage.misc.nested_class.NestedClassMetaclass.__init__ (build/cythonized/sage/misc/nested_class.c:2327)
    ???
E   KeyError: 'knotinfo_db'
================================================================================================================================ short test summary info =================================================================================================================================
ERROR src/sage/databases/knotinfo_db.py - KeyError: 'knotinfo_db'
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 1 error during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
==================================================================================================================================== 1 error in 0.73s ====================================================================================================================================
```

What is the reason for this? How can I fix it? Any hints are welcome!



---

archive/issue_comments_513382.json:
```json
{
    "body": "Reviewer: **Sebastian Oehms**",
    "created_at": "2021-06-07T16:56:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31921#issuecomment-513382",
    "user": "https://github.com/soehms"
}
```

Reviewer: **Sebastian Oehms**



---

archive/issue_comments_513383.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nI also see this error after installing `pytest`.",
    "created_at": "2021-06-07T17:49:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31921#issuecomment-513383",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:19" align="right">comment:19</div>

I also see this error after installing `pytest`.



---

archive/issue_comments_513384.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nThis defect is not specific to `knotinfo_db`; we will address it in #31924 (sage -t: Do not run pytest on individual files)",
    "created_at": "2021-06-07T18:08:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31921#issuecomment-513384",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:20" align="right">comment:20</div>

This defect is not specific to `knotinfo_db`; we will address it in #31924 (sage -t: Do not run pytest on individual files)



---

archive/issue_comments_513385.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nReplying to [@mkoeppe](#comment:20):\n> This defect is not specific to `knotinfo_db`; we will address it in #31924 (sage -t: Do not run pytest on individual files)\n\nMany Thanks!",
    "created_at": "2021-06-07T22:07:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31921#issuecomment-513385",
    "user": "https://github.com/soehms"
}
```

<div id="comment:21" align="right">comment:21</div>

Replying to [@mkoeppe](#comment:20):
> This defect is not specific to `knotinfo_db`; we will address it in #31924 (sage -t: Do not run pytest on individual files)

Many Thanks!



---

archive/issue_comments_513386.json:
```json
{
    "body": "Changed branch from **[u/fbissey/knotinfo_feature](https://github.com/sagemath/sagetrac-mirror/tree/u/fbissey/knotinfo_feature)** to **[`9907095`](https://github.com/sagemath/sagetrac-mirror/commit/99070951e1888e5a0bafd19cd1d88215536b67e3)**",
    "created_at": "2021-06-19T20:58:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31921#issuecomment-513386",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/fbissey/knotinfo_feature](https://github.com/sagemath/sagetrac-mirror/tree/u/fbissey/knotinfo_feature)** to **[`9907095`](https://github.com/sagemath/sagetrac-mirror/commit/99070951e1888e5a0bafd19cd1d88215536b67e3)**



---

archive/issue_events_442302.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-06-19T20:58:49Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31921#event-442302"
}
```



---

archive/issue_events_442303.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "eb0eeb3621fc0119053ffd84e2f69d3fa7fbfa9f",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2021-06-19T20:58:49Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31921#event-442303"
}
```



---

archive/issue_comments_513387.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nThere is another piece of code that should be adapted to the change of file-cache location. I've opened ticket #32099 for that!",
    "created_at": "2021-07-02T16:37:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31921#issuecomment-513387",
    "user": "https://github.com/soehms"
}
```

<div id="comment:23" align="right">comment:23</div>

There is another piece of code that should be adapted to the change of file-cache location. I've opened ticket #32099 for that!



---

archive/issue_comments_513388.json:
```json
{
    "body": "Changed commit from **[`9907095`](https://github.com/sagemath/sagetrac-mirror/commit/99070951e1888e5a0bafd19cd1d88215536b67e3)** to none",
    "created_at": "2021-07-02T16:37:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31921#issuecomment-513388",
    "user": "https://github.com/soehms"
}
```

Changed commit from **[`9907095`](https://github.com/sagemath/sagetrac-mirror/commit/99070951e1888e5a0bafd19cd1d88215536b67e3)** to none
