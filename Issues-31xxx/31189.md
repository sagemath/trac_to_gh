# Issue 31189: Apply flat shading when plotting 3d polyhedra with Three.js

archive/issues_031189.json:
```json
{
    "body": "CC:  @egourgoulhon @jcamp0x2a @laisrast @guenterrote @paulmasson @slel\n\nKeywords: threejs, flat shading, polyhedra\n\nWe should ensure flat shading is the default\nwhen plotting 3d polyhedra with Three.js.\n\nIn this example, only the middle cube (at the origin)\nhas flat shading and looks correct:\n\n```\nsage: cc = [(0, 0, 0), (-1.125, 1.125, 0), (1.125, -1.125, 0)]\nsage: cubes = sum(cube(c) for c in cc)\nsage: cubes.show(frame=False)\n```\n\n![](polyhedron-flat-shading.png\u200b)\n\nThe special case of Platonic solids (as purely graphics objects)\nwas done in #27836.\n\nIn this ticket we do the following:\n* We fix a bug in `plot3d.platonic`:\n  When translating such a platonic solid,\n  the default behavior of flat shading is ignored\n  as shown in the previous example.\n  We fix that.\n\n* We set flat shading to be the default behavior\n  for plots of `geometry.polyhedron`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31426\n\n",
    "closed_at": "2022-03-08T08:12:17Z",
    "created_at": "2021-02-22T14:57:18Z",
    "labels": [
        "component: graphics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "Apply flat shading when plotting 3d polyhedra with Three.js",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31189",
    "user": "https://github.com/slel"
}
```
CC:  @egourgoulhon @jcamp0x2a @laisrast @guenterrote @paulmasson @slel

Keywords: threejs, flat shading, polyhedra

We should ensure flat shading is the default
when plotting 3d polyhedra with Three.js.

In this example, only the middle cube (at the origin)
has flat shading and looks correct:

```
sage: cc = [(0, 0, 0), (-1.125, 1.125, 0), (1.125, -1.125, 0)]
sage: cubes = sum(cube(c) for c in cc)
sage: cubes.show(frame=False)
```

![](polyhedron-flat-shading.pngâ€‹)

The special case of Platonic solids (as purely graphics objects)
was done in #27836.

In this ticket we do the following:
* We fix a bug in `plot3d.platonic`:
  When translating such a platonic solid,
  the default behavior of flat shading is ignored
  as shown in the previous example.
  We fix that.

* We set flat shading to be the default behavior
  for plots of `geometry.polyhedron`.

Issue created by migration from https://trac.sagemath.org/ticket/31426





---

archive/issue_comments_445349.json:
```json
{
    "body": "Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-03-24T02:04:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31189",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31189#issuecomment-445349",
    "user": "https://github.com/mkoeppe"
}
```

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_events_082428.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-24T02:04:25Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31189",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31189#event-82428"
}
```



---

archive/issue_events_082429.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T01:16:42Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31189",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31189#event-82429"
}
```



---

archive/issue_events_082430.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T01:16:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31189",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31189#event-82430"
}
```



---

archive/issue_comments_445350.json:
```json
{
    "body": "I thought changing the `plot` method\nin `src/sage/geometry/polyhedron/base.py`\nto set `threejs_flat_shading` to `True`\nfor the case of 3d polyhedra would do the trick.\n\nI tried this change without success:\n\n```diff\ndiff --git a/src/sage/geometry/polyhedron/base.py b/src/sage/geometry/polyhedron/base.py\nindex 843fe204cb..918ce178c9 100644\n--- a/src/sage/geometry/polyhedron/base.py\n+++ b/src/sage/geometry/polyhedron/base.py\n@@ -815,6 +815,7 @@ class Polyhedron_base(Element):\n              wireframe='blue', fill='green',\n              position=None,\n              orthonormal=True,  # whether to use orthonormal projections\n+             threejs_flat_shading=True,  # flat shading for threejs plotting\n              **kwds):\n         \"\"\"\n         Return a graphical representation.\n@@ -847,6 +848,9 @@ class Polyhedron_base(Element):\n         - ``orthonormal`` -- Boolean (default: True); whether to use\n           orthonormal projections.\n\n+        - ``threejs_flat_shading`` -- boolean (default: True);\n+          whether to apply flat shading when plotting with Three.js\n+\n         - ``**kwds`` -- optional keyword parameters that are passed to\n           all graphics objects.\n```\n\nIdeas anyone?",
    "created_at": "2021-10-27T16:39:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31189",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31189#issuecomment-445350",
    "user": "https://github.com/slel"
}
```

I thought changing the `plot` method
in `src/sage/geometry/polyhedron/base.py`
to set `threejs_flat_shading` to `True`
for the case of 3d polyhedra would do the trick.

I tried this change without success:

```diff
diff --git a/src/sage/geometry/polyhedron/base.py b/src/sage/geometry/polyhedron/base.py
index 843fe204cb..918ce178c9 100644
--- a/src/sage/geometry/polyhedron/base.py
+++ b/src/sage/geometry/polyhedron/base.py
@@ -815,6 +815,7 @@ class Polyhedron_base(Element):
              wireframe='blue', fill='green',
              position=None,
              orthonormal=True,  # whether to use orthonormal projections
+             threejs_flat_shading=True,  # flat shading for threejs plotting
              **kwds):
         """
         Return a graphical representation.
@@ -847,6 +848,9 @@ class Polyhedron_base(Element):
         - ``orthonormal`` -- Boolean (default: True); whether to use
           orthonormal projections.

+        - ``threejs_flat_shading`` -- boolean (default: True);
+          whether to apply flat shading when plotting with Three.js
+
         - ``**kwds`` -- optional keyword parameters that are passed to
           all graphics objects.
```

Ideas anyone?



---

archive/issue_comments_445351.json:
```json
{
    "body": "Attachment [polyhedron-flat-shading.png](tarball://root/attachments/some-uuid/ticket31426/polyhedron-flat-shading.png) by @slel created at 2021-10-27 16:43:48\n\nFlat shading wanted for polyhedra",
    "created_at": "2021-10-27T16:43:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31189",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31189#issuecomment-445351",
    "user": "https://github.com/slel"
}
```

Attachment [polyhedron-flat-shading.png](tarball://root/attachments/some-uuid/ticket31426/polyhedron-flat-shading.png) by @slel created at 2021-10-27 16:43:48

Flat shading wanted for polyhedra



---

archive/issue_comments_445352.json:
```json
{
    "body": "I think there are two different things here:\n\n* There is a bug in `plot3d.platonic`:\n  As your example shows, when changing the center in one of these Platonic solids, the plot does not respect the default `threejs_flat_shading=True`.\n  This is a bug which occurs in the function `prep`.\n  To fix it, the assignment `threejs_flat_shading=True` should be set before applying the translation.\n\n\n* For plots of `geometry.polyhedron`, one can set flat shading as follows:\n  {{{\n  sage: P = polytopes.cube()\n  sage: P.plot(polygon={\"threejs_flat_shading\": True})\n  }}}\n  I will set this as the default behavior.\n  However, I do not encourage putting `threejs_flat_shading` as a parameter of the function `plot`.\n  style-related parameters of `plot` should be passed through the parameters `point`, `line` and `polygon`.",
    "created_at": "2021-10-31T18:47:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31189",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31189#issuecomment-445352",
    "user": "https://github.com/LaisRast"
}
```

I think there are two different things here:

* There is a bug in `plot3d.platonic`:
  As your example shows, when changing the center in one of these Platonic solids, the plot does not respect the default `threejs_flat_shading=True`.
  This is a bug which occurs in the function `prep`.
  To fix it, the assignment `threejs_flat_shading=True` should be set before applying the translation.


* For plots of `geometry.polyhedron`, one can set flat shading as follows:
  {{{
  sage: P = polytopes.cube()
  sage: P.plot(polygon={"threejs_flat_shading": True})
  }}}
  I will set this as the default behavior.
  However, I do not encourage putting `threejs_flat_shading` as a parameter of the function `plot`.
  style-related parameters of `plot` should be passed through the parameters `point`, `line` and `polygon`.



---

archive/issue_comments_445353.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-31T18:48:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31189",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31189#issuecomment-445353",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_445354.json:
```json
{
    "body": "Fill in the author field with your full name\nand set to \"needs review\" if ready.",
    "created_at": "2021-11-18T23:06:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31189",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31189#issuecomment-445354",
    "user": "https://github.com/slel"
}
```

Fill in the author field with your full name
and set to "needs review" if ready.



---

archive/issue_comments_445355.json:
```json
{
    "body": "Changing keywords from \"\" to \"threejs, flat shading, polyhedra\".",
    "created_at": "2021-11-18T23:30:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31189",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31189#issuecomment-445355",
    "user": "https://github.com/LaisRast"
}
```

Changing keywords from "" to "threejs, flat shading, polyhedra".



---

archive/issue_comments_445356.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-11-18T23:30:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31189",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31189#issuecomment-445356",
    "user": "https://github.com/LaisRast"
}
```

Changing status from new to needs_review.



---

archive/issue_events_082431.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:53:12Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31189",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31189#event-82431"
}
```



---

archive/issue_events_082432.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:53:12Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31189",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31189#event-82432"
}
```



---

archive/issue_comments_445357.json:
```json
{
    "body": "Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.",
    "created_at": "2021-12-18T19:53:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31189",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31189#issuecomment-445357",
    "user": "https://github.com/mkoeppe"
}
```

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.



---

archive/issue_comments_445358.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-03-03T07:13:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31189",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31189#issuecomment-445358",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_445359.json:
```json
{
    "body": "These are nice improvements! Thanks for working on this.",
    "created_at": "2022-03-03T07:13:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31189",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31189#issuecomment-445359",
    "user": "https://github.com/mkoeppe"
}
```

These are nice improvements! Thanks for working on this.



---

archive/issue_events_082433.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-03-08T08:12:17Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31189",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31189#event-82433"
}
```



---

archive/issue_comments_445360.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-03-08T08:12:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31189",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31189#issuecomment-445360",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_445361.json:
```json
{
    "body": "It seems the wrong shading sometimes persists.\n\nJuanjo's answer to [Ask Sage question 63031](https://ask.sagemath.org/question/63031)\nseems to indicate the need for a follow-up.",
    "created_at": "2022-06-28T05:01:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31189",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31189#issuecomment-445361",
    "user": "https://github.com/slel"
}
```

It seems the wrong shading sometimes persists.

Juanjo's answer to [Ask Sage question 63031](https://ask.sagemath.org/question/63031)
seems to indicate the need for a follow-up.



---

archive/issue_comments_445362.json:
```json
{
    "body": "Replying to [comment:13 slelievre]:\n> It seems the wrong shading sometimes persists.\n> \n> Juanjo's answer to [Ask Sage question 63031](https://ask.sagemath.org/question/63031)\n> seems to indicate the need for a follow-up.\n\n\nThe situation is as follows:\n* When calling `cube()` with `frame_thickness > 0`,\n  the returned object is a `Graphics3dGroup` which contains two objects: a box and a frame.\n  Otherwise, only the box is returned.\n\n* To the returned object, the function `prep()` is applied,\n  which among other things, sets flat shading for the returned object.\n\n* When converting a `Graphics3dGroup` into json for threejs,\n  the dictionary `._extra_kwds` (in which flat shading is set) is ignored.\n  Only the `._extra_kwds`'s in the child objects are considered.\n\nI think the function `prep()` does not assume to get a `Graphics3dGroup`.\nThe only case when it receives one is the case above.\nThus, I suggest a workaround just for the `cube()` by applying the flat shading\non the box object at the beginning of `cube()`:\n\n```\n    if 'threejs_flat_shading' not in kwds: \n        kwds['threejs_flat_shading'] = True\n```\nThis `kwds` is passed to the box object.\n\nBy the way, the current implementations force the flat shading even if the user\nexplicitly says they do not want it. So\n`cube(threejs_flat_shading=False)`\nwill produce flat shading.",
    "created_at": "2022-06-29T22:14:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31189",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31189#issuecomment-445362",
    "user": "https://github.com/LaisRast"
}
```

Replying to [comment:13 slelievre]:
> It seems the wrong shading sometimes persists.
> 
> Juanjo's answer to [Ask Sage question 63031](https://ask.sagemath.org/question/63031)
> seems to indicate the need for a follow-up.


The situation is as follows:
* When calling `cube()` with `frame_thickness > 0`,
  the returned object is a `Graphics3dGroup` which contains two objects: a box and a frame.
  Otherwise, only the box is returned.

* To the returned object, the function `prep()` is applied,
  which among other things, sets flat shading for the returned object.

* When converting a `Graphics3dGroup` into json for threejs,
  the dictionary `._extra_kwds` (in which flat shading is set) is ignored.
  Only the `._extra_kwds`'s in the child objects are considered.

I think the function `prep()` does not assume to get a `Graphics3dGroup`.
The only case when it receives one is the case above.
Thus, I suggest a workaround just for the `cube()` by applying the flat shading
on the box object at the beginning of `cube()`:

```
    if 'threejs_flat_shading' not in kwds: 
        kwds['threejs_flat_shading'] = True
```
This `kwds` is passed to the box object.

By the way, the current implementations force the flat shading even if the user
explicitly says they do not want it. So
`cube(threejs_flat_shading=False)`
will produce flat shading.
