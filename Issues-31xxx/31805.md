# Issue 31805: some work on intervals in posets

archive/issues_031805.json:
```json
{
    "body": "CC:  @tscrim @slel\n\ntrying to disentangle the situation, a little bit\n\nadding more explanations\n\nadding some typing annotations in the modified file\n\nTo illustrate the various possible speeds:\nBefore:\n\n```\nsage: P = posets.TamariLattice(8)                                               \nsage: H = P._hasse_diagram                                                      \nsage: %timeit z = H.interval(55,1429)                                           \n21.6 ms \u00b1 326 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 10 loops each)\nsage: H._precompute_intervals()                                                 \nsage: %timeit z = H.interval(55,1429)                                           \n596 ns \u00b1 12.7 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\n```\n\n```\nsage: P = posets.TamariLattice(8)                                               \nsage: H = P._hasse_diagram                                                      \nsage: a = H._leq_storage                                                        \nsage: %timeit z = H.interval(55,1429)                                           \n381 \u00b5s \u00b1 1.68 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\n```\nAfter:\n\n```\nsage: P = posets.TamariLattice(8)                                               \nsage: H = P._hasse_diagram                                                      \nsage: %timeit z = H.interval(55,1429)                                           \n22.8 ms \u00b1 416 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 10 loops each)\nsage: H._precompute_intervals()                                                 \nsage: %timeit z = H.interval(55,1429)                                           \n579 ns \u00b1 2.24 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\nsage: %timeit z = list(H.interval_iterator(55,1429))                            \n21.3 ms \u00b1 233 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 10 loops each)\nsage: a = H._leq_storage                                                        \nsage: %timeit z = list(H.interval_iterator(55,1429))                            \n389 \u00b5s \u00b1 2.12 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/32042\n\n",
    "closed_at": "2021-07-06T21:29:20Z",
    "created_at": "2021-06-23T15:34:06Z",
    "labels": [
        "component: combinatorics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "some work on intervals in posets",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31805",
    "user": "https://github.com/fchapoton"
}
```
CC:  @tscrim @slel

trying to disentangle the situation, a little bit

adding more explanations

adding some typing annotations in the modified file

To illustrate the various possible speeds:
Before:

```
sage: P = posets.TamariLattice(8)                                               
sage: H = P._hasse_diagram                                                      
sage: %timeit z = H.interval(55,1429)                                           
21.6 ms ± 326 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
sage: H._precompute_intervals()                                                 
sage: %timeit z = H.interval(55,1429)                                           
596 ns ± 12.7 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
```

```
sage: P = posets.TamariLattice(8)                                               
sage: H = P._hasse_diagram                                                      
sage: a = H._leq_storage                                                        
sage: %timeit z = H.interval(55,1429)                                           
381 µs ± 1.68 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
```
After:

```
sage: P = posets.TamariLattice(8)                                               
sage: H = P._hasse_diagram                                                      
sage: %timeit z = H.interval(55,1429)                                           
22.8 ms ± 416 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
sage: H._precompute_intervals()                                                 
sage: %timeit z = H.interval(55,1429)                                           
579 ns ± 2.24 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: %timeit z = list(H.interval_iterator(55,1429))                            
21.3 ms ± 233 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
sage: a = H._leq_storage                                                        
sage: %timeit z = list(H.interval_iterator(55,1429))                            
389 µs ± 2.12 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
```

Issue created by migration from https://trac.sagemath.org/ticket/32042





---

archive/issue_comments_454016.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-06-23T15:37:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31805#issuecomment-454016",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_454017.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-06-23T15:37:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31805#issuecomment-454017",
    "user": "https://github.com/fchapoton"
}
```

New commits:



---

archive/issue_comments_454018.json:
```json
{
    "body": "bot is morally green, please review",
    "created_at": "2021-06-24T15:13:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31805#issuecomment-454018",
    "user": "https://github.com/fchapoton"
}
```

bot is morally green, please review



---

archive/issue_comments_454019.json:
```json
{
    "body": "How does this compare with the timings before? I am not sure if the list comprehension might be faster.\n\nI guess in terms of documentation, it is better to just have one method...",
    "created_at": "2021-06-25T02:13:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31805#issuecomment-454019",
    "user": "https://github.com/tscrim"
}
```

How does this compare with the timings before? I am not sure if the list comprehension might be faster.

I guess in terms of documentation, it is better to just have one method...



---

archive/issue_comments_454020.json:
```json
{
    "body": "I have added some timings in the description. It seems that we may lose something when not storing any information.\n\nThe situation is quite complicated. There are two different levels at which stored information can make the computations faster. The first level is just to store in \"_leq_storage\" lazy attribute all the principal upper ideals as sets. The second level is to store all intervals. Both are somewhat memory-intensive (especially the second one) and could use something like bitset to be more compact.\n\nThe call of \"_leq_storage\" is speeding all posets computations. The pre-computation of intervals is useful in some specific methods, about computing congruences.\n\nI have no ideal solution. Suggestions are welcome.",
    "created_at": "2021-06-27T08:27:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31805#issuecomment-454020",
    "user": "https://github.com/fchapoton"
}
```

I have added some timings in the description. It seems that we may lose something when not storing any information.

The situation is quite complicated. There are two different levels at which stored information can make the computations faster. The first level is just to store in "_leq_storage" lazy attribute all the principal upper ideals as sets. The second level is to store all intervals. Both are somewhat memory-intensive (especially the second one) and could use something like bitset to be more compact.

The call of "_leq_storage" is speeding all posets computations. The pre-computation of intervals is useful in some specific methods, about computing congruences.

I have no ideal solution. Suggestions are welcome.



---

archive/issue_comments_454021.json:
```json
{
    "body": "Since there doesn't seem to be too significant of a slowdown, I propose we go with the code that is more concise. Thank you.",
    "created_at": "2021-06-28T04:25:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31805#issuecomment-454021",
    "user": "https://github.com/tscrim"
}
```

Since there doesn't seem to be too significant of a slowdown, I propose we go with the code that is more concise. Thank you.



---

archive/issue_comments_454022.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-06-28T04:25:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31805#issuecomment-454022",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_454023.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-07-06T21:29:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31805#issuecomment-454023",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_084791.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-07-06T21:29:20Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31805",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31805#event-84791"
}
```
