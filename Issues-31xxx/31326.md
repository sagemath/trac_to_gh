# Issue 31326: macos-11.0: scipy build fails

archive/issues_031089.json:
```json
{
    "body": "(from #31227)\n\nAffected configurations (From \u200bhttps://groups.google.com/g/sage-release/c/KdSKg6RdZok/m/GXfB1rW1AgAJ)\n- local-macos (homebrew-macos, minimal, default, macos-11.0) \u200bhttps://github.com/mkoeppe/sage/runs/2103782309 -- Sage installs python3 from spkg\n- local-macos (conda-forge-macos, standard, default, macos-11.0) \u200bhttps://github.com/mkoeppe/sage/runs/2103782333 - uses python3 from conda\n- local-macos (homebrew-macos-python3_pythonorg, standard, default, macos-11.0) \u200bhttps://github.com/mkoeppe/sage/runs/2103782375 - uses somewhat dated python3 from python.org - \u200bhttps://www.python.org/ftp/python/3.7.7/python-3.7.7-macosx10.9.pkg\n- another failure report, for a configuration possibly similar to local-macos (homebrew-macos, minimal, default, macos-11.0) , in #30651:\n\n```\n      File \"/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.9/site-packages/numpy/distutils/ccompiler.py\", line 90, in <lambda>\n        m = lambda self, *args, **kw: func(self, *args, **kw)\n      File \"/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.9/site-packages/numpy/distutils/ccompiler.py\", line 657, in CCompiler_get_version\n        version = matcher(output)\n      File \"/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.9/site-packages/numpy/distutils/fcompiler/gnu.py\", line 278, in version_match\n        v = self.gnu_version_match(version_string)\n      File \"/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.9/site-packages/numpy/distutils/fcompiler/gnu.py\", line 80, in gnu_version_match\n        raise ValueError(err + version_string)\n    ValueError: A valid Fortran version was not found in this string:\n```\n\nsee also https://github.com/mkoeppe/sage/runs/2103782381\n\nCC:  @jhpalmieri @zlscherr @dimpase @kliem @isuruf\n\nBranch/Commit: [4cc8c4da3ab35999e0746c498105658a24a224c0](https://github.com/sagemath/sagetrac-mirror/commit/4cc8c4da3ab35999e0746c498105658a24a224c0)\n\nReviewer: Matthias Koeppe\n\nAuthor: Zachary Scherr\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/31326\n\n",
    "closed_at": "2021-03-23T23:49:36Z",
    "created_at": "2021-02-02T17:32:25Z",
    "labels": [
        "component: porting",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "macos-11.0: scipy build fails",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31326",
    "user": "https://github.com/mkoeppe"
}
```
(from #31227)

Affected configurations (From ​https://groups.google.com/g/sage-release/c/KdSKg6RdZok/m/GXfB1rW1AgAJ)
- local-macos (homebrew-macos, minimal, default, macos-11.0) ​https://github.com/mkoeppe/sage/runs/2103782309 -- Sage installs python3 from spkg
- local-macos (conda-forge-macos, standard, default, macos-11.0) ​https://github.com/mkoeppe/sage/runs/2103782333 - uses python3 from conda
- local-macos (homebrew-macos-python3_pythonorg, standard, default, macos-11.0) ​https://github.com/mkoeppe/sage/runs/2103782375 - uses somewhat dated python3 from python.org - ​https://www.python.org/ftp/python/3.7.7/python-3.7.7-macosx10.9.pkg
- another failure report, for a configuration possibly similar to local-macos (homebrew-macos, minimal, default, macos-11.0) , in #30651:

```
      File "/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.9/site-packages/numpy/distutils/ccompiler.py", line 90, in <lambda>
        m = lambda self, *args, **kw: func(self, *args, **kw)
      File "/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.9/site-packages/numpy/distutils/ccompiler.py", line 657, in CCompiler_get_version
        version = matcher(output)
      File "/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.9/site-packages/numpy/distutils/fcompiler/gnu.py", line 278, in version_match
        v = self.gnu_version_match(version_string)
      File "/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.9/site-packages/numpy/distutils/fcompiler/gnu.py", line 80, in gnu_version_match
        raise ValueError(err + version_string)
    ValueError: A valid Fortran version was not found in this string:
```

see also https://github.com/mkoeppe/sage/runs/2103782381

CC:  @jhpalmieri @zlscherr @dimpase @kliem @isuruf

Branch/Commit: [4cc8c4da3ab35999e0746c498105658a24a224c0](https://github.com/sagemath/sagetrac-mirror/commit/4cc8c4da3ab35999e0746c498105658a24a224c0)

Reviewer: Matthias Koeppe

Author: Zachary Scherr

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/31326





---

archive/issue_comments_622068.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,16 @@\n (from #31227)\n \n+another failure report, for a possibly similar configuration, in #30651:\n \n+```\n+      File \"/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.9/site-packages/numpy/distutils/ccompiler.py\", line 90, in <lambda>\n+        m = lambda self, *args, **kw: func(self, *args, **kw)\n+      File \"/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.9/site-packages/numpy/distutils/ccompiler.py\", line 657, in CCompiler_get_version\n+        version = matcher(output)\n+      File \"/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.9/site-packages/numpy/distutils/fcompiler/gnu.py\", line 278, in version_match\n+        v = self.gnu_version_match(version_string)\n+      File \"/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.9/site-packages/numpy/distutils/fcompiler/gnu.py\", line 80, in gnu_version_match\n+        raise ValueError(err + version_string)\n+    ValueError: A valid Fortran version was not found in this string:\n+```\n+\n``````\n",
    "created_at": "2021-03-07T22:21:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622068",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,16 @@
 (from #31227)
 
+another failure report, for a possibly similar configuration, in #30651:
 
+```
+      File "/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.9/site-packages/numpy/distutils/ccompiler.py", line 90, in <lambda>
+        m = lambda self, *args, **kw: func(self, *args, **kw)
+      File "/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.9/site-packages/numpy/distutils/ccompiler.py", line 657, in CCompiler_get_version
+        version = matcher(output)
+      File "/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.9/site-packages/numpy/distutils/fcompiler/gnu.py", line 278, in version_match
+        v = self.gnu_version_match(version_string)
+      File "/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.9/site-packages/numpy/distutils/fcompiler/gnu.py", line 80, in gnu_version_match
+        raise ValueError(err + version_string)
+    ValueError: A valid Fortran version was not found in this string:
+```
+
``````




---

archive/issue_comments_622069.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -14,3 +14,4 @@\n     ValueError: A valid Fortran version was not found in this string:\n ```\n \n+see also https://github.com/mkoeppe/sage/runs/2103782381\n``````\n",
    "created_at": "2021-03-14T23:40:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622069",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -14,3 +14,4 @@
     ValueError: A valid Fortran version was not found in this string:
 ```
 
+see also https://github.com/mkoeppe/sage/runs/2103782381
``````




---

archive/issue_comments_622070.json:
```json
{
    "body": "<a id='comment:3'></a>\nIt seems like `numpy.distutils` gets confused by extra whitespace in the result of `gfortran -dumpversion`. This might be related to the use of `zsh` as the shell. \n\nThis will need investigation by someone who has already made the switch to Big Sur...",
    "created_at": "2021-03-15T00:10:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622070",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'></a>
It seems like `numpy.distutils` gets confused by extra whitespace in the result of `gfortran -dumpversion`. This might be related to the use of `zsh` as the shell. 

This will need investigation by someone who has already made the switch to Big Sur...



---

archive/issue_comments_622071.json:
```json
{
    "body": "<a id='comment:4'></a>\njust want to point out that this problem exists on bash as well.  For anyone wanting to test you can, after configuring, do:\n\n\n```\nmake toolchain\nmake gfortran\nFC=\"local/bin/gfortran\" make numpy\n```\n\nto see the error.",
    "created_at": "2021-03-15T02:04:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622071",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:4'></a>
just want to point out that this problem exists on bash as well.  For anyone wanting to test you can, after configuring, do:


```
make toolchain
make gfortran
FC="local/bin/gfortran" make numpy
```

to see the error.



---

archive/issue_comments_622072.json:
```json
{
    "body": "<a id='comment:5'></a>\nI haven't tested the full homebrew-macos-11.0-xcode-minimal build, but I'm guessing it's related to MACOSX_DEPLOYMENT_TARGET.\n\nAs I noted above, I can recreate the error with numpy by using sage's gfortran 9.2.0 on my machine with homebrew.  As per usual I think this is because python was built with MACOSX_DEPLOYMENT_TARGET 11.0 and gfortran 9.2.0 can't recognize this value.\n\nNow I know that at some point scipy's spkg-install.in file was changed to contain the lines:\n\n\n```\nif [ $MACOSX_VERSION -ge 20 ]; then\n     export MACOSX_DEPLOYMENT_TARGET=11.0\nfi\n```\n\nI'm not exactly sure what is in homebrew-macos-11.0-xcode-minimal, but if sage is building its own gfortran and its own python using a different MACOSX_DEPLOYMENT_TARGET then I would guess that this line might be causing the problems.\n\nIt's been a while since I've thought about this problem, but it's possible that the above export might not be needed anymore since homebrew patched GCC.",
    "created_at": "2021-03-15T03:37:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622072",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:5'></a>
I haven't tested the full homebrew-macos-11.0-xcode-minimal build, but I'm guessing it's related to MACOSX_DEPLOYMENT_TARGET.

As I noted above, I can recreate the error with numpy by using sage's gfortran 9.2.0 on my machine with homebrew.  As per usual I think this is because python was built with MACOSX_DEPLOYMENT_TARGET 11.0 and gfortran 9.2.0 can't recognize this value.

Now I know that at some point scipy's spkg-install.in file was changed to contain the lines:


```
if [ $MACOSX_VERSION -ge 20 ]; then
     export MACOSX_DEPLOYMENT_TARGET=11.0
fi
```

I'm not exactly sure what is in homebrew-macos-11.0-xcode-minimal, but if sage is building its own gfortran and its own python using a different MACOSX_DEPLOYMENT_TARGET then I would guess that this line might be causing the problems.

It's been a while since I've thought about this problem, but it's possible that the above export might not be needed anymore since homebrew patched GCC.



---

archive/issue_comments_622073.json:
```json
{
    "body": "<a id='comment:6'></a>\nActually it probably shouldn't matter whether or not sage is building its own python.  gfortran 9.2.0 just can't recognize MACOSX_DEPLOYMENT_TARGET=11.0.",
    "created_at": "2021-03-15T03:39:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622073",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:6'></a>
Actually it probably shouldn't matter whether or not sage is building its own python.  gfortran 9.2.0 just can't recognize MACOSX_DEPLOYMENT_TARGET=11.0.



---

archive/issue_comments_622074.json:
```json
{
    "body": "<a id='comment:7'></a>\nSorry for the spam, but the ticket that introduced that if statement is #31183",
    "created_at": "2021-03-15T03:41:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622074",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:7'></a>
Sorry for the spam, but the ticket that introduced that if statement is #31183



---

archive/issue_comments_622075.json:
```json
{
    "body": "<a id='comment:8'></a>\nCould you check if the gcc upgrade in #29827 fixes this issue?",
    "created_at": "2021-03-15T03:43:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622075",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>
Could you check if the gcc upgrade in #29827 fixes this issue?



---

archive/issue_comments_622076.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [gh-zlscherr](#comment%3A5):\n> I'm not exactly sure what is in homebrew-macos-11.0-xcode-minimal, but if sage is building its own gfortran \n\n\nYes, that's right. This configuration uses a minimal installation of homebrew, plus the packages listed in `build/pkgs/_bootstrap/distros/homebrew.txt`, namely `gettext autoconf automake libtool pkg-config`",
    "created_at": "2021-03-15T03:46:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622076",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'></a>
Replying to [gh-zlscherr](#comment%3A5):
> I'm not exactly sure what is in homebrew-macos-11.0-xcode-minimal, but if sage is building its own gfortran 


Yes, that's right. This configuration uses a minimal installation of homebrew, plus the packages listed in `build/pkgs/_bootstrap/distros/homebrew.txt`, namely `gettext autoconf automake libtool pkg-config`



---

archive/issue_comments_622077.json:
```json
{
    "body": "<a id='comment:10'></a>\nI also just saw that the error reported on top is in numpy and not in scipy.  I'll take a look at #29827 when I get a chance, but I know that homebrew had to specifically patch GCC to avoid this sort of problem.  A viable solution might be to track the legacy option to see if sage is building its own Fortran, and if so we set MACOSX_DEPLOYMENT_TARGET to 10.something",
    "created_at": "2021-03-15T03:54:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622077",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:10'></a>
I also just saw that the error reported on top is in numpy and not in scipy.  I'll take a look at #29827 when I get a chance, but I know that homebrew had to specifically patch GCC to avoid this sort of problem.  A viable solution might be to track the legacy option to see if sage is building its own Fortran, and if so we set MACOSX_DEPLOYMENT_TARGET to 10.something



---

archive/issue_comments_622078.json:
```json
{
    "body": "<a id='comment:11'></a>\nNo, it's an error building scipy -- which uses numpy.distutils, which you see in the lines of the log",
    "created_at": "2021-03-15T03:56:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622078",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:11'></a>
No, it's an error building scipy -- which uses numpy.distutils, which you see in the lines of the log



---

archive/issue_comments_622079.json:
```json
{
    "body": "<a id='comment:12'></a>\nAh okay. Also, do you know if the homebrew minimal test uses system for python? That might be responsible for why the deployment Target is set to 11, whereas when sage builds it's own python the deployment Target is set lower.",
    "created_at": "2021-03-15T04:11:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622079",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:12'></a>
Ah okay. Also, do you know if the homebrew minimal test uses system for python? That might be responsible for why the deployment Target is set to 11, whereas when sage builds it's own python the deployment Target is set lower.



---

archive/issue_comments_622080.json:
```json
{
    "body": "<a id='comment:13'></a>\nFrom https://groups.google.com/g/sage-release/c/KdSKg6RdZok/m/GXfB1rW1AgAJ: Runs in which scipy fails to build:\n\n- local-macos (homebrew-macos, minimal, default, macos-11.0) https://github.com/mkoeppe/sage/runs/2103782309 -- Sage installs python3 from spkg\n\n- local-macos (conda-forge-macos, standard, default, macos-11.0) https://github.com/mkoeppe/sage/runs/2103782333 - uses python3 from conda\n\n- local-macos (homebrew-macos-python3_pythonorg, standard, default, macos-11.0) https://github.com/mkoeppe/sage/runs/2103782375 - uses somewhat dated python3 from python.org - https://www.python.org/ftp/python/3.7.7/python-3.7.7-macosx10.9.pkg",
    "created_at": "2021-03-15T04:18:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622080",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>
From https://groups.google.com/g/sage-release/c/KdSKg6RdZok/m/GXfB1rW1AgAJ: Runs in which scipy fails to build:

- local-macos (homebrew-macos, minimal, default, macos-11.0) https://github.com/mkoeppe/sage/runs/2103782309 -- Sage installs python3 from spkg

- local-macos (conda-forge-macos, standard, default, macos-11.0) https://github.com/mkoeppe/sage/runs/2103782333 - uses python3 from conda

- local-macos (homebrew-macos-python3_pythonorg, standard, default, macos-11.0) https://github.com/mkoeppe/sage/runs/2103782375 - uses somewhat dated python3 from python.org - https://www.python.org/ftp/python/3.7.7/python-3.7.7-macosx10.9.pkg



---

archive/issue_comments_622081.json:
```json
{
    "body": "<a id='comment:14'></a>\nFor what it's worth, if I do\n\n```\n% make distclean && ./configure --with-system-gfortran=no && make\n```\nthen the build fails on `numpy`, not `scipy`, but with the same sort of error:\n\n```\nValueError: A valid Fortran version was not found in this string:\n\n9.2.0\n```",
    "created_at": "2021-03-15T04:27:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622081",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:14'></a>
For what it's worth, if I do

```
% make distclean && ./configure --with-system-gfortran=no && make
```
then the build fails on `numpy`, not `scipy`, but with the same sort of error:

```
ValueError: A valid Fortran version was not found in this string:

9.2.0
```



---

archive/issue_comments_622082.json:
```json
{
    "body": "<a id='comment:15'></a>\nI think there are extra newlines in this version string, which confuses the numpy.distutils code",
    "created_at": "2021-03-15T04:35:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622082",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:15'></a>
I think there are extra newlines in this version string, which confuses the numpy.distutils code



---

archive/issue_comments_622083.json:
```json
{
    "body": "<a id='comment:16'></a>\nIt's actually worse than just extra newlines.  I tried manually patching to strip all whitespace from both ends, but that didn't solve the problem.  I dumped the contents of the version_string which is causing numpy to fail into a text file and it turned out to be\n\n\"gfortran: warning: couldn't understand version 11\n\n9.3.0\"\n\n(I tested with gcc 9.3, but the same happens with 9.2)\n\nI can get numpy and scipy to build by manually forcing MACOSX_DEPLOYMENT_TARGET to be 10.16 but it seems that 11 and 11.0 both cause problems.\n\nHere is a proposal for how to deal with this:\n\n1.  Remove the if statements from scipy's spkg-install to set MACOSX_DEPLOYMENT_TARGET to 11.0.  I don't think this is needed anymore since Homebrew patched GCC 10 but I can do some testing on that.\n\n2.  At some point in the build process we take a look at MACOSX_DEPLOYMENT_TARGET, which can be easily done with something like\n\n\n```\npython3 -c \"import sysconfig; print(sysconfig.get_config_var('MACOSX_DEPLOYMENT_TARGET'))\"\n```\n\nif we get back a value of 11 and yet the version of gfortran we are using is less than 10.2.0 then we change MACOSX_DEPLOYMENT_TARGET to 10.16 or something like that.",
    "created_at": "2021-03-16T02:16:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622083",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:16'></a>
It's actually worse than just extra newlines.  I tried manually patching to strip all whitespace from both ends, but that didn't solve the problem.  I dumped the contents of the version_string which is causing numpy to fail into a text file and it turned out to be

"gfortran: warning: couldn't understand version 11

9.3.0"

(I tested with gcc 9.3, but the same happens with 9.2)

I can get numpy and scipy to build by manually forcing MACOSX_DEPLOYMENT_TARGET to be 10.16 but it seems that 11 and 11.0 both cause problems.

Here is a proposal for how to deal with this:

1.  Remove the if statements from scipy's spkg-install to set MACOSX_DEPLOYMENT_TARGET to 11.0.  I don't think this is needed anymore since Homebrew patched GCC 10 but I can do some testing on that.

2.  At some point in the build process we take a look at MACOSX_DEPLOYMENT_TARGET, which can be easily done with something like


```
python3 -c "import sysconfig; print(sysconfig.get_config_var('MACOSX_DEPLOYMENT_TARGET'))"
```

if we get back a value of 11 and yet the version of gfortran we are using is less than 10.2.0 then we change MACOSX_DEPLOYMENT_TARGET to 10.16 or something like that.



---

archive/issue_comments_622084.json:
```json
{
    "body": "<a id='comment:17'></a>\nBut probably the second step is not necessary, it would only be needed if the user has python3 from Homebrew and yet gfortran from sage.  I think just fixing up scipy's spkg-install should fix everything.",
    "created_at": "2021-03-16T02:18:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622084",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:17'></a>
But probably the second step is not necessary, it would only be needed if the user has python3 from Homebrew and yet gfortran from sage.  I think just fixing up scipy's spkg-install should fix everything.



---

archive/issue_comments_622085.json:
```json
{
    "body": "Changing branch from \"\" to \"u/gh-zlscherr/revert_scipy_MACOSX_DEPLOYMENT_TARGET\"",
    "created_at": "2021-03-16T02:31:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622085",
    "user": "https://github.com/zlscherr"
}
```

Changing branch from "" to "u/gh-zlscherr/revert_scipy_MACOSX_DEPLOYMENT_TARGET"



---

archive/issue_comments_622086.json:
```json
{
    "body": "Changing commit from \"\" to \"4cc8c4da3ab35999e0746c498105658a24a224c0\"",
    "created_at": "2021-03-16T02:32:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622086",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "" to "4cc8c4da3ab35999e0746c498105658a24a224c0"



---

archive/issue_comments_622087.json:
```json
{
    "body": "<a id='comment:19'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                                             |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------|\n|[4cc8c4d](https://github.com/sagemath/sagetrac-mirror/commit/4cc8c4da3ab35999e0746c498105658a24a224c0)|`Reverted changes in scipy's spkg-install to unset MACOSX_DEPLOYMENT_TARGET to 11 on Big Sur`|",
    "created_at": "2021-03-16T02:32:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622087",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                                             |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------|
|[4cc8c4d](https://github.com/sagemath/sagetrac-mirror/commit/4cc8c4da3ab35999e0746c498105658a24a224c0)|`Reverted changes in scipy's spkg-install to unset MACOSX_DEPLOYMENT_TARGET to 11 on Big Sur`|



---

archive/issue_comments_622088.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-03-16T02:33:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622088",
    "user": "https://github.com/zlscherr"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_622089.json:
```json
{
    "body": "<a id='comment:21'></a>\nThanks for investigating! \n\nTo test this in various configurations, it would be enough to merge the branch of #31492 and then push a tag to your github fork of sage.",
    "created_at": "2021-03-16T02:33:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622089",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:21'></a>
Thanks for investigating! 

To test this in various configurations, it would be enough to merge the branch of #31492 and then push a tag to your github fork of sage.



---

archive/issue_comments_622090.json:
```json
{
    "body": "<a id='comment:22'></a>\nI think I did that correctly.  I'll report on what happens in the CI on my repo.",
    "created_at": "2021-03-16T02:45:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622090",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:22'></a>
I think I did that correctly.  I'll report on what happens in the CI on my repo.



---

archive/issue_comments_622091.json:
```json
{
    "body": "<a id='comment:23'></a>\nI'm not sure if there is something I need to do to get the CI working, but some of the homebrew's are already failing because of an error like:\n\ncurl: (35) LibreSSL SSL_connect: SSL_ERROR_SYSCALL in connection to homebrew.bintray.com:443\n\nIs there something I need to do to avoid this?",
    "created_at": "2021-03-16T03:23:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622091",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:23'></a>
I'm not sure if there is something I need to do to get the CI working, but some of the homebrew's are already failing because of an error like:

curl: (35) LibreSSL SSL_connect: SSL_ERROR_SYSCALL in connection to homebrew.bintray.com:443

Is there something I need to do to avoid this?



---

archive/issue_comments_622092.json:
```json
{
    "body": "<a id='comment:24'></a>\nThere are various ways how these CI runs can intermittently fail. It's nothing that we can fix on our side as far as I can tell. \n\nBy the way, if you want, you can remove the unnecessary runs (for linux, cygwin) by editing files in `.github/workflows/`. Also `max-parallel` can be edited so that more macOS jobs are run in parallel.",
    "created_at": "2021-03-16T03:34:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622092",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:24'></a>
There are various ways how these CI runs can intermittently fail. It's nothing that we can fix on our side as far as I can tell. 

By the way, if you want, you can remove the unnecessary runs (for linux, cygwin) by editing files in `.github/workflows/`. Also `max-parallel` can be edited so that more macOS jobs are run in parallel.



---

archive/issue_comments_622093.json:
```json
{
    "body": "<a id='comment:25'></a>\nReplying to [mkoeppe](#comment%3A13):\n> - local-macos (conda-forge-macos, standard, default, macos-11.0) https://github.com/mkoeppe/sage/runs/2103782333 - uses python3 from conda\n\n\n`@`isuruf: Also this build using conda-forge is affected",
    "created_at": "2021-03-16T07:01:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622093",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:25'></a>
Replying to [mkoeppe](#comment%3A13):
> - local-macos (conda-forge-macos, standard, default, macos-11.0) https://github.com/mkoeppe/sage/runs/2103782333 - uses python3 from conda


`@`isuruf: Also this build using conda-forge is affected



---

archive/issue_events_092368.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "rename": {
        "from": "homebrew-macos-11.0-xcode-minimal: scipy build fails",
        "to": "macos-11.0: scipy build fails"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31326#event-92368"
}
```



---

archive/issue_comments_622094.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,10 @@\n (from #31227)\n \n-another failure report, for a possibly similar configuration, in #30651:\n+Affected configurations (From \u200bhttps://groups.google.com/g/sage-release/c/KdSKg6RdZok/m/GXfB1rW1AgAJ)\n+- local-macos (homebrew-macos, minimal, default, macos-11.0) \u200bhttps://github.com/mkoeppe/sage/runs/2103782309 -- Sage installs python3 from spkg\n+- local-macos (conda-forge-macos, standard, default, macos-11.0) \u200bhttps://github.com/mkoeppe/sage/runs/2103782333 - uses python3 from conda\n+- local-macos (homebrew-macos-python3_pythonorg, standard, default, macos-11.0) \u200bhttps://github.com/mkoeppe/sage/runs/2103782375 - uses somewhat dated python3 from python.org - \u200bhttps://www.python.org/ftp/python/3.7.7/python-3.7.7-macosx10.9.pkg\n+- another failure report, for a configuration possibly similar to local-macos (homebrew-macos, minimal, default, macos-11.0) , in #30651:\n \n ```\n       File \"/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.9/site-packages/numpy/distutils/ccompiler.py\", line 90, in <lambda>\n``````\n",
    "created_at": "2021-03-16T20:30:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622094",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,10 @@
 (from #31227)
 
-another failure report, for a possibly similar configuration, in #30651:
+Affected configurations (From ​https://groups.google.com/g/sage-release/c/KdSKg6RdZok/m/GXfB1rW1AgAJ)
+- local-macos (homebrew-macos, minimal, default, macos-11.0) ​https://github.com/mkoeppe/sage/runs/2103782309 -- Sage installs python3 from spkg
+- local-macos (conda-forge-macos, standard, default, macos-11.0) ​https://github.com/mkoeppe/sage/runs/2103782333 - uses python3 from conda
+- local-macos (homebrew-macos-python3_pythonorg, standard, default, macos-11.0) ​https://github.com/mkoeppe/sage/runs/2103782375 - uses somewhat dated python3 from python.org - ​https://www.python.org/ftp/python/3.7.7/python-3.7.7-macosx10.9.pkg
+- another failure report, for a configuration possibly similar to local-macos (homebrew-macos, minimal, default, macos-11.0) , in #30651:
 
 ```
       File "/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.9/site-packages/numpy/distutils/ccompiler.py", line 90, in <lambda>
``````




---

archive/issue_comments_622095.json:
```json
{
    "body": "<a id='comment:27'></a>\nyes, my student also reports getting\n\n```\n[scipy-1.5.4]     clang: error: invalid version number in 'MACOSX_DEPLOYMENT_TARGET=11.0'\n```",
    "created_at": "2021-03-20T20:59:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622095",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:27'></a>
yes, my student also reports getting

```
[scipy-1.5.4]     clang: error: invalid version number in 'MACOSX_DEPLOYMENT_TARGET=11.0'
```



---

archive/issue_comments_622096.json:
```json
{
    "body": "<a id='comment:28'></a>\nI tried running on github CI, but it quit after a few days and only got through 10.15.  I just took out 10.15 and am trying again...",
    "created_at": "2021-03-20T21:22:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622096",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:28'></a>
I tried running on github CI, but it quit after a few days and only got through 10.15.  I just took out 10.15 and am trying again...



---

archive/issue_comments_622097.json:
```json
{
    "body": "<a id='comment:29'></a>\nI tried to run the CI tests on 11.0 but I got the following error message:\n\n\"No runner matching the specified labels was found: macos-11.0\"\n\nIs there a different way I should get the tests to run on Big Sur?",
    "created_at": "2021-03-21T19:31:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622097",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:29'></a>
I tried to run the CI tests on 11.0 but I got the following error message:

"No runner matching the specified labels was found: macos-11.0"

Is there a different way I should get the tests to run on Big Sur?



---

archive/issue_comments_622098.json:
```json
{
    "body": "<a id='comment:30'></a>\nhttps://github.com/actions/virtual-environments/issues/2486\n\"macOS 11.0 pools will be transited to private preview\"",
    "created_at": "2021-03-21T19:45:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622098",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:30'></a>
https://github.com/actions/virtual-environments/issues/2486
"macOS 11.0 pools will be transited to private preview"



---

archive/issue_comments_622099.json:
```json
{
    "body": "<a id='comment:31'></a>\ngotcha.  I've tried some local testing and the reversion seems to be fine, but I'll leave it to others to do more extensive testing.",
    "created_at": "2021-03-21T19:47:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622099",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:31'></a>
gotcha.  I've tried some local testing and the reversion seems to be fine, but I'll leave it to others to do more extensive testing.



---

archive/issue_comments_622100.json:
```json
{
    "body": "<a id='comment:32'></a>\nSome of my recent runs in https://github.com/mkoeppe/sage/actions/workflows/tox.yml have used branches that merged this ticket and may contain some useful results for 11.0",
    "created_at": "2021-03-21T19:48:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622100",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:32'></a>
Some of my recent runs in https://github.com/mkoeppe/sage/actions/workflows/tox.yml have used branches that merged this ticket and may contain some useful results for 11.0



---

archive/issue_comments_622101.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Matthias Koeppe\"",
    "created_at": "2021-03-21T21:43:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622101",
    "user": "https://github.com/mkoeppe"
}
```

Changing reviewer from "" to "Matthias Koeppe"



---

archive/issue_comments_622102.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-03-21T21:43:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622102",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_622103.json:
```json
{
    "body": "<a id='comment:33'></a>\n- local-macos (homebrew-macos, minimal, default, macos-11.0) - \n  https://github.com/mkoeppe/sage/runs/2156548349 - OK\n\n- local-macos (homebrew-macos, standard, default, macos-11.0) - https://github.com/mkoeppe/sage/runs/2156548388 - OK",
    "created_at": "2021-03-21T21:43:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622103",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:33'></a>
- local-macos (homebrew-macos, minimal, default, macos-11.0) - 
  https://github.com/mkoeppe/sage/runs/2156548349 - OK

- local-macos (homebrew-macos, standard, default, macos-11.0) - https://github.com/mkoeppe/sage/runs/2156548388 - OK



---

archive/issue_comments_622104.json:
```json
{
    "body": "Changing author from \"\" to \"Zachary Scherr\"",
    "created_at": "2021-03-21T21:43:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622104",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "" to "Zachary Scherr"



---

archive/issue_comments_622105.json:
```json
{
    "body": "<a id='comment:34'></a>\nAlso \n\n- local-macos (conda-forge-macos, standard, default, macos-11.0) - https://github.com/mkoeppe/sage/runs/2135024636 - OK (except for an unrelated error in docbuild)",
    "created_at": "2021-03-21T21:47:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622105",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:34'></a>
Also 

- local-macos (conda-forge-macos, standard, default, macos-11.0) - https://github.com/mkoeppe/sage/runs/2135024636 - OK (except for an unrelated error in docbuild)



---

archive/issue_comments_622106.json:
```json
{
    "body": "<a id='comment:35'></a>\nI agree it works with various Pythons on OS X 11.[comment:14](#comment%3A14) has not been addressed, but I guess that's not for this ticket.",
    "created_at": "2021-03-22T02:57:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622106",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:35'></a>
I agree it works with various Pythons on OS X 11.[comment:14](#comment%3A14) has not been addressed, but I guess that's not for this ticket.



---

archive/issue_comments_622107.json:
```json
{
    "body": "<a id='comment:36'></a>\nReplying to [jhpalmieri](#comment%3A35):\n> comment:14 has not been addressed, but I guess that's not for this ticket.\n\nYes, to fix that we need to upgrade our gcc/gfortran - that's #29703.",
    "created_at": "2021-03-22T03:08:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622107",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:36'></a>
Replying to [jhpalmieri](#comment%3A35):
> comment:14 has not been addressed, but I guess that's not for this ticket.

Yes, to fix that we need to upgrade our gcc/gfortran - that's #29703.



---

archive/issue_events_092369.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-03-23T23:49:36Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31326#event-92369"
}
```



---

archive/issue_comments_622108.json:
```json
{
    "body": "Changing branch from \"u/gh-zlscherr/revert_scipy_MACOSX_DEPLOYMENT_TARGET\" to \"4cc8c4da3ab35999e0746c498105658a24a224c0\"",
    "created_at": "2021-03-23T23:49:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622108",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/gh-zlscherr/revert_scipy_MACOSX_DEPLOYMENT_TARGET" to "4cc8c4da3ab35999e0746c498105658a24a224c0"



---

archive/issue_comments_622109.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-03-23T23:49:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31326#issuecomment-622109",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
