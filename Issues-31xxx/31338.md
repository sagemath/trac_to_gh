# Issue 31338: sage_setup: Use paths within SAGE_LOCAL when provided via sage_conf

archive/issues_031101.json:
```json
{
    "body": "We add a simple mechanism to sagelib's `setup.py` (via a new module in `sage_setup`) to prepend `SAGE_LOCAL` values to key environment variables needed for the build: `PATH`, `LIBRARY_PATH`, `CPATH`, `LDFLAGS`. This allows use to build sagelib outside of an environment set by `sage-env` (which would set these variables among many more) if only `sage_conf` is installed in the build environment.\n\nTo test:\n\n```\n./configure --enable-editable\nmake sagelib-build-deps      # installs sage_conf and other things\n(cd src && ../local/bin/python3 setup.py develop)\n```\nNote - the last line is not within a sage-env!\n\nFollow-up, if necessary: Because for misconfigured Pythons, `-I` options may leak in as described in #31335 and take precedence over the CPATH that we set, we may want to essentially revert #29697, adding some refinements:\n- `SAGE_LOCAL` vs `SAGE_VENV`\n- make sure that if `$SAGE_LOCAL` is unset, nothing is added.\n\nRelevant tickets regarding include/library search paths: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)\n\n\nCC:  @jhpalmieri @kiwifb @orlitzky @antonio-rojas @dimpase\n\nReviewer: Dima Pasechnik\n\nAuthor: Matthias Koeppe\n\nBranch: 31eaf5961c2a535f1c180916ac4a9e07ded83dec\n\nDependencies: #31593\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/31338\n\n",
    "closed_at": "2021-06-20T08:14:27Z",
    "created_at": "2021-02-04T05:47:50Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "sage_setup: Use paths within SAGE_LOCAL when provided via sage_conf",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31338",
    "user": "https://github.com/mkoeppe"
}
```
We add a simple mechanism to sagelib's `setup.py` (via a new module in `sage_setup`) to prepend `SAGE_LOCAL` values to key environment variables needed for the build: `PATH`, `LIBRARY_PATH`, `CPATH`, `LDFLAGS`. This allows use to build sagelib outside of an environment set by `sage-env` (which would set these variables among many more) if only `sage_conf` is installed in the build environment.

To test:

```
./configure --enable-editable
make sagelib-build-deps      # installs sage_conf and other things
(cd src && ../local/bin/python3 setup.py develop)
```
Note - the last line is not within a sage-env!

Follow-up, if necessary: Because for misconfigured Pythons, `-I` options may leak in as described in #31335 and take precedence over the CPATH that we set, we may want to essentially revert #29697, adding some refinements:
- `SAGE_LOCAL` vs `SAGE_VENV`
- make sure that if `$SAGE_LOCAL` is unset, nothing is added.

Relevant tickets regarding include/library search paths: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)


CC:  @jhpalmieri @kiwifb @orlitzky @antonio-rojas @dimpase

Reviewer: Dima Pasechnik

Author: Matthias Koeppe

Branch: 31eaf5961c2a535f1c180916ac4a9e07ded83dec

Dependencies: #31593

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/31338





---

archive/issue_comments_622391.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -4,5 +4,8 @@\n - `SAGE_LOCAL` vs `SAGE_VENV`\n - make sure that if `$SAGE_LOCAL` is unset, nothing is added.\n \n+Also, we want to enable building sagelib outside of an environment set by `sage-env`.\n+\n+\n Relevant tickets regarding include/library search paths: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)\n \n``````\n",
    "created_at": "2021-04-05T23:35:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622391",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -4,5 +4,8 @@
 - `SAGE_LOCAL` vs `SAGE_VENV`
 - make sure that if `$SAGE_LOCAL` is unset, nothing is added.
 
+Also, we want to enable building sagelib outside of an environment set by `sage-env`.
+
+
 Relevant tickets regarding include/library search paths: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)
 
``````




---

archive/issue_comments_622392.json:
```json
{
    "body": "Changing branch from \"\" to \"u/mkoeppe/sage_setup__use_paths_within_sage_local_when_provided_via_sage_conf\"",
    "created_at": "2021-04-06T01:50:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622392",
    "user": "https://github.com/mkoeppe"
}
```

Changing branch from "" to "u/mkoeppe/sage_setup__use_paths_within_sage_local_when_provided_via_sage_conf"



---

archive/issue_comments_622393.json:
```json
{
    "body": "Changing author from \"\" to \"Matthias Koeppe\"",
    "created_at": "2021-04-06T02:03:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622393",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "" to "Matthias Koeppe"



---

archive/issue_comments_622394.json:
```json
{
    "body": "<a id='comment:3'></a>\nNew commits:\n|                                                                                                                                          |                                                                                                                                    |\n|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------|\n|[5161d65](https://github.com/sagemath/sagetrac-mirror/commit/5161d658528e5f61e052a270611cfad2a8da5fe4)|`build/pkgs/sage_conf/src/sage_conf.py.in: Move SAGE_ROOT, SAGE_LOCAL to beginning of file; only use substitution `@`prefix`@` once`|\n|[986ca18](https://github.com/sagemath/sagetrac-mirror/commit/986ca18c4a3b255daede540ee114e9f38cbe65bd)|`build/pkgs/sage_conf/src/sage_conf.py.in: replace subst by replace`|\n|[6f05cc2](https://github.com/sagemath/sagetrac-mirror/commit/6f05cc2e4c622125dd8e6501254293fdcb9d5996)|`sage_setup.setenv: New, use it in setup.py so that build works outside of sage-env`|",
    "created_at": "2021-04-06T02:03:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622394",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'></a>
New commits:
|                                                                                                                                          |                                                                                                                                    |
|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------|
|[5161d65](https://github.com/sagemath/sagetrac-mirror/commit/5161d658528e5f61e052a270611cfad2a8da5fe4)|`build/pkgs/sage_conf/src/sage_conf.py.in: Move SAGE_ROOT, SAGE_LOCAL to beginning of file; only use substitution `@`prefix`@` once`|
|[986ca18](https://github.com/sagemath/sagetrac-mirror/commit/986ca18c4a3b255daede540ee114e9f38cbe65bd)|`build/pkgs/sage_conf/src/sage_conf.py.in: replace subst by replace`|
|[6f05cc2](https://github.com/sagemath/sagetrac-mirror/commit/6f05cc2e4c622125dd8e6501254293fdcb9d5996)|`sage_setup.setenv: New, use it in setup.py so that build works outside of sage-env`|



---

archive/issue_comments_622395.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,11 +1,17 @@\n-(from #31335)\n+We add a simple mechanism to sagelib's `setup.py` (via a new module in `sage_setup`) to prepend `SAGE_LOCAL` values to key environment variables needed for the build: `PATH`, `LIBRARY_PATH`, `CPATH`, `LDFLAGS`. This allows use to build sagelib outside of an environment set by `sage-env` (which would set these variables among many more) if only `sage_conf` is installed in the build environment.\n \n-To make sure that libraries installed in $SAGE_LOCAL (if set) take precedence over leaks described in #31335, we may want to essentially revert #29697, adding some refinements:\n+To test:\n+\n+```\n+./configure --enable-editable\n+make sagelib-build-deps      # installs sage_conf and other things\n+(cd src && ../local/bin/python3 setup.py develop)\n+```\n+Note - the last line is not within a sage-env!\n+\n+Follow-up, if necessary: Because for misconfigured Pythons, `-I` options may leak in as described in #31335 and take precedence over the CPATH that we set, we may want to essentially revert #29697, adding some refinements:\n - `SAGE_LOCAL` vs `SAGE_VENV`\n - make sure that if `$SAGE_LOCAL` is unset, nothing is added.\n \n-Also, we want to enable building sagelib outside of an environment set by `sage-env`.\n-\n-\n Relevant tickets regarding include/library search paths: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)\n \n``````\n",
    "created_at": "2021-04-06T02:03:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622395",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,11 +1,17 @@
-(from #31335)
+We add a simple mechanism to sagelib's `setup.py` (via a new module in `sage_setup`) to prepend `SAGE_LOCAL` values to key environment variables needed for the build: `PATH`, `LIBRARY_PATH`, `CPATH`, `LDFLAGS`. This allows use to build sagelib outside of an environment set by `sage-env` (which would set these variables among many more) if only `sage_conf` is installed in the build environment.
 
-To make sure that libraries installed in $SAGE_LOCAL (if set) take precedence over leaks described in #31335, we may want to essentially revert #29697, adding some refinements:
+To test:
+
+```
+./configure --enable-editable
+make sagelib-build-deps      # installs sage_conf and other things
+(cd src && ../local/bin/python3 setup.py develop)
+```
+Note - the last line is not within a sage-env!
+
+Follow-up, if necessary: Because for misconfigured Pythons, `-I` options may leak in as described in #31335 and take precedence over the CPATH that we set, we may want to essentially revert #29697, adding some refinements:
 - `SAGE_LOCAL` vs `SAGE_VENV`
 - make sure that if `$SAGE_LOCAL` is unset, nothing is added.
 
-Also, we want to enable building sagelib outside of an environment set by `sage-env`.
-
-
 Relevant tickets regarding include/library search paths: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)
 
``````




---

archive/issue_comments_622396.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#31593\"",
    "created_at": "2021-04-06T02:03:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622396",
    "user": "https://github.com/mkoeppe"
}
```

Changing dependencies from "" to "#31593"



---

archive/issue_comments_622397.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-04-06T02:03:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622397",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_622398.json:
```json
{
    "body": "Changing commit from \"\" to \"6f05cc2e4c622125dd8e6501254293fdcb9d5996\"",
    "created_at": "2021-04-06T02:03:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622398",
    "user": "https://github.com/mkoeppe"
}
```

Changing commit from "" to "6f05cc2e4c622125dd8e6501254293fdcb9d5996"



---

archive/issue_comments_622399.json:
```json
{
    "body": "Changing commit from \"6f05cc2e4c622125dd8e6501254293fdcb9d5996\" to \"6ea676d4e1f2b57f54fb0fadf6b28a1a53c5268f\"",
    "created_at": "2021-05-11T02:59:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622399",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "6f05cc2e4c622125dd8e6501254293fdcb9d5996" to "6ea676d4e1f2b57f54fb0fadf6b28a1a53c5268f"



---

archive/issue_comments_622400.json:
```json
{
    "body": "<a id='comment:4'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                                                  |\n|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------|\n|[6ea676d](https://github.com/sagemath/sagetrac-mirror/commit/6ea676d4e1f2b57f54fb0fadf6b28a1a53c5268f)|`Merge tag '9.3' into t/31338/sage_setup__use_paths_within_sage_local_when_provided_via_sage_conf`|",
    "created_at": "2021-05-11T02:59:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622400",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                                                  |
|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------|
|[6ea676d](https://github.com/sagemath/sagetrac-mirror/commit/6ea676d4e1f2b57f54fb0fadf6b28a1a53c5268f)|`Merge tag '9.3' into t/31338/sage_setup__use_paths_within_sage_local_when_provided_via_sage_conf`|



---

archive/issue_comments_622401.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-05-12T13:35:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622401",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_622402.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Dima Pasechnik\"",
    "created_at": "2021-05-12T13:35:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622402",
    "user": "https://github.com/dimpase"
}
```

Changing reviewer from "" to "Dima Pasechnik"



---

archive/issue_comments_622403.json:
```json
{
    "body": "<a id='comment:5'></a>\nlgtm",
    "created_at": "2021-05-12T13:35:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622403",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:5'></a>
lgtm



---

archive/issue_comments_622404.json:
```json
{
    "body": "<a id='comment:6'></a>\nThank you!",
    "created_at": "2021-05-12T14:55:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622404",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>
Thank you!



---

archive/issue_comments_622405.json:
```json
{
    "body": "Changing commit from \"6ea676d4e1f2b57f54fb0fadf6b28a1a53c5268f\" to \"31eaf5961c2a535f1c180916ac4a9e07ded83dec\"",
    "created_at": "2021-05-27T00:51:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622405",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "6ea676d4e1f2b57f54fb0fadf6b28a1a53c5268f" to "31eaf5961c2a535f1c180916ac4a9e07ded83dec"



---

archive/issue_comments_622406.json:
```json
{
    "body": "<a id='comment:7'></a>\nBranch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:\n|                                                                                                                                           |                                                                                                |\n|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------|\n|[2078fa6](https://github.com/sagemath/sagetrac-mirror/commit/2078fa6eb00db691046572868d510fad14dd6ede)|`Merge tag '9.4.beta0' into t/31593/configure__paths_within__sage_local___prefix__for_sage_conf`|\n|[31eaf59](https://github.com/sagemath/sagetrac-mirror/commit/31eaf5961c2a535f1c180916ac4a9e07ded83dec)|`Merge #31593`|",
    "created_at": "2021-05-27T00:51:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622406",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>
Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:
|                                                                                                                                           |                                                                                                |
|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------|
|[2078fa6](https://github.com/sagemath/sagetrac-mirror/commit/2078fa6eb00db691046572868d510fad14dd6ede)|`Merge tag '9.4.beta0' into t/31593/configure__paths_within__sage_local___prefix__for_sage_conf`|
|[31eaf59](https://github.com/sagemath/sagetrac-mirror/commit/31eaf5961c2a535f1c180916ac4a9e07ded83dec)|`Merge #31593`|



---

archive/issue_comments_622407.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2021-05-27T00:51:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622407",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_622408.json:
```json
{
    "body": "<a id='comment:8'></a>\nran into missing `toml` dependency in `build/pkgs/pytoml/dependencies` while testing (building backall errored out with `toml` module not found - `pytoml` was built, but `toml` was not).",
    "created_at": "2021-06-02T12:04:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622408",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:8'></a>
ran into missing `toml` dependency in `build/pkgs/pytoml/dependencies` while testing (building backall errored out with `toml` module not found - `pytoml` was built, but `toml` was not).



---

archive/issue_comments_622409.json:
```json
{
    "body": "<a id='comment:9'></a>\nI think this is actually coming from #31280",
    "created_at": "2021-06-02T16:34:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622409",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'></a>
I think this is actually coming from #31280



---

archive/issue_comments_622410.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-06-02T21:20:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622410",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_622411.json:
```json
{
    "body": "<a id='comment:10'></a>\nOK, fine, this works otherwise, will look at #31280 again.",
    "created_at": "2021-06-02T21:20:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622411",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:10'></a>
OK, fine, this works otherwise, will look at #31280 again.



---

archive/issue_comments_622412.json:
```json
{
    "body": "<a id='comment:11'></a>\nThanks!",
    "created_at": "2021-06-03T00:10:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622412",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:11'></a>
Thanks!



---

archive/issue_comments_622413.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-06-20T08:14:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622413",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_092419.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-06-20T08:14:27Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31338#event-92419"
}
```



---

archive/issue_comments_622414.json:
```json
{
    "body": "Changing branch from \"u/mkoeppe/sage_setup__use_paths_within_sage_local_when_provided_via_sage_conf\" to \"31eaf5961c2a535f1c180916ac4a9e07ded83dec\"",
    "created_at": "2021-06-20T08:14:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622414",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/mkoeppe/sage_setup__use_paths_within_sage_local_when_provided_via_sage_conf" to "31eaf5961c2a535f1c180916ac4a9e07ded83dec"



---

archive/issue_comments_622415.json:
```json
{
    "body": "Changing commit from \"31eaf5961c2a535f1c180916ac4a9e07ded83dec\" to \"\"",
    "created_at": "2021-06-22T23:41:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622415",
    "user": "https://github.com/kiwifb"
}
```

Changing commit from "31eaf5961c2a535f1c180916ac4a9e07ded83dec" to ""



---

archive/issue_comments_622416.json:
```json
{
    "body": "<a id='comment:13'></a>\nA bit late to that party. `sage_setup/setenv.py` is highly \"polluting\" - i.e. it all works but fill my build logs with useless junk\n\n```\n/usr/lib/gcc/x86_64-pc-linux-gnu/10.3.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible /usr/lib/libm.so when searching for -lm\n/usr/lib/gcc/x86_64-pc-linux-gnu/10.3.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible /usr/lib/libm.a when searching for -lm\n/usr/lib/gcc/x86_64-pc-linux-gnu/10.3.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible /usr/lib/libc.so when searching for -lc\n/usr/lib/gcc/x86_64-pc-linux-gnu/10.3.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible /usr/lib/libc.a when searching for -lc\n```\n\nI am trying to follow the logic of the ticket but I fail to see when `SAGE_LOCAL` is not defined, which is the only way to avoid these. In `env.py` we have \n\n```\nSAGE_LOCAL = var(\"SAGE_LOCAL\", SAGE_VENV)\n```\nSo either something from the environment or `SAGE_VENV` and it is defined by\n\n```\nSAGE_VENV = var(\"SAGE_VENV\", os.path.abspath(sys.prefix))\n```\nSo if neither `SAGE_LOCAL` or `SAGE_VENV` is in the environment `SAGE_LOCAL` becomes `os.path.abspath(sys.prefix)`.\n\nI am not sure why the `if SAGE_LOCAL:` conditional is necessary since it is always defined. What I don't see is a way to avoid the content of that block becoming added to the environment.\n\nIs there another ticket that will make `SAGE_LOCAL` default to `None` in some circumstances? Or a process that I overlooked?",
    "created_at": "2021-06-22T23:41:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622416",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:13'></a>
A bit late to that party. `sage_setup/setenv.py` is highly "polluting" - i.e. it all works but fill my build logs with useless junk

```
/usr/lib/gcc/x86_64-pc-linux-gnu/10.3.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible /usr/lib/libm.so when searching for -lm
/usr/lib/gcc/x86_64-pc-linux-gnu/10.3.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible /usr/lib/libm.a when searching for -lm
/usr/lib/gcc/x86_64-pc-linux-gnu/10.3.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible /usr/lib/libc.so when searching for -lc
/usr/lib/gcc/x86_64-pc-linux-gnu/10.3.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible /usr/lib/libc.a when searching for -lc
```

I am trying to follow the logic of the ticket but I fail to see when `SAGE_LOCAL` is not defined, which is the only way to avoid these. In `env.py` we have 

```
SAGE_LOCAL = var("SAGE_LOCAL", SAGE_VENV)
```
So either something from the environment or `SAGE_VENV` and it is defined by

```
SAGE_VENV = var("SAGE_VENV", os.path.abspath(sys.prefix))
```
So if neither `SAGE_LOCAL` or `SAGE_VENV` is in the environment `SAGE_LOCAL` becomes `os.path.abspath(sys.prefix)`.

I am not sure why the `if SAGE_LOCAL:` conditional is necessary since it is always defined. What I don't see is a way to avoid the content of that block becoming added to the environment.

Is there another ticket that will make `SAGE_LOCAL` default to `None` in some circumstances? Or a process that I overlooked?



---

archive/issue_comments_622417.json:
```json
{
    "body": "<a id='comment:14'></a>\nThe idea for distribution packaging would be that `SAGE_LOCAL` will not be set at all, which is why we have the `if SAGE_LOCAL` there.\n\nThat it is always set, by the traditional catch-all defaults in `sage.env`, is a nice catch; let's fix this in #32036.",
    "created_at": "2021-06-23T00:17:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622417",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:14'></a>
The idea for distribution packaging would be that `SAGE_LOCAL` will not be set at all, which is why we have the `if SAGE_LOCAL` there.

That it is always set, by the traditional catch-all defaults in `sage.env`, is a nice catch; let's fix this in #32036.



---

archive/issue_comments_622418.json:
```json
{
    "body": "<a id='comment:15'></a>\nI am OK with eliminating `SAGE_LOCAL` the way `SAGE_ROOT` is virtually extinct but we are not there yet. It still need to be set at runtime for a few things. Some would gain to be replaced by more specific variables. But let's move things to #32036",
    "created_at": "2021-06-23T00:21:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622418",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:15'></a>
I am OK with eliminating `SAGE_LOCAL` the way `SAGE_ROOT` is virtually extinct but we are not there yet. It still need to be set at runtime for a few things. Some would gain to be replaced by more specific variables. But let's move things to #32036



---

archive/issue_comments_622419.json:
```json
{
    "body": "<a id='comment:16'></a>\nLet's see if we can solve this problem in a different way. Where is this `incompatible /usr/lib/libm.so` business exactly coming from?",
    "created_at": "2021-06-24T21:42:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622419",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:16'></a>
Let's see if we can solve this problem in a different way. Where is this `incompatible /usr/lib/libm.so` business exactly coming from?



---

archive/issue_comments_622420.json:
```json
{
    "body": "<a id='comment:17'></a>\nReplying to [mkoeppe](#comment%3A16):\n> Let's see if we can solve this problem in a different way. Where is this `incompatible /usr/lib/libm.so` business exactly coming from?\n\n\nBecause you are add `-L/usr/lib` (and some rpath to boot) at linking time, since `SAGE_LOCAL` is `/usr`. But of of course on my system the correct location is `/usr/lib64`, `/usr/lib` is for 32bit libraries. So, when you add `-L/usr/lib` it looks for the 32bit version of the libraries first before looking for the correct ones in the default location.\n\nIt is not strictly harmful unless you have done something dodgy to your system. I described it as pollution, because my logs gets full of it. Which makes reading them difficult when you are looking for real problems.",
    "created_at": "2021-06-24T21:54:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622420",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:17'></a>
Replying to [mkoeppe](#comment%3A16):
> Let's see if we can solve this problem in a different way. Where is this `incompatible /usr/lib/libm.so` business exactly coming from?


Because you are add `-L/usr/lib` (and some rpath to boot) at linking time, since `SAGE_LOCAL` is `/usr`. But of of course on my system the correct location is `/usr/lib64`, `/usr/lib` is for 32bit libraries. So, when you add `-L/usr/lib` it looks for the 32bit version of the libraries first before looking for the correct ones in the default location.

It is not strictly harmful unless you have done something dodgy to your system. I described it as pollution, because my logs gets full of it. Which makes reading them difficult when you are looking for real problems.



---

archive/issue_comments_622421.json:
```json
{
    "body": "<a id='comment:18'></a>\nOK, this is essentially the same issue that we were hitting in #31578. Should we be looking for a general way to find the multilib path for situations like this? Perhaps something in `python3 -m sysconfig` gives it?",
    "created_at": "2021-06-24T21:59:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622421",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:18'></a>
OK, this is essentially the same issue that we were hitting in #31578. Should we be looking for a general way to find the multilib path for situations like this? Perhaps something in `python3 -m sysconfig` gives it?



---

archive/issue_comments_622422.json:
```json
{
    "body": "<a id='comment:19'></a>\nIt is similar indeed and yes it appears that `python -m sysconfig` has the correct value in `LIBDIR` but we should check on a few setup to make sure.",
    "created_at": "2021-06-24T22:02:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622422",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:19'></a>
It is similar indeed and yes it appears that `python -m sysconfig` has the correct value in `LIBDIR` but we should check on a few setup to make sure.



---

archive/issue_comments_622423.json:
```json
{
    "body": "<a id='comment:20'></a>\nHum, on ubuntu I get `/usr/lib` when I am fairly sure it should be `/usr/lib/x86_64-linux-gnu`.",
    "created_at": "2021-06-24T22:09:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622423",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:20'></a>
Hum, on ubuntu I get `/usr/lib` when I am fairly sure it should be `/usr/lib/x86_64-linux-gnu`.



---

archive/issue_comments_622424.json:
```json
{
    "body": "<a id='comment:21'></a>\nThis is really annoying, ubuntu systems have a `MULTIARCH` defined where my gentoo system doesn't. But `conda` on ubuntu defines `MULTIARCH` even so it doesn't use it. There must be a better way to get the right info.",
    "created_at": "2021-06-24T22:14:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622424",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:21'></a>
This is really annoying, ubuntu systems have a `MULTIARCH` defined where my gentoo system doesn't. But `conda` on ubuntu defines `MULTIARCH` even so it doesn't use it. There must be a better way to get the right info.



---

archive/issue_comments_622425.json:
```json
{
    "body": "<a id='comment:22'></a>\nAnother possible solution: #32057",
    "created_at": "2021-06-24T22:28:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-622425",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:22'></a>
Another possible solution: #32057
