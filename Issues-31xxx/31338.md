# Issue 31338: sage_setup: Use paths within SAGE_LOCAL when provided via sage_conf

archive/issues_031101.json:
```json
{
    "assignees": [],
    "body": "We add a simple mechanism to sagelib's `setup.py` (via a new module in `sage_setup`) to prepend `SAGE_LOCAL` values to key environment variables needed for the build: `PATH`, `LIBRARY_PATH`, `CPATH`, `LDFLAGS`. This allows use to build sagelib outside of an environment set by `sage-env` (which would set these variables among many more) if only `sage_conf` is installed in the build environment.\n\nTo test:\n\n```\n./configure --enable-editable\nmake sagelib-build-deps      # installs sage_conf and other things\n(cd src && ../local/bin/python3 setup.py develop)\n```\nNote - the last line is not within a sage-env!\n\nFollow-up, if necessary: Because for misconfigured Pythons, `-I` options may leak in as described in #31335 and take precedence over the CPATH that we set, we may want to essentially revert #29697, adding some refinements:\n- `SAGE_LOCAL` vs `SAGE_VENV`\n- make sure that if `$SAGE_LOCAL` is unset, nothing is added.\n\nRelevant tickets regarding include/library search paths: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)\n\n\nDepends on #31593\n\nCC:  @jhpalmieri @kiwifb @orlitzky @antonio-rojas @dimpase\n\nBranch: **[`31eaf59`](https://github.com/sagemath/sagetrac-mirror/commit/31eaf5961c2a535f1c180916ac4a9e07ded83dec)**\n\nReviewer: **Dima Pasechnik**\n\nAuthor: **Matthias Koeppe**\n\nComponent: **build**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/31338_\n\n",
    "closed_at": "2021-06-20T08:14:27Z",
    "created_at": "2021-02-04T05:47:50Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20build",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.4",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "sage_setup: Use paths within SAGE_LOCAL when provided via sage_conf",
    "type": "issue",
    "updated_at": "2021-06-24T22:28:27Z",
    "url": "https://github.com/sagemath/sage/issues/31338",
    "user": "https://github.com/mkoeppe"
}
```
We add a simple mechanism to sagelib's `setup.py` (via a new module in `sage_setup`) to prepend `SAGE_LOCAL` values to key environment variables needed for the build: `PATH`, `LIBRARY_PATH`, `CPATH`, `LDFLAGS`. This allows use to build sagelib outside of an environment set by `sage-env` (which would set these variables among many more) if only `sage_conf` is installed in the build environment.

To test:

```
./configure --enable-editable
make sagelib-build-deps      # installs sage_conf and other things
(cd src && ../local/bin/python3 setup.py develop)
```
Note - the last line is not within a sage-env!

Follow-up, if necessary: Because for misconfigured Pythons, `-I` options may leak in as described in #31335 and take precedence over the CPATH that we set, we may want to essentially revert #29697, adding some refinements:
- `SAGE_LOCAL` vs `SAGE_VENV`
- make sure that if `$SAGE_LOCAL` is unset, nothing is added.

Relevant tickets regarding include/library search paths: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)


Depends on #31593

CC:  @jhpalmieri @kiwifb @orlitzky @antonio-rojas @dimpase

Branch: **[`31eaf59`](https://github.com/sagemath/sagetrac-mirror/commit/31eaf5961c2a535f1c180916ac4a9e07ded83dec)**

Reviewer: **Dima Pasechnik**

Author: **Matthias Koeppe**

Component: **build**

_Issue created by migration from https://trac.sagemath.org/ticket/31338_





---

archive/issue_events_428810.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-04T05:47:50Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31338#event-428810"
}
```



---

archive/issue_events_428811.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-04T05:47:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20build",
    "label_color": "0000b0",
    "label_name": "c: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31338#event-428811"
}
```



---

archive/issue_events_428812.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-04T05:47:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31338#event-428812"
}
```



---

archive/issue_events_428813.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-04T05:47:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31338#event-428813"
}
```



---

archive/issue_comments_502420.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -4,5 +4,8 @@\n - `SAGE_LOCAL` vs `SAGE_VENV`\n - make sure that if `$SAGE_LOCAL` is unset, nothing is added.\n \n+Also, we want to enable building sagelib outside of an environment set by `sage-env`.\n+\n+\n Relevant tickets regarding include/library search paths: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)\n \n``````\n",
    "created_at": "2021-04-05T23:35:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31338#issuecomment-502420",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -4,5 +4,8 @@
 - `SAGE_LOCAL` vs `SAGE_VENV`
 - make sure that if `$SAGE_LOCAL` is unset, nothing is added.
 
+Also, we want to enable building sagelib outside of an environment set by `sage-env`.
+
+
 Relevant tickets regarding include/library search paths: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)
 
``````




---

archive/issue_comments_502421.json:
```json
{
    "body": "Branch: **[u/mkoeppe/sage_setup__use_paths_within_sage_local_when_provided_via_sage_conf](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage_setup__use_paths_within_sage_local_when_provided_via_sage_conf)**",
    "created_at": "2021-04-06T01:50:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31338#issuecomment-502421",
    "user": "https://github.com/mkoeppe"
}
```

Branch: **[u/mkoeppe/sage_setup__use_paths_within_sage_local_when_provided_via_sage_conf](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage_setup__use_paths_within_sage_local_when_provided_via_sage_conf)**



---

archive/issue_comments_502422.json:
```json
{
    "body": "Author: **Matthias Koeppe**",
    "created_at": "2021-04-06T02:03:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31338#issuecomment-502422",
    "user": "https://github.com/mkoeppe"
}
```

Author: **Matthias Koeppe**



---

archive/issue_comments_502423.json:
```json
{
    "body": "<div id=\"comment:3\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5161d658528e5f61e052a270611cfad2a8da5fe4\"><code>5161d65</code></a></td><td><code>build/pkgs/sage_conf/src/sage_conf.py.in: Move SAGE_ROOT, SAGE_LOCAL to beginning of file; only use substitution @prefix@ once</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/986ca18c4a3b255daede540ee114e9f38cbe65bd\"><code>986ca18</code></a></td><td><code>build/pkgs/sage_conf/src/sage_conf.py.in: replace subst by replace</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6f05cc2e4c622125dd8e6501254293fdcb9d5996\"><code>6f05cc2</code></a></td><td><code>sage_setup.setenv: New, use it in setup.py so that build works outside of sage-env</code></td></tr></table>\n",
    "created_at": "2021-04-06T02:03:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31338#issuecomment-502423",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:3"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5161d658528e5f61e052a270611cfad2a8da5fe4"><code>5161d65</code></a></td><td><code>build/pkgs/sage_conf/src/sage_conf.py.in: Move SAGE_ROOT, SAGE_LOCAL to beginning of file; only use substitution @prefix@ once</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/986ca18c4a3b255daede540ee114e9f38cbe65bd"><code>986ca18</code></a></td><td><code>build/pkgs/sage_conf/src/sage_conf.py.in: replace subst by replace</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6f05cc2e4c622125dd8e6501254293fdcb9d5996"><code>6f05cc2</code></a></td><td><code>sage_setup.setenv: New, use it in setup.py so that build works outside of sage-env</code></td></tr></table>




---

archive/issue_comments_502424.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,11 +1,17 @@\n-(from #31335)\n+We add a simple mechanism to sagelib's `setup.py` (via a new module in `sage_setup`) to prepend `SAGE_LOCAL` values to key environment variables needed for the build: `PATH`, `LIBRARY_PATH`, `CPATH`, `LDFLAGS`. This allows use to build sagelib outside of an environment set by `sage-env` (which would set these variables among many more) if only `sage_conf` is installed in the build environment.\n \n-To make sure that libraries installed in $SAGE_LOCAL (if set) take precedence over leaks described in #31335, we may want to essentially revert #29697, adding some refinements:\n+To test:\n+\n+```\n+./configure --enable-editable\n+make sagelib-build-deps      # installs sage_conf and other things\n+(cd src && ../local/bin/python3 setup.py develop)\n+```\n+Note - the last line is not within a sage-env!\n+\n+Follow-up, if necessary: Because for misconfigured Pythons, `-I` options may leak in as described in #31335 and take precedence over the CPATH that we set, we may want to essentially revert #29697, adding some refinements:\n - `SAGE_LOCAL` vs `SAGE_VENV`\n - make sure that if `$SAGE_LOCAL` is unset, nothing is added.\n \n-Also, we want to enable building sagelib outside of an environment set by `sage-env`.\n-\n-\n Relevant tickets regarding include/library search paths: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)\n \n``````\n",
    "created_at": "2021-04-06T02:03:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31338#issuecomment-502424",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,11 +1,17 @@
-(from #31335)
+We add a simple mechanism to sagelib's `setup.py` (via a new module in `sage_setup`) to prepend `SAGE_LOCAL` values to key environment variables needed for the build: `PATH`, `LIBRARY_PATH`, `CPATH`, `LDFLAGS`. This allows use to build sagelib outside of an environment set by `sage-env` (which would set these variables among many more) if only `sage_conf` is installed in the build environment.
 
-To make sure that libraries installed in $SAGE_LOCAL (if set) take precedence over leaks described in #31335, we may want to essentially revert #29697, adding some refinements:
+To test:
+
+```
+./configure --enable-editable
+make sagelib-build-deps      # installs sage_conf and other things
+(cd src && ../local/bin/python3 setup.py develop)
+```
+Note - the last line is not within a sage-env!
+
+Follow-up, if necessary: Because for misconfigured Pythons, `-I` options may leak in as described in #31335 and take precedence over the CPATH that we set, we may want to essentially revert #29697, adding some refinements:
 - `SAGE_LOCAL` vs `SAGE_VENV`
 - make sure that if `$SAGE_LOCAL` is unset, nothing is added.
 
-Also, we want to enable building sagelib outside of an environment set by `sage-env`.
-
-
 Relevant tickets regarding include/library search paths: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)
 
``````




---

archive/issue_comments_502425.json:
```json
{
    "body": "Dependencies: **#31593**",
    "created_at": "2021-04-06T02:03:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31338#issuecomment-502425",
    "user": "https://github.com/mkoeppe"
}
```

Dependencies: **#31593**



---

archive/issue_events_428814.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-06T02:03:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31338#event-428814"
}
```



---

archive/issue_comments_502426.json:
```json
{
    "body": "Commit: **[`6f05cc2`](https://github.com/sagemath/sagetrac-mirror/commit/6f05cc2e4c622125dd8e6501254293fdcb9d5996)**",
    "created_at": "2021-04-06T02:03:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31338#issuecomment-502426",
    "user": "https://github.com/mkoeppe"
}
```

Commit: **[`6f05cc2`](https://github.com/sagemath/sagetrac-mirror/commit/6f05cc2e4c622125dd8e6501254293fdcb9d5996)**



---

archive/issue_comments_502427.json:
```json
{
    "body": "Changed commit from **[`6f05cc2`](https://github.com/sagemath/sagetrac-mirror/commit/6f05cc2e4c622125dd8e6501254293fdcb9d5996)** to **[`6ea676d`](https://github.com/sagemath/sagetrac-mirror/commit/6ea676d4e1f2b57f54fb0fadf6b28a1a53c5268f)**",
    "created_at": "2021-05-11T02:59:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31338#issuecomment-502427",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`6f05cc2`](https://github.com/sagemath/sagetrac-mirror/commit/6f05cc2e4c622125dd8e6501254293fdcb9d5996)** to **[`6ea676d`](https://github.com/sagemath/sagetrac-mirror/commit/6ea676d4e1f2b57f54fb0fadf6b28a1a53c5268f)**



---

archive/issue_comments_502428.json:
```json
{
    "body": "<div id=\"comment:4\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6ea676d4e1f2b57f54fb0fadf6b28a1a53c5268f\"><code>6ea676d</code></a></td><td><code>Merge tag '9.3' into t/31338/sage_setup__use_paths_within_sage_local_when_provided_via_sage_conf</code></td></tr></table>\n",
    "created_at": "2021-05-11T02:59:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31338#issuecomment-502428",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:4"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6ea676d4e1f2b57f54fb0fadf6b28a1a53c5268f"><code>6ea676d</code></a></td><td><code>Merge tag '9.3' into t/31338/sage_setup__use_paths_within_sage_local_when_provided_via_sage_conf</code></td></tr></table>




---

archive/issue_events_428815.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-05-12T13:35:57Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31338#event-428815"
}
```



---

archive/issue_events_428816.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-05-12T13:35:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31338#event-428816"
}
```



---

archive/issue_comments_502429.json:
```json
{
    "body": "Reviewer: **Dima Pasechnik**",
    "created_at": "2021-05-12T13:35:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31338#issuecomment-502429",
    "user": "https://github.com/dimpase"
}
```

Reviewer: **Dima Pasechnik**



---

archive/issue_comments_502430.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nlgtm",
    "created_at": "2021-05-12T13:35:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31338#issuecomment-502430",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:5" align="right">comment:5</div>

lgtm



---

archive/issue_comments_502431.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nThank you!",
    "created_at": "2021-05-12T14:55:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31338#issuecomment-502431",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:6" align="right">comment:6</div>

Thank you!



---

archive/issue_comments_502432.json:
```json
{
    "body": "Changed commit from **[`6ea676d`](https://github.com/sagemath/sagetrac-mirror/commit/6ea676d4e1f2b57f54fb0fadf6b28a1a53c5268f)** to **[`31eaf59`](https://github.com/sagemath/sagetrac-mirror/commit/31eaf5961c2a535f1c180916ac4a9e07ded83dec)**",
    "created_at": "2021-05-27T00:51:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31338#issuecomment-502432",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`6ea676d`](https://github.com/sagemath/sagetrac-mirror/commit/6ea676d4e1f2b57f54fb0fadf6b28a1a53c5268f)** to **[`31eaf59`](https://github.com/sagemath/sagetrac-mirror/commit/31eaf5961c2a535f1c180916ac4a9e07ded83dec)**



---

archive/issue_comments_502433.json:
```json
{
    "body": "<div id=\"comment:7\"></div>\n\nBranch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2078fa6eb00db691046572868d510fad14dd6ede\"><code>2078fa6</code></a></td><td><code>Merge tag '9.4.beta0' into t/31593/configure__paths_within__sage_local___prefix__for_sage_conf</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/31eaf5961c2a535f1c180916ac4a9e07ded83dec\"><code>31eaf59</code></a></td><td><code>Merge #31593</code></td></tr></table>\n",
    "created_at": "2021-05-27T00:51:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31338#issuecomment-502433",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:7"></div>

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2078fa6eb00db691046572868d510fad14dd6ede"><code>2078fa6</code></a></td><td><code>Merge tag '9.4.beta0' into t/31593/configure__paths_within__sage_local___prefix__for_sage_conf</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/31eaf5961c2a535f1c180916ac4a9e07ded83dec"><code>31eaf59</code></a></td><td><code>Merge #31593</code></td></tr></table>




---

archive/issue_events_428817.json:
```json
{
    "actor": "https://github.com/sagetrac-git",
    "created_at": "2021-05-27T00:51:49Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31338#event-428817"
}
```



---

archive/issue_events_428818.json:
```json
{
    "actor": "https://github.com/sagetrac-git",
    "created_at": "2021-05-27T00:51:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31338#event-428818"
}
```



---

archive/issue_comments_502434.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nran into missing `toml` dependency in `build/pkgs/pytoml/dependencies` while testing (building backall errored out with `toml` module not found - `pytoml` was built, but `toml` was not).",
    "created_at": "2021-06-02T12:04:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31338#issuecomment-502434",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:8" align="right">comment:8</div>

ran into missing `toml` dependency in `build/pkgs/pytoml/dependencies` while testing (building backall errored out with `toml` module not found - `pytoml` was built, but `toml` was not).



---

archive/issue_comments_502435.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nI think this is actually coming from #31280",
    "created_at": "2021-06-02T16:34:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31338#issuecomment-502435",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:9" align="right">comment:9</div>

I think this is actually coming from #31280



---

archive/issue_events_428819.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-06-02T21:20:10Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31338#event-428819"
}
```



---

archive/issue_events_428820.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-06-02T21:20:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31338#event-428820"
}
```



---

archive/issue_comments_502436.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nOK, fine, this works otherwise, will look at #31280 again.",
    "created_at": "2021-06-02T21:20:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31338#issuecomment-502436",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:10" align="right">comment:10</div>

OK, fine, this works otherwise, will look at #31280 again.



---

archive/issue_comments_502437.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nThanks!",
    "created_at": "2021-06-03T00:10:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31338#issuecomment-502437",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:11" align="right">comment:11</div>

Thanks!



---

archive/issue_events_428821.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-06-20T08:14:27Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31338#event-428821"
}
```



---

archive/issue_events_428822.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "e308f750365ffdf3f0516797c4b80c66e3d1db46",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2021-06-20T08:14:27Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31338#event-428822"
}
```



---

archive/issue_comments_502438.json:
```json
{
    "body": "Changed branch from **[u/mkoeppe/sage_setup__use_paths_within_sage_local_when_provided_via_sage_conf](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage_setup__use_paths_within_sage_local_when_provided_via_sage_conf)** to **[`31eaf59`](https://github.com/sagemath/sagetrac-mirror/commit/31eaf5961c2a535f1c180916ac4a9e07ded83dec)**",
    "created_at": "2021-06-20T08:14:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31338#issuecomment-502438",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/mkoeppe/sage_setup__use_paths_within_sage_local_when_provided_via_sage_conf](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage_setup__use_paths_within_sage_local_when_provided_via_sage_conf)** to **[`31eaf59`](https://github.com/sagemath/sagetrac-mirror/commit/31eaf5961c2a535f1c180916ac4a9e07ded83dec)**



---

archive/issue_comments_502439.json:
```json
{
    "body": "Changed commit from **[`31eaf59`](https://github.com/sagemath/sagetrac-mirror/commit/31eaf5961c2a535f1c180916ac4a9e07ded83dec)** to none",
    "created_at": "2021-06-22T23:41:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31338#issuecomment-502439",
    "user": "https://github.com/kiwifb"
}
```

Changed commit from **[`31eaf59`](https://github.com/sagemath/sagetrac-mirror/commit/31eaf5961c2a535f1c180916ac4a9e07ded83dec)** to none



---

archive/issue_comments_502440.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nA bit late to that party. `sage_setup/setenv.py` is highly \"polluting\" - i.e. it all works but fill my build logs with useless junk\n\n```\n/usr/lib/gcc/x86_64-pc-linux-gnu/10.3.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible /usr/lib/libm.so when searching for -lm\n/usr/lib/gcc/x86_64-pc-linux-gnu/10.3.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible /usr/lib/libm.a when searching for -lm\n/usr/lib/gcc/x86_64-pc-linux-gnu/10.3.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible /usr/lib/libc.so when searching for -lc\n/usr/lib/gcc/x86_64-pc-linux-gnu/10.3.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible /usr/lib/libc.a when searching for -lc\n```\n\nI am trying to follow the logic of the ticket but I fail to see when `SAGE_LOCAL` is not defined, which is the only way to avoid these. In `env.py` we have \n\n```\nSAGE_LOCAL = var(\"SAGE_LOCAL\", SAGE_VENV)\n```\nSo either something from the environment or `SAGE_VENV` and it is defined by\n\n```\nSAGE_VENV = var(\"SAGE_VENV\", os.path.abspath(sys.prefix))\n```\nSo if neither `SAGE_LOCAL` or `SAGE_VENV` is in the environment `SAGE_LOCAL` becomes `os.path.abspath(sys.prefix)`.\n\nI am not sure why the `if SAGE_LOCAL:` conditional is necessary since it is always defined. What I don't see is a way to avoid the content of that block becoming added to the environment.\n\nIs there another ticket that will make `SAGE_LOCAL` default to `None` in some circumstances? Or a process that I overlooked?",
    "created_at": "2021-06-22T23:41:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31338#issuecomment-502440",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:13" align="right">comment:13</div>

A bit late to that party. `sage_setup/setenv.py` is highly "polluting" - i.e. it all works but fill my build logs with useless junk

```
/usr/lib/gcc/x86_64-pc-linux-gnu/10.3.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible /usr/lib/libm.so when searching for -lm
/usr/lib/gcc/x86_64-pc-linux-gnu/10.3.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible /usr/lib/libm.a when searching for -lm
/usr/lib/gcc/x86_64-pc-linux-gnu/10.3.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible /usr/lib/libc.so when searching for -lc
/usr/lib/gcc/x86_64-pc-linux-gnu/10.3.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible /usr/lib/libc.a when searching for -lc
```

I am trying to follow the logic of the ticket but I fail to see when `SAGE_LOCAL` is not defined, which is the only way to avoid these. In `env.py` we have 

```
SAGE_LOCAL = var("SAGE_LOCAL", SAGE_VENV)
```
So either something from the environment or `SAGE_VENV` and it is defined by

```
SAGE_VENV = var("SAGE_VENV", os.path.abspath(sys.prefix))
```
So if neither `SAGE_LOCAL` or `SAGE_VENV` is in the environment `SAGE_LOCAL` becomes `os.path.abspath(sys.prefix)`.

I am not sure why the `if SAGE_LOCAL:` conditional is necessary since it is always defined. What I don't see is a way to avoid the content of that block becoming added to the environment.

Is there another ticket that will make `SAGE_LOCAL` default to `None` in some circumstances? Or a process that I overlooked?



---

archive/issue_comments_502441.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nThe idea for distribution packaging would be that `SAGE_LOCAL` will not be set at all, which is why we have the `if SAGE_LOCAL` there.\n\nThat it is always set, by the traditional catch-all defaults in `sage.env`, is a nice catch; let's fix this in #32036.",
    "created_at": "2021-06-23T00:17:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31338#issuecomment-502441",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:14" align="right">comment:14</div>

The idea for distribution packaging would be that `SAGE_LOCAL` will not be set at all, which is why we have the `if SAGE_LOCAL` there.

That it is always set, by the traditional catch-all defaults in `sage.env`, is a nice catch; let's fix this in #32036.



---

archive/issue_comments_502442.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nI am OK with eliminating `SAGE_LOCAL` the way `SAGE_ROOT` is virtually extinct but we are not there yet. It still need to be set at runtime for a few things. Some would gain to be replaced by more specific variables. But let's move things to #32036",
    "created_at": "2021-06-23T00:21:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31338#issuecomment-502442",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:15" align="right">comment:15</div>

I am OK with eliminating `SAGE_LOCAL` the way `SAGE_ROOT` is virtually extinct but we are not there yet. It still need to be set at runtime for a few things. Some would gain to be replaced by more specific variables. But let's move things to #32036



---

archive/issue_comments_502443.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nLet's see if we can solve this problem in a different way. Where is this `incompatible /usr/lib/libm.so` business exactly coming from?",
    "created_at": "2021-06-24T21:42:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31338#issuecomment-502443",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:16" align="right">comment:16</div>

Let's see if we can solve this problem in a different way. Where is this `incompatible /usr/lib/libm.so` business exactly coming from?



---

archive/issue_comments_502444.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@mkoeppe](#comment%3A16):\n> Let's see if we can solve this problem in a different way. Where is this `incompatible /usr/lib/libm.so` business exactly coming from?\n\nBecause you are add `-L/usr/lib` (and some rpath to boot) at linking time, since `SAGE_LOCAL` is `/usr`. But of of course on my system the correct location is `/usr/lib64`, `/usr/lib` is for 32bit libraries. So, when you add `-L/usr/lib` it looks for the 32bit version of the libraries first before looking for the correct ones in the default location.\n\nIt is not strictly harmful unless you have done something dodgy to your system. I described it as pollution, because my logs gets full of it. Which makes reading them difficult when you are looking for real problems.",
    "created_at": "2021-06-24T21:54:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31338#issuecomment-502444",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@mkoeppe](#comment%3A16):
> Let's see if we can solve this problem in a different way. Where is this `incompatible /usr/lib/libm.so` business exactly coming from?

Because you are add `-L/usr/lib` (and some rpath to boot) at linking time, since `SAGE_LOCAL` is `/usr`. But of of course on my system the correct location is `/usr/lib64`, `/usr/lib` is for 32bit libraries. So, when you add `-L/usr/lib` it looks for the 32bit version of the libraries first before looking for the correct ones in the default location.

It is not strictly harmful unless you have done something dodgy to your system. I described it as pollution, because my logs gets full of it. Which makes reading them difficult when you are looking for real problems.



---

archive/issue_comments_502445.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nOK, this is essentially the same issue that we were hitting in #31578. Should we be looking for a general way to find the multilib path for situations like this? Perhaps something in `python3 -m sysconfig` gives it?",
    "created_at": "2021-06-24T21:59:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31338#issuecomment-502445",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:18" align="right">comment:18</div>

OK, this is essentially the same issue that we were hitting in #31578. Should we be looking for a general way to find the multilib path for situations like this? Perhaps something in `python3 -m sysconfig` gives it?



---

archive/issue_comments_502446.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nIt is similar indeed and yes it appears that `python -m sysconfig` has the correct value in `LIBDIR` but we should check on a few setup to make sure.",
    "created_at": "2021-06-24T22:02:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31338#issuecomment-502446",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:19" align="right">comment:19</div>

It is similar indeed and yes it appears that `python -m sysconfig` has the correct value in `LIBDIR` but we should check on a few setup to make sure.



---

archive/issue_comments_502447.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nHum, on ubuntu I get `/usr/lib` when I am fairly sure it should be `/usr/lib/x86_64-linux-gnu`.",
    "created_at": "2021-06-24T22:09:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31338#issuecomment-502447",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:20" align="right">comment:20</div>

Hum, on ubuntu I get `/usr/lib` when I am fairly sure it should be `/usr/lib/x86_64-linux-gnu`.



---

archive/issue_comments_502448.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nThis is really annoying, ubuntu systems have a `MULTIARCH` defined where my gentoo system doesn't. But `conda` on ubuntu defines `MULTIARCH` even so it doesn't use it. There must be a better way to get the right info.",
    "created_at": "2021-06-24T22:14:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31338#issuecomment-502448",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:21" align="right">comment:21</div>

This is really annoying, ubuntu systems have a `MULTIARCH` defined where my gentoo system doesn't. But `conda` on ubuntu defines `MULTIARCH` even so it doesn't use it. There must be a better way to get the right info.



---

archive/issue_comments_502449.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nAnother possible solution: #32057",
    "created_at": "2021-06-24T22:28:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31338#issuecomment-502449",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:22" align="right">comment:22</div>

Another possible solution: #32057
