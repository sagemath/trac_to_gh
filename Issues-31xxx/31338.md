# Issue 31338: sage_setup: Use paths within SAGE_LOCAL when provided via sage_conf

archive/issues_031101.json:
```json
{
    "body": "CC:  @jhpalmieri @kiwifb @orlitzky @antonio-rojas @dimpase\n\nWe add a simple mechanism to sagelib's `setup.py` (via a new module in `sage_setup`) to prepend `SAGE_LOCAL` values to key environment variables needed for the build: `PATH`, `LIBRARY_PATH`, `CPATH`, `LDFLAGS`. This allows use to build sagelib outside of an environment set by `sage-env` (which would set these variables among many more) if only `sage_conf` is installed in the build environment.\n\nTo test:\n\n```\n./configure --enable-editable\nmake sagelib-build-deps      # installs sage_conf and other things\n(cd src && ../local/bin/python3 setup.py develop)\n```\nNote - the last line is not within a sage-env!\n\nFollow-up, if necessary: Because for misconfigured Pythons, `-I` options may leak in as described in #31335 and take precedence over the CPATH that we set, we may want to essentially revert #29697, adding some refinements:\n- `SAGE_LOCAL` vs `SAGE_VENV`\n- make sure that if `$SAGE_LOCAL` is unset, nothing is added.\n\nRelevant tickets regarding include/library search paths: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/31338\n\n",
    "closed_at": "2021-06-20T08:14:27Z",
    "created_at": "2021-02-04T05:47:50Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "sage_setup: Use paths within SAGE_LOCAL when provided via sage_conf",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31338",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @jhpalmieri @kiwifb @orlitzky @antonio-rojas @dimpase

We add a simple mechanism to sagelib's `setup.py` (via a new module in `sage_setup`) to prepend `SAGE_LOCAL` values to key environment variables needed for the build: `PATH`, `LIBRARY_PATH`, `CPATH`, `LDFLAGS`. This allows use to build sagelib outside of an environment set by `sage-env` (which would set these variables among many more) if only `sage_conf` is installed in the build environment.

To test:

```
./configure --enable-editable
make sagelib-build-deps      # installs sage_conf and other things
(cd src && ../local/bin/python3 setup.py develop)
```
Note - the last line is not within a sage-env!

Follow-up, if necessary: Because for misconfigured Pythons, `-I` options may leak in as described in #31335 and take precedence over the CPATH that we set, we may want to essentially revert #29697, adding some refinements:
- `SAGE_LOCAL` vs `SAGE_VENV`
- make sure that if `$SAGE_LOCAL` is unset, nothing is added.

Relevant tickets regarding include/library search paths: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)


Issue created by migration from https://trac.sagemath.org/ticket/31338





---

archive/issue_comments_443742.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-04-06T02:03:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-443742",
    "user": "https://github.com/mkoeppe"
}
```

New commits:



---

archive/issue_comments_443743.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-04-06T02:03:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-443743",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_443744.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-05-11T02:59:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-443744",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_443745.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-05-12T13:35:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-443745",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_443746.json:
```json
{
    "body": "lgtm",
    "created_at": "2021-05-12T13:35:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-443746",
    "user": "https://github.com/dimpase"
}
```

lgtm



---

archive/issue_comments_443747.json:
```json
{
    "body": "Thank you!",
    "created_at": "2021-05-12T14:55:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-443747",
    "user": "https://github.com/mkoeppe"
}
```

Thank you!



---

archive/issue_comments_443748.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2021-05-27T00:51:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-443748",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_443749.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2021-05-27T00:51:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-443749",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_443750.json:
```json
{
    "body": "ran into missing `toml` dependency in `build/pkgs/pytoml/dependencies` while testing (building backall errored out with `toml` module not found - `pytoml` was built, but `toml` was not).",
    "created_at": "2021-06-02T12:04:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-443750",
    "user": "https://github.com/dimpase"
}
```

ran into missing `toml` dependency in `build/pkgs/pytoml/dependencies` while testing (building backall errored out with `toml` module not found - `pytoml` was built, but `toml` was not).



---

archive/issue_comments_443751.json:
```json
{
    "body": "I think this is actually coming from #31280",
    "created_at": "2021-06-02T16:34:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-443751",
    "user": "https://github.com/mkoeppe"
}
```

I think this is actually coming from #31280



---

archive/issue_comments_443752.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-06-02T21:20:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-443752",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_443753.json:
```json
{
    "body": "OK, fine, this works otherwise, will look at #31280 again.",
    "created_at": "2021-06-02T21:20:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-443753",
    "user": "https://github.com/dimpase"
}
```

OK, fine, this works otherwise, will look at #31280 again.



---

archive/issue_comments_443754.json:
```json
{
    "body": "Thanks!",
    "created_at": "2021-06-03T00:10:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-443754",
    "user": "https://github.com/mkoeppe"
}
```

Thanks!



---

archive/issue_comments_443755.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-06-20T08:14:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-443755",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_082075.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-06-20T08:14:27Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31338#event-82075"
}
```



---

archive/issue_comments_443756.json:
```json
{
    "body": "A bit late to that party. `sage_setup/setenv.py` is highly \"polluting\" - i.e. it all works but fill my build logs with useless junk\n\n```\n/usr/lib/gcc/x86_64-pc-linux-gnu/10.3.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible /usr/lib/libm.so when searching for -lm\n/usr/lib/gcc/x86_64-pc-linux-gnu/10.3.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible /usr/lib/libm.a when searching for -lm\n/usr/lib/gcc/x86_64-pc-linux-gnu/10.3.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible /usr/lib/libc.so when searching for -lc\n/usr/lib/gcc/x86_64-pc-linux-gnu/10.3.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible /usr/lib/libc.a when searching for -lc\n```\n\nI am trying to follow the logic of the ticket but I fail to see when `SAGE_LOCAL` is not defined, which is the only way to avoid these. In `env.py` we have \n\n```\nSAGE_LOCAL = var(\"SAGE_LOCAL\", SAGE_VENV)\n```\nSo either something from the environment or `SAGE_VENV` and it is defined by\n\n```\nSAGE_VENV = var(\"SAGE_VENV\", os.path.abspath(sys.prefix))\n```\nSo if neither `SAGE_LOCAL` or `SAGE_VENV` is in the environment `SAGE_LOCAL` becomes `os.path.abspath(sys.prefix)`.\n\nI am not sure why the `if SAGE_LOCAL:` conditional is necessary since it is always defined. What I don't see is a way to avoid the content of that block becoming added to the environment.\n\nIs there another ticket that will make `SAGE_LOCAL` default to `None` in some circumstances? Or a process that I overlooked?",
    "created_at": "2021-06-22T23:41:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-443756",
    "user": "https://github.com/kiwifb"
}
```

A bit late to that party. `sage_setup/setenv.py` is highly "polluting" - i.e. it all works but fill my build logs with useless junk

```
/usr/lib/gcc/x86_64-pc-linux-gnu/10.3.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible /usr/lib/libm.so when searching for -lm
/usr/lib/gcc/x86_64-pc-linux-gnu/10.3.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible /usr/lib/libm.a when searching for -lm
/usr/lib/gcc/x86_64-pc-linux-gnu/10.3.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible /usr/lib/libc.so when searching for -lc
/usr/lib/gcc/x86_64-pc-linux-gnu/10.3.0/../../../../x86_64-pc-linux-gnu/bin/ld: skipping incompatible /usr/lib/libc.a when searching for -lc
```

I am trying to follow the logic of the ticket but I fail to see when `SAGE_LOCAL` is not defined, which is the only way to avoid these. In `env.py` we have 

```
SAGE_LOCAL = var("SAGE_LOCAL", SAGE_VENV)
```
So either something from the environment or `SAGE_VENV` and it is defined by

```
SAGE_VENV = var("SAGE_VENV", os.path.abspath(sys.prefix))
```
So if neither `SAGE_LOCAL` or `SAGE_VENV` is in the environment `SAGE_LOCAL` becomes `os.path.abspath(sys.prefix)`.

I am not sure why the `if SAGE_LOCAL:` conditional is necessary since it is always defined. What I don't see is a way to avoid the content of that block becoming added to the environment.

Is there another ticket that will make `SAGE_LOCAL` default to `None` in some circumstances? Or a process that I overlooked?



---

archive/issue_comments_443757.json:
```json
{
    "body": "The idea for distribution packaging would be that `SAGE_LOCAL` will not be set at all, which is why we have the `if SAGE_LOCAL` there.\n\nThat it is always set, by the traditional catch-all defaults in `sage.env`, is a nice catch; let's fix this in #32036.",
    "created_at": "2021-06-23T00:17:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-443757",
    "user": "https://github.com/mkoeppe"
}
```

The idea for distribution packaging would be that `SAGE_LOCAL` will not be set at all, which is why we have the `if SAGE_LOCAL` there.

That it is always set, by the traditional catch-all defaults in `sage.env`, is a nice catch; let's fix this in #32036.



---

archive/issue_comments_443758.json:
```json
{
    "body": "I am OK with eliminating `SAGE_LOCAL` the way `SAGE_ROOT` is virtually extinct but we are not there yet. It still need to be set at runtime for a few things. Some would gain to be replaced by more specific variables. But let's move things to #32036",
    "created_at": "2021-06-23T00:21:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-443758",
    "user": "https://github.com/kiwifb"
}
```

I am OK with eliminating `SAGE_LOCAL` the way `SAGE_ROOT` is virtually extinct but we are not there yet. It still need to be set at runtime for a few things. Some would gain to be replaced by more specific variables. But let's move things to #32036



---

archive/issue_comments_443759.json:
```json
{
    "body": "Let's see if we can solve this problem in a different way. Where is this `incompatible /usr/lib/libm.so` business exactly coming from?",
    "created_at": "2021-06-24T21:42:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-443759",
    "user": "https://github.com/mkoeppe"
}
```

Let's see if we can solve this problem in a different way. Where is this `incompatible /usr/lib/libm.so` business exactly coming from?



---

archive/issue_comments_443760.json:
```json
{
    "body": "Replying to [comment:16 mkoeppe]:\n> Let's see if we can solve this problem in a different way. Where is this `incompatible /usr/lib/libm.so` business exactly coming from?\n\n\nBecause you are add `-L/usr/lib` (and some rpath to boot) at linking time, since `SAGE_LOCAL` is `/usr`. But of of course on my system the correct location is `/usr/lib64`, `/usr/lib` is for 32bit libraries. So, when you add `-L/usr/lib` it looks for the 32bit version of the libraries first before looking for the correct ones in the default location.\n\nIt is not strictly harmful unless you have done something dodgy to your system. I described it as pollution, because my logs gets full of it. Which makes reading them difficult when you are looking for real problems.",
    "created_at": "2021-06-24T21:54:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-443760",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:16 mkoeppe]:
> Let's see if we can solve this problem in a different way. Where is this `incompatible /usr/lib/libm.so` business exactly coming from?


Because you are add `-L/usr/lib` (and some rpath to boot) at linking time, since `SAGE_LOCAL` is `/usr`. But of of course on my system the correct location is `/usr/lib64`, `/usr/lib` is for 32bit libraries. So, when you add `-L/usr/lib` it looks for the 32bit version of the libraries first before looking for the correct ones in the default location.

It is not strictly harmful unless you have done something dodgy to your system. I described it as pollution, because my logs gets full of it. Which makes reading them difficult when you are looking for real problems.



---

archive/issue_comments_443761.json:
```json
{
    "body": "OK, this is essentially the same issue that we were hitting in #31578. Should we be looking for a general way to find the multilib path for situations like this? Perhaps something in `python3 -m sysconfig` gives it?",
    "created_at": "2021-06-24T21:59:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-443761",
    "user": "https://github.com/mkoeppe"
}
```

OK, this is essentially the same issue that we were hitting in #31578. Should we be looking for a general way to find the multilib path for situations like this? Perhaps something in `python3 -m sysconfig` gives it?



---

archive/issue_comments_443762.json:
```json
{
    "body": "It is similar indeed and yes it appears that `python -m sysconfig` has the correct value in `LIBDIR` but we should check on a few setup to make sure.",
    "created_at": "2021-06-24T22:02:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-443762",
    "user": "https://github.com/kiwifb"
}
```

It is similar indeed and yes it appears that `python -m sysconfig` has the correct value in `LIBDIR` but we should check on a few setup to make sure.



---

archive/issue_comments_443763.json:
```json
{
    "body": "Hum, on ubuntu I get `/usr/lib` when I am fairly sure it should be `/usr/lib/x86_64-linux-gnu`.",
    "created_at": "2021-06-24T22:09:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-443763",
    "user": "https://github.com/kiwifb"
}
```

Hum, on ubuntu I get `/usr/lib` when I am fairly sure it should be `/usr/lib/x86_64-linux-gnu`.



---

archive/issue_comments_443764.json:
```json
{
    "body": "This is really annoying, ubuntu systems have a `MULTIARCH` defined where my gentoo system doesn't. But `conda` on ubuntu defines `MULTIARCH` even so it doesn't use it. There must be a better way to get the right info.",
    "created_at": "2021-06-24T22:14:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-443764",
    "user": "https://github.com/kiwifb"
}
```

This is really annoying, ubuntu systems have a `MULTIARCH` defined where my gentoo system doesn't. But `conda` on ubuntu defines `MULTIARCH` even so it doesn't use it. There must be a better way to get the right info.



---

archive/issue_comments_443765.json:
```json
{
    "body": "Another possible solution: #32057",
    "created_at": "2021-06-24T22:28:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31338#issuecomment-443765",
    "user": "https://github.com/mkoeppe"
}
```

Another possible solution: #32057
