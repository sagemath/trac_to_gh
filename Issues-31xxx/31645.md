# Issue 31645: incorrect handling of constant term when creating power series

archive/issues_031408.json:
```json
{
    "body": "As reported by user TBK in [this sage devel thread](https://groups.google.com/g/sage-devel/c/av4L3qQZl0o/m/d-UDze62AQAJ), the `series` method sometimes returns an incorrect power series in which a constant term has erroneously been multiplied by a power of x:\n\n```\n    sage: ((1-sqrt(1-x))/x + 0).series(x,3)\n    1/2 + 1/8*x + 1/16*x^2 + Order(x^3)  # correct\n    sage: ((1-sqrt(1-x))/x + 123).series(x,3)\n    123*x^(-1) + 1/2 + 1/8*x + 1/16*x^2 + Order(x^3)  # wrong !!!\n```\n\nKeywords: pynac, series\n\nBranch/Commit: 1da52de50e4f01c0e4c61c447217ff77c392b352\n\nReviewer: Travis Scrimshaw\n\nAuthor: Dave Morris\n\nDependencies: #31679\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/31645\n\n",
    "closed_at": "2021-04-25T12:14:05Z",
    "created_at": "2021-04-11T04:19:41Z",
    "labels": [
        "component: symbolics",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "incorrect handling of constant term when creating power series",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31645",
    "user": "https://github.com/DaveWitteMorris"
}
```
As reported by user TBK in [this sage devel thread](https://groups.google.com/g/sage-devel/c/av4L3qQZl0o/m/d-UDze62AQAJ), the `series` method sometimes returns an incorrect power series in which a constant term has erroneously been multiplied by a power of x:

```
    sage: ((1-sqrt(1-x))/x + 0).series(x,3)
    1/2 + 1/8*x + 1/16*x^2 + Order(x^3)  # correct
    sage: ((1-sqrt(1-x))/x + 123).series(x,3)
    123*x^(-1) + 1/2 + 1/8*x + 1/16*x^2 + Order(x^3)  # wrong !!!
```

Keywords: pynac, series

Branch/Commit: 1da52de50e4f01c0e4c61c447217ff77c392b352

Reviewer: Travis Scrimshaw

Author: Dave Morris

Dependencies: #31679

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/31645





---

archive/issue_comments_479532.json:
```json
{
    "body": "<a id='comment:1'></a>**Diagnosis:** Laurent polynomials are stored as a pair consisting of a polynomial and an offset `n` that represents multiplication by `x^n`. Pynac's `add::useries` method fails to account for the offset when adding the constant term to a power series.\n\nThis should be easy to fix, so I should be able to upload a PR soon.",
    "created_at": "2021-04-11T04:21:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31645#issuecomment-479532",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:1'></a>**Diagnosis:** Laurent polynomials are stored as a pair consisting of a polynomial and an offset `n` that represents multiplication by `x^n`. Pynac's `add::useries` method fails to account for the offset when adding the constant term to a power series.

This should be easy to fix, so I should be able to upload a PR soon.



---

archive/issue_comments_479533.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-04-11T18:52:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31645#issuecomment-479533",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_479534.json:
```json
{
    "body": "<a id='comment:3'></a>The PR fixes the bug by moving the handling of the constant term to the initialization phase, where the offset is known to be 0.\n\nWith this PR applied, we get the correct result for the example in the ticket description:\n\n```\nsage: ((1-sqrt(1-x))/x + 123).series(x,3)\n247/2 + 1/8*x + 1/16*x^2 + Order(x^3)\n```\nAs a doctest, the PR uses the following very simple example that was also giving a wrong answer:\n\n```\nsage: (x^(-1) + 1).series(x,1)  # wrong answer !!!\n2*x^(-1) + Order(x)\n```\n\nMy recent pynac patches had merge conflicts, but I rebased this one on #31554 (hence the dependency), so I think it should merge cleanly.  Only the last 3 commits come from this ticket (\"trac 31645 handling ...\", \"add doctest\", and \"increment pynac patch level\").\n\nThis is a critical bug, so I hope it can be merged in 9.3.\n\n---\nLast 10 new commits:",
    "created_at": "2021-04-11T18:52:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31645#issuecomment-479534",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:3'></a>The PR fixes the bug by moving the handling of the constant term to the initialization phase, where the offset is known to be 0.

With this PR applied, we get the correct result for the example in the ticket description:

```
sage: ((1-sqrt(1-x))/x + 123).series(x,3)
247/2 + 1/8*x + 1/16*x^2 + Order(x^3)
```
As a doctest, the PR uses the following very simple example that was also giving a wrong answer:

```
sage: (x^(-1) + 1).series(x,1)  # wrong answer !!!
2*x^(-1) + Order(x)
```

My recent pynac patches had merge conflicts, but I rebased this one on #31554 (hence the dependency), so I think it should merge cleanly.  Only the last 3 commits come from this ticket ("trac 31645 handling ...", "add doctest", and "increment pynac patch level").

This is a critical bug, so I hope it can be merged in 9.3.

---
Last 10 new commits:



---

archive/issue_comments_479535.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-04-11T22:52:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31645#issuecomment-479535",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_479536.json:
```json
{
    "body": "<a id='comment:4'></a>LGTM.",
    "created_at": "2021-04-11T22:52:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31645#issuecomment-479536",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:4'></a>LGTM.



---

archive/issue_comments_479537.json:
```json
{
    "body": "<a id='comment:5'></a>Thanks!",
    "created_at": "2021-04-11T23:00:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31645#issuecomment-479537",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:5'></a>Thanks!



---

archive/issue_comments_479538.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2021-04-18T16:13:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31645#issuecomment-479538",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_479539.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2021-04-19T05:11:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31645#issuecomment-479539",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_479540.json:
```json
{
    "body": "<a id='comment:8'></a>Rebased on #31679 (which replaced #31554), and updated the patch version again.\n\n---\nNew commits:",
    "created_at": "2021-04-19T05:11:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31645#issuecomment-479540",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:8'></a>Rebased on #31679 (which replaced #31554), and updated the patch version again.

---
New commits:



---

archive/issue_comments_479541.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-04-19T17:40:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31645#issuecomment-479541",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_083358.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-04-25T12:14:05Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31645",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31645#event-83358"
}
```



---

archive/issue_comments_479542.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-04-25T12:14:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31645",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31645#issuecomment-479542",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
