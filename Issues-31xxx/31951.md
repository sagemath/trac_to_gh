# Issue 31951: Fix `..` ellipsis interference with REPL multiline input

archive/issues_031714.json:
```json
{
    "assignees": [],
    "body": "Using ellipsis syntax `[a .. b]` or `(a .. b)`\ninterferes with multiline block continuation\nin Sage REPL input.\n\nFor reference, after entering the first two lines\nbelow and hitting enter, the prompt is extended\nwith an (auto-indented) third line, as expected:\n\n```\nsage: for n in range(4):\n....:     m = 2*n\n....:\n```\nand the input is evaluated only once the user\neither manually unindents (e.g. with ctrl-A ctrl-K)\nand hits enter, or hits enter twice.\n\nBy contrast, in all cases below, hitting enter\nat the end of the second line evaluates the code\ntyped so far, preventing to type a third line:\n\n```\nsage: for n in (1 .. 3):\n....:     m = 2*n\nsage: for n in [0 .. 3]:\n....:     m = 2*n\nsage: for n in range(4):\n....:     m = (2*n .. 3*n)\nsage: for n in range(4):\n....:     m = [2*n .. 3*n]\n```\n\nFrom an initial report by John Cremona on sage-support:\n\n- [sage-support, 2021-03-22, having trouble entering multiline code](https://groups.google.com/g/sage-support/c/yOeV7UE5Djg)\n\nCC:  @JohnCremona @jcamp0x2a @kliem @slel\n\nComponent: **user interface**\n\nKeywords: **ellipsis, multiline, repl**\n\nAuthor: **Jonathan Kliem, Kwankyu Lee**\n\nBranch/Commit: **[`041aeaa`](https://github.com/sagemath/sagetrac-mirror/commit/041aeaadca1846bf8cda58da7f2e3c35267ab23c)**\n\nReviewer: **Kwankyu Lee, Jonathan Kliem**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/31951_\n\n",
    "closed_at": "2021-10-09T11:10:08Z",
    "created_at": "2021-06-10T12:19:05Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20user%20interface",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.5",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Fix `..` ellipsis interference with REPL multiline input",
    "type": "issue",
    "updated_at": "2021-10-09T11:10:08Z",
    "url": "https://github.com/sagemath/sage/issues/31951",
    "user": "https://github.com/slel"
}
```
Using ellipsis syntax `[a .. b]` or `(a .. b)`
interferes with multiline block continuation
in Sage REPL input.

For reference, after entering the first two lines
below and hitting enter, the prompt is extended
with an (auto-indented) third line, as expected:

```
sage: for n in range(4):
....:     m = 2*n
....:
```
and the input is evaluated only once the user
either manually unindents (e.g. with ctrl-A ctrl-K)
and hits enter, or hits enter twice.

By contrast, in all cases below, hitting enter
at the end of the second line evaluates the code
typed so far, preventing to type a third line:

```
sage: for n in (1 .. 3):
....:     m = 2*n
sage: for n in [0 .. 3]:
....:     m = 2*n
sage: for n in range(4):
....:     m = (2*n .. 3*n)
sage: for n in range(4):
....:     m = [2*n .. 3*n]
```

From an initial report by John Cremona on sage-support:

- [sage-support, 2021-03-22, having trouble entering multiline code](https://groups.google.com/g/sage-support/c/yOeV7UE5Djg)

CC:  @JohnCremona @jcamp0x2a @kliem @slel

Component: **user interface**

Keywords: **ellipsis, multiline, repl**

Author: **Jonathan Kliem, Kwankyu Lee**

Branch/Commit: **[`041aeaa`](https://github.com/sagemath/sagetrac-mirror/commit/041aeaadca1846bf8cda58da7f2e3c35267ab23c)**

Reviewer: **Kwankyu Lee, Jonathan Kliem**

_Issue created by migration from https://trac.sagemath.org/ticket/31951_





---

archive/issue_events_437368.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2021-06-10T12:19:05Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31951#event-437368"
}
```



---

archive/issue_events_437369.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2021-06-10T12:19:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20user%20interface",
    "label_color": "0000b0",
    "label_name": "c: user interface",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31951#event-437369"
}
```



---

archive/issue_events_437370.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2021-06-10T12:19:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31951#event-437370"
}
```



---

archive/issue_events_437371.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2021-06-10T12:19:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31951#event-437371"
}
```



---

archive/issue_events_437372.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-22T20:35:10Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31951#event-437372"
}
```



---

archive/issue_events_437373.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-22T20:35:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31951#event-437373"
}
```



---

archive/issue_comments_514094.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nPossibly related: `<>` creates the same problem, as in\n\n```\nsage: foo(L):\n....:     K.<a> = L\nsage\n```\n\nSee #32523.",
    "created_at": "2021-09-16T08:41:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514094",
    "user": "https://github.com/kliem"
}
```

<div id="comment:2" align="right">comment:2</div>

Possibly related: `<>` creates the same problem, as in

```
sage: foo(L):
....:     K.<a> = L
sage
```

See #32523.



---

archive/issue_comments_514095.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nI guess all of our preparse customizations that are a syntax error in normal python have the same problem:\n\n```\nsage: implicit_multiplication(True)\nsage: def foo():\n....:     b = 2a\n```",
    "created_at": "2021-09-16T09:35:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514095",
    "user": "https://github.com/kliem"
}
```

<div id="comment:3" align="right">comment:3</div>

I guess all of our preparse customizations that are a syntax error in normal python have the same problem:

```
sage: implicit_multiplication(True)
sage: def foo():
....:     b = 2a
```



---

archive/issue_comments_514096.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nFurther problems, not really serious, but it shows problems that one can run into:\n\n```\nsage: a = \"\"\"\n....: sage: Sagemath.\n....: \"\"\"\nsage: a\n'\\nSagemath.\\n'\n```\n\nThe problem is that one needs to cleanup the syntax in `input_transformers_cleanup` instead of \n`input_transformers_post`.",
    "created_at": "2021-09-16T10:01:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514096",
    "user": "https://github.com/kliem"
}
```

<div id="comment:4" align="right">comment:4</div>

Further problems, not really serious, but it shows problems that one can run into:

```
sage: a = """
....: sage: Sagemath.
....: """
sage: a
'\nSagemath.\n'
```

The problem is that one needs to cleanup the syntax in `input_transformers_cleanup` instead of 
`input_transformers_post`.



---

archive/issue_comments_514097.json:
```json
{
    "body": "Commit: **[`d9c4e95`](https://github.com/sagemath/sagetrac-mirror/commit/d9c4e95f8db6ad82291717e822ace7cd68971e51)**",
    "created_at": "2021-09-16T14:16:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514097",
    "user": "https://github.com/kliem"
}
```

Commit: **[`d9c4e95`](https://github.com/sagemath/sagetrac-mirror/commit/d9c4e95f8db6ad82291717e822ace7cd68971e51)**



---

archive/issue_comments_514098.json:
```json
{
    "body": "<div id=\"comment:5\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d9c4e95f8db6ad82291717e822ace7cd68971e51\"><code>d9c4e95</code></a></td><td><code>fix completeness check for sage special syntax</code></td></tr></table>\n",
    "created_at": "2021-09-16T14:16:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514098",
    "user": "https://github.com/kliem"
}
```

<div id="comment:5"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d9c4e95f8db6ad82291717e822ace7cd68971e51"><code>d9c4e95</code></a></td><td><code>fix completeness check for sage special syntax</code></td></tr></table>




---

archive/issue_events_437374.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-09-16T14:16:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31951#event-437374"
}
```



---

archive/issue_comments_514099.json:
```json
{
    "body": "Author: **Jonathan Kliem**",
    "created_at": "2021-09-16T14:16:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514099",
    "user": "https://github.com/kliem"
}
```

Author: **Jonathan Kliem**



---

archive/issue_comments_514100.json:
```json
{
    "body": "Branch: **[public/31951](https://github.com/sagemath/sagetrac-mirror/tree/public/31951)**",
    "created_at": "2021-09-16T14:16:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514100",
    "user": "https://github.com/kliem"
}
```

Branch: **[public/31951](https://github.com/sagemath/sagetrac-mirror/tree/public/31951)**



---

archive/issue_comments_514101.json:
```json
{
    "body": "Changed commit from **[`d9c4e95`](https://github.com/sagemath/sagetrac-mirror/commit/d9c4e95f8db6ad82291717e822ace7cd68971e51)** to **[`8a43093`](https://github.com/sagemath/sagetrac-mirror/commit/8a4309305d5294d487fc0ad993aac8243f6bc1d5)**",
    "created_at": "2021-09-17T00:50:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514101",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`d9c4e95`](https://github.com/sagemath/sagetrac-mirror/commit/d9c4e95f8db6ad82291717e822ace7cd68971e51)** to **[`8a43093`](https://github.com/sagemath/sagetrac-mirror/commit/8a4309305d5294d487fc0ad993aac8243f6bc1d5)**



---

archive/issue_comments_514102.json:
```json
{
    "body": "<div id=\"comment:6\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8a4309305d5294d487fc0ad993aac8243f6bc1d5\"><code>8a43093</code></a></td><td><code>A few cosmetic fixes</code></td></tr></table>\n",
    "created_at": "2021-09-17T00:50:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514102",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:6"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8a4309305d5294d487fc0ad993aac8243f6bc1d5"><code>8a43093</code></a></td><td><code>A few cosmetic fixes</code></td></tr></table>




---

archive/issue_comments_514103.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nI made a few stylistic fixes. Feel free to revert any part if you think irrelevant.\n\nThe patch works well, looks good. \nOne comment on the `syntax_only` argument: It is not clear what *Sage's special syntax* the argument is for. What is the criterion? Isn't this `R.0 -> R.gen(0)` Sage's special syntax?",
    "created_at": "2021-09-17T00:58:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514103",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:7" align="right">comment:7</div>

I made a few stylistic fixes. Feel free to revert any part if you think irrelevant.

The patch works well, looks good. 
One comment on the `syntax_only` argument: It is not clear what *Sage's special syntax* the argument is for. What is the criterion? Isn't this `R.0 -> R.gen(0)` Sage's special syntax?



---

archive/issue_comments_514104.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\n`R.0` is fixed as well.\n\nThere is correct python syntax. Then ipython has some special syntax, like `%time`.\nThen sage has some special syntax.\n\nI would say that special syntax is anything, that gives a `SyntaxError` without modification. So replacing `2` by `Integer(2)` is not special syntax.\nReplacing `2^3` by `2**3` is also not special syntax (and we need really to avoid doing it twice).\n\nI don't know what is a better name for it, but this is really what the bug boils down to:\n\n`IPython.input_transformer_manager.check_complete` checks the syntax as well, which means it must have access to all our special syntax rules.",
    "created_at": "2021-09-17T06:30:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514104",
    "user": "https://github.com/kliem"
}
```

<div id="comment:8" align="right">comment:8</div>

`R.0` is fixed as well.

There is correct python syntax. Then ipython has some special syntax, like `%time`.
Then sage has some special syntax.

I would say that special syntax is anything, that gives a `SyntaxError` without modification. So replacing `2` by `Integer(2)` is not special syntax.
Replacing `2^3` by `2**3` is also not special syntax (and we need really to avoid doing it twice).

I don't know what is a better name for it, but this is really what the bug boils down to:

`IPython.input_transformer_manager.check_complete` checks the syntax as well, which means it must have access to all our special syntax rules.



---

archive/issue_comments_514105.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nReplying to [@kliem](#comment%3A8):\n> I don't know what is a better name for it, but this is really what the bug boils down to:\n> \n> `IPython.input_transformer_manager.check_complete` checks the syntax as well, which means it must have access to all our special syntax rules.\n\nAs I understands it, your code does (added) Sage syntax preparsing down in \"token level\"(`input_transformer_manager` level) keeping out problematic transforms indicated by `syntax_only`, and then does Sage syntax preparing second time after \"token level\". Am I right? \n\nThen wouldn't it be more safe and efficient to do the transforms (ellipsis and generators) that are necessary to kill the bug in the token level and leave the other transforms after that?",
    "created_at": "2021-09-17T09:30:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514105",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:9" align="right">comment:9</div>

Replying to [@kliem](#comment%3A8):
> I don't know what is a better name for it, but this is really what the bug boils down to:
> 
> `IPython.input_transformer_manager.check_complete` checks the syntax as well, which means it must have access to all our special syntax rules.

As I understands it, your code does (added) Sage syntax preparsing down in "token level"(`input_transformer_manager` level) keeping out problematic transforms indicated by `syntax_only`, and then does Sage syntax preparing second time after "token level". Am I right? 

Then wouldn't it be more safe and efficient to do the transforms (ellipsis and generators) that are necessary to kill the bug in the token level and leave the other transforms after that?



---

archive/issue_comments_514106.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nYou are right. It would be better to cleanly seperate those two steps.\n\nHowever, I can't figure it out. It's such a mess...",
    "created_at": "2021-09-17T14:36:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514106",
    "user": "https://github.com/kliem"
}
```

<div id="comment:10" align="right">comment:10</div>

You are right. It would be better to cleanly seperate those two steps.

However, I can't figure it out. It's such a mess...



---

archive/issue_comments_514107.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nWe could also clean this all up and do it more ipython style instead of string replacment.\n\nThis would simplify a lot of things. E.g. the tokens treat multiline strings as one line, without further interaction. They also treat implicit and explicit line continuation almost the same.\n\nIn this case I would try to replace the `preparse` function in the interactive shell and then as a last step replace preparse by the appropriate steps in ipython, so that loading a file `*.sage` is really the same thing as parsing it all in sage.",
    "created_at": "2021-09-17T15:34:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514107",
    "user": "https://github.com/kliem"
}
```

<div id="comment:11" align="right">comment:11</div>

We could also clean this all up and do it more ipython style instead of string replacment.

This would simplify a lot of things. E.g. the tokens treat multiline strings as one line, without further interaction. They also treat implicit and explicit line continuation almost the same.

In this case I would try to replace the `preparse` function in the interactive shell and then as a last step replace preparse by the appropriate steps in ipython, so that loading a file `*.sage` is really the same thing as parsing it all in sage.



---

archive/issue_comments_514108.json:
```json
{
    "body": "<div id=\"comment:12\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c0c081940c89a198e6cde9020ae9abd6dfd442e0\"><code>c0c0819</code></a></td><td><code>document one more fix</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/99af688e4125f4c0bf0a826ec70ffb6fe6f62b28\"><code>99af688</code></a></td><td><code>fix doc build</code></td></tr></table>\n",
    "created_at": "2021-09-20T07:27:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514108",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:12"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c0c081940c89a198e6cde9020ae9abd6dfd442e0"><code>c0c0819</code></a></td><td><code>document one more fix</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/99af688e4125f4c0bf0a826ec70ffb6fe6f62b28"><code>99af688</code></a></td><td><code>fix doc build</code></td></tr></table>




---

archive/issue_comments_514109.json:
```json
{
    "body": "Changed commit from **[`8a43093`](https://github.com/sagemath/sagetrac-mirror/commit/8a4309305d5294d487fc0ad993aac8243f6bc1d5)** to **[`99af688`](https://github.com/sagemath/sagetrac-mirror/commit/99af688e4125f4c0bf0a826ec70ffb6fe6f62b28)**",
    "created_at": "2021-09-20T07:27:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514109",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`8a43093`](https://github.com/sagemath/sagetrac-mirror/commit/8a4309305d5294d487fc0ad993aac8243f6bc1d5)** to **[`99af688`](https://github.com/sagemath/sagetrac-mirror/commit/99af688e4125f4c0bf0a826ec70ffb6fe6f62b28)**



---

archive/issue_comments_514110.json:
```json
{
    "body": "Work Issues: **close #4545?**",
    "created_at": "2021-09-23T10:59:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514110",
    "user": "https://github.com/kliem"
}
```

Work Issues: **close #4545?**



---

archive/issue_comments_514111.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nI'm reworking the preparses to fix this.",
    "created_at": "2021-09-23T10:59:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514111",
    "user": "https://github.com/kliem"
}
```

<div id="comment:13" align="right">comment:13</div>

I'm reworking the preparses to fix this.



---

archive/issue_events_437375.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-09-23T10:59:01Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31951#event-437375"
}
```



---

archive/issue_events_437376.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-09-23T10:59:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31951#event-437376"
}
```



---

archive/issue_comments_514112.json:
```json
{
    "body": "Changed work issues from **close #4545?** to **close #4545 and #30953**",
    "created_at": "2021-09-24T06:41:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514112",
    "user": "https://github.com/kliem"
}
```

Changed work issues from **close #4545?** to **close #4545 and #30953**



---

archive/issue_comments_514113.json:
```json
{
    "body": "Changed commit from **[`99af688`](https://github.com/sagemath/sagetrac-mirror/commit/99af688e4125f4c0bf0a826ec70ffb6fe6f62b28)** to **[`9e7c480`](https://github.com/sagemath/sagetrac-mirror/commit/9e7c480c43ef491f92d90c4eb2775f98b6045ba8)**",
    "created_at": "2021-09-24T06:41:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514113",
    "user": "https://github.com/kliem"
}
```

Changed commit from **[`99af688`](https://github.com/sagemath/sagetrac-mirror/commit/99af688e4125f4c0bf0a826ec70ffb6fe6f62b28)** to **[`9e7c480`](https://github.com/sagemath/sagetrac-mirror/commit/9e7c480c43ef491f92d90c4eb2775f98b6045ba8)**



---

archive/issue_events_437377.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-09-24T06:41:41Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31951#event-437377"
}
```



---

archive/issue_events_437378.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-09-24T06:41:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31951#event-437378"
}
```



---

archive/issue_comments_514114.json:
```json
{
    "body": "Changed branch from **[public/31951](https://github.com/sagemath/sagetrac-mirror/tree/public/31951)** to **[public/31951-new](https://github.com/sagemath/sagetrac-mirror/tree/public/31951-new)**",
    "created_at": "2021-09-24T06:41:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514114",
    "user": "https://github.com/kliem"
}
```

Changed branch from **[public/31951](https://github.com/sagemath/sagetrac-mirror/tree/public/31951)** to **[public/31951-new](https://github.com/sagemath/sagetrac-mirror/tree/public/31951-new)**



---

archive/issue_comments_514115.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nThe major changes are the following:\n\n- Instead of worrying about `quote_state`, we require that all the lines are given at once into `preparse_multiple_lines`.\n- We add `preparse_multiple_lines` to `cleanup_transformers`.\n- We remove `preparse` from `input_transformers_post`.\n- The following are now handled via token transformers instead:\n  - Backslash division `B \\ C`.\n  - Generator construction `K.<a> = QuadraticField(2)`.\n  - Calculus like function assigment `f(x) = (x + 1)`.\n\nWe add a couple of deprecations.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9e7c480c43ef491f92d90c4eb2775f98b6045ba8\"><code>9e7c480</code></a></td><td><code>rework Sages input preparse, such that the syntax is valid after applying cleanup and token transformers</code></td></tr></table>\n",
    "created_at": "2021-09-24T06:41:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514115",
    "user": "https://github.com/kliem"
}
```

<div id="comment:14" align="right">comment:14</div>

The major changes are the following:

- Instead of worrying about `quote_state`, we require that all the lines are given at once into `preparse_multiple_lines`.
- We add `preparse_multiple_lines` to `cleanup_transformers`.
- We remove `preparse` from `input_transformers_post`.
- The following are now handled via token transformers instead:
  - Backslash division `B \ C`.
  - Generator construction `K.<a> = QuadraticField(2)`.
  - Calculus like function assigment `f(x) = (x + 1)`.

We add a couple of deprecations.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9e7c480c43ef491f92d90c4eb2775f98b6045ba8"><code>9e7c480</code></a></td><td><code>rework Sages input preparse, such that the syntax is valid after applying cleanup and token transformers</code></td></tr></table>




---

archive/issue_comments_514116.json:
```json
{
    "body": "<div id=\"comment:15\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/db167ddc3c35b6ddbb61f97c7233c2f6d18d005e\"><code>db167dd</code></a></td><td><code>correct ticket number</code></td></tr></table>\n",
    "created_at": "2021-09-24T14:59:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514116",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:15"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/db167ddc3c35b6ddbb61f97c7233c2f6d18d005e"><code>db167dd</code></a></td><td><code>correct ticket number</code></td></tr></table>




---

archive/issue_comments_514117.json:
```json
{
    "body": "Changed commit from **[`9e7c480`](https://github.com/sagemath/sagetrac-mirror/commit/9e7c480c43ef491f92d90c4eb2775f98b6045ba8)** to **[`db167dd`](https://github.com/sagemath/sagetrac-mirror/commit/db167ddc3c35b6ddbb61f97c7233c2f6d18d005e)**",
    "created_at": "2021-09-24T14:59:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514117",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`9e7c480`](https://github.com/sagemath/sagetrac-mirror/commit/9e7c480c43ef491f92d90c4eb2775f98b6045ba8)** to **[`db167dd`](https://github.com/sagemath/sagetrac-mirror/commit/db167ddc3c35b6ddbb61f97c7233c2f6d18d005e)**



---

archive/issue_comments_514118.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@kwankyu](#comment%3A9):\n> Replying to [@kliem](#comment%3A8):\n> > I don't know what is a better name for it, but this is really what the bug boils down to:\n> > \n> > `IPython.input_transformer_manager.check_complete` checks the syntax as well, which means it must have access to all our special syntax rules.\n\n> \n> As I understands it, your code does (added) Sage syntax preparsing down in \"token level\"(`input_transformer_manager` level) keeping out problematic transforms indicated by `syntax_only`, and then does Sage syntax preparing second time after \"token level\". Am I right? \n> \n> Then wouldn't it be more safe and efficient to do the transforms (ellipsis and generators) that are necessary to kill the bug in the token level and leave the other transforms after that?\n\nThing is that almost all our changes affect the syntax and need to be done before `input_transformers_post`. We could do all of them just in `cleanup_transformers`, but that makes it difficult resolving things like #30953.",
    "created_at": "2021-09-24T20:17:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514118",
    "user": "https://github.com/kliem"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@kwankyu](#comment%3A9):
> Replying to [@kliem](#comment%3A8):
> > I don't know what is a better name for it, but this is really what the bug boils down to:
> > 
> > `IPython.input_transformer_manager.check_complete` checks the syntax as well, which means it must have access to all our special syntax rules.

> 
> As I understands it, your code does (added) Sage syntax preparsing down in "token level"(`input_transformer_manager` level) keeping out problematic transforms indicated by `syntax_only`, and then does Sage syntax preparing second time after "token level". Am I right? 
> 
> Then wouldn't it be more safe and efficient to do the transforms (ellipsis and generators) that are necessary to kill the bug in the token level and leave the other transforms after that?

Thing is that almost all our changes affect the syntax and need to be done before `input_transformers_post`. We could do all of them just in `cleanup_transformers`, but that makes it difficult resolving things like #30953.



---

archive/issue_comments_514119.json:
```json
{
    "body": "Changed branch from **[public/31951-new](https://github.com/sagemath/sagetrac-mirror/tree/public/31951-new)** to **[public/31951](https://github.com/sagemath/sagetrac-mirror/tree/public/31951)**",
    "created_at": "2021-09-27T04:07:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514119",
    "user": "https://github.com/kwankyu"
}
```

Changed branch from **[public/31951-new](https://github.com/sagemath/sagetrac-mirror/tree/public/31951-new)** to **[public/31951](https://github.com/sagemath/sagetrac-mirror/tree/public/31951)**



---

archive/issue_comments_514120.json:
```json
{
    "body": "<div id=\"comment:17\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9a5362a31c63d53c16cb62c33b990e91308aa114\"><code>9a5362a</code></a></td><td><code>Stylistic fixes</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b4655134f36d64649b5b7676add2c986e2a02766\"><code>b465513</code></a></td><td><code>Transfer doctests</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3d8655472435a8af62658b884d9599c60037e5f1\"><code>3d86554</code></a></td><td><code>Revert deprecations</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/fe36d2eb8473849d87bc1b36e458d05a7db60996\"><code>fe36d2e</code></a></td><td><code>Merge branch 'develop' into trac31951</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5a7b172568acad1f2ea868608139a946df73a65e\"><code>5a7b172</code></a></td><td><code>Remove unnecessary preparse_ipython</code></td></tr></table>\n",
    "created_at": "2021-09-27T04:07:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514120",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:17"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9a5362a31c63d53c16cb62c33b990e91308aa114"><code>9a5362a</code></a></td><td><code>Stylistic fixes</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b4655134f36d64649b5b7676add2c986e2a02766"><code>b465513</code></a></td><td><code>Transfer doctests</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3d8655472435a8af62658b884d9599c60037e5f1"><code>3d86554</code></a></td><td><code>Revert deprecations</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/fe36d2eb8473849d87bc1b36e458d05a7db60996"><code>fe36d2e</code></a></td><td><code>Merge branch 'develop' into trac31951</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5a7b172568acad1f2ea868608139a946df73a65e"><code>5a7b172</code></a></td><td><code>Remove unnecessary preparse_ipython</code></td></tr></table>




---

archive/issue_comments_514121.json:
```json
{
    "body": "Changed commit from **[`db167dd`](https://github.com/sagemath/sagetrac-mirror/commit/db167ddc3c35b6ddbb61f97c7233c2f6d18d005e)** to **[`5a7b172`](https://github.com/sagemath/sagetrac-mirror/commit/5a7b172568acad1f2ea868608139a946df73a65e)**",
    "created_at": "2021-09-27T04:07:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514121",
    "user": "https://github.com/kwankyu"
}
```

Changed commit from **[`db167dd`](https://github.com/sagemath/sagetrac-mirror/commit/db167ddc3c35b6ddbb61f97c7233c2f6d18d005e)** to **[`5a7b172`](https://github.com/sagemath/sagetrac-mirror/commit/5a7b172568acad1f2ea868608139a946df73a65e)**



---

archive/issue_comments_514122.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nI made some commits based on your latest work.\n\nMy main concern with your work was that it introduced some nontrivial regressions regarding `.sage` files (not working `time` and `load/attach` in file, for instance) by deprecating old `preparse` stuffs. My commits recover regressions.\n\nIt works well for me. I am positive on your work. But I think the patch still needs extensive tests.",
    "created_at": "2021-09-27T04:28:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514122",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:18" align="right">comment:18</div>

I made some commits based on your latest work.

My main concern with your work was that it introduced some nontrivial regressions regarding `.sage` files (not working `time` and `load/attach` in file, for instance) by deprecating old `preparse` stuffs. My commits recover regressions.

It works well for me. I am positive on your work. But I think the patch still needs extensive tests.



---

archive/issue_comments_514123.json:
```json
{
    "body": "Reviewer: **Kwankyu Lee**",
    "created_at": "2021-09-27T04:31:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514123",
    "user": "https://github.com/kwankyu"
}
```

Reviewer: **Kwankyu Lee**



---

archive/issue_comments_514124.json:
```json
{
    "body": "Changed commit from **[`5a7b172`](https://github.com/sagemath/sagetrac-mirror/commit/5a7b172568acad1f2ea868608139a946df73a65e)** to **[`bc81873`](https://github.com/sagemath/sagetrac-mirror/commit/bc8187324de61ff24581d665d4254214133d96f2)**",
    "created_at": "2021-09-27T04:34:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514124",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`5a7b172`](https://github.com/sagemath/sagetrac-mirror/commit/5a7b172568acad1f2ea868608139a946df73a65e)** to **[`bc81873`](https://github.com/sagemath/sagetrac-mirror/commit/bc8187324de61ff24581d665d4254214133d96f2)**



---

archive/issue_comments_514125.json:
```json
{
    "body": "<div id=\"comment:20\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bc8187324de61ff24581d665d4254214133d96f2\"><code>bc81873</code></a></td><td><code>Fix a doctest failure</code></td></tr></table>\n",
    "created_at": "2021-09-27T04:34:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514125",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:20"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bc8187324de61ff24581d665d4254214133d96f2"><code>bc81873</code></a></td><td><code>Fix a doctest failure</code></td></tr></table>




---

archive/issue_comments_514126.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nQuestion:\n\nYou deprecated `InterfaceShellTransformer` and `interface_shell_embed`. I don't understand these stuffs well, and have concerns whether deprecating them is safe. Would you explain?",
    "created_at": "2021-09-27T06:21:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514126",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:21" align="right">comment:21</div>

Question:

You deprecated `InterfaceShellTransformer` and `interface_shell_embed`. I don't understand these stuffs well, and have concerns whether deprecating them is safe. Would you explain?



---

archive/issue_comments_514127.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nReplying to [@kwankyu](#comment%3A21):\n> Question:\n> \n> You deprecated `InterfaceShellTransformer` and `interface_shell_embed`. I don't understand these stuffs well, and have concerns whether deprecating them is safe. Would you explain?\n\nI have no idea what this is used for or who uses it. It should definitely undergo questions in sage-devel, whether this can be deprecated or whether this needs to be adapted.",
    "created_at": "2021-09-27T10:42:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514127",
    "user": "https://github.com/kliem"
}
```

<div id="comment:22" align="right">comment:22</div>

Replying to [@kwankyu](#comment%3A21):
> Question:
> 
> You deprecated `InterfaceShellTransformer` and `interface_shell_embed`. I don't understand these stuffs well, and have concerns whether deprecating them is safe. Would you explain?

I have no idea what this is used for or who uses it. It should definitely undergo questions in sage-devel, whether this can be deprecated or whether this needs to be adapted.



---

archive/issue_comments_514128.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nReplying to [@kwankyu](#comment%3A18):\n> I made some commits based on your latest work.\n> \n> My main concern with your work was that it introduced some nontrivial regressions regarding `.sage` files (not working `time` and `load/attach` in file, for instance) by deprecating old `preparse` stuffs. My commits recover regressions.\n> \n> It works well for me. I am positive on your work. But I think the patch still needs extensive tests.\n\nInstead of doing the token now, we could also leave them for #30953. This should make this ticket here easier.\n\n`time` is working in `.sage`. What isn't working anymore is automagic. But automagic isn't meant for multiline things and thus is really a strange concept for files. Line- and cell-magic should be working just fine. (Cell-magic is also a bit strange, as it cannot be exited.) Line-magic wasn't working before in `.sage`-files.\n\nBut yes, this is a regression.",
    "created_at": "2021-09-27T10:48:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514128",
    "user": "https://github.com/kliem"
}
```

<div id="comment:23" align="right">comment:23</div>

Replying to [@kwankyu](#comment%3A18):
> I made some commits based on your latest work.
> 
> My main concern with your work was that it introduced some nontrivial regressions regarding `.sage` files (not working `time` and `load/attach` in file, for instance) by deprecating old `preparse` stuffs. My commits recover regressions.
> 
> It works well for me. I am positive on your work. But I think the patch still needs extensive tests.

Instead of doing the token now, we could also leave them for #30953. This should make this ticket here easier.

`time` is working in `.sage`. What isn't working anymore is automagic. But automagic isn't meant for multiline things and thus is really a strange concept for files. Line- and cell-magic should be working just fine. (Cell-magic is also a bit strange, as it cannot be exited.) Line-magic wasn't working before in `.sage`-files.

But yes, this is a regression.



---

archive/issue_comments_514129.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nReplying to [@kliem](#comment%3A22):\n> Replying to [@kwankyu](#comment%3A21):\n> > Question:\n> > \n> > You deprecated `InterfaceShellTransformer` and `interface_shell_embed`. I don't understand these stuffs well, and have concerns whether deprecating them is safe. Would you explain?\n\n> \n> I have no idea what this is used for or who uses it. \n\nIf so and if they do not do any harm, I think it is safe to leave them intact.",
    "created_at": "2021-09-27T12:38:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514129",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:24" align="right">comment:24</div>

Replying to [@kliem](#comment%3A22):
> Replying to [@kwankyu](#comment%3A21):
> > Question:
> > 
> > You deprecated `InterfaceShellTransformer` and `interface_shell_embed`. I don't understand these stuffs well, and have concerns whether deprecating them is safe. Would you explain?

> 
> I have no idea what this is used for or who uses it. 

If so and if they do not do any harm, I think it is safe to leave them intact.



---

archive/issue_comments_514130.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nReplying to [@kliem](#comment%3A23):\n \n> `time` is working in `.sage`. \n\nYes, now. It stopped working with your patch.\n\n> What isn't working anymore is automagic. But automagic isn't meant for multiline things and thus is really a strange concept for files. Line- and cell-magic should be working just fine. (Cell-magic is also a bit strange, as it cannot be exited.) Line-magic wasn't working before in `.sage`-files.\n\nI think any of those magic things is not for `.sage` files. Even though any one works by accident, we don't need to support it.",
    "created_at": "2021-09-27T12:52:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514130",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:25" align="right">comment:25</div>

Replying to [@kliem](#comment%3A23):
 
> `time` is working in `.sage`. 

Yes, now. It stopped working with your patch.

> What isn't working anymore is automagic. But automagic isn't meant for multiline things and thus is really a strange concept for files. Line- and cell-magic should be working just fine. (Cell-magic is also a bit strange, as it cannot be exited.) Line-magic wasn't working before in `.sage`-files.

I think any of those magic things is not for `.sage` files. Even though any one works by accident, we don't need to support it.



---

archive/issue_comments_514131.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nReplying to [@kliem](#comment%3A23):\n\n> Instead of doing the token now, we could also leave them for #30953. This should make this ticket here easier.\n\n#30953 is fixed by the patch here both on command line and in `.sage` file. We can just close #30953 after the present ticket.",
    "created_at": "2021-09-27T12:56:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514131",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:26" align="right">comment:26</div>

Replying to [@kliem](#comment%3A23):

> Instead of doing the token now, we could also leave them for #30953. This should make this ticket here easier.

#30953 is fixed by the patch here both on command line and in `.sage` file. We can just close #30953 after the present ticket.



---

archive/issue_comments_514132.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nReplying to [@kliem](#comment%3A23):\n> > My main concern with your work was that it introduced some nontrivial regressions regarding `.sage` files (not working `time` and `load/attach` in file, for instance) by deprecating old `preparse` stuffs. My commits recover regressions.\n\n`time` and `load/attach` are Sage things for `.sage` files. They are not ipython magics.",
    "created_at": "2021-09-27T13:10:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514132",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:27" align="right">comment:27</div>

Replying to [@kliem](#comment%3A23):
> > My main concern with your work was that it introduced some nontrivial regressions regarding `.sage` files (not working `time` and `load/attach` in file, for instance) by deprecating old `preparse` stuffs. My commits recover regressions.

`time` and `load/attach` are Sage things for `.sage` files. They are not ipython magics.



---

archive/issue_comments_514133.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nReplying to [@kliem](#comment%3A11):\n> ... so that loading a file `*.sage` is really the same thing as parsing it all in sage.\n\nWe should not pursue this. Loading a `.sage` file needs not be the same thing as typing them in Sage command line. Indeed, code for loading a `.sage` file does some clever things to speed up running the code in the file, which are not done on command line.",
    "created_at": "2021-09-27T13:20:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514133",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:28" align="right">comment:28</div>

Replying to [@kliem](#comment%3A11):
> ... so that loading a file `*.sage` is really the same thing as parsing it all in sage.

We should not pursue this. Loading a `.sage` file needs not be the same thing as typing them in Sage command line. Indeed, code for loading a `.sage` file does some clever things to speed up running the code in the file, which are not done on command line.



---

archive/issue_comments_514134.json:
```json
{
    "body": "Changed branch from **[public/31951](https://github.com/sagemath/sagetrac-mirror/tree/public/31951)** to **[public/31951-new](https://github.com/sagemath/sagetrac-mirror/tree/public/31951-new)**",
    "created_at": "2021-09-27T13:44:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514134",
    "user": "https://github.com/kliem"
}
```

Changed branch from **[public/31951](https://github.com/sagemath/sagetrac-mirror/tree/public/31951)** to **[public/31951-new](https://github.com/sagemath/sagetrac-mirror/tree/public/31951-new)**



---

archive/issue_comments_514135.json:
```json
{
    "body": "Changed commit from **[`bc81873`](https://github.com/sagemath/sagetrac-mirror/commit/bc8187324de61ff24581d665d4254214133d96f2)** to **[`db167dd`](https://github.com/sagemath/sagetrac-mirror/commit/db167ddc3c35b6ddbb61f97c7233c2f6d18d005e)**",
    "created_at": "2021-09-27T13:44:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514135",
    "user": "https://github.com/kliem"
}
```

Changed commit from **[`bc81873`](https://github.com/sagemath/sagetrac-mirror/commit/bc8187324de61ff24581d665d4254214133d96f2)** to **[`db167dd`](https://github.com/sagemath/sagetrac-mirror/commit/db167ddc3c35b6ddbb61f97c7233c2f6d18d005e)**



---

archive/issue_comments_514136.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nSorry for taking your time. I didn't realize until now, that I didn't change the branch yet to the new approach. Hence my comments didn't make a lot of sense to you.",
    "created_at": "2021-09-27T13:45:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514136",
    "user": "https://github.com/kliem"
}
```

<div id="comment:30" align="right">comment:30</div>

Sorry for taking your time. I didn't realize until now, that I didn't change the branch yet to the new approach. Hence my comments didn't make a lot of sense to you.



---

archive/issue_comments_514137.json:
```json
{
    "body": "<div id=\"comment:31\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d372575c4254b46d8047a87f371200a516dbf2f3\"><code>d372575</code></a></td><td><code>do not deprecate InterfaceShellTransformer</code></td></tr></table>\n",
    "created_at": "2021-09-27T13:50:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514137",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:31"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d372575c4254b46d8047a87f371200a516dbf2f3"><code>d372575</code></a></td><td><code>do not deprecate InterfaceShellTransformer</code></td></tr></table>




---

archive/issue_comments_514138.json:
```json
{
    "body": "Changed commit from **[`db167dd`](https://github.com/sagemath/sagetrac-mirror/commit/db167ddc3c35b6ddbb61f97c7233c2f6d18d005e)** to **[`d372575`](https://github.com/sagemath/sagetrac-mirror/commit/d372575c4254b46d8047a87f371200a516dbf2f3)**",
    "created_at": "2021-09-27T13:50:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514138",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`db167dd`](https://github.com/sagemath/sagetrac-mirror/commit/db167ddc3c35b6ddbb61f97c7233c2f6d18d005e)** to **[`d372575`](https://github.com/sagemath/sagetrac-mirror/commit/d372575c4254b46d8047a87f371200a516dbf2f3)**



---

archive/issue_comments_514139.json:
```json
{
    "body": "<div id=\"comment:32\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5fb96b04218e8eff9c0ea37ab19c4bf92a7994c9\"><code>5fb96b0</code></a></td><td><code>make doctest stable</code></td></tr></table>\n",
    "created_at": "2021-09-27T14:21:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514139",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:32"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5fb96b04218e8eff9c0ea37ab19c4bf92a7994c9"><code>5fb96b0</code></a></td><td><code>make doctest stable</code></td></tr></table>




---

archive/issue_comments_514140.json:
```json
{
    "body": "Changed commit from **[`d372575`](https://github.com/sagemath/sagetrac-mirror/commit/d372575c4254b46d8047a87f371200a516dbf2f3)** to **[`5fb96b0`](https://github.com/sagemath/sagetrac-mirror/commit/5fb96b04218e8eff9c0ea37ab19c4bf92a7994c9)**",
    "created_at": "2021-09-27T14:21:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514140",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`d372575`](https://github.com/sagemath/sagetrac-mirror/commit/d372575c4254b46d8047a87f371200a516dbf2f3)** to **[`5fb96b0`](https://github.com/sagemath/sagetrac-mirror/commit/5fb96b04218e8eff9c0ea37ab19c4bf92a7994c9)**



---

archive/issue_comments_514141.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nFixing #30953 seperate from this ticket, will not work without extra work, as the following doctest already assumes that ipythons preparse detected the implicit line continuation:\n\n```\n        sage: preparse(\"a \\\\ b \\\\\") # There is really only one backslash here, it is just being escaped.\n        'a  * BackslashOperator() * b \\\\'\n```\n\n```\n        sage: preparse('''\n        ....: f(a,\n        ....:   b,\n        ....:   c,\n        ....:   d) = a + b*2 + c*3 + d*4\n        ....: ''')\n        '__tmp__ = var(\"a,b,c,d\"); __tmpf__ = a + b*Integer(2) + c*Integer(3) + d*Integer(4); f = symbolic_expression(__tmpf__).function(a,b,c,d)\\n'\n```\n\nSo, I would argue that it makes sense to introduce the following classes during this ticket:\n- `SageBackslashTransformer`,\n- `SageGenConstructionTransformer`,\n- `SageCalculusTransformer`.",
    "created_at": "2021-09-27T14:33:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514141",
    "user": "https://github.com/kliem"
}
```

<div id="comment:33" align="right">comment:33</div>

Fixing #30953 seperate from this ticket, will not work without extra work, as the following doctest already assumes that ipythons preparse detected the implicit line continuation:

```
        sage: preparse("a \\ b \\") # There is really only one backslash here, it is just being escaped.
        'a  * BackslashOperator() * b \\'
```

```
        sage: preparse('''
        ....: f(a,
        ....:   b,
        ....:   c,
        ....:   d) = a + b*2 + c*3 + d*4
        ....: ''')
        '__tmp__ = var("a,b,c,d"); __tmpf__ = a + b*Integer(2) + c*Integer(3) + d*Integer(4); f = symbolic_expression(__tmpf__).function(a,b,c,d)\n'
```

So, I would argue that it makes sense to introduce the following classes during this ticket:
- `SageBackslashTransformer`,
- `SageGenConstructionTransformer`,
- `SageCalculusTransformer`.



---

archive/issue_comments_514142.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nAutomagic could be fixed by a replacement as follows:\n\nReplace `time -2` by\n`sage_eval(\"%time -2\", globals()) if 'time' not in globals() else sage_eval(\"time -2\", globals())`\n\nDoes this sound plausible? Do this for every magic keyword.",
    "created_at": "2021-09-27T14:39:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514142",
    "user": "https://github.com/kliem"
}
```

<div id="comment:34" align="right">comment:34</div>

Automagic could be fixed by a replacement as follows:

Replace `time -2` by
`sage_eval("%time -2", globals()) if 'time' not in globals() else sage_eval("time -2", globals())`

Does this sound plausible? Do this for every magic keyword.



---

archive/issue_comments_514143.json:
```json
{
    "body": "Changed commit from **[`5fb96b0`](https://github.com/sagemath/sagetrac-mirror/commit/5fb96b04218e8eff9c0ea37ab19c4bf92a7994c9)** to **[`126ef4f`](https://github.com/sagemath/sagetrac-mirror/commit/126ef4f04fef813f41d0536c94c18215419c1588)**",
    "created_at": "2021-09-27T19:44:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514143",
    "user": "https://github.com/kliem"
}
```

Changed commit from **[`5fb96b0`](https://github.com/sagemath/sagetrac-mirror/commit/5fb96b04218e8eff9c0ea37ab19c4bf92a7994c9)** to **[`126ef4f`](https://github.com/sagemath/sagetrac-mirror/commit/126ef4f04fef813f41d0536c94c18215419c1588)**



---

archive/issue_comments_514144.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nSorry about the mess.\n\nThis is a much simpler fix. It just creates a second input manager that does Sage's preparsing to check correctness of Sage's syntax. It does not behave as desired with magics, e.g.\n\n```\nsage: ip = get_ipython()\nsage: ip._check_complete_transformer.transform_cell(\"%time 8^^1\")\n\"get_ipython().run_line_magic('time', 'Integer(8)^Integer(1)')\\n\"\n```\nwhich means it would preparse things after `%time` twice, but it's sole purpose is to check the correctness of syntax, for which it works just fine.\n\nWith the new approach I would like the following follow ups:\n- close #4545 with a doctest\n- have preparse and preparse_file call `ip.transform_cell`, which means the code will behave exactly as if parsed into the interactive shell (move the code from preparse to a helper function then)\n- #30953: do generator construction and calculus like assignment with token transformation\n \n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/126ef4f04fef813f41d0536c94c18215419c1588\"><code>126ef4f</code></a></td><td><code>very simple fix for 31951</code></td></tr></table>\n",
    "created_at": "2021-09-27T19:44:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514144",
    "user": "https://github.com/kliem"
}
```

<div id="comment:35" align="right">comment:35</div>

Sorry about the mess.

This is a much simpler fix. It just creates a second input manager that does Sage's preparsing to check correctness of Sage's syntax. It does not behave as desired with magics, e.g.

```
sage: ip = get_ipython()
sage: ip._check_complete_transformer.transform_cell("%time 8^^1")
"get_ipython().run_line_magic('time', 'Integer(8)^Integer(1)')\n"
```
which means it would preparse things after `%time` twice, but it's sole purpose is to check the correctness of syntax, for which it works just fine.

With the new approach I would like the following follow ups:
- close #4545 with a doctest
- have preparse and preparse_file call `ip.transform_cell`, which means the code will behave exactly as if parsed into the interactive shell (move the code from preparse to a helper function then)
- #30953: do generator construction and calculus like assignment with token transformation
 
---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/126ef4f04fef813f41d0536c94c18215419c1588"><code>126ef4f</code></a></td><td><code>very simple fix for 31951</code></td></tr></table>




---

archive/issue_comments_514145.json:
```json
{
    "body": "Changed branch from **[public/31951-new](https://github.com/sagemath/sagetrac-mirror/tree/public/31951-new)** to **[public/31951-new2](https://github.com/sagemath/sagetrac-mirror/tree/public/31951-new2)**",
    "created_at": "2021-09-27T19:44:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514145",
    "user": "https://github.com/kliem"
}
```

Changed branch from **[public/31951-new](https://github.com/sagemath/sagetrac-mirror/tree/public/31951-new)** to **[public/31951-new2](https://github.com/sagemath/sagetrac-mirror/tree/public/31951-new2)**



---

archive/issue_comments_514146.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nReplying to [@kliem](#comment%3A30):\n> Sorry for taking your time. I didn't realize until now, that I didn't change the branch yet to the new approach. Hence my comments didn't make a lot of sense to you.\n\nWhat is a mess seems our miscommunication :-)\n\nYes, you did push your new approach! It fixed a lot of things, and I was happy with that.",
    "created_at": "2021-09-27T19:52:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514146",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:36" align="right">comment:36</div>

Replying to [@kliem](#comment%3A30):
> Sorry for taking your time. I didn't realize until now, that I didn't change the branch yet to the new approach. Hence my comments didn't make a lot of sense to you.

What is a mess seems our miscommunication :-)

Yes, you did push your new approach! It fixed a lot of things, and I was happy with that.



---

archive/issue_comments_514147.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nReplying to [@kliem](#comment%3A33):\n> Fixing #30953 seperate from this ticket, will not work without extra work, as the following doctest already assumes that ipythons preparse detected the implicit line continuation:\n> \n> ```\n>         sage: preparse(\"a \\\\ b \\\\\") # There is really only one backslash here, it is just being escaped.\n>         'a  * BackslashOperator() * b \\\\'\n> ```\n> \n> ```\n>         sage: preparse('''\n>         ....: f(a,\n>         ....:   b,\n>         ....:   c,\n>         ....:   d) = a + b*2 + c*3 + d*4\n>         ....: ''')\n>         '__tmp__ = var(\"a,b,c,d\"); __tmpf__ = a + b*Integer(2) + c*Integer(3) + d*Integer(4); f = symbolic_expression(__tmpf__).function(a,b,c,d)\\n'\n> ```\n> \n> So, I would argue that it makes sense to introduce the following classes during this ticket:\n> - `SageBackslashTransformer`,\n> - `SageGenConstructionTransformer`,\n> - `SageCalculusTransformer`.\n\nYou did introduce these classes in the branch of new approach. Your branch fixed the things above. Then I started working on your branch (with those new classes) because there were regressions in loading `.sage` files.",
    "created_at": "2021-09-27T19:58:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514147",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:37" align="right">comment:37</div>

Replying to [@kliem](#comment%3A33):
> Fixing #30953 seperate from this ticket, will not work without extra work, as the following doctest already assumes that ipythons preparse detected the implicit line continuation:
> 
> ```
>         sage: preparse("a \\ b \\") # There is really only one backslash here, it is just being escaped.
>         'a  * BackslashOperator() * b \\'
> ```
> 
> ```
>         sage: preparse('''
>         ....: f(a,
>         ....:   b,
>         ....:   c,
>         ....:   d) = a + b*2 + c*3 + d*4
>         ....: ''')
>         '__tmp__ = var("a,b,c,d"); __tmpf__ = a + b*Integer(2) + c*Integer(3) + d*Integer(4); f = symbolic_expression(__tmpf__).function(a,b,c,d)\n'
> ```
> 
> So, I would argue that it makes sense to introduce the following classes during this ticket:
> - `SageBackslashTransformer`,
> - `SageGenConstructionTransformer`,
> - `SageCalculusTransformer`.

You did introduce these classes in the branch of new approach. Your branch fixed the things above. Then I started working on your branch (with those new classes) because there were regressions in loading `.sage` files.



---

archive/issue_comments_514148.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nThen let's straight out our communication first.\n\n(1) You pushed `public/31951-new` with the new approach.\n(2) Then I worked on your branch to fix regressions in loading `.sage` files, and then pushed my branch to `public/31951`. I think this is a mistake. I should have named it `public/31951-new-new` or something.\n\nSo now the branch (`public/31951-new2) uploaded to this ticket wiped out both of our works!\n\nCould I upload my branch again with name `public/31951-new3`? Then we can start discussing with the magics, in which there is a miscommunication as well...",
    "created_at": "2021-09-27T20:07:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514148",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:38" align="right">comment:38</div>

Then let's straight out our communication first.

(1) You pushed `public/31951-new` with the new approach.
(2) Then I worked on your branch to fix regressions in loading `.sage` files, and then pushed my branch to `public/31951`. I think this is a mistake. I should have named it `public/31951-new-new` or something.

So now the branch (`public/31951-new2) uploaded to this ticket wiped out both of our works!

Could I upload my branch again with name `public/31951-new3`? Then we can start discussing with the magics, in which there is a miscommunication as well...



---

archive/issue_comments_514149.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nMy branch refactored your new approach and fixed every bugs and regressions (as far as I am concerned) both on command line and in `.sage` files.",
    "created_at": "2021-09-27T20:16:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514149",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:39" align="right">comment:39</div>

My branch refactored your new approach and fixed every bugs and regressions (as far as I am concerned) both on command line and in `.sage` files.



---

archive/issue_comments_514150.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nChanging the branch, does not wipe out the work. Indeed I got confused with your branch name. I only saw you last commit and thought I never changed the branch name.",
    "created_at": "2021-09-27T21:05:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514150",
    "user": "https://github.com/kliem"
}
```

<div id="comment:40" align="right">comment:40</div>

Changing the branch, does not wipe out the work. Indeed I got confused with your branch name. I only saw you last commit and thought I never changed the branch name.



---

archive/issue_comments_514151.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\nYour branch `public/31951` is still intact.",
    "created_at": "2021-09-27T21:06:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514151",
    "user": "https://github.com/kliem"
}
```

<div id="comment:41" align="right">comment:41</div>

Your branch `public/31951` is still intact.



---

archive/issue_comments_514152.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nIt all depends on what we want. The branch `public/31951-new2` is a minimalistic fix to the reported bug. As far as I see, it does not have regressions. So I would propose closing the current ticket with this fix and provide a quick fix to users.\n\nWe can move the previous work to a new ticket (or new tickets). However, I realized that our approach does not work well with automagic, e.g.\n\n`time 8^1` and `time 8^^1` should be equivalent to `%time 8^1` resp. `%time 8^^1`, but I did not accomplish this. Did you?\n\nThere are a number of phases that the transformation undergoes:\n\n1. `get_ipython().input_transformer_manager.cleanup_transforms`: Things like cleaning the prompt as I suggested.\n2. `get_ipython().input_transformer_manager.token_transformers`: Things like IPythons line magic.\n3. `get_ipython().prefilter_manager`: Things like IPythons automagic.\n4. `get_ipython().input_transformers_post`: Currently Sage's `preparse`.\n5. `ip.ast_transformers` (Optional additional changes).\n\nAnything that you enter undergoes all 5 steps. However, when checking whether multi-line input is complete, only the first two steps are checked. It makes sense to execute our preparser at step 4, so it works nicely with automagic. It should be executed at step 2 or later to work nicely with (non-auto) magic.\n\nMy latest solution to this ticket is to leave Sage's preparser at step 4, but overwrite `check_complete` with the method from a different input manager that applies Sage's preparser at step 1. Things will be modified before checking whether this is magic, but this should not bother us.\n\nI quickly scanned your fixes and I think they make sense. When executing a file, it should behave exactly as when typed into the shell, so this could be done via `ipython_preparse` or similar (which calls `get_ipython().transform_cell()` (steps 1 and 2) and not `get_ipython().input_transformer_manager().transform()` (steps 1 to 4).\n\nIf you agree, you could put your branch on #30953 and we leave the minimalistic fix here. Because of the problems with automagic, I think sage's preparsing should stay at step 4 however (except for checking completeness).",
    "created_at": "2021-09-27T21:40:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514152",
    "user": "https://github.com/kliem"
}
```

<div id="comment:42" align="right">comment:42</div>

It all depends on what we want. The branch `public/31951-new2` is a minimalistic fix to the reported bug. As far as I see, it does not have regressions. So I would propose closing the current ticket with this fix and provide a quick fix to users.

We can move the previous work to a new ticket (or new tickets). However, I realized that our approach does not work well with automagic, e.g.

`time 8^1` and `time 8^^1` should be equivalent to `%time 8^1` resp. `%time 8^^1`, but I did not accomplish this. Did you?

There are a number of phases that the transformation undergoes:

1. `get_ipython().input_transformer_manager.cleanup_transforms`: Things like cleaning the prompt as I suggested.
2. `get_ipython().input_transformer_manager.token_transformers`: Things like IPythons line magic.
3. `get_ipython().prefilter_manager`: Things like IPythons automagic.
4. `get_ipython().input_transformers_post`: Currently Sage's `preparse`.
5. `ip.ast_transformers` (Optional additional changes).

Anything that you enter undergoes all 5 steps. However, when checking whether multi-line input is complete, only the first two steps are checked. It makes sense to execute our preparser at step 4, so it works nicely with automagic. It should be executed at step 2 or later to work nicely with (non-auto) magic.

My latest solution to this ticket is to leave Sage's preparser at step 4, but overwrite `check_complete` with the method from a different input manager that applies Sage's preparser at step 1. Things will be modified before checking whether this is magic, but this should not bother us.

I quickly scanned your fixes and I think they make sense. When executing a file, it should behave exactly as when typed into the shell, so this could be done via `ipython_preparse` or similar (which calls `get_ipython().transform_cell()` (steps 1 and 2) and not `get_ipython().input_transformer_manager().transform()` (steps 1 to 4).

If you agree, you could put your branch on #30953 and we leave the minimalistic fix here. Because of the problems with automagic, I think sage's preparsing should stay at step 4 however (except for checking completeness).



---

archive/issue_comments_514153.json:
```json
{
    "body": "<div id=\"comment:43\" align=\"right\">comment:43</div>\n\nReplying to [@kliem](#comment%3A42):\n\nThanks for the detailed explanation. I only guessed the process.\n\n> It all depends on what we want. The branch `public/31951-new2` is a minimalistic fix to the reported bug. As far as I see, it does not have regressions. So I would propose closing the current ticket with this fix and provide a quick fix to users.\n\nAnyway we are too late to provide a \"quick fix\".\n \n> We can move the previous work to a new ticket (or new tickets). However, I realized that our approach does not work well with automagic, e.g.\n> \n> `time 8^1` and `time 8^^1` should be equivalent to `%time 8^1` resp. `%time 8^^1`, but I did not accomplish this. Did you?\n\nNo. I didn't know that. There is no other problem with our approach except this one.\n\nI investigated this. The reason is that ipython applies `cleanup_transforms` **several** times to the input string for automagic. Hence `time 8^^1` becomes `time 8^1` and again `time 8**1`.\n\nSo the solution is to make this code\n\n```\n    # Use ^ for exponentiation and ^^ for xor\n    # (A side effect is that **** becomes xor as well.)\n    L = L.replace('^', '**').replace('****', '^')  \n```\nalso to a token transformer(named perhaps `SageCaretTransformer` or `SageExponentiationTransformer`?).\n\nWith another token transformer, our approach(my branch containing your work) fixes all problems.\n\n> If you agree, you could put your branch on #30953 and we leave the minimalistic fix here. Because of the problems with automagic, I think sage's preparsing should stay at step 4 however (except for checking completeness).\n\nAs I said above, we can provide one branch solving this ticket and #30953 (and #4545?). All these tickets are just different manifestations of a single problem. Then why separate the solution?",
    "created_at": "2021-09-28T02:27:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514153",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:43" align="right">comment:43</div>

Replying to [@kliem](#comment%3A42):

Thanks for the detailed explanation. I only guessed the process.

> It all depends on what we want. The branch `public/31951-new2` is a minimalistic fix to the reported bug. As far as I see, it does not have regressions. So I would propose closing the current ticket with this fix and provide a quick fix to users.

Anyway we are too late to provide a "quick fix".
 
> We can move the previous work to a new ticket (or new tickets). However, I realized that our approach does not work well with automagic, e.g.
> 
> `time 8^1` and `time 8^^1` should be equivalent to `%time 8^1` resp. `%time 8^^1`, but I did not accomplish this. Did you?

No. I didn't know that. There is no other problem with our approach except this one.

I investigated this. The reason is that ipython applies `cleanup_transforms` **several** times to the input string for automagic. Hence `time 8^^1` becomes `time 8^1` and again `time 8**1`.

So the solution is to make this code

```
    # Use ^ for exponentiation and ^^ for xor
    # (A side effect is that **** becomes xor as well.)
    L = L.replace('^', '**').replace('****', '^')  
```
also to a token transformer(named perhaps `SageCaretTransformer` or `SageExponentiationTransformer`?).

With another token transformer, our approach(my branch containing your work) fixes all problems.

> If you agree, you could put your branch on #30953 and we leave the minimalistic fix here. Because of the problems with automagic, I think sage's preparsing should stay at step 4 however (except for checking completeness).

As I said above, we can provide one branch solving this ticket and #30953 (and #4545?). All these tickets are just different manifestations of a single problem. Then why separate the solution?



---

archive/issue_comments_514154.json:
```json
{
    "body": "<div id=\"comment:44\" align=\"right\">comment:44</div>\n\n> So the solution is to make this code\n> \n> ```\n>     # Use ^ for exponentiation and ^^ for xor\n>     # (A side effect is that **** becomes xor as well.)\n>     L = L.replace('^', '**').replace('****', '^')  \n> ```\n> also to a token transformer(named perhaps `SageCaretTransformer` or `SageExponentiationTransformer`?).\n\nOr we can replace the code with another *idempotent* code with some regex juggling.\n\nI can try to code the necessary token transformer, but I think you can do it quicker than me.",
    "created_at": "2021-09-28T02:32:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514154",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:44" align="right">comment:44</div>

> So the solution is to make this code
> 
> ```
>     # Use ^ for exponentiation and ^^ for xor
>     # (A side effect is that **** becomes xor as well.)
>     L = L.replace('^', '**').replace('****', '^')  
> ```
> also to a token transformer(named perhaps `SageCaretTransformer` or `SageExponentiationTransformer`?).

Or we can replace the code with another *idempotent* code with some regex juggling.

I can try to code the necessary token transformer, but I think you can do it quicker than me.



---

archive/issue_comments_514155.json:
```json
{
    "body": "<div id=\"comment:45\" align=\"right\">comment:45</div>\n\nNo, just making it idempotent is not enough.\n\n```\nsage: runfile /tmp/2.sage\nTraceback (most recent call last)\n...\nOSError: did not find file '/tmp/Integer(2).sage' to load or attach\n```\n\nInstead of trying to find a workaround for all these problems, we could just leave our preparsing at step 4 and just modify `check_complete`. Even the backslash transformation is probably best left for step 4.\n\nNow there is a different idea I just had: The current ticket works well with everything except for automagic, which only applies for single-line inputs. In contrast, all our problems only apply for multi-line input. So we could do our replacements at step 1 and 2 for multi-line input and leave it for step 4 for single-line input. This should also work.",
    "created_at": "2021-09-28T06:22:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514155",
    "user": "https://github.com/kliem"
}
```

<div id="comment:45" align="right">comment:45</div>

No, just making it idempotent is not enough.

```
sage: runfile /tmp/2.sage
Traceback (most recent call last)
...
OSError: did not find file '/tmp/Integer(2).sage' to load or attach
```

Instead of trying to find a workaround for all these problems, we could just leave our preparsing at step 4 and just modify `check_complete`. Even the backslash transformation is probably best left for step 4.

Now there is a different idea I just had: The current ticket works well with everything except for automagic, which only applies for single-line inputs. In contrast, all our problems only apply for multi-line input. So we could do our replacements at step 1 and 2 for multi-line input and leave it for step 4 for single-line input. This should also work.



---

archive/issue_comments_514156.json:
```json
{
    "body": "<div id=\"comment:46\" align=\"right\">comment:46</div>\n\nReplying to [@kliem](#comment%3A45):\n> No, just making it idempotent is not enough.\n> \n> ```\n> sage: runfile /tmp/2.sage\n> Traceback (most recent call last)\n> ...\n> OSError: did not find file '/tmp/Integer(2).sage' to load or attach\n> ```\n> \n> Instead of trying to find a workaround for all these problems, we could just leave our preparsing at step 4 and just modify `check_complete`. Even the backslash transformation is probably best left for step 4.\n\nOkay. Now I am persuaded. \n \n> Now there is a different idea I just had: The current ticket works well with everything except for automagic, which only applies for single-line inputs. In contrast, all our problems only apply for multi-line input. So we could do our replacements at step 1 and 2 for multi-line input and leave it for step 4 for single-line input. This should also work.\n\nYour current patch works really well. What about automagic is not working? Your previous example `time 8^^1` works well.",
    "created_at": "2021-09-28T07:16:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514156",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:46" align="right">comment:46</div>

Replying to [@kliem](#comment%3A45):
> No, just making it idempotent is not enough.
> 
> ```
> sage: runfile /tmp/2.sage
> Traceback (most recent call last)
> ...
> OSError: did not find file '/tmp/Integer(2).sage' to load or attach
> ```
> 
> Instead of trying to find a workaround for all these problems, we could just leave our preparsing at step 4 and just modify `check_complete`. Even the backslash transformation is probably best left for step 4.

Okay. Now I am persuaded. 
 
> Now there is a different idea I just had: The current ticket works well with everything except for automagic, which only applies for single-line inputs. In contrast, all our problems only apply for multi-line input. So we could do our replacements at step 1 and 2 for multi-line input and leave it for step 4 for single-line input. This should also work.

Your current patch works really well. What about automagic is not working? Your previous example `time 8^^1` works well.



---

archive/issue_comments_514157.json:
```json
{
    "body": "<div id=\"comment:47\" align=\"right\">comment:47</div>\n\nAh. Your current patch does not fix #30953...",
    "created_at": "2021-09-28T07:20:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514157",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:47" align="right">comment:47</div>

Ah. Your current patch does not fix #30953...



---

archive/issue_comments_514158.json:
```json
{
    "body": "<div id=\"comment:48\" align=\"right\">comment:48</div>\n\n\n```\nsage: %time 8^^1\nCPU times: user 17 \u00b5s, sys: 2 \u00b5s, total: 19 \u00b5s\nWall time: 25.3 \u00b5s\n9\nsage: time 8^^1\nCPU times: user 33 \u00b5s, sys: 3 \u00b5s, total: 36 \u00b5s\nWall time: 49.8 \u00b5s\n8\nsage: 8^^1\n9\n```\n\nNot working. The problem is that `8^^1` is preparsed twice. Automagic is hard to detect and depends in fact on whether a variable of a specific name is defined.\n\nAt the moment I really see two ways of doing it:\n- Have an artificial input manager for `check_complete`.\n- Do the preparsing in steps 1 and 2 except for single-lines, when we keep doing the preparsing at step 4.",
    "created_at": "2021-09-28T07:28:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514158",
    "user": "https://github.com/kliem"
}
```

<div id="comment:48" align="right">comment:48</div>


```
sage: %time 8^^1
CPU times: user 17 s, sys: 2 s, total: 19 s
Wall time: 25.3 s
9
sage: time 8^^1
CPU times: user 33 s, sys: 3 s, total: 36 s
Wall time: 49.8 s
8
sage: 8^^1
9
```

Not working. The problem is that `8^^1` is preparsed twice. Automagic is hard to detect and depends in fact on whether a variable of a specific name is defined.

At the moment I really see two ways of doing it:
- Have an artificial input manager for `check_complete`.
- Do the preparsing in steps 1 and 2 except for single-lines, when we keep doing the preparsing at step 4.



---

archive/issue_comments_514159.json:
```json
{
    "body": "<div id=\"comment:49\" align=\"right\">comment:49</div>\n\nBy combining your current branch (that use artificial input manager for `check_complete`) with my branch, I think I managed to fix automagic problem. The code is still a mess with lots of doctest errors, but all of them seem fixable.\n\nA question: It seems that `ip.input_transformer_manager.transform_cell(...)` does not apply `input_transformers_post`. Am I right? Because of this, now I have lots of doctest errors like \n\n```\nFile \"src/sage/repl/interpreter.py\", line 635, in sage.repl.interpreter.SageBackslashTransformer\nFailed example:\n    ip.input_transformer_manager.transform_cell(r'''\n    a = (2, 3, \\\n         4)''')\nExpected:\n    'a = (Integer(2), Integer(3), \\\\\\n     Integer(4))\\n'\nGot:\n    'a = (2, 3, \\\\\\n     4)\\n'\n```\n\nOtherwise all seems work well. Let me have some time to tidy up the code.",
    "created_at": "2021-09-28T09:11:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514159",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:49" align="right">comment:49</div>

By combining your current branch (that use artificial input manager for `check_complete`) with my branch, I think I managed to fix automagic problem. The code is still a mess with lots of doctest errors, but all of them seem fixable.

A question: It seems that `ip.input_transformer_manager.transform_cell(...)` does not apply `input_transformers_post`. Am I right? Because of this, now I have lots of doctest errors like 

```
File "src/sage/repl/interpreter.py", line 635, in sage.repl.interpreter.SageBackslashTransformer
Failed example:
    ip.input_transformer_manager.transform_cell(r'''
    a = (2, 3, \
         4)''')
Expected:
    'a = (Integer(2), Integer(3), \\\n     Integer(4))\n'
Got:
    'a = (2, 3, \\\n     4)\n'
```

Otherwise all seems work well. Let me have some time to tidy up the code.



---

archive/issue_comments_514160.json:
```json
{
    "body": "<div id=\"comment:50\" align=\"right\">comment:50</div>\n\nI am ready to upload the combined branch, which works well for all problems which we discussed.\n\nI think it is okay to upload the branch here as it combines the current branch.",
    "created_at": "2021-09-28T11:47:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514160",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:50" align="right">comment:50</div>

I am ready to upload the combined branch, which works well for all problems which we discussed.

I think it is okay to upload the branch here as it combines the current branch.



---

archive/issue_comments_514161.json:
```json
{
    "body": "Changed branch from **[public/31951-new2](https://github.com/sagemath/sagetrac-mirror/tree/public/31951-new2)** to **[public/31951](https://github.com/sagemath/sagetrac-mirror/tree/public/31951)**",
    "created_at": "2021-09-28T11:48:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514161",
    "user": "https://github.com/kwankyu"
}
```

Changed branch from **[public/31951-new2](https://github.com/sagemath/sagetrac-mirror/tree/public/31951-new2)** to **[public/31951](https://github.com/sagemath/sagetrac-mirror/tree/public/31951)**



---

archive/issue_comments_514162.json:
```json
{
    "body": "Changed commit from **[`126ef4f`](https://github.com/sagemath/sagetrac-mirror/commit/126ef4f04fef813f41d0536c94c18215419c1588)** to **[`6456a2a`](https://github.com/sagemath/sagetrac-mirror/commit/6456a2af2ba559f2c9766abd8cdcb94eb3597f70)**",
    "created_at": "2021-09-28T11:48:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514162",
    "user": "https://github.com/kwankyu"
}
```

Changed commit from **[`126ef4f`](https://github.com/sagemath/sagetrac-mirror/commit/126ef4f04fef813f41d0536c94c18215419c1588)** to **[`6456a2a`](https://github.com/sagemath/sagetrac-mirror/commit/6456a2af2ba559f2c9766abd8cdcb94eb3597f70)**



---

archive/issue_comments_514163.json:
```json
{
    "body": "<div id=\"comment:51\" align=\"right\">comment:51</div>\n\nThe branch name is again \"public/31951\".\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6456a2af2ba559f2c9766abd8cdcb94eb3597f70\"><code>6456a2a</code></a></td><td><code>Rework Sage input preparser</code></td></tr></table>\n",
    "created_at": "2021-09-28T11:48:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514163",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:51" align="right">comment:51</div>

The branch name is again "public/31951".

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6456a2af2ba559f2c9766abd8cdcb94eb3597f70"><code>6456a2a</code></a></td><td><code>Rework Sage input preparser</code></td></tr></table>




---

archive/issue_comments_514164.json:
```json
{
    "body": "<div id=\"comment:52\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5e59f1287d35e85576ef554518fb9f311bbcc9f2\"><code>5e59f12</code></a></td><td><code>Add missing doctests</code></td></tr></table>\n",
    "created_at": "2021-09-28T12:01:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514164",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:52"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5e59f1287d35e85576ef554518fb9f311bbcc9f2"><code>5e59f12</code></a></td><td><code>Add missing doctests</code></td></tr></table>




---

archive/issue_comments_514165.json:
```json
{
    "body": "Changed commit from **[`6456a2a`](https://github.com/sagemath/sagetrac-mirror/commit/6456a2af2ba559f2c9766abd8cdcb94eb3597f70)** to **[`5e59f12`](https://github.com/sagemath/sagetrac-mirror/commit/5e59f1287d35e85576ef554518fb9f311bbcc9f2)**",
    "created_at": "2021-09-28T12:01:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514165",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`6456a2a`](https://github.com/sagemath/sagetrac-mirror/commit/6456a2af2ba559f2c9766abd8cdcb94eb3597f70)** to **[`5e59f12`](https://github.com/sagemath/sagetrac-mirror/commit/5e59f1287d35e85576ef554518fb9f311bbcc9f2)**



---

archive/issue_comments_514166.json:
```json
{
    "body": "<div id=\"comment:53\" align=\"right\">comment:53</div>\n\n`quote_state` needs not to be a global in `interpreter.py`.\n\nThe problem here is that automagic will still have the 3 token replacement. I'm not on your new branch, but you will see a failure similar to\n\n```\nsage: ls | grep \\f\n/bin/bash: -c: line 0: syntax error near unexpected token `('\n/bin/bash: -c: line 0: `ls -F --color | grep * BackslashOperator() * f'\n```\n\nOn develop this works just fine.\n\nSo the token replacements should not be applied in case of single lines, but then need to be added to `SagePreparseTransformer` again (to be applied to single lines). We could also remove the backslash token and put it back into `SagePreparseTransformer`, but this wouldn't fix the following:\n\nNow:\n\n```\nsage: del maxima\nsage: maxima f(x)=2\n__tmp__=var(\"x\")\n```\n\nBefore:\n\n```\nsage: del maxima\nsage: maxima f(x)=2\nf(x)=2\n```",
    "created_at": "2021-09-28T12:35:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514166",
    "user": "https://github.com/kliem"
}
```

<div id="comment:53" align="right">comment:53</div>

`quote_state` needs not to be a global in `interpreter.py`.

The problem here is that automagic will still have the 3 token replacement. I'm not on your new branch, but you will see a failure similar to

```
sage: ls | grep \f
/bin/bash: -c: line 0: syntax error near unexpected token `('
/bin/bash: -c: line 0: `ls -F --color | grep * BackslashOperator() * f'
```

On develop this works just fine.

So the token replacements should not be applied in case of single lines, but then need to be added to `SagePreparseTransformer` again (to be applied to single lines). We could also remove the backslash token and put it back into `SagePreparseTransformer`, but this wouldn't fix the following:

Now:

```
sage: del maxima
sage: maxima f(x)=2
__tmp__=var("x")
```

Before:

```
sage: del maxima
sage: maxima f(x)=2
f(x)=2
```



---

archive/issue_comments_514167.json:
```json
{
    "body": "<div id=\"comment:54\" align=\"right\">comment:54</div>\n\nReplying to [@kliem](#comment%3A53):\n\n> The problem here is that automagic will still have the 3 token replacement. I'm not on your new branch, but you will see a failure similar to\n> \n> ```\n> sage: ls | grep \\f\n> /bin/bash: -c: line 0: syntax error near unexpected token `('\n> /bin/bash: -c: line 0: `ls -F --color | grep * BackslashOperator() * f'\n> ```\n> \n> On develop this works just fine.\n> \n> So the token replacements should not be applied in case of single lines, but then need to be added to `SagePreparseTransformer` again (to be applied to single lines). We could also remove the backslash token and put it back into `SagePreparseTransformer`, but this wouldn't fix the following:\n> \n> Now:\n> \n> ```\n> sage: del maxima\n> sage: maxima f(x)=2\n> __tmp__=var(\"x\")\n> ```\n> \n> Before:\n> \n> ```\n> sage: del maxima\n> sage: maxima f(x)=2\n> f(x)=2\n> ```\n\nThese works fine with the branch, fortunately.\n\n> `quote_state` needs not to be a global in `interpreter.py`.\n\nWould you fix this while you examine the new branch?",
    "created_at": "2021-09-28T13:06:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514167",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:54" align="right">comment:54</div>

Replying to [@kliem](#comment%3A53):

> The problem here is that automagic will still have the 3 token replacement. I'm not on your new branch, but you will see a failure similar to
> 
> ```
> sage: ls | grep \f
> /bin/bash: -c: line 0: syntax error near unexpected token `('
> /bin/bash: -c: line 0: `ls -F --color | grep * BackslashOperator() * f'
> ```
> 
> On develop this works just fine.
> 
> So the token replacements should not be applied in case of single lines, but then need to be added to `SagePreparseTransformer` again (to be applied to single lines). We could also remove the backslash token and put it back into `SagePreparseTransformer`, but this wouldn't fix the following:
> 
> Now:
> 
> ```
> sage: del maxima
> sage: maxima f(x)=2
> __tmp__=var("x")
> ```
> 
> Before:
> 
> ```
> sage: del maxima
> sage: maxima f(x)=2
> f(x)=2
> ```

These works fine with the branch, fortunately.

> `quote_state` needs not to be a global in `interpreter.py`.

Would you fix this while you examine the new branch?



---

archive/issue_comments_514168.json:
```json
{
    "body": "<div id=\"comment:55\" align=\"right\">comment:55</div>\n\nLet me remind you that the new branch is based on sage beta 9.5.beta2.",
    "created_at": "2021-09-28T13:12:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514168",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:55" align="right">comment:55</div>

Let me remind you that the new branch is based on sage beta 9.5.beta2.



---

archive/issue_comments_514169.json:
```json
{
    "body": "<div id=\"comment:56\" align=\"right\">comment:56</div>\n\nReplying to [@kwankyu](#comment%3A54):\n> Replying to [@kliem](#comment%3A53):\n> \n> > The problem here is that automagic will still have the 3 token replacement. I'm not on your new branch, but you will see a failure similar to\n> > \n> > ```\n> > sage: ls | grep \\f\n> > /bin/bash: -c: line 0: syntax error near unexpected token `('\n> > /bin/bash: -c: line 0: `ls -F --color | grep * BackslashOperator() * f'\n> > ```\n> > \n> > On develop this works just fine.\n> > \n> > So the token replacements should not be applied in case of single lines, but then need to be added to `SagePreparseTransformer` again (to be applied to single lines). We could also remove the backslash token and put it back into `SagePreparseTransformer`, but this wouldn't fix the following:\n> > \n> > Now:\n> > \n> > ```\n> > sage: del maxima\n> > sage: maxima f(x)=2\n> > __tmp__=var(\"x\")\n> > ```\n> > \n> > Before:\n> > \n> > ```\n> > sage: del maxima\n> > sage: maxima f(x)=2\n> > f(x)=2\n> > ```\n\n> \n> These works fine with the branch, fortunately.\n\nWell, because `SageTokenTransformers` are never added to the token transformers. So they don't do anything.\n> \n> > `quote_state` needs not to be a global in `interpreter.py`.\n\n> \n> Would you fix this while you examine the new branch?\n\nYes.",
    "created_at": "2021-09-28T13:33:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514169",
    "user": "https://github.com/kliem"
}
```

<div id="comment:56" align="right">comment:56</div>

Replying to [@kwankyu](#comment%3A54):
> Replying to [@kliem](#comment%3A53):
> 
> > The problem here is that automagic will still have the 3 token replacement. I'm not on your new branch, but you will see a failure similar to
> > 
> > ```
> > sage: ls | grep \f
> > /bin/bash: -c: line 0: syntax error near unexpected token `('
> > /bin/bash: -c: line 0: `ls -F --color | grep * BackslashOperator() * f'
> > ```
> > 
> > On develop this works just fine.
> > 
> > So the token replacements should not be applied in case of single lines, but then need to be added to `SagePreparseTransformer` again (to be applied to single lines). We could also remove the backslash token and put it back into `SagePreparseTransformer`, but this wouldn't fix the following:
> > 
> > Now:
> > 
> > ```
> > sage: del maxima
> > sage: maxima f(x)=2
> > __tmp__=var("x")
> > ```
> > 
> > Before:
> > 
> > ```
> > sage: del maxima
> > sage: maxima f(x)=2
> > f(x)=2
> > ```

> 
> These works fine with the branch, fortunately.

Well, because `SageTokenTransformers` are never added to the token transformers. So they don't do anything.
> 
> > `quote_state` needs not to be a global in `interpreter.py`.

> 
> Would you fix this while you examine the new branch?

Yes.



---

archive/issue_comments_514170.json:
```json
{
    "body": "Changed commit from **[`5e59f12`](https://github.com/sagemath/sagetrac-mirror/commit/5e59f1287d35e85576ef554518fb9f311bbcc9f2)** to **[`7cd7482`](https://github.com/sagemath/sagetrac-mirror/commit/7cd7482f84b9841f3349046d75cd95d5b6aa7e7d)**",
    "created_at": "2021-09-28T14:23:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514170",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`5e59f12`](https://github.com/sagemath/sagetrac-mirror/commit/5e59f1287d35e85576ef554518fb9f311bbcc9f2)** to **[`7cd7482`](https://github.com/sagemath/sagetrac-mirror/commit/7cd7482f84b9841f3349046d75cd95d5b6aa7e7d)**



---

archive/issue_comments_514171.json:
```json
{
    "body": "<div id=\"comment:57\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0ed2a8c9fa6f81cabe9ab6a1d17afb660f27ba7c\"><code>0ed2a8c</code></a></td><td><code>remove global quote_state</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7cd7482f84b9841f3349046d75cd95d5b6aa7e7d\"><code>7cd7482</code></a></td><td><code>special treatment of magics not needed anymore</code></td></tr></table>\n",
    "created_at": "2021-09-28T14:23:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514171",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:57"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0ed2a8c9fa6f81cabe9ab6a1d17afb660f27ba7c"><code>0ed2a8c</code></a></td><td><code>remove global quote_state</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7cd7482f84b9841f3349046d75cd95d5b6aa7e7d"><code>7cd7482</code></a></td><td><code>special treatment of magics not needed anymore</code></td></tr></table>




---

archive/issue_comments_514172.json:
```json
{
    "body": "Changed commit from **[`7cd7482`](https://github.com/sagemath/sagetrac-mirror/commit/7cd7482f84b9841f3349046d75cd95d5b6aa7e7d)** to **[`f1b3439`](https://github.com/sagemath/sagetrac-mirror/commit/f1b3439f9204e4ae4fb9c33b47b6f6e8ad959f5f)**",
    "created_at": "2021-09-28T14:31:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514172",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`7cd7482`](https://github.com/sagemath/sagetrac-mirror/commit/7cd7482f84b9841f3349046d75cd95d5b6aa7e7d)** to **[`f1b3439`](https://github.com/sagemath/sagetrac-mirror/commit/f1b3439f9204e4ae4fb9c33b47b6f6e8ad959f5f)**



---

archive/issue_comments_514173.json:
```json
{
    "body": "<div id=\"comment:58\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f1b3439f9204e4ae4fb9c33b47b6f6e8ad959f5f\"><code>f1b3439</code></a></td><td><code>remove code duplication</code></td></tr></table>\n",
    "created_at": "2021-09-28T14:31:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514173",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:58"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f1b3439f9204e4ae4fb9c33b47b6f6e8ad959f5f"><code>f1b3439</code></a></td><td><code>remove code duplication</code></td></tr></table>




---

archive/issue_comments_514174.json:
```json
{
    "body": "Changed commit from **[`f1b3439`](https://github.com/sagemath/sagetrac-mirror/commit/f1b3439f9204e4ae4fb9c33b47b6f6e8ad959f5f)** to **[`49a9dcb`](https://github.com/sagemath/sagetrac-mirror/commit/49a9dcbb0d3527a5fcf19d907b6ba25f5ef73a0a)**",
    "created_at": "2021-09-28T14:49:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514174",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`f1b3439`](https://github.com/sagemath/sagetrac-mirror/commit/f1b3439f9204e4ae4fb9c33b47b6f6e8ad959f5f)** to **[`49a9dcb`](https://github.com/sagemath/sagetrac-mirror/commit/49a9dcbb0d3527a5fcf19d907b6ba25f5ef73a0a)**



---

archive/issue_comments_514175.json:
```json
{
    "body": "<div id=\"comment:59\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/16e1617ca332483fbd9947bcc1ea97797cce32cf\"><code>16e1617</code></a></td><td><code>remove helper functions</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/49a9dcbb0d3527a5fcf19d907b6ba25f5ef73a0a\"><code>49a9dcb</code></a></td><td><code>fix 4312 and make doctest stable</code></td></tr></table>\n",
    "created_at": "2021-09-28T14:49:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514175",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:59"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/16e1617ca332483fbd9947bcc1ea97797cce32cf"><code>16e1617</code></a></td><td><code>remove helper functions</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/49a9dcbb0d3527a5fcf19d907b6ba25f5ef73a0a"><code>49a9dcb</code></a></td><td><code>fix 4312 and make doctest stable</code></td></tr></table>




---

archive/issue_comments_514176.json:
```json
{
    "body": "<div id=\"comment:60\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/561764f974923fcd74e7b66ffe29ff957a99d89b\"><code>561764f</code></a></td><td><code>less differences to develop</code></td></tr></table>\n",
    "created_at": "2021-09-28T14:55:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514176",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:60"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/561764f974923fcd74e7b66ffe29ff957a99d89b"><code>561764f</code></a></td><td><code>less differences to develop</code></td></tr></table>




---

archive/issue_comments_514177.json:
```json
{
    "body": "Changed commit from **[`49a9dcb`](https://github.com/sagemath/sagetrac-mirror/commit/49a9dcbb0d3527a5fcf19d907b6ba25f5ef73a0a)** to **[`561764f`](https://github.com/sagemath/sagetrac-mirror/commit/561764f974923fcd74e7b66ffe29ff957a99d89b)**",
    "created_at": "2021-09-28T14:55:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514177",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`49a9dcb`](https://github.com/sagemath/sagetrac-mirror/commit/49a9dcbb0d3527a5fcf19d907b6ba25f5ef73a0a)** to **[`561764f`](https://github.com/sagemath/sagetrac-mirror/commit/561764f974923fcd74e7b66ffe29ff957a99d89b)**



---

archive/issue_comments_514178.json:
```json
{
    "body": "<div id=\"comment:61\" align=\"right\">comment:61</div>\n\nLet me know, what you think about the changes.\n\nIf we do it like this then `preparse_calculus` and `preparse_generators` should be deprecated.\n\nAs a follow up ticket we could try to have magics in `preparse_file`, when it is preparsed within ipython.",
    "created_at": "2021-09-28T15:01:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514178",
    "user": "https://github.com/kliem"
}
```

<div id="comment:61" align="right">comment:61</div>

Let me know, what you think about the changes.

If we do it like this then `preparse_calculus` and `preparse_generators` should be deprecated.

As a follow up ticket we could try to have magics in `preparse_file`, when it is preparsed within ipython.



---

archive/issue_comments_514179.json:
```json
{
    "body": "<div id=\"comment:62\" align=\"right\">comment:62</div>\n\nAlso closing #4545 could really happen in #4545, as it has nothing to do with our changes. Apparently the problem just went away.",
    "created_at": "2021-09-28T15:01:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514179",
    "user": "https://github.com/kliem"
}
```

<div id="comment:62" align="right">comment:62</div>

Also closing #4545 could really happen in #4545, as it has nothing to do with our changes. Apparently the problem just went away.



---

archive/issue_comments_514180.json:
```json
{
    "body": "Changed commit from **[`561764f`](https://github.com/sagemath/sagetrac-mirror/commit/561764f974923fcd74e7b66ffe29ff957a99d89b)** to **[`c36e61f`](https://github.com/sagemath/sagetrac-mirror/commit/c36e61f43fc1f50b15b8cc7dfbd2bbb25d33c1e1)**",
    "created_at": "2021-09-28T16:01:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514180",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`561764f`](https://github.com/sagemath/sagetrac-mirror/commit/561764f974923fcd74e7b66ffe29ff957a99d89b)** to **[`c36e61f`](https://github.com/sagemath/sagetrac-mirror/commit/c36e61f43fc1f50b15b8cc7dfbd2bbb25d33c1e1)**



---

archive/issue_comments_514181.json:
```json
{
    "body": "<div id=\"comment:63\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c36e61f43fc1f50b15b8cc7dfbd2bbb25d33c1e1\"><code>c36e61f</code></a></td><td><code>Deprecate preparse_generators and preparse_calculus</code></td></tr></table>\n",
    "created_at": "2021-09-28T16:01:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514181",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:63"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c36e61f43fc1f50b15b8cc7dfbd2bbb25d33c1e1"><code>c36e61f</code></a></td><td><code>Deprecate preparse_generators and preparse_calculus</code></td></tr></table>




---

archive/issue_comments_514182.json:
```json
{
    "body": "<div id=\"comment:64\" align=\"right\">comment:64</div>\n\nReplying to [@kliem](#comment%3A61):\n> Let me know, what you think about the changes.\n\nLooks good.One thing: I am not sure about `@parallel`. Is it already deprecated?\n\n> If we do it like this then `preparse_calculus` and `preparse_generators` should be deprecated.\n\nThen let them be deprecated. I made a commit for this.\n\n> As a follow up ticket we could try to have magics in `preparse_file`, when it is preparsed within ipython.\n\nI have no passion for magics in `.sage` files. But of course you can go ahead.",
    "created_at": "2021-09-28T16:07:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514182",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:64" align="right">comment:64</div>

Replying to [@kliem](#comment%3A61):
> Let me know, what you think about the changes.

Looks good.One thing: I am not sure about `@parallel`. Is it already deprecated?

> If we do it like this then `preparse_calculus` and `preparse_generators` should be deprecated.

Then let them be deprecated. I made a commit for this.

> As a follow up ticket we could try to have magics in `preparse_file`, when it is preparsed within ipython.

I have no passion for magics in `.sage` files. But of course you can go ahead.



---

archive/issue_comments_514183.json:
```json
{
    "body": "<div id=\"comment:65\" align=\"right\">comment:65</div>\n\nReplying to [@kliem](#comment%3A62):\n> Also closing #4545 could really happen in #4545, as it has nothing to do with our changes. Apparently the problem just went away.\n\nOkay with `@parallel`.",
    "created_at": "2021-09-28T16:12:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514183",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:65" align="right">comment:65</div>

Replying to [@kliem](#comment%3A62):
> Also closing #4545 could really happen in #4545, as it has nothing to do with our changes. Apparently the problem just went away.

Okay with `@parallel`.



---

archive/issue_comments_514184.json:
```json
{
    "body": "<div id=\"comment:66\" align=\"right\">comment:66</div>\n\nI am positive on the patch.\n\nYou can set it positive if you are okay too.",
    "created_at": "2021-09-28T16:17:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514184",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:66" align="right">comment:66</div>

I am positive on the patch.

You can set it positive if you are okay too.



---

archive/issue_comments_514185.json:
```json
{
    "body": "<div id=\"comment:67\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/537502fd9352009dea458aefb65e12eca9a13a2d\"><code>537502f</code></a></td><td><code>leave doctest of 4545 for 4545</code></td></tr></table>\n",
    "created_at": "2021-09-29T09:00:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514185",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:67"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/537502fd9352009dea458aefb65e12eca9a13a2d"><code>537502f</code></a></td><td><code>leave doctest of 4545 for 4545</code></td></tr></table>




---

archive/issue_comments_514186.json:
```json
{
    "body": "Changed commit from **[`c36e61f`](https://github.com/sagemath/sagetrac-mirror/commit/c36e61f43fc1f50b15b8cc7dfbd2bbb25d33c1e1)** to **[`537502f`](https://github.com/sagemath/sagetrac-mirror/commit/537502fd9352009dea458aefb65e12eca9a13a2d)**",
    "created_at": "2021-09-29T09:00:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514186",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`c36e61f`](https://github.com/sagemath/sagetrac-mirror/commit/c36e61f43fc1f50b15b8cc7dfbd2bbb25d33c1e1)** to **[`537502f`](https://github.com/sagemath/sagetrac-mirror/commit/537502fd9352009dea458aefb65e12eca9a13a2d)**



---

archive/issue_comments_514187.json:
```json
{
    "body": "Changed reviewer from **Kwankyu Lee** to **Kwankyu Lee, Jonathan Kliem**",
    "created_at": "2021-09-29T09:56:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514187",
    "user": "https://github.com/kliem"
}
```

Changed reviewer from **Kwankyu Lee** to **Kwankyu Lee, Jonathan Kliem**



---

archive/issue_comments_514188.json:
```json
{
    "body": "<div id=\"comment:68\" align=\"right\">comment:68</div>\n\nFrom my side this is ok, I would probably wait for a patchbot.",
    "created_at": "2021-09-29T09:56:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514188",
    "user": "https://github.com/kliem"
}
```

<div id="comment:68" align="right">comment:68</div>

From my side this is ok, I would probably wait for a patchbot.



---

archive/issue_comments_514189.json:
```json
{
    "body": "Changed author from **Jonathan Kliem** to **Jonathan Kliem, Kwankyu Lee**",
    "created_at": "2021-09-29T09:56:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514189",
    "user": "https://github.com/kliem"
}
```

Changed author from **Jonathan Kliem** to **Jonathan Kliem, Kwankyu Lee**



---

archive/issue_comments_514190.json:
```json
{
    "body": "Changed commit from **[`537502f`](https://github.com/sagemath/sagetrac-mirror/commit/537502fd9352009dea458aefb65e12eca9a13a2d)** to **[`48ab22e`](https://github.com/sagemath/sagetrac-mirror/commit/48ab22e2b30c6bc312b8cfaf7bf9eb73d1fd4865)**",
    "created_at": "2021-09-30T03:27:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514190",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`537502f`](https://github.com/sagemath/sagetrac-mirror/commit/537502fd9352009dea458aefb65e12eca9a13a2d)** to **[`48ab22e`](https://github.com/sagemath/sagetrac-mirror/commit/48ab22e2b30c6bc312b8cfaf7bf9eb73d1fd4865)**



---

archive/issue_comments_514191.json:
```json
{
    "body": "<div id=\"comment:69\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/48ab22e2b30c6bc312b8cfaf7bf9eb73d1fd4865\"><code>48ab22e</code></a></td><td><code>Minor fixes and edits for patchbot complaints</code></td></tr></table>\n",
    "created_at": "2021-09-30T03:27:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514191",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:69"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/48ab22e2b30c6bc312b8cfaf7bf9eb73d1fd4865"><code>48ab22e</code></a></td><td><code>Minor fixes and edits for patchbot complaints</code></td></tr></table>




---

archive/issue_comments_514192.json:
```json
{
    "body": "<div id=\"comment:70\" align=\"right\">comment:70</div>\n\nThis approach has a serious problem though:\n\nhttps://patchbot.sagemath.org/log/31951/Linux/1_SMP_Debian_5.10.46-5_(2021-09-23)/x86_64/5.10.0-8-amd64/tmonteil-lxc1/2021-09-30%2006:22:01?plugin=startup_modules&diff=/log/0/Linux/1_SMP_Debian_5.10.46-5_%282021-09-23%29/x86_64/5.10.0-8-amd64/tmonteil-lxc1/2021-09-29%2014%3A23%3A05&ticket=31951&base=9.5.beta2\n\nWhat I understand from this is that now `IPython` is being loaded, even when just running sage from command line, which is new. I have no idea if this is acceptable.",
    "created_at": "2021-09-30T07:26:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514192",
    "user": "https://github.com/kliem"
}
```

<div id="comment:70" align="right">comment:70</div>

This approach has a serious problem though:

https://patchbot.sagemath.org/log/31951/Linux/1_SMP_Debian_5.10.46-5_(2021-09-23)/x86_64/5.10.0-8-amd64/tmonteil-lxc1/2021-09-30%2006:22:01?plugin=startup_modules&diff=/log/0/Linux/1_SMP_Debian_5.10.46-5_%282021-09-23%29/x86_64/5.10.0-8-amd64/tmonteil-lxc1/2021-09-29%2014%3A23%3A05&ticket=31951&base=9.5.beta2

What I understand from this is that now `IPython` is being loaded, even when just running sage from command line, which is new. I have no idea if this is acceptable.



---

archive/issue_comments_514193.json:
```json
{
    "body": "<div id=\"comment:71\" align=\"right\">comment:71</div>\n\nReplying to [@kliem](#comment%3A70):\n> This approach has a serious problem though:\n> \n> https://patchbot.sagemath.org/log/31951/Linux/1_SMP_Debian_5.10.46-5_(2021-09-23)/x86_64/5.10.0-8-amd64/tmonteil-lxc1/2021-09-30%2006:22:01?plugin=startup_modules&diff=/log/0/Linux/1_SMP_Debian_5.10.46-5_%282021-09-23%29/x86_64/5.10.0-8-amd64/tmonteil-lxc1/2021-09-29%2014%3A23%3A05&ticket=31951&base=9.5.beta2\n> \n> What I understand from this is that now `IPython` is being loaded, even when just running sage from command line, which is new. I have no idea if this is acceptable.\n\nIt is serious and not acceptable. Let's see if there's an escape.",
    "created_at": "2021-09-30T08:02:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514193",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:71" align="right">comment:71</div>

Replying to [@kliem](#comment%3A70):
> This approach has a serious problem though:
> 
> https://patchbot.sagemath.org/log/31951/Linux/1_SMP_Debian_5.10.46-5_(2021-09-23)/x86_64/5.10.0-8-amd64/tmonteil-lxc1/2021-09-30%2006:22:01?plugin=startup_modules&diff=/log/0/Linux/1_SMP_Debian_5.10.46-5_%282021-09-23%29/x86_64/5.10.0-8-amd64/tmonteil-lxc1/2021-09-29%2014%3A23%3A05&ticket=31951&base=9.5.beta2
> 
> What I understand from this is that now `IPython` is being loaded, even when just running sage from command line, which is new. I have no idea if this is acceptable.

It is serious and not acceptable. Let's see if there's an escape.



---

archive/issue_comments_514194.json:
```json
{
    "body": "<div id=\"comment:72\" align=\"right\">comment:72</div>\n\nYes, I think so. The solution to #30953 is apparently super easy:\n\n```\n-    L = ';%s;' % L.replace('\\n', ';\\n;')\n+    replacements = []\n+    counta = 0\n+    countb = 0\n+    for i in range(len(L)):\n+        if L[i] == '[':\n+            counta += 1\n+        elif L[i] == '(':\n+            countb += 1\n+        elif L[i] == ']':\n+            counta -= 1\n+        elif L[i] == ')':\n+            countb -= 1\n+        elif L[i] == '\\n':\n+            if counta == countb == 0:\n+                replacements.append(i)\n+    while replacements:\n+        i = replacements.pop()\n+        L = L[:i] + ';\\n;' + L[i+1:]\n+    L = ';' + L\n+    if not L[-1:] == ';':\n+        L += ';'\n```\n\nI'll push changes, once I tested it (and we can always reset, if we don't like it).",
    "created_at": "2021-09-30T08:34:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514194",
    "user": "https://github.com/kliem"
}
```

<div id="comment:72" align="right">comment:72</div>

Yes, I think so. The solution to #30953 is apparently super easy:

```
-    L = ';%s;' % L.replace('\n', ';\n;')
+    replacements = []
+    counta = 0
+    countb = 0
+    for i in range(len(L)):
+        if L[i] == '[':
+            counta += 1
+        elif L[i] == '(':
+            countb += 1
+        elif L[i] == ']':
+            counta -= 1
+        elif L[i] == ')':
+            countb -= 1
+        elif L[i] == '\n':
+            if counta == countb == 0:
+                replacements.append(i)
+    while replacements:
+        i = replacements.pop()
+        L = L[:i] + ';\n;' + L[i+1:]
+    L = ';' + L
+    if not L[-1:] == ';':
+        L += ';'
```

I'll push changes, once I tested it (and we can always reset, if we don't like it).



---

archive/issue_comments_514195.json:
```json
{
    "body": "<div id=\"comment:73\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/88984334157b63794b4f52c111a48be5a547b8a1\"><code>8898433</code></a></td><td><code>simpler fix, by replacing only statement ending \\n and # with ;\\n; and ;#;</code></td></tr></table>\n",
    "created_at": "2021-09-30T09:28:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514195",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:73"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/88984334157b63794b4f52c111a48be5a547b8a1"><code>8898433</code></a></td><td><code>simpler fix, by replacing only statement ending \n and # with ;\n; and ;#;</code></td></tr></table>




---

archive/issue_comments_514196.json:
```json
{
    "body": "Changed commit from **[`48ab22e`](https://github.com/sagemath/sagetrac-mirror/commit/48ab22e2b30c6bc312b8cfaf7bf9eb73d1fd4865)** to **[`8898433`](https://github.com/sagemath/sagetrac-mirror/commit/88984334157b63794b4f52c111a48be5a547b8a1)**",
    "created_at": "2021-09-30T09:28:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514196",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`48ab22e`](https://github.com/sagemath/sagetrac-mirror/commit/48ab22e2b30c6bc312b8cfaf7bf9eb73d1fd4865)** to **[`8898433`](https://github.com/sagemath/sagetrac-mirror/commit/88984334157b63794b4f52c111a48be5a547b8a1)**



---

archive/issue_comments_514197.json:
```json
{
    "body": "<div id=\"comment:74\" align=\"right\">comment:74</div>\n\nSorry about the mess. This apparently works just with some slight changes in comparison to develop.",
    "created_at": "2021-09-30T09:31:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514197",
    "user": "https://github.com/kliem"
}
```

<div id="comment:74" align="right">comment:74</div>

Sorry about the mess. This apparently works just with some slight changes in comparison to develop.



---

archive/issue_comments_514198.json:
```json
{
    "body": "<div id=\"comment:75\" align=\"right\">comment:75</div>\n\nWhy don't we try just to fix the last branch? \n\nIt seems that `IPython` is imported only with 9.5.beta2 + last branch (I mean not with 9.5.beta1). Do you understand how this happen? Is it not surmountable with the approach of the last branch?",
    "created_at": "2021-09-30T09:57:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514198",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:75" align="right">comment:75</div>

Why don't we try just to fix the last branch? 

It seems that `IPython` is imported only with 9.5.beta2 + last branch (I mean not with 9.5.beta1). Do you understand how this happen? Is it not surmountable with the approach of the last branch?



---

archive/issue_comments_514199.json:
```json
{
    "body": "<div id=\"comment:76\" align=\"right\">comment:76</div>\n\n`IPython` is surely imported whenever you parse something. Because the token transformer needs IPython.\n\nWhenevern you run\n\n`sage -c \"print('hello')` or similar, this will call `preparse`, which imports whatever it needs to run. In our case we added the dependency to `IPython`.\n\nNow the new fix just slightly modified the develop branch to obtain the same output, so I don't know why to use tokens, if a slight modification works just as well.",
    "created_at": "2021-09-30T11:12:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514199",
    "user": "https://github.com/kliem"
}
```

<div id="comment:76" align="right">comment:76</div>

`IPython` is surely imported whenever you parse something. Because the token transformer needs IPython.

Whenevern you run

`sage -c "print('hello')` or similar, this will call `preparse`, which imports whatever it needs to run. In our case we added the dependency to `IPython`.

Now the new fix just slightly modified the develop branch to obtain the same output, so I don't know why to use tokens, if a slight modification works just as well.



---

archive/issue_comments_514200.json:
```json
{
    "body": "Changed commit from **[`8898433`](https://github.com/sagemath/sagetrac-mirror/commit/88984334157b63794b4f52c111a48be5a547b8a1)** to **[`041aeaa`](https://github.com/sagemath/sagetrac-mirror/commit/041aeaadca1846bf8cda58da7f2e3c35267ab23c)**",
    "created_at": "2021-09-30T12:21:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514200",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`8898433`](https://github.com/sagemath/sagetrac-mirror/commit/88984334157b63794b4f52c111a48be5a547b8a1)** to **[`041aeaa`](https://github.com/sagemath/sagetrac-mirror/commit/041aeaadca1846bf8cda58da7f2e3c35267ab23c)**



---

archive/issue_comments_514201.json:
```json
{
    "body": "<div id=\"comment:77\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/041aeaadca1846bf8cda58da7f2e3c35267ab23c\"><code>041aeaa</code></a></td><td><code>A fix</code></td></tr></table>\n",
    "created_at": "2021-09-30T12:21:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514201",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:77"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/041aeaadca1846bf8cda58da7f2e3c35267ab23c"><code>041aeaa</code></a></td><td><code>A fix</code></td></tr></table>




---

archive/issue_comments_514202.json:
```json
{
    "body": "<div id=\"comment:78\" align=\"right\">comment:78</div>\n\nReplying to [@kliem](#comment%3A76):\n> `IPython` is surely imported whenever you parse something. Because the token transformer needs IPython.\n> \n> Whenevern you run\n> \n> `sage -c \"print('hello')` or similar, this will call `preparse`, which imports whatever it needs to run. In our case we added the dependency to `IPython`.\n\nI see.\n\n> Now the new fix just slightly modified the develop branch to obtain the same output, so I don't know why to use tokens, if a slight modification works just as well.\n\nOkay. I agree that the simpler, the better.\n\nAll seem work well with me. Let's wait for a green bot.",
    "created_at": "2021-09-30T12:28:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514202",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:78" align="right">comment:78</div>

Replying to [@kliem](#comment%3A76):
> `IPython` is surely imported whenever you parse something. Because the token transformer needs IPython.
> 
> Whenevern you run
> 
> `sage -c "print('hello')` or similar, this will call `preparse`, which imports whatever it needs to run. In our case we added the dependency to `IPython`.

I see.

> Now the new fix just slightly modified the develop branch to obtain the same output, so I don't know why to use tokens, if a slight modification works just as well.

Okay. I agree that the simpler, the better.

All seem work well with me. Let's wait for a green bot.



---

archive/issue_comments_514203.json:
```json
{
    "body": "<div id=\"comment:79\" align=\"right\">comment:79</div>\n\nI think the slight increase of the startup time is acceptable. I cannot clearly explain the increase, but I guess this is caused by increasing time of parsing Sage startup scripts.\n\nOtherwise I am positive with the new simpler fix.",
    "created_at": "2021-10-01T02:39:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514203",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:79" align="right">comment:79</div>

I think the slight increase of the startup time is acceptable. I cannot clearly explain the increase, but I guess this is caused by increasing time of parsing Sage startup scripts.

Otherwise I am positive with the new simpler fix.



---

archive/issue_events_437379.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-10-01T06:32:38Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31951#event-437379"
}
```



---

archive/issue_events_437380.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-10-01T06:32:38Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31951#event-437380"
}
```



---

archive/issue_comments_514204.json:
```json
{
    "body": "<div id=\"comment:80\" align=\"right\">comment:80</div>\n\nOk, let's move on.",
    "created_at": "2021-10-01T06:32:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514204",
    "user": "https://github.com/kliem"
}
```

<div id="comment:80" align="right">comment:80</div>

Ok, let's move on.



---

archive/issue_comments_514205.json:
```json
{
    "body": "Changed work issues from **close #4545 and #30953** to none",
    "created_at": "2021-10-01T06:32:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514205",
    "user": "https://github.com/kliem"
}
```

Changed work issues from **close #4545 and #30953** to none



---

archive/issue_comments_514206.json:
```json
{
    "body": "Changed branch from **[public/31951](https://github.com/sagemath/sagetrac-mirror/tree/public/31951)** to **[`041aeaa`](https://github.com/sagemath/sagetrac-mirror/commit/041aeaadca1846bf8cda58da7f2e3c35267ab23c)**",
    "created_at": "2021-10-09T11:10:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31951#issuecomment-514206",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[public/31951](https://github.com/sagemath/sagetrac-mirror/tree/public/31951)** to **[`041aeaa`](https://github.com/sagemath/sagetrac-mirror/commit/041aeaadca1846bf8cda58da7f2e3c35267ab23c)**



---

archive/issue_events_437381.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-10-09T11:10:08Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31951#event-437381"
}
```



---

archive/issue_events_437382.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "650fe3205ca28452b9ff8bbbc1987bc18fc23488",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2021-10-09T11:10:08Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/31951",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31951#event-437382"
}
```
