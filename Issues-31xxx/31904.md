# Issue 31904: Pullback silently fails in some cases with multiple charts

archive/issues_031667.json:
```json
{
    "body": "In Sage 9.3, we have\n\n```\nsage: E.<x,y> = EuclideanSpace()\nsage: polar.<r,ph> = E.polar_coordinates()\nsage: g = E.metric()\nsage: M = Manifold(1, 'M')\nsage: Ct.<t> = M.chart()\nsage: F = M.diff_map(E, coord_functions={(Ct, polar): (1 + cos(t), t)})\nsage: gM = F.pullback(g)\nsage: gM\nField of symmetric bilinear forms on the 1-dimensional differentiable\nmanifold M\n```\nSo far so good, but\n\n```\nsage: gM.display()\nValueError: no basis could be found for computing the components in \n the Coordinate frame (M, (d/dt)\n```\nActually, `gM` has been initialized as a tensor field object, but its components have not been evaluated in any frame:\n\n```\nsage: gM._components\n{}\n```\nForcing the coordinate expression of the map `F` in the Cartesian chart (for instance by a call to `F.display()`) fixes the issue:\n\n```\nsage: F.display()\nM --> E^2\n   t |--> (x, y) = (cos(t)^2 + cos(t), (cos(t) + 1)*sin(t))\n   t |--> (r, ph) = (cos(t) + 1, t)\nsage: gM = F.pullback(g)\nsage: gM.display()\n(2*cos(t) + 2) dt*dt\n```\nHowever, the expression of `F` in Cartesian coordinates should not be required to compute the pullback of `g` since the latter is known in polar coordinates, where `F` has been defined:\n\n```\nsage: g.display(polar)\ng = dr*dr + r^2 dph*dph\n```\nThis bug has been reported at https://ask.sagemath.org/question/57431/\n\nCC:  @tscrim @mjungmath @mkoeppe\n\nKeywords: pullback\n\nBranch/Commit: aea4554d90de3a3cb39c0e3704edc0807d8b4109\n\nReviewer: Ricardo Buring\n\nAuthor: Eric Gourgoulhon\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/31904\n\n",
    "closed_at": "2021-06-29T17:40:40Z",
    "created_at": "2021-06-04T07:41:04Z",
    "labels": [
        "component: manifolds",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "Pullback silently fails in some cases with multiple charts",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31904",
    "user": "https://github.com/egourgoulhon"
}
```
In Sage 9.3, we have

```
sage: E.<x,y> = EuclideanSpace()
sage: polar.<r,ph> = E.polar_coordinates()
sage: g = E.metric()
sage: M = Manifold(1, 'M')
sage: Ct.<t> = M.chart()
sage: F = M.diff_map(E, coord_functions={(Ct, polar): (1 + cos(t), t)})
sage: gM = F.pullback(g)
sage: gM
Field of symmetric bilinear forms on the 1-dimensional differentiable
manifold M
```
So far so good, but

```
sage: gM.display()
ValueError: no basis could be found for computing the components in 
 the Coordinate frame (M, (d/dt)
```
Actually, `gM` has been initialized as a tensor field object, but its components have not been evaluated in any frame:

```
sage: gM._components
{}
```
Forcing the coordinate expression of the map `F` in the Cartesian chart (for instance by a call to `F.display()`) fixes the issue:

```
sage: F.display()
M --> E^2
   t |--> (x, y) = (cos(t)^2 + cos(t), (cos(t) + 1)*sin(t))
   t |--> (r, ph) = (cos(t) + 1, t)
sage: gM = F.pullback(g)
sage: gM.display()
(2*cos(t) + 2) dt*dt
```
However, the expression of `F` in Cartesian coordinates should not be required to compute the pullback of `g` since the latter is known in polar coordinates, where `F` has been defined:

```
sage: g.display(polar)
g = dr*dr + r^2 dph*dph
```
This bug has been reported at https://ask.sagemath.org/question/57431/

CC:  @tscrim @mjungmath @mkoeppe

Keywords: pullback

Branch/Commit: aea4554d90de3a3cb39c0e3704edc0807d8b4109

Reviewer: Ricardo Buring

Author: Eric Gourgoulhon

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/31904





---

archive/issue_comments_482862.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -19,7 +19,7 @@\n ValueError: no basis could be found for computing the components in \n  the Coordinate frame (M, (d/dt)\n ```\n-Actually, `gM` has not been initialized as a tensor field object, but its components have not been evaluated in any frame:\n+Actually, `gM` has been initialized as a tensor field object, but its components have not been evaluated in any frame:\n \n ```\n sage: gM._components\n``````\n",
    "created_at": "2021-06-04T07:52:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31904#issuecomment-482862",
    "user": "https://github.com/egourgoulhon"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -19,7 +19,7 @@
 ValueError: no basis could be found for computing the components in 
  the Coordinate frame (M, (d/dt)
 ```
-Actually, `gM` has not been initialized as a tensor field object, but its components have not been evaluated in any frame:
+Actually, `gM` has been initialized as a tensor field object, but its components have not been evaluated in any frame:
 
 ```
 sage: gM._components
``````




---

archive/issue_comments_482863.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,48 @@\n+In Sage 9.3, we have\n \n+```\n+sage: E.<x,y> = EuclideanSpace()\n+sage: polar.<r,ph> = E.polar_coordinates()\n+sage: g = E.metric()\n+sage: M = Manifold(1, 'M')\n+sage: Ct.<t> = M.chart()\n+sage: F = M.diff_map(E, coord_functions={(Ct, polar): (1 + cos(t), t)})\n+sage: gM = F.pullback(g)\n+sage: gM\n+Field of symmetric bilinear forms on the 1-dimensional differentiable\n+manifold M\n+```\n+So far so good, but\n+\n+```\n+sage: gM.display()\n+ValueError: no basis could be found for computing the components in \n+ the Coordinate frame (M, (d/dt)\n+```\n+Actually, `gM` has been initialized as a tensor field object, but its components have not been evaluated in any frame:\n+\n+```\n+sage: gM._components\n+{}\n+```\n+Forcing the coordinate expression of the map `F` in the Cartesian chart (for instance by a call to `F.display()`) fixes the issue:\n+\n+```\n+sage: F.display()\n+M --> E^2\n+   t |--> (x, y) = (cos(t)^2 + cos(t), (cos(t) + 1)*sin(t))\n+   t |--> (r, ph) = (cos(t) + 1, t)\n+sage: gM = F.pullback(g)\n+sage: gM.display()\n+(2*cos(t) + 2) dt*dt\n+```\n+However, the expression of `F` in Cartesian coordinates should not be required to compute the pullback of `g` since the latter is known in polar coordinates, where `F` has been defined:\n+\n+```\n+sage: g.display(polar)\n+g = dr*dr + r^2 dph*dph\n+```\n+This bug has been reported at https://ask.sagemath.org/question/57431/\n \n Comment: 1\n \n``````\n",
    "created_at": "2021-06-04T07:53:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31904#issuecomment-482863",
    "user": "https://github.com/egourgoulhon"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,48 @@
+In Sage 9.3, we have
 
+```
+sage: E.<x,y> = EuclideanSpace()
+sage: polar.<r,ph> = E.polar_coordinates()
+sage: g = E.metric()
+sage: M = Manifold(1, 'M')
+sage: Ct.<t> = M.chart()
+sage: F = M.diff_map(E, coord_functions={(Ct, polar): (1 + cos(t), t)})
+sage: gM = F.pullback(g)
+sage: gM
+Field of symmetric bilinear forms on the 1-dimensional differentiable
+manifold M
+```
+So far so good, but
+
+```
+sage: gM.display()
+ValueError: no basis could be found for computing the components in 
+ the Coordinate frame (M, (d/dt)
+```
+Actually, `gM` has been initialized as a tensor field object, but its components have not been evaluated in any frame:
+
+```
+sage: gM._components
+{}
+```
+Forcing the coordinate expression of the map `F` in the Cartesian chart (for instance by a call to `F.display()`) fixes the issue:
+
+```
+sage: F.display()
+M --> E^2
+   t |--> (x, y) = (cos(t)^2 + cos(t), (cos(t) + 1)*sin(t))
+   t |--> (r, ph) = (cos(t) + 1, t)
+sage: gM = F.pullback(g)
+sage: gM.display()
+(2*cos(t) + 2) dt*dt
+```
+However, the expression of `F` in Cartesian coordinates should not be required to compute the pullback of `g` since the latter is known in polar coordinates, where `F` has been defined:
+
+```
+sage: g.display(polar)
+g = dr*dr + r^2 dph*dph
+```
+This bug has been reported at https://ask.sagemath.org/question/57431/
 
 Comment: 1
 
``````




---

archive/issue_comments_482864.json:
```json
{
    "body": "<a id='comment:3'></a>New commits:",
    "created_at": "2021-06-04T08:59:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31904#issuecomment-482864",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:3'></a>New commits:



---

archive/issue_comments_482865.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-06-04T08:59:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31904#issuecomment-482865",
    "user": "https://github.com/egourgoulhon"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_482866.json:
```json
{
    "body": "<a id='comment:4'></a>The fix consisted in making the internal function `_pullback_chart` of the method `pullback` to operate for a single pair of charts (now added as arguments), which is determined in the main part of `pullback`, based on the knowledge of the map's coordinate expressions.",
    "created_at": "2021-06-04T09:15:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31904#issuecomment-482866",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:4'></a>The fix consisted in making the internal function `_pullback_chart` of the method `pullback` to operate for a single pair of charts (now added as arguments), which is determined in the main part of `pullback`, based on the knowledge of the map's coordinate expressions.



---

archive/issue_comments_482867.json:
```json
{
    "body": "<a id='comment:5'></a>The `return partial` statement in the parallel code has seemingly accidentally been indented too far.",
    "created_at": "2021-06-04T11:38:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31904#issuecomment-482867",
    "user": "https://github.com/rburing"
}
```

<a id='comment:5'></a>The `return partial` statement in the parallel code has seemingly accidentally been indented too far.



---

archive/issue_comments_482868.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-05T17:12:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31904#issuecomment-482868",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_482869.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:5 rburing]:\n> The `return partial` statement in the parallel code has seemingly accidentally been indented too far.\n\nGood catch, thanks! (it was not revealed by the parallel doctest because `local_list_ind` had a single element in that case). \nThis is corrected in the above commit (as well as a pyflakes error reported by the patchbot).",
    "created_at": "2021-06-05T17:17:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31904#issuecomment-482869",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:7'></a>Replying to [comment:5 rburing]:
> The `return partial` statement in the parallel code has seemingly accidentally been indented too far.

Good catch, thanks! (it was not revealed by the parallel doctest because `local_list_ind` had a single element in that case). 
This is corrected in the above commit (as well as a pyflakes error reported by the patchbot).



---

archive/issue_comments_482870.json:
```json
{
    "body": "<a id='comment:8'></a>Ricardo, do you agree with the last version?",
    "created_at": "2021-06-17T20:16:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31904#issuecomment-482870",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:8'></a>Ricardo, do you agree with the last version?



---

archive/issue_comments_482871.json:
```json
{
    "body": "<a id='comment:9'></a>Yes, looks good now.",
    "created_at": "2021-06-17T21:17:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31904#issuecomment-482871",
    "user": "https://github.com/rburing"
}
```

<a id='comment:9'></a>Yes, looks good now.



---

archive/issue_comments_482872.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-06-17T21:17:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31904#issuecomment-482872",
    "user": "https://github.com/rburing"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_482873.json:
```json
{
    "body": "<a id='comment:10'></a>Thank you!",
    "created_at": "2021-06-17T22:42:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31904#issuecomment-482873",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:10'></a>Thank you!



---

archive/issue_events_084294.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-06-29T17:40:40Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31904",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31904#event-84294"
}
```



---

archive/issue_comments_482874.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-06-29T17:40:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31904",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31904#issuecomment-482874",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
