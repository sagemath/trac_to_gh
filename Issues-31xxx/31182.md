# Issue 31182: Mutability class and pickling

archive/issues_030945.json:
```json
{
    "assignees": [],
    "body": "If the class `Mutability` is used as mixin for mutability features, the pickling goes wrong (see [here](https://github.com/sagemath/sage/issues/30261#comment:9)).\n\nAn attempt using this mixin class after #30281, still throws a pickling test error, e.g. in #30310:\n\n\n```\nFile \"src/sage/manifolds/chart_func.py\", line 2944, in sage.manifolds.chart_func.MultiCoordFunction.__init__\nFailed example:\n    TestSuite(f).run()\nExpected nothing\nGot:\n    Failure in _test_pickling:\n    Traceback (most recent call last):\n      File \"sage/misc/persist.pyx\", line 291, in sage.misc.persist.dumps (build/cythonized/sage/misc/persist.c:4284)\n        return obj.dumps(compress)\n      File \"sage/structure/sage_object.pyx\", line 476, in sage.structure.sage_object.SageObject.dumps (build/cythonized/sage/structure/sage_object.c:3790)\n        return _base_dumps(self, compress=compress)\n      File \"sage/misc/persist.pyx\", line 264, in sage.misc.persist._base_dumps (build/cythonized/sage/misc/persist.c:4012)\n        gherkin = SagePickler.dumps(obj)\n      File \"sage/misc/persist.pyx\", line 771, in sage.misc.persist.SagePickler.dumps (build/cythonized/sage/misc/persist.c:6801)\n        pickler.dump(obj)\n    TypeError: cannot pickle 'MultiCoordFunction' object\n    <BLANKLINE>\n    During handling of the above exception, another exception occurred:\n    <BLANKLINE>\n    Traceback (most recent call last):\n      File \"/home/michi/Projekte/sage-devel/local/lib/python3.8/site-packages/sage/misc/sage_unittest.py\", line 297, in run\n        test_method(tester=tester)\n      File \"sage/structure/sage_object.pyx\", line 647, in sage.structure.sage_object.SageObject._test_pickling (build/cythonized/sage/structure/sage_object.c:5007)\n        tester.assertEqual(loads(dumps(self)), self)\n      File \"sage/misc/persist.pyx\", line 293, in sage.misc.persist.dumps (build/cythonized/sage/misc/persist.c:4337)\n        return _base_dumps(obj, compress=compress)\n      File \"sage/misc/persist.pyx\", line 264, in sage.misc.persist._base_dumps (build/cythonized/sage/misc/persist.c:4012)\n        gherkin = SagePickler.dumps(obj)\n      File \"sage/misc/persist.pyx\", line 771, in sage.misc.persist.SagePickler.dumps (build/cythonized/sage/misc/persist.c:6801)\n        pickler.dump(obj)\n    TypeError: cannot pickle 'MultiCoordFunction' object\n    ------------------------------------------------------------\n    The following tests failed: _test_pickling\n```\n\nI found out that a non-cythonized alternative works without errors.\n\nDepends on #31196\n\nCC:  @tscrim @mkoeppe @tobiasdiez @nbruin\n\nBranch/Commit: **[`6cbd1fd`](https://github.com/sagemath/sagetrac-mirror/commit/6cbd1fd918ef9fdc73310b10e9a50e6c9bf4b7ed)**\n\nReviewer: **Travis Scrimshaw**\n\nAuthor: **Michael Jung**\n\nComponent: **misc**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/31182_\n\n",
    "closed_at": "2021-03-07T17:05:57Z",
    "created_at": "2021-01-04T20:06:40Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.3",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Mutability class and pickling",
    "type": "issue",
    "updated_at": "2021-03-07T17:05:57Z",
    "url": "https://github.com/sagemath/sage/issues/31182",
    "user": "https://github.com/mjungmath"
}
```
If the class `Mutability` is used as mixin for mutability features, the pickling goes wrong (see [here](https://github.com/sagemath/sage/issues/30261#comment:9)).

An attempt using this mixin class after #30281, still throws a pickling test error, e.g. in #30310:


```
File "src/sage/manifolds/chart_func.py", line 2944, in sage.manifolds.chart_func.MultiCoordFunction.__init__
Failed example:
    TestSuite(f).run()
Expected nothing
Got:
    Failure in _test_pickling:
    Traceback (most recent call last):
      File "sage/misc/persist.pyx", line 291, in sage.misc.persist.dumps (build/cythonized/sage/misc/persist.c:4284)
        return obj.dumps(compress)
      File "sage/structure/sage_object.pyx", line 476, in sage.structure.sage_object.SageObject.dumps (build/cythonized/sage/structure/sage_object.c:3790)
        return _base_dumps(self, compress=compress)
      File "sage/misc/persist.pyx", line 264, in sage.misc.persist._base_dumps (build/cythonized/sage/misc/persist.c:4012)
        gherkin = SagePickler.dumps(obj)
      File "sage/misc/persist.pyx", line 771, in sage.misc.persist.SagePickler.dumps (build/cythonized/sage/misc/persist.c:6801)
        pickler.dump(obj)
    TypeError: cannot pickle 'MultiCoordFunction' object
    <BLANKLINE>
    During handling of the above exception, another exception occurred:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/home/michi/Projekte/sage-devel/local/lib/python3.8/site-packages/sage/misc/sage_unittest.py", line 297, in run
        test_method(tester=tester)
      File "sage/structure/sage_object.pyx", line 647, in sage.structure.sage_object.SageObject._test_pickling (build/cythonized/sage/structure/sage_object.c:5007)
        tester.assertEqual(loads(dumps(self)), self)
      File "sage/misc/persist.pyx", line 293, in sage.misc.persist.dumps (build/cythonized/sage/misc/persist.c:4337)
        return _base_dumps(obj, compress=compress)
      File "sage/misc/persist.pyx", line 264, in sage.misc.persist._base_dumps (build/cythonized/sage/misc/persist.c:4012)
        gherkin = SagePickler.dumps(obj)
      File "sage/misc/persist.pyx", line 771, in sage.misc.persist.SagePickler.dumps (build/cythonized/sage/misc/persist.c:6801)
        pickler.dump(obj)
    TypeError: cannot pickle 'MultiCoordFunction' object
    ------------------------------------------------------------
    The following tests failed: _test_pickling
```

I found out that a non-cythonized alternative works without errors.

Depends on #31196

CC:  @tscrim @mkoeppe @tobiasdiez @nbruin

Branch/Commit: **[`6cbd1fd`](https://github.com/sagemath/sagetrac-mirror/commit/6cbd1fd918ef9fdc73310b10e9a50e6c9bf4b7ed)**

Reviewer: **Travis Scrimshaw**

Author: **Michael Jung**

Component: **misc**

_Issue created by migration from https://trac.sagemath.org/ticket/31182_





---

archive/issue_events_429847.json:
```json
{
    "actor": "https://github.com/mjungmath",
    "created_at": "2021-01-04T20:06:40Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31182#event-429847"
}
```



---

archive/issue_events_429848.json:
```json
{
    "actor": "https://github.com/mjungmath",
    "created_at": "2021-01-04T20:06:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31182#event-429848"
}
```



---

archive/issue_events_429849.json:
```json
{
    "actor": "https://github.com/mjungmath",
    "created_at": "2021-01-04T20:06:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31182#event-429849"
}
```



---

archive/issue_comments_499717.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nTurns out that\n\n```diff\nfrom sage.misc.decorators import sage_wraps\n+cimport cython\n\n+@cython.auto_pickle(True)\ncdef class Mutability:\n```\n\nhelps.\n\nBut I cannot really tell why that is and if that's a reasonable approach. I am not a pickling expert.\n\nSee https://cython.readthedocs.io/en/latest/src/userguide/extension_types.html#controlling-pickling.",
    "created_at": "2021-01-04T20:09:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31182#issuecomment-499717",
    "user": "https://github.com/mjungmath"
}
```

<div id="comment:1" align="right">comment:1</div>

Turns out that

```diff
from sage.misc.decorators import sage_wraps
+cimport cython

+@cython.auto_pickle(True)
cdef class Mutability:
```

helps.

But I cannot really tell why that is and if that's a reasonable approach. I am not a pickling expert.

See https://cython.readthedocs.io/en/latest/src/userguide/extension_types.html#controlling-pickling.



---

archive/issue_comments_499718.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,42 @@\n If the class `Mutability` is used as mixin for mutability features, the pickling goes wrong (see [here](https://github.com/sagemath/sage/issues/30261#comment:9)).\n \n-This is an attempt to fix this.\n+An attempt using this mixin class after #30281, still throws the same pickling test error, namely:\n+\n+\n+```\n+File \"src/sage/manifolds/chart_func.py\", line 2944, in sage.manifolds.chart_func.MultiCoordFunction.__init__\n+Failed example:\n+    TestSuite(f).run()\n+Expected nothing\n+Got:\n+    Failure in _test_pickling:\n+    Traceback (most recent call last):\n+      File \"sage/misc/persist.pyx\", line 291, in sage.misc.persist.dumps (build/cythonized/sage/misc/persist.c:4284)\n+        return obj.dumps(compress)\n+      File \"sage/structure/sage_object.pyx\", line 476, in sage.structure.sage_object.SageObject.dumps (build/cythonized/sage/structure/sage_object.c:3790)\n+        return _base_dumps(self, compress=compress)\n+      File \"sage/misc/persist.pyx\", line 264, in sage.misc.persist._base_dumps (build/cythonized/sage/misc/persist.c:4012)\n+        gherkin = SagePickler.dumps(obj)\n+      File \"sage/misc/persist.pyx\", line 771, in sage.misc.persist.SagePickler.dumps (build/cythonized/sage/misc/persist.c:6801)\n+        pickler.dump(obj)\n+    TypeError: cannot pickle 'MultiCoordFunction' object\n+    <BLANKLINE>\n+    During handling of the above exception, another exception occurred:\n+    <BLANKLINE>\n+    Traceback (most recent call last):\n+      File \"/home/michi/Projekte/sage-devel/local/lib/python3.8/site-packages/sage/misc/sage_unittest.py\", line 297, in run\n+        test_method(tester=tester)\n+      File \"sage/structure/sage_object.pyx\", line 647, in sage.structure.sage_object.SageObject._test_pickling (build/cythonized/sage/structure/sage_object.c:5007)\n+        tester.assertEqual(loads(dumps(self)), self)\n+      File \"sage/misc/persist.pyx\", line 293, in sage.misc.persist.dumps (build/cythonized/sage/misc/persist.c:4337)\n+        return _base_dumps(obj, compress=compress)\n+      File \"sage/misc/persist.pyx\", line 264, in sage.misc.persist._base_dumps (build/cythonized/sage/misc/persist.c:4012)\n+        gherkin = SagePickler.dumps(obj)\n+      File \"sage/misc/persist.pyx\", line 771, in sage.misc.persist.SagePickler.dumps (build/cythonized/sage/misc/persist.c:6801)\n+        pickler.dump(obj)\n+    TypeError: cannot pickle 'MultiCoordFunction' object\n+    ------------------------------------------------------------\n+    The following tests failed: _test_pickling\n+```\n+\n+I found out that a non-cythonized alternative works without errors.\n``````\n",
    "created_at": "2021-01-04T20:13:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31182#issuecomment-499718",
    "user": "https://github.com/mjungmath"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,42 @@
 If the class `Mutability` is used as mixin for mutability features, the pickling goes wrong (see [here](https://github.com/sagemath/sage/issues/30261#comment:9)).
 
-This is an attempt to fix this.
+An attempt using this mixin class after #30281, still throws the same pickling test error, namely:
+
+
+```
+File "src/sage/manifolds/chart_func.py", line 2944, in sage.manifolds.chart_func.MultiCoordFunction.__init__
+Failed example:
+    TestSuite(f).run()
+Expected nothing
+Got:
+    Failure in _test_pickling:
+    Traceback (most recent call last):
+      File "sage/misc/persist.pyx", line 291, in sage.misc.persist.dumps (build/cythonized/sage/misc/persist.c:4284)
+        return obj.dumps(compress)
+      File "sage/structure/sage_object.pyx", line 476, in sage.structure.sage_object.SageObject.dumps (build/cythonized/sage/structure/sage_object.c:3790)
+        return _base_dumps(self, compress=compress)
+      File "sage/misc/persist.pyx", line 264, in sage.misc.persist._base_dumps (build/cythonized/sage/misc/persist.c:4012)
+        gherkin = SagePickler.dumps(obj)
+      File "sage/misc/persist.pyx", line 771, in sage.misc.persist.SagePickler.dumps (build/cythonized/sage/misc/persist.c:6801)
+        pickler.dump(obj)
+    TypeError: cannot pickle 'MultiCoordFunction' object
+    <BLANKLINE>
+    During handling of the above exception, another exception occurred:
+    <BLANKLINE>
+    Traceback (most recent call last):
+      File "/home/michi/Projekte/sage-devel/local/lib/python3.8/site-packages/sage/misc/sage_unittest.py", line 297, in run
+        test_method(tester=tester)
+      File "sage/structure/sage_object.pyx", line 647, in sage.structure.sage_object.SageObject._test_pickling (build/cythonized/sage/structure/sage_object.c:5007)
+        tester.assertEqual(loads(dumps(self)), self)
+      File "sage/misc/persist.pyx", line 293, in sage.misc.persist.dumps (build/cythonized/sage/misc/persist.c:4337)
+        return _base_dumps(obj, compress=compress)
+      File "sage/misc/persist.pyx", line 264, in sage.misc.persist._base_dumps (build/cythonized/sage/misc/persist.c:4012)
+        gherkin = SagePickler.dumps(obj)
+      File "sage/misc/persist.pyx", line 771, in sage.misc.persist.SagePickler.dumps (build/cythonized/sage/misc/persist.c:6801)
+        pickler.dump(obj)
+    TypeError: cannot pickle 'MultiCoordFunction' object
+    ------------------------------------------------------------
+    The following tests failed: _test_pickling
+```
+
+I found out that a non-cythonized alternative works without errors.
``````




---

archive/issue_comments_499719.json:
```json
{
    "body": "Changed author from **Michael Jung** to none",
    "created_at": "2021-01-04T20:13:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31182#issuecomment-499719",
    "user": "https://github.com/mjungmath"
}
```

Changed author from **Michael Jung** to none



---

archive/issue_comments_499720.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n If the class `Mutability` is used as mixin for mutability features, the pickling goes wrong (see [here](https://github.com/sagemath/sage/issues/30261#comment:9)).\n \n-An attempt using this mixin class after #30281, still throws the same pickling test error, namely:\n+An attempt using this mixin class after #30281, still throws the same pickling test error, e.g. in #30310:\n \n \n ```\n``````\n",
    "created_at": "2021-01-04T20:23:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31182#issuecomment-499720",
    "user": "https://github.com/mjungmath"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,6 @@
 If the class `Mutability` is used as mixin for mutability features, the pickling goes wrong (see [here](https://github.com/sagemath/sage/issues/30261#comment:9)).
 
-An attempt using this mixin class after #30281, still throws the same pickling test error, namely:
+An attempt using this mixin class after #30281, still throws the same pickling test error, e.g. in #30310:
 
 
 ```
``````




---

archive/issue_comments_499721.json:
```json
{
    "body": "Branch: **[u/gh-mjungmath/mutability_class_and_pickling](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-mjungmath/mutability_class_and_pickling)**",
    "created_at": "2021-01-06T12:41:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31182#issuecomment-499721",
    "user": "https://github.com/mjungmath"
}
```

Branch: **[u/gh-mjungmath/mutability_class_and_pickling](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-mjungmath/mutability_class_and_pickling)**



---

archive/issue_comments_499722.json:
```json
{
    "body": "Commit: **[`439d0d0`](https://github.com/sagemath/sagetrac-mirror/commit/439d0d0a1cb9cd0af35f1ee33962f8c6f26a49ce)**",
    "created_at": "2021-01-06T12:41:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31182#issuecomment-499722",
    "user": "https://github.com/mjungmath"
}
```

Commit: **[`439d0d0`](https://github.com/sagemath/sagetrac-mirror/commit/439d0d0a1cb9cd0af35f1ee33962f8c6f26a49ce)**



---

archive/issue_comments_499723.json:
```json
{
    "body": "Author: **Michael Jung**",
    "created_at": "2021-01-06T12:41:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31182#issuecomment-499723",
    "user": "https://github.com/mjungmath"
}
```

Author: **Michael Jung**



---

archive/issue_comments_499724.json:
```json
{
    "body": "<div id=\"comment:6\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/439d0d0a1cb9cd0af35f1ee33962f8c6f26a49ce\">439d0d0</a></td><td><code>Trac #31182: enable auto pickle</code></td></tr></table>\n",
    "created_at": "2021-01-06T12:41:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31182#issuecomment-499724",
    "user": "https://github.com/mjungmath"
}
```

<div id="comment:6"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/439d0d0a1cb9cd0af35f1ee33962f8c6f26a49ce">439d0d0</a></td><td><code>Trac #31182: enable auto pickle</code></td></tr></table>




---

archive/issue_events_429850.json:
```json
{
    "actor": "https://github.com/mjungmath",
    "created_at": "2021-01-06T12:42:12Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31182#event-429850"
}
```



---

archive/issue_comments_499725.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n If the class `Mutability` is used as mixin for mutability features, the pickling goes wrong (see [here](https://github.com/sagemath/sage/issues/30261#comment:9)).\n \n-An attempt using this mixin class after #30281, still throws the same pickling test error, e.g. in #30310:\n+An attempt using this mixin class after #30281, still throws a pickling test error, e.g. in #30310:\n \n \n ```\n``````\n",
    "created_at": "2021-01-06T19:55:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31182#issuecomment-499725",
    "user": "https://github.com/mjungmath"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,6 @@
 If the class `Mutability` is used as mixin for mutability features, the pickling goes wrong (see [here](https://github.com/sagemath/sage/issues/30261#comment:9)).
 
-An attempt using this mixin class after #30281, still throws the same pickling test error, e.g. in #30310:
+An attempt using this mixin class after #30281, still throws a pickling test error, e.g. in #30310:
 
 
 ```
``````




---

archive/issue_comments_499726.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nPatchbot is green. The change works with ticket #30310 and according changes.",
    "created_at": "2021-01-06T19:55:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31182#issuecomment-499726",
    "user": "https://github.com/mjungmath"
}
```

<div id="comment:8" align="right">comment:8</div>

Patchbot is green. The change works with ticket #30310 and according changes.



---

archive/issue_comments_499727.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nWould be nice if anyone could give adequate feedback, or cc someone who ought to be an expert. Many tickets depend on it (see #30261).",
    "created_at": "2021-01-09T15:23:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31182#issuecomment-499727",
    "user": "https://github.com/mjungmath"
}
```

<div id="comment:11" align="right">comment:11</div>

Would be nice if anyone could give adequate feedback, or cc someone who ought to be an expert. Many tickets depend on it (see #30261).



---

archive/issue_comments_499728.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nWhy is it a Cython class anyway? Multiple inheritances among Cython classes are not going to work and for Python classes it seems to cause some troubles. I'd vote for turning `Mutability` into a pure Python mix-in class.\n\nIf one really needs the functionality on Cython level, what about a class `SageObjectWithMutability` instead?",
    "created_at": "2021-01-10T10:59:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31182#issuecomment-499728",
    "user": "https://github.com/mjungmath"
}
```

<div id="comment:12" align="right">comment:12</div>

Why is it a Cython class anyway? Multiple inheritances among Cython classes are not going to work and for Python classes it seems to cause some troubles. I'd vote for turning `Mutability` into a pure Python mix-in class.

If one really needs the functionality on Cython level, what about a class `SageObjectWithMutability` instead?



---

archive/issue_comments_499729.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReplying to [@mjungmath](#comment:12):\n> Why is it a Cython class anyway? Multiple inheritances among Cython classes are not going to work and for Python classes it seems to cause some troubles. I'd vote for turning `Mutability` into a pure Python mix-in class.\n\nThis makes no sense. Having this be a Cython class does not influence whether another class *Python* class can inherit this, which can be done in Cython as well. You run into the exact same problem if you want another `cdef` class to inherit from this and another `cdef` class, which is actually worse because a `cdef` class cannot inherit from a Python class.\n\n> If one really needs the functionality on Cython level, what about a class `SageObjectWithMutability` instead?\n\nFor speed, pure and simple.",
    "created_at": "2021-01-12T00:17:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31182#issuecomment-499729",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:13" align="right">comment:13</div>

Replying to [@mjungmath](#comment:12):
> Why is it a Cython class anyway? Multiple inheritances among Cython classes are not going to work and for Python classes it seems to cause some troubles. I'd vote for turning `Mutability` into a pure Python mix-in class.

This makes no sense. Having this be a Cython class does not influence whether another class *Python* class can inherit this, which can be done in Cython as well. You run into the exact same problem if you want another `cdef` class to inherit from this and another `cdef` class, which is actually worse because a `cdef` class cannot inherit from a Python class.

> If one really needs the functionality on Cython level, what about a class `SageObjectWithMutability` instead?

For speed, pure and simple.



---

archive/issue_comments_499730.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@mjungmath](#comment:16):\n> Replying to [@tscrim](#comment:13):\n> > Replying to [@mjungmath](#comment:12):\n> > > Why is it a Cython class anyway? Multiple inheritances among Cython classes are not going to work and for Python classes it seems to cause some troubles. I'd vote for turning `Mutability` into a pure Python mix-in class.\n\n> > \n> > This makes no sense. Having this be a Cython class does not influence whether another class *Python* class can inherit this, which can be done in Cython as well.\n\n> \n> Right, it should work, and somehow the pickling is affected.\n\nThat is likely an issue with how the pickling is implemented and affects all C/Python classes equally. This likely requires implementations of `__reduce__` in the corresponding classes that use it. It's been awhile since I've looked this closely at a pickling issue. There might be some better/more general way to do it.\n\n> > You run into the exact same problem if you want another `cdef` class to inherit from this and another `cdef` class, which is actually worse because a `cdef` class cannot inherit from a Python class.\n\n> \n> I tend to disagree.\n\nWhat I said isn't an opinion but a fact.\n\n> The class `Mutability` is intended to be mixed in, right? Every class in Sage must inherit from `SageObject`, either directly or within an inheritance tree. In order to use `Mutability`, we need therefore two inheritances since `Mutability` does *not* inherit from `SageObject`. But a second inheritance is not allowed if the subsequent class is a Cython class as well. Having `class Sequence(SageObject, Mutability)` on the other hand is allowed but *only* if `Mutability` is a Python class (see [here](https://cython.readthedocs.io/en/latest/src/userguide/extension_types.html#subclassing) for details).\n\nThere is a key difference here: the class being an *extension type*, i.e., a `cdef` class. If you don't believe me, try it. Here is a minimal example:\n\n```\nsage: %%cython\n....: cdef class Foo:\n....:     pass\n....: cdef class Bar:\n....:     pass\n....: class MyClass(Foo, Bar):  # Change to cdef class to see it fail\n....:     pass\n....:\nsage: C = MyClass()\n```\n\n> My point is, classes which inherit from another Cython class, in particular any `cdef` class, can therefore *never* benefit from this mix in class if `Mutability` stays Cythonic (this should hold true for almost every class in Sage).\n\nThis is not true. In fact, there are lots of examples in Sage that use `Parent` and `WithEqualityById` via `UniqueRepresentation`.\n\n> On top of it all, the class as it is right now has no use at all. It's neither working on Python classes due to the above error nor on Cython classes due to its inheritance behavior.\n> \n> > \n> > > If one really needs the functionality on Cython level, what about a class `SageObjectWithMutability` instead?\n\n> > \n> > For speed, pure and simple.\n\n> \n> I see the need of a speed-up. And I mean, we can keep this class as `cdef` as it is if we get the above bug to work. Then it can only be used in a very limited range of classes in Sage.\n\nSee above.\n\n> In any case, due to the above reasons, I suggest a class `SageObjectWithMutability` inheriting from `SageObject` implementing the mutability feature. That would be useful for `Sequence`, `BundleConnection`, `AffineConnection` and probably even more.\n\nStrong -1. See above.",
    "created_at": "2021-01-13T07:17:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31182#issuecomment-499730",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@mjungmath](#comment:16):
> Replying to [@tscrim](#comment:13):
> > Replying to [@mjungmath](#comment:12):
> > > Why is it a Cython class anyway? Multiple inheritances among Cython classes are not going to work and for Python classes it seems to cause some troubles. I'd vote for turning `Mutability` into a pure Python mix-in class.

> > 
> > This makes no sense. Having this be a Cython class does not influence whether another class *Python* class can inherit this, which can be done in Cython as well.

> 
> Right, it should work, and somehow the pickling is affected.

That is likely an issue with how the pickling is implemented and affects all C/Python classes equally. This likely requires implementations of `__reduce__` in the corresponding classes that use it. It's been awhile since I've looked this closely at a pickling issue. There might be some better/more general way to do it.

> > You run into the exact same problem if you want another `cdef` class to inherit from this and another `cdef` class, which is actually worse because a `cdef` class cannot inherit from a Python class.

> 
> I tend to disagree.

What I said isn't an opinion but a fact.

> The class `Mutability` is intended to be mixed in, right? Every class in Sage must inherit from `SageObject`, either directly or within an inheritance tree. In order to use `Mutability`, we need therefore two inheritances since `Mutability` does *not* inherit from `SageObject`. But a second inheritance is not allowed if the subsequent class is a Cython class as well. Having `class Sequence(SageObject, Mutability)` on the other hand is allowed but *only* if `Mutability` is a Python class (see [here](https://cython.readthedocs.io/en/latest/src/userguide/extension_types.html#subclassing) for details).

There is a key difference here: the class being an *extension type*, i.e., a `cdef` class. If you don't believe me, try it. Here is a minimal example:

```
sage: %%cython
....: cdef class Foo:
....:     pass
....: cdef class Bar:
....:     pass
....: class MyClass(Foo, Bar):  # Change to cdef class to see it fail
....:     pass
....:
sage: C = MyClass()
```

> My point is, classes which inherit from another Cython class, in particular any `cdef` class, can therefore *never* benefit from this mix in class if `Mutability` stays Cythonic (this should hold true for almost every class in Sage).

This is not true. In fact, there are lots of examples in Sage that use `Parent` and `WithEqualityById` via `UniqueRepresentation`.

> On top of it all, the class as it is right now has no use at all. It's neither working on Python classes due to the above error nor on Cython classes due to its inheritance behavior.
> 
> > 
> > > If one really needs the functionality on Cython level, what about a class `SageObjectWithMutability` instead?

> > 
> > For speed, pure and simple.

> 
> I see the need of a speed-up. And I mean, we can keep this class as `cdef` as it is if we get the above bug to work. Then it can only be used in a very limited range of classes in Sage.

See above.

> In any case, due to the above reasons, I suggest a class `SageObjectWithMutability` inheriting from `SageObject` implementing the mutability feature. That would be useful for `Sequence`, `BundleConnection`, `AffineConnection` and probably even more.

Strong -1. See above.



---

archive/issue_comments_499731.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nAh shit! I remember, we had the same discussion in #30261. For some reason, it was burnt into my head that it wasn't supposed to work. Big sorry and thanks for your patience! #shameonme #embarrassed",
    "created_at": "2021-01-13T08:28:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31182#issuecomment-499731",
    "user": "https://github.com/mjungmath"
}
```

<div id="comment:18" align="right">comment:18</div>

Ah shit! I remember, we had the same discussion in #30261. For some reason, it was burnt into my head that it wasn't supposed to work. Big sorry and thanks for your patience! #shameonme #embarrassed



---

archive/issue_comments_499732.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\n@tscrim: What about that?\n\n```python\n    def __getstate__(self):\n        state = self.__dict__\n        state['_is_immutable'] = self._is_immutable\n        return state\n```\n\nWorks perfectly.",
    "created_at": "2021-01-17T14:12:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31182#issuecomment-499732",
    "user": "https://github.com/mjungmath"
}
```

<div id="comment:19" align="right">comment:19</div>

@tscrim: What about that?

```python
    def __getstate__(self):
        state = self.__dict__
        state['_is_immutable'] = self._is_immutable
        return state
```

Works perfectly.



---

archive/issue_comments_499733.json:
```json
{
    "body": "<div id=\"comment:20\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1c5d47d8c9f1ccca7bafcd45eb6f67d4f71c64db\">1c5d47d</a></td><td><code>Trac #31182: `__getstate__` and __setstate__</code></td></tr></table>\n",
    "created_at": "2021-01-17T16:46:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31182#issuecomment-499733",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:20"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1c5d47d8c9f1ccca7bafcd45eb6f67d4f71c64db">1c5d47d</a></td><td><code>Trac #31182: `__getstate__` and __setstate__</code></td></tr></table>




---

archive/issue_comments_499734.json:
```json
{
    "body": "Changed commit from **[`439d0d0`](https://github.com/sagemath/sagetrac-mirror/commit/439d0d0a1cb9cd0af35f1ee33962f8c6f26a49ce)** to **[`1c5d47d`](https://github.com/sagemath/sagetrac-mirror/commit/1c5d47d8c9f1ccca7bafcd45eb6f67d4f71c64db)**",
    "created_at": "2021-01-17T16:46:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31182#issuecomment-499734",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`439d0d0`](https://github.com/sagemath/sagetrac-mirror/commit/439d0d0a1cb9cd0af35f1ee33962f8c6f26a49ce)** to **[`1c5d47d`](https://github.com/sagemath/sagetrac-mirror/commit/1c5d47d8c9f1ccca7bafcd45eb6f67d4f71c64db)**



---

archive/issue_comments_499735.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nReplying to [@sagetrac-git](#comment:20):\n> Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1c5d47d8c9f1ccca7bafcd45eb6f67d4f71c64db\">1c5d47d</a></td><td><code>Trac #31182: `__getstate__` and __setstate__</code></td></tr></table>\n\nHere we go. Please check this out. Works perfectly with #30284.",
    "created_at": "2021-01-17T16:52:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31182#issuecomment-499735",
    "user": "https://github.com/mjungmath"
}
```

<div id="comment:21" align="right">comment:21</div>

Replying to [@sagetrac-git](#comment:20):
> Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1c5d47d8c9f1ccca7bafcd45eb6f67d4f71c64db">1c5d47d</a></td><td><code>Trac #31182: `__getstate__` and __setstate__</code></td></tr></table>

Here we go. Please check this out. Works perfectly with #30284.



---

archive/issue_comments_499736.json:
```json
{
    "body": "Dependencies: **#31196**",
    "created_at": "2021-01-17T20:26:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31182#issuecomment-499736",
    "user": "https://github.com/mjungmath"
}
```

Dependencies: **#31196**



---

archive/issue_comments_499737.json:
```json
{
    "body": "<div id=\"comment:23\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5ecbf3a4896e2ccc10f3f16d4100e197de6a6fea\">5ecbf3a</a></td><td><code>Trac #31181: return added</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4c3393509d75c6a040b312732a1801f190b88142\">4c33935</a></td><td><code>Trac #31196: minor code improvements, py3 compatibility, documentation improved</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e5228d3b87529167876c09b693f498e636677d49\">e5228d3</a></td><td><code>Trac #31196: cpdef require methods + example added</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d957f73a5ac9ab8f198e9d6eb0a3cac266e5d8ba\">d957f73</a></td><td><code>Trac #31196: unnecessary line in docstring removed</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d6d6ba416ad27f586ffbe2137c7a1867f1a78130\">d6d6ba4</a></td><td><code>Trac #31182: `__getstate__` and __setstate__</code></td></tr></table>\n",
    "created_at": "2021-01-17T20:59:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31182#issuecomment-499737",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:23"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5ecbf3a4896e2ccc10f3f16d4100e197de6a6fea">5ecbf3a</a></td><td><code>Trac #31181: return added</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4c3393509d75c6a040b312732a1801f190b88142">4c33935</a></td><td><code>Trac #31196: minor code improvements, py3 compatibility, documentation improved</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e5228d3b87529167876c09b693f498e636677d49">e5228d3</a></td><td><code>Trac #31196: cpdef require methods + example added</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d957f73a5ac9ab8f198e9d6eb0a3cac266e5d8ba">d957f73</a></td><td><code>Trac #31196: unnecessary line in docstring removed</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d6d6ba416ad27f586ffbe2137c7a1867f1a78130">d6d6ba4</a></td><td><code>Trac #31182: `__getstate__` and __setstate__</code></td></tr></table>




---

archive/issue_comments_499738.json:
```json
{
    "body": "Changed commit from **[`1c5d47d`](https://github.com/sagemath/sagetrac-mirror/commit/1c5d47d8c9f1ccca7bafcd45eb6f67d4f71c64db)** to **[`d6d6ba4`](https://github.com/sagemath/sagetrac-mirror/commit/d6d6ba416ad27f586ffbe2137c7a1867f1a78130)**",
    "created_at": "2021-01-17T20:59:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31182#issuecomment-499738",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`1c5d47d`](https://github.com/sagemath/sagetrac-mirror/commit/1c5d47d8c9f1ccca7bafcd45eb6f67d4f71c64db)** to **[`d6d6ba4`](https://github.com/sagemath/sagetrac-mirror/commit/d6d6ba416ad27f586ffbe2137c7a1867f1a78130)**



---

archive/issue_comments_499739.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nIf this approach gets a positive review as well as #30284 based upon that, I'll add an explicit doctest for the pickling with #30284 to this file.\n\nIf I understand this correctly, `__setstate__` and `__getstate__` are high level methods so that any implementation of `__reduce__` would overwrite their behavior, which is exactly what we want.",
    "created_at": "2021-01-17T21:02:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31182#issuecomment-499739",
    "user": "https://github.com/mjungmath"
}
```

<div id="comment:24" align="right">comment:24</div>

If this approach gets a positive review as well as #30284 based upon that, I'll add an explicit doctest for the pickling with #30284 to this file.

If I understand this correctly, `__setstate__` and `__getstate__` are high level methods so that any implementation of `__reduce__` would overwrite their behavior, which is exactly what we want.



---

archive/issue_comments_499740.json:
```json
{
    "body": "<div id=\"comment:25\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6cbd1fd918ef9fdc73310b10e9a50e6c9bf4b7ed\">6cbd1fd</a></td><td><code>Trac #31182: doctests added for `__setstate__` and __getstate__</code></td></tr></table>\n",
    "created_at": "2021-01-18T08:17:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31182#issuecomment-499740",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:25"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6cbd1fd918ef9fdc73310b10e9a50e6c9bf4b7ed">6cbd1fd</a></td><td><code>Trac #31182: doctests added for `__setstate__` and __getstate__</code></td></tr></table>




---

archive/issue_comments_499741.json:
```json
{
    "body": "Changed commit from **[`d6d6ba4`](https://github.com/sagemath/sagetrac-mirror/commit/d6d6ba416ad27f586ffbe2137c7a1867f1a78130)** to **[`6cbd1fd`](https://github.com/sagemath/sagetrac-mirror/commit/6cbd1fd918ef9fdc73310b10e9a50e6c9bf4b7ed)**",
    "created_at": "2021-01-18T08:17:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31182#issuecomment-499741",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`d6d6ba4`](https://github.com/sagemath/sagetrac-mirror/commit/d6d6ba416ad27f586ffbe2137c7a1867f1a78130)** to **[`6cbd1fd`](https://github.com/sagemath/sagetrac-mirror/commit/6cbd1fd918ef9fdc73310b10e9a50e6c9bf4b7ed)**



---

archive/issue_comments_499742.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nThis would work for any Python class I guess. If they implement their own version, then they are already taking responsibility for handling the mutability. It is a little hacky, but it is not so bad and it works for what is likely most cases. Let's see what the patchbot says.",
    "created_at": "2021-01-18T09:28:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31182#issuecomment-499742",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:26" align="right">comment:26</div>

This would work for any Python class I guess. If they implement their own version, then they are already taking responsibility for handling the mutability. It is a little hacky, but it is not so bad and it works for what is likely most cases. Let's see what the patchbot says.



---

archive/issue_comments_499743.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nI tried to write a test into the docstring:\n\n```\nsage: class A(SageObject, Mutability):\n....:     def __init__(self, val):\n....:         self._val = val\n....:     def change(self, val):\n....:         self._require_mutable()\n....:         self._val = val\n....:     def __hash__(self):\n....:         self._require_immutable()\n....:         return hash(self._val)\nsage: a = A(4)\nsage: loads(dumps(a))\n```\n\nThe doctest fails with:\n\n```\nFailed example:\n    loads(dumps(a))\nException raised:\n    Traceback (most recent call last):\n      File \"/home/michi/Projekte/sage-devel/local/lib/python3.8/site-packages/sage/doctest/forker.py\", line 714, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/michi/Projekte/sage-devel/local/lib/python3.8/site-packages/sage/doctest/forker.py\", line 1133, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.structure.mutability.Mutability.__getstate__[2]>\", line 1, in <module>\n        loads(dumps(a))\n      File \"sage/misc/persist.pyx\", line 291, in sage.misc.persist.dumps (build/cythonized/sage/misc/persist.c:4284)\n        return obj.dumps(compress)\n      File \"sage/structure/sage_object.pyx\", line 476, in sage.structure.sage_object.SageObject.dumps (build/cythonized/sage/structure/sage_object.c:3789)\n        return _base_dumps(self, compress=compress)\n      File \"sage/misc/persist.pyx\", line 264, in sage.misc.persist._base_dumps (build/cythonized/sage/misc/persist.c:4012)\n        gherkin = SagePickler.dumps(obj)\n      File \"sage/misc/persist.pyx\", line 771, in sage.misc.persist.SagePickler.dumps (build/cythonized/sage/misc/persist.c:6801)\n        pickler.dump(obj)\n    _pickle.PicklingError: Can't pickle <class '__main__.A'>: attribute lookup A on __main__ failed\n\n```\n\nIt is a bit odd since it works perfectly within a usual Sage instance. Only as a doctest this fails. Doctests where `Mutability` is included in #30284 on the other hand work perfectly again.",
    "created_at": "2021-01-18T10:01:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31182#issuecomment-499743",
    "user": "https://github.com/mjungmath"
}
```

<div id="comment:27" align="right">comment:27</div>

I tried to write a test into the docstring:

```
sage: class A(SageObject, Mutability):
....:     def __init__(self, val):
....:         self._val = val
....:     def change(self, val):
....:         self._require_mutable()
....:         self._val = val
....:     def __hash__(self):
....:         self._require_immutable()
....:         return hash(self._val)
sage: a = A(4)
sage: loads(dumps(a))
```

The doctest fails with:

```
Failed example:
    loads(dumps(a))
Exception raised:
    Traceback (most recent call last):
      File "/home/michi/Projekte/sage-devel/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/michi/Projekte/sage-devel/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.structure.mutability.Mutability.__getstate__[2]>", line 1, in <module>
        loads(dumps(a))
      File "sage/misc/persist.pyx", line 291, in sage.misc.persist.dumps (build/cythonized/sage/misc/persist.c:4284)
        return obj.dumps(compress)
      File "sage/structure/sage_object.pyx", line 476, in sage.structure.sage_object.SageObject.dumps (build/cythonized/sage/structure/sage_object.c:3789)
        return _base_dumps(self, compress=compress)
      File "sage/misc/persist.pyx", line 264, in sage.misc.persist._base_dumps (build/cythonized/sage/misc/persist.c:4012)
        gherkin = SagePickler.dumps(obj)
      File "sage/misc/persist.pyx", line 771, in sage.misc.persist.SagePickler.dumps (build/cythonized/sage/misc/persist.c:6801)
        pickler.dump(obj)
    _pickle.PicklingError: Can't pickle <class '__main__.A'>: attribute lookup A on __main__ failed

```

It is a bit odd since it works perfectly within a usual Sage instance. Only as a doctest this fails. Doctests where `Mutability` is included in #30284 on the other hand work perfectly again.



---

archive/issue_comments_499744.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nOkay, seems to be perfectly normal, see `_test_pickling` in `sage_object.pyx`:\n\n```\n\n            sage: class Bla(SageObject): pass\n            sage: Bla()._test_pickling()\n            Traceback (most recent call last):\n            ...\n            PicklingError: Can't pickle <class '__main__.Bla'>: attribute\n            lookup ... failed\n\n        TODO: for a stronger test, this could send the object to a\n        remote Sage session, and get it back.\n```\n\nI'll just add, as already suggested, some tests from #30284 as soon as this ticket is ready, too.",
    "created_at": "2021-01-18T10:15:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31182#issuecomment-499744",
    "user": "https://github.com/mjungmath"
}
```

<div id="comment:28" align="right">comment:28</div>

Okay, seems to be perfectly normal, see `_test_pickling` in `sage_object.pyx`:

```

            sage: class Bla(SageObject): pass
            sage: Bla()._test_pickling()
            Traceback (most recent call last):
            ...
            PicklingError: Can't pickle <class '__main__.Bla'>: attribute
            lookup ... failed

        TODO: for a stronger test, this could send the object to a
        remote Sage session, and get it back.
```

I'll just add, as already suggested, some tests from #30284 as soon as this ticket is ready, too.



---

archive/issue_comments_499745.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nPatchbot is satisfied here, too. :)",
    "created_at": "2021-01-18T21:42:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31182#issuecomment-499745",
    "user": "https://github.com/mjungmath"
}
```

<div id="comment:29" align="right">comment:29</div>

Patchbot is satisfied here, too. :)



---

archive/issue_comments_499746.json:
```json
{
    "body": "Reviewer: **Travis Scrimshaw**",
    "created_at": "2021-01-21T06:55:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31182#issuecomment-499746",
    "user": "https://github.com/tscrim"
}
```

Reviewer: **Travis Scrimshaw**



---

archive/issue_events_429851.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2021-01-21T06:55:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31182#event-429851"
}
```



---

archive/issue_events_429852.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2021-01-21T06:55:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31182#event-429852"
}
```



---

archive/issue_comments_499747.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nThis will work for now. We can revisit this if further problems arise as we use this class more frequently.",
    "created_at": "2021-01-21T06:55:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31182#issuecomment-499747",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:30" align="right">comment:30</div>

This will work for now. We can revisit this if further problems arise as we use this class more frequently.



---

archive/issue_comments_499748.json:
```json
{
    "body": "Changed branch from **[u/gh-mjungmath/mutability_class_and_pickling](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-mjungmath/mutability_class_and_pickling)** to **[`6cbd1fd`](https://github.com/sagemath/sagetrac-mirror/commit/6cbd1fd918ef9fdc73310b10e9a50e6c9bf4b7ed)**",
    "created_at": "2021-03-07T17:05:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31182#issuecomment-499748",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/gh-mjungmath/mutability_class_and_pickling](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-mjungmath/mutability_class_and_pickling)** to **[`6cbd1fd`](https://github.com/sagemath/sagetrac-mirror/commit/6cbd1fd918ef9fdc73310b10e9a50e6c9bf4b7ed)**



---

archive/issue_events_429853.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-03-07T17:05:57Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31182#event-429853"
}
```



---

archive/issue_events_429854.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "d6cf85bd5016ee6fc75537d1611bbd154f025b87",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2021-03-07T17:05:57Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/31182",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31182#event-429854"
}
```
