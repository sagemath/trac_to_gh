# Issue 31313: Memory leak in bipartite_graph (and so in generalised_quadrangle_with_spread)

archive/issues_031076.json:
```json
{
    "assignees": [],
    "body": "Reproducer:\n\n```\nsage: from sage.combinat.designs.gen_quadrangles_with_spread import is_GQ_with_spread, dual_GQ_ovoid  # line 270\nsage: t = designs.generalised_quadrangle_hermitian_with_ovoid(3)  # line 272\nsage: t = dual_GQ_ovoid(*t)  # line 273\nsage: is_GQ_with_spread(*t, s=3, t=9)  # line 274\n```\nFor example, running the last `is_GQ_with_spread` command eats about 170MB per invocation that is never released.\n\nThe relevant tests were marked as `# known bug` in #30517.\n\nFixed by changing `A[i][j]` to `A[i, j]` to access matrix entries.\n\nThis avoids the memory leak which turns out to be\nin accessing matrix rows and is now tracked at #31340.\n\nDepends on #30517\n\nCC:  @dimpase @Ivo-Maffei @dcoudert\n\nKeywords: **generalised_quadrangle, bipartite graph**\n\nBranch: **[`0be8fbc`](https://github.com/sagemath/sagetrac-mirror/commit/0be8fbcb7d76a5b1d845a8cca1b4b04fc9b68ac1)**\n\nReviewer: **Dima Pasechnik**\n\nAuthor: **Dave Morris**\n\nComponent: **combinatorial designs**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/31313_\n\n",
    "closed_at": "2021-03-20T20:55:00Z",
    "created_at": "2021-01-31T20:50:41Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20combinatorial%20designs",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/bug",
        "https://github.com/sagemath/sage/labels/memleak"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.3",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Memory leak in bipartite_graph (and so in generalised_quadrangle_with_spread)",
    "type": "issue",
    "updated_at": "2021-04-19T16:39:21Z",
    "url": "https://github.com/sagemath/sage/issues/31313",
    "user": "https://github.com/vbraun"
}
```
Reproducer:

```
sage: from sage.combinat.designs.gen_quadrangles_with_spread import is_GQ_with_spread, dual_GQ_ovoid  # line 270
sage: t = designs.generalised_quadrangle_hermitian_with_ovoid(3)  # line 272
sage: t = dual_GQ_ovoid(*t)  # line 273
sage: is_GQ_with_spread(*t, s=3, t=9)  # line 274
```
For example, running the last `is_GQ_with_spread` command eats about 170MB per invocation that is never released.

The relevant tests were marked as `# known bug` in #30517.

Fixed by changing `A[i][j]` to `A[i, j]` to access matrix entries.

This avoids the memory leak which turns out to be
in accessing matrix rows and is now tracked at #31340.

Depends on #30517

CC:  @dimpase @Ivo-Maffei @dcoudert

Keywords: **generalised_quadrangle, bipartite graph**

Branch: **[`0be8fbc`](https://github.com/sagemath/sagetrac-mirror/commit/0be8fbcb7d76a5b1d845a8cca1b4b04fc9b68ac1)**

Reviewer: **Dima Pasechnik**

Author: **Dave Morris**

Component: **combinatorial designs**

_Issue created by migration from https://trac.sagemath.org/ticket/31313_





---

archive/issue_events_428464.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-01-31T20:50:41Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31313#event-428464"
}
```



---

archive/issue_events_428465.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-01-31T20:50:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20combinatorial%20designs",
    "label_color": "0000ff",
    "label_name": "c: combinatorial designs",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31313#event-428465"
}
```



---

archive/issue_events_428466.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-01-31T20:50:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31313#event-428466"
}
```



---

archive/issue_events_428467.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-01-31T20:50:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31313#event-428467"
}
```



---

archive/issue_comments_501884.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -9,3 +9,4 @@\n For example, running the last `is_GQ_with_spread` command eats about 170MB per invocation that is never released.\n \n \n+The relevant tests were marked as `# known bug` in #30517\n``````\n",
    "created_at": "2021-01-31T20:52:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501884",
    "user": "https://github.com/vbraun"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -9,3 +9,4 @@
 For example, running the last `is_GQ_with_spread` command eats about 170MB per invocation that is never released.
 
 
+The relevant tests were marked as `# known bug` in #30517
``````




---

archive/issue_comments_501885.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nFor me,\n\n```\nfrom sage.combinat.designs.gen_quadrangles_with_spread import is_GQ_with_spread, dual_GQ_ovoid ## line 270 ##\nt = designs.generalised_quadrangle_hermitian_with_ovoid(3) ## line 272 ##\nt = dual_GQ_ovoid(*t) ## line 273 ##\nfor n in [1..20]:\n    is_GQ_with_spread(*t, s=3, t=9) ## line 274 ##\n    print(get_memory_usage())\n```\n\ndoes NOT show increased memory usage. Putting the other commands inside the loop doesn't create a leak either. This is on Sage 9.2.",
    "created_at": "2021-02-02T07:03:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501885",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:2" align="right">comment:2</div>

For me,

```
from sage.combinat.designs.gen_quadrangles_with_spread import is_GQ_with_spread, dual_GQ_ovoid ## line 270 ##
t = designs.generalised_quadrangle_hermitian_with_ovoid(3) ## line 272 ##
t = dual_GQ_ovoid(*t) ## line 273 ##
for n in [1..20]:
    is_GQ_with_spread(*t, s=3, t=9) ## line 274 ##
    print(get_memory_usage())
```

does NOT show increased memory usage. Putting the other commands inside the loop doesn't create a leak either. This is on Sage 9.2.



---

archive/issue_comments_501886.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nFWIW, I see the leak. I tested nbruin's code with 9.2 and 9.3b6 on `CoCalc`, and 9.3b6 on MacOS 10.15.7. The numbers grew steadily in all cases, but the rate differed: about 170MB on `CoCalc` and about 90MB on MacOS.",
    "created_at": "2021-02-02T07:23:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501886",
    "user": "https://github.com/DaveWitteMorris"
}
```

<div id="comment:3" align="right">comment:3</div>

FWIW, I see the leak. I tested nbruin's code with 9.2 and 9.3b6 on `CoCalc`, and 9.3b6 on MacOS 10.15.7. The numbers grew steadily in all cases, but the rate differed: about 170MB on `CoCalc` and about 90MB on MacOS.



---

archive/issue_comments_501887.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nI apologize if this is noise, but it appears to me that this leak has nothing to do with quadrangles. Instead, the problem seems to be that there is a memory leak in the construction of bipartite graphs:\n\n```\nsage: m = 150\n....: n = 200\n....: A = Matrix(ZZ, m, n)\n....: for j in range(n):\n....:     i = randint(0,m-2)\n....:     A[i, j] = 1\n....:     A[i+1, j] = 1\n....: def graph(A):\n....:     G = Graph(A)\n....: def bipartite(A):\n....:     G = BipartiteGraph(A)\n....: start_mem = get_memory_usage()\n....: for n in [1..10]:\n....:     prev_mem = get_memory_usage()\n....:     graph(A)\n....:     print(\"graph:\", get_memory_usage() - prev_mem)\n....:     prev_mem = get_memory_usage()\n....:     bipartite(A)\n....:     print(\"bipartite:\", get_memory_usage() - prev_mem, get_memory_usage() - start\n....: _mem)\ngraph: 0.14453125\nbipartite: 185.1640625 185.30859375\ngraph: 0.0\nbipartite: 47.0 232.30859375\ngraph: 0.0\nbipartite: 47.00390625 279.3125\ngraph: 0.0\nbipartite: 48.0 327.3125\ngraph: 0.0\nbipartite: 67.0078125 394.3203125\ngraph: 0.0\nbipartite: 47.0 441.3203125\ngraph: 0.0\nbipartite: 48.0 489.3203125\ngraph: 0.0\nbipartite: 47.0 536.3203125\ngraph: 0.0\nbipartite: 46.0 582.3203125\ngraph: 0.0\nbipartite: 58.0 640.3203125\n```\nThis was on MacOS. On `CoCalc`, I got a consistent bipartite leak of 93.84375.",
    "created_at": "2021-02-02T09:54:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501887",
    "user": "https://github.com/DaveWitteMorris"
}
```

<div id="comment:4" align="right">comment:4</div>

I apologize if this is noise, but it appears to me that this leak has nothing to do with quadrangles. Instead, the problem seems to be that there is a memory leak in the construction of bipartite graphs:

```
sage: m = 150
....: n = 200
....: A = Matrix(ZZ, m, n)
....: for j in range(n):
....:     i = randint(0,m-2)
....:     A[i, j] = 1
....:     A[i+1, j] = 1
....: def graph(A):
....:     G = Graph(A)
....: def bipartite(A):
....:     G = BipartiteGraph(A)
....: start_mem = get_memory_usage()
....: for n in [1..10]:
....:     prev_mem = get_memory_usage()
....:     graph(A)
....:     print("graph:", get_memory_usage() - prev_mem)
....:     prev_mem = get_memory_usage()
....:     bipartite(A)
....:     print("bipartite:", get_memory_usage() - prev_mem, get_memory_usage() - start
....: _mem)
graph: 0.14453125
bipartite: 185.1640625 185.30859375
graph: 0.0
bipartite: 47.0 232.30859375
graph: 0.0
bipartite: 47.00390625 279.3125
graph: 0.0
bipartite: 48.0 327.3125
graph: 0.0
bipartite: 67.0078125 394.3203125
graph: 0.0
bipartite: 47.0 441.3203125
graph: 0.0
bipartite: 48.0 489.3203125
graph: 0.0
bipartite: 47.0 536.3203125
graph: 0.0
bipartite: 46.0 582.3203125
graph: 0.0
bipartite: 58.0 640.3203125
```
This was on MacOS. On `CoCalc`, I got a consistent bipartite leak of 93.84375.



---

archive/issue_comments_501888.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nAs a possibly interesting data point, also for this bipartite graph example I'm not getting a leak on sage 9.2, running on CentOS Linux release 7.9.2009 (Core). Extra build info on the underlying python: Python 3.8.5 (default, Dec 15 2020, 19:39:17) [GCC 4.8.5 20150623 (Red Hat 4.8.5-44)] on linux.",
    "created_at": "2021-02-02T23:07:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501888",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:5" align="right">comment:5</div>

As a possibly interesting data point, also for this bipartite graph example I'm not getting a leak on sage 9.2, running on CentOS Linux release 7.9.2009 (Core). Extra build info on the underlying python: Python 3.8.5 (default, Dec 15 2020, 19:39:17) [GCC 4.8.5 20150623 (Red Hat 4.8.5-44)] on linux.



---

archive/issue_comments_501889.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nThe problem seems to be a small leak when accessing a row of an integer matrix. The construction of a bipartite graph involves accessing all of the entries of the matrix. If the graph is large (such as 150 x 200), then the formula `A[jj][ii]` will be evaluated tens of thousands of times, which amplifies the leak.\n\n```\nsage: A = Matrix(ZZ, 200) \n....: def here_is_a_leak(A): \n....:     for n in range(10000): \n....:         row0 = A[0] \n....:  \n....: start_mem = get_memory_usage() \n....: for n in [1..5]: \n....:     prev_mem = get_memory_usage() \n....:     here_is_a_leak(A) \n....:     print(\"change in memory:\", round(get_memory_usage() - prev_mem, 1),  \n....:           \"\\n    total:\", round(get_memory_usage() - start_mem,1))               \nchange in memory: 162.2 \n    total: 162.2\nchange in memory: 15.0 \n    total: 177.2\nchange in memory: 16.0 \n    total: 193.2\nchange in memory: 24.0 \n    total: 217.2\nchange in memory: 16.0 \n    total: 233.2\n```\nThis is from 9.3b6 on MacOS, but I also tested 9.2 on `CoCalc`. The leak seemed to go away (most of the time, at least) when I changed `ZZ` in the definition of `A` to `QQ` or `RR` or `GF(2^10)`.",
    "created_at": "2021-02-02T23:20:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501889",
    "user": "https://github.com/DaveWitteMorris"
}
```

<div id="comment:6" align="right">comment:6</div>

The problem seems to be a small leak when accessing a row of an integer matrix. The construction of a bipartite graph involves accessing all of the entries of the matrix. If the graph is large (such as 150 x 200), then the formula `A[jj][ii]` will be evaluated tens of thousands of times, which amplifies the leak.

```
sage: A = Matrix(ZZ, 200) 
....: def here_is_a_leak(A): 
....:     for n in range(10000): 
....:         row0 = A[0] 
....:  
....: start_mem = get_memory_usage() 
....: for n in [1..5]: 
....:     prev_mem = get_memory_usage() 
....:     here_is_a_leak(A) 
....:     print("change in memory:", round(get_memory_usage() - prev_mem, 1),  
....:           "\n    total:", round(get_memory_usage() - start_mem,1))               
change in memory: 162.2 
    total: 162.2
change in memory: 15.0 
    total: 177.2
change in memory: 16.0 
    total: 193.2
change in memory: 24.0 
    total: 217.2
change in memory: 16.0 
    total: 233.2
```
This is from 9.3b6 on MacOS, but I also tested 9.2 on `CoCalc`. The leak seemed to go away (most of the time, at least) when I changed `ZZ` in the definition of `A` to `QQ` or `RR` or `GF(2^10)`.



---

archive/issue_comments_501890.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nIf my diagnosis is correct, then we might be able to solve the problem on this ticket just by changing `A[jj][ii]` to `A[jj,ii]`. I'll write a patch to try that out.\n\nIf it works, we can open a different ticket about the memory leak of `A[jj]`.",
    "created_at": "2021-02-03T00:07:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501890",
    "user": "https://github.com/DaveWitteMorris"
}
```

<div id="comment:7" align="right">comment:7</div>

If my diagnosis is correct, then we might be able to solve the problem on this ticket just by changing `A[jj][ii]` to `A[jj,ii]`. I'll write a patch to try that out.

If it works, we can open a different ticket about the memory leak of `A[jj]`.



---

archive/issue_comments_501891.json:
```json
{
    "body": "Branch: **[public/31313](https://github.com/sagemath/sagetrac-mirror/tree/public/31313)**",
    "created_at": "2021-02-03T01:17:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501891",
    "user": "https://github.com/DaveWitteMorris"
}
```

Branch: **[public/31313](https://github.com/sagemath/sagetrac-mirror/tree/public/31313)**



---

archive/issue_comments_501892.json:
```json
{
    "body": "<div id=\"comment:9\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/779ebd2c0b1b6f0b209ebb06899a46f173ed44f9\"><code>779ebd2</code></a></td><td><code>off by one error in doctest</code></td></tr></table>\n",
    "created_at": "2021-02-03T01:27:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501892",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:9"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/779ebd2c0b1b6f0b209ebb06899a46f173ed44f9"><code>779ebd2</code></a></td><td><code>off by one error in doctest</code></td></tr></table>




---

archive/issue_comments_501893.json:
```json
{
    "body": "Commit: **[`779ebd2`](https://github.com/sagemath/sagetrac-mirror/commit/779ebd2c0b1b6f0b209ebb06899a46f173ed44f9)**",
    "created_at": "2021-02-03T01:27:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501893",
    "user": "https://github.com/sagetrac-git"
}
```

Commit: **[`779ebd2`](https://github.com/sagemath/sagetrac-mirror/commit/779ebd2c0b1b6f0b209ebb06899a46f173ed44f9)**



---

archive/issue_comments_501894.json:
```json
{
    "body": "Changed keywords from **generalised_quadrangle** to **generalised_quadrangle, bipartite graph**",
    "created_at": "2021-02-03T01:33:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501894",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changed keywords from **generalised_quadrangle** to **generalised_quadrangle, bipartite graph**



---

archive/issue_events_428468.json:
```json
{
    "actor": "https://github.com/DaveWitteMorris",
    "created_at": "2021-02-03T01:33:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "label": "https://github.com/sagemath/sage/labels/memleak",
    "label_color": "d73a4a",
    "label_name": "memleak",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31313#event-428468"
}
```



---

archive/issue_comments_501895.json:
```json
{
    "body": "Author: **Dave Morris**",
    "created_at": "2021-02-03T01:33:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501895",
    "user": "https://github.com/DaveWitteMorris"
}
```

Author: **Dave Morris**



---

archive/issue_events_428469.json:
```json
{
    "actor": "https://github.com/DaveWitteMorris",
    "created_at": "2021-02-03T01:33:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31313#event-428469"
}
```



---

archive/issue_comments_501896.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nYes, that simple change fixes the problem for me (and dramatically speeds up the construction of the bipartite graph).\n\nSo we should be able to remove the `# known bug` tags from #30517.",
    "created_at": "2021-02-03T01:33:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501896",
    "user": "https://github.com/DaveWitteMorris"
}
```

<div id="comment:10" align="right">comment:10</div>

Yes, that simple change fixes the problem for me (and dramatically speeds up the construction of the bipartite graph).

So we should be able to remove the `# known bug` tags from #30517.



---

archive/issue_comments_501897.json:
```json
{
    "body": "<div id=\"comment:11\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/380d4384dd3e4fd31629c6a6939a17d9059503af\"><code>380d438</code></a></td><td><code>style: space after comma</code></td></tr></table>\n",
    "created_at": "2021-02-03T01:48:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501897",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:11"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/380d4384dd3e4fd31629c6a6939a17d9059503af"><code>380d438</code></a></td><td><code>style: space after comma</code></td></tr></table>




---

archive/issue_comments_501898.json:
```json
{
    "body": "Changed commit from **[`779ebd2`](https://github.com/sagemath/sagetrac-mirror/commit/779ebd2c0b1b6f0b209ebb06899a46f173ed44f9)** to **[`380d438`](https://github.com/sagemath/sagetrac-mirror/commit/380d4384dd3e4fd31629c6a6939a17d9059503af)**",
    "created_at": "2021-02-03T01:48:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501898",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`779ebd2`](https://github.com/sagemath/sagetrac-mirror/commit/779ebd2c0b1b6f0b209ebb06899a46f173ed44f9)** to **[`380d438`](https://github.com/sagemath/sagetrac-mirror/commit/380d4384dd3e4fd31629c6a6939a17d9059503af)**



---

archive/issue_comments_501899.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nEDIT: oops sorry, wrong ticket",
    "created_at": "2021-02-03T16:29:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501899",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:12" align="right">comment:12</div>

EDIT: oops sorry, wrong ticket



---

archive/issue_comments_501900.json:
```json
{
    "body": "Reviewer: **Dima Pasechnik**",
    "created_at": "2021-02-04T08:16:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501900",
    "user": "https://github.com/dimpase"
}
```

Reviewer: **Dima Pasechnik**



---

archive/issue_events_428470.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-02-04T08:16:42Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31313#event-428470"
}
```



---

archive/issue_events_428471.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-02-04T08:16:42Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31313#event-428471"
}
```



---

archive/issue_comments_501901.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nGreat catch! Please also base it on  #30517, and revert this known bug tag, here.",
    "created_at": "2021-02-04T08:16:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501901",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:13" align="right">comment:13</div>

Great catch! Please also base it on  #30517, and revert this known bug tag, here.



---

archive/issue_comments_501902.json:
```json
{
    "body": "Dependencies: **#30517**",
    "created_at": "2021-02-04T08:19:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501902",
    "user": "https://github.com/dimpase"
}
```

Dependencies: **#30517**



---

archive/issue_comments_501903.json:
```json
{
    "body": "Changed commit from **[`380d438`](https://github.com/sagemath/sagetrac-mirror/commit/380d4384dd3e4fd31629c6a6939a17d9059503af)** to **[`0be8fbc`](https://github.com/sagemath/sagetrac-mirror/commit/0be8fbcb7d76a5b1d845a8cca1b4b04fc9b68ac1)**",
    "created_at": "2021-02-04T09:29:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501903",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`380d438`](https://github.com/sagemath/sagetrac-mirror/commit/380d4384dd3e4fd31629c6a6939a17d9059503af)** to **[`0be8fbc`](https://github.com/sagemath/sagetrac-mirror/commit/0be8fbcb7d76a5b1d845a8cca1b4b04fc9b68ac1)**



---

archive/issue_comments_501904.json:
```json
{
    "body": "<div id=\"comment:15\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/36837a18013d5e13beb731386f42bcdb646f0e17\"><code>36837a1</code></a></td><td><code>added test function</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/08b88903af9a1e52b298d3558bcc6818fefbceea\"><code>08b8890</code></a></td><td><code>Merge branch 'public/combinat/30517' in 9.3.b6</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a6841da0ccbacea94b6815241b7be02e78dfda32\"><code>a6841da</code></a></td><td><code>adding known bug tags</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c40efe9f4b94adf9dffd778bbc68fdac997929e1\"><code>c40efe9</code></a></td><td><code>removed test()</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/70856340a81e3a83ffe13451f781898ac9f69c2c\"><code>7085634</code></a></td><td><code>Merge remote-tracking branch 'trac/public/31313' into public/31313</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0be8fbcb7d76a5b1d845a8cca1b4b04fc9b68ac1\"><code>0be8fbc</code></a></td><td><code>Revert \"adding known bug tags\" - they are fixed by trac:31313</code></td></tr></table>\n",
    "created_at": "2021-02-04T09:29:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501904",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:15"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/36837a18013d5e13beb731386f42bcdb646f0e17"><code>36837a1</code></a></td><td><code>added test function</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/08b88903af9a1e52b298d3558bcc6818fefbceea"><code>08b8890</code></a></td><td><code>Merge branch 'public/combinat/30517' in 9.3.b6</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a6841da0ccbacea94b6815241b7be02e78dfda32"><code>a6841da</code></a></td><td><code>adding known bug tags</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c40efe9f4b94adf9dffd778bbc68fdac997929e1"><code>c40efe9</code></a></td><td><code>removed test()</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/70856340a81e3a83ffe13451f781898ac9f69c2c"><code>7085634</code></a></td><td><code>Merge remote-tracking branch 'trac/public/31313' into public/31313</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0be8fbcb7d76a5b1d845a8cca1b4b04fc9b68ac1"><code>0be8fbc</code></a></td><td><code>Revert "adding known bug tags" - they are fixed by trac:31313</code></td></tr></table>




---

archive/issue_events_428472.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-02-04T09:40:19Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "title_is": "Memory leak in bipartite_graph (and so in generalised_quadrangle_with_spread)",
    "title_was": "Memory leak in generalized quadrangles",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31313#event-428472"
}
```



---

archive/issue_comments_501905.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nOK, all fixed",
    "created_at": "2021-02-04T09:43:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501905",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:17" align="right">comment:17</div>

OK, all fixed



---

archive/issue_events_428473.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-02-04T09:43:11Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31313#event-428473"
}
```



---

archive/issue_events_428474.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-02-04T09:43:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31313#event-428474"
}
```



---

archive/issue_comments_501906.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nThanks! I opened #31340 for the memory leak from `A[jj]`.",
    "created_at": "2021-02-04T21:15:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501906",
    "user": "https://github.com/DaveWitteMorris"
}
```

<div id="comment:18" align="right">comment:18</div>

Thanks! I opened #31340 for the memory leak from `A[jj]`.



---

archive/issue_events_428475.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-02-07T22:00:51Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31313#event-428475"
}
```



---

archive/issue_events_428476.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-02-07T22:00:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "label": "https://github.com/sagemath/sage/labels/duplicate",
    "label_color": "c6c6c6",
    "label_name": "duplicate",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31313#event-428476"
}
```



---

archive/issue_events_428477.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-02-07T22:00:51Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31313#event-428477"
}
```



---

archive/issue_events_428478.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "73239ab0bd586db32f8dfdb03587baf23ed32b3a",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2021-02-07T22:00:51Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31313#event-428478"
}
```



---

archive/issue_comments_501907.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\n@vbraun: This ticket (#31313) is not a duplicate. The PR here gets rid of a memory leak (and therefore removes the `# known bug` tags that were added in #30517). More work needs to be done (so there is a follow up ticket), but I think this ticket should be enough to make your buildbot run. If not, please let us know.",
    "created_at": "2021-02-07T22:47:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501907",
    "user": "https://github.com/DaveWitteMorris"
}
```

<div id="comment:20" align="right">comment:20</div>

@vbraun: This ticket (#31313) is not a duplicate. The PR here gets rid of a memory leak (and therefore removes the `# known bug` tags that were added in #30517). More work needs to be done (so there is a follow up ticket), but I think this ticket should be enough to make your buildbot run. If not, please let us know.



---

archive/issue_events_428479.json:
```json
{
    "actor": "https://github.com/koffie",
    "created_at": "2021-03-18T22:53:28Z",
    "event": "reopened",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31313#event-428479"
}
```



---

archive/issue_comments_501908.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nI looked at the code here and it seems that this code will probable also be faster then the old code since it is getting entries directly from the matrix instead of creating rows. It seems that the new code is not only a workaround for the underlying bug, but that it will also be better then the existing code even after the underlying bug has been fixed. So I think it makes sense to still merge this.",
    "created_at": "2021-03-18T22:53:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501908",
    "user": "https://github.com/koffie"
}
```

<div id="comment:21" align="right">comment:21</div>

I looked at the code here and it seems that this code will probable also be faster then the old code since it is getting entries directly from the matrix instead of creating rows. It seems that the new code is not only a workaround for the underlying bug, but that it will also be better then the existing code even after the underlying bug has been fixed. So I think it makes sense to still merge this.



---

archive/issue_events_428480.json:
```json
{
    "actor": "https://github.com/koffie",
    "created_at": "2021-03-18T22:53:28Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "label": "https://github.com/sagemath/sage/labels/duplicate",
    "label_color": "c6c6c6",
    "label_name": "duplicate",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31313#event-428480"
}
```



---

archive/issue_events_428481.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-03-19T12:41:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31313#event-428481"
}
```



---

archive/issue_comments_501909.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nneeds review? Or good to go?",
    "created_at": "2021-03-19T12:41:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501909",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:22" align="right">comment:22</div>

needs review? Or good to go?



---

archive/issue_comments_501910.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nre-checked, all good",
    "created_at": "2021-03-19T12:46:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501910",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:23" align="right">comment:23</div>

re-checked, all good



---

archive/issue_events_428482.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-03-19T12:46:48Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31313#event-428482"
}
```



---

archive/issue_events_428483.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-03-19T12:46:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31313#event-428483"
}
```



---

archive/issue_comments_501911.json:
```json
{
    "body": "Changed branch from **[public/31313](https://github.com/sagemath/sagetrac-mirror/tree/public/31313)** to **[`0be8fbc`](https://github.com/sagemath/sagetrac-mirror/commit/0be8fbcb7d76a5b1d845a8cca1b4b04fc9b68ac1)**",
    "created_at": "2021-03-20T20:55:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501911",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[public/31313](https://github.com/sagemath/sagetrac-mirror/tree/public/31313)** to **[`0be8fbc`](https://github.com/sagemath/sagetrac-mirror/commit/0be8fbcb7d76a5b1d845a8cca1b4b04fc9b68ac1)**



---

archive/issue_events_428484.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-03-20T20:55:00Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31313#event-428484"
}
```



---

archive/issue_events_428485.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-03-20T20:55:00Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31313#event-428485"
}
```



---

archive/issue_comments_501912.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nThanks for fixing this and opening the follow-up ticket #31340!\n\nIdeally, `all`, `any`, `sum`, `prod` should be\ncalled on generators rather than lists when possible.\n\nWhen coming across cases of use with list,\nit's good to replace them.\n\n```diff\n-        sage: all([x in t[0] for x in t[1]])\n+        sage: all(x in t[0] for x in t[1])\n```\n\nNot the point of this ticket though; will be done elsewhere.",
    "created_at": "2021-03-21T00:34:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501912",
    "user": "https://github.com/slel"
}
```

<div id="comment:25" align="right">comment:25</div>

Thanks for fixing this and opening the follow-up ticket #31340!

Ideally, `all`, `any`, `sum`, `prod` should be
called on generators rather than lists when possible.

When coming across cases of use with list,
it's good to replace them.

```diff
-        sage: all([x in t[0] for x in t[1]])
+        sage: all(x in t[0] for x in t[1])
```

Not the point of this ticket though; will be done elsewhere.



---

archive/issue_comments_501913.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,12 +1,16 @@\n Reproducer:\n \n ```\n-sage: from sage.combinat.designs.gen_quadrangles_with_spread import is_GQ_with_spread, dual_GQ_ovoid ## line 270 ##\n-sage: t = designs.generalised_quadrangle_hermitian_with_ovoid(3) ## line 272 ##\n-sage: t = dual_GQ_ovoid(*t) ## line 273 ##\n-sage: is_GQ_with_spread(*t, s=3, t=9) ## line 274 ##\n+sage: from sage.combinat.designs.gen_quadrangles_with_spread import is_GQ_with_spread, dual_GQ_ovoid  # line 270\n+sage: t = designs.generalised_quadrangle_hermitian_with_ovoid(3)  # line 272\n+sage: t = dual_GQ_ovoid(*t)  # line 273\n+sage: is_GQ_with_spread(*t, s=3, t=9)  # line 274\n ```\n For example, running the last `is_GQ_with_spread` command eats about 170MB per invocation that is never released.\n \n+The relevant tests were marked as `# known bug` in #30517.\n \n-The relevant tests were marked as `# known bug` in #30517\n+Fixed by changing `A[i][j]` to `A[i, j]` to access matrix entries.\n+\n+This avoids the memory leak which turns out to be\n+in accessing matrix rows and is now tracked at #31340.\n``````\n",
    "created_at": "2021-03-21T00:34:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501913",
    "user": "https://github.com/slel"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,12 +1,16 @@
 Reproducer:
 
 ```
-sage: from sage.combinat.designs.gen_quadrangles_with_spread import is_GQ_with_spread, dual_GQ_ovoid ## line 270 ##
-sage: t = designs.generalised_quadrangle_hermitian_with_ovoid(3) ## line 272 ##
-sage: t = dual_GQ_ovoid(*t) ## line 273 ##
-sage: is_GQ_with_spread(*t, s=3, t=9) ## line 274 ##
+sage: from sage.combinat.designs.gen_quadrangles_with_spread import is_GQ_with_spread, dual_GQ_ovoid  # line 270
+sage: t = designs.generalised_quadrangle_hermitian_with_ovoid(3)  # line 272
+sage: t = dual_GQ_ovoid(*t)  # line 273
+sage: is_GQ_with_spread(*t, s=3, t=9)  # line 274
 ```
 For example, running the last `is_GQ_with_spread` command eats about 170MB per invocation that is never released.
 
+The relevant tests were marked as `# known bug` in #30517.
 
-The relevant tests were marked as `# known bug` in #30517
+Fixed by changing `A[i][j]` to `A[i, j]` to access matrix entries.
+
+This avoids the memory leak which turns out to be
+in accessing matrix rows and is now tracked at #31340.
``````




---

archive/issue_comments_501914.json:
```json
{
    "body": "Changed commit from **[`0be8fbc`](https://github.com/sagemath/sagetrac-mirror/commit/0be8fbcb7d76a5b1d845a8cca1b4b04fc9b68ac1)** to none",
    "created_at": "2021-03-21T00:34:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501914",
    "user": "https://github.com/slel"
}
```

Changed commit from **[`0be8fbc`](https://github.com/sagemath/sagetrac-mirror/commit/0be8fbcb7d76a5b1d845a8cca1b4b04fc9b68ac1)** to none



---

archive/issue_comments_501915.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nAre you sure? I'd be happy to do it either way, but I've been told that using a list is faster.  See, for example, [#11606 comment:12](https://github.com/sagemath/sage/issues/11606#comment:12)",
    "created_at": "2021-03-21T00:50:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501915",
    "user": "https://github.com/DaveWitteMorris"
}
```

<div id="comment:26" align="right">comment:26</div>

Are you sure? I'd be happy to do it either way, but I've been told that using a list is faster.  See, for example, [#11606 comment:12](https://github.com/sagemath/sage/issues/11606#comment:12)



---

archive/issue_comments_501916.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nOops, here goes my belief that using lists made things slower.\n\nThanks for telling me and for the reference.",
    "created_at": "2021-03-21T01:20:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501916",
    "user": "https://github.com/slel"
}
```

<div id="comment:27" align="right">comment:27</div>

Oops, here goes my belief that using lists made things slower.

Thanks for telling me and for the reference.



---

archive/issue_comments_501917.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nUsing an iterator seems much more pythonic, and must use less memory, so maybe it's better, even though it may be a bit slower, but I'm no expert and just try to do what I'm told (and often get confused about what I'm supposed to do).",
    "created_at": "2021-03-21T01:34:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501917",
    "user": "https://github.com/DaveWitteMorris"
}
```

<div id="comment:28" align="right">comment:28</div>

Using an iterator seems much more pythonic, and must use less memory, so maybe it's better, even though it may be a bit slower, but I'm no expert and just try to do what I'm told (and often get confused about what I'm supposed to do).



---

archive/issue_comments_501918.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nI am semi-regularly getting errors with the new doctest\n\n```\nFile \"src/sage/graphs/bipartite_graph.py\", line 326, in sage.graphs.bipartite_graph.BipartiteGraph.__init__\nFailed example:\n    print(round(get_memory_usage() - start_mem))\nExpected:\n    0.0\nGot:\n    1.0\n```\nThis is on OS X Big Sur and all recent Sage betas and rcs. I can reproduce with an interactive Sage session: if I run the loop\n\n```\nsage: for _ in range(10):\n....:     make_bip_graph(A)\n....:\n```\nit will sometimes cause an increase in memory usage.",
    "created_at": "2021-04-13T22:47:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501918",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:29" align="right">comment:29</div>

I am semi-regularly getting errors with the new doctest

```
File "src/sage/graphs/bipartite_graph.py", line 326, in sage.graphs.bipartite_graph.BipartiteGraph.__init__
Failed example:
    print(round(get_memory_usage() - start_mem))
Expected:
    0.0
Got:
    1.0
```
This is on OS X Big Sur and all recent Sage betas and rcs. I can reproduce with an interactive Sage session: if I run the loop

```
sage: for _ in range(10):
....:     make_bip_graph(A)
....:
```
it will sometimes cause an increase in memory usage.



---

archive/issue_comments_501919.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nReplying to [@jhpalmieri](#comment:29):\n> I am semi-regularly getting errors with the new doctest\n> \n> ```\n> File \"src/sage/graphs/bipartite_graph.py\", line 326, in sage.graphs.bipartite_graph.BipartiteGraph.__init__\n> Failed example:\n>     print(round(get_memory_usage() - start_mem))\n> Expected:\n>     0.0\n> Got:\n>     1.0\n> ```\n> This is on OS X Big Sur and all recent Sage betas and rcs. I can reproduce with an interactive Sage session: if I run the loop\n> \n> ```\n> sage: for _ in range(10):\n> ....:     make_bip_graph(A)\n> ....:\n> ```\n> it will sometimes cause an increase in memory usage.\n\nCan you capture the particular A for which you get this failure, and attach it here?\nOf course it might be macOS-specific...",
    "created_at": "2021-04-14T08:10:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501919",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:30" align="right">comment:30</div>

Replying to [@jhpalmieri](#comment:29):
> I am semi-regularly getting errors with the new doctest
> 
> ```
> File "src/sage/graphs/bipartite_graph.py", line 326, in sage.graphs.bipartite_graph.BipartiteGraph.__init__
> Failed example:
>     print(round(get_memory_usage() - start_mem))
> Expected:
>     0.0
> Got:
>     1.0
> ```
> This is on OS X Big Sur and all recent Sage betas and rcs. I can reproduce with an interactive Sage session: if I run the loop
> 
> ```
> sage: for _ in range(10):
> ....:     make_bip_graph(A)
> ....:
> ```
> it will sometimes cause an increase in memory usage.

Can you capture the particular A for which you get this failure, and attach it here?
Of course it might be macOS-specific...



---

archive/issue_comments_501920.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nI have attached one example, but the following is quite repeatable for me:\n\n- start a fresh Sage session and do this:\n\n```\nsage: A = Matrix(ZZ, 100, 125)\nsage: for i in range(A.nrows()):\n....:     for j in Subsets(A.ncols()).random_element():\n....:         A[i, j-1] = 1\n....:\nsage: def make_bip_graph(A):\n....:     G = BipartiteGraph(A)\n....:\nsage: start_mem = get_memory_usage()\n```\nThen I repeat these commands\n\n```\nsage: for _ in range(100):\n....:     make_bip_graph(A)\n....:\nsage: print(round(get_memory_usage() - start_mem))\n```\nand the output often, but not always, increases. Every time I've started Sage, I have seen an increase: it doesn't seem to rely on a very specific value of `A`.\n\nFurther, if in the same Sage session, I redefine `A` by `A = Matrix(...)` and then use the loop `for i in ...`, then I don't see the memory leak any more, no matter how many times I iterate `make_bip_graph(A)`.",
    "created_at": "2021-04-14T19:00:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501920",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:31" align="right">comment:31</div>

I have attached one example, but the following is quite repeatable for me:

- start a fresh Sage session and do this:

```
sage: A = Matrix(ZZ, 100, 125)
sage: for i in range(A.nrows()):
....:     for j in Subsets(A.ncols()).random_element():
....:         A[i, j-1] = 1
....:
sage: def make_bip_graph(A):
....:     G = BipartiteGraph(A)
....:
sage: start_mem = get_memory_usage()
```
Then I repeat these commands

```
sage: for _ in range(100):
....:     make_bip_graph(A)
....:
sage: print(round(get_memory_usage() - start_mem))
```
and the output often, but not always, increases. Every time I've started Sage, I have seen an increase: it doesn't seem to rely on a very specific value of `A`.

Further, if in the same Sage session, I redefine `A` by `A = Matrix(...)` and then use the loop `for i in ...`, then I don't see the memory leak any more, no matter how many times I iterate `make_bip_graph(A)`.



---

archive/issue_comments_501921.json:
```json
{
    "body": "Attachment: **[test.sobj.gz](https://github.com/sagemath/sage/files/ticket31313/test.sobj.gz)**",
    "created_at": "2021-04-14T19:01:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501921",
    "user": "https://github.com/jhpalmieri"
}
```

Attachment: **[test.sobj.gz](https://github.com/sagemath/sage/files/ticket31313/test.sobj.gz)**



---

archive/issue_comments_501922.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nCan it increase multiple times per session? Or is it just one time per session that this happens?\n\nAlso what happens if you do first\n\n```\nimport gc\n```\n\nand then\n\n```\ngc.collect()\n```\n\nright before every call of `get_memory_usage()`",
    "created_at": "2021-04-15T06:19:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501922",
    "user": "https://github.com/koffie"
}
```

<div id="comment:32" align="right">comment:32</div>

Can it increase multiple times per session? Or is it just one time per session that this happens?

Also what happens if you do first

```
import gc
```

and then

```
gc.collect()
```

right before every call of `get_memory_usage()`



---

archive/issue_comments_501923.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nReplying to [@koffie](#comment:32):\n> Can it increase multiple times per session? Or is it just one time per session that this happens?\n> \n> Also what happens if you do first\n> \n> ```\n> import gc\n> ```\n> \n> and then\n> \n> ```\n> gc.collect()\n> ```\n> \n> right before every call of `get_memory_usage()`\n> \n\nindeed, what John sees might be merely a bug in this doctest.\nWithout `gc.collect()` calls, it is not reliable, IMHO.\nE.g. in `src/sage/geometry/polyhedron/base.py` on has\n\n```\n        Test that computing the face lattice does not lead to a memory leak::\n\n            sage: import gc\n            sage: _ = gc.collect()\n            sage: P = polytopes.cube()\n            sage: a = P.face_lattice()\n            sage: n = get_memory_usage()\n            sage: P = polytopes.cube()\n            sage: a = P.face_lattice()\n            sage: _ = gc.collect()\n            sage: n == get_memory_usage()\n            True\n```\n\nthis is the only other memory leak test in the library which uses `get_memory_usage()` - other places merely use it for information (or just it's a useless `import` which can go).\n\nI've opened #31671 to fix this.",
    "created_at": "2021-04-15T09:07:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501923",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:33" align="right">comment:33</div>

Replying to [@koffie](#comment:32):
> Can it increase multiple times per session? Or is it just one time per session that this happens?
> 
> Also what happens if you do first
> 
> ```
> import gc
> ```
> 
> and then
> 
> ```
> gc.collect()
> ```
> 
> right before every call of `get_memory_usage()`
> 

indeed, what John sees might be merely a bug in this doctest.
Without `gc.collect()` calls, it is not reliable, IMHO.
E.g. in `src/sage/geometry/polyhedron/base.py` on has

```
        Test that computing the face lattice does not lead to a memory leak::

            sage: import gc
            sage: _ = gc.collect()
            sage: P = polytopes.cube()
            sage: a = P.face_lattice()
            sage: n = get_memory_usage()
            sage: P = polytopes.cube()
            sage: a = P.face_lattice()
            sage: _ = gc.collect()
            sage: n == get_memory_usage()
            True
```

this is the only other memory leak test in the library which uses `get_memory_usage()` - other places merely use it for information (or just it's a useless `import` which can go).

I've opened #31671 to fix this.



---

archive/issue_comments_501924.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nReplying to [@koffie](#comment:32):\n> Can it increase multiple times per session? Or is it just one time per session that this happens?\n\nMultiple times per session as long as I don't change the matrix `A`.\n \n> Also what happens if you do first\n> \n> ```\n> import gc\n> ```\n> \n> and then\n> \n> ```\n> gc.collect()\n> ```\n> \n> right before every call of `get_memory_usage()`\n\nDoesn't help:\n\n```\n% sage                                 \n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 9.3.rc3, Release Date: 2021-04-12                 \u2502\n\u2502 Using Python 3.9.2. Type \"help()\" for help.                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\nsage: A = Matrix(ZZ, 100, 125)                                                                                             \nsage: for i in range(A.nrows()): \n....:     for j in Subsets(A.ncols()).random_element(): \n....:         A[i, j-1] = 1 \n....:                                                                                                                      \nsage: def make_bip_graph(A): \n....:     G = BipartiteGraph(A) \n....:                                                                                                                      \nsage: import gc                                                                                                            \nsage: gc.collect()                                                                                                         \n349\nsage: start_mem = get_memory_usage()                                                                                       \nsage: for _ in range(100):    \n....:     make_bip_graph(A) \n....:                                                                                                                      \nsage: gc.collect()                                                                                                         \n763\nsage: print(round(get_memory_usage() - start_mem))                                                                         \n16.0\n```",
    "created_at": "2021-04-15T16:01:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501924",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:34" align="right">comment:34</div>

Replying to [@koffie](#comment:32):
> Can it increase multiple times per session? Or is it just one time per session that this happens?

Multiple times per session as long as I don't change the matrix `A`.
 
> Also what happens if you do first
> 
> ```
> import gc
> ```
> 
> and then
> 
> ```
> gc.collect()
> ```
> 
> right before every call of `get_memory_usage()`

Doesn't help:

```
% sage                                 

 SageMath version 9.3.rc3, Release Date: 2021-04-12                 
 Using Python 3.9.2. Type "help()" for help.                        


 Warning: this is a prerelease version, and it may be unstable.     

sage: A = Matrix(ZZ, 100, 125)                                                                                             
sage: for i in range(A.nrows()): 
....:     for j in Subsets(A.ncols()).random_element(): 
....:         A[i, j-1] = 1 
....:                                                                                                                      
sage: def make_bip_graph(A): 
....:     G = BipartiteGraph(A) 
....:                                                                                                                      
sage: import gc                                                                                                            
sage: gc.collect()                                                                                                         
349
sage: start_mem = get_memory_usage()                                                                                       
sage: for _ in range(100):    
....:     make_bip_graph(A) 
....:                                                                                                                      
sage: gc.collect()                                                                                                         
763
sage: print(round(get_memory_usage() - start_mem))                                                                         
16.0
```



---

archive/issue_comments_501925.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\n(un)fortunately this is platform dependent - I can't reproduce this on Linux",
    "created_at": "2021-04-15T16:32:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501925",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:35" align="right">comment:35</div>

(un)fortunately this is platform dependent - I can't reproduce this on Linux



---

archive/issue_comments_501926.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nWhat packages might affect this? I can enable/disable more homebrew packages and see if that makes a difference.",
    "created_at": "2021-04-15T17:01:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501926",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:36" align="right">comment:36</div>

What packages might affect this? I can enable/disable more homebrew packages and see if that makes a difference.



---

archive/issue_comments_501927.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nit doesn't use anything external, I think, it's just sagelib and cython, IMHO.",
    "created_at": "2021-04-15T17:15:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501927",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:37" align="right">comment:37</div>

it doesn't use anything external, I think, it's just sagelib and cython, IMHO.



---

archive/issue_comments_501928.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\non macOS 10.5.7 I observe a very small memory increase the first time we can the graph constructor. Could it be due to a lazy import or something like that ?\n\n```\nsapristi:sage dcoudert$ ./sage\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 9.3.rc3, Release Date: 2021-04-12                 \u2502\n\u2502 Using Python 3.9.2. Type \"help()\" for help.                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\nsage: sage: m = 150 \n....: ....: n = 200 \n....: ....: A = Matrix(ZZ, m, n) \n....: ....: for j in range(n): \n....: ....:     i = randint(0,m-2) \n....: ....:     A[i, j] = 1 \n....: ....:     A[i+1, j] = 1 \n....: ....: def graph(A): \n....: ....:     G = Graph(A) \n....: ....: def bipartite(A): \n....: ....:     G = BipartiteGraph(A) \n....: ....: start_mem = get_memory_usage() \n....: ....: for n in [1..10]: \n....: ....:     prev_mem = get_memory_usage() \n....: ....:     graph(A) \n....: ....:     print(\"graph:\", get_memory_usage() - prev_mem) \n....: ....:     prev_mem = get_memory_usage() \n....: ....:     bipartite(A) \n....: ....:     print(\"bipartite:\", get_memory_usage() - prev_mem, get_memory_usage() - start_mem)                                                 \ngraph: 0.171875\nbipartite: 0.0 0.171875\ngraph: 0.0\nbipartite: 0.0 0.171875\ngraph: 0.0\nbipartite: 0.0 0.171875\ngraph: 0.0\nbipartite: 0.0 0.171875\ngraph: 0.0\nbipartite: 0.0 0.171875\ngraph: 0.0\nbipartite: 0.0 0.171875\ngraph: 0.0\nbipartite: 0.0 0.171875\ngraph: 0.0\nbipartite: 0.0 0.171875\ngraph: 0.0\nbipartite: 0.0 0.171875\ngraph: 0.0\nbipartite: 0.0 0.171875\n```\n\n```\nsapristi:sage dcoudert$ ./sage\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 9.3.rc3, Release Date: 2021-04-12                 \u2502\n\u2502 Using Python 3.9.2. Type \"help()\" for help.                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\nsage: sage: A = Matrix(ZZ, 100, 125)                                                                                              \n....: sage: for i in range(A.nrows()):  \n....: ....:     for j in Subsets(A.ncols()).random_element():  \n....: ....:         A[i, j-1] = 1  \n....: ....:                                                                                                                       \n....: sage: def make_bip_graph(A):  \n....: ....:     G = BipartiteGraph(A)  \n....: ....:                                                                                                                       \n....: sage: import gc                                                                                                             \n....: sage: gc.collect()                                                                                                          \n....:                                                                                                                                              \n271\nsage: sage: start_mem = get_memory_usage()                                                                                        \n....: sage: for _ in range(100):     \n....: ....:     make_bip_graph(A)  \n....: ....:                                                                                                                       \n....: sage: gc.collect()                                                                                                          \n....:                                                                                                                                              \n82\nsage: print(round(get_memory_usage() - start_mem))                                                                                                 \n0.0\n```",
    "created_at": "2021-04-15T17:51:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501928",
    "user": "https://github.com/dcoudert"
}
```

<div id="comment:38" align="right">comment:38</div>

on macOS 10.5.7 I observe a very small memory increase the first time we can the graph constructor. Could it be due to a lazy import or something like that ?

```
sapristi:sage dcoudert$ ./sage

 SageMath version 9.3.rc3, Release Date: 2021-04-12                 
 Using Python 3.9.2. Type "help()" for help.                        


 Warning: this is a prerelease version, and it may be unstable.     

sage: sage: m = 150 
....: ....: n = 200 
....: ....: A = Matrix(ZZ, m, n) 
....: ....: for j in range(n): 
....: ....:     i = randint(0,m-2) 
....: ....:     A[i, j] = 1 
....: ....:     A[i+1, j] = 1 
....: ....: def graph(A): 
....: ....:     G = Graph(A) 
....: ....: def bipartite(A): 
....: ....:     G = BipartiteGraph(A) 
....: ....: start_mem = get_memory_usage() 
....: ....: for n in [1..10]: 
....: ....:     prev_mem = get_memory_usage() 
....: ....:     graph(A) 
....: ....:     print("graph:", get_memory_usage() - prev_mem) 
....: ....:     prev_mem = get_memory_usage() 
....: ....:     bipartite(A) 
....: ....:     print("bipartite:", get_memory_usage() - prev_mem, get_memory_usage() - start_mem)                                                 
graph: 0.171875
bipartite: 0.0 0.171875
graph: 0.0
bipartite: 0.0 0.171875
graph: 0.0
bipartite: 0.0 0.171875
graph: 0.0
bipartite: 0.0 0.171875
graph: 0.0
bipartite: 0.0 0.171875
graph: 0.0
bipartite: 0.0 0.171875
graph: 0.0
bipartite: 0.0 0.171875
graph: 0.0
bipartite: 0.0 0.171875
graph: 0.0
bipartite: 0.0 0.171875
graph: 0.0
bipartite: 0.0 0.171875
```

```
sapristi:sage dcoudert$ ./sage

 SageMath version 9.3.rc3, Release Date: 2021-04-12                 
 Using Python 3.9.2. Type "help()" for help.                        


 Warning: this is a prerelease version, and it may be unstable.     

sage: sage: A = Matrix(ZZ, 100, 125)                                                                                              
....: sage: for i in range(A.nrows()):  
....: ....:     for j in Subsets(A.ncols()).random_element():  
....: ....:         A[i, j-1] = 1  
....: ....:                                                                                                                       
....: sage: def make_bip_graph(A):  
....: ....:     G = BipartiteGraph(A)  
....: ....:                                                                                                                       
....: sage: import gc                                                                                                             
....: sage: gc.collect()                                                                                                          
....:                                                                                                                                              
271
sage: sage: start_mem = get_memory_usage()                                                                                        
....: sage: for _ in range(100):     
....: ....:     make_bip_graph(A)  
....: ....:                                                                                                                       
....: sage: gc.collect()                                                                                                          
....:                                                                                                                                              
82
sage: print(round(get_memory_usage() - start_mem))                                                                                                 
0.0
```



---

archive/issue_comments_501929.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nReplying to [@dcoudert](#comment:38):\n> on macOS 10.5.7 I observe a very small memory increase the first time we can the graph constructor. Could it be due to a lazy import or something like that ?\n\nCan you reproduce what's reported by John on macOS, or are we down to even more selective (perhaps CPU matters too?) bug in his case?",
    "created_at": "2021-04-18T09:26:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501929",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:39" align="right">comment:39</div>

Replying to [@dcoudert](#comment:38):
> on macOS 10.5.7 I observe a very small memory increase the first time we can the graph constructor. Could it be due to a lazy import or something like that ?

Can you reproduce what's reported by John on macOS, or are we down to even more selective (perhaps CPU matters too?) bug in his case?



---

archive/issue_comments_501930.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nWhen I try the branch of this ticket on macOS (10.5.7, intel CPU), I have no dockets error in `bipartite_graph.py`.\n\nWhen I start a session and copy/paste the test, I have a random result:\n\n```\nsapristi:sage dcoudert$ ./sage\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 9.3.rc4, Release Date: 2021-04-18                 \u2502\n\u2502 Using Python 3.9.2. Type \"help()\" for help.                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\nsage: A = Matrix(ZZ, 100, 125) \n....: for i in range(A.nrows()): \n....:     for j in Subsets(A.ncols()).random_element(): \n....:         A[i, j-1] = 1 \n....: def make_bip_graph(A): \n....:     G = BipartiteGraph(A) \n....: import gc \n....: gc.collect() \n....: start_mem = get_memory_usage() \n....: for _ in range(100): \n....:     make_bip_graph(A) \n....: gc.collect() \n....: print(round(get_memory_usage() - start_mem)) \n....:                                                                                                                                              \n282\n0\n0.0\nsage:                                                                                                                                              \nExiting Sage (CPU time 0m1.49s, Wall time 0m19.73s).\nsapristi:sage dcoudert$ ./sage\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 9.3.rc4, Release Date: 2021-04-18                 \u2502\n\u2502 Using Python 3.9.2. Type \"help()\" for help.                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\nsage: A = Matrix(ZZ, 100, 125) \n....: for i in range(A.nrows()): \n....:     for j in Subsets(A.ncols()).random_element(): \n....:         A[i, j-1] = 1 \n....: def make_bip_graph(A): \n....:     G = BipartiteGraph(A) \n....: import gc \n....: gc.collect() \n....: start_mem = get_memory_usage() \n....: for _ in range(100): \n....:     make_bip_graph(A) \n....: gc.collect() \n....: print(round(get_memory_usage() - start_mem)) \n....:                                                                                                                                              \n282\n0\n1.0\n```",
    "created_at": "2021-04-18T09:54:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501930",
    "user": "https://github.com/dcoudert"
}
```

<div id="comment:40" align="right">comment:40</div>

When I try the branch of this ticket on macOS (10.5.7, intel CPU), I have no dockets error in `bipartite_graph.py`.

When I start a session and copy/paste the test, I have a random result:

```
sapristi:sage dcoudert$ ./sage

 SageMath version 9.3.rc4, Release Date: 2021-04-18                 
 Using Python 3.9.2. Type "help()" for help.                        


 Warning: this is a prerelease version, and it may be unstable.     

sage: A = Matrix(ZZ, 100, 125) 
....: for i in range(A.nrows()): 
....:     for j in Subsets(A.ncols()).random_element(): 
....:         A[i, j-1] = 1 
....: def make_bip_graph(A): 
....:     G = BipartiteGraph(A) 
....: import gc 
....: gc.collect() 
....: start_mem = get_memory_usage() 
....: for _ in range(100): 
....:     make_bip_graph(A) 
....: gc.collect() 
....: print(round(get_memory_usage() - start_mem)) 
....:                                                                                                                                              
282
0
0.0
sage:                                                                                                                                              
Exiting Sage (CPU time 0m1.49s, Wall time 0m19.73s).
sapristi:sage dcoudert$ ./sage

 SageMath version 9.3.rc4, Release Date: 2021-04-18                 
 Using Python 3.9.2. Type "help()" for help.                        


 Warning: this is a prerelease version, and it may be unstable.     

sage: A = Matrix(ZZ, 100, 125) 
....: for i in range(A.nrows()): 
....:     for j in Subsets(A.ncols()).random_element(): 
....:         A[i, j-1] = 1 
....: def make_bip_graph(A): 
....:     G = BipartiteGraph(A) 
....: import gc 
....: gc.collect() 
....: start_mem = get_memory_usage() 
....: for _ in range(100): 
....:     make_bip_graph(A) 
....: gc.collect() 
....: print(round(get_memory_usage() - start_mem)) 
....:                                                                                                                                              
282
0
1.0
```



---

archive/issue_comments_501931.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\nReplying to [@dcoudert](#comment:40):\n> When I try the branch of this ticket on macOS (10.5.7, intel CPU), I have no dockets error in `bipartite_graph.py`.\n\nCan you try running the doctest several times? Does it pass 10 times in a row? Passing or failing is random for me.",
    "created_at": "2021-04-18T16:03:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501931",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:41" align="right">comment:41</div>

Replying to [@dcoudert](#comment:40):
> When I try the branch of this ticket on macOS (10.5.7, intel CPU), I have no dockets error in `bipartite_graph.py`.

Can you try running the doctest several times? Does it pass 10 times in a row? Passing or failing is random for me.



---

archive/issue_comments_501932.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nPassed 7 times and failed 3 times :(",
    "created_at": "2021-04-18T17:32:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501932",
    "user": "https://github.com/dcoudert"
}
```

<div id="comment:42" align="right">comment:42</div>

Passed 7 times and failed 3 times :(



---

archive/issue_comments_501933.json:
```json
{
    "body": "<div id=\"comment:43\" align=\"right\">comment:43</div>\n\nThank you for checking. I've tried with the system Python, homebrew's Python, and Sage's, and I get failures with all three. I don't know what else to do to investigate this.",
    "created_at": "2021-04-18T20:29:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501933",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:43" align="right">comment:43</div>

Thank you for checking. I've tried with the system Python, homebrew's Python, and Sage's, and I get failures with all three. I don't know what else to do to investigate this.



---

archive/issue_comments_501934.json:
```json
{
    "body": "<div id=\"comment:44\" align=\"right\">comment:44</div>\n\nI presume it must be a leak in a Cython backend, but which one I don't know (not that I tried looking, though)",
    "created_at": "2021-04-19T16:38:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31313#issuecomment-501934",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:44" align="right">comment:44</div>

I presume it must be a leak in a Cython backend, but which one I don't know (not that I tried looking, though)
