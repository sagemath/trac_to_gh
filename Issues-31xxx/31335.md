# Issue 31335: homebrew: Unused packages (singular, pari, ...) in /usr/local leak into sagelib/cysignals builds via distutils.cfg

archive/issues_031098.json:
```json
{
    "body": "Follow-up from #31132:\n\nIt has been reported that it's still leaking with the upgraded python3 from homebrew that includes https://github.com/Homebrew/homebrew-core/commit/784d29205ee5bd27fed226a5f96837428e171825\n\n\nThe `sagelib` build collects many `-I`, `-L` directives through pkgconfig. \nSuch directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.\nNow if `-I/usr/local/` or `-L/usr/local` (instead of more specific paths to `/usr/local/Cellar/.../...`) appear, then unwanted packages that happen to be installed can leak in. \n\nHowever, here the problem is caused by homebrew installing a `distutils.cfg` that injects `/usr/local/include` into our include search path.\nWe fix the leak by switching to a modern configuration of setuptools.\n\nThis also affects `cysignals`, as reported in https://groups.google.com/g/sage-release/c/KdSKg6RdZok/m/91Ibwn8RAgAJ\n\n\nRelevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~); possible follow-up: #31338\n\n\n\n\nCC:  @jhpalmieri @zlscherr @kiwifb @kliem @slel\n\nReviewer: John Palmieri\n\nAuthor: Matthias Koeppe\n\nBranch: e03c5ac0a9d2d82dd864d6d6d9560eddabbcbba5\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/31335\n\n",
    "closed_at": "2021-03-18T22:32:29Z",
    "created_at": "2021-02-04T02:32:45Z",
    "labels": [
        "component: build",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "homebrew: Unused packages (singular, pari, ...) in /usr/local leak into sagelib/cysignals builds via distutils.cfg",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31335",
    "user": "https://github.com/mkoeppe"
}
```
Follow-up from #31132:

It has been reported that it's still leaking with the upgraded python3 from homebrew that includes https://github.com/Homebrew/homebrew-core/commit/784d29205ee5bd27fed226a5f96837428e171825


The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. 
Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.
Now if `-I/usr/local/` or `-L/usr/local` (instead of more specific paths to `/usr/local/Cellar/.../...`) appear, then unwanted packages that happen to be installed can leak in. 

However, here the problem is caused by homebrew installing a `distutils.cfg` that injects `/usr/local/include` into our include search path.
We fix the leak by switching to a modern configuration of setuptools.

This also affects `cysignals`, as reported in https://groups.google.com/g/sage-release/c/KdSKg6RdZok/m/91Ibwn8RAgAJ


Relevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~); possible follow-up: #31338




CC:  @jhpalmieri @zlscherr @kiwifb @kliem @slel

Reviewer: John Palmieri

Author: Matthias Koeppe

Branch: e03c5ac0a9d2d82dd864d6d6d9560eddabbcbba5

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/31335





---

archive/issue_comments_621844.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#30589, #31132, #31227\"",
    "created_at": "2021-02-04T02:34:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621844",
    "user": "https://github.com/mkoeppe"
}
```

Changing dependencies from "" to "#30589, #31132, #31227"



---

archive/issue_comments_621845.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,12 @@\n Follow-up from #31132:\n \n It's still leaking.\n+\n+The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. \n+Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.\n+\n+\n+\n \n Comment: 1\n \n``````\n",
    "created_at": "2021-02-04T02:41:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621845",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,12 @@
 Follow-up from #31132:
 
 It's still leaking.
+
+The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. 
+Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.
+
+
+
 
 Comment: 1
 
``````




---

archive/issue_comments_621846.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,11 @@\n+Follow-up from #31132:\n+\n+It's still leaking.\n+\n+The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. \n+Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.\n+\n+Relevant tickets: #29562 (+), #29697 (?), #31041 (~)\n \n \n Comment: 1\n``````\n",
    "created_at": "2021-02-04T02:46:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621846",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,11 @@
+Follow-up from #31132:
+
+It's still leaking.
+
+The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. 
+Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.
+
+Relevant tickets: #29562 (+), #29697 (?), #31041 (~)
 
 
 Comment: 1
``````




---

archive/issue_comments_621847.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,11 @@\n+Follow-up from #31132:\n+\n+It's still leaking.\n+\n+The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. \n+Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.\n+\n+Relevant tickets: #29562 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)\n \n \n Comment: 1\n``````\n",
    "created_at": "2021-02-04T02:48:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621847",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,11 @@
+Follow-up from #31132:
+
+It's still leaking.
+
+The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. 
+Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.
+
+Relevant tickets: #29562 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)
 
 
 Comment: 1
``````




---

archive/issue_comments_621848.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,14 @@\n+Follow-up from #31132:\n+\n+It's still leaking.\n+\n+The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. \n+Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.\n+\n+To make sure that \n+\n+\n+Relevant tickets: #13348, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)\n \n \n Comment: 1\n``````\n",
    "created_at": "2021-02-04T02:54:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621848",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,14 @@
+Follow-up from #31132:
+
+It's still leaking.
+
+The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. 
+Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.
+
+To make sure that 
+
+
+Relevant tickets: #13348, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)
 
 
 Comment: 1
``````




---

archive/issue_comments_621849.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,14 @@\n+Follow-up from #31132:\n+\n+It's still leaking.\n+\n+The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. \n+Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.\n+\n+To make sure that \n+\n+\n+Relevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)\n \n \n Comment: 1\n``````\n",
    "created_at": "2021-02-04T02:55:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621849",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,14 @@
+Follow-up from #31132:
+
+It's still leaking.
+
+The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. 
+Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.
+
+To make sure that 
+
+
+Relevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)
 
 
 Comment: 1
``````




---

archive/issue_comments_621850.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,22 @@\n+Follow-up from #31132:\n+\n+It's still leaking.\n+\n+The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. \n+Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.\n+\n+Now if `-I/usr/local/` or `-L/usr/local` (instead of more specific paths to `/usr/local/Cellar/.../...`) appear, then unwanted packages that happen to be installed can leak in.\n+\n+To check whether this comes in through `pkg-config`:\n+\n+```\n+for a in $(pkg-config --list-all | sed 's/ .*//;'); do printf \"$a: \"; pkg-config --cflags $a; printf \"$a: \"; pkg-config --libs $a; done\n+```\n+\n+To make sure that libraries installed in $SAGE_LOCAL (if set) take precedence over such leaks, we should essentially revert #29697.\n+\n+\n+Relevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)\n \n \n Comment: 1\n``````\n",
    "created_at": "2021-02-04T03:05:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621850",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,22 @@
+Follow-up from #31132:
+
+It's still leaking.
+
+The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. 
+Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.
+
+Now if `-I/usr/local/` or `-L/usr/local` (instead of more specific paths to `/usr/local/Cellar/.../...`) appear, then unwanted packages that happen to be installed can leak in.
+
+To check whether this comes in through `pkg-config`:
+
+```
+for a in $(pkg-config --list-all | sed 's/ .*//;'); do printf "$a: "; pkg-config --cflags $a; printf "$a: "; pkg-config --libs $a; done
+```
+
+To make sure that libraries installed in $SAGE_LOCAL (if set) take precedence over such leaks, we should essentially revert #29697.
+
+
+Relevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)
 
 
 Comment: 1
``````




---

archive/issue_comments_621851.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,23 @@\n+Follow-up from #31132:\n+\n+It's still leaking.\n+\n+The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. \n+Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.\n+\n+Now if `-I/usr/local/` or `-L/usr/local` (instead of more specific paths to `/usr/local/Cellar/.../...`) appear, then unwanted packages that happen to be installed can leak in.\n+\n+To check whether this comes in through `pkg-config`:\n+\n+```\n+for a in $(pkg-config --list-all | sed 's/ .*//;'); do printf \"$a: \"; pkg-config --cflags $a; printf \"$a: \"; pkg-config --libs $a; done\n+```\n+\n+To make sure that libraries installed in $SAGE_LOCAL (if set) take precedence over such leaks, we should essentially revert #29697, adding some refinements:\n+- `SAGE_LOCAL` vs `SAGE_VENV`\n+- make sure that if `$SAGE_LOCAL` is unset, nothing is added\n+\n+Relevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)\n \n \n Comment: 1\n``````\n",
    "created_at": "2021-02-04T03:08:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621851",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,23 @@
+Follow-up from #31132:
+
+It's still leaking.
+
+The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. 
+Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.
+
+Now if `-I/usr/local/` or `-L/usr/local` (instead of more specific paths to `/usr/local/Cellar/.../...`) appear, then unwanted packages that happen to be installed can leak in.
+
+To check whether this comes in through `pkg-config`:
+
+```
+for a in $(pkg-config --list-all | sed 's/ .*//;'); do printf "$a: "; pkg-config --cflags $a; printf "$a: "; pkg-config --libs $a; done
+```
+
+To make sure that libraries installed in $SAGE_LOCAL (if set) take precedence over such leaks, we should essentially revert #29697, adding some refinements:
+- `SAGE_LOCAL` vs `SAGE_VENV`
+- make sure that if `$SAGE_LOCAL` is unset, nothing is added
+
+Relevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)
 
 
 Comment: 1
``````




---

archive/issue_comments_621852.json:
```json
{
    "body": "<a id='comment:9'></a>To check whether this comes in through pkg-config, I used:\n\n```\nfor a in $(pkg-config --list-all | sed 's/ .*//;'); do printf \"$a: \"; pkg-config --cflags $a; printf \"$a: \"; pkg-config --libs $a; done\n```\nHowever, on my system, the command line in the ticket description does not find any relevant packages that directly use `/usr/local/{include,lib}` (only `lua` and `fuse` do)",
    "created_at": "2021-02-04T03:12:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621852",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'></a>To check whether this comes in through pkg-config, I used:

```
for a in $(pkg-config --list-all | sed 's/ .*//;'); do printf "$a: "; pkg-config --cflags $a; printf "$a: "; pkg-config --libs $a; done
```
However, on my system, the command line in the ticket description does not find any relevant packages that directly use `/usr/local/{include,lib}` (only `lua` and `fuse` do)



---

archive/issue_comments_621853.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,23 @@\n+Follow-up from #31132:\n+\n+It's still leaking.\n+\n+The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. \n+Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.\n+\n+Now if `-I/usr/local/` or `-L/usr/local` (instead of more specific paths to `/usr/local/Cellar/.../...`) appear, then unwanted packages that happen to be installed can leak in.\n+\n+To check whether this comes in through `pkg-config`:\n+\n+```\n+for a in $(pkg-config --list-all | sed 's/ .*//;'); do printf \"$a: \"; pkg-config --cflags $a; printf \"$a: \"; pkg-config --libs $a; done\n+```\n+\n+To make sure that libraries installed in $SAGE_LOCAL (if set) take precedence over such leaks, we could essentially revert #29697, adding some refinements:\n+- `SAGE_LOCAL` vs `SAGE_VENV`\n+- make sure that if `$SAGE_LOCAL` is unset, nothing is added.\n+\n+Relevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)\n \n \n Comment: 1\n``````\n",
    "created_at": "2021-02-04T03:22:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621853",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,23 @@
+Follow-up from #31132:
+
+It's still leaking.
+
+The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. 
+Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.
+
+Now if `-I/usr/local/` or `-L/usr/local` (instead of more specific paths to `/usr/local/Cellar/.../...`) appear, then unwanted packages that happen to be installed can leak in.
+
+To check whether this comes in through `pkg-config`:
+
+```
+for a in $(pkg-config --list-all | sed 's/ .*//;'); do printf "$a: "; pkg-config --cflags $a; printf "$a: "; pkg-config --libs $a; done
+```
+
+To make sure that libraries installed in $SAGE_LOCAL (if set) take precedence over such leaks, we could essentially revert #29697, adding some refinements:
+- `SAGE_LOCAL` vs `SAGE_VENV`
+- make sure that if `$SAGE_LOCAL` is unset, nothing is added.
+
+Relevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)
 
 
 Comment: 1
``````




---

archive/issue_comments_621854.json:
```json
{
    "body": "Changing dependencies from \"#30589, #31132, #31227\" to \"#30589, #31132, #31227, #30770\"",
    "created_at": "2021-02-04T03:25:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621854",
    "user": "https://github.com/mkoeppe"
}
```

Changing dependencies from "#30589, #31132, #31227" to "#30589, #31132, #31227, #30770"



---

archive/issue_comments_621855.json:
```json
{
    "body": "Changing branch from \"\" to \"u/mkoeppe/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build\"",
    "created_at": "2021-02-04T04:10:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621855",
    "user": "https://github.com/mkoeppe"
}
```

Changing branch from "" to "u/mkoeppe/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build"



---

archive/issue_comments_621856.json:
```json
{
    "body": "<a id='comment:13'></a>With the tickets listed in Dependencies merged (that's the branch on this ticket) and after `brew install singular pari ecl`, I get leakage from singular:\n\n```\n[sagelib-9.3.beta6] [ 1/13] gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk -O2 -g -march=native -I./sage/cpython -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/build/pkgs/sagelib/src -I/usr/local/Cellar/python@3.9/3.9.1_7/Frameworks/Python.framework/Versions/3.9/include/python3.9 -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/numpy/core/include -Ibuild/cythonized -I/usr/local/include -I/usr/local/opt/openssl@1.1/include -I/usr/local/opt/sqlite/include -I/usr/local/opt/tcl-tk/include -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include -I/usr/local/Cellar/python@3.9/3.9.1_7/Frameworks/Python.framework/Versions/3.9/include/python3.9 -c build/cythonized/sage/algebras/letterplace/free_algebra_letterplace.cpp -o build/temp.macosx-10.15-x86_64-3.9/build/cythonized/sage/algebras/letterplace/free_algebra_letterplace.o -fno-strict-aliasing -DCYTHON_CLINE_IN_TRACEBACK=1 -DSING_NDEBUG -DOM_NDEBUG -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular -std=c++11\n[sagelib-9.3.beta6] In file included from build/cythonized/sage/algebras/letterplace/free_algebra_letterplace.cpp:672:\n[sagelib-9.3.beta6] In file included from /usr/local/include/singular/Singular/libsingular.h:7:\n[sagelib-9.3.beta6] In file included from /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular/kernel/structs.h:23:\n[sagelib-9.3.beta6] In file included from /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular/kernel/polys.h:15:\n[sagelib-9.3.beta6] In file included from /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular/polys/monomials/ring.h:13:\n[sagelib-9.3.beta6] In file included from /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular/coeffs/coeffs.h:19:\n[sagelib-9.3.beta6] In file included from /usr/local/include/factory/factory.h:28:\n[sagelib-9.3.beta6] /usr/local/include/factory/si_log2.h:6:19: error: redefinition of 'SI_LOG2'\n[sagelib-9.3.beta6] static inline int SI_LOG2(int v)\n```",
    "created_at": "2021-02-04T04:17:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621856",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>With the tickets listed in Dependencies merged (that's the branch on this ticket) and after `brew install singular pari ecl`, I get leakage from singular:

```
[sagelib-9.3.beta6] [ 1/13] gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk -O2 -g -march=native -I./sage/cpython -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/build/pkgs/sagelib/src -I/usr/local/Cellar/python@3.9/3.9.1_7/Frameworks/Python.framework/Versions/3.9/include/python3.9 -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/numpy/core/include -Ibuild/cythonized -I/usr/local/include -I/usr/local/opt/openssl@1.1/include -I/usr/local/opt/sqlite/include -I/usr/local/opt/tcl-tk/include -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include -I/usr/local/Cellar/python@3.9/3.9.1_7/Frameworks/Python.framework/Versions/3.9/include/python3.9 -c build/cythonized/sage/algebras/letterplace/free_algebra_letterplace.cpp -o build/temp.macosx-10.15-x86_64-3.9/build/cythonized/sage/algebras/letterplace/free_algebra_letterplace.o -fno-strict-aliasing -DCYTHON_CLINE_IN_TRACEBACK=1 -DSING_NDEBUG -DOM_NDEBUG -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular -std=c++11
[sagelib-9.3.beta6] In file included from build/cythonized/sage/algebras/letterplace/free_algebra_letterplace.cpp:672:
[sagelib-9.3.beta6] In file included from /usr/local/include/singular/Singular/libsingular.h:7:
[sagelib-9.3.beta6] In file included from /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular/kernel/structs.h:23:
[sagelib-9.3.beta6] In file included from /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular/kernel/polys.h:15:
[sagelib-9.3.beta6] In file included from /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular/polys/monomials/ring.h:13:
[sagelib-9.3.beta6] In file included from /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular/coeffs/coeffs.h:19:
[sagelib-9.3.beta6] In file included from /usr/local/include/factory/factory.h:28:
[sagelib-9.3.beta6] /usr/local/include/factory/si_log2.h:6:19: error: redefinition of 'SI_LOG2'
[sagelib-9.3.beta6] static inline int SI_LOG2(int v)
```



---

archive/issue_comments_621857.json:
```json
{
    "body": "Changing branch from \"u/mkoeppe/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build\" to \"\"",
    "created_at": "2021-02-04T04:17:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621857",
    "user": "https://github.com/mkoeppe"
}
```

Changing branch from "u/mkoeppe/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build" to ""



---

archive/issue_comments_621858.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,23 @@\n+Follow-up from #31132:\n+\n+It has been reported that it's still leaking.\n+\n+The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. \n+Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.\n+\n+Now if `-I/usr/local/` or `-L/usr/local` (instead of more specific paths to `/usr/local/Cellar/.../...`) appear, then unwanted packages that happen to be installed can leak in.\n+\n+To check whether this comes in through `pkg-config`:\n+\n+```\n+for a in $(pkg-config --list-all | sed 's/ .*//;'); do printf \"$a: \"; pkg-config --cflags $a; printf \"$a: \"; pkg-config --libs $a; done\n+```\n+\n+To make sure that libraries installed in $SAGE_LOCAL (if set) take precedence over such leaks, we could essentially revert #29697, adding some refinements:\n+- `SAGE_LOCAL` vs `SAGE_VENV`\n+- make sure that if `$SAGE_LOCAL` is unset, nothing is added.\n+\n+Relevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)\n \n \n Comment: 1\n``````\n",
    "created_at": "2021-02-04T04:17:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621858",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,23 @@
+Follow-up from #31132:
+
+It has been reported that it's still leaking.
+
+The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. 
+Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.
+
+Now if `-I/usr/local/` or `-L/usr/local` (instead of more specific paths to `/usr/local/Cellar/.../...`) appear, then unwanted packages that happen to be installed can leak in.
+
+To check whether this comes in through `pkg-config`:
+
+```
+for a in $(pkg-config --list-all | sed 's/ .*//;'); do printf "$a: "; pkg-config --cflags $a; printf "$a: "; pkg-config --libs $a; done
+```
+
+To make sure that libraries installed in $SAGE_LOCAL (if set) take precedence over such leaks, we could essentially revert #29697, adding some refinements:
+- `SAGE_LOCAL` vs `SAGE_VENV`
+- make sure that if `$SAGE_LOCAL` is unset, nothing is added.
+
+Relevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)
 
 
 Comment: 1
``````




---

archive/issue_comments_621859.json:
```json
{
    "body": "Changing branch from \"\" to \"u/mkoeppe/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build\"",
    "created_at": "2021-02-04T04:18:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621859",
    "user": "https://github.com/mkoeppe"
}
```

Changing branch from "" to "u/mkoeppe/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build"



---

archive/issue_comments_621860.json:
```json
{
    "body": "Changing commit from \"\" to \"6d3409c8cd0c9de8680025e0dbb8ddadc4c3d4bf\"",
    "created_at": "2021-02-04T04:24:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621860",
    "user": "https://github.com/mkoeppe"
}
```

Changing commit from "" to "6d3409c8cd0c9de8680025e0dbb8ddadc4c3d4bf"



---

archive/issue_comments_621861.json:
```json
{
    "body": "<a id='comment:15'></a>I think this is a specific issue with how we include singular headers.\n\n---\nLast 10 new commits:",
    "created_at": "2021-02-04T04:24:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621861",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:15'></a>I think this is a specific issue with how we include singular headers.

---
Last 10 new commits:



---

archive/issue_comments_621862.json:
```json
{
    "body": "<a id='comment:16'></a>`-I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular` is (correctly) near the beginning of the command line, \nbut the problem is that `-I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include` only comes at the end -- after `-I/usr/local/include` (which probably comes in from `CPATH` set in `.homebrew-build-env`)",
    "created_at": "2021-02-04T04:42:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621862",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:16'></a>`-I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular` is (correctly) near the beginning of the command line, 
but the problem is that `-I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include` only comes at the end -- after `-I/usr/local/include` (which probably comes in from `CPATH` set in `.homebrew-build-env`)



---

archive/issue_comments_621863.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [comment:16 mkoeppe]:\n> after `-I/usr/local/include` (which probably comes in from `CPATH` set in `.homebrew-build-env`)\n\nno, it's not coming from `CPATH`",
    "created_at": "2021-02-04T04:46:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621863",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'></a>Replying to [comment:16 mkoeppe]:
> after `-I/usr/local/include` (which probably comes in from `CPATH` set in `.homebrew-build-env`)

no, it's not coming from `CPATH`



---

archive/issue_comments_621864.json:
```json
{
    "body": "<a id='comment:18'></a>it's also not coming in from `sage.env.cython_aliases` or `sage.env.sage_include_directories`",
    "created_at": "2021-02-04T04:49:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621864",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:18'></a>it's also not coming in from `sage.env.cython_aliases` or `sage.env.sage_include_directories`



---

archive/issue_comments_621865.json:
```json
{
    "body": "<a id='comment:19'></a>\n```\ncat  /usr/local/opt/python@3.9/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/distutils.cfg \n[install]\nprefix=/usr/local\n[build_ext]\ninclude_dirs=/usr/local/include:/usr/local/opt/openssl@1.1/include:/usr/local/opt/sqlite/include:/usr/local/opt/tcl-tk/include\nlibrary_dirs=/usr/local/lib:/usr/local/opt/openssl@1.1/lib:/usr/local/opt/sqlite/lib:/usr/local/opt/tcl-tk/lib\n```",
    "created_at": "2021-02-04T04:51:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621865",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:19'></a>
```
cat  /usr/local/opt/python@3.9/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/distutils.cfg 
[install]
prefix=/usr/local
[build_ext]
include_dirs=/usr/local/include:/usr/local/opt/openssl@1.1/include:/usr/local/opt/sqlite/include:/usr/local/opt/tcl-tk/include
library_dirs=/usr/local/lib:/usr/local/opt/openssl@1.1/lib:/usr/local/opt/sqlite/lib:/usr/local/opt/tcl-tk/lib
```



---

archive/issue_comments_621866.json:
```json
{
    "body": "<a id='comment:20'></a>There we go, it's another distribution bug in homebrew. It installs a `distutils.cfg` that injects the paths into our build.\n\nhomebrew has been struggling with this since at least 2014 - https://github.com/Homebrew/legacy-homebrew/issues/26272",
    "created_at": "2021-02-04T05:00:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621866",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'></a>There we go, it's another distribution bug in homebrew. It installs a `distutils.cfg` that injects the paths into our build.

homebrew has been struggling with this since at least 2014 - https://github.com/Homebrew/legacy-homebrew/issues/26272



---

archive/issue_comments_621867.json:
```json
{
    "body": "Changing commit from \"6d3409c8cd0c9de8680025e0dbb8ddadc4c3d4bf\" to \"017c35126d38d01a42d0a51e7c6bfa20f23c7eac\"",
    "created_at": "2021-02-04T05:10:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621867",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "6d3409c8cd0c9de8680025e0dbb8ddadc4c3d4bf" to "017c35126d38d01a42d0a51e7c6bfa20f23c7eac"



---

archive/issue_comments_621868.json:
```json
{
    "body": "<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2021-02-04T05:10:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621868",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_621869.json:
```json
{
    "body": "Changing dependencies from \"#30589, #31132, #31227, #30770\" to \"#30589, #31132, #31227, #30770, #31134\"",
    "created_at": "2021-02-04T05:11:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621869",
    "user": "https://github.com/mkoeppe"
}
```

Changing dependencies from "#30589, #31132, #31227, #30770" to "#30589, #31132, #31227, #30770, #31134"



---

archive/issue_comments_621870.json:
```json
{
    "body": "Changing dependencies from \"#30589, #31132, #31227, #30770, #31134\" to \"#30589, #31132, #31227, #30770, #30912, #31134\"",
    "created_at": "2021-02-04T05:11:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621870",
    "user": "https://github.com/mkoeppe"
}
```

Changing dependencies from "#30589, #31132, #31227, #30770, #31134" to "#30589, #31132, #31227, #30770, #30912, #31134"



---

archive/issue_comments_621871.json:
```json
{
    "body": "<a id='comment:24'></a>We can work around the existence of this `distutils.cfg` by using `setuptools` (#30912) - more specifically versions of `setuptools` that bring and use their own copy of distutils.\n\nsetuptools 49.6.0 (in Sage 9.3.beta6) does not; >=50.0.0 does; >=50.1.0 only does if `SETUPTOOLS_USE_DISTUTILS=local` is set. (https://setuptools.readthedocs.io/en/latest/history.html#v50-1-0)\n\n#31134 updates setuptools to 51.1.1.",
    "created_at": "2021-02-04T05:20:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621871",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:24'></a>We can work around the existence of this `distutils.cfg` by using `setuptools` (#30912) - more specifically versions of `setuptools` that bring and use their own copy of distutils.

setuptools 49.6.0 (in Sage 9.3.beta6) does not; >=50.0.0 does; >=50.1.0 only does if `SETUPTOOLS_USE_DISTUTILS=local` is set. (https://setuptools.readthedocs.io/en/latest/history.html#v50-1-0)

#31134 updates setuptools to 51.1.1.



---

archive/issue_comments_621872.json:
```json
{
    "body": "Changing commit from \"017c35126d38d01a42d0a51e7c6bfa20f23c7eac\" to \"00b3109cd440cb56212b0a520f7e0e889356cc3c\"",
    "created_at": "2021-02-04T05:27:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621872",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "017c35126d38d01a42d0a51e7c6bfa20f23c7eac" to "00b3109cd440cb56212b0a520f7e0e889356cc3c"



---

archive/issue_comments_621873.json:
```json
{
    "body": "<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-02-04T05:27:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621873",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_621874.json:
```json
{
    "body": "<a id='comment:26'></a>This changes behavior:\n\n```\n[sagelib-9.3.beta6] [ 1/13] gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk -O2 -g -march=native -I./sage/cpython -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/build/pkgs/sagelib/src -I/usr/local/Cellar/python@3.9/3.9.1_7/Frameworks/Python.framework/Versions/3.9/include/python3.9 -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/numpy/core/include -Ibuild/cythonized -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include -I/usr/local/Cellar/python@3.9/3.9.1_7/Frameworks/Python.framework/Versions/3.9/include/python3.9 -c build/cythonized/sage/algebras/letterplace/free_algebra_letterplace.cpp -o build/temp.macosx-10.15-x86_64-3.9/build/cythonized/sage/algebras/letterplace/free_algebra_letterplace.o -fno-strict-aliasing -DCYTHON_CLINE_IN_TRACEBACK=1 -DSING_NDEBUG -DOM_NDEBUG -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular -std=c++11\n[sagelib-9.3.beta6] build/cythonized/sage/algebras/letterplace/free_algebra_letterplace.cpp:671:10: fatal error: 'gmp.h' file not found\n[sagelib-9.3.beta6] #include \"gmp.h\"\n[sagelib-9.3.beta6]          ^~~~~~~\n[sagelib-9.3.beta6] 1 error generated.\n```",
    "created_at": "2021-02-04T05:28:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621874",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:26'></a>This changes behavior:

```
[sagelib-9.3.beta6] [ 1/13] gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk -O2 -g -march=native -I./sage/cpython -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/build/pkgs/sagelib/src -I/usr/local/Cellar/python@3.9/3.9.1_7/Frameworks/Python.framework/Versions/3.9/include/python3.9 -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/numpy/core/include -Ibuild/cythonized -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include -I/usr/local/Cellar/python@3.9/3.9.1_7/Frameworks/Python.framework/Versions/3.9/include/python3.9 -c build/cythonized/sage/algebras/letterplace/free_algebra_letterplace.cpp -o build/temp.macosx-10.15-x86_64-3.9/build/cythonized/sage/algebras/letterplace/free_algebra_letterplace.o -fno-strict-aliasing -DCYTHON_CLINE_IN_TRACEBACK=1 -DSING_NDEBUG -DOM_NDEBUG -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular -std=c++11
[sagelib-9.3.beta6] build/cythonized/sage/algebras/letterplace/free_algebra_letterplace.cpp:671:10: fatal error: 'gmp.h' file not found
[sagelib-9.3.beta6] #include "gmp.h"
[sagelib-9.3.beta6]          ^~~~~~~
[sagelib-9.3.beta6] 1 error generated.
```



---

archive/issue_comments_621875.json:
```json
{
    "body": "<a id='comment:27'></a>OK, I had removed `/usr/local/include` from `CPATH` in my shell.\n\nWhen I restore it (using `.homebrew-build-env`), it builds OK!",
    "created_at": "2021-02-04T05:40:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621875",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:27'></a>OK, I had removed `/usr/local/include` from `CPATH` in my shell.

When I restore it (using `.homebrew-build-env`), it builds OK!



---

archive/issue_comments_621876.json:
```json
{
    "body": "Changing author from \"\" to \"Matthias Koeppe\"",
    "created_at": "2021-02-04T05:49:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621876",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "" to "Matthias Koeppe"



---

archive/issue_comments_621877.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,25 @@\n+Follow-up from #31132:\n+\n+It has been reported that it's still leaking.\n+\n+\n+The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. \n+Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.\n+\n+Now if `-I/usr/local/` or `-L/usr/local` (instead of more specific paths to `/usr/local/Cellar/.../...`) appear, then unwanted packages that happen to be installed can leak in. To check whether this comes in through `pkg-config`:\n+\n+```\n+for a in $(pkg-config --list-all | sed 's/ .*//;'); do printf \"$a: \"; pkg-config --cflags $a; printf \"$a: \"; pkg-config --libs $a; done\n+```\n+\n+\n+However, here the problem is caused by homebrew installing a `distutils.cfg` that injects `/usr/local/include` into our include search path.\n+We fix the leak by switching to a modern configuration of setuptools.\n+\n+\n+Relevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~); possible follow-up: #31338\n+\n+\n \n \n Comment: 1\n``````\n",
    "created_at": "2021-02-04T05:49:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621877",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,25 @@
+Follow-up from #31132:
+
+It has been reported that it's still leaking.
+
+
+The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. 
+Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.
+
+Now if `-I/usr/local/` or `-L/usr/local` (instead of more specific paths to `/usr/local/Cellar/.../...`) appear, then unwanted packages that happen to be installed can leak in. To check whether this comes in through `pkg-config`:
+
+```
+for a in $(pkg-config --list-all | sed 's/ .*//;'); do printf "$a: "; pkg-config --cflags $a; printf "$a: "; pkg-config --libs $a; done
+```
+
+
+However, here the problem is caused by homebrew installing a `distutils.cfg` that injects `/usr/local/include` into our include search path.
+We fix the leak by switching to a modern configuration of setuptools.
+
+
+Relevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~); possible follow-up: #31338
+
+
 
 
 Comment: 1
``````




---

archive/issue_comments_621878.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-02-04T05:49:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621878",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_621879.json:
```json
{
    "body": "<a id='comment:29'></a>Ready for review. Depends on #30912, which also needs review.",
    "created_at": "2021-02-04T05:51:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621879",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:29'></a>Ready for review. Depends on #30912, which also needs review.



---

archive/issue_comments_621880.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,19 @@\n+Follow-up from #31132:\n+\n+It has been reported that it's still leaking.\n+\n+\n+The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. \n+Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.\n+Now if `-I/usr/local/` or `-L/usr/local` (instead of more specific paths to `/usr/local/Cellar/.../...`) appear, then unwanted packages that happen to be installed can leak in. \n+\n+However, here the problem is caused by homebrew installing a `distutils.cfg` that injects `/usr/local/include` into our include search path.\n+We fix the leak by switching to a modern configuration of setuptools.\n+\n+\n+Relevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~); possible follow-up: #31338\n+\n+\n \n \n Comment: 1\n``````\n",
    "created_at": "2021-02-04T05:51:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621880",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,19 @@
+Follow-up from #31132:
+
+It has been reported that it's still leaking.
+
+
+The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. 
+Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.
+Now if `-I/usr/local/` or `-L/usr/local` (instead of more specific paths to `/usr/local/Cellar/.../...`) appear, then unwanted packages that happen to be installed can leak in. 
+
+However, here the problem is caused by homebrew installing a `distutils.cfg` that injects `/usr/local/include` into our include search path.
+We fix the leak by switching to a modern configuration of setuptools.
+
+
+Relevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~); possible follow-up: #31338
+
+
 
 
 Comment: 1
``````




---

archive/issue_comments_621881.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,19 @@\n+Follow-up from #31132:\n+\n+It has been reported that it's still leaking with the upgraded python3 from homebrew that includes https://github.com/Homebrew/homebrew-core/commit/784d29205ee5bd27fed226a5f96837428e171825\n+\n+\n+The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. \n+Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.\n+Now if `-I/usr/local/` or `-L/usr/local` (instead of more specific paths to `/usr/local/Cellar/.../...`) appear, then unwanted packages that happen to be installed can leak in. \n+\n+However, here the problem is caused by homebrew installing a `distutils.cfg` that injects `/usr/local/include` into our include search path.\n+We fix the leak by switching to a modern configuration of setuptools.\n+\n+\n+Relevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~); possible follow-up: #31338\n+\n+\n \n \n Comment: 1\n``````\n",
    "created_at": "2021-02-04T19:14:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621881",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,19 @@
+Follow-up from #31132:
+
+It has been reported that it's still leaking with the upgraded python3 from homebrew that includes https://github.com/Homebrew/homebrew-core/commit/784d29205ee5bd27fed226a5f96837428e171825
+
+
+The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. 
+Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.
+Now if `-I/usr/local/` or `-L/usr/local` (instead of more specific paths to `/usr/local/Cellar/.../...`) appear, then unwanted packages that happen to be installed can leak in. 
+
+However, here the problem is caused by homebrew installing a `distutils.cfg` that injects `/usr/local/include` into our include search path.
+We fix the leak by switching to a modern configuration of setuptools.
+
+
+Relevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~); possible follow-up: #31338
+
+
 
 
 Comment: 1
``````




---

archive/issue_comments_621882.json:
```json
{
    "body": "<a id='comment:31'></a>Just tried building and got the following error in sagelib:\n\n\n```\nmultiprocessing.pool.RemoteTraceback: \n\"\"\"\nTraceback (most recent call last):\n  File \"/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/pool.py\", line 125, in worker\n    result = (True, func(*args, **kwds))\n  File \"/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/pool.py\", line 48, in mapstar\n    return list(map(*args))\n  File \"/Users/zscherr/sage/develop/build/pkgs/sagelib/src/sage_setup/run_parallel.py\", line 50, in apply_func_progress\n    return p[0](p[1])\n  File \"/Users/zscherr/sage/develop/build/pkgs/sagelib/src/sage_setup/command/sage_build_ext.py\", line 163, in build_extension\n    objects = self.compiler.compile(sources,\n  File \"/Users/zscherr/sage/develop/local/lib/python3.9/site-packages/setuptools/_distutils/ccompiler.py\", line 574, in compile\n    self._compile(obj, src, ext, cc_args, extra_postargs, pp_opts)\n  File \"/Users/zscherr/sage/develop/local/lib/python3.9/site-packages/setuptools/_distutils/unixccompiler.py\", line 117, in _compile\n    self.spawn(compiler_so + cc_args + [src, '-o', obj] +\n  File \"/Users/zscherr/sage/develop/local/lib/python3.9/site-packages/setuptools/_distutils/ccompiler.py\", line 910, in spawn\n    spawn(cmd, dry_run=self.dry_run, **kwargs)\n  File \"/Users/zscherr/sage/develop/local/lib/python3.9/site-packages/setuptools/_distutils/spawn.py\", line 61, in spawn\n    _cfg_target_split = [int(x) for x in _cfg_target.split('.')]\nAttributeError: 'int' object has no attribute 'split'\n\"\"\"\n```",
    "created_at": "2021-02-04T23:46:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621882",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:31'></a>Just tried building and got the following error in sagelib:


```
multiprocessing.pool.RemoteTraceback: 
"""
Traceback (most recent call last):
  File "/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/pool.py", line 125, in worker
    result = (True, func(*args, **kwds))
  File "/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/pool.py", line 48, in mapstar
    return list(map(*args))
  File "/Users/zscherr/sage/develop/build/pkgs/sagelib/src/sage_setup/run_parallel.py", line 50, in apply_func_progress
    return p[0](p[1])
  File "/Users/zscherr/sage/develop/build/pkgs/sagelib/src/sage_setup/command/sage_build_ext.py", line 163, in build_extension
    objects = self.compiler.compile(sources,
  File "/Users/zscherr/sage/develop/local/lib/python3.9/site-packages/setuptools/_distutils/ccompiler.py", line 574, in compile
    self._compile(obj, src, ext, cc_args, extra_postargs, pp_opts)
  File "/Users/zscherr/sage/develop/local/lib/python3.9/site-packages/setuptools/_distutils/unixccompiler.py", line 117, in _compile
    self.spawn(compiler_so + cc_args + [src, '-o', obj] +
  File "/Users/zscherr/sage/develop/local/lib/python3.9/site-packages/setuptools/_distutils/ccompiler.py", line 910, in spawn
    spawn(cmd, dry_run=self.dry_run, **kwargs)
  File "/Users/zscherr/sage/develop/local/lib/python3.9/site-packages/setuptools/_distutils/spawn.py", line 61, in spawn
    _cfg_target_split = [int(x) for x in _cfg_target.split('.')]
AttributeError: 'int' object has no attribute 'split'
"""
```



---

archive/issue_comments_621883.json:
```json
{
    "body": "<a id='comment:32'></a>I just looked at the source code for spawn.py and it seems that _cfg_target is set to \n\n\n\n```\nsysconfig.get_config_var(\"MACOSX_DEPLOYMENT_TARGET\")\n```\n\nwhich is 11 and is an int type on Big Sur.",
    "created_at": "2021-02-04T23:56:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621883",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:32'></a>I just looked at the source code for spawn.py and it seems that _cfg_target is set to 



```
sysconfig.get_config_var("MACOSX_DEPLOYMENT_TARGET")
```

which is 11 and is an int type on Big Sur.



---

archive/issue_comments_621884.json:
```json
{
    "body": "<a id='comment:33'></a>Maybe setuptools needs a version bump?",
    "created_at": "2021-02-04T23:58:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621884",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:33'></a>Maybe setuptools needs a version bump?



---

archive/issue_comments_621885.json:
```json
{
    "body": "<a id='comment:34'></a>This is parallel to https://github.com/Homebrew/homebrew-core/issues/66096",
    "created_at": "2021-02-05T00:02:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621885",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:34'></a>This is parallel to https://github.com/Homebrew/homebrew-core/issues/66096



---

archive/issue_comments_621886.json:
```json
{
    "body": "<a id='comment:35'></a>Unfortunately this fix that homebrew uses (https://github.com/fxcoudert/cpython/commit/6511bf56.patch) \nhas not made its way into upstream distutils (https://github.com/pypa/distutils/blob/main/distutils/spawn.py) and thus also not into the vendored distutils in setuptools (https://github.com/pypa/setuptools/blob/main/setuptools/_distutils/spawn.py).",
    "created_at": "2021-02-05T00:15:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621886",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:35'></a>Unfortunately this fix that homebrew uses (https://github.com/fxcoudert/cpython/commit/6511bf56.patch) 
has not made its way into upstream distutils (https://github.com/pypa/distutils/blob/main/distutils/spawn.py) and thus also not into the vendored distutils in setuptools (https://github.com/pypa/setuptools/blob/main/setuptools/_distutils/spawn.py).



---

archive/issue_comments_621887.json:
```json
{
    "body": "<a id='comment:36'></a>Upstream cpython issue:\nhttps://bugs.python.org/issue42504",
    "created_at": "2021-02-05T00:20:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621887",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:36'></a>Upstream cpython issue:
https://bugs.python.org/issue42504



---

archive/issue_comments_621888.json:
```json
{
    "body": "<a id='comment:37'></a>As a temporary measure, let's put the patch into our setuptools.",
    "created_at": "2021-02-05T00:22:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621888",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:37'></a>As a temporary measure, let's put the patch into our setuptools.



---

archive/issue_comments_621889.json:
```json
{
    "body": "Changing commit from \"00b3109cd440cb56212b0a520f7e0e889356cc3c\" to \"3601c510bbca6155f8e99eebf55b29e8cfe51527\"",
    "created_at": "2021-02-05T00:30:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621889",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "00b3109cd440cb56212b0a520f7e0e889356cc3c" to "3601c510bbca6155f8e99eebf55b29e8cfe51527"



---

archive/issue_comments_621890.json:
```json
{
    "body": "<a id='comment:38'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-02-05T00:30:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621890",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:38'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_621891.json:
```json
{
    "body": "<a id='comment:39'></a>Please test on big sur",
    "created_at": "2021-02-05T01:41:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621891",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:39'></a>Please test on big sur



---

archive/issue_comments_621892.json:
```json
{
    "body": "<a id='comment:40'></a>I was able to build successfully on Big Sur with the following packages installed via homebrew:\n\nflint arb pari singular ecl maxima fplll\n\nThere's still the issue that documentation is not building using homebrew's python 3.9, https://groups.google.com/g/sage-devel/c/9EMs9h2i_H4, but I have no idea what's going on there.",
    "created_at": "2021-02-05T02:34:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621892",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:40'></a>I was able to build successfully on Big Sur with the following packages installed via homebrew:

flint arb pari singular ecl maxima fplll

There's still the issue that documentation is not building using homebrew's python 3.9, https://groups.google.com/g/sage-devel/c/9EMs9h2i_H4, but I have no idea what's going on there.



---

archive/issue_comments_621893.json:
```json
{
    "body": "<a id='comment:41'></a>Replying to [comment:40 gh-zlscherr]:\n> There's still the issue that documentation is not building using homebrew's python 3.9, https://groups.google.com/g/sage-devel/c/9EMs9h2i_H4, but I have no idea what's going on there.\n\n\nI guess it would be worth checking for `libtcl` with `otool -L $SAGE_LOCAL/lib/* /usr/local/lib/*`",
    "created_at": "2021-02-05T03:10:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621893",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:41'></a>Replying to [comment:40 gh-zlscherr]:
> There's still the issue that documentation is not building using homebrew's python 3.9, https://groups.google.com/g/sage-devel/c/9EMs9h2i_H4, but I have no idea what's going on there.


I guess it would be worth checking for `libtcl` with `otool -L $SAGE_LOCAL/lib/* /usr/local/lib/*`



---

archive/issue_comments_621894.json:
```json
{
    "body": "<a id='comment:42'></a>I have opened #31344 for the docbuild crash - I also see it on Catalina with homebrew's python3.9",
    "created_at": "2021-02-05T06:36:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621894",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:42'></a>I have opened #31344 for the docbuild crash - I also see it on Catalina with homebrew's python3.9



---

archive/issue_comments_621895.json:
```json
{
    "body": "<a id='comment:43'></a>Replying to [comment:41 mkoeppe]:\n> I guess it would be worth checking for `libtcl` with `otool -L $SAGE_LOCAL/lib/* /usr/local/lib/*` \n\n\nI didn't see anything suspicious here - so it's not just a library mismatch",
    "created_at": "2021-02-05T06:36:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621895",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:43'></a>Replying to [comment:41 mkoeppe]:
> I guess it would be worth checking for `libtcl` with `otool -L $SAGE_LOCAL/lib/* /usr/local/lib/*` 


I didn't see anything suspicious here - so it's not just a library mismatch



---

archive/issue_comments_621896.json:
```json
{
    "body": "<a id='comment:44'></a>(continuing on #31344 regarding docbuild)",
    "created_at": "2021-02-05T07:09:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621896",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:44'></a>(continuing on #31344 regarding docbuild)



---

archive/issue_comments_621897.json:
```json
{
    "body": "Changing dependencies from \"#30589, #31132, #31227, #30770, #30912, #31134\" to \"#30589, #31132, #31227, #30770, #30912, #31134, #31344\"",
    "created_at": "2021-02-05T09:10:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621897",
    "user": "https://github.com/mkoeppe"
}
```

Changing dependencies from "#30589, #31132, #31227, #30770, #30912, #31134" to "#30589, #31132, #31227, #30770, #30912, #31134, #31344"



---

archive/issue_comments_621898.json:
```json
{
    "body": "<a id='comment:46'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-02-05T09:11:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621898",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:46'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_621899.json:
```json
{
    "body": "Changing commit from \"3601c510bbca6155f8e99eebf55b29e8cfe51527\" to \"9ad84cc0105665ac9c1988a3e8fa0914fd1eac73\"",
    "created_at": "2021-02-05T09:11:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621899",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "3601c510bbca6155f8e99eebf55b29e8cfe51527" to "9ad84cc0105665ac9c1988a3e8fa0914fd1eac73"



---

archive/issue_comments_621900.json:
```json
{
    "body": "<a id='comment:47'></a>I see some doctests failing on this branch that may be related to the new distutils.  In particular,\n\n```\n./sage -t src/sage/tests/cmdline.py\n```\n\nfails.  One of the failing tests creates a temporary spyx file, and when it tries to run it with sage, it gives the following error\n\n```\nTraceback (most recent call last):\n  File \"/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/unixccompiler.py\", line 117, in _compile\n    self.spawn(compiler_so + cc_args + [src, '-o', obj] +\n  File \"/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/ccompiler.py\", line 910, in spawn\n    spawn(cmd, dry_run=self.dry_run)\n  File \"/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/spawn.py\", line 87, in spawn\n    raise DistutilsExecError(\ndistutils.errors.DistutilsExecError: command '/usr/bin/gcc' failed with exit code 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/zscherr/sage/develop/local/lib/python3.9/site-packages/sage/misc/cython.py\", line 386, in cython\n    dist.run_command(\"build\")\n  File \"/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/dist.py\", line 985, in run_command\n    cmd_obj.run()\n  File \"/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/command/build.py\", line 135, in run\n    self.run_command(cmd_name)\n  File \"/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/cmd.py\", line 313, in run_command\n    self.distribution.run_command(command)\n  File \"/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/dist.py\", line 985, in run_command\n    cmd_obj.run()\n  File \"/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/command/build_ext.py\", line 340, in run\n    self.build_extensions()\n  File \"/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/command/build_ext.py\", line 449, in build_extensions\n    self._build_extensions_serial()\n  File \"/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/command/build_ext.py\", line 474, in _build_extensions_serial\n    self.build_extension(ext)\n  File \"/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/command/build_ext.py\", line 529, in build_extension\n    objects = self.compiler.compile(sources,\n  File \"/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/ccompiler.py\", line 574, in compile\n    self._compile(obj, src, ext, cc_args, extra_postargs, pp_opts)\n  File \"/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/unixccompiler.py\", line 120, in _compile\n    raise CompileError(msg)\ndistutils.errors.CompileError: command '/usr/bin/gcc' failed with exit code 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/zscherr/sage/develop/src/bin/sage-run-cython\", line 8, in <module>\n    s = load_cython(sys.argv.pop(1))\n  File \"/Users/zscherr/sage/develop/local/lib/python3.9/site-packages/sage/repl/load.py\", line 68, in load_cython\n    mod, dir = cython(name, compile_message=True, use_cache=True)\n  File \"/Users/zscherr/sage/develop/local/lib/python3.9/site-packages/sage/misc/cython.py\", line 392, in cython\n    raise RuntimeError(msg.strip())\nRuntimeError: command '/usr/bin/gcc' failed with exit code 1\n/Users/zscherr/.sage/temp/Zacharys-MacBook-Pro.local/69918/spyx/_Users_zscherr__sage_temp_Zacharys_MacBook_Pro_local_69734_dir_y1gtp384_sage_test_file_spyx/_Users_zscherr__sage_temp_Zacharys_MacBook_Pro_local_69734_dir_y1gtp384_sage_test_file_spyx_0.c:653:10: fatal error: 'gmp.h' file not found\n#include \"gmp.h\"\n```\n\nI'm wondering if the issue is somehow related to distutils not remembering where certain libraries like gmp are located.",
    "created_at": "2021-02-06T01:03:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621900",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:47'></a>I see some doctests failing on this branch that may be related to the new distutils.  In particular,

```
./sage -t src/sage/tests/cmdline.py
```

fails.  One of the failing tests creates a temporary spyx file, and when it tries to run it with sage, it gives the following error

```
Traceback (most recent call last):
  File "/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/unixccompiler.py", line 117, in _compile
    self.spawn(compiler_so + cc_args + [src, '-o', obj] +
  File "/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/ccompiler.py", line 910, in spawn
    spawn(cmd, dry_run=self.dry_run)
  File "/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/spawn.py", line 87, in spawn
    raise DistutilsExecError(
distutils.errors.DistutilsExecError: command '/usr/bin/gcc' failed with exit code 1

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/zscherr/sage/develop/local/lib/python3.9/site-packages/sage/misc/cython.py", line 386, in cython
    dist.run_command("build")
  File "/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/dist.py", line 985, in run_command
    cmd_obj.run()
  File "/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/command/build.py", line 135, in run
    self.run_command(cmd_name)
  File "/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/cmd.py", line 313, in run_command
    self.distribution.run_command(command)
  File "/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/dist.py", line 985, in run_command
    cmd_obj.run()
  File "/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/command/build_ext.py", line 340, in run
    self.build_extensions()
  File "/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/command/build_ext.py", line 449, in build_extensions
    self._build_extensions_serial()
  File "/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/command/build_ext.py", line 474, in _build_extensions_serial
    self.build_extension(ext)
  File "/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/command/build_ext.py", line 529, in build_extension
    objects = self.compiler.compile(sources,
  File "/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/ccompiler.py", line 574, in compile
    self._compile(obj, src, ext, cc_args, extra_postargs, pp_opts)
  File "/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/unixccompiler.py", line 120, in _compile
    raise CompileError(msg)
distutils.errors.CompileError: command '/usr/bin/gcc' failed with exit code 1

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/zscherr/sage/develop/src/bin/sage-run-cython", line 8, in <module>
    s = load_cython(sys.argv.pop(1))
  File "/Users/zscherr/sage/develop/local/lib/python3.9/site-packages/sage/repl/load.py", line 68, in load_cython
    mod, dir = cython(name, compile_message=True, use_cache=True)
  File "/Users/zscherr/sage/develop/local/lib/python3.9/site-packages/sage/misc/cython.py", line 392, in cython
    raise RuntimeError(msg.strip())
RuntimeError: command '/usr/bin/gcc' failed with exit code 1
/Users/zscherr/.sage/temp/Zacharys-MacBook-Pro.local/69918/spyx/_Users_zscherr__sage_temp_Zacharys_MacBook_Pro_local_69734_dir_y1gtp384_sage_test_file_spyx/_Users_zscherr__sage_temp_Zacharys_MacBook_Pro_local_69734_dir_y1gtp384_sage_test_file_spyx_0.c:653:10: fatal error: 'gmp.h' file not found
#include "gmp.h"
```

I'm wondering if the issue is somehow related to distutils not remembering where certain libraries like gmp are located.



---

archive/issue_comments_621901.json:
```json
{
    "body": "<a id='comment:48'></a>gmp used to be found simply because `/usr/local/` is listed in homebrew's `distutils.cfg`. Now we need to update `sage.misc.cython._standard_libs_libdirs` so that gmp library dir information is used, for example from pkgconfig.",
    "created_at": "2021-02-06T02:07:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621901",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:48'></a>gmp used to be found simply because `/usr/local/` is listed in homebrew's `distutils.cfg`. Now we need to update `sage.misc.cython._standard_libs_libdirs` so that gmp library dir information is used, for example from pkgconfig.



---

archive/issue_comments_621902.json:
```json
{
    "body": "<a id='comment:49'></a>Let's address this in #31348.",
    "created_at": "2021-02-06T02:40:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621902",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:49'></a>Let's address this in #31348.



---

archive/issue_comments_621903.json:
```json
{
    "body": "<a id='comment:50'></a>When you ran this test, were the environment variables set by `.homebrew-build-env` set?",
    "created_at": "2021-02-06T02:43:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621903",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:50'></a>When you ran this test, were the environment variables set by `.homebrew-build-env` set?



---

archive/issue_comments_621904.json:
```json
{
    "body": "<a id='comment:51'></a>Replying to [comment:50 mkoeppe]:\n> When you ran this test, were the environment variables set by `.homebrew-build-env` set?\n\n\nat testing time they were not set.",
    "created_at": "2021-02-06T02:48:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621904",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:51'></a>Replying to [comment:50 mkoeppe]:
> When you ran this test, were the environment variables set by `.homebrew-build-env` set?


at testing time they were not set.



---

archive/issue_comments_621905.json:
```json
{
    "body": "<a id='comment:52'></a>I managed to get through all of ptest, and there are a lot of issues with not being able to find -lmpfr as well.  I imagine it's the same type of issue.",
    "created_at": "2021-02-06T04:36:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621905",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:52'></a>I managed to get through all of ptest, and there are a lot of issues with not being able to find -lmpfr as well.  I imagine it's the same type of issue.



---

archive/issue_comments_621906.json:
```json
{
    "body": "<a id='comment:53'></a>Yes, the situation for mpfr is exactly the same. We can probably take care of it in #31348 as well.",
    "created_at": "2021-02-06T05:02:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621906",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:53'></a>Yes, the situation for mpfr is exactly the same. We can probably take care of it in #31348 as well.



---

archive/issue_comments_621907.json:
```json
{
    "body": "<a id='comment:54'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-02-07T18:59:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621907",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:54'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_621908.json:
```json
{
    "body": "Changing commit from \"9ad84cc0105665ac9c1988a3e8fa0914fd1eac73\" to \"9f38a3bdffd2af59193c3b974f6813e798c9bc33\"",
    "created_at": "2021-02-07T18:59:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621908",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "9ad84cc0105665ac9c1988a3e8fa0914fd1eac73" to "9f38a3bdffd2af59193c3b974f6813e798c9bc33"



---

archive/issue_comments_621909.json:
```json
{
    "body": "<a id='comment:55'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-02-07T19:10:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621909",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:55'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_621910.json:
```json
{
    "body": "Changing commit from \"9f38a3bdffd2af59193c3b974f6813e798c9bc33\" to \"a1b3abcca0aa9ab1a0cf8db5aae6c2a1ca0f7a68\"",
    "created_at": "2021-02-07T19:10:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621910",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "9f38a3bdffd2af59193c3b974f6813e798c9bc33" to "a1b3abcca0aa9ab1a0cf8db5aae6c2a1ca0f7a68"



---

archive/issue_comments_621911.json:
```json
{
    "body": "<a id='comment:56'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-02-07T19:27:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621911",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:56'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_621912.json:
```json
{
    "body": "Changing commit from \"a1b3abcca0aa9ab1a0cf8db5aae6c2a1ca0f7a68\" to \"ae4ea5530cab4742272b7bb5460cacd210b63544\"",
    "created_at": "2021-02-07T19:27:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621912",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "a1b3abcca0aa9ab1a0cf8db5aae6c2a1ca0f7a68" to "ae4ea5530cab4742272b7bb5460cacd210b63544"



---

archive/issue_comments_621913.json:
```json
{
    "body": "Changing commit from \"ae4ea5530cab4742272b7bb5460cacd210b63544\" to \"add7db48b2138f80fda1e8f5d4e50dbff1bc2e4c\"",
    "created_at": "2021-02-07T20:47:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621913",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "ae4ea5530cab4742272b7bb5460cacd210b63544" to "add7db48b2138f80fda1e8f5d4e50dbff1bc2e4c"



---

archive/issue_comments_621914.json:
```json
{
    "body": "<a id='comment:57'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-02-07T20:47:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621914",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:57'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_621915.json:
```json
{
    "body": "<a id='comment:58'></a>Replying to [comment:51 gh-zlscherr]:\n> Replying to [comment:50 mkoeppe]:\n> > When you ran this test, were the environment variables set by `.homebrew-build-env` set?\n\n> \n> at testing time they were not set.\n\n\nShall we consider this issue -- `.homebrew-build-env` necessary to be set during testing -- one that can be addressed in follow-up tickets? (#31348, #31365)",
    "created_at": "2021-02-09T03:42:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621915",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:58'></a>Replying to [comment:51 gh-zlscherr]:
> Replying to [comment:50 mkoeppe]:
> > When you ran this test, were the environment variables set by `.homebrew-build-env` set?

> 
> at testing time they were not set.


Shall we consider this issue -- `.homebrew-build-env` necessary to be set during testing -- one that can be addressed in follow-up tickets? (#31348, #31365)



---

archive/issue_comments_621916.json:
```json
{
    "body": "<a id='comment:59'></a>That sounds fair.  With .homebrew-build-env sourced I didn't have any out of the ordinary issues with make ptest, so it seems that things are working well modulo the runtime stuff.",
    "created_at": "2021-02-09T03:44:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621916",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:59'></a>That sounds fair.  With .homebrew-build-env sourced I didn't have any out of the ordinary issues with make ptest, so it seems that things are working well modulo the runtime stuff.



---

archive/issue_comments_621917.json:
```json
{
    "body": "<a id='comment:60'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-09T00:50:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621917",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:60'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_621918.json:
```json
{
    "body": "Changing commit from \"add7db48b2138f80fda1e8f5d4e50dbff1bc2e4c\" to \"4e777e7c9ebe47d1b9f72d625deee6c01f77c14a\"",
    "created_at": "2021-03-09T00:50:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621918",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "add7db48b2138f80fda1e8f5d4e50dbff1bc2e4c" to "4e777e7c9ebe47d1b9f72d625deee6c01f77c14a"



---

archive/issue_comments_621919.json:
```json
{
    "body": "Changing dependencies from \"#30589, #31132, #31227, #30770, #30912, #31134, #31344\" to \"\"",
    "created_at": "2021-03-09T00:53:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621919",
    "user": "https://github.com/mkoeppe"
}
```

Changing dependencies from "#30589, #31132, #31227, #30770, #30912, #31134, #31344" to ""



---

archive/issue_comments_621920.json:
```json
{
    "body": "<a id='comment:61'></a>All dependencies have been merged. Let's get this in?",
    "created_at": "2021-03-09T00:53:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621920",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:61'></a>All dependencies have been merged. Let's get this in?



---

archive/issue_comments_621921.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,21 @@\n+Follow-up from #31132:\n+\n+It has been reported that it's still leaking with the upgraded python3 from homebrew that includes https://github.com/Homebrew/homebrew-core/commit/784d29205ee5bd27fed226a5f96837428e171825\n+\n+\n+The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. \n+Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.\n+Now if `-I/usr/local/` or `-L/usr/local` (instead of more specific paths to `/usr/local/Cellar/.../...`) appear, then unwanted packages that happen to be installed can leak in. \n+\n+However, here the problem is caused by homebrew installing a `distutils.cfg` that injects `/usr/local/include` into our include search path.\n+We fix the leak by switching to a modern configuration of setuptools.\n+\n+This also affects `cysignals`, as reported in https://groups.google.com/g/sage-release/c/KdSKg6RdZok/m/91Ibwn8RAgAJ\n+\n+\n+Relevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~); possible follow-up: #31338\n+\n+\n \n \n Comment: 1\n``````\n",
    "created_at": "2021-03-14T18:35:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621921",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,21 @@
+Follow-up from #31132:
+
+It has been reported that it's still leaking with the upgraded python3 from homebrew that includes https://github.com/Homebrew/homebrew-core/commit/784d29205ee5bd27fed226a5f96837428e171825
+
+
+The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. 
+Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.
+Now if `-I/usr/local/` or `-L/usr/local` (instead of more specific paths to `/usr/local/Cellar/.../...`) appear, then unwanted packages that happen to be installed can leak in. 
+
+However, here the problem is caused by homebrew installing a `distutils.cfg` that injects `/usr/local/include` into our include search path.
+We fix the leak by switching to a modern configuration of setuptools.
+
+This also affects `cysignals`, as reported in https://groups.google.com/g/sage-release/c/KdSKg6RdZok/m/91Ibwn8RAgAJ
+
+
+Relevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~); possible follow-up: #31338
+
+
 
 
 Comment: 1
``````




---

archive/issue_comments_621922.json:
```json
{
    "body": "<a id='comment:62'></a>This is arguably another homebrew distribution bug.",
    "created_at": "2021-03-14T18:35:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621922",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:62'></a>This is arguably another homebrew distribution bug.



---

archive/issue_comments_621923.json:
```json
{
    "body": "Changing commit from \"4e777e7c9ebe47d1b9f72d625deee6c01f77c14a\" to \"bf433e8265a0f2d6ad36491f26908e8f1be48446\"",
    "created_at": "2021-03-14T19:41:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621923",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "4e777e7c9ebe47d1b9f72d625deee6c01f77c14a" to "bf433e8265a0f2d6ad36491f26908e8f1be48446"



---

archive/issue_comments_621924.json:
```json
{
    "body": "<a id='comment:63'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-14T19:41:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621924",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:63'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_621925.json:
```json
{
    "body": "<a id='comment:64'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-03-14T19:42:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621925",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:64'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_621926.json:
```json
{
    "body": "Changing commit from \"bf433e8265a0f2d6ad36491f26908e8f1be48446\" to \"e03c5ac0a9d2d82dd864d6d6d9560eddabbcbba5\"",
    "created_at": "2021-03-14T19:42:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621926",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "bf433e8265a0f2d6ad36491f26908e8f1be48446" to "e03c5ac0a9d2d82dd864d6d6d9560eddabbcbba5"



---

archive/issue_comments_621927.json:
```json
{
    "body": "<a id='comment:65'></a>Prompted by slelievre's report on sage-devel, applying this fix to all packages by putting the setting in `build/bin/sage-build-env`.\nNeeds review",
    "created_at": "2021-03-14T19:44:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621927",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:65'></a>Prompted by slelievre's report on sage-devel, applying this fix to all packages by putting the setting in `build/bin/sage-build-env`.
Needs review



---

archive/issue_comments_621928.json:
```json
{
    "body": "<a id='comment:66'></a>Confirmed by `@`slelievre to fix the `cysignals` build in https://groups.google.com/g/sage-release/c/KdSKg6RdZok/m/O1VHLlUKAwAJ",
    "created_at": "2021-03-16T01:47:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621928",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:66'></a>Confirmed by `@`slelievre to fix the `cysignals` build in https://groups.google.com/g/sage-release/c/KdSKg6RdZok/m/O1VHLlUKAwAJ



---

archive/issue_comments_621929.json:
```json
{
    "body": "Changing reviewer from \"\" to \"John Palmieri\"",
    "created_at": "2021-03-16T17:29:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621929",
    "user": "https://github.com/jhpalmieri"
}
```

Changing reviewer from "" to "John Palmieri"



---

archive/issue_comments_621930.json:
```json
{
    "body": "<a id='comment:67'></a>I can confirm, too: if I install `pari` and `singular` via homebrew, then `cysignals` doesn't build without this fix.",
    "created_at": "2021-03-16T17:29:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621930",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:67'></a>I can confirm, too: if I install `pari` and `singular` via homebrew, then `cysignals` doesn't build without this fix.



---

archive/issue_comments_621931.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-03-16T17:29:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621931",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_621932.json:
```json
{
    "body": "<a id='comment:68'></a>Thanks!",
    "created_at": "2021-03-16T18:28:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621932",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:68'></a>Thanks!



---

archive/issue_comments_621933.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-03-18T22:32:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621933",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_621934.json:
```json
{
    "body": "Changing branch from \"u/mkoeppe/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build\" to \"e03c5ac0a9d2d82dd864d6d6d9560eddabbcbba5\"",
    "created_at": "2021-03-18T22:32:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621934",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/mkoeppe/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build" to "e03c5ac0a9d2d82dd864d6d6d9560eddabbcbba5"



---

archive/issue_events_082066.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-03-18T22:32:29Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31335#event-82066"
}
```



---

archive/issue_comments_621935.json:
```json
{
    "body": "Changing commit from \"e03c5ac0a9d2d82dd864d6d6d9560eddabbcbba5\" to \"\"",
    "created_at": "2022-02-08T06:48:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621935",
    "user": "https://github.com/mkoeppe"
}
```

Changing commit from "e03c5ac0a9d2d82dd864d6d6d9560eddabbcbba5" to ""



---

archive/issue_comments_621936.json:
```json
{
    "body": "<a id='comment:70'></a>The problem with distutils.cfg has now been addressed by homebrew for their Python 3.10 package, see #31348#comment:38",
    "created_at": "2022-02-08T06:48:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31335#issuecomment-621936",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:70'></a>The problem with distutils.cfg has now been addressed by homebrew for their Python 3.10 package, see #31348#comment:38
