# Issue 31335: homebrew: Unused packages (singular, pari, ...) in /usr/local leak into sagelib/cysignals builds via distutils.cfg

archive/issues_031098.json:
```json
{
    "assignees": [],
    "body": "Follow-up from #31132:\n\nIt has been reported that it's still leaking with the upgraded python3 from homebrew that includes https://github.com/Homebrew/homebrew-core/commit/784d29205ee5bd27fed226a5f96837428e171825\n\n\nThe `sagelib` build collects many `-I`, `-L` directives through pkgconfig. \nSuch directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.\nNow if `-I/usr/local/` or `-L/usr/local` (instead of more specific paths to `/usr/local/Cellar/.../...`) appear, then unwanted packages that happen to be installed can leak in. \n\nHowever, here the problem is caused by homebrew installing a `distutils.cfg` that injects `/usr/local/include` into our include search path.\nWe fix the leak by switching to a modern configuration of setuptools.\n\nThis also affects `cysignals`, as reported in https://groups.google.com/g/sage-release/c/KdSKg6RdZok/m/91Ibwn8RAgAJ\n\n\nRelevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~); possible follow-up: #31338\n\n\n\n\nCC:  @jhpalmieri @zlscherr @kiwifb @kliem @slel\n\nBranch: **[`e03c5ac`](https://github.com/sagemath/sagetrac-mirror/commit/e03c5ac0a9d2d82dd864d6d6d9560eddabbcbba5)**\n\nReviewer: **John Palmieri**\n\nAuthor: **Matthias Koeppe**\n\nComponent: **build**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/31335_\n\n",
    "closed_at": "2021-03-18T22:32:29Z",
    "created_at": "2021-02-04T02:32:45Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20build",
        "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.3",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "homebrew: Unused packages (singular, pari, ...) in /usr/local leak into sagelib/cysignals builds via distutils.cfg",
    "type": "issue",
    "updated_at": "2022-02-08T06:48:37Z",
    "url": "https://github.com/sagemath/sage/issues/31335",
    "user": "https://github.com/mkoeppe"
}
```
Follow-up from #31132:

It has been reported that it's still leaking with the upgraded python3 from homebrew that includes https://github.com/Homebrew/homebrew-core/commit/784d29205ee5bd27fed226a5f96837428e171825


The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. 
Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.
Now if `-I/usr/local/` or `-L/usr/local` (instead of more specific paths to `/usr/local/Cellar/.../...`) appear, then unwanted packages that happen to be installed can leak in. 

However, here the problem is caused by homebrew installing a `distutils.cfg` that injects `/usr/local/include` into our include search path.
We fix the leak by switching to a modern configuration of setuptools.

This also affects `cysignals`, as reported in https://groups.google.com/g/sage-release/c/KdSKg6RdZok/m/91Ibwn8RAgAJ


Relevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~); possible follow-up: #31338




CC:  @jhpalmieri @zlscherr @kiwifb @kliem @slel

Branch: **[`e03c5ac`](https://github.com/sagemath/sagetrac-mirror/commit/e03c5ac0a9d2d82dd864d6d6d9560eddabbcbba5)**

Reviewer: **John Palmieri**

Author: **Matthias Koeppe**

Component: **build**

_Issue created by migration from https://trac.sagemath.org/ticket/31335_





---

archive/issue_events_428778.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-04T02:32:45Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31335#event-428778"
}
```



---

archive/issue_events_428779.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-04T02:32:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20build",
    "label_color": "0000b0",
    "label_name": "c: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31335#event-428779"
}
```



---

archive/issue_events_428780.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-04T02:32:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
    "label_color": "ff7700",
    "label_name": "p: critical / 2",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31335#event-428780"
}
```



---

archive/issue_events_428781.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-04T02:32:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31335#event-428781"
}
```



---

archive/issue_comments_502311.json:
```json
{
    "body": "Dependencies: **#30589, #31132, #31227**",
    "created_at": "2021-02-04T02:34:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502311",
    "user": "https://github.com/mkoeppe"
}
```

Dependencies: **#30589, #31132, #31227**



---

archive/issue_comments_502312.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -2,4 +2,8 @@\n \n It's still leaking.\n \n+The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. \n+Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.\n \n+\n+\n``````\n",
    "created_at": "2021-02-04T02:41:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502312",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -2,4 +2,8 @@
 
 It's still leaking.
 
+The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. 
+Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.
 
+
+
``````




---

archive/issue_comments_502313.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -5,5 +5,5 @@\n The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. \n Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.\n \n+Relevant tickets: #29562 (+), #29697 (?), #31041 (~)\n \n-\n``````\n",
    "created_at": "2021-02-04T02:46:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502313",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -5,5 +5,5 @@
 The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. 
 Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.
 
+Relevant tickets: #29562 (+), #29697 (?), #31041 (~)
 
-
``````




---

archive/issue_comments_502314.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -5,5 +5,5 @@\n The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. \n Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.\n \n-Relevant tickets: #29562 (+), #29697 (?), #31041 (~)\n+Relevant tickets: #29562 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)\n \n``````\n",
    "created_at": "2021-02-04T02:48:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502314",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -5,5 +5,5 @@
 The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. 
 Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.
 
-Relevant tickets: #29562 (+), #29697 (?), #31041 (~)
+Relevant tickets: #29562 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)
 
``````




---

archive/issue_comments_502315.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -5,5 +5,8 @@\n The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. \n Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.\n \n-Relevant tickets: #29562 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)\n+To make sure that \n \n+\n+Relevant tickets: #13348, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)\n+\n``````\n",
    "created_at": "2021-02-04T02:54:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502315",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -5,5 +5,8 @@
 The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. 
 Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.
 
-Relevant tickets: #29562 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)
+To make sure that 
 
+
+Relevant tickets: #13348, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)
+
``````




---

archive/issue_comments_502316.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -8,5 +8,5 @@\n To make sure that \n \n \n-Relevant tickets: #13348, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)\n+Relevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)\n \n``````\n",
    "created_at": "2021-02-04T02:55:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502316",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -8,5 +8,5 @@
 To make sure that 
 
 
-Relevant tickets: #13348, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)
+Relevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)
 
``````




---

archive/issue_comments_502317.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -5,7 +5,15 @@\n The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. \n Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.\n \n-To make sure that \n+Now if `-I/usr/local/` or `-L/usr/local` (instead of more specific paths to `/usr/local/Cellar/.../...`) appear, then unwanted packages that happen to be installed can leak in.\n+\n+To check whether this comes in through `pkg-config`:\n+\n+```\n+for a in $(pkg-config --list-all | sed 's/ .*//;'); do printf \"$a: \"; pkg-config --cflags $a; printf \"$a: \"; pkg-config --libs $a; done\n+```\n+\n+To make sure that libraries installed in $SAGE_LOCAL (if set) take precedence over such leaks, we should essentially revert #29697.\n \n \n Relevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)\n``````\n",
    "created_at": "2021-02-04T03:05:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502317",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -5,7 +5,15 @@
 The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. 
 Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.
 
-To make sure that 
+Now if `-I/usr/local/` or `-L/usr/local` (instead of more specific paths to `/usr/local/Cellar/.../...`) appear, then unwanted packages that happen to be installed can leak in.
+
+To check whether this comes in through `pkg-config`:
+
+```
+for a in $(pkg-config --list-all | sed 's/ .*//;'); do printf "$a: "; pkg-config --cflags $a; printf "$a: "; pkg-config --libs $a; done
+```
+
+To make sure that libraries installed in $SAGE_LOCAL (if set) take precedence over such leaks, we should essentially revert #29697.
 
 
 Relevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)
``````




---

archive/issue_comments_502318.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -13,8 +13,9 @@\n for a in $(pkg-config --list-all | sed 's/ .*//;'); do printf \"$a: \"; pkg-config --cflags $a; printf \"$a: \"; pkg-config --libs $a; done\n ```\n \n-To make sure that libraries installed in $SAGE_LOCAL (if set) take precedence over such leaks, we should essentially revert #29697.\n-\n+To make sure that libraries installed in $SAGE_LOCAL (if set) take precedence over such leaks, we should essentially revert #29697, adding some refinements:\n+- `SAGE_LOCAL` vs `SAGE_VENV`\n+- make sure that if `$SAGE_LOCAL` is unset, nothing is added\n \n Relevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)\n \n``````\n",
    "created_at": "2021-02-04T03:08:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502318",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -13,8 +13,9 @@
 for a in $(pkg-config --list-all | sed 's/ .*//;'); do printf "$a: "; pkg-config --cflags $a; printf "$a: "; pkg-config --libs $a; done
 ```
 
-To make sure that libraries installed in $SAGE_LOCAL (if set) take precedence over such leaks, we should essentially revert #29697.
-
+To make sure that libraries installed in $SAGE_LOCAL (if set) take precedence over such leaks, we should essentially revert #29697, adding some refinements:
+- `SAGE_LOCAL` vs `SAGE_VENV`
+- make sure that if `$SAGE_LOCAL` is unset, nothing is added
 
 Relevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)
 
``````




---

archive/issue_comments_502319.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nTo check whether this comes in through pkg-config, I used:\n\n```\nfor a in $(pkg-config --list-all | sed 's/ .*//;'); do printf \"$a: \"; pkg-config --cflags $a; printf \"$a: \"; pkg-config --libs $a; done\n```\nHowever, on my system, the command line in the ticket description does not find any relevant packages that directly use `/usr/local/{include,lib}` (only `lua` and `fuse` do)",
    "created_at": "2021-02-04T03:12:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502319",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:9" align="right">comment:9</div>

To check whether this comes in through pkg-config, I used:

```
for a in $(pkg-config --list-all | sed 's/ .*//;'); do printf "$a: "; pkg-config --cflags $a; printf "$a: "; pkg-config --libs $a; done
```
However, on my system, the command line in the ticket description does not find any relevant packages that directly use `/usr/local/{include,lib}` (only `lua` and `fuse` do)



---

archive/issue_comments_502320.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -13,9 +13,9 @@\n for a in $(pkg-config --list-all | sed 's/ .*//;'); do printf \"$a: \"; pkg-config --cflags $a; printf \"$a: \"; pkg-config --libs $a; done\n ```\n \n-To make sure that libraries installed in $SAGE_LOCAL (if set) take precedence over such leaks, we should essentially revert #29697, adding some refinements:\n+To make sure that libraries installed in $SAGE_LOCAL (if set) take precedence over such leaks, we could essentially revert #29697, adding some refinements:\n - `SAGE_LOCAL` vs `SAGE_VENV`\n-- make sure that if `$SAGE_LOCAL` is unset, nothing is added\n+- make sure that if `$SAGE_LOCAL` is unset, nothing is added.\n \n Relevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)\n \n``````\n",
    "created_at": "2021-02-04T03:22:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502320",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -13,9 +13,9 @@
 for a in $(pkg-config --list-all | sed 's/ .*//;'); do printf "$a: "; pkg-config --cflags $a; printf "$a: "; pkg-config --libs $a; done
 ```
 
-To make sure that libraries installed in $SAGE_LOCAL (if set) take precedence over such leaks, we should essentially revert #29697, adding some refinements:
+To make sure that libraries installed in $SAGE_LOCAL (if set) take precedence over such leaks, we could essentially revert #29697, adding some refinements:
 - `SAGE_LOCAL` vs `SAGE_VENV`
-- make sure that if `$SAGE_LOCAL` is unset, nothing is added
+- make sure that if `$SAGE_LOCAL` is unset, nothing is added.
 
 Relevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)
 
``````




---

archive/issue_comments_502321.json:
```json
{
    "body": "Changed dependencies from **#30589, #31132, #31227** to **#30589, #31132, #31227, #30770**",
    "created_at": "2021-02-04T03:25:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502321",
    "user": "https://github.com/mkoeppe"
}
```

Changed dependencies from **#30589, #31132, #31227** to **#30589, #31132, #31227, #30770**



---

archive/issue_comments_502322.json:
```json
{
    "body": "Branch: **[u/mkoeppe/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build)**",
    "created_at": "2021-02-04T04:10:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502322",
    "user": "https://github.com/mkoeppe"
}
```

Branch: **[u/mkoeppe/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build)**



---

archive/issue_comments_502323.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nWith the tickets listed in Dependencies merged (that's the branch on this ticket) and after `brew install singular pari ecl`, I get leakage from singular:\n\n```\n[sagelib-9.3.beta6] [ 1/13] gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk -O2 -g -march=native -I./sage/cpython -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/build/pkgs/sagelib/src -I/usr/local/Cellar/python@3.9/3.9.1_7/Frameworks/Python.framework/Versions/3.9/include/python3.9 -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/numpy/core/include -Ibuild/cythonized -I/usr/local/include -I/usr/local/opt/openssl@1.1/include -I/usr/local/opt/sqlite/include -I/usr/local/opt/tcl-tk/include -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include -I/usr/local/Cellar/python@3.9/3.9.1_7/Frameworks/Python.framework/Versions/3.9/include/python3.9 -c build/cythonized/sage/algebras/letterplace/free_algebra_letterplace.cpp -o build/temp.macosx-10.15-x86_64-3.9/build/cythonized/sage/algebras/letterplace/free_algebra_letterplace.o -fno-strict-aliasing -DCYTHON_CLINE_IN_TRACEBACK=1 -DSING_NDEBUG -DOM_NDEBUG -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular -std=c++11\n[sagelib-9.3.beta6] In file included from build/cythonized/sage/algebras/letterplace/free_algebra_letterplace.cpp:672:\n[sagelib-9.3.beta6] In file included from /usr/local/include/singular/Singular/libsingular.h:7:\n[sagelib-9.3.beta6] In file included from /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular/kernel/structs.h:23:\n[sagelib-9.3.beta6] In file included from /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular/kernel/polys.h:15:\n[sagelib-9.3.beta6] In file included from /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular/polys/monomials/ring.h:13:\n[sagelib-9.3.beta6] In file included from /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular/coeffs/coeffs.h:19:\n[sagelib-9.3.beta6] In file included from /usr/local/include/factory/factory.h:28:\n[sagelib-9.3.beta6] /usr/local/include/factory/si_log2.h:6:19: error: redefinition of 'SI_LOG2'\n[sagelib-9.3.beta6] static inline int SI_LOG2(int v)\n```",
    "created_at": "2021-02-04T04:17:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502323",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:13" align="right">comment:13</div>

With the tickets listed in Dependencies merged (that's the branch on this ticket) and after `brew install singular pari ecl`, I get leakage from singular:

```
[sagelib-9.3.beta6] [ 1/13] gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk -O2 -g -march=native -I./sage/cpython -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/build/pkgs/sagelib/src -I/usr/local/Cellar/python@3.9/3.9.1_7/Frameworks/Python.framework/Versions/3.9/include/python3.9 -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/numpy/core/include -Ibuild/cythonized -I/usr/local/include -I/usr/local/opt/openssl@1.1/include -I/usr/local/opt/sqlite/include -I/usr/local/opt/tcl-tk/include -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include -I/usr/local/Cellar/python@3.9/3.9.1_7/Frameworks/Python.framework/Versions/3.9/include/python3.9 -c build/cythonized/sage/algebras/letterplace/free_algebra_letterplace.cpp -o build/temp.macosx-10.15-x86_64-3.9/build/cythonized/sage/algebras/letterplace/free_algebra_letterplace.o -fno-strict-aliasing -DCYTHON_CLINE_IN_TRACEBACK=1 -DSING_NDEBUG -DOM_NDEBUG -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular -std=c++11
[sagelib-9.3.beta6] In file included from build/cythonized/sage/algebras/letterplace/free_algebra_letterplace.cpp:672:
[sagelib-9.3.beta6] In file included from /usr/local/include/singular/Singular/libsingular.h:7:
[sagelib-9.3.beta6] In file included from /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular/kernel/structs.h:23:
[sagelib-9.3.beta6] In file included from /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular/kernel/polys.h:15:
[sagelib-9.3.beta6] In file included from /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular/polys/monomials/ring.h:13:
[sagelib-9.3.beta6] In file included from /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular/coeffs/coeffs.h:19:
[sagelib-9.3.beta6] In file included from /usr/local/include/factory/factory.h:28:
[sagelib-9.3.beta6] /usr/local/include/factory/si_log2.h:6:19: error: redefinition of 'SI_LOG2'
[sagelib-9.3.beta6] static inline int SI_LOG2(int v)
```



---

archive/issue_comments_502324.json:
```json
{
    "body": "Changed branch from **[u/mkoeppe/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build)** to none",
    "created_at": "2021-02-04T04:17:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502324",
    "user": "https://github.com/mkoeppe"
}
```

Changed branch from **[u/mkoeppe/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build)** to none



---

archive/issue_comments_502325.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n Follow-up from #31132:\n \n-It's still leaking.\n+It has been reported that it's still leaking.\n \n The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. \n Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.\n``````\n",
    "created_at": "2021-02-04T04:17:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502325",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,6 @@
 Follow-up from #31132:
 
-It's still leaking.
+It has been reported that it's still leaking.
 
 The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. 
 Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.
``````




---

archive/issue_comments_502326.json:
```json
{
    "body": "Branch: **[u/mkoeppe/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build)**",
    "created_at": "2021-02-04T04:18:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502326",
    "user": "https://github.com/mkoeppe"
}
```

Branch: **[u/mkoeppe/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build)**



---

archive/issue_comments_502327.json:
```json
{
    "body": "Commit: **[`6d3409c`](https://github.com/sagemath/sagetrac-mirror/commit/6d3409c8cd0c9de8680025e0dbb8ddadc4c3d4bf)**",
    "created_at": "2021-02-04T04:24:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502327",
    "user": "https://github.com/mkoeppe"
}
```

Commit: **[`6d3409c`](https://github.com/sagemath/sagetrac-mirror/commit/6d3409c8cd0c9de8680025e0dbb8ddadc4c3d4bf)**



---

archive/issue_comments_502328.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nI think this is a specific issue with how we include singular headers.\n\n---\nLast 10 new commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/32dfadd5b2948efcf2cc9eb2f9648cc486f2e2e0\"><code>32dfadd</code></a></td><td><code>Merge branch 't/31227/accept__usr_bin_python3_from_xcode_12_3_on_macos_10_15__catalina_' into t/31335/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3049e53618902318c8247e277d28f50c1f59f545\"><code>3049e53</code></a></td><td><code>Use ecl-config to determine compiler/linker flags for ecl</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1041128342253f609a9c3b8f8efe4495bc314a2e\"><code>1041128</code></a></td><td><code>Rename ecl config variable</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/fd05a972b62b0014995887f1372e7934866fdf24\"><code>fd05a97</code></a></td><td><code>Add fallback</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2ac4cc8aeea651adeaf05632d798025e6ec530df\"><code>2ac4cc8</code></a></td><td><code>Merge branch 'develop' of git://github.com/sagemath/sage into public/build/ecl-config</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6370c345114d50095e84a9b2e7917dd8cae3bfe6\"><code>6370c34</code></a></td><td><code>src/sage/env.py: Do not use capture_output, which requires python 3.7</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/31f1bbba244263160e887613b34111bc3a20d4f4\"><code>31f1bbb</code></a></td><td><code>Also use universal_newlines instead of text, for python 3.6 compatibility</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/11ad40ae805a29feb59f0db4816cc21cd5be9f4f\"><code>11ad40a</code></a></td><td><code>Merge branch 'public/build/ecl-config' of git://trac.sagemath.org/sage into public/build/ecl-config</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/046f72f7a0d32f22f7808c1396e40b2f5801a381\"><code>046f72f</code></a></td><td><code>Merge branch 't/31227/accept__usr_bin_python3_from_xcode_12_3_on_macos_10_15__catalina_' into t/30770/public/build/ecl-config</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6d3409c8cd0c9de8680025e0dbb8ddadc4c3d4bf\"><code>6d3409c</code></a></td><td><code>Merge branch 't/30770/public/build/ecl-config' into t/31335/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build</code></td></tr></table>\n",
    "created_at": "2021-02-04T04:24:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502328",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:15" align="right">comment:15</div>

I think this is a specific issue with how we include singular headers.

---
Last 10 new commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/32dfadd5b2948efcf2cc9eb2f9648cc486f2e2e0"><code>32dfadd</code></a></td><td><code>Merge branch 't/31227/accept__usr_bin_python3_from_xcode_12_3_on_macos_10_15__catalina_' into t/31335/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3049e53618902318c8247e277d28f50c1f59f545"><code>3049e53</code></a></td><td><code>Use ecl-config to determine compiler/linker flags for ecl</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1041128342253f609a9c3b8f8efe4495bc314a2e"><code>1041128</code></a></td><td><code>Rename ecl config variable</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/fd05a972b62b0014995887f1372e7934866fdf24"><code>fd05a97</code></a></td><td><code>Add fallback</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2ac4cc8aeea651adeaf05632d798025e6ec530df"><code>2ac4cc8</code></a></td><td><code>Merge branch 'develop' of git://github.com/sagemath/sage into public/build/ecl-config</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6370c345114d50095e84a9b2e7917dd8cae3bfe6"><code>6370c34</code></a></td><td><code>src/sage/env.py: Do not use capture_output, which requires python 3.7</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/31f1bbba244263160e887613b34111bc3a20d4f4"><code>31f1bbb</code></a></td><td><code>Also use universal_newlines instead of text, for python 3.6 compatibility</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/11ad40ae805a29feb59f0db4816cc21cd5be9f4f"><code>11ad40a</code></a></td><td><code>Merge branch 'public/build/ecl-config' of git://trac.sagemath.org/sage into public/build/ecl-config</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/046f72f7a0d32f22f7808c1396e40b2f5801a381"><code>046f72f</code></a></td><td><code>Merge branch 't/31227/accept__usr_bin_python3_from_xcode_12_3_on_macos_10_15__catalina_' into t/30770/public/build/ecl-config</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6d3409c8cd0c9de8680025e0dbb8ddadc4c3d4bf"><code>6d3409c</code></a></td><td><code>Merge branch 't/30770/public/build/ecl-config' into t/31335/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build</code></td></tr></table>




---

archive/issue_comments_502329.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\n`-I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular` is (correctly) near the beginning of the command line, \nbut the problem is that `-I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include` only comes at the end -- after `-I/usr/local/include` (which probably comes in from `CPATH` set in `.homebrew-build-env`)",
    "created_at": "2021-02-04T04:42:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502329",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:16" align="right">comment:16</div>

`-I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular` is (correctly) near the beginning of the command line, 
but the problem is that `-I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include` only comes at the end -- after `-I/usr/local/include` (which probably comes in from `CPATH` set in `.homebrew-build-env`)



---

archive/issue_comments_502330.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@mkoeppe](#comment%3A16):\n> after `-I/usr/local/include` (which probably comes in from `CPATH` set in `.homebrew-build-env`)\n\nno, it's not coming from `CPATH`",
    "created_at": "2021-02-04T04:46:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502330",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@mkoeppe](#comment%3A16):
> after `-I/usr/local/include` (which probably comes in from `CPATH` set in `.homebrew-build-env`)

no, it's not coming from `CPATH`



---

archive/issue_comments_502331.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nit's also not coming in from `sage.env.cython_aliases` or `sage.env.sage_include_directories`",
    "created_at": "2021-02-04T04:49:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502331",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:18" align="right">comment:18</div>

it's also not coming in from `sage.env.cython_aliases` or `sage.env.sage_include_directories`



---

archive/issue_comments_502332.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\n\n```\ncat  /usr/local/opt/python@3.9/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/distutils.cfg \n[install]\nprefix=/usr/local\n[build_ext]\ninclude_dirs=/usr/local/include:/usr/local/opt/openssl@1.1/include:/usr/local/opt/sqlite/include:/usr/local/opt/tcl-tk/include\nlibrary_dirs=/usr/local/lib:/usr/local/opt/openssl@1.1/lib:/usr/local/opt/sqlite/lib:/usr/local/opt/tcl-tk/lib\n```",
    "created_at": "2021-02-04T04:51:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502332",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:19" align="right">comment:19</div>


```
cat  /usr/local/opt/python@3.9/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/distutils.cfg 
[install]
prefix=/usr/local
[build_ext]
include_dirs=/usr/local/include:/usr/local/opt/openssl@1.1/include:/usr/local/opt/sqlite/include:/usr/local/opt/tcl-tk/include
library_dirs=/usr/local/lib:/usr/local/opt/openssl@1.1/lib:/usr/local/opt/sqlite/lib:/usr/local/opt/tcl-tk/lib
```



---

archive/issue_comments_502333.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nThere we go, it's another distribution bug in homebrew. It installs a `distutils.cfg` that injects the paths into our build.\n\nhomebrew has been struggling with this since at least 2014 - https://github.com/Homebrew/legacy-homebrew/issues/26272",
    "created_at": "2021-02-04T05:00:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502333",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:20" align="right">comment:20</div>

There we go, it's another distribution bug in homebrew. It installs a `distutils.cfg` that injects the paths into our build.

homebrew has been struggling with this since at least 2014 - https://github.com/Homebrew/legacy-homebrew/issues/26272



---

archive/issue_comments_502334.json:
```json
{
    "body": "Changed commit from **[`6d3409c`](https://github.com/sagemath/sagetrac-mirror/commit/6d3409c8cd0c9de8680025e0dbb8ddadc4c3d4bf)** to **[`017c351`](https://github.com/sagemath/sagetrac-mirror/commit/017c35126d38d01a42d0a51e7c6bfa20f23c7eac)**",
    "created_at": "2021-02-04T05:10:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502334",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`6d3409c`](https://github.com/sagemath/sagetrac-mirror/commit/6d3409c8cd0c9de8680025e0dbb8ddadc4c3d4bf)** to **[`017c351`](https://github.com/sagemath/sagetrac-mirror/commit/017c35126d38d01a42d0a51e7c6bfa20f23c7eac)**



---

archive/issue_comments_502335.json:
```json
{
    "body": "<div id=\"comment:21\"></div>\n\nBranch pushed to git repo; I updated commit sha1. Last 10 new commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6432727a4fb106206dd0aae3d8e62715cd6725b3\"><code>6432727</code></a></td><td><code>Merge tag '9.3.beta2' into t/30912/sagelib__update_metadata_for_pypi_deployment</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4a693f22c6044c8baa80f744519855371e3c4aae\"><code>4a693f2</code></a></td><td><code>Move build/pkgs/sagelib/src/setup.cfg to SAGE_ROOT/src, replace by symlink</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ea182d7302b3d362bbd38b548cda65c86e3b6f66\"><code>ea182d7</code></a></td><td><code>Copy changes from build/pkgs/sagelib/src to src</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a1a10b9b524e63574bbf1de2c4ce6f149116f147\"><code>a1a10b9</code></a></td><td><code>src/VERSION.txt: New</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5697335ed14c929adb01a3fafe95f82b79248918\"><code>5697335</code></a></td><td><code>src/setup.cfg: Add license_file=LICENSE.txt</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/deb9eb3a33ee6474f755a9bee6f487d839c9d247\"><code>deb9eb3</code></a></td><td><code>Merge tag '9.3.beta3' into t/30912/sagelib__update_metadata_for_pypi_deployment</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7ad4c0e6da58f8851cfbced0e9c1a66c9479f918\"><code>7ad4c0e</code></a></td><td><code>Merge tag '9.3.beta4' into t/30912/sagelib__update_metadata_for_pypi_deployment</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/62e1945feca75b3f7dcc5b9118e9576376836d82\"><code>62e1945</code></a></td><td><code>Merge branch 't/30912/sagelib__update_metadata_for_pypi_deployment' into t/31335/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5c86b590e64d4c18d392a14abc2129205862d12e\"><code>5c86b59</code></a></td><td><code>trac 31134: update setuptools, setuptools_scm</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/017c35126d38d01a42d0a51e7c6bfa20f23c7eac\"><code>017c351</code></a></td><td><code>Merge commit '5c86b590e64d4c18d392a14abc2129205862d12e' of git://trac.sagemath.org/sage into t/31335/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build</code></td></tr></table>\n",
    "created_at": "2021-02-04T05:10:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502335",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:21"></div>

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6432727a4fb106206dd0aae3d8e62715cd6725b3"><code>6432727</code></a></td><td><code>Merge tag '9.3.beta2' into t/30912/sagelib__update_metadata_for_pypi_deployment</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4a693f22c6044c8baa80f744519855371e3c4aae"><code>4a693f2</code></a></td><td><code>Move build/pkgs/sagelib/src/setup.cfg to SAGE_ROOT/src, replace by symlink</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ea182d7302b3d362bbd38b548cda65c86e3b6f66"><code>ea182d7</code></a></td><td><code>Copy changes from build/pkgs/sagelib/src to src</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a1a10b9b524e63574bbf1de2c4ce6f149116f147"><code>a1a10b9</code></a></td><td><code>src/VERSION.txt: New</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5697335ed14c929adb01a3fafe95f82b79248918"><code>5697335</code></a></td><td><code>src/setup.cfg: Add license_file=LICENSE.txt</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/deb9eb3a33ee6474f755a9bee6f487d839c9d247"><code>deb9eb3</code></a></td><td><code>Merge tag '9.3.beta3' into t/30912/sagelib__update_metadata_for_pypi_deployment</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7ad4c0e6da58f8851cfbced0e9c1a66c9479f918"><code>7ad4c0e</code></a></td><td><code>Merge tag '9.3.beta4' into t/30912/sagelib__update_metadata_for_pypi_deployment</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/62e1945feca75b3f7dcc5b9118e9576376836d82"><code>62e1945</code></a></td><td><code>Merge branch 't/30912/sagelib__update_metadata_for_pypi_deployment' into t/31335/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5c86b590e64d4c18d392a14abc2129205862d12e"><code>5c86b59</code></a></td><td><code>trac 31134: update setuptools, setuptools_scm</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/017c35126d38d01a42d0a51e7c6bfa20f23c7eac"><code>017c351</code></a></td><td><code>Merge commit '5c86b590e64d4c18d392a14abc2129205862d12e' of git://trac.sagemath.org/sage into t/31335/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build</code></td></tr></table>




---

archive/issue_comments_502336.json:
```json
{
    "body": "Changed dependencies from **#30589, #31132, #31227, #30770** to **#30589, #31132, #31227, #30770, #31134**",
    "created_at": "2021-02-04T05:11:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502336",
    "user": "https://github.com/mkoeppe"
}
```

Changed dependencies from **#30589, #31132, #31227, #30770** to **#30589, #31132, #31227, #30770, #31134**



---

archive/issue_comments_502337.json:
```json
{
    "body": "Changed dependencies from **#30589, #31132, #31227, #30770, #31134** to **#30589, #31132, #31227, #30770, #30912, #31134**",
    "created_at": "2021-02-04T05:11:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502337",
    "user": "https://github.com/mkoeppe"
}
```

Changed dependencies from **#30589, #31132, #31227, #30770, #31134** to **#30589, #31132, #31227, #30770, #30912, #31134**



---

archive/issue_comments_502338.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nWe can work around the existence of this `distutils.cfg` by using `setuptools` (#30912) - more specifically versions of `setuptools` that bring and use their own copy of distutils.\n\nsetuptools 49.6.0 (in Sage 9.3.beta6) does not; >=50.0.0 does; >=50.1.0 only does if `SETUPTOOLS_USE_DISTUTILS=local` is set. (https://setuptools.readthedocs.io/en/latest/history.html#v50-1-0)\n\n#31134 updates setuptools to 51.1.1.",
    "created_at": "2021-02-04T05:20:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502338",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:24" align="right">comment:24</div>

We can work around the existence of this `distutils.cfg` by using `setuptools` (#30912) - more specifically versions of `setuptools` that bring and use their own copy of distutils.

setuptools 49.6.0 (in Sage 9.3.beta6) does not; >=50.0.0 does; >=50.1.0 only does if `SETUPTOOLS_USE_DISTUTILS=local` is set. (https://setuptools.readthedocs.io/en/latest/history.html#v50-1-0)

#31134 updates setuptools to 51.1.1.



---

archive/issue_comments_502339.json:
```json
{
    "body": "Changed commit from **[`017c351`](https://github.com/sagemath/sagetrac-mirror/commit/017c35126d38d01a42d0a51e7c6bfa20f23c7eac)** to **[`00b3109`](https://github.com/sagemath/sagetrac-mirror/commit/00b3109cd440cb56212b0a520f7e0e889356cc3c)**",
    "created_at": "2021-02-04T05:27:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502339",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`017c351`](https://github.com/sagemath/sagetrac-mirror/commit/017c35126d38d01a42d0a51e7c6bfa20f23c7eac)** to **[`00b3109`](https://github.com/sagemath/sagetrac-mirror/commit/00b3109cd440cb56212b0a520f7e0e889356cc3c)**



---

archive/issue_comments_502340.json:
```json
{
    "body": "<div id=\"comment:25\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/00b3109cd440cb56212b0a520f7e0e889356cc3c\"><code>00b3109</code></a></td><td><code>build/pkgs/sagelib/spkg-install: Set SETUPTOOLS_USE_DISTUTILS=local</code></td></tr></table>\n",
    "created_at": "2021-02-04T05:27:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502340",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:25"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/00b3109cd440cb56212b0a520f7e0e889356cc3c"><code>00b3109</code></a></td><td><code>build/pkgs/sagelib/spkg-install: Set SETUPTOOLS_USE_DISTUTILS=local</code></td></tr></table>




---

archive/issue_comments_502341.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nThis changes behavior:\n\n```\n[sagelib-9.3.beta6] [ 1/13] gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk -O2 -g -march=native -I./sage/cpython -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/build/pkgs/sagelib/src -I/usr/local/Cellar/python@3.9/3.9.1_7/Frameworks/Python.framework/Versions/3.9/include/python3.9 -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/numpy/core/include -Ibuild/cythonized -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include -I/usr/local/Cellar/python@3.9/3.9.1_7/Frameworks/Python.framework/Versions/3.9/include/python3.9 -c build/cythonized/sage/algebras/letterplace/free_algebra_letterplace.cpp -o build/temp.macosx-10.15-x86_64-3.9/build/cythonized/sage/algebras/letterplace/free_algebra_letterplace.o -fno-strict-aliasing -DCYTHON_CLINE_IN_TRACEBACK=1 -DSING_NDEBUG -DOM_NDEBUG -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular -std=c++11\n[sagelib-9.3.beta6] build/cythonized/sage/algebras/letterplace/free_algebra_letterplace.cpp:671:10: fatal error: 'gmp.h' file not found\n[sagelib-9.3.beta6] #include \"gmp.h\"\n[sagelib-9.3.beta6]          ^~~~~~~\n[sagelib-9.3.beta6] 1 error generated.\n```",
    "created_at": "2021-02-04T05:28:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502341",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:26" align="right">comment:26</div>

This changes behavior:

```
[sagelib-9.3.beta6] [ 1/13] gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk -O2 -g -march=native -I./sage/cpython -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/build/pkgs/sagelib/src -I/usr/local/Cellar/python@3.9/3.9.1_7/Frameworks/Python.framework/Versions/3.9/include/python3.9 -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/numpy/core/include -Ibuild/cythonized -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include -I/usr/local/Cellar/python@3.9/3.9.1_7/Frameworks/Python.framework/Versions/3.9/include/python3.9 -c build/cythonized/sage/algebras/letterplace/free_algebra_letterplace.cpp -o build/temp.macosx-10.15-x86_64-3.9/build/cythonized/sage/algebras/letterplace/free_algebra_letterplace.o -fno-strict-aliasing -DCYTHON_CLINE_IN_TRACEBACK=1 -DSING_NDEBUG -DOM_NDEBUG -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/singular -std=c++11
[sagelib-9.3.beta6] build/cythonized/sage/algebras/letterplace/free_algebra_letterplace.cpp:671:10: fatal error: 'gmp.h' file not found
[sagelib-9.3.beta6] #include "gmp.h"
[sagelib-9.3.beta6]          ^~~~~~~
[sagelib-9.3.beta6] 1 error generated.
```



---

archive/issue_comments_502342.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nOK, I had removed `/usr/local/include` from `CPATH` in my shell.\n\nWhen I restore it (using `.homebrew-build-env`), it builds OK!",
    "created_at": "2021-02-04T05:40:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502342",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:27" align="right">comment:27</div>

OK, I had removed `/usr/local/include` from `CPATH` in my shell.

When I restore it (using `.homebrew-build-env`), it builds OK!



---

archive/issue_comments_502343.json:
```json
{
    "body": "Author: **Matthias Koeppe**",
    "created_at": "2021-02-04T05:49:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502343",
    "user": "https://github.com/mkoeppe"
}
```

Author: **Matthias Koeppe**



---

archive/issue_comments_502344.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -2,20 +2,22 @@\n \n It has been reported that it's still leaking.\n \n+\n The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. \n Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.\n \n-Now if `-I/usr/local/` or `-L/usr/local` (instead of more specific paths to `/usr/local/Cellar/.../...`) appear, then unwanted packages that happen to be installed can leak in.\n-\n-To check whether this comes in through `pkg-config`:\n+Now if `-I/usr/local/` or `-L/usr/local` (instead of more specific paths to `/usr/local/Cellar/.../...`) appear, then unwanted packages that happen to be installed can leak in. To check whether this comes in through `pkg-config`:\n \n ```\n for a in $(pkg-config --list-all | sed 's/ .*//;'); do printf \"$a: \"; pkg-config --cflags $a; printf \"$a: \"; pkg-config --libs $a; done\n ```\n \n-To make sure that libraries installed in $SAGE_LOCAL (if set) take precedence over such leaks, we could essentially revert #29697, adding some refinements:\n-- `SAGE_LOCAL` vs `SAGE_VENV`\n-- make sure that if `$SAGE_LOCAL` is unset, nothing is added.\n \n-Relevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)\n+However, here the problem is caused by homebrew installing a `distutils.cfg` that injects `/usr/local/include` into our include search path.\n+We fix the leak by switching to a modern configuration of setuptools.\n \n+\n+Relevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~); possible follow-up: #31338\n+\n+\n+\n``````\n",
    "created_at": "2021-02-04T05:49:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502344",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -2,20 +2,22 @@
 
 It has been reported that it's still leaking.
 
+
 The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. 
 Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.
 
-Now if `-I/usr/local/` or `-L/usr/local` (instead of more specific paths to `/usr/local/Cellar/.../...`) appear, then unwanted packages that happen to be installed can leak in.
-
-To check whether this comes in through `pkg-config`:
+Now if `-I/usr/local/` or `-L/usr/local` (instead of more specific paths to `/usr/local/Cellar/.../...`) appear, then unwanted packages that happen to be installed can leak in. To check whether this comes in through `pkg-config`:
 
 ```
 for a in $(pkg-config --list-all | sed 's/ .*//;'); do printf "$a: "; pkg-config --cflags $a; printf "$a: "; pkg-config --libs $a; done
 ```
 
-To make sure that libraries installed in $SAGE_LOCAL (if set) take precedence over such leaks, we could essentially revert #29697, adding some refinements:
-- `SAGE_LOCAL` vs `SAGE_VENV`
-- make sure that if `$SAGE_LOCAL` is unset, nothing is added.
 
-Relevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~)
+However, here the problem is caused by homebrew installing a `distutils.cfg` that injects `/usr/local/include` into our include search path.
+We fix the leak by switching to a modern configuration of setuptools.
 
+
+Relevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~); possible follow-up: #31338
+
+
+
``````




---

archive/issue_events_428782.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-04T05:49:23Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "title_is": "homebrew: Unused packages (singular, pari, ...) in /usr/local leak into sagelib build via distutils.cfg",
    "title_was": "homebrew: Unused packages (singular, pari, ...) in /usr/local leak into sagelib build",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31335#event-428782"
}
```



---

archive/issue_events_428783.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-04T05:49:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31335#event-428783"
}
```



---

archive/issue_comments_502345.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nReady for review. Depends on #30912, which also needs review.",
    "created_at": "2021-02-04T05:51:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502345",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:29" align="right">comment:29</div>

Ready for review. Depends on #30912, which also needs review.



---

archive/issue_comments_502346.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -5,13 +5,7 @@\n \n The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. \n Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.\n-\n-Now if `-I/usr/local/` or `-L/usr/local` (instead of more specific paths to `/usr/local/Cellar/.../...`) appear, then unwanted packages that happen to be installed can leak in. To check whether this comes in through `pkg-config`:\n-\n-```\n-for a in $(pkg-config --list-all | sed 's/ .*//;'); do printf \"$a: \"; pkg-config --cflags $a; printf \"$a: \"; pkg-config --libs $a; done\n-```\n-\n+Now if `-I/usr/local/` or `-L/usr/local` (instead of more specific paths to `/usr/local/Cellar/.../...`) appear, then unwanted packages that happen to be installed can leak in. \n \n However, here the problem is caused by homebrew installing a `distutils.cfg` that injects `/usr/local/include` into our include search path.\n We fix the leak by switching to a modern configuration of setuptools.\n``````\n",
    "created_at": "2021-02-04T05:51:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502346",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -5,13 +5,7 @@
 
 The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. 
 Such directives on the command line take precedence over the search paths set by `sage-env` in `$CPATH`, `$LIBRARY_PATH`.
-
-Now if `-I/usr/local/` or `-L/usr/local` (instead of more specific paths to `/usr/local/Cellar/.../...`) appear, then unwanted packages that happen to be installed can leak in. To check whether this comes in through `pkg-config`:
-
-```
-for a in $(pkg-config --list-all | sed 's/ .*//;'); do printf "$a: "; pkg-config --cflags $a; printf "$a: "; pkg-config --libs $a; done
-```
-
+Now if `-I/usr/local/` or `-L/usr/local` (instead of more specific paths to `/usr/local/Cellar/.../...`) appear, then unwanted packages that happen to be installed can leak in. 
 
 However, here the problem is caused by homebrew installing a `distutils.cfg` that injects `/usr/local/include` into our include search path.
 We fix the leak by switching to a modern configuration of setuptools.
``````




---

archive/issue_comments_502347.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n Follow-up from #31132:\n \n-It has been reported that it's still leaking.\n+It has been reported that it's still leaking with the upgraded python3 from homebrew that includes https://github.com/Homebrew/homebrew-core/commit/784d29205ee5bd27fed226a5f96837428e171825\n \n \n The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. \n``````\n",
    "created_at": "2021-02-04T19:14:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502347",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,6 @@
 Follow-up from #31132:
 
-It has been reported that it's still leaking.
+It has been reported that it's still leaking with the upgraded python3 from homebrew that includes https://github.com/Homebrew/homebrew-core/commit/784d29205ee5bd27fed226a5f96837428e171825
 
 
 The `sagelib` build collects many `-I`, `-L` directives through pkgconfig. 
``````




---

archive/issue_comments_502348.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nJust tried building and got the following error in sagelib:\n\n\n```\nmultiprocessing.pool.RemoteTraceback: \n\"\"\"\nTraceback (most recent call last):\n  File \"/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/pool.py\", line 125, in worker\n    result = (True, func(*args, **kwds))\n  File \"/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/pool.py\", line 48, in mapstar\n    return list(map(*args))\n  File \"/Users/zscherr/sage/develop/build/pkgs/sagelib/src/sage_setup/run_parallel.py\", line 50, in apply_func_progress\n    return p[0](p[1])\n  File \"/Users/zscherr/sage/develop/build/pkgs/sagelib/src/sage_setup/command/sage_build_ext.py\", line 163, in build_extension\n    objects = self.compiler.compile(sources,\n  File \"/Users/zscherr/sage/develop/local/lib/python3.9/site-packages/setuptools/_distutils/ccompiler.py\", line 574, in compile\n    self._compile(obj, src, ext, cc_args, extra_postargs, pp_opts)\n  File \"/Users/zscherr/sage/develop/local/lib/python3.9/site-packages/setuptools/_distutils/unixccompiler.py\", line 117, in _compile\n    self.spawn(compiler_so + cc_args + [src, '-o', obj] +\n  File \"/Users/zscherr/sage/develop/local/lib/python3.9/site-packages/setuptools/_distutils/ccompiler.py\", line 910, in spawn\n    spawn(cmd, dry_run=self.dry_run, **kwargs)\n  File \"/Users/zscherr/sage/develop/local/lib/python3.9/site-packages/setuptools/_distutils/spawn.py\", line 61, in spawn\n    _cfg_target_split = [int(x) for x in _cfg_target.split('.')]\nAttributeError: 'int' object has no attribute 'split'\n\"\"\"\n```",
    "created_at": "2021-02-04T23:46:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502348",
    "user": "https://github.com/zlscherr"
}
```

<div id="comment:31" align="right">comment:31</div>

Just tried building and got the following error in sagelib:


```
multiprocessing.pool.RemoteTraceback: 
"""
Traceback (most recent call last):
  File "/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/pool.py", line 125, in worker
    result = (True, func(*args, **kwds))
  File "/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/pool.py", line 48, in mapstar
    return list(map(*args))
  File "/Users/zscherr/sage/develop/build/pkgs/sagelib/src/sage_setup/run_parallel.py", line 50, in apply_func_progress
    return p[0](p[1])
  File "/Users/zscherr/sage/develop/build/pkgs/sagelib/src/sage_setup/command/sage_build_ext.py", line 163, in build_extension
    objects = self.compiler.compile(sources,
  File "/Users/zscherr/sage/develop/local/lib/python3.9/site-packages/setuptools/_distutils/ccompiler.py", line 574, in compile
    self._compile(obj, src, ext, cc_args, extra_postargs, pp_opts)
  File "/Users/zscherr/sage/develop/local/lib/python3.9/site-packages/setuptools/_distutils/unixccompiler.py", line 117, in _compile
    self.spawn(compiler_so + cc_args + [src, '-o', obj] +
  File "/Users/zscherr/sage/develop/local/lib/python3.9/site-packages/setuptools/_distutils/ccompiler.py", line 910, in spawn
    spawn(cmd, dry_run=self.dry_run, **kwargs)
  File "/Users/zscherr/sage/develop/local/lib/python3.9/site-packages/setuptools/_distutils/spawn.py", line 61, in spawn
    _cfg_target_split = [int(x) for x in _cfg_target.split('.')]
AttributeError: 'int' object has no attribute 'split'
"""
```



---

archive/issue_comments_502349.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nI just looked at the source code for spawn.py and it seems that _cfg_target is set to \n\n\n\n```\nsysconfig.get_config_var(\"MACOSX_DEPLOYMENT_TARGET\")\n```\n\nwhich is 11 and is an int type on Big Sur.",
    "created_at": "2021-02-04T23:56:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502349",
    "user": "https://github.com/zlscherr"
}
```

<div id="comment:32" align="right">comment:32</div>

I just looked at the source code for spawn.py and it seems that _cfg_target is set to 



```
sysconfig.get_config_var("MACOSX_DEPLOYMENT_TARGET")
```

which is 11 and is an int type on Big Sur.



---

archive/issue_comments_502350.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nMaybe setuptools needs a version bump?",
    "created_at": "2021-02-04T23:58:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502350",
    "user": "https://github.com/zlscherr"
}
```

<div id="comment:33" align="right">comment:33</div>

Maybe setuptools needs a version bump?



---

archive/issue_comments_502351.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nThis is parallel to https://github.com/Homebrew/homebrew-core/issues/66096",
    "created_at": "2021-02-05T00:02:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502351",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:34" align="right">comment:34</div>

This is parallel to https://github.com/Homebrew/homebrew-core/issues/66096



---

archive/issue_comments_502352.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nUnfortunately this fix that homebrew uses (https://github.com/fxcoudert/cpython/commit/6511bf56.patch) \nhas not made its way into upstream distutils (https://github.com/pypa/distutils/blob/main/distutils/spawn.py) and thus also not into the vendored distutils in setuptools (https://github.com/pypa/setuptools/blob/main/setuptools/_distutils/spawn.py).",
    "created_at": "2021-02-05T00:15:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502352",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:35" align="right">comment:35</div>

Unfortunately this fix that homebrew uses (https://github.com/fxcoudert/cpython/commit/6511bf56.patch) 
has not made its way into upstream distutils (https://github.com/pypa/distutils/blob/main/distutils/spawn.py) and thus also not into the vendored distutils in setuptools (https://github.com/pypa/setuptools/blob/main/setuptools/_distutils/spawn.py).



---

archive/issue_comments_502353.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nUpstream cpython issue:\nhttps://bugs.python.org/issue42504",
    "created_at": "2021-02-05T00:20:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502353",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:36" align="right">comment:36</div>

Upstream cpython issue:
https://bugs.python.org/issue42504



---

archive/issue_comments_502354.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nAs a temporary measure, let's put the patch into our setuptools.",
    "created_at": "2021-02-05T00:22:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502354",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:37" align="right">comment:37</div>

As a temporary measure, let's put the patch into our setuptools.



---

archive/issue_comments_502355.json:
```json
{
    "body": "Changed commit from **[`00b3109`](https://github.com/sagemath/sagetrac-mirror/commit/00b3109cd440cb56212b0a520f7e0e889356cc3c)** to **[`3601c51`](https://github.com/sagemath/sagetrac-mirror/commit/3601c510bbca6155f8e99eebf55b29e8cfe51527)**",
    "created_at": "2021-02-05T00:30:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502355",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`00b3109`](https://github.com/sagemath/sagetrac-mirror/commit/00b3109cd440cb56212b0a520f7e0e889356cc3c)** to **[`3601c51`](https://github.com/sagemath/sagetrac-mirror/commit/3601c510bbca6155f8e99eebf55b29e8cfe51527)**



---

archive/issue_comments_502356.json:
```json
{
    "body": "<div id=\"comment:38\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/fd23c0dde13d4a99b73f24d7cb4739dae9edf771\"><code>fd23c0d</code></a></td><td><code>build/pkgs/setuptools/patches: Add distutils patch from https://github.com/fxcoudert/cpython/commit/6511bf56.patch</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3601c510bbca6155f8e99eebf55b29e8cfe51527\"><code>3601c51</code></a></td><td><code>Adapt the patch to apply to the vendored distutils</code></td></tr></table>\n",
    "created_at": "2021-02-05T00:30:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502356",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:38"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/fd23c0dde13d4a99b73f24d7cb4739dae9edf771"><code>fd23c0d</code></a></td><td><code>build/pkgs/setuptools/patches: Add distutils patch from https://github.com/fxcoudert/cpython/commit/6511bf56.patch</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3601c510bbca6155f8e99eebf55b29e8cfe51527"><code>3601c51</code></a></td><td><code>Adapt the patch to apply to the vendored distutils</code></td></tr></table>




---

archive/issue_comments_502357.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nPlease test on big sur",
    "created_at": "2021-02-05T01:41:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502357",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:39" align="right">comment:39</div>

Please test on big sur



---

archive/issue_comments_502358.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nI was able to build successfully on Big Sur with the following packages installed via homebrew:\n\nflint arb pari singular ecl maxima fplll\n\nThere's still the issue that documentation is not building using homebrew's python 3.9, https://groups.google.com/g/sage-devel/c/9EMs9h2i_H4, but I have no idea what's going on there.",
    "created_at": "2021-02-05T02:34:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502358",
    "user": "https://github.com/zlscherr"
}
```

<div id="comment:40" align="right">comment:40</div>

I was able to build successfully on Big Sur with the following packages installed via homebrew:

flint arb pari singular ecl maxima fplll

There's still the issue that documentation is not building using homebrew's python 3.9, https://groups.google.com/g/sage-devel/c/9EMs9h2i_H4, but I have no idea what's going on there.



---

archive/issue_comments_502359.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\nReplying to [@zlscherr](#comment%3A40):\n> There's still the issue that documentation is not building using homebrew's python 3.9, https://groups.google.com/g/sage-devel/c/9EMs9h2i_H4, but I have no idea what's going on there.\n\nI guess it would be worth checking for `libtcl` with `otool -L $SAGE_LOCAL/lib/* /usr/local/lib/*`",
    "created_at": "2021-02-05T03:10:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502359",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:41" align="right">comment:41</div>

Replying to [@zlscherr](#comment%3A40):
> There's still the issue that documentation is not building using homebrew's python 3.9, https://groups.google.com/g/sage-devel/c/9EMs9h2i_H4, but I have no idea what's going on there.

I guess it would be worth checking for `libtcl` with `otool -L $SAGE_LOCAL/lib/* /usr/local/lib/*`



---

archive/issue_comments_502360.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nI have opened #31344 for the docbuild crash - I also see it on Catalina with homebrew's python3.9",
    "created_at": "2021-02-05T06:36:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502360",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:42" align="right">comment:42</div>

I have opened #31344 for the docbuild crash - I also see it on Catalina with homebrew's python3.9



---

archive/issue_comments_502361.json:
```json
{
    "body": "<div id=\"comment:43\" align=\"right\">comment:43</div>\n\nReplying to [@mkoeppe](#comment%3A41):\n> I guess it would be worth checking for `libtcl` with `otool -L $SAGE_LOCAL/lib/* /usr/local/lib/*` \n\nI didn't see anything suspicious here - so it's not just a library mismatch",
    "created_at": "2021-02-05T06:36:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502361",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:43" align="right">comment:43</div>

Replying to [@mkoeppe](#comment%3A41):
> I guess it would be worth checking for `libtcl` with `otool -L $SAGE_LOCAL/lib/* /usr/local/lib/*` 

I didn't see anything suspicious here - so it's not just a library mismatch



---

archive/issue_comments_502362.json:
```json
{
    "body": "<div id=\"comment:44\" align=\"right\">comment:44</div>\n\n(continuing on #31344 regarding docbuild)",
    "created_at": "2021-02-05T07:09:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502362",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:44" align="right">comment:44</div>

(continuing on #31344 regarding docbuild)



---

archive/issue_comments_502363.json:
```json
{
    "body": "Changed dependencies from **#30589, #31132, #31227, #30770, #30912, #31134** to **#30589, #31132, #31227, #30770, #30912, #31134, #31344**",
    "created_at": "2021-02-05T09:10:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502363",
    "user": "https://github.com/mkoeppe"
}
```

Changed dependencies from **#30589, #31132, #31227, #30770, #30912, #31134** to **#30589, #31132, #31227, #30770, #30912, #31134, #31344**



---

archive/issue_comments_502364.json:
```json
{
    "body": "<div id=\"comment:46\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/80720d7bcc0b1de4b92984fa62d52dad5855b9b0\"><code>80720d7</code></a></td><td><code>src/sage/misc/cython.py: Do not run pkgconfig at import time</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9ad84cc0105665ac9c1988a3e8fa0914fd1eac73\"><code>9ad84cc</code></a></td><td><code>Merge branch 't/31344/homebrew__docbuild_crashes__libtcl_atforkprepare' into t/31335/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build</code></td></tr></table>\n",
    "created_at": "2021-02-05T09:11:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502364",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:46"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/80720d7bcc0b1de4b92984fa62d52dad5855b9b0"><code>80720d7</code></a></td><td><code>src/sage/misc/cython.py: Do not run pkgconfig at import time</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9ad84cc0105665ac9c1988a3e8fa0914fd1eac73"><code>9ad84cc</code></a></td><td><code>Merge branch 't/31344/homebrew__docbuild_crashes__libtcl_atforkprepare' into t/31335/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build</code></td></tr></table>




---

archive/issue_comments_502365.json:
```json
{
    "body": "Changed commit from **[`3601c51`](https://github.com/sagemath/sagetrac-mirror/commit/3601c510bbca6155f8e99eebf55b29e8cfe51527)** to **[`9ad84cc`](https://github.com/sagemath/sagetrac-mirror/commit/9ad84cc0105665ac9c1988a3e8fa0914fd1eac73)**",
    "created_at": "2021-02-05T09:11:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502365",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`3601c51`](https://github.com/sagemath/sagetrac-mirror/commit/3601c510bbca6155f8e99eebf55b29e8cfe51527)** to **[`9ad84cc`](https://github.com/sagemath/sagetrac-mirror/commit/9ad84cc0105665ac9c1988a3e8fa0914fd1eac73)**



---

archive/issue_comments_502366.json:
```json
{
    "body": "<div id=\"comment:47\" align=\"right\">comment:47</div>\n\nI see some doctests failing on this branch that may be related to the new distutils.  In particular,\n\n```\n./sage -t src/sage/tests/cmdline.py\n```\n\nfails.  One of the failing tests creates a temporary spyx file, and when it tries to run it with sage, it gives the following error\n\n```\nTraceback (most recent call last):\n  File \"/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/unixccompiler.py\", line 117, in _compile\n    self.spawn(compiler_so + cc_args + [src, '-o', obj] +\n  File \"/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/ccompiler.py\", line 910, in spawn\n    spawn(cmd, dry_run=self.dry_run)\n  File \"/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/spawn.py\", line 87, in spawn\n    raise DistutilsExecError(\ndistutils.errors.DistutilsExecError: command '/usr/bin/gcc' failed with exit code 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/zscherr/sage/develop/local/lib/python3.9/site-packages/sage/misc/cython.py\", line 386, in cython\n    dist.run_command(\"build\")\n  File \"/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/dist.py\", line 985, in run_command\n    cmd_obj.run()\n  File \"/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/command/build.py\", line 135, in run\n    self.run_command(cmd_name)\n  File \"/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/cmd.py\", line 313, in run_command\n    self.distribution.run_command(command)\n  File \"/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/dist.py\", line 985, in run_command\n    cmd_obj.run()\n  File \"/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/command/build_ext.py\", line 340, in run\n    self.build_extensions()\n  File \"/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/command/build_ext.py\", line 449, in build_extensions\n    self._build_extensions_serial()\n  File \"/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/command/build_ext.py\", line 474, in _build_extensions_serial\n    self.build_extension(ext)\n  File \"/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/command/build_ext.py\", line 529, in build_extension\n    objects = self.compiler.compile(sources,\n  File \"/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/ccompiler.py\", line 574, in compile\n    self._compile(obj, src, ext, cc_args, extra_postargs, pp_opts)\n  File \"/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/unixccompiler.py\", line 120, in _compile\n    raise CompileError(msg)\ndistutils.errors.CompileError: command '/usr/bin/gcc' failed with exit code 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/Users/zscherr/sage/develop/src/bin/sage-run-cython\", line 8, in <module>\n    s = load_cython(sys.argv.pop(1))\n  File \"/Users/zscherr/sage/develop/local/lib/python3.9/site-packages/sage/repl/load.py\", line 68, in load_cython\n    mod, dir = cython(name, compile_message=True, use_cache=True)\n  File \"/Users/zscherr/sage/develop/local/lib/python3.9/site-packages/sage/misc/cython.py\", line 392, in cython\n    raise RuntimeError(msg.strip())\nRuntimeError: command '/usr/bin/gcc' failed with exit code 1\n/Users/zscherr/.sage/temp/Zacharys-MacBook-Pro.local/69918/spyx/_Users_zscherr__sage_temp_Zacharys_MacBook_Pro_local_69734_dir_y1gtp384_sage_test_file_spyx/_Users_zscherr__sage_temp_Zacharys_MacBook_Pro_local_69734_dir_y1gtp384_sage_test_file_spyx_0.c:653:10: fatal error: 'gmp.h' file not found\n#include \"gmp.h\"\n```\n\nI'm wondering if the issue is somehow related to distutils not remembering where certain libraries like gmp are located.",
    "created_at": "2021-02-06T01:03:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502366",
    "user": "https://github.com/zlscherr"
}
```

<div id="comment:47" align="right">comment:47</div>

I see some doctests failing on this branch that may be related to the new distutils.  In particular,

```
./sage -t src/sage/tests/cmdline.py
```

fails.  One of the failing tests creates a temporary spyx file, and when it tries to run it with sage, it gives the following error

```
Traceback (most recent call last):
  File "/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/unixccompiler.py", line 117, in _compile
    self.spawn(compiler_so + cc_args + [src, '-o', obj] +
  File "/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/ccompiler.py", line 910, in spawn
    spawn(cmd, dry_run=self.dry_run)
  File "/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/spawn.py", line 87, in spawn
    raise DistutilsExecError(
distutils.errors.DistutilsExecError: command '/usr/bin/gcc' failed with exit code 1

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/zscherr/sage/develop/local/lib/python3.9/site-packages/sage/misc/cython.py", line 386, in cython
    dist.run_command("build")
  File "/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/dist.py", line 985, in run_command
    cmd_obj.run()
  File "/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/command/build.py", line 135, in run
    self.run_command(cmd_name)
  File "/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/cmd.py", line 313, in run_command
    self.distribution.run_command(command)
  File "/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/dist.py", line 985, in run_command
    cmd_obj.run()
  File "/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/command/build_ext.py", line 340, in run
    self.build_extensions()
  File "/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/command/build_ext.py", line 449, in build_extensions
    self._build_extensions_serial()
  File "/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/command/build_ext.py", line 474, in _build_extensions_serial
    self.build_extension(ext)
  File "/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/command/build_ext.py", line 529, in build_extension
    objects = self.compiler.compile(sources,
  File "/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/ccompiler.py", line 574, in compile
    self._compile(obj, src, ext, cc_args, extra_postargs, pp_opts)
  File "/usr/local/Cellar/python@3.9/3.9.1_8/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/unixccompiler.py", line 120, in _compile
    raise CompileError(msg)
distutils.errors.CompileError: command '/usr/bin/gcc' failed with exit code 1

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/zscherr/sage/develop/src/bin/sage-run-cython", line 8, in <module>
    s = load_cython(sys.argv.pop(1))
  File "/Users/zscherr/sage/develop/local/lib/python3.9/site-packages/sage/repl/load.py", line 68, in load_cython
    mod, dir = cython(name, compile_message=True, use_cache=True)
  File "/Users/zscherr/sage/develop/local/lib/python3.9/site-packages/sage/misc/cython.py", line 392, in cython
    raise RuntimeError(msg.strip())
RuntimeError: command '/usr/bin/gcc' failed with exit code 1
/Users/zscherr/.sage/temp/Zacharys-MacBook-Pro.local/69918/spyx/_Users_zscherr__sage_temp_Zacharys_MacBook_Pro_local_69734_dir_y1gtp384_sage_test_file_spyx/_Users_zscherr__sage_temp_Zacharys_MacBook_Pro_local_69734_dir_y1gtp384_sage_test_file_spyx_0.c:653:10: fatal error: 'gmp.h' file not found
#include "gmp.h"
```

I'm wondering if the issue is somehow related to distutils not remembering where certain libraries like gmp are located.



---

archive/issue_comments_502367.json:
```json
{
    "body": "<div id=\"comment:48\" align=\"right\">comment:48</div>\n\ngmp used to be found simply because `/usr/local/` is listed in homebrew's `distutils.cfg`. Now we need to update `sage.misc.cython._standard_libs_libdirs` so that gmp library dir information is used, for example from pkgconfig.",
    "created_at": "2021-02-06T02:07:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502367",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:48" align="right">comment:48</div>

gmp used to be found simply because `/usr/local/` is listed in homebrew's `distutils.cfg`. Now we need to update `sage.misc.cython._standard_libs_libdirs` so that gmp library dir information is used, for example from pkgconfig.



---

archive/issue_comments_502368.json:
```json
{
    "body": "<div id=\"comment:49\" align=\"right\">comment:49</div>\n\nLet's address this in #31348.",
    "created_at": "2021-02-06T02:40:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502368",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:49" align="right">comment:49</div>

Let's address this in #31348.



---

archive/issue_comments_502369.json:
```json
{
    "body": "<div id=\"comment:50\" align=\"right\">comment:50</div>\n\nWhen you ran this test, were the environment variables set by `.homebrew-build-env` set?",
    "created_at": "2021-02-06T02:43:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502369",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:50" align="right">comment:50</div>

When you ran this test, were the environment variables set by `.homebrew-build-env` set?



---

archive/issue_comments_502370.json:
```json
{
    "body": "<div id=\"comment:51\" align=\"right\">comment:51</div>\n\nReplying to [@mkoeppe](#comment%3A50):\n> When you ran this test, were the environment variables set by `.homebrew-build-env` set?\n\nat testing time they were not set.",
    "created_at": "2021-02-06T02:48:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502370",
    "user": "https://github.com/zlscherr"
}
```

<div id="comment:51" align="right">comment:51</div>

Replying to [@mkoeppe](#comment%3A50):
> When you ran this test, were the environment variables set by `.homebrew-build-env` set?

at testing time they were not set.



---

archive/issue_comments_502371.json:
```json
{
    "body": "<div id=\"comment:52\" align=\"right\">comment:52</div>\n\nI managed to get through all of ptest, and there are a lot of issues with not being able to find -lmpfr as well.  I imagine it's the same type of issue.",
    "created_at": "2021-02-06T04:36:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502371",
    "user": "https://github.com/zlscherr"
}
```

<div id="comment:52" align="right">comment:52</div>

I managed to get through all of ptest, and there are a lot of issues with not being able to find -lmpfr as well.  I imagine it's the same type of issue.



---

archive/issue_comments_502372.json:
```json
{
    "body": "<div id=\"comment:53\" align=\"right\">comment:53</div>\n\nYes, the situation for mpfr is exactly the same. We can probably take care of it in #31348 as well.",
    "created_at": "2021-02-06T05:02:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502372",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:53" align="right">comment:53</div>

Yes, the situation for mpfr is exactly the same. We can probably take care of it in #31348 as well.



---

archive/issue_comments_502373.json:
```json
{
    "body": "<div id=\"comment:54\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f7d698d8aa29a8f736bf2c49c20a1c46d0329a60\"><code>f7d698d</code></a></td><td><code>sage_setup.docbuild.AllBuilder: stop the non-reference manual docs from being built in parallel</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9f38a3bdffd2af59193c3b974f6813e798c9bc33\"><code>9f38a3b</code></a></td><td><code>sage_setup.dpcbuild.AllBuilder: Restrict workaround to macOS</code></td></tr></table>\n",
    "created_at": "2021-02-07T18:59:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502373",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:54"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f7d698d8aa29a8f736bf2c49c20a1c46d0329a60"><code>f7d698d</code></a></td><td><code>sage_setup.docbuild.AllBuilder: stop the non-reference manual docs from being built in parallel</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9f38a3bdffd2af59193c3b974f6813e798c9bc33"><code>9f38a3b</code></a></td><td><code>sage_setup.dpcbuild.AllBuilder: Restrict workaround to macOS</code></td></tr></table>




---

archive/issue_comments_502374.json:
```json
{
    "body": "Changed commit from **[`9ad84cc`](https://github.com/sagemath/sagetrac-mirror/commit/9ad84cc0105665ac9c1988a3e8fa0914fd1eac73)** to **[`9f38a3b`](https://github.com/sagemath/sagetrac-mirror/commit/9f38a3bdffd2af59193c3b974f6813e798c9bc33)**",
    "created_at": "2021-02-07T18:59:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502374",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`9ad84cc`](https://github.com/sagemath/sagetrac-mirror/commit/9ad84cc0105665ac9c1988a3e8fa0914fd1eac73)** to **[`9f38a3b`](https://github.com/sagemath/sagetrac-mirror/commit/9f38a3bdffd2af59193c3b974f6813e798c9bc33)**



---

archive/issue_comments_502375.json:
```json
{
    "body": "<div id=\"comment:55\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a1b3abcca0aa9ab1a0cf8db5aae6c2a1ca0f7a68\"><code>a1b3abc</code></a></td><td><code>sage_setup.docbuild: In the workaround, do not go through build_many to build serially</code></td></tr></table>\n",
    "created_at": "2021-02-07T19:10:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502375",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:55"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a1b3abcca0aa9ab1a0cf8db5aae6c2a1ca0f7a68"><code>a1b3abc</code></a></td><td><code>sage_setup.docbuild: In the workaround, do not go through build_many to build serially</code></td></tr></table>




---

archive/issue_comments_502376.json:
```json
{
    "body": "Changed commit from **[`9f38a3b`](https://github.com/sagemath/sagetrac-mirror/commit/9f38a3bdffd2af59193c3b974f6813e798c9bc33)** to **[`a1b3abc`](https://github.com/sagemath/sagetrac-mirror/commit/a1b3abcca0aa9ab1a0cf8db5aae6c2a1ca0f7a68)**",
    "created_at": "2021-02-07T19:10:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502376",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`9f38a3b`](https://github.com/sagemath/sagetrac-mirror/commit/9f38a3bdffd2af59193c3b974f6813e798c9bc33)** to **[`a1b3abc`](https://github.com/sagemath/sagetrac-mirror/commit/a1b3abcca0aa9ab1a0cf8db5aae6c2a1ca0f7a68)**



---

archive/issue_comments_502377.json:
```json
{
    "body": "<div id=\"comment:56\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/515f89934e3b6d5daaa9a54684a4fb374289b978\"><code>515f899</code></a></td><td><code>sage_setup.docbuild.AllBuilder: stop the non-reference manual docs from being built in parallel</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/804ebd7689fe8423e901e8ecf38dd62a7a9b8789\"><code>804ebd7</code></a></td><td><code>sage_setup.dpcbuild.AllBuilder: Restrict workaround to macOS</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b4ceee5dae4caa7dac7a6fe7ca29538aca2d381a\"><code>b4ceee5</code></a></td><td><code>sage_setup.docbuild: In the workaround, do not go through build_many to build serially</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ae4ea5530cab4742272b7bb5460cacd210b63544\"><code>ae4ea55</code></a></td><td><code>Merge branch 't/31344/homebrew__docbuild_crashes__libtcl_atforkprepare' into t/31335/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build</code></td></tr></table>\n",
    "created_at": "2021-02-07T19:27:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502377",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:56"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/515f89934e3b6d5daaa9a54684a4fb374289b978"><code>515f899</code></a></td><td><code>sage_setup.docbuild.AllBuilder: stop the non-reference manual docs from being built in parallel</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/804ebd7689fe8423e901e8ecf38dd62a7a9b8789"><code>804ebd7</code></a></td><td><code>sage_setup.dpcbuild.AllBuilder: Restrict workaround to macOS</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b4ceee5dae4caa7dac7a6fe7ca29538aca2d381a"><code>b4ceee5</code></a></td><td><code>sage_setup.docbuild: In the workaround, do not go through build_many to build serially</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ae4ea5530cab4742272b7bb5460cacd210b63544"><code>ae4ea55</code></a></td><td><code>Merge branch 't/31344/homebrew__docbuild_crashes__libtcl_atforkprepare' into t/31335/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build</code></td></tr></table>




---

archive/issue_comments_502378.json:
```json
{
    "body": "Changed commit from **[`a1b3abc`](https://github.com/sagemath/sagetrac-mirror/commit/a1b3abcca0aa9ab1a0cf8db5aae6c2a1ca0f7a68)** to **[`ae4ea55`](https://github.com/sagemath/sagetrac-mirror/commit/ae4ea5530cab4742272b7bb5460cacd210b63544)**",
    "created_at": "2021-02-07T19:27:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502378",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`a1b3abc`](https://github.com/sagemath/sagetrac-mirror/commit/a1b3abcca0aa9ab1a0cf8db5aae6c2a1ca0f7a68)** to **[`ae4ea55`](https://github.com/sagemath/sagetrac-mirror/commit/ae4ea5530cab4742272b7bb5460cacd210b63544)**



---

archive/issue_comments_502379.json:
```json
{
    "body": "Changed commit from **[`ae4ea55`](https://github.com/sagemath/sagetrac-mirror/commit/ae4ea5530cab4742272b7bb5460cacd210b63544)** to **[`add7db4`](https://github.com/sagemath/sagetrac-mirror/commit/add7db48b2138f80fda1e8f5d4e50dbff1bc2e4c)**",
    "created_at": "2021-02-07T20:47:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502379",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`ae4ea55`](https://github.com/sagemath/sagetrac-mirror/commit/ae4ea5530cab4742272b7bb5460cacd210b63544)** to **[`add7db4`](https://github.com/sagemath/sagetrac-mirror/commit/add7db48b2138f80fda1e8f5d4e50dbff1bc2e4c)**



---

archive/issue_comments_502380.json:
```json
{
    "body": "<div id=\"comment:57\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/add7db48b2138f80fda1e8f5d4e50dbff1bc2e4c\"><code>add7db4</code></a></td><td><code>Merge tag '9.3.beta7' into t/31335/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build</code></td></tr></table>\n",
    "created_at": "2021-02-07T20:47:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502380",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:57"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/add7db48b2138f80fda1e8f5d4e50dbff1bc2e4c"><code>add7db4</code></a></td><td><code>Merge tag '9.3.beta7' into t/31335/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build</code></td></tr></table>




---

archive/issue_comments_502381.json:
```json
{
    "body": "<div id=\"comment:58\" align=\"right\">comment:58</div>\n\nReplying to [@zlscherr](#comment%3A51):\n> Replying to [@mkoeppe](#comment%3A50):\n> > When you ran this test, were the environment variables set by `.homebrew-build-env` set?\n\n> \n> at testing time they were not set.\n\nShall we consider this issue -- `.homebrew-build-env` necessary to be set during testing -- one that can be addressed in follow-up tickets? (#31348, #31365)",
    "created_at": "2021-02-09T03:42:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502381",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:58" align="right">comment:58</div>

Replying to [@zlscherr](#comment%3A51):
> Replying to [@mkoeppe](#comment%3A50):
> > When you ran this test, were the environment variables set by `.homebrew-build-env` set?

> 
> at testing time they were not set.

Shall we consider this issue -- `.homebrew-build-env` necessary to be set during testing -- one that can be addressed in follow-up tickets? (#31348, #31365)



---

archive/issue_comments_502382.json:
```json
{
    "body": "<div id=\"comment:59\" align=\"right\">comment:59</div>\n\nThat sounds fair.  With .homebrew-build-env sourced I didn't have any out of the ordinary issues with make ptest, so it seems that things are working well modulo the runtime stuff.",
    "created_at": "2021-02-09T03:44:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502382",
    "user": "https://github.com/zlscherr"
}
```

<div id="comment:59" align="right">comment:59</div>

That sounds fair.  With .homebrew-build-env sourced I didn't have any out of the ordinary issues with make ptest, so it seems that things are working well modulo the runtime stuff.



---

archive/issue_comments_502383.json:
```json
{
    "body": "<div id=\"comment:60\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4e777e7c9ebe47d1b9f72d625deee6c01f77c14a\"><code>4e777e7</code></a></td><td><code>Merge tag '9.3.beta8' into t/31335/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build</code></td></tr></table>\n",
    "created_at": "2021-03-09T00:50:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502383",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:60"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4e777e7c9ebe47d1b9f72d625deee6c01f77c14a"><code>4e777e7</code></a></td><td><code>Merge tag '9.3.beta8' into t/31335/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build</code></td></tr></table>




---

archive/issue_comments_502384.json:
```json
{
    "body": "Changed commit from **[`add7db4`](https://github.com/sagemath/sagetrac-mirror/commit/add7db48b2138f80fda1e8f5d4e50dbff1bc2e4c)** to **[`4e777e7`](https://github.com/sagemath/sagetrac-mirror/commit/4e777e7c9ebe47d1b9f72d625deee6c01f77c14a)**",
    "created_at": "2021-03-09T00:50:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502384",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`add7db4`](https://github.com/sagemath/sagetrac-mirror/commit/add7db48b2138f80fda1e8f5d4e50dbff1bc2e4c)** to **[`4e777e7`](https://github.com/sagemath/sagetrac-mirror/commit/4e777e7c9ebe47d1b9f72d625deee6c01f77c14a)**



---

archive/issue_comments_502385.json:
```json
{
    "body": "Changed dependencies from **#30589, #31132, #31227, #30770, #30912, #31134, #31344** to none",
    "created_at": "2021-03-09T00:53:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502385",
    "user": "https://github.com/mkoeppe"
}
```

Changed dependencies from **#30589, #31132, #31227, #30770, #30912, #31134, #31344** to none



---

archive/issue_comments_502386.json:
```json
{
    "body": "<div id=\"comment:61\" align=\"right\">comment:61</div>\n\nAll dependencies have been merged. Let's get this in?",
    "created_at": "2021-03-09T00:53:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502386",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:61" align="right">comment:61</div>

All dependencies have been merged. Let's get this in?



---

archive/issue_comments_502387.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -10,6 +10,8 @@\n However, here the problem is caused by homebrew installing a `distutils.cfg` that injects `/usr/local/include` into our include search path.\n We fix the leak by switching to a modern configuration of setuptools.\n \n+This also affects `cysignals`, as reported in https://groups.google.com/g/sage-release/c/KdSKg6RdZok/m/91Ibwn8RAgAJ\n+\n \n Relevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~); possible follow-up: #31338\n \n``````\n",
    "created_at": "2021-03-14T18:35:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502387",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -10,6 +10,8 @@
 However, here the problem is caused by homebrew installing a `distutils.cfg` that injects `/usr/local/include` into our include search path.
 We fix the leak by switching to a modern configuration of setuptools.
 
+This also affects `cysignals`, as reported in https://groups.google.com/g/sage-release/c/KdSKg6RdZok/m/91Ibwn8RAgAJ
+
 
 Relevant tickets: #13348, #14709, #29562 (+), #29607 (+), #29697 (?), #31041 (~), #30818 (~), #30013 (~); possible follow-up: #31338
 
``````




---

archive/issue_events_428784.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-14T18:35:34Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "title_is": "homebrew: Unused packages (singular, pari, ...) in /usr/local leak into sagelib/cysignals builds via distutils.cfg",
    "title_was": "homebrew: Unused packages (singular, pari, ...) in /usr/local leak into sagelib build via distutils.cfg",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31335#event-428784"
}
```



---

archive/issue_comments_502388.json:
```json
{
    "body": "<div id=\"comment:62\" align=\"right\">comment:62</div>\n\nThis is arguably another homebrew distribution bug.",
    "created_at": "2021-03-14T18:35:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502388",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:62" align="right">comment:62</div>

This is arguably another homebrew distribution bug.



---

archive/issue_comments_502389.json:
```json
{
    "body": "Changed commit from **[`4e777e7`](https://github.com/sagemath/sagetrac-mirror/commit/4e777e7c9ebe47d1b9f72d625deee6c01f77c14a)** to **[`bf433e8`](https://github.com/sagemath/sagetrac-mirror/commit/bf433e8265a0f2d6ad36491f26908e8f1be48446)**",
    "created_at": "2021-03-14T19:41:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502389",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`4e777e7`](https://github.com/sagemath/sagetrac-mirror/commit/4e777e7c9ebe47d1b9f72d625deee6c01f77c14a)** to **[`bf433e8`](https://github.com/sagemath/sagetrac-mirror/commit/bf433e8265a0f2d6ad36491f26908e8f1be48446)**



---

archive/issue_comments_502390.json:
```json
{
    "body": "<div id=\"comment:63\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bf433e8265a0f2d6ad36491f26908e8f1be48446\"><code>bf433e8</code></a></td><td><code>build/bin/sage-build-env-config.in: Set SETUPTOOLS_USE_DISTUTILS here, not in build/pkgs/sagelib/spkg-install</code></td></tr></table>\n",
    "created_at": "2021-03-14T19:41:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502390",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:63"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bf433e8265a0f2d6ad36491f26908e8f1be48446"><code>bf433e8</code></a></td><td><code>build/bin/sage-build-env-config.in: Set SETUPTOOLS_USE_DISTUTILS here, not in build/pkgs/sagelib/spkg-install</code></td></tr></table>




---

archive/issue_comments_502391.json:
```json
{
    "body": "<div id=\"comment:64\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e03c5ac0a9d2d82dd864d6d6d9560eddabbcbba5\"><code>e03c5ac</code></a></td><td><code>build/bin/sage-build-env: Set SETUPTOOLS_USE_DISTUTILS here, not in build/pkgs/sagelib/spkg-install</code></td></tr></table>\n",
    "created_at": "2021-03-14T19:42:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502391",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:64"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e03c5ac0a9d2d82dd864d6d6d9560eddabbcbba5"><code>e03c5ac</code></a></td><td><code>build/bin/sage-build-env: Set SETUPTOOLS_USE_DISTUTILS here, not in build/pkgs/sagelib/spkg-install</code></td></tr></table>




---

archive/issue_comments_502392.json:
```json
{
    "body": "Changed commit from **[`bf433e8`](https://github.com/sagemath/sagetrac-mirror/commit/bf433e8265a0f2d6ad36491f26908e8f1be48446)** to **[`e03c5ac`](https://github.com/sagemath/sagetrac-mirror/commit/e03c5ac0a9d2d82dd864d6d6d9560eddabbcbba5)**",
    "created_at": "2021-03-14T19:42:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502392",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`bf433e8`](https://github.com/sagemath/sagetrac-mirror/commit/bf433e8265a0f2d6ad36491f26908e8f1be48446)** to **[`e03c5ac`](https://github.com/sagemath/sagetrac-mirror/commit/e03c5ac0a9d2d82dd864d6d6d9560eddabbcbba5)**



---

archive/issue_comments_502393.json:
```json
{
    "body": "<div id=\"comment:65\" align=\"right\">comment:65</div>\n\nPrompted by slelievre's report on sage-devel, applying this fix to all packages by putting the setting in `build/bin/sage-build-env`.\nNeeds review",
    "created_at": "2021-03-14T19:44:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502393",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:65" align="right">comment:65</div>

Prompted by slelievre's report on sage-devel, applying this fix to all packages by putting the setting in `build/bin/sage-build-env`.
Needs review



---

archive/issue_comments_502394.json:
```json
{
    "body": "<div id=\"comment:66\" align=\"right\">comment:66</div>\n\nConfirmed by @slel to fix the `cysignals` build in https://groups.google.com/g/sage-release/c/KdSKg6RdZok/m/O1VHLlUKAwAJ",
    "created_at": "2021-03-16T01:47:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502394",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:66" align="right">comment:66</div>

Confirmed by @slel to fix the `cysignals` build in https://groups.google.com/g/sage-release/c/KdSKg6RdZok/m/O1VHLlUKAwAJ



---

archive/issue_comments_502395.json:
```json
{
    "body": "Reviewer: **John Palmieri**",
    "created_at": "2021-03-16T17:29:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502395",
    "user": "https://github.com/jhpalmieri"
}
```

Reviewer: **John Palmieri**



---

archive/issue_comments_502396.json:
```json
{
    "body": "<div id=\"comment:67\" align=\"right\">comment:67</div>\n\nI can confirm, too: if I install `pari` and `singular` via homebrew, then `cysignals` doesn't build without this fix.",
    "created_at": "2021-03-16T17:29:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502396",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:67" align="right">comment:67</div>

I can confirm, too: if I install `pari` and `singular` via homebrew, then `cysignals` doesn't build without this fix.



---

archive/issue_events_428785.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2021-03-16T17:29:58Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31335#event-428785"
}
```



---

archive/issue_events_428786.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2021-03-16T17:29:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31335#event-428786"
}
```



---

archive/issue_comments_502397.json:
```json
{
    "body": "<div id=\"comment:68\" align=\"right\">comment:68</div>\n\nThanks!",
    "created_at": "2021-03-16T18:28:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502397",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:68" align="right">comment:68</div>

Thanks!



---

archive/issue_comments_502398.json:
```json
{
    "body": "Changed branch from **[u/mkoeppe/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build)** to **[`e03c5ac`](https://github.com/sagemath/sagetrac-mirror/commit/e03c5ac0a9d2d82dd864d6d6d9560eddabbcbba5)**",
    "created_at": "2021-03-18T22:32:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502398",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/mkoeppe/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_sagelib_build)** to **[`e03c5ac`](https://github.com/sagemath/sagetrac-mirror/commit/e03c5ac0a9d2d82dd864d6d6d9560eddabbcbba5)**



---

archive/issue_events_428787.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-03-18T22:32:29Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31335#event-428787"
}
```



---

archive/issue_events_428788.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "114dd261665ce280c2d49c22bb3a53281cce2388",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2021-03-18T22:32:29Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31335#event-428788"
}
```



---

archive/issue_comments_502399.json:
```json
{
    "body": "Changed commit from **[`e03c5ac`](https://github.com/sagemath/sagetrac-mirror/commit/e03c5ac0a9d2d82dd864d6d6d9560eddabbcbba5)** to none",
    "created_at": "2022-02-08T06:48:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502399",
    "user": "https://github.com/mkoeppe"
}
```

Changed commit from **[`e03c5ac`](https://github.com/sagemath/sagetrac-mirror/commit/e03c5ac0a9d2d82dd864d6d6d9560eddabbcbba5)** to none



---

archive/issue_comments_502400.json:
```json
{
    "body": "<div id=\"comment:70\" align=\"right\">comment:70</div>\n\nThe problem with distutils.cfg has now been addressed by homebrew for their Python 3.10 package, see [#31348 comment:38](https://github.com/sagemath/sage/issues/31348#comment:38)",
    "created_at": "2022-02-08T06:48:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31335#issuecomment-502400",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:70" align="right">comment:70</div>

The problem with distutils.cfg has now been addressed by homebrew for their Python 3.10 package, see [#31348 comment:38](https://github.com/sagemath/sage/issues/31348#comment:38)
