# Issue 31543: Meta-ticket: Eliminate use of patches for Python packages

archive/issues_031306.json:
```json
{
    "body": "Installing \"sdist + patches\" is not supported by Python package infrastructure.\n\nWe review existing patches, and for those packages that still need them, we create a repository fork and create and deposit an sdist tarball from here.\n\nTickets:\n\n- #31967/#31280 `rst2ipynb`: Update to 0.2.3 to remove patching\n- #32691 `setuptools`: Upgrade to 58.2.0, remove old `easy_install` patch\n- #32832 `cython`: Eliminate use of custom patches\n- #32828 `pyzmq`\n\nPackages with patches can be found as follows:\n\n```\n$ ./sage -package list --has-file install-requires.txt --has-file patches | sort\ncvxopt\ncypari\ncython\ndot2tex\nipywidgets\nnotedown\nnumpy\npillow\npsutil\nrpy2\nsetuptools\nsphinx\nwidgetsnbextension\n```\n\nAlso, some Python packages need specific settings of environment variables at build time. Example: #21170 (pypolymake); a new package script such as `spkg-env` could set these (#29045)\n\nFinally, some packages may install custom configurations, such as the `notebook` package's `jupyter_notebook_config.py` that currently gets installed into ` \"$SAGE_INST_LOCAL\"/etc/jupyter`.\n\n\nCC:  @dimpase @orlitzky @tobiasdiez\n\nStatus: new\n\nIssue created by migration from https://trac.sagemath.org/ticket/31543\n\n",
    "created_at": "2021-03-23T05:48:27Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Meta-ticket: Eliminate use of patches for Python packages",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31543",
    "user": "https://github.com/mkoeppe"
}
```
Installing "sdist + patches" is not supported by Python package infrastructure.

We review existing patches, and for those packages that still need them, we create a repository fork and create and deposit an sdist tarball from here.

Tickets:

- #31967/#31280 `rst2ipynb`: Update to 0.2.3 to remove patching
- #32691 `setuptools`: Upgrade to 58.2.0, remove old `easy_install` patch
- #32832 `cython`: Eliminate use of custom patches
- #32828 `pyzmq`

Packages with patches can be found as follows:

```
$ ./sage -package list --has-file install-requires.txt --has-file patches | sort
cvxopt
cypari
cython
dot2tex
ipywidgets
notedown
numpy
pillow
psutil
rpy2
setuptools
sphinx
widgetsnbextension
```

Also, some Python packages need specific settings of environment variables at build time. Example: #21170 (pypolymake); a new package script such as `spkg-env` could set these (#29045)

Finally, some packages may install custom configurations, such as the `notebook` package's `jupyter_notebook_config.py` that currently gets installed into ` "$SAGE_INST_LOCAL"/etc/jupyter`.


CC:  @dimpase @orlitzky @tobiasdiez

Status: new

Issue created by migration from https://trac.sagemath.org/ticket/31543





---

archive/issue_comments_447047.json:
```json
{
    "body": "<a id='comment:2'></a>rst2ipynb could be updated to 0.2.3, that contains our patch",
    "created_at": "2021-06-12T09:41:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31543#issuecomment-447047",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:2'></a>rst2ipynb could be updated to 0.2.3, that contains our patch



---

archive/issue_events_082887.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T01:16:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31543",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31543#event-82887"
}
```



---

archive/issue_comments_447048.json:
```json
{
    "body": "<a id='comment:10'></a>The pillow patch might not be needed any longer, but someone with macOS will have to check.",
    "created_at": "2021-10-15T05:36:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31543#issuecomment-447048",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:10'></a>The pillow patch might not be needed any longer, but someone with macOS will have to check.



---

archive/issue_comments_447049.json:
```json
{
    "body": "<a id='comment:11'></a>In #30371, no patches to python packages are applied (as the packages used there come directly from pypi completely bypassing sages package infrastructure).\nThe only real test failures on ubuntu are:\n\n```\n\nFile \"sage/matrix/matrix_integer_dense.pyx\", line 3706, in sage.matrix.matrix_integer_dense.Matrix_integer_dense.determinant\nFailed example:\n    A.determinant(algorithm='linbox',proof=False) == d\nExpected:\n    True\nGot:\n    False\n**********************************************************************\nFile \"sage/cpython/dict_del_by_value.pyx\", line 268, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value\nFailed example:\n    test_del_dictitem_by_exact_value(D, ZZ, 2)\nException raised:\n    Traceback (most recent call last):\n      File \"/__w/sagetrac-mirror/sagetrac-mirror/src/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/__w/sagetrac-mirror/sagetrac-mirror/src/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value[6]>\", line 1, in <module>\n        test_del_dictitem_by_exact_value(D, ZZ, Integer(2))\n      File \"sage/cpython/dict_del_by_value.pyx\", line 275, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value\n        del_dictitem_by_exact_value(<PyDictObject *>D, <PyObject *>value, h)\n    TypeError: an integer is required\n**********************************************************************\nFile \"sage/cpython/dict_del_by_value.pyx\", line 271, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value\nFailed example:\n    test_del_dictitem_by_exact_value(D, QQ, 1)\nException raised:\n    Traceback (most recent call last):\n      File \"/__w/sagetrac-mirror/sagetrac-mirror/src/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/__w/sagetrac-mirror/sagetrac-mirror/src/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value[8]>\", line 1, in <module>\n        test_del_dictitem_by_exact_value(D, QQ, Integer(1))\n      File \"sage/cpython/dict_del_by_value.pyx\", line 275, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value\n        del_dictitem_by_exact_value(<PyDictObject *>D, <PyObject *>value, h)\n    TypeError: an integer is required\n```\nThat's good evidence that most patches might no longer be needed (at least on ubuntu and possibly updating the python packages).",
    "created_at": "2021-10-15T10:43:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31543#issuecomment-447049",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:11'></a>In #30371, no patches to python packages are applied (as the packages used there come directly from pypi completely bypassing sages package infrastructure).
The only real test failures on ubuntu are:

```

File "sage/matrix/matrix_integer_dense.pyx", line 3706, in sage.matrix.matrix_integer_dense.Matrix_integer_dense.determinant
Failed example:
    A.determinant(algorithm='linbox',proof=False) == d
Expected:
    True
Got:
    False
**********************************************************************
File "sage/cpython/dict_del_by_value.pyx", line 268, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value
Failed example:
    test_del_dictitem_by_exact_value(D, ZZ, 2)
Exception raised:
    Traceback (most recent call last):
      File "/__w/sagetrac-mirror/sagetrac-mirror/src/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/__w/sagetrac-mirror/sagetrac-mirror/src/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value[6]>", line 1, in <module>
        test_del_dictitem_by_exact_value(D, ZZ, Integer(2))
      File "sage/cpython/dict_del_by_value.pyx", line 275, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value
        del_dictitem_by_exact_value(<PyDictObject *>D, <PyObject *>value, h)
    TypeError: an integer is required
**********************************************************************
File "sage/cpython/dict_del_by_value.pyx", line 271, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value
Failed example:
    test_del_dictitem_by_exact_value(D, QQ, 1)
Exception raised:
    Traceback (most recent call last):
      File "/__w/sagetrac-mirror/sagetrac-mirror/src/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/__w/sagetrac-mirror/sagetrac-mirror/src/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value[8]>", line 1, in <module>
        test_del_dictitem_by_exact_value(D, QQ, Integer(1))
      File "sage/cpython/dict_del_by_value.pyx", line 275, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value
        del_dictitem_by_exact_value(<PyDictObject *>D, <PyObject *>value, h)
    TypeError: an integer is required
```
That's good evidence that most patches might no longer be needed (at least on ubuntu and possibly updating the python packages).



---

archive/issue_events_082888.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-14T02:04:49Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31543",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31543#event-82888"
}
```



---

archive/issue_events_082889.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-14T02:04:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31543",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31543#event-82889"
}
```



---

archive/issue_events_082890.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-02T17:54:54Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31543",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31543#event-82890"
}
```



---

archive/issue_events_082891.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-02T17:54:54Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31543",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31543#event-82891"
}
```



---

archive/issue_events_082892.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31543",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31543#event-82892"
}
```



---

archive/issue_events_082893.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31543",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31543#event-82893"
}
```
