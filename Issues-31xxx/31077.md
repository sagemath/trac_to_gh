# Issue 31077: very incorrect "expand" of a symbolic expression

archive/issues_030840.json:
```json
{
    "body": "As discussed on [sagedevel](https://groups.google.com/g/sage-devel/c/cuYVxld88Ng/m/nNfV4jxBBAAJ), the following determinant is 0, but that's not what sage says:\n\n```\nsage: a,b,c,d,e,z = var(\"a b c d e z\") \n....: L = Matrix([\n....:     [-a, 1, 0, 0, 0, -4*d/z, 0, 0, 0], \n....:     [1, a - b - 1, 1, 0, 4*d/z, 0, 0, 0, 0], \n....:     [0, 1, b - c + 2, b, 0, 0, 0, 0, 0], \n....:     [0, 0, b, c - 3, 0, 0, 0, 0, 2*e], \n....:     [0, d*z, 0, 0, a, -1, 0, 0, 0], \n....:     [-d*z, 0, 0, 0, -1, -a + b + 1, -1, 0, 0], \n....:     [0, 0, 0, 0, 0, -1, -b + c - 2, -b, 0], \n....:     [0, 0, 0, 0, 0, 0, -b, -c + 3, -e], \n....:     [0, 0, 0, e, 0, 0, 0, -2*e, 0]]) \n....: L.det().factor() # should be 0, but it's not\n4*a*b^2*d*e^2*(z + 1)*(z - 1)/z\n```\nTo confirm that the determinant is 0, just multiply the matrix by z, which multiplies the determinant by z<sup>9</sup>:\n\n```\nsage: (z*L).det()\n0\n```\n(Calculating in a `LaurentPolynomialRing` also verifies that the determinant is 0.)\n\nEdit: Further investigation seems to reveal that the determinant is calculated correctly by maxima, but then sage's `expand` method introduces an error.\n\nCC:  @orlitzky fchapoton @burcin @rwst @behackl @kcrisman\n\nKeywords: expand\n\nBranch: [public/31077v2](https://github.com/sagemath/sagetrac-mirror/tree/public/31077v2)\n\nCommit: [d05da0bf665ad4abdc3757aee28245036ee42b4e](https://github.com/sagemath/sagetrac-mirror/commit/d05da0bf665ad4abdc3757aee28245036ee42b4e)\n\nAuthor: Dave Morris\n\nStatus: needs_work\n\nIssue created by migration from https://trac.sagemath.org/ticket/31077\n\n",
    "created_at": "2020-12-18T18:56:16Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "very incorrect \"expand\" of a symbolic expression",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31077",
    "user": "https://github.com/DaveWitteMorris"
}
```
As discussed on [sagedevel](https://groups.google.com/g/sage-devel/c/cuYVxld88Ng/m/nNfV4jxBBAAJ), the following determinant is 0, but that's not what sage says:

```
sage: a,b,c,d,e,z = var("a b c d e z") 
....: L = Matrix([
....:     [-a, 1, 0, 0, 0, -4*d/z, 0, 0, 0], 
....:     [1, a - b - 1, 1, 0, 4*d/z, 0, 0, 0, 0], 
....:     [0, 1, b - c + 2, b, 0, 0, 0, 0, 0], 
....:     [0, 0, b, c - 3, 0, 0, 0, 0, 2*e], 
....:     [0, d*z, 0, 0, a, -1, 0, 0, 0], 
....:     [-d*z, 0, 0, 0, -1, -a + b + 1, -1, 0, 0], 
....:     [0, 0, 0, 0, 0, -1, -b + c - 2, -b, 0], 
....:     [0, 0, 0, 0, 0, 0, -b, -c + 3, -e], 
....:     [0, 0, 0, e, 0, 0, 0, -2*e, 0]]) 
....: L.det().factor() # should be 0, but it's not
4*a*b^2*d*e^2*(z + 1)*(z - 1)/z
```
To confirm that the determinant is 0, just multiply the matrix by z, which multiplies the determinant by z<sup>9</sup>:

```
sage: (z*L).det()
0
```
(Calculating in a `LaurentPolynomialRing` also verifies that the determinant is 0.)

Edit: Further investigation seems to reveal that the determinant is calculated correctly by maxima, but then sage's `expand` method introduces an error.

CC:  @orlitzky fchapoton @burcin @rwst @behackl @kcrisman

Keywords: expand

Branch: [public/31077v2](https://github.com/sagemath/sagetrac-mirror/tree/public/31077v2)

Commit: [d05da0bf665ad4abdc3757aee28245036ee42b4e](https://github.com/sagemath/sagetrac-mirror/commit/d05da0bf665ad4abdc3757aee28245036ee42b4e)

Author: Dave Morris

Status: needs_work

Issue created by migration from https://trac.sagemath.org/ticket/31077





---

archive/issue_comments_617127.json:
```json
{
    "body": "<a id='comment:2'></a>\nThis seems to be a maxima bug (or a bug in the maxima interface):\n\n```\nsage: f(x) = L._maxima_(maxima).charpoly('x')._sage_().expand()\nsage: f(0).factor()                                                                                                                                         \n4*a*b^2*d*e^2*(z + 1)*(z - 1)/z\n```",
    "created_at": "2020-12-18T19:59:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617127",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:2'></a>
This seems to be a maxima bug (or a bug in the maxima interface):

```
sage: f(x) = L._maxima_(maxima).charpoly('x')._sage_().expand()
sage: f(0).factor()                                                                                                                                         
4*a*b^2*d*e^2*(z + 1)*(z - 1)/z
```



---

archive/issue_comments_617128.json:
```json
{
    "body": "<a id='comment:3'></a>\nMore precisely, it seems to be within the expand method:\n\n```\nsage: var = 'A0123456789'\nsage: p = L._maxima_(maxima).charpoly(var)._sage_()\nsage: fricas(p).series(A0123456789=0) -  fricas(p.expand()).series(A0123456789=0)\n         2   2 2        2   2        2   2 2      2   2\n  - 4 a b d e z  + 4 a b d e    - 4 b d e z  + 4 b d e\n  --------------------------- + ----------------------- A0123456789\n               z                           z\n+ \n               11\n  O(A0123456789  )\n\n```",
    "created_at": "2020-12-18T20:15:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617128",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:3'></a>
More precisely, it seems to be within the expand method:

```
sage: var = 'A0123456789'
sage: p = L._maxima_(maxima).charpoly(var)._sage_()
sage: fricas(p).series(A0123456789=0) -  fricas(p.expand()).series(A0123456789=0)
         2   2 2        2   2        2   2 2      2   2
  - 4 a b d e z  + 4 a b d e    - 4 b d e z  + 4 b d e
  --------------------------- + ----------------------- A0123456789
               z                           z
+ 
               11
  O(A0123456789  )

```



---

archive/issue_comments_617129.json:
```json
{
    "body": "<a id='comment:4'></a>\nRight, it seems that the problem is with `expand`, and has nothing to do with determinants.  It shows up if I directly define E to be the expression that is called `f(x)` above.\n\n```\nsage: E1 = \"\"\"-4*(a - x)*b^2*d*e^2*z - (b^2*x + ((b^2*x + (2*e^2 - (c + x - 3)*x)*(b - c + x + 2\n....: ))*(a - b + x - 1) - 2*e^2 + (c + x - 3)*x)*(a - x) + (2*e^2 - (c + x - 3)*x)*(b - c + x +\n....:  2))*b^2 + (4*b^2*d*e^2*z - ((b^2*x + ((b^2*x + (2*e^2 - (c + x - 3)*x)*(b - c + x + 2))*(\n....: a - b + x - 1) - 2*e^2 + (c + x - 3)*x)*(a - x) + (2*e^2 - (c + x - 3)*x)*(b - c + x + 2))\n....: *b^2 - ((b^2*x + ((b^2*x + (2*e^2 - (c + x - 3)*x)*(b - c + x + 2))*(a - b + x - 1) - 2*e^\n....: 2 + (c + x - 3)*x)*(a - x) + (2*e^2 - (c + x - 3)*x)*(b - c + x + 2))*(c - x - 3) + 2*(b^2\n....: *e - (b - c + x + 2)*(c + x - 3)*e + ((b^2*e - (b - c + x + 2)*(c + x - 3)*e)*(a - b + x -\n....:  1) + (c + x - 3)*e)*(a - x))*e)*(b - c - x + 2))*(a - b - x - 1) - (b^2*x + ((b^2*x + (2*\n....: e^2 - (c + x - 3)*x)*(b - c + x + 2))*(a - b + x - 1) - 2*e^2 + (c + x - 3)*x)*(a - x) + (\n....: 2*e^2 - (c + x - 3)*x)*(b - c + x + 2))*(c - x - 3) - 2*(b^2*e - (b - c + x + 2)*(c + x - \n....: 3)*e + ((b^2*e - (b - c + x + 2)*(c + x - 3)*e)*(a - b + x - 1) + (c + x - 3)*e)*(a - x))*\n....: e + 4*(((b^2*x + (2*e^2 - (c + x - 3)*x)*(b - c + x + 2))*(a - b + x - 1) - 2*e^2 + (c + x\n....:  - 3)*x)*b^2*d*z + b^2*e^2 - (((b^2*x + (2*e^2 - (c + x - 3)*x)*(b - c + x + 2))*(a - b + \n....: x - 1) - 2*e^2 + (c + x - 3)*x)*(c - x - 3)*d*z + 2*((b^2*e - (b - c + x + 2)*(c + x - 3)*\n....: e)*(a - b + x - 1) + (c + x - 3)*e)*d*e*z)*(b - c - x + 2))*d/z)*(a + x) + ((b^2*x + ((b^2\n....: *x + (2*e^2 - (c + x - 3)*x)*(b - c + x + 2))*(a - b + x - 1) - 2*e^2 + (c + x - 3)*x)*(a \n....: - x) + (2*e^2 - (c + x - 3)*x)*(b - c + x + 2))*(c - x - 3) + 2*(b^2*e - (b - c + x + 2)*(\n....: c + x - \"\"\"                                                                               \nsage: E2 = \"\"\"3)*e + ((b^2*e - (b - c + x + 2)*(c + x - 3)*e)*(a - b + x - 1) + (c + x - 3)*e)*(\n....: a - x))*e)*(b - c - x + 2) - 4*((a - x)*b^2*e^2 - (b^2*x + (2*e^2 - (c + x - 3)*x)*(b - c \n....: + x + 2))*b^2*d*z - (b^2*x + (2*e^2 - (c + x - 3)*x)*(b - c + x + 2))*(a - x)*(c - x - 3)*\n....: d*z - 2*(b^2*e - (b - c + x + 2)*(c + x - 3)*e)*(a - x)*d*e*z - ((b^2*x + (2*e^2 - (c + x \n....: - 3)*x)*(b - c + x + 2))*(a - x)*b^2*d*z - ((b^2*x + (2*e^2 - (c + x - 3)*x)*(b - c + x + \n....: 2))*(a - x)*(c - x - 3)*d*z + 2*(b^2*e - (b - c + x + 2)*(c + x - 3)*e)*(a - x)*d*e*z)*(b \n....: - c - x + 2))*(a - b - x - 1) + ((b^2*x + (2*e^2 - (c + x - 3)*x)*(b - c + x + 2))*(c - x \n....: - 3)*d*z + 2*(b^2*e - (b - c + x + 2)*(c + x - 3)*e)*d*e*z)*(b - c - x + 2) + 4*((b^2*x + \n....: (2*e^2 - (c + x - 3)*x)*(b - c + x + 2))*b^2*d^2*z^2 - ((b^2*x + (2*e^2 - (c + x - 3)*x)*(\n....: b - c + x + 2))*(c - x - 3)*d^2*z^2 + 2*(b^2*e - (b - c + x + 2)*(c + x - 3)*e)*d^2*e*z^2)\n....: *(b - c - x + 2))*d/z)*d/z + 4*((b^2*x + (2*e^2 - (c + x - 3)*x)*(b - c + x + 2))*b^2*d*z \n....: - ((b^2*x + (2*e^2 - (c + x - 3)*x)*(b - c + x + 2))*(c - x - 3)*d*z + 2*(b^2*e - (b - c +\n....:  x + 2)*(c + x - 3)*e)*d*e*z)*(b - c - x + 2))*d/z\"\"\"                                     \nsage: E = SR(E1 + E2)                                                                           \nsage: E.expand().subs(x=0)                                                                      \n4*a*b^2*d*z*e^2 - 4*a*b^2*d*e^2/z\nsage: E.subs(x=0).expand()                                                                      \n0\n```\nIf that is really true, then we should change the title of this ticket.",
    "created_at": "2020-12-18T22:56:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617129",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:4'></a>
Right, it seems that the problem is with `expand`, and has nothing to do with determinants.  It shows up if I directly define E to be the expression that is called `f(x)` above.

```
sage: E1 = """-4*(a - x)*b^2*d*e^2*z - (b^2*x + ((b^2*x + (2*e^2 - (c + x - 3)*x)*(b - c + x + 2
....: ))*(a - b + x - 1) - 2*e^2 + (c + x - 3)*x)*(a - x) + (2*e^2 - (c + x - 3)*x)*(b - c + x +
....:  2))*b^2 + (4*b^2*d*e^2*z - ((b^2*x + ((b^2*x + (2*e^2 - (c + x - 3)*x)*(b - c + x + 2))*(
....: a - b + x - 1) - 2*e^2 + (c + x - 3)*x)*(a - x) + (2*e^2 - (c + x - 3)*x)*(b - c + x + 2))
....: *b^2 - ((b^2*x + ((b^2*x + (2*e^2 - (c + x - 3)*x)*(b - c + x + 2))*(a - b + x - 1) - 2*e^
....: 2 + (c + x - 3)*x)*(a - x) + (2*e^2 - (c + x - 3)*x)*(b - c + x + 2))*(c - x - 3) + 2*(b^2
....: *e - (b - c + x + 2)*(c + x - 3)*e + ((b^2*e - (b - c + x + 2)*(c + x - 3)*e)*(a - b + x -
....:  1) + (c + x - 3)*e)*(a - x))*e)*(b - c - x + 2))*(a - b - x - 1) - (b^2*x + ((b^2*x + (2*
....: e^2 - (c + x - 3)*x)*(b - c + x + 2))*(a - b + x - 1) - 2*e^2 + (c + x - 3)*x)*(a - x) + (
....: 2*e^2 - (c + x - 3)*x)*(b - c + x + 2))*(c - x - 3) - 2*(b^2*e - (b - c + x + 2)*(c + x - 
....: 3)*e + ((b^2*e - (b - c + x + 2)*(c + x - 3)*e)*(a - b + x - 1) + (c + x - 3)*e)*(a - x))*
....: e + 4*(((b^2*x + (2*e^2 - (c + x - 3)*x)*(b - c + x + 2))*(a - b + x - 1) - 2*e^2 + (c + x
....:  - 3)*x)*b^2*d*z + b^2*e^2 - (((b^2*x + (2*e^2 - (c + x - 3)*x)*(b - c + x + 2))*(a - b + 
....: x - 1) - 2*e^2 + (c + x - 3)*x)*(c - x - 3)*d*z + 2*((b^2*e - (b - c + x + 2)*(c + x - 3)*
....: e)*(a - b + x - 1) + (c + x - 3)*e)*d*e*z)*(b - c - x + 2))*d/z)*(a + x) + ((b^2*x + ((b^2
....: *x + (2*e^2 - (c + x - 3)*x)*(b - c + x + 2))*(a - b + x - 1) - 2*e^2 + (c + x - 3)*x)*(a 
....: - x) + (2*e^2 - (c + x - 3)*x)*(b - c + x + 2))*(c - x - 3) + 2*(b^2*e - (b - c + x + 2)*(
....: c + x - """                                                                               
sage: E2 = """3)*e + ((b^2*e - (b - c + x + 2)*(c + x - 3)*e)*(a - b + x - 1) + (c + x - 3)*e)*(
....: a - x))*e)*(b - c - x + 2) - 4*((a - x)*b^2*e^2 - (b^2*x + (2*e^2 - (c + x - 3)*x)*(b - c 
....: + x + 2))*b^2*d*z - (b^2*x + (2*e^2 - (c + x - 3)*x)*(b - c + x + 2))*(a - x)*(c - x - 3)*
....: d*z - 2*(b^2*e - (b - c + x + 2)*(c + x - 3)*e)*(a - x)*d*e*z - ((b^2*x + (2*e^2 - (c + x 
....: - 3)*x)*(b - c + x + 2))*(a - x)*b^2*d*z - ((b^2*x + (2*e^2 - (c + x - 3)*x)*(b - c + x + 
....: 2))*(a - x)*(c - x - 3)*d*z + 2*(b^2*e - (b - c + x + 2)*(c + x - 3)*e)*(a - x)*d*e*z)*(b 
....: - c - x + 2))*(a - b - x - 1) + ((b^2*x + (2*e^2 - (c + x - 3)*x)*(b - c + x + 2))*(c - x 
....: - 3)*d*z + 2*(b^2*e - (b - c + x + 2)*(c + x - 3)*e)*d*e*z)*(b - c - x + 2) + 4*((b^2*x + 
....: (2*e^2 - (c + x - 3)*x)*(b - c + x + 2))*b^2*d^2*z^2 - ((b^2*x + (2*e^2 - (c + x - 3)*x)*(
....: b - c + x + 2))*(c - x - 3)*d^2*z^2 + 2*(b^2*e - (b - c + x + 2)*(c + x - 3)*e)*d^2*e*z^2)
....: *(b - c - x + 2))*d/z)*d/z + 4*((b^2*x + (2*e^2 - (c + x - 3)*x)*(b - c + x + 2))*b^2*d*z 
....: - ((b^2*x + (2*e^2 - (c + x - 3)*x)*(b - c + x + 2))*(c - x - 3)*d*z + 2*(b^2*e - (b - c +
....:  x + 2)*(c + x - 3)*e)*d*e*z)*(b - c - x + 2))*d/z"""                                     
sage: E = SR(E1 + E2)                                                                           
sage: E.expand().subs(x=0)                                                                      
4*a*b^2*d*z*e^2 - 4*a*b^2*d*e^2/z
sage: E.subs(x=0).expand()                                                                      
0
```
If that is really true, then we should change the title of this ticket.



---

archive/issue_comments_617130.json:
```json
{
    "body": "<a id='comment:5'></a>\nHere is a shorter expression that I think illustrates the bug in `expand`. I was unable to make it any shorter.\n\n```\nsage: var(\"a b c d e x z\")\n(a, b, c, d, e, x, z)\nsage: E = ((((((b^2*x + (e^2 - c)*(b - c + x + 1))*(a - b + x - 1) + (x + 1))*(a - x) + e)\n....: *(c - x - 3) + e)*(b - c - x + 1))*(a - b - x - 1) + (a - b + x - 1 )*d/z)*(a + x)\nsage: E.expand().subs(x=0, a=2, b=0, c=0, e=0)\n2*d*z - 12\nsage: E.expand().subs(x=0) - E.subs(x=0).expand()                                               \na^2*d*z - a*b*d*z - a*d*z - a^2*d/z + a*b*d/z + a*d/z\nsage: E.expand().is_polynomial(z)\nTrue\nsage: E.expand() - E.subs(z = 1/z).expand()\n0\n```\nThe expression `E` is a polynomial in `a,b,c,d,x` and `1/z`, so expanding it cannot yield a term (such as `2*d*z`) with a positive power of `z`. But `expand` actually makes all powers of `z` positive (as indicated by `is_polynomial(z)` being `True`). In fact, the final line seems to indicate that `expand` is somehow confusing `z` with `1/z`.",
    "created_at": "2020-12-19T04:49:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617130",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:5'></a>
Here is a shorter expression that I think illustrates the bug in `expand`. I was unable to make it any shorter.

```
sage: var("a b c d e x z")
(a, b, c, d, e, x, z)
sage: E = ((((((b^2*x + (e^2 - c)*(b - c + x + 1))*(a - b + x - 1) + (x + 1))*(a - x) + e)
....: *(c - x - 3) + e)*(b - c - x + 1))*(a - b - x - 1) + (a - b + x - 1 )*d/z)*(a + x)
sage: E.expand().subs(x=0, a=2, b=0, c=0, e=0)
2*d*z - 12
sage: E.expand().subs(x=0) - E.subs(x=0).expand()                                               
a^2*d*z - a*b*d*z - a*d*z - a^2*d/z + a*b*d/z + a*d/z
sage: E.expand().is_polynomial(z)
True
sage: E.expand() - E.subs(z = 1/z).expand()
0
```
The expression `E` is a polynomial in `a,b,c,d,x` and `1/z`, so expanding it cannot yield a term (such as `2*d*z`) with a positive power of `z`. But `expand` actually makes all powers of `z` positive (as indicated by `is_polynomial(z)` being `True`). In fact, the final line seems to indicate that `expand` is somehow confusing `z` with `1/z`.



---

archive/issue_comments_617131.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -22,3 +22,5 @@\n 0\n ```\n (Calculating in a `LaurentPolynomialRing` also verifies that the determinant is 0.)\n+\n+Edit: Further investigation seems to reveal that the determinant is calculated correctly by maxima, but then sage's `expand` method introduces an error.\n``````\n",
    "created_at": "2020-12-19T04:49:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617131",
    "user": "https://github.com/DaveWitteMorris"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -22,3 +22,5 @@
 0
 ```
 (Calculating in a `LaurentPolynomialRing` also verifies that the determinant is 0.)
+
+Edit: Further investigation seems to reveal that the determinant is calculated correctly by maxima, but then sage's `expand` method introduces an error.
``````




---

archive/issue_comments_617132.json:
```json
{
    "body": "Changing keywords from \"determinant\" to \"expand\".",
    "created_at": "2020-12-19T04:49:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617132",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing keywords from "determinant" to "expand".



---

archive/issue_events_091406.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "rename": {
        "from": "incorrect determinant of a symbolic matrix",
        "to": "very incorrect \"expand\" of a symbolic expression"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31077#event-91406"
}
```



---

archive/issue_events_091407.json:
```json
{
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "label": "critical",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31077#event-91407"
}
```



---

archive/issue_comments_617133.json:
```json
{
    "body": "<a id='comment:6'></a>\nThis means that it is a bug in pynac.  I don't know how to report this.\n\nA tiny bit shorter, by setting `d=1`:\n\n```\nsage: F = (((((b^2*x + (e^2 - c)*(b - c + x + 1))*(a - b + x - 1) + x + 1)*(a - x) + e)*(c - x - 3) + e)*(a - b - x - 1)*(b - c - x + 1) + (a - b + x - 1)/z)*(a + x)\nsage: F.expand().is_polynomial(z)\nTrue\nsage: F.is_polynomial(z)\nFalse\n```",
    "created_at": "2020-12-19T12:05:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617133",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:6'></a>
This means that it is a bug in pynac.  I don't know how to report this.

A tiny bit shorter, by setting `d=1`:

```
sage: F = (((((b^2*x + (e^2 - c)*(b - c + x + 1))*(a - b + x - 1) + x + 1)*(a - x) + e)*(c - x - 3) + e)*(a - b - x - 1)*(b - c - x + 1) + (a - b + x - 1)/z)*(a + x)
sage: F.expand().is_polynomial(z)
True
sage: F.is_polynomial(z)
False
```



---

archive/issue_comments_617134.json:
```json
{
    "body": "<a id='comment:7'></a>\nSlightly simpler:\n\n```\nsage: var(\"A B C x\")\n(A, B, C, x)\nsage: G = ((((((B^2 + C^2)*(B^2 + x) + A + B)*(A + x + 1) + A + 1)*(C^2 + A) + A)*(A + C + 1) + A)*(B^2 + A + 1)*(A + B + x) + (A + B + 1)/x)*(A + 1)\nsage: G.is_polynomial(x)\nFalse\nsage: G.expand().is_polynomial(x)\nTrue\n```",
    "created_at": "2020-12-19T12:38:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617134",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:7'></a>
Slightly simpler:

```
sage: var("A B C x")
(A, B, C, x)
sage: G = ((((((B^2 + C^2)*(B^2 + x) + A + B)*(A + x + 1) + A + 1)*(C^2 + A) + A)*(A + C + 1) + A)*(B^2 + A + 1)*(A + B + x) + (A + B + 1)/x)*(A + 1)
sage: G.is_polynomial(x)
False
sage: G.expand().is_polynomial(x)
True
```



---

archive/issue_comments_617135.json:
```json
{
    "body": "<a id='comment:9'></a>\nYet a very tiny bit simpler:\n\n```\nsage: var(\"A B C x\")\n(A, B, C, x)\nsage: p = A^2*B^2*C^3*x^2 + A^2*B^2*C^2*x^3 + A^2*B^2*C^2*x^2 + A^2*C^3*x^3 + A^5*B^2 + A^2*B^2*C^3 + A^3*B^2*C*x + A^2*B^2*C^2*x + A^3*B^2*x^2 + A^4*x^3 + A^3*C*x^3 + A^4*C^2 + A^2*B^2*C^2 + A^3*C^3 + A^3*B^2*x + B^2*C^3*x + A^3*C*x^2 + A^2*C^2*x^2 + A*C^3*x^2 + A*C^2*x^3 + C^3*x^3 + A^3*B^2 + A^2*B*C^2 + A*B*C^3 + A*B*C^2*x + B^2*C^2*x + A^3*x^2 + C^3*x^2 + A^2*x^3 + B^2*x^3 + A*C*x^3 + C^2*x^3 + A^4 + A^3*C + A^2*C^2 + B^2*C^2 + A*C^3 + B*C^3 + A^2*B*x + A*B*C*x + A*C*x^2 + B*C*x^2 + C^2*x^2 + A^2*B + B^2*C + B*C^2 + C^3 + A*B*x + A*x^2 + C*x^2 + x^3 + A^2 + B^2 + A*C + B*C + C^2 + B*x + x^2 + B + C + x + 1\nsage: G = (((A + B + x) * (A + B^2 + 1) * p + (A + B + 1)/x)*(A+1))\n\nsage: G.expand().is_polynomial(x) != G.is_polynomial(x)\nTrue\n```",
    "created_at": "2020-12-20T17:45:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617135",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:9'></a>
Yet a very tiny bit simpler:

```
sage: var("A B C x")
(A, B, C, x)
sage: p = A^2*B^2*C^3*x^2 + A^2*B^2*C^2*x^3 + A^2*B^2*C^2*x^2 + A^2*C^3*x^3 + A^5*B^2 + A^2*B^2*C^3 + A^3*B^2*C*x + A^2*B^2*C^2*x + A^3*B^2*x^2 + A^4*x^3 + A^3*C*x^3 + A^4*C^2 + A^2*B^2*C^2 + A^3*C^3 + A^3*B^2*x + B^2*C^3*x + A^3*C*x^2 + A^2*C^2*x^2 + A*C^3*x^2 + A*C^2*x^3 + C^3*x^3 + A^3*B^2 + A^2*B*C^2 + A*B*C^3 + A*B*C^2*x + B^2*C^2*x + A^3*x^2 + C^3*x^2 + A^2*x^3 + B^2*x^3 + A*C*x^3 + C^2*x^3 + A^4 + A^3*C + A^2*C^2 + B^2*C^2 + A*C^3 + B*C^3 + A^2*B*x + A*B*C*x + A*C*x^2 + B*C*x^2 + C^2*x^2 + A^2*B + B^2*C + B*C^2 + C^3 + A*B*x + A*x^2 + C*x^2 + x^3 + A^2 + B^2 + A*C + B*C + C^2 + B*x + x^2 + B + C + x + 1
sage: G = (((A + B + x) * (A + B^2 + 1) * p + (A + B + 1)/x)*(A+1))

sage: G.expand().is_polynomial(x) != G.is_polynomial(x)
True
```



---

archive/issue_comments_617136.json:
```json
{
    "body": "<a id='comment:10'></a>\njust in case, it's not fixed by #30446",
    "created_at": "2021-01-24T22:29:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617136",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:10'></a>
just in case, it's not fixed by #30446



---

archive/issue_comments_617137.json:
```json
{
    "body": "<a id='comment:12'></a>\nThis 4x4 symbolic determinant with denominators also goes wrong.\n\nTried the following with Sage 9.3.beta5, 9.3.beta6, 9.3.beta7:\n\n```\nsage: N = 4\nsage: t, x, y, z = (SR.var(s, N) for s in 'txyz')\nsage: f = lambda i, j: (x[i] - x[j])*(y[i] - y[j])*(z[i] - z[j])/(t[i] - t[j])\nsage: A = matrix(SR, N, lambda i, j: f(i, j) if i != j else 0)\nsage: A_det = A.det()\nsage: txyz = t + x + y + z\nsage: vv = dict(zip(txyz, list(range(N))*4))\nsage: A.subs(vv).det(), A_det().subs(vv)\n(0, -3072)\n```\n\nComputing `len(str(A_det))` gave varied results, all near 5.8 million.\n\nRepeating the sequence \"start Sage, define `N`, `t`, `x`, `y`, `z`,\n`f`, `A`, `A_det`, compute that length\" various times gave\n5794243, 5775526, 5783134, 5771824, 5775730, 5810160, 5820599...\n\nComputing `A_det.subs(vv)` after that also gave several values: -3072, 6144, 9216.",
    "created_at": "2021-02-19T03:20:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617137",
    "user": "https://github.com/slel"
}
```

<a id='comment:12'></a>
This 4x4 symbolic determinant with denominators also goes wrong.

Tried the following with Sage 9.3.beta5, 9.3.beta6, 9.3.beta7:

```
sage: N = 4
sage: t, x, y, z = (SR.var(s, N) for s in 'txyz')
sage: f = lambda i, j: (x[i] - x[j])*(y[i] - y[j])*(z[i] - z[j])/(t[i] - t[j])
sage: A = matrix(SR, N, lambda i, j: f(i, j) if i != j else 0)
sage: A_det = A.det()
sage: txyz = t + x + y + z
sage: vv = dict(zip(txyz, list(range(N))*4))
sage: A.subs(vv).det(), A_det().subs(vv)
(0, -3072)
```

Computing `len(str(A_det))` gave varied results, all near 5.8 million.

Repeating the sequence "start Sage, define `N`, `t`, `x`, `y`, `z`,
`f`, `A`, `A_det`, compute that length" various times gave
5794243, 5775526, 5783134, 5771824, 5775730, 5810160, 5820599...

Computing `A_det.subs(vv)` after that also gave several values: -3072, 6144, 9216.



---

archive/issue_comments_617138.json:
```json
{
    "body": "patch mul::expand to eliminate call to poly_mul_expand",
    "created_at": "2021-02-22T21:15:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617138",
    "user": "https://github.com/DaveWitteMorris"
}
```

patch mul::expand to eliminate call to poly_mul_expand



---

archive/issue_comments_617139.json:
```json
{
    "body": "<a id='comment:13'></a>\nAttachment [mul_expand.patch](tarball://root/attachments/some-uuid/ticket31077/mul_expand.patch) by @DaveWitteMorris created at 2021-02-22 21:18:06\n\nThe attached patch `mul_expand.patch` works for me (and causes no doctest failures).  It solves all of the problems on this ticket and also the bug reported in #31411. If other people have the same experience, then I think it is a viable workaround until we fix the real problem, so perhaps we should make this ticket a blocker.\n\nIn effect, the patch just comments out a call to `poly_mul_expand`, so that seems to be where the problem is. The pynac code for this function is short, so it should be easy to find the bug if that's where it is. But the problem may be upstream in `singular` or `libgiac`.\n\nHere is a more detailed explanation of my experience after the patch is applied.\n\n* For the original issue on this ticket, `L.det()` gives `0`.\n* For `E` as in[comment:5](#comment%3A5), \n    * `E.expand().subs(x=0, a=2, b=0, c=0, e=0)` gives `2*d/z - 12`\n    * `E.expand().subs(x=0) - E.subs(x=0).expand()` gives `0`\n    * `E.expand().subs(z=1/z).is_polynomial(z)` gives `True`\n* For `A` and `A_det` as in[comment:12](#comment%3A12), \n    * `A.subs(vv).det(), A_det().subs(vv)` gives `(0, 0)`\n    * `len(str(A_det))` gives `942027`\n* For `A` and `B` as in #31411,\n    * `bool((A*B).expand()==(A*B.expand()).expand())` gives `True`\n    * `((A*B).expand())/((A*B.expand()).expand())` gives `1`",
    "created_at": "2021-02-22T21:18:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617139",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:13'></a>
Attachment [mul_expand.patch](tarball://root/attachments/some-uuid/ticket31077/mul_expand.patch) by @DaveWitteMorris created at 2021-02-22 21:18:06

The attached patch `mul_expand.patch` works for me (and causes no doctest failures).  It solves all of the problems on this ticket and also the bug reported in #31411. If other people have the same experience, then I think it is a viable workaround until we fix the real problem, so perhaps we should make this ticket a blocker.

In effect, the patch just comments out a call to `poly_mul_expand`, so that seems to be where the problem is. The pynac code for this function is short, so it should be easy to find the bug if that's where it is. But the problem may be upstream in `singular` or `libgiac`.

Here is a more detailed explanation of my experience after the patch is applied.

* For the original issue on this ticket, `L.det()` gives `0`.
* For `E` as in[comment:5](#comment%3A5), 
    * `E.expand().subs(x=0, a=2, b=0, c=0, e=0)` gives `2*d/z - 12`
    * `E.expand().subs(x=0) - E.subs(x=0).expand()` gives `0`
    * `E.expand().subs(z=1/z).is_polynomial(z)` gives `True`
* For `A` and `A_det` as in[comment:12](#comment%3A12), 
    * `A.subs(vv).det(), A_det().subs(vv)` gives `(0, 0)`
    * `len(str(A_det))` gives `942027`
* For `A` and `B` as in #31411,
    * `bool((A*B).expand()==(A*B.expand()).expand())` gives `True`
    * `((A*B).expand())/((A*B.expand()).expand())` gives `1`



---

archive/issue_comments_617140.json:
```json
{
    "body": "Changing author from \"\" to \"Dave Morris\"",
    "created_at": "2021-02-22T21:18:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617140",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing author from "" to "Dave Morris"



---

archive/issue_comments_617141.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-02-22T21:18:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617141",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_617142.json:
```json
{
    "body": "<a id='comment:15'></a>\nThis is a very bad bug, so I am raising the priority to blocker.\n\nSage is silently returning mathematically wrong answers any time it expands a product `A * B` where `A` and `B` are long sums (more than about 400 terms in total) such that one of the sums has a term where at least one of the factors has a negative exponent. The patch `mul_expand.patch` gets rid of the mathematical error by eliminating an incorrect optimization. The drawback is that sage may run slower and use more memory. \n\nIt should be pretty easy to write a better patch that restores the optimization in cases where it is correct, so I will work on that.  But an optimization for the general case might  not be ready for 9.3.\n\n---\n\nExplanation of the bug:\nIn order to take advantage of optimizations in `singular`'s handling of products of large polynomials, pynac converts the product `A * B` into a product of multivariate polynomials, and asks `singular` to do the calculation.\nTo do this, pynac uses the `ex::to_canonical` method, which claims to turn any expression into a polynomial, by replacing some subexpressions with new variables.  (For example, `x^2 + a*cos(y)^3` could be encoded as `x^2 + a*c^3`, where `c` stands for `cos(y)`.) The bug is that the result is sometimes actually a *Laurent* polynomial, not a true polynomial, because some of the exponents could be negative. This causes a problem when the supposed \"polynomial\" is sent to `singular`, which seems to think it is getting a genuine polynomial (i.e., a `CanonicalForm` in `singular`'s terminology). I have not yet checked the details of what has happening, but it seems that `singular` does indeed get a polynomial, because all negative exponents are silently converted to positive. I don't know exactly where this happens, and I don't understand why no error is raised -- I will look into those questions.\n\nMy \"it should be pretty easy\" comment above is the suggestion that we could send the product to `singular` only in cases where none of the exponents are negative. If there is a CAS that optimizes multiplication of multivariate Laurent polynomials over `Q`, then the other cases could also be optimized with very little additional work. (How efficient is `sage`'s code for the `_mul_` method of `LaurentPolynomial_mpair`?)",
    "created_at": "2021-02-23T20:19:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617142",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:15'></a>
This is a very bad bug, so I am raising the priority to blocker.

Sage is silently returning mathematically wrong answers any time it expands a product `A * B` where `A` and `B` are long sums (more than about 400 terms in total) such that one of the sums has a term where at least one of the factors has a negative exponent. The patch `mul_expand.patch` gets rid of the mathematical error by eliminating an incorrect optimization. The drawback is that sage may run slower and use more memory. 

It should be pretty easy to write a better patch that restores the optimization in cases where it is correct, so I will work on that.  But an optimization for the general case might  not be ready for 9.3.

---

Explanation of the bug:
In order to take advantage of optimizations in `singular`'s handling of products of large polynomials, pynac converts the product `A * B` into a product of multivariate polynomials, and asks `singular` to do the calculation.
To do this, pynac uses the `ex::to_canonical` method, which claims to turn any expression into a polynomial, by replacing some subexpressions with new variables.  (For example, `x^2 + a*cos(y)^3` could be encoded as `x^2 + a*c^3`, where `c` stands for `cos(y)`.) The bug is that the result is sometimes actually a *Laurent* polynomial, not a true polynomial, because some of the exponents could be negative. This causes a problem when the supposed "polynomial" is sent to `singular`, which seems to think it is getting a genuine polynomial (i.e., a `CanonicalForm` in `singular`'s terminology). I have not yet checked the details of what has happening, but it seems that `singular` does indeed get a polynomial, because all negative exponents are silently converted to positive. I don't know exactly where this happens, and I don't understand why no error is raised -- I will look into those questions.

My "it should be pretty easy" comment above is the suggestion that we could send the product to `singular` only in cases where none of the exponents are negative. If there is a CAS that optimizes multiplication of multivariate Laurent polynomials over `Q`, then the other cases could also be optimized with very little additional work. (How efficient is `sage`'s code for the `_mul_` method of `LaurentPolynomial_mpair`?)



---

archive/issue_events_091408.json:
```json
{
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "label": "critical",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31077#event-91408"
}
```



---

archive/issue_events_091409.json:
```json
{
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "label": "blocker",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31077#event-91409"
}
```



---

archive/issue_comments_617143.json:
```json
{
    "body": "<a id='comment:16'></a>\nYou are a true hero!",
    "created_at": "2021-02-23T20:28:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617143",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:16'></a>
You are a true hero!



---

archive/issue_comments_617144.json:
```json
{
    "body": "<a id='comment:17'></a>\nThanks a lot for this fix! Can you turn your patch into a branch?",
    "created_at": "2021-02-23T21:14:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617144",
    "user": "https://github.com/slel"
}
```

<a id='comment:17'></a>
Thanks a lot for this fix! Can you turn your patch into a branch?



---

archive/issue_comments_617145.json:
```json
{
    "body": "Changing branch from \"\" to \"public/31077\"",
    "created_at": "2021-02-23T21:56:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617145",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing branch from "" to "public/31077"



---

archive/issue_comments_617146.json:
```json
{
    "body": "<a id='comment:19'></a>\nThanks (both of you) for the encouragement. I pushed a branch.\n\n---\nNew commits:\n|                                                                                                                                          |                                      |\n|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------|\n|[3d2a2dd](https://github.com/sagemath/sagetrac-mirror/commit/3d2a2dd9811a7d802c2c9b795f31aa34e6469e32)|`trac 31077 don't use poly_mul_expand`|",
    "created_at": "2021-02-23T21:57:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617146",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:19'></a>
Thanks (both of you) for the encouragement. I pushed a branch.

---
New commits:
|                                                                                                                                          |                                      |
|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------|
|[3d2a2dd](https://github.com/sagemath/sagetrac-mirror/commit/3d2a2dd9811a7d802c2c9b795f31aa34e6469e32)|`trac 31077 don't use poly_mul_expand`|



---

archive/issue_comments_617147.json:
```json
{
    "body": "Changing commit from \"\" to \"3d2a2dd9811a7d802c2c9b795f31aa34e6469e32\"",
    "created_at": "2021-02-23T21:57:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617147",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing commit from "" to "3d2a2dd9811a7d802c2c9b795f31aa34e6469e32"



---

archive/issue_comments_617148.json:
```json
{
    "body": "<a id='comment:20'></a>\nWell done - that was a very subtle bug indeed, and finding exactly what happened is great.",
    "created_at": "2021-02-23T22:28:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617148",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:20'></a>
Well done - that was a very subtle bug indeed, and finding exactly what happened is great.



---

archive/issue_comments_617149.json:
```json
{
    "body": "<a id='comment:21'></a>\nReplying to [gh-DaveWitteMorris](#comment%3A15):\n> (How efficient is `sage`'s code for the `_mul_` method of `LaurentPolynomial_mpair`?)\n\n\nLaurent polynomials in Sage are represented by libsingular polynomials together with an offset exponent vector, so I assume that it would be quite ok.",
    "created_at": "2021-02-24T21:58:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617149",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:21'></a>
Replying to [gh-DaveWitteMorris](#comment%3A15):
> (How efficient is `sage`'s code for the `_mul_` method of `LaurentPolynomial_mpair`?)


Laurent polynomials in Sage are represented by libsingular polynomials together with an offset exponent vector, so I assume that it would be quite ok.



---

archive/issue_comments_617150.json:
```json
{
    "body": "<a id='comment:22'></a>\nThanks, that's good to know. I'll try to find time to write a PR in the next few days.",
    "created_at": "2021-02-24T22:16:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617150",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:22'></a>
Thanks, that's good to know. I'll try to find time to write a PR in the next few days.



---

archive/issue_comments_617151.json:
```json
{
    "body": "<a id='comment:23'></a>\nWould it make sense to compare with the ginac code?  I do not understand cpp code, but it seems that the two `mul::expand` routines have diverged a fair bit.  I guess a big difference is that ginac doesn't call singular, but given the bug, is it worth it?",
    "created_at": "2021-02-25T09:44:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617151",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:23'></a>
Would it make sense to compare with the ginac code?  I do not understand cpp code, but it seems that the two `mul::expand` routines have diverged a fair bit.  I guess a big difference is that ginac doesn't call singular, but given the bug, is it worth it?



---

archive/issue_comments_617152.json:
```json
{
    "body": "<a id='comment:24'></a>\nDeterminants are often computed to check whether (or for which\nvalues of parameters) they are zero; factoring would help more\nthan expanding for that.\n\nRegarding denominators and Singular, a solution might be to detect\ndenominators in each row, collect them, ask Singular to compute\na denominatorless determinant, and divide back afterwards.",
    "created_at": "2021-02-25T10:50:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617152",
    "user": "https://github.com/slel"
}
```

<a id='comment:24'></a>
Determinants are often computed to check whether (or for which
values of parameters) they are zero; factoring would help more
than expanding for that.

Regarding denominators and Singular, a solution might be to detect
denominators in each row, collect them, ask Singular to compute
a denominatorless determinant, and divide back afterwards.



---

archive/issue_comments_617153.json:
```json
{
    "body": "<a id='comment:25'></a>\nEven if a follow-up ticket might restore a fixed optimisation,\nthis should go in -- ideally with doctests.",
    "created_at": "2021-02-25T10:59:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617153",
    "user": "https://github.com/slel"
}
```

<a id='comment:25'></a>
Even if a follow-up ticket might restore a fixed optimisation,
this should go in -- ideally with doctests.



---

archive/issue_comments_617154.json:
```json
{
    "body": "<a id='comment:26'></a>\nI hope to have a correct fix (with doctests) ready in a few days, so I don't think we should merge the current patch. It was just written to test whether I was on the right track, and to provide a backup plan if a real fix was too hard.\n\n*Correction:* The rationale that I gave for using (Laurent) polynomials was incorrect.  Using a single variable to represent a complicated expression can give a big savings in space and time, even if the handling of (Laurent) polynomials is not particularly efficient. It eliminates the need to copy the expression every time two terms are multiplied (and there are `n^2` multiplications when two sums of length `n` are multiplied). So I think it is worth trying to re-enable this.\n\n---\n\nPS I think I now understand the two issues that I left open at the end of the next-to-last paragraph of[comment:15](#comment%3A15):\n\n1) The `ex::to_canonical` method uses singular's `CanonicalForm::power` method to calculate a power `a^n`. This `power` method does not allow `n` to be negative, and starts with a check for that. However, the check is `ASSERT( n >= 0, \"illegal exponent\" )`, and I think sage uses compile flags that disable debugging, and therefore disable this `assert` statement. So the check is not performed.  That is why no error is raised.    (My quick impression is that the `singular` source code has hundreds of assert statements that should be raising errors. I don't know whether there is anything we can do about this.)\n\n2) The `CanonicalForm::power` method uses repeated squaring to calculate `a^n`. This will always result in raising `a` to a positive power, even if `n` is negative. That is why the negative exponent turns into a positive one. In fact, the way the code is written means that the result will always be precisely `a^abs(n)`.",
    "created_at": "2021-02-26T03:11:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617154",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:26'></a>
I hope to have a correct fix (with doctests) ready in a few days, so I don't think we should merge the current patch. It was just written to test whether I was on the right track, and to provide a backup plan if a real fix was too hard.

*Correction:* The rationale that I gave for using (Laurent) polynomials was incorrect.  Using a single variable to represent a complicated expression can give a big savings in space and time, even if the handling of (Laurent) polynomials is not particularly efficient. It eliminates the need to copy the expression every time two terms are multiplied (and there are `n^2` multiplications when two sums of length `n` are multiplied). So I think it is worth trying to re-enable this.

---

PS I think I now understand the two issues that I left open at the end of the next-to-last paragraph of[comment:15](#comment%3A15):

1) The `ex::to_canonical` method uses singular's `CanonicalForm::power` method to calculate a power `a^n`. This `power` method does not allow `n` to be negative, and starts with a check for that. However, the check is `ASSERT( n >= 0, "illegal exponent" )`, and I think sage uses compile flags that disable debugging, and therefore disable this `assert` statement. So the check is not performed.  That is why no error is raised.    (My quick impression is that the `singular` source code has hundreds of assert statements that should be raising errors. I don't know whether there is anything we can do about this.)

2) The `CanonicalForm::power` method uses repeated squaring to calculate `a^n`. This will always result in raising `a` to a positive power, even if `n` is negative. That is why the negative exponent turns into a positive one. In fact, the way the code is written means that the result will always be precisely `a^abs(n)`.



---

archive/issue_comments_617155.json:
```json
{
    "body": "Changing branch from \"public/31077\" to \"public/31077v2\"",
    "created_at": "2021-02-27T06:17:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617155",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing branch from "public/31077" to "public/31077v2"



---

archive/issue_comments_617156.json:
```json
{
    "body": "<a id='comment:28'></a>\nThis simple patch allows the `singular` optimization to be used in the cases where it works (i.e., when the exponents are positive). It would be more work to enable an optimization (by using Laurent series) for negative exponents, so that can be a follow-up ticket. I think that extension would be an enhancement, not a bug fix, so certainly not critical, and I do not intend to work on it soon, but it's great if someone else is interested.\n\n---\nNew commits:\n|                                                                                                                                          |                                    |\n|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------|\n|[dbf88e2](https://github.com/sagemath/sagetrac-mirror/commit/dbf88e228d94d288e13e4e2a71e628cf027364ed)|`trac 31077 fix incorrect expansion`|\n|[d05da0b](https://github.com/sagemath/sagetrac-mirror/commit/d05da0bf665ad4abdc3757aee28245036ee42b4e)|`add doctest`|",
    "created_at": "2021-02-27T06:32:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617156",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:28'></a>
This simple patch allows the `singular` optimization to be used in the cases where it works (i.e., when the exponents are positive). It would be more work to enable an optimization (by using Laurent series) for negative exponents, so that can be a follow-up ticket. I think that extension would be an enhancement, not a bug fix, so certainly not critical, and I do not intend to work on it soon, but it's great if someone else is interested.

---
New commits:
|                                                                                                                                          |                                    |
|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------|
|[dbf88e2](https://github.com/sagemath/sagetrac-mirror/commit/dbf88e228d94d288e13e4e2a71e628cf027364ed)|`trac 31077 fix incorrect expansion`|
|[d05da0b](https://github.com/sagemath/sagetrac-mirror/commit/d05da0bf665ad4abdc3757aee28245036ee42b4e)|`add doctest`|



---

archive/issue_comments_617157.json:
```json
{
    "body": "Changing commit from \"3d2a2dd9811a7d802c2c9b795f31aa34e6469e32\" to \"d05da0bf665ad4abdc3757aee28245036ee42b4e\"",
    "created_at": "2021-02-27T06:32:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617157",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing commit from "3d2a2dd9811a7d802c2c9b795f31aa34e6469e32" to "d05da0bf665ad4abdc3757aee28245036ee42b4e"



---

archive/issue_comments_617158.json:
```json
{
    "body": "<a id='comment:29'></a>\nWhy 400 in `if (s > 400) {...` ?\n\nSo this problem is not triggered if `s<401`? Or doesit mean to avoid using this code branch for `s<401`?",
    "created_at": "2021-02-27T11:51:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617158",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:29'></a>
Why 400 in `if (s > 400) {...` ?

So this problem is not triggered if `s<401`? Or doesit mean to avoid using this code branch for `s<401`?



---

archive/issue_comments_617159.json:
```json
{
    "body": "<a id='comment:30'></a>\n400 was in the original code.  I think the point is that the overhead of translating to a polynomial is not worth the trouble for short sums, so `poly_mul_expand` should not be called unless `s` is large. A comment in the code says that the condition `s > 400` is \"probably too simple\", but making a more more intelligent choice would be a different ticket.\n\nThe negative-exponent bug arose whenever `poly_mul_expand` was called with a negative exponent. Because of the condition `s > 400`, this only happened for long sums (see[comment:21](#comment%3A21)). When I was searching for the bug, I changed 400 to 2, so that the problem was visible in very short sums, which made it easier to diagnose.",
    "created_at": "2021-02-27T18:51:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617159",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:30'></a>
400 was in the original code.  I think the point is that the overhead of translating to a polynomial is not worth the trouble for short sums, so `poly_mul_expand` should not be called unless `s` is large. A comment in the code says that the condition `s > 400` is "probably too simple", but making a more more intelligent choice would be a different ticket.

The negative-exponent bug arose whenever `poly_mul_expand` was called with a negative exponent. Because of the condition `s > 400`, this only happened for long sums (see[comment:21](#comment%3A21)). When I was searching for the bug, I changed 400 to 2, so that the problem was visible in very short sums, which made it easier to diagnose.



---

archive/issue_comments_617160.json:
```json
{
    "body": "<a id='comment:31'></a>\nA patchbot failed the doctest that I wrote to test the patch. I think it is because the patchbot didn't rebuild pynac after loading the patch (so the patch to pynac didn't do anything). Is there something I can do to get the patchbots to test the patch?",
    "created_at": "2021-02-27T20:48:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617160",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:31'></a>
A patchbot failed the doctest that I wrote to test the patch. I think it is because the patchbot didn't rebuild pynac after loading the patch (so the patch to pynac didn't do anything). Is there something I can do to get the patchbots to test the patch?



---

archive/issue_comments_617161.json:
```json
{
    "body": "<a id='comment:32'></a>\nFWIW, `sage -t -l --optional=sage --all` doesn't give me any unexpected doctest failures on MacOS 10.15.7 or Ubuntu 20.04 (`CoCalc`).",
    "created_at": "2021-03-01T05:44:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617161",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:32'></a>
FWIW, `sage -t -l --optional=sage --all` doesn't give me any unexpected doctest failures on MacOS 10.15.7 or Ubuntu 20.04 (`CoCalc`).



---

archive/issue_comments_617162.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-03-02T03:20:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617162",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_617163.json:
```json
{
    "body": "<a id='comment:33'></a>\nI just noticed that the same problem probably happens in another (nearby) place in the file. I fixed the problem for rational exponents, but I think the same thing could happen for irrational exponents. I plan to upload a fix soon.",
    "created_at": "2021-03-02T03:20:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617163",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:33'></a>
I just noticed that the same problem probably happens in another (nearby) place in the file. I fixed the problem for rational exponents, but I think the same thing could happen for irrational exponents. I plan to upload a fix soon.



---

archive/issue_events_091410.json:
```json
{
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "label": "blocker",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31077#event-91410"
}
```



---

archive/issue_comments_617164.json:
```json
{
    "body": "<a id='comment:34'></a>\nTicket #31411 reveals two other bugs in `poly_mul_expand`. I opened blocker ticket #31479 to disable the use of this function until all of the bugs have been fixed (and metaticket #31478 to track the progress), so it is not an urgent problem.",
    "created_at": "2021-03-10T07:39:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617164",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:34'></a>
Ticket #31411 reveals two other bugs in `poly_mul_expand`. I opened blocker ticket #31479 to disable the use of this function until all of the bugs have been fixed (and metaticket #31478 to track the progress), so it is not an urgent problem.



---

archive/issue_events_091411.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-05-10T17:42:09Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31077#event-91411"
}
```



---

archive/issue_comments_617165.json:
```json
{
    "body": "<a id='comment:35'></a>\nMoving to 9.4, as 9.3 has been released.",
    "created_at": "2021-05-10T17:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-617165",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:35'></a>
Moving to 9.4, as 9.3 has been released.



---

archive/issue_events_091412.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-22T20:35:10Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31077#event-91412"
}
```



---

archive/issue_events_091413.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-22T20:35:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31077#event-91413"
}
```



---

archive/issue_events_091414.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:24:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31077#event-91414"
}
```



---

archive/issue_events_091415.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:24:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31077#event-91415"
}
```



---

archive/issue_events_091416.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:19:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31077#event-91416"
}
```



---

archive/issue_events_091417.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:19:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31077#event-91417"
}
```



---

archive/issue_events_091418.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31077#event-91418"
}
```



---

archive/issue_events_091419.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31077#event-91419"
}
```
