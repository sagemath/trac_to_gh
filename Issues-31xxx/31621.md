# Issue 31621: ubuntu-groovy-standard, debian-bullseye-standard: numerics-related sage testsuite errors

archive/issues_031384.json:
```json
{
    "assignees": [],
    "body": "From https://groups.google.com/g/sage-release/c/6WjKQt_e_B8/m/dpx1qILOCwAJ (for 9.3.rc2):\n\n9.3.beta8> {debian-bullseye,ubuntu-groovy}-standard: cvxopt testsuite errors, numerics-related sage testsuite errors\n9.3.beta8> (is system BLAS feeling OK??)\n\nThe numerics failures on debian-bullseye have disappeared (or perhaps it is processor dependent, and we were luckier in this run), but show up in debian-sid this time. \nThe numerics failures on ubuntu-groovy are still present.\n\nAnother report for `debian-bullseye`: https://groups.google.com/g/sage-devel/c/kip6kYlL95Q/m/fjUbYwA-AwAJ\n\nCC:  @dimpase @jhpalmieri @videlec @kliem\n\nComponent: **porting**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/31621_\n\n",
    "created_at": "2021-04-08T17:18:51Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20porting",
        "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.8",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "ubuntu-groovy-standard, debian-bullseye-standard: numerics-related sage testsuite errors",
    "type": "issue",
    "updated_at": "2022-09-19T18:58:47Z",
    "url": "https://github.com/sagemath/sage/issues/31621",
    "user": "https://github.com/mkoeppe"
}
```
From https://groups.google.com/g/sage-release/c/6WjKQt_e_B8/m/dpx1qILOCwAJ (for 9.3.rc2):

9.3.beta8> {debian-bullseye,ubuntu-groovy}-standard: cvxopt testsuite errors, numerics-related sage testsuite errors
9.3.beta8> (is system BLAS feeling OK??)

The numerics failures on debian-bullseye have disappeared (or perhaps it is processor dependent, and we were luckier in this run), but show up in debian-sid this time. 
The numerics failures on ubuntu-groovy are still present.

Another report for `debian-bullseye`: https://groups.google.com/g/sage-devel/c/kip6kYlL95Q/m/fjUbYwA-AwAJ

CC:  @dimpase @jhpalmieri @videlec @kliem

Component: **porting**

_Issue created by migration from https://trac.sagemath.org/ticket/31621_





---

archive/issue_events_438282.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-08T17:18:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31621#event-438282"
}
```



---

archive/issue_events_438283.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-08T17:18:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20porting",
    "label_color": "000080",
    "label_name": "c: porting",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31621#event-438283"
}
```



---

archive/issue_events_438284.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-08T17:18:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31621#event-438284"
}
```



---

archive/issue_events_438285.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-08T17:18:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31621#event-438285"
}
```



---

archive/issue_events_438286.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-05-10T17:42:09Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31621#event-438286"
}
```



---

archive/issue_events_438287.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-05-10T17:42:09Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31621#event-438287"
}
```



---

archive/issue_comments_508440.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nMoving to 9.4, as 9.3 has been released.",
    "created_at": "2021-05-10T17:42:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508440",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:1" align="right">comment:1</div>

Moving to 9.4, as 9.3 has been released.



---

archive/issue_events_438288.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-22T20:35:10Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31621#event-438288"
}
```



---

archive/issue_events_438289.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-22T20:35:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31621#event-438289"
}
```



---

archive/issue_comments_508441.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nI saw what I think are the same failures on one OS X 11.5.2 machine (but not another one \u2014\u00a0I think it's CPU dependent). The failing machine says\n\n```\n% sysctl -n machdep.cpu.brand_string\nIntel(R) Xeon(R) W-2140B CPU @ 3.20GHz\n```\nI can provide other CPU info if you let me know what commands to run.",
    "created_at": "2021-09-22T21:39:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508441",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:4" align="right">comment:4</div>

I saw what I think are the same failures on one OS X 11.5.2 machine (but not another one — I think it's CPU dependent). The failing machine says

```
% sysctl -n machdep.cpu.brand_string
Intel(R) Xeon(R) W-2140B CPU @ 3.20GHz
```
I can provide other CPU info if you let me know what commands to run.



---

archive/issue_comments_508442.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nThe tests passed when I did `tox -e local-homebrew-macos-minimal -- ptestlong`. Any guesses for what homebrew package is causing the problem? What should I plug into `./configure --with-system-PKG=no`?",
    "created_at": "2021-09-23T20:18:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508442",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:5" align="right">comment:5</div>

The tests passed when I did `tox -e local-homebrew-macos-minimal -- ptestlong`. Any guesses for what homebrew package is causing the problem? What should I plug into `./configure --with-system-PKG=no`?



---

archive/issue_comments_508443.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nThese tests passed when I did `./configure --with-system-gsl=no --with-system-openblas=no`. \n\nJust using `./configure --with-system-gsl=no` failed to build: gsl's configure script failed with\n\n```\nconfigure: error: in `/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta1/local/var/tmp/sage/build/gsl-2.6/src':\nconfigure: error: C compiler cannot create executables\n```\nand gsl's config.log file said\n\n```\nld: library not found for -lopenblas\n```\n\nI'm trying now with `./configure --with-system-openblas=no`, which means that Sage will also build its own `gsl`, `r`, and `suitesparse`.\n\n(This computer is in my work office, and so I will not check its progress again until Monday.)",
    "created_at": "2021-09-24T21:57:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508443",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:6" align="right">comment:6</div>

These tests passed when I did `./configure --with-system-gsl=no --with-system-openblas=no`. 

Just using `./configure --with-system-gsl=no` failed to build: gsl's configure script failed with

```
configure: error: in `/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta1/local/var/tmp/sage/build/gsl-2.6/src':
configure: error: C compiler cannot create executables
```
and gsl's config.log file said

```
ld: library not found for -lopenblas
```

I'm trying now with `./configure --with-system-openblas=no`, which means that Sage will also build its own `gsl`, `r`, and `suitesparse`.

(This computer is in my work office, and so I will not check its progress again until Monday.)



---

archive/issue_comments_508444.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nBy the way, I expect this to pass these tests \u2014 it should be equivalent to what I already did with `./configure --with-system-gsl=no --with-system-openblas=no` \u2014\u00a0but I want to see the output of `make ptestlong`.",
    "created_at": "2021-09-24T22:06:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508444",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:7" align="right">comment:7</div>

By the way, I expect this to pass these tests — it should be equivalent to what I already did with `./configure --with-system-gsl=no --with-system-openblas=no` — but I want to see the output of `make ptestlong`.



---

archive/issue_comments_508445.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nAll tests passed when using that flag (`--with-system-openblas=no`).",
    "created_at": "2021-09-27T18:56:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508445",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:8" align="right">comment:8</div>

All tests passed when using that flag (`--with-system-openblas=no`).



---

archive/issue_events_438290.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-10-16T17:48:02Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31621#event-438290"
}
```



---

archive/issue_events_438291.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-10-16T17:48:02Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "label": "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p: 2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31621#event-438291"
}
```



---

archive/issue_comments_508446.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -6,4 +6,4 @@\n The numerics failures on debian-bullseye have disappeared (or perhaps it is processor dependent, and we were luckier in this run), but show up in debian-sid this time. \n The numerics failures on ubuntu-groovy are still present.\n \n-\n+Another report for `debian-bullseye`: https://groups.google.com/g/sage-devel/c/kip6kYlL95Q/m/fjUbYwA-AwAJ\n``````\n",
    "created_at": "2021-10-16T17:48:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508446",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -6,4 +6,4 @@
 The numerics failures on debian-bullseye have disappeared (or perhaps it is processor dependent, and we were luckier in this run), but show up in debian-sid this time. 
 The numerics failures on ubuntu-groovy are still present.
 
-
+Another report for `debian-bullseye`: https://groups.google.com/g/sage-devel/c/kip6kYlL95Q/m/fjUbYwA-AwAJ
``````




---

archive/issue_events_438292.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-10-16T17:48:56Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "title_is": "ubuntu-groovy-standard, debian-bullseye-standard: numerics-related sage testsuite errors",
    "title_was": "ubuntu-groovy-standard: numerics-related sage testsuite errors",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31621#event-438292"
}
```



---

archive/issue_comments_508447.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nJohn, do you see on macOS the error reported by Vincent?\n\n```\nFile \"src/sage/matrix/matrix_double_dense.pyx\", line 1365, in\nsage.matrix.matrix_double_dense.Matrix_double_dense.?\nFailed example:\n     A.eigenvalues(algorithm='symmetric', tol=1.0e-5)  # tol 2e-15\nExpected:\n     [(-8.0, 22), (2.0, 77), (22.0, 1)]\nGot:\n     [(-13.81753974166025, 1),\n...\n```\n\n- it's one I know how to produce a standalone test for (as a short Fortran program linking OpenBLAS)",
    "created_at": "2021-10-16T22:37:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508447",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:11" align="right">comment:11</div>

John, do you see on macOS the error reported by Vincent?

```
File "src/sage/matrix/matrix_double_dense.pyx", line 1365, in
sage.matrix.matrix_double_dense.Matrix_double_dense.?
Failed example:
     A.eigenvalues(algorithm='symmetric', tol=1.0e-5)  # tol 2e-15
Expected:
     [(-8.0, 22), (2.0, 77), (22.0, 1)]
Got:
     [(-13.81753974166025, 1),
...
```

- it's one I know how to produce a standalone test for (as a short Fortran program linking OpenBLAS)



---

archive/issue_comments_508448.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nalso, what openblas version did you try on homebrew?\nthe bumped to 0.3.18 two weeks ago: https://github.com/Homebrew/homebrew-core/commit/63de340b1e397b67e7137519f45b02491b6e1f15",
    "created_at": "2021-10-16T22:56:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508448",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:12" align="right">comment:12</div>

also, what openblas version did you try on homebrew?
the bumped to 0.3.18 two weeks ago: https://github.com/Homebrew/homebrew-core/commit/63de340b1e397b67e7137519f45b02491b6e1f15



---

archive/issue_comments_508449.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nI will check on Monday.",
    "created_at": "2021-10-17T00:44:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508449",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:13" align="right">comment:13</div>

I will check on Monday.



---

archive/issue_comments_508450.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@dimpase](#comment:11):\n> John, do you see on macOS the error reported by Vincent?\n> \n> ```\n> File \"src/sage/matrix/matrix_double_dense.pyx\", line 1365, in\n> sage.matrix.matrix_double_dense.Matrix_double_dense.?\n> Failed example:\n>      A.eigenvalues(algorithm='symmetric', tol=1.0e-5)  # tol 2e-15\n> Expected:\n>      [(-8.0, 22), (2.0, 77), (22.0, 1)]\n> Got:\n>      [(-13.81753974166025, 1),\n> ...\n> ```\n> \n> - it's one I know how to produce a standalone test for (as a short Fortran program linking OpenBLAS)\n> \n>  \n\nDima, even a standalone test with scipy would be already good enough. I would like to check if the Debian package is completely broken or simply used wrongly within sage. In both cases, it might be known from Debian developers.",
    "created_at": "2021-10-17T10:34:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508450",
    "user": "https://github.com/videlec"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@dimpase](#comment:11):
> John, do you see on macOS the error reported by Vincent?
> 
> ```
> File "src/sage/matrix/matrix_double_dense.pyx", line 1365, in
> sage.matrix.matrix_double_dense.Matrix_double_dense.?
> Failed example:
>      A.eigenvalues(algorithm='symmetric', tol=1.0e-5)  # tol 2e-15
> Expected:
>      [(-8.0, 22), (2.0, 77), (22.0, 1)]
> Got:
>      [(-13.81753974166025, 1),
> ...
> ```
> 
> - it's one I know how to produce a standalone test for (as a short Fortran program linking OpenBLAS)
> 
>  

Dima, even a standalone test with scipy would be already good enough. I would like to check if the Debian package is completely broken or simply used wrongly within sage. In both cases, it might be known from Debian developers.



---

archive/issue_comments_508451.json:
```json
{
    "body": "Attachment: **[dev_test.f90.gz](https://github.com/sagemath/sage/files/ticket31621/dev_test.f90.gz)**\n\ntest Fortran program",
    "created_at": "2021-10-17T21:17:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508451",
    "user": "https://github.com/dimpase"
}
```

Attachment: **[dev_test.f90.gz](https://github.com/sagemath/sage/files/ticket31621/dev_test.f90.gz)**

test Fortran program



---

archive/issue_comments_508452.json:
```json
{
    "body": "the failing example (spectrum of the adj. matrix of 100-vertex Higman-Sims graph)",
    "created_at": "2021-10-17T21:19:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508452",
    "user": "https://github.com/dimpase"
}
```

the failing example (spectrum of the adj. matrix of 100-vertex Higman-Sims graph)



---

archive/issue_comments_508453.json:
```json
{
    "body": "Attachment: **[HigmanSims.tst.gz](https://github.com/sagemath/sage/files/ticket31621/HigmanSims.tst.gz)**\n\nsmaller example (from Petersen graph)",
    "created_at": "2021-10-17T21:19:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508453",
    "user": "https://github.com/dimpase"
}
```

Attachment: **[HigmanSims.tst.gz](https://github.com/sagemath/sage/files/ticket31621/HigmanSims.tst.gz)**

smaller example (from Petersen graph)



---

archive/issue_comments_508454.json:
```json
{
    "body": "Attachment: **[petersen.tst.gz](https://github.com/sagemath/sage/files/ticket31621/petersen.tst.gz)**\n\nscript to compute test data",
    "created_at": "2021-10-17T21:20:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508454",
    "user": "https://github.com/dimpase"
}
```

Attachment: **[petersen.tst.gz](https://github.com/sagemath/sage/files/ticket31621/petersen.tst.gz)**

script to compute test data



---

archive/issue_comments_508455.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nAttachment: **[graphdata.sage.gz](https://github.com/sagemath/sage/files/ticket31621/graphdata.sage.gz)**\n\nI've uploaded an attempted test of OpenBLAS. Download the attachments and\n\n```\ngfortran dev_test.f90 -lopenblas\n./a.out <HigmanSims.tst\n```\n\nThe last line of the output should say `max. deviation of eigenvals: <small number>`, where `<small number>` is smaller than 10<sup>-13</sup> or so if all is good.\n \n(there is another, smaller, example, too, petersen.tst)\n\n\nPlease note I'm not sure I used exactly the same LAPACK function as in Sage failing test - there is one more function to try, `DSYEVR` if this one, `DSYEV`, would just work.",
    "created_at": "2021-10-17T21:28:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508455",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:15" align="right">comment:15</div>

Attachment: **[graphdata.sage.gz](https://github.com/sagemath/sage/files/ticket31621/graphdata.sage.gz)**

I've uploaded an attempted test of OpenBLAS. Download the attachments and

```
gfortran dev_test.f90 -lopenblas
./a.out <HigmanSims.tst
```

The last line of the output should say `max. deviation of eigenvals: <small number>`, where `<small number>` is smaller than 10<sup>-13</sup> or so if all is good.
 
(there is another, smaller, example, too, petersen.tst)


Please note I'm not sure I used exactly the same LAPACK function as in Sage failing test - there is one more function to try, `DSYEVR` if this one, `DSYEV`, would just work.



---

archive/issue_comments_508456.json:
```json
{
    "body": "Attachment: **[dev_test_dsyevr.f90.gz](https://github.com/sagemath/sage/files/ticket31621/dev_test_dsyevr.f90.gz)**\n\ntest using LAPACK's dsyevr call",
    "created_at": "2021-10-18T10:54:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508456",
    "user": "https://github.com/dimpase"
}
```

Attachment: **[dev_test_dsyevr.f90.gz](https://github.com/sagemath/sage/files/ticket31621/dev_test_dsyevr.f90.gz)**

test using LAPACK's dsyevr call



---

archive/issue_comments_508457.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nplease also try the latter attachment (same instructions, different file name,  `dev_test_dsyevr.f90`",
    "created_at": "2021-10-18T10:55:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508457",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:16" align="right">comment:16</div>

please also try the latter attachment (same instructions, different file name,  `dev_test_dsyevr.f90`



---

archive/issue_comments_508458.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@videlec](#comment:14):\n\n> Dima, even a standalone test with scipy would be already good enough. I would like to check if the Debian package is completely broken or simply used wrongly within sage. In both cases, it might be known from Debian developers.\n\nhere is a direct scipy test via Sage:\n\n```\nsage: import numpy as np\nsage: import scipy\nsage: import scipy.linalg\nsage: g=graphs.HigmanSimsGraph()\nsage: a=np.matrix(g.adjacency_matrix())\nsage: eig=scipy.linalg.lapack.dsyevr(a); eig[0]\narray([-8., -8., -8., -8., -8., -8., -8., -8., -8., -8., -8., -8., -8.,\n       -8., -8., -8., -8., -8., -8., -8., -8., -8.,  2.,  2.,  2.,  2.,\n        2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,\n        2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,\n        2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,\n        2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,\n        2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,\n        2.,  2.,  2.,  2.,  2.,  2.,  2.,  2., 22.])\n```",
    "created_at": "2021-10-18T14:27:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508458",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@videlec](#comment:14):

> Dima, even a standalone test with scipy would be already good enough. I would like to check if the Debian package is completely broken or simply used wrongly within sage. In both cases, it might be known from Debian developers.

here is a direct scipy test via Sage:

```
sage: import numpy as np
sage: import scipy
sage: import scipy.linalg
sage: g=graphs.HigmanSimsGraph()
sage: a=np.matrix(g.adjacency_matrix())
sage: eig=scipy.linalg.lapack.dsyevr(a); eig[0]
array([-8., -8., -8., -8., -8., -8., -8., -8., -8., -8., -8., -8., -8.,
       -8., -8., -8., -8., -8., -8., -8., -8., -8.,  2.,  2.,  2.,  2.,
        2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,
        2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,
        2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,
        2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,
        2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,  2.,
        2.,  2.,  2.,  2.,  2.,  2.,  2.,  2., 22.])
```



---

archive/issue_comments_508459.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@dimpase](#comment:11):\n> John, do you see on macOS the error reported by Vincent?\n> \n> ```\n> File \"src/sage/matrix/matrix_double_dense.pyx\", line 1365, in\n> sage.matrix.matrix_double_dense.Matrix_double_dense.?\n> Failed example:\n>      A.eigenvalues(algorithm='symmetric', tol=1.0e-5)  # tol 2e-15\n> Expected:\n>      [(-8.0, 22), (2.0, 77), (22.0, 1)]\n> Got:\n>      [(-13.81753974166025, 1),\n> ...\n> ```\n\nYes, I see this failure. This is with an un-updated version of OpenBLAS: 0.3.17 from 2021-09-23 according to `brew info openblas`. I will try upgrading.",
    "created_at": "2021-10-18T17:48:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508459",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@dimpase](#comment:11):
> John, do you see on macOS the error reported by Vincent?
> 
> ```
> File "src/sage/matrix/matrix_double_dense.pyx", line 1365, in
> sage.matrix.matrix_double_dense.Matrix_double_dense.?
> Failed example:
>      A.eigenvalues(algorithm='symmetric', tol=1.0e-5)  # tol 2e-15
> Expected:
>      [(-8.0, 22), (2.0, 77), (22.0, 1)]
> Got:
>      [(-13.81753974166025, 1),
> ...
> ```

Yes, I see this failure. This is with an un-updated version of OpenBLAS: 0.3.17 from 2021-09-23 according to `brew info openblas`. I will try upgrading.



---

archive/issue_comments_508460.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nI can't use the standalone test because I get `ld: library not found for -lopenblas`.",
    "created_at": "2021-10-18T17:50:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508460",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:19" align="right">comment:19</div>

I can't use the standalone test because I get `ld: library not found for -lopenblas`.



---

archive/issue_comments_508461.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [@jhpalmieri](#comment:19):\n> I can't use the standalone test because I get `ld: library not found for -lopenblas`.\n\nYou'd need `-L` flag:\n\n```\ngfortran <...>.f90 -L/usr/local/opt/openblas/lib -lopenblas\n```",
    "created_at": "2021-10-18T18:29:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508461",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [@jhpalmieri](#comment:19):
> I can't use the standalone test because I get `ld: library not found for -lopenblas`.

You'd need `-L` flag:

```
gfortran <...>.f90 -L/usr/local/opt/openblas/lib -lopenblas
```



---

archive/issue_comments_508462.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nThanks. When I run `./a.out <HigmanSims.tst`, the last line is the same with either test program: `max. deviation of eigenvals:    1.2878587085651816E-014`.",
    "created_at": "2021-10-18T18:57:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508462",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:21" align="right">comment:21</div>

Thanks. When I run `./a.out <HigmanSims.tst`, the last line is the same with either test program: `max. deviation of eigenvals:    1.2878587085651816E-014`.



---

archive/issue_comments_508463.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nWith `petersen.tst` I get `max. deviation of eigenvals:    8.8817841970012523E-016`.",
    "created_at": "2021-10-18T18:57:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508463",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:22" align="right">comment:22</div>

With `petersen.tst` I get `max. deviation of eigenvals:    8.8817841970012523E-016`.



---

archive/issue_comments_508464.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nOn the other hand, when I run the example in Sage in [comment:17](#comment:17), I get\n\n```\narray([-9.51662688, -9.01957761, -8.82571413, -8.53509523, -8.45449832,\n       -8.19421094, -8.06706488, -8.        , -8.        , -8.        ,\n       -8.        , -8.        , -8.        , -8.        , -8.        ,\n       -8.        , -8.        , -7.92742484, -7.63275394, -7.25448498,\n       -7.06795155, -6.90611622, -6.64469129, -6.54715317, -5.4872644 ,\n       -5.29660049, -4.69884647, -4.33752666, -4.30959029, -3.75213367,\n       -3.57502391, -2.92795773, -2.58101222, -2.57098415, -2.53138416,\n       -2.27048023, -2.16406448, -1.80261557, -1.75557973, -1.59188765,\n       -1.41796672, -1.35756654, -1.13476674, -0.92256797, -0.65109354,\n       -0.49437488, -0.27070739, -0.07512487,  0.17239949,  0.4835247 ,\n        0.54260365,  0.67677662,  1.03820124,  1.12679921,  1.41540993,\n        1.65236118,  1.75100574,  1.86305818,  1.99997232,  2.        ,\n        2.        ,  2.        ,  2.        ,  2.        ,  2.        ,\n        2.        ,  2.        ,  2.        ,  2.        ,  2.01296242,\n        2.23534418,  2.37464655,  2.50556135,  2.69055392,  2.73682618,\n        3.00360424,  3.18959084,  3.33877411,  3.4352485 ,  3.60531369,\n        3.74100246,  3.88461972,  3.98561053,  4.12222078,  4.2778004 ,\n        4.42940272,  4.49540354,  4.52975646,  4.83264503,  4.90738351,\n        5.1034719 ,  5.17889141,  5.6570698 ,  5.75157547,  6.26235796,\n        6.26836517,  7.08899349,  7.30672858,  8.74786038, 22.        ])\n```",
    "created_at": "2021-10-18T18:58:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508464",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:23" align="right">comment:23</div>

On the other hand, when I run the example in Sage in [comment:17](#comment:17), I get

```
array([-9.51662688, -9.01957761, -8.82571413, -8.53509523, -8.45449832,
       -8.19421094, -8.06706488, -8.        , -8.        , -8.        ,
       -8.        , -8.        , -8.        , -8.        , -8.        ,
       -8.        , -8.        , -7.92742484, -7.63275394, -7.25448498,
       -7.06795155, -6.90611622, -6.64469129, -6.54715317, -5.4872644 ,
       -5.29660049, -4.69884647, -4.33752666, -4.30959029, -3.75213367,
       -3.57502391, -2.92795773, -2.58101222, -2.57098415, -2.53138416,
       -2.27048023, -2.16406448, -1.80261557, -1.75557973, -1.59188765,
       -1.41796672, -1.35756654, -1.13476674, -0.92256797, -0.65109354,
       -0.49437488, -0.27070739, -0.07512487,  0.17239949,  0.4835247 ,
        0.54260365,  0.67677662,  1.03820124,  1.12679921,  1.41540993,
        1.65236118,  1.75100574,  1.86305818,  1.99997232,  2.        ,
        2.        ,  2.        ,  2.        ,  2.        ,  2.        ,
        2.        ,  2.        ,  2.        ,  2.        ,  2.01296242,
        2.23534418,  2.37464655,  2.50556135,  2.69055392,  2.73682618,
        3.00360424,  3.18959084,  3.33877411,  3.4352485 ,  3.60531369,
        3.74100246,  3.88461972,  3.98561053,  4.12222078,  4.2778004 ,
        4.42940272,  4.49540354,  4.52975646,  4.83264503,  4.90738351,
        5.1034719 ,  5.17889141,  5.6570698 ,  5.75157547,  6.26235796,
        6.26836517,  7.08899349,  7.30672858,  8.74786038, 22.        ])
```



---

archive/issue_comments_508465.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nReplying to [@jhpalmieri](#comment:21):\n> Thanks. When I run `./a.out <HigmanSims.tst`, the last line is the same with either test program: `max. deviation of eigenvals:    1.2878587085651816E-014`.\n\nWhich Fortran program do you compile? Please try  `dev_test_dsyevr.f90` if you did not.",
    "created_at": "2021-10-18T19:11:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508465",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:24" align="right">comment:24</div>

Replying to [@jhpalmieri](#comment:21):
> Thanks. When I run `./a.out <HigmanSims.tst`, the last line is the same with either test program: `max. deviation of eigenvals:    1.2878587085651816E-014`.

Which Fortran program do you compile? Please try  `dev_test_dsyevr.f90` if you did not.



---

archive/issue_comments_508466.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nReplying to [@dimpase](#comment:24):\n> Replying to [@jhpalmieri](#comment:21):\n> > Thanks. When I run `./a.out <HigmanSims.tst`, the last line is the same with either test program: `max. deviation of eigenvals:    1.2878587085651816E-014`.\n\n> \n> Which Fortran program do you compile? Please try  `dev_test_dsyevr.f90` if you did not.\n\nI tried both (that's what I meant by \"either test program\").",
    "created_at": "2021-10-18T19:13:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508466",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:25" align="right">comment:25</div>

Replying to [@dimpase](#comment:24):
> Replying to [@jhpalmieri](#comment:21):
> > Thanks. When I run `./a.out <HigmanSims.tst`, the last line is the same with either test program: `max. deviation of eigenvals:    1.2878587085651816E-014`.

> 
> Which Fortran program do you compile? Please try  `dev_test_dsyevr.f90` if you did not.

I tried both (that's what I meant by "either test program").



---

archive/issue_comments_508467.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nok, so the next step would be to try the \"normal\" scipy run. That is, you can print `a` to a file, and then start `./sage --python`, read `a` in, and then run all the other lines in [comment:17](#comment:17).",
    "created_at": "2021-10-18T19:32:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508467",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:26" align="right">comment:26</div>

ok, so the next step would be to try the "normal" scipy run. That is, you can print `a` to a file, and then start `./sage --python`, read `a` in, and then run all the other lines in [comment:17](#comment:17).



---

archive/issue_comments_508468.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nand if the latter still returns incorrect results, I'd try a standalone scipy, built from source using openblas from homebrew.",
    "created_at": "2021-10-18T19:38:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508468",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:27" align="right">comment:27</div>

and if the latter still returns incorrect results, I'd try a standalone scipy, built from source using openblas from homebrew.



---

archive/issue_comments_508469.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nReplying to [@dimpase](#comment:26):\n> ok, so the next step would be to try the \"normal\" scipy run. That is, you can print `a` to a file, and then start `./sage --python`, read `a` in, and then run all the other lines in [comment:17](#comment:17).\n> \n\none quick way to do this is the following:\n\n```\nsage: import numpy as np\nsage: g=graphs.HigmanSimsGraph()\nsage: a=np.matrix(g.adjacency_matrix())\nsage: np.save('/tmp/x',a)\n```\nnow we have `a` in `/tmp/x.npy`. So start \n\n```\n./sage --python\n``` \nand at its `>>>` prompt do\n\n```\nimport numpy as np\na=np.load('/tmp/x.npy')\nimport scipy\nimport scipy.linalg\neig=scipy.linalg.lapack.dsyevr(a); eig[0]\n```",
    "created_at": "2021-10-18T20:01:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508469",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:28" align="right">comment:28</div>

Replying to [@dimpase](#comment:26):
> ok, so the next step would be to try the "normal" scipy run. That is, you can print `a` to a file, and then start `./sage --python`, read `a` in, and then run all the other lines in [comment:17](#comment:17).
> 

one quick way to do this is the following:

```
sage: import numpy as np
sage: g=graphs.HigmanSimsGraph()
sage: a=np.matrix(g.adjacency_matrix())
sage: np.save('/tmp/x',a)
```
now we have `a` in `/tmp/x.npy`. So start 

```
./sage --python
``` 
and at its `>>>` prompt do

```
import numpy as np
a=np.load('/tmp/x.npy')
import scipy
import scipy.linalg
eig=scipy.linalg.lapack.dsyevr(a); eig[0]
```



---

archive/issue_comments_508470.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nNeedless to say, it's a good idea to check that `/tmp/x.npy` is correct, so copying it on a machine where Sage is not broken and testing it as above might be good idea.",
    "created_at": "2021-10-18T20:03:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508470",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:29" align="right">comment:29</div>

Needless to say, it's a good idea to check that `/tmp/x.npy` is correct, so copying it on a machine where Sage is not broken and testing it as above might be good idea.



---

archive/issue_comments_508471.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\n> Replying to [@dimpase](#comment:27):\n> and if the latter still returns incorrect results, I'd try a standalone scipy, built from source using openblas from homebrew.\n\nThis gives correct results (although I wrote the matrix `g.adjacency_matrix()` to a file and then read it back in and fed it into `np.matrix(...)`).",
    "created_at": "2021-10-18T20:07:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508471",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:30" align="right">comment:30</div>

> Replying to [@dimpase](#comment:27):
> and if the latter still returns incorrect results, I'd try a standalone scipy, built from source using openblas from homebrew.

This gives correct results (although I wrote the matrix `g.adjacency_matrix()` to a file and then read it back in and fed it into `np.matrix(...)`).



---

archive/issue_comments_508472.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nSo it's not OpenBLAS or SciPy themselves, right?\nSomething else in Sage upsets OpenBLAS (and only OpenBLAS from numpy, right?) on this particular CPU.",
    "created_at": "2021-10-18T20:19:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508472",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:31" align="right">comment:31</div>

So it's not OpenBLAS or SciPy themselves, right?
Something else in Sage upsets OpenBLAS (and only OpenBLAS from numpy, right?) on this particular CPU.



---

archive/issue_comments_508473.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nFor what it's worth, I dumped `a` to a file using `np.save(FILE, a)`. Then I loaded it and ran the above list of commands.\n\n- works just fine with `./sage --python`\n- produces the wrong answer with `./sage`",
    "created_at": "2021-10-18T21:14:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508473",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:32" align="right">comment:32</div>

For what it's worth, I dumped `a` to a file using `np.save(FILE, a)`. Then I loaded it and ran the above list of commands.

- works just fine with `./sage --python`
- produces the wrong answer with `./sage`



---

archive/issue_comments_508474.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nAnd naturally it works fine if I use a version of Sage built with `./configure --with-system-openblas=no`.",
    "created_at": "2021-10-18T21:21:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508474",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:33" align="right">comment:33</div>

And naturally it works fine if I use a version of Sage built with `./configure --with-system-openblas=no`.



---

archive/issue_comments_508475.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nCould `gsl` be involved somehow, rather than `openblas`?",
    "created_at": "2021-10-18T21:22:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508475",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:34" align="right">comment:34</div>

Could `gsl` be involved somehow, rather than `openblas`?



---

archive/issue_comments_508476.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nIt need not be something even dependent on openblas that creates this weird CPU state. It could be something using AVX-512, or OpenMP.\n\nUnfortunately Sage isn't modularised enough so that one could just load parts one by one, and check if the bug appears.",
    "created_at": "2021-10-18T21:47:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508476",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:35" align="right">comment:35</div>

It need not be something even dependent on openblas that creates this weird CPU state. It could be something using AVX-512, or OpenMP.

Unfortunately Sage isn't modularised enough so that one could just load parts one by one, and check if the bug appears.



---

archive/issue_comments_508477.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nI built Sage with\n\n```\nexport CFLAGS=\"-L/usr/local/opt/openblas/lib\"\n./configure --with-system-gsl=no\n```\nand I am not seeing the errors. This is using homebrew's `openblas`.",
    "created_at": "2021-10-18T22:17:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508477",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:36" align="right">comment:36</div>

I built Sage with

```
export CFLAGS="-L/usr/local/opt/openblas/lib"
./configure --with-system-gsl=no
```
and I am not seeing the errors. This is using homebrew's `openblas`.



---

archive/issue_comments_508478.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nInteresting. First, it's a bug either in spkg-install of GSL, as it demands that `cblas` is known to `pkg-config`, which is not the case here - it can get the same from `openblas`, or somewhere in our hacky procedure of creating .pc files from the one for `openblas`.\n\nSecond, Sage is still on GSL 2.6, but Homebrew is on GSL 2.7.\nThere is #32607 - which supposed to be fixing something GSL 2.7-related (but I am happily running GSL 2.7 on Linux with Sage...)\n\nMatthias has tickets to make GSL optional.",
    "created_at": "2021-10-18T22:40:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508478",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:37" align="right">comment:37</div>

Interesting. First, it's a bug either in spkg-install of GSL, as it demands that `cblas` is known to `pkg-config`, which is not the case here - it can get the same from `openblas`, or somewhere in our hacky procedure of creating .pc files from the one for `openblas`.

Second, Sage is still on GSL 2.6, but Homebrew is on GSL 2.7.
There is #32607 - which supposed to be fixing something GSL 2.7-related (but I am happily running GSL 2.7 on Linux with Sage...)

Matthias has tickets to make GSL optional.



---

archive/issue_comments_508479.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nRegarding the 1st issue: if you fire up `./sage --buildsh`, and at its prompt, run\n`pkg-config --libs cblas`, what's the output?\n\nI suspect that \n\n```\nsdh_configure LIBS=\"`pkg-config --libs-only-l cblas` -lm\"\n```\nin GSL's spkg-install.in should be\n\n```\nsdh_configure LIBS=\"`pkg-config --libs cblas` -lm\"\n```\n\n(`--libs-only-l` doesn't print `-L` flags.)\n\nCan you try the latter line without `CFLAGS` ?",
    "created_at": "2021-10-18T22:46:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508479",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:38" align="right">comment:38</div>

Regarding the 1st issue: if you fire up `./sage --buildsh`, and at its prompt, run
`pkg-config --libs cblas`, what's the output?

I suspect that 

```
sdh_configure LIBS="`pkg-config --libs-only-l cblas` -lm"
```
in GSL's spkg-install.in should be

```
sdh_configure LIBS="`pkg-config --libs cblas` -lm"
```

(`--libs-only-l` doesn't print `-L` flags.)

Can you try the latter line without `CFLAGS` ?



---

archive/issue_comments_508480.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nShould `pkgconf` be a dependency for `gsl`?",
    "created_at": "2021-10-18T22:51:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508480",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:39" align="right">comment:39</div>

Should `pkgconf` be a dependency for `gsl`?



---

archive/issue_comments_508481.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nReplying to [@dimpase](#comment:38):\n> Regarding the 1st issue: if you fire up `./sage --buildsh`, and at its prompt, run\n> `pkg-config --libs cblas`, what's the output?\n\n\n```\n-L/usr/local/Cellar/openblas/0.3.18/lib -lopenblas\n```\n> \n> I suspect that \n> \n> ```\n> sdh_configure LIBS=\"`pkg-config --libs-only-l cblas` -lm\"\n> ```\n> in GSL's spkg-install.in should be\n> \n> ```\n> sdh_configure LIBS=\"`pkg-config --libs cblas` -lm\"\n> ```\n> \n> (`--libs-only-l` doesn't print `-L` flags.)\n> \n> Can you try the latter line without `CFLAGS` ?\n\nWill do.",
    "created_at": "2021-10-18T22:52:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508481",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:40" align="right">comment:40</div>

Replying to [@dimpase](#comment:38):
> Regarding the 1st issue: if you fire up `./sage --buildsh`, and at its prompt, run
> `pkg-config --libs cblas`, what's the output?


```
-L/usr/local/Cellar/openblas/0.3.18/lib -lopenblas
```
> 
> I suspect that 
> 
> ```
> sdh_configure LIBS="`pkg-config --libs-only-l cblas` -lm"
> ```
> in GSL's spkg-install.in should be
> 
> ```
> sdh_configure LIBS="`pkg-config --libs cblas` -lm"
> ```
> 
> (`--libs-only-l` doesn't print `-L` flags.)
> 
> Can you try the latter line without `CFLAGS` ?

Will do.



---

archive/issue_comments_508482.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\nAs noted in #32587, GSL 2.7 may be built with an option to use old API. This does not happen on Homebrew, see https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/gsl.rb\n\nHowever, on Debian Bullseye GSL is still version 2.6, so perhaps\nit's not the version alone that's reponsible.\nhttps://packages.debian.org/source/stable/gsl\n\n---\n\nVincent, could you check the GSL version you're using, and build Sage with system OpenBLAS, but\nwithout GSL, just as John did here?",
    "created_at": "2021-10-19T07:35:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508482",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:41" align="right">comment:41</div>

As noted in #32587, GSL 2.7 may be built with an option to use old API. This does not happen on Homebrew, see https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/gsl.rb

However, on Debian Bullseye GSL is still version 2.6, so perhaps
it's not the version alone that's reponsible.
https://packages.debian.org/source/stable/gsl

---

Vincent, could you check the GSL version you're using, and build Sage with system OpenBLAS, but
without GSL, just as John did here?



---

archive/issue_comments_508483.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nReplying to [@jhpalmieri](#comment:40):\n> Replying to [@dimpase](#comment:38):\n> > Regarding the 1st issue: if you fire up `./sage --buildsh`, and at its prompt, run\n> > `pkg-config --libs cblas`, what's the output?\n\n> \n> ```\n> -L/usr/local/Cellar/openblas/0.3.18/lib -lopenblas\n> ```\n> > \n> > I suspect that \n> > \n> > ```\n> > sdh_configure LIBS=\"`pkg-config --libs-only-l cblas` -lm\"\n> > ```\n> > in GSL's spkg-install.in should be\n> > \n> > ```\n> > sdh_configure LIBS=\"`pkg-config --libs cblas` -lm\"\n> > ```\n> > \n> > (`--libs-only-l` doesn't print `-L` flags.)\n> > \n> > Can you try the latter line without `CFLAGS` ?\n\n> \n> Will do.\n\nPerhaps one should leave that LIBS settings alone, and add LDFLAGS (it's weird that CFLAGS worked for you!) as follows:\n\n```\nsdh_configure LIBS=\"`pkg-config --libs-only-l cblas` -lm\" LDFLAGS=\"$LDFLAGS `pkg-config --libs-only-L cblas`\"\n```",
    "created_at": "2021-10-19T15:27:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508483",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:42" align="right">comment:42</div>

Replying to [@jhpalmieri](#comment:40):
> Replying to [@dimpase](#comment:38):
> > Regarding the 1st issue: if you fire up `./sage --buildsh`, and at its prompt, run
> > `pkg-config --libs cblas`, what's the output?

> 
> ```
> -L/usr/local/Cellar/openblas/0.3.18/lib -lopenblas
> ```
> > 
> > I suspect that 
> > 
> > ```
> > sdh_configure LIBS="`pkg-config --libs-only-l cblas` -lm"
> > ```
> > in GSL's spkg-install.in should be
> > 
> > ```
> > sdh_configure LIBS="`pkg-config --libs cblas` -lm"
> > ```
> > 
> > (`--libs-only-l` doesn't print `-L` flags.)
> > 
> > Can you try the latter line without `CFLAGS` ?

> 
> Will do.

Perhaps one should leave that LIBS settings alone, and add LDFLAGS (it's weird that CFLAGS worked for you!) as follows:

```
sdh_configure LIBS="`pkg-config --libs-only-l cblas` -lm" LDFLAGS="$LDFLAGS `pkg-config --libs-only-L cblas`"
```



---

archive/issue_comments_508484.json:
```json
{
    "body": "<div id=\"comment:43\" align=\"right\">comment:43</div>\n\nReplying to [@dimpase](#comment:42):\n> Perhaps one should leave that LIBS settings alone, and add LDFLAGS (it's weird that CFLAGS worked for you!) as follows:\n> \n> ```\n> sdh_configure LIBS=\"`pkg-config --libs-only-l cblas` -lm\" LDFLAGS=\"$LDFLAGS `pkg-config --libs-only-L cblas`\"\n> ``` \n\n`gsl` builds but the `sagelib` package fails to build this way: `ld: library not found for -lopenblas`.",
    "created_at": "2021-10-19T16:51:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508484",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:43" align="right">comment:43</div>

Replying to [@dimpase](#comment:42):
> Perhaps one should leave that LIBS settings alone, and add LDFLAGS (it's weird that CFLAGS worked for you!) as follows:
> 
> ```
> sdh_configure LIBS="`pkg-config --libs-only-l cblas` -lm" LDFLAGS="$LDFLAGS `pkg-config --libs-only-L cblas`"
> ``` 

`gsl` builds but the `sagelib` package fails to build this way: `ld: library not found for -lopenblas`.



---

archive/issue_comments_508485.json:
```json
{
    "body": "<div id=\"comment:44\" align=\"right\">comment:44</div>\n\nhow about \n\n```diff\n--- a/.homebrew-build-env\n+++ b/.homebrew-build-env\n@@ -23,7 +23,7 @@ export PKG_CONFIG_PATH\n LIBRARY_PATH=\"$HOMEBREW/lib$LIBRARY_PATH\"\n [ -z \"$CPATH\" ] || CPATH=\":${CPATH}\"\n CPATH=\"$HOMEBREW/include$CPATH\"\n-for l in readline bzip2 ntl; do\n+for l in readline bzip2 ntl openblas; do\n     if [ -d \"$HOMEBREW/opt/$l/lib\" ]; then\n         LIBRARY_PATH=\"$HOMEBREW/opt/$l/lib:$LIBRARY_PATH\"\n     fi\n```\ni.e. change `.homebrew-build-env` as above, source it, and then run `make build` again.",
    "created_at": "2021-10-19T16:59:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508485",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:44" align="right">comment:44</div>

how about 

```diff
--- a/.homebrew-build-env
+++ b/.homebrew-build-env
@@ -23,7 +23,7 @@ export PKG_CONFIG_PATH
 LIBRARY_PATH="$HOMEBREW/lib$LIBRARY_PATH"
 [ -z "$CPATH" ] || CPATH=":${CPATH}"
 CPATH="$HOMEBREW/include$CPATH"
-for l in readline bzip2 ntl; do
+for l in readline bzip2 ntl openblas; do
     if [ -d "$HOMEBREW/opt/$l/lib" ]; then
         LIBRARY_PATH="$HOMEBREW/opt/$l/lib:$LIBRARY_PATH"
     fi
```
i.e. change `.homebrew-build-env` as above, source it, and then run `make build` again.



---

archive/issue_comments_508486.json:
```json
{
    "body": "<div id=\"comment:45\" align=\"right\">comment:45</div>\n\nI'm really confused now.\n\n- With the changes you suggested in [comment:42](#comment:42) and [comment:44](#comment:44) (set LDFLAGS and modify `.homebrew-build-env`), Sage builds, but the example in [comment:17](#comment:17) fails and I see the numerical failures in doctesting.\n- If instead I build Sage as in [comment:36](#comment:36) (exporting `CFLAGS`), then Sage builds (although with warnings \"clang: warning: argument unused during compilation: '-L/usr/local/opt/openblas/lib' [-Wunused-command-line-argument]\") and the example in [comment:17](#comment:17) works. `./sage -tp --long src/sage/matrix` succeeds: no numerical failures.",
    "created_at": "2021-10-19T18:59:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508486",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:45" align="right">comment:45</div>

I'm really confused now.

- With the changes you suggested in [comment:42](#comment:42) and [comment:44](#comment:44) (set LDFLAGS and modify `.homebrew-build-env`), Sage builds, but the example in [comment:17](#comment:17) fails and I see the numerical failures in doctesting.
- If instead I build Sage as in [comment:36](#comment:36) (exporting `CFLAGS`), then Sage builds (although with warnings "clang: warning: argument unused during compilation: '-L/usr/local/opt/openblas/lib' [-Wunused-command-line-argument]") and the example in [comment:17](#comment:17) works. `./sage -tp --long src/sage/matrix` succeeds: no numerical failures.



---

archive/issue_comments_508487.json:
```json
{
    "body": "<div id=\"comment:46\" align=\"right\">comment:46</div>\n\nprobably \"success\" with gsl comes from it not using openblas at all. You can check by running `otool -L `",
    "created_at": "2021-10-19T20:15:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508487",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:46" align="right">comment:46</div>

probably "success" with gsl comes from it not using openblas at all. You can check by running `otool -L `



---

archive/issue_comments_508488.json:
```json
{
    "body": "<div id=\"comment:47\" align=\"right\">comment:47</div>\n\n`% otool -L local/lib/libgsl.25.dylib` returns the same thing in each of the two cases (edited to replace the actual path with `$SAGE_ROOT`):\n\n```\n% otool -L local/lib/libgsl.25.dylib \nlocal/lib/libgsl.25.dylib:\n\t$SAGE_ROOT/local/lib/libgsl.25.dylib (compatibility version 26.0.0, current version 26.0.0)\n\t/usr/local/opt/openblas/lib/libopenblas.0.dylib (compatibility version 0.0.0, current version 0.0.0)\n\t/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1292.100.5)\n```",
    "created_at": "2021-10-19T21:00:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508488",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:47" align="right">comment:47</div>

`% otool -L local/lib/libgsl.25.dylib` returns the same thing in each of the two cases (edited to replace the actual path with `$SAGE_ROOT`):

```
% otool -L local/lib/libgsl.25.dylib 
local/lib/libgsl.25.dylib:
	$SAGE_ROOT/local/lib/libgsl.25.dylib (compatibility version 26.0.0, current version 26.0.0)
	/usr/local/opt/openblas/lib/libopenblas.0.dylib (compatibility version 0.0.0, current version 0.0.0)
	/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1292.100.5)
```



---

archive/issue_comments_508489.json:
```json
{
    "body": "<div id=\"comment:48\" align=\"right\">comment:48</div>\n\nSame with `otool -L local/lib/libgslcblas.0.dylib`.",
    "created_at": "2021-10-19T21:01:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508489",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:48" align="right">comment:48</div>

Same with `otool -L local/lib/libgslcblas.0.dylib`.



---

archive/issue_comments_508490.json:
```json
{
    "body": "<div id=\"comment:49\" align=\"right\">comment:49</div>\n\nI can only say that exporting `-L` flag in CFLAGS makes little sense to me.\nI'd like to see GSLs config.log when it's set, and when it's not (as in [comment:6](#comment:6) are you sure your CFLAGS didn't contain something wrong then?).",
    "created_at": "2021-10-19T21:52:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508490",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:49" align="right">comment:49</div>

I can only say that exporting `-L` flag in CFLAGS makes little sense to me.
I'd like to see GSLs config.log when it's set, and when it's not (as in [comment:6](#comment:6) are you sure your CFLAGS didn't contain something wrong then?).



---

archive/issue_comments_508491.json:
```json
{
    "body": "<div id=\"comment:50\" align=\"right\">comment:50</div>\n\n\n```\n% echo $CFLAGS\n-L/usr/local/opt/openblas/lib\n```\nBut this causes other changes in the Sage build: when I set `CFLAGS` manually, then Sage does not add `-O2 -g -march=native`. Maybe one of those flags makes a difference. I'll try to test it out.",
    "created_at": "2021-10-19T22:36:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508491",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:50" align="right">comment:50</div>


```
% echo $CFLAGS
-L/usr/local/opt/openblas/lib
```
But this causes other changes in the Sage build: when I set `CFLAGS` manually, then Sage does not add `-O2 -g -march=native`. Maybe one of those flags makes a difference. I'll try to test it out.



---

archive/issue_comments_508492.json:
```json
{
    "body": "Attachment: **[gsl-2.6.log.CFLAGS.gz](https://github.com/sagemath/sage/files/ticket31621/gsl-2.6.log.CFLAGS.gz)**",
    "created_at": "2021-10-19T22:36:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508492",
    "user": "https://github.com/jhpalmieri"
}
```

Attachment: **[gsl-2.6.log.CFLAGS.gz](https://github.com/sagemath/sage/files/ticket31621/gsl-2.6.log.CFLAGS.gz)**



---

archive/issue_comments_508493.json:
```json
{
    "body": "<div id=\"comment:51\" align=\"right\">comment:51</div>\n\nAttachment: **[gsl-2.6.log.do-not-set-CFLAGS.gz](https://github.com/sagemath/sage/files/ticket31621/gsl-2.6.log.do-not-set-CFLAGS.gz)**\n\nI guess it's `-march=native` to blame for this. Overwriting `CFLAGS` to exclude it for `gsl` makes a difference (see  #27122), and we saw this a number of times lately in regard of `openblas`. Not all Xeon CPUs are created equal. :/",
    "created_at": "2021-10-20T09:41:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508493",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:51" align="right">comment:51</div>

Attachment: **[gsl-2.6.log.do-not-set-CFLAGS.gz](https://github.com/sagemath/sage/files/ticket31621/gsl-2.6.log.do-not-set-CFLAGS.gz)**

I guess it's `-march=native` to blame for this. Overwriting `CFLAGS` to exclude it for `gsl` makes a difference (see  #27122), and we saw this a number of times lately in regard of `openblas`. Not all Xeon CPUs are created equal. :/



---

archive/issue_comments_508494.json:
```json
{
    "body": "<div id=\"comment:52\" align=\"right\">comment:52</div>\n\nAfter a `make openblas` sage fails to start with\n\n```\n~/sage/local/lib/python3.9/site-packages/sage/matrix/matrix_space.py in <module>\n     42 \n---> 43 from . import matrix_modn_sparse\n        global matrix_modn_sparse = undefined\n     44\n\nImportError: /lib/x86_64-linux-gnu/libblas.so.3: undefined symbol: gotoblas\n```\nI thought that this would have solved my problem but instead created another one.",
    "created_at": "2021-10-20T17:55:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508494",
    "user": "https://github.com/videlec"
}
```

<div id="comment:52" align="right">comment:52</div>

After a `make openblas` sage fails to start with

```
~/sage/local/lib/python3.9/site-packages/sage/matrix/matrix_space.py in <module>
     42 
---> 43 from . import matrix_modn_sparse
        global matrix_modn_sparse = undefined
     44

ImportError: /lib/x86_64-linux-gnu/libblas.so.3: undefined symbol: gotoblas
```
I thought that this would have solved my problem but instead created another one.



---

archive/issue_comments_508495.json:
```json
{
    "body": "<div id=\"comment:53\" align=\"right\">comment:53</div>\n\nhave you rebuilt sagelib?\n\n```\nmake sagelib-clean && make build\n```",
    "created_at": "2021-10-20T19:26:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508495",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:53" align="right">comment:53</div>

have you rebuilt sagelib?

```
make sagelib-clean && make build
```



---

archive/issue_comments_508496.json:
```json
{
    "body": "<div id=\"comment:54\" align=\"right\">comment:54</div>\n\nSeparately from the other issues, should we change gsl's `spkg-install.in` to use\n\n```\nsdh_configure LIBS=\"`pkg-config --libs-only-l cblas` -lm\" LDFLAGS=\"$LDFLAGS `pkg-config --libs-only-L cblas`\"\n```\nas suggested in [comment:42](#comment:42)? And should `pkgconf` be a dependency for `gsl`, to make sure `pkg-config` is available for this command?",
    "created_at": "2021-10-21T19:52:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508496",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:54" align="right">comment:54</div>

Separately from the other issues, should we change gsl's `spkg-install.in` to use

```
sdh_configure LIBS="`pkg-config --libs-only-l cblas` -lm" LDFLAGS="$LDFLAGS `pkg-config --libs-only-L cblas`"
```
as suggested in [comment:42](#comment:42)? And should `pkgconf` be a dependency for `gsl`, to make sure `pkg-config` is available for this command?



---

archive/issue_comments_508497.json:
```json
{
    "body": "<div id=\"comment:55\" align=\"right\">comment:55</div>\n\nReplying to [@jhpalmieri](#comment:54):\n> Separately from the other issues, should we change gsl's `spkg-install.in` to use\n> \n> ```\n> sdh_configure LIBS=\"`pkg-config --libs-only-l cblas` -lm\" LDFLAGS=\"$LDFLAGS `pkg-config --libs-only-L cblas`\"\n> ```\n> as suggested in [comment:42](#comment:42)?\n\nyes\n\n> And should `pkgconf` be a dependency for `gsl`, to make sure `pkg-config` is available for this command?\n\nyes (an order-only dependency, just like for `r`).",
    "created_at": "2021-10-22T09:55:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508497",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:55" align="right">comment:55</div>

Replying to [@jhpalmieri](#comment:54):
> Separately from the other issues, should we change gsl's `spkg-install.in` to use
> 
> ```
> sdh_configure LIBS="`pkg-config --libs-only-l cblas` -lm" LDFLAGS="$LDFLAGS `pkg-config --libs-only-L cblas`"
> ```
> as suggested in [comment:42](#comment:42)?

yes

> And should `pkgconf` be a dependency for `gsl`, to make sure `pkg-config` is available for this command?

yes (an order-only dependency, just like for `r`).



---

archive/issue_comments_508498.json:
```json
{
    "body": "<div id=\"comment:56\" align=\"right\">comment:56</div>\n\nBy the way, if I build all of Sage with `export CFLAGS='-O2 -g'`, just with a plain `./configure` so using all of homebrew's packages, tests pass. So allowing  `-march=native` to remain (by not explicitly setting `CFLAGS`) on this machine causes problems in building parts of Sage.",
    "created_at": "2021-10-22T21:47:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508498",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:56" align="right">comment:56</div>

By the way, if I build all of Sage with `export CFLAGS='-O2 -g'`, just with a plain `./configure` so using all of homebrew's packages, tests pass. So allowing  `-march=native` to remain (by not explicitly setting `CFLAGS`) on this machine causes problems in building parts of Sage.



---

archive/issue_comments_508499.json:
```json
{
    "body": "<div id=\"comment:57\" align=\"right\">comment:57</div>\n\nShouldn't `CPPFLAGS` also be set using pkgconfig?",
    "created_at": "2021-10-23T22:56:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508499",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:57" align="right">comment:57</div>

Shouldn't `CPPFLAGS` also be set using pkgconfig?



---

archive/issue_comments_508500.json:
```json
{
    "body": "<div id=\"comment:58\" align=\"right\">comment:58</div>\n\n(in the branch of #32587)",
    "created_at": "2021-10-24T20:09:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508500",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:58" align="right">comment:58</div>

(in the branch of #32587)



---

archive/issue_comments_508501.json:
```json
{
    "body": "<div id=\"comment:59\" align=\"right\">comment:59</div>\n\nReplying to [@mkoeppe](#comment:57):\n> Shouldn't `CPPFLAGS` also be set using pkgconfig?\n\nIt builds without that, but please modify that branch if you think it's a good idea.",
    "created_at": "2021-10-27T04:52:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508501",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:59" align="right">comment:59</div>

Replying to [@mkoeppe](#comment:57):
> Shouldn't `CPPFLAGS` also be set using pkgconfig?

It builds without that, but please modify that branch if you think it's a good idea.



---

archive/issue_events_438293.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-11-13T17:21:23Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "label": "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p: 2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31621#event-438293"
}
```



---

archive/issue_events_438294.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-11-13T17:21:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "label": "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p: 1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31621#event-438294"
}
```



---

archive/issue_comments_508502.json:
```json
{
    "body": "<div id=\"comment:60\" align=\"right\">comment:60</div>\n\nStill the same in 9.5.beta6",
    "created_at": "2021-11-13T17:21:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508502",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:60" align="right">comment:60</div>

Still the same in 9.5.beta6



---

archive/issue_comments_508503.json:
```json
{
    "body": "<div id=\"comment:61\" align=\"right\">comment:61</div>\n\nWhat's the status here?",
    "created_at": "2021-12-21T17:02:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508503",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:61" align="right">comment:61</div>

What's the status here?



---

archive/issue_events_438295.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-10T23:03:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "label": "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p: 1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31621#event-438295"
}
```



---

archive/issue_events_438296.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-10T23:03:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31621#event-438296"
}
```



---

archive/issue_comments_508504.json:
```json
{
    "body": "<div id=\"comment:62\" align=\"right\">comment:62</div>\n\nWe can no longer test `ubuntu-groovy`, and the failures do not show up in any other Debian and Ubuntu variants tested in https://github.com/sagemath/sage/actions/runs/1673712139 (for 9.5.rc0). \n\nSo perhaps we can close it?",
    "created_at": "2022-01-10T23:03:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508504",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:62" align="right">comment:62</div>

We can no longer test `ubuntu-groovy`, and the failures do not show up in any other Debian and Ubuntu variants tested in https://github.com/sagemath/sage/actions/runs/1673712139 (for 9.5.rc0). 

So perhaps we can close it?



---

archive/issue_events_438297.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-28T23:11:40Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31621#event-438297"
}
```



---

archive/issue_events_438298.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-28T23:11:40Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31621#event-438298"
}
```



---

archive/issue_events_438299.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31621#event-438299"
}
```



---

archive/issue_events_438300.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31621#event-438300"
}
```



---

archive/issue_comments_508505.json:
```json
{
    "body": "<div id=\"comment:65\" align=\"right\">comment:65</div>\n\nSeen again in 9.7.rc0 on `debian-bullseye-standard`\nhttps://github.com/sagemath/sage/runs/8104739123?check_suite_focus=true",
    "created_at": "2022-09-02T04:36:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31621#issuecomment-508505",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:65" align="right">comment:65</div>

Seen again in 9.7.rc0 on `debian-bullseye-standard`
https://github.com/sagemath/sage/runs/8104739123?check_suite_focus=true



---

archive/issue_events_438301.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-02T04:36:14Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31621#event-438301"
}
```



---

archive/issue_events_438302.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-02T04:36:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "label": "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p: 2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31621#event-438302"
}
```



---

archive/issue_events_438303.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31621#event-438303"
}
```



---

archive/issue_events_438304.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31621",
    "milestone_number": null,
    "milestone_title": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31621#event-438304"
}
```
