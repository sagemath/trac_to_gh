# Issue 31948: Reimplement parallel docbuild using make

archive/issues_031711.json:
```json
{
    "assignees": [],
    "body": "Based on #31353 (`sage --docbuild`: Add options to list all documents), we can remove the issues with parallel (#31344) and serial (#31936) docbuild by restructuring the docbuild using `make`.\n\nBlocker because it solves blocker issue #31936.\n\nCC:  @dimpase\n\nBranch: **[`53f260c`](https://github.com/sagemath/sagetrac-mirror/commit/53f260c1b355fc623cf8feed858614a87133028d)**\n\nReviewer: **Matthias Koeppe, John Palmieri, Dima Pasechnik**\n\nAuthor: **John Palmieri, Matthias Koeppe**\n\nComponent: **build**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/31948_\n\n",
    "closed_at": "2021-06-20T08:14:49Z",
    "created_at": "2021-06-10T03:21:10Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20build",
        "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.4",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Reimplement parallel docbuild using make",
    "type": "issue",
    "updated_at": "2021-07-22T02:03:30Z",
    "url": "https://github.com/sagemath/sage/issues/31948",
    "user": "https://github.com/mkoeppe"
}
```
Based on #31353 (`sage --docbuild`: Add options to list all documents), we can remove the issues with parallel (#31344) and serial (#31936) docbuild by restructuring the docbuild using `make`.

Blocker because it solves blocker issue #31936.

CC:  @dimpase

Branch: **[`53f260c`](https://github.com/sagemath/sagetrac-mirror/commit/53f260c1b355fc623cf8feed858614a87133028d)**

Reviewer: **Matthias Koeppe, John Palmieri, Dima Pasechnik**

Author: **John Palmieri, Matthias Koeppe**

Component: **build**

_Issue created by migration from https://trac.sagemath.org/ticket/31948_





---

archive/issue_events_440576.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-06-10T03:21:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31948#event-440576"
}
```



---

archive/issue_events_440577.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-06-10T03:21:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20build",
    "label_color": "000080",
    "label_name": "c: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31948#event-440577"
}
```



---

archive/issue_events_440578.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-06-10T03:21:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31948#event-440578"
}
```



---

archive/issue_events_440579.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-06-10T03:21:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31948#event-440579"
}
```



---

archive/issue_comments_514137.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nI'm not quite sure how to go about this. I tried this:\n\n```diff\ndiff --git a/build/make/Makefile.in b/build/make/Makefile.in\nindex fb3a6ed5bc..4581dc3226 100644\n--- a/build/make/Makefile.in\n+++ b/build/make/Makefile.in\n@@ -335,7 +335,12 @@ DOC_DEPENDENCIES = sagelib sage_docbuild $(inst_sphinx) \\\n        $(inst_ipykernel) $(inst_jupyter_client) $(inst_conway_polynomials) \\\n        $(inst_tachyon) $(inst_jmol) $(inst_thebe) $(inst_ipywidgets)\n \n-doc: doc-html\n+doc: doc-new\n+\n+doc-new: $(DOC_DEPENDENCIES)\n+       for doc in $(shell cd $(SAGE_ROOT) && ./sage --docbuild --all-documents all); do \\\n+           $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p \"./sage --docbuild --no-pdf-links $$doc html $(SAGE_DOCBUILD_OPTS)\" logs/dochtml.log; \\\n+       done\n \n doc-html: $(DOC_DEPENDENCIES)\n        $(AM_V_at)cd ../.. && sage-logger -p './sage --docbuild --no-pdf-links all html $(SAGE_DOCBUILD_OPTS)' logs/dochtml.log\n```\nand it seems to build the documentation, but it doesn't do it in parallel, I think because  we've turned off parallel processing for recursive calls to make earlier in the file.\n\nIf it did work, this approach would need a little tinkering: we should build the reference manual first, then everything else.\n\nA separate question: why do we use `cd ../..` in the recipe for `doc-html` (and other doc targets), rather than `cd $(SAGE_ROOT)`?",
    "created_at": "2021-06-10T20:41:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514137",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:1" align="right">comment:1</div>

I'm not quite sure how to go about this. I tried this:

```diff
diff --git a/build/make/Makefile.in b/build/make/Makefile.in
index fb3a6ed5bc..4581dc3226 100644
--- a/build/make/Makefile.in
+++ b/build/make/Makefile.in
@@ -335,7 +335,12 @@ DOC_DEPENDENCIES = sagelib sage_docbuild $(inst_sphinx) \
        $(inst_ipykernel) $(inst_jupyter_client) $(inst_conway_polynomials) \
        $(inst_tachyon) $(inst_jmol) $(inst_thebe) $(inst_ipywidgets)
 
-doc: doc-html
+doc: doc-new
+
+doc-new: $(DOC_DEPENDENCIES)
+       for doc in $(shell cd $(SAGE_ROOT) && ./sage --docbuild --all-documents all); do \
+           $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p "./sage --docbuild --no-pdf-links $$doc html $(SAGE_DOCBUILD_OPTS)" logs/dochtml.log; \
+       done
 
 doc-html: $(DOC_DEPENDENCIES)
        $(AM_V_at)cd ../.. && sage-logger -p './sage --docbuild --no-pdf-links all html $(SAGE_DOCBUILD_OPTS)' logs/dochtml.log
```
and it seems to build the documentation, but it doesn't do it in parallel, I think because  we've turned off parallel processing for recursive calls to make earlier in the file.

If it did work, this approach would need a little tinkering: we should build the reference manual first, then everything else.

A separate question: why do we use `cd ../..` in the recipe for `doc-html` (and other doc targets), rather than `cd $(SAGE_ROOT)`?



---

archive/issue_comments_514138.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nAnd if we really want to pull all of the parallel building out of the current system, then we should build the pieces of the reference manual separately in the `Makefile`. I think this is what you intended.",
    "created_at": "2021-06-10T20:43:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514138",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:2" align="right">comment:2</div>

And if we really want to pull all of the parallel building out of the current system, then we should build the pieces of the reference manual separately in the `Makefile`. I think this is what you intended.



---

archive/issue_comments_514139.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nHere is my current attempt, which doesn't quite work:\n\n```diff\ndiff --git a/build/make/Makefile.in b/build/make/Makefile.in\nindex fb3a6ed5bc..c199de440d 100644\n--- a/build/make/Makefile.in\n+++ b/build/make/Makefile.in\n@@ -335,7 +335,27 @@ DOC_DEPENDENCIES = sagelib sage_docbuild $(inst_sphinx) \\\n        $(inst_ipykernel) $(inst_jupyter_client) $(inst_conway_polynomials) \\\n        $(inst_tachyon) $(inst_jmol) $(inst_thebe) $(inst_ipywidgets)\n \n-doc: doc-html\n+doc: doc-references doc-other\n+\n+doc-references: $(DOC_DEPENDENCIES)\n+       $(eval DOCS = $(shell cd $(SAGE_ROOT) && ./sage --docbuild --all-documents reference))\n+       $(eval biblio = $(firstword $(DOCS)))\n+       $(eval other_docs = $(wordlist 2, 100, $(DOCS)))\n+       $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p \"./sage --docbuild --no-pdf-links $(biblio) inventory $(SAGE_DOCBUILD_OPTS)\" logs/docs-reference-html.log; \\\n+       for doc in $(other_docs); do \\\n+           $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p \"./sage --docbuild --no-pdf-links $$doc inventory $(SAGE_DOCBUILD_OPTS)\" logs/docs-reference-html.log; \\\n+       done\n+       $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p \"./sage --docbuild --no-pdf-links reference inventory $(SAGE_DOCBUILD_OPTS)\" logs/docs-reference-html.log; \\\n+       $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p \"./sage --docbuild --no-pdf-links $(biblio) html $(SAGE_DOCBUILD_OPTS)\" logs/docs-reference-html.log; \\\n+       for doc in $(other_docs); do \\\n+           $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p \"./sage --docbuild --no-pdf-links $$doc html $(SAGE_DOCBUILD_OPTS)\" logs/docs-reference-html.log; \\\n+       $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p \"./sage --docbuild --no-pdf-links reference html $(SAGE_DOCBUILD_OPTS)\" logs/docs-reference-html.log; \\\n+       done\n+\n+doc-other: $(DOC_DEPENDENCIES) doc-references\n+       for doc in $(wordlist 2, 100, $(shell cd $(SAGE_ROOT) && ./sage --docbuild --all-documents all)); do \\\n+           $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p \"./sage --docbuild --no-pdf-links $$doc html $(SAGE_DOCBUILD_OPTS)\" logs/docs-other-html.log; \\\n+       done\n \n doc-html: $(DOC_DEPENDENCIES)\n        $(AM_V_at)cd ../.. && sage-logger -p './sage --docbuild --no-pdf-links all html $(SAGE_DOCBUILD_OPTS)' logs/dochtml.log\ndiff --git a/src/sage_docbuild/__init__.py b/src/sage_docbuild/__init__.py\nindex 79005b903a..a3caa8a92d 100644\n--- a/src/sage_docbuild/__init__.py\n+++ b/src/sage_docbuild/__init__.py\n@@ -116,7 +116,7 @@ def builder_helper(type):\n             # WEBSITESPHINXOPTS is either empty or \" -A hide_pdf_links=1 \"\n             options += WEBSITESPHINXOPTS\n \n-        if kwds.get('use_multidoc_inventory', True):\n+        if kwds.get('use_multidoc_inventory', True) and type != 'inventory':\n             options += ' -D multidoc_first_pass=0'\n         else:\n             options += ' -D multidoc_first_pass=1'\n```\nSeveral problems:\n\n- lack of parallel building\n- line 348 should be replaced by something that just builds the top-level reference manual stuff, assembling the parts into one set of indices, etc. Probably the same for line 352.\n- I'm getting some warning messages that I don't know what to make of: \"[schemes  ] Handler <function on_build_finished at 0x33872ef70> for event 'build-finished' threw an exception\", for example.",
    "created_at": "2021-06-11T01:18:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514139",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:3" align="right">comment:3</div>

Here is my current attempt, which doesn't quite work:

```diff
diff --git a/build/make/Makefile.in b/build/make/Makefile.in
index fb3a6ed5bc..c199de440d 100644
--- a/build/make/Makefile.in
+++ b/build/make/Makefile.in
@@ -335,7 +335,27 @@ DOC_DEPENDENCIES = sagelib sage_docbuild $(inst_sphinx) \
        $(inst_ipykernel) $(inst_jupyter_client) $(inst_conway_polynomials) \
        $(inst_tachyon) $(inst_jmol) $(inst_thebe) $(inst_ipywidgets)
 
-doc: doc-html
+doc: doc-references doc-other
+
+doc-references: $(DOC_DEPENDENCIES)
+       $(eval DOCS = $(shell cd $(SAGE_ROOT) && ./sage --docbuild --all-documents reference))
+       $(eval biblio = $(firstword $(DOCS)))
+       $(eval other_docs = $(wordlist 2, 100, $(DOCS)))
+       $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p "./sage --docbuild --no-pdf-links $(biblio) inventory $(SAGE_DOCBUILD_OPTS)" logs/docs-reference-html.log; \
+       for doc in $(other_docs); do \
+           $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p "./sage --docbuild --no-pdf-links $$doc inventory $(SAGE_DOCBUILD_OPTS)" logs/docs-reference-html.log; \
+       done
+       $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p "./sage --docbuild --no-pdf-links reference inventory $(SAGE_DOCBUILD_OPTS)" logs/docs-reference-html.log; \
+       $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p "./sage --docbuild --no-pdf-links $(biblio) html $(SAGE_DOCBUILD_OPTS)" logs/docs-reference-html.log; \
+       for doc in $(other_docs); do \
+           $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p "./sage --docbuild --no-pdf-links $$doc html $(SAGE_DOCBUILD_OPTS)" logs/docs-reference-html.log; \
+       $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p "./sage --docbuild --no-pdf-links reference html $(SAGE_DOCBUILD_OPTS)" logs/docs-reference-html.log; \
+       done
+
+doc-other: $(DOC_DEPENDENCIES) doc-references
+       for doc in $(wordlist 2, 100, $(shell cd $(SAGE_ROOT) && ./sage --docbuild --all-documents all)); do \
+           $(AM_V_at)cd $(SAGE_ROOT) && sage-logger -p "./sage --docbuild --no-pdf-links $$doc html $(SAGE_DOCBUILD_OPTS)" logs/docs-other-html.log; \
+       done
 
 doc-html: $(DOC_DEPENDENCIES)
        $(AM_V_at)cd ../.. && sage-logger -p './sage --docbuild --no-pdf-links all html $(SAGE_DOCBUILD_OPTS)' logs/dochtml.log
diff --git a/src/sage_docbuild/__init__.py b/src/sage_docbuild/__init__.py
index 79005b903a..a3caa8a92d 100644
--- a/src/sage_docbuild/__init__.py
+++ b/src/sage_docbuild/__init__.py
@@ -116,7 +116,7 @@ def builder_helper(type):
             # WEBSITESPHINXOPTS is either empty or " -A hide_pdf_links=1 "
             options += WEBSITESPHINXOPTS
 
-        if kwds.get('use_multidoc_inventory', True):
+        if kwds.get('use_multidoc_inventory', True) and type != 'inventory':
             options += ' -D multidoc_first_pass=0'
         else:
             options += ' -D multidoc_first_pass=1'
```
Several problems:

- lack of parallel building
- line 348 should be replaced by something that just builds the top-level reference manual stuff, assembling the parts into one set of indices, etc. Probably the same for line 352.
- I'm getting some warning messages that I don't know what to make of: "[schemes  ] Handler <function on_build_finished at 0x33872ef70> for event 'build-finished' threw an exception", for example.



---

archive/issue_comments_514140.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nTo get `make` to parallelize it, the individual documents need to become `make` targets. A combination of `$(eval...)` and a macro call can do this -- similar to https://www.gnu.org/software/make/manual/html_node/Eval-Function.html",
    "created_at": "2021-06-11T03:37:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514140",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:4" align="right">comment:4</div>

To get `make` to parallelize it, the individual documents need to become `make` targets. A combination of `$(eval...)` and a macro call can do this -- similar to https://www.gnu.org/software/make/manual/html_node/Eval-Function.html



---

archive/issue_comments_514141.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nI don't see how to do anything like that unless we hardcode the list of documents: we can't run `sage --docbuild ...` without building some other targets, so it seems to me that we have to construct the list of documents inside a recipe. But I'm very far from a `Makefile` expert, so I could be missing something.",
    "created_at": "2021-06-11T05:30:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514141",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:5" align="right">comment:5</div>

I don't see how to do anything like that unless we hardcode the list of documents: we can't run `sage --docbuild ...` without building some other targets, so it seems to me that we have to construct the list of documents inside a recipe. But I'm very far from a `Makefile` expert, so I could be missing something.



---

archive/issue_comments_514142.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nOr write a standalone script to construct the document list.",
    "created_at": "2021-06-11T05:41:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514142",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:6" align="right">comment:6</div>

Or write a standalone script to construct the document list.



---

archive/issue_comments_514143.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nCould you push your current version to the ticket please?",
    "created_at": "2021-06-11T16:07:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514143",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:7" align="right">comment:7</div>

Could you push your current version to the ticket please?



---

archive/issue_comments_514144.json:
```json
{
    "body": "Branch: **[u/jhpalmieri/parallel-docbuild-with-make](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/parallel-docbuild-with-make)**",
    "created_at": "2021-06-11T16:36:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514144",
    "user": "https://github.com/jhpalmieri"
}
```

Branch: **[u/jhpalmieri/parallel-docbuild-with-make](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/parallel-docbuild-with-make)**



---

archive/issue_comments_514145.json:
```json
{
    "body": "Commit: **[`c2c9b3c`](https://github.com/sagemath/sagetrac-mirror/commit/c2c9b3c735c9b651045c471360f3a1314e883a8b)**",
    "created_at": "2021-06-11T16:36:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514145",
    "user": "https://github.com/jhpalmieri"
}
```

Commit: **[`c2c9b3c`](https://github.com/sagemath/sagetrac-mirror/commit/c2c9b3c735c9b651045c471360f3a1314e883a8b)**



---

archive/issue_comments_514146.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nHere it is.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c2c9b3c735c9b651045c471360f3a1314e883a8b\">c2c9b3c</a></td><td><code>trac 31948: very rough draft</code></td></tr></table>\n",
    "created_at": "2021-06-11T16:36:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514146",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:9" align="right">comment:9</div>

Here it is.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c2c9b3c735c9b651045c471360f3a1314e883a8b">c2c9b3c</a></td><td><code>trac 31948: very rough draft</code></td></tr></table>




---

archive/issue_comments_514147.json:
```json
{
    "body": "Changed branch from **[u/jhpalmieri/parallel-docbuild-with-make](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/parallel-docbuild-with-make)** to **[u/mkoeppe/parallel-docbuild-with-make](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/parallel-docbuild-with-make)**",
    "created_at": "2021-06-11T17:43:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514147",
    "user": "https://github.com/mkoeppe"
}
```

Changed branch from **[u/jhpalmieri/parallel-docbuild-with-make](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/parallel-docbuild-with-make)** to **[u/mkoeppe/parallel-docbuild-with-make](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/parallel-docbuild-with-make)**



---

archive/issue_comments_514148.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nHere's a solution using recursive make invocation\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/393ab650dd0bd38599e4716092b5217b8ecae9ed\">393ab65</a></td><td><code>build/make/Makefile.in (doc-reference): Invoke make recursively to build documents in parallel</code></td></tr></table>\n",
    "created_at": "2021-06-11T17:46:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514148",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:11" align="right">comment:11</div>

Here's a solution using recursive make invocation

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/393ab650dd0bd38599e4716092b5217b8ecae9ed">393ab65</a></td><td><code>build/make/Makefile.in (doc-reference): Invoke make recursively to build documents in parallel</code></td></tr></table>




---

archive/issue_comments_514149.json:
```json
{
    "body": "Changed commit from **[`c2c9b3c`](https://github.com/sagemath/sagetrac-mirror/commit/c2c9b3c735c9b651045c471360f3a1314e883a8b)** to **[`393ab65`](https://github.com/sagemath/sagetrac-mirror/commit/393ab650dd0bd38599e4716092b5217b8ecae9ed)**",
    "created_at": "2021-06-11T17:46:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514149",
    "user": "https://github.com/mkoeppe"
}
```

Changed commit from **[`c2c9b3c`](https://github.com/sagemath/sagetrac-mirror/commit/c2c9b3c735c9b651045c471360f3a1314e883a8b)** to **[`393ab65`](https://github.com/sagemath/sagetrac-mirror/commit/393ab650dd0bd38599e4716092b5217b8ecae9ed)**



---

archive/issue_comments_514150.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nThis doesn't work for me, unfortunately. If I do `make doc-clean && make doc`, I get this error, which I don't understand.\n\n```\n[reference] building [inventory]: targets for 1 source files that are out of date\n[reference] updating environment: [new config] 1 added, 0 changed, 0 removed\n[reference] The inventory files are in local/share/doc/sage/inventory/en/reference/references.\nBuild finished. The built documents can be found in /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/share/doc/sage/inventory/en/reference/references\nDeleting empty directory /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/src/doc/en/reference/manifolds/sage/manifolds\nDeleting empty directory /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/src/doc/en/reference/manifolds/sage\nError building the documentation.\nTraceback (most recent call last):\n  File \"/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py\", line 197, in _run_module_as_main\n    return _run_code(code, main_globals, None,\n  File \"/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py\", line 87, in _run_code\n    exec(code, run_globals)\n  File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__main__.py\", line 2, in <module>\n    main()\n  File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__init__.py\", line 1762, in main\n    builder()\n  File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__init__.py\", line 769, in _wrapper\n    self.write_auto_rest_file(module_name)\n  File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__init__.py\", line 1070, in write_auto_rest_file\n    with open(filename, 'w') as outfile:\nFileNotFoundError: [Errno 2] No such file or directory: '/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/src/doc/en/reference/manifolds/sage/manifolds/utilities.rst'\n```\nWith the following change, the documentation builds:\n\n```diff\ndiff --git a/build/make/Makefile.in b/build/make/Makefile.in\nindex 339497fd17..12b4e56b20 100644\n--- a/build/make/Makefile.in\n+++ b/build/make/Makefile.in\n@@ -349,11 +349,7 @@ doc-references: $(DOC_DEPENDENCIES)\n        $(eval DOCS = $(shell cd $(SAGE_ROOT) && ./sage --docbuild --all-documents reference))\n        $(eval biblio = $(firstword $(DOCS)))\n        $(eval other_docs = $(wordlist 2, 100, $(DOCS)))\n-       +$(MAKE_REC) doc-inventory-$(subst /,-,$(biblio))\n-       +$(MAKE_REC) $(foreach doc, $(other_docs), doc-inventory-$(subst /,-,$(doc)))\n        +$(MAKE_REC) doc-inventory-reference\n-       +$(MAKE_REC) doc-html-$(subst /,-,$(biblio))\n-       +$(MAKE_REC) $(foreach doc, $(other_docs), doc-html-$(subst /,-,$(doc)))\n        +$(MAKE_REC) doc-html-reference\n \n doc-other: $(DOC_DEPENDENCIES) doc-references\n```\nThis is a hybrid model, using the old parallel building methods for the reference manual. The inventory build is fine, but I get some strange warnings during the html build:\n\n```\n[repl     ] building [html]: targets for 35 source files that are out of date\n[polynomia] building [html]: targets for 62 source files that are out of date\n[spkg     ] building [html]: targets for 316 source files that are out of date\n[tensor_fr] building [html]: targets for 19 source files that are out of date\n[algebras ] building [html]: targets for 97 source files that are out of date\n[manifolds] building [html]: targets for 81 source files that are out of date\n[repl     ] writing additional pages...  searchdone\n[repl     ] dumping search index in English (code: en)... done\n[repl     ] The HTML pages are in local/share/doc/sage/html/en/reference/repl.\n[repl     ] Extension error:\n[repl     ] Handler <function on_build_finished at 0x33c247af0> for event 'build-finished' threw an exception\nBuild finished. The built documents can be found in /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/share/doc/sage/html/en/reference/repl\n[tensor_fr] writing additional pages...  searchdone\n[tensor_fr] dumping search index in English (code: en)... done\n[tensor_fr] The HTML pages are in local/share/doc/sage/html/en/reference/tensor_free_modules.\n[tensor_fr] Extension error:\n[tensor_fr] Handler <function on_build_finished at 0x33d1c3040> for event 'build-finished' threw an exception\n```\nI don't know what `Handler <function on_build_finished at 0x33d1c3040> for event 'build-finished' threw an exception` means or where it comes from.",
    "created_at": "2021-06-12T00:59:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514150",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:12" align="right">comment:12</div>

This doesn't work for me, unfortunately. If I do `make doc-clean && make doc`, I get this error, which I don't understand.

```
[reference] building [inventory]: targets for 1 source files that are out of date
[reference] updating environment: [new config] 1 added, 0 changed, 0 removed
[reference] The inventory files are in local/share/doc/sage/inventory/en/reference/references.
Build finished. The built documents can be found in /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/share/doc/sage/inventory/en/reference/references
Deleting empty directory /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/src/doc/en/reference/manifolds/sage/manifolds
Deleting empty directory /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/src/doc/en/reference/manifolds/sage
Error building the documentation.
Traceback (most recent call last):
  File "/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py", line 197, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py", line 87, in _run_code
    exec(code, run_globals)
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__main__.py", line 2, in <module>
    main()
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 1762, in main
    builder()
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 769, in _wrapper
    self.write_auto_rest_file(module_name)
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 1070, in write_auto_rest_file
    with open(filename, 'w') as outfile:
FileNotFoundError: [Errno 2] No such file or directory: '/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/src/doc/en/reference/manifolds/sage/manifolds/utilities.rst'
```
With the following change, the documentation builds:

```diff
diff --git a/build/make/Makefile.in b/build/make/Makefile.in
index 339497fd17..12b4e56b20 100644
--- a/build/make/Makefile.in
+++ b/build/make/Makefile.in
@@ -349,11 +349,7 @@ doc-references: $(DOC_DEPENDENCIES)
        $(eval DOCS = $(shell cd $(SAGE_ROOT) && ./sage --docbuild --all-documents reference))
        $(eval biblio = $(firstword $(DOCS)))
        $(eval other_docs = $(wordlist 2, 100, $(DOCS)))
-       +$(MAKE_REC) doc-inventory-$(subst /,-,$(biblio))
-       +$(MAKE_REC) $(foreach doc, $(other_docs), doc-inventory-$(subst /,-,$(doc)))
        +$(MAKE_REC) doc-inventory-reference
-       +$(MAKE_REC) doc-html-$(subst /,-,$(biblio))
-       +$(MAKE_REC) $(foreach doc, $(other_docs), doc-html-$(subst /,-,$(doc)))
        +$(MAKE_REC) doc-html-reference
 
 doc-other: $(DOC_DEPENDENCIES) doc-references
```
This is a hybrid model, using the old parallel building methods for the reference manual. The inventory build is fine, but I get some strange warnings during the html build:

```
[repl     ] building [html]: targets for 35 source files that are out of date
[polynomia] building [html]: targets for 62 source files that are out of date
[spkg     ] building [html]: targets for 316 source files that are out of date
[tensor_fr] building [html]: targets for 19 source files that are out of date
[algebras ] building [html]: targets for 97 source files that are out of date
[manifolds] building [html]: targets for 81 source files that are out of date
[repl     ] writing additional pages...  searchdone
[repl     ] dumping search index in English (code: en)... done
[repl     ] The HTML pages are in local/share/doc/sage/html/en/reference/repl.
[repl     ] Extension error:
[repl     ] Handler <function on_build_finished at 0x33c247af0> for event 'build-finished' threw an exception
Build finished. The built documents can be found in /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/share/doc/sage/html/en/reference/repl
[tensor_fr] writing additional pages...  searchdone
[tensor_fr] dumping search index in English (code: en)... done
[tensor_fr] The HTML pages are in local/share/doc/sage/html/en/reference/tensor_free_modules.
[tensor_fr] Extension error:
[tensor_fr] Handler <function on_build_finished at 0x33d1c3040> for event 'build-finished' threw an exception
```
I don't know what `Handler <function on_build_finished at 0x33d1c3040> for event 'build-finished' threw an exception` means or where it comes from.



---

archive/issue_comments_514151.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReplying to [@jhpalmieri](#comment:12):\n> This doesn't work for me, unfortunately. If I do `make doc-clean && make doc`, I get this error, which I don't understand.\n> \n> ```\n> [reference] building [inventory]: targets for 1 source files that are out of date\n> [reference] updating environment: [new config] 1 added, 0 changed, 0 removed\n> [reference] The inventory files are in local/share/doc/sage/inventory/en/reference/references.\n> Build finished. The built documents can be found in /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/share/doc/sage/inventory/en/reference/references\n> Deleting empty directory /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/src/doc/en/reference/manifolds/sage/manifolds\n> Deleting empty directory /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/src/doc/en/reference/manifolds/sage\n> Error building the documentation.\n> Traceback (most recent call last):\n>   File \"/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py\", line 197, in _run_module_as_main\n>     return _run_code(code, main_globals, None,\n>   File \"/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py\", line 87, in _run_code\n>     exec(code, run_globals)\n>   File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__main__.py\", line 2, in <module>\n>     main()\n>   File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__init__.py\", line 1762, in main\n>     builder()\n>   File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__init__.py\", line 769, in _wrapper\n>     self.write_auto_rest_file(module_name)\n>   File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__init__.py\", line 1070, in write_auto_rest_file\n>     with open(filename, 'w') as outfile:\n> FileNotFoundError: [Errno 2] No such file or directory: '/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/src/doc/en/reference/manifolds/sage/manifolds/utilities.rst'\n> ```\n\nLooks like something forgot to create the directory in which this .rst file is to be created",
    "created_at": "2021-06-12T01:14:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514151",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:13" align="right">comment:13</div>

Replying to [@jhpalmieri](#comment:12):
> This doesn't work for me, unfortunately. If I do `make doc-clean && make doc`, I get this error, which I don't understand.
> 
> ```
> [reference] building [inventory]: targets for 1 source files that are out of date
> [reference] updating environment: [new config] 1 added, 0 changed, 0 removed
> [reference] The inventory files are in local/share/doc/sage/inventory/en/reference/references.
> Build finished. The built documents can be found in /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/share/doc/sage/inventory/en/reference/references
> Deleting empty directory /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/src/doc/en/reference/manifolds/sage/manifolds
> Deleting empty directory /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/src/doc/en/reference/manifolds/sage
> Error building the documentation.
> Traceback (most recent call last):
>   File "/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py", line 197, in _run_module_as_main
>     return _run_code(code, main_globals, None,
>   File "/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py", line 87, in _run_code
>     exec(code, run_globals)
>   File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__main__.py", line 2, in <module>
>     main()
>   File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 1762, in main
>     builder()
>   File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 769, in _wrapper
>     self.write_auto_rest_file(module_name)
>   File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 1070, in write_auto_rest_file
>     with open(filename, 'w') as outfile:
> FileNotFoundError: [Errno 2] No such file or directory: '/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta1/src/doc/en/reference/manifolds/sage/manifolds/utilities.rst'
> ```

Looks like something forgot to create the directory in which this .rst file is to be created



---

archive/issue_comments_514152.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nI was able to reproduce an error of this form as well.",
    "created_at": "2021-06-12T01:28:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514152",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:14" align="right">comment:14</div>

I was able to reproduce an error of this form as well.



---

archive/issue_comments_514153.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nIf you do `make doc-clean && make SAGE_DOCBUILD_OPTS=\"--verbose=3\" doc`, you can see that this is a race between creating directories and \"deleting empty directories\"",
    "created_at": "2021-06-12T01:29:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514153",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:15" align="right">comment:15</div>

If you do `make doc-clean && make SAGE_DOCBUILD_OPTS="--verbose=3" doc`, you can see that this is a race between creating directories and "deleting empty directories"



---

archive/issue_comments_514154.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nI'll add an option to turn it off",
    "created_at": "2021-06-12T01:37:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514154",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:16" align="right">comment:16</div>

I'll add an option to turn it off



---

archive/issue_comments_514155.json:
```json
{
    "body": "Changed commit from **[`393ab65`](https://github.com/sagemath/sagetrac-mirror/commit/393ab650dd0bd38599e4716092b5217b8ecae9ed)** to **[`d08633f`](https://github.com/sagemath/sagetrac-mirror/commit/d08633f65901a3accd709e496527fa8ac5bc4f2e)**",
    "created_at": "2021-06-12T02:02:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514155",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`393ab65`](https://github.com/sagemath/sagetrac-mirror/commit/393ab650dd0bd38599e4716092b5217b8ecae9ed)** to **[`d08633f`](https://github.com/sagemath/sagetrac-mirror/commit/d08633f65901a3accd709e496527fa8ac5bc4f2e)**



---

archive/issue_comments_514156.json:
```json
{
    "body": "<div id=\"comment:17\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d08633f65901a3accd709e496527fa8ac5bc4f2e\">d08633f</a></td><td><code>build/make/Makefile.in, src/sage_docbuild/__init__.py: New option --no-prune-empty-dirs, use it to remove races</code></td></tr></table>\n",
    "created_at": "2021-06-12T02:02:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514156",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:17"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d08633f65901a3accd709e496527fa8ac5bc4f2e">d08633f</a></td><td><code>build/make/Makefile.in, src/sage_docbuild/__init__.py: New option --no-prune-empty-dirs, use it to remove races</code></td></tr></table>




---

archive/issue_comments_514157.json:
```json
{
    "body": "Author: **John Palmieri, Matthias Koeppe**",
    "created_at": "2021-06-12T02:03:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514157",
    "user": "https://github.com/mkoeppe"
}
```

Author: **John Palmieri, Matthias Koeppe**



---

archive/issue_comments_514158.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nI still see\n\n```\n[valuation] Extension error:\n[valuation] Handler <function on_build_finished at 0x3375808b0> for event 'build-finished' threw an exception\n```\nfor (I think) every piece of the reference manual. Any ideas about this?\n\nEdit: the manual seems to build correctly, regardless.",
    "created_at": "2021-06-12T04:41:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514158",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:19" align="right">comment:19</div>

I still see

```
[valuation] Extension error:
[valuation] Handler <function on_build_finished at 0x3375808b0> for event 'build-finished' threw an exception
```
for (I think) every piece of the reference manual. Any ideas about this?

Edit: the manual seems to build correctly, regardless.



---

archive/issue_comments_514159.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nNo idea about this error. I don't see it here. I suppose you could try to run the docbuild for a document in `pdb` to debug this.",
    "created_at": "2021-06-12T05:02:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514159",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:20" align="right">comment:20</div>

No idea about this error. I don't see it here. I suppose you could try to run the docbuild for a document in `pdb` to debug this.



---

archive/issue_comments_514160.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nI haven't tried `pdb`, but I get it when doing `make doc-clean && make` \u2014\u00a0running `make` again at that point doesn't produce the error. I also get it on two different machines, one Big Sur, one Catalina.\n\nOne more task: the reference manual is built twice: the line\n\n```\n+$(MAKE_REC) SAGE_DOCBUILD_OPTS=\"$(SAGE_DOCBUILD_OPTS) --no-prune-empty-dirs\" doc-inventory--reference\n```\nneeds to be replaced with something that just builds the top-level ref manual indices, and similarly for the html build. I may be able to work on this later, but please go ahead if you want to take a stab at it.",
    "created_at": "2021-06-12T17:02:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514160",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:22" align="right">comment:22</div>

I haven't tried `pdb`, but I get it when doing `make doc-clean && make` — running `make` again at that point doesn't produce the error. I also get it on two different machines, one Big Sur, one Catalina.

One more task: the reference manual is built twice: the line

```
+$(MAKE_REC) SAGE_DOCBUILD_OPTS="$(SAGE_DOCBUILD_OPTS) --no-prune-empty-dirs" doc-inventory--reference
```
needs to be replaced with something that just builds the top-level ref manual indices, and similarly for the html build. I may be able to work on this later, but please go ahead if you want to take a stab at it.



---

archive/issue_comments_514161.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nIf it shows up again, perhaps #31005 (Add traceback information to exceptions during docbuild) can help to diagnose it",
    "created_at": "2021-06-12T17:22:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514161",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:23" align="right">comment:23</div>

If it shows up again, perhaps #31005 (Add traceback information to exceptions during docbuild) can help to diagnose it



---

archive/issue_comments_514162.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nOK, I see `Handler <function on_build_finished at 0x3b9411310> for event 'build-finished' threw an exception` now too",
    "created_at": "2021-06-12T17:37:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514162",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:24" align="right">comment:24</div>

OK, I see `Handler <function on_build_finished at 0x3b9411310> for event 'build-finished' threw an exception` now too



---

archive/issue_comments_514163.json:
```json
{
    "body": "<div id=\"comment:25\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/06c6365c0dba9b4ce85feac19fb1f97cf7bea3e3\">06c6365</a></td><td><code>build/make/Makefile.in: Build doc-pdf in parallel using make</code></td></tr></table>\n",
    "created_at": "2021-06-12T17:52:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514163",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:25"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/06c6365c0dba9b4ce85feac19fb1f97cf7bea3e3">06c6365</a></td><td><code>build/make/Makefile.in: Build doc-pdf in parallel using make</code></td></tr></table>




---

archive/issue_comments_514164.json:
```json
{
    "body": "Changed commit from **[`d08633f`](https://github.com/sagemath/sagetrac-mirror/commit/d08633f65901a3accd709e496527fa8ac5bc4f2e)** to **[`06c6365`](https://github.com/sagemath/sagetrac-mirror/commit/06c6365c0dba9b4ce85feac19fb1f97cf7bea3e3)**",
    "created_at": "2021-06-12T17:52:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514164",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`d08633f`](https://github.com/sagemath/sagetrac-mirror/commit/d08633f65901a3accd709e496527fa8ac5bc4f2e)** to **[`06c6365`](https://github.com/sagemath/sagetrac-mirror/commit/06c6365c0dba9b4ce85feac19fb1f97cf7bea3e3)**



---

archive/issue_comments_514165.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nHere's an attempt to do the same for PDF.",
    "created_at": "2021-06-12T17:53:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514165",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:26" align="right">comment:26</div>

Here's an attempt to do the same for PDF.



---

archive/issue_comments_514166.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nWhen I merged with #31005, I didn't see any extra information.",
    "created_at": "2021-06-12T17:58:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514166",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:27" align="right">comment:27</div>

When I merged with #31005, I didn't see any extra information.



---

archive/issue_comments_514167.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nI tried the html build here, and the Japanese is gone. I see that `Handler <function on_build_finished...` messages too.\nSomething to configure for sphinx, I gather. The default `on_build_finished()` needs to be replaced by something we should do\n(maybe just `pass`)",
    "created_at": "2021-06-12T18:56:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514167",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:28" align="right">comment:28</div>

I tried the html build here, and the Japanese is gone. I see that `Handler <function on_build_finished...` messages too.
Something to configure for sphinx, I gather. The default `on_build_finished()` needs to be replaced by something we should do
(maybe just `pass`)



---

archive/issue_comments_514168.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\n\n```\nsrc/docs/conf.py:              'sphinx.ext.graphviz'\n```\nand in Sphinx in `sphinx/ext/graphviz.py` there is \n\n```\ndef on_build_finished(app: Sphinx, exc: Exception) -> None:\n    if exc is None:\n        src = path.join(sphinx.package_dir, 'templates', 'graphviz', 'graphviz.css')\n        dst = path.join(app.outdir, '_static')\n        copy_asset(src, dst)\n```",
    "created_at": "2021-06-12T20:00:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514168",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:29" align="right">comment:29</div>


```
src/docs/conf.py:              'sphinx.ext.graphviz'
```
and in Sphinx in `sphinx/ext/graphviz.py` there is 

```
def on_build_finished(app: Sphinx, exc: Exception) -> None:
    if exc is None:
        src = path.join(sphinx.package_dir, 'templates', 'graphviz', 'graphviz.css')
        dst = path.join(app.outdir, '_static')
        copy_asset(src, dst)
```



---

archive/issue_comments_514169.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nOkay, I'm annoyed. First, we've [had problems](https://github.com/sagemath/sage/issues/26451#comment:26) with the Sphinx graphviz extension before. Why do we even need it? As far as I can tell, it only [provides](https://www.sphinx-doc.org/en/master/usage/extensions/graphviz.html) Sphinx directives `.. graphviz::`, `.. graph`, and `.. digraph::`, and I don't see any of those in our code. Second, it's labeled an optional Sage package, so why load the extension all of the time? Third, what sort of ridiculous package is it? Its `spkg-install.in` script just says\n\n```\n#! /usr/bin/env bash\necho Error: graphviz is not installed as a system package.\necho Please install the system package recommended by ./configure\nexit 1\n```\nCan we delete it?\n\nThe documentation builds without error if we remove `sphinx.ext.graphviz` and the related `sphinx.ext.inheritance_diagram` from the list of Sphinx extensions. Can we remove these extensions?",
    "created_at": "2021-06-12T22:16:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514169",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:30" align="right">comment:30</div>

Okay, I'm annoyed. First, we've [had problems](https://github.com/sagemath/sage/issues/26451#comment:26) with the Sphinx graphviz extension before. Why do we even need it? As far as I can tell, it only [provides](https://www.sphinx-doc.org/en/master/usage/extensions/graphviz.html) Sphinx directives `.. graphviz::`, `.. graph`, and `.. digraph::`, and I don't see any of those in our code. Second, it's labeled an optional Sage package, so why load the extension all of the time? Third, what sort of ridiculous package is it? Its `spkg-install.in` script just says

```
#! /usr/bin/env bash
echo Error: graphviz is not installed as a system package.
echo Please install the system package recommended by ./configure
exit 1
```
Can we delete it?

The documentation builds without error if we remove `sphinx.ext.graphviz` and the related `sphinx.ext.inheritance_diagram` from the list of Sphinx extensions. Can we remove these extensions?



---

archive/issue_comments_514170.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nThis type of packages is there to make system package information available -- this is what will show at the end of `./configure`.",
    "created_at": "2021-06-12T22:19:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514170",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:31" align="right">comment:31</div>

This type of packages is there to make system package information available -- this is what will show at the end of `./configure`.



---

archive/issue_comments_514171.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nI'm pretty sure that this sphinx extension is not used anywhere in our documentation. It's probably a leftover from antiquity",
    "created_at": "2021-06-12T22:20:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514171",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:32" align="right">comment:32</div>

I'm pretty sure that this sphinx extension is not used anywhere in our documentation. It's probably a leftover from antiquity



---

archive/issue_comments_514172.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nReplying to [@mkoeppe](#comment:31):\n> This type of packages is there to make system package information available -- this is what will show at the end of `./configure`.\n\nI think it would make more sense for `graphviz` to be part of `_recommended` rather than its own package.",
    "created_at": "2021-06-12T22:37:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514172",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:33" align="right">comment:33</div>

Replying to [@mkoeppe](#comment:31):
> This type of packages is there to make system package information available -- this is what will show at the end of `./configure`.

I think it would make more sense for `graphviz` to be part of `_recommended` rather than its own package.



---

archive/issue_comments_514173.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nNo, that would not be an improvement. Our `configure` script detects the presence of system features on the granularity of packages. A catch-all \"_recommended\" package can't do that. See #30930.\n\nIn any case, all of this is unrelated to the errors in the present ticket.",
    "created_at": "2021-06-12T22:46:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514173",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:34" align="right">comment:34</div>

No, that would not be an improvement. Our `configure` script detects the presence of system features on the granularity of packages. A catch-all "_recommended" package can't do that. See #30930.

In any case, all of this is unrelated to the errors in the present ticket.



---

archive/issue_comments_514174.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nDo we want to deprecate the use of `./sage --docbuild all ...`, while keeping `./sage --docbuild DOCUMENT ...` for specific documents?",
    "created_at": "2021-06-12T22:49:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514174",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:35" align="right">comment:35</div>

Do we want to deprecate the use of `./sage --docbuild all ...`, while keeping `./sage --docbuild DOCUMENT ...` for specific documents?



---

archive/issue_comments_514175.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\ngraphviz sphinx extension came in #7549 (in 2009)",
    "created_at": "2021-06-12T22:50:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514175",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:36" align="right">comment:36</div>

graphviz sphinx extension came in #7549 (in 2009)



---

archive/issue_comments_514176.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nReplying to [@mkoeppe](#comment:34):\n> No, that would not be an improvement. Our `configure` script detects the presence of system features on the granularity of packages. A catch-all \"_recommended\" package can't do that. See #30930.\n> \n> In any case, all of this is unrelated to the errors in the present ticket.\n\nI agree with all of this, but I don't understand why `graphviz` is treated differently than `ffmpeg`, for example.",
    "created_at": "2021-06-12T22:50:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514176",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:37" align="right">comment:37</div>

Replying to [@mkoeppe](#comment:34):
> No, that would not be an improvement. Our `configure` script detects the presence of system features on the granularity of packages. A catch-all "_recommended" package can't do that. See #30930.
> 
> In any case, all of this is unrelated to the errors in the present ticket.

I agree with all of this, but I don't understand why `graphviz` is treated differently than `ffmpeg`, for example.



---

archive/issue_comments_514177.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nReplying to [@jhpalmieri](#comment:35):\n> Do we want to deprecate the use of `./sage --docbuild all ...`, while keeping `./sage --docbuild DOCUMENT ...` for specific documents?\n\nI think that's a good idea.",
    "created_at": "2021-06-12T22:51:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514177",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:38" align="right">comment:38</div>

Replying to [@jhpalmieri](#comment:35):
> Do we want to deprecate the use of `./sage --docbuild all ...`, while keeping `./sage --docbuild DOCUMENT ...` for specific documents?

I think that's a good idea.



---

archive/issue_comments_514178.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nReplying to [@dimpase](#comment:36):\n> graphviz sphinx extension came in #7549 (in 2009)\n\nThank you, Dima. Let's delete those extensions.",
    "created_at": "2021-06-12T22:53:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514178",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:39" align="right">comment:39</div>

Replying to [@dimpase](#comment:36):
> graphviz sphinx extension came in #7549 (in 2009)

Thank you, Dima. Let's delete those extensions.



---

archive/issue_comments_514179.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nReplying to [@jhpalmieri](#comment:37):\n> I don't understand why `graphviz` is treated differently than `ffmpeg`, for example.\n\n`ffmpeg` should also be broken out of `_recommended` and transformed to its separate script package. \nWhen I created `_recommended`, I did not anticipate that users would be confused when the configure script recommends to install things that are already installed.",
    "created_at": "2021-06-12T22:53:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514179",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:40" align="right">comment:40</div>

Replying to [@jhpalmieri](#comment:37):
> I don't understand why `graphviz` is treated differently than `ffmpeg`, for example.

`ffmpeg` should also be broken out of `_recommended` and transformed to its separate script package. 
When I created `_recommended`, I did not anticipate that users would be confused when the configure script recommends to install things that are already installed.



---

archive/issue_comments_514180.json:
```json
{
    "body": "Changed branch from **[u/mkoeppe/parallel-docbuild-with-make](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/parallel-docbuild-with-make)** to **[u/jhpalmieri/parallel-docbuild-with-make](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/parallel-docbuild-with-make)**",
    "created_at": "2021-06-12T22:56:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514180",
    "user": "https://github.com/jhpalmieri"
}
```

Changed branch from **[u/mkoeppe/parallel-docbuild-with-make](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/parallel-docbuild-with-make)** to **[u/jhpalmieri/parallel-docbuild-with-make](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/parallel-docbuild-with-make)**



---

archive/issue_comments_514181.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nI think that we could also delete the `cleanup` method in `src/sage_docbuild/ext/inventory_builder.py`: its docstring says\n\n```\n        Remove the '_static' directory.\n\n        This directory is unnecessary for the inventory build, but it\n        may be created by the graphviz extension. Its presence will\n        break the docbuild later on, so remove it.\n```\nBut let's keep it for now. It doesn't cause any harm.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/501d3fa85311bdaf07f5f77a776d6869ce789d98\">501d3fa</a></td><td><code>trac 31948: no longer use sphinx.ext.graphviz or</code></td></tr></table>\n",
    "created_at": "2021-06-12T22:58:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514181",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:42" align="right">comment:42</div>

I think that we could also delete the `cleanup` method in `src/sage_docbuild/ext/inventory_builder.py`: its docstring says

```
        Remove the '_static' directory.

        This directory is unnecessary for the inventory build, but it
        may be created by the graphviz extension. Its presence will
        break the docbuild later on, so remove it.
```
But let's keep it for now. It doesn't cause any harm.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/501d3fa85311bdaf07f5f77a776d6869ce789d98">501d3fa</a></td><td><code>trac 31948: no longer use sphinx.ext.graphviz or</code></td></tr></table>




---

archive/issue_comments_514182.json:
```json
{
    "body": "Changed commit from **[`06c6365`](https://github.com/sagemath/sagetrac-mirror/commit/06c6365c0dba9b4ce85feac19fb1f97cf7bea3e3)** to **[`501d3fa`](https://github.com/sagemath/sagetrac-mirror/commit/501d3fa85311bdaf07f5f77a776d6869ce789d98)**",
    "created_at": "2021-06-12T22:58:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514182",
    "user": "https://github.com/jhpalmieri"
}
```

Changed commit from **[`06c6365`](https://github.com/sagemath/sagetrac-mirror/commit/06c6365c0dba9b4ce85feac19fb1f97cf7bea3e3)** to **[`501d3fa`](https://github.com/sagemath/sagetrac-mirror/commit/501d3fa85311bdaf07f5f77a776d6869ce789d98)**



---

archive/issue_comments_514183.json:
```json
{
    "body": "<div id=\"comment:43\" align=\"right\">comment:43</div>\n\nReplying to [@jhpalmieri](#comment:39):\n> Replying to [@dimpase](#comment:36):\n> > graphviz sphinx extension came in #7549 (in 2009)\n\n> \n> Thank you, Dima. Let's delete those extensions.\n\nSure. Reading #7549 tells that it was meant for https://www.sphinx-doc.org/en/master/usage/extensions/inheritance.html",
    "created_at": "2021-06-12T22:59:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514183",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:43" align="right">comment:43</div>

Replying to [@jhpalmieri](#comment:39):
> Replying to [@dimpase](#comment:36):
> > graphviz sphinx extension came in #7549 (in 2009)

> 
> Thank you, Dima. Let's delete those extensions.

Sure. Reading #7549 tells that it was meant for https://www.sphinx-doc.org/en/master/usage/extensions/inheritance.html



---

archive/issue_comments_514184.json:
```json
{
    "body": "<div id=\"comment:44\" align=\"right\">comment:44</div>\n\nReplying to [@mkoeppe](#comment:38):\n> Replying to [@jhpalmieri](#comment:35):\n> > Do we want to deprecate the use of `./sage --docbuild all ...`, while keeping `./sage --docbuild DOCUMENT ...` for specific documents?\n\n> I think that's a good idea.\n\nActually, can we do this? I don't know enough about distro use: can we really recommend \"make doc\" and \"make doc-pdf\" as replacements?",
    "created_at": "2021-06-12T23:07:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514184",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:44" align="right">comment:44</div>

Replying to [@mkoeppe](#comment:38):
> Replying to [@jhpalmieri](#comment:35):
> > Do we want to deprecate the use of `./sage --docbuild all ...`, while keeping `./sage --docbuild DOCUMENT ...` for specific documents?

> I think that's a good idea.

Actually, can we do this? I don't know enough about distro use: can we really recommend "make doc" and "make doc-pdf" as replacements?



---

archive/issue_comments_514185.json:
```json
{
    "body": "<div id=\"comment:45\" align=\"right\">comment:45</div>\n\nReplying to [@jhpalmieri](#comment:44):\n> Replying to [@mkoeppe](#comment:38):\n> > Replying to [@jhpalmieri](#comment:35):\n> > > Do we want to deprecate the use of `./sage --docbuild all ...`, while keeping `./sage --docbuild DOCUMENT ...` for specific documents?\n\n> > I think that's a good idea.\n\n> \n> Actually, can we do this? I don't know enough about distro use: can we really recommend \"make doc\" and \"make doc-pdf\" as replacements?\n\nI'd say just adding a deprecation warning won't break anything.\n\nHaving these make recipes in our main Makefile probably shouldn't be the final form of this. \nIn #31356, I hope that we can restructure the docbuild as script packages (`sagemath_doc_html`, `sagemath_doc_pdf`), and in the next step as pip-installable packages (#29868).",
    "created_at": "2021-06-12T23:48:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514185",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:45" align="right">comment:45</div>

Replying to [@jhpalmieri](#comment:44):
> Replying to [@mkoeppe](#comment:38):
> > Replying to [@jhpalmieri](#comment:35):
> > > Do we want to deprecate the use of `./sage --docbuild all ...`, while keeping `./sage --docbuild DOCUMENT ...` for specific documents?

> > I think that's a good idea.

> 
> Actually, can we do this? I don't know enough about distro use: can we really recommend "make doc" and "make doc-pdf" as replacements?

I'd say just adding a deprecation warning won't break anything.

Having these make recipes in our main Makefile probably shouldn't be the final form of this. 
In #31356, I hope that we can restructure the docbuild as script packages (`sagemath_doc_html`, `sagemath_doc_pdf`), and in the next step as pip-installable packages (#29868).



---

archive/issue_comments_514186.json:
```json
{
    "body": "<div id=\"comment:46\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6f60fd9f66622f2d6878de9ccad4752e107fe178\">6f60fd9</a></td><td><code>trac 31948: deprecate \"sage --docbuild all ...\"</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4057d34ba4a3af97680d46f3b5b9186bbe22f7c5\">4057d34</a></td><td><code>trac 31948: implement \"sage --docbuild reference_top FORMAT\"</code></td></tr></table>\n",
    "created_at": "2021-06-13T21:03:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514186",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:46"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6f60fd9f66622f2d6878de9ccad4752e107fe178">6f60fd9</a></td><td><code>trac 31948: deprecate "sage --docbuild all ..."</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4057d34ba4a3af97680d46f3b5b9186bbe22f7c5">4057d34</a></td><td><code>trac 31948: implement "sage --docbuild reference_top FORMAT"</code></td></tr></table>




---

archive/issue_comments_514187.json:
```json
{
    "body": "Changed commit from **[`501d3fa`](https://github.com/sagemath/sagetrac-mirror/commit/501d3fa85311bdaf07f5f77a776d6869ce789d98)** to **[`4057d34`](https://github.com/sagemath/sagetrac-mirror/commit/4057d34ba4a3af97680d46f3b5b9186bbe22f7c5)**",
    "created_at": "2021-06-13T21:03:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514187",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`501d3fa`](https://github.com/sagemath/sagetrac-mirror/commit/501d3fa85311bdaf07f5f77a776d6869ce789d98)** to **[`4057d34`](https://github.com/sagemath/sagetrac-mirror/commit/4057d34ba4a3af97680d46f3b5b9186bbe22f7c5)**



---

archive/issue_comments_514188.json:
```json
{
    "body": "<div id=\"comment:47\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0fee9392e1ba167b26dc8b10525f6e582cd5b310\">0fee939</a></td><td><code>trac 31948: implement \"sage --docbuild reference_top FORMAT\"</code></td></tr></table>\n",
    "created_at": "2021-06-13T21:05:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514188",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:47"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0fee9392e1ba167b26dc8b10525f6e582cd5b310">0fee939</a></td><td><code>trac 31948: implement "sage --docbuild reference_top FORMAT"</code></td></tr></table>




---

archive/issue_comments_514189.json:
```json
{
    "body": "Changed commit from **[`4057d34`](https://github.com/sagemath/sagetrac-mirror/commit/4057d34ba4a3af97680d46f3b5b9186bbe22f7c5)** to **[`0fee939`](https://github.com/sagemath/sagetrac-mirror/commit/0fee9392e1ba167b26dc8b10525f6e582cd5b310)**",
    "created_at": "2021-06-13T21:05:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514189",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`4057d34`](https://github.com/sagemath/sagetrac-mirror/commit/4057d34ba4a3af97680d46f3b5b9186bbe22f7c5)** to **[`0fee939`](https://github.com/sagemath/sagetrac-mirror/commit/0fee9392e1ba167b26dc8b10525f6e582cd5b310)**



---

archive/issue_comments_514190.json:
```json
{
    "body": "<div id=\"comment:48\" align=\"right\">comment:48</div>\n\nOkay, here is a deprecation warning, plus my attempt to add a builder for just the top-level reference manual document(s). It looks like it works, but it needs more testing.",
    "created_at": "2021-06-13T21:06:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514190",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:48" align="right">comment:48</div>

Okay, here is a deprecation warning, plus my attempt to add a builder for just the top-level reference manual document(s). It looks like it works, but it needs more testing.



---

archive/issue_comments_514191.json:
```json
{
    "body": "<div id=\"comment:49\" align=\"right\">comment:49</div>\n\n(In general I feel like the docbuilding code should be torn down and rebuilt from scratch; I find it very confusing and hard to work with.)",
    "created_at": "2021-06-13T21:06:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514191",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:49" align="right">comment:49</div>

(In general I feel like the docbuilding code should be torn down and rebuilt from scratch; I find it very confusing and hard to work with.)



---

archive/issue_comments_514192.json:
```json
{
    "body": "<div id=\"comment:50\" align=\"right\">comment:50</div>\n\nThe HTML build seems to work well for me, even with high parallelization. PDF stops somewhere with LaTeX complaining about an undefined reference and some unicode characters, but that may be coming from some tickets that I have merged into my development branch.\n\nI'd say let's get this in and see how this works for other people",
    "created_at": "2021-06-13T22:52:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514192",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:50" align="right">comment:50</div>

The HTML build seems to work well for me, even with high parallelization. PDF stops somewhere with LaTeX complaining about an undefined reference and some unicode characters, but that may be coming from some tickets that I have merged into my development branch.

I'd say let's get this in and see how this works for other people



---

archive/issue_comments_514193.json:
```json
{
    "body": "Reviewer: **Matthias Koeppe, ...**",
    "created_at": "2021-06-13T22:52:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514193",
    "user": "https://github.com/mkoeppe"
}
```

Reviewer: **Matthias Koeppe, ...**



---

archive/issue_comments_514194.json:
```json
{
    "body": "<div id=\"comment:51\" align=\"right\">comment:51</div>\n\n\n```\n[docpdf] Latexmk: Log file says output to 'combinat.pdf'\n[docpdf] Latexmk: List of undefined refs and citations:\n[docpdf]   Reference `index:module-sage.combinat' on page 3639 undefined on input line 348243\n[docpdf] Latexmk: Summary of warnings from last run of *latex:\n[docpdf]   Latex failed to resolve 1 reference(s)\n[docpdf]   =====Latex reported missing or unavailable character(s).\n[docpdf] =====See log file for details.\n```",
    "created_at": "2021-06-13T22:53:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514194",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:51" align="right">comment:51</div>


```
[docpdf] Latexmk: Log file says output to 'combinat.pdf'
[docpdf] Latexmk: List of undefined refs and citations:
[docpdf]   Reference `index:module-sage.combinat' on page 3639 undefined on input line 348243
[docpdf] Latexmk: Summary of warnings from last run of *latex:
[docpdf]   Latex failed to resolve 1 reference(s)
[docpdf]   =====Latex reported missing or unavailable character(s).
[docpdf] =====See log file for details.
```



---

archive/issue_comments_514195.json:
```json
{
    "body": "Changed commit from **[`0fee939`](https://github.com/sagemath/sagetrac-mirror/commit/0fee9392e1ba167b26dc8b10525f6e582cd5b310)** to **[`1c41284`](https://github.com/sagemath/sagetrac-mirror/commit/1c412844148e4429918bc4035cb8c755a270ecc1)**",
    "created_at": "2021-06-13T22:57:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514195",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`0fee939`](https://github.com/sagemath/sagetrac-mirror/commit/0fee9392e1ba167b26dc8b10525f6e582cd5b310)** to **[`1c41284`](https://github.com/sagemath/sagetrac-mirror/commit/1c412844148e4429918bc4035cb8c755a270ecc1)**



---

archive/issue_comments_514196.json:
```json
{
    "body": "<div id=\"comment:52\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1c412844148e4429918bc4035cb8c755a270ecc1\">1c41284</a></td><td><code>trac 31948: implement \"sage --docbuild reference_top FORMAT\"</code></td></tr></table>\n",
    "created_at": "2021-06-13T22:57:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514196",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:52"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1c412844148e4429918bc4035cb8c755a270ecc1">1c41284</a></td><td><code>trac 31948: implement "sage --docbuild reference_top FORMAT"</code></td></tr></table>




---

archive/issue_comments_514197.json:
```json
{
    "body": "<div id=\"comment:53\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b17b67463aaa3c0fa4d1e8d54711aeccabda3327\">b17b674</a></td><td><code>trac 31948: implement \"sage --docbuild reference_top FORMAT\"</code></td></tr></table>\n",
    "created_at": "2021-06-14T00:58:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514197",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:53"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b17b67463aaa3c0fa4d1e8d54711aeccabda3327">b17b674</a></td><td><code>trac 31948: implement "sage --docbuild reference_top FORMAT"</code></td></tr></table>




---

archive/issue_comments_514198.json:
```json
{
    "body": "Changed commit from **[`1c41284`](https://github.com/sagemath/sagetrac-mirror/commit/1c412844148e4429918bc4035cb8c755a270ecc1)** to **[`b17b674`](https://github.com/sagemath/sagetrac-mirror/commit/b17b67463aaa3c0fa4d1e8d54711aeccabda3327)**",
    "created_at": "2021-06-14T00:58:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514198",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`1c41284`](https://github.com/sagemath/sagetrac-mirror/commit/1c412844148e4429918bc4035cb8c755a270ecc1)** to **[`b17b674`](https://github.com/sagemath/sagetrac-mirror/commit/b17b67463aaa3c0fa4d1e8d54711aeccabda3327)**



---

archive/issue_comments_514199.json:
```json
{
    "body": "<div id=\"comment:54\" align=\"right\">comment:54</div>\n\nI'm struggling to get this to work. The current branch works for me when building the html documentation with `make doc`, but `./sage --docbuild all html` fails with\n\n```\nError building the documentation.\nTraceback (most recent call last):\n  File \"/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py\", line 197, in _run_module_as_main\n    return _run_code(code, main_globals, None,\n  File \"/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py\", line 87, in _run_code\n    exec(code, run_globals)\n  File \"/Users/palmieri/Desktop/Sage/git/sage/local/lib/python3.9/site-packages/sage_docbuild/__main__.py\", line 2, in <module>\n    main()\n  File \"/Users/palmieri/Desktop/Sage/git/sage/local/lib/python3.9/site-packages/sage_docbuild/__init__.py\", line 1811, in main\n    builder()\n  File \"/Users/palmieri/Desktop/Sage/git/sage/local/lib/python3.9/site-packages/sage_docbuild/__init__.py\", line 345, in _wrapper\n    getattr(get_builder(document), 'inventory')(*args, **kwds)\n  File \"/Users/palmieri/Desktop/Sage/git/sage/local/lib/python3.9/site-packages/sage_docbuild/__init__.py\", line 589, in _wrapper\n    self._build_top_level(format, *args, **kwds)\n  File \"/Users/palmieri/Desktop/Sage/git/sage/local/lib/python3.9/site-packages/sage_docbuild/__init__.py\", line 571, in _build_top_level\n    getattr(ReferenceTopBuilder(), format)(*args, **kwds)\n  File \"/Users/palmieri/Desktop/Sage/git/sage/local/lib/python3.9/site-packages/sage_docbuild/__init__.py\", line 627, in __init__\n    DocBuilder.__init__(self, *args, **kwds)\nTypeError: __init__() missing 1 required positional argument: 'name'\n```\nIf I add an argument, for example `\"reference\"`, to the call\n\n```\n        DocBuilder.__init__(self, *args, **kwds)\n```\nin `ReferenceTopBuilder.__init__`, then `make doc` fails.",
    "created_at": "2021-06-14T01:01:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514199",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:54" align="right">comment:54</div>

I'm struggling to get this to work. The current branch works for me when building the html documentation with `make doc`, but `./sage --docbuild all html` fails with

```
Error building the documentation.
Traceback (most recent call last):
  File "/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py", line 197, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py", line 87, in _run_code
    exec(code, run_globals)
  File "/Users/palmieri/Desktop/Sage/git/sage/local/lib/python3.9/site-packages/sage_docbuild/__main__.py", line 2, in <module>
    main()
  File "/Users/palmieri/Desktop/Sage/git/sage/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 1811, in main
    builder()
  File "/Users/palmieri/Desktop/Sage/git/sage/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 345, in _wrapper
    getattr(get_builder(document), 'inventory')(*args, **kwds)
  File "/Users/palmieri/Desktop/Sage/git/sage/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 589, in _wrapper
    self._build_top_level(format, *args, **kwds)
  File "/Users/palmieri/Desktop/Sage/git/sage/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 571, in _build_top_level
    getattr(ReferenceTopBuilder(), format)(*args, **kwds)
  File "/Users/palmieri/Desktop/Sage/git/sage/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 627, in __init__
    DocBuilder.__init__(self, *args, **kwds)
TypeError: __init__() missing 1 required positional argument: 'name'
```
If I add an argument, for example `"reference"`, to the call

```
        DocBuilder.__init__(self, *args, **kwds)
```
in `ReferenceTopBuilder.__init__`, then `make doc` fails.



---

archive/issue_comments_514200.json:
```json
{
    "body": "Changed commit from **[`b17b674`](https://github.com/sagemath/sagetrac-mirror/commit/b17b67463aaa3c0fa4d1e8d54711aeccabda3327)** to **[`06dfb90`](https://github.com/sagemath/sagetrac-mirror/commit/06dfb9097e82dd6d1c95a0f7412f53967d21c217)**",
    "created_at": "2021-06-14T02:32:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514200",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`b17b674`](https://github.com/sagemath/sagetrac-mirror/commit/b17b67463aaa3c0fa4d1e8d54711aeccabda3327)** to **[`06dfb90`](https://github.com/sagemath/sagetrac-mirror/commit/06dfb9097e82dd6d1c95a0f7412f53967d21c217)**



---

archive/issue_comments_514201.json:
```json
{
    "body": "<div id=\"comment:55\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/06dfb9097e82dd6d1c95a0f7412f53967d21c217\">06dfb90</a></td><td><code>trac 31948: fix \"help_documents\"</code></td></tr></table>\n",
    "created_at": "2021-06-14T02:32:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514201",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:55"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/06dfb9097e82dd6d1c95a0f7412f53967d21c217">06dfb90</a></td><td><code>trac 31948: fix "help_documents"</code></td></tr></table>




---

archive/issue_comments_514202.json:
```json
{
    "body": "Changed commit from **[`06dfb90`](https://github.com/sagemath/sagetrac-mirror/commit/06dfb9097e82dd6d1c95a0f7412f53967d21c217)** to **[`8930551`](https://github.com/sagemath/sagetrac-mirror/commit/8930551946875bc8eefd855c2b8cb88828f93a24)**",
    "created_at": "2021-06-14T05:09:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514202",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`06dfb90`](https://github.com/sagemath/sagetrac-mirror/commit/06dfb9097e82dd6d1c95a0f7412f53967d21c217)** to **[`8930551`](https://github.com/sagemath/sagetrac-mirror/commit/8930551946875bc8eefd855c2b8cb88828f93a24)**



---

archive/issue_comments_514203.json:
```json
{
    "body": "<div id=\"comment:56\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8930551946875bc8eefd855c2b8cb88828f93a24\">8930551</a></td><td><code>trac 31948: repair \"sage --docbuild all html\"</code></td></tr></table>\n",
    "created_at": "2021-06-14T05:09:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514203",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:56"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8930551946875bc8eefd855c2b8cb88828f93a24">8930551</a></td><td><code>trac 31948: repair "sage --docbuild all html"</code></td></tr></table>




---

archive/issue_comments_514204.json:
```json
{
    "body": "<div id=\"comment:57\" align=\"right\">comment:57</div>\n\nI think that fixes my problem. I've seen the combinat.pdf failure once, but I can't reproduce it. I'll keep trying.",
    "created_at": "2021-06-14T05:09:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514204",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:57" align="right">comment:57</div>

I think that fixes my problem. I've seen the combinat.pdf failure once, but I can't reproduce it. I'll keep trying.



---

archive/issue_comments_514205.json:
```json
{
    "body": "<div id=\"comment:58\" align=\"right\">comment:58</div>\n\non Lunix I am seeing\n\n```\n[dochtml] [combinat ] updating environment: [new config] 382 added, 0 changed, 0 removed\n[dochtml] [manifolds] building [inventory]: targets for 81 source files that are out of date\n[dochtml] [manifolds] updating environment: [new config] 81 added, 0 changed, 0 removed\n[dochtml] Error, reached the pre-set memory limit\n[dochtml] (change it with the -o command line option)\n[dochtml] Error, was not in any namespace\n```\nnot sure what limit is involved here and why.",
    "created_at": "2021-06-14T09:26:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514205",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:58" align="right">comment:58</div>

on Lunix I am seeing

```
[dochtml] [combinat ] updating environment: [new config] 382 added, 0 changed, 0 removed
[dochtml] [manifolds] building [inventory]: targets for 81 source files that are out of date
[dochtml] [manifolds] updating environment: [new config] 81 added, 0 changed, 0 removed
[dochtml] Error, reached the pre-set memory limit
[dochtml] (change it with the -o command line option)
[dochtml] Error, was not in any namespace
```
not sure what limit is involved here and why.



---

archive/issue_comments_514206.json:
```json
{
    "body": "<div id=\"comment:59\" align=\"right\">comment:59</div>\n\notherwise, all works on Linux, both html and pdf builds.",
    "created_at": "2021-06-14T12:15:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514206",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:59" align="right">comment:59</div>

otherwise, all works on Linux, both html and pdf builds.



---

archive/issue_comments_514207.json:
```json
{
    "body": "<div id=\"comment:60\" align=\"right\">comment:60</div>\n\nReplying to [@dimpase](#comment:58):\n> on Lunix I am seeing\n> \n> ```\n> [dochtml] [combinat ] updating environment: [new config] 382 added, 0 changed, 0 removed\n> [dochtml] [manifolds] building [inventory]: targets for 81 source files that are out of date\n> [dochtml] [manifolds] updating environment: [new config] 81 added, 0 changed, 0 removed\n> [dochtml] Error, reached the pre-set memory limit\n> [dochtml] (change it with the -o command line option)\n> [dochtml] Error, was not in any namespace\n> ```\n> not sure what limit is involved here and why.\n\nIs that error new? Is it repeatable?",
    "created_at": "2021-06-14T16:53:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514207",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:60" align="right">comment:60</div>

Replying to [@dimpase](#comment:58):
> on Lunix I am seeing
> 
> ```
> [dochtml] [combinat ] updating environment: [new config] 382 added, 0 changed, 0 removed
> [dochtml] [manifolds] building [inventory]: targets for 81 source files that are out of date
> [dochtml] [manifolds] updating environment: [new config] 81 added, 0 changed, 0 removed
> [dochtml] Error, reached the pre-set memory limit
> [dochtml] (change it with the -o command line option)
> [dochtml] Error, was not in any namespace
> ```
> not sure what limit is involved here and why.

Is that error new? Is it repeatable?



---

archive/issue_comments_514208.json:
```json
{
    "body": "<div id=\"comment:61\" align=\"right\">comment:61</div>\n\nit might be due to the new GAP 4.11.1 I have in my branch (this message comes from GAP, that's certain).\nLet's ignore it now. I'll try to reproduce it on another system.",
    "created_at": "2021-06-14T18:13:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514208",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:61" align="right">comment:61</div>

it might be due to the new GAP 4.11.1 I have in my branch (this message comes from GAP, that's certain).
Let's ignore it now. I'll try to reproduce it on another system.



---

archive/issue_comments_514209.json:
```json
{
    "body": "<div id=\"comment:62\" align=\"right\">comment:62</div>\n\nThis also works for me with the Sphinx upgrade at #31696.",
    "created_at": "2021-06-15T01:59:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514209",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:62" align="right">comment:62</div>

This also works for me with the Sphinx upgrade at #31696.



---

archive/issue_comments_514210.json:
```json
{
    "body": "<div id=\"comment:63\" align=\"right\">comment:63</div>\n\nI wonder if it is easy to get rid of build_many(), and replace it by a make-based parallelisation.",
    "created_at": "2021-06-15T08:54:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514210",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:63" align="right">comment:63</div>

I wonder if it is easy to get rid of build_many(), and replace it by a make-based parallelisation.



---

archive/issue_comments_514211.json:
```json
{
    "body": "<div id=\"comment:64\" align=\"right\">comment:64</div>\n\nReplying to [@dimpase](#comment:63):\n> I wonder if it is easy to get rid of build_many(), and replace it by a make-based parallelisation.\n\nProbably, but on another ticket. Should we start using `src/doc/Makefile` for more than just cleaning? As I said earlier, I am unclear on the distro situation: I don't know what packages are going to be available in general, and in particular in this case: if we have the documentation source files, can we be guaranteed to have `sage_docbuild`?\n\nIn any case, this may all fit somehow into #31356 and related tickets.",
    "created_at": "2021-06-15T16:40:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514211",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:64" align="right">comment:64</div>

Replying to [@dimpase](#comment:63):
> I wonder if it is easy to get rid of build_many(), and replace it by a make-based parallelisation.

Probably, but on another ticket. Should we start using `src/doc/Makefile` for more than just cleaning? As I said earlier, I am unclear on the distro situation: I don't know what packages are going to be available in general, and in particular in this case: if we have the documentation source files, can we be guaranteed to have `sage_docbuild`?

In any case, this may all fit somehow into #31356 and related tickets.



---

archive/issue_comments_514212.json:
```json
{
    "body": "<div id=\"comment:65\" align=\"right\">comment:65</div>\n\nReplying to [@jhpalmieri](#comment:64):\n> Replying to [@dimpase](#comment:63):\n> > I wonder if it is easy to get rid of build_many(), and replace it by a make-based parallelisation.\n\n> \n> Probably, but on another ticket. \n\nI agree.\n\n> Should we start using `src/doc/Makefile` for more than just cleaning? \n\nI think that's a good idea. The things that we added in `build/make/Makefile.in` could just be moved there.",
    "created_at": "2021-06-15T16:51:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514212",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:65" align="right">comment:65</div>

Replying to [@jhpalmieri](#comment:64):
> Replying to [@dimpase](#comment:63):
> > I wonder if it is easy to get rid of build_many(), and replace it by a make-based parallelisation.

> 
> Probably, but on another ticket. 

I agree.

> Should we start using `src/doc/Makefile` for more than just cleaning? 

I think that's a good idea. The things that we added in `build/make/Makefile.in` could just be moved there.



---

archive/issue_comments_514213.json:
```json
{
    "body": "<div id=\"comment:66\" align=\"right\">comment:66</div>\n\nReplying to [@mkoeppe](#comment:65):\n> Replying to [@jhpalmieri](#comment:64):\n> > Should we start using `src/doc/Makefile` for more than just cleaning? \n\n> \n> I think that's a good idea. The things that we added in `build/make/Makefile.in` could just be moved there.\n\nI'm experimenting with this and it seems to be working. A few questions about our Makefiles:\n\n- Where is SAGE_ROOT defined? It appears to work if I just use it in `src/doc/Makefile`, but I don't know why.\n\n- Do I need to use `+$(MAKE_REC)` or can I just use `$(MAKE)`? The latter seems to work.\n\n- Do I need to define `AM_V_at` in this Makefile, or does it inherit the definition from `build/make/Makefile`?",
    "created_at": "2021-06-15T18:14:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514213",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:66" align="right">comment:66</div>

Replying to [@mkoeppe](#comment:65):
> Replying to [@jhpalmieri](#comment:64):
> > Should we start using `src/doc/Makefile` for more than just cleaning? 

> 
> I think that's a good idea. The things that we added in `build/make/Makefile.in` could just be moved there.

I'm experimenting with this and it seems to be working. A few questions about our Makefiles:

- Where is SAGE_ROOT defined? It appears to work if I just use it in `src/doc/Makefile`, but I don't know why.

- Do I need to use `+$(MAKE_REC)` or can I just use `$(MAKE)`? The latter seems to work.

- Do I need to define `AM_V_at` in this Makefile, or does it inherit the definition from `build/make/Makefile`?



---

archive/issue_comments_514214.json:
```json
{
    "body": "<div id=\"comment:67\" align=\"right\">comment:67</div>\n\nReplying to [@jhpalmieri](#comment:66):\n> Replying to [@mkoeppe](#comment:65):\n> > Replying to [@jhpalmieri](#comment:64):\n> > > Should we start using `src/doc/Makefile` for more than just cleaning? \n\n> > \n> > I think that's a good idea. The things that we added in `build/make/Makefile.in` could just be moved there.\n\n> \n> I'm experimenting with this and it seems to be working. A few questions about our Makefiles:\n> \n> - Where is SAGE_ROOT defined? It appears to work if I just use it in `src/doc/Makefile`, but I don't know why.\n\nIt comes from the environment and is set in `build/make/install`. \n\n> - Do I need to use `+$(MAKE_REC)` or can I just use `$(MAKE)`? The latter seems to work.\n\n`$(MAKE)` is fine here - https://www.gnu.org/software/make/manual/make.html#MAKE-Variable\n\n> - Do I need to define `AM_V_at` in this Makefile, or does it inherit the definition from `build/make/Makefile`?\n\nYou'd need to copy this definition from Makefile.in; it's not exported",
    "created_at": "2021-06-15T19:08:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514214",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:67" align="right">comment:67</div>

Replying to [@jhpalmieri](#comment:66):
> Replying to [@mkoeppe](#comment:65):
> > Replying to [@jhpalmieri](#comment:64):
> > > Should we start using `src/doc/Makefile` for more than just cleaning? 

> > 
> > I think that's a good idea. The things that we added in `build/make/Makefile.in` could just be moved there.

> 
> I'm experimenting with this and it seems to be working. A few questions about our Makefiles:
> 
> - Where is SAGE_ROOT defined? It appears to work if I just use it in `src/doc/Makefile`, but I don't know why.

It comes from the environment and is set in `build/make/install`. 

> - Do I need to use `+$(MAKE_REC)` or can I just use `$(MAKE)`? The latter seems to work.

`$(MAKE)` is fine here - https://www.gnu.org/software/make/manual/make.html#MAKE-Variable

> - Do I need to define `AM_V_at` in this Makefile, or does it inherit the definition from `build/make/Makefile`?

You'd need to copy this definition from Makefile.in; it's not exported



---

archive/issue_comments_514215.json:
```json
{
    "body": "<div id=\"comment:68\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/522b4508e2686a118e4c5dfb0d0bd09f89b4aa00\">522b450</a></td><td><code>trac 31948: use src/doc/Makefile for docbuilding commands</code></td></tr></table>\n",
    "created_at": "2021-06-15T20:19:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514215",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:68"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/522b4508e2686a118e4c5dfb0d0bd09f89b4aa00">522b450</a></td><td><code>trac 31948: use src/doc/Makefile for docbuilding commands</code></td></tr></table>




---

archive/issue_comments_514216.json:
```json
{
    "body": "Changed commit from **[`8930551`](https://github.com/sagemath/sagetrac-mirror/commit/8930551946875bc8eefd855c2b8cb88828f93a24)** to **[`522b450`](https://github.com/sagemath/sagetrac-mirror/commit/522b4508e2686a118e4c5dfb0d0bd09f89b4aa00)**",
    "created_at": "2021-06-15T20:19:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514216",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`8930551`](https://github.com/sagemath/sagetrac-mirror/commit/8930551946875bc8eefd855c2b8cb88828f93a24)** to **[`522b450`](https://github.com/sagemath/sagetrac-mirror/commit/522b4508e2686a118e4c5dfb0d0bd09f89b4aa00)**



---

archive/issue_comments_514217.json:
```json
{
    "body": "<div id=\"comment:69\" align=\"right\">comment:69</div>\n\nThat's helpful, thank you. Here's an attempt. I'm not sure how to handle `SAGE_ROOT` in `src/doc/Makefile`: if it's not set, exit with an error? That's my current approach.\n\nThe new branch keeps the logging in `build/make/Makefile`: if someone wants to use `src/doc/Makefile` to build the documentation, maybe they don't want it logged. This seems consistent with how we do logging in general. It does mean that `make doc-pdf` logs all docbuilding, including inventory building, in `docpdf.log`, whereas it used to put the inventory logs into `dochtml.log`.",
    "created_at": "2021-06-15T20:21:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514217",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:69" align="right">comment:69</div>

That's helpful, thank you. Here's an attempt. I'm not sure how to handle `SAGE_ROOT` in `src/doc/Makefile`: if it's not set, exit with an error? That's my current approach.

The new branch keeps the logging in `build/make/Makefile`: if someone wants to use `src/doc/Makefile` to build the documentation, maybe they don't want it logged. This seems consistent with how we do logging in general. It does mean that `make doc-pdf` logs all docbuilding, including inventory building, in `docpdf.log`, whereas it used to put the inventory logs into `dochtml.log`.



---

archive/issue_comments_514218.json:
```json
{
    "body": "Changed commit from **[`522b450`](https://github.com/sagemath/sagetrac-mirror/commit/522b4508e2686a118e4c5dfb0d0bd09f89b4aa00)** to **[`3d90c59`](https://github.com/sagemath/sagetrac-mirror/commit/3d90c59461f5d1c656e6b972809c89468c92a334)**",
    "created_at": "2021-06-15T20:49:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514218",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`522b450`](https://github.com/sagemath/sagetrac-mirror/commit/522b4508e2686a118e4c5dfb0d0bd09f89b4aa00)** to **[`3d90c59`](https://github.com/sagemath/sagetrac-mirror/commit/3d90c59461f5d1c656e6b972809c89468c92a334)**



---

archive/issue_comments_514219.json:
```json
{
    "body": "<div id=\"comment:70\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3d90c59461f5d1c656e6b972809c89468c92a334\">3d90c59</a></td><td><code>trac 31948: use src/doc/Makefile for docbuilding commands</code></td></tr></table>\n",
    "created_at": "2021-06-15T20:49:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514219",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:70"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3d90c59461f5d1c656e6b972809c89468c92a334">3d90c59</a></td><td><code>trac 31948: use src/doc/Makefile for docbuilding commands</code></td></tr></table>




---

archive/issue_comments_514220.json:
```json
{
    "body": "Changed commit from **[`3d90c59`](https://github.com/sagemath/sagetrac-mirror/commit/3d90c59461f5d1c656e6b972809c89468c92a334)** to **[`2c3a9ae`](https://github.com/sagemath/sagetrac-mirror/commit/2c3a9ae60a5f101f958ca711a413c2d27a61aa17)**",
    "created_at": "2021-06-16T02:04:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514220",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`3d90c59`](https://github.com/sagemath/sagetrac-mirror/commit/3d90c59461f5d1c656e6b972809c89468c92a334)** to **[`2c3a9ae`](https://github.com/sagemath/sagetrac-mirror/commit/2c3a9ae60a5f101f958ca711a413c2d27a61aa17)**



---

archive/issue_comments_514221.json:
```json
{
    "body": "<div id=\"comment:71\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2c3a9ae60a5f101f958ca711a413c2d27a61aa17\">2c3a9ae</a></td><td><code>trac 31948: move some \"$(AM_V_at)\"s around</code></td></tr></table>\n",
    "created_at": "2021-06-16T02:04:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514221",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:71"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2c3a9ae60a5f101f958ca711a413c2d27a61aa17">2c3a9ae</a></td><td><code>trac 31948: move some "$(AM_V_at)"s around</code></td></tr></table>




---

archive/issue_comments_514222.json:
```json
{
    "body": "Changed commit from **[`2c3a9ae`](https://github.com/sagemath/sagetrac-mirror/commit/2c3a9ae60a5f101f958ca711a413c2d27a61aa17)** to **[`54e68e0`](https://github.com/sagemath/sagetrac-mirror/commit/54e68e068e64d7a8650c474cf5b24af91c0baad5)**",
    "created_at": "2021-06-16T02:04:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514222",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`2c3a9ae`](https://github.com/sagemath/sagetrac-mirror/commit/2c3a9ae60a5f101f958ca711a413c2d27a61aa17)** to **[`54e68e0`](https://github.com/sagemath/sagetrac-mirror/commit/54e68e068e64d7a8650c474cf5b24af91c0baad5)**



---

archive/issue_comments_514223.json:
```json
{
    "body": "<div id=\"comment:72\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/54e68e068e64d7a8650c474cf5b24af91c0baad5\">54e68e0</a></td><td><code>trac 31948: move some \"$(AM_V_at)\"s around</code></td></tr></table>\n",
    "created_at": "2021-06-16T02:04:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514223",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:72"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/54e68e068e64d7a8650c474cf5b24af91c0baad5">54e68e0</a></td><td><code>trac 31948: move some "$(AM_V_at)"s around</code></td></tr></table>




---

archive/issue_comments_514224.json:
```json
{
    "body": "<div id=\"comment:73\" align=\"right\">comment:73</div>\n\nOkay, I think I'm done tinkering now.",
    "created_at": "2021-06-16T04:01:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514224",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:73" align="right">comment:73</div>

Okay, I think I'm done tinkering now.



---

archive/issue_events_440580.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-06-16T05:24:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31948#event-440580"
}
```



---

archive/issue_comments_514225.json:
```json
{
    "body": "<div id=\"comment:75\" align=\"right\">comment:75</div>\n\nLooks good and seems to work well. Positive review from my side",
    "created_at": "2021-06-16T06:02:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514225",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:75" align="right">comment:75</div>

Looks good and seems to work well. Positive review from my side



---

archive/issue_comments_514226.json:
```json
{
    "body": "<div id=\"comment:76\" align=\"right\">comment:76</div>\n\nDima, any comments? I'm happy with Matthias' contributions.",
    "created_at": "2021-06-16T17:13:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514226",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:76" align="right">comment:76</div>

Dima, any comments? I'm happy with Matthias' contributions.



---

archive/issue_comments_514227.json:
```json
{
    "body": "Changed reviewer from **Matthias Koeppe, ...** to **Matthias Koeppe, John Palmieri, ...**",
    "created_at": "2021-06-16T21:56:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514227",
    "user": "https://github.com/jhpalmieri"
}
```

Changed reviewer from **Matthias Koeppe, ...** to **Matthias Koeppe, John Palmieri, ...**



---

archive/issue_comments_514228.json:
```json
{
    "body": "Changed commit from **[`54e68e0`](https://github.com/sagemath/sagetrac-mirror/commit/54e68e068e64d7a8650c474cf5b24af91c0baad5)** to **[`53f260c`](https://github.com/sagemath/sagetrac-mirror/commit/53f260c1b355fc623cf8feed858614a87133028d)**",
    "created_at": "2021-06-16T23:33:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514228",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`54e68e0`](https://github.com/sagemath/sagetrac-mirror/commit/54e68e068e64d7a8650c474cf5b24af91c0baad5)** to **[`53f260c`](https://github.com/sagemath/sagetrac-mirror/commit/53f260c1b355fc623cf8feed858614a87133028d)**



---

archive/issue_comments_514229.json:
```json
{
    "body": "<div id=\"comment:78\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/53f260c1b355fc623cf8feed858614a87133028d\">53f260c</a></td><td><code>trac 31948: fix doctests</code></td></tr></table>\n",
    "created_at": "2021-06-16T23:33:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514229",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:78"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/53f260c1b355fc623cf8feed858614a87133028d">53f260c</a></td><td><code>trac 31948: fix doctests</code></td></tr></table>




---

archive/issue_comments_514230.json:
```json
{
    "body": "<div id=\"comment:79\" align=\"right\">comment:79</div>\n\nlooks good, thanks!",
    "created_at": "2021-06-17T10:22:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514230",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:79" align="right">comment:79</div>

looks good, thanks!



---

archive/issue_comments_514231.json:
```json
{
    "body": "Changed reviewer from **Matthias Koeppe, John Palmieri, ...** to **Matthias Koeppe, John Palmieri, Dima Pasechnik**",
    "created_at": "2021-06-17T10:22:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514231",
    "user": "https://github.com/dimpase"
}
```

Changed reviewer from **Matthias Koeppe, John Palmieri, ...** to **Matthias Koeppe, John Palmieri, Dima Pasechnik**



---

archive/issue_events_440581.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-06-17T10:22:54Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31948#event-440581"
}
```



---

archive/issue_events_440582.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-06-17T10:22:54Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31948#event-440582"
}
```



---

archive/issue_comments_514232.json:
```json
{
    "body": "<div id=\"comment:80\" align=\"right\">comment:80</div>\n\nGreat, thank you!",
    "created_at": "2021-06-17T16:09:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514232",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:80" align="right">comment:80</div>

Great, thank you!



---

archive/issue_events_440583.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-06-17T17:30:19Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31948#event-440583"
}
```



---

archive/issue_events_440584.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-06-17T17:30:19Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "label": "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p: 1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31948#event-440584"
}
```



---

archive/issue_comments_514233.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,3 @@\n Based on #31353 (`sage --docbuild`: Add options to list all documents), we can remove the issues with parallel (#31344) and serial (#31936) docbuild by restructuring the docbuild using `make`.\n \n-\n+Blocker because it solves blocker issue #31936.\n``````\n",
    "created_at": "2021-06-17T17:30:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514233",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,3 @@
 Based on #31353 (`sage --docbuild`: Add options to list all documents), we can remove the issues with parallel (#31344) and serial (#31936) docbuild by restructuring the docbuild using `make`.
 
-
+Blocker because it solves blocker issue #31936.
``````




---

archive/issue_events_440585.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-06-20T08:14:49Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31948#event-440585"
}
```



---

archive/issue_events_440586.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "4795abb8cf538a8639a8401edd62c55bb965786e",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2021-06-20T08:14:49Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31948#event-440586"
}
```



---

archive/issue_comments_514234.json:
```json
{
    "body": "Changed branch from **[u/jhpalmieri/parallel-docbuild-with-make](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/parallel-docbuild-with-make)** to **[`53f260c`](https://github.com/sagemath/sagetrac-mirror/commit/53f260c1b355fc623cf8feed858614a87133028d)**",
    "created_at": "2021-06-20T08:14:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514234",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/jhpalmieri/parallel-docbuild-with-make](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/parallel-docbuild-with-make)** to **[`53f260c`](https://github.com/sagemath/sagetrac-mirror/commit/53f260c1b355fc623cf8feed858614a87133028d)**



---

archive/issue_comments_514235.json:
```json
{
    "body": "Changed commit from **[`53f260c`](https://github.com/sagemath/sagetrac-mirror/commit/53f260c1b355fc623cf8feed858614a87133028d)** to none",
    "created_at": "2021-06-23T04:05:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514235",
    "user": "https://github.com/kwankyu"
}
```

Changed commit from **[`53f260c`](https://github.com/sagemath/sagetrac-mirror/commit/53f260c1b355fc623cf8feed858614a87133028d)** to none



---

archive/issue_comments_514236.json:
```json
{
    "body": "<div id=\"comment:83\" align=\"right\">comment:83</div>\n\nPreviously `sage --docbuild all pdf` built a main website listing all documentations with icons linking to pdf files. Now it seems that `make doc-pdf` does not build such an website. Is there a way to build the website?",
    "created_at": "2021-06-23T04:05:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514236",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:83" align="right">comment:83</div>

Previously `sage --docbuild all pdf` built a main website listing all documentations with icons linking to pdf files. Now it seems that `make doc-pdf` does not build such an website. Is there a way to build the website?



---

archive/issue_comments_514237.json:
```json
{
    "body": "<div id=\"comment:84\" align=\"right\">comment:84</div>\n\nI've opened #32043 for this",
    "created_at": "2021-06-23T16:00:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514237",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:84" align="right">comment:84</div>

I've opened #32043 for this



---

archive/issue_comments_514238.json:
```json
{
    "body": "<div id=\"comment:85\" align=\"right\">comment:85</div>\n\nI am seeing a race condition, sphinx may race `FileExistsError`, cf. e.g.\n\n```\n[dochtml] [reference] preparing documents... skipping loading of indexes... done\n[dochtml] [reference] Merging js index files...\n[dochtml] [reference]     algebras: 4424 js index entries\n[dochtml] [reference]     arithgroup: 1204 js index entries\n...\n\n[dochtml] [reference]     topology: 1937 js index entries\n[dochtml] [reference]     valuations: 973 js index entries\n[dochtml] [reference] ... done (64387 js index entries)\n[dochtml] [reference] copying static files... failed\n[dochtml] [reference] WARNING: cannot copy static file\nFileExistsError(17, 'File exists')\n[dochtml] [reference] dumping search index in English (code: en)... done\n[dochtml] [reference] The HTML pages are in\nlocal/share/doc/sage/html/en/reference.\n[dochtml] Error building the documentation.\n```\n\n`make -j1`\nallows the docs to build. \n\nSee e.g. https://github.com/sagemath/sagetrac-mirror/runs/3104375540\n\nIt's of course not totally surprising that several processes may try to, say, create the same directory. Perhaps the relevant part of the builder should be launched with this specific error being ignored?",
    "created_at": "2021-07-21T16:54:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514238",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:85" align="right">comment:85</div>

I am seeing a race condition, sphinx may race `FileExistsError`, cf. e.g.

```
[dochtml] [reference] preparing documents... skipping loading of indexes... done
[dochtml] [reference] Merging js index files...
[dochtml] [reference]     algebras: 4424 js index entries
[dochtml] [reference]     arithgroup: 1204 js index entries
...

[dochtml] [reference]     topology: 1937 js index entries
[dochtml] [reference]     valuations: 973 js index entries
[dochtml] [reference] ... done (64387 js index entries)
[dochtml] [reference] copying static files... failed
[dochtml] [reference] WARNING: cannot copy static file
FileExistsError(17, 'File exists')
[dochtml] [reference] dumping search index in English (code: en)... done
[dochtml] [reference] The HTML pages are in
local/share/doc/sage/html/en/reference.
[dochtml] Error building the documentation.
```

`make -j1`
allows the docs to build. 

See e.g. https://github.com/sagemath/sagetrac-mirror/runs/3104375540

It's of course not totally surprising that several processes may try to, say, create the same directory. Perhaps the relevant part of the builder should be launched with this specific error being ignored?



---

archive/issue_comments_514239.json:
```json
{
    "body": "<div id=\"comment:86\" align=\"right\">comment:86</div>\n\nIt's strange because that doesn't look like part of the docbuild process that's done in parallel with anything else: it looks like the main reference page, built after the other parts of the reference manual. How reliably can you reproduce this?\n\nI think this part of the process (copying static files) is controlled by Sphinx, not by Sage or its modifications to Sphinx, for what that's worth.",
    "created_at": "2021-07-21T21:08:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514239",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:86" align="right">comment:86</div>

It's strange because that doesn't look like part of the docbuild process that's done in parallel with anything else: it looks like the main reference page, built after the other parts of the reference manual. How reliably can you reproduce this?

I think this part of the process (copying static files) is controlled by Sphinx, not by Sage or its modifications to Sphinx, for what that's worth.



---

archive/issue_comments_514240.json:
```json
{
    "body": "<div id=\"comment:87\" align=\"right\">comment:87</div>\n\nReplying to [@dimpase](#comment:85):\n> I am seeing a race condition, sphinx may race `FileExistsError`\n\nnew ticket please?",
    "created_at": "2021-07-21T23:46:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514240",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:87" align="right">comment:87</div>

Replying to [@dimpase](#comment:85):
> I am seeing a race condition, sphinx may race `FileExistsError`

new ticket please?



---

archive/issue_comments_514241.json:
```json
{
    "body": "<div id=\"comment:88\" align=\"right\">comment:88</div>\n\nReplying to [@mkoeppe](#comment:87):\n> Replying to [@dimpase](#comment:85):\n> > I am seeing a race condition, sphinx may race `FileExistsError`\n\n> \n> new ticket please?\n\nThis is now #32262",
    "created_at": "2021-07-22T02:03:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31948#issuecomment-514241",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:88" align="right">comment:88</div>

Replying to [@mkoeppe](#comment:87):
> Replying to [@dimpase](#comment:85):
> > I am seeing a race condition, sphinx may race `FileExistsError`

> 
> new ticket please?

This is now #32262
