# Issue 31869: Fix segfault when multiplying x * ((3*i + 4)*x - 5)

archive/issues_031632.json:
```json
{
    "body": "The following crashes Sage:\n\n```\nsage: x = SR.var('x')\nsage: h = (3*I + 4)*x - 5\nsage: x * h  # hangs then crashes\n```\n\nSmall variations work fine:\n\n```\nsage: h = (3*I + 4)*x - 4\nsage: x * h\nx*((3*I + 4)*x - 4)\n```\n\n```\nsage: h = (3*I + 5)*x - 5\nsage: x * h\nx*((3*I + 5)*x - 5)\n```\n\nPriority set to critical as such a simple\noperation should not crash Sage.\n\n---\n\nFrom a [report on sage-support](https://groups.google.com/g/sage-support/c/BLGNjf7319k)\nwhich involved substitutions.\n\nThe original report can be rephrased as follows.\nDefine `f`:\n\n```\nsage: y, z = SR.var('y, z')\nsage: f = -(15*z/(17*y + 11) + 1)*(5*z/(4*y + 1) - 1)*(15*z/(3*y - 4) + 1)\n```\n\nWe want to substitute `y = I` into `f`. Tweaking `f` first works:\n\n```\nsage: f.expand()(y=I)\n-(3735/1394*I + 405/1394)*z^3 - (606/697*I - 942/697)*z^2 - (8681/6970*I + 15973/6970)*z + 1\nsage: f.partial_fraction(y)(y=I)\n-(3735/1394*I + 405/1394)*z^3 - (606/697*I - 942/697)*z^2 - (8681/6970*I + 15973/6970)*z + 1\nsage: f.simplify_full()(y=I)\n-(3735/1394*I + 405/1394)*z^3 - (606/697*I - 942/697)*z^2 - (8681/6970*I + 15973/6970)*z + 1\n```\nbut doing it directly crashes:\n\n```\nsage: f(y=I)  # hangs then crashes\n------------------------------------------------------------------------\n(no backtrace available)\n------------------------------------------------------------------------\nUnhandled SIGSEGV: A segmentation fault occurred.\nThis probably occurred because a *compiled* module has a bug\nin it and is not properly wrapped with sig_on(), sig_off().\nPython will now terminate.\n------------------------------------------------------------------------\n.../src/bin/sage-python: line 2: ... Segmentation fault: 11  sage -python \"$@\"\n```\n\nA simpler example that boils down to the minimal reproducer:\n\n```\nsage: a, x = SR.var('a, x')\nsage: g = x * ((3*a + 4)*x - 5)\nsage: g\n((3*a + 4)*x - 5)*x\nsage: g(a=I)  # hangs then crashes\n------------------------------------------------------------------------\n(no backtrace available)\n------------------------------------------------------------------------\nUnhandled SIGSEGV: A segmentation fault occurred.\nThis probably occurred because a *compiled* module has a bug\nin it and is not properly wrapped with sig_on(), sig_off().\nPython will now terminate.\n------------------------------------------------------------------------\n.../src/bin/sage-python: line 2: ... Segmentation fault: 11  sage -python \"$@\"\n```\n\n**CC:**  @EmmanuelCharpentier @sheerluck @ypfmde @nbruin @slel\n\n**Keywords:** pynac, segfault\n\n**Branch/Commit:** [48f7a070bd168a3a039b6592f035c62a387b02bb](https://github.com/sagemath/sagetrac-mirror/commit/48f7a070bd168a3a039b6592f035c62a387b02bb)\n\n**Reviewer:** Travis Scrimshaw\n\n**Author:** Dave Morris\n\nIssue created by migration from https://trac.sagemath.org/ticket/31869\n\n",
    "closed_at": "2021-06-07T21:40:31Z",
    "created_at": "2021-05-28T13:26:09Z",
    "labels": [
        "component: symbolics",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.4",
    "title": "Fix segfault when multiplying x * ((3*i + 4)*x - 5)",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/31869",
    "user": "https://github.com/EmmanuelCharpentier"
}
```
The following crashes Sage:

```
sage: x = SR.var('x')
sage: h = (3*I + 4)*x - 5
sage: x * h  # hangs then crashes
```

Small variations work fine:

```
sage: h = (3*I + 4)*x - 4
sage: x * h
x*((3*I + 4)*x - 4)
```

```
sage: h = (3*I + 5)*x - 5
sage: x * h
x*((3*I + 5)*x - 5)
```

Priority set to critical as such a simple
operation should not crash Sage.

---

From a [report on sage-support](https://groups.google.com/g/sage-support/c/BLGNjf7319k)
which involved substitutions.

The original report can be rephrased as follows.
Define `f`:

```
sage: y, z = SR.var('y, z')
sage: f = -(15*z/(17*y + 11) + 1)*(5*z/(4*y + 1) - 1)*(15*z/(3*y - 4) + 1)
```

We want to substitute `y = I` into `f`. Tweaking `f` first works:

```
sage: f.expand()(y=I)
-(3735/1394*I + 405/1394)*z^3 - (606/697*I - 942/697)*z^2 - (8681/6970*I + 15973/6970)*z + 1
sage: f.partial_fraction(y)(y=I)
-(3735/1394*I + 405/1394)*z^3 - (606/697*I - 942/697)*z^2 - (8681/6970*I + 15973/6970)*z + 1
sage: f.simplify_full()(y=I)
-(3735/1394*I + 405/1394)*z^3 - (606/697*I - 942/697)*z^2 - (8681/6970*I + 15973/6970)*z + 1
```
but doing it directly crashes:

```
sage: f(y=I)  # hangs then crashes
------------------------------------------------------------------------
(no backtrace available)
------------------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------
.../src/bin/sage-python: line 2: ... Segmentation fault: 11  sage -python "$@"
```

A simpler example that boils down to the minimal reproducer:

```
sage: a, x = SR.var('a, x')
sage: g = x * ((3*a + 4)*x - 5)
sage: g
((3*a + 4)*x - 5)*x
sage: g(a=I)  # hangs then crashes
------------------------------------------------------------------------
(no backtrace available)
------------------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------
.../src/bin/sage-python: line 2: ... Segmentation fault: 11  sage -python "$@"
```

**CC:**  @EmmanuelCharpentier @sheerluck @ypfmde @nbruin @slel

**Keywords:** pynac, segfault

**Branch/Commit:** [48f7a070bd168a3a039b6592f035c62a387b02bb](https://github.com/sagemath/sagetrac-mirror/commit/48f7a070bd168a3a039b6592f035c62a387b02bb)

**Reviewer:** Travis Scrimshaw

**Author:** Dave Morris

Issue created by migration from https://trac.sagemath.org/ticket/31869





---

archive/issue_comments_515062.json:
```json
{
    "body": "<a id='comment:1'></a>\nFor one, this *isn't* a Maxima problem :\n\n```\nsage: maxima_calculus.interact()\n\n  --> Switching to Maxima_lib <--\n\nmaxima_lib: subst([y=%i], -(15*z/(17*y + 11) + 1)*(5*z/(4*y + 1) - 1)*(15*z/(3*y - 4) + 1)) ;\n((15*z)/(3*%i-4)+1)*((5*z)/(4*%i+1)-1)*((-(15*z)/(17*%i+11))-1)\nmaxima_lib: \n  --> Exiting back to Sage <--\n\n```\nBut :\n\n```\nmaxima_calculus.subst([y==i],f).sage()\n```\nsends Sage in an infinite loop again...\n\nthe problem might lie in the Maxima-->Sage translation layer :\n\n```\nsage: foo = f._maxima_lib_()\nsage: bar = maxima_calculus.subst((y==I)._maxima_lib_(), foo)\nsage: bar\n-((15*_SAGE_VAR_z)/(3*%i-4)+1)*((5*_SAGE_VAR_z)/(4*%i+1)-1)*((15*_SAGE_VAR_z)/(17*%i+11)+1)\n```\nworks fine ; but asking for `bar.sage()` sends Sage in an infinite loop...",
    "created_at": "2021-05-28T13:35:37Z",
    "issue": "https://github.com/sagemath/sage/issues/31869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31869#issuecomment-515062",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:1'></a>
For one, this *isn't* a Maxima problem :

```
sage: maxima_calculus.interact()

  --> Switching to Maxima_lib <--

maxima_lib: subst([y=%i], -(15*z/(17*y + 11) + 1)*(5*z/(4*y + 1) - 1)*(15*z/(3*y - 4) + 1)) ;
((15*z)/(3*%i-4)+1)*((5*z)/(4*%i+1)-1)*((-(15*z)/(17*%i+11))-1)
maxima_lib: 
  --> Exiting back to Sage <--

```
But :

```
maxima_calculus.subst([y==i],f).sage()
```
sends Sage in an infinite loop again...

the problem might lie in the Maxima-->Sage translation layer :

```
sage: foo = f._maxima_lib_()
sage: bar = maxima_calculus.subst((y==I)._maxima_lib_(), foo)
sage: bar
-((15*_SAGE_VAR_z)/(3*%i-4)+1)*((5*_SAGE_VAR_z)/(4*%i+1)-1)*((15*_SAGE_VAR_z)/(17*%i+11)+1)
```
works fine ; but asking for `bar.sage()` sends Sage in an infinite loop...



---

archive/issue_comments_515063.json:
```json
{
    "body": "<a id='comment:2'></a>\nReplying to [@EmmanuelCharpentier](#comment%3A1):\n\nPutting the example in self-contained form here:\n> \n> ```\n> sage: var('z y')\n> sage: f = -(15*z/(17*y + 11) + 1)*(5*z/(4*y + 1) - 1)*(15*z/(3*y - 4) + 1)\n> sage: foo = f._maxima_lib_()\n> sage: bar = maxima_calculus.subst((y==I)._maxima_lib_(), foo)\n> sage: bar\n> -((15*_SAGE_VAR_z)/(3*%i-4)+1)*((5*_SAGE_VAR_z)/(4*%i+1)-1)*((15*_SAGE_VAR_z)/(17*%i+11)+1)\n> ```\n> but asking the following throws sage in an apparently infinite loop.\n> \n> ```\n> sage: bar.sage()\n> ```\n\nOddly enough, interrupting the process and looking at the traceback often shows sage is constructing $\\sqrt(17)$.",
    "created_at": "2021-05-28T17:15:39Z",
    "issue": "https://github.com/sagemath/sage/issues/31869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31869#issuecomment-515063",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:2'></a>
Replying to [@EmmanuelCharpentier](#comment%3A1):

Putting the example in self-contained form here:
> 
> ```
> sage: var('z y')
> sage: f = -(15*z/(17*y + 11) + 1)*(5*z/(4*y + 1) - 1)*(15*z/(3*y - 4) + 1)
> sage: foo = f._maxima_lib_()
> sage: bar = maxima_calculus.subst((y==I)._maxima_lib_(), foo)
> sage: bar
> -((15*_SAGE_VAR_z)/(3*%i-4)+1)*((5*_SAGE_VAR_z)/(4*%i+1)-1)*((15*_SAGE_VAR_z)/(17*%i+11)+1)
> ```
> but asking the following throws sage in an apparently infinite loop.
> 
> ```
> sage: bar.sage()
> ```

Oddly enough, interrupting the process and looking at the traceback often shows sage is constructing $\sqrt(17)$.



---

archive/issue_comments_515064.json:
```json
{
    "body": "<a id='comment:3'></a>\nReplying to [@nbruin](#comment%3A2):\n> traceback often shows sage is constructing $\\sqrt(17)$.\n\nI see\n* `parse_sequence` from `misc/parser.pyx`, it goes to\n* `__mul__` from `structure/element.pyx` line 1513 \n\n```\n         if HAVE_SAME_PARENT(cl):\n             return (<Element>left)._mul_(right)\n```\n* `_mul_` from `symbolic/expression.pyx` line 3792\n\n```\n         else:\n             x = left._gobj * _right._gobj\n```\n* and it jumps in `GiNaC::operator*` from `pynac-0.7.27/ginac/operators.cpp:78`\n* `GiNaC::exmul` from `pynac-0.7.27/ginac/operators.cpp:53`\n* `GiNaC::ex::ex` from `pynac-0.7.27/ginac/ex.h:314`\n* `GiNaC::ex::construct_from_basic` from `pynac-0.7.27/ginac/ex.cpp:923`\n* `GiNaC::mul::eval` from `pynac-0.7.27/ginac/mul.cpp:783`\n* and here in jumps back to `GiNaC::ex::ex` from `pynac-0.7.27/ginac/ex.h:314` and repeat calls `GiNaC::ex::ex -> GiNaC::ex::construct_from_basic -> GiNaC::mul::eval` more than **36500** times :(",
    "created_at": "2021-05-28T20:22:03Z",
    "issue": "https://github.com/sagemath/sage/issues/31869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31869#issuecomment-515064",
    "user": "https://github.com/sheerluck"
}
```

<a id='comment:3'></a>
Replying to [@nbruin](#comment%3A2):
> traceback often shows sage is constructing $\sqrt(17)$.

I see
* `parse_sequence` from `misc/parser.pyx`, it goes to
* `__mul__` from `structure/element.pyx` line 1513 

```
         if HAVE_SAME_PARENT(cl):
             return (<Element>left)._mul_(right)
```
* `_mul_` from `symbolic/expression.pyx` line 3792

```
         else:
             x = left._gobj * _right._gobj
```
* and it jumps in `GiNaC::operator*` from `pynac-0.7.27/ginac/operators.cpp:78`
* `GiNaC::exmul` from `pynac-0.7.27/ginac/operators.cpp:53`
* `GiNaC::ex::ex` from `pynac-0.7.27/ginac/ex.h:314`
* `GiNaC::ex::construct_from_basic` from `pynac-0.7.27/ginac/ex.cpp:923`
* `GiNaC::mul::eval` from `pynac-0.7.27/ginac/mul.cpp:783`
* and here in jumps back to `GiNaC::ex::ex` from `pynac-0.7.27/ginac/ex.h:314` and repeat calls `GiNaC::ex::ex -> GiNaC::ex::construct_from_basic -> GiNaC::mul::eval` more than **36500** times :(



---

archive/issue_comments_515065.json:
```json
{
    "body": "<a id='comment:4'></a>\nI don't know if that helps to pin down the problem, but even in\n\n```\nvar('z')\na = z/(4*I + 1)\nb = 15*z/(3*I - 4) + 1\nc = a*b\n```\nthe execution of the last line hangs. Slight modifications of the assignment of `b`, like `b = z/(3*I - 4) + 1` or `b = 15*z/(3*I - 4)` don't display that problem.",
    "created_at": "2021-05-28T23:27:28Z",
    "issue": "https://github.com/sagemath/sage/issues/31869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31869#issuecomment-515065",
    "user": "https://github.com/ypfmde"
}
```

<a id='comment:4'></a>
I don't know if that helps to pin down the problem, but even in

```
var('z')
a = z/(4*I + 1)
b = 15*z/(3*I - 4) + 1
c = a*b
```
the execution of the last line hangs. Slight modifications of the assignment of `b`, like `b = z/(3*I - 4) + 1` or `b = 15*z/(3*I - 4)` don't display that problem.



---

archive/issue_comments_515066.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [@ypfmde](#comment%3A4):\n> I don't know if that helps to pin down the problem\n\nI think it does: as far as I can see, the code example you give does not involve maxima at all. This indicates it's a straight-up bug in pynac, or at least in the way sage uses it (pynac is basically part of sage: I don't think there is any other package that uses it)",
    "created_at": "2021-05-29T00:12:21Z",
    "issue": "https://github.com/sagemath/sage/issues/31869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31869#issuecomment-515066",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:5'></a>
Replying to [@ypfmde](#comment%3A4):
> I don't know if that helps to pin down the problem

I think it does: as far as I can see, the code example you give does not involve maxima at all. This indicates it's a straight-up bug in pynac, or at least in the way sage uses it (pynac is basically part of sage: I don't think there is any other package that uses it)



---

archive/issue_comments_515067.json:
```json
{
    "body": "<a id='comment:6'></a>\nI'm new to sage trac (and more of a naive end user of sage), so I don't want to potentially mess up this ticket. But in view of the many tickets, wouldn't a more expressive title (and fix of the typo) be more useful? From `A simple substitution can send Sage in an infiite loop` I would expect that some substitution generates an unlimited recursion. Maybe something explicit like `y = x*(5*x/(3*I-4)+1)/I causes segfault`? (And indeed it does!)",
    "created_at": "2021-05-29T10:11:59Z",
    "issue": "https://github.com/sagemath/sage/issues/31869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31869#issuecomment-515067",
    "user": "https://github.com/ypfmde"
}
```

<a id='comment:6'></a>
I'm new to sage trac (and more of a naive end user of sage), so I don't want to potentially mess up this ticket. But in view of the many tickets, wouldn't a more expressive title (and fix of the typo) be more useful? From `A simple substitution can send Sage in an infiite loop` I would expect that some substitution generates an unlimited recursion. Maybe something explicit like `y = x*(5*x/(3*I-4)+1)/I causes segfault`? (And indeed it does!)



---

archive/issue_comments_515068.json:
```json
{
    "body": "**Changing keywords** from \"\" to \"pynac, segfault\".",
    "created_at": "2021-05-29T12:16:13Z",
    "issue": "https://github.com/sagemath/sage/issues/31869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31869#issuecomment-515068",
    "user": "https://github.com/slel"
}
```

**Changing keywords** from "" to "pynac, segfault".



---

archive/issue_comments_515069.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,20 +1,81 @@\n-Reported in [`sage-support`](https://groups.google.com/g/sage-support/c/BLGNjf7319k)\n-\n-An inocuous-looking expression :\n+The following crashes Sage:\n \n ```\n-sage: f.expand()(y==I)\n-15*z/(17*(y == I) + 11) - 5*z/(4*(y == I) + 1) + 15*z/(3*(y == I) - 4) - 75*z^2/((17*(y == I) + 11)*(4*(y == I) + 1)) + 225*z^2/((17*(y == I) + 11)*(3*(y == I) - 4)) - 75*z^2/((4*(y == I) + 1)*(3*(y == I) - 4)) - 1125*z^3/((17*(y == I) + 11)*(4*(y == I) + 1)*(3*(y == I) - 4)) + 1\n-sage: f.partial_fraction(y)(y==I)\n--5/909*(21675*z^3 - 1700*z^2 - 2727*z)/(17*(y == I) + 11) - 15/1919*(675*z^3 + 660*z^2 - 1919*z)/(3*(y == I) - 4) + 5/171*(1200*z^3 + 160*z^2 - 171*z)/(4*(y == I) + 1) + 1\n-sage: f.simplify_full()(y==I)\n-(-300*(2*(y == I) + 1)*z^2 - 211*(y == I) - 1125*z^3 + 204*(y == I)^3 + 5*(189*(y == I)^2 + 179*(y == I) + 65)*z - 89*(y == I)^2 - 44)/(204*(y == I)^3 - 89*(y == I)^2 - 211*(y == I) - 44)\n+sage: x = SR.var('x')\n+sage: h = (3*I + 4)*x - 5\n+sage: x * h  # hangs then crashes\n ```\n-So far, so fine. But\n+\n+Small variations work fine:\n \n ```\n-sage: f(y=I)\n+sage: h = (3*I + 4)*x - 4\n+sage: x * h\n+x*((3*I + 4)*x - 4)\n ```\n-never returns, and need a long raft of interruptions to exit.\n \n-Marked as `critical`, because a simple substitution can crash Sage.\n+```\n+sage: h = (3*I + 5)*x - 5\n+sage: x * h\n+x*((3*I + 5)*x - 5)\n+```\n+\n+Priority set to critical as such a simple\n+operation should not crash Sage.\n+\n+---\n+\n+From a [report on sage-support](https://groups.google.com/g/sage-support/c/BLGNjf7319k)\n+which involved substitutions.\n+\n+The original report can be rephrased as follows.\n+Define `f`:\n+\n+```\n+sage: y, z = SR.var('y, z')\n+sage: f = -(15*z/(17*y + 11) + 1)*(5*z/(4*y + 1) - 1)*(15*z/(3*y - 4) + 1)\n+```\n+\n+We want to substitute `y = I` into `f`. Tweaking `f` first works:\n+\n+```\n+sage: f.expand()(y=I)\n+-(3735/1394*I + 405/1394)*z^3 - (606/697*I - 942/697)*z^2 - (8681/6970*I + 15973/6970)*z + 1\n+sage: f.partial_fraction(y)(y=I)\n+-(3735/1394*I + 405/1394)*z^3 - (606/697*I - 942/697)*z^2 - (8681/6970*I + 15973/6970)*z + 1\n+sage: f.simplify_full()(y=I)\n+-(3735/1394*I + 405/1394)*z^3 - (606/697*I - 942/697)*z^2 - (8681/6970*I + 15973/6970)*z + 1\n+```\n+but doing it directly crashes:\n+\n+```\n+sage: f(y=I)  # hangs then crashes\n+------------------------------------------------------------------------\n+(no backtrace available)\n+------------------------------------------------------------------------\n+Unhandled SIGSEGV: A segmentation fault occurred.\n+This probably occurred because a *compiled* module has a bug\n+in it and is not properly wrapped with sig_on(), sig_off().\n+Python will now terminate.\n+------------------------------------------------------------------------\n+.../src/bin/sage-python: line 2: ... Segmentation fault: 11  sage -python \"$@\"\n+```\n+\n+A simpler example that boils down to the minimal reproducer:\n+\n+```\n+sage: a, x = SR.var('a, x')\n+sage: g = x * ((3*a + 4)*x - 5)\n+sage: g\n+((3*a + 4)*x - 5)*x\n+sage: g(a=I)  # hangs then crashes\n+------------------------------------------------------------------------\n+(no backtrace available)\n+------------------------------------------------------------------------\n+Unhandled SIGSEGV: A segmentation fault occurred.\n+This probably occurred because a *compiled* module has a bug\n+in it and is not properly wrapped with sig_on(), sig_off().\n+Python will now terminate.\n+------------------------------------------------------------------------\n+.../src/bin/sage-python: line 2: ... Segmentation fault: 11  sage -python \"$@\"\n+```\n``````\n",
    "created_at": "2021-05-29T12:16:13Z",
    "issue": "https://github.com/sagemath/sage/issues/31869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31869#issuecomment-515069",
    "user": "https://github.com/slel"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,20 +1,81 @@
-Reported in [`sage-support`](https://groups.google.com/g/sage-support/c/BLGNjf7319k)
-
-An inocuous-looking expression :
+The following crashes Sage:
 
 ```
-sage: f.expand()(y==I)
-15*z/(17*(y == I) + 11) - 5*z/(4*(y == I) + 1) + 15*z/(3*(y == I) - 4) - 75*z^2/((17*(y == I) + 11)*(4*(y == I) + 1)) + 225*z^2/((17*(y == I) + 11)*(3*(y == I) - 4)) - 75*z^2/((4*(y == I) + 1)*(3*(y == I) - 4)) - 1125*z^3/((17*(y == I) + 11)*(4*(y == I) + 1)*(3*(y == I) - 4)) + 1
-sage: f.partial_fraction(y)(y==I)
--5/909*(21675*z^3 - 1700*z^2 - 2727*z)/(17*(y == I) + 11) - 15/1919*(675*z^3 + 660*z^2 - 1919*z)/(3*(y == I) - 4) + 5/171*(1200*z^3 + 160*z^2 - 171*z)/(4*(y == I) + 1) + 1
-sage: f.simplify_full()(y==I)
-(-300*(2*(y == I) + 1)*z^2 - 211*(y == I) - 1125*z^3 + 204*(y == I)^3 + 5*(189*(y == I)^2 + 179*(y == I) + 65)*z - 89*(y == I)^2 - 44)/(204*(y == I)^3 - 89*(y == I)^2 - 211*(y == I) - 44)
+sage: x = SR.var('x')
+sage: h = (3*I + 4)*x - 5
+sage: x * h  # hangs then crashes
 ```
-So far, so fine. But
+
+Small variations work fine:
 
 ```
-sage: f(y=I)
+sage: h = (3*I + 4)*x - 4
+sage: x * h
+x*((3*I + 4)*x - 4)
 ```
-never returns, and need a long raft of interruptions to exit.
 
-Marked as `critical`, because a simple substitution can crash Sage.
+```
+sage: h = (3*I + 5)*x - 5
+sage: x * h
+x*((3*I + 5)*x - 5)
+```
+
+Priority set to critical as such a simple
+operation should not crash Sage.
+
+---
+
+From a [report on sage-support](https://groups.google.com/g/sage-support/c/BLGNjf7319k)
+which involved substitutions.
+
+The original report can be rephrased as follows.
+Define `f`:
+
+```
+sage: y, z = SR.var('y, z')
+sage: f = -(15*z/(17*y + 11) + 1)*(5*z/(4*y + 1) - 1)*(15*z/(3*y - 4) + 1)
+```
+
+We want to substitute `y = I` into `f`. Tweaking `f` first works:
+
+```
+sage: f.expand()(y=I)
+-(3735/1394*I + 405/1394)*z^3 - (606/697*I - 942/697)*z^2 - (8681/6970*I + 15973/6970)*z + 1
+sage: f.partial_fraction(y)(y=I)
+-(3735/1394*I + 405/1394)*z^3 - (606/697*I - 942/697)*z^2 - (8681/6970*I + 15973/6970)*z + 1
+sage: f.simplify_full()(y=I)
+-(3735/1394*I + 405/1394)*z^3 - (606/697*I - 942/697)*z^2 - (8681/6970*I + 15973/6970)*z + 1
+```
+but doing it directly crashes:
+
+```
+sage: f(y=I)  # hangs then crashes
+------------------------------------------------------------------------
+(no backtrace available)
+------------------------------------------------------------------------
+Unhandled SIGSEGV: A segmentation fault occurred.
+This probably occurred because a *compiled* module has a bug
+in it and is not properly wrapped with sig_on(), sig_off().
+Python will now terminate.
+------------------------------------------------------------------------
+.../src/bin/sage-python: line 2: ... Segmentation fault: 11  sage -python "$@"
+```
+
+A simpler example that boils down to the minimal reproducer:
+
+```
+sage: a, x = SR.var('a, x')
+sage: g = x * ((3*a + 4)*x - 5)
+sage: g
+((3*a + 4)*x - 5)*x
+sage: g(a=I)  # hangs then crashes
+------------------------------------------------------------------------
+(no backtrace available)
+------------------------------------------------------------------------
+Unhandled SIGSEGV: A segmentation fault occurred.
+This probably occurred because a *compiled* module has a bug
+in it and is not properly wrapped with sig_on(), sig_off().
+Python will now terminate.
+------------------------------------------------------------------------
+.../src/bin/sage-python: line 2: ... Segmentation fault: 11  sage -python "$@"
+```
``````




---

archive/issue_events_286097.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2021-05-29T12:16:13Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/31869",
    "rename": {
        "from": "A simple substitution can send Sage in an infiite loop.",
        "to": "Fix segfault when multiplying x * ((3*i + 4)*x - 5)"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31869#event-286097"
}
```



---

archive/issue_comments_515070.json:
```json
{
    "body": "<a id='comment:7'></a>\nHere is a simpler reproducer: `x * ((3*i + 4)*x - 5)`.\n\nKept original expression in ticket description\nso the discussion still makes sense.",
    "created_at": "2021-05-29T12:16:13Z",
    "issue": "https://github.com/sagemath/sage/issues/31869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31869#issuecomment-515070",
    "user": "https://github.com/slel"
}
```

<a id='comment:7'></a>
Here is a simpler reproducer: `x * ((3*i + 4)*x - 5)`.

Kept original expression in ticket description
so the discussion still makes sense.



---

archive/issue_comments_515071.json:
```json
{
    "body": "<a id='comment:8'></a>\nThe infinite loop (in pynac) is caused by an incorrect calculation of the `integer_content` of a polynomial (or other sum) that has complex coefficients. I will soon provide a patch and further explanation.",
    "created_at": "2021-05-30T23:27:50Z",
    "issue": "https://github.com/sagemath/sage/issues/31869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31869#issuecomment-515071",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:8'></a>
The infinite loop (in pynac) is caused by an incorrect calculation of the `integer_content` of a polynomial (or other sum) that has complex coefficients. I will soon provide a patch and further explanation.



---

archive/issue_comments_515072.json:
```json
{
    "body": "**Author:** Dave Morris",
    "created_at": "2021-05-30T23:27:50Z",
    "issue": "https://github.com/sagemath/sage/issues/31869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31869#issuecomment-515072",
    "user": "https://github.com/DaveWitteMorris"
}
```

**Author:** Dave Morris



---

archive/issue_comments_515073.json:
```json
{
    "body": "**Branch:** [public/31869](https://github.com/sagemath/sagetrac-mirror/tree/public/31869)",
    "created_at": "2021-05-31T02:19:26Z",
    "issue": "https://github.com/sagemath/sage/issues/31869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31869#issuecomment-515073",
    "user": "https://github.com/DaveWitteMorris"
}
```

**Branch:** [public/31869](https://github.com/sagemath/sagetrac-mirror/tree/public/31869)



---

archive/issue_events_286098.json:
```json
{
    "actor": "https://github.com/DaveWitteMorris",
    "created_at": "2021-05-31T03:13:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31869",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31869#event-286098"
}
```



---

archive/issue_comments_515074.json:
```json
{
    "body": "**Commit:** [48f7a070bd168a3a039b6592f035c62a387b02bb](https://github.com/sagemath/sagetrac-mirror/commit/48f7a070bd168a3a039b6592f035c62a387b02bb)",
    "created_at": "2021-05-31T03:13:56Z",
    "issue": "https://github.com/sagemath/sage/issues/31869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31869#issuecomment-515074",
    "user": "https://github.com/DaveWitteMorris"
}
```

**Commit:** [48f7a070bd168a3a039b6592f035c62a387b02bb](https://github.com/sagemath/sagetrac-mirror/commit/48f7a070bd168a3a039b6592f035c62a387b02bb)



---

archive/issue_comments_515075.json:
```json
{
    "body": "<a id='comment:10'></a>\nThis pynac patch should solve the problem.\n\n**Diagnosis:** Pynac automatically simplifies expressions to a standard form. In the situation here, it passes repeatedly through a loop, until no changes are made in a pass, so it knows that it is finished. One step of the simplification of a polynomial (or other sum) divides by the `integer_content`. This is supposed to be the largest rational number that can be divided by to give a result that has no denominator. \n\nFor a polynomial with rational coefficients, the `integer_content` can be calculated by taking the gcd of the numerators, and dividing by the lcm of the denominators. Pynac tries to use this same formula for polynomials with complex coefficients, but a \"feature\" of the `gcd` function sends the calculation awry. Namely, pynac assumes that `gcd(a,0)` is always `abs(a)`. (See #31884 for a complaint about this.)\n\n*Here is what goes wrong:* To calculate the `integer_content` of the expression `(3*i + 4)*x - 5`, pynac calculates `gcd(gcd(0, 3*i + 4), -5)`.  Since `gcd(0, 3*i + 4)` is `abs(3*i + 4)`, which is `5`, the result is `gcd(5, -5)`, which is `5`. (This is incorrect: the `integer_content` of this polynomial is `1`.) So pynac divides by `5`, resulting in `(3/5 * i + 4/5)*x - 1`. In the next pass through the loop, pynac sees the denominator of `5`, and (correctly) concludes that the `integer_content` of this polynomial is `1/5`. It therefore divides by `1/5` to get rid of the denominator. This gets us back to the original polynomial, so pynac is in an infinite loop.\n\n**Solution:** The `integer_content` of a polynomial with coefficient `a + b*i` should be calculated as if `a` and `b` were the coefficients of two different terms.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/48f7a070bd168a3a039b6592f035c62a387b02bb\">48f7a07</a></td><td><code>trac 31869 fix pynac integer_content</code></td></tr></table>\n",
    "created_at": "2021-05-31T03:13:56Z",
    "issue": "https://github.com/sagemath/sage/issues/31869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31869#issuecomment-515075",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:10'></a>
This pynac patch should solve the problem.

**Diagnosis:** Pynac automatically simplifies expressions to a standard form. In the situation here, it passes repeatedly through a loop, until no changes are made in a pass, so it knows that it is finished. One step of the simplification of a polynomial (or other sum) divides by the `integer_content`. This is supposed to be the largest rational number that can be divided by to give a result that has no denominator. 

For a polynomial with rational coefficients, the `integer_content` can be calculated by taking the gcd of the numerators, and dividing by the lcm of the denominators. Pynac tries to use this same formula for polynomials with complex coefficients, but a "feature" of the `gcd` function sends the calculation awry. Namely, pynac assumes that `gcd(a,0)` is always `abs(a)`. (See #31884 for a complaint about this.)

*Here is what goes wrong:* To calculate the `integer_content` of the expression `(3*i + 4)*x - 5`, pynac calculates `gcd(gcd(0, 3*i + 4), -5)`.  Since `gcd(0, 3*i + 4)` is `abs(3*i + 4)`, which is `5`, the result is `gcd(5, -5)`, which is `5`. (This is incorrect: the `integer_content` of this polynomial is `1`.) So pynac divides by `5`, resulting in `(3/5 * i + 4/5)*x - 1`. In the next pass through the loop, pynac sees the denominator of `5`, and (correctly) concludes that the `integer_content` of this polynomial is `1/5`. It therefore divides by `1/5` to get rid of the denominator. This gets us back to the original polynomial, so pynac is in an infinite loop.

**Solution:** The `integer_content` of a polynomial with coefficient `a + b*i` should be calculated as if `a` and `b` were the coefficients of two different terms.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/48f7a070bd168a3a039b6592f035c62a387b02bb">48f7a07</a></td><td><code>trac 31869 fix pynac integer_content</code></td></tr></table>




---

archive/issue_comments_515076.json:
```json
{
    "body": "<a id='comment:11'></a>\nPS Thanks to everyone who contributed to this discussion. The simplified example, the traceback, and the other comments made it much easier to locate the bug!",
    "created_at": "2021-05-31T07:19:48Z",
    "issue": "https://github.com/sagemath/sage/issues/31869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31869#issuecomment-515076",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:11'></a>
PS Thanks to everyone who contributed to this discussion. The simplified example, the traceback, and the other comments made it much easier to locate the bug!



---

archive/issue_comments_515077.json:
```json
{
    "body": "**Reviewer:** Travis Scrimshaw",
    "created_at": "2021-06-01T00:13:29Z",
    "issue": "https://github.com/sagemath/sage/issues/31869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31869#issuecomment-515077",
    "user": "https://github.com/tscrim"
}
```

**Reviewer:** Travis Scrimshaw



---

archive/issue_events_286099.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2021-06-01T00:13:29Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31869",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31869#event-286099"
}
```



---

archive/issue_events_286100.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2021-06-01T00:13:29Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31869",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31869#event-286100"
}
```



---

archive/issue_comments_515078.json:
```json
{
    "body": "<a id='comment:12'></a>\nLGTM. Please also create a PR [upstream](https://github.com/pynac/pynac) and link it in the ticket description.",
    "created_at": "2021-06-01T00:13:29Z",
    "issue": "https://github.com/sagemath/sage/issues/31869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31869#issuecomment-515078",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:12'></a>
LGTM. Please also create a PR [upstream](https://github.com/pynac/pynac) and link it in the ticket description.



---

archive/issue_comments_515079.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [@tscrim](#comment%3A12):\n> LGTM. Please also create a PR [upstream](https://github.com/pynac/pynac) and link it in the ticket description.\n\nSame results here : passes `ptestlong` with the sae results as 9.4.betaO).\n\nThanks a lot !",
    "created_at": "2021-06-01T05:57:18Z",
    "issue": "https://github.com/sagemath/sage/issues/31869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31869#issuecomment-515079",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:13'></a>
Replying to [@tscrim](#comment%3A12):
> LGTM. Please also create a PR [upstream](https://github.com/pynac/pynac) and link it in the ticket description.

Same results here : passes `ptestlong` with the sae results as 9.4.betaO).

Thanks a lot !



---

archive/issue_comments_515080.json:
```json
{
    "body": "**Changing branch** from \"[public/31869](https://github.com/sagemath/sagetrac-mirror/tree/public/31869)\" to \"[48f7a070bd168a3a039b6592f035c62a387b02bb](https://github.com/sagemath/sagetrac-mirror/commit/48f7a070bd168a3a039b6592f035c62a387b02bb)\".",
    "created_at": "2021-06-07T21:40:31Z",
    "issue": "https://github.com/sagemath/sage/issues/31869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31869#issuecomment-515080",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[public/31869](https://github.com/sagemath/sagetrac-mirror/tree/public/31869)" to "[48f7a070bd168a3a039b6592f035c62a387b02bb](https://github.com/sagemath/sagetrac-mirror/commit/48f7a070bd168a3a039b6592f035c62a387b02bb)".



---

archive/issue_events_286101.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-06-07T21:40:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31869",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31869#event-286101"
}
```



---

archive/issue_events_286102.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "732c966cee16e2e5d19294ac47ef6ae2d81c7dbe",
    "created_at": "2021-06-07T21:40:31Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/31869",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31869#event-286102"
}
```
