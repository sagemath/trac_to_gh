# Issue 31227: Accept /usr/bin/python3 from XCode 12.3 on macOS 10.15 (Catalina) and 11 (Big Sur)

archive/issues_030990.json:
```json
{
    "body": "(from #31132)\n\n#27122 determines whether CC accepts `-march=native` and then adds it globally to `CFLAGS` in `build/bin/sage-build-env`.\n\n#30725 fixes this for macOS, where some packages are explicitly built with `clang`.\n\nHowever, there is another mechanism how `clang` can come in: Python extension modules are compiled with the compiler listed in sysconfig. On macOS with homebrew, using `/usr/bin/python3`, this could again be `clang`, which does not accept `-march=native` in combination with `-arch arm64` (which is provided even on x86_64 if `ARCHFLAGS` is unset).\n\nIn this ticket, we fix this by checking whether the compiler used by distutils accepts `-march=native` (or more generally, the flags determined earlier by `configure`). If it does not, then we disable the use of these flags.\n\nIn order to test this with `/usr/bin/python3` from XCode 12.3 (on macOS 10.15 (Catalina)), we fix another issue:\nThis python3 (3.8.2) is not able to build extension modules because it emits `-arch arm64 -arch x86_64` unless `ARCHFLAGS` is set explicitly\n\n```\n$ /usr/bin/python3 -m sysconfig |grep '\\bCFLAGS ='\n\tCFLAGS = \"-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64\"\n\n$ ARCHFLAGS=\"\" /usr/bin/python3 -m sysconfig |grep '\\bCFLAGS ='\n\tCFLAGS = \"-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers  -arch x86_64 \"\n```\n\nIn this ticket, if the distutils test fails, we try if setting `ARCHFLAGS=\"\"` fixes it.  Also, after accepting a system python and `ARCHFLAGS` so far has not been set, we test whether the system python wants to do the multi-arch build.\n\nIn either of these two cases, we store a configuration variable that causes `sage-env` to set `ARCHFLAGS` as well.\n\nThis is somewhat complicated logic - we are tiptoeing around previous breakage that had been caused by setting `ARCHFLAGS` unconditionally (#29408).\n\n\n\nCC:  @jhpalmieri @zlscherr @dimpase @kliem @vbraun\n\nBranch/Commit: fc8b67644bada9ea52cbb7c91f53f763ca84f4bb\n\nReviewer: Jonathan Kliem\n\nAuthor: Matthias Koeppe\n\nDependencies: #31132, #30725\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/31227\n\n",
    "closed_at": "2021-02-20T10:46:52Z",
    "created_at": "2021-01-13T01:31:23Z",
    "labels": [
        "component: build: configure",
        "blocker"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "Accept /usr/bin/python3 from XCode 12.3 on macOS 10.15 (Catalina) and 11 (Big Sur)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31227",
    "user": "https://github.com/mkoeppe"
}
```
(from #31132)

#27122 determines whether CC accepts `-march=native` and then adds it globally to `CFLAGS` in `build/bin/sage-build-env`.

#30725 fixes this for macOS, where some packages are explicitly built with `clang`.

However, there is another mechanism how `clang` can come in: Python extension modules are compiled with the compiler listed in sysconfig. On macOS with homebrew, using `/usr/bin/python3`, this could again be `clang`, which does not accept `-march=native` in combination with `-arch arm64` (which is provided even on x86_64 if `ARCHFLAGS` is unset).

In this ticket, we fix this by checking whether the compiler used by distutils accepts `-march=native` (or more generally, the flags determined earlier by `configure`). If it does not, then we disable the use of these flags.

In order to test this with `/usr/bin/python3` from XCode 12.3 (on macOS 10.15 (Catalina)), we fix another issue:
This python3 (3.8.2) is not able to build extension modules because it emits `-arch arm64 -arch x86_64` unless `ARCHFLAGS` is set explicitly

```
$ /usr/bin/python3 -m sysconfig |grep '\bCFLAGS ='
	CFLAGS = "-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64"

$ ARCHFLAGS="" /usr/bin/python3 -m sysconfig |grep '\bCFLAGS ='
	CFLAGS = "-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers  -arch x86_64 "
```

In this ticket, if the distutils test fails, we try if setting `ARCHFLAGS=""` fixes it.  Also, after accepting a system python and `ARCHFLAGS` so far has not been set, we test whether the system python wants to do the multi-arch build.

In either of these two cases, we store a configuration variable that causes `sage-env` to set `ARCHFLAGS` as well.

This is somewhat complicated logic - we are tiptoeing around previous breakage that had been caused by setting `ARCHFLAGS` unconditionally (#29408).



CC:  @jhpalmieri @zlscherr @dimpase @kliem @vbraun

Branch/Commit: fc8b67644bada9ea52cbb7c91f53f763ca84f4bb

Reviewer: Jonathan Kliem

Author: Matthias Koeppe

Dependencies: #31132, #30725

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/31227





---

archive/issue_comments_472218.json:
```json
{
    "body": "<a id='comment:3'></a>New commits:",
    "created_at": "2021-01-14T04:18:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472218",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'></a>New commits:



---

archive/issue_comments_472219.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2021-01-23T20:22:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472219",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_472220.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-23T20:27:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472220",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_472221.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-01-23T20:30:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472221",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_472222.json:
```json
{
    "body": "<a id='comment:8'></a>This is the branch that I had. I won't have time to work on it over the next week.",
    "created_at": "2021-01-23T20:30:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472222",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>This is the branch that I had. I won't have time to work on it over the next week.



---

archive/issue_comments_472223.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -10,7 +10,9 @@\n egret:~/s/sage/sage-rebasing/worktree-algebraic-2018-spring (t/31132/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_build_when_using_homebrew_s_python3 *\n ```\n \n-In this ticket, we set `ARCHFLAGS` during this configure step...\n+In this ticket, we set `ARCHFLAGS` during this configure step.\n+ \n+\n \n Comment: 1\n \n```\n",
    "created_at": "2021-01-23T20:30:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472223",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -10,7 +10,9 @@
 egret:~/s/sage/sage-rebasing/worktree-algebraic-2018-spring (t/31132/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_build_when_using_homebrew_s_python3 *
 ```
 
-In this ticket, we set `ARCHFLAGS` during this configure step...
+In this ticket, we set `ARCHFLAGS` during this configure step.
+ 
+
 
 Comment: 1
 
```




---

archive/issue_comments_472224.json:
```json
{
    "body": "<a id='comment:9'></a>It was proposed to mark #31228 as invalid and do it all here. In this case (and it is in fact already done here).\n\nIn this case, this ticket here is really ready for review (and the depency of #31228 could be removed).",
    "created_at": "2021-01-25T06:55:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472224",
    "user": "https://github.com/kliem"
}
```

<a id='comment:9'></a>It was proposed to mark #31228 as invalid and do it all here. In this case (and it is in fact already done here).

In this case, this ticket here is really ready for review (and the depency of #31228 could be removed).



---

archive/issue_comments_472225.json:
```json
{
    "body": "<a id='comment:10'></a>I'm happy with this ticket, but I will have to wait and see if things work out in practice.",
    "created_at": "2021-01-25T07:04:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472225",
    "user": "https://github.com/kliem"
}
```

<a id='comment:10'></a>I'm happy with this ticket, but I will have to wait and see if things work out in practice.



---

archive/issue_comments_472226.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2021-01-25T19:22:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472226",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_472227.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,26 @@\n+(from #31132)\n+\n+#27122 determines whether CC accepts `-march=native` and then adds it globally to `CFLAGS` in `build/bin/sage-build-env`.\n+\n+#30725 fixes this for macOS, where some packages are explicitly built with `clang`.\n+\n+However, there is another mechanism how `clang` can come in: Python extension modules are compiled with the compiler listed in sysconfig. On macOS with homebrew, using `/usr/bin/python3`, this could again be `clang`, which does not accept `-march=native`.\n+\n+In this ticket, we fix this by checking whether the compiler used by distutils accepts `-march=native` (or more generally, the flags determined earlier by `configure`). If it does not, then we disable the use of these flags.\n+\n+In order to test this with `/usr/bin/python3` from XCode 12.3 (on macOS 10.15 (Catalina)), we fix another issue:\n+This python3 (3.8.2) is not able to build extension modules because it emits `-arch arm64 -arch x86_64` unless `ARCHFLAGS` is set explicitly\n+\n+```\n+$ /usr/bin/python3 -m sysconfig |grep '\\bCFLAGS ='\n+\tCFLAGS = \"-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64\"\n+ARCHFLAGS=\"\" /usr/bin/python3 -m sysconfig |grep '\\bCFLAGS ='\n+\tCFLAGS = \"-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers  -arch x86_64 \"\n+egret:~/s/sage/sage-rebasing/worktree-algebraic-2018-spring (t/31132/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_build_when_using_homebrew_s_python3 *\n+```\n+\n+In this ticket, we set `ARCHFLAGS` during this configure step.\n+ \n \n \n Comment: 1\n```\n",
    "created_at": "2021-01-25T19:31:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472227",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,26 @@
+(from #31132)
+
+#27122 determines whether CC accepts `-march=native` and then adds it globally to `CFLAGS` in `build/bin/sage-build-env`.
+
+#30725 fixes this for macOS, where some packages are explicitly built with `clang`.
+
+However, there is another mechanism how `clang` can come in: Python extension modules are compiled with the compiler listed in sysconfig. On macOS with homebrew, using `/usr/bin/python3`, this could again be `clang`, which does not accept `-march=native`.
+
+In this ticket, we fix this by checking whether the compiler used by distutils accepts `-march=native` (or more generally, the flags determined earlier by `configure`). If it does not, then we disable the use of these flags.
+
+In order to test this with `/usr/bin/python3` from XCode 12.3 (on macOS 10.15 (Catalina)), we fix another issue:
+This python3 (3.8.2) is not able to build extension modules because it emits `-arch arm64 -arch x86_64` unless `ARCHFLAGS` is set explicitly
+
+```
+$ /usr/bin/python3 -m sysconfig |grep '\bCFLAGS ='
+	CFLAGS = "-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64"
+ARCHFLAGS="" /usr/bin/python3 -m sysconfig |grep '\bCFLAGS ='
+	CFLAGS = "-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers  -arch x86_64 "
+egret:~/s/sage/sage-rebasing/worktree-algebraic-2018-spring (t/31132/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_build_when_using_homebrew_s_python3 *
+```
+
+In this ticket, we set `ARCHFLAGS` during this configure step.
+ 
 
 
 Comment: 1
```




---

archive/issue_comments_472228.json:
```json
{
    "body": "<a id='comment:13'></a>With this branch, `./configure --with-python=/usr/bin/python3` fails for me on OS X Catalina with Xcode 12.3. See attached `config.log`.",
    "created_at": "2021-01-25T23:23:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472228",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:13'></a>With this branch, `./configure --with-python=/usr/bin/python3` fails for me on OS X Catalina with Xcode 12.3. See attached `config.log`.



---

archive/issue_comments_472229.json:
```json
{
    "body": "<a id='comment:14'></a>Did you run `bootstrap`?",
    "created_at": "2021-01-26T04:34:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472229",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:14'></a>Did you run `bootstrap`?



---

archive/issue_comments_472230.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:14 mkoeppe]:\n> Did you run `bootstrap`?\n\n\nNo, sorry for the false report. Having run `./bootstrap`, and with `local/bin/python3` a symlink pointing to `/Applications/Xcode.app/Contents/Developer/usr/bin/python3`, the build has now failed twice: `Pillow` and `cython` have both failed to build.",
    "created_at": "2021-01-26T22:57:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472230",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:15'></a>Replying to [comment:14 mkoeppe]:
> Did you run `bootstrap`?


No, sorry for the false report. Having run `./bootstrap`, and with `local/bin/python3` a symlink pointing to `/Applications/Xcode.app/Contents/Developer/usr/bin/python3`, the build has now failed twice: `Pillow` and `cython` have both failed to build.



---

archive/issue_comments_472231.json:
```json
{
    "body": "Attachment [pillow-8.0.1.log](tarball://root/attachments/some-uuid/ticket31227/pillow-8.0.1.log) by @jhpalmieri created at 2021-01-26 22:58:21",
    "created_at": "2021-01-26T22:58:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472231",
    "user": "https://github.com/jhpalmieri"
}
```

Attachment [pillow-8.0.1.log](tarball://root/attachments/some-uuid/ticket31227/pillow-8.0.1.log) by @jhpalmieri created at 2021-01-26 22:58:21



---

archive/issue_comments_472232.json:
```json
{
    "body": "<a id='comment:16'></a>Attachment [cython-0.29.21.log](tarball://root/attachments/some-uuid/ticket31227/cython-0.29.21.log) by @jhpalmieri created at 2021-01-26 23:03:36\n\nOh, and `gmpy2`, also.",
    "created_at": "2021-01-26T23:03:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472232",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:16'></a>Attachment [cython-0.29.21.log](tarball://root/attachments/some-uuid/ticket31227/cython-0.29.21.log) by @jhpalmieri created at 2021-01-26 23:03:36

Oh, and `gmpy2`, also.



---

archive/issue_comments_472233.json:
```json
{
    "body": "Attachment [gmpy2-2.1.0b5.log](tarball://root/attachments/some-uuid/ticket31227/gmpy2-2.1.0b5.log) by @jhpalmieri created at 2021-01-26 23:03:49",
    "created_at": "2021-01-26T23:03:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472233",
    "user": "https://github.com/jhpalmieri"
}
```

Attachment [gmpy2-2.1.0b5.log](tarball://root/attachments/some-uuid/ticket31227/gmpy2-2.1.0b5.log) by @jhpalmieri created at 2021-01-26 23:03:49



---

archive/issue_comments_472234.json:
```json
{
    "body": "<a id='comment:17'></a>OK, looks like we have to set `ARCHFLAGS=\"\"` in more places. But this needs to be done very carefully - see #29408",
    "created_at": "2021-01-26T23:44:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472234",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'></a>OK, looks like we have to set `ARCHFLAGS=""` in more places. But this needs to be done very carefully - see #29408



---

archive/issue_comments_472235.json:
```json
{
    "body": "<a id='comment:18'></a>I ran `make -k` to get a fuller report, and it ended with:\n\n```\n* package:         gmpy2-2.1.0b5\n  last build time: Jan 26 15:52\n  log file:        /Users/jpalmier/Desktop/Sage/git/sage/logs/pkgs/gmpy2-2.1.0b5.log\n  build directory: /Users/jpalmier/Desktop/Sage/git/sage/local/var/tmp/sage/build/gmpy2-2.1.0b5\n\n* package:         cython-0.29.21\n  last build time: Jan 26 15:52\n  log file:        /Users/jpalmier/Desktop/Sage/git/sage/logs/pkgs/cython-0.29.21.log\n  build directory: /Users/jpalmier/Desktop/Sage/git/sage/local/var/tmp/sage/build/cython-0.29.21\n\n* package:         psutil-5.2.0.p2\n  last build time: Jan 26 15:52\n  log file:        /Users/jpalmier/Desktop/Sage/git/sage/logs/pkgs/psutil-5.2.0.p2.log\n  build directory: /Users/jpalmier/Desktop/Sage/git/sage/local/var/tmp/sage/build/psutil-5.2.0.p2\n\n* package:         pillow-8.0.1\n  last build time: Jan 26 15:52\n  log file:        /Users/jpalmier/Desktop/Sage/git/sage/logs/pkgs/pillow-8.0.1.log\n  build directory: /Users/jpalmier/Desktop/Sage/git/sage/local/var/tmp/sage/build/pillow-8.0.1\n\n* package:         kiwisolver-1.0.1\n  last build time: Jan 26 15:52\n  log file:        /Users/jpalmier/Desktop/Sage/git/sage/logs/pkgs/kiwisolver-1.0.1.log\n  build directory: /Users/jpalmier/Desktop/Sage/git/sage/local/var/tmp/sage/build/kiwisolver-1.0.1\n\n* package:         pynac-0.7.26.sage-2020-04-03.p0\n  last build time: Jan 26 15:53\n  log file:        /Users/jpalmier/Desktop/Sage/git/sage/logs/pkgs/pynac-0.7.26.sage-2020-04-03.p0.log\n  build directory: /Users/jpalmier/Desktop/Sage/git/sage/local/var/tmp/sage/build/pynac-0.7.26.sage-2020-04-03.p0\n\n* package:         cffi-1.14.4\n  last build time: Jan 26 15:53\n  log file:        /Users/jpalmier/Desktop/Sage/git/sage/logs/pkgs/cffi-1.14.4.log\n  build directory: /Users/jpalmier/Desktop/Sage/git/sage/local/var/tmp/sage/build/cffi-1.14.4\n```\nAll show the same error, \"clang: error: the clang compiler does not support '-march=native'\".",
    "created_at": "2021-01-27T00:02:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472235",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:18'></a>I ran `make -k` to get a fuller report, and it ended with:

```
* package:         gmpy2-2.1.0b5
  last build time: Jan 26 15:52
  log file:        /Users/jpalmier/Desktop/Sage/git/sage/logs/pkgs/gmpy2-2.1.0b5.log
  build directory: /Users/jpalmier/Desktop/Sage/git/sage/local/var/tmp/sage/build/gmpy2-2.1.0b5

* package:         cython-0.29.21
  last build time: Jan 26 15:52
  log file:        /Users/jpalmier/Desktop/Sage/git/sage/logs/pkgs/cython-0.29.21.log
  build directory: /Users/jpalmier/Desktop/Sage/git/sage/local/var/tmp/sage/build/cython-0.29.21

* package:         psutil-5.2.0.p2
  last build time: Jan 26 15:52
  log file:        /Users/jpalmier/Desktop/Sage/git/sage/logs/pkgs/psutil-5.2.0.p2.log
  build directory: /Users/jpalmier/Desktop/Sage/git/sage/local/var/tmp/sage/build/psutil-5.2.0.p2

* package:         pillow-8.0.1
  last build time: Jan 26 15:52
  log file:        /Users/jpalmier/Desktop/Sage/git/sage/logs/pkgs/pillow-8.0.1.log
  build directory: /Users/jpalmier/Desktop/Sage/git/sage/local/var/tmp/sage/build/pillow-8.0.1

* package:         kiwisolver-1.0.1
  last build time: Jan 26 15:52
  log file:        /Users/jpalmier/Desktop/Sage/git/sage/logs/pkgs/kiwisolver-1.0.1.log
  build directory: /Users/jpalmier/Desktop/Sage/git/sage/local/var/tmp/sage/build/kiwisolver-1.0.1

* package:         pynac-0.7.26.sage-2020-04-03.p0
  last build time: Jan 26 15:53
  log file:        /Users/jpalmier/Desktop/Sage/git/sage/logs/pkgs/pynac-0.7.26.sage-2020-04-03.p0.log
  build directory: /Users/jpalmier/Desktop/Sage/git/sage/local/var/tmp/sage/build/pynac-0.7.26.sage-2020-04-03.p0

* package:         cffi-1.14.4
  last build time: Jan 26 15:53
  log file:        /Users/jpalmier/Desktop/Sage/git/sage/logs/pkgs/cffi-1.14.4.log
  build directory: /Users/jpalmier/Desktop/Sage/git/sage/local/var/tmp/sage/build/cffi-1.14.4
```
All show the same error, "clang: error: the clang compiler does not support '-march=native'".



---

archive/issue_comments_472236.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [comment:17 mkoeppe]:\n> OK, looks like we have to set `ARCHFLAGS=\"\"` in more places. But this needs to be done very carefully - see #29408\n\n\nHow can we detect whether we're using a Python which requires this? And where is the right place to do it? `build/bin/sage-build-env-config.in`? There are lots of affected packages, so doing it globally would be easier. (`pyzmq`, `cysignals`, `numpy`, and others also seem to fail with the same error, if I recklessly add `export ARCHFLAGS=\"\"` to the install scripts for the other packages which were failing.)",
    "created_at": "2021-01-27T01:19:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472236",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:19'></a>Replying to [comment:17 mkoeppe]:
> OK, looks like we have to set `ARCHFLAGS=""` in more places. But this needs to be done very carefully - see #29408


How can we detect whether we're using a Python which requires this? And where is the right place to do it? `build/bin/sage-build-env-config.in`? There are lots of affected packages, so doing it globally would be easier. (`pyzmq`, `cysignals`, `numpy`, and others also seem to fail with the same error, if I recklessly add `export ARCHFLAGS=""` to the install scripts for the other packages which were failing.)



---

archive/issue_comments_472237.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [comment:18 jhpalmieri]:\n> All show the same error, \"clang: error: the clang compiler does not support '-march=native'\".\n\n\nOh, this is a different error. Let me try to fix this",
    "created_at": "2021-01-27T01:37:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472237",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'></a>Replying to [comment:18 jhpalmieri]:
> All show the same error, "clang: error: the clang compiler does not support '-march=native'".


Oh, this is a different error. Let me try to fix this



---

archive/issue_comments_472238.json:
```json
{
    "body": "<a id='comment:21'></a>Could you post config.log from this run?",
    "created_at": "2021-01-27T02:04:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472238",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:21'></a>Could you post config.log from this run?



---

archive/issue_comments_472239.json:
```json
{
    "body": "Attachment [config.log](tarball://root/attachments/some-uuid/ticket31227/config.log) by @jhpalmieri created at 2021-01-27 03:08:26",
    "created_at": "2021-01-27T03:08:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472239",
    "user": "https://github.com/jhpalmieri"
}
```

Attachment [config.log](tarball://root/attachments/some-uuid/ticket31227/config.log) by @jhpalmieri created at 2021-01-27 03:08:26



---

archive/issue_comments_472240.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [comment:21 mkoeppe]:\n> Could you post config.log from this run?\n\n\nYes. I replaced the old `config.log`, since that was a result of my error, not a problem with this ticket.",
    "created_at": "2021-01-27T03:09:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472240",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:22'></a>Replying to [comment:21 mkoeppe]:
> Could you post config.log from this run?


Yes. I replaced the old `config.log`, since that was a result of my error, not a problem with this ticket.



---

archive/issue_comments_472241.json:
```json
{
    "body": "<a id='comment:23'></a>Thanks. The crazy thing is that passing `-march=native` only seems to result in the error `clang: error: the clang compiler does not support '-march=native'` if also `-arch arm64` is passed. The current test in `python3/spkg-configure.m4` does not catch this.",
    "created_at": "2021-01-27T03:53:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472241",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:23'></a>Thanks. The crazy thing is that passing `-march=native` only seems to result in the error `clang: error: the clang compiler does not support '-march=native'` if also `-arch arm64` is passed. The current test in `python3/spkg-configure.m4` does not catch this.



---

archive/issue_comments_472242.json:
```json
{
    "body": "<a id='comment:24'></a>What I find a bit confusing is the following:\n\nWe do not test, whether setting `ARCHFLAGS=\"\"` was necesarry in order to build this test extension during configure\n\nWhy do we expect that in real life situations (when actually compiling python extensions for sage) `ARCHFLAGS=\"\"` is not a requirement anymore?",
    "created_at": "2021-01-27T08:08:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472242",
    "user": "https://github.com/kliem"
}
```

<a id='comment:24'></a>What I find a bit confusing is the following:

We do not test, whether setting `ARCHFLAGS=""` was necesarry in order to build this test extension during configure

Why do we expect that in real life situations (when actually compiling python extensions for sage) `ARCHFLAGS=""` is not a requirement anymore?



---

archive/issue_comments_472243.json:
```json
{
    "body": "<a id='comment:25'></a>For what it's worth, setting `ARCHFLAGS=\"\"` in `sage-build-env-config.in` let me build Sage. Doctesting didn't go that well: various failures because of \"command 'gcc' failed with exit status 1\" and \"#error Unsupported architecture\" and \"#error architecture not supported\".",
    "created_at": "2021-01-27T19:25:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472243",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:25'></a>For what it's worth, setting `ARCHFLAGS=""` in `sage-build-env-config.in` let me build Sage. Doctesting didn't go that well: various failures because of "command 'gcc' failed with exit status 1" and "#error Unsupported architecture" and "#error architecture not supported".



---

archive/issue_comments_472244.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-01-30T17:50:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472244",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_472245.json:
```json
{
    "body": "<a id='comment:27'></a>Replying to [comment:25 jhpalmieri]:\n> For what it's worth, setting `ARCHFLAGS=\"\"` in `sage-build-env-config.in` let me build Sage. Doctesting didn't go that well: various failures because of \"command 'gcc' failed with exit status 1\" and \"#error Unsupported architecture\" and \"#error architecture not supported\".\n\n\nIf we set `ARCHFLAGS`, we will have to do this in `sage-env` so that it also affects runtime use of the compiler (some of which is tested in doctests) and when users install Python packages with `sage -pip`.",
    "created_at": "2021-01-31T00:11:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472245",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:27'></a>Replying to [comment:25 jhpalmieri]:
> For what it's worth, setting `ARCHFLAGS=""` in `sage-build-env-config.in` let me build Sage. Doctesting didn't go that well: various failures because of "command 'gcc' failed with exit status 1" and "#error Unsupported architecture" and "#error architecture not supported".


If we set `ARCHFLAGS`, we will have to do this in `sage-env` so that it also affects runtime use of the compiler (some of which is tested in doctests) and when users install Python packages with `sage -pip`.



---

archive/issue_comments_472246.json:
```json
{
    "body": "<a id='comment:28'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-31T00:28:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472246",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:28'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_472247.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,26 @@\n+(from #31132)\n+\n+#27122 determines whether CC accepts `-march=native` and then adds it globally to `CFLAGS` in `build/bin/sage-build-env`.\n+\n+#30725 fixes this for macOS, where some packages are explicitly built with `clang`.\n+\n+However, there is another mechanism how `clang` can come in: Python extension modules are compiled with the compiler listed in sysconfig. On macOS with homebrew, using `/usr/bin/python3`, this could again be `clang`, which does not accept `-march=native` in combination with `-arch arm64` (which is provided even on x86_64 if `ARCHFLAGS` is unset).\n+\n+In this ticket, we fix this by checking whether the compiler used by distutils accepts `-march=native` (or more generally, the flags determined earlier by `configure`). If it does not, then we disable the use of these flags.\n+\n+In order to test this with `/usr/bin/python3` from XCode 12.3 (on macOS 10.15 (Catalina)), we fix another issue:\n+This python3 (3.8.2) is not able to build extension modules because it emits `-arch arm64 -arch x86_64` unless `ARCHFLAGS` is set explicitly\n+\n+```\n+$ /usr/bin/python3 -m sysconfig |grep '\\bCFLAGS ='\n+\tCFLAGS = \"-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64\"\n+ARCHFLAGS=\"\" /usr/bin/python3 -m sysconfig |grep '\\bCFLAGS ='\n+\tCFLAGS = \"-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers  -arch x86_64 \"\n+egret:~/s/sage/sage-rebasing/worktree-algebraic-2018-spring (t/31132/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_build_when_using_homebrew_s_python3 *\n+```\n+\n+In this ticket, we set `ARCHFLAGS` during this configure step.\n+ \n \n \n Comment: 1\n```\n",
    "created_at": "2021-01-31T00:36:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472247",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,26 @@
+(from #31132)
+
+#27122 determines whether CC accepts `-march=native` and then adds it globally to `CFLAGS` in `build/bin/sage-build-env`.
+
+#30725 fixes this for macOS, where some packages are explicitly built with `clang`.
+
+However, there is another mechanism how `clang` can come in: Python extension modules are compiled with the compiler listed in sysconfig. On macOS with homebrew, using `/usr/bin/python3`, this could again be `clang`, which does not accept `-march=native` in combination with `-arch arm64` (which is provided even on x86_64 if `ARCHFLAGS` is unset).
+
+In this ticket, we fix this by checking whether the compiler used by distutils accepts `-march=native` (or more generally, the flags determined earlier by `configure`). If it does not, then we disable the use of these flags.
+
+In order to test this with `/usr/bin/python3` from XCode 12.3 (on macOS 10.15 (Catalina)), we fix another issue:
+This python3 (3.8.2) is not able to build extension modules because it emits `-arch arm64 -arch x86_64` unless `ARCHFLAGS` is set explicitly
+
+```
+$ /usr/bin/python3 -m sysconfig |grep '\bCFLAGS ='
+	CFLAGS = "-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64"
+ARCHFLAGS="" /usr/bin/python3 -m sysconfig |grep '\bCFLAGS ='
+	CFLAGS = "-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers  -arch x86_64 "
+egret:~/s/sage/sage-rebasing/worktree-algebraic-2018-spring (t/31132/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_build_when_using_homebrew_s_python3 *
+```
+
+In this ticket, we set `ARCHFLAGS` during this configure step.
+ 
 
 
 Comment: 1
```




---

archive/issue_comments_472248.json:
```json
{
    "body": "<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-31T02:20:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472248",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_472249.json:
```json
{
    "body": "<a id='comment:31'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-31T04:17:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472249",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:31'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_472250.json:
```json
{
    "body": "<a id='comment:32'></a>Here's a new version that may be worth testing",
    "created_at": "2021-01-31T04:22:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472250",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:32'></a>Here's a new version that may be worth testing



---

archive/issue_comments_472251.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-01-31T04:22:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472251",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_472252.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,27 @@\n+(from #31132)\n+\n+#27122 determines whether CC accepts `-march=native` and then adds it globally to `CFLAGS` in `build/bin/sage-build-env`.\n+\n+#30725 fixes this for macOS, where some packages are explicitly built with `clang`.\n+\n+However, there is another mechanism how `clang` can come in: Python extension modules are compiled with the compiler listed in sysconfig. On macOS with homebrew, using `/usr/bin/python3`, this could again be `clang`, which does not accept `-march=native` in combination with `-arch arm64` (which is provided even on x86_64 if `ARCHFLAGS` is unset).\n+\n+In this ticket, we fix this by checking whether the compiler used by distutils accepts `-march=native` (or more generally, the flags determined earlier by `configure`). If it does not, then we disable the use of these flags.\n+\n+In order to test this with `/usr/bin/python3` from XCode 12.3 (on macOS 10.15 (Catalina)), we fix another issue:\n+This python3 (3.8.2) is not able to build extension modules because it emits `-arch arm64 -arch x86_64` unless `ARCHFLAGS` is set explicitly\n+\n+```\n+$ /usr/bin/python3 -m sysconfig |grep '\\bCFLAGS ='\n+\tCFLAGS = \"-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64\"\n+ARCHFLAGS=\"\" /usr/bin/python3 -m sysconfig |grep '\\bCFLAGS ='\n+\tCFLAGS = \"-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers  -arch x86_64 \"\n+egret:~/s/sage/sage-rebasing/worktree-algebraic-2018-spring (t/31132/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_build_when_using_homebrew_s_python3 *\n+```\n+\n+In this ticket, if the distutils test fails, we try if setting `ARCHFLAGS=\"\"` fixes it. In that case, we store a configuration variable that causes `sage-env` to set `ARCHFLAGS` as well.\n+\n+ \n \n \n Comment: 1\n```\n",
    "created_at": "2021-01-31T04:25:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472252",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,27 @@
+(from #31132)
+
+#27122 determines whether CC accepts `-march=native` and then adds it globally to `CFLAGS` in `build/bin/sage-build-env`.
+
+#30725 fixes this for macOS, where some packages are explicitly built with `clang`.
+
+However, there is another mechanism how `clang` can come in: Python extension modules are compiled with the compiler listed in sysconfig. On macOS with homebrew, using `/usr/bin/python3`, this could again be `clang`, which does not accept `-march=native` in combination with `-arch arm64` (which is provided even on x86_64 if `ARCHFLAGS` is unset).
+
+In this ticket, we fix this by checking whether the compiler used by distutils accepts `-march=native` (or more generally, the flags determined earlier by `configure`). If it does not, then we disable the use of these flags.
+
+In order to test this with `/usr/bin/python3` from XCode 12.3 (on macOS 10.15 (Catalina)), we fix another issue:
+This python3 (3.8.2) is not able to build extension modules because it emits `-arch arm64 -arch x86_64` unless `ARCHFLAGS` is set explicitly
+
+```
+$ /usr/bin/python3 -m sysconfig |grep '\bCFLAGS ='
+	CFLAGS = "-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64"
+ARCHFLAGS="" /usr/bin/python3 -m sysconfig |grep '\bCFLAGS ='
+	CFLAGS = "-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers  -arch x86_64 "
+egret:~/s/sage/sage-rebasing/worktree-algebraic-2018-spring (t/31132/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_build_when_using_homebrew_s_python3 *
+```
+
+In this ticket, if the distutils test fails, we try if setting `ARCHFLAGS=""` fixes it. In that case, we store a configuration variable that causes `sage-env` to set `ARCHFLAGS` as well.
+
+ 
 
 
 Comment: 1
```




---

archive/issue_comments_472253.json:
```json
{
    "body": "<a id='comment:34'></a>Builds successfully for me with `tox -e local-homebrew-macos-standard-python3_xcode`",
    "created_at": "2021-01-31T04:56:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472253",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:34'></a>Builds successfully for me with `tox -e local-homebrew-macos-standard-python3_xcode`



---

archive/issue_comments_472254.json:
```json
{
    "body": "<a id='comment:35'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-31T08:24:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472254",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:35'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_472255.json:
```json
{
    "body": "<a id='comment:36'></a>What is the purpose of this line?\n\n```diff\n+    AC_SUBST([ARCHFLAGS], [unset])\n```",
    "created_at": "2021-01-31T08:34:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472255",
    "user": "https://github.com/kliem"
}
```

<a id='comment:36'></a>What is the purpose of this line?

```diff
+    AC_SUBST([ARCHFLAGS], [unset])
```



---

archive/issue_comments_472256.json:
```json
{
    "body": "<a id='comment:37'></a>I think the second reason is wrong here. Isn't this the case when building a C extension fails?\n\n```\ndnl distutils test\nAC_DEFUN([SAGE_PYTHON_CHECK_DISTUTILS], [\n    m4_pushdef([PYTHON_EXE], [$1])\n    m4_pushdef([COMMANDS_IF_DISTUTILS_GOOD], [$2])\n    m4_pushdef([COMMANDS_IF_DISTUTILS_NOT_GOOD], [$3])\n    SAGE_PYTHON_DISTUTILS_C_CONFTEST\n    dnl (echo \"***ENV***:\"; env; echo \"***SYSCONFIG***\"; conftest_venv/bin/python3 -m sysconfig) >& AS_MESSAGE_LOG_FD\n    echo PYTHON_EXE conftest.py --verbose build --build-base=conftest.dir >& AS_MESSAGE_LOG_FD\n    AS_IF([PYTHON_EXE conftest.py --verbose build --build-base=conftest.dir >& AS_MESSAGE_LOG_FD 2>&1 ], [\n        SAGE_PYTHON_DISTUTILS_CXX_CONFTEST\n        echo PYTHON_EXE conftest.py --verbose build --build-base=conftest.dir >& AS_MESSAGE_LOG_FD 2>&1\n        AS_IF([PYTHON_EXE conftest.py --verbose build --build-base=conftest.dir >& AS_MESSAGE_LOG_FD 2>&1 ], [\n            COMMANDS_IF_DISTUTILS_GOOD], [\n            reason=\"distutils cannot build a C++ 11 extension\"\n            COMMANDS_IF_DISTUTILS_NOT_GOOD\n        ])\n    ], [\n       reason=\"distutils cannot build a C++ 11 extension\"\n       COMMANDS_IF_DISTUTILS_NOT_GOOD\n    ])\n    m4_popdef([PYTHON_EXE])\n    m4_popdef([COMMANDS_IF_DISTUTILS_GOOD])\n    m4_popdef([COMMANDS_IF_DISTUTILS_NOT_GOOD])\n])\n```",
    "created_at": "2021-01-31T08:46:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472256",
    "user": "https://github.com/kliem"
}
```

<a id='comment:37'></a>I think the second reason is wrong here. Isn't this the case when building a C extension fails?

```
dnl distutils test
AC_DEFUN([SAGE_PYTHON_CHECK_DISTUTILS], [
    m4_pushdef([PYTHON_EXE], [$1])
    m4_pushdef([COMMANDS_IF_DISTUTILS_GOOD], [$2])
    m4_pushdef([COMMANDS_IF_DISTUTILS_NOT_GOOD], [$3])
    SAGE_PYTHON_DISTUTILS_C_CONFTEST
    dnl (echo "***ENV***:"; env; echo "***SYSCONFIG***"; conftest_venv/bin/python3 -m sysconfig) >& AS_MESSAGE_LOG_FD
    echo PYTHON_EXE conftest.py --verbose build --build-base=conftest.dir >& AS_MESSAGE_LOG_FD
    AS_IF([PYTHON_EXE conftest.py --verbose build --build-base=conftest.dir >& AS_MESSAGE_LOG_FD 2>&1 ], [
        SAGE_PYTHON_DISTUTILS_CXX_CONFTEST
        echo PYTHON_EXE conftest.py --verbose build --build-base=conftest.dir >& AS_MESSAGE_LOG_FD 2>&1
        AS_IF([PYTHON_EXE conftest.py --verbose build --build-base=conftest.dir >& AS_MESSAGE_LOG_FD 2>&1 ], [
            COMMANDS_IF_DISTUTILS_GOOD], [
            reason="distutils cannot build a C++ 11 extension"
            COMMANDS_IF_DISTUTILS_NOT_GOOD
        ])
    ], [
       reason="distutils cannot build a C++ 11 extension"
       COMMANDS_IF_DISTUTILS_NOT_GOOD
    ])
    m4_popdef([PYTHON_EXE])
    m4_popdef([COMMANDS_IF_DISTUTILS_GOOD])
    m4_popdef([COMMANDS_IF_DISTUTILS_NOT_GOOD])
])
```



---

archive/issue_comments_472257.json:
```json
{
    "body": "<a id='comment:38'></a>Also `tox -e local-homebrew-usrlocal-minimal-python3.8` still works.",
    "created_at": "2021-01-31T08:47:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472257",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:38'></a>Also `tox -e local-homebrew-usrlocal-minimal-python3.8` still works.



---

archive/issue_comments_472258.json:
```json
{
    "body": "<a id='comment:39'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-31T08:50:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472258",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:39'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_472259.json:
```json
{
    "body": "<a id='comment:40'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-31T08:51:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472259",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:40'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_472260.json:
```json
{
    "body": "<a id='comment:41'></a>Thanks for spotting these mistakes!",
    "created_at": "2021-01-31T08:51:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472260",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:41'></a>Thanks for spotting these mistakes!



---

archive/issue_comments_472261.json:
```json
{
    "body": "<a id='comment:42'></a>Otherwise, this looks very plausible.\n\nI updated https://github.com/kliem/sage/pull/36/ (not the last two commits, but they are cosmetic).",
    "created_at": "2021-01-31T09:09:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472261",
    "user": "https://github.com/kliem"
}
```

<a id='comment:42'></a>Otherwise, this looks very plausible.

I updated https://github.com/kliem/sage/pull/36/ (not the last two commits, but they are cosmetic).



---

archive/issue_comments_472262.json:
```json
{
    "body": "<a id='comment:43'></a>This works for me on OS X Catalina. If I also include #31204, it passes most doctests. I see a few failures I don't remember seeing before:\n\n```\nsage -t --long --random-seed=0 src/sage_setup/find.py\n**********************************************************************\nFile \"src/sage_setup/find.py\", line 278, in sage_setup.find.installed_files_by_module\nFailed example:\n    f1\nExpected:\n    'sage/structure/__init__.py'\nGot:\n    '/Users/jpalmier/Library/Caches/com.apple.python/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python3.8/site-packages/sage/structure/__init__.cpython-38.pyc'\n**********************************************************************\nFile \"src/sage_setup/find.py\", line 280, in sage_setup.find.installed_files_by_module\nFailed example:\n    f2\nExpected:\n    'sage/structure/....pyc'\nGot:\n    'sage/structure/__init__.py'\n```\nand\n\n```\nsage -t --long --random-seed=0 src/sage_setup/clean.py\n**********************************************************************\nFile \"src/sage_setup/clean.py\", line 95, in sage_setup.clean._find_stale_files\nFailed example:\n    for f in stale_iter:\n        if f.endswith(skip_extensions): continue\n        if '/ext_data/' in f: continue\n        print('Found stale file: ' + f)\nExpected nothing\nGot:\n    Found stale file: /Users/jpalmier/Library/Caches/com.apple.python/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python3.8/site-packages/sage/all_cmdline.cpython-38.pyc\n    Found stale file: /Users/jpalmier/Library/Caches/com.apple.python/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python3.8/site-packages/sage/version.cpython-38.pyc\n\n  [ and many more lines of such messages ]\n```\nWhy is it looking in `$HOME/Library`? Also, the files there look from their dates as if they were created during this build of Sage.",
    "created_at": "2021-01-31T22:27:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472262",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:43'></a>This works for me on OS X Catalina. If I also include #31204, it passes most doctests. I see a few failures I don't remember seeing before:

```
sage -t --long --random-seed=0 src/sage_setup/find.py
**********************************************************************
File "src/sage_setup/find.py", line 278, in sage_setup.find.installed_files_by_module
Failed example:
    f1
Expected:
    'sage/structure/__init__.py'
Got:
    '/Users/jpalmier/Library/Caches/com.apple.python/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python3.8/site-packages/sage/structure/__init__.cpython-38.pyc'
**********************************************************************
File "src/sage_setup/find.py", line 280, in sage_setup.find.installed_files_by_module
Failed example:
    f2
Expected:
    'sage/structure/....pyc'
Got:
    'sage/structure/__init__.py'
```
and

```
sage -t --long --random-seed=0 src/sage_setup/clean.py
**********************************************************************
File "src/sage_setup/clean.py", line 95, in sage_setup.clean._find_stale_files
Failed example:
    for f in stale_iter:
        if f.endswith(skip_extensions): continue
        if '/ext_data/' in f: continue
        print('Found stale file: ' + f)
Expected nothing
Got:
    Found stale file: /Users/jpalmier/Library/Caches/com.apple.python/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python3.8/site-packages/sage/all_cmdline.cpython-38.pyc
    Found stale file: /Users/jpalmier/Library/Caches/com.apple.python/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python3.8/site-packages/sage/version.cpython-38.pyc

  [ and many more lines of such messages ]
```
Why is it looking in `$HOME/Library`? Also, the files there look from their dates as if they were created during this build of Sage.



---

archive/issue_comments_472263.json:
```json
{
    "body": "<a id='comment:44'></a>This does not work for me with OS X Big Sur, though: many packages (cython, pynac, gmpy2, psutil, pillow, kiwisolver, cffi) fail to build with the error \"clang: error: the clang compiler does not support '-march=native'\".\n\nHold on, I have to run `./bootstrap` and try again.\n\nConfirmed, these packages all fail after\n\n```\nmake distclean && ./bootstrap && ./configure --with-python=/usr/bin/python3 && make -k\n```",
    "created_at": "2021-01-31T23:42:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472263",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:44'></a>This does not work for me with OS X Big Sur, though: many packages (cython, pynac, gmpy2, psutil, pillow, kiwisolver, cffi) fail to build with the error "clang: error: the clang compiler does not support '-march=native'".

Hold on, I have to run `./bootstrap` and try again.

Confirmed, these packages all fail after

```
make distclean && ./bootstrap && ./configure --with-python=/usr/bin/python3 && make -k
```



---

archive/issue_comments_472264.json:
```json
{
    "body": "<a id='comment:45'></a>Replying to [comment:43 jhpalmieri]:\n> This works for me on OS X Catalina. If I also include #31204, it passes most doctests. I see a few failures I don't remember seeing before [...]\n> Why is it looking in `$HOME/Library`? Also, the files there look from their dates as if they were created during this build of Sage.\n\n\nIs `PYTHONPYCACHEPREFIX` set on your system? https://docs.python.org/3/using/cmdline.html#envvar-PYTHONPYCACHEPREFIX\n(#31314)",
    "created_at": "2021-02-01T01:22:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472264",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:45'></a>Replying to [comment:43 jhpalmieri]:
> This works for me on OS X Catalina. If I also include #31204, it passes most doctests. I see a few failures I don't remember seeing before [...]
> Why is it looking in `$HOME/Library`? Also, the files there look from their dates as if they were created during this build of Sage.


Is `PYTHONPYCACHEPREFIX` set on your system? https://docs.python.org/3/using/cmdline.html#envvar-PYTHONPYCACHEPREFIX
(#31314)



---

archive/issue_comments_472265.json:
```json
{
    "body": "<a id='comment:46'></a>`config.log` from the big sur system please",
    "created_at": "2021-02-01T01:23:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472265",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:46'></a>`config.log` from the big sur system please



---

archive/issue_comments_472266.json:
```json
{
    "body": "<a id='comment:47'></a>Replying to [comment:45 mkoeppe]:\n> Replying to [comment:43 jhpalmieri]:\n> > This works for me on OS X Catalina. If I also include #31204, it passes most doctests. I see a few failures I don't remember seeing before [...]\n> > Why is it looking in `$HOME/Library`? Also, the files there look from their dates as if they were created during this build of Sage.\n\n> \n> Is `PYTHONPYCACHEPREFIX` set on your system? https://docs.python.org/3/using/cmdline.html#envvar-PYTHONPYCACHEPREFIX\n> (#31314)\n\n\nNo, not normally and not after running `./sage --sh`.",
    "created_at": "2021-02-01T02:08:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472266",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:47'></a>Replying to [comment:45 mkoeppe]:
> Replying to [comment:43 jhpalmieri]:
> > This works for me on OS X Catalina. If I also include #31204, it passes most doctests. I see a few failures I don't remember seeing before [...]
> > Why is it looking in `$HOME/Library`? Also, the files there look from their dates as if they were created during this build of Sage.

> 
> Is `PYTHONPYCACHEPREFIX` set on your system? https://docs.python.org/3/using/cmdline.html#envvar-PYTHONPYCACHEPREFIX
> (#31314)


No, not normally and not after running `./sage --sh`.



---

archive/issue_comments_472267.json:
```json
{
    "body": "Attachment [config.2.log](tarball://root/attachments/some-uuid/ticket31227/config.2.log) by @jhpalmieri created at 2021-02-01 02:09:11\n\nconfig.log for failed Big Sur build",
    "created_at": "2021-02-01T02:09:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472267",
    "user": "https://github.com/jhpalmieri"
}
```

Attachment [config.2.log](tarball://root/attachments/some-uuid/ticket31227/config.2.log) by @jhpalmieri created at 2021-02-01 02:09:11

config.log for failed Big Sur build



---

archive/issue_comments_472268.json:
```json
{
    "body": "<a id='comment:48'></a>Replying to [comment:47 jhpalmieri]:\n> Replying to [comment:45 mkoeppe]:\n> > Replying to [comment:43 jhpalmieri]:\n> > > This works for me on OS X Catalina. If I also include #31204, it passes most doctests. I see a few failures I don't remember seeing before [...]\n> > > Why is it looking in `$HOME/Library`? Also, the files there look from their dates as if they were created during this build of Sage.\n\n> > \n> > Is `PYTHONPYCACHEPREFIX` set on your system? https://docs.python.org/3/using/cmdline.html#envvar-PYTHONPYCACHEPREFIX\n> > (#31314)\n\n> \n> No, not normally and not after running `./sage --sh`.\n\n\nHowever:\n\n```\n% /usr/bin/python3   \nPython 3.8.2 (default, Dec 21 2020, 15:06:04) \n[Clang 12.0.0 (clang-1200.0.32.29)] on darwin\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> import sys\n>>> sys.pycache_prefix\n'/Users/jpalmier/Library/Caches/com.apple.python'\n```\nThis is not how `/usr/local/bin/python3` behaves: `sys.pycache_prefix` is `None` there. The Python documentation suggests that the default setting should be `None` since I am not passing a `-X` argument nor am I setting `PYTHONPYCACHEPREFIX`.",
    "created_at": "2021-02-01T02:16:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472268",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:48'></a>Replying to [comment:47 jhpalmieri]:
> Replying to [comment:45 mkoeppe]:
> > Replying to [comment:43 jhpalmieri]:
> > > This works for me on OS X Catalina. If I also include #31204, it passes most doctests. I see a few failures I don't remember seeing before [...]
> > > Why is it looking in `$HOME/Library`? Also, the files there look from their dates as if they were created during this build of Sage.

> > 
> > Is `PYTHONPYCACHEPREFIX` set on your system? https://docs.python.org/3/using/cmdline.html#envvar-PYTHONPYCACHEPREFIX
> > (#31314)

> 
> No, not normally and not after running `./sage --sh`.


However:

```
% /usr/bin/python3   
Python 3.8.2 (default, Dec 21 2020, 15:06:04) 
[Clang 12.0.0 (clang-1200.0.32.29)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>> import sys
>>> sys.pycache_prefix
'/Users/jpalmier/Library/Caches/com.apple.python'
```
This is not how `/usr/local/bin/python3` behaves: `sys.pycache_prefix` is `None` there. The Python documentation suggests that the default setting should be `None` since I am not passing a `-X` argument nor am I setting `PYTHONPYCACHEPREFIX`.



---

archive/issue_comments_472269.json:
```json
{
    "body": "<a id='comment:49'></a>hm... config.2.log does not look like it's coming from this branch...",
    "created_at": "2021-02-01T02:18:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472269",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:49'></a>hm... config.2.log does not look like it's coming from this branch...



---

archive/issue_comments_472270.json:
```json
{
    "body": "<a id='comment:50'></a>Replying to [comment:48 jhpalmieri]:\n> {{{\n> % /usr/bin/python3   \n> Python 3.8.2 (default, Dec 21 2020, 15:06:04) \n> [Clang 12.0.0 (clang-1200.0.32.29)] on darwin\n> Type \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n> >>> import sys\n> >>> sys.pycache_prefix\n\n> '/Users/jpalmier/Library/Caches/com.apple.python'\n> }}}\n\n\nSame here. Looks like Apple has preconfigured their build to do this. I'll update the description of #31314.",
    "created_at": "2021-02-01T02:20:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472270",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:50'></a>Replying to [comment:48 jhpalmieri]:
> {{{
> % /usr/bin/python3   
> Python 3.8.2 (default, Dec 21 2020, 15:06:04) 
> [Clang 12.0.0 (clang-1200.0.32.29)] on darwin
> Type "help", "copyright", "credits" or "license" for more information.
> >>> import sys
> >>> sys.pycache_prefix

> '/Users/jpalmier/Library/Caches/com.apple.python'
> }}}


Same here. Looks like Apple has preconfigured their build to do this. I'll update the description of #31314.



---

archive/issue_comments_472271.json:
```json
{
    "body": "<a id='comment:51'></a>Replying to [comment:49 mkoeppe]:\n> hm... config.2.log does not look like it's coming from this branch...\n  \nSorry, you're right. Typo on my part: I checked out #31127 instead of #31227. Trying again now.",
    "created_at": "2021-02-01T02:25:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472271",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:51'></a>Replying to [comment:49 mkoeppe]:
> hm... config.2.log does not look like it's coming from this branch...
  
Sorry, you're right. Typo on my part: I checked out #31127 instead of #31227. Trying again now.



---

archive/issue_comments_472272.json:
```json
{
    "body": "<a id='comment:52'></a>Now with Big Sur, `cysignals` and `scipy` fail. For `scipy`, the error looks like this:\n\n```\n    /Users/palmieri/Desktop/Sage/sage_builds/TESTING/clean/sage-9.3.beta6/local/lib/python3.8/site-packages/numpy/distutils/system_info.py:838: UserWarning: Specified path /usr/local/include/python3.8 is invalid.\n```\nSomehow it's picking up `/usr/local`. I'm not sure what's going on with `cysignals`. Logs attached.",
    "created_at": "2021-02-01T03:53:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472272",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:52'></a>Now with Big Sur, `cysignals` and `scipy` fail. For `scipy`, the error looks like this:

```
    /Users/palmieri/Desktop/Sage/sage_builds/TESTING/clean/sage-9.3.beta6/local/lib/python3.8/site-packages/numpy/distutils/system_info.py:838: UserWarning: Specified path /usr/local/include/python3.8 is invalid.
```
Somehow it's picking up `/usr/local`. I'm not sure what's going on with `cysignals`. Logs attached.



---

archive/issue_comments_472273.json:
```json
{
    "body": "config.log for failed Big Sur build",
    "created_at": "2021-02-01T03:54:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472273",
    "user": "https://github.com/jhpalmieri"
}
```

config.log for failed Big Sur build



---

archive/issue_comments_472274.json:
```json
{
    "body": "Attachment [config.3.log](tarball://root/attachments/some-uuid/ticket31227/config.3.log) by @jhpalmieri created at 2021-02-01 03:54:25",
    "created_at": "2021-02-01T03:54:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472274",
    "user": "https://github.com/jhpalmieri"
}
```

Attachment [config.3.log](tarball://root/attachments/some-uuid/ticket31227/config.3.log) by @jhpalmieri created at 2021-02-01 03:54:25



---

archive/issue_comments_472275.json:
```json
{
    "body": "Attachment [cysignals-1.10.2.log](tarball://root/attachments/some-uuid/ticket31227/cysignals-1.10.2.log) by @jhpalmieri created at 2021-02-01 03:54:34",
    "created_at": "2021-02-01T03:54:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472275",
    "user": "https://github.com/jhpalmieri"
}
```

Attachment [cysignals-1.10.2.log](tarball://root/attachments/some-uuid/ticket31227/cysignals-1.10.2.log) by @jhpalmieri created at 2021-02-01 03:54:34



---

archive/issue_comments_472276.json:
```json
{
    "body": "<a id='comment:53'></a>Attachment [scipy-1.5.4.log](tarball://root/attachments/some-uuid/ticket31227/scipy-1.5.4.log) by @mkoeppe created at 2021-02-01 03:58:21\n\nThe config.log looks good.",
    "created_at": "2021-02-01T03:58:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472276",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:53'></a>Attachment [scipy-1.5.4.log](tarball://root/attachments/some-uuid/ticket31227/scipy-1.5.4.log) by @mkoeppe created at 2021-02-01 03:58:21

The config.log looks good.



---

archive/issue_comments_472277.json:
```json
{
    "body": "<a id='comment:54'></a>Replying to [comment:52 jhpalmieri]:\n> Now with Big Sur, `cysignals` and `scipy` fail. For `scipy`, the error looks like this:\n> \n> ```\n>     /Users/palmieri/Desktop/Sage/sage_builds/TESTING/clean/sage-9.3.beta6/local/lib/python3.8/site-packages/numpy/distutils/system_info.py:838: UserWarning: Specified path /usr/local/include/python3.8 is invalid.\n> ```\n\n\nI think the actual error is this one:\n\n```\n  ar: adding 50 object files to build/temp.macosx-10.14.6-x86_64-3.8/libsuperlu_src.a\n  warning: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/ranlib: archive library: build/temp.macosx-10.14.6-x86_64-3.8/libsuperlu_src.a will be fat and ar(1) will not be able to operate on it\n  ar: adding 50 object files to build/temp.macosx-10.14.6-x86_64-3.8/libsuperlu_src.a\n  ar: build/temp.macosx-10.14.6-x86_64-3.8/libsuperlu_src.a is a fat file (use libtool(1) or lipo(1) and ar(1) on it)\n  ar: build/temp.macosx-10.14.6-x86_64-3.8/libsuperlu_src.a: Inappropriate file type or format\n```",
    "created_at": "2021-02-01T04:01:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472277",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:54'></a>Replying to [comment:52 jhpalmieri]:
> Now with Big Sur, `cysignals` and `scipy` fail. For `scipy`, the error looks like this:
> 
> ```
>     /Users/palmieri/Desktop/Sage/sage_builds/TESTING/clean/sage-9.3.beta6/local/lib/python3.8/site-packages/numpy/distutils/system_info.py:838: UserWarning: Specified path /usr/local/include/python3.8 is invalid.
> ```


I think the actual error is this one:

```
  ar: adding 50 object files to build/temp.macosx-10.14.6-x86_64-3.8/libsuperlu_src.a
  warning: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/ranlib: archive library: build/temp.macosx-10.14.6-x86_64-3.8/libsuperlu_src.a will be fat and ar(1) will not be able to operate on it
  ar: adding 50 object files to build/temp.macosx-10.14.6-x86_64-3.8/libsuperlu_src.a
  ar: build/temp.macosx-10.14.6-x86_64-3.8/libsuperlu_src.a is a fat file (use libtool(1) or lipo(1) and ar(1) on it)
  ar: build/temp.macosx-10.14.6-x86_64-3.8/libsuperlu_src.a: Inappropriate file type or format
```



---

archive/issue_comments_472278.json:
```json
{
    "body": "<a id='comment:55'></a>Similar: https://github.com/scipy/scipy/issues/10902",
    "created_at": "2021-02-01T04:09:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472278",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:55'></a>Similar: https://github.com/scipy/scipy/issues/10902



---

archive/issue_comments_472279.json:
```json
{
    "body": "<a id='comment:56'></a>Is `MACOSX_DEPLOYMENT_TARGET` set to something on your big sur system?",
    "created_at": "2021-02-01T04:13:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472279",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:56'></a>Is `MACOSX_DEPLOYMENT_TARGET` set to something on your big sur system?



---

archive/issue_comments_472280.json:
```json
{
    "body": "<a id='comment:57'></a>Replying to [comment:56 mkoeppe]:\n> Is `MACOSX_DEPLOYMENT_TARGET` set to something on your big sur system?\n\n\nNo, but who knows what Xcode and/or homebrew are doing these days.",
    "created_at": "2021-02-01T04:17:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472280",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:57'></a>Replying to [comment:56 mkoeppe]:
> Is `MACOSX_DEPLOYMENT_TARGET` set to something on your big sur system?


No, but who knows what Xcode and/or homebrew are doing these days.



---

archive/issue_comments_472281.json:
```json
{
    "body": "<a id='comment:58'></a>from cysignals.log: \n\n```\n  gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64 -O2 -g -Wp,-U_FORTIFY_SOURCE -DCYTHON_CLINE_IN_TRACEBACK=0 -U_FORTIFY_SOURCE -Isrc/cysignals -Isrc -I/Users/palmieri/Desktop/Sage/sage_builds/TESTING/clean/sage-9.3.beta6/local/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -c build/src/cysignals/signals.c -o build/temp.macosx-10.14.6-x86_64-3.8/build/src/cysignals/signals.o -pthread\n  In file included from build/src/cysignals/signals.c:1570:\n  In file included from build/src/cysignals/implementation.c:58:\n  In file included from /Users/palmieri/Desktop/Sage/sage_builds/TESTING/clean/sage-9.3.beta6/local/include/pari/pari.h:49:\n  ../src/kernel/none/divll_pre.h:30:10: error: invalid output constraint '=a' in asm\n    return divll(~0UL, n);\n           ^\n```\nThis is trying to build for `-arch arm64 -arch x86_64` and is tripping over the installed pari header ... which is arch-specific!",
    "created_at": "2021-02-01T04:21:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472281",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:58'></a>from cysignals.log: 

```
  gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64 -O2 -g -Wp,-U_FORTIFY_SOURCE -DCYTHON_CLINE_IN_TRACEBACK=0 -U_FORTIFY_SOURCE -Isrc/cysignals -Isrc -I/Users/palmieri/Desktop/Sage/sage_builds/TESTING/clean/sage-9.3.beta6/local/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -c build/src/cysignals/signals.c -o build/temp.macosx-10.14.6-x86_64-3.8/build/src/cysignals/signals.o -pthread
  In file included from build/src/cysignals/signals.c:1570:
  In file included from build/src/cysignals/implementation.c:58:
  In file included from /Users/palmieri/Desktop/Sage/sage_builds/TESTING/clean/sage-9.3.beta6/local/include/pari/pari.h:49:
  ../src/kernel/none/divll_pre.h:30:10: error: invalid output constraint '=a' in asm
    return divll(~0UL, n);
           ^
```
This is trying to build for `-arch arm64 -arch x86_64` and is tripping over the installed pari header ... which is arch-specific!



---

archive/issue_comments_472282.json:
```json
{
    "body": "<a id='comment:59'></a>Before I source `.homebrew-build-env`, I only set these environment variables:\n\n```\nBIBINPUTS=/Users/palmieri/iCloud/Documents/tex/bibtex:.:\nEDITOR=emacs\nLESS=-R\nLSCOLORS=Gxfxcxdxbxegedabagacad\nMAKE='make -j6'\nMAKEFLAGS=-j6\nPAGER=less\nPATH=/Users/palmieri/.local/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/Library/TeX/texbin:/Library/Apple/usr/bin:/Library/Frameworks/Mono.framework/Versions/Current/Commands\n```\n(If I run `export` at the start of my .zshrc file and also comment out the line that runs `.homebrew-build-env`, and then run `export` again with an actual running terminal, these are the differences.) Nothing strange there, nothing that I think should cause any problems. This is on the Big Sur system, but the Catalina system has a very similar configuration.",
    "created_at": "2021-02-01T04:32:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472282",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:59'></a>Before I source `.homebrew-build-env`, I only set these environment variables:

```
BIBINPUTS=/Users/palmieri/iCloud/Documents/tex/bibtex:.:
EDITOR=emacs
LESS=-R
LSCOLORS=Gxfxcxdxbxegedabagacad
MAKE='make -j6'
MAKEFLAGS=-j6
PAGER=less
PATH=/Users/palmieri/.local/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/Library/TeX/texbin:/Library/Apple/usr/bin:/Library/Frameworks/Mono.framework/Versions/Current/Commands
```
(If I run `export` at the start of my .zshrc file and also comment out the line that runs `.homebrew-build-env`, and then run `export` again with an actual running terminal, these are the differences.) Nothing strange there, nothing that I think should cause any problems. This is on the Big Sur system, but the Catalina system has a very similar configuration.



---

archive/issue_comments_472283.json:
```json
{
    "body": "<a id='comment:60'></a>It seems that we need to set `ARCHFLAGS=\"\"` in more situations. The default set by `/usr/bin/python3`, trying to build for both architectures, is unrealistic to support -- this would require major changes to how we install libraries.",
    "created_at": "2021-02-01T04:34:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472283",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:60'></a>It seems that we need to set `ARCHFLAGS=""` in more situations. The default set by `/usr/bin/python3`, trying to build for both architectures, is unrealistic to support -- this would require major changes to how we install libraries.



---

archive/issue_comments_472284.json:
```json
{
    "body": "<a id='comment:61'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-02-01T04:58:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472284",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:61'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_472285.json:
```json
{
    "body": "<a id='comment:62'></a>Here's a new version to try on big sur",
    "created_at": "2021-02-01T04:58:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472285",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:62'></a>Here's a new version to try on big sur



---

archive/issue_comments_472286.json:
```json
{
    "body": "<a id='comment:63'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-02-01T05:54:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472286",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:63'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_472287.json:
```json
{
    "body": "<a id='comment:64'></a>Started tests at https://github.com/mkoeppe/sage/actions/runs/526769308 but it looks like there is a long wait time to get macos instances",
    "created_at": "2021-02-01T05:56:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472287",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:64'></a>Started tests at https://github.com/mkoeppe/sage/actions/runs/526769308 but it looks like there is a long wait time to get macos instances



---

archive/issue_comments_472288.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,27 @@\n+(from #31132)\n+\n+#27122 determines whether CC accepts `-march=native` and then adds it globally to `CFLAGS` in `build/bin/sage-build-env`.\n+\n+#30725 fixes this for macOS, where some packages are explicitly built with `clang`.\n+\n+However, there is another mechanism how `clang` can come in: Python extension modules are compiled with the compiler listed in sysconfig. On macOS with homebrew, using `/usr/bin/python3`, this could again be `clang`, which does not accept `-march=native` in combination with `-arch arm64` (which is provided even on x86_64 if `ARCHFLAGS` is unset).\n+\n+In this ticket, we fix this by checking whether the compiler used by distutils accepts `-march=native` (or more generally, the flags determined earlier by `configure`). If it does not, then we disable the use of these flags.\n+\n+In order to test this with `/usr/bin/python3` from XCode 12.3 (on macOS 10.15 (Catalina)), we fix another issue:\n+This python3 (3.8.2) is not able to build extension modules because it emits `-arch arm64 -arch x86_64` unless `ARCHFLAGS` is set explicitly\n+\n+```\n+$ /usr/bin/python3 -m sysconfig |grep '\\bCFLAGS ='\n+\tCFLAGS = \"-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64\"\n+\n+$ ARCHFLAGS=\"\" /usr/bin/python3 -m sysconfig |grep '\\bCFLAGS ='\n+\tCFLAGS = \"-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers  -arch x86_64 \"\n+```\n+\n+In this ticket, if the distutils test fails, we try if setting `ARCHFLAGS=\"\"` fixes it. In that case, we store a configuration variable that causes `sage-env` to set `ARCHFLAGS` as well.\n+\n+ \n \n \n Comment: 1\n```\n",
    "created_at": "2021-02-01T05:57:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472288",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,27 @@
+(from #31132)
+
+#27122 determines whether CC accepts `-march=native` and then adds it globally to `CFLAGS` in `build/bin/sage-build-env`.
+
+#30725 fixes this for macOS, where some packages are explicitly built with `clang`.
+
+However, there is another mechanism how `clang` can come in: Python extension modules are compiled with the compiler listed in sysconfig. On macOS with homebrew, using `/usr/bin/python3`, this could again be `clang`, which does not accept `-march=native` in combination with `-arch arm64` (which is provided even on x86_64 if `ARCHFLAGS` is unset).
+
+In this ticket, we fix this by checking whether the compiler used by distutils accepts `-march=native` (or more generally, the flags determined earlier by `configure`). If it does not, then we disable the use of these flags.
+
+In order to test this with `/usr/bin/python3` from XCode 12.3 (on macOS 10.15 (Catalina)), we fix another issue:
+This python3 (3.8.2) is not able to build extension modules because it emits `-arch arm64 -arch x86_64` unless `ARCHFLAGS` is set explicitly
+
+```
+$ /usr/bin/python3 -m sysconfig |grep '\bCFLAGS ='
+	CFLAGS = "-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64"
+
+$ ARCHFLAGS="" /usr/bin/python3 -m sysconfig |grep '\bCFLAGS ='
+	CFLAGS = "-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers  -arch x86_64 "
+```
+
+In this ticket, if the distutils test fails, we try if setting `ARCHFLAGS=""` fixes it. In that case, we store a configuration variable that causes `sage-env` to set `ARCHFLAGS` as well.
+
+ 
 
 
 Comment: 1
```




---

archive/issue_comments_472289.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,30 @@\n+(from #31132)\n+\n+#27122 determines whether CC accepts `-march=native` and then adds it globally to `CFLAGS` in `build/bin/sage-build-env`.\n+\n+#30725 fixes this for macOS, where some packages are explicitly built with `clang`.\n+\n+However, there is another mechanism how `clang` can come in: Python extension modules are compiled with the compiler listed in sysconfig. On macOS with homebrew, using `/usr/bin/python3`, this could again be `clang`, which does not accept `-march=native` in combination with `-arch arm64` (which is provided even on x86_64 if `ARCHFLAGS` is unset).\n+\n+In this ticket, we fix this by checking whether the compiler used by distutils accepts `-march=native` (or more generally, the flags determined earlier by `configure`). If it does not, then we disable the use of these flags.\n+\n+In order to test this with `/usr/bin/python3` from XCode 12.3 (on macOS 10.15 (Catalina)), we fix another issue:\n+This python3 (3.8.2) is not able to build extension modules because it emits `-arch arm64 -arch x86_64` unless `ARCHFLAGS` is set explicitly\n+\n+```\n+$ /usr/bin/python3 -m sysconfig |grep '\\bCFLAGS ='\n+\tCFLAGS = \"-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64\"\n+\n+$ ARCHFLAGS=\"\" /usr/bin/python3 -m sysconfig |grep '\\bCFLAGS ='\n+\tCFLAGS = \"-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers  -arch x86_64 \"\n+```\n+\n+In this ticket, if the distutils test fails, we try if setting `ARCHFLAGS=\"\"` fixes it.  Also, after accepting a system python and `ARCHFLAGS` so far has not been set, we test whether the system python wants to do the multi-arch build.\n+\n+In either of these two cases, we store a configuration variable that causes `sage-env` to set `ARCHFLAGS` as well.\n+\n+This is somewhat complicated logic - we are tiptoeing around previous breakage that had been caused by setting `ARCHFLAGS` unconditionally (#29408).\n+\n \n \n Comment: 1\n```\n",
    "created_at": "2021-02-01T06:00:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472289",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,30 @@
+(from #31132)
+
+#27122 determines whether CC accepts `-march=native` and then adds it globally to `CFLAGS` in `build/bin/sage-build-env`.
+
+#30725 fixes this for macOS, where some packages are explicitly built with `clang`.
+
+However, there is another mechanism how `clang` can come in: Python extension modules are compiled with the compiler listed in sysconfig. On macOS with homebrew, using `/usr/bin/python3`, this could again be `clang`, which does not accept `-march=native` in combination with `-arch arm64` (which is provided even on x86_64 if `ARCHFLAGS` is unset).
+
+In this ticket, we fix this by checking whether the compiler used by distutils accepts `-march=native` (or more generally, the flags determined earlier by `configure`). If it does not, then we disable the use of these flags.
+
+In order to test this with `/usr/bin/python3` from XCode 12.3 (on macOS 10.15 (Catalina)), we fix another issue:
+This python3 (3.8.2) is not able to build extension modules because it emits `-arch arm64 -arch x86_64` unless `ARCHFLAGS` is set explicitly
+
+```
+$ /usr/bin/python3 -m sysconfig |grep '\bCFLAGS ='
+	CFLAGS = "-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64"
+
+$ ARCHFLAGS="" /usr/bin/python3 -m sysconfig |grep '\bCFLAGS ='
+	CFLAGS = "-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers  -arch x86_64 "
+```
+
+In this ticket, if the distutils test fails, we try if setting `ARCHFLAGS=""` fixes it.  Also, after accepting a system python and `ARCHFLAGS` so far has not been set, we test whether the system python wants to do the multi-arch build.
+
+In either of these two cases, we store a configuration variable that causes `sage-env` to set `ARCHFLAGS` as well.
+
+This is somewhat complicated logic - we are tiptoeing around previous breakage that had been caused by setting `ARCHFLAGS` unconditionally (#29408).
+
 
 
 Comment: 1
```




---

archive/issue_comments_472290.json:
```json
{
    "body": "<a id='comment:68'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-02-01T18:21:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472290",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:68'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_472291.json:
```json
{
    "body": "<a id='comment:69'></a>For the record, I was able to successfully build sage and documentation with this ticket on Big Sur using \n\n--with-python=/usr/bin/python3",
    "created_at": "2021-02-01T18:30:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472291",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:69'></a>For the record, I was able to successfully build sage and documentation with this ticket on Big Sur using 

--with-python=/usr/bin/python3



---

archive/issue_comments_472292.json:
```json
{
    "body": "<a id='comment:70'></a>Thanks for testing!",
    "created_at": "2021-02-01T18:31:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472292",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:70'></a>Thanks for testing!



---

archive/issue_comments_472293.json:
```json
{
    "body": "<a id='comment:71'></a>Works for me with the system Python 3 on both Big Sur and Catalina.",
    "created_at": "2021-02-01T21:36:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472293",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:71'></a>Works for me with the system Python 3 on both Big Sur and Catalina.



---

archive/issue_comments_472294.json:
```json
{
    "body": "<a id='comment:72'></a>Thanks for testing! \n\nLet's deal with issue #31314 (messages from `find_stale_files`) in a follow up.\n\nReady for review?",
    "created_at": "2021-02-01T23:12:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472294",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:72'></a>Thanks for testing! 

Let's deal with issue #31314 (messages from `find_stale_files`) in a follow up.

Ready for review?



---

archive/issue_comments_472295.json:
```json
{
    "body": "<a id='comment:73'></a>Replying to [comment:64 mkoeppe]:\n> Started tests at https://github.com/mkoeppe/sage/actions/runs/526769308 but it looks like there is a long wait time to get macos instances\n\n\nSome results have been coming in:\n\n- `local-homebrew-macos-10.15-xcode-11.7-{minimal,standard}`: clean\n- `local-homebrew-macos-11.0-xcode-11.7-{minimal,standard}`: Homebrew complains that xcode is too old\n\nStill waiting for the tests with other xcode versions (12.2, 12.3, 12.4). No failures so far.\n\nNote all runs are on `x86_64` - we do not have test infrastructor for `macos-arm64` yet.",
    "created_at": "2021-02-02T01:58:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472295",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:73'></a>Replying to [comment:64 mkoeppe]:
> Started tests at https://github.com/mkoeppe/sage/actions/runs/526769308 but it looks like there is a long wait time to get macos instances


Some results have been coming in:

- `local-homebrew-macos-10.15-xcode-11.7-{minimal,standard}`: clean
- `local-homebrew-macos-11.0-xcode-11.7-{minimal,standard}`: Homebrew complains that xcode is too old

Still waiting for the tests with other xcode versions (12.2, 12.3, 12.4). No failures so far.

Note all runs are on `x86_64` - we do not have test infrastructor for `macos-arm64` yet.



---

archive/issue_comments_472296.json:
```json
{
    "body": "<a id='comment:74'></a>I'm happy with this ticket, but I would like another opinion on this.",
    "created_at": "2021-02-02T09:17:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472296",
    "user": "https://github.com/kliem"
}
```

<a id='comment:74'></a>I'm happy with this ticket, but I would like another opinion on this.



---

archive/issue_comments_472297.json:
```json
{
    "body": "<a id='comment:75'></a>Ok, I give it another 24 hours. If nobody speaks up, I'll give a positive review (after taking a final look of course).",
    "created_at": "2021-02-02T16:45:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472297",
    "user": "https://github.com/kliem"
}
```

<a id='comment:75'></a>Ok, I give it another 24 hours. If nobody speaks up, I'll give a positive review (after taking a final look of course).



---

archive/issue_comments_472298.json:
```json
{
    "body": "<a id='comment:76'></a>I don't feel like I have enough experience to review this, but it certainly built on Big Sur and Catalina.  I'm going to upgrade Big Sur to 11.2 later and see if this builds on 11.2 as well.",
    "created_at": "2021-02-02T17:03:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472298",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:76'></a>I don't feel like I have enough experience to review this, but it certainly built on Big Sur and Catalina.  I'm going to upgrade Big Sur to 11.2 later and see if this builds on 11.2 as well.



---

archive/issue_comments_472299.json:
```json
{
    "body": "<a id='comment:77'></a>Replying to [comment:64 mkoeppe]:\n> Started tests at https://github.com/mkoeppe/sage/actions/runs/526769308 but it looks like there is a long wait time to get macos instances\n\n\nSome more results:\n- `local-homebrew-macos-10.15-xcode-{12.2,12.3,12.4}-{minimal,standard}`: clean except for doctest errors from `ld: warning` (#31204)\n- `local-homebrew-macos-11.0-xcode-{12.2,12.3}-minimal`: `scipy` build fails (https://github.com/mkoeppe/sage/runs/1804239019?check_suite_focus=true)\n- `local-homebrew-macos-11.0-xcode-12.3-standard`: clean except for doctest errors from `ld: warning` (#31204)",
    "created_at": "2021-02-02T17:28:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472299",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:77'></a>Replying to [comment:64 mkoeppe]:
> Started tests at https://github.com/mkoeppe/sage/actions/runs/526769308 but it looks like there is a long wait time to get macos instances


Some more results:
- `local-homebrew-macos-10.15-xcode-{12.2,12.3,12.4}-{minimal,standard}`: clean except for doctest errors from `ld: warning` (#31204)
- `local-homebrew-macos-11.0-xcode-{12.2,12.3}-minimal`: `scipy` build fails (https://github.com/mkoeppe/sage/runs/1804239019?check_suite_focus=true)
- `local-homebrew-macos-11.0-xcode-12.3-standard`: clean except for doctest errors from `ld: warning` (#31204)



---

archive/issue_comments_472300.json:
```json
{
    "body": "<a id='comment:78'></a>Let's take care of the `scipy` build failures in #31326.\n\nI think this is sufficient improvement for one ticket.",
    "created_at": "2021-02-02T17:33:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472300",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:78'></a>Let's take care of the `scipy` build failures in #31326.

I think this is sufficient improvement for one ticket.



---

archive/issue_comments_472301.json:
```json
{
    "body": "<a id='comment:80'></a>Seems to work well on Big Sur 11.2 with standard homebrew packages.  When running make ptest I get the annoying warnings:\n\nld: warning: dylib (/usr/local/lib/libgmp.dylib) was built for newer macOS version (10.15) than being linked (10.14.6)\n\nwhich is probably because the MACOSX_DEPLOYMENT_TARGET for /usr/bin/python3 is set to 10.14.6 which doesn't match what Homebrew sets. It's easy enough to eliminate the warnings by setting MACOSX_DEPLOYMENT_TARGET=11.0 before doing all the testing.\n\nOtherwise, everything seems to build/test correctly.",
    "created_at": "2021-02-03T01:04:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472301",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:80'></a>Seems to work well on Big Sur 11.2 with standard homebrew packages.  When running make ptest I get the annoying warnings:

ld: warning: dylib (/usr/local/lib/libgmp.dylib) was built for newer macOS version (10.15) than being linked (10.14.6)

which is probably because the MACOSX_DEPLOYMENT_TARGET for /usr/bin/python3 is set to 10.14.6 which doesn't match what Homebrew sets. It's easy enough to eliminate the warnings by setting MACOSX_DEPLOYMENT_TARGET=11.0 before doing all the testing.

Otherwise, everything seems to build/test correctly.



---

archive/issue_comments_472302.json:
```json
{
    "body": "<a id='comment:81'></a>Ok. Thanks for fixing all of this. I think the ticket is a good improvement as it is.",
    "created_at": "2021-02-03T19:02:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472302",
    "user": "https://github.com/kliem"
}
```

<a id='comment:81'></a>Ok. Thanks for fixing all of this. I think the ticket is a good improvement as it is.



---

archive/issue_comments_472303.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-02-03T19:02:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472303",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_472304.json:
```json
{
    "body": "<a id='comment:82'></a>Thanks!",
    "created_at": "2021-02-03T19:21:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472304",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:82'></a>Thanks!



---

archive/issue_events_081629.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-02-20T10:46:52Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31227#event-81629"
}
```



---

archive/issue_comments_472305.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-02-20T10:46:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31227#issuecomment-472305",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
