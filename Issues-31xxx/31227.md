# Issue 31227: Accept /usr/bin/python3 from XCode 12.3 on macOS 10.15 (Catalina) and 11 (Big Sur)

archive/issues_030990.json:
```json
{
    "assignees": [],
    "body": "(from #31132)\n\n#27122 determines whether CC accepts `-march=native` and then adds it globally to `CFLAGS` in `build/bin/sage-build-env`.\n\n#30725 fixes this for macOS, where some packages are explicitly built with `clang`.\n\nHowever, there is another mechanism how `clang` can come in: Python extension modules are compiled with the compiler listed in sysconfig. On macOS with homebrew, using `/usr/bin/python3`, this could again be `clang`, which does not accept `-march=native` in combination with `-arch arm64` (which is provided even on x86_64 if `ARCHFLAGS` is unset).\n\nIn this ticket, we fix this by checking whether the compiler used by distutils accepts `-march=native` (or more generally, the flags determined earlier by `configure`). If it does not, then we disable the use of these flags.\n\nIn order to test this with `/usr/bin/python3` from XCode 12.3 (on macOS 10.15 (Catalina)), we fix another issue:\nThis python3 (3.8.2) is not able to build extension modules because it emits `-arch arm64 -arch x86_64` unless `ARCHFLAGS` is set explicitly\n\n```\n$ /usr/bin/python3 -m sysconfig |grep '\\bCFLAGS ='\n\tCFLAGS = \"-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64\"\n\n$ ARCHFLAGS=\"\" /usr/bin/python3 -m sysconfig |grep '\\bCFLAGS ='\n\tCFLAGS = \"-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers  -arch x86_64 \"\n```\n\nIn this ticket, if the distutils test fails, we try if setting `ARCHFLAGS=\"\"` fixes it.  Also, after accepting a system python and `ARCHFLAGS` so far has not been set, we test whether the system python wants to do the multi-arch build.\n\nIn either of these two cases, we store a configuration variable that causes `sage-env` to set `ARCHFLAGS` as well.\n\nThis is somewhat complicated logic - we are tiptoeing around previous breakage that had been caused by setting `ARCHFLAGS` unconditionally (#29408).\n\n\n\nDepends on #31132\n\nDepends on #30725\n\n**CC:**  @jhpalmieri @zlscherr @dimpase @kliem @vbraun\n\n**Branch/Commit:** [fc8b67644bada9ea52cbb7c91f53f763ca84f4bb](https://github.com/sagemath/sagetrac-mirror/commit/fc8b67644bada9ea52cbb7c91f53f763ca84f4bb)\n\n**Reviewer:** Jonathan Kliem\n\n**Author:** Matthias Koeppe\n\nIssue created by migration from https://trac.sagemath.org/ticket/31227\n\n",
    "closed_at": "2021-02-20T10:46:52Z",
    "created_at": "2021-01-13T01:31:23Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20build%3A%20configure",
        "https://github.com/sagemath/sage/labels/blocker",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.3",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Accept /usr/bin/python3 from XCode 12.3 on macOS 10.15 (Catalina) and 11 (Big Sur)",
    "type": "issue",
    "updated_at": "2021-02-20T10:46:52Z",
    "url": "https://github.com/sagemath/sage/issues/31227",
    "user": "https://github.com/mkoeppe"
}
```
(from #31132)

#27122 determines whether CC accepts `-march=native` and then adds it globally to `CFLAGS` in `build/bin/sage-build-env`.

#30725 fixes this for macOS, where some packages are explicitly built with `clang`.

However, there is another mechanism how `clang` can come in: Python extension modules are compiled with the compiler listed in sysconfig. On macOS with homebrew, using `/usr/bin/python3`, this could again be `clang`, which does not accept `-march=native` in combination with `-arch arm64` (which is provided even on x86_64 if `ARCHFLAGS` is unset).

In this ticket, we fix this by checking whether the compiler used by distutils accepts `-march=native` (or more generally, the flags determined earlier by `configure`). If it does not, then we disable the use of these flags.

In order to test this with `/usr/bin/python3` from XCode 12.3 (on macOS 10.15 (Catalina)), we fix another issue:
This python3 (3.8.2) is not able to build extension modules because it emits `-arch arm64 -arch x86_64` unless `ARCHFLAGS` is set explicitly

```
$ /usr/bin/python3 -m sysconfig |grep '\bCFLAGS ='
	CFLAGS = "-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64"

$ ARCHFLAGS="" /usr/bin/python3 -m sysconfig |grep '\bCFLAGS ='
	CFLAGS = "-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers  -arch x86_64 "
```

In this ticket, if the distutils test fails, we try if setting `ARCHFLAGS=""` fixes it.  Also, after accepting a system python and `ARCHFLAGS` so far has not been set, we test whether the system python wants to do the multi-arch build.

In either of these two cases, we store a configuration variable that causes `sage-env` to set `ARCHFLAGS` as well.

This is somewhat complicated logic - we are tiptoeing around previous breakage that had been caused by setting `ARCHFLAGS` unconditionally (#29408).



Depends on #31132

Depends on #30725

**CC:**  @jhpalmieri @zlscherr @dimpase @kliem @vbraun

**Branch/Commit:** [fc8b67644bada9ea52cbb7c91f53f763ca84f4bb](https://github.com/sagemath/sagetrac-mirror/commit/fc8b67644bada9ea52cbb7c91f53f763ca84f4bb)

**Reviewer:** Jonathan Kliem

**Author:** Matthias Koeppe

Issue created by migration from https://trac.sagemath.org/ticket/31227





---

archive/issue_events_378555.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-01-13T01:31:23Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31227#event-378555"
}
```



---

archive/issue_events_378556.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-01-13T01:31:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20build%3A%20configure",
    "label_color": "08517b",
    "label_name": "component: build: configure",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31227#event-378556"
}
```



---

archive/issue_events_378557.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-01-13T01:31:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "008080",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31227#event-378557"
}
```



---

archive/issue_comments_503076.json:
```json
{
    "body": "**Dependencies:** #31132",
    "created_at": "2021-01-13T01:54:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503076",
    "user": "https://github.com/mkoeppe"
}
```

**Dependencies:** #31132



---

archive/issue_comments_503077.json:
```json
{
    "body": "**Branch:** [u/mkoeppe/accept__usr_bin_python3_from_xcode_12_3_on_macos_10_15__catalina_](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/accept__usr_bin_python3_from_xcode_12_3_on_macos_10_15__catalina_)",
    "created_at": "2021-01-13T01:56:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503077",
    "user": "https://github.com/mkoeppe"
}
```

**Branch:** [u/mkoeppe/accept__usr_bin_python3_from_xcode_12_3_on_macos_10_15__catalina_](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/accept__usr_bin_python3_from_xcode_12_3_on_macos_10_15__catalina_)



---

archive/issue_comments_503078.json:
```json
{
    "body": "<a id='comment:3'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2c6002555d21e242ab5d1e25e4d1f3851e246532\">2c60025</a></td><td><code>m4/sage_check_python_for_venv.m4: Warn if python3 is misconfigured like it is currently in homebrew</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ee679bd57302d8e422e76b422d73f83ab87a4293\">ee679bd</a></td><td><code>build/pkgs/python3/spkg-configure.m4: Do not check sysconfig CPPFLAGS so that /usr/bin/python3 is accepted on macOS; reject broken homebrew python3 unless requested explicitly with configgure --with-python=...</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/29aee87fc01f6fce3cc4356c98f27c44e4ce2b5b\">29aee87</a></td><td><code>build/pkgs/python3: Update to 3.9.0rc2</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e61d464292262d80c43895c64fce4f48a6895822\">e61d464</a></td><td><code>build/pkgs/python3: Update to 3.9.0</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f8bb56d16600c8cfe1bab1d127f3931ca280dff0\">f8bb56d</a></td><td><code>build/pkgs/python3: Update to 3.9.1</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0e3513fcb3e2efa1832db8bd7957a93ad75b215c\">0e3513f</a></td><td><code>build/pkgs/pip: Update to 20.3.3</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/41d7e7a74441e5f9deb3e7a93adfccf486dde417\">41d7e7a</a></td><td><code>Merge branch 'u/jhpalmieri/new_wheel' of git://trac.sagemath.org/sage into t/30589/upgrade-python-3.9</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/76d5fd15f9bcc50a478471182f70ba8d46bf4319\">76d5fd1</a></td><td><code>Merge branch 't/30589/upgrade-python-3.9' into t/31132/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_build_when_using_homebrew_s_python3</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ce3481061b6308e730004ed461f8a86341249db1\">ce34810</a></td><td><code>m4/sage_check_python_for_venv.m4: Use empty ARCHFLAGS while testing distutils</code></td></tr></table>\n",
    "created_at": "2021-01-14T04:18:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503078",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2c6002555d21e242ab5d1e25e4d1f3851e246532">2c60025</a></td><td><code>m4/sage_check_python_for_venv.m4: Warn if python3 is misconfigured like it is currently in homebrew</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ee679bd57302d8e422e76b422d73f83ab87a4293">ee679bd</a></td><td><code>build/pkgs/python3/spkg-configure.m4: Do not check sysconfig CPPFLAGS so that /usr/bin/python3 is accepted on macOS; reject broken homebrew python3 unless requested explicitly with configgure --with-python=...</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/29aee87fc01f6fce3cc4356c98f27c44e4ce2b5b">29aee87</a></td><td><code>build/pkgs/python3: Update to 3.9.0rc2</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e61d464292262d80c43895c64fce4f48a6895822">e61d464</a></td><td><code>build/pkgs/python3: Update to 3.9.0</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f8bb56d16600c8cfe1bab1d127f3931ca280dff0">f8bb56d</a></td><td><code>build/pkgs/python3: Update to 3.9.1</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0e3513fcb3e2efa1832db8bd7957a93ad75b215c">0e3513f</a></td><td><code>build/pkgs/pip: Update to 20.3.3</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/41d7e7a74441e5f9deb3e7a93adfccf486dde417">41d7e7a</a></td><td><code>Merge branch 'u/jhpalmieri/new_wheel' of git://trac.sagemath.org/sage into t/30589/upgrade-python-3.9</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/76d5fd15f9bcc50a478471182f70ba8d46bf4319">76d5fd1</a></td><td><code>Merge branch 't/30589/upgrade-python-3.9' into t/31132/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_build_when_using_homebrew_s_python3</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ce3481061b6308e730004ed461f8a86341249db1">ce34810</a></td><td><code>m4/sage_check_python_for_venv.m4: Use empty ARCHFLAGS while testing distutils</code></td></tr></table>




---

archive/issue_comments_503079.json:
```json
{
    "body": "**Changing dependencies** from \"#31132\" to \"#31132, #31228\".",
    "created_at": "2021-01-14T04:18:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503079",
    "user": "https://github.com/mkoeppe"
}
```

**Changing dependencies** from "#31132" to "#31132, #31228".



---

archive/issue_comments_503080.json:
```json
{
    "body": "**Commit:** [ce3481061b6308e730004ed461f8a86341249db1](https://github.com/sagemath/sagetrac-mirror/commit/ce3481061b6308e730004ed461f8a86341249db1)",
    "created_at": "2021-01-14T04:18:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503080",
    "user": "https://github.com/mkoeppe"
}
```

**Commit:** [ce3481061b6308e730004ed461f8a86341249db1](https://github.com/sagemath/sagetrac-mirror/commit/ce3481061b6308e730004ed461f8a86341249db1)



---

archive/issue_comments_503081.json:
```json
{
    "body": "<a id='comment:4'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **Last 10 new commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1b16a8c4884fd6eb464b94121b29990b0cc4dff8\">1b16a8c</a></td><td><code>build/pkgs/pari/spkg-install.in: Do not recompute MACOSX_VERSION</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c6e30eab754c20f53ceef40508a223c590f06cb1\">c6e30ea</a></td><td><code>tox.ini: Add configuration factors gcc_10, gcc_11</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9b0eb15897bbde3ad5e440b26d714f637516e91d\">9b0eb15</a></td><td><code>build/pkgs/{cmake,curl,psutil,python3,r}: If setting CC=clang, also set CFLAGS</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/05985d85d6f1e0d570ed3882b1f5ccf019e28673\">05985d8</a></td><td><code>Merge branch 't/30725/macos__spkg_install__remove_outdated__building_with_clang__code___which_conflicts_with___march_native_' into t/31228/the___march_native__flag_vs__the_compiler_used_when_python_extensions_are_built</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/02c268457164b76ddd97bece691111725dddf6c0\">02c2684</a></td><td><code>R is already compiled without -march=native</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/24b4fcca7179e0b857d3599d7ccf086e37c1d464\">24b4fcc</a></td><td><code>set EXTRACFLAGS instead of CFLAGS</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/44be9671b85348db09046fa0c720812bfe7393a1\">44be967</a></td><td><code>make code a bit more stable against future changes</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f56e65e25f23e69aee0d37080c046d36d7f349ed\">f56e65e</a></td><td><code>fix CFLAGS for python3/spkg-build.in by running testcflags.sh after determination of the compiler</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/09b03d2dbf209d705cb882edd5987d9096cb80ef\">09b03d2</a></td><td><code>Merge branch 'u/gh-kliem/macos__spkg_install__remove_outdated__building_with_clang__code___which_conflicts_with___march_native_' of git://trac.sagemath.org/sage into t/31228/the___march_native__flag_vs__the_compiler_used_when_python_extensions_are_built</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/67d66b74baa03829defe3f0721e79d8603ce34d8\">67d66b7</a></td><td><code>Merge branch 't/31228/the___march_native__flag_vs__the_compiler_used_when_python_extensions_are_built' into t/31227/accept__usr_bin_python3_from_xcode_12_3_on_macos_10_15__catalina_</code></td></tr></table>\n",
    "created_at": "2021-01-23T20:22:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503081",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:4'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **Last 10 new commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1b16a8c4884fd6eb464b94121b29990b0cc4dff8">1b16a8c</a></td><td><code>build/pkgs/pari/spkg-install.in: Do not recompute MACOSX_VERSION</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c6e30eab754c20f53ceef40508a223c590f06cb1">c6e30ea</a></td><td><code>tox.ini: Add configuration factors gcc_10, gcc_11</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9b0eb15897bbde3ad5e440b26d714f637516e91d">9b0eb15</a></td><td><code>build/pkgs/{cmake,curl,psutil,python3,r}: If setting CC=clang, also set CFLAGS</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/05985d85d6f1e0d570ed3882b1f5ccf019e28673">05985d8</a></td><td><code>Merge branch 't/30725/macos__spkg_install__remove_outdated__building_with_clang__code___which_conflicts_with___march_native_' into t/31228/the___march_native__flag_vs__the_compiler_used_when_python_extensions_are_built</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/02c268457164b76ddd97bece691111725dddf6c0">02c2684</a></td><td><code>R is already compiled without -march=native</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/24b4fcca7179e0b857d3599d7ccf086e37c1d464">24b4fcc</a></td><td><code>set EXTRACFLAGS instead of CFLAGS</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/44be9671b85348db09046fa0c720812bfe7393a1">44be967</a></td><td><code>make code a bit more stable against future changes</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f56e65e25f23e69aee0d37080c046d36d7f349ed">f56e65e</a></td><td><code>fix CFLAGS for python3/spkg-build.in by running testcflags.sh after determination of the compiler</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/09b03d2dbf209d705cb882edd5987d9096cb80ef">09b03d2</a></td><td><code>Merge branch 'u/gh-kliem/macos__spkg_install__remove_outdated__building_with_clang__code___which_conflicts_with___march_native_' of git://trac.sagemath.org/sage into t/31228/the___march_native__flag_vs__the_compiler_used_when_python_extensions_are_built</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/67d66b74baa03829defe3f0721e79d8603ce34d8">67d66b7</a></td><td><code>Merge branch 't/31228/the___march_native__flag_vs__the_compiler_used_when_python_extensions_are_built' into t/31227/accept__usr_bin_python3_from_xcode_12_3_on_macos_10_15__catalina_</code></td></tr></table>




---

archive/issue_comments_503082.json:
```json
{
    "body": "**Changing commit** from \"[ce3481061b6308e730004ed461f8a86341249db1](https://github.com/sagemath/sagetrac-mirror/commit/ce3481061b6308e730004ed461f8a86341249db1)\" to \"[67d66b74baa03829defe3f0721e79d8603ce34d8](https://github.com/sagemath/sagetrac-mirror/commit/67d66b74baa03829defe3f0721e79d8603ce34d8)\".",
    "created_at": "2021-01-23T20:22:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503082",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[ce3481061b6308e730004ed461f8a86341249db1](https://github.com/sagemath/sagetrac-mirror/commit/ce3481061b6308e730004ed461f8a86341249db1)" to "[67d66b74baa03829defe3f0721e79d8603ce34d8](https://github.com/sagemath/sagetrac-mirror/commit/67d66b74baa03829defe3f0721e79d8603ce34d8)".



---

archive/issue_comments_503083.json:
```json
{
    "body": "**Changing dependencies** from \"#31132, #31228\" to \"#31132, #30725, #31228\".",
    "created_at": "2021-01-23T20:23:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503083",
    "user": "https://github.com/mkoeppe"
}
```

**Changing dependencies** from "#31132, #31228" to "#31132, #30725, #31228".



---

archive/issue_comments_503084.json:
```json
{
    "body": "<a id='comment:7'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3325a4e4cef11e7b2f9946fd0db143f1c0157af3\">3325a4e</a></td><td><code>build/pkgs/python3/spkg-configure.m4: Actually test with CFLAGS=$CFLAGS_MARCH</code></td></tr></table>\n",
    "created_at": "2021-01-23T20:27:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503084",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:7'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3325a4e4cef11e7b2f9946fd0db143f1c0157af3">3325a4e</a></td><td><code>build/pkgs/python3/spkg-configure.m4: Actually test with CFLAGS=$CFLAGS_MARCH</code></td></tr></table>




---

archive/issue_comments_503085.json:
```json
{
    "body": "**Changing commit** from \"[67d66b74baa03829defe3f0721e79d8603ce34d8](https://github.com/sagemath/sagetrac-mirror/commit/67d66b74baa03829defe3f0721e79d8603ce34d8)\" to \"[3325a4e4cef11e7b2f9946fd0db143f1c0157af3](https://github.com/sagemath/sagetrac-mirror/commit/3325a4e4cef11e7b2f9946fd0db143f1c0157af3)\".",
    "created_at": "2021-01-23T20:27:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503085",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[67d66b74baa03829defe3f0721e79d8603ce34d8](https://github.com/sagemath/sagetrac-mirror/commit/67d66b74baa03829defe3f0721e79d8603ce34d8)" to "[3325a4e4cef11e7b2f9946fd0db143f1c0157af3](https://github.com/sagemath/sagetrac-mirror/commit/3325a4e4cef11e7b2f9946fd0db143f1c0157af3)".



---

archive/issue_events_378558.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-01-23T20:30:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31227#event-378558"
}
```



---

archive/issue_comments_503086.json:
```json
{
    "body": "<a id='comment:8'></a>\nThis is the branch that I had. I won't have time to work on it over the next week.",
    "created_at": "2021-01-23T20:30:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503086",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>
This is the branch that I had. I won't have time to work on it over the next week.



---

archive/issue_comments_503087.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -10,5 +10,6 @@\n egret:~/s/sage/sage-rebasing/worktree-algebraic-2018-spring (t/31132/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_build_when_using_homebrew_s_python3 *\n ```\n \n-In this ticket, we set `ARCHFLAGS` during this configure step... \n+In this ticket, we set `ARCHFLAGS` during this configure step.\n+ \n \n``````\n",
    "created_at": "2021-01-23T20:30:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503087",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -10,5 +10,6 @@
 egret:~/s/sage/sage-rebasing/worktree-algebraic-2018-spring (t/31132/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_build_when_using_homebrew_s_python3 *
 ```
 
-In this ticket, we set `ARCHFLAGS` during this configure step... 
+In this ticket, we set `ARCHFLAGS` during this configure step.
+ 
 
``````




---

archive/issue_comments_503088.json:
```json
{
    "body": "**Author:** Matthias Koeppe",
    "created_at": "2021-01-23T20:30:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503088",
    "user": "https://github.com/mkoeppe"
}
```

**Author:** Matthias Koeppe



---

archive/issue_comments_503089.json:
```json
{
    "body": "<a id='comment:9'></a>\nIt was proposed to mark #31228 as invalid and do it all here. In this case (and it is in fact already done here).\n\nIn this case, this ticket here is really ready for review (and the depency of #31228 could be removed).",
    "created_at": "2021-01-25T06:55:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503089",
    "user": "https://github.com/kliem"
}
```

<a id='comment:9'></a>
It was proposed to mark #31228 as invalid and do it all here. In this case (and it is in fact already done here).

In this case, this ticket here is really ready for review (and the depency of #31228 could be removed).



---

archive/issue_comments_503090.json:
```json
{
    "body": "**Reviewer:** https://github.com/kliem/sage/pull/36/checks, Jonathan Kliem",
    "created_at": "2021-01-25T07:04:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503090",
    "user": "https://github.com/kliem"
}
```

**Reviewer:** https://github.com/kliem/sage/pull/36/checks, Jonathan Kliem



---

archive/issue_comments_503091.json:
```json
{
    "body": "<a id='comment:10'></a>\nI'm happy with this ticket, but I will have to wait and see if things work out in practice.",
    "created_at": "2021-01-25T07:04:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503091",
    "user": "https://github.com/kliem"
}
```

<a id='comment:10'></a>
I'm happy with this ticket, but I will have to wait and see if things work out in practice.



---

archive/issue_events_378559.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-01-25T19:22:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "label": "https://github.com/sagemath/sage/labels/blocker",
    "label_color": "ff0000",
    "label_name": "blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31227#event-378559"
}
```



---

archive/issue_comments_503092.json:
```json
{
    "body": "**Changing dependencies** from \"#31132, #30725, #31228\" to \"#31132, #30725\".",
    "created_at": "2021-01-25T19:31:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503092",
    "user": "https://github.com/mkoeppe"
}
```

**Changing dependencies** from "#31132, #30725, #31228" to "#31132, #30725".



---

archive/issue_comments_503093.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,5 +1,14 @@\n (from #31132)\n \n+#27122 determines whether CC accepts `-march=native` and then adds it globally to `CFLAGS` in `build/bin/sage-build-env`.\n+\n+#30725 fixes this for macOS, where some packages are explicitly built with `clang`.\n+\n+However, there is another mechanism how `clang` can come in: Python extension modules are compiled with the compiler listed in sysconfig. On macOS with homebrew, using `/usr/bin/python3`, this could again be `clang`, which does not accept `-march=native`.\n+\n+In this ticket, we fix this by checking whether the compiler used by distutils accepts `-march=native` (or more generally, the flags determined earlier by `configure`). If it does not, then we disable the use of these flags.\n+\n+In order to test this with `/usr/bin/python3` from XCode 12.3 (on macOS 10.15 (Catalina)), we fix another issue:\n This python3 (3.8.2) is not able to build extension modules because it emits `-arch arm64 -arch x86_64` unless `ARCHFLAGS` is set explicitly\n \n ```\n``````\n",
    "created_at": "2021-01-25T19:31:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503093",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,5 +1,14 @@
 (from #31132)
 
+#27122 determines whether CC accepts `-march=native` and then adds it globally to `CFLAGS` in `build/bin/sage-build-env`.
+
+#30725 fixes this for macOS, where some packages are explicitly built with `clang`.
+
+However, there is another mechanism how `clang` can come in: Python extension modules are compiled with the compiler listed in sysconfig. On macOS with homebrew, using `/usr/bin/python3`, this could again be `clang`, which does not accept `-march=native`.
+
+In this ticket, we fix this by checking whether the compiler used by distutils accepts `-march=native` (or more generally, the flags determined earlier by `configure`). If it does not, then we disable the use of these flags.
+
+In order to test this with `/usr/bin/python3` from XCode 12.3 (on macOS 10.15 (Catalina)), we fix another issue:
 This python3 (3.8.2) is not able to build extension modules because it emits `-arch arm64 -arch x86_64` unless `ARCHFLAGS` is set explicitly
 
 ```
``````




---

archive/issue_comments_503094.json:
```json
{
    "body": "<a id='comment:13'></a>\nWith this branch, `./configure --with-python=/usr/bin/python3` fails for me on OS X Catalina with Xcode 12.3. See attached `config.log`.",
    "created_at": "2021-01-25T23:23:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503094",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:13'></a>
With this branch, `./configure --with-python=/usr/bin/python3` fails for me on OS X Catalina with Xcode 12.3. See attached `config.log`.



---

archive/issue_comments_503095.json:
```json
{
    "body": "<a id='comment:14'></a>\nDid you run `bootstrap`?",
    "created_at": "2021-01-26T04:34:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503095",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:14'></a>
Did you run `bootstrap`?



---

archive/issue_comments_503096.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [@mkoeppe](#comment%3A14):\n> Did you run `bootstrap`?\n\nNo, sorry for the false report. Having run `./bootstrap`, and with `local/bin/python3` a symlink pointing to `/Applications/Xcode.app/Contents/Developer/usr/bin/python3`, the build has now failed twice: `Pillow` and `cython` have both failed to build.",
    "created_at": "2021-01-26T22:57:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503096",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:15'></a>
Replying to [@mkoeppe](#comment%3A14):
> Did you run `bootstrap`?

No, sorry for the false report. Having run `./bootstrap`, and with `local/bin/python3` a symlink pointing to `/Applications/Xcode.app/Contents/Developer/usr/bin/python3`, the build has now failed twice: `Pillow` and `cython` have both failed to build.



---

archive/issue_comments_503097.json:
```json
{
    "body": "**Attachment:** [pillow-8.0.1.log](https://github.com/sagemath/sage/files/ticket31227/pillow-8.0.1.log)",
    "created_at": "2021-01-26T22:58:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503097",
    "user": "https://github.com/jhpalmieri"
}
```

**Attachment:** [pillow-8.0.1.log](https://github.com/sagemath/sage/files/ticket31227/pillow-8.0.1.log)



---

archive/issue_comments_503098.json:
```json
{
    "body": "<a id='comment:16'></a>\n**Attachment:** [cython-0.29.21.log](https://github.com/sagemath/sage/files/ticket31227/cython-0.29.21.log)\n\nOh, and `gmpy2`, also.",
    "created_at": "2021-01-26T23:03:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503098",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:16'></a>
**Attachment:** [cython-0.29.21.log](https://github.com/sagemath/sage/files/ticket31227/cython-0.29.21.log)

Oh, and `gmpy2`, also.



---

archive/issue_comments_503099.json:
```json
{
    "body": "**Attachment:** [gmpy2-2.1.0b5.log](https://github.com/sagemath/sage/files/ticket31227/gmpy2-2.1.0b5.log)",
    "created_at": "2021-01-26T23:03:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503099",
    "user": "https://github.com/jhpalmieri"
}
```

**Attachment:** [gmpy2-2.1.0b5.log](https://github.com/sagemath/sage/files/ticket31227/gmpy2-2.1.0b5.log)



---

archive/issue_comments_503100.json:
```json
{
    "body": "<a id='comment:17'></a>\nOK, looks like we have to set `ARCHFLAGS=\"\"` in more places. But this needs to be done very carefully - see #29408",
    "created_at": "2021-01-26T23:44:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503100",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'></a>
OK, looks like we have to set `ARCHFLAGS=""` in more places. But this needs to be done very carefully - see #29408



---

archive/issue_comments_503101.json:
```json
{
    "body": "<a id='comment:18'></a>\nI ran `make -k` to get a fuller report, and it ended with:\n\n```\n* package:         gmpy2-2.1.0b5\n  last build time: Jan 26 15:52\n  log file:        /Users/jpalmier/Desktop/Sage/git/sage/logs/pkgs/gmpy2-2.1.0b5.log\n  build directory: /Users/jpalmier/Desktop/Sage/git/sage/local/var/tmp/sage/build/gmpy2-2.1.0b5\n\n* package:         cython-0.29.21\n  last build time: Jan 26 15:52\n  log file:        /Users/jpalmier/Desktop/Sage/git/sage/logs/pkgs/cython-0.29.21.log\n  build directory: /Users/jpalmier/Desktop/Sage/git/sage/local/var/tmp/sage/build/cython-0.29.21\n\n* package:         psutil-5.2.0.p2\n  last build time: Jan 26 15:52\n  log file:        /Users/jpalmier/Desktop/Sage/git/sage/logs/pkgs/psutil-5.2.0.p2.log\n  build directory: /Users/jpalmier/Desktop/Sage/git/sage/local/var/tmp/sage/build/psutil-5.2.0.p2\n\n* package:         pillow-8.0.1\n  last build time: Jan 26 15:52\n  log file:        /Users/jpalmier/Desktop/Sage/git/sage/logs/pkgs/pillow-8.0.1.log\n  build directory: /Users/jpalmier/Desktop/Sage/git/sage/local/var/tmp/sage/build/pillow-8.0.1\n\n* package:         kiwisolver-1.0.1\n  last build time: Jan 26 15:52\n  log file:        /Users/jpalmier/Desktop/Sage/git/sage/logs/pkgs/kiwisolver-1.0.1.log\n  build directory: /Users/jpalmier/Desktop/Sage/git/sage/local/var/tmp/sage/build/kiwisolver-1.0.1\n\n* package:         pynac-0.7.26.sage-2020-04-03.p0\n  last build time: Jan 26 15:53\n  log file:        /Users/jpalmier/Desktop/Sage/git/sage/logs/pkgs/pynac-0.7.26.sage-2020-04-03.p0.log\n  build directory: /Users/jpalmier/Desktop/Sage/git/sage/local/var/tmp/sage/build/pynac-0.7.26.sage-2020-04-03.p0\n\n* package:         cffi-1.14.4\n  last build time: Jan 26 15:53\n  log file:        /Users/jpalmier/Desktop/Sage/git/sage/logs/pkgs/cffi-1.14.4.log\n  build directory: /Users/jpalmier/Desktop/Sage/git/sage/local/var/tmp/sage/build/cffi-1.14.4\n```\nAll show the same error, \"clang: error: the clang compiler does not support '-march=native'\".",
    "created_at": "2021-01-27T00:02:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503101",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:18'></a>
I ran `make -k` to get a fuller report, and it ended with:

```
* package:         gmpy2-2.1.0b5
  last build time: Jan 26 15:52
  log file:        /Users/jpalmier/Desktop/Sage/git/sage/logs/pkgs/gmpy2-2.1.0b5.log
  build directory: /Users/jpalmier/Desktop/Sage/git/sage/local/var/tmp/sage/build/gmpy2-2.1.0b5

* package:         cython-0.29.21
  last build time: Jan 26 15:52
  log file:        /Users/jpalmier/Desktop/Sage/git/sage/logs/pkgs/cython-0.29.21.log
  build directory: /Users/jpalmier/Desktop/Sage/git/sage/local/var/tmp/sage/build/cython-0.29.21

* package:         psutil-5.2.0.p2
  last build time: Jan 26 15:52
  log file:        /Users/jpalmier/Desktop/Sage/git/sage/logs/pkgs/psutil-5.2.0.p2.log
  build directory: /Users/jpalmier/Desktop/Sage/git/sage/local/var/tmp/sage/build/psutil-5.2.0.p2

* package:         pillow-8.0.1
  last build time: Jan 26 15:52
  log file:        /Users/jpalmier/Desktop/Sage/git/sage/logs/pkgs/pillow-8.0.1.log
  build directory: /Users/jpalmier/Desktop/Sage/git/sage/local/var/tmp/sage/build/pillow-8.0.1

* package:         kiwisolver-1.0.1
  last build time: Jan 26 15:52
  log file:        /Users/jpalmier/Desktop/Sage/git/sage/logs/pkgs/kiwisolver-1.0.1.log
  build directory: /Users/jpalmier/Desktop/Sage/git/sage/local/var/tmp/sage/build/kiwisolver-1.0.1

* package:         pynac-0.7.26.sage-2020-04-03.p0
  last build time: Jan 26 15:53
  log file:        /Users/jpalmier/Desktop/Sage/git/sage/logs/pkgs/pynac-0.7.26.sage-2020-04-03.p0.log
  build directory: /Users/jpalmier/Desktop/Sage/git/sage/local/var/tmp/sage/build/pynac-0.7.26.sage-2020-04-03.p0

* package:         cffi-1.14.4
  last build time: Jan 26 15:53
  log file:        /Users/jpalmier/Desktop/Sage/git/sage/logs/pkgs/cffi-1.14.4.log
  build directory: /Users/jpalmier/Desktop/Sage/git/sage/local/var/tmp/sage/build/cffi-1.14.4
```
All show the same error, "clang: error: the clang compiler does not support '-march=native'".



---

archive/issue_comments_503102.json:
```json
{
    "body": "<a id='comment:19'></a>\nReplying to [@mkoeppe](#comment%3A17):\n> OK, looks like we have to set `ARCHFLAGS=\"\"` in more places. But this needs to be done very carefully - see #29408\n\nHow can we detect whether we're using a Python which requires this? And where is the right place to do it? `build/bin/sage-build-env-config.in`? There are lots of affected packages, so doing it globally would be easier. (`pyzmq`, `cysignals`, `numpy`, and others also seem to fail with the same error, if I recklessly add `export ARCHFLAGS=\"\"` to the install scripts for the other packages which were failing.)",
    "created_at": "2021-01-27T01:19:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503102",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:19'></a>
Replying to [@mkoeppe](#comment%3A17):
> OK, looks like we have to set `ARCHFLAGS=""` in more places. But this needs to be done very carefully - see #29408

How can we detect whether we're using a Python which requires this? And where is the right place to do it? `build/bin/sage-build-env-config.in`? There are lots of affected packages, so doing it globally would be easier. (`pyzmq`, `cysignals`, `numpy`, and others also seem to fail with the same error, if I recklessly add `export ARCHFLAGS=""` to the install scripts for the other packages which were failing.)



---

archive/issue_comments_503103.json:
```json
{
    "body": "<a id='comment:20'></a>\nReplying to [@jhpalmieri](#comment%3A18):\n> All show the same error, \"clang: error: the clang compiler does not support '-march=native'\".\n\nOh, this is a different error. Let me try to fix this",
    "created_at": "2021-01-27T01:37:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503103",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'></a>
Replying to [@jhpalmieri](#comment%3A18):
> All show the same error, "clang: error: the clang compiler does not support '-march=native'".

Oh, this is a different error. Let me try to fix this



---

archive/issue_comments_503104.json:
```json
{
    "body": "<a id='comment:21'></a>\nCould you post config.log from this run?",
    "created_at": "2021-01-27T02:04:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503104",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:21'></a>
Could you post config.log from this run?



---

archive/issue_comments_503105.json:
```json
{
    "body": "**Attachment:** [config.log](https://github.com/sagemath/sage/files/ticket31227/config.log)",
    "created_at": "2021-01-27T03:08:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503105",
    "user": "https://github.com/jhpalmieri"
}
```

**Attachment:** [config.log](https://github.com/sagemath/sage/files/ticket31227/config.log)



---

archive/issue_comments_503106.json:
```json
{
    "body": "<a id='comment:22'></a>\nReplying to [@mkoeppe](#comment%3A21):\n> Could you post config.log from this run?\n\nYes. I replaced the old `config.log`, since that was a result of my error, not a problem with this ticket.",
    "created_at": "2021-01-27T03:09:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503106",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:22'></a>
Replying to [@mkoeppe](#comment%3A21):
> Could you post config.log from this run?

Yes. I replaced the old `config.log`, since that was a result of my error, not a problem with this ticket.



---

archive/issue_comments_503107.json:
```json
{
    "body": "<a id='comment:23'></a>\nThanks. The crazy thing is that passing `-march=native` only seems to result in the error `clang: error: the clang compiler does not support '-march=native'` if also `-arch arm64` is passed. The current test in `python3/spkg-configure.m4` does not catch this.",
    "created_at": "2021-01-27T03:53:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503107",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:23'></a>
Thanks. The crazy thing is that passing `-march=native` only seems to result in the error `clang: error: the clang compiler does not support '-march=native'` if also `-arch arm64` is passed. The current test in `python3/spkg-configure.m4` does not catch this.



---

archive/issue_comments_503108.json:
```json
{
    "body": "<a id='comment:24'></a>\nWhat I find a bit confusing is the following:\n\nWe do not test, whether setting `ARCHFLAGS=\"\"` was necesarry in order to build this test extension during configure\n\nWhy do we expect that in real life situations (when actually compiling python extensions for sage) `ARCHFLAGS=\"\"` is not a requirement anymore?",
    "created_at": "2021-01-27T08:08:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503108",
    "user": "https://github.com/kliem"
}
```

<a id='comment:24'></a>
What I find a bit confusing is the following:

We do not test, whether setting `ARCHFLAGS=""` was necesarry in order to build this test extension during configure

Why do we expect that in real life situations (when actually compiling python extensions for sage) `ARCHFLAGS=""` is not a requirement anymore?



---

archive/issue_comments_503109.json:
```json
{
    "body": "<a id='comment:25'></a>\nFor what it's worth, setting `ARCHFLAGS=\"\"` in `sage-build-env-config.in` let me build Sage. Doctesting didn't go that well: various failures because of \"command 'gcc' failed with exit status 1\" and \"#error Unsupported architecture\" and \"#error architecture not supported\".",
    "created_at": "2021-01-27T19:25:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503109",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:25'></a>
For what it's worth, setting `ARCHFLAGS=""` in `sage-build-env-config.in` let me build Sage. Doctesting didn't go that well: various failures because of "command 'gcc' failed with exit status 1" and "#error Unsupported architecture" and "#error architecture not supported".



---

archive/issue_events_378560.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-01-30T17:50:01Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31227#event-378560"
}
```



---

archive/issue_events_378561.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-01-30T17:50:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31227#event-378561"
}
```



---

archive/issue_comments_503110.json:
```json
{
    "body": "<a id='comment:27'></a>\nReplying to [@jhpalmieri](#comment%3A25):\n> For what it's worth, setting `ARCHFLAGS=\"\"` in `sage-build-env-config.in` let me build Sage. Doctesting didn't go that well: various failures because of \"command 'gcc' failed with exit status 1\" and \"#error Unsupported architecture\" and \"#error architecture not supported\".\n\nIf we set `ARCHFLAGS`, we will have to do this in `sage-env` so that it also affects runtime use of the compiler (some of which is tested in doctests) and when users install Python packages with `sage -pip`.",
    "created_at": "2021-01-31T00:11:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503110",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:27'></a>
Replying to [@jhpalmieri](#comment%3A25):
> For what it's worth, setting `ARCHFLAGS=""` in `sage-build-env-config.in` let me build Sage. Doctesting didn't go that well: various failures because of "command 'gcc' failed with exit status 1" and "#error Unsupported architecture" and "#error architecture not supported".

If we set `ARCHFLAGS`, we will have to do this in `sage-env` so that it also affects runtime use of the compiler (some of which is tested in doctests) and when users install Python packages with `sage -pip`.



---

archive/issue_comments_503111.json:
```json
{
    "body": "<a id='comment:28'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/be3196dbfd015b9fbdbf7a06b9c953b687db3726\">be3196d</a></td><td><code>build/pkgs/python3/spkg-configure.m4, src/bin/sage-env[-config.in]: Prepare conditional setting of ARCHFLAGS</code></td></tr></table>\n",
    "created_at": "2021-01-31T00:28:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503111",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:28'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/be3196dbfd015b9fbdbf7a06b9c953b687db3726">be3196d</a></td><td><code>build/pkgs/python3/spkg-configure.m4, src/bin/sage-env[-config.in]: Prepare conditional setting of ARCHFLAGS</code></td></tr></table>




---

archive/issue_comments_503112.json:
```json
{
    "body": "**Changing commit** from \"[3325a4e4cef11e7b2f9946fd0db143f1c0157af3](https://github.com/sagemath/sagetrac-mirror/commit/3325a4e4cef11e7b2f9946fd0db143f1c0157af3)\" to \"[be3196dbfd015b9fbdbf7a06b9c953b687db3726](https://github.com/sagemath/sagetrac-mirror/commit/be3196dbfd015b9fbdbf7a06b9c953b687db3726)\".",
    "created_at": "2021-01-31T00:28:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503112",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[3325a4e4cef11e7b2f9946fd0db143f1c0157af3](https://github.com/sagemath/sagetrac-mirror/commit/3325a4e4cef11e7b2f9946fd0db143f1c0157af3)" to "[be3196dbfd015b9fbdbf7a06b9c953b687db3726](https://github.com/sagemath/sagetrac-mirror/commit/be3196dbfd015b9fbdbf7a06b9c953b687db3726)".



---

archive/issue_comments_503113.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -4,7 +4,7 @@\n \n #30725 fixes this for macOS, where some packages are explicitly built with `clang`.\n \n-However, there is another mechanism how `clang` can come in: Python extension modules are compiled with the compiler listed in sysconfig. On macOS with homebrew, using `/usr/bin/python3`, this could again be `clang`, which does not accept `-march=native`.\n+However, there is another mechanism how `clang` can come in: Python extension modules are compiled with the compiler listed in sysconfig. On macOS with homebrew, using `/usr/bin/python3`, this could again be `clang`, which does not accept `-march=native` in combination with `-arch arm64` (which is provided even on x86_64 if `ARCHFLAGS` is unset).\n \n In this ticket, we fix this by checking whether the compiler used by distutils accepts `-march=native` (or more generally, the flags determined earlier by `configure`). If it does not, then we disable the use of these flags.\n \n``````\n",
    "created_at": "2021-01-31T00:36:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503113",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -4,7 +4,7 @@
 
 #30725 fixes this for macOS, where some packages are explicitly built with `clang`.
 
-However, there is another mechanism how `clang` can come in: Python extension modules are compiled with the compiler listed in sysconfig. On macOS with homebrew, using `/usr/bin/python3`, this could again be `clang`, which does not accept `-march=native`.
+However, there is another mechanism how `clang` can come in: Python extension modules are compiled with the compiler listed in sysconfig. On macOS with homebrew, using `/usr/bin/python3`, this could again be `clang`, which does not accept `-march=native` in combination with `-arch arm64` (which is provided even on x86_64 if `ARCHFLAGS` is unset).
 
 In this ticket, we fix this by checking whether the compiler used by distutils accepts `-march=native` (or more generally, the flags determined earlier by `configure`). If it does not, then we disable the use of these flags.
 
``````




---

archive/issue_comments_503114.json:
```json
{
    "body": "<a id='comment:30'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4c1596ccbf57b7d63f56a189681852e82fe5bac9\">4c1596c</a></td><td><code>build/pkgs/python3/spkg-configure.m4, m4/sage_check_python_for_venv.m4: Refactor through new macro SAGE_PYTHON_CHECK_DISTUTILS</code></td></tr></table>\n",
    "created_at": "2021-01-31T02:20:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503114",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:30'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4c1596ccbf57b7d63f56a189681852e82fe5bac9">4c1596c</a></td><td><code>build/pkgs/python3/spkg-configure.m4, m4/sage_check_python_for_venv.m4: Refactor through new macro SAGE_PYTHON_CHECK_DISTUTILS</code></td></tr></table>




---

archive/issue_comments_503115.json:
```json
{
    "body": "**Changing commit** from \"[be3196dbfd015b9fbdbf7a06b9c953b687db3726](https://github.com/sagemath/sagetrac-mirror/commit/be3196dbfd015b9fbdbf7a06b9c953b687db3726)\" to \"[4c1596ccbf57b7d63f56a189681852e82fe5bac9](https://github.com/sagemath/sagetrac-mirror/commit/4c1596ccbf57b7d63f56a189681852e82fe5bac9)\".",
    "created_at": "2021-01-31T02:20:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503115",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[be3196dbfd015b9fbdbf7a06b9c953b687db3726](https://github.com/sagemath/sagetrac-mirror/commit/be3196dbfd015b9fbdbf7a06b9c953b687db3726)" to "[4c1596ccbf57b7d63f56a189681852e82fe5bac9](https://github.com/sagemath/sagetrac-mirror/commit/4c1596ccbf57b7d63f56a189681852e82fe5bac9)".



---

archive/issue_comments_503116.json:
```json
{
    "body": "**Changing commit** from \"[4c1596ccbf57b7d63f56a189681852e82fe5bac9](https://github.com/sagemath/sagetrac-mirror/commit/4c1596ccbf57b7d63f56a189681852e82fe5bac9)\" to \"[dc5e22511f783391282eca6a986971e6fe6f20b3](https://github.com/sagemath/sagetrac-mirror/commit/dc5e22511f783391282eca6a986971e6fe6f20b3)\".",
    "created_at": "2021-01-31T04:17:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503116",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[4c1596ccbf57b7d63f56a189681852e82fe5bac9](https://github.com/sagemath/sagetrac-mirror/commit/4c1596ccbf57b7d63f56a189681852e82fe5bac9)" to "[dc5e22511f783391282eca6a986971e6fe6f20b3](https://github.com/sagemath/sagetrac-mirror/commit/dc5e22511f783391282eca6a986971e6fe6f20b3)".



---

archive/issue_comments_503117.json:
```json
{
    "body": "<a id='comment:31'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/dc5e22511f783391282eca6a986971e6fe6f20b3\">dc5e225</a></td><td><code>build/pkgs/python3/spkg-configure.m4: On macOS, if the distutils test fails, try using empty ARCHFLAGS</code></td></tr></table>\n",
    "created_at": "2021-01-31T04:17:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503117",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:31'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/dc5e22511f783391282eca6a986971e6fe6f20b3">dc5e225</a></td><td><code>build/pkgs/python3/spkg-configure.m4: On macOS, if the distutils test fails, try using empty ARCHFLAGS</code></td></tr></table>




---

archive/issue_comments_503118.json:
```json
{
    "body": "<a id='comment:32'></a>\nHere's a new version that may be worth testing",
    "created_at": "2021-01-31T04:22:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503118",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:32'></a>
Here's a new version that may be worth testing



---

archive/issue_events_378562.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-01-31T04:22:38Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31227#event-378562"
}
```



---

archive/issue_events_378563.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-01-31T04:22:38Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31227#event-378563"
}
```



---

archive/issue_comments_503119.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -19,6 +19,7 @@\n egret:~/s/sage/sage-rebasing/worktree-algebraic-2018-spring (t/31132/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_build_when_using_homebrew_s_python3 *\n ```\n \n-In this ticket, we set `ARCHFLAGS` during this configure step.\n+In this ticket, if the distutils test fails, we try if setting `ARCHFLAGS=\"\"` fixes it. In that case, we store a configuration variable that causes `sage-env` to set `ARCHFLAGS` as well.\n+\n  \n \n``````\n",
    "created_at": "2021-01-31T04:25:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503119",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -19,6 +19,7 @@
 egret:~/s/sage/sage-rebasing/worktree-algebraic-2018-spring (t/31132/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_build_when_using_homebrew_s_python3 *
 ```
 
-In this ticket, we set `ARCHFLAGS` during this configure step.
+In this ticket, if the distutils test fails, we try if setting `ARCHFLAGS=""` fixes it. In that case, we store a configuration variable that causes `sage-env` to set `ARCHFLAGS` as well.
+
  
 
``````




---

archive/issue_comments_503120.json:
```json
{
    "body": "<a id='comment:34'></a>\nBuilds successfully for me with `tox -e local-homebrew-macos-standard-python3_xcode`",
    "created_at": "2021-01-31T04:56:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503120",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:34'></a>
Builds successfully for me with `tox -e local-homebrew-macos-standard-python3_xcode`



---

archive/issue_comments_503121.json:
```json
{
    "body": "<a id='comment:35'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/df17ad4e916d4db69a49dbe7c8082014abbcb539\">df17ad4</a></td><td><code>tox.ini: Add configuration factors for specific homebrew python3.x</code></td></tr></table>\n",
    "created_at": "2021-01-31T08:24:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503121",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:35'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/df17ad4e916d4db69a49dbe7c8082014abbcb539">df17ad4</a></td><td><code>tox.ini: Add configuration factors for specific homebrew python3.x</code></td></tr></table>




---

archive/issue_comments_503122.json:
```json
{
    "body": "**Changing commit** from \"[dc5e22511f783391282eca6a986971e6fe6f20b3](https://github.com/sagemath/sagetrac-mirror/commit/dc5e22511f783391282eca6a986971e6fe6f20b3)\" to \"[df17ad4e916d4db69a49dbe7c8082014abbcb539](https://github.com/sagemath/sagetrac-mirror/commit/df17ad4e916d4db69a49dbe7c8082014abbcb539)\".",
    "created_at": "2021-01-31T08:24:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503122",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[dc5e22511f783391282eca6a986971e6fe6f20b3](https://github.com/sagemath/sagetrac-mirror/commit/dc5e22511f783391282eca6a986971e6fe6f20b3)" to "[df17ad4e916d4db69a49dbe7c8082014abbcb539](https://github.com/sagemath/sagetrac-mirror/commit/df17ad4e916d4db69a49dbe7c8082014abbcb539)".



---

archive/issue_comments_503123.json:
```json
{
    "body": "<a id='comment:36'></a>\nWhat is the purpose of this line?\n\n```diff\n+    AC_SUBST([ARCHFLAGS], [unset])\n```",
    "created_at": "2021-01-31T08:34:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503123",
    "user": "https://github.com/kliem"
}
```

<a id='comment:36'></a>
What is the purpose of this line?

```diff
+    AC_SUBST([ARCHFLAGS], [unset])
```



---

archive/issue_comments_503124.json:
```json
{
    "body": "<a id='comment:37'></a>\nI think the second reason is wrong here. Isn't this the case when building a C extension fails?\n\n```\ndnl distutils test\nAC_DEFUN([SAGE_PYTHON_CHECK_DISTUTILS], [\n    m4_pushdef([PYTHON_EXE], [$1])\n    m4_pushdef([COMMANDS_IF_DISTUTILS_GOOD], [$2])\n    m4_pushdef([COMMANDS_IF_DISTUTILS_NOT_GOOD], [$3])\n    SAGE_PYTHON_DISTUTILS_C_CONFTEST\n    dnl (echo \"***ENV***:\"; env; echo \"***SYSCONFIG***\"; conftest_venv/bin/python3 -m sysconfig) >& AS_MESSAGE_LOG_FD\n    echo PYTHON_EXE conftest.py --verbose build --build-base=conftest.dir >& AS_MESSAGE_LOG_FD\n    AS_IF([PYTHON_EXE conftest.py --verbose build --build-base=conftest.dir >& AS_MESSAGE_LOG_FD 2>&1 ], [\n        SAGE_PYTHON_DISTUTILS_CXX_CONFTEST\n        echo PYTHON_EXE conftest.py --verbose build --build-base=conftest.dir >& AS_MESSAGE_LOG_FD 2>&1\n        AS_IF([PYTHON_EXE conftest.py --verbose build --build-base=conftest.dir >& AS_MESSAGE_LOG_FD 2>&1 ], [\n            COMMANDS_IF_DISTUTILS_GOOD], [\n            reason=\"distutils cannot build a C++ 11 extension\"\n            COMMANDS_IF_DISTUTILS_NOT_GOOD\n        ])\n    ], [\n       reason=\"distutils cannot build a C++ 11 extension\"\n       COMMANDS_IF_DISTUTILS_NOT_GOOD\n    ])\n    m4_popdef([PYTHON_EXE])\n    m4_popdef([COMMANDS_IF_DISTUTILS_GOOD])\n    m4_popdef([COMMANDS_IF_DISTUTILS_NOT_GOOD])\n])\n```",
    "created_at": "2021-01-31T08:46:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503124",
    "user": "https://github.com/kliem"
}
```

<a id='comment:37'></a>
I think the second reason is wrong here. Isn't this the case when building a C extension fails?

```
dnl distutils test
AC_DEFUN([SAGE_PYTHON_CHECK_DISTUTILS], [
    m4_pushdef([PYTHON_EXE], [$1])
    m4_pushdef([COMMANDS_IF_DISTUTILS_GOOD], [$2])
    m4_pushdef([COMMANDS_IF_DISTUTILS_NOT_GOOD], [$3])
    SAGE_PYTHON_DISTUTILS_C_CONFTEST
    dnl (echo "***ENV***:"; env; echo "***SYSCONFIG***"; conftest_venv/bin/python3 -m sysconfig) >& AS_MESSAGE_LOG_FD
    echo PYTHON_EXE conftest.py --verbose build --build-base=conftest.dir >& AS_MESSAGE_LOG_FD
    AS_IF([PYTHON_EXE conftest.py --verbose build --build-base=conftest.dir >& AS_MESSAGE_LOG_FD 2>&1 ], [
        SAGE_PYTHON_DISTUTILS_CXX_CONFTEST
        echo PYTHON_EXE conftest.py --verbose build --build-base=conftest.dir >& AS_MESSAGE_LOG_FD 2>&1
        AS_IF([PYTHON_EXE conftest.py --verbose build --build-base=conftest.dir >& AS_MESSAGE_LOG_FD 2>&1 ], [
            COMMANDS_IF_DISTUTILS_GOOD], [
            reason="distutils cannot build a C++ 11 extension"
            COMMANDS_IF_DISTUTILS_NOT_GOOD
        ])
    ], [
       reason="distutils cannot build a C++ 11 extension"
       COMMANDS_IF_DISTUTILS_NOT_GOOD
    ])
    m4_popdef([PYTHON_EXE])
    m4_popdef([COMMANDS_IF_DISTUTILS_GOOD])
    m4_popdef([COMMANDS_IF_DISTUTILS_NOT_GOOD])
])
```



---

archive/issue_comments_503125.json:
```json
{
    "body": "<a id='comment:38'></a>\nAlso `tox -e local-homebrew-usrlocal-minimal-python3.8` still works.",
    "created_at": "2021-01-31T08:47:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503125",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:38'></a>
Also `tox -e local-homebrew-usrlocal-minimal-python3.8` still works.



---

archive/issue_comments_503126.json:
```json
{
    "body": "**Changing commit** from \"[df17ad4e916d4db69a49dbe7c8082014abbcb539](https://github.com/sagemath/sagetrac-mirror/commit/df17ad4e916d4db69a49dbe7c8082014abbcb539)\" to \"[914ea58a359df5478484da7fa3293007fad2b2df](https://github.com/sagemath/sagetrac-mirror/commit/914ea58a359df5478484da7fa3293007fad2b2df)\".",
    "created_at": "2021-01-31T08:50:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503126",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[df17ad4e916d4db69a49dbe7c8082014abbcb539](https://github.com/sagemath/sagetrac-mirror/commit/df17ad4e916d4db69a49dbe7c8082014abbcb539)" to "[914ea58a359df5478484da7fa3293007fad2b2df](https://github.com/sagemath/sagetrac-mirror/commit/914ea58a359df5478484da7fa3293007fad2b2df)".



---

archive/issue_comments_503127.json:
```json
{
    "body": "<a id='comment:39'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/914ea58a359df5478484da7fa3293007fad2b2df\">914ea58</a></td><td><code>build/pkgs/python3/spkg-configure.m4: Get rid of stray AC_SUBST</code></td></tr></table>\n",
    "created_at": "2021-01-31T08:50:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503127",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:39'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/914ea58a359df5478484da7fa3293007fad2b2df">914ea58</a></td><td><code>build/pkgs/python3/spkg-configure.m4: Get rid of stray AC_SUBST</code></td></tr></table>




---

archive/issue_comments_503128.json:
```json
{
    "body": "**Changing commit** from \"[914ea58a359df5478484da7fa3293007fad2b2df](https://github.com/sagemath/sagetrac-mirror/commit/914ea58a359df5478484da7fa3293007fad2b2df)\" to \"[986739b940952c7b10dfe0bd2b17dce2407f1ee0](https://github.com/sagemath/sagetrac-mirror/commit/986739b940952c7b10dfe0bd2b17dce2407f1ee0)\".",
    "created_at": "2021-01-31T08:51:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503128",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[914ea58a359df5478484da7fa3293007fad2b2df](https://github.com/sagemath/sagetrac-mirror/commit/914ea58a359df5478484da7fa3293007fad2b2df)" to "[986739b940952c7b10dfe0bd2b17dce2407f1ee0](https://github.com/sagemath/sagetrac-mirror/commit/986739b940952c7b10dfe0bd2b17dce2407f1ee0)".



---

archive/issue_comments_503129.json:
```json
{
    "body": "<a id='comment:40'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/986739b940952c7b10dfe0bd2b17dce2407f1ee0\">986739b</a></td><td><code>m4/sage_check_python_for_venv.m4: Fix reason</code></td></tr></table>\n",
    "created_at": "2021-01-31T08:51:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503129",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:40'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/986739b940952c7b10dfe0bd2b17dce2407f1ee0">986739b</a></td><td><code>m4/sage_check_python_for_venv.m4: Fix reason</code></td></tr></table>




---

archive/issue_comments_503130.json:
```json
{
    "body": "<a id='comment:41'></a>\nThanks for spotting these mistakes!",
    "created_at": "2021-01-31T08:51:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503130",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:41'></a>
Thanks for spotting these mistakes!



---

archive/issue_comments_503131.json:
```json
{
    "body": "<a id='comment:42'></a>\nOtherwise, this looks very plausible.\n\nI updated https://github.com/kliem/sage/pull/36/ (not the last two commits, but they are cosmetic).",
    "created_at": "2021-01-31T09:09:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503131",
    "user": "https://github.com/kliem"
}
```

<a id='comment:42'></a>
Otherwise, this looks very plausible.

I updated https://github.com/kliem/sage/pull/36/ (not the last two commits, but they are cosmetic).



---

archive/issue_comments_503132.json:
```json
{
    "body": "<a id='comment:43'></a>\nThis works for me on OS X Catalina. If I also include #31204, it passes most doctests. I see a few failures I don't remember seeing before:\n\n```\nsage -t --long --random-seed=0 src/sage_setup/find.py\n**********************************************************************\nFile \"src/sage_setup/find.py\", line 278, in sage_setup.find.installed_files_by_module\nFailed example:\n    f1\nExpected:\n    'sage/structure/__init__.py'\nGot:\n    '/Users/jpalmier/Library/Caches/com.apple.python/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python3.8/site-packages/sage/structure/__init__.cpython-38.pyc'\n**********************************************************************\nFile \"src/sage_setup/find.py\", line 280, in sage_setup.find.installed_files_by_module\nFailed example:\n    f2\nExpected:\n    'sage/structure/....pyc'\nGot:\n    'sage/structure/__init__.py'\n```\nand\n\n```\nsage -t --long --random-seed=0 src/sage_setup/clean.py\n**********************************************************************\nFile \"src/sage_setup/clean.py\", line 95, in sage_setup.clean._find_stale_files\nFailed example:\n    for f in stale_iter:\n        if f.endswith(skip_extensions): continue\n        if '/ext_data/' in f: continue\n        print('Found stale file: ' + f)\nExpected nothing\nGot:\n    Found stale file: /Users/jpalmier/Library/Caches/com.apple.python/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python3.8/site-packages/sage/all_cmdline.cpython-38.pyc\n    Found stale file: /Users/jpalmier/Library/Caches/com.apple.python/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python3.8/site-packages/sage/version.cpython-38.pyc\n\n  [ and many more lines of such messages ]\n```\nWhy is it looking in `$HOME/Library`? Also, the files there look from their dates as if they were created during this build of Sage.",
    "created_at": "2021-01-31T22:27:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503132",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:43'></a>
This works for me on OS X Catalina. If I also include #31204, it passes most doctests. I see a few failures I don't remember seeing before:

```
sage -t --long --random-seed=0 src/sage_setup/find.py
**********************************************************************
File "src/sage_setup/find.py", line 278, in sage_setup.find.installed_files_by_module
Failed example:
    f1
Expected:
    'sage/structure/__init__.py'
Got:
    '/Users/jpalmier/Library/Caches/com.apple.python/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python3.8/site-packages/sage/structure/__init__.cpython-38.pyc'
**********************************************************************
File "src/sage_setup/find.py", line 280, in sage_setup.find.installed_files_by_module
Failed example:
    f2
Expected:
    'sage/structure/....pyc'
Got:
    'sage/structure/__init__.py'
```
and

```
sage -t --long --random-seed=0 src/sage_setup/clean.py
**********************************************************************
File "src/sage_setup/clean.py", line 95, in sage_setup.clean._find_stale_files
Failed example:
    for f in stale_iter:
        if f.endswith(skip_extensions): continue
        if '/ext_data/' in f: continue
        print('Found stale file: ' + f)
Expected nothing
Got:
    Found stale file: /Users/jpalmier/Library/Caches/com.apple.python/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python3.8/site-packages/sage/all_cmdline.cpython-38.pyc
    Found stale file: /Users/jpalmier/Library/Caches/com.apple.python/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python3.8/site-packages/sage/version.cpython-38.pyc

  [ and many more lines of such messages ]
```
Why is it looking in `$HOME/Library`? Also, the files there look from their dates as if they were created during this build of Sage.



---

archive/issue_comments_503133.json:
```json
{
    "body": "<a id='comment:44'></a>\nThis does not work for me with OS X Big Sur, though: many packages (cython, pynac, gmpy2, psutil, pillow, kiwisolver, cffi) fail to build with the error \"clang: error: the clang compiler does not support '-march=native'\".\n\nHold on, I have to run `./bootstrap` and try again.\n\nConfirmed, these packages all fail after\n\n```\nmake distclean && ./bootstrap && ./configure --with-python=/usr/bin/python3 && make -k\n```",
    "created_at": "2021-01-31T23:42:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503133",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:44'></a>
This does not work for me with OS X Big Sur, though: many packages (cython, pynac, gmpy2, psutil, pillow, kiwisolver, cffi) fail to build with the error "clang: error: the clang compiler does not support '-march=native'".

Hold on, I have to run `./bootstrap` and try again.

Confirmed, these packages all fail after

```
make distclean && ./bootstrap && ./configure --with-python=/usr/bin/python3 && make -k
```



---

archive/issue_comments_503134.json:
```json
{
    "body": "<a id='comment:45'></a>\nReplying to [@jhpalmieri](#comment%3A43):\n> This works for me on OS X Catalina. If I also include #31204, it passes most doctests. I see a few failures I don't remember seeing before [...]\n> Why is it looking in `$HOME/Library`? Also, the files there look from their dates as if they were created during this build of Sage.\n\nIs `PYTHONPYCACHEPREFIX` set on your system? https://docs.python.org/3/using/cmdline.html#envvar-PYTHONPYCACHEPREFIX\n(#31314)",
    "created_at": "2021-02-01T01:22:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503134",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:45'></a>
Replying to [@jhpalmieri](#comment%3A43):
> This works for me on OS X Catalina. If I also include #31204, it passes most doctests. I see a few failures I don't remember seeing before [...]
> Why is it looking in `$HOME/Library`? Also, the files there look from their dates as if they were created during this build of Sage.

Is `PYTHONPYCACHEPREFIX` set on your system? https://docs.python.org/3/using/cmdline.html#envvar-PYTHONPYCACHEPREFIX
(#31314)



---

archive/issue_comments_503135.json:
```json
{
    "body": "<a id='comment:46'></a>\n`config.log` from the big sur system please",
    "created_at": "2021-02-01T01:23:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503135",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:46'></a>
`config.log` from the big sur system please



---

archive/issue_comments_503136.json:
```json
{
    "body": "<a id='comment:47'></a>\nReplying to [@mkoeppe](#comment%3A45):\n> Replying to [@jhpalmieri](#comment%3A43):\n> > This works for me on OS X Catalina. If I also include #31204, it passes most doctests. I see a few failures I don't remember seeing before [...]\n> > Why is it looking in `$HOME/Library`? Also, the files there look from their dates as if they were created during this build of Sage.\n\n> \n> Is `PYTHONPYCACHEPREFIX` set on your system? https://docs.python.org/3/using/cmdline.html#envvar-PYTHONPYCACHEPREFIX\n> (#31314)\n\nNo, not normally and not after running `./sage --sh`.",
    "created_at": "2021-02-01T02:08:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503136",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:47'></a>
Replying to [@mkoeppe](#comment%3A45):
> Replying to [@jhpalmieri](#comment%3A43):
> > This works for me on OS X Catalina. If I also include #31204, it passes most doctests. I see a few failures I don't remember seeing before [...]
> > Why is it looking in `$HOME/Library`? Also, the files there look from their dates as if they were created during this build of Sage.

> 
> Is `PYTHONPYCACHEPREFIX` set on your system? https://docs.python.org/3/using/cmdline.html#envvar-PYTHONPYCACHEPREFIX
> (#31314)

No, not normally and not after running `./sage --sh`.



---

archive/issue_comments_503137.json:
```json
{
    "body": "**Attachment:** [config.2.log](https://github.com/sagemath/sage/files/ticket31227/config.2.log)\n\nconfig.log for failed Big Sur build",
    "created_at": "2021-02-01T02:09:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503137",
    "user": "https://github.com/jhpalmieri"
}
```

**Attachment:** [config.2.log](https://github.com/sagemath/sage/files/ticket31227/config.2.log)

config.log for failed Big Sur build



---

archive/issue_comments_503138.json:
```json
{
    "body": "<a id='comment:48'></a>\nReplying to [@jhpalmieri](#comment%3A47):\n> Replying to [@mkoeppe](#comment%3A45):\n> > Replying to [@jhpalmieri](#comment%3A43):\n> > > This works for me on OS X Catalina. If I also include #31204, it passes most doctests. I see a few failures I don't remember seeing before [...]\n> > > Why is it looking in `$HOME/Library`? Also, the files there look from their dates as if they were created during this build of Sage.\n\n> > \n> > Is `PYTHONPYCACHEPREFIX` set on your system? https://docs.python.org/3/using/cmdline.html#envvar-PYTHONPYCACHEPREFIX\n> > (#31314)\n\n> \n> No, not normally and not after running `./sage --sh`.\n\nHowever:\n\n```\n% /usr/bin/python3   \nPython 3.8.2 (default, Dec 21 2020, 15:06:04) \n[Clang 12.0.0 (clang-1200.0.32.29)] on darwin\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> import sys\n>>> sys.pycache_prefix\n'/Users/jpalmier/Library/Caches/com.apple.python'\n```\nThis is not how `/usr/local/bin/python3` behaves: `sys.pycache_prefix` is `None` there. The Python documentation suggests that the default setting should be `None` since I am not passing a `-X` argument nor am I setting `PYTHONPYCACHEPREFIX`.",
    "created_at": "2021-02-01T02:16:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503138",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:48'></a>
Replying to [@jhpalmieri](#comment%3A47):
> Replying to [@mkoeppe](#comment%3A45):
> > Replying to [@jhpalmieri](#comment%3A43):
> > > This works for me on OS X Catalina. If I also include #31204, it passes most doctests. I see a few failures I don't remember seeing before [...]
> > > Why is it looking in `$HOME/Library`? Also, the files there look from their dates as if they were created during this build of Sage.

> > 
> > Is `PYTHONPYCACHEPREFIX` set on your system? https://docs.python.org/3/using/cmdline.html#envvar-PYTHONPYCACHEPREFIX
> > (#31314)

> 
> No, not normally and not after running `./sage --sh`.

However:

```
% /usr/bin/python3   
Python 3.8.2 (default, Dec 21 2020, 15:06:04) 
[Clang 12.0.0 (clang-1200.0.32.29)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>> import sys
>>> sys.pycache_prefix
'/Users/jpalmier/Library/Caches/com.apple.python'
```
This is not how `/usr/local/bin/python3` behaves: `sys.pycache_prefix` is `None` there. The Python documentation suggests that the default setting should be `None` since I am not passing a `-X` argument nor am I setting `PYTHONPYCACHEPREFIX`.



---

archive/issue_comments_503139.json:
```json
{
    "body": "<a id='comment:49'></a>\nhm... config.2.log does not look like it's coming from this branch...",
    "created_at": "2021-02-01T02:18:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503139",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:49'></a>
hm... config.2.log does not look like it's coming from this branch...



---

archive/issue_comments_503140.json:
```json
{
    "body": "<a id='comment:50'></a>\nReplying to [@jhpalmieri](#comment%3A48):\n> \n> ```\n> % /usr/bin/python3   \n> Python 3.8.2 (default, Dec 21 2020, 15:06:04) \n> [Clang 12.0.0 (clang-1200.0.32.29)] on darwin\n> Type \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n> >>> import sys\n> >>> sys.pycache_prefix\n> '/Users/jpalmier/Library/Caches/com.apple.python'\n> ```\n\nSame here. Looks like Apple has preconfigured their build to do this. I'll update the description of #31314.",
    "created_at": "2021-02-01T02:20:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503140",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:50'></a>
Replying to [@jhpalmieri](#comment%3A48):
> 
> ```
> % /usr/bin/python3   
> Python 3.8.2 (default, Dec 21 2020, 15:06:04) 
> [Clang 12.0.0 (clang-1200.0.32.29)] on darwin
> Type "help", "copyright", "credits" or "license" for more information.
> >>> import sys
> >>> sys.pycache_prefix
> '/Users/jpalmier/Library/Caches/com.apple.python'
> ```

Same here. Looks like Apple has preconfigured their build to do this. I'll update the description of #31314.



---

archive/issue_comments_503141.json:
```json
{
    "body": "<a id='comment:51'></a>\nReplying to [@mkoeppe](#comment%3A49):\n> hm... config.2.log does not look like it's coming from this branch...\n\nSorry, you're right. Typo on my part: I checked out #31127 instead of #31227. Trying again now.",
    "created_at": "2021-02-01T02:25:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503141",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:51'></a>
Replying to [@mkoeppe](#comment%3A49):
> hm... config.2.log does not look like it's coming from this branch...

Sorry, you're right. Typo on my part: I checked out #31127 instead of #31227. Trying again now.



---

archive/issue_comments_503142.json:
```json
{
    "body": "<a id='comment:52'></a>\nNow with Big Sur, `cysignals` and `scipy` fail. For `scipy`, the error looks like this:\n\n```\n    /Users/palmieri/Desktop/Sage/sage_builds/TESTING/clean/sage-9.3.beta6/local/lib/python3.8/site-packages/numpy/distutils/system_info.py:838: UserWarning: Specified path /usr/local/include/python3.8 is invalid.\n```\nSomehow it's picking up `/usr/local`. I'm not sure what's going on with `cysignals`. Logs attached.",
    "created_at": "2021-02-01T03:53:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503142",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:52'></a>
Now with Big Sur, `cysignals` and `scipy` fail. For `scipy`, the error looks like this:

```
    /Users/palmieri/Desktop/Sage/sage_builds/TESTING/clean/sage-9.3.beta6/local/lib/python3.8/site-packages/numpy/distutils/system_info.py:838: UserWarning: Specified path /usr/local/include/python3.8 is invalid.
```
Somehow it's picking up `/usr/local`. I'm not sure what's going on with `cysignals`. Logs attached.



---

archive/issue_comments_503143.json:
```json
{
    "body": "config.log for failed Big Sur build",
    "created_at": "2021-02-01T03:54:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503143",
    "user": "https://github.com/jhpalmieri"
}
```

config.log for failed Big Sur build



---

archive/issue_comments_503144.json:
```json
{
    "body": "**Attachment:** [config.3.log](https://github.com/sagemath/sage/files/ticket31227/config.3.log)",
    "created_at": "2021-02-01T03:54:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503144",
    "user": "https://github.com/jhpalmieri"
}
```

**Attachment:** [config.3.log](https://github.com/sagemath/sage/files/ticket31227/config.3.log)



---

archive/issue_comments_503145.json:
```json
{
    "body": "**Attachment:** [cysignals-1.10.2.log](https://github.com/sagemath/sage/files/ticket31227/cysignals-1.10.2.log)",
    "created_at": "2021-02-01T03:54:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503145",
    "user": "https://github.com/jhpalmieri"
}
```

**Attachment:** [cysignals-1.10.2.log](https://github.com/sagemath/sage/files/ticket31227/cysignals-1.10.2.log)



---

archive/issue_comments_503146.json:
```json
{
    "body": "<a id='comment:53'></a>\n**Attachment:** [scipy-1.5.4.log](https://github.com/sagemath/sage/files/ticket31227/scipy-1.5.4.log)\n\nThe config.log looks good.",
    "created_at": "2021-02-01T03:58:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503146",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:53'></a>
**Attachment:** [scipy-1.5.4.log](https://github.com/sagemath/sage/files/ticket31227/scipy-1.5.4.log)

The config.log looks good.



---

archive/issue_comments_503147.json:
```json
{
    "body": "<a id='comment:54'></a>\nReplying to [@jhpalmieri](#comment%3A52):\n> Now with Big Sur, `cysignals` and `scipy` fail. For `scipy`, the error looks like this:\n> \n> ```\n>     /Users/palmieri/Desktop/Sage/sage_builds/TESTING/clean/sage-9.3.beta6/local/lib/python3.8/site-packages/numpy/distutils/system_info.py:838: UserWarning: Specified path /usr/local/include/python3.8 is invalid.\n> ```\n\nI think the actual error is this one:\n\n```\n  ar: adding 50 object files to build/temp.macosx-10.14.6-x86_64-3.8/libsuperlu_src.a\n  warning: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/ranlib: archive library: build/temp.macosx-10.14.6-x86_64-3.8/libsuperlu_src.a will be fat and ar(1) will not be able to operate on it\n  ar: adding 50 object files to build/temp.macosx-10.14.6-x86_64-3.8/libsuperlu_src.a\n  ar: build/temp.macosx-10.14.6-x86_64-3.8/libsuperlu_src.a is a fat file (use libtool(1) or lipo(1) and ar(1) on it)\n  ar: build/temp.macosx-10.14.6-x86_64-3.8/libsuperlu_src.a: Inappropriate file type or format\n```",
    "created_at": "2021-02-01T04:01:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503147",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:54'></a>
Replying to [@jhpalmieri](#comment%3A52):
> Now with Big Sur, `cysignals` and `scipy` fail. For `scipy`, the error looks like this:
> 
> ```
>     /Users/palmieri/Desktop/Sage/sage_builds/TESTING/clean/sage-9.3.beta6/local/lib/python3.8/site-packages/numpy/distutils/system_info.py:838: UserWarning: Specified path /usr/local/include/python3.8 is invalid.
> ```

I think the actual error is this one:

```
  ar: adding 50 object files to build/temp.macosx-10.14.6-x86_64-3.8/libsuperlu_src.a
  warning: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/ranlib: archive library: build/temp.macosx-10.14.6-x86_64-3.8/libsuperlu_src.a will be fat and ar(1) will not be able to operate on it
  ar: adding 50 object files to build/temp.macosx-10.14.6-x86_64-3.8/libsuperlu_src.a
  ar: build/temp.macosx-10.14.6-x86_64-3.8/libsuperlu_src.a is a fat file (use libtool(1) or lipo(1) and ar(1) on it)
  ar: build/temp.macosx-10.14.6-x86_64-3.8/libsuperlu_src.a: Inappropriate file type or format
```



---

archive/issue_comments_503148.json:
```json
{
    "body": "<a id='comment:55'></a>\nSimilar: https://github.com/scipy/scipy/issues/10902",
    "created_at": "2021-02-01T04:09:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503148",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:55'></a>
Similar: https://github.com/scipy/scipy/issues/10902



---

archive/issue_comments_503149.json:
```json
{
    "body": "<a id='comment:56'></a>\nIs `MACOSX_DEPLOYMENT_TARGET` set to something on your big sur system?",
    "created_at": "2021-02-01T04:13:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503149",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:56'></a>
Is `MACOSX_DEPLOYMENT_TARGET` set to something on your big sur system?



---

archive/issue_comments_503150.json:
```json
{
    "body": "<a id='comment:57'></a>\nReplying to [@mkoeppe](#comment%3A56):\n> Is `MACOSX_DEPLOYMENT_TARGET` set to something on your big sur system?\n\nNo, but who knows what Xcode and/or homebrew are doing these days.",
    "created_at": "2021-02-01T04:17:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503150",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:57'></a>
Replying to [@mkoeppe](#comment%3A56):
> Is `MACOSX_DEPLOYMENT_TARGET` set to something on your big sur system?

No, but who knows what Xcode and/or homebrew are doing these days.



---

archive/issue_comments_503151.json:
```json
{
    "body": "<a id='comment:58'></a>\nfrom cysignals.log: \n\n```\n  gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64 -O2 -g -Wp,-U_FORTIFY_SOURCE -DCYTHON_CLINE_IN_TRACEBACK=0 -U_FORTIFY_SOURCE -Isrc/cysignals -Isrc -I/Users/palmieri/Desktop/Sage/sage_builds/TESTING/clean/sage-9.3.beta6/local/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -c build/src/cysignals/signals.c -o build/temp.macosx-10.14.6-x86_64-3.8/build/src/cysignals/signals.o -pthread\n  In file included from build/src/cysignals/signals.c:1570:\n  In file included from build/src/cysignals/implementation.c:58:\n  In file included from /Users/palmieri/Desktop/Sage/sage_builds/TESTING/clean/sage-9.3.beta6/local/include/pari/pari.h:49:\n  ../src/kernel/none/divll_pre.h:30:10: error: invalid output constraint '=a' in asm\n    return divll(~0UL, n);\n           ^\n```\nThis is trying to build for `-arch arm64 -arch x86_64` and is tripping over the installed pari header ... which is arch-specific!",
    "created_at": "2021-02-01T04:21:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503151",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:58'></a>
from cysignals.log: 

```
  gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64 -O2 -g -Wp,-U_FORTIFY_SOURCE -DCYTHON_CLINE_IN_TRACEBACK=0 -U_FORTIFY_SOURCE -Isrc/cysignals -Isrc -I/Users/palmieri/Desktop/Sage/sage_builds/TESTING/clean/sage-9.3.beta6/local/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -c build/src/cysignals/signals.c -o build/temp.macosx-10.14.6-x86_64-3.8/build/src/cysignals/signals.o -pthread
  In file included from build/src/cysignals/signals.c:1570:
  In file included from build/src/cysignals/implementation.c:58:
  In file included from /Users/palmieri/Desktop/Sage/sage_builds/TESTING/clean/sage-9.3.beta6/local/include/pari/pari.h:49:
  ../src/kernel/none/divll_pre.h:30:10: error: invalid output constraint '=a' in asm
    return divll(~0UL, n);
           ^
```
This is trying to build for `-arch arm64 -arch x86_64` and is tripping over the installed pari header ... which is arch-specific!



---

archive/issue_comments_503152.json:
```json
{
    "body": "<a id='comment:59'></a>\nBefore I source `.homebrew-build-env`, I only set these environment variables:\n\n```\nBIBINPUTS=/Users/palmieri/iCloud/Documents/tex/bibtex:.:\nEDITOR=emacs\nLESS=-R\nLSCOLORS=Gxfxcxdxbxegedabagacad\nMAKE='make -j6'\nMAKEFLAGS=-j6\nPAGER=less\nPATH=/Users/palmieri/.local/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/Library/TeX/texbin:/Library/Apple/usr/bin:/Library/Frameworks/Mono.framework/Versions/Current/Commands\n```\n(If I run `export` at the start of my .zshrc file and also comment out the line that runs `.homebrew-build-env`, and then run `export` again with an actual running terminal, these are the differences.) Nothing strange there, nothing that I think should cause any problems. This is on the Big Sur system, but the Catalina system has a very similar configuration.",
    "created_at": "2021-02-01T04:32:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503152",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:59'></a>
Before I source `.homebrew-build-env`, I only set these environment variables:

```
BIBINPUTS=/Users/palmieri/iCloud/Documents/tex/bibtex:.:
EDITOR=emacs
LESS=-R
LSCOLORS=Gxfxcxdxbxegedabagacad
MAKE='make -j6'
MAKEFLAGS=-j6
PAGER=less
PATH=/Users/palmieri/.local/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/Library/TeX/texbin:/Library/Apple/usr/bin:/Library/Frameworks/Mono.framework/Versions/Current/Commands
```
(If I run `export` at the start of my .zshrc file and also comment out the line that runs `.homebrew-build-env`, and then run `export` again with an actual running terminal, these are the differences.) Nothing strange there, nothing that I think should cause any problems. This is on the Big Sur system, but the Catalina system has a very similar configuration.



---

archive/issue_comments_503153.json:
```json
{
    "body": "<a id='comment:60'></a>\nIt seems that we need to set `ARCHFLAGS=\"\"` in more situations. The default set by `/usr/bin/python3`, trying to build for both architectures, is unrealistic to support -- this would require major changes to how we install libraries.",
    "created_at": "2021-02-01T04:34:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503153",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:60'></a>
It seems that we need to set `ARCHFLAGS=""` in more situations. The default set by `/usr/bin/python3`, trying to build for both architectures, is unrealistic to support -- this would require major changes to how we install libraries.



---

archive/issue_comments_503154.json:
```json
{
    "body": "**Changing commit** from \"[986739b940952c7b10dfe0bd2b17dce2407f1ee0](https://github.com/sagemath/sagetrac-mirror/commit/986739b940952c7b10dfe0bd2b17dce2407f1ee0)\" to \"[0b3e70d458ef88d610c6883ddedaf19565f7de3a](https://github.com/sagemath/sagetrac-mirror/commit/0b3e70d458ef88d610c6883ddedaf19565f7de3a)\".",
    "created_at": "2021-02-01T04:58:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503154",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[986739b940952c7b10dfe0bd2b17dce2407f1ee0](https://github.com/sagemath/sagetrac-mirror/commit/986739b940952c7b10dfe0bd2b17dce2407f1ee0)" to "[0b3e70d458ef88d610c6883ddedaf19565f7de3a](https://github.com/sagemath/sagetrac-mirror/commit/0b3e70d458ef88d610c6883ddedaf19565f7de3a)".



---

archive/issue_comments_503155.json:
```json
{
    "body": "<a id='comment:61'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0b3e70d458ef88d610c6883ddedaf19565f7de3a\">0b3e70d</a></td><td><code>build/pkgs/python3/spkg-configure.m4: If PYTHON_FOR_VENV is configured to build multiarch extensions, set SAGE_ARCHFLAGS to disable it</code></td></tr></table>\n",
    "created_at": "2021-02-01T04:58:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503155",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:61'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0b3e70d458ef88d610c6883ddedaf19565f7de3a">0b3e70d</a></td><td><code>build/pkgs/python3/spkg-configure.m4: If PYTHON_FOR_VENV is configured to build multiarch extensions, set SAGE_ARCHFLAGS to disable it</code></td></tr></table>




---

archive/issue_comments_503156.json:
```json
{
    "body": "<a id='comment:62'></a>\nHere's a new version to try on big sur",
    "created_at": "2021-02-01T04:58:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503156",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:62'></a>
Here's a new version to try on big sur



---

archive/issue_comments_503157.json:
```json
{
    "body": "<a id='comment:63'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/372adcb4b2f3de7a230b14f5c275299d7d8c50fc\">372adcb</a></td><td><code>.github/workflows/tox.yml: Update xcode versions</code></td></tr></table>\n",
    "created_at": "2021-02-01T05:54:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503157",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:63'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/372adcb4b2f3de7a230b14f5c275299d7d8c50fc">372adcb</a></td><td><code>.github/workflows/tox.yml: Update xcode versions</code></td></tr></table>




---

archive/issue_comments_503158.json:
```json
{
    "body": "**Changing commit** from \"[0b3e70d458ef88d610c6883ddedaf19565f7de3a](https://github.com/sagemath/sagetrac-mirror/commit/0b3e70d458ef88d610c6883ddedaf19565f7de3a)\" to \"[372adcb4b2f3de7a230b14f5c275299d7d8c50fc](https://github.com/sagemath/sagetrac-mirror/commit/372adcb4b2f3de7a230b14f5c275299d7d8c50fc)\".",
    "created_at": "2021-02-01T05:54:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503158",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[0b3e70d458ef88d610c6883ddedaf19565f7de3a](https://github.com/sagemath/sagetrac-mirror/commit/0b3e70d458ef88d610c6883ddedaf19565f7de3a)" to "[372adcb4b2f3de7a230b14f5c275299d7d8c50fc](https://github.com/sagemath/sagetrac-mirror/commit/372adcb4b2f3de7a230b14f5c275299d7d8c50fc)".



---

archive/issue_comments_503159.json:
```json
{
    "body": "<a id='comment:64'></a>\nStarted tests at https://github.com/mkoeppe/sage/actions/runs/526769308 but it looks like there is a long wait time to get macos instances",
    "created_at": "2021-02-01T05:56:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503159",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:64'></a>
Started tests at https://github.com/mkoeppe/sage/actions/runs/526769308 but it looks like there is a long wait time to get macos instances



---

archive/issue_comments_503160.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -14,9 +14,9 @@\n ```\n $ /usr/bin/python3 -m sysconfig |grep '\\bCFLAGS ='\n \tCFLAGS = \"-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64\"\n-ARCHFLAGS=\"\" /usr/bin/python3 -m sysconfig |grep '\\bCFLAGS ='\n+\n+$ ARCHFLAGS=\"\" /usr/bin/python3 -m sysconfig |grep '\\bCFLAGS ='\n \tCFLAGS = \"-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers  -arch x86_64 \"\n-egret:~/s/sage/sage-rebasing/worktree-algebraic-2018-spring (t/31132/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_build_when_using_homebrew_s_python3 *\n ```\n \n In this ticket, if the distutils test fails, we try if setting `ARCHFLAGS=\"\"` fixes it. In that case, we store a configuration variable that causes `sage-env` to set `ARCHFLAGS` as well.\n``````\n",
    "created_at": "2021-02-01T05:57:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503160",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -14,9 +14,9 @@
 ```
 $ /usr/bin/python3 -m sysconfig |grep '\bCFLAGS ='
 	CFLAGS = "-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64"
-ARCHFLAGS="" /usr/bin/python3 -m sysconfig |grep '\bCFLAGS ='
+
+$ ARCHFLAGS="" /usr/bin/python3 -m sysconfig |grep '\bCFLAGS ='
 	CFLAGS = "-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers  -arch x86_64 "
-egret:~/s/sage/sage-rebasing/worktree-algebraic-2018-spring (t/31132/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_build_when_using_homebrew_s_python3 *
 ```
 
 In this ticket, if the distutils test fails, we try if setting `ARCHFLAGS=""` fixes it. In that case, we store a configuration variable that causes `sage-env` to set `ARCHFLAGS` as well.
``````




---

archive/issue_comments_503161.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -19,7 +19,10 @@\n \tCFLAGS = \"-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers  -arch x86_64 \"\n ```\n \n-In this ticket, if the distutils test fails, we try if setting `ARCHFLAGS=\"\"` fixes it. In that case, we store a configuration variable that causes `sage-env` to set `ARCHFLAGS` as well.\n+In this ticket, if the distutils test fails, we try if setting `ARCHFLAGS=\"\"` fixes it.  Also, after accepting a system python and `ARCHFLAGS` so far has not been set, we test whether the system python wants to do the multi-arch build.\n \n- \n+In either of these two cases, we store a configuration variable that causes `sage-env` to set `ARCHFLAGS` as well.\n \n+This is somewhat complicated logic - we are tiptoeing around previous breakage that had been caused by setting `ARCHFLAGS` unconditionally (#29408).\n+\n+\n``````\n",
    "created_at": "2021-02-01T06:00:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503161",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -19,7 +19,10 @@
 	CFLAGS = "-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers  -arch x86_64 "
 ```
 
-In this ticket, if the distutils test fails, we try if setting `ARCHFLAGS=""` fixes it. In that case, we store a configuration variable that causes `sage-env` to set `ARCHFLAGS` as well.
+In this ticket, if the distutils test fails, we try if setting `ARCHFLAGS=""` fixes it.  Also, after accepting a system python and `ARCHFLAGS` so far has not been set, we test whether the system python wants to do the multi-arch build.
 
- 
+In either of these two cases, we store a configuration variable that causes `sage-env` to set `ARCHFLAGS` as well.
 
+This is somewhat complicated logic - we are tiptoeing around previous breakage that had been caused by setting `ARCHFLAGS` unconditionally (#29408).
+
+
``````




---

archive/issue_events_378564.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-01T06:05:09Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "rename": {
        "from": "Accept /usr/bin/python3 from XCode 12.3 on macOS 10.15 (Catalina)",
        "to": "Accept /usr/bin/python3 from XCode 12.3 on macOS 10.15 (Catalina) and 11 (Big Sur)"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31227#event-378564"
}
```



---

archive/issue_comments_503162.json:
```json
{
    "body": "<a id='comment:68'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/fc8b67644bada9ea52cbb7c91f53f763ca84f4bb\">fc8b676</a></td><td><code>SAGE_CHECK_PYTHON_FOR_VENV: Rework with less nesting</code></td></tr></table>\n",
    "created_at": "2021-02-01T18:21:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503162",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:68'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/fc8b67644bada9ea52cbb7c91f53f763ca84f4bb">fc8b676</a></td><td><code>SAGE_CHECK_PYTHON_FOR_VENV: Rework with less nesting</code></td></tr></table>




---

archive/issue_comments_503163.json:
```json
{
    "body": "**Changing commit** from \"[372adcb4b2f3de7a230b14f5c275299d7d8c50fc](https://github.com/sagemath/sagetrac-mirror/commit/372adcb4b2f3de7a230b14f5c275299d7d8c50fc)\" to \"[fc8b67644bada9ea52cbb7c91f53f763ca84f4bb](https://github.com/sagemath/sagetrac-mirror/commit/fc8b67644bada9ea52cbb7c91f53f763ca84f4bb)\".",
    "created_at": "2021-02-01T18:21:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503163",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[372adcb4b2f3de7a230b14f5c275299d7d8c50fc](https://github.com/sagemath/sagetrac-mirror/commit/372adcb4b2f3de7a230b14f5c275299d7d8c50fc)" to "[fc8b67644bada9ea52cbb7c91f53f763ca84f4bb](https://github.com/sagemath/sagetrac-mirror/commit/fc8b67644bada9ea52cbb7c91f53f763ca84f4bb)".



---

archive/issue_comments_503164.json:
```json
{
    "body": "<a id='comment:69'></a>\nFor the record, I was able to successfully build sage and documentation with this ticket on Big Sur using \n\n--with-python=/usr/bin/python3",
    "created_at": "2021-02-01T18:30:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503164",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:69'></a>
For the record, I was able to successfully build sage and documentation with this ticket on Big Sur using 

--with-python=/usr/bin/python3



---

archive/issue_comments_503165.json:
```json
{
    "body": "<a id='comment:70'></a>\nThanks for testing!",
    "created_at": "2021-02-01T18:31:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503165",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:70'></a>
Thanks for testing!



---

archive/issue_comments_503166.json:
```json
{
    "body": "<a id='comment:71'></a>\nWorks for me with the system Python 3 on both Big Sur and Catalina.",
    "created_at": "2021-02-01T21:36:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503166",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:71'></a>
Works for me with the system Python 3 on both Big Sur and Catalina.



---

archive/issue_comments_503167.json:
```json
{
    "body": "<a id='comment:72'></a>\nThanks for testing! \n\nLet's deal with issue #31314 (messages from `find_stale_files`) in a follow up.\n\nReady for review?",
    "created_at": "2021-02-01T23:12:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503167",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:72'></a>
Thanks for testing! 

Let's deal with issue #31314 (messages from `find_stale_files`) in a follow up.

Ready for review?



---

archive/issue_comments_503168.json:
```json
{
    "body": "<a id='comment:73'></a>\nReplying to [@mkoeppe](#comment%3A64):\n> Started tests at https://github.com/mkoeppe/sage/actions/runs/526769308 but it looks like there is a long wait time to get macos instances\n\nSome results have been coming in:\n\n- `local-homebrew-macos-10.15-xcode-11.7-{minimal,standard}`: clean\n- `local-homebrew-macos-11.0-xcode-11.7-{minimal,standard}`: Homebrew complains that xcode is too old\n\nStill waiting for the tests with other xcode versions (12.2, 12.3, 12.4). No failures so far.\n\nNote all runs are on `x86_64` - we do not have test infrastructor for `macos-arm64` yet.",
    "created_at": "2021-02-02T01:58:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503168",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:73'></a>
Replying to [@mkoeppe](#comment%3A64):
> Started tests at https://github.com/mkoeppe/sage/actions/runs/526769308 but it looks like there is a long wait time to get macos instances

Some results have been coming in:

- `local-homebrew-macos-10.15-xcode-11.7-{minimal,standard}`: clean
- `local-homebrew-macos-11.0-xcode-11.7-{minimal,standard}`: Homebrew complains that xcode is too old

Still waiting for the tests with other xcode versions (12.2, 12.3, 12.4). No failures so far.

Note all runs are on `x86_64` - we do not have test infrastructor for `macos-arm64` yet.



---

archive/issue_comments_503169.json:
```json
{
    "body": "**Changing reviewer** from \"https://github.com/kliem/sage/pull/36/checks, Jonathan Kliem\" to \"Jonathan Kliem\".",
    "created_at": "2021-02-02T09:17:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503169",
    "user": "https://github.com/kliem"
}
```

**Changing reviewer** from "https://github.com/kliem/sage/pull/36/checks, Jonathan Kliem" to "Jonathan Kliem".



---

archive/issue_comments_503170.json:
```json
{
    "body": "<a id='comment:74'></a>\nI'm happy with this ticket, but I would like another opinion on this.",
    "created_at": "2021-02-02T09:17:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503170",
    "user": "https://github.com/kliem"
}
```

<a id='comment:74'></a>
I'm happy with this ticket, but I would like another opinion on this.



---

archive/issue_comments_503171.json:
```json
{
    "body": "<a id='comment:75'></a>\nOk, I give it another 24 hours. If nobody speaks up, I'll give a positive review (after taking a final look of course).",
    "created_at": "2021-02-02T16:45:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503171",
    "user": "https://github.com/kliem"
}
```

<a id='comment:75'></a>
Ok, I give it another 24 hours. If nobody speaks up, I'll give a positive review (after taking a final look of course).



---

archive/issue_comments_503172.json:
```json
{
    "body": "<a id='comment:76'></a>\nI don't feel like I have enough experience to review this, but it certainly built on Big Sur and Catalina.  I'm going to upgrade Big Sur to 11.2 later and see if this builds on 11.2 as well.",
    "created_at": "2021-02-02T17:03:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503172",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:76'></a>
I don't feel like I have enough experience to review this, but it certainly built on Big Sur and Catalina.  I'm going to upgrade Big Sur to 11.2 later and see if this builds on 11.2 as well.



---

archive/issue_comments_503173.json:
```json
{
    "body": "<a id='comment:77'></a>\nReplying to [@mkoeppe](#comment%3A64):\n> Started tests at https://github.com/mkoeppe/sage/actions/runs/526769308 but it looks like there is a long wait time to get macos instances\n\nSome more results:\n- `local-homebrew-macos-10.15-xcode-{12.2,12.3,12.4}-{minimal,standard}`: clean except for doctest errors from `ld: warning` (#31204)\n- `local-homebrew-macos-11.0-xcode-{12.2,12.3}-minimal`: `scipy` build fails (https://github.com/mkoeppe/sage/runs/1804239019?check_suite_focus=true)\n- `local-homebrew-macos-11.0-xcode-12.3-standard`: clean except for doctest errors from `ld: warning` (#31204)",
    "created_at": "2021-02-02T17:28:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503173",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:77'></a>
Replying to [@mkoeppe](#comment%3A64):
> Started tests at https://github.com/mkoeppe/sage/actions/runs/526769308 but it looks like there is a long wait time to get macos instances

Some more results:
- `local-homebrew-macos-10.15-xcode-{12.2,12.3,12.4}-{minimal,standard}`: clean except for doctest errors from `ld: warning` (#31204)
- `local-homebrew-macos-11.0-xcode-{12.2,12.3}-minimal`: `scipy` build fails (https://github.com/mkoeppe/sage/runs/1804239019?check_suite_focus=true)
- `local-homebrew-macos-11.0-xcode-12.3-standard`: clean except for doctest errors from `ld: warning` (#31204)



---

archive/issue_comments_503174.json:
```json
{
    "body": "<a id='comment:78'></a>\nLet's take care of the `scipy` build failures in #31326.\n\nI think this is sufficient improvement for one ticket.",
    "created_at": "2021-02-02T17:33:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503174",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:78'></a>
Let's take care of the `scipy` build failures in #31326.

I think this is sufficient improvement for one ticket.



---

archive/issue_comments_503175.json:
```json
{
    "body": "<a id='comment:80'></a>\nSeems to work well on Big Sur 11.2 with standard homebrew packages.  When running make ptest I get the annoying warnings:\n\nld: warning: dylib (/usr/local/lib/libgmp.dylib) was built for newer macOS version (10.15) than being linked (10.14.6)\n\nwhich is probably because the MACOSX_DEPLOYMENT_TARGET for /usr/bin/python3 is set to 10.14.6 which doesn't match what Homebrew sets. It's easy enough to eliminate the warnings by setting MACOSX_DEPLOYMENT_TARGET=11.0 before doing all the testing.\n\nOtherwise, everything seems to build/test correctly.",
    "created_at": "2021-02-03T01:04:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503175",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:80'></a>
Seems to work well on Big Sur 11.2 with standard homebrew packages.  When running make ptest I get the annoying warnings:

ld: warning: dylib (/usr/local/lib/libgmp.dylib) was built for newer macOS version (10.15) than being linked (10.14.6)

which is probably because the MACOSX_DEPLOYMENT_TARGET for /usr/bin/python3 is set to 10.14.6 which doesn't match what Homebrew sets. It's easy enough to eliminate the warnings by setting MACOSX_DEPLOYMENT_TARGET=11.0 before doing all the testing.

Otherwise, everything seems to build/test correctly.



---

archive/issue_comments_503176.json:
```json
{
    "body": "<a id='comment:81'></a>\nOk. Thanks for fixing all of this. I think the ticket is a good improvement as it is.",
    "created_at": "2021-02-03T19:02:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503176",
    "user": "https://github.com/kliem"
}
```

<a id='comment:81'></a>
Ok. Thanks for fixing all of this. I think the ticket is a good improvement as it is.



---

archive/issue_events_378565.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-02-03T19:02:29Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31227#event-378565"
}
```



---

archive/issue_events_378566.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-02-03T19:02:29Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31227#event-378566"
}
```



---

archive/issue_comments_503177.json:
```json
{
    "body": "<a id='comment:82'></a>\nThanks!",
    "created_at": "2021-02-03T19:21:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503177",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:82'></a>
Thanks!



---

archive/issue_comments_503178.json:
```json
{
    "body": "**Changing branch** from \"[u/mkoeppe/accept__usr_bin_python3_from_xcode_12_3_on_macos_10_15__catalina_](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/accept__usr_bin_python3_from_xcode_12_3_on_macos_10_15__catalina_)\" to \"[fc8b67644bada9ea52cbb7c91f53f763ca84f4bb](https://github.com/sagemath/sagetrac-mirror/commit/fc8b67644bada9ea52cbb7c91f53f763ca84f4bb)\".",
    "created_at": "2021-02-20T10:46:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31227#issuecomment-503178",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/mkoeppe/accept__usr_bin_python3_from_xcode_12_3_on_macos_10_15__catalina_](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/accept__usr_bin_python3_from_xcode_12_3_on_macos_10_15__catalina_)" to "[fc8b67644bada9ea52cbb7c91f53f763ca84f4bb](https://github.com/sagemath/sagetrac-mirror/commit/fc8b67644bada9ea52cbb7c91f53f763ca84f4bb)".



---

archive/issue_events_378567.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-02-20T10:46:52Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31227#event-378567"
}
```



---

archive/issue_events_378568.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "1a79f3f401122ebb4a50147c9e0c3076d1f12b32",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2021-02-20T10:46:52Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/31227",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31227#event-378568"
}
```
