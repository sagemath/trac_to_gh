# Issue 31643: tab-completion sometimes access attributes

archive/issues_031406.json:
```json
{
    "body": "When jedi is activated, the IPython tab completion tries to access the `__module__` attribute of the tab-completed object\n\n```\nsage: ip = get_ipython()\nsage: ip.Completer.use_jedi = True\nsage: cython(\"\"\"\n....: cdef class A(object):\n....:     def __getattr__(self, key):\n....:         print('getattr(key={})'.format(key))\n....:         raise AttributeError\n....: \"\"\")\nsage: my_custom_name = A()\nsage: ip.Completer.all_completions(\"my_custo\")\ngetattr(key=__module__)\ngetattr(key=__module__)\n['my_custom_name']\n```\nNote that this is very specific to extension classes and works fine with plain Python classes. \n\nYou can see here that it is specific to jedi\n\n```\nsage: ip.Completer.use_jedi = False\nsage: ip.Completer.all_completions(\"my_cu\")\n['my_custom_name']\n```\n\nThis access to the `__module__` attribute has dramatic consequence with lazily imported objects that gets imported when accessing any attribute including `__module__`. In the following example, it even leads to a Sage crash on 9.2.rc3 because of badly designed lazy import\n\n```\nsage: ip.Completer.all_completions(\"s\")\nTraceback (most recent call last):\n...\nAttributeError: module 'sage.coding.linear_code' has no attribute 'self_orthogonal_binary_codes'\n```\n\nHere is the full trace of the calls that lead to the access of `__module__` in the first example above\n\n```\n  File \"/opt/sage/src/bin/sage-ipython\", line 16, in <module>\n    app.start()\n  File \"/opt/sage/local/lib/python3.9/site-packages/IPython/terminal/ipapp.py\", line 356, in start\n    self.shell.mainloop()\n  File \"/opt/sage/local/lib/python3.9/site-packages/IPython/terminal/interactiveshell.py\", line 563, in mainloop\n    self.interact()\n  File \"/opt/sage/local/lib/python3.9/site-packages/IPython/terminal/interactiveshell.py\", line 554, in interact\n    self.run_cell(code, store_history=True)\n  File \"/opt/sage/local/lib/python3.9/site-packages/IPython/core/interactiveshell.py\", line 2866, in run_cell\n    result = self._run_cell(\n  File \"/opt/sage/local/lib/python3.9/site-packages/IPython/core/interactiveshell.py\", line 2895, in _run_cell\n    return runner(coro)\n  File \"/opt/sage/local/lib/python3.9/site-packages/IPython/core/async_helpers.py\", line 68, in _pseudo_sync_runner\n    coro.send(None)\n  File \"/opt/sage/local/lib/python3.9/site-packages/IPython/core/interactiveshell.py\", line 3071, in run_cell_async\n    has_raised = await self.run_ast_nodes(code_ast.body, cell_name,\n  File \"/opt/sage/local/lib/python3.9/site-packages/IPython/core/interactiveshell.py\", line 3263, in run_ast_nodes\n    if (await self.run_code(code, result,  async_=asy)):\n  File \"/opt/sage/local/lib/python3.9/site-packages/IPython/core/interactiveshell.py\", line 3343, in run_code\n    exec(code_obj, self.user_global_ns, self.user_ns)\n  File \"<ipython-input-13-e16cd8a94897>\", line 1, in <module>\n    ip.Completer.all_completions(\"my_cu\")\n  File \"/opt/sage/local/lib/python3.9/site-packages/IPython/core/completer.py\", line 1148, in all_completions\n    return ['.'.join([prefix, c.text]) if prefix and self.use_jedi else c.text\n  File \"/opt/sage/local/lib/python3.9/site-packages/IPython/core/completer.py\", line 1148, in <listcomp>\n    return ['.'.join([prefix, c.text]) if prefix and self.use_jedi else c.text\n  File \"/opt/sage/local/lib/python3.9/site-packages/IPython/core/completer.py\", line 1818, in completions\n    for c in self._completions(text, offset, _timeout=self.jedi_compute_type_timeout/1000):\n  File \"/opt/sage/local/lib/python3.9/site-packages/IPython/core/completer.py\", line 1868, in _completions\n    type_ = jm.type\n  File \"/opt/sage/local/lib/python3.9/site-packages/jedi/api/classes.py\", line 759, in type\n    return super(Completion, self).type\n  File \"/opt/sage/local/lib/python3.9/site-packages/jedi/api/classes.py\", line 192, in type\n    return self._name.api_type\n  File \"/opt/sage/local/lib/python3.9/site-packages/jedi/inference/names.py\", line 612, in __getattr__\n    return getattr(self._wrapped_name, name)\n  File \"/opt/sage/local/lib/python3.9/site-packages/jedi/inference/compiled/value.py\", line 354, in api_type\n    api = self.infer()\n  File \"/opt/sage/local/lib/python3.9/site-packages/jedi/cache.py\", line 111, in wrapper\n    result = method(self, *args, **kwargs)\n  File \"/opt/sage/local/lib/python3.9/site-packages/jedi/inference/compiled/value.py\", line 362, in infer\n    return ValueSet([self.infer_compiled_value()])\n  File \"/opt/sage/local/lib/python3.9/site-packages/jedi/inference/compiled/value.py\", line 365, in infer_compiled_value\n    return create_from_name(self._inference_state, self._parent_value, self.string_name)\n  File \"/opt/sage/local/lib/python3.9/site-packages/jedi/inference/compiled/value.py\", line 591, in create_from_name\n    access_paths = compiled_value.access_handle.getattr_paths(name, default=None)\n  File \"/opt/sage/local/lib/python3.9/site-packages/jedi/inference/compiled/subprocess/__init__.py\", line 400, in _workaround\n    return self._cached_results(name, *args, **kwargs)\n  File \"/opt/sage/local/lib/python3.9/site-packages/jedi/cache.py\", line 111, in wrapper\n    result = method(self, *args, **kwargs)\n  File \"/opt/sage/local/lib/python3.9/site-packages/jedi/inference/compiled/subprocess/__init__.py\", line 404, in _cached_results\n    return self._subprocess.get_compiled_method_return(self.id, name, *args, **kwargs)\n  File \"/opt/sage/local/lib/python3.9/site-packages/jedi/inference/compiled/subprocess/functions.py\", line 24, in get_compiled_method_return\n    return getattr(handle.access, attribute)(*args, **kwargs)\n  File \"/opt/sage/local/lib/python3.9/site-packages/jedi/inference/compiled/access.py\", line 391, in getattr_paths\n    module = inspect.getmodule(return_obj)\n  File \"/usr/lib/python3.9/inspect.py\", line 731, in getmodule\n    if hasattr(object, '__module__'):\n```\n\nCC:  @kliem\n\nUpstream: Not yet reported upstream; Will do shortly.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31643\n\n",
    "created_at": "2021-04-10T20:09:29Z",
    "labels": [
        "component: misc",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "tab-completion sometimes access attributes",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31643",
    "user": "https://github.com/videlec"
}
```
When jedi is activated, the IPython tab completion tries to access the `__module__` attribute of the tab-completed object

```
sage: ip = get_ipython()
sage: ip.Completer.use_jedi = True
sage: cython("""
....: cdef class A(object):
....:     def __getattr__(self, key):
....:         print('getattr(key={})'.format(key))
....:         raise AttributeError
....: """)
sage: my_custom_name = A()
sage: ip.Completer.all_completions("my_custo")
getattr(key=__module__)
getattr(key=__module__)
['my_custom_name']
```
Note that this is very specific to extension classes and works fine with plain Python classes. 

You can see here that it is specific to jedi

```
sage: ip.Completer.use_jedi = False
sage: ip.Completer.all_completions("my_cu")
['my_custom_name']
```

This access to the `__module__` attribute has dramatic consequence with lazily imported objects that gets imported when accessing any attribute including `__module__`. In the following example, it even leads to a Sage crash on 9.2.rc3 because of badly designed lazy import

```
sage: ip.Completer.all_completions("s")
Traceback (most recent call last):
...
AttributeError: module 'sage.coding.linear_code' has no attribute 'self_orthogonal_binary_codes'
```

Here is the full trace of the calls that lead to the access of `__module__` in the first example above

```
  File "/opt/sage/src/bin/sage-ipython", line 16, in <module>
    app.start()
  File "/opt/sage/local/lib/python3.9/site-packages/IPython/terminal/ipapp.py", line 356, in start
    self.shell.mainloop()
  File "/opt/sage/local/lib/python3.9/site-packages/IPython/terminal/interactiveshell.py", line 563, in mainloop
    self.interact()
  File "/opt/sage/local/lib/python3.9/site-packages/IPython/terminal/interactiveshell.py", line 554, in interact
    self.run_cell(code, store_history=True)
  File "/opt/sage/local/lib/python3.9/site-packages/IPython/core/interactiveshell.py", line 2866, in run_cell
    result = self._run_cell(
  File "/opt/sage/local/lib/python3.9/site-packages/IPython/core/interactiveshell.py", line 2895, in _run_cell
    return runner(coro)
  File "/opt/sage/local/lib/python3.9/site-packages/IPython/core/async_helpers.py", line 68, in _pseudo_sync_runner
    coro.send(None)
  File "/opt/sage/local/lib/python3.9/site-packages/IPython/core/interactiveshell.py", line 3071, in run_cell_async
    has_raised = await self.run_ast_nodes(code_ast.body, cell_name,
  File "/opt/sage/local/lib/python3.9/site-packages/IPython/core/interactiveshell.py", line 3263, in run_ast_nodes
    if (await self.run_code(code, result,  async_=asy)):
  File "/opt/sage/local/lib/python3.9/site-packages/IPython/core/interactiveshell.py", line 3343, in run_code
    exec(code_obj, self.user_global_ns, self.user_ns)
  File "<ipython-input-13-e16cd8a94897>", line 1, in <module>
    ip.Completer.all_completions("my_cu")
  File "/opt/sage/local/lib/python3.9/site-packages/IPython/core/completer.py", line 1148, in all_completions
    return ['.'.join([prefix, c.text]) if prefix and self.use_jedi else c.text
  File "/opt/sage/local/lib/python3.9/site-packages/IPython/core/completer.py", line 1148, in <listcomp>
    return ['.'.join([prefix, c.text]) if prefix and self.use_jedi else c.text
  File "/opt/sage/local/lib/python3.9/site-packages/IPython/core/completer.py", line 1818, in completions
    for c in self._completions(text, offset, _timeout=self.jedi_compute_type_timeout/1000):
  File "/opt/sage/local/lib/python3.9/site-packages/IPython/core/completer.py", line 1868, in _completions
    type_ = jm.type
  File "/opt/sage/local/lib/python3.9/site-packages/jedi/api/classes.py", line 759, in type
    return super(Completion, self).type
  File "/opt/sage/local/lib/python3.9/site-packages/jedi/api/classes.py", line 192, in type
    return self._name.api_type
  File "/opt/sage/local/lib/python3.9/site-packages/jedi/inference/names.py", line 612, in __getattr__
    return getattr(self._wrapped_name, name)
  File "/opt/sage/local/lib/python3.9/site-packages/jedi/inference/compiled/value.py", line 354, in api_type
    api = self.infer()
  File "/opt/sage/local/lib/python3.9/site-packages/jedi/cache.py", line 111, in wrapper
    result = method(self, *args, **kwargs)
  File "/opt/sage/local/lib/python3.9/site-packages/jedi/inference/compiled/value.py", line 362, in infer
    return ValueSet([self.infer_compiled_value()])
  File "/opt/sage/local/lib/python3.9/site-packages/jedi/inference/compiled/value.py", line 365, in infer_compiled_value
    return create_from_name(self._inference_state, self._parent_value, self.string_name)
  File "/opt/sage/local/lib/python3.9/site-packages/jedi/inference/compiled/value.py", line 591, in create_from_name
    access_paths = compiled_value.access_handle.getattr_paths(name, default=None)
  File "/opt/sage/local/lib/python3.9/site-packages/jedi/inference/compiled/subprocess/__init__.py", line 400, in _workaround
    return self._cached_results(name, *args, **kwargs)
  File "/opt/sage/local/lib/python3.9/site-packages/jedi/cache.py", line 111, in wrapper
    result = method(self, *args, **kwargs)
  File "/opt/sage/local/lib/python3.9/site-packages/jedi/inference/compiled/subprocess/__init__.py", line 404, in _cached_results
    return self._subprocess.get_compiled_method_return(self.id, name, *args, **kwargs)
  File "/opt/sage/local/lib/python3.9/site-packages/jedi/inference/compiled/subprocess/functions.py", line 24, in get_compiled_method_return
    return getattr(handle.access, attribute)(*args, **kwargs)
  File "/opt/sage/local/lib/python3.9/site-packages/jedi/inference/compiled/access.py", line 391, in getattr_paths
    module = inspect.getmodule(return_obj)
  File "/usr/lib/python3.9/inspect.py", line 731, in getmodule
    if hasattr(object, '__module__'):
```

CC:  @kliem

Upstream: Not yet reported upstream; Will do shortly.

Issue created by migration from https://trac.sagemath.org/ticket/31643





---

archive/issue_events_083347.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-18T16:17:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31643",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31643#event-83347"
}
```



---

archive/issue_events_083348.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-10T17:30:20Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31643",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31643#event-83348"
}
```



---

archive/issue_events_083349.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-10T17:30:20Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31643",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31643#event-83349"
}
```



---

archive/issue_events_083350.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:41:23Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31643",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31643#event-83350"
}
```



---

archive/issue_events_083351.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:41:23Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31643",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31643#event-83351"
}
```



---

archive/issue_events_083352.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31643",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31643#event-83352"
}
```



---

archive/issue_events_083353.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31643",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31643#event-83353"
}
```



---

archive/issue_events_083354.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31643",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31643#event-83354"
}
```



---

archive/issue_events_083355.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31643",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31643#event-83355"
}
```
