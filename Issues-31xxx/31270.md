# Issue 31270: Remove sage-location's "sage-force-relocate" mechanism, fix script to work without SAGE_ROOT

archive/issues_031033.json:
```json
{
    "body": "CC:  @jhpalmieri @culler @dimpase @kiwifb @antonio-rojas @mwageringel\n\n#21783 removes the last productive bit of `sage-location`. The only thing that `sage-location` does now is write a warning if it notices that the tree has moved.\n\nWe want to get rid of the whole mechanism completely.... (or reuse its remains to implement #31076). \n\nIn this ticket, we remove a part of it, the \"sage-force-relocate\" mechanism, which used to be invoked by `sage-spkg`.\n\nWe also fix the script so that it works in installations without `SAGE_ROOT`. This is for the benefit of downstream packaging and #30913.\n\n(When we finally get rid of `sage-location`, we can finally close tickets #15146, #17479, #11755.)\n\nThis is also preparation of sorts for #31076, which proposes to add a different relocation mechanism.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/31270\n\n",
    "closed_at": "2021-01-31T20:53:08Z",
    "created_at": "2021-01-20T23:57:36Z",
    "labels": [
        "component: relocation"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "Remove sage-location's \"sage-force-relocate\" mechanism, fix script to work without SAGE_ROOT",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31270",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @jhpalmieri @culler @dimpase @kiwifb @antonio-rojas @mwageringel

#21783 removes the last productive bit of `sage-location`. The only thing that `sage-location` does now is write a warning if it notices that the tree has moved.

We want to get rid of the whole mechanism completely.... (or reuse its remains to implement #31076). 

In this ticket, we remove a part of it, the "sage-force-relocate" mechanism, which used to be invoked by `sage-spkg`.

We also fix the script so that it works in installations without `SAGE_ROOT`. This is for the benefit of downstream packaging and #30913.

(When we finally get rid of `sage-location`, we can finally close tickets #15146, #17479, #11755.)

This is also preparation of sorts for #31076, which proposes to add a different relocation mechanism.


Issue created by migration from https://trac.sagemath.org/ticket/31270





---

archive/issue_comments_442736.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-21T00:14:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31270#issuecomment-442736",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_442737.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-01-21T00:24:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31270#issuecomment-442737",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_442738.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-21T00:37:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31270#issuecomment-442738",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_442739.json:
```json
{
    "body": "- I don't know how to test whether this will \"fix script to work without SAGE_ROOT\". Maybe the distro people have to look at that part.\n\n- The script's main purpose is to see if Sage has been relocated and then to quit with an error message if so. Do we need to do this? Can we just document that it can't be moved and let it fail however if fails if someone ignores this? That is, can we delete this entirely?",
    "created_at": "2021-01-21T21:57:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31270#issuecomment-442739",
    "user": "https://github.com/jhpalmieri"
}
```

- I don't know how to test whether this will "fix script to work without SAGE_ROOT". Maybe the distro people have to look at that part.

- The script's main purpose is to see if Sage has been relocated and then to quit with an error message if so. Do we need to do this? Can we just document that it can't be moved and let it fail however if fails if someone ignores this? That is, can we delete this entirely?



---

archive/issue_comments_442740.json:
```json
{
    "body": "Replying to [comment:7 jhpalmieri]:\n> - I don't know how to test whether this will \"fix script to work without SAGE_ROOT\". Maybe the distro people have to look at that part.\n\n\nYes, I hope this ticket can reduce the amount of downstream patching",
    "created_at": "2021-01-21T22:03:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31270#issuecomment-442740",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:7 jhpalmieri]:
> - I don't know how to test whether this will "fix script to work without SAGE_ROOT". Maybe the distro people have to look at that part.


Yes, I hope this ticket can reduce the amount of downstream patching



---

archive/issue_comments_442741.json:
```json
{
    "body": "Also: would the check\n\n```\n    if OLD_SAGE_ROOT != SAGE_ROOT:\n```\nbe more robust as\n\n```\n    if not os.path.samefile(OLD_SAGE_ROOT, SAGE_ROOT):\n```\nor `SAGE_ROOT = os.pathlib.Path('...')` followed by `SAGE_ROOT.samefile(...)` or something similar? Maybe we have to handle `None` as a special case.\n\nEdit: typo: should be `samefile`, not `samepath`.",
    "created_at": "2021-01-21T22:04:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31270#issuecomment-442741",
    "user": "https://github.com/jhpalmieri"
}
```

Also: would the check

```
    if OLD_SAGE_ROOT != SAGE_ROOT:
```
be more robust as

```
    if not os.path.samefile(OLD_SAGE_ROOT, SAGE_ROOT):
```
or `SAGE_ROOT = os.pathlib.Path('...')` followed by `SAGE_ROOT.samefile(...)` or something similar? Maybe we have to handle `None` as a special case.

Edit: typo: should be `samefile`, not `samepath`.



---

archive/issue_comments_442742.json:
```json
{
    "body": "Replying to [comment:7 jhpalmieri]:\n> - The script's main purpose is to see if Sage has been relocated and then to quit with an error message if so. Do we need to do this? Can we just document that it can't be moved and let it fail however if fails if someone ignores this? That is, can we delete this entirely?\n\n\nI think there's value in giving a clear error message - removing it could cause more traffic on sage-support",
    "created_at": "2021-01-21T22:07:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31270#issuecomment-442742",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:7 jhpalmieri]:
> - The script's main purpose is to see if Sage has been relocated and then to quit with an error message if so. Do we need to do this? Can we just document that it can't be moved and let it fail however if fails if someone ignores this? That is, can we delete this entirely?


I think there's value in giving a clear error message - removing it could cause more traffic on sage-support



---

archive/issue_comments_442743.json:
```json
{
    "body": "Replying to [comment:9 jhpalmieri]:\n> Also: would the check\n> \n> ```\n>     if OLD_SAGE_ROOT != SAGE_ROOT:\n> ```\n> be more robust as\n> \n> ```\n>     if not os.path.samepath(OLD_SAGE_ROOT, SAGE_ROOT):\n> ```\n> or `SAGE_ROOT = os.pathlib.Path('...')` followed by `SAGE_ROOT.samefile(...)` or something similar? Maybe we have to handle `None` as a special case.\n\n\nYes, this sounds like a good idea.",
    "created_at": "2021-01-21T22:09:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31270#issuecomment-442743",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:9 jhpalmieri]:
> Also: would the check
> 
> ```
>     if OLD_SAGE_ROOT != SAGE_ROOT:
> ```
> be more robust as
> 
> ```
>     if not os.path.samepath(OLD_SAGE_ROOT, SAGE_ROOT):
> ```
> or `SAGE_ROOT = os.pathlib.Path('...')` followed by `SAGE_ROOT.samefile(...)` or something similar? Maybe we have to handle `None` as a special case.


Yes, this sounds like a good idea.



---

archive/issue_comments_442744.json:
```json
{
    "body": "But in fact to make this code really useful, it should be revised to work with `SAGE_LOCAL` instead of `SAGE_ROOT` (see discussion in #30913). So on the present ticket, I wouldn't want to make such improvements",
    "created_at": "2021-01-21T22:14:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31270#issuecomment-442744",
    "user": "https://github.com/mkoeppe"
}
```

But in fact to make this code really useful, it should be revised to work with `SAGE_LOCAL` instead of `SAGE_ROOT` (see discussion in #30913). So on the present ticket, I wouldn't want to make such improvements



---

archive/issue_comments_442745.json:
```json
{
    "body": "I'm not sure what you mean by that, but here is how I would change the file (without worrying about SAGE_ROOT vs. SAGE_LOCAL):\n\n```diff\ndiff --git a/src/bin/sage-location b/src/bin/sage-location\nindex f656dd8f41..e83b06e409 100755\n--- a/src/bin/sage-location\n+++ b/src/bin/sage-location\n@@ -97,15 +97,9 @@ if __name__ == '__main__':\n     # OLD_SAGE_ROOT is None if this is a first-time install.\n     OLD_SAGE_ROOT = read_location_file()\n \n-    if OLD_SAGE_ROOT != SAGE_ROOT:\n-        if OLD_SAGE_ROOT is None:\n-            print(\"This looks like the first time you are running Sage.\")\n-        elif OLD_SAGE_ROOT != SAGE_ROOT:\n-            print(RELOCATION_ERROR.format(OLD_SAGE_ROOT=OLD_SAGE_ROOT, SAGE_ROOT=SAGE_ROOT))\n-            sys.exit(1)\n-        else:\n-            print(\"The Sage installation tree has moved\")\n-            print(\"from %s\" % OLD_SAGE_ROOT)\n-            print(\"  to %s\" % SAGE_ROOT)\n-            assert(False)\n+    if OLD_SAGE_ROOT is None:\n+        print(\"This looks like the first time you are running Sage.\")\n         sage_relocate()\n+    elif not os.path.samefile(OLD_SAGE_ROOT, SAGE_ROOT):\n+        print(RELOCATION_ERROR.format(OLD_SAGE_ROOT=OLD_SAGE_ROOT, SAGE_ROOT=SAGE_ROOT))\n+        sys.exit(1)\n```",
    "created_at": "2021-01-21T22:41:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31270#issuecomment-442745",
    "user": "https://github.com/jhpalmieri"
}
```

I'm not sure what you mean by that, but here is how I would change the file (without worrying about SAGE_ROOT vs. SAGE_LOCAL):

```diff
diff --git a/src/bin/sage-location b/src/bin/sage-location
index f656dd8f41..e83b06e409 100755
--- a/src/bin/sage-location
+++ b/src/bin/sage-location
@@ -97,15 +97,9 @@ if __name__ == '__main__':
     # OLD_SAGE_ROOT is None if this is a first-time install.
     OLD_SAGE_ROOT = read_location_file()
 
-    if OLD_SAGE_ROOT != SAGE_ROOT:
-        if OLD_SAGE_ROOT is None:
-            print("This looks like the first time you are running Sage.")
-        elif OLD_SAGE_ROOT != SAGE_ROOT:
-            print(RELOCATION_ERROR.format(OLD_SAGE_ROOT=OLD_SAGE_ROOT, SAGE_ROOT=SAGE_ROOT))
-            sys.exit(1)
-        else:
-            print("The Sage installation tree has moved")
-            print("from %s" % OLD_SAGE_ROOT)
-            print("  to %s" % SAGE_ROOT)
-            assert(False)
+    if OLD_SAGE_ROOT is None:
+        print("This looks like the first time you are running Sage.")
         sage_relocate()
+    elif not os.path.samefile(OLD_SAGE_ROOT, SAGE_ROOT):
+        print(RELOCATION_ERROR.format(OLD_SAGE_ROOT=OLD_SAGE_ROOT, SAGE_ROOT=SAGE_ROOT))
+        sys.exit(1)
```



---

archive/issue_comments_442746.json:
```json
{
    "body": "This change would be fine with me. In fact, the message \"This looks like the first time you are running Sage.\" can probably be removed. Please feel free to push to the ticket",
    "created_at": "2021-01-21T22:44:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31270#issuecomment-442746",
    "user": "https://github.com/mkoeppe"
}
```

This change would be fine with me. In fact, the message "This looks like the first time you are running Sage." can probably be removed. Please feel free to push to the ticket



---

archive/issue_comments_442747.json:
```json
{
    "body": "Done.\n\n---\nNew commits:",
    "created_at": "2021-01-21T23:03:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31270#issuecomment-442747",
    "user": "https://github.com/jhpalmieri"
}
```

Done.

---
New commits:



---

archive/issue_comments_442748.json:
```json
{
    "body": "Positive review for your changes.",
    "created_at": "2021-01-21T23:17:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31270#issuecomment-442748",
    "user": "https://github.com/mkoeppe"
}
```

Positive review for your changes.



---

archive/issue_comments_442749.json:
```json
{
    "body": "I'm happy with it, too, but as I said, I can't review the parts that claim to work when `SAGE_ROOT` is not defined.",
    "created_at": "2021-01-21T23:26:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31270#issuecomment-442749",
    "user": "https://github.com/jhpalmieri"
}
```

I'm happy with it, too, but as I said, I can't review the parts that claim to work when `SAGE_ROOT` is not defined.



---

archive/issue_comments_442750.json:
```json
{
    "body": "Well, sage-on-gentoo and probably other distros don't bother installing `sage-location`.\n\nBut it looks safe to run on a distro installed sage since we exit straight away on `SAGE_ROOT` being undefined.",
    "created_at": "2021-01-22T00:27:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31270#issuecomment-442750",
    "user": "https://github.com/kiwifb"
}
```

Well, sage-on-gentoo and probably other distros don't bother installing `sage-location`.

But it looks safe to run on a distro installed sage since we exit straight away on `SAGE_ROOT` being undefined.



---

archive/issue_comments_442751.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-01-22T22:19:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31270#issuecomment-442751",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_442752.json:
```json
{
    "body": "I don't speak Italian (despite the last name), but I think we can merge this.",
    "created_at": "2021-01-22T22:19:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31270#issuecomment-442752",
    "user": "https://github.com/jhpalmieri"
}
```

I don't speak Italian (despite the last name), but I think we can merge this.



---

archive/issue_comments_442753.json:
```json
{
    "body": "Thanks!",
    "created_at": "2021-01-22T22:43:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31270#issuecomment-442753",
    "user": "https://github.com/mkoeppe"
}
```

Thanks!



---

archive/issue_events_081777.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-01-31T20:53:08Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31270",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31270#event-81777"
}
```



---

archive/issue_comments_442754.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-01-31T20:53:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31270#issuecomment-442754",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
