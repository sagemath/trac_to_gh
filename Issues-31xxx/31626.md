# Issue 31626: ModuleNotFoundError in doctesting src/sage/misc/sageinspect.py

archive/issues_031389.json:
```json
{
    "body": "The two main failures are:\n\n```\nFile \"src/sage/misc/sageinspect.py\", line 2102, in sage.misc.sageinspect._sage_getsourcelines_name_with_dot\nFailed example:\n    cython('''\n    class A:\n        def __init__(self):\n            \"some init doc\"\n            pass\n    class B:\n        \"some class doc\"\n        class A(A):\n            pass\n    ''')\nException raised:\n    Traceback (most recent call last):\n      File \"/local/sage-git/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 714, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/local/sage-git/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1133, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.misc.sageinspect._sage_getsourcelines_name_with_dot[3]>\", line 1, in <module>\n        cython('''\n      File \"sage/misc/lazy_import.pyx\", line 360, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:4032)\n        return self.get_object()(*args, **kwds)\n      File \"/local/sage-git/sage/local/lib/python3.9/site-packages/sage/misc/cython.py\", line 659, in cython_compile\n        return cython_import_all(tmpfile, get_globals(), **kwds)\n      File \"/local/sage-git/sage/local/lib/python3.9/site-packages/sage/misc/cython.py\", line 549, in cython_import_all\n        m = cython_import(filename, **kwds)\n      File \"/local/sage-git/sage/local/lib/python3.9/site-packages/sage/misc/cython.py\", line 529, in cython_import\n        return builtins.__import__(name)\n    ModuleNotFoundError: No module named '_home_steven__sage_temp_hp_probook_2359_tmp_isl9jpcz_pyx_0'\n```\nand\n\n```\nFile \"src/sage/misc/sageinspect.py\", line 2251, in sage.misc.sageinspect.sage_getsourcelines\nFailed example:\n    cython('''cpdef test_funct(x,y): return''')\nException raised:\n    Traceback (most recent call last):\n      File \"/local/sage-git/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 714, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/local/sage-git/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1133, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.misc.sageinspect.sage_getsourcelines[6]>\", line 1, in <module>\n        cython('''cpdef test_funct(x,y): return''')\n      File \"sage/misc/lazy_import.pyx\", line 360, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:4032)\n        return self.get_object()(*args, **kwds)\n      File \"/local/sage-git/sage/local/lib/python3.9/site-packages/sage/misc/cython.py\", line 659, in cython_compile\n        return cython_import_all(tmpfile, get_globals(), **kwds)\n      File \"/local/sage-git/sage/local/lib/python3.9/site-packages/sage/misc/cython.py\", line 549, in cython_import_all\n        m = cython_import(filename, **kwds)\n      File \"/local/sage-git/sage/local/lib/python3.9/site-packages/sage/misc/cython.py\", line 529, in cython_import\n        return builtins.__import__(name)\n    ModuleNotFoundError: No module named '_home_steven__sage_temp_hp_probook_2359_tmp__qk8dlm5_pyx_0'\n```\n\nHardware:\n\n```\nLinux hp-probook 5.4.97-gentoo-x86_64 #16 SMP Mon Mar 15 21:41:09 MDT 2021 x86_64 AMD Ryzen 7 4700U with Radeon Graphics AuthenticAMD GNU/Linux\n\n04:00.0 Non-Volatile memory controller: Intel Corporation SSD 660P Series (rev 03) (prog-if 02 [NVM Express])\n        Subsystem: Intel Corporation SSD 660P Series\n```\n\n**Branch/Commit:** [c8cfa341a29c563f6814bc25314092de29e6f10e](https://github.com/sagemath/sagetrac-mirror/commit/c8cfa341a29c563f6814bc25314092de29e6f10e)\n\n**Reviewer:** Matthias Koeppe\n\n**Author:** Steven Trogdon\n\nIssue created by migration from https://trac.sagemath.org/ticket/31626\n\n",
    "closed_at": "2022-07-21T21:12:16Z",
    "created_at": "2021-04-08T20:47:31Z",
    "labels": [
        "component: doctest framework",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.7",
    "title": "ModuleNotFoundError in doctesting src/sage/misc/sageinspect.py",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/31626",
    "user": "https://github.com/strogdon"
}
```
The two main failures are:

```
File "src/sage/misc/sageinspect.py", line 2102, in sage.misc.sageinspect._sage_getsourcelines_name_with_dot
Failed example:
    cython('''
    class A:
        def __init__(self):
            "some init doc"
            pass
    class B:
        "some class doc"
        class A(A):
            pass
    ''')
Exception raised:
    Traceback (most recent call last):
      File "/local/sage-git/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/local/sage-git/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.sageinspect._sage_getsourcelines_name_with_dot[3]>", line 1, in <module>
        cython('''
      File "sage/misc/lazy_import.pyx", line 360, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:4032)
        return self.get_object()(*args, **kwds)
      File "/local/sage-git/sage/local/lib/python3.9/site-packages/sage/misc/cython.py", line 659, in cython_compile
        return cython_import_all(tmpfile, get_globals(), **kwds)
      File "/local/sage-git/sage/local/lib/python3.9/site-packages/sage/misc/cython.py", line 549, in cython_import_all
        m = cython_import(filename, **kwds)
      File "/local/sage-git/sage/local/lib/python3.9/site-packages/sage/misc/cython.py", line 529, in cython_import
        return builtins.__import__(name)
    ModuleNotFoundError: No module named '_home_steven__sage_temp_hp_probook_2359_tmp_isl9jpcz_pyx_0'
```
and

```
File "src/sage/misc/sageinspect.py", line 2251, in sage.misc.sageinspect.sage_getsourcelines
Failed example:
    cython('''cpdef test_funct(x,y): return''')
Exception raised:
    Traceback (most recent call last):
      File "/local/sage-git/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/local/sage-git/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.sageinspect.sage_getsourcelines[6]>", line 1, in <module>
        cython('''cpdef test_funct(x,y): return''')
      File "sage/misc/lazy_import.pyx", line 360, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:4032)
        return self.get_object()(*args, **kwds)
      File "/local/sage-git/sage/local/lib/python3.9/site-packages/sage/misc/cython.py", line 659, in cython_compile
        return cython_import_all(tmpfile, get_globals(), **kwds)
      File "/local/sage-git/sage/local/lib/python3.9/site-packages/sage/misc/cython.py", line 549, in cython_import_all
        m = cython_import(filename, **kwds)
      File "/local/sage-git/sage/local/lib/python3.9/site-packages/sage/misc/cython.py", line 529, in cython_import
        return builtins.__import__(name)
    ModuleNotFoundError: No module named '_home_steven__sage_temp_hp_probook_2359_tmp__qk8dlm5_pyx_0'
```

Hardware:

```
Linux hp-probook 5.4.97-gentoo-x86_64 #16 SMP Mon Mar 15 21:41:09 MDT 2021 x86_64 AMD Ryzen 7 4700U with Radeon Graphics AuthenticAMD GNU/Linux

04:00.0 Non-Volatile memory controller: Intel Corporation SSD 660P Series (rev 03) (prog-if 02 [NVM Express])
        Subsystem: Intel Corporation SSD 660P Series
```

**Branch/Commit:** [c8cfa341a29c563f6814bc25314092de29e6f10e](https://github.com/sagemath/sagetrac-mirror/commit/c8cfa341a29c563f6814bc25314092de29e6f10e)

**Reviewer:** Matthias Koeppe

**Author:** Steven Trogdon

Issue created by migration from https://trac.sagemath.org/ticket/31626





---

archive/attachments_022235.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "sageinspect.py.log",
    "asset_url": "tarball://root/attachments/ticket31626/sageinspect.py.log",
    "created_at": "2021-04-08T20:55:02Z",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket31626/sageinspect.py.log",
    "user": "https://github.com/strogdon"
}
```



---

archive/issue_comments_511454.json:
```json
{
    "body": "<a id='comment:1'></a>\n**Attachment:** [sageinspect.py.log](https://github.com/sagemath/sage/files/ticket31626/sageinspect.py.log)\n\nA simple example that demonstrates the failure is:\n\n```\nsage: cython(''' \n....: ''')                                                                                                                                                                                                                                   \n---------------------------------------------------------------------------\nModuleNotFoundError                       Traceback (most recent call last)\n<ipython-input-1-e3fd0203ef75> in <module>\n----> 1 cython('''\n      2 ''')\n\n/local/sage-git/sage/local/lib/python3.9/site-packages/sage/misc/lazy_import.pyx in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:4032)()\n    358             True\n    359         \"\"\"\n--> 360         return self.get_object()(*args, **kwds)\n    361 \n    362     def __repr__(self):\n\n/local/sage-git/sage/local/lib/python3.9/site-packages/sage/misc/cython.py in cython_compile(code, **kwds)\n    657     with open(tmpfile, 'w') as f:\n    658         f.write(code)\n--> 659     return cython_import_all(tmpfile, get_globals(), **kwds)\n    660 \n    661 \n\n/local/sage-git/sage/local/lib/python3.9/site-packages/sage/misc/cython.py in cython_import_all(filename, globals, **kwds)\n    547       code\n    548     \"\"\"\n--> 549     m = cython_import(filename, **kwds)\n    550     for k, x in m.__dict__.items():\n    551         if k[0] != '_':\n\n/local/sage-git/sage/local/lib/python3.9/site-packages/sage/misc/cython.py in cython_import(filename, **kwds)\n    527     try:\n    528         sys.path.append(build_dir)\n--> 529         return builtins.__import__(name)\n    530     finally:\n    531         sys.path = oldpath\n\nModuleNotFoundError: No module named '_home_steven__sage_temp_hp_probook_3426_tmp_p61fqom7_pyx_0'\n```\nwhere the module is present\n\n```\n$ tree -a ~/.sage/temp\n/home/steven/.sage/temp\n\u2514\u2500\u2500 hp-probook\n    \u251c\u2500\u2500 3426\n    \u2502\u00a0\u00a0 \u251c\u2500\u2500 ecl\n    \u2502\u00a0\u00a0 \u251c\u2500\u2500 spyx\n    \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 _home_steven__sage_temp_hp_probook_3426_tmp_p61fqom7_pyx\n    \u2502\u00a0\u00a0 \u2502\u00a0\u00a0     \u251c\u2500\u2500 build\n    \u2502\u00a0\u00a0 \u2502\u00a0\u00a0     \u2502\u00a0\u00a0 \u2514\u2500\u2500 temp.linux-x86_64-3.9\n    \u2502\u00a0\u00a0 \u2502\u00a0\u00a0     \u2502\u00a0\u00a0     \u2514\u2500\u2500 home\n    \u2502\u00a0\u00a0 \u2502\u00a0\u00a0     \u2502\u00a0\u00a0         \u2514\u2500\u2500 steven\n    \u2502\u00a0\u00a0 \u2502\u00a0\u00a0     \u2502\u00a0\u00a0             \u2514\u2500\u2500 .sage\n    \u2502\u00a0\u00a0 \u2502\u00a0\u00a0     \u2502\u00a0\u00a0                 \u2514\u2500\u2500 temp\n    \u2502\u00a0\u00a0 \u2502\u00a0\u00a0     \u2502\u00a0\u00a0                     \u2514\u2500\u2500 hp-probook\n    \u2502\u00a0\u00a0 \u2502\u00a0\u00a0     \u2502\u00a0\u00a0                         \u2514\u2500\u2500 3426\n    \u2502\u00a0\u00a0 \u2502\u00a0\u00a0     \u2502\u00a0\u00a0                             \u2514\u2500\u2500 spyx\n    \u2502\u00a0\u00a0 \u2502\u00a0\u00a0     \u2502\u00a0\u00a0                                 \u2514\u2500\u2500 _home_steven__sage_temp_hp_probook_3426_tmp_p61fqom7_pyx\n    \u2502\u00a0\u00a0 \u2502\u00a0\u00a0     \u2502\u00a0\u00a0                                     \u2514\u2500\u2500 _home_steven__sage_temp_hp_probook_3426_tmp_p61fqom7_pyx_0.o\n    \u2502\u00a0\u00a0 \u2502\u00a0\u00a0     \u251c\u2500\u2500 _home_steven__sage_temp_hp_probook_3426_tmp_p61fqom7_pyx_0.c\n    \u2502\u00a0\u00a0 \u2502\u00a0\u00a0     \u251c\u2500\u2500 _home_steven__sage_temp_hp_probook_3426_tmp_p61fqom7_pyx_0.cpython-39-x86_64-linux-gnu.so\n    \u2502\u00a0\u00a0 \u2502\u00a0\u00a0     \u251c\u2500\u2500 _home_steven__sage_temp_hp_probook_3426_tmp_p61fqom7_pyx_0.err\n    \u2502\u00a0\u00a0 \u2502\u00a0\u00a0     \u251c\u2500\u2500 _home_steven__sage_temp_hp_probook_3426_tmp_p61fqom7_pyx_0.html\n    \u2502\u00a0\u00a0 \u2502\u00a0\u00a0     \u251c\u2500\u2500 _home_steven__sage_temp_hp_probook_3426_tmp_p61fqom7_pyx_0.lis\n    \u2502\u00a0\u00a0 \u2502\u00a0\u00a0     \u2514\u2500\u2500 _home_steven__sage_temp_hp_probook_3426_tmp_p61fqom7_pyx_0.pyx\n    \u2502\u00a0\u00a0 \u2514\u2500\u2500 tmp_p61fqom7.pyx\n    \u251c\u2500\u2500 cleaner.log\n    \u2514\u2500\u2500 cleaner.pid\n```\n\nOccasionally, the above will not fail.",
    "created_at": "2021-04-08T20:55:02Z",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31626#issuecomment-511454",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:1'></a>
**Attachment:** [sageinspect.py.log](https://github.com/sagemath/sage/files/ticket31626/sageinspect.py.log)

A simple example that demonstrates the failure is:

```
sage: cython(''' 
....: ''')                                                                                                                                                                                                                                   
---------------------------------------------------------------------------
ModuleNotFoundError                       Traceback (most recent call last)
<ipython-input-1-e3fd0203ef75> in <module>
----> 1 cython('''
      2 ''')

/local/sage-git/sage/local/lib/python3.9/site-packages/sage/misc/lazy_import.pyx in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:4032)()
    358             True
    359         """
--> 360         return self.get_object()(*args, **kwds)
    361 
    362     def __repr__(self):

/local/sage-git/sage/local/lib/python3.9/site-packages/sage/misc/cython.py in cython_compile(code, **kwds)
    657     with open(tmpfile, 'w') as f:
    658         f.write(code)
--> 659     return cython_import_all(tmpfile, get_globals(), **kwds)
    660 
    661 

/local/sage-git/sage/local/lib/python3.9/site-packages/sage/misc/cython.py in cython_import_all(filename, globals, **kwds)
    547       code
    548     """
--> 549     m = cython_import(filename, **kwds)
    550     for k, x in m.__dict__.items():
    551         if k[0] != '_':

/local/sage-git/sage/local/lib/python3.9/site-packages/sage/misc/cython.py in cython_import(filename, **kwds)
    527     try:
    528         sys.path.append(build_dir)
--> 529         return builtins.__import__(name)
    530     finally:
    531         sys.path = oldpath

ModuleNotFoundError: No module named '_home_steven__sage_temp_hp_probook_3426_tmp_p61fqom7_pyx_0'
```
where the module is present

```
$ tree -a ~/.sage/temp
/home/steven/.sage/temp
└── hp-probook
    ├── 3426
    │   ├── ecl
    │   ├── spyx
    │   │   └── _home_steven__sage_temp_hp_probook_3426_tmp_p61fqom7_pyx
    │   │       ├── build
    │   │       │   └── temp.linux-x86_64-3.9
    │   │       │       └── home
    │   │       │           └── steven
    │   │       │               └── .sage
    │   │       │                   └── temp
    │   │       │                       └── hp-probook
    │   │       │                           └── 3426
    │   │       │                               └── spyx
    │   │       │                                   └── _home_steven__sage_temp_hp_probook_3426_tmp_p61fqom7_pyx
    │   │       │                                       └── _home_steven__sage_temp_hp_probook_3426_tmp_p61fqom7_pyx_0.o
    │   │       ├── _home_steven__sage_temp_hp_probook_3426_tmp_p61fqom7_pyx_0.c
    │   │       ├── _home_steven__sage_temp_hp_probook_3426_tmp_p61fqom7_pyx_0.cpython-39-x86_64-linux-gnu.so
    │   │       ├── _home_steven__sage_temp_hp_probook_3426_tmp_p61fqom7_pyx_0.err
    │   │       ├── _home_steven__sage_temp_hp_probook_3426_tmp_p61fqom7_pyx_0.html
    │   │       ├── _home_steven__sage_temp_hp_probook_3426_tmp_p61fqom7_pyx_0.lis
    │   │       └── _home_steven__sage_temp_hp_probook_3426_tmp_p61fqom7_pyx_0.pyx
    │   └── tmp_p61fqom7.pyx
    ├── cleaner.log
    └── cleaner.pid
```

Occasionally, the above will not fail.



---

archive/issue_comments_511455.json:
```json
{
    "body": "<a id='comment:2'></a>\nUsually the following will not fail\n\n```\nsage: cython(''' \n....: ''', create_local_so_file=True)\nsage:\n```\nbut even this will occasionally fail.",
    "created_at": "2021-04-08T20:59:06Z",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31626#issuecomment-511455",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:2'></a>
Usually the following will not fail

```
sage: cython(''' 
....: ''', create_local_so_file=True)
sage:
```
but even this will occasionally fail.



---

archive/issue_comments_511456.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -55,3 +55,12 @@\n         return builtins.__import__(name)\n     ModuleNotFoundError: No module named '_home_steven__sage_temp_hp_probook_2359_tmp__qk8dlm5_pyx_0'\n ```\n+\n+Hardware:\n+\n+```\n+Linux hp-probook 5.4.97-gentoo-x86_64 #16 SMP Mon Mar 15 21:41:09 MDT 2021 x86_64 AMD Ryzen 7 4700U with Radeon Graphics AuthenticAMD GNU/Linux\n+\n+04:00.0 Non-Volatile memory controller: Intel Corporation SSD 660P Series (rev 03) (prog-if 02 [NVM Express])\n+        Subsystem: Intel Corporation SSD 660P Series\n+```\n``````\n",
    "created_at": "2021-04-08T21:04:03Z",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31626#issuecomment-511456",
    "user": "https://github.com/strogdon"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -55,3 +55,12 @@
         return builtins.__import__(name)
     ModuleNotFoundError: No module named '_home_steven__sage_temp_hp_probook_2359_tmp__qk8dlm5_pyx_0'
 ```
+
+Hardware:
+
+```
+Linux hp-probook 5.4.97-gentoo-x86_64 #16 SMP Mon Mar 15 21:41:09 MDT 2021 x86_64 AMD Ryzen 7 4700U with Radeon Graphics AuthenticAMD GNU/Linux
+
+04:00.0 Non-Volatile memory controller: Intel Corporation SSD 660P Series (rev 03) (prog-if 02 [NVM Express])
+        Subsystem: Intel Corporation SSD 660P Series
+```
``````




---

archive/issue_comments_511457.json:
```json
{
    "body": "<a id='comment:4'></a>\nsee also old ticket #28928",
    "created_at": "2021-04-10T22:47:37Z",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31626#issuecomment-511457",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>
see also old ticket #28928



---

archive/issue_comments_511458.json:
```json
{
    "body": "<a id='comment:5'></a>\nThis hack seems to resolve things here\n\n```diff\ndiff --git a/src/sage/misc/cython.py b/src/sage/misc/cython.py\nindex e72c97f5c3..f77d7d956b 100644\n--- a/src/sage/misc/cython.py\n+++ b/src/sage/misc/cython.py\n@@ -523,6 +523,8 @@ def cython_import(filename, **kwds):\n     \"\"\"\n     name, build_dir = cython(filename, **kwds)\n \n+    build_dir = build_dir + '/'\n+\n     oldpath = sys.path\n     try:\n         sys.path.append(build_dir)\n```\n\n```\n$ ./sage -t src/sage/misc/sageinspect.py \nRunning doctests with ID 2021-04-23-20-30-52-2178c446.\nGit branch: develop\nUsing --optional=build,dochtml,gentoo,pip,sage,sage_spkg\nDoctesting 1 file.\nsage -t --warn-long 95.9 --random-seed=0 src/sage/misc/sageinspect.py\n    [340 tests, 106.40 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 106.7 seconds\n    cpu time: 103.9 seconds\n    cumulative wall time: 106.4 seconds\n```\n\nAnd the [above](https://github.com/sagemath/sage/issues/31626#comment:1) simple example:\n\n```\nsage: import sys                                                                                         \nsage: cython(''' \n....: ''')                                                                                               \nsage: sys.path                                                                                           \n['/local/sage-git/sage/src/bin',\n '/usr/lib/python39.zip',\n '/usr/lib/python3.9',\n '/usr/lib/python3.9/lib-dynload',\n '',\n '/local/sage-git/sage/local/lib/python3.9/site-packages',\n '/local/sage-git/sage/local/lib/python3.9/site-packages/IPython/extensions',\n '/home/steven/.sage/ipython-5.0.0',\n '/home/steven/.sage/temp/hp-probook/10953/spyx/_home_steven__sage_temp_hp_probook_10953_tmp_terjz7ms_pyx/']\nsage:\n```\nSo why is the `/` needed?",
    "created_at": "2021-04-24T02:43:36Z",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31626#issuecomment-511458",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:5'></a>
This hack seems to resolve things here

```diff
diff --git a/src/sage/misc/cython.py b/src/sage/misc/cython.py
index e72c97f5c3..f77d7d956b 100644
--- a/src/sage/misc/cython.py
+++ b/src/sage/misc/cython.py
@@ -523,6 +523,8 @@ def cython_import(filename, **kwds):
     """
     name, build_dir = cython(filename, **kwds)
 
+    build_dir = build_dir + '/'
+
     oldpath = sys.path
     try:
         sys.path.append(build_dir)
```

```
$ ./sage -t src/sage/misc/sageinspect.py 
Running doctests with ID 2021-04-23-20-30-52-2178c446.
Git branch: develop
Using --optional=build,dochtml,gentoo,pip,sage,sage_spkg
Doctesting 1 file.
sage -t --warn-long 95.9 --random-seed=0 src/sage/misc/sageinspect.py
    [340 tests, 106.40 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 106.7 seconds
    cpu time: 103.9 seconds
    cumulative wall time: 106.4 seconds
```

And the [above](https://github.com/sagemath/sage/issues/31626#comment:1) simple example:

```
sage: import sys                                                                                         
sage: cython(''' 
....: ''')                                                                                               
sage: sys.path                                                                                           
['/local/sage-git/sage/src/bin',
 '/usr/lib/python39.zip',
 '/usr/lib/python3.9',
 '/usr/lib/python3.9/lib-dynload',
 '',
 '/local/sage-git/sage/local/lib/python3.9/site-packages',
 '/local/sage-git/sage/local/lib/python3.9/site-packages/IPython/extensions',
 '/home/steven/.sage/ipython-5.0.0',
 '/home/steven/.sage/temp/hp-probook/10953/spyx/_home_steven__sage_temp_hp_probook_10953_tmp_terjz7ms_pyx/']
sage:
```
So why is the `/` needed?



---

archive/issue_comments_511459.json:
```json
{
    "body": "<a id='comment:6'></a>\n\"three dots magic\" is too slow, it costs 130 seconds:\n\n```diff\n--- a/src/sage/misc/sageinspect.py\n+++ b/src/sage/misc/sageinspect.py\n@@ -2276,11 +2276,10 @@\n         ([...'class MPolynomialIdeal( MPolynomialIdeal_singular_repr, \\\\\\n',\n         ...)\n         sage: x = var('x')\n-        sage: sage_getsourcelines(x)\n-        (['cdef class Expression(CommutativeRingElement):\\n',\n-          '    cpdef object pyobject(self):\\n',\n-        ...)\n-        sage: sage_getsourcelines(x)[0][-1]    # last line\n+        sage: lines, lineno = sage_getsourcelines(x); lines[0:2]\n+        ['cdef class Expression(CommutativeRingElement):\\n',\n+         '    cpdef object pyobject(self):\\n']\n+        sage: lines[-1]    # last line\n         '        return S\\n'\n```\n\nbefore:\n\n```\nsage -t --long --random-seed=0 src/sage/misc/sageinspect.py\n    [340 tests, 158.98 s]\n```\nafter:\n\n```\nsage -t --long --random-seed=0 src/sage/misc/sageinspect.py\n    [340 tests, 34.82 s]\n```",
    "created_at": "2021-05-31T14:24:47Z",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31626#issuecomment-511459",
    "user": "https://github.com/sheerluck"
}
```

<a id='comment:6'></a>
"three dots magic" is too slow, it costs 130 seconds:

```diff
--- a/src/sage/misc/sageinspect.py
+++ b/src/sage/misc/sageinspect.py
@@ -2276,11 +2276,10 @@
         ([...'class MPolynomialIdeal( MPolynomialIdeal_singular_repr, \\\n',
         ...)
         sage: x = var('x')
-        sage: sage_getsourcelines(x)
-        (['cdef class Expression(CommutativeRingElement):\n',
-          '    cpdef object pyobject(self):\n',
-        ...)
-        sage: sage_getsourcelines(x)[0][-1]    # last line
+        sage: lines, lineno = sage_getsourcelines(x); lines[0:2]
+        ['cdef class Expression(CommutativeRingElement):\n',
+         '    cpdef object pyobject(self):\n']
+        sage: lines[-1]    # last line
         '        return S\n'
```

before:

```
sage -t --long --random-seed=0 src/sage/misc/sageinspect.py
    [340 tests, 158.98 s]
```
after:

```
sage -t --long --random-seed=0 src/sage/misc/sageinspect.py
    [340 tests, 34.82 s]
```



---

archive/issue_comments_511460.json:
```json
{
    "body": "<a id='comment:7'></a>\nSame basic result here on hardware where there is no `ModuleNotFoundError`:\n\nbefore:\n\n```\nsage -t --long --warn-long 182.5 --random-seed=0 src/sage/misc/sageinspect.py\n    [340 tests, 156.74 s]\n```\n\nafter:\n\n```\nsage -t --long --warn-long 183.3 --random-seed=0 src/sage/misc/sageinspect.py\n    [340 tests, 25.88 s]\n```\n\nHowever, this does not resolve the `ModuleNotFoundError` on the hardware listed in the description.",
    "created_at": "2021-05-31T16:34:07Z",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31626#issuecomment-511460",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:7'></a>
Same basic result here on hardware where there is no `ModuleNotFoundError`:

before:

```
sage -t --long --warn-long 182.5 --random-seed=0 src/sage/misc/sageinspect.py
    [340 tests, 156.74 s]
```

after:

```
sage -t --long --warn-long 183.3 --random-seed=0 src/sage/misc/sageinspect.py
    [340 tests, 25.88 s]
```

However, this does not resolve the `ModuleNotFoundError` on the hardware listed in the description.



---

archive/issue_comments_511461.json:
```json
{
    "body": "<a id='comment:8'></a>\nInvalidating internal caches seems to resolve things here on the machine in the description (see [https://docs.python.org/3/library/importlib.html#importlib.invalidate_caches](https://docs.python.org/3/library/importlib.html#importlib.invalidate_caches)\n\n```diff\n\ndiff --git a/src/sage/misc/cython.py b/src/sage/misc/cython.py\nindex e72c97f5c3..ec67e6042c 100644\n--- a/src/sage/misc/cython.py\n+++ b/src/sage/misc/cython.py\n@@ -526,6 +526,8 @@ def cython_import(filename, **kwds):\n     oldpath = sys.path\n     try:\n         sys.path.append(build_dir)\n+        import importlib\n+        importlib.invalidate_caches()\n         return builtins.__import__(name)\n     finally:\n         sys.path = oldpath\n```\n\nI'm not sure why it's needed nor if this is a proper `fix`, but `sageinspect.py` does not fail with it\n\n```\n$ ./sage -t src/sage/misc/sageinspect.py \nRunning doctests with ID 2021-06-17-15-51-51-0193a7dc.\nGit branch: trac_31626\nUsing --optional=build,dochtml,gentoo,pip,sage,sage_spkg\nDoctesting 1 file.\nsage -t --warn-long 95.3 --random-seed=0 src/sage/misc/sageinspect.py\n    [340 tests, 152.35 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 152.6 seconds\n    cpu time: 149.9 seconds\n    cumulative wall time: 152.4 seconds\nPytest is not installed, skip checking tests that rely on it.\n```",
    "created_at": "2021-06-17T22:02:54Z",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31626#issuecomment-511461",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:8'></a>
Invalidating internal caches seems to resolve things here on the machine in the description (see [https://docs.python.org/3/library/importlib.html#importlib.invalidate_caches](https://docs.python.org/3/library/importlib.html#importlib.invalidate_caches)

```diff

diff --git a/src/sage/misc/cython.py b/src/sage/misc/cython.py
index e72c97f5c3..ec67e6042c 100644
--- a/src/sage/misc/cython.py
+++ b/src/sage/misc/cython.py
@@ -526,6 +526,8 @@ def cython_import(filename, **kwds):
     oldpath = sys.path
     try:
         sys.path.append(build_dir)
+        import importlib
+        importlib.invalidate_caches()
         return builtins.__import__(name)
     finally:
         sys.path = oldpath
```

I'm not sure why it's needed nor if this is a proper `fix`, but `sageinspect.py` does not fail with it

```
$ ./sage -t src/sage/misc/sageinspect.py 
Running doctests with ID 2021-06-17-15-51-51-0193a7dc.
Git branch: trac_31626
Using --optional=build,dochtml,gentoo,pip,sage,sage_spkg
Doctesting 1 file.
sage -t --warn-long 95.3 --random-seed=0 src/sage/misc/sageinspect.py
    [340 tests, 152.35 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 152.6 seconds
    cpu time: 149.9 seconds
    cumulative wall time: 152.4 seconds
Pytest is not installed, skip checking tests that rely on it.
```



---

archive/issue_comments_511462.json:
```json
{
    "body": "<a id='comment:9'></a>\nI actually like it. From https://docs.python.org/3/library/importlib.html :\n\n\"This function should be called if any modules are created/installed while your program is running to guarantee all finders will notice the new module\u2019s existence.\"\n\nSo, it is actually highly appropriate because that's exactly what the code is doing. Create a temporary module and trying to load it.",
    "created_at": "2021-06-17T22:10:50Z",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31626#issuecomment-511462",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:9'></a>
I actually like it. From https://docs.python.org/3/library/importlib.html :

"This function should be called if any modules are created/installed while your program is running to guarantee all finders will notice the new module’s existence."

So, it is actually highly appropriate because that's exactly what the code is doing. Create a temporary module and trying to load it.



---

archive/issue_comments_511463.json:
```json
{
    "body": "**Branch:** [u/strogdon/ModuleNotFound_doctest_sageinspect](https://github.com/sagemath/sagetrac-mirror/tree/u/strogdon/ModuleNotFound_doctest_sageinspect)",
    "created_at": "2021-06-18T15:51:57Z",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31626#issuecomment-511463",
    "user": "https://github.com/strogdon"
}
```

**Branch:** [u/strogdon/ModuleNotFound_doctest_sageinspect](https://github.com/sagemath/sagetrac-mirror/tree/u/strogdon/ModuleNotFound_doctest_sageinspect)



---

archive/issue_comments_511464.json:
```json
{
    "body": "<a id='comment:11'></a>\nPushed the recent suggestion. Let's see what the Bots say - if there are any unintended consequences. This may be difficult to review since the issue seems rare.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/926359ed07b1ec49c646e8f25389f183875f5a8e\">926359e</a></td><td><code>Fix for when cython created temporary modules throw a</code></td></tr></table>\n",
    "created_at": "2021-06-18T15:56:07Z",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31626#issuecomment-511464",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:11'></a>
Pushed the recent suggestion. Let's see what the Bots say - if there are any unintended consequences. This may be difficult to review since the issue seems rare.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/926359ed07b1ec49c646e8f25389f183875f5a8e">926359e</a></td><td><code>Fix for when cython created temporary modules throw a</code></td></tr></table>




---

archive/issue_comments_511465.json:
```json
{
    "body": "**Commit:** [926359ed07b1ec49c646e8f25389f183875f5a8e](https://github.com/sagemath/sagetrac-mirror/commit/926359ed07b1ec49c646e8f25389f183875f5a8e)",
    "created_at": "2021-06-18T15:56:07Z",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31626#issuecomment-511465",
    "user": "https://github.com/strogdon"
}
```

**Commit:** [926359ed07b1ec49c646e8f25389f183875f5a8e](https://github.com/sagemath/sagetrac-mirror/commit/926359ed07b1ec49c646e8f25389f183875f5a8e)



---

archive/issue_events_283971.json:
```json
{
    "actor": "https://github.com/strogdon",
    "created_at": "2021-06-18T15:56:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31626#event-283971"
}
```



---

archive/issue_comments_511466.json:
```json
{
    "body": "**Author:** Steven Trogdon",
    "created_at": "2021-06-18T15:56:07Z",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31626#issuecomment-511466",
    "user": "https://github.com/strogdon"
}
```

**Author:** Steven Trogdon



---

archive/issue_comments_511467.json:
```json
{
    "body": "<a id='comment:12'></a>\nNot every meta path finder\n\n```\nsage: sys.meta_path                                                                                      \n[<class '_frozen_importlib.BuiltinImporter'>,\n <class '_frozen_importlib.FrozenImporter'>,\n <class '_frozen_importlib_external.PathFinder'>,\n <six._SixMetaPathImporter object at 0x7fd4688217c0>]\n```\nhas an `invalidate_caches` attribute, that allows applying the `invalidate_caches()` method. The offending item here is `PathFinder`.\n\n```\nsage: import _frozen_importlib_external                                                                  \nsage: _frozen_importlib_external.PathFinder.__dict__                                                     \nmappingproxy({'__module__': '_frozen_importlib_external',\n              '__doc__': 'Meta path finder for sys.path and package __path__ attributes.',\n              'invalidate_caches': <classmethod object at 0x7fd468c713a0>,\n              '_path_hooks': <classmethod object at 0x7fd468c713d0>,\n              '_path_importer_cache': <classmethod object at 0x7fd468c71400>,\n              '_legacy_get_spec': <classmethod object at 0x7fd468c71430>,\n              '_get_spec': <classmethod object at 0x7fd468c71460>,\n              'find_spec': <classmethod object at 0x7fd468c71490>,\n              'find_module': <classmethod object at 0x7fd468c714c0>,\n              'find_distributions': <classmethod object at 0x7fd468c714f0>,\n              '__dict__': <attribute '__dict__' of 'PathFinder' objects>,\n              '__weakref__': <attribute '__weakref__' of 'PathFinder' objects>})\n```\nThe following achieves the same as this branch\n\n```diff\ndiff --git a/src/sage/misc/cython.py b/src/sage/misc/cython.py\nindex e72c97f5c3..b3fc341b05 100644\n--- a/src/sage/misc/cython.py\n+++ b/src/sage/misc/cython.py\n@@ -526,6 +526,8 @@ def cython_import(filename, **kwds):\n     oldpath = sys.path\n     try:\n         sys.path.append(build_dir)\n+        import _frozen_importlib_external\n+        _frozen_importlib_external.PathFinder.invalidate_caches()\n         return builtins.__import__(name)\n     finally:\n         sys.path = oldpath\n```\nApparently, the `ModuleNotFoundError` is the result of a race condition that can exit on certain archs when a module is created on the fly and then imported. This is a potential `feature` since Python 3.3.",
    "created_at": "2021-06-26T22:13:45Z",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31626#issuecomment-511467",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:12'></a>
Not every meta path finder

```
sage: sys.meta_path                                                                                      
[<class '_frozen_importlib.BuiltinImporter'>,
 <class '_frozen_importlib.FrozenImporter'>,
 <class '_frozen_importlib_external.PathFinder'>,
 <six._SixMetaPathImporter object at 0x7fd4688217c0>]
```
has an `invalidate_caches` attribute, that allows applying the `invalidate_caches()` method. The offending item here is `PathFinder`.

```
sage: import _frozen_importlib_external                                                                  
sage: _frozen_importlib_external.PathFinder.__dict__                                                     
mappingproxy({'__module__': '_frozen_importlib_external',
              '__doc__': 'Meta path finder for sys.path and package __path__ attributes.',
              'invalidate_caches': <classmethod object at 0x7fd468c713a0>,
              '_path_hooks': <classmethod object at 0x7fd468c713d0>,
              '_path_importer_cache': <classmethod object at 0x7fd468c71400>,
              '_legacy_get_spec': <classmethod object at 0x7fd468c71430>,
              '_get_spec': <classmethod object at 0x7fd468c71460>,
              'find_spec': <classmethod object at 0x7fd468c71490>,
              'find_module': <classmethod object at 0x7fd468c714c0>,
              'find_distributions': <classmethod object at 0x7fd468c714f0>,
              '__dict__': <attribute '__dict__' of 'PathFinder' objects>,
              '__weakref__': <attribute '__weakref__' of 'PathFinder' objects>})
```
The following achieves the same as this branch

```diff
diff --git a/src/sage/misc/cython.py b/src/sage/misc/cython.py
index e72c97f5c3..b3fc341b05 100644
--- a/src/sage/misc/cython.py
+++ b/src/sage/misc/cython.py
@@ -526,6 +526,8 @@ def cython_import(filename, **kwds):
     oldpath = sys.path
     try:
         sys.path.append(build_dir)
+        import _frozen_importlib_external
+        _frozen_importlib_external.PathFinder.invalidate_caches()
         return builtins.__import__(name)
     finally:
         sys.path = oldpath
```
Apparently, the `ModuleNotFoundError` is the result of a race condition that can exit on certain archs when a module is created on the fly and then imported. This is a potential `feature` since Python 3.3.



---

archive/issue_comments_511468.json:
```json
{
    "body": "<a id='comment:13'></a>\nI'm convinced that I need to call\n\n```\nimportlib.invalidate_caches()\n```\nin order to get things to work properly. From the documentation there appears to be no harm in making the call. However, it seems that the call is not always needed and making the call unconditionally may introduce overhead. Therefore I propose to make the call conditionally as\n\n```diff\ndiff --git a/src/sage/misc/cython.py b/src/sage/misc/cython.py\nindex 8277842084..822d115660 100644\n--- a/src/sage/misc/cython.py\n+++ b/src/sage/misc/cython.py\n@@ -529,6 +529,10 @@ def cython_import(filename, **kwds):\n     try:\n         sys.path.append(build_dir)\n         return builtins.__import__(name)\n+    except ModuleNotFoundError:\n+        import importlib\n+        importlib.invalidate_caches()\n+        return builtins.__import__(name)\n     finally:\n         sys.path = oldpath\n```\nThis fixed things for me. Comments are welcome.",
    "created_at": "2021-07-27T03:36:30Z",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31626#issuecomment-511468",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:13'></a>
I'm convinced that I need to call

```
importlib.invalidate_caches()
```
in order to get things to work properly. From the documentation there appears to be no harm in making the call. However, it seems that the call is not always needed and making the call unconditionally may introduce overhead. Therefore I propose to make the call conditionally as

```diff
diff --git a/src/sage/misc/cython.py b/src/sage/misc/cython.py
index 8277842084..822d115660 100644
--- a/src/sage/misc/cython.py
+++ b/src/sage/misc/cython.py
@@ -529,6 +529,10 @@ def cython_import(filename, **kwds):
     try:
         sys.path.append(build_dir)
         return builtins.__import__(name)
+    except ModuleNotFoundError:
+        import importlib
+        importlib.invalidate_caches()
+        return builtins.__import__(name)
     finally:
         sys.path = oldpath
```
This fixed things for me. Comments are welcome.



---

archive/issue_events_283972.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-22T20:35:10Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31626#event-283972"
}
```



---

archive/issue_events_283973.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-22T20:35:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31626#event-283973"
}
```



---

archive/issue_events_283974.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:53:12Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31626#event-283974"
}
```



---

archive/issue_events_283975.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:53:12Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31626#event-283975"
}
```



---

archive/issue_comments_511469.json:
```json
{
    "body": "<a id='comment:15'></a>\nStalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.",
    "created_at": "2021-12-18T19:53:12Z",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31626#issuecomment-511469",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:15'></a>
Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.



---

archive/issue_comments_511470.json:
```json
{
    "body": "<a id='comment:16'></a>\nI still get the `ModuleNotFoundError` when doctesting `sageinspect.py` on the indicated hardware. I therefore patch each new beta with\n\n```diff\ndiff --git a/src/sage/misc/cython.py b/src/sage/misc/cython.py\nindex 8277842084..822d115660 100644\n--- a/src/sage/misc/cython.py\n+++ b/src/sage/misc/cython.py\n@@ -529,6 +529,10 @@ def cython_import(filename, **kwds):\n     try:\n         sys.path.append(build_dir)\n         return builtins.__import__(name)\n+    except ModuleNotFoundError:\n+        import importlib\n+        importlib.invalidate_caches()\n+        return builtins.__import__(name)\n     finally:\n         sys.path = oldpath\n```\nAnd this patch is used on Sage-on-Gentoo to avoid the same issue. This ticket's branch is sufficient to remove the issue for me but I believe the above patch to be preferred. Reviewing will be difficult unless someone has the issue.",
    "created_at": "2021-12-18T22:24:36Z",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31626#issuecomment-511470",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:16'></a>
I still get the `ModuleNotFoundError` when doctesting `sageinspect.py` on the indicated hardware. I therefore patch each new beta with

```diff
diff --git a/src/sage/misc/cython.py b/src/sage/misc/cython.py
index 8277842084..822d115660 100644
--- a/src/sage/misc/cython.py
+++ b/src/sage/misc/cython.py
@@ -529,6 +529,10 @@ def cython_import(filename, **kwds):
     try:
         sys.path.append(build_dir)
         return builtins.__import__(name)
+    except ModuleNotFoundError:
+        import importlib
+        importlib.invalidate_caches()
+        return builtins.__import__(name)
     finally:
         sys.path = oldpath
```
And this patch is used on Sage-on-Gentoo to avoid the same issue. This ticket's branch is sufficient to remove the issue for me but I believe the above patch to be preferred. Reviewing will be difficult unless someone has the issue.



---

archive/issue_events_283976.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31626#event-283976"
}
```



---

archive/issue_events_283977.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31626#event-283977"
}
```



---

archive/issue_events_283978.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-07-16T18:07:54Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31626#event-283978"
}
```



---

archive/issue_events_283979.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-07-16T18:07:54Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "label": "needs info",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31626#event-283979"
}
```



---

archive/issue_comments_511471.json:
```json
{
    "body": "<a id='comment:18'></a>\nIs this still needed after #33213?",
    "created_at": "2022-07-16T18:07:54Z",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31626#issuecomment-511471",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:18'></a>
Is this still needed after #33213?



---

archive/issue_comments_511472.json:
```json
{
    "body": "<a id='comment:19'></a>\nReplying to [@mkoeppe](#comment%3A18):\n> Is this still needed after #33213?\n\nStill not fixed here. The following will eventually fail\n\n```\nsage: cython('''\n....: ''')\n---------------------------------------------------------------------------\nModuleNotFoundError                       Traceback (most recent call last)\n<ipython-input-8-e3fd0203ef75> in <module>\n----> 1 cython('''\n      2 ''')\n\n/local/sage-git/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/misc/lazy_import.pyx in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:4241)()\n    388             True\n    389         \"\"\"\n--> 390         return self.get_object()(*args, **kwds)\n    391 \n    392     def __repr__(self):\n\n/local/sage-git/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/misc/cython.py in cython_compile(code, **kwds)\n    658     with open(tmpfile, 'w') as f:\n    659         f.write(code)\n--> 660     return cython_import_all(tmpfile, get_globals(), **kwds)\n    661 \n    662 \n\n/local/sage-git/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/misc/cython.py in cython_import_all(filename, globals, **kwds)\n    548       code\n    549     \"\"\"\n--> 550     m = cython_import(filename, **kwds)\n    551     for k, x in m.__dict__.items():\n    552         if k[0] != '_':\n\n/local/sage-git/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/misc/cython.py in cython_import(filename, **kwds)\n    528     try:\n    529         sys.path.append(build_dir)\n--> 530         return builtins.__import__(name)\n    531     finally:\n    532         sys.path = oldpath\n\nModuleNotFoundError: No module named '_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx_0'\n```\nwith relevant files created\n\n```\n/tmp/tmpe6pubgmm/spyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx_0.c\n/tmp/tmpe6pubgmm/spyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx_0.cpython-310-x86_64-linux-gnu.so\n/tmp/tmpe6pubgmm/spyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx_0.html\n/tmp/tmpe6pubgmm/spyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx_0.pyx\n/tmp/tmpe6pubgmm/spyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx_0.lis\n/tmp/tmpe6pubgmm/spyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx_0.err\n/tmp/tmpe6pubgmm/spyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx/build/temp.linux-x86_64-cpython-310/tmp/tmpe6pubgmm/spyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx_0.o\n```\ncomment:16 still works here.",
    "created_at": "2022-07-16T23:42:48Z",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31626#issuecomment-511472",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:19'></a>
Replying to [@mkoeppe](#comment%3A18):
> Is this still needed after #33213?

Still not fixed here. The following will eventually fail

```
sage: cython('''
....: ''')
---------------------------------------------------------------------------
ModuleNotFoundError                       Traceback (most recent call last)
<ipython-input-8-e3fd0203ef75> in <module>
----> 1 cython('''
      2 ''')

/local/sage-git/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/misc/lazy_import.pyx in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:4241)()
    388             True
    389         """
--> 390         return self.get_object()(*args, **kwds)
    391 
    392     def __repr__(self):

/local/sage-git/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/misc/cython.py in cython_compile(code, **kwds)
    658     with open(tmpfile, 'w') as f:
    659         f.write(code)
--> 660     return cython_import_all(tmpfile, get_globals(), **kwds)
    661 
    662 

/local/sage-git/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/misc/cython.py in cython_import_all(filename, globals, **kwds)
    548       code
    549     """
--> 550     m = cython_import(filename, **kwds)
    551     for k, x in m.__dict__.items():
    552         if k[0] != '_':

/local/sage-git/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/misc/cython.py in cython_import(filename, **kwds)
    528     try:
    529         sys.path.append(build_dir)
--> 530         return builtins.__import__(name)
    531     finally:
    532         sys.path = oldpath

ModuleNotFoundError: No module named '_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx_0'
```
with relevant files created

```
/tmp/tmpe6pubgmm/spyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx_0.c
/tmp/tmpe6pubgmm/spyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx_0.cpython-310-x86_64-linux-gnu.so
/tmp/tmpe6pubgmm/spyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx_0.html
/tmp/tmpe6pubgmm/spyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx_0.pyx
/tmp/tmpe6pubgmm/spyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx_0.lis
/tmp/tmpe6pubgmm/spyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx_0.err
/tmp/tmpe6pubgmm/spyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx/build/temp.linux-x86_64-cpython-310/tmp/tmpe6pubgmm/spyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx_0.o
```
comment:16 still works here.



---

archive/issue_comments_511473.json:
```json
{
    "body": "<a id='comment:20'></a>\ncomment:16 looks like the right fix. Could you update the branch please?",
    "created_at": "2022-07-17T18:31:14Z",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31626#issuecomment-511473",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'></a>
comment:16 looks like the right fix. Could you update the branch please?



---

archive/issue_events_283980.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-07-17T18:31:34Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "label": "needs info",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31626#event-283980"
}
```



---

archive/issue_events_283981.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-07-17T18:31:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31626#event-283981"
}
```



---

archive/issue_comments_511474.json:
```json
{
    "body": "**Changing commit** from \"[926359ed07b1ec49c646e8f25389f183875f5a8e](https://github.com/sagemath/sagetrac-mirror/commit/926359ed07b1ec49c646e8f25389f183875f5a8e)\" to \"[c8cfa341a29c563f6814bc25314092de29e6f10e](https://github.com/sagemath/sagetrac-mirror/commit/c8cfa341a29c563f6814bc25314092de29e6f10e)\".",
    "created_at": "2022-07-18T00:37:54Z",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31626#issuecomment-511474",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[926359ed07b1ec49c646e8f25389f183875f5a8e](https://github.com/sagemath/sagetrac-mirror/commit/926359ed07b1ec49c646e8f25389f183875f5a8e)" to "[c8cfa341a29c563f6814bc25314092de29e6f10e](https://github.com/sagemath/sagetrac-mirror/commit/c8cfa341a29c563f6814bc25314092de29e6f10e)".



---

archive/issue_comments_511475.json:
```json
{
    "body": "<a id='comment:22'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e5273bbd4a7412ec92302f95d4fc67c8179bcc39\">e5273bb</a></td><td><code>Merge branch 'u/strogdon/ModuleNotFound_doctest_sageinspect' of trac.sagemath.org:sage into ModuleNotFound_doctest_sageinspect</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c8cfa341a29c563f6814bc25314092de29e6f10e\">c8cfa34</a></td><td><code>Update ModuleNotFoundError patch</code></td></tr></table>\n",
    "created_at": "2022-07-18T00:37:54Z",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31626#issuecomment-511475",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:22'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e5273bbd4a7412ec92302f95d4fc67c8179bcc39">e5273bb</a></td><td><code>Merge branch 'u/strogdon/ModuleNotFound_doctest_sageinspect' of trac.sagemath.org:sage into ModuleNotFound_doctest_sageinspect</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c8cfa341a29c563f6814bc25314092de29e6f10e">c8cfa34</a></td><td><code>Update ModuleNotFoundError patch</code></td></tr></table>




---

archive/issue_events_283982.json:
```json
{
    "actor": "https://github.com/strogdon",
    "created_at": "2022-07-18T00:39:39Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31626#event-283982"
}
```



---

archive/issue_events_283983.json:
```json
{
    "actor": "https://github.com/strogdon",
    "created_at": "2022-07-18T00:39:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31626#event-283983"
}
```



---

archive/issue_comments_511476.json:
```json
{
    "body": "<a id='comment:23'></a>\npatch updated",
    "created_at": "2022-07-18T00:39:39Z",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31626#issuecomment-511476",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:23'></a>
patch updated



---

archive/issue_events_283984.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-07-18T01:01:59Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31626#event-283984"
}
```



---

archive/issue_events_283985.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-07-18T01:01:59Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31626#event-283985"
}
```



---

archive/issue_comments_511477.json:
```json
{
    "body": "**Reviewer:** Matthias Koeppe",
    "created_at": "2022-07-18T01:01:59Z",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31626#issuecomment-511477",
    "user": "https://github.com/mkoeppe"
}
```

**Reviewer:** Matthias Koeppe



---

archive/issue_comments_511478.json:
```json
{
    "body": "**Changing branch** from \"[u/strogdon/ModuleNotFound_doctest_sageinspect](https://github.com/sagemath/sagetrac-mirror/tree/u/strogdon/ModuleNotFound_doctest_sageinspect)\" to \"[c8cfa341a29c563f6814bc25314092de29e6f10e](https://github.com/sagemath/sagetrac-mirror/commit/c8cfa341a29c563f6814bc25314092de29e6f10e)\".",
    "created_at": "2022-07-21T21:12:16Z",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31626#issuecomment-511478",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/strogdon/ModuleNotFound_doctest_sageinspect](https://github.com/sagemath/sagetrac-mirror/tree/u/strogdon/ModuleNotFound_doctest_sageinspect)" to "[c8cfa341a29c563f6814bc25314092de29e6f10e](https://github.com/sagemath/sagetrac-mirror/commit/c8cfa341a29c563f6814bc25314092de29e6f10e)".



---

archive/issue_events_283986.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-07-21T21:12:16Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31626#event-283986"
}
```



---

archive/issue_events_283987.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "5fc17fd3006bb4d4478f3e50137965d4c8304421",
    "created_at": "2022-07-21T21:12:16Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/31626",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31626#event-283987"
}
```
