# Issue 31567: tox.ini: Add local-macos-nohomebrew environments, deployment targets 10.14, 10.15, 11.1

archive/issues_031330.json:
```json
{
    "body": "This will do a \"best effort\" isolation to avoid using a homebrew installation in `/usr/local` for anything except bootstrapping and unpacking xz tarballs + a little trick for liblzma.h, which is missing on macOS.\n\nTo test:\n\n```\n$ EXTRA_CONFIGURE_ARGS=\"--disable-r\" tox -e local-macos-nohomebrew-python3_xcode\n```\nIt can then be checked that no libraries from /usr/local leak in, using\n\n```\nfind prefix/lib -name \"*.so\" -o -name \"*.dylib*\" -exec otool -L {} \\;\n```\n(Building R is disabled because the R package build still pokes around in /usr/local and finds libintl and liblzma.)\n\nTo set specific deployment targets, use:\n\n```\n$ EXTRA_CONFIGURE_ARGS=\"--disable-r\" tox -e local-macos-10.14-nohomebrew-python3_xcode -- config.status\n$ EXTRA_CONFIGURE_ARGS=\"--disable-r\" tox -e local-macos-10.15-nohomebrew-python3_xcode -- config.status\n$ EXTRA_CONFIGURE_ARGS=\"--disable-r\" tox -e local-macos-11.1-nohomebrew-python3_xcode -- config.status\n```\n\n... and with python3.7 from XCode:\n\n```\n$ tox -e local-macos-10.14-nohomebrew-python3_xcode-python3.7 -- config.status\n```\n(Remove `config.status` from the end of these lines to have the actual build done.)\n\nThese environments allow building Sage for older macOS versions, for example for building a 10.14 distribution on a 10.15 machine. The wheels are then correctly tagged, for example `pplpy-0.8.6-cp38-cp38-macosx_10_14_x86_64.whl`.\n\nCannot go in the opposite direction (building for 11 on a 10.15 machine) -- because pip will refuse to install a previously built wheel that is tagged for 11.)\n\n\nCC:  @jhpalmieri @zlscherr\n\nBranch/Commit: ed1a089963e3215ddfe1216ad01237396364519b\n\nReviewer: John Palmieri\n\nAuthor: Matthias Koeppe\n\nDependencies: #31552, #31562, #31409, #31584\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/31567\n\n",
    "closed_at": "2021-05-27T20:28:46Z",
    "created_at": "2021-03-26T21:36:43Z",
    "labels": [
        "component: porting",
        "critical"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "tox.ini: Add local-macos-nohomebrew environments, deployment targets 10.14, 10.15, 11.1",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31567",
    "user": "https://github.com/mkoeppe"
}
```
This will do a "best effort" isolation to avoid using a homebrew installation in `/usr/local` for anything except bootstrapping and unpacking xz tarballs + a little trick for liblzma.h, which is missing on macOS.

To test:

```
$ EXTRA_CONFIGURE_ARGS="--disable-r" tox -e local-macos-nohomebrew-python3_xcode
```
It can then be checked that no libraries from /usr/local leak in, using

```
find prefix/lib -name "*.so" -o -name "*.dylib*" -exec otool -L {} \;
```
(Building R is disabled because the R package build still pokes around in /usr/local and finds libintl and liblzma.)

To set specific deployment targets, use:

```
$ EXTRA_CONFIGURE_ARGS="--disable-r" tox -e local-macos-10.14-nohomebrew-python3_xcode -- config.status
$ EXTRA_CONFIGURE_ARGS="--disable-r" tox -e local-macos-10.15-nohomebrew-python3_xcode -- config.status
$ EXTRA_CONFIGURE_ARGS="--disable-r" tox -e local-macos-11.1-nohomebrew-python3_xcode -- config.status
```

... and with python3.7 from XCode:

```
$ tox -e local-macos-10.14-nohomebrew-python3_xcode-python3.7 -- config.status
```
(Remove `config.status` from the end of these lines to have the actual build done.)

These environments allow building Sage for older macOS versions, for example for building a 10.14 distribution on a 10.15 machine. The wheels are then correctly tagged, for example `pplpy-0.8.6-cp38-cp38-macosx_10_14_x86_64.whl`.

Cannot go in the opposite direction (building for 11 on a 10.15 machine) -- because pip will refuse to install a previously built wheel that is tagged for 11.)


CC:  @jhpalmieri @zlscherr

Branch/Commit: ed1a089963e3215ddfe1216ad01237396364519b

Reviewer: John Palmieri

Author: Matthias Koeppe

Dependencies: #31552, #31562, #31409, #31584

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/31567





---

archive/issue_comments_627710.json:
```json
{
    "body": "Changing branch from \"\" to \"u/mkoeppe/tox_ini__add_local_macos_nohomebrew_environments\"",
    "created_at": "2021-03-26T23:33:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627710",
    "user": "https://github.com/mkoeppe"
}
```

Changing branch from "" to "u/mkoeppe/tox_ini__add_local_macos_nohomebrew_environments"



---

archive/issue_comments_627711.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-03-27T00:16:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627711",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_627712.json:
```json
{
    "body": "Changing commit from \"\" to \"87e2dbaea7bf8a59d1ecb082871219e530218366\"",
    "created_at": "2021-03-27T00:16:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627712",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "" to "87e2dbaea7bf8a59d1ecb082871219e530218366"



---

archive/issue_comments_627713.json:
```json
{
    "body": "Changing author from \"\" to \"Matthias Koeppe\"",
    "created_at": "2021-03-27T00:28:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627713",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "" to "Matthias Koeppe"



---

archive/issue_comments_627714.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,16 @@\n This will do a \"best effort\" isolation to avoid using a homebrew installation in `/usr/local` for anythings except bootstrapping and perhaps unpacking xz tarballs.\n \n+To test:\n \n+```\n+$ tox -e local-macos-nohomebrew-python3_xcode -- config.status\n+```\n+\n+To set specific deployment targets, use:\n+\n+```\n+$ tox -e local-macos-10.14-nohomebrew-python3_xcode -- config.status\n+$ tox -e local-macos-10.15-nohomebrew-python3_xcode -- config.status\n+$ tox -e local-macos-11.1-nohomebrew-python3_xcode -- config.status\n+```\n+\n``````\n",
    "created_at": "2021-03-27T00:28:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627714",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,16 @@
 This will do a "best effort" isolation to avoid using a homebrew installation in `/usr/local` for anythings except bootstrapping and perhaps unpacking xz tarballs.
 
+To test:
 
+```
+$ tox -e local-macos-nohomebrew-python3_xcode -- config.status
+```
+
+To set specific deployment targets, use:
+
+```
+$ tox -e local-macos-10.14-nohomebrew-python3_xcode -- config.status
+$ tox -e local-macos-10.15-nohomebrew-python3_xcode -- config.status
+$ tox -e local-macos-11.1-nohomebrew-python3_xcode -- config.status
+```
+
``````




---

archive/issue_comments_627715.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -14,3 +14,7 @@\n $ tox -e local-macos-11.1-nohomebrew-python3_xcode -- config.status\n ```\n \n+These environments allow building Sage for older macOS versions, for example for building a 10.14 distribution on a 10.15 machine. The wheels are then correctly tagged, for example `pplpy-0.8.6-cp38-cp38-macosx_10_14_x86_64.whl`.\n+\n+Cannot go in the opposite direction (building for 11 on a 10.15 machine) -- because pip will refuse to install a previously built wheel that is tagged for 11.)\n+\n``````\n",
    "created_at": "2021-03-27T01:45:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627715",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -14,3 +14,7 @@
 $ tox -e local-macos-11.1-nohomebrew-python3_xcode -- config.status
 ```
 
+These environments allow building Sage for older macOS versions, for example for building a 10.14 distribution on a 10.15 machine. The wheels are then correctly tagged, for example `pplpy-0.8.6-cp38-cp38-macosx_10_14_x86_64.whl`.
+
+Cannot go in the opposite direction (building for 11 on a 10.15 machine) -- because pip will refuse to install a previously built wheel that is tagged for 11.)
+
``````




---

archive/issue_comments_627716.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-27T02:21:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627716",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_627717.json:
```json
{
    "body": "Changing commit from \"87e2dbaea7bf8a59d1ecb082871219e530218366\" to \"1ed930292280bd3baa7cb3b72492c966fa204030\"",
    "created_at": "2021-03-27T02:21:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627717",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "87e2dbaea7bf8a59d1ecb082871219e530218366" to "1ed930292280bd3baa7cb3b72492c966fa204030"



---

archive/issue_comments_627718.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-03-27T02:21:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627718",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_627719.json:
```json
{
    "body": "Changing commit from \"1ed930292280bd3baa7cb3b72492c966fa204030\" to \"0458f2309b3f30a9445dd0196a130f4d41dafe44\"",
    "created_at": "2021-03-27T02:21:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627719",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "1ed930292280bd3baa7cb3b72492c966fa204030" to "0458f2309b3f30a9445dd0196a130f4d41dafe44"



---

archive/issue_comments_627720.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-This will do a \"best effort\" isolation to avoid using a homebrew installation in `/usr/local` for anythings except bootstrapping and perhaps unpacking xz tarballs.\n+This will do a \"best effort\" isolation to avoid using a homebrew installation in `/usr/local` for anything except bootstrapping and unpacking xz tarballs + a little trick for liblzma.h, which is missing on macOS.\n \n To test:\n \n``````\n",
    "created_at": "2021-03-27T02:49:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627720",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-This will do a "best effort" isolation to avoid using a homebrew installation in `/usr/local` for anythings except bootstrapping and perhaps unpacking xz tarballs.
+This will do a "best effort" isolation to avoid using a homebrew installation in `/usr/local` for anything except bootstrapping and unpacking xz tarballs + a little trick for liblzma.h, which is missing on macOS.
 
 To test:
 
``````




---

archive/issue_comments_627721.json:
```json
{
    "body": "<a id='comment:8'></a>This is best tested together with #31552, #31562, which do some of the necessary isolation work.\n\nMore isolation work is needed at least for `pillow` and `freetype` - as observed in #31396#comment:32",
    "created_at": "2021-03-27T02:49:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627721",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>This is best tested together with #31552, #31562, which do some of the necessary isolation work.

More isolation work is needed at least for `pillow` and `freetype` - as observed in #31396#comment:32



---

archive/issue_comments_627722.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -14,6 +14,13 @@\n $ tox -e local-macos-11.1-nohomebrew-python3_xcode -- config.status\n ```\n \n+... and with python3.7 from XCode:\n+\n+```\n+tox -e local-macos-10.14-nohomebrew-python3_xcode-python3.7 -- config.status\n+```\n+(Remove `config.status` from the end of these lines to have the actual build done.)\n+\n These environments allow building Sage for older macOS versions, for example for building a 10.14 distribution on a 10.15 machine. The wheels are then correctly tagged, for example `pplpy-0.8.6-cp38-cp38-macosx_10_14_x86_64.whl`.\n \n Cannot go in the opposite direction (building for 11 on a 10.15 machine) -- because pip will refuse to install a previously built wheel that is tagged for 11.)\n``````\n",
    "created_at": "2021-03-27T02:51:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627722",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -14,6 +14,13 @@
 $ tox -e local-macos-11.1-nohomebrew-python3_xcode -- config.status
 ```
 
+... and with python3.7 from XCode:
+
+```
+tox -e local-macos-10.14-nohomebrew-python3_xcode-python3.7 -- config.status
+```
+(Remove `config.status` from the end of these lines to have the actual build done.)
+
 These environments allow building Sage for older macOS versions, for example for building a 10.14 distribution on a 10.15 machine. The wheels are then correctly tagged, for example `pplpy-0.8.6-cp38-cp38-macosx_10_14_x86_64.whl`.
 
 Cannot go in the opposite direction (building for 11 on a 10.15 machine) -- because pip will refuse to install a previously built wheel that is tagged for 11.)
``````




---

archive/issue_comments_627723.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -17,7 +17,7 @@\n ... and with python3.7 from XCode:\n \n ```\n-tox -e local-macos-10.14-nohomebrew-python3_xcode-python3.7 -- config.status\n+$ tox -e local-macos-10.14-nohomebrew-python3_xcode-python3.7 -- config.status\n ```\n (Remove `config.status` from the end of these lines to have the actual build done.)\n \n``````\n",
    "created_at": "2021-03-27T02:52:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627723",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -17,7 +17,7 @@
 ... and with python3.7 from XCode:
 
 ```
-tox -e local-macos-10.14-nohomebrew-python3_xcode-python3.7 -- config.status
+$ tox -e local-macos-10.14-nohomebrew-python3_xcode-python3.7 -- config.status
 ```
 (Remove `config.status` from the end of these lines to have the actual build done.)
 
``````




---

archive/issue_comments_627724.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#31552, #31562\"",
    "created_at": "2021-03-27T03:00:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627724",
    "user": "https://github.com/mkoeppe"
}
```

Changing dependencies from "" to "#31552, #31562"



---

archive/issue_comments_627725.json:
```json
{
    "body": "Changing commit from \"0458f2309b3f30a9445dd0196a130f4d41dafe44\" to \"9d9c562060e86156064f3647e7b223054218c93d\"",
    "created_at": "2021-03-27T03:01:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627725",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "0458f2309b3f30a9445dd0196a130f4d41dafe44" to "9d9c562060e86156064f3647e7b223054218c93d"



---

archive/issue_comments_627726.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-27T03:01:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627726",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_627727.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-03-27T03:09:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627727",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_627728.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-28T00:54:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627728",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_627729.json:
```json
{
    "body": "Changing commit from \"9d9c562060e86156064f3647e7b223054218c93d\" to \"236ea3c0219e5418d244c62d3289e13d14afeee1\"",
    "created_at": "2021-03-28T00:54:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627729",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "9d9c562060e86156064f3647e7b223054218c93d" to "236ea3c0219e5418d244c62d3289e13d14afeee1"



---

archive/issue_comments_627730.json:
```json
{
    "body": "Changing commit from \"236ea3c0219e5418d244c62d3289e13d14afeee1\" to \"92db4e40bf40a73be4570e159c4e5b36c1955451\"",
    "created_at": "2021-03-28T00:55:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627730",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "236ea3c0219e5418d244c62d3289e13d14afeee1" to "92db4e40bf40a73be4570e159c4e5b36c1955451"



---

archive/issue_comments_627731.json:
```json
{
    "body": "<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-03-28T00:55:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627731",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_627732.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -3,15 +3,21 @@\n To test:\n \n ```\n-$ tox -e local-macos-nohomebrew-python3_xcode -- config.status\n+$ EXTRA_CONFIGURE_ARGS=\"--disable-r\" tox -e local-macos-nohomebrew-python3_xcode\n ```\n+It can then be checked that no libraries from /usr/local leak in, using\n+\n+```\n+find prefix/lib -name \"*.so\" -o -name \"*.dylib*\" -exec otool -L {} \\;\n+```\n+(Building R is disabled because the R package build still pokes around in /usr/local and finds libintl and liblzma.)\n \n To set specific deployment targets, use:\n \n ```\n-$ tox -e local-macos-10.14-nohomebrew-python3_xcode -- config.status\n-$ tox -e local-macos-10.15-nohomebrew-python3_xcode -- config.status\n-$ tox -e local-macos-11.1-nohomebrew-python3_xcode -- config.status\n+$ EXTRA_CONFIGURE_ARGS=\"--disable-r\" tox -e local-macos-10.14-nohomebrew-python3_xcode -- config.status\n+$ EXTRA_CONFIGURE_ARGS=\"--disable-r\" tox -e local-macos-10.15-nohomebrew-python3_xcode -- config.status\n+$ EXTRA_CONFIGURE_ARGS=\"--disable-r\" tox -e local-macos-11.1-nohomebrew-python3_xcode -- config.status\n ```\n \n ... and with python3.7 from XCode:\n``````\n",
    "created_at": "2021-03-28T01:47:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627732",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -3,15 +3,21 @@
 To test:
 
 ```
-$ tox -e local-macos-nohomebrew-python3_xcode -- config.status
+$ EXTRA_CONFIGURE_ARGS="--disable-r" tox -e local-macos-nohomebrew-python3_xcode
 ```
+It can then be checked that no libraries from /usr/local leak in, using
+
+```
+find prefix/lib -name "*.so" -o -name "*.dylib*" -exec otool -L {} \;
+```
+(Building R is disabled because the R package build still pokes around in /usr/local and finds libintl and liblzma.)
 
 To set specific deployment targets, use:
 
 ```
-$ tox -e local-macos-10.14-nohomebrew-python3_xcode -- config.status
-$ tox -e local-macos-10.15-nohomebrew-python3_xcode -- config.status
-$ tox -e local-macos-11.1-nohomebrew-python3_xcode -- config.status
+$ EXTRA_CONFIGURE_ARGS="--disable-r" tox -e local-macos-10.14-nohomebrew-python3_xcode -- config.status
+$ EXTRA_CONFIGURE_ARGS="--disable-r" tox -e local-macos-10.15-nohomebrew-python3_xcode -- config.status
+$ EXTRA_CONFIGURE_ARGS="--disable-r" tox -e local-macos-11.1-nohomebrew-python3_xcode -- config.status
 ```
 
 ... and with python3.7 from XCode:
``````




---

archive/issue_comments_627733.json:
```json
{
    "body": "Changing dependencies from \"#31552, #31562\" to \"#31552, #31562, #31409\"",
    "created_at": "2021-03-28T01:47:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627733",
    "user": "https://github.com/mkoeppe"
}
```

Changing dependencies from "#31552, #31562" to "#31552, #31562, #31409"



---

archive/issue_comments_627734.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2021-03-28T01:54:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627734",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_627735.json:
```json
{
    "body": "Changing commit from \"92db4e40bf40a73be4570e159c4e5b36c1955451\" to \"7966b662147c5f58807e0f9492b35c95e9322b36\"",
    "created_at": "2021-03-28T01:54:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627735",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "92db4e40bf40a73be4570e159c4e5b36c1955451" to "7966b662147c5f58807e0f9492b35c95e9322b36"



---

archive/issue_comments_627736.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2021-03-28T01:58:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627736",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_627737.json:
```json
{
    "body": "<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-28T05:50:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627737",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_627738.json:
```json
{
    "body": "Changing commit from \"7966b662147c5f58807e0f9492b35c95e9322b36\" to \"b5edde2e54cc58bd151880293e6454c3f92150fe\"",
    "created_at": "2021-03-28T05:50:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627738",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "7966b662147c5f58807e0f9492b35c95e9322b36" to "b5edde2e54cc58bd151880293e6454c3f92150fe"



---

archive/issue_comments_627739.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-03-28T06:02:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627739",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_627740.json:
```json
{
    "body": "<a id='comment:20'></a>Now pillow does not find zlib",
    "created_at": "2021-03-28T06:02:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627740",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'></a>Now pillow does not find zlib



---

archive/issue_comments_627741.json:
```json
{
    "body": "<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-28T06:43:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627741",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_627742.json:
```json
{
    "body": "Changing commit from \"b5edde2e54cc58bd151880293e6454c3f92150fe\" to \"dffcdbc75e46d08bcb1fd2ac9a5677a7a7312e2f\"",
    "created_at": "2021-03-28T06:43:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627742",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "b5edde2e54cc58bd151880293e6454c3f92150fe" to "dffcdbc75e46d08bcb1fd2ac9a5677a7a7312e2f"



---

archive/issue_comments_627743.json:
```json
{
    "body": "<a id='comment:22'></a>pillow still finds various libraries in `/usr/local` because of very creative discovery code that finds everything in `/usr/local` because we told it that it can have `/usr/local/opt/xz/include` - see `_add_directory` (https://github.com/python-pillow/Pillow/blob/8.1.x/setup.py#L197)",
    "created_at": "2021-03-29T01:26:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627743",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:22'></a>pillow still finds various libraries in `/usr/local` because of very creative discovery code that finds everything in `/usr/local` because we told it that it can have `/usr/local/opt/xz/include` - see `_add_directory` (https://github.com/python-pillow/Pillow/blob/8.1.x/setup.py#L197)



---

archive/issue_comments_627744.json:
```json
{
    "body": "<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-29T01:59:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627744",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_627745.json:
```json
{
    "body": "Changing commit from \"dffcdbc75e46d08bcb1fd2ac9a5677a7a7312e2f\" to \"3779a2525d5bbf0987a1d4ad0e42b73fb5769bc0\"",
    "created_at": "2021-03-29T01:59:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627745",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "dffcdbc75e46d08bcb1fd2ac9a5677a7a7312e2f" to "3779a2525d5bbf0987a1d4ad0e42b73fb5769bc0"



---

archive/issue_comments_627746.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-03-29T02:08:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627746",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_627747.json:
```json
{
    "body": "<a id='comment:24'></a>Fixed pillow. Now I can build a wheel in #31396 that does not have any dependencies on shared libraries in `/usr/local`.",
    "created_at": "2021-03-29T02:08:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627747",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:24'></a>Fixed pillow. Now I can build a wheel in #31396 that does not have any dependencies on shared libraries in `/usr/local`.



---

archive/issue_comments_627748.json:
```json
{
    "body": "<a id='comment:25'></a>For what it's worth, I see a few suspicious items in the log files. (This is on a system with homebrew and with `source .homebrew-build-env` in my shell init file. That may be causing some of these.)\n\n- cvxopt includes flags `-L/usr/local/lib` and `-I/usr/local/include` when calling `gcc`\n- pillow says `Appending path /usr/local/Cellar/xz/5.2.5/include` and then the `gcc` flag `-I/usr/local/Cellar/xz/5.2.5/include`.",
    "created_at": "2021-03-30T22:02:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627748",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:25'></a>For what it's worth, I see a few suspicious items in the log files. (This is on a system with homebrew and with `source .homebrew-build-env` in my shell init file. That may be causing some of these.)

- cvxopt includes flags `-L/usr/local/lib` and `-I/usr/local/include` when calling `gcc`
- pillow says `Appending path /usr/local/Cellar/xz/5.2.5/include` and then the `gcc` flag `-I/usr/local/Cellar/xz/5.2.5/include`.



---

archive/issue_comments_627749.json:
```json
{
    "body": "<a id='comment:26'></a>The xz include is on purpose -- see comment added in `tox.ini`",
    "created_at": "2021-03-30T22:12:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627749",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:26'></a>The xz include is on purpose -- see comment added in `tox.ini`



---

archive/issue_comments_627750.json:
```json
{
    "body": "<a id='comment:27'></a>Replying to [jhpalmieri](#comment%3A25):\n> For what it's worth, I see a few suspicious items in the log files. (This is on a system with homebrew and with `source .homebrew-build-env` in my shell init file. That may be causing some of these.)\n\n\nYes, this a good setting for testing this ticket. The build using tox is designed to be isolated from the effects of `.homebrew-build-env`. \n\n> - cvxopt includes flags `-L/usr/local/lib` and `-I/usr/local/include` when calling `gcc`\n\n\nThis is probably https://github.com/cvxopt/cvxopt/blob/master/setup.py#L55 in combination with a bug in our build system - #31584.",
    "created_at": "2021-03-30T22:39:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627750",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:27'></a>Replying to [jhpalmieri](#comment%3A25):
> For what it's worth, I see a few suspicious items in the log files. (This is on a system with homebrew and with `source .homebrew-build-env` in my shell init file. That may be causing some of these.)


Yes, this a good setting for testing this ticket. The build using tox is designed to be isolated from the effects of `.homebrew-build-env`. 

> - cvxopt includes flags `-L/usr/local/lib` and `-I/usr/local/include` when calling `gcc`


This is probably https://github.com/cvxopt/cvxopt/blob/master/setup.py#L55 in combination with a bug in our build system - #31584.



---

archive/issue_comments_627751.json:
```json
{
    "body": "Changing dependencies from \"#31552, #31562, #31409\" to \"#31552, #31562, #31409, #31584\"",
    "created_at": "2021-03-30T22:46:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627751",
    "user": "https://github.com/mkoeppe"
}
```

Changing dependencies from "#31552, #31562, #31409" to "#31552, #31562, #31409, #31584"



---

archive/issue_comments_627752.json:
```json
{
    "body": "Changing commit from \"3779a2525d5bbf0987a1d4ad0e42b73fb5769bc0\" to \"ed1a089963e3215ddfe1216ad01237396364519b\"",
    "created_at": "2021-03-30T22:56:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627752",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "3779a2525d5bbf0987a1d4ad0e42b73fb5769bc0" to "ed1a089963e3215ddfe1216ad01237396364519b"



---

archive/issue_comments_627753.json:
```json
{
    "body": "<a id='comment:29'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-30T22:56:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627753",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:29'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_627754.json:
```json
{
    "body": "Changing reviewer from \"\" to \"John Palmieri\"",
    "created_at": "2021-03-31T02:04:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627754",
    "user": "https://github.com/jhpalmieri"
}
```

Changing reviewer from "" to "John Palmieri"



---

archive/issue_comments_627755.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-03-31T02:04:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627755",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_627756.json:
```json
{
    "body": "<a id='comment:30'></a>Okay, this looks good to me.",
    "created_at": "2021-03-31T02:04:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627756",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:30'></a>Okay, this looks good to me.



---

archive/issue_comments_627757.json:
```json
{
    "body": "<a id='comment:31'></a>Thanks!",
    "created_at": "2021-03-31T02:11:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627757",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:31'></a>Thanks!



---

archive/issue_comments_627758.json:
```json
{
    "body": "<a id='comment:32'></a>By the way, should commands like `make distclean` also clean the `.tox` directory?",
    "created_at": "2021-03-31T02:35:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627758",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:32'></a>By the way, should commands like `make distclean` also clean the `.tox` directory?



---

archive/issue_comments_627759.json:
```json
{
    "body": "<a id='comment:33'></a>I think it should not because `.tox` is not a \"build artifact\" - if this reasoning makes sense.",
    "created_at": "2021-03-31T02:59:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627759",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:33'></a>I think it should not because `.tox` is not a "build artifact" - if this reasoning makes sense.



---

archive/issue_comments_627760.json:
```json
{
    "body": "<a id='comment:34'></a>That makes sense. Maybe I need to learn more about tox. What command should I use if I want to restart `EXTRA_CONFIGURE_ARGS=\"--disable-r\" tox -e local-macos-nohomebrew-python3_xcode` from scratch? Just delete `.tox/local-macos-nohomebrew-python3`?",
    "created_at": "2021-03-31T16:49:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627760",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:34'></a>That makes sense. Maybe I need to learn more about tox. What command should I use if I want to restart `EXTRA_CONFIGURE_ARGS="--disable-r" tox -e local-macos-nohomebrew-python3_xcode` from scratch? Just delete `.tox/local-macos-nohomebrew-python3`?



---

archive/issue_comments_627761.json:
```json
{
    "body": "<a id='comment:35'></a>Replying to [jhpalmieri](#comment%3A34):\n> That makes sense. Maybe I need to learn more about tox. What command should I use if I want to restart `EXTRA_CONFIGURE_ARGS=\"--disable-r\" tox -e local-macos-nohomebrew-python3_xcode` from scratch? Just delete `.tox/local-macos-nohomebrew-python3`?\n\n\nThat works, but you can also pass the `-r` option to `tox`, which will start from scratch.",
    "created_at": "2021-03-31T16:52:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627761",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:35'></a>Replying to [jhpalmieri](#comment%3A34):
> That makes sense. Maybe I need to learn more about tox. What command should I use if I want to restart `EXTRA_CONFIGURE_ARGS="--disable-r" tox -e local-macos-nohomebrew-python3_xcode` from scratch? Just delete `.tox/local-macos-nohomebrew-python3`?


That works, but you can also pass the `-r` option to `tox`, which will start from scratch.



---

archive/issue_comments_627762.json:
```json
{
    "body": "<a id='comment:36'></a>Great, thanks!",
    "created_at": "2021-03-31T17:21:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627762",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:36'></a>Great, thanks!



---

archive/issue_events_082990.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-18T16:17:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31567#event-82990"
}
```



---

archive/issue_comments_627763.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-05-27T20:28:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627763",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_627764.json:
```json
{
    "body": "Changing branch from \"u/mkoeppe/tox_ini__add_local_macos_nohomebrew_environments\" to \"ed1a089963e3215ddfe1216ad01237396364519b\"",
    "created_at": "2021-05-27T20:28:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31567#issuecomment-627764",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/mkoeppe/tox_ini__add_local_macos_nohomebrew_environments" to "ed1a089963e3215ddfe1216ad01237396364519b"



---

archive/issue_events_082991.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-05-27T20:28:46Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31567",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31567#event-82991"
}
```
