# Issue 31783: Comparison of morphisms is not reliable  and may give wrong answers

archive/issues_031546.json:
```json
{
    "assignees": [],
    "body": "The current generic implementation of `_richcmp_` of morphisms relies on certain assumptions that does not hold in general, and may give mathematically wrong answers. For example, \n\n```\nsage: S.<a,b> = QQ['a,b'].quotient('a*b')\nsage: R.<x> = S[]\nsage: f = R.hom([b], R)\nsage: g = R.hom([b], R) * R.hom(S.hom([-a, b], S), R)\nsage: f == g  # should be False\nTrue\n```\n\nThe aim of this ticket is to reimplement or refactor morphism infrastructure to make comparison of morphisms robust.\n\nThis is a sequel to #28617.\n\nComment of Markus:\n\n>It may be necessary to separate the implementations for rings and modules. For rings, it is enough to check that f and g agree on the generators of the ring and, recursively, on the generators of the base ring. For modules, I am not so sure \u2013 maybe we need to restrict to the case of module homomorphisms and raise a `NotImplementedError` otherwise.\n\n\n\nCC:  @kwankyu @mwageringel @tscrim @roed314\n\nBranch/Commit: **[u/caruso/comparison_hom](https://github.com/sagemath/sagetrac-mirror/tree/u/caruso/comparison_hom) @ [80012e6](https://github.com/sagemath/sagetrac-mirror/commit/80012e6b13405fc460337fde02c59c9a73874de4)**\n\nReviewer: **Travis Scrimshaw**\n\nAuthor: **Xavier Caruso**\n\nComponent: **algebra**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/31783_\n\n",
    "created_at": "2021-05-06T00:13:26Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20algebra",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug",
        "https://github.com/sagemath/sage/labels/needs%20work"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.8",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Comparison of morphisms is not reliable  and may give wrong answers",
    "type": "issue",
    "updated_at": "2022-09-19T18:58:47Z",
    "url": "https://github.com/sagemath/sage/issues/31783",
    "user": "https://github.com/kwankyu"
}
```
The current generic implementation of `_richcmp_` of morphisms relies on certain assumptions that does not hold in general, and may give mathematically wrong answers. For example, 

```
sage: S.<a,b> = QQ['a,b'].quotient('a*b')
sage: R.<x> = S[]
sage: f = R.hom([b], R)
sage: g = R.hom([b], R) * R.hom(S.hom([-a, b], S), R)
sage: f == g  # should be False
True
```

The aim of this ticket is to reimplement or refactor morphism infrastructure to make comparison of morphisms robust.

This is a sequel to #28617.

Comment of Markus:

>It may be necessary to separate the implementations for rings and modules. For rings, it is enough to check that f and g agree on the generators of the ring and, recursively, on the generators of the base ring. For modules, I am not so sure – maybe we need to restrict to the case of module homomorphisms and raise a `NotImplementedError` otherwise.



CC:  @kwankyu @mwageringel @tscrim @roed314

Branch/Commit: **[u/caruso/comparison_hom](https://github.com/sagemath/sagetrac-mirror/tree/u/caruso/comparison_hom) @ [80012e6](https://github.com/sagemath/sagetrac-mirror/commit/80012e6b13405fc460337fde02c59c9a73874de4)**

Reviewer: **Travis Scrimshaw**

Author: **Xavier Caruso**

Component: **algebra**

_Issue created by migration from https://trac.sagemath.org/ticket/31783_





---

archive/issue_events_438365.json:
```json
{
    "actor": "https://github.com/kwankyu",
    "created_at": "2021-05-06T00:13:26Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31783#event-438365"
}
```



---

archive/issue_events_438366.json:
```json
{
    "actor": "https://github.com/kwankyu",
    "created_at": "2021-05-06T00:13:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20algebra",
    "label_color": "0000ff",
    "label_name": "c: algebra",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31783#event-438366"
}
```



---

archive/issue_events_438367.json:
```json
{
    "actor": "https://github.com/kwankyu",
    "created_at": "2021-05-06T00:13:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31783#event-438367"
}
```



---

archive/issue_events_438368.json:
```json
{
    "actor": "https://github.com/kwankyu",
    "created_at": "2021-05-06T00:13:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31783#event-438368"
}
```



---

archive/issue_comments_511211.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -13,4 +13,8 @@\n \n This is a sequel to #28617.\n \n+Comment of Markus:\n \n+>It may be necessary to separate the implementations for rings and modules. For rings, it is enough to check that f and g agree on the generators of the ring and, recursively, on the generators of the base ring. For modules, I am not so sure \u2013 maybe we need to restrict to the case of module homomorphisms and raise a `NotImplementedError` otherwise.\n+\n+\n``````\n",
    "created_at": "2021-05-06T00:25:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511211",
    "user": "https://github.com/kwankyu"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -13,4 +13,8 @@
 
 This is a sequel to #28617.
 
+Comment of Markus:
 
+>It may be necessary to separate the implementations for rings and modules. For rings, it is enough to check that f and g agree on the generators of the ring and, recursively, on the generators of the base ring. For modules, I am not so sure – maybe we need to restrict to the case of module homomorphisms and raise a `NotImplementedError` otherwise.
+
+
``````




---

archive/issue_comments_511212.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-The current generic implementation of `_richcmp_` of morphisms assumes cancellation property on the scalar multiplication of the domain. This assumption that does not hold in general opens the door to mathematically wrong answers. For example, \n+The current generic implementation of `_richcmp_` of morphisms relies on certain assumptions that does not hold in general, and may give mathematically wrong answers. For example, \n \n ```\n sage: S.<a,b> = QQ['a,b'].quotient('a*b')\n``````\n",
    "created_at": "2021-05-06T09:21:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511212",
    "user": "https://github.com/kwankyu"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-The current generic implementation of `_richcmp_` of morphisms assumes cancellation property on the scalar multiplication of the domain. This assumption that does not hold in general opens the door to mathematically wrong answers. For example, 
+The current generic implementation of `_richcmp_` of morphisms relies on certain assumptions that does not hold in general, and may give mathematically wrong answers. For example, 
 
 ```
 sage: S.<a,b> = QQ['a,b'].quotient('a*b')
``````




---

archive/issue_comments_511213.json:
```json
{
    "body": "Branch: **[u/caruso/comparison_hom](https://github.com/sagemath/sagetrac-mirror/tree/u/caruso/comparison_hom)**",
    "created_at": "2021-05-06T23:18:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511213",
    "user": "https://github.com/xcaruso"
}
```

Branch: **[u/caruso/comparison_hom](https://github.com/sagemath/sagetrac-mirror/tree/u/caruso/comparison_hom)**



---

archive/issue_comments_511214.json:
```json
{
    "body": "Commit: **[0aa5099](https://github.com/sagemath/sagetrac-mirror/commit/0aa509913eea741eeb19d259c53d6062a6bdd97b)**",
    "created_at": "2021-05-06T23:21:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511214",
    "user": "https://github.com/xcaruso"
}
```

Commit: **[0aa5099](https://github.com/sagemath/sagetrac-mirror/commit/0aa509913eea741eeb19d259c53d6062a6bdd97b)**



---

archive/issue_comments_511215.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nI set this ticket to \"needs review\" in order to get feedback from the patchbot.",
    "created_at": "2021-05-06T23:21:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511215",
    "user": "https://github.com/xcaruso"
}
```

<div id="comment:4" align="right">comment:4</div>

I set this ticket to "needs review" in order to get feedback from the patchbot.



---

archive/issue_events_438369.json:
```json
{
    "actor": "https://github.com/xcaruso",
    "created_at": "2021-05-06T23:21:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31783#event-438369"
}
```



---

archive/issue_comments_511216.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nWell, maybe the class `RingHomomorphism` is not the right place to add this code since I realized that a lot of ring homomorphisms do not derive for this class. Here are a few examples:\n\n```\nsage: from sage.rings.morphism import RingHomomorphism\nsage: isinstance(ZZ.hom(Zmod(6)), RingHomomorphism)\nFalse\n\nsage: R.<x> = ZZ[]\nsage: isinstance(R.coerce_map_from(ZZ), RingHomomorphism)\nFalse\n```\n\nShould we change this? Or put the comparison code at the level of categories? Other ideas?",
    "created_at": "2021-05-08T08:11:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511216",
    "user": "https://github.com/xcaruso"
}
```

<div id="comment:5" align="right">comment:5</div>

Well, maybe the class `RingHomomorphism` is not the right place to add this code since I realized that a lot of ring homomorphisms do not derive for this class. Here are a few examples:

```
sage: from sage.rings.morphism import RingHomomorphism
sage: isinstance(ZZ.hom(Zmod(6)), RingHomomorphism)
False

sage: R.<x> = ZZ[]
sage: isinstance(R.coerce_map_from(ZZ), RingHomomorphism)
False
```

Should we change this? Or put the comparison code at the level of categories? Other ideas?



---

archive/issue_comments_511217.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nWith the following, this also fixes the problem of #28617, which is really about ring homomorphisms.\n\n```diff\n \n-    def _richcmp_(self, other, int op):\n+    cpdef _richcmp_(self, other, int op):\n         r\"\"\"\n         Compare this ring morphism with ``other``.\n \n-        This is the generic implementation:\n-        we check if both morphisms agree on the generators of the\n-        domain (including generators of successive base rings).\n+        This is a generic implementation. We check if both morphisms agree on\n+        the generators of the domain, including generators of successive base\n+        rings.\n \n         TESTS:\n```",
    "created_at": "2021-05-10T09:45:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511217",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:6" align="right">comment:6</div>

With the following, this also fixes the problem of #28617, which is really about ring homomorphisms.

```diff
 
-    def _richcmp_(self, other, int op):
+    cpdef _richcmp_(self, other, int op):
         r"""
         Compare this ring morphism with ``other``.
 
-        This is the generic implementation:
-        we check if both morphisms agree on the generators of the
-        domain (including generators of successive base rings).
+        This is a generic implementation. We check if both morphisms agree on
+        the generators of the domain, including generators of successive base
+        rings.
 
         TESTS:
```



---

archive/issue_comments_511218.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nReplying to [@xcaruso](#comment:5):\n> Well, maybe the class `RingHomomorphism` is not the right place to add this code since I realized that a lot of ring homomorphisms do not derive for this class. Here are a few examples:\n\nI think it is the right place. Other ring homomorphisms may gradually(later) move to the `RingHomomorphism` class.",
    "created_at": "2021-05-10T09:48:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511218",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:7" align="right">comment:7</div>

Replying to [@xcaruso](#comment:5):
> Well, maybe the class `RingHomomorphism` is not the right place to add this code since I realized that a lot of ring homomorphisms do not derive for this class. Here are a few examples:

I think it is the right place. Other ring homomorphisms may gradually(later) move to the `RingHomomorphism` class.



---

archive/issue_comments_511219.json:
```json
{
    "body": "<div id=\"comment:8\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c8f66b9803e8e64db5ec035cc3cd953d3bb7bbfa\">c8f66b9</a></td><td><code>generic implementation of rich comparison in the class Morphism</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b4b15013a0232916b498f99bb2ba4adc84aa2a0e\">b4b1501</a></td><td><code>implement is_identity and is_coercion_map</code></td></tr></table>\n",
    "created_at": "2021-05-12T10:08:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511219",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:8"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c8f66b9803e8e64db5ec035cc3cd953d3bb7bbfa">c8f66b9</a></td><td><code>generic implementation of rich comparison in the class Morphism</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b4b15013a0232916b498f99bb2ba4adc84aa2a0e">b4b1501</a></td><td><code>implement is_identity and is_coercion_map</code></td></tr></table>




---

archive/issue_comments_511220.json:
```json
{
    "body": "Changed commit from **[0aa5099](https://github.com/sagemath/sagetrac-mirror/commit/0aa509913eea741eeb19d259c53d6062a6bdd97b)** to **[b4b1501](https://github.com/sagemath/sagetrac-mirror/commit/b4b15013a0232916b498f99bb2ba4adc84aa2a0e)**",
    "created_at": "2021-05-12T10:08:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511220",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[0aa5099](https://github.com/sagemath/sagetrac-mirror/commit/0aa509913eea741eeb19d259c53d6062a6bdd97b)** to **[b4b1501](https://github.com/sagemath/sagetrac-mirror/commit/b4b15013a0232916b498f99bb2ba4adc84aa2a0e)**



---

archive/issue_comments_511221.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nThe logic in the class hierarchy of morphisms is sometimes a bit strange (at least I don't always understand it).\n\nIn particular, I cannot understand the difference between the classes `Map` and `Morphism`. At first, I thought that the latter was reserved for mappings preserving some structure whereas the former was used for set-theoretical mappings. But it doesn't seem to be that obvious: for instance, `RingMap` (which is explicitly defined as the set of set-theoretic maps between rings in the documentation) derives from `Morphism` and not from `Map`. Is this a bug or is there some subtlely behind it?",
    "created_at": "2021-05-12T10:16:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511221",
    "user": "https://github.com/xcaruso"
}
```

<div id="comment:9" align="right">comment:9</div>

The logic in the class hierarchy of morphisms is sometimes a bit strange (at least I don't always understand it).

In particular, I cannot understand the difference between the classes `Map` and `Morphism`. At first, I thought that the latter was reserved for mappings preserving some structure whereas the former was used for set-theoretical mappings. But it doesn't seem to be that obvious: for instance, `RingMap` (which is explicitly defined as the set of set-theoretic maps between rings in the documentation) derives from `Morphism` and not from `Map`. Is this a bug or is there some subtlely behind it?



---

archive/issue_comments_511222.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@xcaruso](#comment:9):\n> The logic in the class hierarchy of morphisms is sometimes a bit strange (at least I don't always understand it).\n> \n> In particular, I cannot understand the difference between the classes `Map` and `Morphism`. At first, I thought that the latter was reserved for mappings preserving some structure whereas the former was used for set-theoretical mappings. But it doesn't seem to be that obvious: for instance, `RingMap` (which is explicitly defined as the set of set-theoretic maps between rings in the documentation) derives from `Morphism` and not from `Map`. Is this a bug or is there some subtlely behind it?\n\n`RingMap` is there just to provide the common name \"Set-theoretic ring\". I think the adjective \"set-theoretic\" is meaningless as all ring morphisms are set-theoretic. I guess `RingMap` could equally be `RingMorphism` but the author seems to have preferred `RingMap` as the class name.",
    "created_at": "2021-05-12T11:23:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511222",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@xcaruso](#comment:9):
> The logic in the class hierarchy of morphisms is sometimes a bit strange (at least I don't always understand it).
> 
> In particular, I cannot understand the difference between the classes `Map` and `Morphism`. At first, I thought that the latter was reserved for mappings preserving some structure whereas the former was used for set-theoretical mappings. But it doesn't seem to be that obvious: for instance, `RingMap` (which is explicitly defined as the set of set-theoretic maps between rings in the documentation) derives from `Morphism` and not from `Map`. Is this a bug or is there some subtlely behind it?

`RingMap` is there just to provide the common name "Set-theoretic ring". I think the adjective "set-theoretic" is meaningless as all ring morphisms are set-theoretic. I guess `RingMap` could equally be `RingMorphism` but the author seems to have preferred `RingMap` as the class name.



---

archive/issue_comments_511223.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nBoth `RingMap` and `RingHomomorphism` exist. Reading the documentation, I've understood that `RingMap` should be used for morphism between rings which are not ring homomorphisms (a typical example is the map `GF(p) -> ZZ` taking an integer mod p to its smallest representative).\n\nHowever, I'm not sure there is a real interest to distinguish between `RingMap` and just `Map`.",
    "created_at": "2021-05-12T11:56:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511223",
    "user": "https://github.com/xcaruso"
}
```

<div id="comment:11" align="right">comment:11</div>

Both `RingMap` and `RingHomomorphism` exist. Reading the documentation, I've understood that `RingMap` should be used for morphism between rings which are not ring homomorphisms (a typical example is the map `GF(p) -> ZZ` taking an integer mod p to its smallest representative).

However, I'm not sure there is a real interest to distinguish between `RingMap` and just `Map`.



---

archive/issue_comments_511224.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@xcaruso](#comment:11):\n> However, I'm not sure there is a real interest to distinguish between `RingMap` and just `Map`.\n\nThere could be a performance reason for it as we really want some important rings to have really fast maps (but not necessarily morphisms) between them. I don't know of an explicit example of this, but this might be a reason. Another is that it is just old code that is in need of cleanup.",
    "created_at": "2021-05-13T00:21:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511224",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@xcaruso](#comment:11):
> However, I'm not sure there is a real interest to distinguish between `RingMap` and just `Map`.

There could be a performance reason for it as we really want some important rings to have really fast maps (but not necessarily morphisms) between them. I don't know of an explicit example of this, but this might be a reason. Another is that it is just old code that is in need of cleanup.



---

archive/issue_comments_511225.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nI had a discussion with David Roe on zulip about this ticket.\n\nThe starting point of our discussion is the observation that there are currently two concurrent systems for handling the different types of morphisms provided by Sage: the class hierarchy and the category framework. This causes confusion and sometimes contradiction.\n\nWe believe that it would be great to clarify the situation and clearly separate the roles of these two systems. Roughly speaking, our proposal is to use the class hierarchy to handle different types of implementations and let the category stuff handle mathematical properties of the morphisms.\n\nIn this perspective, we do not want to keep the class `RingHomomorphism` for instance, but want to move the methods therein to the category. Contrarily having special classes for coercion maps or for maps whose domains are polynomial rings continues to make sense.\n\nAny class can implement its own `_richcmp_` method if there is a good reason for (typically a very simple way to compare morphisms of this type). However, a `_richcmp_` method should be also provided by the category and it will be used as a fallback if the class does not provide any specific implementation (or if it returns `NotImplemented`). (Maybe it would be a good idea to have different names for those methods, e.g. `_richcmp_class` and `_richcmp_category`, especially since inheritence with the special method `_richcmp_` seems to work very bizarrely.)\n\nThe same approach could also be used for compositions.\n\nSince this touches a lot of things in the structure of morphisms in Sage, I would appreciate to have your feedback before starting to write code.",
    "created_at": "2021-05-13T22:13:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511225",
    "user": "https://github.com/xcaruso"
}
```

<div id="comment:13" align="right">comment:13</div>

I had a discussion with David Roe on zulip about this ticket.

The starting point of our discussion is the observation that there are currently two concurrent systems for handling the different types of morphisms provided by Sage: the class hierarchy and the category framework. This causes confusion and sometimes contradiction.

We believe that it would be great to clarify the situation and clearly separate the roles of these two systems. Roughly speaking, our proposal is to use the class hierarchy to handle different types of implementations and let the category stuff handle mathematical properties of the morphisms.

In this perspective, we do not want to keep the class `RingHomomorphism` for instance, but want to move the methods therein to the category. Contrarily having special classes for coercion maps or for maps whose domains are polynomial rings continues to make sense.

Any class can implement its own `_richcmp_` method if there is a good reason for (typically a very simple way to compare morphisms of this type). However, a `_richcmp_` method should be also provided by the category and it will be used as a fallback if the class does not provide any specific implementation (or if it returns `NotImplemented`). (Maybe it would be a good idea to have different names for those methods, e.g. `_richcmp_class` and `_richcmp_category`, especially since inheritence with the special method `_richcmp_` seems to work very bizarrely.)

The same approach could also be used for compositions.

Since this touches a lot of things in the structure of morphisms in Sage, I would appreciate to have your feedback before starting to write code.



---

archive/issue_comments_511226.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nAn additional remark I just noticed: related questions were already discussed in #23204.",
    "created_at": "2021-05-13T22:43:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511226",
    "user": "https://github.com/xcaruso"
}
```

<div id="comment:14" align="right">comment:14</div>

An additional remark I just noticed: related questions were already discussed in #23204.



---

archive/issue_comments_511227.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nShort version, see [comment:12](#comment:12).\n\nLong version, overall, I think this would be a great thing to do, but there are a few things to be very careful about in terms of speed regressions. Examples of some rings that should have fast-as-possible maps are polynomial rings and finite fields. Granted, comparing morphism is unlikely to be a bottleneck, but if the whole hierarchy is being redone, some of the methods might get swept up in this as well.\n\nOne sticking point could be that it is very hard to implement generic comparisons at the category level because these comparisons depend strongly on the specific implementation of the morphisms. There is the related issue with the homset parents not having a unique element class as you can want morphisms that behave very differently or needing varying internal structures.\n\nNote that `_richcmp_` is not a special method (as opposed to `__richcmp__`); it follows the usual inheritance. However, many of the morphisms are extension classes, so these actual morphism instances are not dynamically created classes and some magic needs to be done with `__getattr__` in order to check stuff in the category.\n\nMy suggestion would be to map out a little bit about the class and category hierarchy that you want to have with the morphisms for the rings. It doesn't need to be complete, but having a bit of a plan before starting to code could be useful.",
    "created_at": "2021-05-13T23:12:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511227",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:15" align="right">comment:15</div>

Short version, see [comment:12](#comment:12).

Long version, overall, I think this would be a great thing to do, but there are a few things to be very careful about in terms of speed regressions. Examples of some rings that should have fast-as-possible maps are polynomial rings and finite fields. Granted, comparing morphism is unlikely to be a bottleneck, but if the whole hierarchy is being redone, some of the methods might get swept up in this as well.

One sticking point could be that it is very hard to implement generic comparisons at the category level because these comparisons depend strongly on the specific implementation of the morphisms. There is the related issue with the homset parents not having a unique element class as you can want morphisms that behave very differently or needing varying internal structures.

Note that `_richcmp_` is not a special method (as opposed to `__richcmp__`); it follows the usual inheritance. However, many of the morphisms are extension classes, so these actual morphism instances are not dynamically created classes and some magic needs to be done with `__getattr__` in order to check stuff in the category.

My suggestion would be to map out a little bit about the class and category hierarchy that you want to have with the morphisms for the rings. It doesn't need to be complete, but having a bit of a plan before starting to code could be useful.



---

archive/issue_comments_511228.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@tscrim](#comment:15):\n> Short version, see [comment:12](#comment:12).\n\nOh yes, I saw your comment but forgot to answer.\nSince basically the class `RingMap` does nothing more than `Map` except redefining `_repr_type`, I can't believe there is a performance issue here.\n\nBut I agree with you that in general we have to be very careful about this.\n \n> Long version, overall, I think this would be a great thing to do, but there are a few things to be very careful about in terms of speed regressions. Examples of some rings that should have fast-as-possible maps are polynomial rings and finite fields. Granted, comparing morphism is unlikely to be a bottleneck, but if the whole hierarchy is being redone, some of the methods might get swept up in this as well.\n\nThat's a good point.\nEspecially since I've understood (but I might be wrong) that it's not possible to have cython methods in the category. Is this correct?\n\n> One sticking point could be that it is very hard to implement generic comparisons at the category level because these comparisons depend strongly on the specific implementation of the morphisms. There is the related issue with the homset parents not having a unique element class as you can want morphisms that behave very differently or needing varying internal structures.\n\nI think it makes sense at least for some categories.\nFor instance, equalities of ring homomorphisms can be checked by comparing the images of the generators. Again, I might be wrong but I suspect that in most cases, the objects in Sage are finitely generated, so if we have enough information about the underlying structure (which is a priori encoded in the category), implementing a reliable comparison test sounds feasible.\n\n> Note that `_richcmp_` is not a special method (as opposed to `__richcmp__`); it follows the usual inheritance. However, many of the morphisms are extension classes, so these actual morphism instances are not dynamically created classes and some magic needs to be done with `__getattr__` in order to check stuff in the category.\n\nOK. Thanks for the clarification.\nI previously encountered several issues with inheritance of rich comparisons, but it was probably because I was using directly `__richcmp__`.\n\n> My suggestion would be to map out a little bit about the class and category hierarchy that you want to have with the morphisms for the rings. It doesn't need to be complete, but having a bit of a plan before starting to code could be useful.\n\nThat's a good idea. Thanks.",
    "created_at": "2021-05-14T07:57:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511228",
    "user": "https://github.com/xcaruso"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@tscrim](#comment:15):
> Short version, see [comment:12](#comment:12).

Oh yes, I saw your comment but forgot to answer.
Since basically the class `RingMap` does nothing more than `Map` except redefining `_repr_type`, I can't believe there is a performance issue here.

But I agree with you that in general we have to be very careful about this.
 
> Long version, overall, I think this would be a great thing to do, but there are a few things to be very careful about in terms of speed regressions. Examples of some rings that should have fast-as-possible maps are polynomial rings and finite fields. Granted, comparing morphism is unlikely to be a bottleneck, but if the whole hierarchy is being redone, some of the methods might get swept up in this as well.

That's a good point.
Especially since I've understood (but I might be wrong) that it's not possible to have cython methods in the category. Is this correct?

> One sticking point could be that it is very hard to implement generic comparisons at the category level because these comparisons depend strongly on the specific implementation of the morphisms. There is the related issue with the homset parents not having a unique element class as you can want morphisms that behave very differently or needing varying internal structures.

I think it makes sense at least for some categories.
For instance, equalities of ring homomorphisms can be checked by comparing the images of the generators. Again, I might be wrong but I suspect that in most cases, the objects in Sage are finitely generated, so if we have enough information about the underlying structure (which is a priori encoded in the category), implementing a reliable comparison test sounds feasible.

> Note that `_richcmp_` is not a special method (as opposed to `__richcmp__`); it follows the usual inheritance. However, many of the morphisms are extension classes, so these actual morphism instances are not dynamically created classes and some magic needs to be done with `__getattr__` in order to check stuff in the category.

OK. Thanks for the clarification.
I previously encountered several issues with inheritance of rich comparisons, but it was probably because I was using directly `__richcmp__`.

> My suggestion would be to map out a little bit about the class and category hierarchy that you want to have with the morphisms for the rings. It doesn't need to be complete, but having a bit of a plan before starting to code could be useful.

That's a good idea. Thanks.



---

archive/issue_comments_511229.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@xcaruso](#comment:16):\n> Especially since I've understood (but I might be wrong) that it's not possible to have cython methods in the category. Is this correct?\n\nYes, that's correct since categories have to by in Python (IIRC, I think there is a limitation with how things get converted into Cython. Much more certainly, categories cannot be extension classes.)",
    "created_at": "2021-05-17T04:54:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511229",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@xcaruso](#comment:16):
> Especially since I've understood (but I might be wrong) that it's not possible to have cython methods in the category. Is this correct?

Yes, that's correct since categories have to by in Python (IIRC, I think there is a limitation with how things get converted into Cython. Much more certainly, categories cannot be extension classes.)



---

archive/issue_comments_511230.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nAre you going to do this restructuring for this ticket or on a followup ticket?\n\nOne change for this ticket:\n\n```diff\n-Implemented only when the domain has methods `gens` and `base_ring`.\n+Implemented only when the domain has methods ``gens`` and ``base_ring``.\n```\n\nBefore the patchbot will run, the ticket needs an author.",
    "created_at": "2021-05-17T04:58:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511230",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:18" align="right">comment:18</div>

Are you going to do this restructuring for this ticket or on a followup ticket?

One change for this ticket:

```diff
-Implemented only when the domain has methods `gens` and `base_ring`.
+Implemented only when the domain has methods ``gens`` and ``base_ring``.
```

Before the patchbot will run, the ticket needs an author.



---

archive/issue_comments_511231.json:
```json
{
    "body": "<div id=\"comment:19\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2eaab5e5976c125739a56e3abc4e9f9d4591076f\">2eaab5e</a></td><td><code>minor fixes</code></td></tr></table>\n",
    "created_at": "2021-05-18T06:17:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511231",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:19"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2eaab5e5976c125739a56e3abc4e9f9d4591076f">2eaab5e</a></td><td><code>minor fixes</code></td></tr></table>




---

archive/issue_comments_511232.json:
```json
{
    "body": "Changed commit from **[b4b1501](https://github.com/sagemath/sagetrac-mirror/commit/b4b15013a0232916b498f99bb2ba4adc84aa2a0e)** to **[2eaab5e](https://github.com/sagemath/sagetrac-mirror/commit/2eaab5e5976c125739a56e3abc4e9f9d4591076f)**",
    "created_at": "2021-05-18T06:17:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511232",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[b4b1501](https://github.com/sagemath/sagetrac-mirror/commit/b4b15013a0232916b498f99bb2ba4adc84aa2a0e)** to **[2eaab5e](https://github.com/sagemath/sagetrac-mirror/commit/2eaab5e5976c125739a56e3abc4e9f9d4591076f)**



---

archive/issue_comments_511233.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nMy initial plan was to put all the changes in this ticket but, thinking again at it, I think you're right, it's better to open a new ticket.",
    "created_at": "2021-05-18T06:19:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511233",
    "user": "https://github.com/xcaruso"
}
```

<div id="comment:20" align="right">comment:20</div>

My initial plan was to put all the changes in this ticket but, thinking again at it, I think you're right, it's better to open a new ticket.



---

archive/issue_comments_511234.json:
```json
{
    "body": "Author: **Xavier Caruso**",
    "created_at": "2021-05-18T06:19:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511234",
    "user": "https://github.com/xcaruso"
}
```

Author: **Xavier Caruso**



---

archive/issue_comments_511235.json:
```json
{
    "body": "Changed commit from **[2eaab5e](https://github.com/sagemath/sagetrac-mirror/commit/2eaab5e5976c125739a56e3abc4e9f9d4591076f)** to **[c989d1e](https://github.com/sagemath/sagetrac-mirror/commit/c989d1e36fd166ae5df91669da02fdf670ca518c)**",
    "created_at": "2021-05-18T07:03:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511235",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[2eaab5e](https://github.com/sagemath/sagetrac-mirror/commit/2eaab5e5976c125739a56e3abc4e9f9d4591076f)** to **[c989d1e](https://github.com/sagemath/sagetrac-mirror/commit/c989d1e36fd166ae5df91669da02fdf670ca518c)**



---

archive/issue_comments_511236.json:
```json
{
    "body": "<div id=\"comment:21\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c989d1e36fd166ae5df91669da02fdf670ca518c\">c989d1e</a></td><td><code>fix doctest</code></td></tr></table>\n",
    "created_at": "2021-05-18T07:03:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511236",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:21"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c989d1e36fd166ae5df91669da02fdf670ca518c">c989d1e</a></td><td><code>fix doctest</code></td></tr></table>




---

archive/issue_comments_511237.json:
```json
{
    "body": "<div id=\"comment:22\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/01736aac202b9d456485b1a401d04a89f7eff833\">01736aa</a></td><td><code>more typos</code></td></tr></table>\n",
    "created_at": "2021-05-18T07:17:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511237",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:22"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/01736aac202b9d456485b1a401d04a89f7eff833">01736aa</a></td><td><code>more typos</code></td></tr></table>




---

archive/issue_comments_511238.json:
```json
{
    "body": "Changed commit from **[c989d1e](https://github.com/sagemath/sagetrac-mirror/commit/c989d1e36fd166ae5df91669da02fdf670ca518c)** to **[01736aa](https://github.com/sagemath/sagetrac-mirror/commit/01736aac202b9d456485b1a401d04a89f7eff833)**",
    "created_at": "2021-05-18T07:17:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511238",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[c989d1e](https://github.com/sagemath/sagetrac-mirror/commit/c989d1e36fd166ae5df91669da02fdf670ca518c)** to **[01736aa](https://github.com/sagemath/sagetrac-mirror/commit/01736aac202b9d456485b1a401d04a89f7eff833)**



---

archive/issue_comments_511239.json:
```json
{
    "body": "<div id=\"comment:23\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c9547e6dace9f9d2e2ff8279ee4882c12213c4aa\">c9547e6</a></td><td><code>handle the case where base_ring is not defined (or is None)</code></td></tr></table>\n",
    "created_at": "2021-05-19T11:59:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511239",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:23"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c9547e6dace9f9d2e2ff8279ee4882c12213c4aa">c9547e6</a></td><td><code>handle the case where base_ring is not defined (or is None)</code></td></tr></table>




---

archive/issue_comments_511240.json:
```json
{
    "body": "Changed commit from **[01736aa](https://github.com/sagemath/sagetrac-mirror/commit/01736aac202b9d456485b1a401d04a89f7eff833)** to **[c9547e6](https://github.com/sagemath/sagetrac-mirror/commit/c9547e6dace9f9d2e2ff8279ee4882c12213c4aa)**",
    "created_at": "2021-05-19T11:59:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511240",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[01736aa](https://github.com/sagemath/sagetrac-mirror/commit/01736aac202b9d456485b1a401d04a89f7eff833)** to **[c9547e6](https://github.com/sagemath/sagetrac-mirror/commit/c9547e6dace9f9d2e2ff8279ee4882c12213c4aa)**



---

archive/issue_comments_511241.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nOK, patchbot now looks happy with the ticket.\n\nSo, I'd say that the ticket is ready for review.",
    "created_at": "2021-05-20T03:20:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511241",
    "user": "https://github.com/xcaruso"
}
```

<div id="comment:24" align="right">comment:24</div>

OK, patchbot now looks happy with the ticket.

So, I'd say that the ticket is ready for review.



---

archive/issue_comments_511242.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nThis seems good to me overall. I don't immediately see the need for the `is_coercion_map()` method. Yet, that could benefit from having a quick check to see if `self is` the coercion map:\n\n```diff\n-        if not self.codomain().has_coerce_map_from(domain):\n+        f = self.codomain()._internal_coerce_map_from(domain)\n+        if f is None:\n             return False\n+        if f is self:\n+            return True\n```\nAlso, there is a bunch of duplicate code with `is_coercion_map()` and `is_identity()`. I think `is_identity()` can simply call `is_coercion_map()` after checking the domain equals the codomain.",
    "created_at": "2021-05-22T08:52:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511242",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:25" align="right">comment:25</div>

This seems good to me overall. I don't immediately see the need for the `is_coercion_map()` method. Yet, that could benefit from having a quick check to see if `self is` the coercion map:

```diff
-        if not self.codomain().has_coerce_map_from(domain):
+        f = self.codomain()._internal_coerce_map_from(domain)
+        if f is None:
             return False
+        if f is self:
+            return True
```
Also, there is a bunch of duplicate code with `is_coercion_map()` and `is_identity()`. I think `is_identity()` can simply call `is_coercion_map()` after checking the domain equals the codomain.



---

archive/issue_comments_511243.json:
```json
{
    "body": "Reviewer: **Travis Scrimshaw**",
    "created_at": "2021-05-22T08:52:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511243",
    "user": "https://github.com/tscrim"
}
```

Reviewer: **Travis Scrimshaw**



---

archive/issue_comments_511244.json:
```json
{
    "body": "Changed commit from **[c9547e6](https://github.com/sagemath/sagetrac-mirror/commit/c9547e6dace9f9d2e2ff8279ee4882c12213c4aa)** to **[80012e6](https://github.com/sagemath/sagetrac-mirror/commit/80012e6b13405fc460337fde02c59c9a73874de4)**",
    "created_at": "2021-05-22T09:48:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511244",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[c9547e6](https://github.com/sagemath/sagetrac-mirror/commit/c9547e6dace9f9d2e2ff8279ee4882c12213c4aa)** to **[80012e6](https://github.com/sagemath/sagetrac-mirror/commit/80012e6b13405fc460337fde02c59c9a73874de4)**



---

archive/issue_comments_511245.json:
```json
{
    "body": "<div id=\"comment:26\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/80012e6b13405fc460337fde02c59c9a73874de4\">80012e6</a></td><td><code>factor code in is_identity / is_coercion_map</code></td></tr></table>\n",
    "created_at": "2021-05-22T09:48:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511245",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:26"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/80012e6b13405fc460337fde02c59c9a73874de4">80012e6</a></td><td><code>factor code in is_identity / is_coercion_map</code></td></tr></table>




---

archive/issue_comments_511246.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nReplying to [@tscrim](#comment:25):\n> I don't immediately see the need for the `is_coercion_map()` method.\n\nWell, I don't have any very good reason but I'd say that it's natural to have this method in sage where coercion maps play a central role.\n\n> Yet, that could benefit from having a quick check to see if `self is` the coercion map:\n> \n> ```diff\n> -        if not self.codomain().has_coerce_map_from(domain):\n> +        f = self.codomain()._internal_coerce_map_from(domain)\n> +        if f is None:\n>              return False\n> +        if f is self:\n> +            return True\n> ```\n> Also, there is a bunch of duplicate code with `is_coercion_map()` and `is_identity()`. I think `is_identity()` can simply call `is_coercion_map()` after checking the domain equals the codomain.\n\nYou're right. I made the modifications.",
    "created_at": "2021-05-22T10:02:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511246",
    "user": "https://github.com/xcaruso"
}
```

<div id="comment:27" align="right">comment:27</div>

Replying to [@tscrim](#comment:25):
> I don't immediately see the need for the `is_coercion_map()` method.

Well, I don't have any very good reason but I'd say that it's natural to have this method in sage where coercion maps play a central role.

> Yet, that could benefit from having a quick check to see if `self is` the coercion map:
> 
> ```diff
> -        if not self.codomain().has_coerce_map_from(domain):
> +        f = self.codomain()._internal_coerce_map_from(domain)
> +        if f is None:
>              return False
> +        if f is self:
> +            return True
> ```
> Also, there is a bunch of duplicate code with `is_coercion_map()` and `is_identity()`. I think `is_identity()` can simply call `is_coercion_map()` after checking the domain equals the codomain.

You're right. I made the modifications.



---

archive/issue_events_438370.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2021-05-23T05:21:43Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31783#event-438370"
}
```



---

archive/issue_events_438371.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2021-05-23T05:21:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31783#event-438371"
}
```



---

archive/issue_comments_511247.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nThen let it be so.",
    "created_at": "2021-05-23T05:21:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511247",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:28" align="right">comment:28</div>

Then let it be so.



---

archive/issue_comments_511248.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nMerge conflict with latest beta.",
    "created_at": "2021-06-02T02:24:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31783#issuecomment-511248",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:29" align="right">comment:29</div>

Merge conflict with latest beta.



---

archive/issue_events_438372.json:
```json
{
    "actor": "https://github.com/kwankyu",
    "created_at": "2021-06-02T02:24:42Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31783#event-438372"
}
```



---

archive/issue_events_438373.json:
```json
{
    "actor": "https://github.com/kwankyu",
    "created_at": "2021-06-02T02:24:42Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31783#event-438373"
}
```



---

archive/issue_events_438374.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-22T20:35:10Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31783#event-438374"
}
```



---

archive/issue_events_438375.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-22T20:35:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31783#event-438375"
}
```



---

archive/issue_events_438376.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:24:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31783#event-438376"
}
```



---

archive/issue_events_438377.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:24:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31783#event-438377"
}
```



---

archive/issue_events_438378.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:19:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31783#event-438378"
}
```



---

archive/issue_events_438379.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:19:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31783#event-438379"
}
```



---

archive/issue_events_438380.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31783#event-438380"
}
```



---

archive/issue_events_438381.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31783",
    "milestone_number": null,
    "milestone_title": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31783#event-438381"
}
```
