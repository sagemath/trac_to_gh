# Issue 16509: Sort dicts in doctests

Issue created by migration from https://trac.sagemath.org/ticket/16746

Original creator: vbraun

Original creation time: 2014-07-31 15:35:58

CC:  dkrenn




---

Comment by vbraun created at 2014-07-31 16:14:02

Changing component from PLEASE CHANGE to doctest framework.


---

Comment by vbraun created at 2014-07-31 16:14:02

New commits:


---

Comment by vbraun created at 2014-07-31 16:14:02

Changing type from PLEASE CHANGE to defect.


---

Comment by vbraun created at 2014-07-31 16:18:51

The first commit changes the doctest displayhook to the one we want. This causes various doctest changes that need to be fixed.


---

Comment by vbraun created at 2014-09-17 10:57:50

I noticed that the fix for printing types "our way" (#14466) was incomplete, inside lists it still uses IPython style:

```
sage: type(1)
<type 'sage.rings.integer.Integer'>
sage: [type(1)]
[sage.rings.integer.Integer]
```



---

Comment by git created at 2014-09-17 23:51:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2014-09-18 00:14:41

I've refactored our displayhook machinery so we can pick & choose which parts we want to take from IPython. Now works ok, still have to fixup old doctests.


---

Comment by git created at 2014-09-18 18:21:04

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vbraun created at 2014-09-18 18:27:05

Changing status from new to needs_review.


---

Comment by vbraun created at 2014-09-18 18:27:14

Changing priority from major to blocker.


---

Comment by kcrisman created at 2014-09-18 18:49:44

Wow, that is a massive set of changes... just out of curiosity, what does the documentation now look like for graphics?  I don't know whether it is more obvious before or after this change that one needs to evaluate to get them.  One reason for the spaces before (I mean the ones after plot doctests) was to "leave room" in the (live) doc for evaluating these.


---

Comment by jdemeyer created at 2014-09-18 19:32:39

I see why you needed #16992 now...


---

Comment by jdemeyer created at 2014-09-18 19:45:01

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2014-09-18 19:45:01

In `src/sage/graphs/generic_graph.py`, this was probably intended as a doctest (although certainly something went wrong around those lines):

```
sage: g.layout(layout="acyclic_dummy", save_po=True)
{('0', 0): [0.3356712660780875, 0],
 ('0', 1): [0.33563875939602245, 1],
 ('1', 0): [0.6751346747788185, 0],
 ('1', 1): [0.6715689173983604, 1]}
```



---

Comment by vbraun created at 2014-09-18 19:50:48

Honestly, I don't know what the `g.layout(layout="acyclic_dummy", save_po=True)` is supposed to do. I took out the `1+1 == 2` but kept the layout call since the latter changes the rng (so without it all following doctests change).


---

Comment by jdemeyer created at 2014-09-18 20:07:11

There is a problem with graphics objects: they used to be actually "plotted" by doctests to some random file, now this gone. To easily check this, execute

```
$ chmod 0000 local/bin/tachyon
$ ./sage -t src/sage/plot/circle.py
```


Without this patch, this breaks 4 doctests. With this patch, this only breaks 1 doctest (where an explicit `.show()` was given), meaning there are now 3 plots no longer tested.


---

Comment by jdemeyer created at 2014-09-18 20:07:48

Replying to [comment:18 vbraun]:
> Honestly, I don't know what the `g.layout(layout="acyclic_dummy", save_po=True)` is supposed to do. I took out the `1+1 == 2` but kept the layout call since the latter changes the rng (so without it all following doctests change). 
I didn't mean to remove the call, just to show the output, i.e. remove the `x =`.


---

Comment by jdemeyer created at 2014-09-18 20:17:37

Apart from the issues in the last comments, the changes to the doctests look okay. I haven't looked at the new displayhook code though.

What does "repl" stand for by the way? Perhaps a one-paragraph explanation in `src/sage/repl/all.py` would be good.


---

Comment by vbraun created at 2014-09-18 20:38:44

Read-Eval-Print-Loop.

I'll also call show() on  graphics in the doctest displayhook...


---

Comment by cheuberg created at 2014-09-19 05:40:17

`make ptestlong` on my linux mint 64 bit desktop gave a few failing doctests, mostly because sorting of integers and strings is more or less random.


```
sage -t --long src/doc/de/tutorial/programming.rst
**********************************************************************
File "src/doc/de/tutorial/programming.rst", line 503, in doc.de.tutorial.programming
Failed example:
    X
Expected:
    {1, 19, 'a'}
Got:
    {'a', 1, 19}
**********************************************************************
1 item had failures:
   1 of 143 in doc.de.tutorial.programming
    [113 tests, 1 failure, 1.61 s]
sage -t --long src/doc/en/tutorial/programming.rst
**********************************************************************
File "src/doc/en/tutorial/programming.rst", line 485, in doc.en.tutorial.programming
Failed example:
    X
Expected:
    {1, 19, 'a'}
Got:
    {'a', 1, 19}
**********************************************************************
1 item had failures:
   1 of 144 in doc.en.tutorial.programming
    [114 tests, 1 failure, 0.17 s]
sage -t --long src/doc/en/thematic_tutorials/tutorial-programming-python.rst
**********************************************************************
File "src/doc/en/thematic_tutorials/tutorial-programming-python.rst", line 707, in doc.en.thematic_tutorials.tutorial-programming-python
Failed example:
    d
Expected:
    {3/2: 17, 3: 17, 'key': [4, 1, 5, 2, 3], (3, 1, 2): 'goo'}
Got:
    {'key': [4, 1, 5, 2, 3], (3, 1, 2): 'goo', 3/2: 17, 3: 17}
**********************************************************************
File "src/doc/en/thematic_tutorials/tutorial-programming-python.rst", line 734, in doc.en.thematic_tutorials.tutorial-programming-python
Failed example:
    d
Expected:
    {3/2: 17, 3: 17, 10: 'a', 'key': [4, 1, 5, 2, 3], (3, 1, 2): 'goo'}
Got:
    {'key': [4, 1, 5, 2, 3], (3, 1, 2): 'goo', 3/2: 17, 3: 17, 10: 'a'}
**********************************************************************
File "src/doc/en/thematic_tutorials/tutorial-programming-python.rst", line 767, in doc.en.thematic_tutorials.tutorial-programming-python
Failed example:
    d
Expected:
    {3: 14, 10: 'newvalue', 20: 'newervalue', 'a': [1, 2, 3]}
Got:
    {'a': [1, 2, 3], 3: 14, 10: 'newvalue', 20: 'newervalue'}
**********************************************************************
1 item had failures:
   3 of 159 in doc.en.thematic_tutorials.tutorial-programming-python
    [158 tests, 3 failures, 0.16 s]
sage -t --long src/doc/fr/tutorial/programming.rst
**********************************************************************
File "src/doc/fr/tutorial/programming.rst", line 501, in doc.fr.tutorial.programming
Failed example:
    X
Expected:
    {1, 19, 'a'}
Got:
    {'a', 1, 19}
**********************************************************************
1 item had failures:
   1 of 143 in doc.fr.tutorial.programming
    [113 tests, 1 failure, 0.17 s]
sage -t --long src/doc/ru/tutorial/programming.rst
**********************************************************************
File "src/doc/ru/tutorial/programming.rst", line 469, in doc.ru.tutorial.programming
Failed example:
    X
Expected:
    {1, 19, 'a'}
Got:
    {'a', 1, 19}
**********************************************************************
1 item had failures:
   1 of 143 in doc.ru.tutorial.programming
    [113 tests, 1 failure, 0.17 s]
sage -t --long local/lib/python2.7/site-packages/sagenb-0.10.8.2-py2.7.egg/sagenb/notebook/worksheet.py
**********************************************************************
File "local/lib/python2.7/site-packages/sagenb-0.10.8.2-py2.7.egg/sagenb/notebook/worksheet.py", line 4063, in sagenb.notebook.worksheet.Worksheet.delete_all_output
Failed example:
    W.cell_list()
Expected:
    [Cell 0: in=2+3, out=
    5, Cell 1: in=open('afile', 'w').write('some text')
    print 'hello', out=
    ]
Got:
    [Cell 0: in=2+3, out=
     5, Cell 1: in=open('afile', 'w').write('some text')
     print 'hello', out=]
**********************************************************************
1 item had failures:
   1 of  21 in sagenb.notebook.worksheet.Worksheet.delete_all_output
    [530 tests, 1 failure, 13.40 s]
```



---

Comment by git created at 2014-09-19 14:58:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2014-09-19 14:58:54

I've addressed all issues so far and added more documentation (which also spells out REPL).


---

Comment by vbraun created at 2014-09-19 14:58:54

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2014-09-19 18:38:28

Found some more random failures. Also, missed the `W.cell_list()` failure above which is caused by not preserving a trailing newline (IPython does that, too). Fix coming shortly...


---

Comment by git created at 2014-09-19 19:01:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-09-19 21:58:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cheuberg created at 2014-09-20 07:48:35

Now, all doctests pass on my linux mint 64 bit desktop.


---

Comment by vbraun created at 2014-09-20 22:09:23

All doctest pass on the buildbot...


---

Comment by dimpase created at 2014-09-26 09:31:31

Did you try this on ARM?


---

Comment by vbraun created at 2014-09-26 09:37:29

ARM is part of the buildbot now, so yes ;-)


---

Comment by fbissey created at 2014-09-26 09:39:37

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2014-09-26 09:39:37

Since it pass on the build bot and I don;t see any obvious problem with the new code itself I will give it a positive review. I expect ARM to be irrelevant in this context as we are only talking about re-formatting current doctests.
Plus it will fix broken doctests in sage-on-gentoo (dictionaries displayed in a different order).


---

Comment by git created at 2014-09-26 17:41:31

Changing status from positive_review to needs_review.


---

Comment by git created at 2014-09-26 17:41:31

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by vbraun created at 2014-09-26 17:45:27

surprisingly only one merge conflict ;-)


---

Comment by vbraun created at 2014-09-26 17:45:27

Changing status from needs_review to positive_review.


---

Comment by git created at 2014-09-27 00:05:47

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2014-09-27 00:05:47

Changing status from positive_review to needs_review.


---

Comment by fbissey created at 2014-09-27 00:57:37

At this stage I think you have done all the work that should be done in one ticket. I suggest we have a follow up ticket for any new discoveries.


---

Comment by jdemeyer created at 2014-09-27 07:35:47

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-09-27 12:56:54

Resolution: fixed
