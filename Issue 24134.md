# Issue 24134: Move real/complex interval fields to new coercion model

Issue created by migration from https://trac.sagemath.org/ticket/24371

Original creator: jdemeyer

Original creation time: 2017-12-12 17:07:42

CC:  tscrim




---

Comment by git created at 2017-12-14 12:04:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-12-14 17:08:31

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-12-15 12:24:32

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-12-15 16:38:42

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tscrim created at 2017-12-15 21:50:09

This will conflict with #23739, but note that #23739 is currently stalled.


---

Comment by tscrim created at 2017-12-15 21:51:56

Also, I imagine #24363 is a dependency from looking at the code.


---

Comment by jdemeyer created at 2017-12-16 08:43:22

Replying to [comment:10 tscrim]:
> Also, I imagine #24363 is a dependency from looking at the code.

I don't see why.


---

Comment by jdemeyer created at 2017-12-16 09:05:24

Replying to [comment:9 tscrim]:
> This will conflict with #23739, but note that #23739 is currently stalled.

I shouldn't be hard to fix #23739 in this ticket.


---

Comment by mderickx created at 2017-12-16 10:41:35

I also shortly want to note #15114 here and the discussion from which that ticket spawned at [sage-devel](https://groups.google.com/forum/#!searchin/sage-devel/coercion$20interval$20field%7Csort:date/sage-devel/zfg0PhFR_qA/t2SY2cbOCAAJ). I am not saying it needs to get fixed here, but it is a good thing to have in the back of your mind while working on this ticket so that at least things do not get worse in that respect.


---

Comment by tscrim created at 2017-12-16 12:52:37

Replying to [comment:11 jdemeyer]:
> Replying to [comment:10 tscrim]:
> > Also, I imagine #24363 is a dependency from looking at the code.
> 
> I don't see why.

I thought I saw a conflict, but that turns out to not be the case.


---

Comment by git created at 2017-12-17 20:46:32

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-12-18 08:39:00

Replying to [comment:14 mderickx]:
> I also shortly want to note #15114 here and the discussion from which that ticket spawned at [sage-devel](https://groups.google.com/forum/#!searchin/sage-devel/coercion$20interval$20field%7Csort:date/sage-devel/zfg0PhFR_qA/t2SY2cbOCAAJ). I am not saying it needs to get fixed here, but it is a good thing to have in the back of your mind while working on this ticket so that at least things do not get worse in that respect.

OK. So with #15114 in mind, this should be a feature and not a bug:

```
sage: CC.one() + CIF.one()
...
TypeError: unsupported operand parent(s) for +: 'Complex Field with 53 bits of precision' and 'Complex Interval Field with 53 bits of precision'
```



---

Comment by git created at 2017-12-18 14:58:59

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-12-19 08:17:52

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-12-19 09:36:52

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-12-19 14:49:11

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-12-22 12:50:16

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-12-22 16:14:39

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-12-22 16:30:29

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mmezzarobba created at 2018-02-07 14:22:27

Rebased (trivial conflits only)... Is this ready for review?


---

Comment by git created at 2018-02-07 14:30:18

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-02-07 19:28:40

Replying to [comment:29 mmezzarobba]:
> Is this ready for review?

Not sure... I wanted to wait until the dependencies are merged before continuing with this.

It should be _mostly_ done though. If it passes doctests, it might as well be "needs review".


---

Comment by git created at 2018-02-09 14:10:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-02-09 14:12:40

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-02-09 14:16:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-02-09 14:39:49

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-02-09 14:59:16

I still need to implement the Python 3 compatibility that I promised.


---

Comment by git created at 2018-02-09 16:21:40

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-02-09 16:23:58

Changing status from new to needs_review.


---

Comment by tscrim created at 2018-02-09 21:23:39

Some comments:

- I know this is slightly outside the purview of this ticket, but perhaps we can rename `ComplexIntervalField_class` to `ComplexIntervalField` and have it inherit from `UniqueRepresentation` in order to get rid of the custom caching. I can also do this if you want.
- I would do the same for `RealIntervalField_class` except it is an extension class. Do you think there is a benefit for that? We don't even do that for `Rationals`.
- Why not use ``@`cached_method` for `real_field`, `middle_field`, etc.? They to have `UniqueRepresentation`-like behavior, so do not strictly need to be cached. However, I am assuming they are cached for speed reasons, so doing ``@`cached_method` is the best for repeated use:
  {{{#!sage
sage: class Foo(object):
....:     def __init__(self):
....:         self._cache2 = None
....:     `@`cached_method
....:     def cm(self):
....:         return 5
....:     def c1(self):
....:         try:
....:             return self._cache1
....:         except AttributeError:
....:             self._cache1 = 5
....:             return self._cache1
....:     def c2(self):
....:         if self._cache2 is None:
....:             self._cache2 = 5
....:         return self._cache2
sage: timeit('F = Foo(); F.cm()', number=10000, repeat=20)
10000 loops, best of 20: 1.53 µs per loop
sage: timeit('F = Foo(); F.c1()', number=10000, repeat=20)
10000 loops, best of 20: 1.39 µs per loop
sage: timeit('F = Foo(); F.c2()', number=10000, repeat=20)
10000 loops, best of 20: 635 ns per loop
sage: F = Foo()
sage: timeit('F.cm()', number=10000, repeat=20)
10000 loops, best of 20: 68.7 ns per loop
sage: timeit('F.c1()', number=10000, repeat=20)
10000 loops, best of 20: 121 ns per loop
sage: timeit('F.c2()', number=10000, repeat=20)
10000 loops, best of 20: 1.49 µs per loop
  }}}
- Is the `_real_field = real_field` leftover from testing? I think it should be removed altogether.
- You should replace
  {{{#!diff
        return complex_interval.ComplexIntervalFieldElement(self, x, im, **kwds)
        return self.element_class(self, x, im, **kwds)
  }}}
  (in fact, if that is used elsewhere in the file, it should be replaced as well) to pick up the category contributions.
- Same comment for returning `RealIntervalFieldElement`.
- Similarly, I would also make this change:
  {{{#!diff
     R = RealIntervalField(prec=max(bits+pad, min_prec))
     if upper is not None:
         s = (s, upper)
-    return RealIntervalFieldElement(R, s, base)
+    return R.element_class(R, s, base)
 }}}

I think it looks good otherwise.


---

Comment by jdemeyer created at 2018-02-09 21:36:53

I consider the proposed changes to unique representation outside the scope of this ticket. This ticket is already reasonably large, let's not add more things. I'll have a look at your other comments.


---

Comment by tscrim created at 2018-02-09 21:39:10

I guess the `_real_field = real_field` is to avoid #24695 as a dependency?


---

Comment by tscrim created at 2018-02-09 21:40:34

We should also do changes of the form in `ComplexIntervalFieldElement`:

```diff
-return ComplexIntervalFieldElement(self._parent, re, im)
+return type(self)(self._parent, re, im)
```

and similarly for `RealIntervalFieldElement`.


---

Comment by jdemeyer created at 2018-02-09 21:46:17

Replying to [comment:42 tscrim]:
> I guess the `_real_field = real_field` is to avoid #24695 as a dependency?

I wasn't actually aware of that, thanks for the pointer :-)


---

Comment by jdemeyer created at 2018-02-12 12:04:38

I guess I kept `_real_field` for compatibility with other "complex number" implementations such as

```
sage: CC._real_field()
Real Field with 53 bits of precision
```


We should probably have a separate ticket to replace `_real_field` by `real_field`: this looks like a useful method, it should not be private.


---

Comment by git created at 2018-02-12 13:18:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2018-02-12 13:19:11

I ended up doing a lot of cleanup. I think I'm using `element_class` everywhere, but don't shoot me if I'm wrong.

Note that currently the category stuff won't be used anyway because the elements are extension types.


---

Comment by tscrim created at 2018-02-13 01:45:06

Thank you for doing the cleanup.

For changes such as

```diff
-        cdef ComplexIntervalFieldElement res = self._new()
+        res = self._new()
```

aren't we loosing some efficiency? I would think because they are still subclasses of `ComplexIntervalFieldElement`, that Cython would be able to optimize their attribute lookups by not treating them as Python objects? (Of course, we would have to explicitly cast `<ComplexIntervalFieldElement>` to avoid the type-checking-safety-penalty.)

This goes through the `__call__` (which in this case, bypasses the coercion framework, but normally it wouldn't):

```diff
-        return complex_interval.ComplexIntervalFieldElement(self, 0, 1)
+        return self(0, 1)
```

I think we are better making a direct call to `self.element_class(self, 0, 1)` since this is not user input.


---

Comment by jdemeyer created at 2018-02-13 06:28:06

Replying to [comment:48 tscrim]:
> Thank you for doing the cleanup.
> 
> For changes such as
> {{{#!diff
> -        cdef ComplexIntervalFieldElement res = self._new()
> +        res = self._new()
> }}}
> aren't we loosing some efficiency?

No, Cython has type inference. Since `_new` is declared as returning a `ComplexIntervalFieldElement`, the declaration `cdef ComplexIntervalFieldElement res` is just redundant.

> This goes through the `__call__` (which in this case, bypasses the coercion framework, but normally it wouldn't):
> {{{#!diff
> -        return complex_interval.ComplexIntervalFieldElement(self, 0, 1)
> +        return self(0, 1)
> }}}
> I think we are better making a direct call to `self.element_class(self, 0, 1)` since this is not user input.

I don't see the problem with using `__call__` here but I can make that change.


---

Comment by git created at 2018-02-13 08:46:45

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-02-13 09:00:14

Replying to [comment:48 tscrim]:
> Cython would be able to optimize their attribute lookups by not treating them as Python objects?

Actually, the relevant attributes are `cdef` attributes, so they cannot even be accessed from Python! So the fact that the code works proves that Cython must be doing type inference.

I changed some `self(...)` calls to `self.element_class(self, ...)`


---

Comment by tscrim created at 2018-02-13 12:40:35

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2018-02-13 12:40:35

Replying to [comment:51 jdemeyer]:
> Replying to [comment:48 tscrim]:
> > Cython would be able to optimize their attribute lookups by not treating them as Python objects?
> 
> Actually, the relevant attributes are `cdef` attributes, so they cannot even be accessed from Python! So the fact that the code works proves that Cython must be doing type inference.

That is what is happening, e.g.:

```C
  __pyx_t_1 = ((PyObject *)__pyx_f_4sage_5rings_16complex_interval_27ComplexIntervalFieldE
lement__new(__pyx_v_self)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 325, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_v_a00 = ((struct __pyx_obj_4sage_5rings_16complex_interval_ComplexIntervalFieldEle
ment *)__pyx_t_1);
  __pyx_t_1 = 0;
```

I didn't realize that Cython was that smart. :)

> I changed some `self(...)` calls to `self.element_class(self, ...)`

Thank you. LGTM. (If I wanted to be **really** picky, I would say `self.element_class(self, 1)` should instead use the cached `self.one()`, but `zeta(1)` is almost certainly never called.)


---

Comment by jdemeyer created at 2018-02-13 15:24:07

Thanks!


---

Comment by vbraun created at 2018-02-15 23:13:40

Resolution: fixed
