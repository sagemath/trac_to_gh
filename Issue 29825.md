# Issue 29825: Add to category of metric spaces

Issue created by migration from https://trac.sagemath.org/ticket/30062

Original creator: mkoeppe

Original creation time: 2020-07-04 06:35:06

CC:  tscrim egourgoulhon


```
sage: from sage.categories.metric_spaces import MetricSpaces
sage: QQ in MetricSpaces()
True
sage: RR in MetricSpaces()
True
sage: ZZ in MetricSpaces()
True
sage: AA in MetricSpaces()
False
sage: QuadraticField(5) in MetricSpaces()
False
sage: M = Matrix(QQ,[[2,1,0],[1,2,1],[0,1,2]])
sage: V = VectorSpace(QQ,3,inner_product_matrix=M)
sage: V in MetricSpaces()
```



---

Comment by egourgoulhon created at 2020-07-11 15:57:25

New commits:


---

Comment by egourgoulhon created at 2020-07-11 16:23:26

The above commit is a first attempt to add `EuclideanSpace` to the category of metric spaces. It endows the class `EuclideanSpace` with the method `dist()`, which computes the Euclidean distance between two points. However, `TestSuite(E).run()` fails with `_test_metric` because of the name clash between 
- the method `metric()` of `EuclideanSpace`, which is inheritated from `PseudoRiemannianManifold` and which returns the metric tensor (first fundamental form)
- the method `metric()` of `ParentMethods` in `MetricSpaces`, which is supposed to be the distance function.

It seems difficult to change the name of `PseudoRiemannianManifold.metric()`, even with a proper deprecation notice, because it is heavily used and it is the natural name in the context of differential geometry. On the other side, could the parent method `metric()` of `MetricSpaces` be changed to something else? e.g. `distance_function`? Also, it seems quite redundant with the other parent method `dist()`. Indeed, by default, the parent method `metric()` is defined as 

```
        def metric(self):
            return lambda a,b: a.dist(b)
```

with `a.dist(b)` being `self.parent().dist(self, b)`, so at the end of the day, if `M` is a metric space, `M.metric()(a,b)` ends to `M.dist(a,b)`.


---

Comment by egourgoulhon created at 2020-07-11 16:28:36

Another remark about `MetricSpaces`: it defines an element method `abs()`, which returns the distance to the zero element. For `EuclideanSpace`, the zero element could be defined as the element of Cartesian coordinates `(0,0,...,0)`, but in general, metric spaces (which are not necessarily algebraic structures) do not have any natural "zero" element, do they?


---

Comment by egourgoulhon created at 2020-07-11 16:35:32

Regarding the addition of Riemannian manifolds beyond `EuclideanSpace` to the category `MetricSpaces`, this seems computationaly difficult. It is true that any connected Riemannian manifold can be turned into a metric space by defining the distance function as the infinimum of the lengths of the paths connecting two points, but the latter is not computable in practice.


---

Comment by mkoeppe created at 2020-07-11 17:54:00

Replying to [comment:4 egourgoulhon]:
> The above commit is a first attempt to add `EuclideanSpace` to the category of metric spaces. It endows the class `EuclideanSpace` with the method `dist()`, which computes the Euclidean distance between two points.

Great!

> However, `TestSuite(E).run()` fails with `_test_metric` because of the name clash between 
> - the method `metric()` of `EuclideanSpace`, which is inheritated from `PseudoRiemannianManifold` and which returns the metric tensor (first fundamental form)
> - the method `metric()` of `ParentMethods` in `MetricSpaces`, which is supposed to be the distance function.
> 
> It seems difficult to change the name of `PseudoRiemannianManifold.metric()`, even with a proper deprecation notice, because it is heavily used and it is the natural name in the context of differential geometry.

I agree.

> On the other side, could the parent method `metric()` of `MetricSpaces` be changed to something else?

Overall, this category seems not very well developed, and I would be surprised if it was used much in user code. I think it will be safe to make changes to it (with deprecation).

> e.g. `distance_function`? 

Sounds good to me. But perhaps we can just deprecate the parent method `metric` altogether until a clear need for it arises?


---

Comment by mkoeppe created at 2020-07-11 17:56:45

Replying to [comment:5 egourgoulhon]:
> Another remark about `MetricSpaces`: it defines an element method `abs()`, which returns the distance to the zero element. For `EuclideanSpace`, the zero element could be defined as the element of Cartesian coordinates `(0,0,...,0)`, but in general, metric spaces (which are not necessarily algebraic structures) do not have any natural "zero" element, do they? 

I would propose to deprecate this element method, exactly for this reason. Probably when the category was written, the author was thinking of normed spaces; but these should become a separate category.


---

Comment by mkoeppe created at 2020-07-11 18:01:55

Replying to [comment:6 egourgoulhon]:
> Regarding the addition of Riemannian manifolds beyond `EuclideanSpace` to the category `MetricSpaces`, this seems computationaly difficult. It is true that any connected Riemannian manifold can be turned into a metric space by defining the distance function as the infinimum of the lengths of the paths connecting two points, but the latter is not computable in practice. 

Good point about the needed hypothesis of connectedness. That alone is already a good enough reason not to add Riemannian manifolds to the category. So we can ignore the more subtle question whether it makes sense to add it to the category but have the `dist` method raise `NotImplementedError` for nontrivial inputs.


---

Comment by tscrim created at 2020-07-12 03:27:42

Indeed, I was conflating metric spaces and normed spaces, which should be separated into 2 separate categories (with normed spaces being a subcategory of metric spaces of course).

Just to note: We do have an axiom for connected and the category `Manifolds().Connected()`.

I am -1 for removing the element and parent methods `dist` and the `metric` method. `a.dist(b)` is natural and easier to work with when you don't want to explicitly specify the parent of `a` (and `b`). It is also more conceptual when you don't want to care about the exact metric as long as there is some metric. Similarly, when you want to specify which metric (space) you want to use `M.dist(a,b)` or `M.metric()(a,b)` becomes the more natural choice. Additionally, sometimes you want to explicitly work or pass the metric, so `M.metric()` is something useful too. There should not be any conflict here and having extra (natural) methods doesn't hurt anything.

I would also be wary of saying there is no need just because something is not used in the Sage code: It could be used in a user's code and it feels natural from a teaching perspective. Additionally, me being the (dumb) non-geometer that I am, I would expect asking for the `metric()` of a metric space to return the metric function `d: X x X -> R`.

As Eric said in comment:4, the real issue is the name conflict. From some wikipedia searching, what is currently called a metric in the manifolds code is really a (very common) shorthand name for "metric tensor," whereas "metric" is the standard name for the function that defines a metric space. Of course, the metric tensor allows one to define a metric as Eric said, and it is clear from the context of the different fields what one means. Unfortunately there is not a good way to resolve this other than possibly replacing `metric` with `metric_tensor` in the manifolds code. However, I think it is reasonable to not put the connected Riemannian manifolds in the `MetricSpaces` category because of the computational infeasibility of the metric function.


---

Comment by mkoeppe created at 2020-07-12 05:07:31

Just a quick note:

Replying to [comment:10 tscrim]:
> I am -1 for removing the element and parent methods `dist` and the `metric` method. `a.dist(b)` is natural and easier to work with when you don't want to explicitly specify the parent of `a` (and `b`). 

There is no problem with the element method `dist`. The only problem is the clash of the parent method `metric`.


---

Comment by egourgoulhon created at 2020-07-12 12:50:02

Replying to [comment:10 tscrim]:
> 
> I would also be wary of saying there is no need just because something is not used in the Sage code: It could be used in a user's code and it feels natural from a teaching perspective. Additionally, me being the (dumb) non-geometer that I am, I would expect asking for the `metric()` of a metric space to return the metric function `d: X x X -> R`.
> 

I agree this quite natural.

> As Eric said in comment:4, the real issue is the name conflict. From some wikipedia searching, what is currently called a metric in the manifolds code is really a (very common) shorthand name for "metric tensor," whereas "metric" is the standard name for the function that defines a metric space. Of course, the metric tensor allows one to define a metric as Eric said, and it is clear from the context of the different fields what one means. 

Indeed, both usages of _metric_ are natural in their respective contexts. 

>Unfortunately there is not a good way to resolve this other than possibly replacing `metric` with `metric_tensor` in the manifolds code. 

Another option is to replace `metric` by `metric_function` in `MetricSpaces`. I would favor that one. From a teaching perspective, it is as easy to discover by TAB completion as `metric` (contrary to `distance_function`, which I proposed in comment:4). Moreover, the `MetricSpaces`'s `metric()` is much less used in Sage's code than the manifold one: `grep -r "\.metric()"` in `src/sage` returns 5 lines for metric spaces, versus 127 lines for manifolds. 

>However, I think it is reasonable to not put the connected Riemannian manifolds in the `MetricSpaces` category because of the computational infeasibility of the metric function.

I agree, but this does not solve the clash issue for `EuclideanSpace`, since the latter is considered as a Riemannian manifold (with a flat metric tensor).


---

Comment by mkoeppe created at 2020-07-12 17:58:17

Replying to [comment:12 egourgoulhon]:
> Another option is to replace `metric` by `metric_function` in `MetricSpaces`. I would favor that one. From a teaching perspective, it is as easy to discover by TAB completion as `metric` (contrary to `distance_function`, which I proposed in comment:4). Moreover, the `MetricSpaces`'s `metric()` is much less used in Sage's code than the manifold one: `grep -r "\.metric()"` in `src/sage` returns 5 lines for metric spaces, versus 127 lines for manifolds. 

+1 on `metric_function` (with deprecation for `metric`) in `MetricSpaces`. I think this is a good compromise.


---

Comment by tscrim created at 2020-07-12 23:20:39

I agree that renaming `metric()` -> `metric_function()` and using that internally is good. However, I might also advocate for doing `metric()` -> `metric_tensor()` in the manifold code as it is basically just one sed command, as well as providing `metric()` as a shorthand.

The slightly trickier question would be should we allow `MetricSpaces` to have `metric()` be a shorthand whose semantics could change?


---

Comment by git created at 2020-07-17 07:19:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-17 19:24:23

Replying to [comment:10 tscrim]:
> Indeed, I was conflating metric spaces and normed spaces, which should be separated into 2 separate categories (with normed spaces being a subcategory of metric spaces of course).

Let's fix this in #30092.


---

Comment by mkoeppe created at 2020-07-25 21:23:23

Changing status from new to needs_review.


---

Comment by tscrim created at 2020-07-25 22:44:56

While I am not fully convinced that we should not have an ambiguous `metric` method, it is not a strong enough opinion to warrant asking for further discussion. So if a patchbot comes back (morally) green, then positive review.


---

Comment by mkoeppe created at 2020-07-26 00:17:11

Some test failures that look like this

```
sage -t --long src/sage/rings/padics/padic_base_leaves.py
**********************************************************************
File "src/sage/rings/padics/padic_base_leaves.py", line 237, in sage.rings.padics.padic_base_leaves.pAdicRingCappedRelative.__init__
Failed example:
    R._test_metric(elements = [R.random_element() for i in range(2^3)]) # long time
Exception raised:
    Traceback (most recent call last):
      File "sage/structure/category_object.pyx", line 838, in sage.structure.category_object.CategoryObject.getattr_from_category (build/cythonized/sage/structure/category_object.c:6954)
        return self.__cached_methods[name]
    KeyError: '_test_metric'

    During handling of the above exception, another exception occurred:

    Traceback (most recent call last):
      File "/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 707, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1131, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.padics.padic_base_leaves.pAdicRingCappedRelative.__init__[5]>", line 1, in <module>
        R._test_metric(elements = [R.random_element() for i in range(Integer(2)**Integer(3))]) # long time
      File "sage/structure/category_object.pyx", line 832, in sage.structure.category_object.CategoryObject.__getattr__ (build/cythonized/sage/structure/category_object.c:6876)
        return self.getattr_from_category(name)
      File "sage/structure/category_object.pyx", line 847, in sage.structure.category_object.CategoryObject.getattr_from_category (build/cythonized/sage/structure/category_object.c:7039)
        attr = getattr_from_other_class(self, cls, name)
      File "sage/cpython/getattr.pyx", line 389, in sage.cpython.getattr.getattr_from_other_class (build/cythonized/sage/cpython/getattr.c:2548)
        raise AttributeError(dummy_error_message)
    AttributeError: 'pAdicRingCappedRelative_with_category' object has no attribute '_test_metric'
**********************************************************************
```

... and some others


---

Comment by mkoeppe created at 2020-07-26 00:17:17

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-07-26 00:29:26


```
sage -t --long src/doc/en/thematic_tutorials/vector_calculus/vector_calc_advanced.rst
**********************************************************************
File "src/doc/en/thematic_tutorials/vector_calculus/vector_calc_advanced.rst", line 31, in doc.en.thematic_tutorials.vector_calculus.vector_calc_advanced
Failed example:
    E.category()
Expected:
    Category of smooth manifolds over Real Field with 53 bits of precision
Got:
    Join of Category of differentiable manifolds over Real Field with 53 bits of precision and Category of metric spaces
```

Is the change from "smooth" to "differentiable" expected here?


---

Comment by mkoeppe created at 2020-07-26 00:29:33

Changing status from needs_work to needs_info.


---

Comment by git created at 2020-07-26 00:30:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-26 00:33:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-26 00:33:49

Changing status from needs_info to needs_review.


---

Comment by tscrim created at 2020-07-26 02:28:12

Replying to [comment:22 mkoeppe]:
> {{{
> sage -t --long src/doc/en/thematic_tutorials/vector_calculus/vector_calc_advanced.rst
> **********************************************************************
> File "src/doc/en/thematic_tutorials/vector_calculus/vector_calc_advanced.rst", line 31, in doc.en.thematic_tutorials.vector_calculus.vector_calc_advanced
> Failed example:
>     E.category()
> Expected:
>     Category of smooth manifolds over Real Field with 53 bits of precision
> Got:
>     Join of Category of differentiable manifolds over Real Field with 53 bits of precision and Category of metric spaces
> }}}
> Is the change from "smooth" to "differentiable" expected here?


You explicitly changed the default category to only be differentiable rather than smooth:

```diff
+        if category is None:
+            category = Manifolds(RR).Differentiable() & MetricSpaces()
```

See `sage.manifolds.differentiable.manifold.DifferentiableManifold.__init__`. So I think you need to change

```diff
-            category = Manifolds(RR).Differentiable() & MetricSpaces()
+            category = Manifolds(RR).Smooth() & MetricSpaces()
```



---

Comment by mkoeppe created at 2020-07-26 02:31:57

Eric's commit 1f4f9422 did this, so I guess my question is to him whether this change was intentional


---

Comment by tscrim created at 2020-07-26 04:42:16

Replying to [comment:28 mkoeppe]:
> Eric's commit 1f4f9422 did this, so I guess my question is to him whether this change was intentional

Ah, sorry, I thought it was on one of your commits.


---

Comment by egourgoulhon created at 2020-07-26 12:42:12

Replying to [comment:28 mkoeppe]:
> Eric's commit 1f4f9422 did this, so I guess my question is to him whether this change was intentional
Sorry it is a mistake from my side; of course, for Euclidean spaces, the category shall be `Manifolds(RR).Smooth()`.


---

Comment by egourgoulhon created at 2020-07-26 12:48:48

Since we are on it, we could also add that the Euclidean space is in the category of complete metric spaces:

```
    category = Manifolds(RR).Smooth() & MetricSpaces().Complete()
```

with hopefully some day `RR` replaced by a better representation of the real field, as proposed in #24456.


---

Comment by egourgoulhon created at 2020-07-26 13:54:17

Replying to [comment:31 egourgoulhon]:
> Since we are on it, we could also add that the Euclidean space is in the category of complete metric spaces:
> {{{
>     category = Manifolds(RR).Smooth() & MetricSpaces().Complete()
> }}}
> with hopefully some day `RR` replaced by a better representation of the real field, as proposed in #24456.

I'll add a commit implementing this soon (EDIT: this is the commit in comment:33).


---

Comment by git created at 2020-07-26 14:10:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-26 17:27:18

Looks great to me, thanks very much.

Patchbot is green too. (There is one patchbot that is not feeling well, unrelated to this ticket.)


---

Comment by tscrim created at 2020-07-27 03:39:24

Thank you.


---

Comment by tscrim created at 2020-07-27 03:39:24

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-08-02 08:20:40

Resolution: fixed
