# Issue 11746: `sage --valgrind` etc. apparently broken

archive/issues_011746.json:
```json
{
    "body": "Assignee: @nexttime\n\nCC:  @roed314 simonking\n\nKeywords: --memcheck sage.supp suppressions\n\nAs reported on the IRC, running `sage --valgrind` (alias `sage --memcheck`) is apparently broken because the suppressions file is missing (and its directory, `$SAGE_LOCAL/lib/valgrind/`, doesn't exist).\n\nBoth `sage-valgrind` and `sage-doctest` seem to hardcode `$SAGE_LOCAL/lib/valgrind/sage.supp`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/11918\n\n",
    "created_at": "2011-10-13T12:36:31Z",
    "labels": [
        "component: scripts",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "`sage --valgrind` etc. apparently broken",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11746",
    "user": "https://github.com/nexttime"
}
```
Assignee: @nexttime

CC:  @roed314 simonking

Keywords: --memcheck sage.supp suppressions

As reported on the IRC, running `sage --valgrind` (alias `sage --memcheck`) is apparently broken because the suppressions file is missing (and its directory, `$SAGE_LOCAL/lib/valgrind/`, doesn't exist).

Both `sage-valgrind` and `sage-doctest` seem to hardcode `$SAGE_LOCAL/lib/valgrind/sage.supp`.

Issue created by migration from https://trac.sagemath.org/ticket/11918





---

archive/issue_comments_133430.json:
```json
{
    "body": "Changing assignee from @nexttime to tbd.",
    "created_at": "2011-10-13T12:37:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11746#issuecomment-133430",
    "user": "https://github.com/nexttime"
}
```

Changing assignee from @nexttime to tbd.



---

archive/issue_comments_133431.json:
```json
{
    "body": "sage.supp is part of the optional valgrind package which BTW is out of date.\n\n\nAccording to http://groups.google.com/group/sage-devel/browse_thread/thread/1657cccac33c9dd7\n  The suppression file gets rid of a bunch of annoying issues introduced by zlib and Cython.\n\nIs this still necessary?",
    "created_at": "2011-10-26T18:12:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11746#issuecomment-133431",
    "user": "https://github.com/a-andre"
}
```

sage.supp is part of the optional valgrind package which BTW is out of date.


According to http://groups.google.com/group/sage-devel/browse_thread/thread/1657cccac33c9dd7
  The suppression file gets rid of a bunch of annoying issues introduced by zlib and Cython.

Is this still necessary?



---

archive/issue_comments_133432.json:
```json
{
    "body": "Replying to [comment:3 aapitzsch]:\n> sage.supp is part of the optional valgrind package which BTW is out of date.\n\nYes, but it's IMHO pointless to install an (almost always) obsolete spkg just to get a file which consists of only a few lines.  It should be part of the standard distribution.\n\n(More recent `valgrind` versions are either already installed or at least available as a \"native\" package in any reasonable distro.  Moreover, I don't think one would *only* use it for Sage.  Note also that usually `valgrind` has to be updated each time new processor instructions / ISA extensions come up.)\n\nNot testing for its presence (btw. without any meaningful error message from Sage's side) is certainly a bug.\n\n\n\n\n> \"The suppression file gets rid of a bunch of annoying issues introduced by zlib and Cython.\"\n> \n> Is this still necessary?\n\nI think so, but it should be kept up-to-date anyway.",
    "created_at": "2011-10-26T18:44:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11746#issuecomment-133432",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:3 aapitzsch]:
> sage.supp is part of the optional valgrind package which BTW is out of date.

Yes, but it's IMHO pointless to install an (almost always) obsolete spkg just to get a file which consists of only a few lines.  It should be part of the standard distribution.

(More recent `valgrind` versions are either already installed or at least available as a "native" package in any reasonable distro.  Moreover, I don't think one would *only* use it for Sage.  Note also that usually `valgrind` has to be updated each time new processor instructions / ISA extensions come up.)

Not testing for its presence (btw. without any meaningful error message from Sage's side) is certainly a bug.




> "The suppression file gets rid of a bunch of annoying issues introduced by zlib and Cython."
> 
> Is this still necessary?

I think so, but it should be kept up-to-date anyway.



---

archive/issue_comments_133433.json:
```json
{
    "body": "Changing keywords from \"--memcheck sage.supp suppressions\" to \"--valgrind --memcheck sage.supp suppressions\".",
    "created_at": "2011-10-26T18:48:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11746#issuecomment-133433",
    "user": "https://github.com/nexttime"
}
```

Changing keywords from "--memcheck sage.supp suppressions" to "--valgrind --memcheck sage.supp suppressions".



---

archive/issue_comments_133434.json:
```json
{
    "body": "P.S.: Thanks for bringing this ticket back to my mind.  We recently had some discussion on the IRC regarding the spkg, but I completely forgot about the ticket... ;-)",
    "created_at": "2011-10-26T18:52:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11746#issuecomment-133434",
    "user": "https://github.com/nexttime"
}
```

P.S.: Thanks for bringing this ticket back to my mind.  We recently had some discussion on the IRC regarding the spkg, but I completely forgot about the ticket... ;-)



---

archive/issue_comments_133435.json:
```json
{
    "body": "Attachment [sage.supp](tarball://root/attachments/some-uuid/ticket11918/sage.supp) by @nbruin created at 2012-08-30 21:00:49\n\nsage-valgrind suppression file (store as $SAGE_LOCAL/lib/valgrind/sage.supp)",
    "created_at": "2012-08-30T21:00:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11746#issuecomment-133435",
    "user": "https://github.com/nbruin"
}
```

Attachment [sage.supp](tarball://root/attachments/some-uuid/ticket11918/sage.supp) by @nbruin created at 2012-08-30 21:00:49

sage-valgrind suppression file (store as $SAGE_LOCAL/lib/valgrind/sage.supp)



---

archive/issue_comments_133436.json:
```json
{
    "body": "Until this ticket is fixed, I've attached [attachment:sage.supp], which might help people with using valgrind in the mean time. File should be at\n`$SAGE_LOCAL/lib/valgrind/sage.supp` to be picked up. NOTE: This is `sage-liberal.supp` from the spkg.",
    "created_at": "2012-08-30T21:03:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11746#issuecomment-133436",
    "user": "https://github.com/nbruin"
}
```

Until this ticket is fixed, I've attached [attachment:sage.supp], which might help people with using valgrind in the mean time. File should be at
`$SAGE_LOCAL/lib/valgrind/sage.supp` to be picked up. NOTE: This is `sage-liberal.supp` from the spkg.



---

archive/issue_comments_133437.json:
```json
{
    "body": "Hi Nils,\n\nthank you for the sage.supp at #11918! When I run the tests of sage/rings/polynomial/infinite_polynomial_ring.py (which make Volker's patchbot at #12876 segfault, even though they are fine for me, I do not get a SIGILL. But I do get a considerable amount of lost memory:\n\n```\n==13541== 13,936 bytes in 1 blocks are definitely lost in loss record 8,673 of 8,997\n==13541==    at 0x4C244E8: malloc (vg_replace_malloc.c:236)\n==13541==    by 0x21E8984F: omAllocFromSystem (omAllocSystem.c:184)\n==13541==    by 0x21E89A21: omAllocLarge (omAllocSystem.c:39)\n==13541==    by 0x21BB3A00: iiAllStart(procinfo*, char*, feBufferTypes, int) (omalloc.h:2432)\n==13541==    by 0x21BB3B95: iiPStart(idrec*, sleftv*) (iplib.cc:360)\n==13541==    by 0x21BB4148: iiMake_proc(idrec*, sip_package*, sleftv*) (iplib.cc:482)\n==13541==    by 0x2239B64D: __pyx_f_4sage_4libs_8singular_8function_call_function(__pyx_obj_4sage_4libs_8singular_8function_SingularFunction*, _object*, _object*, __pyx_opt_args_4sage_4libs_8singular_8f\nunction_call_function*) (function.cpp:13241)\n==13541==    by 0x2239CBA8: __pyx_pw_4sage_4libs_8singular_8function_16SingularFunction_5__call__(_object*, _object*, _object*) (function.cpp:11924)\n==13541==    by 0x4E742C2: PyObject_Call (abstract.c:2529)\n==13541==    by 0x4F160FC: PyEval_EvalFrameEx (ceval.c:4239)\n==13541==    by 0x4F19124: PyEval_EvalCodeEx (ceval.c:3253)\n==13541==    by 0x4E9C122: function_call (funcobject.c:526)\n==13541==    by 0x4E742C2: PyObject_Call (abstract.c:2529)\n==13541==    by 0x4F14C59: PyEval_EvalFrameEx (ceval.c:4334)\n==13541==    by 0x4F19124: PyEval_EvalCodeEx (ceval.c:3253)\n==13541==    by 0x4E9C122: function_call (funcobject.c:526)\n==13541==    by 0x4E742C2: PyObject_Call (abstract.c:2529)\n==13541==    by 0x4F14C59: PyEval_EvalFrameEx (ceval.c:4334)\n==13541==    by 0x4F19124: PyEval_EvalCodeEx (ceval.c:3253)\n==13541==    by 0x4E9C122: function_call (funcobject.c:526)\n==13541==    by 0x4E742C2: PyObject_Call (abstract.c:2529)\n==13541==    by 0xB29B841: __pyx_pw_4sage_4misc_9cachefunc_12CachedMethod_3_instance_call (cachefunc.c:9733)\n==13541==    by 0x4E742C2: PyObject_Call (abstract.c:2529)\n==13541==    by 0xB29C7D4: __pyx_pw_4sage_4misc_9cachefunc_18CachedMethodCaller_7__call__ (cachefunc.c:7254)\n==13541==    by 0x4E742C2: PyObject_Call (abstract.c:2529)\n```\n\nIs there a way to find out what singular_function or what cached method are involved?",
    "created_at": "2012-08-30T21:21:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11746#issuecomment-133437",
    "user": "https://github.com/simon-king-jena"
}
```

Hi Nils,

thank you for the sage.supp at #11918! When I run the tests of sage/rings/polynomial/infinite_polynomial_ring.py (which make Volker's patchbot at #12876 segfault, even though they are fine for me, I do not get a SIGILL. But I do get a considerable amount of lost memory:

```
==13541== 13,936 bytes in 1 blocks are definitely lost in loss record 8,673 of 8,997
==13541==    at 0x4C244E8: malloc (vg_replace_malloc.c:236)
==13541==    by 0x21E8984F: omAllocFromSystem (omAllocSystem.c:184)
==13541==    by 0x21E89A21: omAllocLarge (omAllocSystem.c:39)
==13541==    by 0x21BB3A00: iiAllStart(procinfo*, char*, feBufferTypes, int) (omalloc.h:2432)
==13541==    by 0x21BB3B95: iiPStart(idrec*, sleftv*) (iplib.cc:360)
==13541==    by 0x21BB4148: iiMake_proc(idrec*, sip_package*, sleftv*) (iplib.cc:482)
==13541==    by 0x2239B64D: __pyx_f_4sage_4libs_8singular_8function_call_function(__pyx_obj_4sage_4libs_8singular_8function_SingularFunction*, _object*, _object*, __pyx_opt_args_4sage_4libs_8singular_8f
unction_call_function*) (function.cpp:13241)
==13541==    by 0x2239CBA8: __pyx_pw_4sage_4libs_8singular_8function_16SingularFunction_5__call__(_object*, _object*, _object*) (function.cpp:11924)
==13541==    by 0x4E742C2: PyObject_Call (abstract.c:2529)
==13541==    by 0x4F160FC: PyEval_EvalFrameEx (ceval.c:4239)
==13541==    by 0x4F19124: PyEval_EvalCodeEx (ceval.c:3253)
==13541==    by 0x4E9C122: function_call (funcobject.c:526)
==13541==    by 0x4E742C2: PyObject_Call (abstract.c:2529)
==13541==    by 0x4F14C59: PyEval_EvalFrameEx (ceval.c:4334)
==13541==    by 0x4F19124: PyEval_EvalCodeEx (ceval.c:3253)
==13541==    by 0x4E9C122: function_call (funcobject.c:526)
==13541==    by 0x4E742C2: PyObject_Call (abstract.c:2529)
==13541==    by 0x4F14C59: PyEval_EvalFrameEx (ceval.c:4334)
==13541==    by 0x4F19124: PyEval_EvalCodeEx (ceval.c:3253)
==13541==    by 0x4E9C122: function_call (funcobject.c:526)
==13541==    by 0x4E742C2: PyObject_Call (abstract.c:2529)
==13541==    by 0xB29B841: __pyx_pw_4sage_4misc_9cachefunc_12CachedMethod_3_instance_call (cachefunc.c:9733)
==13541==    by 0x4E742C2: PyObject_Call (abstract.c:2529)
==13541==    by 0xB29C7D4: __pyx_pw_4sage_4misc_9cachefunc_18CachedMethodCaller_7__call__ (cachefunc.c:7254)
==13541==    by 0x4E742C2: PyObject_Call (abstract.c:2529)
```

Is there a way to find out what singular_function or what cached method are involved?



---

archive/issue_comments_133438.json:
```json
{
    "body": "Isn't it telling you?\n\n```\n==13541==    by 0x2239B64D: __pyx_f_4sage_4libs_8singular_8function_call_function(__pyx_obj_4sage_4libs_8singular_8function_SingularFunction*, _object*, _object*, __pyx_f_4sage_4libs_8singular_8function_call_function(__pyx_obj_4sage_4libs_8singular_8function_SingularFunction*, _object*, _object*, __pyx_opt_args_4sage_4libs_8singular_8f\nunction_call_function*) (function.cpp:13241)\n==13541==    by 0x2239CBA8: __pyx_pw_4sage_4libs_8singular_8function_16SingularFunction_5__call__(_object*, _object*, _object*) (function.cpp:11924)\n```\n\nYou should be able to look that line up: `(function.cpp:11924)`. I suppose that's a cython generated file, so the context there will tell you which function this is in the corresponding `function.pyx` file.\n\nI have no experience with valgrind myself. However, I think Python's memory management can confuse valgrind quite a bit. I was actually more hoping for a \"double free\" or \"access to freed memory block\" type error (i.e., illegal use of a pointer value.)\n\nIt may well be that my SIGILL is indeed a matter of mpfr on Corei7 compiling to something that's too fancy for valgrind and not a pointer to an error.",
    "created_at": "2012-08-30T21:58:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11746#issuecomment-133438",
    "user": "https://github.com/nbruin"
}
```

Isn't it telling you?

```
==13541==    by 0x2239B64D: __pyx_f_4sage_4libs_8singular_8function_call_function(__pyx_obj_4sage_4libs_8singular_8function_SingularFunction*, _object*, _object*, __pyx_f_4sage_4libs_8singular_8function_call_function(__pyx_obj_4sage_4libs_8singular_8function_SingularFunction*, _object*, _object*, __pyx_opt_args_4sage_4libs_8singular_8f
unction_call_function*) (function.cpp:13241)
==13541==    by 0x2239CBA8: __pyx_pw_4sage_4libs_8singular_8function_16SingularFunction_5__call__(_object*, _object*, _object*) (function.cpp:11924)
```

You should be able to look that line up: `(function.cpp:11924)`. I suppose that's a cython generated file, so the context there will tell you which function this is in the corresponding `function.pyx` file.

I have no experience with valgrind myself. However, I think Python's memory management can confuse valgrind quite a bit. I was actually more hoping for a "double free" or "access to freed memory block" type error (i.e., illegal use of a pointer value.)

It may well be that my SIGILL is indeed a matter of mpfr on Corei7 compiling to something that's too fancy for valgrind and not a pointer to an error.



---

archive/issue_comments_133439.json:
```json
{
    "body": "Replying to [comment:11 nbruin]:\n> Isn't it telling you?\n\nNo, it isn't. It just tells that it is a singular_function (as defined in sage.libs.singular.function), but it could be any function of Singular (std, slimgb, reduce, system, ...)",
    "created_at": "2012-08-30T22:02:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11746#issuecomment-133439",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:11 nbruin]:
> Isn't it telling you?

No, it isn't. It just tells that it is a singular_function (as defined in sage.libs.singular.function), but it could be any function of Singular (std, slimgb, reduce, system, ...)



---

archive/issue_comments_133440.json:
```json
{
    "body": "Replying to [comment:12 SimonKing]:\n> Replying to [comment:11 nbruin]:\n> > Isn't it telling you?\n> \n> No, it isn't. It just tells that it is a singular_function (as defined in sage.libs.singular.function), but it could be any function of Singular (std, slimgb, reduce, system, ...)\n\nOh, right. That's going to just as opaque as debugging python code with gdb then. I guess you could try and set a breakpoint at the function and then investigate the arguments? It's triggering `iiPStart` though. That might tell you something?\n\nAnyway, given that there's a good chance this is a false positive anyway, perhaps this call sequence might not be the one to concentrate on. I'd imagine `omalloc` plays tricks that would confuse valgrind (it's an advanced memory manager after all!), so `malloc` \"losing\" memory doesn't sound particularly worrisome to me.",
    "created_at": "2012-08-30T22:21:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11746#issuecomment-133440",
    "user": "https://github.com/nbruin"
}
```

Replying to [comment:12 SimonKing]:
> Replying to [comment:11 nbruin]:
> > Isn't it telling you?
> 
> No, it isn't. It just tells that it is a singular_function (as defined in sage.libs.singular.function), but it could be any function of Singular (std, slimgb, reduce, system, ...)

Oh, right. That's going to just as opaque as debugging python code with gdb then. I guess you could try and set a breakpoint at the function and then investigate the arguments? It's triggering `iiPStart` though. That might tell you something?

Anyway, given that there's a good chance this is a false positive anyway, perhaps this call sequence might not be the one to concentrate on. I'd imagine `omalloc` plays tricks that would confuse valgrind (it's an advanced memory manager after all!), so `malloc` "losing" memory doesn't sound particularly worrisome to me.



---

archive/issue_comments_133441.json:
```json
{
    "body": "Ping! Is anybody inclined to fix this? Sorry that my knowledge of valgrind is too limited for doing this myself.",
    "created_at": "2013-08-15T07:55:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11746#issuecomment-133441",
    "user": "https://github.com/simon-king-jena"
}
```

Ping! Is anybody inclined to fix this? Sorry that my knowledge of valgrind is too limited for doing this myself.



---

archive/issue_comments_133442.json:
```json
{
    "body": "This has been fixed with #15586.",
    "created_at": "2014-10-12T21:02:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11746#issuecomment-133442",
    "user": "https://github.com/a-andre"
}
```

This has been fixed with #15586.



---

archive/issue_comments_133443.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-10-12T21:02:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11746#issuecomment-133443",
    "user": "https://github.com/a-andre"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_133444.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-10-25T21:46:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11746#issuecomment-133444",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
