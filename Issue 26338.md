# Issue 26338: Doctest results starting with ...

archive/issues_026338.json:
```json
{
    "body": "CC:  @xcaruso @jdemeyer\n\nCurrently, the Sage doctest framework gives `ValueError in doctesting framework` if you try to start the doctest results with an ellipsis:\n\n```\nsage: from sage.doctest.parsing import SageDocTestParser\nsage: DTP = SageDocTestParser()\nsage: DTP.parse(\"sage: Zp(5,4,print_mode='digits')(5)\\n...00010\")\nTraceback (most recent call last):\n.../local/lib/python2.7/doctest.pyc in _check_prompt_blank(self, lines, indent, name, lineno)\n    787         for i, line in enumerate(lines):\n    788             if len(line) >= indent+4 and line[indent+3] != ' ':\n    789                 raise ValueError('line %r of the docstring for %s '\n    790                                  'lacks blank after %s: %r' %\n    791                                  (lineno+i+1, name,\n--> 792                                   line[indent:indent+3], line))\n...\nValueError: line 2 of the docstring for <string> lacks blank after ...: '...00010'\n```\n\nThe issue is that Python's doctester uses ellipses both for wildcard matching and for line continuations.  So when the first line begins with an ellipsis, it can't distinguish between the two uses.\n\nMost of the time in Sage, we use `....: ` for line continuation, so we don't have this ambiguity.  However, the doctesting framework still supports doctests written in plain Python.\n\nI propose the following: if the doctest contains a line beginning with the Python doctest marker `>>> `, we leave the behavior as is.  Otherwise, allow `...` at the beginning of the results to behave as a wildcard matcher.\n\nIssue created by migration from https://trac.sagemath.org/ticket/26575\n\n",
    "closed_at": "2018-11-04T13:11:03Z",
    "created_at": "2018-10-27T23:55:51Z",
    "labels": [
        "component: doctest framework",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.5",
    "title": "Doctest results starting with ...",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26338",
    "user": "https://github.com/roed314"
}
```
CC:  @xcaruso @jdemeyer

Currently, the Sage doctest framework gives `ValueError in doctesting framework` if you try to start the doctest results with an ellipsis:

```
sage: from sage.doctest.parsing import SageDocTestParser
sage: DTP = SageDocTestParser()
sage: DTP.parse("sage: Zp(5,4,print_mode='digits')(5)\n...00010")
Traceback (most recent call last):
.../local/lib/python2.7/doctest.pyc in _check_prompt_blank(self, lines, indent, name, lineno)
    787         for i, line in enumerate(lines):
    788             if len(line) >= indent+4 and line[indent+3] != ' ':
    789                 raise ValueError('line %r of the docstring for %s '
    790                                  'lacks blank after %s: %r' %
    791                                  (lineno+i+1, name,
--> 792                                   line[indent:indent+3], line))
...
ValueError: line 2 of the docstring for <string> lacks blank after ...: '...00010'
```

The issue is that Python's doctester uses ellipses both for wildcard matching and for line continuations.  So when the first line begins with an ellipsis, it can't distinguish between the two uses.

Most of the time in Sage, we use `....: ` for line continuation, so we don't have this ambiguity.  However, the doctesting framework still supports doctests written in plain Python.

I propose the following: if the doctest contains a line beginning with the Python doctest marker `>>> `, we leave the behavior as is.  Otherwise, allow `...` at the beginning of the results to behave as a wildcard matcher.

Issue created by migration from https://trac.sagemath.org/ticket/26575





---

archive/issue_comments_370484.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-10-28T02:02:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26338#issuecomment-370484",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_370485.json:
```json
{
    "body": "There are some doctest failures\n\n```\nsage -t --long --warn-long 99.5 src/sage/interfaces/tachyon.py  # 1 doctest failed\nsage -t --long --warn-long 99.5 src/sage/categories/category_with_axiom.py  # 1 doctest failed\nsage -t --long --warn-long 99.5 src/sage/tests/books/judson-abstract-algebra/homomorph-sage.py  # 1 doctest failed\nsage -t --long --warn-long 99.5 src/sage/interfaces/singular.py  # 1 doctest failed\nsage -t --long --warn-long 99.5 src/sage/interfaces/gap.py  # 1 doctest failed\nsage -t --long --warn-long 99.5 src/sage/rings/asymptotic/asymptotic_ring.py  # 1 doctest failed\nsage -t --long --warn-long 99.5 src/sage/misc/cython.py  # 2 doctests failed\n```\nwhich all seem to do with blank lines before tracebacks\n\n```\nFile \"src/sage/categories/category_with_axiom.py\", line 1758, in sage.categories.category_with_axiom.base_category_class_and_axiom\nFailed example:\n    base_category_class_and_axiom(Sets.Infinite)\nExpected:\n    Traceback (most recent call last):\n    ...\n    TypeError: Could not retrieve the base category class and axiom for <class 'sage.categories.sets_cat.Sets.Infinite'>.\n    ...\nGot:\n    <BLANKLINE>\n    Traceback (most recent call last):\n      File \"/home/roed/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 659, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/roed/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1070, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.categories.category_with_axiom.base_category_class_and_axiom[11]>\", line 1, in <module>\n        base_category_class_and_axiom(Sets.Infinite)\n      File \"/home/roed/sage/local/lib/python2.7/site-packages/sage/categories/category_with_axiom.py\", line 1796, in base_category_class_and_axiom\n        See CategoryWithAxiom for details.\"\"\".format(cls))\n    TypeError: Could not retrieve the base category class and axiom for <class 'sage.categories.sets_cat.Sets.Infinite'>.\n    Please specify it explicitly using the attribute _base_category_class_and_axiom.\n    See CategoryWithAxiom for details.\n**********************************************************************\n1 item had failures:\n   1 of  13 in sage.categories.category_with_axiom.base_category_class_and_axiom\n    [327 tests, 1 failure, 0.31 s]\n```\nI've seen these blank lines before, but I'm not sure what causes them....",
    "created_at": "2018-10-28T02:05:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26338#issuecomment-370485",
    "user": "https://github.com/roed314"
}
```

There are some doctest failures

```
sage -t --long --warn-long 99.5 src/sage/interfaces/tachyon.py  # 1 doctest failed
sage -t --long --warn-long 99.5 src/sage/categories/category_with_axiom.py  # 1 doctest failed
sage -t --long --warn-long 99.5 src/sage/tests/books/judson-abstract-algebra/homomorph-sage.py  # 1 doctest failed
sage -t --long --warn-long 99.5 src/sage/interfaces/singular.py  # 1 doctest failed
sage -t --long --warn-long 99.5 src/sage/interfaces/gap.py  # 1 doctest failed
sage -t --long --warn-long 99.5 src/sage/rings/asymptotic/asymptotic_ring.py  # 1 doctest failed
sage -t --long --warn-long 99.5 src/sage/misc/cython.py  # 2 doctests failed
```
which all seem to do with blank lines before tracebacks

```
File "src/sage/categories/category_with_axiom.py", line 1758, in sage.categories.category_with_axiom.base_category_class_and_axiom
Failed example:
    base_category_class_and_axiom(Sets.Infinite)
Expected:
    Traceback (most recent call last):
    ...
    TypeError: Could not retrieve the base category class and axiom for <class 'sage.categories.sets_cat.Sets.Infinite'>.
    ...
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/home/roed/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 659, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/roed/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1070, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.categories.category_with_axiom.base_category_class_and_axiom[11]>", line 1, in <module>
        base_category_class_and_axiom(Sets.Infinite)
      File "/home/roed/sage/local/lib/python2.7/site-packages/sage/categories/category_with_axiom.py", line 1796, in base_category_class_and_axiom
        See CategoryWithAxiom for details.""".format(cls))
    TypeError: Could not retrieve the base category class and axiom for <class 'sage.categories.sets_cat.Sets.Infinite'>.
    Please specify it explicitly using the attribute _base_category_class_and_axiom.
    See CategoryWithAxiom for details.
**********************************************************************
1 item had failures:
   1 of  13 in sage.categories.category_with_axiom.base_category_class_and_axiom
    [327 tests, 1 failure, 0.31 s]
```
I've seen these blank lines before, but I'm not sure what causes them....



---

archive/issue_comments_370486.json:
```json
{
    "body": "I just merged (and resolved conflicts) with sage 8.5.beta1",
    "created_at": "2018-10-28T03:10:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26338#issuecomment-370486",
    "user": "https://github.com/xcaruso"
}
```

I just merged (and resolved conflicts) with sage 8.5.beta1



---

archive/issue_comments_370487.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-11-01T21:17:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26338#issuecomment-370487",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_370488.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-11-01T21:58:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26338#issuecomment-370488",
    "user": "https://github.com/roed314"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_370489.json:
```json
{
    "body": "all tests pass\n\n---\nNew commits:",
    "created_at": "2018-11-01T22:55:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26338#issuecomment-370489",
    "user": "https://github.com/roed314"
}
```

all tests pass

---
New commits:



---

archive/issue_comments_370490.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-11-01T22:55:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26338#issuecomment-370490",
    "user": "https://github.com/xcaruso"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_370491.json:
```json
{
    "body": "Great. Then everything's alright, I give a positive review.",
    "created_at": "2018-11-01T22:55:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26338#issuecomment-370491",
    "user": "https://github.com/xcaruso"
}
```

Great. Then everything's alright, I give a positive review.



---

archive/issue_comments_370492.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-11-04T13:11:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26338#issuecomment-370492",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_065980.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-11-04T13:11:03Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26338",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26338#event-65980"
}
```
