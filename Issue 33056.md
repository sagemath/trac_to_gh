# Issue 33056: checking doctest output is too slow

Issue created by migration from https://trac.sagemath.org/ticket/33293

Original creator: @mwageringel

Original creation time: 2022-02-05 14:38:03

The computation in this doctest takes a few seconds, but checking the output takes the doctest framework more than 4 minutes. There is no warning about this taking a long time.

```
sage: a = ZZ['x'](range(100000))
sage: R = Integers(3)['x']
sage: R(a)  # long time (7s on sage.math, 2013)
2*x^99998 + ... + x
```

It would be easy to rewrite the last line to make it fast, but ideally

- parsing the doctest output should be faster
- long time warnings should take into account the time it takes to check the output in order to make it easier to find slow doctests like this one


After deleting this doctest:

```
sage -t --long --warn-long 30.0 --random-seed=127464012278616651004415010266788953280 src/sage/rings/polynomial/polynomial_zmod_flint.pyx
    [140 tests, 0.26 s]
```

Before:

```
sage -t --long --warn-long 30.0 --random-seed=47006518779514815594404376050243712990 src/sage/rings/polynomial/polynomial_zmod_flint.pyx
    [143 tests, 267.67 s]
```



---

Comment by @mwageringel created at 2022-02-05 14:39:38

It would be interesting to know whether it has always been this slow or whether this is a recent change.


---

Comment by mjo created at 2022-02-06 02:29:23

I found and fixed the problem (see the commit message). I still think it would be a good idea to include the comparison time in the `--warn-long` numbers though. And of course, for this one test, it would be better to check the two terms of this polynomial that we actually care about rather than using a regex on its enormous string representation.
----
New commits:


---

Comment by git created at 2022-02-06 02:37:04

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @mwageringel created at 2022-02-06 12:39:08

Thank you. I think we should also change this regular expression:


```diff
-ld_warning_regex = re.compile(r'.*dylib.*was built for newer macOS version.*than being linked.*')
+ld_warning_regex = re.compile(r'^.*dylib.*was built for newer macOS version.*than being linked.*')
```


It is used with `re.sub()` which looks for all occurrences of the pattern in a string, so using `.*` at the front leads to accidentally quadratic runtime.

Meanwhile, I have only found two more doctests that were slowed down a lot due to the same problem

```
File "src/sage/rings/integer.pyx", line 6667, in sage.rings.integer.Integer.inverse_mod
    c = a.inverse_mod(a*a)   # long time
File "src/sage/schemes/elliptic_curves/isogeny_small_degree.py", line 1553, in sage.schemes.elliptic_curves.isogeny_small_degree.Psi2
    Psi2(71)  # long time (1 second)
```

which took about 77 and 190 seconds.


Replying to [comment:2 mjo]:
> I still think it would be a good idea to include the comparison time in the `--warn-long` numbers though.

Should this be a new ticket or done here? I can create a branch for that.


---

Comment by chapoton created at 2022-02-06 13:30:28

will conflict with #33142


---

Comment by git created at 2022-02-06 13:52:07

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mjo created at 2022-02-06 14:05:08

Replying to [comment:4 gh-mwageringel]:
> 
> Should this be a new ticket or done here? I can create a branch for that.

Either way. I have a vaguely conflicting branch in #32981 but it won't be hard to rebase.

The timing information is currently obtained in `forker.py` within the `compile_and_execute()` method:


```python
timer = Timer().start()
try:
    compiled = compiler(example)
    timer.start()    # reset timer                                                                                                                                   
    exec(compiled, globs)
    finally:
        timer.stop().annotate(example)
```


That's used in `_run()`, and we check the output after `compile_and_execute()` has been run and the timing information already obtained.

The cleanest way to update that might be to use a separate timer for the output checking, and to simply add up the two numbers at the end? Otherwise we'd have to pull the timer up out of `compile_and_execute()` and into `_run()` so that we can stop it after the output has been checked.


---

Comment by @mwageringel created at 2022-02-06 17:51:55

Changing status from new to needs_review.


---

Comment by @mwageringel created at 2022-02-06 17:51:55

Replying to [comment:8 mjo]:
> Replying to [comment:4 gh-mwageringel]:
> > 
> > Should this be a new ticket or done here? I can create a branch for that.
> 
> Either way. I have a vaguely conflicting branch in #32981 but it won't be hard to rebase.

Ok, I will open a new ticket then to avoid unnecessary conflicts, as the current branch seems already good to me.

> The cleanest way to update that might be to use a separate timer for the output checking, and to simply add up the two numbers at the end? Otherwise we'd have to pull the timer up out of `compile_and_execute()` and into `_run()` so that we can stop it after the output has been checked.

The first option would allow to make the warning message more informative, as we can report which part of the test is slow. My approach would have been to measure the wall time from before the test is run until after the check is done. Then the difference with the wall time from the timer in `compile_and_execute` should give the overall overhead of checking the output and also compiling the test etc. This would conflict with #32981 though, I think.

If we add a separate timer just for the output checking, should it measure cpu time rather than wall time?


---

Comment by slelievre created at 2022-02-06 17:56:24

Does the modified doctest still need to be marked long?

Even checking all the coefficients does not take all that long.

```
sage: %time a = ZZ['x'](range(100000))
CPU times: user 15 ms, sys: 2.45 ms, total: 17.4 ms
Wall time: 18 ms
sage: %time R = Integers(3)['x']
CPU times: user 13.6 ms, sys: 3.9 ms, total: 17.5 ms
Wall time: 18.5 ms
sage: %time p = R(a)
CPU times: user 59.4 ms, sys: 4.54 ms, total: 64 ms
Wall time: 64.5 ms
sage: %time p.list() == [0, 1, 2] * 33333
CPU times: user 275 ms, sys: 5.17 ms, total: 281 ms
Wall time: 283 ms
True
```



---

Comment by git created at 2022-02-06 18:08:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mjo created at 2022-02-06 18:09:11

Replying to [comment:10 slelievre]:
> Does the modified doctest still need to be marked long?
> 
> Even checking all the coefficients does not take all that long.

Right, good catch.


---

Comment by mjo created at 2022-02-06 18:15:06

Replying to [comment:9 gh-mwageringel]:
> 
> If we add a separate timer just for the output checking, should it measure cpu time rather than wall time?

For now, I would say yes. CPU time still isn't perfect because it depends on your CPU, optimization flags, and so on. But wall time is just completely crazy. (I don't know if our implementation does this, but using wall time in general risks e.g. getting outrageous answers twice a year at 2am due to daylight savings time).

In #33022 we'll replace CPU time with the amount of time that it takes to perform some computation. That should minimize the difference due to CPU type and compiler flags.


---

Comment by slelievre created at 2022-02-06 19:02:18

The test in `schemes/elliptic_curves/isogeny_small_degree.py`
also became fast:

```
sage: %time from sage.schemes.elliptic_curves.isogeny_small_degree import Psi2
CPU times: user 18.4 ms, sys: 4.92 ms, total: 23.3 ms
Wall time: 24.7 ms
sage: %time Psi2(11)
CPU times: user 109 ms, sys: 30.7 ms, total: 140 ms
Wall time: 240 ms
x^5 - 55*x^4*u + 994*x^3*u^2 - 8774*x^2*u^3 + 41453*x*u^4 - 928945/11*u^5 + 33*x^4 + 276*x^3*u - 7794*x^2*u^2 + 4452*x*u^3 + 1319331/11*u^4 + 216*x^3*v - 4536*x^2*u*v + 31752*x*u^2*v - 842616/11*u^3*v + 162*x^3 + 38718*x^2*u - 610578*x*u^2 + 33434694/11*u^3 - 4536*x^2*v + 73872*x*u*v - 2745576/11*u^2*v - 16470*x^2 + 580068*x*u - 67821354/11*u^2 - 185976*x*v + 14143896/11*u*v + 7533*x - 20437029/11*u - 12389112/11*v + 19964151/11
sage: %time p = Psi2(71)
CPU times: user 578 ms, sys: 8.28 ms, total: 586 ms
Wall time: 595 ms
sage: %time (x,u,v) = p.variables()
CPU times: user 374 µs, sys: 33 µs, total: 407 µs
Wall time: 409 µs
sage: %time p.coefficient({x: 0, u: 210, v: 0})
CPU times: user 171 µs, sys: 28 µs, total: 199 µs
Wall time: 203 µs
-2209380711722505179506258739515288584116147237393815266468076436521/71
sage: %time p.coefficient({x: 0, u: 0, v: 0})
CPU times: user 128 µs, sys: 0 ns, total: 128 µs
Wall time: 131 µs
-14790739586438315394567393301990769678157425619440464678252277649/71
```



---

Comment by slelievre created at 2022-02-06 19:02:25

The reworked `rings/polynomial/polynomial_zmod_flint.pyx`
doctest lost some information.

This would contain all the same information.

```
sage: d, v = p.degree(), p.valuation()
sage: d, v
(99998, 1)
sage: p[d], p[v]
(2, 1)
```



---

Comment by slelievre created at 2022-02-06 19:04:04

With `p` from the `polynomial_zmod_flint.pyx` doctest,
here is something slow:

```
sage: %time str(p) == str(p)
CPU times: user 7.71 s, sys: 309 ms, total: 8.02 s
Wall time: 8.04 s
True
```



---

Comment by git created at 2022-02-06 20:56:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mwageringel created at 2022-02-14 21:10:38

Changing status from needs_review to positive_review.


---

Comment by @mwageringel created at 2022-02-14 21:10:38

All the suggestions have been implemented, so I think we can move forward with this. Please revert this, Samuel, in case you have further concerns.

I do not understand what is wrong with the patchbot though, but the tests have passed already with the previous beta.


---

Comment by slelievre created at 2022-02-15 00:16:55

No further concerns, comment:14 was maybe a bit hasty.

The `psi2` doctest might in fact still qualify for the
`# long time` marker.

Frédéric, do you understand the "doctest continuation"
patchbot plugin reports?


---

Comment by @mwageringel created at 2022-02-15 07:32:16

Replying to [comment:20 slelievre]:
> Frédéric, do you understand the "doctest continuation"
> patchbot plugin reports?

The continuation plugin is about checking the `....:` syntax of continuation lines. The plugin failure seems to be a false positive.

Though, at the time of my previous comment, the bot was stuck in status "pending" which is what I did not understand. The bot had already moved on to other tickets. Only after telling it to retry this ticket, it actually ran the tests – and the previous "pending" report was replaced by the new report.


---

Comment by vbraun created at 2022-02-20 13:27:33

Resolution: fixed


---

Comment by @mwageringel created at 2022-02-23 20:02:33

Replying to [comment:2 mjo]:
> I still think it would be a good idea to include the comparison time in the `--warn-long` numbers though.

I have opened #33411 for this.
