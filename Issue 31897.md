# Issue 31897: Doctests in src/sage/modular/local_comp/local_comp.py make patchbots fail

archive/issues_031897.json:
```json
{
    "body": "CC:  @dimpase @kliem @slel\n\n#30801 adapted some doctests by using Python sets. However, those are displayd in arbitrary order, which breaks parchbots:\n\n\n```\nsage -t --long --random-seed=0 src/sage/modular/local_comp/local_comp.py\n**********************************************************************\nFile \"src/sage/modular/local_comp/local_comp.py\", line 653, in sage.modular.local_comp.local_comp.PrimitiveSupercuspidal.characters\nFailed example:\n    set(Pi.characters())\nExpected:\n    {Character of unramified extension Q_5(s)* (s^2 + 4*s + 2 = 0), of level 1, mapping s |--> 1/3*j0^2*d - 1/3*j0^3, 5 |--> 5,\n     Character of unramified extension Q_5(s)* (s^2 + 4*s + 2 = 0), of level 1, mapping s |--> -1/3*j0^2*d, 5 |--> 5}\nGot:\n    {Character of unramified extension Q_5(s)* (s^2 + 4*s + 2 = 0), of level 1, mapping s |--> -1/3*j0^2*d, 5 |--> 5,\n     Character of unramified extension Q_5(s)* (s^2 + 4*s + 2 = 0), of level 1, mapping s |--> 1/3*j0^2*d - 1/3*j0^3, 5 |--> 5}\n**********************************************************************\n```\n\n\nThis tickets tries to fix that, by using lists.\n\nIssue created by migration from https://trac.sagemath.org/ticket/32134\n\n",
    "created_at": "2021-07-05T14:05:14Z",
    "labels": [
        "doctest framework",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Doctests in src/sage/modular/local_comp/local_comp.py make patchbots fail",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31897",
    "user": "tmonteil"
}
```
CC:  @dimpase @kliem @slel

#30801 adapted some doctests by using Python sets. However, those are displayd in arbitrary order, which breaks parchbots:


```
sage -t --long --random-seed=0 src/sage/modular/local_comp/local_comp.py
**********************************************************************
File "src/sage/modular/local_comp/local_comp.py", line 653, in sage.modular.local_comp.local_comp.PrimitiveSupercuspidal.characters
Failed example:
    set(Pi.characters())
Expected:
    {Character of unramified extension Q_5(s)* (s^2 + 4*s + 2 = 0), of level 1, mapping s |--> 1/3*j0^2*d - 1/3*j0^3, 5 |--> 5,
     Character of unramified extension Q_5(s)* (s^2 + 4*s + 2 = 0), of level 1, mapping s |--> -1/3*j0^2*d, 5 |--> 5}
Got:
    {Character of unramified extension Q_5(s)* (s^2 + 4*s + 2 = 0), of level 1, mapping s |--> -1/3*j0^2*d, 5 |--> 5,
     Character of unramified extension Q_5(s)* (s^2 + 4*s + 2 = 0), of level 1, mapping s |--> 1/3*j0^2*d - 1/3*j0^3, 5 |--> 5}
**********************************************************************
```


This tickets tries to fix that, by using lists.

Issue created by migration from https://trac.sagemath.org/ticket/32134





---

archive/issue_comments_455751.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-07-05T14:10:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31897#issuecomment-455751",
    "user": "tmonteil"
}
```

New commits:



---

archive/issue_comments_455752.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-07-05T14:10:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31897#issuecomment-455752",
    "user": "tmonteil"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_455753.json:
```json
{
    "body": "see #29977",
    "created_at": "2021-07-05T15:40:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31897#issuecomment-455753",
    "user": "@fchapoton"
}
```

see #29977



---

archive/issue_comments_455754.json:
```json
{
    "body": "Replying to [comment:3 chapoton]:\n> see #29977\n\nI created this ticket because that particular issue has no link with random seeds, which is the purpose of #29977, see the comment ticket:29977#comment:28",
    "created_at": "2021-07-05T16:04:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31897#issuecomment-455754",
    "user": "tmonteil"
}
```

Replying to [comment:3 chapoton]:
> see #29977

I created this ticket because that particular issue has no link with random seeds, which is the purpose of #29977, see the comment ticket:29977#comment:28



---

archive/issue_comments_455755.json:
```json
{
    "body": "The \"set\" were added very recently in #30801",
    "created_at": "2021-07-05T16:19:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31897#issuecomment-455755",
    "user": "@fchapoton"
}
```

The "set" were added very recently in #30801



---

archive/issue_comments_455756.json:
```json
{
    "body": "Btw, you don't use lists:\n\n\n```\nsage: f = Newforms(GammaH(25, [6]), 3, names='j')[0]                            \nsage: Pi = LocalComponent(f, 5)                                                 \nsage: type(Pi.characters())                                                     \n<class 'sage.structure.sequence.Sequence_generic'>\n```\n",
    "created_at": "2021-07-05T16:35:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31897#issuecomment-455756",
    "user": "@kliem"
}
```

Btw, you don't use lists:


```
sage: f = Newforms(GammaH(25, [6]), 3, names='j')[0]                            
sage: Pi = LocalComponent(f, 5)                                                 
sage: type(Pi.characters())                                                     
<class 'sage.structure.sequence.Sequence_generic'>
```




---

archive/issue_comments_455757.json:
```json
{
    "body": "Why is replacing one apparently unstable order with another apparently unstable order a good fix?\nI didn't add `set()` just for fun in #30801.",
    "created_at": "2021-07-06T09:59:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31897#issuecomment-455757",
    "user": "@dimpase"
}
```

Why is replacing one apparently unstable order with another apparently unstable order a good fix?
I didn't add `set()` just for fun in #30801.



---

archive/issue_comments_455758.json:
```json
{
    "body": "That is exactly why I didn't want to put it on positive review. I would really prefer `sorted` with `key=str`. That appears to be stable and if we think it's not pretty, we can figure out something nicer later.",
    "created_at": "2021-07-06T10:14:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31897#issuecomment-455758",
    "user": "@kliem"
}
```

That is exactly why I didn't want to put it on positive review. I would really prefer `sorted` with `key=str`. That appears to be stable and if we think it's not pretty, we can figure out something nicer later.



---

archive/issue_comments_455759.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-07-06T10:14:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31897#issuecomment-455759",
    "user": "@kliem"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_455760.json:
```json
{
    "body": "Replying to [comment:8 gh-kliem]:\n> I would really prefer `sorted` with `key=str`.\n+1",
    "created_at": "2021-07-06T13:00:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31897#issuecomment-455760",
    "user": "@mkoeppe"
}
```

Replying to [comment:8 gh-kliem]:
> I would really prefer `sorted` with `key=str`.
+1



---

archive/issue_comments_455761.json:
```json
{
    "body": "I would also vote for a hotfix using the order given\nby string representations.\n\nThen we can calmly investigate what causes the different\ndisplay order, and find a nicer fix.",
    "created_at": "2021-07-06T13:15:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31897#issuecomment-455761",
    "user": "@slel"
}
```

I would also vote for a hotfix using the order given
by string representations.

Then we can calmly investigate what causes the different
display order, and find a nicer fix.



---

archive/issue_comments_455762.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-07-06T13:22:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31897#issuecomment-455762",
    "user": "@kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_455763.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2021-07-06T13:22:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31897#issuecomment-455763",
    "user": "@kliem"
}
```

Changing priority from major to critical.



---

archive/issue_comments_455764.json:
```json
{
    "body": "Moving this up to critical, as the issue reduces patchbot capacity by 50 percent and slows down review process of all tickets.\n----\nNew commits:",
    "created_at": "2021-07-06T13:22:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31897#issuecomment-455764",
    "user": "@kliem"
}
```

Moving this up to critical, as the issue reduces patchbot capacity by 50 percent and slows down review process of all tickets.
----
New commits:



---

archive/issue_comments_455765.json:
```json
{
    "body": "this is in part collides with #29977",
    "created_at": "2021-07-06T14:24:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31897#issuecomment-455765",
    "user": "@dimpase"
}
```

this is in part collides with #29977



---

archive/issue_comments_455766.json:
```json
{
    "body": "Replying to [comment:6 gh-kliem]:\n> Btw, you don't use lists:\n> \n> {{{\n> sage: f = Newforms(GammaH(25, [6]), 3, names='j')[0]                            \n> sage: Pi = LocalComponent(f, 5)                                                 \n> sage: type(Pi.characters())                                                     \n> <class 'sage.structure.sequence.Sequence_generic'>\n> }}}\n\nIndeed.\n\nReplying to [comment:7 dimpase]:\n> Why is replacing one apparently unstable order with another apparently unstable order a good fix?\n> I didn't add `set()` just for fun in #30801.\n\nI was asking the same question, but I did not see any evidence (i might have missed something though). If the raw use of `Pi.characters()` is only *apparently* unstable, then i am not in favor to work around it, which is why i asked, otherwise we might end up sorting every Sage doctest. If there is a configuration that does not provide that order, which one it is ? If this is about the 32 vs 64 bit architecture, then why not specify it with two dedicated doctests ?\n\nReplying to [comment:11 slelievre]:\n> I would also vote for a hotfix using the order given\n> by string representations.\n> \n> Then we can calmly investigate what causes the different\n> display order, and find a nicer fix.\n\nOK, then could you please all try the [straightforward branch](https://git.sagemath.org/sage.git/log/?h=u/tmonteil/doctests_in_src_sage_modular_local_comp_local_comp_py_make_patchbots_fail) and tell if is passes on your various computers, so that we could see whether it can break and understand the cause (for example, it seems not related to the choice of the random seed).",
    "created_at": "2021-07-06T14:25:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31897#issuecomment-455766",
    "user": "tmonteil"
}
```

Replying to [comment:6 gh-kliem]:
> Btw, you don't use lists:
> 
> {{{
> sage: f = Newforms(GammaH(25, [6]), 3, names='j')[0]                            
> sage: Pi = LocalComponent(f, 5)                                                 
> sage: type(Pi.characters())                                                     
> <class 'sage.structure.sequence.Sequence_generic'>
> }}}

Indeed.

Replying to [comment:7 dimpase]:
> Why is replacing one apparently unstable order with another apparently unstable order a good fix?
> I didn't add `set()` just for fun in #30801.

I was asking the same question, but I did not see any evidence (i might have missed something though). If the raw use of `Pi.characters()` is only *apparently* unstable, then i am not in favor to work around it, which is why i asked, otherwise we might end up sorting every Sage doctest. If there is a configuration that does not provide that order, which one it is ? If this is about the 32 vs 64 bit architecture, then why not specify it with two dedicated doctests ?

Replying to [comment:11 slelievre]:
> I would also vote for a hotfix using the order given
> by string representations.
> 
> Then we can calmly investigate what causes the different
> display order, and find a nicer fix.

OK, then could you please all try the [straightforward branch](https://git.sagemath.org/sage.git/log/?h=u/tmonteil/doctests_in_src_sage_modular_local_comp_local_comp_py_make_patchbots_fail) and tell if is passes on your various computers, so that we could see whether it can break and understand the cause (for example, it seems not related to the choice of the random seed).



---

archive/issue_comments_455767.json:
```json
{
    "body": "Replying to [comment:14 tmonteil]:\n> Replying to [comment:6 gh-kliem]:\n> > Btw, you don't use lists:\n> > \n> > {{{\n> > sage: f = Newforms(GammaH(25, [6]), 3, names='j')[0]                            \n> > sage: Pi = LocalComponent(f, 5)                                                 \n> > sage: type(Pi.characters())                                                     \n> > <class 'sage.structure.sequence.Sequence_generic'>\n> > }}}\n> \n> Indeed.\n> \n> Replying to [comment:7 dimpase]:\n> > Why is replacing one apparently unstable order with another apparently unstable order a good fix?\n> > I didn't add `set()` just for fun in #30801.\n> \n> I was asking the same question, but I did not see any evidence (i might have missed something though). If the raw use of `Pi.characters()` is only *apparently* unstable, then i am not in favor to work around it, which is why i asked, otherwise we might end up sorting every Sage doctest. If there is a configuration that does not provide that order, which one it is ? If this is about the 32 vs 64 bit architecture, then why not specify it with two dedicated doctests ?\n> \n> Replying to [comment:11 slelievre]:\n> > I would also vote for a hotfix using the order given\n> > by string representations.\n> > \n> > Then we can calmly investigate what causes the different\n> > display order, and find a nicer fix.\n> \n> OK, then could you please all try the [straightforward branch](https://git.sagemath.org/sage.git/log/?h=u/tmonteil/doctests_in_src_sage_modular_local_comp_local_comp_py_make_patchbots_fail) and tell if is passes on your various computers, so that we could see whether it can break and understand the cause (for example, it seems not related to the choice of the random seed).\n\nhttps://github.com/kliem/sage/pull/47/checks\n\nAs #29977 is now positively review, we can now also go back to your branch and see whether this works.",
    "created_at": "2021-07-06T14:45:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31897#issuecomment-455767",
    "user": "@kliem"
}
```

Replying to [comment:14 tmonteil]:
> Replying to [comment:6 gh-kliem]:
> > Btw, you don't use lists:
> > 
> > {{{
> > sage: f = Newforms(GammaH(25, [6]), 3, names='j')[0]                            
> > sage: Pi = LocalComponent(f, 5)                                                 
> > sage: type(Pi.characters())                                                     
> > <class 'sage.structure.sequence.Sequence_generic'>
> > }}}
> 
> Indeed.
> 
> Replying to [comment:7 dimpase]:
> > Why is replacing one apparently unstable order with another apparently unstable order a good fix?
> > I didn't add `set()` just for fun in #30801.
> 
> I was asking the same question, but I did not see any evidence (i might have missed something though). If the raw use of `Pi.characters()` is only *apparently* unstable, then i am not in favor to work around it, which is why i asked, otherwise we might end up sorting every Sage doctest. If there is a configuration that does not provide that order, which one it is ? If this is about the 32 vs 64 bit architecture, then why not specify it with two dedicated doctests ?
> 
> Replying to [comment:11 slelievre]:
> > I would also vote for a hotfix using the order given
> > by string representations.
> > 
> > Then we can calmly investigate what causes the different
> > display order, and find a nicer fix.
> 
> OK, then could you please all try the [straightforward branch](https://git.sagemath.org/sage.git/log/?h=u/tmonteil/doctests_in_src_sage_modular_local_comp_local_comp_py_make_patchbots_fail) and tell if is passes on your various computers, so that we could see whether it can break and understand the cause (for example, it seems not related to the choice of the random seed).

https://github.com/kliem/sage/pull/47/checks

As #29977 is now positively review, we can now also go back to your branch and see whether this works.



---

archive/issue_comments_455768.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-07-29T11:52:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31897#issuecomment-455768",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_455769.json:
```json
{
    "body": "Does this make bots happy?",
    "created_at": "2021-07-29T15:38:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31897#issuecomment-455769",
    "user": "@dimpase"
}
```

Does this make bots happy?



---

archive/issue_comments_455770.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-07-29T15:38:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31897#issuecomment-455770",
    "user": "@dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_455771.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2021-07-29T15:48:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31897#issuecomment-455771",
    "user": "tmonteil"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_455772.json:
```json
{
    "body": "Replying to [comment:18 dimpase]:\n> Does this make bots happy?\n\nI think we have to let 32bit bots to work on it. I will work on setting one up later in the summer. Let us keep this ticket to \"needs review\" so that bots can work on it.\n\nI encourage everybody to try this branch to see if something wrong appears.",
    "created_at": "2021-07-29T15:48:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31897#issuecomment-455772",
    "user": "tmonteil"
}
```

Replying to [comment:18 dimpase]:
> Does this make bots happy?

I think we have to let 32bit bots to work on it. I will work on setting one up later in the summer. Let us keep this ticket to "needs review" so that bots can work on it.

I encourage everybody to try this branch to see if something wrong appears.



---

archive/issue_comments_455773.json:
```json
{
    "body": "it works on 32-bit too.",
    "created_at": "2021-08-14T20:04:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31897#issuecomment-455773",
    "user": "@dimpase"
}
```

it works on 32-bit too.



---

archive/issue_comments_455774.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-08-14T20:04:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31897#issuecomment-455774",
    "user": "@dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_455775.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-08-29T09:38:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31897#issuecomment-455775",
    "user": "@vbraun"
}
```

Resolution: fixed
