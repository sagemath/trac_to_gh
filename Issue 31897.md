# Issue 31897: Doctests in src/sage/modular/local_comp/local_comp.py make patchbots fail

Issue created by migration from https://trac.sagemath.org/ticket/32134

Original creator: tmonteil

Original creation time: 2021-07-05 14:05:14

CC:  dimpase @kliem slelievre

#30801 adapted some doctests by using Python sets. However, those are displayd in arbitrary order, which breaks parchbots:


```
sage -t --long --random-seed=0 src/sage/modular/local_comp/local_comp.py
**********************************************************************
File "src/sage/modular/local_comp/local_comp.py", line 653, in sage.modular.local_comp.local_comp.PrimitiveSupercuspidal.characters
Failed example:
    set(Pi.characters())
Expected:
    {Character of unramified extension Q_5(s)* (s^2 + 4*s + 2 = 0), of level 1, mapping s |--> 1/3*j0^2*d - 1/3*j0^3, 5 |--> 5,
     Character of unramified extension Q_5(s)* (s^2 + 4*s + 2 = 0), of level 1, mapping s |--> -1/3*j0^2*d, 5 |--> 5}
Got:
    {Character of unramified extension Q_5(s)* (s^2 + 4*s + 2 = 0), of level 1, mapping s |--> -1/3*j0^2*d, 5 |--> 5,
     Character of unramified extension Q_5(s)* (s^2 + 4*s + 2 = 0), of level 1, mapping s |--> 1/3*j0^2*d - 1/3*j0^3, 5 |--> 5}
**********************************************************************
```


This tickets tries to fix that, by using lists.


---

Comment by tmonteil created at 2021-07-05 14:10:13

New commits:


---

Comment by tmonteil created at 2021-07-05 14:10:13

Changing status from new to needs_review.


---

Comment by chapoton created at 2021-07-05 15:40:00

see #29977


---

Comment by tmonteil created at 2021-07-05 16:04:16

Replying to [comment:3 chapoton]:
> see #29977

I created this ticket because that particular issue has no link with random seeds, which is the purpose of #29977, see the comment ticket:29977#comment:28


---

Comment by chapoton created at 2021-07-05 16:19:41

The "set" were added very recently in #30801


---

Comment by @kliem created at 2021-07-05 16:35:13

Btw, you don't use lists:


```
sage: f = Newforms(GammaH(25, [6]), 3, names='j')[0]                            
sage: Pi = LocalComponent(f, 5)                                                 
sage: type(Pi.characters())                                                     
<class 'sage.structure.sequence.Sequence_generic'>
```



---

Comment by dimpase created at 2021-07-06 09:59:36

Why is replacing one apparently unstable order with another apparently unstable order a good fix?
I didn't add `set()` just for fun in #30801.


---

Comment by @kliem created at 2021-07-06 10:14:11

That is exactly why I didn't want to put it on positive review. I would really prefer `sorted` with `key=str`. That appears to be stable and if we think it's not pretty, we can figure out something nicer later.


---

Comment by @kliem created at 2021-07-06 10:14:19

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-07-06 13:00:40

Replying to [comment:8 gh-kliem]:
> I would really prefer `sorted` with `key=str`.
+1


---

Comment by slelievre created at 2021-07-06 13:15:02

I would also vote for a hotfix using the order given
by string representations.

Then we can calmly investigate what causes the different
display order, and find a nicer fix.


---

Comment by @kliem created at 2021-07-06 13:22:26

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2021-07-06 13:22:26

Changing priority from major to critical.


---

Comment by @kliem created at 2021-07-06 13:22:26

Moving this up to critical, as the issue reduces patchbot capacity by 50 percent and slows down review process of all tickets.
----
New commits:


---

Comment by dimpase created at 2021-07-06 14:24:03

this is in part collides with #29977


---

Comment by tmonteil created at 2021-07-06 14:25:26

Replying to [comment:6 gh-kliem]:
> Btw, you don't use lists:
> 
> {{{
> sage: f = Newforms(GammaH(25, [6]), 3, names='j')[0]                            
> sage: Pi = LocalComponent(f, 5)                                                 
> sage: type(Pi.characters())                                                     
> <class 'sage.structure.sequence.Sequence_generic'>
> }}}

Indeed.

Replying to [comment:7 dimpase]:
> Why is replacing one apparently unstable order with another apparently unstable order a good fix?
> I didn't add `set()` just for fun in #30801.

I was asking the same question, but I did not see any evidence (i might have missed something though). If the raw use of `Pi.characters()` is only _apparently_ unstable, then i am not in favor to work around it, which is why i asked, otherwise we might end up sorting every Sage doctest. If there is a configuration that does not provide that order, which one it is ? If this is about the 32 vs 64 bit architecture, then why not specify it with two dedicated doctests ?

Replying to [comment:11 slelievre]:
> I would also vote for a hotfix using the order given
> by string representations.
> 
> Then we can calmly investigate what causes the different
> display order, and find a nicer fix.

OK, then could you please all try the [straightforward branch](https://git.sagemath.org/sage.git/log/?h=u/tmonteil/doctests_in_src_sage_modular_local_comp_local_comp_py_make_patchbots_fail) and tell if is passes on your various computers, so that we could see whether it can break and understand the cause (for example, it seems not related to the choice of the random seed).


---

Comment by @kliem created at 2021-07-06 14:45:38

Replying to [comment:14 tmonteil]:
> Replying to [comment:6 gh-kliem]:
> > Btw, you don't use lists:
> > 
> > {{{
> > sage: f = Newforms(GammaH(25, [6]), 3, names='j')[0]                            
> > sage: Pi = LocalComponent(f, 5)                                                 
> > sage: type(Pi.characters())                                                     
> > <class 'sage.structure.sequence.Sequence_generic'>
> > }}}
> 
> Indeed.
> 
> Replying to [comment:7 dimpase]:
> > Why is replacing one apparently unstable order with another apparently unstable order a good fix?
> > I didn't add `set()` just for fun in #30801.
> 
> I was asking the same question, but I did not see any evidence (i might have missed something though). If the raw use of `Pi.characters()` is only _apparently_ unstable, then i am not in favor to work around it, which is why i asked, otherwise we might end up sorting every Sage doctest. If there is a configuration that does not provide that order, which one it is ? If this is about the 32 vs 64 bit architecture, then why not specify it with two dedicated doctests ?
> 
> Replying to [comment:11 slelievre]:
> > I would also vote for a hotfix using the order given
> > by string representations.
> > 
> > Then we can calmly investigate what causes the different
> > display order, and find a nicer fix.
> 
> OK, then could you please all try the [straightforward branch](https://git.sagemath.org/sage.git/log/?h=u/tmonteil/doctests_in_src_sage_modular_local_comp_local_comp_py_make_patchbots_fail) and tell if is passes on your various computers, so that we could see whether it can break and understand the cause (for example, it seems not related to the choice of the random seed).

https://github.com/kliem/sage/pull/47/checks

As #29977 is now positively review, we can now also go back to your branch and see whether this works.


---

Comment by git created at 2021-07-29 11:52:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2021-07-29 15:38:38

Does this make bots happy?


---

Comment by dimpase created at 2021-07-29 15:38:38

Changing status from needs_review to positive_review.


---

Comment by tmonteil created at 2021-07-29 15:48:05

Changing status from positive_review to needs_review.


---

Comment by tmonteil created at 2021-07-29 15:48:05

Replying to [comment:18 dimpase]:
> Does this make bots happy?

I think we have to let 32bit bots to work on it. I will work on setting one up later in the summer. Let us keep this ticket to "needs review" so that bots can work on it.

I encourage everybody to try this branch to see if something wrong appears.


---

Comment by dimpase created at 2021-08-14 20:04:57

it works on 32-bit too.


---

Comment by dimpase created at 2021-08-14 20:04:57

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-08-29 09:38:17

Resolution: fixed
