# Issue 29394: spkg-configure.m4 for linbox

Issue created by migration from https://trac.sagemath.org/ticket/29631

Original creator: @thierry-FreeBSD

Original creation time: 2020-05-01 17:50:05

CC:  mkoeppe dimpase fbissey isuruf embray arojas slelievre

Keywords: linbox; spkg-configure; system packages

This ticket adds an spkg-configure.m4 for linbox, in order to use it from a system package if possible (see #27330).

Note for packagers: by default, linbox produces a buggy linbox.pc, and `@`LINBOXSAGE_LIBS`@` must be removed from their linbox.pc.in.

No more problem after that.


---

Comment by @thierry-FreeBSD created at 2020-05-01 17:50:42

To be put under build/pkgs/linbox


---

Attachment


---

Comment by mjo created at 2020-05-04 12:41:38

We also need iml, ntl, flint, fplll, and mpfr in the DEPCHECK. Linbox can be built without some of those libraries with, for example, `--without-ntl`, so we may need to check for the parts that are actually used in sage. The sage-on-gentoo ebuild passes `--without-fplll`, so that dependency is probably superfluous, and maybe others are as well? In any case, to check which libraries linbox actually supports... after the `PKG_CHECK_MODULES` call, I guess we could look for things like `-lntl` in `LINBOX_LIBS`?

I don't see any distros that have a 1.6.x version other than 1.6.3, so it would probably be pointless to lower the version to 1.6.0. The real question is whether or not we can use the v1.5.2 that e.g. older Debian/Fedora ship.


---

Comment by @thierry-FreeBSD created at 2020-05-04 16:03:02


```
pkgconf linbox --libs
```

 sets LINBOX_LIB, and we could grep that the required libs are there?


---

Comment by mjo created at 2020-05-04 16:19:58

Hmm, looking at the spkg-install for linbox, we already pass `--without-fplll`:


```
# Disable fplll as version 5.x is not supported by linbox <= 1.5.0.
# This is harmless as no functionality using fplll is exposed in Sage.
# See trac ticket #21221.
LINBOX_CONFIGURE="--without-fplll $LINBOX_CONFIGURE"
```


So, the existing dependency on fplll (in `build/pkgs/linbox/dependencies`) is wrong. I'm going to build a system copy of linbox with all of the other stuff disabled and see what goes wrong. Maybe we don't care if the other stuff is enabled, either.


---

Comment by mjo created at 2020-05-04 16:24:16

For posterity, this also appears to be obsolete,


```
# Need to use 'bash' for configure, see
# https://trac.sagemath.org/ticket/23451
if [ -z "$CONFIG_SHELL" ]; then
    export CONFIG_SHELL=`command -v bash`
fi
```


as I've been compiling linbox-1.6.3 this whole time with `/bin/sh -> /bin/dash`.


---

Comment by mjo created at 2020-05-04 17:24:39

Even if you pass `--without-foo` for all of the optional linbox dependencies, flint still gets pulled in automagically, so it's going to be required either way. I'm doing a full sage build / ptestlong now with the rest (ntl, fplll, mpfr, iml) disabled to see if any of them are actually important.


---

Comment by mjo created at 2020-05-05 12:06:16

Everything is fine if we disable ntl, iml, and mpfr in linbox, so I created a branch with those dependencies eliminated. That means that we only need to add "flint" to the DEPCHECK.
----
New commits:


---

Comment by mjo created at 2020-05-05 12:40:53

This page has some information on how to checkout and push new branches to our trac server:

  http://doc.sagemath.org/html/en/developer/manual_git.html

You should be able to checkout my branch, add a commit on top of it, and then push a new branch of your own (which you would then stick in the "branch" field of this ticket). That's the best way to collaborate since it will keep your commit info and author information in-tact. If you don't feel like dealing with it, though, I can just add the spkg-configure.m4 onto my branch and re-push.

After adding flint to the DEPCHECK, I think only two questions remains:

* Do we need to check for flint support in the spkg-configure check? Given that flint support is "automagically" enabled, I don't think it's necessary on source-based distros, who should have flint support enabled unconditionally to avoid problems. If none of the binary distros ship a flint-less linbox, then we can skip it.
* Should we try to set the version bound to 1.5.2? Someone would need to test that.


---

Comment by mkoeppe created at 2020-08-11 17:40:53

These questions can be resolved by adding system package information to `build/pkgs/linbox/distros` and then testing...


---

Comment by mkoeppe created at 2020-09-09 20:46:24

The duplicate ticket #29484 reminds us to "(attempt to) lower the bound on fflas-ffpack in its spkg-configure.m4. If we can accept an older system linbox that itself uses an older system fflas-ffpack, that would be nice."


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by slelievre created at 2021-03-22 01:16:42

Changing status from new to needs_review.


---

Comment by slelievre created at 2021-03-22 01:16:42

Replying to [comment:9 mkoeppe]:
> These questions can be resolved by adding system package information to `build/pkgs/linbox/distros` and then testing...

Here we go.


---

Comment by slelievre created at 2021-03-22 01:16:58

New commits:


---

Comment by mkoeppe created at 2021-03-22 03:11:24

The branch does not do what ticket title and description promise


---

Comment by mkoeppe created at 2021-03-22 03:11:24

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by mjo created at 2021-11-12 15:17:15

let's unforget about this
----
New commits:


---

Comment by mjo created at 2021-11-12 15:17:15

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-11-14 00:56:32


```
+# Disable all additional features of linbox that aren't needed by sage.
+# This helps keep the dependency list small, and makes it more likely
+# that we can use the system copy of linbox (which may be missing some
+# of these features).
```

Note that the purpose of the `SPKG_DEPCHECK` logic is as follows: The system package MIGHT link to an optional dependency like `fplll`. Therefore, if we build our own `fplll`, we need to avoid using system `linbox`.

It does not help at all to remove features from our build of the `linbox` spkg.


---

Comment by mkoeppe created at 2021-11-14 00:56:42

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-11-14 20:38:21

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mjo created at 2021-11-14 20:47:33

Replying to [comment:19 mkoeppe]:
> {{{
> +# Disable all additional features of linbox that aren't needed by sage.
> +# This helps keep the dependency list small, and makes it more likely
> +# that we can use the system copy of linbox (which may be missing some
> +# of these features).
> }}}
> Note that the purpose of the `SPKG_DEPCHECK` logic is as follows: The system package MIGHT link to an optional dependency like `fplll`. Therefore, if we build our own `fplll`, we need to avoid using system `linbox`.

Ideally we would detect that optional linkage using `AC_SEARCH_LIBS`, so that we only reject a system linbox if it actually links to something on the system that is also installed (and linked into sage) as an SPKG. But `DEPCHECK` is much easier than digging through the source looking for public functions hidden behind e.g. `HAVE_IML`, so I've just gone ahead and used `DEPCHECK` for now.

> 
> It does not help at all to remove features from our build of the `linbox` spkg.
> 

Not having those features in the SPKG means that we don't have to insist that they be present in the system copy.


---

Comment by mjo created at 2021-11-14 20:47:45

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-11-14 20:49:55

Replying to [comment:22 mjo]:
> > It does not help at all to remove features from our build of the `linbox` spkg.
> > 
> 
> Not having those features in the SPKG means that we don't have to insist that they be present in the system copy.

We don't have to insist on it either way. No need to remove the feature.


---

Comment by mjo created at 2021-11-14 21:53:36

Replying to [comment:24 mkoeppe]:
> > 
> > Not having those features in the SPKG means that we don't have to insist that they be present in the system copy.
> 
> We don't have to insist on it either way. No need to remove the feature.

You want the linbox SPKG to have mpfr, ntl, and iml support... but also accept a system linbox that doesn't? And will crash the moment anyone tries to use those optional features?


---

Comment by mkoeppe created at 2021-11-14 21:56:23

Replying to [comment:25 mjo]:
> You want the linbox SPKG to have mpfr, ntl, and iml support... but also accept a system linbox that doesn't? And will crash the moment anyone tries to use those optional features?

The same is also true when a user uses a system linbox that provides the optional features.


---

Comment by mjo created at 2021-11-14 22:08:10

Replying to [comment:26 mkoeppe]:
> Replying to [comment:25 mjo]:
> > You want the linbox SPKG to have mpfr, ntl, and iml support... but also accept a system linbox that doesn't? And will crash the moment anyone tries to use those optional features?
> 
> The same is also true when a user uses a system linbox that provides the optional features.

A user can write his own code that depends on his own special system copy of linbox, but he won't get it committed to sage, which is the risk we run retaining the optional features in the SPKG. And the general trend is from-SPKG-to-system-package -- not the other way around -- minimizing the risk that someone will shoot himself in the foot that way. Finally, we're not doing "two wrong make a right." Avoiding the one potential problem is a win. Sage doesn't need those features enabled. Why slow down the build, bloat the install, and invite future bug reports?


---

Comment by mkoeppe created at 2021-11-14 22:10:10

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-11-14 22:10:10

Removing the features is neither an improvement, nor a prerequisite for the goal of the ticket. So it's not appropriate for this ticket.


---

Comment by git created at 2021-11-14 22:21:28

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mjo created at 2021-11-14 22:22:23

Changing status from needs_work to needs_review.


---

Comment by mjo created at 2021-11-14 22:22:23

As you wish.


---

Comment by mkoeppe created at 2021-11-14 22:24:15

Thanks. The branch still has this change though:

```
--- a/build/pkgs/linbox/dependencies
+++ b/build/pkgs/linbox/dependencies
@@ -1,4 +1,4 @@
-$(MP_LIBRARY) ntl givaro mpfr fplll iml flint fflas_ffpack
+$(MP_LIBRARY) ntl givaro mpfr iml flint fflas_ffpack
```



---

Comment by mjo created at 2021-11-14 22:37:37

Replying to [comment:31 mkoeppe]:
> Thanks. The branch still has this change though:
> {{{
> --- a/build/pkgs/linbox/dependencies
> +++ b/build/pkgs/linbox/dependencies
> `@``@` -1,4 +1,4 `@``@`
> -$(MP_LIBRARY) ntl givaro mpfr fplll iml flint fflas_ffpack
> +$(MP_LIBRARY) ntl givaro mpfr iml flint fflas_ffpack
> }}}

Its spkg-install explicitly disables fplll.


---

Comment by mkoeppe created at 2021-11-14 22:42:11

Ah, thanks.


---

Comment by mkoeppe created at 2021-11-14 22:42:57

Looking good then, but this will need platform testing on GH Actions


---

Comment by tornaria created at 2021-11-26 02:43:43

After fixing the system linbox package (as in #27205) this works for me on void linux.


---

Comment by dimpase created at 2021-12-04 10:32:23

rebased over the latest beta
----
New commits:


---

Comment by git created at 2021-12-04 10:36:19

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-12-04 10:38:45

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by dimpase created at 2021-12-04 10:42:21

tests on https://github.com/sagemath/sagetrac-mirror/actions/runs/1538684506


---

Comment by dimpase created at 2021-12-04 10:48:21

currently the branch includes some positively reviewed tickets - most of them to increase chances of more systems passing.


---

Comment by git created at 2021-12-05 11:00:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-12-05 11:01:17

the last commit should not be forgotten while cutting the final branch here...


---

Comment by dimpase created at 2021-12-05 11:19:11

also need

```diff
--- a/build/pkgs/m4ri/distros/debian.txt
+++ b/build/pkgs/m4ri/distros/debian.txt
@@ -0,0 +1 @@
+libm4ri-dev
```



---

Comment by dimpase created at 2021-12-05 11:22:20

and

```diff
--- /dev/null
+++ b/build/pkgs/fplll/distros/debian.txt
@@ -0,0 +1 @@
+libfplll-dev
```



---

Comment by slelievre created at 2021-12-14 05:24:06

New commits:


---

Comment by slelievre created at 2021-12-14 15:02:42

Added the changes proposed in `@`dimpase's
last two comments: comment:43, comment:44.


---

Comment by mkoeppe created at 2021-12-18 18:17:52

Replying to [comment:40 dimpase]:
> currently the branch includes some positively reviewed tickets - most of them to increase chances of more systems passing.
These should be listed in the Dependencies field


---

Comment by mkoeppe created at 2021-12-18 18:18:18

In light of #33042, let's also set an upper bound for the linbox version


---

Comment by slelievre created at 2021-12-19 00:20:00

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-12-19 20:30:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slelievre created at 2021-12-19 20:31:14

Like that?


---

Comment by slelievre created at 2021-12-19 20:31:14

Changing status from needs_work to needs_review.


---

Comment by mjo created at 2021-12-20 14:57:52

Replying to [comment:51 slelievre]:
> Like that?

LGTM. The linbox team doesn't really do maintenance releases, so even if we set the bound to `< 1.7.0`, it would have the same effect. `sage_spkg_install_linbox=no` is the default so it's not really necessary but it won't hurt anything.


---

Comment by slelievre created at 2021-12-27 00:43:12

I mimicked `build/pkgsfplll/spkg-configure.m4`.

Is anything else needed here?


---

Comment by mjo created at 2021-12-27 12:22:47

Replying to [comment:53 slelievre]:
> 
> Is anything else needed here?

I think we need #8450 to be merged to clear up the merge conflict but otherwise the commits for this ticket are good to go.


---

Comment by mjo created at 2022-01-20 03:29:42

I don't think #8450 is going to make it into v9.5, maybe time to rebase this with just the linbox commits?


---

Comment by slelievre created at 2022-02-06 23:13:16

#8450 made it into Sage 9.6.beta0.


---

Comment by mjo created at 2022-02-06 23:15:29

Replying to [comment:57 slelievre]:
> #8450 made it into Sage 9.6.beta0.

Merge failed though D:


---

Comment by mjo created at 2022-02-07 12:11:35

New commits:


---

Comment by git created at 2022-02-22 21:01:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mjo created at 2022-03-10 20:32:39

Ping, this one should be easy now:

- Very few lines changed
- We require the one exact version of linbox that sage itself ships
- It already went through Github CI


---

Comment by dimpase created at 2022-03-10 20:38:53

lgtm


---

Comment by dimpase created at 2022-03-10 20:38:53

Changing status from needs_review to positive_review.


---

Comment by mjo created at 2022-03-10 20:47:03

Thanks! Now I guess I have to test the maxima ticket on github.


---

Comment by mkoeppe created at 2022-03-10 21:14:36

Changing status from positive_review to needs_work.


---

Comment by mkoeppe created at 2022-03-10 21:14:36

This ticket makes no sense because we have no spkg-configure.m4 for the dependency `fflas_ffpack`


---

Comment by mkoeppe created at 2022-03-10 21:15:53

Sorry for the noise - I was wrong about that (misled by a typo that I made)


---

Comment by mkoeppe created at 2022-03-10 21:15:53

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2022-03-20 18:59:30

Resolution: fixed


---

Comment by dimpase created at 2022-03-24 12:42:38

I've missed that `build/pkgs/linbox/distros/fedora.txt` also needs `linbox-devel`
