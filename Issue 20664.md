# Issue 20664: Upgrade bliss package to 0.73 with Debian patches; install header files in location expected by polymake

Issue created by migration from Trac.

Original creator: mkoeppe

Original creation time: 2016-06-28 23:54:15

CC:  azi jdemeyer vdelecroix kcrisman dimpase chapoton stumpc5 moritz vbraun

New upstream archive: http://www.tcs.hut.fi/Software/bliss/bliss-0.73.zip (we have 0.72)

Upstream bliss does not have a proper build system (in particular no 'make install').
"spkg-install" installs header files with generic names such as "graph.hh" flat into $SAGE_LOCAL/include/

Debian has https://packages.debian.org/sid/math/bliss
which autotoolizes the package and adjust the include file location.
This matches where Polymake (#20892) expects the header files.

We should really be using Debian as our upstream for this package.


---

Comment by mkoeppe created at 2016-07-15 19:50:08

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2016-07-15 19:50:08

New commits:


---

Comment by mkoeppe created at 2016-07-16 12:20:10

Needs review. Prerequisite for polymake (#20892).


---

Comment by dimpase created at 2016-07-16 14:58:44

what are the new goodies? a shared library?


---

Comment by mkoeppe created at 2016-07-16 16:18:15

Replying to [comment:6 dimpase]:
> what are the new goodies? a shared library?

A shared library, proper include files location, and as a result works as a prerequisite for polymake.
New upstream version -- but upstream is silent about what has changed compared to 0.72.


---

Comment by git created at 2016-07-16 18:57:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-07-17 07:33:56

The usual way to ship packages in Sage is to start from the original unmodified sources and then apply patches (either at packaging time or at build time). Here, you are instead forking upstream for no clear reason.


---

Comment by git created at 2016-07-17 09:34:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2016-07-17 09:37:40

Replying to [comment:9 jdemeyer]:
> The usual way to ship packages in Sage is to start from the original unmodified sources and then apply patches (either at packaging time or at build time). Here, you are instead forking upstream for no clear reason.

OK, I've changed it to using upstream + a patch.
Unfortunately our patches cannot be as elegant as Debian's because we cannot rely on the availability of autotools. So my patch has to ship the whole autogenerated build system.


---

Comment by fbissey created at 2016-07-18 11:19:03

Learn to write a `spkg-src` file like for `ecl` 
https://github.com/sagemath/sage/blob/master/build/pkgs/ecl/spkg-src
or `glpk` at #20710. It will require you to produce a new tarball and host it somewhere until the ticket is merged.


---

Comment by dimpase created at 2016-07-20 08:47:54

yeah, `spkg-src` is important, as you don't want to become the only one in state to perform an update...


---

Comment by mkoeppe created at 2016-07-26 07:11:55

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2016-07-26 07:11:55

Unfortunately this update causes some tests to fail with segfault.

```
age:             sage: g3 = polytopes.hypercube(3).vertex_graph(); g3
Graph on 8 vertices
sage:             sage: g3.automorphism_group().cardinality()
python(2197,0x7fff7b8f9000) malloc: *** error for object 0x1001d3fff: pointer being realloc'd was not allocated
*** set a breakpoint in malloc_error_break to debug

Program received signal SIGABRT, Aborted.
0x00007fff8b2cff06 in __pthread_kill () from /usr/lib/system/libsystem_kernel.dylib
(gdb) where
#0  0x00007fff8b2cff06 in __pthread_kill () from /usr/lib/system/libsystem_kernel.dylib
#1  0x00007fff92ea14ec in pthread_kill () from /usr/lib/system/libsystem_pthread.dylib
#2  0x00007fff8ec5c6e7 in abort () from /usr/lib/system/libsystem_c.dylib
#3  0x00007fff933d879d in realloc () from /usr/lib/system/libsystem_malloc.dylib
#4  0x0000000107284ddd in __pyx_f_4sage_3ext_6memory_sage_sig_realloc () from /Users/mkoeppe/cvs/sage/local/lib/python2.7/site-packages/sage/ext/memory.so
#5  0x0000000106afca01 in __gmpz_realloc () from /Users/mkoeppe/cvs/sage/local/lib/libgmp.16.dylib
#6  0x0000000106af8c0e in __gmpz_mul_si () from /Users/mkoeppe/cvs/sage/local/lib/libgmp.16.dylib
#7  0x00000001aefad6f0 in ?? () from /Users/mkoeppe/cvs/sage/local/lib/libbliss.2.dylib
#8  0x00000001aefaf43c in ?? () from /Users/mkoeppe/cvs/sage/local/lib/libbliss.2.dylib
#9  0x00000001aef96e13 in __pyx_pw_4sage_6graphs_5bliss_1automorphism_group(_object*, _object*, _object*) ()
   from /Users/mkoeppe/cvs/sage/local/lib/python2.7/site-packages/sage/graphs/bliss.so
#10 0x00000001000e92a4 in PyEval_EvalFrameEx () from /Users/mkoeppe/cvs/sage/local/lib/libpython2.7.dylib
#
```

I could use some help here.


---

Comment by fbissey created at 2016-07-26 07:16:15

Well known problem. Disable `gmp` in `bliss` that's the culprit.


---

Comment by mkoeppe created at 2016-07-26 08:05:48

Replying to [comment:15 fbissey]:
> Well known problem. Disable `gmp` in `bliss` that's the culprit.
Thanks!


---

Comment by dimpase created at 2016-07-26 09:40:43

Why would `bliss` need `gmp`? Looks strange to me.


---

Comment by fbissey created at 2016-07-26 09:44:45

It's a build option, ask the author.


---

Comment by git created at 2016-08-03 07:53:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2016-08-03 07:54:37

Replying to [comment:12 fbissey]:
> Learn to write a `spkg-src` file 

Thanks, done.

Ready for review.


---

Comment by mkoeppe created at 2016-08-03 07:54:37

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2016-08-03 08:43:36

there is something funny with tarball name: if I do  sage -i bliss it looks for `bliss-0.73+debian-1+sage-2016-08-02.tar.gz`, while wget with your URL gives `bliss-0.73.debian-1.sage-2016-08-02.tar.gz`.

OK, I renamed the tarball, and was able to run `sage -i bliss`, but the following make fails:

```
[sagelib-7.3.rc0] building 'sage.graphs.bliss' extension
[sagelib-7.3.rc0] Executing 1 command (using 1 thread)
[sagelib-7.3.rc0] [1/1] gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -fPIC -I/home/scratch/dimpase/sage/sage/local/include -I/home/scratch/dimpase/sage/sage/local/include/python2.7 -I/home/scratch/dimpase/sage/sage/local/lib/python2.7/site-packages/numpy/core/include -I/home/scratch/dimpase/sage/sage/src -I/home/scratch/dimpase/sage/sage/src/sage/ext -I/home/scratch/dimpase/sage/sage/src/build/cythonized -I/home/scratch/dimpase/sage/sage/src/build/cythonized/sage/ext -I/home/scratch/dimpase/sage/sage/local/include/python2.7 -c /home/scratch/dimpase/sage/sage/src/build/cythonized/sage/graphs/bliss.cpp -o build/temp.linux-x86_64-2.7/home/scratch/dimpase/sage/sage/src/build/cythonized/sage/graphs/bliss.o -fno-strict-aliasing
[sagelib-7.3.rc0] /home/scratch/dimpase/sage/sage/src/build/cythonized/sage/graphs/bliss.cpp:317:20: fatal error: graph.hh: No such file or directory
[sagelib-7.3.rc0] compilation terminated.
[sagelib-7.3.rc0] error: command 'gcc' failed with exit status 1
```


This is on Fedora23, Sage 7.3.rc0, with gcc version 5.3.1 20160406 (Red Hat 5.3.1-6) (GCC).


---

Comment by mkoeppe created at 2016-08-03 08:49:22

Replying to [comment:22 dimpase]:
> there is something funny with tarball name: if I do  sage -i bliss it looks for `bliss-0.73+debian-1+sage-2016-08-02.tar.gz`, while wget with your URL gives `bliss-0.73.debian-1.sage-2016-08-02.tar.gz`.

It's a limitation of github, it renames `+` to `.`

> OK, I renamed the tarball, and was able to run `sage -i bliss`, but the following make fails:
> {{{
> [sagelib-7.3.rc0] building 'sage.graphs.bliss' extension
> [sagelib-7.3.rc0] Executing 1 command (using 1 thread)
> [sagelib-7.3.rc0] [1/1] gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -fPIC -I/home/scratch/dimpase/sage/sage/local/include -I/home/scratch/dimpase/sage/sage/local/include/python2.7 -I/home/scratch/dimpase/sage/sage/local/lib/python2.7/site-packages/numpy/core/include -I/home/scratch/dimpase/sage/sage/src -I/home/scratch/dimpase/sage/sage/src/sage/ext -I/home/scratch/dimpase/sage/sage/src/build/cythonized -I/home/scratch/dimpase/sage/sage/src/build/cythonized/sage/ext -I/home/scratch/dimpase/sage/sage/local/include/python2.7 -c /home/scratch/dimpase/sage/sage/src/build/cythonized/sage/graphs/bliss.cpp -o build/temp.linux-x86_64-2.7/home/scratch/dimpase/sage/sage/src/build/cythonized/sage/graphs/bliss.o -fno-strict-aliasing
> [sagelib-7.3.rc0] /home/scratch/dimpase/sage/sage/src/build/cythonized/sage/graphs/bliss.cpp:317:20: fatal error: graph.hh: No such file or directory
> [sagelib-7.3.rc0] compilation terminated.
> [sagelib-7.3.rc0] error: command 'gcc' failed with exit status 1
> }}}
> 
> This is on Fedora23, Sage 7.3.rc0, with gcc version 5.3.1 20160406 (Red Hat 5.3.1-6) (GCC).

Thanks for catching this. Fix coming shortly.


---

Comment by git created at 2016-08-03 10:00:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2016-08-03 10:01:04

Fixed.


---

Comment by dimpase created at 2016-08-03 10:55:01

OK, this works. In order to keep the release manager happy, I suggest that you put the tarball somewhere where it can be wget'ed without renaming hassle...


---

Comment by mkoeppe created at 2016-08-04 19:02:33

Is this a "positive_review"?


---

Comment by dimpase created at 2016-08-04 19:09:20

I trust you are able to put the tarball somewhere where the name mangling does not happen. :-)


---

Comment by dimpase created at 2016-08-04 19:09:20

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2016-08-04 19:29:25

Thanks, Dima.

Volker - does the upload location of the tarball work for you?


---

Comment by vbraun created at 2016-08-07 20:01:33

Resolution: fixed


---

Comment by chapoton created at 2016-08-18 10:26:32

some patchbots meet compilation problems:

```
[sagelib-7.4.beta1] /home/worker/sage-patchbot/src/build/cythonized/sage/graphs/bliss.cpp:317:26: fatal error: bliss/graph.hh: No such file or directory
[sagelib-7.4.beta1]  #include "bliss/graph.hh"
[sagelib-7.4.beta1]                           ^
[sagelib-7.4.beta1] compilation terminated.
```



---

Comment by mkoeppe created at 2016-08-18 16:12:52

Well, the install location of this header file changed with this upgrade, so the patchbots will have to reinstall the package.


---

Comment by jdemeyer created at 2016-08-19 09:26:31

I hope that #21288 will fix this.
