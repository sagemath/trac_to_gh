# Issue 19102: Use digraph labels if present for ClusterAlgebra and ClusterQuiver

Issue created by migration from https://trac.sagemath.org/ticket/19339

Original creator: aram.dermenjian

Original creation time: 2015-10-03 15:26:34

CC:  gmoose05 benstrasser egunawan aram.dermenjian




---

Comment by aram.dermenjian created at 2015-10-03 15:30:53

Changing priority from major to minor.


---

Comment by aram.dermenjian created at 2015-10-03 15:30:53

Changing component from PLEASE CHANGE to algebra.


---

Comment by aram.dermenjian created at 2015-10-03 15:31:36

Changing type from PLEASE CHANGE to enhancement.


---

Comment by aram.dermenjian created at 2015-10-03 15:31:36

Changing keywords from "" to "clusters".


---

Comment by chapoton created at 2015-10-07 14:29:01

Changing keywords from "clusters" to "cluster".


---

Comment by benstrasser created at 2015-11-09 21:50:33

I am working on a review patch for this ticket.  This will include:

1) A small bug fix to address the issue where digraph labels get lost if the ClusterSeed is mutated:

```
sage: dg = DiGraph([[5,6]])
sage: S = ClusterSeed(dg); S.quiver().digraph().vertices()
[5, 6]
sage: S.mutate(0)
sage: S.quiver().digraph().vertices()
[0, 1]
```


2) An enhancement allowing users to specify a list of frozen variables.
----
New commits:


---

Comment by benstrasser created at 2015-11-28 19:21:04

Replying to [comment:7 benstrasser]:

I changed ClusterQuiver and ClusterSeed to maintain lists of mutable and immutable vertices throughout, and ensured that they pass these lists around when necessary.  Thus, the user should be able to submit lists of frozen vertices and mutate them freely.  Let me know what you think.  If these seem like good changes, we can clean up the documentation and finalize.
----
New commits:


---

Comment by git created at 2015-12-09 02:55:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-01-24 19:23:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by gmoose05 created at 2016-03-02 14:00:18

Merged to sage.7.1.beta5


---

Comment by git created at 2016-03-19 03:02:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-03-31 02:44:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-20 03:03:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-06-21 04:41:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egunawan created at 2016-06-30 00:54:32

Changing keywords from "cluster" to "cluster, cluster algebra, quiver, cluster quiver".


---

Comment by git created at 2016-07-01 16:36:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by benstrasser created at 2016-07-01 16:40:05

Changing status from new to needs_review.


---

Comment by egunawan created at 2016-07-08 07:57:08

Changing status from needs_review to needs_work.


---

Comment by egunawan created at 2016-07-08 07:57:08

Hi Ben,
These are my suggestions for now:
* In the doc for `ClusterQuiver` taking digraph as input, could you add another line `sage: for Q.nlist()` so the user will read that `ClusterQuiver` will remember labels from the input digraph.

* The following bug does not exist before this ticket was pulled:

```
sage: Q=ClusterQuiver(DiGraph([[0,5]]))
sage: Q.b_matrix()
[ 0  1]
[-1  0]
sage: Q.mutate(0)
IndexError: index out of range
```


* Also, I think we should either explain the following behavior in the doc, or change the code so that the behavior for `mutation` is more consistent. I think either is fine. The following works well

```
sage: S=ClusterSeed(DiGraph([['a','b']]))
sage: S.mutate('a')
}}}  
but the following throws an error
{{{
sage: S=ClusterSeed(DiGraph([[5,'b']]))
sage: S.mutate(5)
ValueError: The quiver can only be mutated at a vertex or at a sequence of vertices
}}}

* If possible, could you get the recent version of Sage (if not 7.3beta 6, then at least 7.2 master branch), and then add your code on top of this recent Sage? Currently your branch is marked as red because it cannot automatically merge.


---

Comment by benstrasser created at 2016-07-22 17:19:11

New commits:


---

Comment by tscrim created at 2016-07-22 20:15:49

Some quick comments:

- I believe you want `user_labels` to be a list, so once we switch to Python3, the current code won't work. So I recommend (and is also faster):
  {{{
user_labels = [ZZ(x) if type(x) == int else x for x in user_labels]
  }}}
- Instead of `elif type(user_labels[i]) in [list,tuple]:`, you should use `elif isinstance(user_labels[i], (list, tuple)):` (unless you want to explicitly forbid any subclasses of `list` or `tuple`).
- Python uses different conventions than, e.g., C++/Java. So variables `isVertices` should be `is_vertices`.
- You have an erroneous character:
  {{{#!diff
 For the compendium on the cluster algebra and quiver package see ::
-
+f
     http://arxiv.org/abs/1102.4844.
 
  }}}


---

Comment by chapoton created at 2016-08-03 19:32:39

doc does not build:

```
+[dochtml] [combinat ] /home/kevin/sage-patchbot/local/lib/python2.7/site-packages/sage/combinat/cluster_algebra_quiver/cluster_seed.py:docstring of sage.combinat.cluster_algebra_quiver.cluster_seed.ClusterSeed.mutate:29: ERROR: Unexpected indentation.
+[dochtml] [combinat ] /home/kevin/sage-patchbot/local/lib/python2.7/site-packages/sage/combinat/cluster_algebra_quiver/quiver.py:docstring of sage.combinat.cluster_algebra_quiver.quiver:21: ERROR: Unexpected indentation.
```



---

Comment by gmoose05 created at 2016-08-07 05:17:38

Last 10 new commits:


---

Comment by git created at 2016-08-07 19:50:55

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2016-08-07 21:45:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by benstrasser created at 2016-08-10 04:21:48

New commits:


---

Comment by git created at 2016-08-13 00:27:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by gmoose05 created at 2016-08-13 00:31:23

Anyone know why the branch name (in the above description) isn't green?


---

Comment by tscrim created at 2016-08-13 00:57:03

Typically it means a conflict with the latest beta.


---

Comment by aram.dermenjian created at 2016-08-21 16:59:10

New commits:


---

Comment by benstrasser created at 2017-08-07 21:59:26

New commits:


---

Comment by benstrasser created at 2017-08-07 21:59:57

aram.dermenjian


---

Comment by chapoton created at 2017-08-08 06:56:36

Do not use xrange in .py files (see patchbot plugin report).

If you need an iterator range, use `from from six.moves import range`


---

Comment by git created at 2017-08-08 15:44:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by benstrasser created at 2017-08-08 21:13:45

Passes src/sage/rings/function_field and src/sage/graphs locally even though it times out on the patch bot.
----
New commits:


---

Comment by benstrasser created at 2017-08-08 21:13:45

Changing status from needs_work to needs_review.


---

Comment by benstrasser created at 2017-08-08 21:15:26

Changing keywords from "cluster, cluster algebra, quiver, cluster quiver" to "cluster, cluster algebra, quiver, cluster quiver, IMA coding sprints".


---

Comment by benstrasser created at 2017-08-09 16:00:27

Changing status from needs_review to needs_work.


---

Comment by benstrasser created at 2017-08-09 17:39:22

New commits:


---

Comment by benstrasser created at 2017-08-09 18:27:21

Changing status from needs_work to needs_review.


---

Comment by benstrasser created at 2017-08-10 00:22:21

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-08-10 00:31:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-08-10 17:05:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by benstrasser created at 2017-08-10 17:06:18

Changing status from needs_work to needs_review.


---

Comment by jmatherne created at 2017-08-10 21:32:38

Seems to be working as intended, and the patchbot is green.


---

Comment by jmatherne created at 2017-08-10 21:32:38

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2017-08-10 22:07:24

Changing status from positive_review to needs_work.


---

Comment by tscrim created at 2017-08-10 22:07:24

Some comments, most of them are minor:

- There is a `warn` function (see, e.g., `sets/disjoint_union_enumerated_sets.py`). I feel like you should use that instead of `print` statements, but I'm not 100% sure.
- The `copy` is redundant here `copy( list(data._nlist) )` because `list` already makes a (shallow) copy.
- The `keys()` is unnecessary in `labelset = set(user_labels.keys())`.
- Do you really only want to test `type(x) == int` in this line:
  {{{#!python
user_labels = [ZZ(x) if type(x) == int else x for x in user_labels]
  }}}
  I feel it would be better to do `if x in ZZ`.
- If `user_labels` does conflict, are you sure you only want a string printed? This feels like it should be an error.
- Change
  {{{#!diff
-type(user_labels[key]) in [list,tuple]
+isinstance(user_labels[key], (list, tuple))
  }}}
- You need a blank line here between text and doctests, e.g., here:
  {{{#!diff
         For a cluster seed from an arbitrarily labelled digraph::
+
             sage: S = ClusterSeed(DiGraph([['a','b'],['b','c']]),frozen=['b'])
             sage: S.cluster_class()
             [[a, c], [a, (b + 1)/c], [(b + 1)/a, c], [(b + 1)/a, (b + 1)/c]]
  }}}
  There is at least one other place where this is needed.
- From the warning message, I don't understand the added check here:
  {{{
            if frozen is not None and type(frozen) in [int,Integer]:
                print('The input data is a matrix, therefore the additional parameter frozen is ignored.  Frozen vertices read off accordingly if the matrix is not square.')
  }}}
- Why is this downgraded to only a warning?
  {{{#!diff
+            warning_given = False
             for edge in dg.edge_iterator():
-                if edge[0] >= n and edge[1] >= n:
-                    raise ValueError("The input digraph contains edges within the frozen vertices")
+                if edge[0] >= n and edge[1] >= n and not warning_given:
+                    #raise ValueError("The input digraph contains edges within the frozen vertices")
+                    print('Warning: The input digraph contained edges within the frozen vertices. Use remove_frozen_edges to remove these edges.')
+                    warning_given = True
  }}}
- `nlist()` and `mlist()` are not very descriptive method names (however, it is fine for the internal attributes). I think it would be better to call them `free_vertices()` and `frozen_vertices()`.
- Never do `keep_previous_frozen == False`. Simply do `not keep_previous_frozen`. Similar for `keep_previous_frozen == True`.
- You are breaking PEP8 in a lot of places:
  * Arguments should not have spaces around the `=`, e.g., `def foo(x=5)` and not `def foo(x = 5)`.
  * Same holds true for default arguments to functions.
  * Binary operations should have spaces to either side: `strng = strng + "_" + j`. Although IMO you should leave this type alone `user_labels.keys()[n:n+m]` as the `[]` operator takes priority.
  * `dict` input as, e.g., `{x: -x for x in range(5)}`.
  * Commas will always have spaces after them.
- Break long (> 80 characters) docstrings.
- Use `Return` instead of `Returns` in the 1-line doc description (at least do not make things worse in your added functions/methods).
- There are a number of docstring formatting issues, e.g., you should code format things like ```self``` or variable names.
- You have added a lot of unnecessary whitespace to the docstrings. For example:
  {{{#!diff
`@``@` -120,6 +121,14 `@``@` class ClusterSeed(SageObject):
 
         sage: S = ClusterSeed(['A',4]); S.use_fpolys(False); S._use_fpolys
         False
+        
+        sage: S = ClusterSeed(DiGraph([['a','b'],['c','b'],['c','d'],['e','d']]),frozen = ['c']); S
+        A seed for a cluster algebra of rank 4 with 1 frozen variable
+
+        sage: S = ClusterSeed(['D',4],user_labels = [-1,0,1,2]);S
+        A seed for a cluster algebra of rank 4 of type ['D', 4]
+
+
 
     """
     def __init__(self, data, frozen=None, is_principal=False, user_labels=None, user_labels_prefix='x'):
  }}}
  It is good to be consistent with the rest of Sage (at most 1 line after doctests before the `"""`).
- Remove trailing whitespace.


---

Comment by git created at 2017-08-11 20:53:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-08-11 21:22:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by benstrasser created at 2017-08-11 21:22:48

Thanks for the detailed comments, Travis. I've done my best to address your concerns, although its possible I missed something. 

* Some of the 'print('Warning: ... 's which I added were really just clarifying default behavior, so I am not sure they should be warnings. I have removed the `Warning' from this string. I am not sure if this is the correct way to do such a thing in general, but it is at least consistent with the rest of the cluster_algebra_quiver package (see, for example, the messages about ignoring frozen vertices). Perhaps a later ticket should go through and add the `warn` command where appropriate.

* Regarding the warning vs error message for edges between frozen vertices, I had downgraded the error to a warning in order to play nicely with the new `set_frozen` command. I can't remember exactly why Gregg and I decided to add this functionality. Furthermore, this seems to go a bit beyond the stated goals of this ticket. For the moment I've decided to remove the `set_frozen` and `remove_frozen_edges` methods. I can add these commands (with or without the warning message) with a later ticket if someone wants it. 

* I did my best to change 'returns' to 'return' on the docstrings for the methods which we added here. As you point out, this is one of many stylistic inconsistencies throughout the cluster_algebra_quiver package. Perhaps a later ticket could go through and ensure the rest of the package conforms with this. The PEP8 issues are similar - I've done my best to make the new code conform, but there appears to be existing code which doesn't quite follow these standards. If this is a serious issue, someone could try to make the entire package conform with PEP8 at a later date.

Please let me know if I've missed anything of misinterpreted any of your comments!
----
New commits:


---

Comment by benstrasser created at 2017-08-14 18:46:45

Changing status from needs_work to needs_review.


---

Comment by benstrasser created at 2017-08-14 18:46:58

I just changed it.  Thanks for the input!


---

Comment by tscrim created at 2017-08-15 01:39:13

Replying to [comment:59 benstrasser]:
> Thanks for the detailed comments, Travis. I've done my best to address your concerns, although its possible I missed something. 

Thanks. I went through and made some additional changes and fixes as well, but there's too much to standardize to do it all on this ticket.

> * Some of the 'print('Warning: ... 's which I added were really just clarifying default behavior, so I am not sure they should be warnings. I have removed the `Warning' from this string. I am not sure if this is the correct way to do such a thing in general, but it is at least consistent with the rest of the cluster_algebra_quiver package (see, for example, the messages about ignoring frozen vertices). Perhaps a later ticket should go through and add the `warn` command where appropriate.

I would say no, but since the rest of the code here does it, it is better to be consistent.

> * I did my best to change 'returns' to 'return' on the docstrings for the methods which we added here. As you point out, this is one of many stylistic inconsistencies throughout the cluster_algebra_quiver package. Perhaps a later ticket could go through and ensure the rest of the package conforms with this. The PEP8 issues are similar - I've done my best to make the new code conform, but there appears to be existing code which doesn't quite follow these standards. If this is a serious issue, someone could try to make the entire package conform with PEP8 at a later date.

Serious, not really. Yet, it makes the code a little more difficult to parse quickly, and it would help give Sage a more polished feel.

If my changes are good, then positive review.
----
New commits:


---

Comment by git created at 2017-08-15 01:49:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by gmoose05 created at 2017-08-15 16:53:21

There seems to be a new error found by the patchbot now:

sage -t --long src/sage/combinat/cluster_algebra_quiver/cluster_seed.py

File "src/sage/combinat/cluster_algebra_quiver/cluster_seed.py", line 2356, in sage.combinat.cluster_algebra_quiver.cluster_seed.ClusterSeed.mutate
Failed example:
    S = ClusterSeed(['A', 4], user_labels=['a', 'b', 'c']);
Expected:
    Traceback (most recent call last):
    ...
    ValueError: The number of user-defined labels is not the number of exchangeable and frozen variables.
Got:
    <BLANKLINE>

I think once this is fixed, that the code would be ready for a positive review.


---

Comment by benstrasser created at 2017-08-15 21:58:03

Hmm I've run into this kind of issue before...  I don't really know how to deal with it since it doesn't seem to occur outside of doctests (i.e. if you manually enter it in terminal).  Has anyone seen this before?  What tends to cause this?

I'll try to work it out tomorrow.


---

Comment by git created at 2017-08-16 00:27:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-08-16 00:29:50

It is not a blankline; the patchbot reports an actual error traceback (although the blankline is annoying to have it in the output, it is not something that is actually is checked). It is a simple fix because of changes I made to the error messages to conform to our (and Python's) convention of error messages being lowercase and without periods.

I have also fixed the docbuilding issues reported by the patchbot.


---

Comment by gmoose05 created at 2017-08-20 02:07:25

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-08-21 19:23:47

Resolution: fixed


---

Comment by jdemeyer created at 2018-06-14 09:21:20

Why use `reduce()` here?

```
is_cluster_vars = reduce(lambda x, y: isinstance(y, str), seqq, 1) and seed._use_fpolys
```


This code is equivalent to

```
if len(seqq) == 0 or isinstance(seqq[-1], str):
    is_cluster_vars = seed._use_fpolys
else:
    is_cluster_vars = False
```

but is that what is intented?

Or did you perhaps mean

```
is_cluster_vars = all(isinstance(y, str) for y in seqq) and seed._use_fpolys
```


I ask because we trying to clean this up in #25571.
