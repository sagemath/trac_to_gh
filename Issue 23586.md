# Issue 23586: py3 error in graphs

Issue created by migration from https://trac.sagemath.org/ticket/23823

Original creator: chapoton

Original creation time: 2017-09-10 16:32:02

CC:  embray jdemeyer tscrim fbissey

Using a python3 build, one gets

```
----> 1 from sage.graphs.graph import Graph

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/graphs/graph.py in <module>()
   7870     Graph.tutte_polynomial          : "Algorithmically hard stuff",
   7871     Graph.lovasz_theta              : "Leftovers",
-> 7872     Graph.strong_orientations_iterator : "Orientations"
   7873     }
   7874 

TypeError: unhashable type: 'instancemethod'
```



---

Comment by chapoton created at 2017-09-20 08:02:00

Changing component from graph theory to python3.


---

Comment by chapoton created at 2017-09-20 11:24:22

This comes from the lines

```
src/sage/graphs/graph.py:_additional_categories = {

src/sage/graphs/graph.py:__doc__ = __doc__.replace("{INDEX_OF_METHODS}",gen_thematic_rest_table_index(Graph,_additional_categories))
```

that try to make a dictionary where keys are instancemethods.


---

Comment by chapoton created at 2017-09-20 12:44:10

Trying to fix that, one meets a strange phenomenon in 

```
sage: from sage.misc.rest_index_of_methods import *
sage: list_of_subfunctions(Graph)[0]
```

namely, there is just one line that is 

```
<built-in function is_asteroidal_triple_free>
```

everybody else is an unbound method.


---

Comment by chapoton created at 2017-09-20 15:34:39

New commits:


---

Comment by tscrim created at 2017-09-20 16:55:45

I think it understand what makes that special: it is a "method" defined in a pyx file whereas the others are all py files. So it is behaving a little differently.


---

Comment by git created at 2017-09-21 15:38:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-09-21 15:39:30

My branch is almost working, except for issues with cliques_maximum (duplicated) and "is_asteroidal_..." missing.
----
New commits:


---

Comment by chapoton created at 2017-09-21 15:40:50

I am also very unsure about using `__func__` in python3..


---

Comment by chapoton created at 2017-09-27 12:15:47

Changing type from PLEASE CHANGE to enhancement.


---

Comment by dcoudert created at 2017-09-30 08:00:02

Replying to [comment:5 tscrim]:
> I think it understand what makes that special: it is a "method" defined in a pyx file whereas the others are all py files. So it is behaving a little differently.

Several of these methods are defined in .pyx files: `pathwidth` in `vertex_separation.pyx`, `chromatic_polynomial` in `chrompoly.pyx`, etc. So there might be something else to explain the difference.


---

Comment by embray created at 2017-10-06 11:41:49

I think you should be able to just write `f.__name__` instead of `f.__func__.__name__`.  Bound method objects still have a `.__name__` attribute that should be the same as the underlying function's name, and the way this code is written it shouldn't be seeing `classmethod` or `staticmethod` objects (since it uses `getattr` on the parent object).


---

Comment by git created at 2017-10-10 13:14:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-10-13 14:08:58

This is now my blocking point in the experimental python3 build.


---

Comment by dcoudert created at 2017-10-13 16:46:40

On my side, the patch passes tests, the html doc builds properly and it displays nicely in my browser. But I'm not using py3.

What else should we do to finalize the review ? Actually, this patch is still in `new` status, so I don't know if it should or not be reviewed...


---

Comment by chapoton created at 2017-10-13 16:49:33

Well, there are two problems:

* this does not fix the issue in python3

* I am not sure that the doc is exactly the same as before (no missing function ?)


---

Comment by dcoudert created at 2017-10-13 17:00:08

> * I am not sure that the doc is exactly the same as before (no missing function ?)

* `strong_orientations_iterator` moved from `Orientations` to `Connectivity, orientations, trees`
* `cliques_maximum()` moved from `Clique-related methods` to `Unsorted`

Other methods are at the same place.


---

Comment by git created at 2017-11-12 09:34:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-11-12 09:37:27

Maybe we could validate this as a first approximation, and keep python3-full-support for another ticket ?


---

Comment by chapoton created at 2017-11-12 10:23:35

Changing status from new to needs_review.


---

Comment by tscrim created at 2017-11-13 01:14:33

[Edit: sorry wrong ticket!]


---

Comment by tscrim created at 2017-11-13 01:27:27

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2017-11-13 01:27:27

IMO, I don't like Python3's behavior with this, but nothing we can do about that. I think this is an acceptable way forward, and we can always revisit this later.


---

Comment by embray created at 2017-11-13 12:02:30

This is a bit strange--I don't think this is really a "Python 3" behavior per se.  But I think the change makes sense if nothing else because it avoids the issue of whether or not the attributes that are keyed on are hashable types which, depending on implementation, they aren't necessarily.


---

Comment by vbraun created at 2017-12-11 01:03:38

Resolution: fixed


---

Comment by chapoton created at 2018-02-13 16:55:46

This needs a follow-up ticket, as the line

```
src/sage/graphs/graph.py:
__doc__ = __doc__.replace({INDEX_OF_METHODS}",gen_thematic_rest_table_index(Graph,
_additional_categories))
```

is one of the last 2 points preventing sage to start with python3 on my machine.

*EDIT*: `@`embray, did you fix this in your branch, and if yes, how ??


---

Comment by chapoton created at 2018-02-14 12:50:29

follow up in #24728
