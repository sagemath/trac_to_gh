# Issue 29636: sage.categories: Remove module-level imports of sage.rings, sage.algebras, sage.matrix

Issue created by migration from https://trac.sagemath.org/ticket/29873

Original creator: mkoeppe

Original creation time: 2020-06-16 18:45:28

CC:  vdelecroix tscrim mjo nthiery @timokau chapoton

This is for a cleaner, filtered structure of our Python modules, at least regarding their load time.  This is preparation for #29865 (`sage-objects`).

The idea is that `sage.categories` should be more abstract than any of the implemented algebraic structures in `sage.rings`, `sage.algebras`, `sage.modules`, ... Therefore it should only have a (module load time) dependence on `sage.structure` and `sage.misc`.

At run time, of course, there are additional dependencies. For example, as noted in #29705, the output of `.cardinality()` must be an integer (ZZ).

The present ticket changes module-level imports to method-level imports so that they are resolved later than at module load time.

Also, obviously the doctests need a larger part of the library.

(split out from #29865)


---

Comment by mkoeppe created at 2020-06-16 18:58:51

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-06-16 18:58:51

New commits:


---

Comment by mkoeppe created at 2020-06-16 18:59:30

Branch is on top of #29869.


---

Comment by tscrim created at 2020-06-16 23:42:33

In this code, these extra imports at the method level will not have a meaningful effect on the run time, so I am giving this a positive review based on that. However, this is something to be aware of as there can be functions in the category framework that are used in tighter loops.


---

Comment by tscrim created at 2020-06-16 23:42:33

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-06-17 00:17:52

Thanks! Yes, let's watch out for performance impacts of some of the upcoming changes.


---

Comment by mkoeppe created at 2020-06-17 04:17:50

Actually now I see

```
  File "/local/sage-patchbot/sage/local/lib/python3.7/site-packages/sage/combinat/backtrack.py", line 76, in <module>
    from sage.sets.recursively_enumerated_set import RecursivelyEnumeratedSet_generic
  File "sage/sets/recursively_enumerated_set.pyx", line 179, in init sage.sets.recursively_enumerated_set (build/cythonized/sage/sets/recursively_enumerated_set.c:12654)
ImportError: cannot import name SearchForest
```



---

Comment by mkoeppe created at 2020-06-17 04:17:50

Changing status from positive_review to needs_work.


---

Comment by git created at 2020-06-17 04:18:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-06-17 04:19:07

rebased on top of newer #29869


---

Comment by mkoeppe created at 2020-06-17 04:23:11

cyclic import, it seems


---

Comment by mkoeppe created at 2020-06-17 04:28:46

`sage.combinat.backtrack` notes a relevant todo:

```
    - For now the code of :class:`SearchForest` is still in
      ``sage/combinat/backtrack.py``.  It should be moved in
      ``sage/sets/recursively_enumerated_set.pyx`` into a class named
      :class:`RecursivelyEnumeratedSet_forest` in a later ticket.
```



---

Comment by mkoeppe created at 2020-06-17 04:31:32

that's apparently #16351.


---

Comment by git created at 2020-06-17 06:11:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-17 06:12:34

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-06-17 06:12:34

Merging #16351 fixed the `ImportError`.
Ready for review


---

Comment by tscrim created at 2020-06-17 23:08:08

One last little trivial thing, please add

```
# -*- coding: utf-8 -*-
```

as the first line to `call.py`. Once done, you can set a positive review.


---

Comment by git created at 2020-06-18 00:01:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-18 00:01:44

Thanks!


---

Comment by mkoeppe created at 2020-06-18 00:01:44

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-07-02 21:30:05

Resolution: fixed
