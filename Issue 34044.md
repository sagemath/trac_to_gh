# Issue 34044: defer primality and irreducibility testing in GF constructor until after caching

Issue created by migration from https://trac.sagemath.org/ticket/34281

Original creator: lorenz

Original creation time: 2022-08-05 05:35:03

CC:  @k3w1k0d3r

Example:


```sage
sage: p = 2^521-1
sage: F = GF(p)
sage: GF(p) is F  # field is cached
True
sage: %timeit GF(p)
521 ms ± 6.46 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
```


Note that the constructor tests primality _each time_ even though the field is already cached! This was pointed out here:

  https://github.com/jack4818/Castryck-Decru-SageMath#speeding-sagemath-up-using-a-cache

In this patch, we move the primality and irreducibility testing from `FiniteFieldFactory.create_key_and_extra_args()` to `FiniteFieldFactory.create_object()`, so that it isn't performed again for fields already present in the cache.

The result is a massive speedup for repeated invocations of `GF(p)`:

```
78.6 µs ± 870 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
```



---

Comment by lorenz created at 2022-08-05 05:35:12

Changing status from new to needs_review.


---

Comment by git created at 2022-08-05 09:26:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @k3w1k0d3r created at 2022-08-05 11:06:49

Changing status from needs_review to positive_review.


---

Comment by @k3w1k0d3r created at 2022-08-05 23:37:09

Changing status from positive_review to needs_work.


---

Comment by @k3w1k0d3r created at 2022-08-05 23:43:29

patchbot failed a test, segfaulting when it reached the `p, n = order.perfect_power()` you added. I'm currently checking if I reproduce this locally.


---

Comment by lorenz created at 2022-08-06 00:58:01

I suspect this is a consequence of the other doctest failures here (which I also see on the unpatched `develop` branch). I can't reproduce it in isolation.


---

Comment by @k3w1k0d3r created at 2022-08-06 02:56:13

I am able to reproduce this behavior locally. It seems like a bug in the perfect_power method though. I'll investigate.


---

Comment by git created at 2022-08-08 03:44:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lorenz created at 2022-08-08 03:50:23

Changing status from needs_work to needs_review.


---

Comment by lorenz created at 2022-08-08 03:50:23

Setting to "needs review" to get the patchbot to run, but I suspect there are still problems.


---

Comment by git created at 2022-08-09 05:24:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lorenz created at 2022-08-09 05:28:27

With the most recent commit, I no longer see any failures on my machine. Still not sure what causes these crashes and why things only go wrong in `pbori.pyx`, but the workaround seems to, well, work around it.


---

Comment by lorenz created at 2022-08-09 14:05:16

Patchbot is morally green; I've seen the remaining failure in other (totally unrelated) tickets before.


---

Comment by @k3w1k0d3r created at 2022-08-09 17:03:35

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-08-30 06:51:45

Resolution: fixed
