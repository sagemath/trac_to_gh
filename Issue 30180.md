# Issue 30180: preparsing multi-line strings is broken

Issue created by migration from https://trac.sagemath.org/ticket/30417

Original creator: @mwageringel

Original creation time: 2020-08-21 20:25:10

CC:  arojas jhpalmieri @kliem â€‹novoselt

As of the IPython 7 upgrade #28197, preparsing multiline strings does not work anymore. The preparser alters multiline strings, even though it should not:

```
sage: """
....: abc-1-2
....: """
'\nabc-Integer(1)-Integer(2)\n'    # expected: '\nabc-1-2\n'
```


Reported on [devel](https://groups.google.com/forum/#!topic/sage-devel/JV2XwptndKM).


---

Comment by novoselt created at 2020-08-21 21:54:44

Changing priority from critical to blocker.


---

Comment by novoselt created at 2020-08-21 21:54:44

This makes pretty much all my interacts unusable with no sensible workaround to fix it. I doubt I am the only user with this issue.


---

Comment by @kliem created at 2020-08-22 13:04:47

Note that this only happens in the sage shell not during doctesting. If you run this during a doctest, you get the following:


```
File "src/sage/__init__.py", line 54, in sage.isfunction
Failed example:
    '''
    abc-1-2
    '''
Expected nothing
Got:
    '\nabc-1-2\n'
```


So this is exactly what we want. #29139 has a doctest that works find during doctesting but not in real life.


---

Comment by @mwageringel created at 2020-08-22 13:22:26

Replying to [comment:2 gh-kliem]:
> Note that this only happens in the sage shell not during doctesting.

I assume that is because `BackendDoctest` does not inherit from `BackendIPython`, so doctesting alone will not in general detect this kind of IPython issues.


---

Comment by @jcamp0x2a created at 2020-08-26 00:05:34

I think I was able to track this down and have pushed a branch with an attempt at a fix. The state of whether/which set of quotes we were in wasn't being carried over across lines of input. This fixes the example code in the description and a few other trivial multi-line strings I was able to come up with off the top of my head, but would appreciate if someone could throw it at some real world examples.


---

Comment by @jcamp0x2a created at 2020-08-26 00:05:34

Changing status from new to needs_review.


---

Comment by @kliem created at 2020-08-26 06:21:26

Apparently this does the job. Looks fine to me.

We could remove an unused import, while we are touching the file anyway:


```
+src/sage/repl/interpreter.py:780:13 'line_profiler' imported but unused
```



---

Comment by @kliem created at 2020-08-26 06:21:38

Thanks for figuring this out.


---

Comment by @jcamp0x2a created at 2020-08-26 15:26:56

Replying to [comment:5 gh-kliem]:
> We could remove an unused import, while we are touching the file anyway:
> 
> {{{
> +src/sage/repl/interpreter.py:780:13 'line_profiler' imported but unused
> }}}

I believe that warning is a false positive. Removing the import breaks over 80% of the doctests in `interpreter.py`. The import is surrounded by a try-catch, so I think the intent is to check that the import _could_ be done without actually needing it at the moment.

Thanks for taking a look at it!


---

Comment by @jcamp0x2a created at 2020-08-26 19:48:29

Replying to [comment:7 gh-jcamp0x2a]:
> I believe that warning is a false positive. Removing the import breaks over 80% of the doctests in `interpreter.py`. The import is surrounded by a try-catch, so I think the intent is to check that the import _could_ be done without actually needing it at the moment.

Sorry, sorry. When I commented out the import, I forgot that in Python you need a `pass` statement in an empty block. That's what broke the doctests, not removing the import.

That said, I think my understanding of the import's intent is still correct, and thus it shouldn't be removed. Here's the full block of code for context:


```python
# Load the %lprun extension if available
try:
    import line_profiler
except ImportError:
    pass
else:
    self.extensions.append('line_profiler')
```



---

Comment by mkoeppe created at 2020-08-27 01:28:55

Replying to [comment:8 gh-jcamp0x2a]:
> I think my understanding of the import's intent is still correct, and thus it shouldn't be removed. 

I agree


---

Comment by @kliem created at 2020-08-27 05:11:43

Sorry for keeping you busy. I usually trust those `pyflakles` warnings blindly, because usually it is right. But in this case this seems to be not the case.


---

Comment by @kliem created at 2020-08-27 06:47:55

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2020-08-27 06:47:55

Ok. Looks good to me.


---

Comment by vbraun created at 2020-09-01 23:00:24

Resolution: fixed


---

Comment by egourgoulhon created at 2020-11-17 08:08:41

See #30928 for a possible follow-up.
