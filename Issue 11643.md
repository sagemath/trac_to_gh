# Issue 11643: Embedding information in doc strings must not be formatted

Issue created by migration from Trac.

Original creator: SimonKing

Original creation time: 2011-09-19 13:34:33

Assignee: jason

CC:  vbraun leif

Keywords: embedding format

A doc string from an extension module typically starts with embedding information, such as here:

```
sage: cython("""
....: def testfunc(x):
....:     'some doc string'
....:     return x
....: """)
sage: print testfunc.__doc__
File: _mnt_local_king__sage_temp_mpc622_13356_tmp_0_spyx_0.pyx (starting at line 7)
some doc string
```


There are two functions in `sage.misc.sageinspect` that retrieve doc strings: `sage_getdoc` and `_sage_getdoc_unformatted`. The latter returns the doc string as it is, the former is supposed to remove the embedding information.

However, before doing so, sage_getdoc runs `sage.misc.sagedoc.format` on the output of `_sage_getdoc_unformatted`. That is a problem, because the formatting may insert line breaks, thereby destroying the embedding information, so that it can now not be correctly stripped from the doc string.

I suggest to modify `sage.misc.sagedoc.format`, such that the first line is preserved, if it contains embedding information. In that case, directives are searched in the second line of the doc string, not in the first line (currently the only recognized directive is `nodetex`).

Example, without the patch:

```
sage: from sage.misc.sagedoc import format
sage: r = 'File: _local_user_with_a_very_long_name_that_would_normally_be_wrapped_sage_temp_machine_name_1234_tmp_1_spyx_0.pyx (starting at line 6)\nnodetex\nsome doc for a cython method\n`x \\geq y`'
sage: print format(r)
File: _local_user_with_a_very_long_name_that_would_normally_be_wrapped
_sage_temp_machine_name_1234_tmp_1_spyx_0.pyx (starting at line 6)
nodetex some doc for a cython method x >= y
```


The same example with the patch (it is a new doc test):

```
sage: r = 'File: _local_user_with_a_very_long_name_that_would_normally_be_wrapped_sage_temp_machine_name_1234_tmp_1_spyx_0.pyx (starting at line 6)\nnodetex\nsome doc for a cython method\n`x \\geq y`'
sage: print format(r)
File: _local_user_with_a_very_long_name_that_would_normally_be_wrapped_sage_temp_machine_name_1234_tmp_1_spyx_0.pyx (starting at line 6)
<BLANKLINE>
some doc for a cython method
`x \geq y`
```



---

Comment by SimonKing created at 2011-09-19 13:38:17

Changing status from new to needs_review.


---

Comment by SimonKing created at 2011-09-19 13:38:17

The attached patch was created on top of sage-4.7.2.alpha3-prerelease. I suppose that it will also apply on top of the official sage-4.7.2.alpha2. The alpha3 tests pass modulo some numerical errors. I suppose that they are noise, unrelated with my patch.

Hence, needs review!


---

Comment by SimonKing created at 2011-09-19 14:10:17

Too bad, the patchbot starts with sage-4.7.1. But I do hope it works on top of alpha2. It definitely does on top of alpha3-prerelease.


---

Comment by SimonKing created at 2011-09-19 14:13:08

I'll try whether it suffices to add some dependencies that are merged into alpha versions of 4.7.2


---

Comment by SimonKing created at 2011-09-19 14:36:01

I think I know what dependency is missing: #11287.
Trying again...


---

Comment by leif created at 2011-09-19 14:37:55

Replying to [comment:1 SimonKing]:
> The alpha3 tests pass modulo some numerical errors. I suppose that they are noise, unrelated with my patch.

Ooops, could you send me the failing ones, along with your system information (OS, processor, GCC version)?


---

Comment by SimonKing created at 2011-09-19 15:27:45

Replying to [comment:5 leif]:
> Ooops, could you send me the failing ones, along with your system information (OS, processor, GCC version)?

I just did - off list, since I think it is not related with this ticket.


---

Comment by SimonKing created at 2011-09-19 15:31:11

The good new is that now the patchbot manages to apply the patch.


The bad new is that the patchbot states:

```
The following tests failed:

	sage -t  -force_lib devel/sage-11815/doc/fr/tutorial/programming.rst
```


The good news is that the patchbot is actually not showing any error in the log. So, why does it state that it fails?


---

Comment by SimonKing created at 2011-09-19 16:02:35

Actually, what I did ought to be improved: The problem is that a directive is not necessarily in the first line of the doc string after the embedding information:

```
sage: cython("""
....: def testfunc(x):
....:     '''
....:     nodetex
....:     This is a doc string with raw latex
....:     
....:     `x \\geq y`
....:     '''
....:     return -x
....: """)
sage: print testfunc.__doc__
File: _mnt_local_king__sage_temp_mpc622_14073_tmp_0_spyx_0.pyx (starting at line 7)

    nodetex
    This is a doc string with raw latex

    `x \geq y`
    
```

Hence, one should strip empty lines at the beginning of a string resp. after the embedding information.


---

Comment by SimonKing created at 2011-09-19 16:02:35

Changing status from needs_review to needs_work.


---

Comment by leif created at 2011-09-19 16:16:13

Replying to [comment:7 SimonKing]:
> The bad new is that the patchbot states:

```
The following tests failed:

	sage -t  -force_lib devel/sage-11815/doc/fr/tutorial/programming.rst
```

> 
> The good news is that the patchbot is actually not showing any error in the log. So, why does it state that it fails?

Assuming the patchbot tests in parallel, it's likely to be an instance of the race conditions now fixed by #9739.


---

Comment by SimonKing created at 2011-09-19 16:35:40

I updated the patch, and there is now a new doc test:

```
sage: cython_code = ["def testfunc(x):",
... "    '''",
... "    nodetex",
... "    This is a doc string with raw latex",
... "",
... "    `x \\geq y`",
... "    '''",
... "    return -x"]
sage: cython('\n'.join(cython_code))
sage: from sage.misc.sageinspect import sage_getdoc
sage: print sage_getdoc(testfunc)
<BLANKLINE>
    This is a doc string with raw latex
<BLANKLINE>
    `x \geq y`
<BLANKLINE>
```


The trick is to strip leading empty lines (after the embedding information), and also to strip blank space around the directives.


---

Comment by SimonKing created at 2011-09-19 16:35:40

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2011-09-19 20:57:10

Applies fine to sage-4.7.2.alpha2 + #11342. Positive review.


---

Comment by vbraun created at 2011-09-19 20:57:10

Changing status from needs_review to positive_review.


---

Comment by SimonKing created at 2011-09-20 08:26:37

Preserve embedding information when formatting a raw doc string


---

Attachment

I had forgotten to insert my name into the author list. Apart from that, there is no difference to the old patch. I hope it is OK if I keep it "positive review".


---

Comment by leif created at 2011-09-27 17:41:30

Resolution: fixed
