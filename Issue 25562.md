# Issue 25562: Remove hardcoded default matplotlib stylesheet

Issue created by migration from https://trac.sagemath.org/ticket/25799

Original creator: klee

Original creation time: 2018-07-08 08:24:36

CC:  fbissey strogdon

This does not work:

```
import matplotlib as mpl 
mpl.rcParams['font.family'] = 'Impact'
text(u"A text here", (1,1))
```

because of hardcoded matplotlib stylesheet (`classic`), which silently overwrites the rc parameters. Putting configurations in the file `matplotlibrc` also does not work because of the same reason.

The patch removes the hardcoded default matplotlib stylesheet that silently applies to all graphics.


---

Comment by git created at 2018-07-08 08:29:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2018-07-08 08:33:34

Changing status from new to needs_review.


---

Comment by egourgoulhon created at 2018-07-10 07:37:13

For reference, I am copying below a part of this [sage-devel thread](https://groups.google.com/d/msg/sage-devel/4I2bTb00pFg/sEWUTkeeCQAJ):

we may keep specifically only the math font of the classic style by:

```
mpl.rcParams['mathtext.fontset'] = 'cm'
mpl.rcParams['mathtext.rm'] = 'serif'
```


See [this example](https://trac.sagemath.org/ticket/23696#comment:111) for drawbacks of using Matplolib new defaults for math fonts.
Moreover using cm fonts for math makes plots coherent with MathJax rendering of Jupyter output cells, which is an important feature IMHO.


---

Comment by git created at 2018-07-11 00:47:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2018-07-14 15:05:48

Changing the priority to 'major' in order to get the attention of patchbots.


---

Comment by egourgoulhon created at 2018-07-14 15:05:48

Changing priority from minor to major.


---

Attachment


---

Attachment

A noticeable effect of the proposed change is that it decreases the size of figures of approx. 20% in each dimension. For instance, with the ticket branch,

```
sage: plot(sin(x^2), (x, 0, 4), axes_labels=['$x$', '$y$'], gridlines=True)
```

generates this 628x470 figure:
![](plot.png)

while we had previously (i.e. with the 'classic' style) this 781x584 figure:
![](plot_classic.png)

This size change was already discussed in [comment:134 of #23696](https://trac.sagemath.org/ticket/23696#comment:134).

Other changes are the major ticks on the x-axis (Delta_x = 0.5 instead of Delta_x = 1) and the dash style (in general, dashes are narrower than with the classic style, as we can see on the dash plots in the 2D graphics section of the documentation).

I am fine with these changes (*); I simply mention them for the benefit of the discussion. 

(*) except maybe for the dash style of curves, which could require some tuning of the option `linestyle='--'` on Sage's side: compare the output of 

```
sage: g1 = plot(sin(x), 0, 2*pi)
sage: g2 = plot(cos(x), 0, 2*pi, linestyle="--")
sage: (g1+g2).show(ticks=pi/6, tick_formatter=pi)  # long time # show their sum, nicely formatted
```

in the [2D plotting](http://doc.sagemath.org/html/en/reference/plotting/sage/plot/plot.html) section of the documentation.

On general grounds, I think it is a good thing to remove the 'classic' stylesheet (provided the TeX fonts are corrected as above), in particular because this fixes the issues mentioned in the ticket description.


---

Attachment


---

Attachment


---

Comment by klee created at 2018-07-15 23:02:13

Replying to [comment:10 egourgoulhon]:
> I am fine with these changes (*); I simply mention them for the benefit of the discussion. 
> 
> (*) except maybe for the dash style of curves, which could require some tuning of the option `linestyle='--'` on Sage's side: compare the output of 
> {{{
> sage: g1 = plot(sin(x), 0, 2*pi)
> sage: g2 = plot(cos(x), 0, 2*pi, linestyle="--")
> sage: (g1+g2).show(ticks=pi/6, tick_formatter=pi)  # long time # show their sum, nicely formatted
> }}}
> in the [2D plotting](http://doc.sagemath.org/html/en/reference/plotting/sage/plot/plot.html) section of the documentation.

I am not sure...

Dashed line in classic style:

![](dashed_classic.png)

Dashed line in matplotlib2 default style:

![](dashed_default.png)


---

Comment by fbissey created at 2018-07-15 23:07:09

While the font change was the most glaring thing, there was other stuff indeed. Changing the style was the shortest way to fix all that. It would be interesting to know if we can set a style just for building the documentation. Of course even that could cause problems if you need to change something for building the documentation in a specific language.


---

Comment by klee created at 2018-07-16 02:06:29

Replying to [comment:13 fbissey]:
> While the font change was the most glaring thing, there was other stuff indeed. Changing the style was the shortest way to fix all that.

If there are needed other (not uniformly agreed upon) tunings, then it may be necessary to make another ticket for that purpose, while the most glaring changes, like the font change, get into this ticket. Let's see.

> It would be interesting to know if we can set a style just for building the documentation. Of course even that could cause problems if you need to change something for building the documentation in a specific language.

Yes. But as someone has suggested in other context,  I agree that users should get the same outputs in their own sessions as in the documentation.


---

Attachment


---

Attachment


---

Comment by klee created at 2018-07-16 02:19:18

Just for discussion.

Dashed lines in classic style:

![](dashed2_classic.png)

Dashed lines in default style:

![](dashed2_default.png)


---

Comment by klee created at 2018-07-23 11:00:05

There was a poll about the changes that the branch of this ticket introduces in 

https://groups.google.com/forum/#!topic/sage-devel/jz9fCnW8eT8

Counted from 8 participants to the discussion,  there are

5 positive votes;

2 no opinion;

1 not-so-positive vote.


---

Comment by egourgoulhon created at 2018-07-23 11:02:53

Changing status from needs_review to positive_review.


---

Comment by egourgoulhon created at 2018-07-23 11:02:53

So let's move this into Sage 8.4!


---

Comment by vbraun created at 2018-07-30 15:45:36

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2018-07-30 15:45:36


```
sage -t --long src/sage/plot/arrow.py  # 1 doctest failed
```



---

Comment by fbissey created at 2018-07-30 21:06:17

Replying to [comment:19 vbraun]:
> {{{
> sage -t --long src/sage/plot/arrow.py  # 1 doctest failed
> }}}

That doctest is fragile and I am pretty sure it depends on the stylesheet used.


---

Comment by egourgoulhon created at 2018-07-30 21:46:51

Replying to [comment:20 fbissey]:
> Replying to [comment:19 vbraun]:
> > {{{
> > sage -t --long src/sage/plot/arrow.py  # 1 doctest failed
> > }}}
> 
> That doctest is fragile and I am pretty sure it depends on the stylesheet used.

I confirm the doctest fails with the ticket branch merged in Sage 8.3.rc0:

```
./sage -t --long src/sage/plot/arrow.py 
Running doctests with ID 2018-07-30-23-45-27-5227bad0.
Git branch: matplotlib_style
Using --optional=mpir,python2,sage
Doctesting 1 file.
sage -t --long --warn-long 80.1 src/sage/plot/arrow.py
**********************************************************************
File "src/sage/plot/arrow.py", line 364, in sage.plot.arrow.Arrow._render_on_subplot
Failed example:
    two_stroke_re.search(contents) is None
Expected:
    True
Got:
    False
**********************************************************************
1 item had failures:
   1 of  18 in sage.plot.arrow.Arrow._render_on_subplot
    [69 tests, 1 failure, 3.79 s]
```



---

Comment by fbissey created at 2018-07-30 21:53:33

Getting that doctest to return something sensible required a considerable amount of effort. It is about controlling some aspect of the appearance on screen and stems from an older ticket about the appearance of double dashing. If I am completely honest I am not sure it is worth the time invested into fixing it.


---

Comment by klee created at 2018-07-31 00:25:50

Replying to [comment:22 fbissey]:
> Getting that doctest to return something sensible required a considerable amount of effort. It is about controlling some aspect of the appearance on screen and stems from an older ticket about the appearance of double dashing. If I am completely honest I am not sure it is worth the time invested into fixing it.

I agree. Doctesting graphics is something that requires a human eye or AI.


---

Comment by git created at 2018-07-31 00:26:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2018-07-31 00:28:39

Changing status from needs_work to needs_review.


---

Comment by egourgoulhon created at 2018-07-31 06:53:03

Changing status from needs_review to positive_review.


---

Comment by egourgoulhon created at 2018-07-31 06:53:03

LGTM. FranÃ§ois, do you agree?


---

Comment by fbissey created at 2018-07-31 07:23:53

I am OK with it. I'll be waiting for comments on the new look of the documentation. It is inevitable, even when we have talked so much about it.


---

Comment by strogdon created at 2018-08-01 03:31:50

Replying to [comment:23 klee]:
> Replying to [comment:22 fbissey]:
> > Getting that doctest to return something sensible required a considerable amount of effort. It is about controlling some aspect of the appearance on screen and stems from an older ticket about the appearance of double dashing. If I am completely honest I am not sure it is worth the time invested into fixing it.
> 
> I agree. Doctesting graphics is something that requires a human eye or AI.
It appears that now we are back to the `matching` sequence for `1.5.3` #23696#comment:27. This 

```
sage: two_stroke_pattern = r'setdash.*setdash.*stroke.*stroke.*setdash'
```

seems to work; although, I haven't checked whether the above `is` matched correctly when the arrow is drawn with `dashed` linetype.


---

Comment by strogdon created at 2018-08-01 04:42:44

Replying to [comment:28 strogdon]:
> Replying to [comment:23 klee]:
> > Replying to [comment:22 fbissey]:
> > > Getting that doctest to return something sensible required a considerable amount of effort. It is about controlling some aspect of the appearance on screen and stems from an older ticket about the appearance of double dashing. If I am completely honest I am not sure it is worth the time invested into fixing it.
> > 
> > I agree. Doctesting graphics is something that requires a human eye or AI.
> It appears that now we are back to the `matching` sequence for `1.5.3` #23696#comment:27. This 
> {{{
> sage: two_stroke_pattern = r'setdash.*setdash.*stroke.*stroke.*setdash'
> }}}
> seems to work; although, I haven't checked whether the above `is` matched correctly when the arrow is drawn with `dashed` linetype.
> 
This was just a shot in the dark. It doesn't work properly when the arrow is drawn with `dashed` linetype.


---

Comment by strogdon created at 2018-08-02 02:45:39

Just for the record, not that anything should be changed but

```
sage: two_stroke_pattern = r'setdash.*setdash.*stroke.*stroke.*setdash'
```

is the correct matching pattern. It's fairly straightforward to deduce it. I had a `typo` that led to the previous conclusion.


---

Comment by vbraun created at 2018-08-05 08:16:40

Resolution: fixed
