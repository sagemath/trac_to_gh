# Issue 31076: Memory leak in generalized quadrangles

archive/issues_031076.json:
```json
{
    "body": "CC:  @dimpase @ivo-maffei @dcoudert\n\nKeywords: generalised_quadrangle\n\nReproducer:\n\n```\nsage: from sage.combinat.designs.gen_quadrangles_with_spread import is_GQ_with_spread, dual_GQ_ovoid ## line 270 ##\nsage: t = designs.generalised_quadrangle_hermitian_with_ovoid(3) ## line 272 ##\nsage: t = dual_GQ_ovoid(*t) ## line 273 ##\nsage: is_GQ_with_spread(*t, s=3, t=9) ## line 274 ##\n```\n\nFor example, running the last `is_GQ_with_spread` command eats about 170MB per invocation that is never released.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31313\n\n",
    "created_at": "2021-01-31T20:50:41Z",
    "labels": [
        "component: combinatorial designs",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "Memory leak in generalized quadrangles",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31076",
    "user": "https://github.com/vbraun"
}
```
CC:  @dimpase @ivo-maffei @dcoudert

Keywords: generalised_quadrangle

Reproducer:

```
sage: from sage.combinat.designs.gen_quadrangles_with_spread import is_GQ_with_spread, dual_GQ_ovoid ## line 270 ##
sage: t = designs.generalised_quadrangle_hermitian_with_ovoid(3) ## line 272 ##
sage: t = dual_GQ_ovoid(*t) ## line 273 ##
sage: is_GQ_with_spread(*t, s=3, t=9) ## line 274 ##
```

For example, running the last `is_GQ_with_spread` command eats about 170MB per invocation that is never released.

Issue created by migration from https://trac.sagemath.org/ticket/31313





---

archive/issue_comments_443327.json:
```json
{
    "body": "For me,\n\n\n```\nfrom sage.combinat.designs.gen_quadrangles_with_spread import is_GQ_with_spread, dual_GQ_ovoid ## line 270 ##\nt = designs.generalised_quadrangle_hermitian_with_ovoid(3) ## line 272 ##\nt = dual_GQ_ovoid(*t) ## line 273 ##\nfor n in [1..20]:\n    is_GQ_with_spread(*t, s=3, t=9) ## line 274 ##\n    print(get_memory_usage())\n```\n\n\ndoes NOT show increased memory usage. Putting the other commands inside the loop doesn't create a leak either. This is on Sage 9.2.",
    "created_at": "2021-02-02T07:03:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443327",
    "user": "https://github.com/nbruin"
}
```

For me,


```
from sage.combinat.designs.gen_quadrangles_with_spread import is_GQ_with_spread, dual_GQ_ovoid ## line 270 ##
t = designs.generalised_quadrangle_hermitian_with_ovoid(3) ## line 272 ##
t = dual_GQ_ovoid(*t) ## line 273 ##
for n in [1..20]:
    is_GQ_with_spread(*t, s=3, t=9) ## line 274 ##
    print(get_memory_usage())
```


does NOT show increased memory usage. Putting the other commands inside the loop doesn't create a leak either. This is on Sage 9.2.



---

archive/issue_comments_443328.json:
```json
{
    "body": "FWIW, I see the leak. I tested nbruin's code with 9.2 and 9.3b6 on `CoCalc`, and 9.3b6 on MacOS 10.15.7. The numbers grew steadily in all cases, but the rate differed: about 170MB on `CoCalc` and about 90MB on MacOS.",
    "created_at": "2021-02-02T07:23:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443328",
    "user": "https://github.com/DaveWitteMorris"
}
```

FWIW, I see the leak. I tested nbruin's code with 9.2 and 9.3b6 on `CoCalc`, and 9.3b6 on MacOS 10.15.7. The numbers grew steadily in all cases, but the rate differed: about 170MB on `CoCalc` and about 90MB on MacOS.



---

archive/issue_comments_443329.json:
```json
{
    "body": "I apologize if this is noise, but it appears to me that this leak has nothing to do with quadrangles. Instead, the problem seems to be that there is a memory leak in the construction of bipartite graphs:\n\n```\nsage: m = 150\n....: n = 200\n....: A = Matrix(ZZ, m, n)\n....: for j in range(n):\n....:     i = randint(0,m-2)\n....:     A[i, j] = 1\n....:     A[i+1, j] = 1\n....: def graph(A):\n....:     G = Graph(A)\n....: def bipartite(A):\n....:     G = BipartiteGraph(A)\n....: start_mem = get_memory_usage()\n....: for n in [1..10]:\n....:     prev_mem = get_memory_usage()\n....:     graph(A)\n....:     print(\"graph:\", get_memory_usage() - prev_mem)\n....:     prev_mem = get_memory_usage()\n....:     bipartite(A)\n....:     print(\"bipartite:\", get_memory_usage() - prev_mem, get_memory_usage() - start\n....: _mem)\ngraph: 0.14453125\nbipartite: 185.1640625 185.30859375\ngraph: 0.0\nbipartite: 47.0 232.30859375\ngraph: 0.0\nbipartite: 47.00390625 279.3125\ngraph: 0.0\nbipartite: 48.0 327.3125\ngraph: 0.0\nbipartite: 67.0078125 394.3203125\ngraph: 0.0\nbipartite: 47.0 441.3203125\ngraph: 0.0\nbipartite: 48.0 489.3203125\ngraph: 0.0\nbipartite: 47.0 536.3203125\ngraph: 0.0\nbipartite: 46.0 582.3203125\ngraph: 0.0\nbipartite: 58.0 640.3203125\n```\n\nThis was on MacOS. On `CoCalc`, I got a consistent bipartite leak of 93.84375.",
    "created_at": "2021-02-02T09:54:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443329",
    "user": "https://github.com/DaveWitteMorris"
}
```

I apologize if this is noise, but it appears to me that this leak has nothing to do with quadrangles. Instead, the problem seems to be that there is a memory leak in the construction of bipartite graphs:

```
sage: m = 150
....: n = 200
....: A = Matrix(ZZ, m, n)
....: for j in range(n):
....:     i = randint(0,m-2)
....:     A[i, j] = 1
....:     A[i+1, j] = 1
....: def graph(A):
....:     G = Graph(A)
....: def bipartite(A):
....:     G = BipartiteGraph(A)
....: start_mem = get_memory_usage()
....: for n in [1..10]:
....:     prev_mem = get_memory_usage()
....:     graph(A)
....:     print("graph:", get_memory_usage() - prev_mem)
....:     prev_mem = get_memory_usage()
....:     bipartite(A)
....:     print("bipartite:", get_memory_usage() - prev_mem, get_memory_usage() - start
....: _mem)
graph: 0.14453125
bipartite: 185.1640625 185.30859375
graph: 0.0
bipartite: 47.0 232.30859375
graph: 0.0
bipartite: 47.00390625 279.3125
graph: 0.0
bipartite: 48.0 327.3125
graph: 0.0
bipartite: 67.0078125 394.3203125
graph: 0.0
bipartite: 47.0 441.3203125
graph: 0.0
bipartite: 48.0 489.3203125
graph: 0.0
bipartite: 47.0 536.3203125
graph: 0.0
bipartite: 46.0 582.3203125
graph: 0.0
bipartite: 58.0 640.3203125
```

This was on MacOS. On `CoCalc`, I got a consistent bipartite leak of 93.84375.



---

archive/issue_comments_443330.json:
```json
{
    "body": "As a possibly interesting data point, also for this bipartite graph example I'm not getting a leak on sage 9.2, running on CentOS Linux release 7.9.2009 (Core). Extra build info on the underlying python: Python 3.8.5 (default, Dec 15 2020, 19:39:17) [GCC 4.8.5 20150623 (Red Hat 4.8.5-44)] on linux.",
    "created_at": "2021-02-02T23:07:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443330",
    "user": "https://github.com/nbruin"
}
```

As a possibly interesting data point, also for this bipartite graph example I'm not getting a leak on sage 9.2, running on CentOS Linux release 7.9.2009 (Core). Extra build info on the underlying python: Python 3.8.5 (default, Dec 15 2020, 19:39:17) [GCC 4.8.5 20150623 (Red Hat 4.8.5-44)] on linux.



---

archive/issue_comments_443331.json:
```json
{
    "body": "The problem seems to be a small leak when accessing a row of an integer matrix. The construction of a bipartite graph involves accessing all of the entries of the matrix. If the graph is large (such as 150 x 200), then the formula `A[jj][ii]` will be evaluated tens of thousands of times, which amplifies the leak.\n\n```\nsage: A = Matrix(ZZ, 200) \n....: def here_is_a_leak(A): \n....:     for n in range(10000): \n....:         row0 = A[0] \n....:  \n....: start_mem = get_memory_usage() \n....: for n in [1..5]: \n....:     prev_mem = get_memory_usage() \n....:     here_is_a_leak(A) \n....:     print(\"change in memory:\", round(get_memory_usage() - prev_mem, 1),  \n....:           \"\\n    total:\", round(get_memory_usage() - start_mem,1))               \nchange in memory: 162.2 \n    total: 162.2\nchange in memory: 15.0 \n    total: 177.2\nchange in memory: 16.0 \n    total: 193.2\nchange in memory: 24.0 \n    total: 217.2\nchange in memory: 16.0 \n    total: 233.2\n```\n\nThis is from 9.3b6 on MacOS, but I also tested 9.2 on `CoCalc`. The leak seemed to go away (most of the time, at least) when I changed `ZZ` in the definition of `A` to `QQ` or `RR` or `GF(2^10)`.",
    "created_at": "2021-02-02T23:20:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443331",
    "user": "https://github.com/DaveWitteMorris"
}
```

The problem seems to be a small leak when accessing a row of an integer matrix. The construction of a bipartite graph involves accessing all of the entries of the matrix. If the graph is large (such as 150 x 200), then the formula `A[jj][ii]` will be evaluated tens of thousands of times, which amplifies the leak.

```
sage: A = Matrix(ZZ, 200) 
....: def here_is_a_leak(A): 
....:     for n in range(10000): 
....:         row0 = A[0] 
....:  
....: start_mem = get_memory_usage() 
....: for n in [1..5]: 
....:     prev_mem = get_memory_usage() 
....:     here_is_a_leak(A) 
....:     print("change in memory:", round(get_memory_usage() - prev_mem, 1),  
....:           "\n    total:", round(get_memory_usage() - start_mem,1))               
change in memory: 162.2 
    total: 162.2
change in memory: 15.0 
    total: 177.2
change in memory: 16.0 
    total: 193.2
change in memory: 24.0 
    total: 217.2
change in memory: 16.0 
    total: 233.2
```

This is from 9.3b6 on MacOS, but I also tested 9.2 on `CoCalc`. The leak seemed to go away (most of the time, at least) when I changed `ZZ` in the definition of `A` to `QQ` or `RR` or `GF(2^10)`.



---

archive/issue_comments_443332.json:
```json
{
    "body": "If my diagnosis is correct, then we might be able to solve the problem on this ticket just by changing `A[jj][ii]` to `A[jj,ii]`. I'll write a patch to try that out.\n\nIf it works, we can open a different ticket about the memory leak of `A[jj]`.",
    "created_at": "2021-02-03T00:07:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443332",
    "user": "https://github.com/DaveWitteMorris"
}
```

If my diagnosis is correct, then we might be able to solve the problem on this ticket just by changing `A[jj][ii]` to `A[jj,ii]`. I'll write a patch to try that out.

If it works, we can open a different ticket about the memory leak of `A[jj]`.



---

archive/issue_comments_443333.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-02-03T01:27:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443333",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_443334.json:
```json
{
    "body": "Changing keywords from \"generalised_quadrangle\" to \"generalised_quadrangle, bipartite graph, memory leak\".",
    "created_at": "2021-02-03T01:33:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443334",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing keywords from "generalised_quadrangle" to "generalised_quadrangle, bipartite graph, memory leak".



---

archive/issue_comments_443335.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-02-03T01:33:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443335",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_443336.json:
```json
{
    "body": "Yes, that simple change fixes the problem for me (and dramatically speeds up the construction of the bipartite graph).\n\nSo we should be able to remove the `# known bug` tags from #30517.",
    "created_at": "2021-02-03T01:33:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443336",
    "user": "https://github.com/DaveWitteMorris"
}
```

Yes, that simple change fixes the problem for me (and dramatically speeds up the construction of the bipartite graph).

So we should be able to remove the `# known bug` tags from #30517.



---

archive/issue_comments_443337.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-02-03T01:48:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443337",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_443338.json:
```json
{
    "body": "EDIT: oops sorry, wrong ticket",
    "created_at": "2021-02-03T16:29:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443338",
    "user": "https://github.com/fchapoton"
}
```

EDIT: oops sorry, wrong ticket



---

archive/issue_comments_443339.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-02-04T08:16:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443339",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_443340.json:
```json
{
    "body": "Great catch! Please also base it on  #30517, and revert this known bug tag, here.",
    "created_at": "2021-02-04T08:16:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443340",
    "user": "https://github.com/dimpase"
}
```

Great catch! Please also base it on  #30517, and revert this known bug tag, here.



---

archive/issue_comments_443341.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-02-04T09:29:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443341",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_443342.json:
```json
{
    "body": "OK, all fixed",
    "created_at": "2021-02-04T09:43:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443342",
    "user": "https://github.com/dimpase"
}
```

OK, all fixed



---

archive/issue_comments_443343.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2021-02-04T09:43:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443343",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_443344.json:
```json
{
    "body": "Thanks! I opened #31340 for the memory leak from `A[jj]`.",
    "created_at": "2021-02-04T21:15:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443344",
    "user": "https://github.com/DaveWitteMorris"
}
```

Thanks! I opened #31340 for the memory leak from `A[jj]`.



---

archive/issue_comments_443345.json:
```json
{
    "body": "Resolution: duplicate",
    "created_at": "2021-02-07T22:00:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443345",
    "user": "https://github.com/vbraun"
}
```

Resolution: duplicate



---

archive/issue_events_081981.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-02-07T22:00:51Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31076#event-81981"
}
```



---

archive/issue_comments_443346.json:
```json
{
    "body": "`@`vbraun: This ticket (#31313) is not a duplicate. The PR here gets rid of a memory leak (and therefore removes the `# known bug` tags that were added in #30517). More work needs to be done (so there is a follow up ticket), but I think this ticket should be enough to make your buildbot run. If not, please let us know.",
    "created_at": "2021-02-07T22:47:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443346",
    "user": "https://github.com/DaveWitteMorris"
}
```

`@`vbraun: This ticket (#31313) is not a duplicate. The PR here gets rid of a memory leak (and therefore removes the `# known bug` tags that were added in #30517). More work needs to be done (so there is a follow up ticket), but I think this ticket should be enough to make your buildbot run. If not, please let us know.



---

archive/issue_comments_443347.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2021-03-18T22:53:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443347",
    "user": "https://github.com/koffie"
}
```

Changing status from closed to new.



---

archive/issue_events_081982.json:
```json
{
    "actor": "https://github.com/koffie",
    "created_at": "2021-03-18T22:53:28Z",
    "event": "reopened",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31076#event-81982"
}
```



---

archive/issue_comments_443348.json:
```json
{
    "body": "I looked at the code here and it seems that this code will probable also be faster then the old code since it is getting entries directly from the matrix instead of creating rows. It seems that the new code is not only a workaround for the underlying bug, but that it will also be better then the existing code even after the underlying bug has been fixed. So I think it makes sense to still merge this.",
    "created_at": "2021-03-18T22:53:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443348",
    "user": "https://github.com/koffie"
}
```

I looked at the code here and it seems that this code will probable also be faster then the old code since it is getting entries directly from the matrix instead of creating rows. It seems that the new code is not only a workaround for the underlying bug, but that it will also be better then the existing code even after the underlying bug has been fixed. So I think it makes sense to still merge this.



---

archive/issue_comments_443349.json:
```json
{
    "body": "Resolution changed from duplicate to ",
    "created_at": "2021-03-18T22:53:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443349",
    "user": "https://github.com/koffie"
}
```

Resolution changed from duplicate to 



---

archive/issue_comments_443350.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-03-19T12:41:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443350",
    "user": "https://github.com/dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_443351.json:
```json
{
    "body": "needs review? Or good to go?",
    "created_at": "2021-03-19T12:41:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443351",
    "user": "https://github.com/dimpase"
}
```

needs review? Or good to go?



---

archive/issue_comments_443352.json:
```json
{
    "body": "re-checked, all good",
    "created_at": "2021-03-19T12:46:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443352",
    "user": "https://github.com/dimpase"
}
```

re-checked, all good



---

archive/issue_comments_443353.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-03-19T12:46:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443353",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_443354.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-03-20T20:55:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443354",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_081983.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-03-20T20:55:00Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31076#event-81983"
}
```



---

archive/issue_comments_443355.json:
```json
{
    "body": "Thanks for fixing this and opening the follow-up ticket #31340!\n\nIdeally, `all`, `any`, `sum`, `prod` should be\ncalled on generators rather than lists when possible.\n\nWhen coming across cases of use with list,\nit's good to replace them.\n\n\n```diff\n-        sage: all([x in t[0] for x in t[1]])\n+        sage: all(x in t[0] for x in t[1])\n```\n\n\nNot the point of this ticket though; will be done elsewhere.",
    "created_at": "2021-03-21T00:34:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443355",
    "user": "https://github.com/slel"
}
```

Thanks for fixing this and opening the follow-up ticket #31340!

Ideally, `all`, `any`, `sum`, `prod` should be
called on generators rather than lists when possible.

When coming across cases of use with list,
it's good to replace them.


```diff
-        sage: all([x in t[0] for x in t[1]])
+        sage: all(x in t[0] for x in t[1])
```


Not the point of this ticket though; will be done elsewhere.



---

archive/issue_comments_443356.json:
```json
{
    "body": "Are you sure? I'd be happy to do it either way, but I've been told that using a list is faster.  See, for example, ticket:11606#comment:12",
    "created_at": "2021-03-21T00:50:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443356",
    "user": "https://github.com/DaveWitteMorris"
}
```

Are you sure? I'd be happy to do it either way, but I've been told that using a list is faster.  See, for example, ticket:11606#comment:12



---

archive/issue_comments_443357.json:
```json
{
    "body": "Oops, here goes my belief that using lists made things slower.\n\nThanks for telling me and for the reference.",
    "created_at": "2021-03-21T01:20:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443357",
    "user": "https://github.com/slel"
}
```

Oops, here goes my belief that using lists made things slower.

Thanks for telling me and for the reference.



---

archive/issue_comments_443358.json:
```json
{
    "body": "Using an iterator seems much more pythonic, and must use less memory, so maybe it's better, even though it may be a bit slower, but I'm no expert and just try to do what I'm told (and often get confused about what I'm supposed to do).",
    "created_at": "2021-03-21T01:34:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443358",
    "user": "https://github.com/DaveWitteMorris"
}
```

Using an iterator seems much more pythonic, and must use less memory, so maybe it's better, even though it may be a bit slower, but I'm no expert and just try to do what I'm told (and often get confused about what I'm supposed to do).



---

archive/issue_comments_443359.json:
```json
{
    "body": "I am semi-regularly getting errors with the new doctest\n\n```\nFile \"src/sage/graphs/bipartite_graph.py\", line 326, in sage.graphs.bipartite_graph.BipartiteGraph.__init__\nFailed example:\n    print(round(get_memory_usage() - start_mem))\nExpected:\n    0.0\nGot:\n    1.0\n```\n\nThis is on OS X Big Sur and all recent Sage betas and rcs. I can reproduce with an interactive Sage session: if I run the loop\n\n```\nsage: for _ in range(10):\n....:     make_bip_graph(A)\n....:\n```\n\nit will sometimes cause an increase in memory usage.",
    "created_at": "2021-04-13T22:47:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443359",
    "user": "https://github.com/jhpalmieri"
}
```

I am semi-regularly getting errors with the new doctest

```
File "src/sage/graphs/bipartite_graph.py", line 326, in sage.graphs.bipartite_graph.BipartiteGraph.__init__
Failed example:
    print(round(get_memory_usage() - start_mem))
Expected:
    0.0
Got:
    1.0
```

This is on OS X Big Sur and all recent Sage betas and rcs. I can reproduce with an interactive Sage session: if I run the loop

```
sage: for _ in range(10):
....:     make_bip_graph(A)
....:
```

it will sometimes cause an increase in memory usage.



---

archive/issue_comments_443360.json:
```json
{
    "body": "Replying to [comment:29 jhpalmieri]:\n> I am semi-regularly getting errors with the new doctest\n> {{{\n> File \"src/sage/graphs/bipartite_graph.py\", line 326, in sage.graphs.bipartite_graph.BipartiteGraph.__init__\n> Failed example:\n>     print(round(get_memory_usage() - start_mem))\n> Expected:\n>     0.0\n> Got:\n>     1.0\n> }}}\n> This is on OS X Big Sur and all recent Sage betas and rcs. I can reproduce with an interactive Sage session: if I run the loop\n> {{{\n> sage: for _ in range(10):\n> ....:     make_bip_graph(A)\n> ....:\n> }}}\n> it will sometimes cause an increase in memory usage.\n\nCan you capture the particular A for which you get this failure, and attach it here?\nOf course it might be macOS-specific...",
    "created_at": "2021-04-14T08:10:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443360",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:29 jhpalmieri]:
> I am semi-regularly getting errors with the new doctest
> {{{
> File "src/sage/graphs/bipartite_graph.py", line 326, in sage.graphs.bipartite_graph.BipartiteGraph.__init__
> Failed example:
>     print(round(get_memory_usage() - start_mem))
> Expected:
>     0.0
> Got:
>     1.0
> }}}
> This is on OS X Big Sur and all recent Sage betas and rcs. I can reproduce with an interactive Sage session: if I run the loop
> {{{
> sage: for _ in range(10):
> ....:     make_bip_graph(A)
> ....:
> }}}
> it will sometimes cause an increase in memory usage.

Can you capture the particular A for which you get this failure, and attach it here?
Of course it might be macOS-specific...



---

archive/issue_comments_443361.json:
```json
{
    "body": "I have attached one example, but the following is quite repeatable for me:\n\n- start a fresh Sage session and do this:\n\n```\nsage: A = Matrix(ZZ, 100, 125)\nsage: for i in range(A.nrows()):\n....:     for j in Subsets(A.ncols()).random_element():\n....:         A[i, j-1] = 1\n....:\nsage: def make_bip_graph(A):\n....:     G = BipartiteGraph(A)\n....:\nsage: start_mem = get_memory_usage()\n```\n\nThen I repeat these commands\n\n```\nsage: for _ in range(100):\n....:     make_bip_graph(A)\n....:\nsage: print(round(get_memory_usage() - start_mem))\n```\n\nand the output often, but not always, increases. Every time I've started Sage, I have seen an increase: it doesn't seem to rely on a very specific value of `A`.\n\nFurther, if in the same Sage session, I redefine `A` by `A = Matrix(...)` and then use the loop `for i in ...`, then I don't see the memory leak any more, no matter how many times I iterate `make_bip_graph(A)`.",
    "created_at": "2021-04-14T19:00:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443361",
    "user": "https://github.com/jhpalmieri"
}
```

I have attached one example, but the following is quite repeatable for me:

- start a fresh Sage session and do this:

```
sage: A = Matrix(ZZ, 100, 125)
sage: for i in range(A.nrows()):
....:     for j in Subsets(A.ncols()).random_element():
....:         A[i, j-1] = 1
....:
sage: def make_bip_graph(A):
....:     G = BipartiteGraph(A)
....:
sage: start_mem = get_memory_usage()
```

Then I repeat these commands

```
sage: for _ in range(100):
....:     make_bip_graph(A)
....:
sage: print(round(get_memory_usage() - start_mem))
```

and the output often, but not always, increases. Every time I've started Sage, I have seen an increase: it doesn't seem to rely on a very specific value of `A`.

Further, if in the same Sage session, I redefine `A` by `A = Matrix(...)` and then use the loop `for i in ...`, then I don't see the memory leak any more, no matter how many times I iterate `make_bip_graph(A)`.



---

archive/issue_comments_443362.json:
```json
{
    "body": "Attachment [test.sobj](tarball://root/attachments/some-uuid/ticket31313/test.sobj) by @jhpalmieri created at 2021-04-14 19:01:04",
    "created_at": "2021-04-14T19:01:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443362",
    "user": "https://github.com/jhpalmieri"
}
```

Attachment [test.sobj](tarball://root/attachments/some-uuid/ticket31313/test.sobj) by @jhpalmieri created at 2021-04-14 19:01:04



---

archive/issue_comments_443363.json:
```json
{
    "body": "Can it increase multiple times per session? Or is it just one time per session that this happens?\n\nAlso what happens if you do first\n\n\n```\nimport gc\n```\n\n\nand then\n\n\n```\ngc.collect()\n```\n\n\nright before every call of `get_memory_usage()`",
    "created_at": "2021-04-15T06:19:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443363",
    "user": "https://github.com/koffie"
}
```

Can it increase multiple times per session? Or is it just one time per session that this happens?

Also what happens if you do first


```
import gc
```


and then


```
gc.collect()
```


right before every call of `get_memory_usage()`



---

archive/issue_comments_443364.json:
```json
{
    "body": "Replying to [comment:32 mderickx]:\n> Can it increase multiple times per session? Or is it just one time per session that this happens?\n> \n> Also what happens if you do first\n> \n> {{{\n> import gc\n> }}}\n> \n> and then\n> \n> {{{\n> gc.collect()\n> }}}\n> \n> right before every call of `get_memory_usage()`\n> \nindeed, what John sees might be merely a bug in this doctest.\nWithout `gc.collect()` calls, it is not reliable, IMHO.\nE.g. in `src/sage/geometry/polyhedron/base.py` on has\n\n```\n        Test that computing the face lattice does not lead to a memory leak::\n\n            sage: import gc\n            sage: _ = gc.collect()\n            sage: P = polytopes.cube()\n            sage: a = P.face_lattice()\n            sage: n = get_memory_usage()\n            sage: P = polytopes.cube()\n            sage: a = P.face_lattice()\n            sage: _ = gc.collect()\n            sage: n == get_memory_usage()\n            True\n```\n\n\nthis is the only other memory leak test in the library which uses `get_memory_usage()` - other places merely use it for information (or just it's a useless `import` which can go).\n\nI've opened #31671 to fix this.",
    "created_at": "2021-04-15T09:07:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443364",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:32 mderickx]:
> Can it increase multiple times per session? Or is it just one time per session that this happens?
> 
> Also what happens if you do first
> 
> {{{
> import gc
> }}}
> 
> and then
> 
> {{{
> gc.collect()
> }}}
> 
> right before every call of `get_memory_usage()`
> 
indeed, what John sees might be merely a bug in this doctest.
Without `gc.collect()` calls, it is not reliable, IMHO.
E.g. in `src/sage/geometry/polyhedron/base.py` on has

```
        Test that computing the face lattice does not lead to a memory leak::

            sage: import gc
            sage: _ = gc.collect()
            sage: P = polytopes.cube()
            sage: a = P.face_lattice()
            sage: n = get_memory_usage()
            sage: P = polytopes.cube()
            sage: a = P.face_lattice()
            sage: _ = gc.collect()
            sage: n == get_memory_usage()
            True
```


this is the only other memory leak test in the library which uses `get_memory_usage()` - other places merely use it for information (or just it's a useless `import` which can go).

I've opened #31671 to fix this.



---

archive/issue_comments_443365.json:
```json
{
    "body": "Replying to [comment:32 mderickx]:\n> Can it increase multiple times per session? Or is it just one time per session that this happens?\n\nMultiple times per session as long as I don't change the matrix `A`.\n \n> Also what happens if you do first\n> \n> {{{\n> import gc\n> }}}\n> \n> and then\n> \n> {{{\n> gc.collect()\n> }}}\n> \n> right before every call of `get_memory_usage()`\n\nDoesn't help:\n\n```\n% sage                                 \n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 9.3.rc3, Release Date: 2021-04-12                 \u2502\n\u2502 Using Python 3.9.2. Type \"help()\" for help.                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\nsage: A = Matrix(ZZ, 100, 125)                                                                                             \nsage: for i in range(A.nrows()): \n....:     for j in Subsets(A.ncols()).random_element(): \n....:         A[i, j-1] = 1 \n....:                                                                                                                      \nsage: def make_bip_graph(A): \n....:     G = BipartiteGraph(A) \n....:                                                                                                                      \nsage: import gc                                                                                                            \nsage: gc.collect()                                                                                                         \n349\nsage: start_mem = get_memory_usage()                                                                                       \nsage: for _ in range(100):    \n....:     make_bip_graph(A) \n....:                                                                                                                      \nsage: gc.collect()                                                                                                         \n763\nsage: print(round(get_memory_usage() - start_mem))                                                                         \n16.0\n```\n",
    "created_at": "2021-04-15T16:01:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443365",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:32 mderickx]:
> Can it increase multiple times per session? Or is it just one time per session that this happens?

Multiple times per session as long as I don't change the matrix `A`.
 
> Also what happens if you do first
> 
> {{{
> import gc
> }}}
> 
> and then
> 
> {{{
> gc.collect()
> }}}
> 
> right before every call of `get_memory_usage()`

Doesn't help:

```
% sage                                 
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.3.rc3, Release Date: 2021-04-12                 │
│ Using Python 3.9.2. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: A = Matrix(ZZ, 100, 125)                                                                                             
sage: for i in range(A.nrows()): 
....:     for j in Subsets(A.ncols()).random_element(): 
....:         A[i, j-1] = 1 
....:                                                                                                                      
sage: def make_bip_graph(A): 
....:     G = BipartiteGraph(A) 
....:                                                                                                                      
sage: import gc                                                                                                            
sage: gc.collect()                                                                                                         
349
sage: start_mem = get_memory_usage()                                                                                       
sage: for _ in range(100):    
....:     make_bip_graph(A) 
....:                                                                                                                      
sage: gc.collect()                                                                                                         
763
sage: print(round(get_memory_usage() - start_mem))                                                                         
16.0
```




---

archive/issue_comments_443366.json:
```json
{
    "body": "(un)fortunately this is platform dependent - I can't reproduce this on Linux",
    "created_at": "2021-04-15T16:32:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443366",
    "user": "https://github.com/dimpase"
}
```

(un)fortunately this is platform dependent - I can't reproduce this on Linux



---

archive/issue_comments_443367.json:
```json
{
    "body": "What packages might affect this? I can enable/disable more homebrew packages and see if that makes a difference.",
    "created_at": "2021-04-15T17:01:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443367",
    "user": "https://github.com/jhpalmieri"
}
```

What packages might affect this? I can enable/disable more homebrew packages and see if that makes a difference.



---

archive/issue_comments_443368.json:
```json
{
    "body": "it doesn't use anything external, I think, it's just sagelib and cython, IMHO.",
    "created_at": "2021-04-15T17:15:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443368",
    "user": "https://github.com/dimpase"
}
```

it doesn't use anything external, I think, it's just sagelib and cython, IMHO.



---

archive/issue_comments_443369.json:
```json
{
    "body": "on macOS 10.5.7 I observe a very small memory increase the first time we can the graph constructor. Could it be due to a lazy import or something like that ?\n\n\n```\nsapristi:sage dcoudert$ ./sage\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 9.3.rc3, Release Date: 2021-04-12                 \u2502\n\u2502 Using Python 3.9.2. Type \"help()\" for help.                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\nsage: sage: m = 150 \n....: ....: n = 200 \n....: ....: A = Matrix(ZZ, m, n) \n....: ....: for j in range(n): \n....: ....:     i = randint(0,m-2) \n....: ....:     A[i, j] = 1 \n....: ....:     A[i+1, j] = 1 \n....: ....: def graph(A): \n....: ....:     G = Graph(A) \n....: ....: def bipartite(A): \n....: ....:     G = BipartiteGraph(A) \n....: ....: start_mem = get_memory_usage() \n....: ....: for n in [1..10]: \n....: ....:     prev_mem = get_memory_usage() \n....: ....:     graph(A) \n....: ....:     print(\"graph:\", get_memory_usage() - prev_mem) \n....: ....:     prev_mem = get_memory_usage() \n....: ....:     bipartite(A) \n....: ....:     print(\"bipartite:\", get_memory_usage() - prev_mem, get_memory_usage() - start_mem)                                                 \ngraph: 0.171875\nbipartite: 0.0 0.171875\ngraph: 0.0\nbipartite: 0.0 0.171875\ngraph: 0.0\nbipartite: 0.0 0.171875\ngraph: 0.0\nbipartite: 0.0 0.171875\ngraph: 0.0\nbipartite: 0.0 0.171875\ngraph: 0.0\nbipartite: 0.0 0.171875\ngraph: 0.0\nbipartite: 0.0 0.171875\ngraph: 0.0\nbipartite: 0.0 0.171875\ngraph: 0.0\nbipartite: 0.0 0.171875\ngraph: 0.0\nbipartite: 0.0 0.171875\n```\n\n\n\n```\nsapristi:sage dcoudert$ ./sage\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 9.3.rc3, Release Date: 2021-04-12                 \u2502\n\u2502 Using Python 3.9.2. Type \"help()\" for help.                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\nsage: sage: A = Matrix(ZZ, 100, 125)                                                                                              \n....: sage: for i in range(A.nrows()):  \n....: ....:     for j in Subsets(A.ncols()).random_element():  \n....: ....:         A[i, j-1] = 1  \n....: ....:                                                                                                                       \n....: sage: def make_bip_graph(A):  \n....: ....:     G = BipartiteGraph(A)  \n....: ....:                                                                                                                       \n....: sage: import gc                                                                                                             \n....: sage: gc.collect()                                                                                                          \n....:                                                                                                                                              \n271\nsage: sage: start_mem = get_memory_usage()                                                                                        \n....: sage: for _ in range(100):     \n....: ....:     make_bip_graph(A)  \n....: ....:                                                                                                                       \n....: sage: gc.collect()                                                                                                          \n....:                                                                                                                                              \n82\nsage: print(round(get_memory_usage() - start_mem))                                                                                                 \n0.0\n```\n",
    "created_at": "2021-04-15T17:51:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443369",
    "user": "https://github.com/dcoudert"
}
```

on macOS 10.5.7 I observe a very small memory increase the first time we can the graph constructor. Could it be due to a lazy import or something like that ?


```
sapristi:sage dcoudert$ ./sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.3.rc3, Release Date: 2021-04-12                 │
│ Using Python 3.9.2. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: sage: m = 150 
....: ....: n = 200 
....: ....: A = Matrix(ZZ, m, n) 
....: ....: for j in range(n): 
....: ....:     i = randint(0,m-2) 
....: ....:     A[i, j] = 1 
....: ....:     A[i+1, j] = 1 
....: ....: def graph(A): 
....: ....:     G = Graph(A) 
....: ....: def bipartite(A): 
....: ....:     G = BipartiteGraph(A) 
....: ....: start_mem = get_memory_usage() 
....: ....: for n in [1..10]: 
....: ....:     prev_mem = get_memory_usage() 
....: ....:     graph(A) 
....: ....:     print("graph:", get_memory_usage() - prev_mem) 
....: ....:     prev_mem = get_memory_usage() 
....: ....:     bipartite(A) 
....: ....:     print("bipartite:", get_memory_usage() - prev_mem, get_memory_usage() - start_mem)                                                 
graph: 0.171875
bipartite: 0.0 0.171875
graph: 0.0
bipartite: 0.0 0.171875
graph: 0.0
bipartite: 0.0 0.171875
graph: 0.0
bipartite: 0.0 0.171875
graph: 0.0
bipartite: 0.0 0.171875
graph: 0.0
bipartite: 0.0 0.171875
graph: 0.0
bipartite: 0.0 0.171875
graph: 0.0
bipartite: 0.0 0.171875
graph: 0.0
bipartite: 0.0 0.171875
graph: 0.0
bipartite: 0.0 0.171875
```



```
sapristi:sage dcoudert$ ./sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.3.rc3, Release Date: 2021-04-12                 │
│ Using Python 3.9.2. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: sage: A = Matrix(ZZ, 100, 125)                                                                                              
....: sage: for i in range(A.nrows()):  
....: ....:     for j in Subsets(A.ncols()).random_element():  
....: ....:         A[i, j-1] = 1  
....: ....:                                                                                                                       
....: sage: def make_bip_graph(A):  
....: ....:     G = BipartiteGraph(A)  
....: ....:                                                                                                                       
....: sage: import gc                                                                                                             
....: sage: gc.collect()                                                                                                          
....:                                                                                                                                              
271
sage: sage: start_mem = get_memory_usage()                                                                                        
....: sage: for _ in range(100):     
....: ....:     make_bip_graph(A)  
....: ....:                                                                                                                       
....: sage: gc.collect()                                                                                                          
....:                                                                                                                                              
82
sage: print(round(get_memory_usage() - start_mem))                                                                                                 
0.0
```




---

archive/issue_comments_443370.json:
```json
{
    "body": "Replying to [comment:38 dcoudert]:\n> on macOS 10.5.7 I observe a very small memory increase the first time we can the graph constructor. Could it be due to a lazy import or something like that ?\n\nCan you reproduce what's reported by John on macOS, or are we down to even more selective (perhaps CPU matters too?) bug in his case?",
    "created_at": "2021-04-18T09:26:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443370",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:38 dcoudert]:
> on macOS 10.5.7 I observe a very small memory increase the first time we can the graph constructor. Could it be due to a lazy import or something like that ?

Can you reproduce what's reported by John on macOS, or are we down to even more selective (perhaps CPU matters too?) bug in his case?



---

archive/issue_comments_443371.json:
```json
{
    "body": "When I try the branch of this ticket on macOS (10.5.7, intel CPU), I have no dockets error in `bipartite_graph.py`.\n\nWhen I start a session and copy/paste the test, I have a random result:\n\n```\nsapristi:sage dcoudert$ ./sage\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 9.3.rc4, Release Date: 2021-04-18                 \u2502\n\u2502 Using Python 3.9.2. Type \"help()\" for help.                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\nsage: A = Matrix(ZZ, 100, 125) \n....: for i in range(A.nrows()): \n....:     for j in Subsets(A.ncols()).random_element(): \n....:         A[i, j-1] = 1 \n....: def make_bip_graph(A): \n....:     G = BipartiteGraph(A) \n....: import gc \n....: gc.collect() \n....: start_mem = get_memory_usage() \n....: for _ in range(100): \n....:     make_bip_graph(A) \n....: gc.collect() \n....: print(round(get_memory_usage() - start_mem)) \n....:                                                                                                                                              \n282\n0\n0.0\nsage:                                                                                                                                              \nExiting Sage (CPU time 0m1.49s, Wall time 0m19.73s).\nsapristi:sage dcoudert$ ./sage\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 9.3.rc4, Release Date: 2021-04-18                 \u2502\n\u2502 Using Python 3.9.2. Type \"help()\" for help.                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\nsage: A = Matrix(ZZ, 100, 125) \n....: for i in range(A.nrows()): \n....:     for j in Subsets(A.ncols()).random_element(): \n....:         A[i, j-1] = 1 \n....: def make_bip_graph(A): \n....:     G = BipartiteGraph(A) \n....: import gc \n....: gc.collect() \n....: start_mem = get_memory_usage() \n....: for _ in range(100): \n....:     make_bip_graph(A) \n....: gc.collect() \n....: print(round(get_memory_usage() - start_mem)) \n....:                                                                                                                                              \n282\n0\n1.0\n```\n",
    "created_at": "2021-04-18T09:54:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443371",
    "user": "https://github.com/dcoudert"
}
```

When I try the branch of this ticket on macOS (10.5.7, intel CPU), I have no dockets error in `bipartite_graph.py`.

When I start a session and copy/paste the test, I have a random result:

```
sapristi:sage dcoudert$ ./sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.3.rc4, Release Date: 2021-04-18                 │
│ Using Python 3.9.2. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: A = Matrix(ZZ, 100, 125) 
....: for i in range(A.nrows()): 
....:     for j in Subsets(A.ncols()).random_element(): 
....:         A[i, j-1] = 1 
....: def make_bip_graph(A): 
....:     G = BipartiteGraph(A) 
....: import gc 
....: gc.collect() 
....: start_mem = get_memory_usage() 
....: for _ in range(100): 
....:     make_bip_graph(A) 
....: gc.collect() 
....: print(round(get_memory_usage() - start_mem)) 
....:                                                                                                                                              
282
0
0.0
sage:                                                                                                                                              
Exiting Sage (CPU time 0m1.49s, Wall time 0m19.73s).
sapristi:sage dcoudert$ ./sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.3.rc4, Release Date: 2021-04-18                 │
│ Using Python 3.9.2. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: A = Matrix(ZZ, 100, 125) 
....: for i in range(A.nrows()): 
....:     for j in Subsets(A.ncols()).random_element(): 
....:         A[i, j-1] = 1 
....: def make_bip_graph(A): 
....:     G = BipartiteGraph(A) 
....: import gc 
....: gc.collect() 
....: start_mem = get_memory_usage() 
....: for _ in range(100): 
....:     make_bip_graph(A) 
....: gc.collect() 
....: print(round(get_memory_usage() - start_mem)) 
....:                                                                                                                                              
282
0
1.0
```




---

archive/issue_comments_443372.json:
```json
{
    "body": "Replying to [comment:40 dcoudert]:\n> When I try the branch of this ticket on macOS (10.5.7, intel CPU), I have no dockets error in `bipartite_graph.py`.\n\nCan you try running the doctest several times? Does it pass 10 times in a row? Passing or failing is random for me.",
    "created_at": "2021-04-18T16:03:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443372",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:40 dcoudert]:
> When I try the branch of this ticket on macOS (10.5.7, intel CPU), I have no dockets error in `bipartite_graph.py`.

Can you try running the doctest several times? Does it pass 10 times in a row? Passing or failing is random for me.



---

archive/issue_comments_443373.json:
```json
{
    "body": "Passed 7 times and failed 3 times :(",
    "created_at": "2021-04-18T17:32:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443373",
    "user": "https://github.com/dcoudert"
}
```

Passed 7 times and failed 3 times :(



---

archive/issue_comments_443374.json:
```json
{
    "body": "Thank you for checking. I've tried with the system Python, homebrew's Python, and Sage's, and I get failures with all three. I don't know what else to do to investigate this.",
    "created_at": "2021-04-18T20:29:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443374",
    "user": "https://github.com/jhpalmieri"
}
```

Thank you for checking. I've tried with the system Python, homebrew's Python, and Sage's, and I get failures with all three. I don't know what else to do to investigate this.



---

archive/issue_comments_443375.json:
```json
{
    "body": "I presume it must be a leak in a Cython backend, but which one I don't know (not that I tried looking, though)",
    "created_at": "2021-04-19T16:38:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31076#issuecomment-443375",
    "user": "https://github.com/dimpase"
}
```

I presume it must be a leak in a Cython backend, but which one I don't know (not that I tried looking, though)
