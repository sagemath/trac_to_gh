# Issue 22391: SINGULAR_SO default is incorrect of Cygwin

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2017-03-17 00:44:17

It should be under `$SAGE_LOCAL/bin/cygSingular-<version>.dll`.  Rather than guess at the version the attached patch just takes the latest one (which will normally be the only one).  It's pretty hacky, but then so is this code on other platforms too.

For the purposes of the standard Sage distribution this should generally work though.


---

Comment by embray created at 2017-03-17 00:44:37

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2017-03-17 09:07:34

So on Cygwin there is no "symlink" `cygSingular.dll -> cygSingular-VERSION.dll`? It would be simpler if there would be. It would also be simpler if `cygSingular.dll` would just be called `libSingular.dll`. Is there any chance of getting done in upstream Singular? Then the same code could be used on all platforms.


---

Comment by embray created at 2017-03-18 11:03:05

Generally DLLs do not go in `/lib` on Cygwin.  The reason for this is that _Windows_ searches `$PATH` for DLLs.  Further, the default way Cygwin implements symlinks is as normal files.  So Windows would see a symlink named `cygSingular.dll` and try to load the actual file `cygSingular.dll` as a DLL and fail.

In any case, I think it's better to explicitly point to the platform-specific location of a shared library.

(In fact, rather than hard-coding this it would be better if there were a routine to get shared library paths in a platform-specific way.  `ctypes.util.find_library` comes close, but unfortunately it does not return absolute paths (there are a couple issues in the Python bug tracker about fixing this, but I don't know when it will be).)


---

Comment by embray created at 2017-03-18 11:04:43

Replying to [comment:3 embray]:
> Generally DLLs do not go in `/lib` on Cygwin.  The reason for this is that _Windows_ searches `$PATH` for DLLs.  Further, the default way Cygwin implements symlinks is as normal files.  So Windows would see a symlink named `cygSingular.dll` and try to load the actual file `cygSingular.dll` as a DLL and fail.

That said, for the purposes of `dlopen` it _might_ be fine. I think Cygwin will resolve the symlink before passing to the underlying Windows APIs.  Regardless, I think this explicit approach is better.  I don't see the point of making a symlink on the filesystem that is otherwise pointless for this one case.


---

Comment by jdemeyer created at 2017-03-18 13:32:29

There is still a potential problem when changing Singular versions. Then multiple DLLs might be installed. How do you know which is the correct one?


---

Comment by embray created at 2017-03-20 10:21:35

Would there be though?  I worried about this too, but I thought any previous version would be uninstalled before installing a new version.


---

Comment by jdemeyer created at 2017-03-20 10:26:41

Replying to [comment:6 embray]:
> Would there be though?  I worried about this too, but I thought any previous version would be uninstalled before installing a new version.

`build/pkgs/singular/spkg-install` has this wonderful part:

```sh
remove_old_version()
{   
    # the following is a little verbose but it ensures we leave no trace of 3.x
    # _or_ 4.x
    rm -f "$SAGE_LOCAL"/bin/*Singular*
    rm -f "$SAGE_LOCAL"/bin/*singular*
    rm -rf "$SAGE_LOCAL/include/singular" # 3.x and 4.x
    rm -rf "$SAGE_LOCAL/include/factory" # 3.x and 4.x
    rm -f "$SAGE_LOCAL/include/factor.h" # 3.x only
    rm -f "$SAGE_LOCAL/include/factoryconf.h" # 3.x only
    rm -rf "$SAGE_LOCAL/include/omalloc" #4.x only
    rm -f "$SAGE_LOCAL/include/omalloc.h" # 3.x only
    rm -f "$SAGE_LOCAL/include/omlimits.h" # 3.x only
    rm -rf "$SAGE_LOCAL/include/resources" #4.x only
    rm -rf "$SAGE_LOCAL/include/gfanlib" #4.x only
    rm -f "$SAGE_LOCAL"/lib/libsingular* # 3.x with lower case
    rm -f "$SAGE_LOCAL"/lib/libsingcf*.a # 3.x only additional archives
    rm -f "$SAGE_LOCAL"/lib/libsingfac*.a # 3.x only additional archives
    rm -f "$SAGE_LOCAL"/lib/libSingular* # 4.x with upper case
    rm -f "$SAGE_LOCAL"/lib/p_Procs_Field* # 3.x only
    # a bunch of additional libraries for 4.x
    rm -f "$SAGE_LOCAL"/lib/libpolys*
    rm -f "$SAGE_LOCAL"/lib/libfactory*
    rm -f "$SAGE_LOCAL"/lib/libomalloc*
    rm -f "$SAGE_LOCAL"/lib/libresources*
    rm -r "$SAGE_LOCAL"/lib/libgfan*
    rm -rf "$SAGE_LOCAL/share/singular"
    rm -f "$SAGE_LOCAL"/share/info/singular*
}
```

which doesn't deal with any of the Cygwin names for the library (that would be another good reason why Cygwin should just the name `libSingular` instead of `cygSingular`).


---

Comment by embray created at 2017-03-20 10:33:15

See #22652


---

Comment by embray created at 2017-03-20 10:34:37

Yeah, that's pretty hideous, which is why I wrote #22510.  In the meantime I'll update the existing "uninstall" to handle Cygwin better.  Unfortunately the DLL naming can't be changed.


---

Comment by embray created at 2017-03-20 11:00:45

Changing status from needs_review to needs_work.


---

Comment by embray created at 2017-03-20 11:00:45

At the very least the Singular `spkg-install` needs to be updated to handle uninstallation better on Cygwin (this is likely the case for other packages as well, but the broader issue can wait for another time).


---

Comment by git created at 2017-03-22 15:12:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2017-03-22 15:18:11

This ensures Singular will be "uninstalled" better when upgrading on Cygwin.  This way there really should only be one `SINGULAR_SO` (if any) found in the method used by this patch.

Much as it's not nice to have platform-specific checks in `sage.env` I think for something like this (that is, locating a shared library for `dlopen()`) it's inevitable. So I'd rather leave it explicit for now, and deal with it better later (e.g. in #22652).


---

Comment by embray created at 2017-03-22 15:18:11

Changing status from needs_work to needs_review.


---

Comment by git created at 2017-03-22 15:21:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-03-22 15:22:08

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-03-22 15:22:08

Don't hardcode the extension. OS X uses `.dylib`


---

Comment by embray created at 2017-03-22 15:23:39

Ah, right.  I'll leave it for Cygwin but remove it for the 'else' case.


---

Comment by git created at 2017-03-22 15:25:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2017-03-22 15:25:26

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-03-28 11:34:23

I made two minor corrections. You can set this ticket to positive_review if you agree.
----
New commits:


---

Comment by embray created at 2017-03-28 11:54:29

Changing status from needs_review to needs_work.


---

Comment by embray created at 2017-03-28 11:54:29

I think I had `rm -rf` because one of the lines I replaced was `rm -r "$SAGE_LOCAL"/lib/libgfan*`, though I don't know why that would need `-r` either.

I agree `SINGULAR_SO = None` is fairly useless, but there should still be a better fallback in case the library is not found.  Currently this just results in an `IndexError` if so.


---

Comment by jdemeyer created at 2017-03-28 11:57:40

Replying to [comment:20 embray]:
> I think I had `rm -rf` because one of the lines I replaced was `rm -r "$SAGE_LOCAL"/lib/libgfan*`, though I don't know why that would need `-r` either.

The `-r` would only be needed if there would be a *directory* called `libgfan...`

That seems like something which shouldn't happen and I'd rather see an error in that case.

> Currently this just results in an `IndexError` if so.

At least, it's very clear where the error happens. Setting `SINGULAR_SO = None` might just lead to more obscure errors later.


---

Comment by embray created at 2017-03-28 14:57:38

> The -r would only be needed if there would be a directory called libgfan...

Yeah. I didn't put it there.


---

Comment by embray created at 2017-03-28 14:58:50

> At least, it's very clear where the error happens. Setting SINGULAR_SO = None might just lead to more obscure errors later.

Better a more explicit error message in that "later" case then.  Or earlier, if you prefer.  My thinking was just that it might be nice to be able to import `sage.env` even if the Singular install is broken, for debugging purposes if nothing else.


---

Comment by jdemeyer created at 2017-03-28 15:04:01

Replying to [comment:22 embray]:
> Yeah. I didn't put it there.

I'm not entirely sure that I follow you. You _did_ change `-f` to `-rf`. I changed back `-rf` to `-f` in my commit.


---

Comment by embray created at 2017-03-28 15:12:37

> You did change -f to -rf

No, I added an entirely new line that used `-rf`--I didn't change some existing line from `-f` to `-rf`.  As I explained in [comment:21], one of the lines I _replaced_ contained `rm -r` (probably unnecessarily).  I didn't really think about it though and just took the union of all the flags on the `rm` calls I was replacing (because honestly, knowing the history of this project and projects like Singular maybe there _was_ a directory matching 'libgfan*' on somebody's install once... =_=)


---

Comment by embray created at 2017-04-11 14:09:00

Replying to [comment:23 embray]:
> > At least, it's very clear where the error happens. Setting SINGULAR_SO = None might just lead to more obscure errors later.
> 
> Better a more explicit error message in that "later" case then.  Or earlier, if you prefer.  My thinking was just that it might be nice to be able to import `sage.env` even if the Singular install is broken, for debugging purposes if nothing else.

Any comment on this?  This is the only thing keeping this from having positive_review.  There should be an explicit error message if a valid path for `SINGULAR_SO` is not found (as opposed to an obscure-looking `IndexError`).


---

Comment by embray created at 2017-04-21 12:23:02

Changing priority from major to blocker.


---

Comment by tscrim created at 2017-05-03 03:29:17

Ping? FYI - I needed this to build on Cygwin.


---

Comment by embray created at 2017-05-03 09:02:47

If Jeroen doesn't mind I could switch this back over to my branch and just add the minor fix I'm proposing.  It's mostly just a nitpick.


---

Comment by embray created at 2017-05-05 14:46:50

Changing status from needs_work to needs_review.


---

Comment by embray created at 2017-05-05 14:46:50

Went ahead and did what I had in mind.  This will error out very early on in `sage.env` on all platforms if Singular is not built/installed properly.
----
New commits:


---

Comment by git created at 2017-05-05 14:49:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2017-05-20 22:46:46

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-06-04 10:11:06

Resolution: fixed
