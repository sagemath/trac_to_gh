# Issue 14524: cython dependency tracking

Issue created by migration from https://trac.sagemath.org/ticket/14728

Original creator: felixs

Original creation time: 2013-06-12 08:40:09

Assignee: felixs

CC:  robertwb jondo

Keywords: dependencies, cython, makefile

cython does not write out make rules for dependencies, like other code-processors to.
this complicates dependency tracking a lot.

this is a known bug, http://trac.cython.org/cython_trac/ticket/655

my patch (minimal changes required in frontend) might need some scrubbing, but it works well for me.


---

Comment by leif created at 2013-06-12 12:24:41

Minor comments:

I'd go / stay with single-letter short options (i.e., `-M <makefile>` or e.g. `--makefile <makefile>`).

I'd use tabs (which is also the portable way) instead of hardcoded `"    "` (four spaces).


---

Comment by felixs created at 2013-06-12 20:48:06

Replying to [comment:2 leif]:
> Minor comments:
> 
> I'd go / stay with single-letter short options (i.e., `-M <makefile>` or e.g. `--makefile <makefile>`).

i dont like -MF either (does it violate POSIX?), but thats what gcc (and others) do. -M is something else -- related but different -- and will cause confusion. there are even other -M[A-Z] options that might be useful. i would just stick to long options, if they didn't waste so much space...

> I'd use tabs (which is also the portable way) instead of hardcoded `"    "` (four spaces).

gcc writes exactly one space character. i will do it like that, as it minimizes wrapping.


---

Comment by leif created at 2013-06-12 22:04:29

Replying to [comment:3 felixs]:
> Replying to [comment:2 leif]:
> > I'd go / stay with single-letter short options (i.e., `-M <makefile>` or e.g. `--makefile <makefile>`).
> 
> i dont like -MF either (does it violate POSIX?)

MF is at least not politically correct.

> but thats what gcc (and others) do.

Well, that's `cython`, not GCC, and Cython (so far) uses either single-letter short options or long options, so one day<sup>TM</sup> `-MF` might get interpreted as `-M -F`, with a different meaning.

> -M is something else -- related but different

It just outputs the dependencies to `stdout`.




> > I'd use tabs (which is also the portable way) instead of hardcoded `"    "` (four spaces).
> 
> gcc writes exactly one space character. i will do it like that, as it minimizes wrapping.

Oh, you're right; we're writing just (escaped single-line) dependencies as opposed to receipts.


---

Comment by felixs created at 2013-06-13 15:21:58

> MF is at least not politically correct.
Exactly, that's why i dont like it. on second thought it cannot cause problems, if -MF (gcc) translates to -F (cython, unused) and -M (gcc) will be implemented as -M (on cython side, currently unused).

> > but thats what gcc (and others) do.
> `-MF` might get interpreted as `-M -F`, with a different meaning.

clearly, -MF will be interpreted as -M -F but not with a different meaning.
For gcc "-M -MF <file>" is also equal to "-MF <file>". thats the same with the other -M[A-Z] options as far as i can see.

I would favor wasting the -F short option to implement gcc-style, rather than choosing new option names for well established functionality. but my patch needs to reflect that, and allow "-F" as well.

unfortunately i'm not the one who will decide, so i will have to contact upstream about it.


---

Comment by leif created at 2013-06-13 17:37:07

Replying to [comment:3 felixs]:
> Replying to [comment:2 leif]:
> > I'd go / stay with single-letter short options (i.e., `-M <makefile>` or e.g. `--makefile <makefile>`).
> 
> i dont like -MF either (does it violate POSIX?)

[Single Unix Specification Utility Syntax Guidelines](http://pubs.opengroup.org/onlinepubs/7908799/xbd/utilconv.html#usg)

  _"It is recommended that all future utilities and applications use these guidelines to enhance user portability. The fact that some historical utilities could not be changed (to avoid breaking existing applications) should not deter this future goal."_

:-)


---

Comment by felixs created at 2013-06-13 18:15:05

Replying to [comment:6 leif]:
> [Single Unix Specification Utility Syntax Guidelines](http://pubs.opengroup.org/onlinepubs/7908799/xbd/utilconv.html#usg)

Thanks. I was looking for something like it. 

You are not implying that the quote is opposed to my previous post, are you?


---

Comment by leif created at 2013-06-13 18:29:30

Replying to [comment:7 felixs]:
> Replying to [comment:6 leif]:
> > [Single Unix Specification Utility Syntax Guidelines](http://pubs.opengroup.org/onlinepubs/7908799/xbd/utilconv.html#usg)
> 
> Thanks. I was looking for something like it.

See also `man 3 getopt` (and for the GNU version, especially `POSIXLY_CORRECT` ;-) )




> You are not implying that the quote is opposed to my previous post, are you?

I leave that to your interpretation.

Note that GNU `cpp` / `gcc` / `g++` do not accept `-MF <outputfile>` alone; you have to also give `-M` or `-MM` in addition.

(And you'd probably also have to support `-FM ...`, and ignore `-F`.)


---

Comment by felixs created at 2013-06-13 19:03:05

> Note that GNU `cpp` / `gcc` / `g++` do not accept `-MF <outputfile>` alone; you have to also give `-M` or `-MM` in addition.

Indeed. Particularly I am wrong in post number 5 about the gcc options.
-MM is be not very much needed nor useful, so defaulting to -M might be sufferable.

> (And you'd probably also have to support `-FM ...`, and ignore `-F`.)

-FM sets the output filename to "M", standalone -F will not require one of -M and -MM. if there is no -MM, it should just be equivalent to -MF...

(I'm getting closer, thanks for your help)


---

Comment by ohanar created at 2013-06-17 06:31:59

Since this is an upstream feature, I think it would be better to submit a pull request at Cython's github with a cleaned-up version of your patch. Really, we should only patch cython for bug fixes or for features not included in the latest release that we want/need.


---

Comment by leif created at 2013-06-17 15:04:51

Replying to [comment:10 ohanar]:
> Since this is an upstream feature, I think it would be better to submit a pull request at Cython's github with a cleaned-up version of your patch.

I was assuming that's exactly what Felix was finally going to do (once the patch is in a submittable state); at least the "Report upstream" field is already set...


---

Comment by felixs created at 2013-06-19 06:42:49

Replying to [comment:10 ohanar]:
> Since this is an upstream feature, I think it would be better to submit a pull request at Cython's github with a cleaned-up version of your patch. Really, we should only patch cython for bug fixes or for features not included in the latest release that we want/need.

Its a bugfix, it's not included in the latest release and I want/need it. I've just added a -D switch and noticed cython-devel.


---

Comment by ohanar created at 2013-06-19 20:18:50

Considering it is marked 'wishlist' upstream, they definitely consider it a feature, not a bug. Also, at least from my perspective (correct me if I'm wrong Robert), but it seems like using the cython command line utility is not the recommended way to use cython -- rather it seems that cythonize+distutils/setuptools/distribute seems like the recommended way going forward. So I imagine adding this functionality to cython is not even on the radar for upstream. To avoid bitrot, I would seriously suggest submitting something upstream at least to get the ball rolling.


---

Comment by leif created at 2013-06-20 00:54:41

Replying to [comment:13 ohanar]:
> Considering it is marked 'wishlist' upstream, they definitely consider it a feature, not a bug. Also, at least from my perspective (correct me if I'm wrong Robert), but it seems like using the cython command line utility is not the recommended way to use cython -- rather it seems that cythonize+distutils/setuptools/distribute seems like the recommended way going forward.

Well, it's perhaps Cython upstream's "recommended way", but in fact it is currently the _only way_ because of the missing feature this ticket is supposed to add... ;-)


---

Comment by felixs created at 2013-08-29 11:19:01

It might be just 'wishlist' upstream. Since it breaks anything that requires plain dependencies for cython generated files, and since there is no better option in the dropdown, i'll leave it like this.

(The patch has moved to git, it looks like i cannot remove the attached file)


---

Comment by felixs created at 2013-09-03 08:21:34

Changing status from new to needs_review.


---

Comment by chapoton created at 2015-09-03 18:37:27

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2015-09-03 18:37:27

cython patches do not apply


---

Comment by jdemeyer created at 2017-09-07 12:19:52

Given that upstream Cython has no plans for this and given that nobody uses automake for Python projects, I suggest to close this as "wontfix".


---

Comment by jdemeyer created at 2017-09-07 12:19:52

Changing status from needs_work to positive_review.


---

Comment by embray created at 2017-12-12 08:23:33

Resolution: wontfix
