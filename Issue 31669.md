# Issue 31669: Faster point transform matrix

Issue created by migration from https://trac.sagemath.org/ticket/31906

Original creator: @EnderWannabe

Original creation time: 2021-06-04 15:24:44

CC:  bhutz

Keywords: gsoc2021

Currently, the point transform matrix method is slow over fields such as QQbar, and does not work over precision fields such as the reals.

We implement a different approach based on linear algebra which improves performance over QQbar and works over precision fields. We replace the old approach as our update is an improvement in all cases.


---

Comment by git created at 2021-06-08 18:11:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @EnderWannabe created at 2021-06-08 18:11:47

Changing status from new to needs_review.


---

Comment by git created at 2021-06-09 14:22:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bhutz created at 2021-06-14 15:38:46

A few comments here.

- why is this based of off #31896?

- Documentation fixes

`Given a projective space of dimension n -> Given a projective space of dimension n`

`finds -> find`

`If the base ring is a field, the matrix is normalized so that the last nonzero entry in the last row is 1.`

- In the examples, there is a left action defined for matrices on projective points, so you only need to do


```
[m*points_source[i] == points_target[i] for i in range(4)]
```


- add some white space to examples like


```
sage: P1.<a,b,c>=ProjectiveSpace(RR, 2)
sage: points_source=[P1([1,4,1]),P1([1,2,2]),P1([3,5,1]),P1([1,-1,1])]
sage: points_target=[P1([5,-2,7]),P1([3,-2,3]),P1([6,-5,9]), P1([3,6,7])]
sage: P1.point_transformation_matrix(points_source, points_target)
```



- probably worth adding a citation of some kind. This is a standard calculation, but a citation is harder to pin down. I guess you could use my thesis Proposition 2.16 which works out all the details.


```
@phdthesis{Hutz,
  author =   {Benjamin Hutz},
  title =    {Arithmetic Dynamics on Varieties of Dimension Greater Than 1},
  school =  {Brown University},
  year =     {2007},
}
```



-What happened here

works:

```
R.<t> = FunctionField(QQ)
P.<a,b> = ProjectiveSpace(R,1)
points_source = [P([-6*t,7]), P([2,4]), P([3,2])]
points_target = [P([-1,2*t]), P([0,2]), P([-1,6])]
P.point_transformation_matrix(points_source, points_target)
```


ZeroDivisionError:

```
R.<t> = FunctionField(CC)
P.<a,b> = ProjectiveSpace(R,1)
points_source = [P([-6*t,7]), P([2,4]), P([3,2])]
points_target = [P([-1,2*t]), P([0,2]), P([-1,6])]
P.point_transformation_matrix(points_source, points_target)
```


This may be part of a larger issue with non-exact fields. 


```
R.<t> = CC[]
P.<a,b> = ProjectiveSpace(R,1)
points_source = [P([-6*t,7]), P([2,4]), P([3,2])]
points_target = [P([-1,2*t]), P([0,2]), P([-1,6])]
m=P.point_transformation_matrix(points_source, points_target, normalize=False)
[m*points_source[i] == points_target[i] for i in range(3)]
[False, False, False]
```

same for RR,RIF, CIF (Qp seems ok)

even just plain CC has issues

```
P.<a,b> = ProjectiveSpace(CC,1)
points_source = [P([-6,7]), P([1,4]), P([3,2])]
points_target = [P([7,-12]), P([4,2]), P([2,6])]
m=P.point_transformation_matrix(points_source, points_target)
[m*points_source[i] == points_target[i] for i in range(3)]
[False, True, True]
```


Complex Inteval field just gives weirdness

```
P.<a,b> = ProjectiveSpace(CIF,1)
points_source = [P([-6,7]), P([1,4]), P([3,2])]
points_target = [P([7,-12]), P([4,2]), P([2,6])]
m=P.point_transformation_matrix(points_source, points_target)
[m*points_source[i] == points_target[i] for i in range(3)]
[False, True, True]
```



You may just need to exclude non-exact fields.


---

Comment by bhutz created at 2021-06-14 15:38:46

Changing status from needs_review to needs_work.


---

Comment by @EnderWannabe created at 2021-06-15 18:48:06

Fixed the documentation issues.

As for the issues with non-exact fields, normalizing was causing issues, as CIF can't distinguish 1*10<sup>-13</sup> from 0. I stopped normalizing if the field is not exact. This shouldn't interfere with existing functionality, as this function did not previously work with non-exact fields. This fixes the CIF example:



```
P.<a,b> = ProjectiveSpace(CIF,1)
points_source = [P([-6,7]), P([1,4]), P([3,2])]
points_target = [P([7,-12]), P([4,2]), P([2,6])]
m=P.point_transformation_matrix(points_source, points_target); m
[          0.?e-14 0.33333333333334?]
[0.66666666666667?           0.?e-14]
```



The zero division error seems to be caused by CC[] thinking it is an exact field, as function fields do not implement an is_exact() method.

I added a warning saying that over non-exact fields, the matrix may be far from correct.


---

Comment by git created at 2021-06-15 18:49:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @EnderWannabe created at 2021-06-15 18:49:43

Changing status from needs_work to needs_review.


---

Comment by bhutz created at 2021-06-16 20:00:39

This fixes the issues that are fixable. The ZeroDivisionError seems to not be an issue in any of your code, that is just a problem with .inverse() over that ring. So we'll leave that as is.

The inexact solution I think is as good as it can get. Checking `==` for these points isn't really the best mechanism. Looking more closely they are differing only be precision errors in the examples I tried. So, I'm ok with the behavior being exhibited.

Just one issue
 - the warning box is not formatting correctly in the documentation. I think it is just the space before the `::`


---

Comment by bhutz created at 2021-06-16 20:00:39

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-06-17 16:32:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bhutz created at 2021-06-17 18:27:40

This still doesn't work. Take a look at another warning in the code. Looks like it needs to be


```
.. warning::

   text
```



---

Comment by git created at 2021-06-17 19:27:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @EnderWannabe created at 2021-06-17 19:28:28

Changing status from needs_work to needs_review.


---

Comment by bhutz created at 2021-06-17 19:37:16

Changing status from needs_review to positive_review.


---

Comment by bhutz created at 2021-07-06 15:10:13

Changing status from positive_review to needs_work.


---

Comment by bhutz created at 2021-07-06 15:10:13

Found a fringe case bug that should be fixed.


```
P.<x,y,z>=ProjectiveSpace(ZZ,2)
points_source = [P(1 , 0, 0), P(0 , 1 , 0), P(0 , 0 , 1), P(1 , -1 , -1)]
points_target = [P(0 , 1 , 0), P(-2 , 0 , 1), P(0 , 0 , 1), P(1 , -1 , -1)]
P.point_transformation_matrix(points_source,points_target,normalize=True)
```



---

Comment by git created at 2021-07-06 16:25:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @EnderWannabe created at 2021-07-06 16:26:12

Replying to [comment:17 bhutz]:
> Found a fringe case bug that should be fixed.
> 

Fixed and added as test


---

Comment by @EnderWannabe created at 2021-07-06 16:50:31

Changing status from needs_work to needs_review.


---

Comment by bhutz created at 2021-07-06 17:30:48

Changing status from needs_review to positive_review.


---

Comment by bhutz created at 2021-07-06 17:30:48

This fixes the examples. I adjusted the spacing on the added test.
----
New commits:


---

Comment by vbraun created at 2021-07-25 13:25:41

Resolution: fixed
