# Issue 31669: Faster point transform matrix

archive/issues_031669.json:
```json
{
    "body": "CC:  bhutz\n\nKeywords: gsoc2021\n\nCurrently, the point transform matrix method is slow over fields such as QQbar, and does not work over precision fields such as the reals.\n\nWe implement a different approach based on linear algebra which improves performance over QQbar and works over precision fields. We replace the old approach as our update is an improvement in all cases.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31906\n\n",
    "created_at": "2021-06-04T15:24:44Z",
    "labels": [
        "dynamics",
        "minor",
        "enhancement"
    ],
    "title": "Faster point transform matrix",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31669",
    "user": "@EnderWannabe"
}
```
CC:  bhutz

Keywords: gsoc2021

Currently, the point transform matrix method is slow over fields such as QQbar, and does not work over precision fields such as the reals.

We implement a different approach based on linear algebra which improves performance over QQbar and works over precision fields. We replace the old approach as our update is an improvement in all cases.

Issue created by migration from https://trac.sagemath.org/ticket/31906





---

archive/issue_comments_452366.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-08T18:11:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31669#issuecomment-452366",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452367.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-06-08T18:11:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31669#issuecomment-452367",
    "user": "@EnderWannabe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_452368.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-09T14:22:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31669#issuecomment-452368",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452369.json:
```json
{
    "body": "A few comments here.\n\n- why is this based of off #31896?\n\n- Documentation fixes\n\n`Given a projective space of dimension n -> Given a projective space of dimension n`\n\n`finds -> find`\n\n`If the base ring is a field, the matrix is normalized so that the last nonzero entry in the last row is 1.`\n\n- In the examples, there is a left action defined for matrices on projective points, so you only need to do\n\n\n```\n[m*points_source[i] == points_target[i] for i in range(4)]\n```\n\n\n- add some white space to examples like\n\n\n```\nsage: P1.<a,b,c>=ProjectiveSpace(RR, 2)\nsage: points_source=[P1([1,4,1]),P1([1,2,2]),P1([3,5,1]),P1([1,-1,1])]\nsage: points_target=[P1([5,-2,7]),P1([3,-2,3]),P1([6,-5,9]), P1([3,6,7])]\nsage: P1.point_transformation_matrix(points_source, points_target)\n```\n\n\n\n- probably worth adding a citation of some kind. This is a standard calculation, but a citation is harder to pin down. I guess you could use my thesis Proposition 2.16 which works out all the details.\n\n\n```\n@phdthesis{Hutz,\n  author =   {Benjamin Hutz},\n  title =    {Arithmetic Dynamics on Varieties of Dimension Greater Than 1},\n  school =  {Brown University},\n  year =     {2007},\n}\n```\n\n\n\n-What happened here\n\nworks:\n\n```\nR.<t> = FunctionField(QQ)\nP.<a,b> = ProjectiveSpace(R,1)\npoints_source = [P([-6*t,7]), P([2,4]), P([3,2])]\npoints_target = [P([-1,2*t]), P([0,2]), P([-1,6])]\nP.point_transformation_matrix(points_source, points_target)\n```\n\n\nZeroDivisionError:\n\n```\nR.<t> = FunctionField(CC)\nP.<a,b> = ProjectiveSpace(R,1)\npoints_source = [P([-6*t,7]), P([2,4]), P([3,2])]\npoints_target = [P([-1,2*t]), P([0,2]), P([-1,6])]\nP.point_transformation_matrix(points_source, points_target)\n```\n\n\nThis may be part of a larger issue with non-exact fields. \n\n\n```\nR.<t> = CC[]\nP.<a,b> = ProjectiveSpace(R,1)\npoints_source = [P([-6*t,7]), P([2,4]), P([3,2])]\npoints_target = [P([-1,2*t]), P([0,2]), P([-1,6])]\nm=P.point_transformation_matrix(points_source, points_target, normalize=False)\n[m*points_source[i] == points_target[i] for i in range(3)]\n[False, False, False]\n```\n\nsame for RR,RIF, CIF (Qp seems ok)\n\neven just plain CC has issues\n\n```\nP.<a,b> = ProjectiveSpace(CC,1)\npoints_source = [P([-6,7]), P([1,4]), P([3,2])]\npoints_target = [P([7,-12]), P([4,2]), P([2,6])]\nm=P.point_transformation_matrix(points_source, points_target)\n[m*points_source[i] == points_target[i] for i in range(3)]\n[False, True, True]\n```\n\n\nComplex Inteval field just gives weirdness\n\n```\nP.<a,b> = ProjectiveSpace(CIF,1)\npoints_source = [P([-6,7]), P([1,4]), P([3,2])]\npoints_target = [P([7,-12]), P([4,2]), P([2,6])]\nm=P.point_transformation_matrix(points_source, points_target)\n[m*points_source[i] == points_target[i] for i in range(3)]\n[False, True, True]\n```\n\n\n\nYou may just need to exclude non-exact fields.",
    "created_at": "2021-06-14T15:38:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31669#issuecomment-452369",
    "user": "bhutz"
}
```

A few comments here.

- why is this based of off #31896?

- Documentation fixes

`Given a projective space of dimension n -> Given a projective space of dimension n`

`finds -> find`

`If the base ring is a field, the matrix is normalized so that the last nonzero entry in the last row is 1.`

- In the examples, there is a left action defined for matrices on projective points, so you only need to do


```
[m*points_source[i] == points_target[i] for i in range(4)]
```


- add some white space to examples like


```
sage: P1.<a,b,c>=ProjectiveSpace(RR, 2)
sage: points_source=[P1([1,4,1]),P1([1,2,2]),P1([3,5,1]),P1([1,-1,1])]
sage: points_target=[P1([5,-2,7]),P1([3,-2,3]),P1([6,-5,9]), P1([3,6,7])]
sage: P1.point_transformation_matrix(points_source, points_target)
```



- probably worth adding a citation of some kind. This is a standard calculation, but a citation is harder to pin down. I guess you could use my thesis Proposition 2.16 which works out all the details.


```
@phdthesis{Hutz,
  author =   {Benjamin Hutz},
  title =    {Arithmetic Dynamics on Varieties of Dimension Greater Than 1},
  school =  {Brown University},
  year =     {2007},
}
```



-What happened here

works:

```
R.<t> = FunctionField(QQ)
P.<a,b> = ProjectiveSpace(R,1)
points_source = [P([-6*t,7]), P([2,4]), P([3,2])]
points_target = [P([-1,2*t]), P([0,2]), P([-1,6])]
P.point_transformation_matrix(points_source, points_target)
```


ZeroDivisionError:

```
R.<t> = FunctionField(CC)
P.<a,b> = ProjectiveSpace(R,1)
points_source = [P([-6*t,7]), P([2,4]), P([3,2])]
points_target = [P([-1,2*t]), P([0,2]), P([-1,6])]
P.point_transformation_matrix(points_source, points_target)
```


This may be part of a larger issue with non-exact fields. 


```
R.<t> = CC[]
P.<a,b> = ProjectiveSpace(R,1)
points_source = [P([-6*t,7]), P([2,4]), P([3,2])]
points_target = [P([-1,2*t]), P([0,2]), P([-1,6])]
m=P.point_transformation_matrix(points_source, points_target, normalize=False)
[m*points_source[i] == points_target[i] for i in range(3)]
[False, False, False]
```

same for RR,RIF, CIF (Qp seems ok)

even just plain CC has issues

```
P.<a,b> = ProjectiveSpace(CC,1)
points_source = [P([-6,7]), P([1,4]), P([3,2])]
points_target = [P([7,-12]), P([4,2]), P([2,6])]
m=P.point_transformation_matrix(points_source, points_target)
[m*points_source[i] == points_target[i] for i in range(3)]
[False, True, True]
```


Complex Inteval field just gives weirdness

```
P.<a,b> = ProjectiveSpace(CIF,1)
points_source = [P([-6,7]), P([1,4]), P([3,2])]
points_target = [P([7,-12]), P([4,2]), P([2,6])]
m=P.point_transformation_matrix(points_source, points_target)
[m*points_source[i] == points_target[i] for i in range(3)]
[False, True, True]
```



You may just need to exclude non-exact fields.



---

archive/issue_comments_452370.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-06-14T15:38:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31669#issuecomment-452370",
    "user": "bhutz"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_452371.json:
```json
{
    "body": "Fixed the documentation issues.\n\nAs for the issues with non-exact fields, normalizing was causing issues, as CIF can't distinguish 1*10<sup>-13</sup> from 0. I stopped normalizing if the field is not exact. This shouldn't interfere with existing functionality, as this function did not previously work with non-exact fields. This fixes the CIF example:\n\n\n\n```\nP.<a,b> = ProjectiveSpace(CIF,1)\npoints_source = [P([-6,7]), P([1,4]), P([3,2])]\npoints_target = [P([7,-12]), P([4,2]), P([2,6])]\nm=P.point_transformation_matrix(points_source, points_target); m\n[          0.?e-14 0.33333333333334?]\n[0.66666666666667?           0.?e-14]\n```\n\n\n\nThe zero division error seems to be caused by CC[] thinking it is an exact field, as function fields do not implement an is_exact() method.\n\nI added a warning saying that over non-exact fields, the matrix may be far from correct.",
    "created_at": "2021-06-15T18:48:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31669#issuecomment-452371",
    "user": "@EnderWannabe"
}
```

Fixed the documentation issues.

As for the issues with non-exact fields, normalizing was causing issues, as CIF can't distinguish 1*10<sup>-13</sup> from 0. I stopped normalizing if the field is not exact. This shouldn't interfere with existing functionality, as this function did not previously work with non-exact fields. This fixes the CIF example:



```
P.<a,b> = ProjectiveSpace(CIF,1)
points_source = [P([-6,7]), P([1,4]), P([3,2])]
points_target = [P([7,-12]), P([4,2]), P([2,6])]
m=P.point_transformation_matrix(points_source, points_target); m
[          0.?e-14 0.33333333333334?]
[0.66666666666667?           0.?e-14]
```



The zero division error seems to be caused by CC[] thinking it is an exact field, as function fields do not implement an is_exact() method.

I added a warning saying that over non-exact fields, the matrix may be far from correct.



---

archive/issue_comments_452372.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-15T18:49:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31669#issuecomment-452372",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452373.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-06-15T18:49:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31669#issuecomment-452373",
    "user": "@EnderWannabe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_452374.json:
```json
{
    "body": "This fixes the issues that are fixable. The ZeroDivisionError seems to not be an issue in any of your code, that is just a problem with .inverse() over that ring. So we'll leave that as is.\n\nThe inexact solution I think is as good as it can get. Checking `==` for these points isn't really the best mechanism. Looking more closely they are differing only be precision errors in the examples I tried. So, I'm ok with the behavior being exhibited.\n\nJust one issue\n- the warning box is not formatting correctly in the documentation. I think it is just the space before the `::`",
    "created_at": "2021-06-16T20:00:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31669#issuecomment-452374",
    "user": "bhutz"
}
```

This fixes the issues that are fixable. The ZeroDivisionError seems to not be an issue in any of your code, that is just a problem with .inverse() over that ring. So we'll leave that as is.

The inexact solution I think is as good as it can get. Checking `==` for these points isn't really the best mechanism. Looking more closely they are differing only be precision errors in the examples I tried. So, I'm ok with the behavior being exhibited.

Just one issue
- the warning box is not formatting correctly in the documentation. I think it is just the space before the `::`



---

archive/issue_comments_452375.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-06-16T20:00:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31669#issuecomment-452375",
    "user": "bhutz"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_452376.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-17T16:32:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31669#issuecomment-452376",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452377.json:
```json
{
    "body": "This still doesn't work. Take a look at another warning in the code. Looks like it needs to be\n\n\n```\n.. warning::\n\n   text\n```\n",
    "created_at": "2021-06-17T18:27:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31669#issuecomment-452377",
    "user": "bhutz"
}
```

This still doesn't work. Take a look at another warning in the code. Looks like it needs to be


```
.. warning::

   text
```




---

archive/issue_comments_452378.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-17T19:27:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31669#issuecomment-452378",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452379.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-06-17T19:28:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31669#issuecomment-452379",
    "user": "@EnderWannabe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_452380.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-06-17T19:37:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31669#issuecomment-452380",
    "user": "bhutz"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_452381.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-07-06T15:10:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31669#issuecomment-452381",
    "user": "bhutz"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_452382.json:
```json
{
    "body": "Found a fringe case bug that should be fixed.\n\n\n```\nP.<x,y,z>=ProjectiveSpace(ZZ,2)\npoints_source = [P(1 , 0, 0), P(0 , 1 , 0), P(0 , 0 , 1), P(1 , -1 , -1)]\npoints_target = [P(0 , 1 , 0), P(-2 , 0 , 1), P(0 , 0 , 1), P(1 , -1 , -1)]\nP.point_transformation_matrix(points_source,points_target,normalize=True)\n```\n",
    "created_at": "2021-07-06T15:10:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31669#issuecomment-452382",
    "user": "bhutz"
}
```

Found a fringe case bug that should be fixed.


```
P.<x,y,z>=ProjectiveSpace(ZZ,2)
points_source = [P(1 , 0, 0), P(0 , 1 , 0), P(0 , 0 , 1), P(1 , -1 , -1)]
points_target = [P(0 , 1 , 0), P(-2 , 0 , 1), P(0 , 0 , 1), P(1 , -1 , -1)]
P.point_transformation_matrix(points_source,points_target,normalize=True)
```




---

archive/issue_comments_452383.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-06T16:25:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31669#issuecomment-452383",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452384.json:
```json
{
    "body": "Replying to [comment:17 bhutz]:\n> Found a fringe case bug that should be fixed.\n> \n\nFixed and added as test",
    "created_at": "2021-07-06T16:26:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31669#issuecomment-452384",
    "user": "@EnderWannabe"
}
```

Replying to [comment:17 bhutz]:
> Found a fringe case bug that should be fixed.
> 

Fixed and added as test



---

archive/issue_comments_452385.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-07-06T16:50:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31669#issuecomment-452385",
    "user": "@EnderWannabe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_452386.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-07-06T17:30:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31669#issuecomment-452386",
    "user": "bhutz"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_452387.json:
```json
{
    "body": "This fixes the examples. I adjusted the spacing on the added test.\n----\nNew commits:",
    "created_at": "2021-07-06T17:30:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31669#issuecomment-452387",
    "user": "bhutz"
}
```

This fixes the examples. I adjusted the spacing on the added test.
----
New commits:



---

archive/issue_comments_452388.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-07-25T13:25:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31669#issuecomment-452388",
    "user": "vbraun"
}
```

Resolution: fixed
