# Issue 33091: some fixes for signed permutations

archive/issues_033091.json:
```json
{
    "body": "\n\nIssue created by migration from https://trac.sagemath.org/ticket/33328\n\n",
    "created_at": "2022-02-12T20:53:27Z",
    "labels": [
        "component: please change"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "some fixes for signed permutations",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33091",
    "user": "https://github.com/mantepse"
}
```


Issue created by migration from https://trac.sagemath.org/ticket/33328





---

archive/issue_comments_471207.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to combinatorics.",
    "created_at": "2022-02-12T20:58:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33091",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33091#issuecomment-471207",
    "user": "https://github.com/mantepse"
}
```

Changing component from PLEASE CHANGE to combinatorics.



---

archive/issue_comments_471208.json:
```json
{
    "body": "I need help to add the correct `__classcall_private__`, I never get that right.",
    "created_at": "2022-02-12T20:58:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33091",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33091#issuecomment-471208",
    "user": "https://github.com/mantepse"
}
```

I need help to add the correct `__classcall_private__`, I never get that right.



---

archive/issue_comments_471209.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2022-02-12T20:58:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33091",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33091#issuecomment-471209",
    "user": "https://github.com/mantepse"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_471210.json:
```json
{
    "body": "Incidentally, `Permutation` doesn't have `order` either, `PermutationGroupElement` does.  I don't see a good reason for that, though.",
    "created_at": "2022-02-12T20:59:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33091",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33091#issuecomment-471210",
    "user": "https://github.com/mantepse"
}
```

Incidentally, `Permutation` doesn't have `order` either, `PermutationGroupElement` does.  I don't see a good reason for that, though.



---

archive/issue_comments_471211.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-14T11:37:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33091",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33091#issuecomment-471211",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_471212.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-02-14T11:38:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33091",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33091#issuecomment-471212",
    "user": "https://github.com/mantepse"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_471213.json:
```json
{
    "body": "It is a big unfair to call these fixes because they are not bugs. However, thank you for these improvements.\n\nI think the `__getitem__` could be made more efficient by directly accessing the underlying information:\n\n```\ndef __getitem__(self, i):\n    return (self._perm[i], self._colors[i])\n```\n\nA similar change should be done for `SignedPermutations` as the iteration has a different behavior (which is natural and by design even though it is a behavior change when going to the subclass). I think we should try and optimize this method a bit.\n\nPlease also add a doctest for `to_cycles(singletons=False, use_min=False)`.\n\nCan you switch to Python variable lower_case_var_anmes?\n\nIt would be good to not call the variable `next` to not conflict with the iterator advancement function.\n\nI am wondering if it might be better to use the underlying permutions `to_cycle()` and then add in the computation based on the \u201ccolors\u201d. This might not necessarily be faster, but it would reduce some of the code duplication. Although it would obfuscate the code a bit. Your thoughts on this? One advantage of this implementation is that it could easily be modified for general colored permutations, where the `order()` could then be lifted.",
    "created_at": "2022-02-15T06:16:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33091",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33091#issuecomment-471213",
    "user": "https://github.com/tscrim"
}
```

It is a big unfair to call these fixes because they are not bugs. However, thank you for these improvements.

I think the `__getitem__` could be made more efficient by directly accessing the underlying information:

```
def __getitem__(self, i):
    return (self._perm[i], self._colors[i])
```

A similar change should be done for `SignedPermutations` as the iteration has a different behavior (which is natural and by design even though it is a behavior change when going to the subclass). I think we should try and optimize this method a bit.

Please also add a doctest for `to_cycles(singletons=False, use_min=False)`.

Can you switch to Python variable lower_case_var_anmes?

It would be good to not call the variable `next` to not conflict with the iterator advancement function.

I am wondering if it might be better to use the underlying permutions `to_cycle()` and then add in the computation based on the “colors”. This might not necessarily be faster, but it would reduce some of the code duplication. Although it would obfuscate the code a bit. Your thoughts on this? One advantage of this implementation is that it could easily be modified for general colored permutations, where the `order()` could then be lifted.



---

archive/issue_comments_471214.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-16T11:23:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33091",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33091#issuecomment-471214",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_471215.json:
```json
{
    "body": "I am all for reusing `to_cycles`, but cannot do this right now, possibly tonight.",
    "created_at": "2022-02-16T11:24:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33091",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33091#issuecomment-471215",
    "user": "https://github.com/mantepse"
}
```

I am all for reusing `to_cycles`, but cannot do this right now, possibly tonight.



---

archive/issue_comments_471216.json:
```json
{
    "body": "That's the simplest I could come up with, and it looks like a great waste.  Any ideas?\n\n```\ndef to_cycles(pi):\n    cycles = pi.permutation().to_cycles()\n    result = []\n    for c in cycles:\n        s = 1\n        nc = [c[0]]\n        for i in range(1, len(c)):\n            s = pi._colors[c[i - 1] - 1] * s\n            nc.append(s * c[i])\n        s = pi._colors[c[-1] - 1] * s\n        if s < 0:\n            nc.extend([-e for e in nc])\n        result.append(tuple(nc))\n    return result\n```\n",
    "created_at": "2022-02-16T20:37:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33091",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33091#issuecomment-471216",
    "user": "https://github.com/mantepse"
}
```

That's the simplest I could come up with, and it looks like a great waste.  Any ideas?

```
def to_cycles(pi):
    cycles = pi.permutation().to_cycles()
    result = []
    for c in cycles:
        s = 1
        nc = [c[0]]
        for i in range(1, len(c)):
            s = pi._colors[c[i - 1] - 1] * s
            nc.append(s * c[i])
        s = pi._colors[c[-1] - 1] * s
        if s < 0:
            nc.extend([-e for e in nc])
        result.append(tuple(nc))
    return result
```




---

archive/issue_comments_471217.json:
```json
{
    "body": "Thank you for looking into it. That is basically what I had in mind, although you could just convert each cycle to a list and modify the elements of that list. Upon seeing it, I agree that it is a bit computationally wasteful. It might be worth profiling to see how much slower this version is in comparison.\n\nAnother option might be to refactor out with the permutation code and see how much speed we lose there by generalizing it (in that case, there would be a lot of multiplication by `1`).\n\nI will look into this today.",
    "created_at": "2022-02-17T00:07:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33091",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33091#issuecomment-471217",
    "user": "https://github.com/tscrim"
}
```

Thank you for looking into it. That is basically what I had in mind, although you could just convert each cycle to a list and modify the elements of that list. Upon seeing it, I agree that it is a bit computationally wasteful. It might be worth profiling to see how much slower this version is in comparison.

Another option might be to refactor out with the permutation code and see how much speed we lose there by generalizing it (in that case, there would be a lot of multiplication by `1`).

I will look into this today.



---

archive/issue_comments_471218.json:
```json
{
    "body": "I decided to just go with the current method with some slight modifications. It could be refactored, but I figure the extra overhead to make it work for permutations is not worth it.\n\nI added also a `__call__` for signed permutations.\n\nHere is a comparison with your comment:9 code (slightly tweaked to optimize it):\n\n```\nsage: pi = SignedPermutation([-4, 5, -1, 2, -3])\nsage: pi.to_cycles2()\n[(-1, -4, -2, 5, 3, 1, 4, 2, -5, -3)]\nsage: %timeit pi.to_cycles()\n7.58 \u00b5s \u00b1 51.4 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit pi.to_cycles2()  # comment:9 code\n9.53 \u00b5s \u00b1 65.3 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```\n\nversus my pushed code:\n\n```\nsage: %timeit pi.to_cycles()  # pushed commit\n7.55 \u00b5s \u00b1 109 ns per loop per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```\n\n\nComparison of my commit:\n\n```\nsage: pi = SignedPermutations(7)([2,-1,4,-6,-5,-3,7])\nsage: %timeit pi.to_cycles()\n10.9 \u00b5s \u00b1 303 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit pi.to_cycles(singletons=False)\n11.2 \u00b5s \u00b1 223 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```\n\nversus your version:\n\n```\nsage: %timeit pi.to_cycles()\n12.4 \u00b5s \u00b1 3.27 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit pi.to_cycles(singletons=False)\n13.5 \u00b5s \u00b1 3.96 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```\n\n\nWith the branch I pushed, slices are faster for colored and signed permutations:\n\n```\nsage: C = ColoredPermutations(4, 3)\nsage: s1,s2,t = C.gens()\nsage: x = s1*s2*t\nsage: %timeit x[:]\n1.19 \u00b5s \u00b1 2.14 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\n\npi = SignedPermutation([-4, 5, -1, 2, -3])\nsage: %timeit pi[:]\n1.31 \u00b5s \u00b1 18.3 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\nsage: %timeit pi[1::2]\n1.42 \u00b5s \u00b1 15.5 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\n```\n\nversus before\n\n```\n2.23 \u00b5s \u00b1 30.4 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n\n6.07 \u00b5s \u00b1 40.4 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n3.62 \u00b5s \u00b1 22.2 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```\n\n----\nNew commits:",
    "created_at": "2022-02-17T04:58:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33091",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33091#issuecomment-471218",
    "user": "https://github.com/tscrim"
}
```

I decided to just go with the current method with some slight modifications. It could be refactored, but I figure the extra overhead to make it work for permutations is not worth it.

I added also a `__call__` for signed permutations.

Here is a comparison with your comment:9 code (slightly tweaked to optimize it):

```
sage: pi = SignedPermutation([-4, 5, -1, 2, -3])
sage: pi.to_cycles2()
[(-1, -4, -2, 5, 3, 1, 4, 2, -5, -3)]
sage: %timeit pi.to_cycles()
7.58 µs ± 51.4 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit pi.to_cycles2()  # comment:9 code
9.53 µs ± 65.3 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```

versus my pushed code:

```
sage: %timeit pi.to_cycles()  # pushed commit
7.55 µs ± 109 ns per loop per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```


Comparison of my commit:

```
sage: pi = SignedPermutations(7)([2,-1,4,-6,-5,-3,7])
sage: %timeit pi.to_cycles()
10.9 µs ± 303 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit pi.to_cycles(singletons=False)
11.2 µs ± 223 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```

versus your version:

```
sage: %timeit pi.to_cycles()
12.4 µs ± 3.27 µs per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit pi.to_cycles(singletons=False)
13.5 µs ± 3.96 µs per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```


With the branch I pushed, slices are faster for colored and signed permutations:

```
sage: C = ColoredPermutations(4, 3)
sage: s1,s2,t = C.gens()
sage: x = s1*s2*t
sage: %timeit x[:]
1.19 µs ± 2.14 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)

pi = SignedPermutation([-4, 5, -1, 2, -3])
sage: %timeit pi[:]
1.31 µs ± 18.3 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: %timeit pi[1::2]
1.42 µs ± 15.5 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
```

versus before

```
2.23 µs ± 30.4 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)

6.07 µs ± 40.4 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
3.62 µs ± 22.2 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```

----
New commits:



---

archive/issue_comments_471219.json:
```json
{
    "body": "Perfect!  Thank you in particular for adding `__call__`!\n\nI am all for it!",
    "created_at": "2022-02-17T07:24:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33091",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33091#issuecomment-471219",
    "user": "https://github.com/mantepse"
}
```

Perfect!  Thank you in particular for adding `__call__`!

I am all for it!



---

archive/issue_comments_471220.json:
```json
{
    "body": "Green bot too. `:)`",
    "created_at": "2022-02-17T08:02:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33091",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33091#issuecomment-471220",
    "user": "https://github.com/tscrim"
}
```

Green bot too. `:)`



---

archive/issue_comments_471221.json:
```json
{
    "body": "I am also happy with the rest of your changes, so if you are okay with mine, then go ahead an set a positive review.",
    "created_at": "2022-02-17T08:03:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33091",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33091#issuecomment-471221",
    "user": "https://github.com/tscrim"
}
```

I am also happy with the rest of your changes, so if you are okay with mine, then go ahead an set a positive review.



---

archive/issue_comments_471222.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-02-17T15:09:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33091",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33091#issuecomment-471222",
    "user": "https://github.com/mantepse"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_471223.json:
```json
{
    "body": "Thank you for checking my changes and the working to improve Sage!",
    "created_at": "2022-02-17T21:53:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33091",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33091#issuecomment-471223",
    "user": "https://github.com/tscrim"
}
```

Thank you for checking my changes and the working to improve Sage!



---

archive/issue_events_087952.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-02-21T21:56:05Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33091",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33091#event-87952"
}
```



---

archive/issue_comments_471224.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-02-21T21:56:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33091",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33091#issuecomment-471224",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
