# Issue 12175: make install broken in Sage 4.8

archive/issues_012175.json:
```json
{
    "body": "Assignee: GeorgSWeber\n\nwhen I compile Sage 4.8 from source in say `/tmp/sage-4.8`, then\nI do `make install DESTDIR=/usr/local/sage-4.8`, and I run the binary `/usr/local/sage-4.8/bin/sage` I get:\n\n```\n[zimmerma@coing ~]$ /usr/local/sage-4.8/bin/sage\n************************************************************************\nYou must compile Sage first using 'make' in the Sage root directory.\n(If you have already compiled Sage, you must set the SAGE_ROOT variable\nin the file '/usr/local/sage-4.8/bin/sage').\n************************************************************************\n```\n\nThis way of compiling and installing Sage worked before, up to Sage 4.7.2.\n\nA fix is to add the line\n\n```\nSAGE_ROOT=\"/usr/local/sage-4.8/sage\n```\n\nin the script `/usr/local/sage-4.8/bin/sage`. This was done\nautomatically by `make install` up to 4.7.2, and was broken in Sage 4.8.\n\nPaul\n\nIssue created by migration from https://trac.sagemath.org/ticket/12347\n\n",
    "created_at": "2012-01-24T08:00:59Z",
    "labels": [
        "build",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.0",
    "title": "make install broken in Sage 4.8",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12175",
    "user": "@zimmermann6"
}
```
Assignee: GeorgSWeber

when I compile Sage 4.8 from source in say `/tmp/sage-4.8`, then
I do `make install DESTDIR=/usr/local/sage-4.8`, and I run the binary `/usr/local/sage-4.8/bin/sage` I get:

```
[zimmerma@coing ~]$ /usr/local/sage-4.8/bin/sage
************************************************************************
You must compile Sage first using 'make' in the Sage root directory.
(If you have already compiled Sage, you must set the SAGE_ROOT variable
in the file '/usr/local/sage-4.8/bin/sage').
************************************************************************
```

This way of compiling and installing Sage worked before, up to Sage 4.7.2.

A fix is to add the line

```
SAGE_ROOT="/usr/local/sage-4.8/sage
```

in the script `/usr/local/sage-4.8/bin/sage`. This was done
automatically by `make install` up to 4.7.2, and was broken in Sage 4.8.

Paul

Issue created by migration from https://trac.sagemath.org/ticket/12347





---

archive/issue_comments_141774.json:
```json
{
    "body": "The sage directory is relocatable and so simply moving the directory from `/tmp/sage-4.8` to `/usr/local/sage-4.8` will enable you to run sage again. After moving the folder you should also run sage just once ( `/usr/local/sage-4.8/sage` ) so that it resolves all the paths.\n\nAs for make install being broken, it seems to happen because there is no `SAGE_ROOT=\".....\"` in the file anymore and so that hard coding doesn't get done any more. A simple fix should be this patch to the Makefile in your `/tmp/sage-4.8/Makefile`:\n\n```diff\n--- Makefile.old\t2012-01-24 20:37:40.000000000 +0800\n+++ Makefile\t2012-01-24 20:42:38.000000000 +0800\n@@ -149,7 +149,7 @@\n \tmkdir -p $(DESTDIR)/sage\n \tmkdir -p $(DESTDIR)/bin/\n \tcp -rpv * $(DESTDIR)/sage/\n-\tpython local/bin/sage-hardcode_sage_root $(DESTDIR)/sage/sage \"$(DESTDIR)\"/sage\n+\tsed -i -e \"s@^#SAGE_ROOT=/path/.*$@SAGE_ROOT=$(DESTDIR)/sage@;q\" \"$(DESTDIR)/sage/sage\"\n \tcp $(DESTDIR)/sage/sage $(DESTDIR)/bin/\n \tcd $(DESTDIR)/bin/; ./sage -c\n\n```\n",
    "created_at": "2012-01-24T12:44:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141774",
    "user": "@ppurka"
}
```

The sage directory is relocatable and so simply moving the directory from `/tmp/sage-4.8` to `/usr/local/sage-4.8` will enable you to run sage again. After moving the folder you should also run sage just once ( `/usr/local/sage-4.8/sage` ) so that it resolves all the paths.

As for make install being broken, it seems to happen because there is no `SAGE_ROOT="....."` in the file anymore and so that hard coding doesn't get done any more. A simple fix should be this patch to the Makefile in your `/tmp/sage-4.8/Makefile`:

```diff
--- Makefile.old	2012-01-24 20:37:40.000000000 +0800
+++ Makefile	2012-01-24 20:42:38.000000000 +0800
@@ -149,7 +149,7 @@
 	mkdir -p $(DESTDIR)/sage
 	mkdir -p $(DESTDIR)/bin/
 	cp -rpv * $(DESTDIR)/sage/
-	python local/bin/sage-hardcode_sage_root $(DESTDIR)/sage/sage "$(DESTDIR)"/sage
+	sed -i -e "s@^#SAGE_ROOT=/path/.*$@SAGE_ROOT=$(DESTDIR)/sage@;q" "$(DESTDIR)/sage/sage"
 	cp $(DESTDIR)/sage/sage $(DESTDIR)/bin/
 	cd $(DESTDIR)/bin/; ./sage -c

```




---

archive/issue_comments_141775.json:
```json
{
    "body": "Hmm.. using `@` is not a good idea there. The correct patch should be:\n\n```diff\n--- Makefile.old\t2012-01-20 13:38:18.000000000 +0800\n+++ Makefile\t2012-01-24 20:51:23.000000000 +0800\n@@ -149,7 +149,7 @@\n \tmkdir -p $(DESTDIR)/sage\n \tmkdir -p $(DESTDIR)/bin/\n \tcp -rpv * $(DESTDIR)/sage/\n-\tpython local/bin/sage-hardcode_sage_root $(DESTDIR)/sage/sage \"$(DESTDIR)\"/sage\n+\tsed -i -e \"s|^#SAGE_ROOT=/path/.*$|SAGE_ROOT=\\\"$(DESTDIR)/sage\\\"|;q\" \"$(DESTDIR)/sage/sage\"\n \tcp $(DESTDIR)/sage/sage $(DESTDIR)/bin/\n \tcd $(DESTDIR)/bin/; ./sage -c\n \n```\n",
    "created_at": "2012-01-24T12:52:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141775",
    "user": "@ppurka"
}
```

Hmm.. using `@` is not a good idea there. The correct patch should be:

```diff
--- Makefile.old	2012-01-20 13:38:18.000000000 +0800
+++ Makefile	2012-01-24 20:51:23.000000000 +0800
@@ -149,7 +149,7 @@
 	mkdir -p $(DESTDIR)/sage
 	mkdir -p $(DESTDIR)/bin/
 	cp -rpv * $(DESTDIR)/sage/
-	python local/bin/sage-hardcode_sage_root $(DESTDIR)/sage/sage "$(DESTDIR)"/sage
+	sed -i -e "s|^#SAGE_ROOT=/path/.*$|SAGE_ROOT=\"$(DESTDIR)/sage\"|;q" "$(DESTDIR)/sage/sage"
 	cp $(DESTDIR)/sage/sage $(DESTDIR)/bin/
 	cd $(DESTDIR)/bin/; ./sage -c
 
```




---

archive/issue_comments_141776.json:
```json
{
    "body": "I tried your patch and got:\n\n```\nsed -i -e \"s|^#SAGE_ROOT=/path/.*SAGE_ROOT=\\\"/usr/local/sage-4.8a/sage\\\"|;q\" \"/usr/local/sage-4.8a/sage/sage\"\nsed: -e expression #1, char 62: unterminated `s' command\nmake: *** [install] Error 1\n```\n\nDid you really test your patch?\n\n```\n[root@coing sage-4.8]# diff Makefile.orig Makefile\n152c152\n<       python local/bin/sage-hardcode_sage_root $(DESTDIR)/sage/sage \"$(DESTDIR)\"/sage\n---\n>       sed -i -e \"s|^#SAGE_ROOT=/path/.*$|SAGE_ROOT=\\\"$(DESTDIR)/sage\\\"|;q\" \"$(DESTDIR)/sage/sage\"\n```\n\nPaul",
    "created_at": "2012-01-25T11:25:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141776",
    "user": "@zimmermann6"
}
```

I tried your patch and got:

```
sed -i -e "s|^#SAGE_ROOT=/path/.*SAGE_ROOT=\"/usr/local/sage-4.8a/sage\"|;q" "/usr/local/sage-4.8a/sage/sage"
sed: -e expression #1, char 62: unterminated `s' command
make: *** [install] Error 1
```

Did you really test your patch?

```
[root@coing sage-4.8]# diff Makefile.orig Makefile
152c152
<       python local/bin/sage-hardcode_sage_root $(DESTDIR)/sage/sage "$(DESTDIR)"/sage
---
>       sed -i -e "s|^#SAGE_ROOT=/path/.*$|SAGE_ROOT=\"$(DESTDIR)/sage\"|;q" "$(DESTDIR)/sage/sage"
```

Paul



---

archive/issue_comments_141777.json:
```json
{
    "body": "Sigh. Sorry for the trouble. I don't have sage-4.8 built yet. So, I can't test this as \"make install\". But I did test this sed expression before putting it here (that's how I caught the ``@`` problem).\n\nI see from\n\n```\nsed -i -e \"s|^#SAGE_ROOT=/path/.*SAGE_ROOT=\\\"/usr/local/sage-4.8a/sage\\\"|;q\"\n```\n\nthat the `$|` was eaten away by the make process (it is not stripped away when run on the terminal). This is why you are getting that sed error. Can you try it without the `$`? Then the patch will look like this:\n\n```diff\n--- Makefile\t2012-01-20 13:38:18.000000000 +0800\n+++ /home/punarbasu/Makefile\t2012-01-24 20:51:23.000000000 +0800\n@@ -149,7 +149,7 @@\n \tmkdir -p $(DESTDIR)/sage\n \tmkdir -p $(DESTDIR)/bin/\n \tcp -rpv * $(DESTDIR)/sage/\n-\tpython local/bin/sage-hardcode_sage_root $(DESTDIR)/sage/sage \"$(DESTDIR)\"/sage\n+\tsed -i -e \"s|^#SAGE_ROOT=/path/.*|SAGE_ROOT=\\\"$(DESTDIR)/sage\\\"|;q\" \"$(DESTDIR)/sage/sage\"\n \tcp $(DESTDIR)/sage/sage $(DESTDIR)/bin/\n \tcd $(DESTDIR)/bin/; ./sage -c\n \n```\n",
    "created_at": "2012-01-25T16:16:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141777",
    "user": "@ppurka"
}
```

Sigh. Sorry for the trouble. I don't have sage-4.8 built yet. So, I can't test this as "make install". But I did test this sed expression before putting it here (that's how I caught the ``@`` problem).

I see from

```
sed -i -e "s|^#SAGE_ROOT=/path/.*SAGE_ROOT=\"/usr/local/sage-4.8a/sage\"|;q"
```

that the `$|` was eaten away by the make process (it is not stripped away when run on the terminal). This is why you are getting that sed error. Can you try it without the `$`? Then the patch will look like this:

```diff
--- Makefile	2012-01-20 13:38:18.000000000 +0800
+++ /home/punarbasu/Makefile	2012-01-24 20:51:23.000000000 +0800
@@ -149,7 +149,7 @@
 	mkdir -p $(DESTDIR)/sage
 	mkdir -p $(DESTDIR)/bin/
 	cp -rpv * $(DESTDIR)/sage/
-	python local/bin/sage-hardcode_sage_root $(DESTDIR)/sage/sage "$(DESTDIR)"/sage
+	sed -i -e "s|^#SAGE_ROOT=/path/.*|SAGE_ROOT=\"$(DESTDIR)/sage\"|;q" "$(DESTDIR)/sage/sage"
 	cp $(DESTDIR)/sage/sage $(DESTDIR)/bin/
 	cd $(DESTDIR)/bin/; ./sage -c
 
```




---

archive/issue_comments_141778.json:
```json
{
    "body": "it still does not work. With the change of comment [comment:4], the `$(DESTDIR)/bin/sage` file contains a single line:\n\n```\ntarte% cat /tmp/sage-4.8/bin/sage\n#!/usr/bin/env bash\n```\n\nPaul",
    "created_at": "2012-01-25T16:33:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141778",
    "user": "@zimmermann6"
}
```

it still does not work. With the change of comment [comment:4], the `$(DESTDIR)/bin/sage` file contains a single line:

```
tarte% cat /tmp/sage-4.8/bin/sage
#!/usr/bin/env bash
```

Paul



---

archive/issue_comments_141779.json:
```json
{
    "body": "Ok. I will leave it up to someone else to come up with a fix to the python file `local/bin/sage-hardcode_sage_root`. I will check this ticket again after I have downloaded and built sage-4.8.\n\nThanks for your patience and feedback.",
    "created_at": "2012-01-25T17:15:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141779",
    "user": "@ppurka"
}
```

Ok. I will leave it up to someone else to come up with a fix to the python file `local/bin/sage-hardcode_sage_root`. I will check this ticket again after I have downloaded and built sage-4.8.

Thanks for your patience and feedback.



---

archive/issue_comments_141780.json:
```json
{
    "body": "Ok. Here is a fix for the hard coding of the path. The simplest fix is to not do any hard coding at all!\n\nPlease apply [attachment:trac_12347.patch] to `SAGE_ROOT` (the directory where the `Makefile` is present). If the review is positive then we should also remove `SAGE_ROOT/local/bin/sage-hardcode_sage_root` from the tree since it is no longer needed.\n\nI also ran into some problems with `cp`, in particular with this line in the `Makefile`:\n\n```\ncp -rpv * $(DESTDIR)/sage/\n```\n\nOn the system that I tried this, cp actually errored out with error status 2. The last few lines of the make output are as follows:\n\n```\n$ make DESTDIR=\"/tmp/sage-install\" install\n\n.... tons of copying stuff ....\n\n`spkg/logs/matplotlib-1.0.1.p0.log' -> `/tmp/sage-install/sage/spkg/logs/matplotlib-1.0.1.p0.log'\n`spkg/logs/sqlite-3.7.5.p0.log' -> `/tmp/sage-install/sage/spkg/logs/sqlite-3.7.5.p0.log'\n`start.log' -> `/tmp/sage-install/sage/start.log'\n`tmp' -> `/tmp/sage-install/sage/tmp'\nmake: *** [install] Error 1\n```\n\nI can not fathom why it errors out. As a workaround, I changed the `cp` command to include `-u` and the cp finishes fine after invoking the make command once again:\n\n```\n$ make DESTDIR=\"/tmp/sage-install\" install\necho \"Experimental use only!\"\nExperimental use only!\nif [ \"/tmp/sage-install\" = \"\" ]; then \\\n\t\techo \"Set DESTDIR\"; \\\n\t\texit 1; \\\n\tfi\nmkdir -p /tmp/sage-install\nmkdir -p /tmp/sage-install/sage\nmkdir -p /tmp/sage-install/bin/\ncp -rpuv * /tmp/sage-install/sage/\n`Makefile' -> `/tmp/sage-install/sage/Makefile'\ncd /tmp/sage-install/bin; ln -sfn ../sage/sage ./sage; ./sage -c\nThe Sage installation tree may have moved\n(from /home/punarbasu/Installations/sage-4.8 to /tmp/sage-install/sage).\nChanging various hardcoded paths...\n(Please wait at most a few minutes.)\nDO NOT INTERRUPT THIS.\nDone resetting paths.\n```\n",
    "created_at": "2012-01-28T12:59:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141780",
    "user": "@ppurka"
}
```

Ok. Here is a fix for the hard coding of the path. The simplest fix is to not do any hard coding at all!

Please apply [attachment:trac_12347.patch] to `SAGE_ROOT` (the directory where the `Makefile` is present). If the review is positive then we should also remove `SAGE_ROOT/local/bin/sage-hardcode_sage_root` from the tree since it is no longer needed.

I also ran into some problems with `cp`, in particular with this line in the `Makefile`:

```
cp -rpv * $(DESTDIR)/sage/
```

On the system that I tried this, cp actually errored out with error status 2. The last few lines of the make output are as follows:

```
$ make DESTDIR="/tmp/sage-install" install

.... tons of copying stuff ....

`spkg/logs/matplotlib-1.0.1.p0.log' -> `/tmp/sage-install/sage/spkg/logs/matplotlib-1.0.1.p0.log'
`spkg/logs/sqlite-3.7.5.p0.log' -> `/tmp/sage-install/sage/spkg/logs/sqlite-3.7.5.p0.log'
`start.log' -> `/tmp/sage-install/sage/start.log'
`tmp' -> `/tmp/sage-install/sage/tmp'
make: *** [install] Error 1
```

I can not fathom why it errors out. As a workaround, I changed the `cp` command to include `-u` and the cp finishes fine after invoking the make command once again:

```
$ make DESTDIR="/tmp/sage-install" install
echo "Experimental use only!"
Experimental use only!
if [ "/tmp/sage-install" = "" ]; then \
		echo "Set DESTDIR"; \
		exit 1; \
	fi
mkdir -p /tmp/sage-install
mkdir -p /tmp/sage-install/sage
mkdir -p /tmp/sage-install/bin/
cp -rpuv * /tmp/sage-install/sage/
`Makefile' -> `/tmp/sage-install/sage/Makefile'
cd /tmp/sage-install/bin; ln -sfn ../sage/sage ./sage; ./sage -c
The Sage installation tree may have moved
(from /home/punarbasu/Installations/sage-4.8 to /tmp/sage-install/sage).
Changing various hardcoded paths...
(Please wait at most a few minutes.)
DO NOT INTERRUPT THIS.
Done resetting paths.
```




---

archive/issue_comments_141781.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-01-28T12:59:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141781",
    "user": "@ppurka"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_141782.json:
```json
{
    "body": "You shouldn't use the options `-u`, `-v`, or `-R` for cp.  Re `-r`, the man page for cp on OS X says\n\n```\n     Historic versions of the cp utility had a -r option.  This implementation supports that\n     option; however, its use is strongly discouraged, as it does not correctly copy special\n     files, symbolic links, or fifo's.\n```\n\nThe OS X version of cp doesn't recognize the `-u` option at all.  The Solaris version of cp doesn't support `-u` or `-v`.\n\nMake sure to only use Posix-standard options; I think [this web page](http://pwet.fr/man/linux/commandes/posix/cp) is accurate.\n\nAlong the same lines, on Solaris (and perhaps other platforms), `ln -f` doesn't behave the way it does on linux; see the comment on line 71 of the file SAGE_ROOT/local/bin/sage-build.",
    "created_at": "2012-01-28T15:58:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141782",
    "user": "@jhpalmieri"
}
```

You shouldn't use the options `-u`, `-v`, or `-R` for cp.  Re `-r`, the man page for cp on OS X says

```
     Historic versions of the cp utility had a -r option.  This implementation supports that
     option; however, its use is strongly discouraged, as it does not correctly copy special
     files, symbolic links, or fifo's.
```

The OS X version of cp doesn't recognize the `-u` option at all.  The Solaris version of cp doesn't support `-u` or `-v`.

Make sure to only use Posix-standard options; I think [this web page](http://pwet.fr/man/linux/commandes/posix/cp) is accurate.

Along the same lines, on Solaris (and perhaps other platforms), `ln -f` doesn't behave the way it does on linux; see the comment on line 71 of the file SAGE_ROOT/local/bin/sage-build.



---

archive/issue_comments_141783.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-01-28T15:58:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141783",
    "user": "@jhpalmieri"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_141784.json:
```json
{
    "body": "`@`jhpalmieri: I added -u to make sure that the second time `make install` is run, cp does not go around copying the files all over again. The options `-r`, `-v` were all present from before. `ln -f` was needed in case the user ran `make install` yet again, otherwise ln would give error. If the first invocation of make install doesn't fail, then there is no need to use -f with ln.\n\nIf `cp` is unreliable then what is the alternative (it is actually quite reliable on linux with the `-a` option, that is, it copies symlinks properly)? Alternatively, can we assume that `rsync` is available on all platforms and use rsync instead?",
    "created_at": "2012-01-28T16:13:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141784",
    "user": "@ppurka"
}
```

`@`jhpalmieri: I added -u to make sure that the second time `make install` is run, cp does not go around copying the files all over again. The options `-r`, `-v` were all present from before. `ln -f` was needed in case the user ran `make install` yet again, otherwise ln would give error. If the first invocation of make install doesn't fail, then there is no need to use -f with ln.

If `cp` is unreliable then what is the alternative (it is actually quite reliable on linux with the `-a` option, that is, it copies symlinks properly)? Alternatively, can we assume that `rsync` is available on all platforms and use rsync instead?



---

archive/issue_comments_141785.json:
```json
{
    "body": "Replying to [comment:9 ppurka]:\n> `@`jhpalmieri: I added -u to make sure that the second time `make install` is run, cp does not go around copying the files all over again. \n\nSolaris is a supported platform for Sage on which the `-u` option is not recognized, so it doesn't matter too much why you added it: it's not going to work.\n\n> The options `-r`, `-v` were all present from before. \n\nBut while you're fixing other things, you might as well fix this.  Just use `-R` or `-pR` instead.\n\n> `ln -f` was needed in case the user ran `make install` yet again, otherwise ln would give error. If the first invocation of make install doesn't fail, then there is no need to use -f with ln.\n\nSame comment as before: it's not going to work this way, so you should do it a different way.  (For example, first run 'rm -f ...' on the link, then do 'ln -s ...'.)\n\n> If `cp` is unreliable then what is the alternative (it is actually quite reliable on linux with the `-a` option, that is, it copies symlinks properly)? Alternatively, can we assume that `rsync` is available on all platforms and use rsync instead?\n\nI think that 'cp -pR' is reliable on all platforms.  Note also that the 'make install' option says \"Experimental use only!\", so I don't think it's been well-maintained or supported, or even used much, which is why, for example, the `-v` option for cp wasn't removed earlier.  But if you're working on this, you should do it right, so that it works on all supported platforms.  Using POSIX-standard commands should be completely reliable; every platform's version of 'cp' should support the POSIX-standard options for cp.",
    "created_at": "2012-01-28T16:50:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141785",
    "user": "@jhpalmieri"
}
```

Replying to [comment:9 ppurka]:
> `@`jhpalmieri: I added -u to make sure that the second time `make install` is run, cp does not go around copying the files all over again. 

Solaris is a supported platform for Sage on which the `-u` option is not recognized, so it doesn't matter too much why you added it: it's not going to work.

> The options `-r`, `-v` were all present from before. 

But while you're fixing other things, you might as well fix this.  Just use `-R` or `-pR` instead.

> `ln -f` was needed in case the user ran `make install` yet again, otherwise ln would give error. If the first invocation of make install doesn't fail, then there is no need to use -f with ln.

Same comment as before: it's not going to work this way, so you should do it a different way.  (For example, first run 'rm -f ...' on the link, then do 'ln -s ...'.)

> If `cp` is unreliable then what is the alternative (it is actually quite reliable on linux with the `-a` option, that is, it copies symlinks properly)? Alternatively, can we assume that `rsync` is available on all platforms and use rsync instead?

I think that 'cp -pR' is reliable on all platforms.  Note also that the 'make install' option says "Experimental use only!", so I don't think it's been well-maintained or supported, or even used much, which is why, for example, the `-v` option for cp wasn't removed earlier.  But if you're working on this, you should do it right, so that it works on all supported platforms.  Using POSIX-standard commands should be completely reliable; every platform's version of 'cp' should support the POSIX-standard options for cp.



---

archive/issue_comments_141786.json:
```json
{
    "body": "Attachment [trac_12347-remove-sage-hardcode.patch](tarball://root/attachments/some-uuid/ticket12347/trac_12347-remove-sage-hardcode.patch) by @ppurka created at 2012-01-28 19:32:10\n\nRemove unnecessary file. Apply to `SAGE_ROOT/local/bin`",
    "created_at": "2012-01-28T19:32:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141786",
    "user": "@ppurka"
}
```

Attachment [trac_12347-remove-sage-hardcode.patch](tarball://root/attachments/some-uuid/ticket12347/trac_12347-remove-sage-hardcode.patch) by @ppurka created at 2012-01-28 19:32:10

Remove unnecessary file. Apply to `SAGE_ROOT/local/bin`



---

archive/issue_comments_141787.json:
```json
{
    "body": "Updated the patches.\n\nNow I see why cp failed:\n\n```\n...stallations/sage-4.8> make DESTDIR=\"/tmp/sage-xxxx\" install |& tee -i -a ~/tmp/log-new.txt\necho \"Experimental use only!\"\nExperimental use only!\nif [ \"/tmp/sage-xxxx\" = \"\" ]; then \\\n\t\techo \"Set DESTDIR\"; \\\n\t\texit 1; \\\n\tfi\nmkdir -p /tmp/sage-xxxx\nmkdir -p /tmp/sage-xxxx/sage\nmkdir -p /tmp/sage-xxxx/bin/\ncp -Rp * /tmp/sage-xxxx/sage/\ncp: reading `local/lib/libpari.a': Input/output error\nmake: *** [install] Error 1\n```\n\nRebuilding pari makes this bug go away\n\n```\n~/Installations/sage-4.8> ./sage -f spkg/standard/pari-2.5.0.p3.spkg >& ~/tmp/pari.txt\n~/Installations/sage-4.8> cp local/lib/libpari.a /tmp\n~/Installations/sage-4.8> \n```\n",
    "created_at": "2012-01-28T19:37:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141787",
    "user": "@ppurka"
}
```

Updated the patches.

Now I see why cp failed:

```
...stallations/sage-4.8> make DESTDIR="/tmp/sage-xxxx" install |& tee -i -a ~/tmp/log-new.txt
echo "Experimental use only!"
Experimental use only!
if [ "/tmp/sage-xxxx" = "" ]; then \
		echo "Set DESTDIR"; \
		exit 1; \
	fi
mkdir -p /tmp/sage-xxxx
mkdir -p /tmp/sage-xxxx/sage
mkdir -p /tmp/sage-xxxx/bin/
cp -Rp * /tmp/sage-xxxx/sage/
cp: reading `local/lib/libpari.a': Input/output error
make: *** [install] Error 1
```

Rebuilding pari makes this bug go away

```
~/Installations/sage-4.8> ./sage -f spkg/standard/pari-2.5.0.p3.spkg >& ~/tmp/pari.txt
~/Installations/sage-4.8> cp local/lib/libpari.a /tmp
~/Installations/sage-4.8> 
```




---

archive/issue_comments_141788.json:
```json
{
    "body": "is the patch ready for review? No work issues were added in comment [comment:8].\n\nPaul",
    "created_at": "2012-01-30T15:14:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141788",
    "user": "@zimmermann6"
}
```

is the patch ready for review? No work issues were added in comment [comment:8].

Paul



---

archive/issue_comments_141789.json:
```json
{
    "body": "Sorry, forgot to set it to needs_review.",
    "created_at": "2012-01-30T15:20:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141789",
    "user": "@ppurka"
}
```

Sorry, forgot to set it to needs_review.



---

archive/issue_comments_141790.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-01-30T15:20:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141790",
    "user": "@ppurka"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_141791.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-04-06T12:23:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141791",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_141792.json:
```json
{
    "body": "Replace\n\n```\ncd $(DESTDIR)/bin; ln -s ../sage/sage ./sage; ./sage -c\n```\n\nby\n\n```\n-rm -f $(DESTDIR)/bin/sage\nln -s ../sage/sage $(DESTDIR)/bin/sage\n$(DESTDIR)/bin/sage -c   # Need to run sage-location\n```\n",
    "created_at": "2012-04-06T12:23:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141792",
    "user": "@jdemeyer"
}
```

Replace

```
cd $(DESTDIR)/bin; ln -s ../sage/sage ./sage; ./sage -c
```

by

```
-rm -f $(DESTDIR)/bin/sage
ln -s ../sage/sage $(DESTDIR)/bin/sage
$(DESTDIR)/bin/sage -c   # Need to run sage-location
```




---

archive/issue_comments_141793.json:
```json
{
    "body": "updated.",
    "created_at": "2012-04-06T15:41:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141793",
    "user": "@ppurka"
}
```

updated.



---

archive/issue_comments_141794.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-04-10T12:39:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141794",
    "user": "@ppurka"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_141795.json:
```json
{
    "body": "Just one more thing: it would be better to first delete `$(DESTDIR)/sage/` for two reasons:\n1. if there already was a previous version, there might be some kind of conflict (although I cannot immediately think of a concrete problem that could occur).\n2. some program in the old version might still be running (considering `sage-cleaner`, this is less unlikely than you might think at first).",
    "created_at": "2012-04-11T17:36:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141795",
    "user": "@jdemeyer"
}
```

Just one more thing: it would be better to first delete `$(DESTDIR)/sage/` for two reasons:
1. if there already was a previous version, there might be some kind of conflict (although I cannot immediately think of a concrete problem that could occur).
2. some program in the old version might still be running (considering `sage-cleaner`, this is less unlikely than you might think at first).



---

archive/issue_comments_141796.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-04-11T17:37:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141796",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_141797.json:
```json
{
    "body": "Updated the patch. I guess we could write some logic to detect if a sage process is running, but it would not be robust enough and would bloat the install part.\n\nI updated the patch to not proceed with the installation if the `$(DESTDIR)/sage` is a file or symlink. It will (hopefully) prevent accidents. :)",
    "created_at": "2012-04-13T14:40:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141797",
    "user": "@ppurka"
}
```

Updated the patch. I guess we could write some logic to detect if a sage process is running, but it would not be robust enough and would bloat the install part.

I updated the patch to not proceed with the installation if the `$(DESTDIR)/sage` is a file or symlink. It will (hopefully) prevent accidents. :)



---

archive/issue_comments_141798.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-04-13T14:40:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141798",
    "user": "@ppurka"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_141799.json:
```json
{
    "body": "\"`[ -e`\" isn't portable.  \"`[ -f`\" is portable.\n\nWhy do you talk about symlinks in your comment?  I don't see that in your code.\n\nI would simply remove the whole `elif` block.  `mkdir -p \"$(DESTDIR)\"/sage` should fail anyway if `\"$(DESTDIR)\"/sage` is a non-directory.",
    "created_at": "2012-04-13T14:51:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141799",
    "user": "@jdemeyer"
}
```

"`[ -e`" isn't portable.  "`[ -f`" is portable.

Why do you talk about symlinks in your comment?  I don't see that in your code.

I would simply remove the whole `elif` block.  `mkdir -p "$(DESTDIR)"/sage` should fail anyway if `"$(DESTDIR)"/sage` is a non-directory.



---

archive/issue_comments_141800.json:
```json
{
    "body": "Mention in a comment that the \"`[ -d`\" test is meant to exclude the case that \"$(DESTDIR)\"/sage is an existing file, not a directory.",
    "created_at": "2012-04-13T14:52:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141800",
    "user": "@jdemeyer"
}
```

Mention in a comment that the "`[ -d`" test is meant to exclude the case that "$(DESTDIR)"/sage is an existing file, not a directory.



---

archive/issue_comments_141801.json:
```json
{
    "body": "Replying to [comment:21 jdemeyer]:\n> Why do you talk about symlinks in your comment?  I don't see that in your code.\n\nWell, `-e` checks for both. I didn't know it wasn't portable. You are correct that mkdir will fail. I hadn't thought of that.",
    "created_at": "2012-04-13T15:16:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141801",
    "user": "@ppurka"
}
```

Replying to [comment:21 jdemeyer]:
> Why do you talk about symlinks in your comment?  I don't see that in your code.

Well, `-e` checks for both. I didn't know it wasn't portable. You are correct that mkdir will fail. I hadn't thought of that.



---

archive/issue_comments_141802.json:
```json
{
    "body": "Apply to SAGE_ROOT",
    "created_at": "2012-04-13T15:20:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141802",
    "user": "@ppurka"
}
```

Apply to SAGE_ROOT



---

archive/issue_comments_141803.json:
```json
{
    "body": "Attachment [trac_12347.patch](tarball://root/attachments/some-uuid/ticket12347/trac_12347.patch) by @ppurka created at 2012-04-13 15:21:27\n\nUpdated.",
    "created_at": "2012-04-13T15:21:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141803",
    "user": "@ppurka"
}
```

Attachment [trac_12347.patch](tarball://root/attachments/some-uuid/ticket12347/trac_12347.patch) by @ppurka created at 2012-04-13 15:21:27

Updated.



---

archive/issue_comments_141804.json:
```json
{
    "body": "Actually `-e` should be portable, going by [this page](http://www.unix.com/man-page/POSIX/1/test/).",
    "created_at": "2012-04-13T15:28:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141804",
    "user": "@ppurka"
}
```

Actually `-e` should be portable, going by [this page](http://www.unix.com/man-page/POSIX/1/test/).



---

archive/issue_comments_141805.json:
```json
{
    "body": "Replying to [comment:25 ppurka]:\n> Actually `-e` should be portable, going by [this page](http://www.unix.com/man-page/POSIX/1/test/).\n\nMaybe it \"should be\", but it isn't.",
    "created_at": "2012-04-13T15:44:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141805",
    "user": "@jdemeyer"
}
```

Replying to [comment:25 ppurka]:
> Actually `-e` should be portable, going by [this page](http://www.unix.com/man-page/POSIX/1/test/).

Maybe it "should be", but it isn't.



---

archive/issue_comments_141806.json:
```json
{
    "body": "For shell script portability discussions, I often refer to the GNU autoconf manual: [http://www.gnu.org/savannah-checkouts/gnu/autoconf/manual/autoconf-2.68/html_node/Portable-Shell.html#Portable-Shell](http://www.gnu.org/savannah-checkouts/gnu/autoconf/manual/autoconf-2.68/html_node/Portable-Shell.html#Portable-Shell).\n\nQuoting from there:\n> But occasionally you may find it necessary to check whether some arbitrary file exists. To do so, use \u2018test -f\u2019 or \u2018test -r\u2019. Do not use \u2018test -x\u2019, because 4.3BSD does not have it. Do not use \u2018test -e\u2019 either, because Solaris /bin/sh lacks it. To test for symbolic links on systems that have them, use \u2018test -h\u2019 rather than \u2018test -L\u2019; either form conforms to Posix 1003.1-2001, but older shells like Solaris 8 /bin/sh support only -h.",
    "created_at": "2012-04-13T15:47:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141806",
    "user": "@jdemeyer"
}
```

For shell script portability discussions, I often refer to the GNU autoconf manual: [http://www.gnu.org/savannah-checkouts/gnu/autoconf/manual/autoconf-2.68/html_node/Portable-Shell.html#Portable-Shell](http://www.gnu.org/savannah-checkouts/gnu/autoconf/manual/autoconf-2.68/html_node/Portable-Shell.html#Portable-Shell).

Quoting from there:
> But occasionally you may find it necessary to check whether some arbitrary file exists. To do so, use ‘test -f’ or ‘test -r’. Do not use ‘test -x’, because 4.3BSD does not have it. Do not use ‘test -e’ either, because Solaris /bin/sh lacks it. To test for symbolic links on systems that have them, use ‘test -h’ rather than ‘test -L’; either form conforms to Posix 1003.1-2001, but older shells like Solaris 8 /bin/sh support only -h.



---

archive/issue_comments_141807.json:
```json
{
    "body": "Thanks!",
    "created_at": "2012-04-13T15:48:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141807",
    "user": "@ppurka"
}
```

Thanks!



---

archive/issue_comments_141808.json:
```json
{
    "body": "the patches apply successfully to sage-5.0.beta13 and `make install` works.\nMy only comment after looking at the patch: shouldn't we check also if $(DESTDIR)/bin\nalready exists?\n\nPaul",
    "created_at": "2012-04-16T14:36:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141808",
    "user": "@zimmermann6"
}
```

the patches apply successfully to sage-5.0.beta13 and `make install` works.
My only comment after looking at the patch: shouldn't we check also if $(DESTDIR)/bin
already exists?

Paul



---

archive/issue_comments_141809.json:
```json
{
    "body": "Replying to [comment:29 zimmerma]:\n> shouldn't we check also if $(DESTDIR)/bin already exists?\nWhy?  What would you propose?",
    "created_at": "2012-04-16T14:47:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141809",
    "user": "@jdemeyer"
}
```

Replying to [comment:29 zimmerma]:
> shouldn't we check also if $(DESTDIR)/bin already exists?
Why?  What would you propose?



---

archive/issue_comments_141810.json:
```json
{
    "body": "if we assume that $(DESTDIR)/sage can already exist, the same can happen for $(DESTDIR)/bin\nwith a previous installation of Sage. What will then happen? I propose to remove\n$(DESTDIR)/bin if it exists and is a directory.\n\nPaul",
    "created_at": "2012-04-16T15:08:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141810",
    "user": "@zimmermann6"
}
```

if we assume that $(DESTDIR)/sage can already exist, the same can happen for $(DESTDIR)/bin
with a previous installation of Sage. What will then happen? I propose to remove
$(DESTDIR)/bin if it exists and is a directory.

Paul



---

archive/issue_comments_141811.json:
```json
{
    "body": "Replying to [comment:31 zimmerma]:\n> if we assume that $(DESTDIR)/sage can already exist, the same can happen for $(DESTDIR)/bin\n> with a previous installation of Sage. What will then happen?\nNothing bad will happen.  The file or symbolic link `$(DESTDIR)/bin/sage` will be deleted and recreated as symbolic link to `$(DESTDIR)/sage/sage`.",
    "created_at": "2012-04-16T15:15:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141811",
    "user": "@jdemeyer"
}
```

Replying to [comment:31 zimmerma]:
> if we assume that $(DESTDIR)/sage can already exist, the same can happen for $(DESTDIR)/bin
> with a previous installation of Sage. What will then happen?
Nothing bad will happen.  The file or symbolic link `$(DESTDIR)/bin/sage` will be deleted and recreated as symbolic link to `$(DESTDIR)/sage/sage`.



---

archive/issue_comments_141812.json:
```json
{
    "body": "ok, then I give a positive review.\n\nPaul",
    "created_at": "2012-04-16T15:22:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141812",
    "user": "@zimmermann6"
}
```

ok, then I give a positive review.

Paul



---

archive/issue_comments_141813.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-04-16T15:22:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141813",
    "user": "@zimmermann6"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_141814.json:
```json
{
    "body": "Replying to [comment:33 zimmerma]:\n> ok, then I give a positive review.\nAgreed.",
    "created_at": "2012-04-16T15:24:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141814",
    "user": "@jdemeyer"
}
```

Replying to [comment:33 zimmerma]:
> ok, then I give a positive review.
Agreed.



---

archive/issue_comments_141815.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-04-19T08:10:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12175",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12175#issuecomment-141815",
    "user": "@jdemeyer"
}
```

Resolution: fixed
