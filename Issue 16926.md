# Issue 16926: Speed improvement for DiGraph.in_degree

Issue created by migration from Trac.

Original creator: ncohen

Original creation time: 2014-10-16 06:03:08

CC:  jmantysalo

As reported by Jori, the following is... unexpected:


```
sage: g = digraphs.RandomDirectedGNP(300,.2)
sage: %timeit g.sinks() # vertices of outdegree 0
1000 loops, best of 3: 376 µs per loop
sage: %timeit g.sources() # vertices of indegree 0
100 loops, best of 3: 7.78 ms per loop
```


With this patch:

```
sage: g = digraphs.RandomDirectedGNP(300,.2)      
sage: %timeit g.sinks() # vertices of outdegree 0 
1000 loops, best of 3: 370 µs per loop
sage: %timeit g.sources() # vertices of indegree 0
1000 loops, best of 3: 361 µs per loop
```


Cause:

This is because the function `in_degree` was not implemented at the data structure level, but "abstractly" by iterating over all incoming edges of a vertices and counting them. This is bad, especially since any sensible backends already stores that information.

What the branch does:

1) Add a `in_degree` function in the CGraph backend.

2) Add a `in_degree` and `out_degree` (empty) function in the `GenericGraph` backend (the only point is to write somewhere that the `in_degree/out_degree` functions should be implemented by all graph backends

3) Add a `in_degree/out_degree` function to the NetworkX backend. This backend is only used in one doctest, and this is the only backend that did not have this function.

4) Because all backends now have the `in_degree/out_degree` functions, it is now useless to 'check if the backend has the function' before calling it. As a result the code of `DiGraph.in_degree/out_degree` is simplified.

Nathann


---

Comment by ncohen created at 2014-10-16 06:03:22

Changing status from new to needs_review.


---

Comment by git created at 2014-10-16 06:04:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2014-10-16 11:28:46

Seems to work; now `top()` and `bottom()` on posets take same time. This also explains why timings with #13223 where little strange.

Unfortunately I don't know enought Sage to be able to really review this.


---

Comment by dcoudert created at 2014-10-18 11:29:55

The patch is working well. However, there are several places in `src/sage/graphs/base/c_graph.pyx` where you have such instruction (this one from your patch):


```
cdef v_int = get_vertex(v,
                        self.vertex_ints,
                        self.vertex_labels,
                        self._cg)
```


Shouldn't you specify the _int_ type ?


---

Comment by git created at 2014-10-18 11:58:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2014-10-18 11:58:47

> Shouldn't you specify the _int_ type ?

Indeed. I just did, thanks.

Nathann


---

Comment by dcoudert created at 2014-10-18 13:29:49

Changing status from needs_review to positive_review.


---

Comment by dcoudert created at 2014-10-18 13:29:49

All tests pass on `src/sage/graphs/`, so I give positive review.


---

Comment by ncohen created at 2014-10-18 13:30:15

Thanks !

Nathann


---

Comment by vbraun created at 2014-10-18 18:19:10

Resolution: fixed
