# Issue 15455: Value of cached methods should not always be pickled

archive/issues_015455.json:
```json
{
    "body": "CC:  @nathanncohen @vbraun @nbruin @novoselt jkeitel @nthiery\n\nKeywords: pickling hash cache\n\nIn #15278, the hash of graphs was turned into a ``@`cached_method`. If a cached method is pickled, then the cached value is pickled as well. In the case of a hash value, this is not always what we want, since the hash value might depend on the memory address of an object, or worse: The hash function might change in future implementations.\n\nThat's to say: If you save object O now, together with hash value 123, and later load it, then hash(O) will still be 123, even if a newly constructed object P with O==P might have hash(P)==456, because of a change in the hash function.\n\nThis obviously is a problem. There is something called `sage.misc.cachefunc.ClearCacheOnPickle`, but I don't know if this would really help in this case. Also, this would clear *all* cache values at once. Also, I don't know if it works for cached methods that do not take arguments (beside `self`).\n\nI suggest that we should instead have an optional parameter for `sage.misc.cachefunc.CachedMethodCallerNoArgs` that determines whether or not the cached value is preserved, and use it on graphs (and future applications of cached method on `__hash__`).\n\nIssue created by migration from https://trac.sagemath.org/ticket/15692\n\n",
    "created_at": "2014-01-18T09:30:18Z",
    "labels": [
        "component: pickling",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.0",
    "title": "Value of cached methods should not always be pickled",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15455",
    "user": "https://github.com/simon-king-jena"
}
```
CC:  @nathanncohen @vbraun @nbruin @novoselt jkeitel @nthiery

Keywords: pickling hash cache

In #15278, the hash of graphs was turned into a ``@`cached_method`. If a cached method is pickled, then the cached value is pickled as well. In the case of a hash value, this is not always what we want, since the hash value might depend on the memory address of an object, or worse: The hash function might change in future implementations.

That's to say: If you save object O now, together with hash value 123, and later load it, then hash(O) will still be 123, even if a newly constructed object P with O==P might have hash(P)==456, because of a change in the hash function.

This obviously is a problem. There is something called `sage.misc.cachefunc.ClearCacheOnPickle`, but I don't know if this would really help in this case. Also, this would clear *all* cache values at once. Also, I don't know if it works for cached methods that do not take arguments (beside `self`).

I suggest that we should instead have an optional parameter for `sage.misc.cachefunc.CachedMethodCallerNoArgs` that determines whether or not the cached value is preserved, and use it on graphs (and future applications of cached method on `__hash__`).

Issue created by migration from https://trac.sagemath.org/ticket/15692





---

archive/issue_comments_199341.json:
```json
{
    "body": "In #15149 it was proposed that caches should be 'opt-in and not opt-out' (comment:6:ticket:15149). Imho most caches are not used for things that are horribly expensive to compute, they are just too expensive to be computed again all the time.\n\nWould somebody mind if I implemented it that way, i.e., the default for a cache would be that it is not pickled?",
    "created_at": "2014-05-12T10:01:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199341",
    "user": "https://github.com/saraedum"
}
```

In #15149 it was proposed that caches should be 'opt-in and not opt-out' (comment:6:ticket:15149). Imho most caches are not used for things that are horribly expensive to compute, they are just too expensive to be computed again all the time.

Would somebody mind if I implemented it that way, i.e., the default for a cache would be that it is not pickled?



---

archive/issue_comments_199342.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-05-12T17:44:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199342",
    "user": "https://github.com/saraedum"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_199343.json:
```json
{
    "body": "I'm in support of this although I am not the right person to review the changes.\n----\nNew commits:",
    "created_at": "2014-05-12T22:30:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199343",
    "user": "https://github.com/novoselt"
}
```

I'm in support of this although I am not the right person to review the changes.
----
New commits:



---

archive/issue_comments_199344.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-07-23T16:41:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199344",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_199345.json:
```json
{
    "body": "does not apply, needs rebase",
    "created_at": "2015-08-04T12:56:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199345",
    "user": "https://github.com/fchapoton"
}
```

does not apply, needs rebase



---

archive/issue_comments_199346.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-08-04T12:56:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199346",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_199347.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-08-08T18:56:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199347",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_199348.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-08-08T18:59:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199348",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_199349.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-08-09T08:31:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199349",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_199350.json:
```json
{
    "body": "one failing doctest, see patchbot report",
    "created_at": "2015-08-09T08:31:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199350",
    "user": "https://github.com/fchapoton"
}
```

one failing doctest, see patchbot report



---

archive/issue_comments_199351.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-08-12T18:49:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199351",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_199352.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-08-12T18:50:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199352",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_199353.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-08-15T11:09:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199353",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_199354.json:
```json
{
    "body": "Hello,\n\n\nIn `_cached_function_unpickle` instead of \n\n```\nfor k,v in cache:\n    ret.cache[k] = v\n```\n\nyou can simply do `ret.cache.update(cache)`. Moreover, in that function you should document the argument `cache`.\n\nI think that disabling the cache by default on pickle is a good improvement. However, the class `ClearCacheOnPickle` that you remove in your branch had several purposes: clear the cache on pickle but also on copy. Your version keep the cache on copy and that might not be appropriate for classes that used `ClearCacheOnPickle`.\n\nVincent",
    "created_at": "2015-08-15T11:09:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199354",
    "user": "https://github.com/videlec"
}
```

Hello,


In `_cached_function_unpickle` instead of 

```
for k,v in cache:
    ret.cache[k] = v
```

you can simply do `ret.cache.update(cache)`. Moreover, in that function you should document the argument `cache`.

I think that disabling the cache by default on pickle is a good improvement. However, the class `ClearCacheOnPickle` that you remove in your branch had several purposes: clear the cache on pickle but also on copy. Your version keep the cache on copy and that might not be appropriate for classes that used `ClearCacheOnPickle`.

Vincent



---

archive/issue_comments_199355.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-08-18T18:41:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199355",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_199356.json:
```json
{
    "body": "Replying to [comment:16 vdelecroix]:\n> I think that disabling the cache by default on pickle is a good improvement. However, the class `ClearCacheOnPickle` that you remove in your branch had several purposes: clear the cache on pickle but also on copy. Your version keep the cache on copy and that might not be appropriate for classes that used `ClearCacheOnPickle`.\nThanks for pointing this out. What should we do about this? Should caches ever be copied actually?",
    "created_at": "2015-08-18T18:46:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199356",
    "user": "https://github.com/saraedum"
}
```

Replying to [comment:16 vdelecroix]:
> I think that disabling the cache by default on pickle is a good improvement. However, the class `ClearCacheOnPickle` that you remove in your branch had several purposes: clear the cache on pickle but also on copy. Your version keep the cache on copy and that might not be appropriate for classes that used `ClearCacheOnPickle`.
Thanks for pointing this out. What should we do about this? Should caches ever be copied actually?



---

archive/issue_comments_199357.json:
```json
{
    "body": "Changing status from needs_work to needs_info.",
    "created_at": "2015-08-18T18:46:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199357",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_work to needs_info.



---

archive/issue_comments_199358.json:
```json
{
    "body": "Replying to [comment:19 saraedum]:\n> Replying to [comment:16 vdelecroix]:\n> > I think that disabling the cache by default on pickle is a good improvement. However, the class `ClearCacheOnPickle` that you remove in your branch had several purposes: clear the cache on pickle but also on copy. Your version keep the cache on copy and that might not be appropriate for classes that used `ClearCacheOnPickle`.\n> Thanks for pointing this out. What should we do about this? Should caches ever be copied actually?\n\nI guess not. And if you really want to, it is always possible to fill the cache manually.",
    "created_at": "2015-08-18T21:49:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199358",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:19 saraedum]:
> Replying to [comment:16 vdelecroix]:
> > I think that disabling the cache by default on pickle is a good improvement. However, the class `ClearCacheOnPickle` that you remove in your branch had several purposes: clear the cache on pickle but also on copy. Your version keep the cache on copy and that might not be appropriate for classes that used `ClearCacheOnPickle`.
> Thanks for pointing this out. What should we do about this? Should caches ever be copied actually?

I guess not. And if you really want to, it is always possible to fill the cache manually.



---

archive/issue_comments_199359.json:
```json
{
    "body": "Do you have any idea how I could implement that? I could for example implement `__getstate__` for sage parents and elements, but then whenever it is overwritten I would have to rely on the super implementation being called. I could also implement `__copy__` there which is muss less likely to be overwritten but still the problem is the same.\nThe problem is that unlike with pickling, `__getstate__` is not called on the cached methods when a shallow copy is made (only for a deep copy.)\nOne thing I could think of is putting the `id` of the original object into each of its caches. Any call to the cache could check that id (which could be a small but significant performance loss) and complain if it does not match the element the cache is associated to.\n\nI think that implementing `__copy__` is probably the best path to take.",
    "created_at": "2015-08-24T02:50:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199359",
    "user": "https://github.com/saraedum"
}
```

Do you have any idea how I could implement that? I could for example implement `__getstate__` for sage parents and elements, but then whenever it is overwritten I would have to rely on the super implementation being called. I could also implement `__copy__` there which is muss less likely to be overwritten but still the problem is the same.
The problem is that unlike with pickling, `__getstate__` is not called on the cached methods when a shallow copy is made (only for a deep copy.)
One thing I could think of is putting the `id` of the original object into each of its caches. Any call to the cache could check that id (which could be a small but significant performance loss) and complain if it does not match the element the cache is associated to.

I think that implementing `__copy__` is probably the best path to take.



---

archive/issue_comments_199360.json:
```json
{
    "body": "Replying to [comment:22 saraedum]:\n> Do you have any idea how I could implement that? I could for example implement `__getstate__` for sage parents and elements, but then whenever it is overwritten I would have to rely on the super implementation being called.\n\n(I'm pretty sure that `__getstate__` should call its super unless one really knows what one is doing. A bigger problem is that `__getstate__` is only a convention that the standard `__reduce__` uses. I'm sure there are classes that implement their own `__reduce__` far below the point where you'd be thinking of injecting your `__getstate__`)\n\nOn #15207 there is some discussion of some possible infrastructure for managing these things. Perhaps it's relevant for your case?\n\n>I could also implement `__copy__` there which is muss less likely to be overwritten but still the problem is the same.\n\nI would recommend leaving `__copy__` out of it. That has nothing to do with the pickling/serialization protocol. It provides a \"cheap\" way of replicating a mutable structure (note that for immutable structures, `__copy__` routinely returns `self`, because immutability implies) so that mutations of one do not affect the other.\n\nMutable structures need to take care that they invalidate caches already (when mutated). I would say that a default behaviour where `copy` creates a new object with the same caches would be appropriate. The default behaviour of \"copy\" is to copy the instance dict, which largely establishes this.\n\nIf this is not appropriate behaviour, it seems to me that the class has rather special needs and hence should provide its own `__copy__`.\n\n**EDIT:** I see that `ClearCacheOnPickle` gets its `copy` behaviour because under certain circumstances, `copy(...)` will revert to calling `__getstate__`. So I would expect that this would continue to be the case.  Since the \"clear cache on copy\" is a bit of a side-effect of the implementation of `ClearCacheOnPickle` I would try and see if just changing the copy behaviour gives acceptable results. If not then providing a custom `__copy__` on just the class that originally inherited from `ClearCacheOnPickle` would do the trick. Going forward, I think having caches replicated (or probably even shared!) between shallow copies by default doesn't seem like an unreasonable default.",
    "created_at": "2015-08-24T18:32:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199360",
    "user": "https://github.com/nbruin"
}
```

Replying to [comment:22 saraedum]:
> Do you have any idea how I could implement that? I could for example implement `__getstate__` for sage parents and elements, but then whenever it is overwritten I would have to rely on the super implementation being called.

(I'm pretty sure that `__getstate__` should call its super unless one really knows what one is doing. A bigger problem is that `__getstate__` is only a convention that the standard `__reduce__` uses. I'm sure there are classes that implement their own `__reduce__` far below the point where you'd be thinking of injecting your `__getstate__`)

On #15207 there is some discussion of some possible infrastructure for managing these things. Perhaps it's relevant for your case?

>I could also implement `__copy__` there which is muss less likely to be overwritten but still the problem is the same.

I would recommend leaving `__copy__` out of it. That has nothing to do with the pickling/serialization protocol. It provides a "cheap" way of replicating a mutable structure (note that for immutable structures, `__copy__` routinely returns `self`, because immutability implies) so that mutations of one do not affect the other.

Mutable structures need to take care that they invalidate caches already (when mutated). I would say that a default behaviour where `copy` creates a new object with the same caches would be appropriate. The default behaviour of "copy" is to copy the instance dict, which largely establishes this.

If this is not appropriate behaviour, it seems to me that the class has rather special needs and hence should provide its own `__copy__`.

**EDIT:** I see that `ClearCacheOnPickle` gets its `copy` behaviour because under certain circumstances, `copy(...)` will revert to calling `__getstate__`. So I would expect that this would continue to be the case.  Since the "clear cache on copy" is a bit of a side-effect of the implementation of `ClearCacheOnPickle` I would try and see if just changing the copy behaviour gives acceptable results. If not then providing a custom `__copy__` on just the class that originally inherited from `ClearCacheOnPickle` would do the trick. Going forward, I think having caches replicated (or probably even shared!) between shallow copies by default doesn't seem like an unreasonable default.



---

archive/issue_comments_199361.json:
```json
{
    "body": "Ok. Thanks for the input. I will implement it like that. Explicitly implement `__copy__` where it is necessary to keep the old behaviour and leave everything else like it is in my branch.",
    "created_at": "2015-08-27T00:04:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199361",
    "user": "https://github.com/saraedum"
}
```

Ok. Thanks for the input. I will implement it like that. Explicitly implement `__copy__` where it is necessary to keep the old behaviour and leave everything else like it is in my branch.



---

archive/issue_comments_199362.json:
```json
{
    "body": "Trying to implement this, I realized that the point of the `ClearCacheOnPickle` on these classes was certainly not to clear *all* caches on copy.\nAlso, `ClearCacheOnPickle` is broken, since it replaces any cache dictionary with an actual `dict` , i.e., it would  replace a weak dictionary with a regular one.)\n\nI guess there was in each case some cached method which should not be pickled (or probably copied.)\nSo it is probably better to look at the actual occurences and fix the copying there instead of just hacking a \"drop some caches\" `__copy__` method which probably does too much and might even break if we change the cached methods next time around.\n\nThe classes which carry `ClearCacheOnPickle` are:\n* `ToricVariety_field` where it was added in `0be2c23d` with the comment \"Do not pickle caches of toric varieties\". So it could be alright if we still copied them.\n* `WeilGroup_gens` where it was added when the class did not provide the functionality to clear caches on copy. So it might be alright to copy them.\n* `AmbientSpace` and `RootSpace` where it is not clear why it was added exactly. Maybe Nicolas could clarify this (author of the commit which added it.)\n\nBtw. the lengthy discussion in #11115 (this is where the clear caches on copy was introduced) does not make any mention of \"copy\".",
    "created_at": "2015-09-03T21:38:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199362",
    "user": "https://github.com/saraedum"
}
```

Trying to implement this, I realized that the point of the `ClearCacheOnPickle` on these classes was certainly not to clear *all* caches on copy.
Also, `ClearCacheOnPickle` is broken, since it replaces any cache dictionary with an actual `dict` , i.e., it would  replace a weak dictionary with a regular one.)

I guess there was in each case some cached method which should not be pickled (or probably copied.)
So it is probably better to look at the actual occurences and fix the copying there instead of just hacking a "drop some caches" `__copy__` method which probably does too much and might even break if we change the cached methods next time around.

The classes which carry `ClearCacheOnPickle` are:
* `ToricVariety_field` where it was added in `0be2c23d` with the comment "Do not pickle caches of toric varieties". So it could be alright if we still copied them.
* `WeilGroup_gens` where it was added when the class did not provide the functionality to clear caches on copy. So it might be alright to copy them.
* `AmbientSpace` and `RootSpace` where it is not clear why it was added exactly. Maybe Nicolas could clarify this (author of the commit which added it.)

Btw. the lengthy discussion in #11115 (this is where the clear caches on copy was introduced) does not make any mention of "copy".



---

archive/issue_comments_199363.json:
```json
{
    "body": "Since there has been no reaction for quite a while, I'm setting this back to needs review. I think my current implementation does the right thing.",
    "created_at": "2015-09-29T19:39:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199363",
    "user": "https://github.com/saraedum"
}
```

Since there has been no reaction for quite a while, I'm setting this back to needs review. I think my current implementation does the right thing.



---

archive/issue_comments_199364.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2015-09-29T19:39:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199364",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_199365.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-10-02T01:41:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199365",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_199366.json:
```json
{
    "body": "From the patchbot\n\n```\nsage -t --long src/sage/misc/cachefunc.pyx\n**********************************************************************\nFile \"src/sage/misc/cachefunc.pyx\", line 3185, in sage.misc.cachefunc.cached_method\nFailed example:\n    id(d) == hash(d)\nExpected:\n    True\nGot:\n    False\n**********************************************************************\n1 item had failures:\n   1 of  30 in sage.misc.cachefunc.cached_method\n    [830 tests, 1 failure, 15.75 s]\n----------------------------------------------------------------------\nsage -t --long src/sage/misc/cachefunc.pyx  # 1 doctest failed\n----------------------------------------------------------------------\n```\n",
    "created_at": "2015-10-02T01:41:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199366",
    "user": "https://github.com/videlec"
}
```

From the patchbot

```
sage -t --long src/sage/misc/cachefunc.pyx
**********************************************************************
File "src/sage/misc/cachefunc.pyx", line 3185, in sage.misc.cachefunc.cached_method
Failed example:
    id(d) == hash(d)
Expected:
    True
Got:
    False
**********************************************************************
1 item had failures:
   1 of  30 in sage.misc.cachefunc.cached_method
    [830 tests, 1 failure, 15.75 s]
----------------------------------------------------------------------
sage -t --long src/sage/misc/cachefunc.pyx  # 1 doctest failed
----------------------------------------------------------------------
```




---

archive/issue_comments_199367.json:
```json
{
    "body": "That test does not fail for me. It is reported to be fine by another patchbot. Maybe the patchbot that ran it is broken somehow? I can not really imagine that something \"random\" is happening here.",
    "created_at": "2015-10-04T21:49:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199367",
    "user": "https://github.com/saraedum"
}
```

That test does not fail for me. It is reported to be fine by another patchbot. Maybe the patchbot that ran it is broken somehow? I can not really imagine that something "random" is happening here.



---

archive/issue_comments_199368.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-10-04T21:49:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199368",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_199369.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-23T18:27:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199369",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_199370.json:
```json
{
    "body": "What's the use case for `pickle=True`? I would say that a cache should *never* be pickled.",
    "created_at": "2015-12-23T19:35:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199370",
    "user": "https://github.com/jdemeyer"
}
```

What's the use case for `pickle=True`? I would say that a cache should *never* be pickled.



---

archive/issue_comments_199371.json:
```json
{
    "body": "Replying to [comment:30 jdemeyer]:\n> What's the use case for `pickle=True`? I would say that a cache should *never* be pickled.\n\nIf something in cache is expensive to compute and you want to dump your object so that later you can load it with cache full. I use it regularly for my personal classes and some time ago it was also used for lists of reflexive polytopes (to store points and faces that were taking many seconds to recompute). One may argue whether it is the best way philosophically or not, but it is easy and it works, so it is nice to have this possibility available.",
    "created_at": "2015-12-25T04:51:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199371",
    "user": "https://github.com/novoselt"
}
```

Replying to [comment:30 jdemeyer]:
> What's the use case for `pickle=True`? I would say that a cache should *never* be pickled.

If something in cache is expensive to compute and you want to dump your object so that later you can load it with cache full. I use it regularly for my personal classes and some time ago it was also used for lists of reflexive polytopes (to store points and faces that were taking many seconds to recompute). One may argue whether it is the best way philosophically or not, but it is easy and it works, so it is nice to have this possibility available.



---

archive/issue_comments_199372.json:
```json
{
    "body": "Replying to [comment:31 novoselt]:\n> If something in cache is expensive to compute and you want to dump your object so that later you can load it with cache full. I use it regularly for my personal classes and some time ago it was also used for lists of reflexive polytopes (to store points and faces that were taking many seconds to recompute). One may argue whether it is the best way philosophically or not, but it is easy and it works, so it is nice to have this possibility available.\n\nThat seems like an argument for making `pickle=True` the default.\n\nSomething else: couldn't this be implemented more easily by a new class instead of adding `pickle` arguments everywhere?",
    "created_at": "2015-12-25T12:51:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199372",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:31 novoselt]:
> If something in cache is expensive to compute and you want to dump your object so that later you can load it with cache full. I use it regularly for my personal classes and some time ago it was also used for lists of reflexive polytopes (to store points and faces that were taking many seconds to recompute). One may argue whether it is the best way philosophically or not, but it is easy and it works, so it is nice to have this possibility available.

That seems like an argument for making `pickle=True` the default.

Something else: couldn't this be implemented more easily by a new class instead of adding `pickle` arguments everywhere?



---

archive/issue_comments_199373.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-12-25T12:55:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199373",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_199374.json:
```json
{
    "body": "One easy simplification: make `CacheDict` never pickle its contents and just choose the type `dict` or `CacheDict`.",
    "created_at": "2015-12-25T12:55:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199374",
    "user": "https://github.com/jdemeyer"
}
```

One easy simplification: make `CacheDict` never pickle its contents and just choose the type `dict` or `CacheDict`.



---

archive/issue_comments_199375.json:
```json
{
    "body": "One easy simplification: make `CacheDict` never pickle its contents and just choose the type `dict` or `CacheDict`.",
    "created_at": "2015-12-25T12:57:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199375",
    "user": "https://github.com/jdemeyer"
}
```

One easy simplification: make `CacheDict` never pickle its contents and just choose the type `dict` or `CacheDict`.



---

archive/issue_comments_199376.json:
```json
{
    "body": "This is not grammatically correct:\n\n```\nPer default, the contents of the cache are not pickle::\n```\n",
    "created_at": "2015-12-25T12:57:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199376",
    "user": "https://github.com/jdemeyer"
}
```

This is not grammatically correct:

```
Per default, the contents of the cache are not pickle::
```




---

archive/issue_comments_199377.json:
```json
{
    "body": "Can you replace the `pickle` keyword and attribute to `do_pickle` since that more accurately describes the intention.\n\nAlso, please explain the reason for changing both the pickling/unpickling of the cached function themselves as well as the `CacheDict`. It seems that they both solve your problem and I don't see why this problem needs to be solved twice.",
    "created_at": "2015-12-25T13:01:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199377",
    "user": "https://github.com/jdemeyer"
}
```

Can you replace the `pickle` keyword and attribute to `do_pickle` since that more accurately describes the intention.

Also, please explain the reason for changing both the pickling/unpickling of the cached function themselves as well as the `CacheDict`. It seems that they both solve your problem and I don't see why this problem needs to be solved twice.



---

archive/issue_comments_199378.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-03-20T21:16:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199378",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_199379.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-03-20T22:28:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199379",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_199380.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-03-20T22:29:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199380",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_199381.json:
```json
{
    "body": "Replying to [comment:36 jdemeyer]:\n> Can you replace the `pickle` keyword and attribute to `do_pickle` since that more accurately describes the intention.\nFixed.\n> Also, please explain the reason for changing both the pickling/unpickling of the cached function themselves as well as the `CacheDict`. It seems that they both solve your problem and I don't see why this problem needs to be solved twice.\nYou are right. I did look at the (do_)pickle parameter in too many places.",
    "created_at": "2016-03-20T22:33:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199381",
    "user": "https://github.com/saraedum"
}
```

Replying to [comment:36 jdemeyer]:
> Can you replace the `pickle` keyword and attribute to `do_pickle` since that more accurately describes the intention.
Fixed.
> Also, please explain the reason for changing both the pickling/unpickling of the cached function themselves as well as the `CacheDict`. It seems that they both solve your problem and I don't see why this problem needs to be solved twice.
You are right. I did look at the (do_)pickle parameter in too many places.



---

archive/issue_comments_199382.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-03-21T11:40:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199382",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_199383.json:
```json
{
    "body": "Changing keywords from \"pickling hash cache\" to \"pickling, hash, cache, days71\".",
    "created_at": "2016-03-24T02:22:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199383",
    "user": "https://github.com/saraedum"
}
```

Changing keywords from "pickling hash cache" to "pickling, hash, cache, days71".



---

archive/issue_comments_199384.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-03-24T02:59:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199384",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_199385.json:
```json
{
    "body": "Looks good to me.",
    "created_at": "2016-03-24T03:10:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199385",
    "user": "https://github.com/roed314"
}
```

Looks good to me.



---

archive/issue_comments_199386.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-03-24T03:10:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199386",
    "user": "https://github.com/roed314"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_199387.json:
```json
{
    "body": "I'm not going to change this from positive review, but I found the tiniest doctest typo:\n\n```\n+        Per default, the contents of the cache are not pickle::\n```\n\npickle should be pickled here.",
    "created_at": "2016-03-24T09:36:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199387",
    "user": "https://github.com/adeines"
}
```

I'm not going to change this from positive review, but I found the tiniest doctest typo:

```
+        Per default, the contents of the cache are not pickle::
```

pickle should be pickled here.



---

archive/issue_comments_199388.json:
```json
{
    "body": "I think you're looking at an old version; that typo was what was fixed in 746dc53.",
    "created_at": "2016-03-24T19:47:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199388",
    "user": "https://github.com/roed314"
}
```

I think you're looking at an old version; that typo was what was fixed in 746dc53.



---

archive/issue_comments_199389.json:
```json
{
    "body": "Awesome!",
    "created_at": "2016-03-25T00:09:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199389",
    "user": "https://github.com/adeines"
}
```

Awesome!



---

archive/issue_comments_199390.json:
```json
{
    "body": "Fails on 32-bit:\n\n```\nsage -t --long src/sage/misc/cachefunc.pyx\n**********************************************************************\nFile \"src/sage/misc/cachefunc.pyx\", line 3161, in sage.misc.cachefunc.cached_method\nFailed example:\n    id(d) == hash(d)\nExpected:\n    True\nGot:\n    False\n**********************************************************************\n1 item had failures:\n   1 of  30 in sage.misc.cachefunc.cached_method\n    [843 tests, 1 failure, 8.96 s]\n```\n",
    "created_at": "2016-03-26T09:10:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199390",
    "user": "https://github.com/vbraun"
}
```

Fails on 32-bit:

```
sage -t --long src/sage/misc/cachefunc.pyx
**********************************************************************
File "src/sage/misc/cachefunc.pyx", line 3161, in sage.misc.cachefunc.cached_method
Failed example:
    id(d) == hash(d)
Expected:
    True
Got:
    False
**********************************************************************
1 item had failures:
   1 of  30 in sage.misc.cachefunc.cached_method
    [843 tests, 1 failure, 8.96 s]
```




---

archive/issue_comments_199391.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-03-26T09:10:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199391",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_199392.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-06-20T17:10:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199392",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_199393.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2016-06-20T17:11:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199393",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_199394.json:
```json
{
    "body": "Since this is such a minor change, I set this back to positive review.",
    "created_at": "2016-06-20T17:12:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199394",
    "user": "https://github.com/saraedum"
}
```

Since this is such a minor change, I set this back to positive review.



---

archive/issue_comments_199395.json:
```json
{
    "body": "I suspect I am getting this in sage-on-gentoo pulling volker's current develop branch because of this:\n\n```\nFile \"/usr/lib64/python2.7/site-packages/sage/modular/overconvergent/weightspace.py\", line 473, in sage.modular.overconvergent.weightspace.AlgebraicWeight\nFailed example:\n    w == loads(dumps(w))\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib64/python2.7/site-packages/sage/doctest/forker.py\", line 501, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib64/python2.7/site-packages/sage/doctest/forker.py\", line 864, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.modular.overconvergent.weightspace.AlgebraicWeight[3]>\", line 1, in <module>\n        w == loads(dumps(w))\n      File \"sage/structure/element.pyx\", line 913, in sage.structure.element.Element.__richcmp__ (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/structure/element.c:9542)\n        return (<Element>self)._richcmp_(<Element>other, op)\n      File \"sage/structure/element.pyx\", line 948, in sage.structure.element.Element._richcmp_ (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/structure/element.c:9722)\n        c = left._cmp_(right)\n      File \"sage/structure/element.pyx\", line 964, in sage.structure.element.Element._cmp_ (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/structure/element.c:10101)\n        return left_cmp(right)\n      File \"/usr/lib64/python2.7/site-packages/sage/modular/overconvergent/weightspace.py\", line 417, in __cmp__\n        return cmp(self.values_on_gens(), other.values_on_gens())\n      File \"/usr/lib64/python2.7/site-packages/sage/modular/overconvergent/weightspace.py\", line 380, in values_on_gens\n        return ( self(self.parent()._param), self.teichmuller_type())\n      File \"/usr/lib64/python2.7/site-packages/sage/modular/overconvergent/weightspace.py\", line 539, in __call__\n        if self._p**(x.precision_absolute()) < self._chi.conductor():\n      File \"sage/misc/cachefunc.pyx\", line 1717, in sage.misc.cachefunc.CachedMethodPickle.__call__ (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/misc/cachefunc.c:8703)\n        return CM(*args,**kwds)\n      File \"sage/misc/cachefunc.pyx\", line 2401, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/misc/cachefunc.c:12708)\n        self.cache = f(self._instance)\n      File \"/usr/lib64/python2.7/site-packages/sage/modular/dirichlet.py\", line 755, in conductor\n        if self.modulus() == 1 or self.is_trivial():\n      File \"sage/misc/cachefunc.pyx\", line 1717, in sage.misc.cachefunc.CachedMethodPickle.__call__ (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/misc/cachefunc.c:8703)\n        return CM(*args,**kwds)\n      File \"sage/misc/cachefunc.pyx\", line 2401, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/misc/cachefunc.c:12708)\n        self.cache = f(self._instance)\n```\n\nand ending after many lines with\n\n```\n      File \"sage/misc/cachefunc.pyx\", line 2401, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/misc/cachefunc.c:12708)\n        self.cache = f(self._instance)\n      File \"/usr/lib64/python2.7/site-packages/sage/modular/dirichlet.py\", line 1738, in element\n        v = M([dlog[x] for x in self.values_on_gens()])\n      File \"/usr/lib64/python2.7/site-packages/sage/modular/dirichlet.py\", line 1705, in values_on_gens\n        v = tuple([pows[i] for i in self.element()])\n      File \"sage/misc/cachefunc.pyx\", line 2401, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/misc/cachefunc.c:12708)\n        self.cache = f(self._instance)\n      File \"/usr/lib64/python2.7/site-packages/sage/modular/dirichlet.py\", line 1730, in element\n        M = P._module\n      File \"/usr/lib64/python2.7/site-packages/sage/modular/dirichlet.py\", line 2137, in _module\n        len(self.unit_gens()))\n      File \"sage/structure/factory.pyx\", line 361, in sage.structure.factory.UniqueFactory.__call__ (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/structure/factory.c:1585)\n        key, kwds = self.create_key_and_extra_args(*args, **kwds)\n      File \"sage/structure/factory.pyx\", line 459, in sage.structure.factory.UniqueFactory.create_key_and_extra_args (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/structure/factory.c:2722)\n        return self.create_key(*args, **kwds), {}\n      File \"/usr/lib64/python2.7/site-packages/sage/modules/free_module.py\", line 336, in create_key\n        rank = int(sage.rings.integer.Integer(rank))\n    RuntimeError: maximum recursion depth exceeded while calling a Python object\n**********************************************************************\n1 item had failures:\n   2 of   6 in sage.modular.overconvergent.weightspace.AlgebraicWeight\n    [108 tests, 2 failures, 0.32 s]\n----------------------------------------------------------------------\nsage -t --long /usr/lib64/python2.7/site-packages/sage/modular/overconvergent/weightspace.py  # 2 doctests failed\n----------------------------------------------------------------------\n```\n\nThere are two of those. There is always the possibility that I missed a patch in `python` or some other place that deals with this but I don't think so.",
    "created_at": "2016-06-21T04:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199395",
    "user": "https://github.com/kiwifb"
}
```

I suspect I am getting this in sage-on-gentoo pulling volker's current develop branch because of this:

```
File "/usr/lib64/python2.7/site-packages/sage/modular/overconvergent/weightspace.py", line 473, in sage.modular.overconvergent.weightspace.AlgebraicWeight
Failed example:
    w == loads(dumps(w))
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 501, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 864, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.modular.overconvergent.weightspace.AlgebraicWeight[3]>", line 1, in <module>
        w == loads(dumps(w))
      File "sage/structure/element.pyx", line 913, in sage.structure.element.Element.__richcmp__ (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/structure/element.c:9542)
        return (<Element>self)._richcmp_(<Element>other, op)
      File "sage/structure/element.pyx", line 948, in sage.structure.element.Element._richcmp_ (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/structure/element.c:9722)
        c = left._cmp_(right)
      File "sage/structure/element.pyx", line 964, in sage.structure.element.Element._cmp_ (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/structure/element.c:10101)
        return left_cmp(right)
      File "/usr/lib64/python2.7/site-packages/sage/modular/overconvergent/weightspace.py", line 417, in __cmp__
        return cmp(self.values_on_gens(), other.values_on_gens())
      File "/usr/lib64/python2.7/site-packages/sage/modular/overconvergent/weightspace.py", line 380, in values_on_gens
        return ( self(self.parent()._param), self.teichmuller_type())
      File "/usr/lib64/python2.7/site-packages/sage/modular/overconvergent/weightspace.py", line 539, in __call__
        if self._p**(x.precision_absolute()) < self._chi.conductor():
      File "sage/misc/cachefunc.pyx", line 1717, in sage.misc.cachefunc.CachedMethodPickle.__call__ (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/misc/cachefunc.c:8703)
        return CM(*args,**kwds)
      File "sage/misc/cachefunc.pyx", line 2401, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/misc/cachefunc.c:12708)
        self.cache = f(self._instance)
      File "/usr/lib64/python2.7/site-packages/sage/modular/dirichlet.py", line 755, in conductor
        if self.modulus() == 1 or self.is_trivial():
      File "sage/misc/cachefunc.pyx", line 1717, in sage.misc.cachefunc.CachedMethodPickle.__call__ (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/misc/cachefunc.c:8703)
        return CM(*args,**kwds)
      File "sage/misc/cachefunc.pyx", line 2401, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/misc/cachefunc.c:12708)
        self.cache = f(self._instance)
```

and ending after many lines with

```
      File "sage/misc/cachefunc.pyx", line 2401, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/misc/cachefunc.c:12708)
        self.cache = f(self._instance)
      File "/usr/lib64/python2.7/site-packages/sage/modular/dirichlet.py", line 1738, in element
        v = M([dlog[x] for x in self.values_on_gens()])
      File "/usr/lib64/python2.7/site-packages/sage/modular/dirichlet.py", line 1705, in values_on_gens
        v = tuple([pows[i] for i in self.element()])
      File "sage/misc/cachefunc.pyx", line 2401, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/misc/cachefunc.c:12708)
        self.cache = f(self._instance)
      File "/usr/lib64/python2.7/site-packages/sage/modular/dirichlet.py", line 1730, in element
        M = P._module
      File "/usr/lib64/python2.7/site-packages/sage/modular/dirichlet.py", line 2137, in _module
        len(self.unit_gens()))
      File "sage/structure/factory.pyx", line 361, in sage.structure.factory.UniqueFactory.__call__ (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/structure/factory.c:1585)
        key, kwds = self.create_key_and_extra_args(*args, **kwds)
      File "sage/structure/factory.pyx", line 459, in sage.structure.factory.UniqueFactory.create_key_and_extra_args (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/structure/factory.c:2722)
        return self.create_key(*args, **kwds), {}
      File "/usr/lib64/python2.7/site-packages/sage/modules/free_module.py", line 336, in create_key
        rank = int(sage.rings.integer.Integer(rank))
    RuntimeError: maximum recursion depth exceeded while calling a Python object
**********************************************************************
1 item had failures:
   2 of   6 in sage.modular.overconvergent.weightspace.AlgebraicWeight
    [108 tests, 2 failures, 0.32 s]
----------------------------------------------------------------------
sage -t --long /usr/lib64/python2.7/site-packages/sage/modular/overconvergent/weightspace.py  # 2 doctests failed
----------------------------------------------------------------------
```

There are two of those. There is always the possibility that I missed a patch in `python` or some other place that deals with this but I don't think so.



---

archive/issue_events_015105.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-06-21T20:45:41Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15455#event-15105"
}
```



---

archive/issue_comments_199396.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-06-21T20:45:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199396",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_199397.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2016-06-21T21:44:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199397",
    "user": "https://github.com/vbraun"
}
```

Changing status from closed to new.



---

archive/issue_events_015106.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-06-21T21:44:23Z",
    "event": "reopened",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15455#event-15106"
}
```



---

archive/issue_comments_199398.json:
```json
{
    "body": "Resolution changed from fixed to ",
    "created_at": "2016-06-21T21:44:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199398",
    "user": "https://github.com/vbraun"
}
```

Resolution changed from fixed to 



---

archive/issue_comments_199399.json:
```json
{
    "body": "Indeed the two doctest failures",
    "created_at": "2016-06-21T21:44:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199399",
    "user": "https://github.com/vbraun"
}
```

Indeed the two doctest failures



---

archive/issue_comments_199400.json:
```json
{
    "body": "Actually the main failure is in `sage/modular/dirichlet.py`, the other `sage/modular/overconvergent/weightspace.py` fails because it is calling dirichlet. So one only needs to fix dirichlet.py.",
    "created_at": "2016-06-26T21:36:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199400",
    "user": "https://github.com/kiwifb"
}
```

Actually the main failure is in `sage/modular/dirichlet.py`, the other `sage/modular/overconvergent/weightspace.py` fails because it is calling dirichlet. So one only needs to fix dirichlet.py.



---

archive/issue_comments_199401.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-06-30T03:29:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199401",
    "user": "https://github.com/saraedum"
}
```

New commits:



---

archive/issue_comments_199402.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-06-30T19:38:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199402",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_199403.json:
```json
{
    "body": "The `dirichlet.py` doctests pass now. Let's see what the patchbot thinks about  the rest.",
    "created_at": "2016-06-30T20:00:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199403",
    "user": "https://github.com/saraedum"
}
```

The `dirichlet.py` doctests pass now. Let's see what the patchbot thinks about  the rest.



---

archive/issue_comments_199404.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-06-30T20:00:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199404",
    "user": "https://github.com/saraedum"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_199405.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-07-01T09:27:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199405",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_199406.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-07-07T01:26:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199406",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_199407.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-07-07T01:27:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199407",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_199408.json:
```json
{
    "body": "Looks like your last commit needs a tiny little bit more work\n\n```\nsage -t --long src/sage/modular/dirichlet.py\n**********************************************************************\nFile \"src/sage/modular/dirichlet.py\", line 1760, in sage.modular.dirichlet.DirichletCharacter.__setstate__\nFailed example:\n    loads(dumps(e)) == e\nExpected nothing\nGot:\n    True\n```\n\nFrom the bot.",
    "created_at": "2016-07-07T21:47:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199408",
    "user": "https://github.com/kiwifb"
}
```

Looks like your last commit needs a tiny little bit more work

```
sage -t --long src/sage/modular/dirichlet.py
**********************************************************************
File "src/sage/modular/dirichlet.py", line 1760, in sage.modular.dirichlet.DirichletCharacter.__setstate__
Failed example:
    loads(dumps(e)) == e
Expected nothing
Got:
    True
```

From the bot.



---

archive/issue_comments_199409.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-07-07T21:47:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199409",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_199410.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-07-08T04:53:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199410",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_199411.json:
```json
{
    "body": "Sorry, that was dumb. I hope it's better now :)\n----\nNew commits:",
    "created_at": "2016-07-08T04:54:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199411",
    "user": "https://github.com/saraedum"
}
```

Sorry, that was dumb. I hope it's better now :)
----
New commits:



---

archive/issue_comments_199412.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-07-08T04:54:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199412",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_199413.json:
```json
{
    "body": "Bot happy, I am putting this back to positive.",
    "created_at": "2016-07-09T05:16:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199413",
    "user": "https://github.com/kiwifb"
}
```

Bot happy, I am putting this back to positive.



---

archive/issue_comments_199414.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-07-09T05:16:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199414",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_199415.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-07-09T16:29:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15455#issuecomment-199415",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_015107.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-07-09T16:29:27Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/15455",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15455#event-15107"
}
```
