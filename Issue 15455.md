# Issue 15455: Value of cached methods should not always be pickled

Issue created by migration from https://trac.sagemath.org/ticket/15692

Original creator: SimonKing

Original creation time: 2014-01-18 09:30:18

CC:  ncohen vbraun nbruin novoselt jkeitel nthiery

Keywords: pickling hash cache

In #15278, the hash of graphs was turned into a ``@`cached_method`. If a cached method is pickled, then the cached value is pickled as well. In the case of a hash value, this is not always what we want, since the hash value might depend on the memory address of an object, or worse: The hash function might change in future implementations.

That's to say: If you save object O now, together with hash value 123, and later load it, then hash(O) will still be 123, even if a newly constructed object P with O==P might have hash(P)==456, because of a change in the hash function.

This obviously is a problem. There is something called `sage.misc.cachefunc.ClearCacheOnPickle`, but I don't know if this would really help in this case. Also, this would clear _all_ cache values at once. Also, I don't know if it works for cached methods that do not take arguments (beside `self`).

I suggest that we should instead have an optional parameter for `sage.misc.cachefunc.CachedMethodCallerNoArgs` that determines whether or not the cached value is preserved, and use it on graphs (and future applications of cached method on `__hash__`).


---

Comment by saraedum created at 2014-05-12 10:01:10

In #15149 it was proposed that caches should be 'opt-in and not opt-out' (comment:6:ticket:15149). Imho most caches are not used for things that are horribly expensive to compute, they are just too expensive to be computed again all the time.

Would somebody mind if I implemented it that way, i.e., the default for a cache would be that it is not pickled?


---

Comment by saraedum created at 2014-05-12 17:44:07

Changing status from new to needs_review.


---

Comment by novoselt created at 2014-05-12 22:30:08

I'm in support of this although I am not the right person to review the changes.
----
New commits:


---

Comment by git created at 2014-07-23 16:41:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2015-08-04 12:56:38

does not apply, needs rebase


---

Comment by chapoton created at 2015-08-04 12:56:38

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-08-08 18:56:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2015-08-08 18:59:33

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2015-08-09 08:31:57

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2015-08-09 08:31:57

one failing doctest, see patchbot report


---

Comment by git created at 2015-08-12 18:49:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2015-08-12 18:50:08

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-08-15 11:09:17

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2015-08-15 11:09:17

Hello,


In `_cached_function_unpickle` instead of 

```
for k,v in cache:
    ret.cache[k] = v
```

you can simply do `ret.cache.update(cache)`. Moreover, in that function you should document the argument `cache`.

I think that disabling the cache by default on pickle is a good improvement. However, the class `ClearCacheOnPickle` that you remove in your branch had several purposes: clear the cache on pickle but also on copy. Your version keep the cache on copy and that might not be appropriate for classes that used `ClearCacheOnPickle`.

Vincent


---

Comment by git created at 2015-08-18 18:41:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2015-08-18 18:46:07

Replying to [comment:16 vdelecroix]:
> I think that disabling the cache by default on pickle is a good improvement. However, the class `ClearCacheOnPickle` that you remove in your branch had several purposes: clear the cache on pickle but also on copy. Your version keep the cache on copy and that might not be appropriate for classes that used `ClearCacheOnPickle`.
Thanks for pointing this out. What should we do about this? Should caches ever be copied actually?


---

Comment by saraedum created at 2015-08-18 18:46:14

Changing status from needs_work to needs_info.


---

Comment by vdelecroix created at 2015-08-18 21:49:40

Replying to [comment:19 saraedum]:
> Replying to [comment:16 vdelecroix]:
> > I think that disabling the cache by default on pickle is a good improvement. However, the class `ClearCacheOnPickle` that you remove in your branch had several purposes: clear the cache on pickle but also on copy. Your version keep the cache on copy and that might not be appropriate for classes that used `ClearCacheOnPickle`.
> Thanks for pointing this out. What should we do about this? Should caches ever be copied actually?

I guess not. And if you really want to, it is always possible to fill the cache manually.


---

Comment by saraedum created at 2015-08-24 02:50:02

Do you have any idea how I could implement that? I could for example implement `__getstate__` for sage parents and elements, but then whenever it is overwritten I would have to rely on the super implementation being called. I could also implement `__copy__` there which is muss less likely to be overwritten but still the problem is the same.
The problem is that unlike with pickling, `__getstate__` is not called on the cached methods when a shallow copy is made (only for a deep copy.)
One thing I could think of is putting the `id` of the original object into each of its caches. Any call to the cache could check that id (which could be a small but significant performance loss) and complain if it does not match the element the cache is associated to.

I think that implementing `__copy__` is probably the best path to take.


---

Comment by nbruin created at 2015-08-24 18:32:03

Replying to [comment:22 saraedum]:
> Do you have any idea how I could implement that? I could for example implement `__getstate__` for sage parents and elements, but then whenever it is overwritten I would have to rely on the super implementation being called.

(I'm pretty sure that `__getstate__` should call its super unless one really knows what one is doing. A bigger problem is that `__getstate__` is only a convention that the standard `__reduce__` uses. I'm sure there are classes that implement their own `__reduce__` far below the point where you'd be thinking of injecting your `__getstate__`)

On #15207 there is some discussion of some possible infrastructure for managing these things. Perhaps it's relevant for your case?

>I could also implement `__copy__` there which is muss less likely to be overwritten but still the problem is the same.

I would recommend leaving `__copy__` out of it. That has nothing to do with the pickling/serialization protocol. It provides a "cheap" way of replicating a mutable structure (note that for immutable structures, `__copy__` routinely returns `self`, because immutability implies) so that mutations of one do not affect the other.

Mutable structures need to take care that they invalidate caches already (when mutated). I would say that a default behaviour where `copy` creates a new object with the same caches would be appropriate. The default behaviour of "copy" is to copy the instance dict, which largely establishes this.

If this is not appropriate behaviour, it seems to me that the class has rather special needs and hence should provide its own `__copy__`.

*EDIT:* I see that `ClearCacheOnPickle` gets its `copy` behaviour because under certain circumstances, `copy(...)` will revert to calling `__getstate__`. So I would expect that this would continue to be the case.  Since the "clear cache on copy" is a bit of a side-effect of the implementation of `ClearCacheOnPickle` I would try and see if just changing the copy behaviour gives acceptable results. If not then providing a custom `__copy__` on just the class that originally inherited from `ClearCacheOnPickle` would do the trick. Going forward, I think having caches replicated (or probably even shared!) between shallow copies by default doesn't seem like an unreasonable default.


---

Comment by saraedum created at 2015-08-27 00:04:10

Ok. Thanks for the input. I will implement it like that. Explicitly implement `__copy__` where it is necessary to keep the old behaviour and leave everything else like it is in my branch.


---

Comment by saraedum created at 2015-09-03 21:38:19

Trying to implement this, I realized that the point of the `ClearCacheOnPickle` on these classes was certainly not to clear *all* caches on copy.
Also, `ClearCacheOnPickle` is broken, since it replaces any cache dictionary with an actual `dict` , i.e., it would  replace a weak dictionary with a regular one.)

I guess there was in each case some cached method which should not be pickled (or probably copied.)
So it is probably better to look at the actual occurences and fix the copying there instead of just hacking a "drop some caches" `__copy__` method which probably does too much and might even break if we change the cached methods next time around.

The classes which carry `ClearCacheOnPickle` are:
* `ToricVariety_field` where it was added in `0be2c23d` with the comment "Do not pickle caches of toric varieties". So it could be alright if we still copied them.
* `WeilGroup_gens` where it was added when the class did not provide the functionality to clear caches on copy. So it might be alright to copy them.
* `AmbientSpace` and `RootSpace` where it is not clear why it was added exactly. Maybe Nicolas could clarify this (author of the commit which added it.)

Btw. the lengthy discussion in #11115 (this is where the clear caches on copy was introduced) does not make any mention of "copy".


---

Comment by saraedum created at 2015-09-29 19:39:09

Since there has been no reaction for quite a while, I'm setting this back to needs review. I think my current implementation does the right thing.


---

Comment by saraedum created at 2015-09-29 19:39:09

Changing status from needs_info to needs_review.


---

Comment by vdelecroix created at 2015-10-02 01:41:47

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2015-10-02 01:41:47

From the patchbot

```
sage -t --long src/sage/misc/cachefunc.pyx
**********************************************************************
File "src/sage/misc/cachefunc.pyx", line 3185, in sage.misc.cachefunc.cached_method
Failed example:
    id(d) == hash(d)
Expected:
    True
Got:
    False
**********************************************************************
1 item had failures:
   1 of  30 in sage.misc.cachefunc.cached_method
    [830 tests, 1 failure, 15.75 s]
----------------------------------------------------------------------
sage -t --long src/sage/misc/cachefunc.pyx  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by saraedum created at 2015-10-04 21:49:38

That test does not fail for me. It is reported to be fine by another patchbot. Maybe the patchbot that ran it is broken somehow? I can not really imagine that something "random" is happening here.


---

Comment by saraedum created at 2015-10-04 21:49:38

Changing status from needs_work to needs_review.


---

Comment by git created at 2015-12-23 18:27:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-12-23 19:35:54

What's the use case for `pickle=True`? I would say that a cache should _never_ be pickled.


---

Comment by novoselt created at 2015-12-25 04:51:38

Replying to [comment:30 jdemeyer]:
> What's the use case for `pickle=True`? I would say that a cache should _never_ be pickled.

If something in cache is expensive to compute and you want to dump your object so that later you can load it with cache full. I use it regularly for my personal classes and some time ago it was also used for lists of reflexive polytopes (to store points and faces that were taking many seconds to recompute). One may argue whether it is the best way philosophically or not, but it is easy and it works, so it is nice to have this possibility available.


---

Comment by jdemeyer created at 2015-12-25 12:51:27

Replying to [comment:31 novoselt]:
> If something in cache is expensive to compute and you want to dump your object so that later you can load it with cache full. I use it regularly for my personal classes and some time ago it was also used for lists of reflexive polytopes (to store points and faces that were taking many seconds to recompute). One may argue whether it is the best way philosophically or not, but it is easy and it works, so it is nice to have this possibility available.

That seems like an argument for making `pickle=True` the default.

Something else: couldn't this be implemented more easily by a new class instead of adding `pickle` arguments everywhere?


---

Comment by jdemeyer created at 2015-12-25 12:55:39

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-12-25 12:55:39

One easy simplification: make `CacheDict` never pickle its contents and just choose the type `dict` or `CacheDict`.


---

Comment by jdemeyer created at 2015-12-25 12:57:10

One easy simplification: make `CacheDict` never pickle its contents and just choose the type `dict` or `CacheDict`.


---

Comment by jdemeyer created at 2015-12-25 12:57:33

This is not grammatically correct:

```
Per default, the contents of the cache are not pickle::
```



---

Comment by jdemeyer created at 2015-12-25 13:01:14

Can you replace the `pickle` keyword and attribute to `do_pickle` since that more accurately describes the intention.

Also, please explain the reason for changing both the pickling/unpickling of the cached function themselves as well as the `CacheDict`. It seems that they both solve your problem and I don't see why this problem needs to be solved twice.


---

Comment by git created at 2016-03-20 21:16:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-03-20 22:28:26

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-03-20 22:29:05

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by saraedum created at 2016-03-20 22:33:45

Replying to [comment:36 jdemeyer]:
> Can you replace the `pickle` keyword and attribute to `do_pickle` since that more accurately describes the intention.
Fixed.
> Also, please explain the reason for changing both the pickling/unpickling of the cached function themselves as well as the `CacheDict`. It seems that they both solve your problem and I don't see why this problem needs to be solved twice.
You are right. I did look at the (do_)pickle parameter in too many places.


---

Comment by saraedum created at 2016-03-21 11:40:37

Changing status from needs_work to needs_review.


---

Comment by saraedum created at 2016-03-24 02:22:26

Changing keywords from "pickling hash cache" to "pickling, hash, cache, days71".


---

Comment by git created at 2016-03-24 02:59:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2016-03-24 03:10:02

Looks good to me.


---

Comment by roed created at 2016-03-24 03:10:02

Changing status from needs_review to positive_review.


---

Comment by aly.deines created at 2016-03-24 09:36:04

I'm not going to change this from positive review, but I found the tiniest doctest typo:

```
+        Per default, the contents of the cache are not pickle::
```

pickle should be pickled here.


---

Comment by roed created at 2016-03-24 19:47:51

I think you're looking at an old version; that typo was what was fixed in 746dc53.


---

Comment by aly.deines created at 2016-03-25 00:09:05

Awesome!


---

Comment by vbraun created at 2016-03-26 09:10:25

Fails on 32-bit:

```
sage -t --long src/sage/misc/cachefunc.pyx
**********************************************************************
File "src/sage/misc/cachefunc.pyx", line 3161, in sage.misc.cachefunc.cached_method
Failed example:
    id(d) == hash(d)
Expected:
    True
Got:
    False
**********************************************************************
1 item had failures:
   1 of  30 in sage.misc.cachefunc.cached_method
    [843 tests, 1 failure, 8.96 s]
```



---

Comment by vbraun created at 2016-03-26 09:10:25

Changing status from positive_review to needs_work.


---

Comment by git created at 2016-06-20 17:10:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2016-06-20 17:11:54

Changing status from needs_work to positive_review.


---

Comment by saraedum created at 2016-06-20 17:12:17

Since this is such a minor change, I set this back to positive review.


---

Comment by fbissey created at 2016-06-21 04:17:38

I suspect I am getting this in sage-on-gentoo pulling volker's current develop branch because of this:

```
File "/usr/lib64/python2.7/site-packages/sage/modular/overconvergent/weightspace.py", line 473, in sage.modular.overconvergent.weightspace.AlgebraicWeight
Failed example:
    w == loads(dumps(w))
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 501, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 864, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.modular.overconvergent.weightspace.AlgebraicWeight[3]>", line 1, in <module>
        w == loads(dumps(w))
      File "sage/structure/element.pyx", line 913, in sage.structure.element.Element.__richcmp__ (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/structure/element.c:9542)
        return (<Element>self)._richcmp_(<Element>other, op)
      File "sage/structure/element.pyx", line 948, in sage.structure.element.Element._richcmp_ (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/structure/element.c:9722)
        c = left._cmp_(right)
      File "sage/structure/element.pyx", line 964, in sage.structure.element.Element._cmp_ (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/structure/element.c:10101)
        return left_cmp(right)
      File "/usr/lib64/python2.7/site-packages/sage/modular/overconvergent/weightspace.py", line 417, in __cmp__
        return cmp(self.values_on_gens(), other.values_on_gens())
      File "/usr/lib64/python2.7/site-packages/sage/modular/overconvergent/weightspace.py", line 380, in values_on_gens
        return ( self(self.parent()._param), self.teichmuller_type())
      File "/usr/lib64/python2.7/site-packages/sage/modular/overconvergent/weightspace.py", line 539, in __call__
        if self._p**(x.precision_absolute()) < self._chi.conductor():
      File "sage/misc/cachefunc.pyx", line 1717, in sage.misc.cachefunc.CachedMethodPickle.__call__ (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/misc/cachefunc.c:8703)
        return CM(*args,**kwds)
      File "sage/misc/cachefunc.pyx", line 2401, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/misc/cachefunc.c:12708)
        self.cache = f(self._instance)
      File "/usr/lib64/python2.7/site-packages/sage/modular/dirichlet.py", line 755, in conductor
        if self.modulus() == 1 or self.is_trivial():
      File "sage/misc/cachefunc.pyx", line 1717, in sage.misc.cachefunc.CachedMethodPickle.__call__ (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/misc/cachefunc.c:8703)
        return CM(*args,**kwds)
      File "sage/misc/cachefunc.pyx", line 2401, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/misc/cachefunc.c:12708)
        self.cache = f(self._instance)
```

and ending after many lines with

```
      File "sage/misc/cachefunc.pyx", line 2401, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/misc/cachefunc.c:12708)
        self.cache = f(self._instance)
      File "/usr/lib64/python2.7/site-packages/sage/modular/dirichlet.py", line 1738, in element
        v = M([dlog[x] for x in self.values_on_gens()])
      File "/usr/lib64/python2.7/site-packages/sage/modular/dirichlet.py", line 1705, in values_on_gens
        v = tuple([pows[i] for i in self.element()])
      File "sage/misc/cachefunc.pyx", line 2401, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/misc/cachefunc.c:12708)
        self.cache = f(self._instance)
      File "/usr/lib64/python2.7/site-packages/sage/modular/dirichlet.py", line 1730, in element
        M = P._module
      File "/usr/lib64/python2.7/site-packages/sage/modular/dirichlet.py", line 2137, in _module
        len(self.unit_gens()))
      File "sage/structure/factory.pyx", line 361, in sage.structure.factory.UniqueFactory.__call__ (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/structure/factory.c:1585)
        key, kwds = self.create_key_and_extra_args(*args, **kwds)
      File "sage/structure/factory.pyx", line 459, in sage.structure.factory.UniqueFactory.create_key_and_extra_args (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/structure/factory.c:2722)
        return self.create_key(*args, **kwds), {}
      File "/usr/lib64/python2.7/site-packages/sage/modules/free_module.py", line 336, in create_key
        rank = int(sage.rings.integer.Integer(rank))
    RuntimeError: maximum recursion depth exceeded while calling a Python object
**********************************************************************
1 item had failures:
   2 of   6 in sage.modular.overconvergent.weightspace.AlgebraicWeight
    [108 tests, 2 failures, 0.32 s]
----------------------------------------------------------------------
sage -t --long /usr/lib64/python2.7/site-packages/sage/modular/overconvergent/weightspace.py  # 2 doctests failed
----------------------------------------------------------------------
```

There are two of those. There is always the possibility that I missed a patch in `python` or some other place that deals with this but I don't think so.


---

Comment by vbraun created at 2016-06-21 20:45:41

Resolution: fixed


---

Comment by vbraun created at 2016-06-21 21:44:23

Changing status from closed to new.


---

Comment by vbraun created at 2016-06-21 21:44:23

Resolution changed from fixed to 


---

Comment by vbraun created at 2016-06-21 21:44:45

Indeed the two doctest failures


---

Comment by fbissey created at 2016-06-26 21:36:06

Actually the main failure is in `sage/modular/dirichlet.py`, the other `sage/modular/overconvergent/weightspace.py` fails because it is calling dirichlet. So one only needs to fix dirichlet.py.


---

Comment by saraedum created at 2016-06-30 03:29:12

New commits:


---

Comment by git created at 2016-06-30 19:38:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2016-06-30 20:00:02

The `dirichlet.py` doctests pass now. Let's see what the patchbot thinks about  the rest.


---

Comment by saraedum created at 2016-06-30 20:00:02

Changing status from new to needs_review.


---

Comment by saraedum created at 2016-07-01 09:27:05

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-07-07 01:26:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2016-07-07 01:27:09

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2016-07-07 21:47:20

Looks like your last commit needs a tiny little bit more work

```
sage -t --long src/sage/modular/dirichlet.py
**********************************************************************
File "src/sage/modular/dirichlet.py", line 1760, in sage.modular.dirichlet.DirichletCharacter.__setstate__
Failed example:
    loads(dumps(e)) == e
Expected nothing
Got:
    True
```

From the bot.


---

Comment by fbissey created at 2016-07-07 21:47:20

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-07-08 04:53:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2016-07-08 04:54:04

Sorry, that was dumb. I hope it's better now :)
----
New commits:


---

Comment by saraedum created at 2016-07-08 04:54:18

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2016-07-09 05:16:31

Bot happy, I am putting this back to positive.


---

Comment by fbissey created at 2016-07-09 05:16:31

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-07-09 16:29:27

Resolution: fixed
