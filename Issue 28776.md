# Issue 28776: In a python3 build, install all Python packages into a venv

Issue created by migration from https://trac.sagemath.org/ticket/29013

Original creator: mkoeppe

Original creation time: 2020-01-14 22:26:27

CC:  dimpase jdemeyer embray vbraun jhpalmieri

We propose to create a venv (https://docs.python.org/3/library/venv.html) at `$SAGE_LOCAL/venv`, 
to activate the venv in the `sage-env` script, and to install all Python packages (including `sagelib`) into this venv.

This is preparation for #27824, in which the system's python3 will be used when available.

Note, the proposal is to use `venv` (new since Python 3.3), not `virtualenv`. So this change will be limited to Python 3 builds of Sage.


---

Comment by mkoeppe created at 2020-01-15 01:55:49

A simple change. Compiles from a fresh checkout and runs without problems on macOS.
----
New commits:


---

Comment by mkoeppe created at 2020-01-15 01:55:49

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-01-15 04:47:29

In the branch #27824, the venv is created by slightly more complicated code in `build/make/Makefile`. This complexity is not necessary for the present ticket.


---

Comment by dimpase created at 2020-01-15 10:21:32

Does this ticket make sense separately, or only as part of #27824 ?


---

Comment by mkoeppe created at 2020-01-15 14:08:42

#27824 is the use case that I have in mind.
This ticket is a less intrusive change and should go through the betas first.


---

Comment by jhpalmieri created at 2020-01-15 20:02:22

I tried building with this branch on OS X, and I got doctest failures:

```
sage -t --long src/sage/plot/plot.py  # 1 doctest failed
sage -t --long src/sage/matrix/matrix2.pyx  # 2 doctests failed
sage -t --long src/sage/finance/time_series.pyx  # 5 doctests failed
sage -t --long src/sage/misc/trace.py  # 4 doctests failed
sage -t --long src/sage/env.py  # 1 doctest failed
sage -t --long src/sage/repl/configuration.py  # 1 doctest failed
sage -t --long src/sage/schemes/affine/affine_homset.py  # 1 doctest failed
```

For example

```
File "src/sage/plot/plot.py", line 521, in sage.plot.plot
Failed example:
    os.system("sage -c \"if 'matplotlib' in sys.modules: sys.exit(1)\"") # long time
Expected:
    0
Got:
    Traceback (most recent call last):
      File "/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.1.beta0/local/bin/sage-eval", line 4, in <module>
        from sage.all import *
    ModuleNotFoundError: No module named 'sage'
    256
```

and

```
**********************************************************************
File "src/sage/matrix/matrix2.pyx", line 1127, in sage.matrix.matrix2.Matrix.pseudoinverse
Failed example:
    M.pseudoinverse()  # tol 1e-15
Expected:
    [0.0620518477661335 0.0206839492553778 0.0124103695532267]
    [ 0.124103695532267 0.0413678985107557 0.0248207391064534]
    [ 0.186155543298400 0.0620518477661335 0.0372311086596801]
Got:
    [0.0620518477661334 0.0206839492553778 0.0124103695532267]
    [ 0.124103695532267 0.0413678985107556 0.0248207391064534]
    [ 0.186155543298400 0.0620518477661335 0.0372311086596801]
Tolerance exceeded in 2 of 9:
    0.0620518477661335 vs 0.0620518477661334, tolerance 2e-15 > 1e-15
    0.0413678985107557 vs 0.0413678985107556, tolerance 3e-15 > 1e-15
**********************************************************************
File "src/sage/matrix/matrix2.pyx", line 1131, in sage.matrix.matrix2.Matrix.pseudoinverse
Failed example:
    M.pseudoinverse(algorithm="numpy")  # tol 1e-15
Expected:
    [0.0620518477661335 0.0206839492553778 0.0124103695532267]
    [ 0.124103695532267 0.0413678985107557 0.0248207391064534]
    [ 0.186155543298400 0.0620518477661335 0.0372311086596801]
Got:
    [0.0620518477661334 0.0206839492553778 0.0124103695532267]
    [ 0.124103695532267 0.0413678985107556 0.0248207391064534]
    [ 0.186155543298400 0.0620518477661335 0.0372311086596801]
Tolerance exceeded in 2 of 9:
    0.0620518477661335 vs 0.0620518477661334, tolerance 2e-15 > 1e-15
    0.0413678985107557 vs 0.0413678985107556, tolerance 3e-15 > 1e-15
**********************************************************************
1 item had failures:
   2 of  25 in sage.matrix.matrix2.Matrix.pseudoinverse
    [2472 tests, 2 failures, 9.06 s]
```



---

Comment by mkoeppe created at 2020-01-15 21:25:23

Thanks for testing!


---

Comment by mkoeppe created at 2020-01-15 22:54:09

Replying to [comment:8 jhpalmieri]:
> sage -t --long src/sage/matrix/matrix2.pyx  # 2 doctests failed

Not sure what's causing the numerical failures.

> sage -t --long src/sage/env.py  # 1 doctest failed

For this one, I have created #29022.


---

Comment by git created at 2020-01-15 22:56:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-01-15 23:37:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-01-15 23:39:51

Replying to [comment:10 mkoeppe]:
> > sage -t --long src/sage/env.py  # 1 doctest failed
> 
> For this one, I have created #29022.

Fixed.


---

Comment by mkoeppe created at 2020-01-16 02:21:36

The numerical problems seems to happen because numpy does not find BLAS.


---

Comment by mkoeppe created at 2020-01-16 02:37:35

Actually, it does not find openblas or atlas, but it does find the "Accelerate framework":

```
accelerate_info:
  FOUND:
    extra_compile_args = ['-msse3', '-I/System/Library/Frameworks/vecLib.framework/Headers']
    extra_link_args = ['-Wl,-framework', '-Wl,Accelerate']
    define_macros = [('NO_ATLAS_INFO', 3), ('HAVE_CBLAS', None)]

  FOUND:
    extra_compile_args = ['-msse3', '-I/System/Library/Frameworks/vecLib.framework/Headers']
    extra_link_args = ['-Wl,-framework', '-Wl,Accelerate']
    define_macros = [('NO_ATLAS_INFO', 3), ('HAVE_CBLAS', None)]
```



---

Comment by git created at 2020-01-16 03:04:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-01-16 03:05:05

Merged #29025, fixes the numerical doctests.


---

Comment by dimpase created at 2020-01-16 09:29:55

I see a problem with cryptominisat spkg on this branch (which otherwise builds and passes most tests (not related to this packages) on Gentoo)

```
sage -t --warn-long 88.1 src/sage/sat/solvers/cryptominisat.py
**********************************************************************
File "src/sage/sat/solvers/cryptominisat.py", line 49, in sage.sat.solvers.cryptominisat.CryptoMiniSat
Failed example:
    solver = CryptoMiniSat()                                  # optional - cryptominisat
Exception raised:
    Traceback (most recent call last):
      File "/mnt/opt/Sage/sage-dev/local/lib/sage/venv/sage/lib/python3.7/site-packages/sage/sat/solvers/cryptominisat.py", line 69, in __init__
        from pycryptosat import Solver
    ModuleNotFoundError: No module named 'pycryptosat'
```

I wonder whether it uses a convoluted way to create python extensions, which got broken.


---

Comment by dimpase created at 2020-01-16 09:32:32

oops, comment:18 belongs to #27824


---

Comment by embray created at 2020-01-16 11:46:25

Minor bikeshed, but why the long path "lib/sage/venv/sage"?  What about something like just "lib/sage-X.Y"; analogously to "lib/python-X.Y"?  We've never had a "lib/sage" before in the first place, so I don't see any immediate need to make the path so much more complicated.


---

Comment by mkoeppe created at 2020-01-16 14:25:46

Replying to [comment:20 embray]:
> Minor bikeshed, but why the long path "lib/sage/venv/sage"?  What about something like just "lib/sage-X.Y"; analogously to "lib/python-X.Y"?  We've never had a "lib/sage" before in the first place, so I don't see any immediate need to make the path so much more complicated.

1) "venv" has to be in the path to indicate that it's a venv in the technical sense and not a random place with invitation to install stuff in it.

2) Definitely no versioning.

3) I suppose I could drop the final "sage", making it `lib/sage/venv`


---

Comment by mkoeppe created at 2020-01-16 14:32:11

Replying to [comment:18 dimpase]:
> I see a problem with cryptominisat spkg on this branch (which otherwise builds and passes most tests (not related to this packages) on Gentoo)
> {{{
> sage -t --warn-long 88.1 src/sage/sat/solvers/cryptominisat.py
> **********************************************************************
> File "src/sage/sat/solvers/cryptominisat.py", line 49, in sage.sat.solvers.cryptominisat.CryptoMiniSat
> Failed example:
>     solver = CryptoMiniSat()                                  # optional - cryptominisat
> Exception raised:
>     Traceback (most recent call last):
>       File "/mnt/opt/Sage/sage-dev/local/lib/sage/venv/sage/lib/python3.7/site-packages/sage/sat/solvers/cryptominisat.py", line 69, in __init__
>         from pycryptosat import Solver
>     ModuleNotFoundError: No module named 'pycryptosat'
> }}}
> I wonder whether it uses a convoluted way to create python extensions, which got broken.

Upstream merged pull request https://github.com/msoos/cryptominisat/pull/551
to take care of a `virtualenv` installation.


---

Comment by mkoeppe created at 2020-01-16 14:35:16

I haven't tested whether this patch helps for our `venv`. The patch is not in the current release 5.6.8 (which we have).


---

Comment by git created at 2020-01-16 14:47:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-01-16 14:48:13

Try with this patch please. I can't compile cryptominisat because of an unrelated reason.


---

Comment by dimpase created at 2020-01-16 15:16:55

patch landed into a wrong place, it should be one level down, in patches/

testing now, after correction of this.


---

Comment by mkoeppe created at 2020-01-16 15:31:29

Sorry, thanks.


---

Comment by git created at 2020-01-16 16:15:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-01-16 16:16:07

the patch worked, it's all good with tests now.


---

Comment by mkoeppe created at 2020-01-16 16:27:45

Thank you!


---

Comment by embray created at 2020-01-16 16:54:37

I might have missed some discussion elsewhere, but I still don't see the advantage of this extra complication over having the sage environment just extend `sys.path` where necessary.  I say this as a big fan of virtualenvs in general, and having suggested doing something like this in the past.  But the more I think about it the less I see any advantage in this case over having an additional `sys.path` entry.


---

Comment by mkoeppe created at 2020-01-16 17:01:59

Replying to [comment:31 embray]:
> I say this as a big fan of virtualenvs in general, and having suggested doing something like this in the past.  
Yes, of course this ticket was inspired by various insights and discussions shared by you and others on trac tickets. 

> But the more I think about it the less I see any advantage in this case over having an additional `sys.path` entry.
Previously, with our python2 build, there was no clear way to do it. But now with python 3 there is a standard and clean tool: that's venv. Installing into it is supported by standard tools.


---

Comment by embray created at 2020-01-16 17:02:28

Or, at the very least, what I've suggested in the past was to make `$SAGE_LOCAL` itself a virtualenv, as virtualenvs already have a sort-of root filesystem, including among other things `lib/pythonX.Y/site-packages`.

With this approach, there will now be (depending whether or not the system Python is used) both:

* `SAGE_LOCAL/lib/python3.7/site-packages`
* `SAGE_LOCAL/lib/sage/venv/sage/lib/python3.7/site-packages`

If `SAGE_LOCAL` itself (if it exists) were a virtualenv already that would simplify matters greatly.


---

Comment by mkoeppe created at 2020-01-16 17:18:17

Replying to [comment:33 embray]:
> Or, at the very least, what I've suggested in the past was to make `$SAGE_LOCAL` itself a virtualenv, as virtualenvs already have a sort-of root filesystem, including among other things `lib/pythonX.Y/site-packages`.

No, the present ticket explicitly avoids that.
The reason is that `venv` has no documented mechanism for adding non-Python stuff to it, in particular to its activation scripts.


---

Comment by mkoeppe created at 2020-01-16 17:20:41

Replying to [comment:33 embray]:
> With this approach, there will now be (depending whether or not the system Python is used) both:
> 
> * `SAGE_LOCAL/lib/python3.7/site-packages`
> * `SAGE_LOCAL/lib/sage/venv/sage/lib/python3.7/site-packages`

That's correct.
In a fresh install, the first one will be empty.

In an install upgraded from earlier versions, there will be packages in both.
When there's an update, the old version if removed from the first one and the new version is added to the second one.


---

Comment by embray created at 2020-01-16 17:52:56

Replying to [comment:34 mkoeppe]:
> Replying to [comment:33 embray]:
> > Or, at the very least, what I've suggested in the past was to make `$SAGE_LOCAL` itself a virtualenv, as virtualenvs already have a sort-of root filesystem, including among other things `lib/pythonX.Y/site-packages`.
> 
> No, the present ticket explicitly avoids that.
> The reason is that `venv` has no documented mechanism for adding non-Python stuff to it, in particular to its activation scripts.

There's no reason you can't--I've often install C libraries into a virtualenv by setting the path to it in `./configure --prefix`.


---

Comment by embray created at 2020-01-16 17:56:48

I really hate to be a pain in the ass because I know you put a lot of work into this, but I really don't get it...  It really seems complicated and messy to both activate the Sage environment, and then within that activate a virtualenv.  I don't think that's what I ever had in mind when I suggested using a virtualenv for Sage (or if I did, I take it back...)

I'd still like to know what problem this is solving.  You say that it's required for #27824, but why?  What specific problems related to #27824 is it solving?  Because most likely there's another way.


---

Comment by dimpase created at 2020-01-16 18:23:11

Well, the separation of #29013 and #27824 is artificial, but otherwise, they do the job.
venv removes an extra complication of sagelib being very far from pip-installable.


---

Comment by mkoeppe created at 2020-01-16 18:34:43

Replying to [comment:37 embray]:
>  I don't think that's what I ever had in mind when I suggested using a virtualenv for Sage

Don't worry. I'm prepared to take full credit for this specific version of the idea, if necessary.


---

Comment by embray created at 2020-01-17 14:18:03

Replying to [comment:38 dimpase]:
> Well, the separation of #29013 and #27824 is artificial, but otherwise, they do the job.
> venv removes an extra complication of sagelib being very far from pip-installable.

How?  Why?  There's really nothing that magical about virtualenvs.  It's just an alternate install prefix plus (as of Python 3 and the venv module) some small support bits in the interpreter to report a different `sys.prefix`, etc.


---

Comment by mkoeppe created at 2020-01-17 14:25:36

Replying to [comment:40 embray]:
> Replying to [comment:38 dimpase]:
> > Well, the separation of #29013 and #27824 is artificial, but otherwise, they do the job.
> > venv removes an extra complication of sagelib being very far from pip-installable.
> 
> How?  Why?  There's really nothing that magical about virtualenvs.  It's just an alternate install prefix plus (as of Python 3 and the venv module) some small support bits in the interpreter to report a different `sys.prefix`, etc.
Part of the magic is to use the standard instead of project-specific tricks.


---

Comment by embray created at 2020-01-17 14:52:23

Replying to [comment:41 mkoeppe]:
> Replying to [comment:40 embray]:
> > Replying to [comment:38 dimpase]:
> > > Well, the separation of #29013 and #27824 is artificial, but otherwise, they do the job.
> > > venv removes an extra complication of sagelib being very far from pip-installable.
> > 
> > How?  Why?  There's really nothing that magical about virtualenvs.  It's just an alternate install prefix plus (as of Python 3 and the venv module) some small support bits in the interpreter to report a different `sys.prefix`, etc.
> Part of the magic is to use the standard instead of project-specific tricks.

What "tricks" are you avoiding?


---

Comment by git created at 2020-01-17 21:39:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-01-17 21:41:27

Replying to [comment:21 mkoeppe]:
> Replying to [comment:20 embray]:
> > Minor bikeshed, but why the long path "lib/sage/venv/sage"?  ....
> 
> 3) I suppose I could drop the final "sage", making it `lib/sage/venv`

Done.


---

Comment by mkoeppe created at 2020-01-17 21:43:19

I've also merged in a few changes from #29032 (Erik's version of python spkg-configure / venv), and the current #29022.


---

Comment by git created at 2020-01-17 22:08:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-01-19 19:50:37

Changing status from needs_review to needs_work.


---

Comment by embray created at 2020-01-31 11:51:28

I would be interested in your comments on #29032.  By making `$SAGE_LOCAL` itself into a virtualenv--which it already essentially is in all other respects--no other weird hacks are needed.

Other than some things like the OSX fixes I don't see what this solves that my branch doesn't.


---

Comment by git created at 2020-03-17 23:57:26

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-10-04 22:19:00

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2020-10-04 22:19:46

Replaced the branch


---

Comment by git created at 2020-10-05 01:31:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-10-05 01:43:27

When `sage-env-config` is sourced, it overrides `PYTHON_FOR_VENV`.
This will be addressed in #30724.


---

Comment by git created at 2020-10-05 02:32:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-10-05 05:13:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-10-05 23:55:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Changing keywords from "" to "sd111".


---

Comment by git created at 2021-02-26 02:04:59

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2021-02-26 06:33:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-26 06:45:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-26 17:43:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-03 20:09:12

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-04-03 20:50:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-04-03 20:50:25

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-04-04 00:14:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-05 18:26:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2021-04-05 23:58:56

With `./configure --with-python=/usr/bin/python3 --with-sage-venv="`pwd`/local/var/lib/sage/venv/python3.8"`, I'm getting some doctest failures:

```
sage -t --long --warn-long 101.2 --random-seed=0 src/sage/misc/package.py  # 5 doctests failed
```

(because it doesn't find some Python packages). Also

```
sage -t --long --warn-long 101.2 --random-seed=0 src/sage_setup/find.py  # 2 doctests failed
sage -t --long --warn-long 101.2 --random-seed=0 src/sage_setup/clean.py  # 1 doctest failed
```

Details:

```
File "src/sage_setup/find.py", line 365, in sage_setup.find.installed_files_by_module
Failed example:
    f1
Expected:
    'sage/structure/__init__.py'
Got:
    '/Users/palmieri/Library/Caches/com.apple.python/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc1/local/var/lib/sage/venv/python3.8/lib/python3.8/site-packages/sage/structure/__init__.cpython-38.pyc'
**********************************************************************
File "src/sage_setup/find.py", line 367, in sage_setup.find.installed_files_by_module
Failed example:
    f2
Expected:
    'sage/structure/....pyc'
Got:
    'sage/structure/__init__.py'
**********************************************************************
File "src/sage_setup/clean.py", line 96, in sage_setup.clean._find_stale_files
Failed example:
    for f in stale_iter:
        if f.endswith(skip_extensions): continue
        if '/ext_data/' in f: continue
        print('Found stale file: ' + f)
Expected nothing
Got:
    Found stale file: /Users/palmieri/Library/Caches/com.apple.python/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc1/local/var/lib/sage/venv/python3.8/lib/python3.8/site-packages/sage/all_cmdline.cpython-38.pyc
...
[followed by many many lines of "stale" files]
```



---

Comment by mkoeppe created at 2021-04-06 00:04:08

The ones in `find` and `clean` are I think #31314.

For the failure in `package` I know what to do


---

Comment by mkoeppe created at 2021-04-06 00:04:08

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-04-06 03:11:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-04-06 04:22:37

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2021-04-06 21:13:46

The sage_setup doctest failures have vanished, but I am seeing different problems with `misc/package.py`:

```
**********************************************************************
File "src/sage/misc/package.py", line 554, in sage.misc.package.package_manifest
Failed example:
    sagetex_manifest = package_manifest('sagetex')  # optional - build
Exception raised:
    Traceback (most recent call last):
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc1/local/var/lib/sage/venv/python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc1/local/var/lib/sage/venv/python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.package.package_manifest[1]>", line 1, in <module>
        sagetex_manifest = package_manifest('sagetex')  # optional - build
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc1/local/var/lib/sage/venv/python3.9/lib/python3.9/site-packages/sage/misc/package.py", line 570, in package_manifest
        with open(stamp_file) as f:
    FileNotFoundError: [Errno 2] No such file or directory: '/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc1/local/var/lib/sage/installed/sagetex-3.5'
**********************************************************************
File "src/sage/misc/package.py", line 555, in sage.misc.package.package_manifest
Failed example:
    sagetex_manifest['package_name'] == 'sagetex'  # optional - build
Exception raised:
    Traceback (most recent call last):
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc1/local/var/lib/sage/venv/python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc1/local/var/lib/sage/venv/python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.package.package_manifest[2]>", line 1, in <module>
        sagetex_manifest['package_name'] == 'sagetex'  # optional - build
    NameError: name 'sagetex_manifest' is not defined
**********************************************************************
File "src/sage/misc/package.py", line 557, in sage.misc.package.package_manifest
Failed example:
    'files' in sagetex_manifest  # optional - build
Exception raised:
    Traceback (most recent call last):
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc1/local/var/lib/sage/venv/python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.rc1/local/var/lib/sage/venv/python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.package.package_manifest[3]>", line 1, in <module>
        'files' in sagetex_manifest  # optional - build
    NameError: name 'sagetex_manifest' is not defined
**********************************************************************
```

I guess the issue is that manifests are now written to two different places, depending on whether it's a Python package or not.


---

Comment by jhpalmieri created at 2021-04-06 21:13:46

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-04-06 21:17:30

Right, I forgot about this function. It will need a slightly generalized interface


---

Comment by git created at 2021-04-07 00:19:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-04-07 00:27:15

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2021-04-07 21:10:22

That fixes the `package.py` doctest for me, thank you. I'm not sure I fully understand how venvs are supposed to work. If I do `./configure --with-sage-venv=... && make` and then separately do `./configure && make`, I should get two builds (as far as Python packages are concerned), which I could conceivably switch between, right? Now if I do `./configure && make pysingular`, then I can do `import PySingular`, but I switch to the other venv, I won't be able to. However, `'pysingular' in installed_packages()` returns `True` regardless of whether I'm using the venv, since it searches both installation directories.

(a) Am I understanding the situation correctly? and

(b) is it worth trying to fix?


---

Comment by mkoeppe created at 2021-04-07 22:21:44

Replying to [comment:104 jhpalmieri]:
> I'm not sure I fully understand how venvs are supposed to work. If I do `./configure --with-sage-venv=... && make` and then separately do `./configure && make`, I should get two builds (as far as Python packages are concerned), which I could conceivably switch between, right?

Yes, that's right. Separate for Python packages, sharing the non-Python packages, which are only in SAGE_LOCAL.

> Now if I do `./configure && make pysingular`, then I can do `import PySingular`, but I switch to the other venv, I won't be able to. However, `'pysingular' in installed_packages()` returns `True` regardless of whether I'm using the venv, since it searches both installation directories.

OK, thanks for catching this. Yes, the `sage.misc.package` code does not handle this situation correctly. I would simply suggest to not mix builds that use with `--with-sage-venv=...` with builds that don't. You can switch between several venvs in this way.


---

Comment by jhpalmieri created at 2021-04-07 23:59:23

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2021-04-07 23:59:23

Great, let's merge it, then.


---

Comment by mkoeppe created at 2021-04-08 00:01:02

Thank you!


---

Comment by vbraun created at 2021-05-27 20:30:21

Resolution: fixed
