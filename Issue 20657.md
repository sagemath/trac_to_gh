# Issue 20657: Sage package for Perl 5 readline library

Issue created by migration from Trac.

Original creator: mkoeppe

Original creation time: 2016-06-27 21:24:03

CC:  vdelecroix vbraun embray jdemeyer dimpase kcrisman tscrim

This is a prerequisite for building Polymake (#20892) on Mac OS X.

http://search.cpan.org/~hayashi/Term-ReadLine-Gnu-1.34/


---

Comment by mkoeppe created at 2016-06-27 22:17:18

Not sure if this installation should be done using CPAN scripts instead.
----
New commits:


---

Comment by mkoeppe created at 2016-06-27 22:17:18

Changing status from new to needs_review.


---

Comment by kcrisman created at 2016-06-28 01:07:45

This always was a big part of the struggle for me in getting this to work on Mac.   Hopefully it can be portable to pre-10.11 as well but at least if it is working on _some_ OS X it will be a huge improvement - I regularly see papers citing polymake or latte which could be using Sage to interface better with them and other stuff.


---

Comment by kcrisman created at 2016-06-28 03:33:00

There is a problem in the way we do things now with experimental packages.  Here is what I saw:

```
make[1]: warning: -jN forced in submake: disabling jobserver mode.
sage-logger -p 'sage-spkg  perl_term_readline_gnu-1.34' '/Users/karl.crisman/Downloads/sage/logs/pkgs/perl_term_readline_gnu-1.34.log'
[perl_term_readline_gnu-1.34] Found local metadata for perl_term_readline_gnu-1.34
[perl_term_readline_gnu-1.34] =========================== WARNING ===========================
[perl_term_readline_gnu-1.34] You are about to download and install an experimental package.
[perl_term_readline_gnu-1.34] This probably won't work at all for you! There is no guarantee
[perl_term_readline_gnu-1.34] that it will build correctly, or behave as expected.
[perl_term_readline_gnu-1.34] Use at your own risk!
[perl_term_readline_gnu-1.34] ===============================================================
<hang>
```

but actually it was waiting for me to answer

```
[perl_term_readline_gnu-1.34] Are you sure you want to continue [Y/n]? 
```

which the second time I did.  In the old `./sage -i` this worked okay, but somehow with the new logging system it sort of failed.  Don't know if fixing this belongs on this ticket, though.  (Jeroen, I think you've tried out more experimental packages than most - thoughts?)


---

Comment by kcrisman created at 2016-06-28 03:34:16

But #20892 still does:

```
[polymake-3.0r1] Thread model: posix
[polymake-3.0r1] gcc version 4.9.3 (GCC) 
[polymake-3.0r1] ****************************************************
[polymake-3.0r1] checking C++ compiler ... ok (g++ is GCC 4.9.3)
[polymake-3.0r1] checking C++ library ... ok (GNU stdlibc++ 20150626, C++ 199711)
[polymake-3.0r1] checking fink installation ... The Fink package system is a mandatory prerequisite to build and use polymake under MacOS.
[polymake-3.0r1] Please refer to http://www.polymake.org/doku.php/mac for details and installation instructions.
[polymake-3.0r1] If you already have Fink installed at a non-standard location, please specify it using option --with-fink
[polymake-3.0r1] Several configurations for MacOS platform found;
[polymake-3.0r1] Please specify the desired one using the option Arch=<NAME>.
[polymake-3.0r1] Makefile:32: *** CONFIGURATION ERROR.  Stop.
[polymake-3.0r1] Several configurations for MacOS platform found;
[polymake-3.0r1] Please specify the desired one using the option Arch=<NAME>.
[polymake-3.0r1] Makefile:32: *** CONFIGURATION ERROR.  Stop.
[polymake-3.0r1] 
[polymake-3.0r1] real	0m1.003s
[polymake-3.0r1] user	0m0.415s
[polymake-3.0r1] sys	0m0.219s
[polymake-3.0r1] ************************************************************************
[polymake-3.0r1] Error installing package polymake-3.0r1
[polymake-3.0r1] ************************************************************************
```

I see you have some special instructions at comment:17:ticket:20892 so I'll try that.


---

Comment by kcrisman created at 2016-06-28 03:45:43

Apparently this is working well enough that I'd say one could give it positive review (modulo comment:6, if relevant).  But I would like to hear from Linuces.  I have to admit I was never successful in getting this to work on my older Mac but apparently the Perl part actually does here!


---

Comment by mkoeppe created at 2016-06-28 03:53:06

Replying to [comment:6 kcrisman]:
> There is a problem in the way we do things now with experimental packages.  Here is what I saw:
> {{{
> <hang>
> }}}
> but actually it was waiting for me to answer
> {{{
> [perl_term_readline_gnu-1.34] Are you sure you want to continue [Y/n]? 
> }}}
> which the second time I did.

This is bug #20884.


---

Comment by kcrisman created at 2016-06-28 22:46:32

Okay, then I think all we need for positive review is someone to test this doesn't break anything.  (E.g. on Linux or Cygwin...)  Very nice!


---

Comment by tmonteil created at 2016-06-30 09:10:17

The `ARCHFLAGS='-arch x86_64'` looks weird. How does it behaves on other architectures ?


---

Comment by git created at 2016-07-01 13:30:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2016-07-01 13:33:35

Replying to [comment:12 tmonteil]:
> The `ARCHFLAGS='-arch x86_64'` looks weird. How does it behaves on other architectures ?

I now do this only on Mac OS X and use `uname`.

It needs testing ("review") to know whether this ticket works on other architectures. I don't have access to other architectures at the moment.


---

Comment by tmonteil created at 2016-07-01 14:27:13

Replying to [comment:14 mkoeppe]:
> Replying to [comment:12 tmonteil]:
> > The `ARCHFLAGS='-arch x86_64'` looks weird. How does it behaves on other architectures ?
> 
> I now do this only on Mac OS X and use `uname`.

Looks indeed better like this. I will test on i686 soon (i am currently doing some computations there, perhaps for 3-4 more days).

> It needs testing ("review") to know whether this ticket works on other architectures. I don't have access to other architectures at the moment.


---

Comment by dimpase created at 2016-07-07 08:09:33

I will do testing on i686


---

Comment by dimpase created at 2016-07-07 08:18:51

the upstream tarball is not wgetttable - I get "scheme missing"... While this does not prevent testing, release manager won't be amused.


---

Comment by dimpase created at 2016-07-07 08:37:03

On `x86_64` this installs well, but `polymake` installation fails:

```
...
[polymake-3.0r1] checking mpfr installation ... ok
[polymake-3.0r1] checking shared perl library ... Can't locate ExtUtils/Embed.pm in `@`INC (you may need to install the ExtUtils::Embed module) (`@`INC contains: /home/scratch/dimpase/sage/sage/local/lib/perl5/x86_64-linux-thread-multi /home/scratch/dimpase/sage/sage/local/lib/perl5 /usr/local/lib64/perl5 /usr/local/share/perl5 /usr/lib64/perl5/vendor_perl /usr/share/perl5/vendor_perl /usr/lib64/perl5 /usr/share/perl5 .).
[polymake-3.0r1] BEGIN failed--compilation aborted.
[polymake-3.0r1] Can't locate ExtUtils/Embed.pm in `@`INC (you may need to install the ExtUtils::Embed module) (`@`INC contains: /home/scratch/dimpase/sage/sage/local/lib/perl5/x86_64-linux-thread-multi /home/scratch/dimpase/sage/sage/local/lib/perl5 /usr/local/lib64/perl5 /usr/local/share/perl5 /usr/lib64/perl5/vendor_perl /usr/share/perl5/vendor_perl /usr/lib64/perl5 /usr/share/perl5 .).
[polymake-3.0r1] BEGIN failed--compilation aborted.
[polymake-3.0r1] failed
[polymake-3.0r1] 
[polymake-3.0r1] Could not compile a test program for the libperl.so shared library.
[polymake-3.0r1] The build error is as follows:
[polymake-3.0r1] /tmp/polymake_10418_configure.cc:1:20: fatal error: EXTERN.h: No such file or directory
[polymake-3.0r1] compilation terminated.
[polymake-3.0r1] 
```



---

Comment by mkoeppe created at 2016-07-07 08:44:25

Thanks for testing. Could you try to find out which packages on your distribution need to be installed for this to work? We could add this information to the polymake package readme. However, I don't see us including all kinds of Perl prerequisites as Sage packages. I consider `libterm-readline-gnu` an exception because it's not available on OS X; fink does not have a package for it; we already have libreadline; the CPAN script fails to install it on OS X.


---

Comment by dimpase created at 2016-07-07 08:47:35

Do you mean that on Linux you would not need to use this package, and system-wide Perl would do?


---

Comment by mkoeppe created at 2016-07-07 08:52:48

I think a system-wide Perl with the necessary modules would do; but given that we unconditionally install readline (it being a standard package) even on Linux (which probably also has readline, though maybe not the header files), perhaps we want to use our readline for Perl as well for consistency.


---

Comment by dimpase created at 2016-07-07 09:04:34

I am testing this on Fedora 23, and the missing header `EXTERN.h` is installed, it is in `/usr/lib64/perl5/CORE/`. This seems to be quite messy; [perl people recommend](https://www.centos.org/forums/viewtopic.php?t=19848) doing

```
$ perl -MConfig -e 'print "$Config{archlib}\n"'
```

to get the path to default `perl` install. On Ubuntu I get `/usr/lib/perl/5.18`, on Fedora 23 I get `/usr/lib64/perl5`. Thus `polymake` ought to use the output of that `perl` call to construct a path to `EXTERN.h`.


---

Comment by mkoeppe created at 2016-07-07 09:28:26

This check in Polymake's configure script is in support/configure.pl lines 718-
Could you look what's going on and/or report this failure on Fedora 23 in the polymake forum? I think this is not Sage-specific. https://forum.polymake.org/viewforum.php?f=10


---

Comment by dimpase created at 2016-07-07 10:19:04

In fact, after `$ sudo yum install perl-ExtUtils-Embed` (took a while to dig up)
polymake is building. I'll report this on polymake forum.


---

Comment by mkoeppe created at 2016-07-07 21:25:54

Should this be an experimental or an optional package?


---

Comment by dimpase created at 2016-07-07 21:28:09

let's start with experimental. Optional needs approval on sage-devel, as well as passing all its tests... IMHO it and polymake should go in lockstep in this.


---

Comment by mkoeppe created at 2016-07-07 21:43:14

OK, then I leave it as experimental.


---

Comment by mkoeppe created at 2016-07-07 22:23:14

If I understand the procedure correctly (https://trac.sagemath.org/ticket/20529#comment:15), this ticket might be ready for `positive_review` as buildbots will do further builds on other platforms.


---

Comment by dimpase created at 2016-07-07 22:33:16

looks good to me


---

Comment by dimpase created at 2016-07-07 22:33:16

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-07-09 07:46:15

Resolution: fixed
