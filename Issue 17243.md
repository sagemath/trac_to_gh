# Issue 17243: Improve documentation of element.pyx

Issue created by migration from https://trac.sagemath.org/ticket/17480

Original creator: cheuberg

Original creation time: 2014-12-10 07:29:54

CC:  behackl roed

Keywords: documentation, element

In

http://www.sagemath.org/doc/reference/structure/sage/structure/element.html#how-to-define-a-new-element-class ,

I find the descriptions of `_add_` very confusing, because it seems to imply that there are two versions of `_add_`, one of them as a `def` and the other as a `cpdef`. As it stands, it reads as a circular argument.

`def RingElement._add_`: ... You should override `_add_`. .... The default implementation of this function is to call `_add_`.

`cpdef RingElement._add_` ... which will happen if no-one has supplied implementations of either `_add_`

I think that it does not help that Pyrex is still mentioned instead of Cython.

Apart from that, there were several ReST formatting errors.



---

Comment by cheuberg created at 2014-12-10 07:35:31

I started a branch correcting the ReST formatting errors. The output is visible at
https://www.math.aau.at/user/cheuberg/sage/doc/6.5.beta2-1-g8106a86/en/reference/structure/sage/structure/element.html .
----
New commits:


---

Comment by git created at 2014-12-16 19:11:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cheuberg created at 2014-12-16 19:12:47

Changing status from new to needs_review.


---

Comment by cheuberg created at 2014-12-16 19:12:47

I now combined the descriptions of def and cpdef _add_, as discussed at [sage-devel](https://groups.google.com/forum/#!topic/sage-devel/eXxanFbQ2Jg).


---

Comment by cheuberg created at 2014-12-16 20:08:40

Output is visible at
https://www.math.aau.at/user/cheuberg/sage/doc/6.5.beta2-2-g225ee88/en/reference/structure/sage/structure/element.html


---

Comment by git created at 2014-12-17 10:15:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cheuberg created at 2014-12-17 10:23:42

Fixed issues reported by [Samuel Lelievre](https://groups.google.com/d/msg/sage-devel/eXxanFbQ2Jg/TTBqjq9CCj0J). Updated output is visible at
https://www.math.aau.at/user/cheuberg/sage/doc/6.5.beta2-4-g2e57cf9/en/reference/structure/sage/structure/element.html .


---

Comment by slelievre created at 2014-12-17 19:02:32

It's good that you are refreshing this part of the documentation, if only to update references to Pyrex, and instead refer to Cython! Here are three more thoughts.

First, maybe it would be worth pointing to the subtle ways in which these functions differ in names and in nature, by saying for instance:

  There are three relevant functions, with subtly differing names (add vs iadd, single vs double underscores), one of which has both a Python and a Cython version (note the `def` vs `cpdef`).

Then in the paragraph about `_add_`, you could insist once again on the presence of the def and cpdef versions.

Second, in the sentence

  For speed, there are also inplace version of the arithmetic commands.

we want "inplace versions" (plural).

Last, in the sentence

  This is the function you should override to inplace implement addition in a Python subclass of `RingElement`.

I would change "to inplace implement addition" to "to implement inplace addition".


---

Comment by git created at 2014-12-18 08:41:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cheuberg created at 2014-12-18 08:45:42

Replying to [comment:8 slelievre]:
> First, maybe it would be worth pointing to the subtle ways in which these functions differ in names and in nature, by saying for instance:
> 
>   There are three relevant functions, with subtly differing names (add vs iadd, single vs double underscores), one of which has both a Python and a Cython version (note the `def` vs `cpdef`).

done.

> Then in the paragraph about `_add_`, you could insist once again on the presence of the def and cpdef versions.

Really? It is already in a `.. warning::` box; what else can we do?
Or are we speaking about different paragraphs?

In any case, I mention `def` and `cpdef` in the heading of the paragraph.

> Second, in the sentence ...

done.

> Last, in the sentence ...

done.

Documentation output is visible  [here](https://www.math.aau.at/user/cheuberg/sage/doc/6.5.beta2-6-g7ebe661/en/reference/structure/sage/structure/element.html).


---

Comment by slelievre created at 2014-12-19 02:11:01

Replying to [comment:10 cheuberg]:
> > Then in the paragraph about `_add_`, you could insist once again on the presence of the def and cpdef versions.
> 
> Really? It is already in a `.. warning::` box; what else can we do?
> Or are we speaking about different paragraphs?
> 
> In any case, I mention `def` and `cpdef` in the heading of the paragraph.

That's what I had in mind, nothing more: mentioning both `def` and `cpdef` in the heading of the paragraph.


---

Comment by cheuberg created at 2014-12-28 13:43:41

Replying to [comment:11 slelievre]:
> Replying to [comment:10 cheuberg]:
> > In any case, I mention `def` and `cpdef` in the heading of the paragraph.
> 
> That's what I had in mind, nothing more: mentioning both `def` and `cpdef` in the heading of the paragraph.

If you are happy with the current state: could you set this to `positive_review`?


---

Comment by mmezzarobba created at 2015-01-23 13:43:17

There remained an indentation error which I fixed. I took the occasion to make a few more formatting changes. The previous patches look fine to me; if you are happy with my changes, please feel free to set the ticket to positive review.


---

Comment by slelievre created at 2015-01-23 15:59:52

One more thing while we're at it: in the docstring of `abs`,

```
Return the absolute value of self
```

should be

```
Return the absolute value of ``self``
```

Modulo that, you can set it to positive review.


---

Comment by cheuberg created at 2015-01-23 16:49:30

Changing status from needs_review to positive_review.


---

Comment by cheuberg created at 2015-01-23 16:49:30

Replying to [comment:15 slelievre]:
> One more thing while we're at it: in the docstring of `abs`,
> {{{
> Return the absolute value of self
> }}}
> should be
> {{{
> Return the absolute value of ``self``
> }}}

Done.

> Modulo that, you can set it to positive review.

Done, thanks.
----
New commits:


---

Comment by jdemeyer created at 2015-01-24 09:01:53

This conflicts with #10779 and, to be safe, it should be rebased on #17533 also.

I also wonder about the statement

```
   .. warning::

      In a *Cython* class, this has to be overridden as a ``cpdef``;
      otherwise, it won't get called. It is especially important to keep
      this in mind whenever you move a class down from Python to Cython.

      In *Python*, this has to be overridden as a ``def``.
```


I doubt that this is true and would simply remove this paragraph.


---

Comment by jdemeyer created at 2015-01-24 09:01:53

Changing status from positive_review to needs_work.


---

Comment by git created at 2015-01-31 08:26:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cheuberg created at 2015-01-31 08:47:01

Changing status from needs_work to needs_info.


---

Comment by cheuberg created at 2015-01-31 08:47:01

Replying to [comment:18 jdemeyer]:
> This conflicts with #10779 and, to be safe, it should be rebased on #17533 also.

Merged 6.5.beta6 (containing #10779) and resolved merge conflict.
#17533 does not produce a merge conflict, but merged it anyway to be on the safe side.

> 
> I also wonder about the statement
> {{{
>    .. warning::
> 
>       In a *Cython* class, this has to be overridden as a ``cpdef``;
>       otherwise, it won't get called. It is especially important to keep
>       this in mind whenever you move a class down from Python to Cython.
> 
>       In *Python*, this has to be overridden as a ``def``.
> }}}
> 
> I doubt that this is true and would simply remove this paragraph.

So that would mean that the [old documentation](http://www.sagemath.org/doc/reference/structure/sage/structure/element.html#how-to-define-a-new-element-class) mentioning a `def _add_` and a `cpdef _add_` with a similar warning was incorrect, too?

I tried the following:

```
sage: cython_code = """
....: from sage.structure.element cimport RingElement
....: cdef class MyCRingElement(RingElement):
....:    def _add_(self, other):
....:        print "My _add_ is called"
....:        return 0"""
sage: cython(cython_code)
sage: b = MyCRingElement(ZZ)
sage: b._add_(b)
My _add_ is called
0
```


Therefore, I tend to remove the warning, as well as the whole `cpdef` vs. `def` discussion. Before doing so, I'd like to hear other opinions (Samuel?)


---

Comment by git created at 2015-02-08 10:33:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cheuberg created at 2015-02-08 10:34:59

Replying to [comment:18 jdemeyer]:
> I also wonder about the statement
> {{{
>    .. warning::
> 
>       In a *Cython* class, this has to be overridden as a ``cpdef``;
>       otherwise, it won't get called. It is especially important to keep
>       this in mind whenever you move a class down from Python to Cython.
> 
>       In *Python*, this has to be overridden as a ``def``.
> }}}
> 
> I doubt that this is true and would simply remove this paragraph.

I removed the paragraph (and modified the sentence introducing this list).


---

Comment by cheuberg created at 2015-02-08 10:34:59

Changing status from needs_info to needs_review.


---

Comment by mmezzarobba created at 2015-02-09 09:45:23

Replying to [comment:22 cheuberg]:
> I removed the paragraph (and modified the sentence introducing this list).

Perhaps the item heading "cpdef RingElement._add_ vs. def RingElement._add_" also needs to be rephrased then?


---

Comment by cheuberg created at 2015-02-09 09:51:30

I did not change it because you might overwrite it as `def` or as `cpdef`.

But perhaps keeping it does cause more confusion, so I'll remove it following your suggestion.


---

Comment by cheuberg created at 2015-02-09 09:51:30

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-02-09 11:15:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cheuberg created at 2015-02-09 11:16:39

Changing status from needs_work to needs_review.


---

Comment by cheuberg created at 2015-02-09 11:16:39

Replying to [comment:24 cheuberg]:
> so I'll remove it following your suggestion.

done.

I also removed "from Python" from the sentence "If you want to add two objects from Python".


---

Comment by jdemeyer created at 2015-02-09 11:24:49

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-02-09 11:24:49

The only thing I'm missing now is that there is no mention at all about `cpdef` functions. Perhaps add a sentence like "when implementing `_add_` in a Cython extension class, use `cpdef _add_` instead".

In other words: it's not _required_ to use `cpdef` but still encouraged.


---

Comment by git created at 2015-02-09 11:49:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cheuberg created at 2015-02-09 11:50:41

Replying to [comment:27 jdemeyer]:
> The only thing I'm missing now is that there is no mention at all about `cpdef` functions. Perhaps add a sentence like "when implementing `_add_` in a Cython extension class, use `cpdef _add_` instead".

Done.


---

Comment by cheuberg created at 2015-02-09 11:50:41

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-02-09 12:18:53

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-02-18 08:53:21

Resolution: fixed
