# Issue 24631: Neighbor method for quadratic forms

archive/issues_024631.json:
```json
{
    "body": "We implement neighbor method (neighbour method) for quadratic forms. We just combine `find_p_neighbor_from_vec`, `is_globally_equivalent_to` and `find_primitive_p_divisible_vector__next`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/24868\n\n",
    "created_at": "2018-02-28T15:13:34Z",
    "labels": [
        "component: quadratic forms"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Neighbor method for quadratic forms",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24631",
    "user": "https://trac.sagemath.org/admin/accounts/users/khashimoto"
}
```
We implement neighbor method (neighbour method) for quadratic forms. We just combine `find_p_neighbor_from_vec`, `is_globally_equivalent_to` and `find_primitive_p_divisible_vector__next`.

Issue created by migration from https://trac.sagemath.org/ticket/24868





---

archive/issue_comments_345123.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-01T08:33:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24631#issuecomment-345123",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_345124.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-01T09:41:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24631#issuecomment-345124",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_345125.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-03-01T09:43:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24631#issuecomment-345125",
    "user": "https://trac.sagemath.org/admin/accounts/users/khashimoto"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_345126.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-03-01T11:25:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24631#issuecomment-345126",
    "user": "https://github.com/simonbrandhorst"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_345127.json:
```json
{
    "body": "Some suggestions:\n- use the conway_mass() as an optional breaking or sanity check condition\n- extra condition for 2-neighbors",
    "created_at": "2018-03-01T11:25:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24631#issuecomment-345127",
    "user": "https://github.com/simonbrandhorst"
}
```

Some suggestions:
- use the conway_mass() as an optional breaking or sanity check condition
- extra condition for 2-neighbors



---

archive/issue_comments_345128.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-02T16:02:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24631#issuecomment-345128",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_345129.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-09-25T15:28:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24631#issuecomment-345129",
    "user": "https://github.com/simonbrandhorst"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_345130.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-09-25T15:28:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24631#issuecomment-345130",
    "user": "https://github.com/simonbrandhorst"
}
```

New commits:



---

archive/issue_comments_345131.json:
```json
{
    "body": "A few minor things:\n\n\n```diff\n-rational forms we just pretend the base ring is ZZ::\n+rational forms we just pretend the base ring is ``ZZ``::\n```\n\n\nWhile the error message says it only takes `ZZ`, the code also allows for `QQ`:\n\n```python\n    if self.base_ring() not in [ZZ, QQ]:\n        raise NotImplementedError(\"the base ring of this form must be the integers\")\n```\n\nCan you explain this discrepency?\n\n\n```diff\n-      if G.denominator()!=1:\n-        raise ValueError(\"the associated bilinear form q(x+y)-q(x)-q(y) must be integral.\")\n+      if G.denominator() != 1:\n+        raise ValueError(\"the associated bilinear form q(x+y)-q(x)-q(y) must be integral\")\n```\n\n\n\n```diff\n-    if p!=2 and b % p**2 != 0:\n+    if p != 2 and b % p**2 != 0:\n```\n\n\nIs `assert y*G*y % 8 == 0, (y, G)` something that is expected to always succeed or is it meant to catch bad input?\n\nThere will be problems mixing `yield` and nontrivial `return` statements:\n\n```diff\n-            return iter([v.lift() for v in Q.orbits_lines_mod_p(p)\n-                        if v!=0 and Q(v.lift()).valuation(p) > 0])\n+            yield from (v.lift() for v in Q.orbits_lines_mod_p(p)\n+                        if v != 0 and Q(v.lift()).valuation(p) > 0)\n+            return\n```\n\n\nEasier way to copy a list:\n\n```diff\n-waiting_list = copy(seeds)\n+waiting_list = list(seeds)\n```\n\n\nIt would be a little more readable if the subsequent lines of\n\n```\n    orbs = libgap.function_factory(\"\"\"function(gens, p)\n```\n\nwere also indented.",
    "created_at": "2020-09-27T23:20:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24631#issuecomment-345131",
    "user": "https://github.com/tscrim"
}
```

A few minor things:


```diff
-rational forms we just pretend the base ring is ZZ::
+rational forms we just pretend the base ring is ``ZZ``::
```


While the error message says it only takes `ZZ`, the code also allows for `QQ`:

```python
    if self.base_ring() not in [ZZ, QQ]:
        raise NotImplementedError("the base ring of this form must be the integers")
```

Can you explain this discrepency?


```diff
-      if G.denominator()!=1:
-        raise ValueError("the associated bilinear form q(x+y)-q(x)-q(y) must be integral.")
+      if G.denominator() != 1:
+        raise ValueError("the associated bilinear form q(x+y)-q(x)-q(y) must be integral")
```



```diff
-    if p!=2 and b % p**2 != 0:
+    if p != 2 and b % p**2 != 0:
```


Is `assert y*G*y % 8 == 0, (y, G)` something that is expected to always succeed or is it meant to catch bad input?

There will be problems mixing `yield` and nontrivial `return` statements:

```diff
-            return iter([v.lift() for v in Q.orbits_lines_mod_p(p)
-                        if v!=0 and Q(v.lift()).valuation(p) > 0])
+            yield from (v.lift() for v in Q.orbits_lines_mod_p(p)
+                        if v != 0 and Q(v.lift()).valuation(p) > 0)
+            return
```


Easier way to copy a list:

```diff
-waiting_list = copy(seeds)
+waiting_list = list(seeds)
```


It would be a little more readable if the subsequent lines of

```
    orbs = libgap.function_factory("""function(gens, p)
```

were also indented.



---

archive/issue_comments_345132.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-09-28T12:56:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24631#issuecomment-345132",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_345133.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-09-28T13:12:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24631#issuecomment-345133",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_345134.json:
```json
{
    "body": "I updated the error message. It should match now.\nBasically neighbors make sense for half integral quadratic forms,\nthat is, with base ring `ZZ` and values in `1/2 ZZ`. \nHowever base_ring and domain are not yet separated, so we have to include rational forms.",
    "created_at": "2020-09-28T13:16:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24631#issuecomment-345134",
    "user": "https://github.com/simonbrandhorst"
}
```

I updated the error message. It should match now.
Basically neighbors make sense for half integral quadratic forms,
that is, with base ring `ZZ` and values in `1/2 ZZ`. 
However base_ring and domain are not yet separated, so we have to include rational forms.



---

archive/issue_comments_345135.json:
```json
{
    "body": "Okay. Then LGTM now. Thanks.",
    "created_at": "2020-09-29T02:59:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24631#issuecomment-345135",
    "user": "https://github.com/tscrim"
}
```

Okay. Then LGTM now. Thanks.



---

archive/issue_comments_345136.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-09-29T02:59:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24631#issuecomment-345136",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_345137.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-10-03T22:57:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24631#issuecomment-345137",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_345138.json:
```json
{
    "body": "These sage-release reports may indicate a possible issue:\n\n- https://groups.google.com/d/msg/sage-release/0MnZQYItCYc/C2WM1LvcAAAJ\n- https://groups.google.com/d/msg/sage-release/0MnZQYItCYc/6ks32lnXAAAJ",
    "created_at": "2020-10-07T14:51:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24631#issuecomment-345138",
    "user": "https://github.com/egourgoulhon"
}
```

These sage-release reports may indicate a possible issue:

- https://groups.google.com/d/msg/sage-release/0MnZQYItCYc/C2WM1LvcAAAJ
- https://groups.google.com/d/msg/sage-release/0MnZQYItCYc/6ks32lnXAAAJ



---

archive/issue_comments_345139.json:
```json
{
    "body": "It seems to be rather #27749?",
    "created_at": "2020-10-07T20:06:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24631#issuecomment-345139",
    "user": "https://github.com/simonbrandhorst"
}
```

It seems to be rather #27749?



---

archive/issue_comments_345140.json:
```json
{
    "body": "Replying to [comment:19 sbrandhorst]:\n> It seems to be rather #27749?\nAh yes indeed! Sorry for the noise.",
    "created_at": "2020-10-07T20:20:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24631#issuecomment-345140",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:19 sbrandhorst]:
> It seems to be rather #27749?
Ah yes indeed! Sorry for the noise.
