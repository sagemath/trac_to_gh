# Issue 24631: Neighbor method for quadratic forms

Issue created by migration from https://trac.sagemath.org/ticket/24868

Original creator: khashimoto

Original creation time: 2018-02-28 15:13:34

We implement neighbor method (neighbour method) for quadratic forms. We just combine `find_p_neighbor_from_vec`, `is_globally_equivalent_to` and `find_primitive_p_divisible_vector__next`.


---

Comment by git created at 2018-03-01 08:33:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-03-01 09:41:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by khashimoto created at 2018-03-01 09:43:13

Changing status from new to needs_review.


---

Comment by sbrandhorst created at 2018-03-01 11:25:53

Changing status from needs_review to needs_work.


---

Comment by sbrandhorst created at 2018-03-01 11:25:53

Some suggestions:
- use the conway_mass() as an optional breaking or sanity check condition
- extra condition for 2-neighbors


---

Comment by git created at 2018-03-02 16:02:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by sbrandhorst created at 2020-09-25 15:28:37

Changing status from needs_work to needs_review.


---

Comment by sbrandhorst created at 2020-09-25 15:28:37

New commits:


---

Comment by tscrim created at 2020-09-27 23:20:29

A few minor things:


```diff
-rational forms we just pretend the base ring is ZZ::
+rational forms we just pretend the base ring is ``ZZ``::
```


While the error message says it only takes `ZZ`, the code also allows for `QQ`:

```python
    if self.base_ring() not in [ZZ, QQ]:
        raise NotImplementedError("the base ring of this form must be the integers")
```

Can you explain this discrepency?


```diff
-      if G.denominator()!=1:
-        raise ValueError("the associated bilinear form q(x+y)-q(x)-q(y) must be integral.")
+      if G.denominator() != 1:
+        raise ValueError("the associated bilinear form q(x+y)-q(x)-q(y) must be integral")
```



```diff
-    if p!=2 and b % p**2 != 0:
+    if p != 2 and b % p**2 != 0:
```


Is `assert y*G*y % 8 == 0, (y, G)` something that is expected to always succeed or is it meant to catch bad input?

There will be problems mixing `yield` and nontrivial `return` statements:

```diff
-            return iter([v.lift() for v in Q.orbits_lines_mod_p(p)
-                        if v!=0 and Q(v.lift()).valuation(p) > 0])
+            yield from (v.lift() for v in Q.orbits_lines_mod_p(p)
+                        if v != 0 and Q(v.lift()).valuation(p) > 0)
+            return
```


Easier way to copy a list:

```diff
-waiting_list = copy(seeds)
+waiting_list = list(seeds)
```


It would be a little more readable if the subsequent lines of

```
    orbs = libgap.function_factory("""function(gens, p)
```

were also indented.


---

Comment by git created at 2020-09-28 12:56:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-09-28 13:12:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by sbrandhorst created at 2020-09-28 13:16:04

I updated the error message. It should match now.
Basically neighbors make sense for half integral quadratic forms,
that is, with base ring `ZZ` and values in `1/2 ZZ`. 
However base_ring and domain are not yet separated, so we have to include rational forms.


---

Comment by tscrim created at 2020-09-29 02:59:12

Okay. Then LGTM now. Thanks.


---

Comment by tscrim created at 2020-09-29 02:59:12

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-10-03 22:57:36

Resolution: fixed


---

Comment by egourgoulhon created at 2020-10-07 14:51:43

These sage-release reports may indicate a possible issue:

- https://groups.google.com/d/msg/sage-release/0MnZQYItCYc/C2WM1LvcAAAJ
- https://groups.google.com/d/msg/sage-release/0MnZQYItCYc/6ks32lnXAAAJ


---

Comment by sbrandhorst created at 2020-10-07 20:06:56

It seems to be rather #27749?


---

Comment by egourgoulhon created at 2020-10-07 20:20:27

Replying to [comment:19 sbrandhorst]:
> It seems to be rather #27749?
Ah yes indeed! Sorry for the noise.
