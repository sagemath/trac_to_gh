# Issue 14045: There should be no need to have _an_element_ implement to multiply elements

archive/issues_014045.json:
```json
{
    "body": "Assignee: robertwb\n\nCC:  nthiery\n\nWe currently have\n\n```\n  sage: from sage.structure.element import ModuleElement\n  sage: class MyElement(ModuleElement):\n  ....:     def __init__(self, x, y, parent=None):\n  ....:         ModuleElement.__init__(self, parent)\n  ....:     def _mul_(self, other):\n  ....:         return self\n  ....:     def _rmul_(self, other):\n  ....:         return self\n  ....:     def _lmul_(self, other):\n  ....:         return self\n  ....:\n  sage: class MyParent(Parent):\n  ....:     Element = MyElement\n  ....:\n  sage: P = MyParent(category=Rings())\n  sage: P(1,2)\n  Generic element of a structure\n  sage: a = _\n  sage: a*2\n  Traceback (most recent call last):\n  ...\n  NotImplementedError: please implement _an_element_ for <class '__main__.MyParent_with_category'>\n```\n\n\nI find this very annoying.\n\nThe background is that the coercion model tries to get a multiplication action, namely `RightModuleAction`. During initialisation of the module action, some sanity tests are performed. In particular, an element of the acting parent and the acted-upon set are taken and the action called on these two elements.\n\nProblem: Where to get the two elements from? Currently, they are gotten from the method `an_element()`, which in turn relies on `_an_element_()` being implemented if the default implementation is not good enough (which is the case in the example above).\n\nBut normally, we do not want to have the `RightModuleAction` just out of the blue: Typically (in the example above, at least), we want to create it during the first multiplication. And in that moment we *do* have two elements.\n\nSo, I propose to make it possible to pass the two elements being multiplied to the constructor of `Left/RightModuleAction`, and let `an_element()` be called *only* if no element is passed.\n\nIssue created by migration from https://trac.sagemath.org/ticket/14249\n\n",
    "created_at": "2013-03-10T07:55:15Z",
    "labels": [
        "coercion",
        "major",
        "bug"
    ],
    "title": "There should be no need to have _an_element_ implement to multiply elements",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14045",
    "user": "SimonKing"
}
```
Assignee: robertwb

CC:  nthiery

We currently have

```
  sage: from sage.structure.element import ModuleElement
  sage: class MyElement(ModuleElement):
  ....:     def __init__(self, x, y, parent=None):
  ....:         ModuleElement.__init__(self, parent)
  ....:     def _mul_(self, other):
  ....:         return self
  ....:     def _rmul_(self, other):
  ....:         return self
  ....:     def _lmul_(self, other):
  ....:         return self
  ....:
  sage: class MyParent(Parent):
  ....:     Element = MyElement
  ....:
  sage: P = MyParent(category=Rings())
  sage: P(1,2)
  Generic element of a structure
  sage: a = _
  sage: a*2
  Traceback (most recent call last):
  ...
  NotImplementedError: please implement _an_element_ for <class '__main__.MyParent_with_category'>
```


I find this very annoying.

The background is that the coercion model tries to get a multiplication action, namely `RightModuleAction`. During initialisation of the module action, some sanity tests are performed. In particular, an element of the acting parent and the acted-upon set are taken and the action called on these two elements.

Problem: Where to get the two elements from? Currently, they are gotten from the method `an_element()`, which in turn relies on `_an_element_()` being implemented if the default implementation is not good enough (which is the case in the example above).

But normally, we do not want to have the `RightModuleAction` just out of the blue: Typically (in the example above, at least), we want to create it during the first multiplication. And in that moment we *do* have two elements.

So, I propose to make it possible to pass the two elements being multiplied to the constructor of `Left/RightModuleAction`, and let `an_element()` be called *only* if no element is passed.

Issue created by migration from https://trac.sagemath.org/ticket/14249





---

archive/issue_comments_175637.json:
```json
{
    "body": "I am afraid that my patch touches parent.pxd and thus forces rebuilding most of Sage.\n\nAnyway. If an action of one parent on some object is requested *during arithmetic operations*, then the coercion model will now use the two given elements to construct/test an action, rather than calling an_element() of the parent and the object, which might not always be available.\n\nMy patch uncovered a bug in sage/schemes/hyperelliptic_curves/jacobian_morphism.py: An `IntegerMulAction` was to be created, but for testing it, `m+(-m)` is attempted for the given element m. But the involved element used to raise an error on `-m`.\n\nSo, that's an independent bug, which I fixed in #14264.",
    "created_at": "2013-03-13T10:50:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14045#issuecomment-175637",
    "user": "SimonKing"
}
```

I am afraid that my patch touches parent.pxd and thus forces rebuilding most of Sage.

Anyway. If an action of one parent on some object is requested *during arithmetic operations*, then the coercion model will now use the two given elements to construct/test an action, rather than calling an_element() of the parent and the object, which might not always be available.

My patch uncovered a bug in sage/schemes/hyperelliptic_curves/jacobian_morphism.py: An `IntegerMulAction` was to be created, but for testing it, `m+(-m)` is attempted for the given element m. But the involved element used to raise an error on `-m`.

So, that's an independent bug, which I fixed in #14264.



---

archive/issue_comments_175638.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-03-13T10:50:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14045#issuecomment-175638",
    "user": "SimonKing"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_175639.json:
```json
{
    "body": "Isn't it a logical flaw that there should even be elements for an action to exist? I think it's entirely possible to have a group acting on an empty set. In fact, in number theory these things often arise. If C is a smooth projective genus 1 curve then it is a torsor under its jacobian E. This gives a functorial way for E(k) to act on C(k), for any extension k of the field of definition. In the interesting cases, C(k) is empty, so you have a finitely generated group E(k) acting on the empty set C(k).\n\nThis particular scenario isn't particularly relevant for the coercion framework, but it does show that actions on empty sets are natural to consider, so if we're not supporting that, there may be something wrong with our model.\n\nCan't we just ditch the sanity check (or skip it if an element isn't easily obtained)?",
    "created_at": "2013-03-13T15:50:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14045#issuecomment-175639",
    "user": "nbruin"
}
```

Isn't it a logical flaw that there should even be elements for an action to exist? I think it's entirely possible to have a group acting on an empty set. In fact, in number theory these things often arise. If C is a smooth projective genus 1 curve then it is a torsor under its jacobian E. This gives a functorial way for E(k) to act on C(k), for any extension k of the field of definition. In the interesting cases, C(k) is empty, so you have a finitely generated group E(k) acting on the empty set C(k).

This particular scenario isn't particularly relevant for the coercion framework, but it does show that actions on empty sets are natural to consider, so if we're not supporting that, there may be something wrong with our model.

Can't we just ditch the sanity check (or skip it if an element isn't easily obtained)?



---

archive/issue_comments_175640.json:
```json
{
    "body": "Replying to [comment:2 nbruin]:\n> Isn't it a logical flaw that there should even be elements for an action to exist? \n\nFor *general* actions I agree. But:\n \n> This particular scenario isn't particularly relevant for the coercion framework, but it does show that actions on empty sets are natural to consider, so if we're not supporting that, there may be something wrong with our model.\n\nDon't forget that what we are talking about here is in sage.structure.coerce_actions. So, this *is* for coercions, and it *is* to be applied to elements.\n\nsage.categories.action is of course more general.\n\n> Can't we just ditch the sanity check (or skip it if an element isn't easily obtained)?\n\nPart of the problem is that we have different ways to define an action on elements. There is _rmul_/_lmul_, there is _l_action/_r_action (at least according to sage.structure.coerce_actions, but it isn't used in sage.structure.coerce), there is _act_on_, and there is _acted_upon_. Moreover, there is `IntegerMulAction`. And since they are all acting *on elements*, I think it somehow does make sense to test which of the different flavours is available for the elements.",
    "created_at": "2013-03-13T16:07:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14045#issuecomment-175640",
    "user": "SimonKing"
}
```

Replying to [comment:2 nbruin]:
> Isn't it a logical flaw that there should even be elements for an action to exist? 

For *general* actions I agree. But:
 
> This particular scenario isn't particularly relevant for the coercion framework, but it does show that actions on empty sets are natural to consider, so if we're not supporting that, there may be something wrong with our model.

Don't forget that what we are talking about here is in sage.structure.coerce_actions. So, this *is* for coercions, and it *is* to be applied to elements.

sage.categories.action is of course more general.

> Can't we just ditch the sanity check (or skip it if an element isn't easily obtained)?

Part of the problem is that we have different ways to define an action on elements. There is _rmul_/_lmul_, there is _l_action/_r_action (at least according to sage.structure.coerce_actions, but it isn't used in sage.structure.coerce), there is _act_on_, and there is _acted_upon_. Moreover, there is `IntegerMulAction`. And since they are all acting *on elements*, I think it somehow does make sense to test which of the different flavours is available for the elements.



---

archive/issue_comments_175641.json:
```json
{
    "body": "That said, it is possible for a parent to return an action on request (implement _get_action_). Here, I think it does make sense to offer an optional parameter ``check``, such that the elements are only tested if ``check=True`` (which should be the default, IMHO).\n\nAnd my patch *does* introduce such a ``check`` parameter!",
    "created_at": "2013-03-13T16:10:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14045#issuecomment-175641",
    "user": "SimonKing"
}
```

That said, it is possible for a parent to return an action on request (implement _get_action_). Here, I think it does make sense to offer an optional parameter ``check``, such that the elements are only tested if ``check=True`` (which should be the default, IMHO).

And my patch *does* introduce such a ``check`` parameter!



---

archive/issue_comments_175642.json:
```json
{
    "body": "Since this is a prerequisite for #14279 (which would implement the coercion model for homsets), I am putting Nicolas on Cc. Needs review, hinthint...",
    "created_at": "2013-05-17T08:16:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14045#issuecomment-175642",
    "user": "SimonKing"
}
```

Since this is a prerequisite for #14279 (which would implement the coercion model for homsets), I am putting Nicolas on Cc. Needs review, hinthint...



---

archive/issue_comments_175643.json:
```json
{
    "body": "I agree, basic arithmetic should not require to construct an_element. In general the coercion model's approach of monkey calling a method with garbage to test if by chance it would accept that garbage is ugly and fragile; I am in favor of any step away of it.\n\nThat's a first step :-) \n\nI went through the patch, and it sounds reasonable. So if all test pass, I am fine with it.",
    "created_at": "2013-05-17T18:59:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14045#issuecomment-175643",
    "user": "nthiery"
}
```

I agree, basic arithmetic should not require to construct an_element. In general the coercion model's approach of monkey calling a method with garbage to test if by chance it would accept that garbage is ugly and fragile; I am in favor of any step away of it.

That's a first step :-) 

I went through the patch, and it sounds reasonable. So if all test pass, I am fine with it.



---

archive/issue_comments_175644.json:
```json
{
    "body": "Hey Simon,\n\nSome minor things:\n\n- Line 78 of `parent.pyx` needs the double colon `::`.\n- Could you use the python 3 syntax for the exceptions on lines 332 and 336 of `coerce_actions.pyx`? (`raise CoercionException(\"msg\")`)\n- Use the new line continuations `....:` in `parent.pyx`.\n\nThanks,\n\nTravis",
    "created_at": "2013-05-19T21:04:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14045#issuecomment-175644",
    "user": "tscrim"
}
```

Hey Simon,

Some minor things:

- Line 78 of `parent.pyx` needs the double colon `::`.
- Could you use the python 3 syntax for the exceptions on lines 332 and 336 of `coerce_actions.pyx`? (`raise CoercionException("msg")`)
- Use the new line continuations `....:` in `parent.pyx`.

Thanks,

Travis



---

archive/issue_comments_175645.json:
```json
{
    "body": "Fixes according to Travis' remarks",
    "created_at": "2013-05-21T13:55:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14045#issuecomment-175645",
    "user": "SimonKing"
}
```

Fixes according to Travis' remarks



---

archive/issue_comments_175646.json:
```json
{
    "body": "Attachment\n\nI have added a new patch that hopefully succeeds in addressing Travis' comments.",
    "created_at": "2013-05-21T13:56:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14045#issuecomment-175646",
    "user": "SimonKing"
}
```

Attachment

I have added a new patch that hopefully succeeds in addressing Travis' comments.



---

archive/issue_comments_175647.json:
```json
{
    "body": "The patchbot still complains about the old style line continuations in the first patch. However, the patchbot does not realise that the second patch changes these into new style line continuations. So, I guess the ticket is still ready for review...",
    "created_at": "2013-05-24T15:36:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14045#issuecomment-175647",
    "user": "SimonKing"
}
```

The patchbot still complains about the old style line continuations in the first patch. However, the patchbot does not realise that the second patch changes these into new style line continuations. So, I guess the ticket is still ready for review...



---

archive/issue_comments_175648.json:
```json
{
    "body": "Sorry for falling (slightly) behind on reviewing this. From looking at the patch, it looks good. I'll test it later tonight due to the recompile, promise.",
    "created_at": "2013-05-24T16:50:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14045#issuecomment-175648",
    "user": "tscrim"
}
```

Sorry for falling (slightly) behind on reviewing this. From looking at the patch, it looks good. I'll test it later tonight due to the recompile, promise.



---

archive/issue_comments_175649.json:
```json
{
    "body": "Replying to [comment:9 SimonKing]:\n> The patchbot still complains about the old style line continuations in the first patch. However, the patchbot does not realise that the second patch changes these into new style line continuations. So, I guess the ticket is still ready for review...\n\nOne workaround would be to fold the two patches into the first one, and leave the second one around for review.",
    "created_at": "2013-05-24T19:07:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14045#issuecomment-175649",
    "user": "nthiery"
}
```

Replying to [comment:9 SimonKing]:
> The patchbot still complains about the old style line continuations in the first patch. However, the patchbot does not realise that the second patch changes these into new style line continuations. So, I guess the ticket is still ready for review...

One workaround would be to fold the two patches into the first one, and leave the second one around for review.



---

archive/issue_comments_175650.json:
```json
{
    "body": "OK, the patches got folded.\n\nApply trac_14249-coercion_without_an_element.patch",
    "created_at": "2013-05-24T20:23:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14045#issuecomment-175650",
    "user": "SimonKing"
}
```

OK, the patches got folded.

Apply trac_14249-coercion_without_an_element.patch



---

archive/issue_comments_175651.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-05-25T01:24:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14045#issuecomment-175651",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_175652.json:
```json
{
    "body": "Looks good to me. Thanks Simon.",
    "created_at": "2013-05-25T01:24:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14045#issuecomment-175652",
    "user": "tscrim"
}
```

Looks good to me. Thanks Simon.



---

archive/issue_comments_175653.json:
```json
{
    "body": "Note that a failing plugin is not necessarily a blocker for positive review, especially if it can be explained. And more on topic, a big +1 to this change.",
    "created_at": "2013-05-25T05:31:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14045#issuecomment-175653",
    "user": "robertwb"
}
```

Note that a failing plugin is not necessarily a blocker for positive review, especially if it can be explained. And more on topic, a big +1 to this change.



---

archive/issue_comments_175654.json:
```json
{
    "body": "The PDF documentation doesn't build:\n\n```\n! Missing { inserted.\n<to be read again> \n                   $\nl.15158 $_an_element_$ \n                       for the parent. But now, the following example works:\n?\n! Emergency stop.\n<to be read again> \n                   $\nl.15158 $_an_element_$ \n                       for the parent. But now, the following example works:\n!  ==> Fatal error occurred, no output PDF file produced!\n```\n",
    "created_at": "2013-05-27T11:24:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14045#issuecomment-175654",
    "user": "jdemeyer"
}
```

The PDF documentation doesn't build:

```
! Missing { inserted.
<to be read again> 
                   $
l.15158 $_an_element_$ 
                       for the parent. But now, the following example works:
?
! Emergency stop.
<to be read again> 
                   $
l.15158 $_an_element_$ 
                       for the parent. But now, the following example works:
!  ==> Fatal error occurred, no output PDF file produced!
```




---

archive/issue_comments_175655.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2013-05-27T11:24:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14045#issuecomment-175655",
    "user": "jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_175656.json:
```json
{
    "body": "Combined patch",
    "created_at": "2013-05-27T12:18:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14045#issuecomment-175656",
    "user": "SimonKing"
}
```

Combined patch



---

archive/issue_comments_175657.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2013-05-27T12:20:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14045#issuecomment-175657",
    "user": "SimonKing"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_175658.json:
```json
{
    "body": "Attachment\n\nI hope double back ticks do the trick (I only changed single into double back tick, so, I hope I can directly revert to \"positive_review\")\n\nApply trac_14249-coercion_without_an_element.patch",
    "created_at": "2013-05-27T12:20:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14045#issuecomment-175658",
    "user": "SimonKing"
}
```

Attachment

I hope double back ticks do the trick (I only changed single into double back tick, so, I hope I can directly revert to "positive_review")

Apply trac_14249-coercion_without_an_element.patch



---

archive/issue_comments_175659.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-05-29T07:09:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14045",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14045#issuecomment-175659",
    "user": "jdemeyer"
}
```

Resolution: fixed
