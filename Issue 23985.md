# Issue 23985: py3: simplified string conversion utilities

archive/issues_023985.json:
```json
{
    "body": "CC:  chapoton jdemeyer\n\nA possible alternative to #24186, implementing simple conversion from C `char` arrays or `bytes` objects to `str` objects, and of `str` objects to `bytes` objects.  Here \"`str`\" and \"`bytes`\" are to be read exactly for either Python 2 or Python 3, so on Python 2 this means no conversion is performed since `str is bytes == True`.\n\nOne thing this does not do is implement any kind of conversion from Python 2 `unicode` objects to `bytes`.  This functionality might be worth adding, in some form, to `str_to_bytes`.  But this would add a *new* feature on Python 2, whereas for now I'm only trying to preserve the existing functionality on Python 2 exactly, while transparently supporting Python 3 `str`s everywhere that Python 2 `str`s are supported.\n\nIssue created by migration from https://trac.sagemath.org/ticket/24222\n\n",
    "created_at": "2017-11-16T11:38:13Z",
    "labels": [
        "python3",
        "major",
        "bug"
    ],
    "title": "py3: simplified string conversion utilities",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23985",
    "user": "embray"
}
```
CC:  chapoton jdemeyer

A possible alternative to #24186, implementing simple conversion from C `char` arrays or `bytes` objects to `str` objects, and of `str` objects to `bytes` objects.  Here "`str`" and "`bytes`" are to be read exactly for either Python 2 or Python 3, so on Python 2 this means no conversion is performed since `str is bytes == True`.

One thing this does not do is implement any kind of conversion from Python 2 `unicode` objects to `bytes`.  This functionality might be worth adding, in some form, to `str_to_bytes`.  But this would add a *new* feature on Python 2, whereas for now I'm only trying to preserve the existing functionality on Python 2 exactly, while transparently supporting Python 3 `str`s everywhere that Python 2 `str`s are supported.

Issue created by migration from https://trac.sagemath.org/ticket/24222





---

archive/issue_comments_336055.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-11-16T11:38:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336055",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_336056.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-11-16T11:44:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336056",
    "user": "embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_336057.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2017-11-16T11:59:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336057",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_336058.json:
```json
{
    "body": "OK, so now we have to discuss encodings... first of all, I really don't like the `encoding` argument in the functions, that will just slow everything down. Better pick one (or a few) good encoding(s) and use those.\n\nI don't see why you would pick `locale.getpreferredencoding()` as default encoding. Relevant encodings should be:\n\n1. `ascii`. In many cases we know that output from a C library is an ASCII string (for example, the string representation of a number). Luckily, ASCII is compatible with most other encodings, so this isn't an issue.\n\n2. `filesystemencoding`. This is the encoding that Python internally uses for most conversions `char*` <-> `str`. For this reason, I think that this is the most important use case and it should be the default when in doubt.\n\n3. `utf-8`. This is good if you just want to store `unicode` as `char*` (say, an internal user-specified name for something) and you don't care about the exact encoding but you do care that round-trip conversion works properly.\n\n4. `locale.getpreferredencoding()`. I believe that this is mainly relevant for subprocesses, provided that those subprocesses also look at the encoding.\n\nFor efficiency, I would rather have several sets of functions, each with a hard-coded encoding.\n\nI would also suggest to implement these functions (or at least the functions where you care about performance) as `cdef inline` functions in the `.pxd` file. That way, they will actually be inlined when calling them from an external Cython module.",
    "created_at": "2017-11-16T11:59:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336058",
    "user": "jdemeyer"
}
```

OK, so now we have to discuss encodings... first of all, I really don't like the `encoding` argument in the functions, that will just slow everything down. Better pick one (or a few) good encoding(s) and use those.

I don't see why you would pick `locale.getpreferredencoding()` as default encoding. Relevant encodings should be:

1. `ascii`. In many cases we know that output from a C library is an ASCII string (for example, the string representation of a number). Luckily, ASCII is compatible with most other encodings, so this isn't an issue.

2. `filesystemencoding`. This is the encoding that Python internally uses for most conversions `char*` <-> `str`. For this reason, I think that this is the most important use case and it should be the default when in doubt.

3. `utf-8`. This is good if you just want to store `unicode` as `char*` (say, an internal user-specified name for something) and you don't care about the exact encoding but you do care that round-trip conversion works properly.

4. `locale.getpreferredencoding()`. I believe that this is mainly relevant for subprocesses, provided that those subprocesses also look at the encoding.

For efficiency, I would rather have several sets of functions, each with a hard-coded encoding.

I would also suggest to implement these functions (or at least the functions where you care about performance) as `cdef inline` functions in the `.pxd` file. That way, they will actually be inlined when calling them from an external Cython module.



---

archive/issue_comments_336059.json:
```json
{
    "body": "You don't need `six.PY2`. You can just replace\n\n```\nif six.PY2:\n    from cpython.string cimport PyString_FromString\nelse:\n    from cpython.bytes cimport PyBytes_FromString as PyString_FromString\n```\n\nby\n\n```\nfrom cpython.bytes cimport PyBytes_FromString as PyString_FromString\n```\n\nYou could also just use `PyBytes_FromString` in the code.",
    "created_at": "2017-11-16T12:03:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336059",
    "user": "jdemeyer"
}
```

You don't need `six.PY2`. You can just replace

```
if six.PY2:
    from cpython.string cimport PyString_FromString
else:
    from cpython.bytes cimport PyBytes_FromString as PyString_FromString
```

by

```
from cpython.bytes cimport PyBytes_FromString as PyString_FromString
```

You could also just use `PyBytes_FromString` in the code.



---

archive/issue_comments_336060.json:
```json
{
    "body": "Replying to [comment:4 jdemeyer]:\n> You don't need `six.PY2`. You can just replace\n\nThat's what I thought originally too, but I was having some problems trying to do it as a one-liner.  I'll try your suggestion though and double-check whether it works.",
    "created_at": "2017-11-16T12:31:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336060",
    "user": "embray"
}
```

Replying to [comment:4 jdemeyer]:
> You don't need `six.PY2`. You can just replace

That's what I thought originally too, but I was having some problems trying to do it as a one-liner.  I'll try your suggestion though and double-check whether it works.



---

archive/issue_comments_336061.json:
```json
{
    "body": "I don't think the \"encoding\" argument slows anything down by any significant amount, especially in cases where it isn't used.  I'd be amenable to encoding-specific functions for some cases, as Python has those as well in its API.  But right now I'm really trying to avoid breadth of API surface.  It *is* good to have generic versions of these functions that accept any encoding, and this is the bare minimum needed to get Python 3 support off the ground.  I think that later we can encoding-specific functions where *specific* use cases for them can be demonstrated.  I don't want to get into the weeds with this right now.\n\nAs for the default encoding, `locale.getpreferredencoding()` makes more sense.  `sys.getfilesystemencoding()` is specifically about guessing (more or less) what encoding the filesystem *specifically* is using for encoding e.g. of filenames, and has nothing to do with encodings of file contents or of arbitrary strings output by software.  (Well, that's not exactly true since on *nix the two are essentially the same, although the former can change if the process's locale is changed, I think).\n\nSo on *NIX platforms like we care about the most it's actually *mostly* a moot point.  But a lot of the software Sage interfaces with is locale-aware, so it's better to take that into account as the default than not.",
    "created_at": "2017-11-16T12:48:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336061",
    "user": "embray"
}
```

I don't think the "encoding" argument slows anything down by any significant amount, especially in cases where it isn't used.  I'd be amenable to encoding-specific functions for some cases, as Python has those as well in its API.  But right now I'm really trying to avoid breadth of API surface.  It *is* good to have generic versions of these functions that accept any encoding, and this is the bare minimum needed to get Python 3 support off the ground.  I think that later we can encoding-specific functions where *specific* use cases for them can be demonstrated.  I don't want to get into the weeds with this right now.

As for the default encoding, `locale.getpreferredencoding()` makes more sense.  `sys.getfilesystemencoding()` is specifically about guessing (more or less) what encoding the filesystem *specifically* is using for encoding e.g. of filenames, and has nothing to do with encodings of file contents or of arbitrary strings output by software.  (Well, that's not exactly true since on *nix the two are essentially the same, although the former can change if the process's locale is changed, I think).

So on *NIX platforms like we care about the most it's actually *mostly* a moot point.  But a lot of the software Sage interfaces with is locale-aware, so it's better to take that into account as the default than not.



---

archive/issue_comments_336062.json:
```json
{
    "body": "> I would also suggest to implement these functions (or at least the functions where you care about performance) as cdef inline functions in the .pxd file.\n\nI was wondering about that.  But in that case the `.pyx` file will be empty (does it even need to exist at all)?  What about the default encoding variables?",
    "created_at": "2017-11-16T12:50:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336062",
    "user": "embray"
}
```

> I would also suggest to implement these functions (or at least the functions where you care about performance) as cdef inline functions in the .pxd file.

I was wondering about that.  But in that case the `.pyx` file will be empty (does it even need to exist at all)?  What about the default encoding variables?



---

archive/issue_comments_336063.json:
```json
{
    "body": "Maybe the best solution would be to not have a default encoding and require users to think what encoding they want?",
    "created_at": "2017-11-16T12:57:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336063",
    "user": "jdemeyer"
}
```

Maybe the best solution would be to not have a default encoding and require users to think what encoding they want?



---

archive/issue_comments_336064.json:
```json
{
    "body": "Replying to [comment:6 embray]:\n> I don't think the \"encoding\" argument slows anything down by any significant amount\n\nThe Python 3 C API has specific functions to encode/decode for certainly particular encodings:\n* https://docs.python.org/3/c-api/unicode.html#utf-8-codecs\n* https://docs.python.org/3/c-api/unicode.html#locale-encoding\n* https://docs.python.org/3/c-api/unicode.html#file-system-encoding\n\nI haven't profiled, but I would hope that these are faster than the generic API.",
    "created_at": "2017-11-16T13:40:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336064",
    "user": "jdemeyer"
}
```

Replying to [comment:6 embray]:
> I don't think the "encoding" argument slows anything down by any significant amount

The Python 3 C API has specific functions to encode/decode for certainly particular encodings:
* https://docs.python.org/3/c-api/unicode.html#utf-8-codecs
* https://docs.python.org/3/c-api/unicode.html#locale-encoding
* https://docs.python.org/3/c-api/unicode.html#file-system-encoding

I haven't profiled, but I would hope that these are faster than the generic API.



---

archive/issue_comments_336065.json:
```json
{
    "body": "Replying to [comment:7 embray]:\n> But in that case the `.pyx` file will be empty (does it even need to exist at all)?\n\nIt doesn't need to exist.\n\n> What about the default encoding variables?\n\nI propose to remove those variables anyway. If you *do* need them for some reason, they must be in the `.pyx` file.",
    "created_at": "2017-11-16T13:42:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336065",
    "user": "jdemeyer"
}
```

Replying to [comment:7 embray]:
> But in that case the `.pyx` file will be empty (does it even need to exist at all)?

It doesn't need to exist.

> What about the default encoding variables?

I propose to remove those variables anyway. If you *do* need them for some reason, they must be in the `.pyx` file.



---

archive/issue_comments_336066.json:
```json
{
    "body": "Two more things:\n\n1. it is safer to use the Cython-compile-time constant `PY_VERSION_HEX` instead of the C-compile-time constant `PY_MAJOR_VERSION`. It is dubious C code to write something like\n\n```\nif (0)\n    nonexisting_function()\n```\n\nwhen `nonexisting_function()` doesn't actually exist like `PyUnicode_AsUTF8` on Python 2. The only reason that the above code compiles is compiler optimization.\n\nSee also #24215 for Cython-compile-time constants in general.\n\n2. Could you move this to `sage/cpython/string.pxd`? I recently created the `sage/cpython` directory to deal with low-level Python internals and I think that these functions would fit there.",
    "created_at": "2017-11-16T13:51:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336066",
    "user": "jdemeyer"
}
```

Two more things:

1. it is safer to use the Cython-compile-time constant `PY_VERSION_HEX` instead of the C-compile-time constant `PY_MAJOR_VERSION`. It is dubious C code to write something like

```
if (0)
    nonexisting_function()
```

when `nonexisting_function()` doesn't actually exist like `PyUnicode_AsUTF8` on Python 2. The only reason that the above code compiles is compiler optimization.

See also #24215 for Cython-compile-time constants in general.

2. Could you move this to `sage/cpython/string.pxd`? I recently created the `sage/cpython` directory to deal with low-level Python internals and I think that these functions would fit there.



---

archive/issue_comments_336067.json:
```json
{
    "body": "fails to build, see patchbot report:\n\n```\nfrom string import Template\n```\n",
    "created_at": "2017-11-16T15:16:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336067",
    "user": "chapoton"
}
```

fails to build, see patchbot report:

```
from string import Template
```




---

archive/issue_comments_336068.json:
```json
{
    "body": "oh, I see. Name conflict between the global \"string\" module and the local \"string\" module..",
    "created_at": "2017-11-16T15:20:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336068",
    "user": "chapoton"
}
```

oh, I see. Name conflict between the global "string" module and the local "string" module..



---

archive/issue_comments_336069.json:
```json
{
    "body": "Replying to [comment:8 jdemeyer]:\n> Maybe the best solution would be to not have a default encoding and require users to think what encoding they want?\n\nThat's far too onerous and anxiety-provoking for the user :)  Python itself uses default encodings all over the place when in doubt (hence e.g. [PyUnicode_DecodeFSDefault](https://docs.python.org/3/c-api/unicode.html#c.PyUnicode_DecodeFSDefault)).  It's an unfortunate fact that there's isn't always one \"right answer\" here; the best we can do is provide sensible defaults *and* the ability for user-specified encoding where applicable; that is, where we know we want a specific encoding.  Moving forward we can also do more, for example, to ensure that any locale-aware code run by Sage is handled well.\n\nI could definitely agree to adding more encoding-specific helper functions, especially for ASCII and UTF-8.  But as a first pass, for the sake of getting Python 3 support off the ground, I'd prefer to leave this as is and then make adjustments as specific use cases arise.  It will be difficult to even find those specific use cases until and unless we get further along on getting Python 3 working in general (with these functions, plus a few other fixes I'll be posting soon, I've gotten the Sage doctest runner working, so that will help expose a lot of interesting cases *quickly*).\n\nI'll look at the rest of your suggestions; they seem reasonable.",
    "created_at": "2017-11-17T14:22:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336069",
    "user": "embray"
}
```

Replying to [comment:8 jdemeyer]:
> Maybe the best solution would be to not have a default encoding and require users to think what encoding they want?

That's far too onerous and anxiety-provoking for the user :)  Python itself uses default encodings all over the place when in doubt (hence e.g. [PyUnicode_DecodeFSDefault](https://docs.python.org/3/c-api/unicode.html#c.PyUnicode_DecodeFSDefault)).  It's an unfortunate fact that there's isn't always one "right answer" here; the best we can do is provide sensible defaults *and* the ability for user-specified encoding where applicable; that is, where we know we want a specific encoding.  Moving forward we can also do more, for example, to ensure that any locale-aware code run by Sage is handled well.

I could definitely agree to adding more encoding-specific helper functions, especially for ASCII and UTF-8.  But as a first pass, for the sake of getting Python 3 support off the ground, I'd prefer to leave this as is and then make adjustments as specific use cases arise.  It will be difficult to even find those specific use cases until and unless we get further along on getting Python 3 working in general (with these functions, plus a few other fixes I'll be posting soon, I've gotten the Sage doctest runner working, so that will help expose a lot of interesting cases *quickly*).

I'll look at the rest of your suggestions; they seem reasonable.



---

archive/issue_comments_336070.json:
```json
{
    "body": "Replying to [comment:11 jdemeyer]:\n> Two more things:\n> \n> 1. it is safer to use the Cython-compile-time constant `PY_VERSION_HEX` instead of the C-compile-time constant `PY_MAJOR_VERSION`. It is dubious C code to write something like\n\nAh, I was actually really looking for something like this but I couldn't find it anywhere in the Cython documentation.  Am I just blind?",
    "created_at": "2017-11-17T14:22:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336070",
    "user": "embray"
}
```

Replying to [comment:11 jdemeyer]:
> Two more things:
> 
> 1. it is safer to use the Cython-compile-time constant `PY_VERSION_HEX` instead of the C-compile-time constant `PY_MAJOR_VERSION`. It is dubious C code to write something like

Ah, I was actually really looking for something like this but I couldn't find it anywhere in the Cython documentation.  Am I just blind?



---

archive/issue_comments_336071.json:
```json
{
    "body": "Replying to [comment:15 embray]:\n> Replying to [comment:11 jdemeyer]:\n> > Two more things:\n> > \n> > 1. it is safer to use the Cython-compile-time constant `PY_VERSION_HEX` instead of the C-compile-time constant `PY_MAJOR_VERSION`. It is dubious C code to write something like\n> \n> Ah, I was actually really looking for something like this but I couldn't find it anywhere in the Cython documentation.  Am I just blind?\n\nNevermind; I see now that we explicitly pass that in to `cythonize` in the `setup.py`.  For that matter, any reason not to add simply `PY2` and `PY3` compile-time constants?  Comparing against `PY_VERSION_HEX` is a little annoying.",
    "created_at": "2017-11-17T14:26:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336071",
    "user": "embray"
}
```

Replying to [comment:15 embray]:
> Replying to [comment:11 jdemeyer]:
> > Two more things:
> > 
> > 1. it is safer to use the Cython-compile-time constant `PY_VERSION_HEX` instead of the C-compile-time constant `PY_MAJOR_VERSION`. It is dubious C code to write something like
> 
> Ah, I was actually really looking for something like this but I couldn't find it anywhere in the Cython documentation.  Am I just blind?

Nevermind; I see now that we explicitly pass that in to `cythonize` in the `setup.py`.  For that matter, any reason not to add simply `PY2` and `PY3` compile-time constants?  Comparing against `PY_VERSION_HEX` is a little annoying.



---

archive/issue_comments_336072.json:
```json
{
    "body": ">It will be difficult to even find those specific use cases until and unless we get >further along on getting Python 3 working in general (with these functions, plus a >few other fixes I'll be posting soon, I've gotten the Sage doctest runner working, so >that will help expose a lot of interesting cases *quickly*).\n> \n\nThis sounds great ! I was hoping that the doctest framework could be made to work at some point, but was not expecting it soon.",
    "created_at": "2017-11-17T14:57:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336072",
    "user": "chapoton"
}
```

>It will be difficult to even find those specific use cases until and unless we get >further along on getting Python 3 working in general (with these functions, plus a >few other fixes I'll be posting soon, I've gotten the Sage doctest runner working, so >that will help expose a lot of interesting cases *quickly*).
> 

This sounds great ! I was hoping that the doctest framework could be made to work at some point, but was not expecting it soon.



---

archive/issue_comments_336073.json:
```json
{
    "body": "Replying to [comment:17 chapoton]:\n> >It will be difficult to even find those specific use cases until and unless we get >further along on getting Python 3 working in general (with these functions, plus a >few other fixes I'll be posting soon, I've gotten the Sage doctest runner working, so >that will help expose a lot of interesting cases *quickly*).\n> > \n> \n> This sounds great ! I was hoping that the doctest framework could be made to work at some point, but was not expecting it soon.\n\nI had to get it working, in part, so that I could run the doctests for this module :)\n\nI think it will help things go much faster.",
    "created_at": "2017-11-17T15:09:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336073",
    "user": "embray"
}
```

Replying to [comment:17 chapoton]:
> >It will be difficult to even find those specific use cases until and unless we get >further along on getting Python 3 working in general (with these functions, plus a >few other fixes I'll be posting soon, I've gotten the Sage doctest runner working, so >that will help expose a lot of interesting cases *quickly*).
> > 
> 
> This sounds great ! I was hoping that the doctest framework could be made to work at some point, but was not expecting it soon.

I had to get it working, in part, so that I could run the doctests for this module :)

I think it will help things go much faster.



---

archive/issue_comments_336074.json:
```json
{
    "body": "I'm seeing now how wanting to have module-level global variables in conjunction with inline `c(p)def` functions in Cython gets problematic.  It just compiles them as `__Pyx_GetModuleGlobalName(name)`.  I feel like this should be a bug (I *think* not too difficult to fix?) in Cython, since it's really counter to how Python should work in this case.\n\nFor functions inlined from another module--at least if those functions access global variables from their original module--it should import that module during module initialization and use the correct module dict for globals lookups (just as normal Python functions do, basically).\n\nThat's an issue beyond this one though, so I'll rework things for now to get rid use of the global variables by these functions (I still want to have default encodings though).",
    "created_at": "2017-11-17T15:33:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336074",
    "user": "embray"
}
```

I'm seeing now how wanting to have module-level global variables in conjunction with inline `c(p)def` functions in Cython gets problematic.  It just compiles them as `__Pyx_GetModuleGlobalName(name)`.  I feel like this should be a bug (I *think* not too difficult to fix?) in Cython, since it's really counter to how Python should work in this case.

For functions inlined from another module--at least if those functions access global variables from their original module--it should import that module during module initialization and use the correct module dict for globals lookups (just as normal Python functions do, basically).

That's an issue beyond this one though, so I'll rework things for now to get rid use of the global variables by these functions (I still want to have default encodings though).



---

archive/issue_comments_336075.json:
```json
{
    "body": "So it turns out `PyUnicode_AsEncodedString` and `PyUnicode_Decode` do allow the `encoding` argument to be `NULL`, in which case they default to UTF-8.  So if it's a good enough default for Python maybe it's a good enough default for us, for now.\n\nPerhaps I'll just stick with that functionality, and take care to use things like `locale.getpreferredencoding()` when necessary, such as interfacing with external software.  To that end it would be good to come up with some list of exactly what software Sage interfaces with *is* locale aware.  Certainly ECL and GAP are strong candidates; probably others.  It will be good to add some tests to that effect but we can worry about it when we come to it.",
    "created_at": "2017-11-17T16:37:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336075",
    "user": "embray"
}
```

So it turns out `PyUnicode_AsEncodedString` and `PyUnicode_Decode` do allow the `encoding` argument to be `NULL`, in which case they default to UTF-8.  So if it's a good enough default for Python maybe it's a good enough default for us, for now.

Perhaps I'll just stick with that functionality, and take care to use things like `locale.getpreferredencoding()` when necessary, such as interfacing with external software.  To that end it would be good to come up with some list of exactly what software Sage interfaces with *is* locale aware.  Certainly ECL and GAP are strong candidates; probably others.  It will be good to add some tests to that effect but we can worry about it when we come to it.



---

archive/issue_comments_336076.json:
```json
{
    "body": "Replying to [comment:14 embray]:\n> Python itself uses default encodings all over the place when in doubt\n\nRight, but there are several defaults (each of UTF-8, `sys.getfilesystemencoding()` and `locale.getpreferredencoding()` could be considered as defaults). And I don't think that any of those 3 has the large majority. So I still feel that forcing the user to pick one is the best solution.",
    "created_at": "2017-11-17T16:56:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336076",
    "user": "jdemeyer"
}
```

Replying to [comment:14 embray]:
> Python itself uses default encodings all over the place when in doubt

Right, but there are several defaults (each of UTF-8, `sys.getfilesystemencoding()` and `locale.getpreferredencoding()` could be considered as defaults). And I don't think that any of those 3 has the large majority. So I still feel that forcing the user to pick one is the best solution.



---

archive/issue_comments_336077.json:
```json
{
    "body": "Also, I feel that error handling should be different for the different cases: if you are communicating with locale-aware software using `locale.getpreferredencoding()` you probably want decoding errors to be actual errors. With the file system encoding on the other hand, `surrogateescape` is typically a better default.",
    "created_at": "2017-11-17T17:03:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336077",
    "user": "jdemeyer"
}
```

Also, I feel that error handling should be different for the different cases: if you are communicating with locale-aware software using `locale.getpreferredencoding()` you probably want decoding errors to be actual errors. With the file system encoding on the other hand, `surrogateescape` is typically a better default.



---

archive/issue_comments_336078.json:
```json
{
    "body": "Replying to [comment:16 embray]:\n> For that matter, any reason not to add simply `PY2` and `PY3` compile-time constants?  Comparing against `PY_VERSION_HEX` is a little annoying.\n\nNo problem for me, although I would prefer `PY_MAJOR_VERSION` then. If you want to do that, please make a new ticket and make it depend on #24215 please.",
    "created_at": "2017-11-17T17:14:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336078",
    "user": "jdemeyer"
}
```

Replying to [comment:16 embray]:
> For that matter, any reason not to add simply `PY2` and `PY3` compile-time constants?  Comparing against `PY_VERSION_HEX` is a little annoying.

No problem for me, although I would prefer `PY_MAJOR_VERSION` then. If you want to do that, please make a new ticket and make it depend on #24215 please.



---

archive/issue_comments_336079.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-11-20T08:31:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336079",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_336080.json:
```json
{
    "body": "Replying to [comment:23 jdemeyer]:\n> Replying to [comment:16 embray]:\n> > For that matter, any reason not to add simply `PY2` and `PY3` compile-time constants?  Comparing against `PY_VERSION_HEX` is a little annoying.\n> \n> No problem for me, although I would prefer `PY_MAJOR_VERSION` then. If you want to do that, please make a new ticket and make it depend on #24215 please.\n\nOkay hold on...",
    "created_at": "2017-11-20T08:36:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336080",
    "user": "embray"
}
```

Replying to [comment:23 jdemeyer]:
> Replying to [comment:16 embray]:
> > For that matter, any reason not to add simply `PY2` and `PY3` compile-time constants?  Comparing against `PY_VERSION_HEX` is a little annoying.
> 
> No problem for me, although I would prefer `PY_MAJOR_VERSION` then. If you want to do that, please make a new ticket and make it depend on #24215 please.

Okay hold on...



---

archive/issue_comments_336081.json:
```json
{
    "body": "Replying to [comment:22 jdemeyer]:\n> Also, I feel that error handling should be different for the different cases: if you are communicating with locale-aware software using `locale.getpreferredencoding()` you probably want decoding errors to be actual errors. With the file system encoding on the other hand, `surrogateescape` is typically a better default.\n\nYeah, I'm inclined to agree here--I think I'll change that.  But in that case I'd also want an optional argument for error handling.",
    "created_at": "2017-11-20T08:39:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336081",
    "user": "embray"
}
```

Replying to [comment:22 jdemeyer]:
> Also, I feel that error handling should be different for the different cases: if you are communicating with locale-aware software using `locale.getpreferredencoding()` you probably want decoding errors to be actual errors. With the file system encoding on the other hand, `surrogateescape` is typically a better default.

Yeah, I'm inclined to agree here--I think I'll change that.  But in that case I'd also want an optional argument for error handling.



---

archive/issue_comments_336082.json:
```json
{
    "body": "Replying to [comment:12 chapoton]:\n> fails to build, see patchbot report:\n> {{{\n> from string import Template\n> }}}\n\nFixed in #24242.",
    "created_at": "2017-11-20T08:42:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336082",
    "user": "jdemeyer"
}
```

Replying to [comment:12 chapoton]:
> fails to build, see patchbot report:
> {{{
> from string import Template
> }}}

Fixed in #24242.



---

archive/issue_comments_336083.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-20T09:06:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336083",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_336084.json:
```json
{
    "body": "I'm pretty happy with this now as-is.  I'm up for minor tweaking but would prefer not to make any other major changes to how this works, for now, since it's proving pretty useful in getting other code working.\n\nI'd be up for adding additional shortcut functions for certain special cases if they come up often enough--we'll see.\n\n(Also, it turns out if you put `cpdef` function definitions into a `.pxd` file it won't generate a module for them unless you also have a corresponding `.pyx` file, even if it's empty--annoying.  That said, it's useful to have a shortcut for `sys.getfilesystemencoding()` which is annoying to write :)",
    "created_at": "2017-11-20T09:14:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336084",
    "user": "embray"
}
```

I'm pretty happy with this now as-is.  I'm up for minor tweaking but would prefer not to make any other major changes to how this works, for now, since it's proving pretty useful in getting other code working.

I'd be up for adding additional shortcut functions for certain special cases if they come up often enough--we'll see.

(Also, it turns out if you put `cpdef` function definitions into a `.pxd` file it won't generate a module for them unless you also have a corresponding `.pyx` file, even if it's empty--annoying.  That said, it's useful to have a shortcut for `sys.getfilesystemencoding()` which is annoying to write :)



---

archive/issue_comments_336085.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2017-11-20T09:14:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336085",
    "user": "embray"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_336086.json:
```json
{
    "body": "I have just noticed that we use a similar kind of function \"from sagenb.misc.misc import encoded_str\" in src/sage/misc/latex.py..",
    "created_at": "2017-11-20T15:17:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336086",
    "user": "chapoton"
}
```

I have just noticed that we use a similar kind of function "from sagenb.misc.misc import encoded_str" in src/sage/misc/latex.py..



---

archive/issue_comments_336087.json:
```json
{
    "body": "If you want to pass `encoding` and `errors` arguments, can you pass them as the C type `const char*`? That avoids needless slow manipulation of Python objects.",
    "created_at": "2017-11-20T17:25:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336087",
    "user": "jdemeyer"
}
```

If you want to pass `encoding` and `errors` arguments, can you pass them as the C type `const char*`? That avoids needless slow manipulation of Python objects.



---

archive/issue_comments_336088.json:
```json
{
    "body": "Replying to [comment:29 embray]:\n> since it's proving pretty useful in getting other code working.\n\nIf you have such use cases, I'd love to see them.\n\nI'm not yet convinced that we should use `locale.getpreferredencoding()` as default. Since this is just a preliminary interface, why can't we *require* an encoding argument until we have a clearer idea that most Unicode conversions are indeed using `locale.getpreferredencoding`?",
    "created_at": "2017-11-20T17:28:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336088",
    "user": "jdemeyer"
}
```

Replying to [comment:29 embray]:
> since it's proving pretty useful in getting other code working.

If you have such use cases, I'd love to see them.

I'm not yet convinced that we should use `locale.getpreferredencoding()` as default. Since this is just a preliminary interface, why can't we *require* an encoding argument until we have a clearer idea that most Unicode conversions are indeed using `locale.getpreferredencoding`?



---

archive/issue_comments_336089.json:
```json
{
    "body": "The code is a bit inconsistent in how it checks that the input has the correct type, for example passing non-bytes to `bytes_to_str()`. In any case, I would drop the typing on the argument (`bytes b` -> `b`). If you want checks, make them explicit by using checked casts (`<str?>` instead of `<str>`).",
    "created_at": "2017-11-20T17:37:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336089",
    "user": "jdemeyer"
}
```

The code is a bit inconsistent in how it checks that the input has the correct type, for example passing non-bytes to `bytes_to_str()`. In any case, I would drop the typing on the argument (`bytes b` -> `b`). If you want checks, make them explicit by using checked casts (`<str?>` instead of `<str>`).



---

archive/issue_comments_336090.json:
```json
{
    "body": "Replying to [comment:32 jdemeyer]:\n> Replying to [comment:29 embray]:\n> > since it's proving pretty useful in getting other code working.\n> \n> If you have such use cases, I'd love to see them.\n\nNever mind, I just noticed #24223.",
    "created_at": "2017-11-20T19:16:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336090",
    "user": "jdemeyer"
}
```

Replying to [comment:32 jdemeyer]:
> Replying to [comment:29 embray]:
> > since it's proving pretty useful in getting other code working.
> 
> If you have such use cases, I'd love to see them.

Never mind, I just noticed #24223.



---

archive/issue_comments_336091.json:
```json
{
    "body": "Replying to [comment:31 jdemeyer]:\n> If you want to pass `encoding` and `errors` arguments, can you pass them as the C type `const char*`? That avoids needless slow manipulation of Python objects.\n\nDoesn't that mean that from Python you'd have to pass those arguments in as `bytes` then?\n\nLet's please not get too hung up about micro-optimization here.  Compared to actual string decoding (except in some trivial cases) this kind of point is pretty trivial.",
    "created_at": "2017-11-22T14:08:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336091",
    "user": "embray"
}
```

Replying to [comment:31 jdemeyer]:
> If you want to pass `encoding` and `errors` arguments, can you pass them as the C type `const char*`? That avoids needless slow manipulation of Python objects.

Doesn't that mean that from Python you'd have to pass those arguments in as `bytes` then?

Let's please not get too hung up about micro-optimization here.  Compared to actual string decoding (except in some trivial cases) this kind of point is pretty trivial.



---

archive/issue_comments_336092.json:
```json
{
    "body": "Replying to [comment:32 jdemeyer]:\n> I'm not yet convinced that we should use `locale.getpreferredencoding()` as default. Since this is just a preliminary interface, why can't we *require* an encoding argument until we have a clearer idea that most Unicode conversions are indeed using `locale.getpreferredencoding`?\n\nNo, for exactly the reason that in all cases it's not clear what the best choice is.  Anyways the end result is going to be everyone just writing \"utf-8\" everywhere which I'd prefer to avoid.  I'd like to see how far we get with a sensible default for now.  There are some cases where it's definitely good to specify an encoding--for example all files written by sage can be encoded utf-8 in general.  In general that's not the case though.",
    "created_at": "2017-11-22T14:11:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336092",
    "user": "embray"
}
```

Replying to [comment:32 jdemeyer]:
> I'm not yet convinced that we should use `locale.getpreferredencoding()` as default. Since this is just a preliminary interface, why can't we *require* an encoding argument until we have a clearer idea that most Unicode conversions are indeed using `locale.getpreferredencoding`?

No, for exactly the reason that in all cases it's not clear what the best choice is.  Anyways the end result is going to be everyone just writing "utf-8" everywhere which I'd prefer to avoid.  I'd like to see how far we get with a sensible default for now.  There are some cases where it's definitely good to specify an encoding--for example all files written by sage can be encoded utf-8 in general.  In general that's not the case though.



---

archive/issue_comments_336093.json:
```json
{
    "body": "Replying to [comment:33 jdemeyer]:\n> The code is a bit inconsistent in how it checks that the input has the correct type, for example passing non-bytes to `bytes_to_str()`. In any case, I would drop the typing on the argument (`bytes b` -> `b`). If you want checks, make them explicit by using checked casts (`<str?>` instead of `<str>`).\n\n\"make them explicit\" I don't know what isn't explicit about specifying the argument type?",
    "created_at": "2017-11-22T14:12:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336093",
    "user": "embray"
}
```

Replying to [comment:33 jdemeyer]:
> The code is a bit inconsistent in how it checks that the input has the correct type, for example passing non-bytes to `bytes_to_str()`. In any case, I would drop the typing on the argument (`bytes b` -> `b`). If you want checks, make them explicit by using checked casts (`<str?>` instead of `<str>`).

"make them explicit" I don't know what isn't explicit about specifying the argument type?



---

archive/issue_comments_336094.json:
```json
{
    "body": "Replying to [comment:37 embray]:\n> I don't know what isn't explicit about specifying the argument type?\n\nIt's explicit but not what you want. Cython always allows `None` to be passed as any type. If you really want `bytes` and not `None`, you need to check for it. And if you do an explicit check, there is no reason for the typing of the argument.",
    "created_at": "2017-11-22T14:21:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336094",
    "user": "jdemeyer"
}
```

Replying to [comment:37 embray]:
> I don't know what isn't explicit about specifying the argument type?

It's explicit but not what you want. Cython always allows `None` to be passed as any type. If you really want `bytes` and not `None`, you need to check for it. And if you do an explicit check, there is no reason for the typing of the argument.



---

archive/issue_comments_336095.json:
```json
{
    "body": "Replying to [comment:36 embray]:\n> Anyways the end result is going to be everyone just writing \"utf-8\" everywhere which I'd prefer to avoid.\n\nAnd now we're in a situation where everybody uses `locale.getpreferredencoding()` which is also not what you want.",
    "created_at": "2017-11-22T14:22:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336095",
    "user": "jdemeyer"
}
```

Replying to [comment:36 embray]:
> Anyways the end result is going to be everyone just writing "utf-8" everywhere which I'd prefer to avoid.

And now we're in a situation where everybody uses `locale.getpreferredencoding()` which is also not what you want.



---

archive/issue_comments_336096.json:
```json
{
    "body": "I owe you an apology... I read some Python docs and sources and it turns out that Python uses `locale.getpreferredencoding()` for more things than I thought. So with that in mind, `locale.getpreferredencoding()` might actually be a reasonable default after all.",
    "created_at": "2017-11-22T14:55:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336096",
    "user": "jdemeyer"
}
```

I owe you an apology... I read some Python docs and sources and it turns out that Python uses `locale.getpreferredencoding()` for more things than I thought. So with that in mind, `locale.getpreferredencoding()` might actually be a reasonable default after all.



---

archive/issue_comments_336097.json:
```json
{
    "body": "Replying to [comment:40 jdemeyer]:\n> I owe you an apology... I read some Python docs and sources and it turns out that Python uses `locale.getpreferredencoding()` for more things than I thought. So with that in mind, `locale.getpreferredencoding()` might actually be a reasonable default after all.\n\nThat's okay, I'm just going off experience here.  But it's a hazy topic so I don't mind having my assumptions challenged.\n\nWhat's nice about having a sensible default is that, especially starting out, one needs to use a *lot* of these and it's not always immediately obvious what to do.  It's easier to not worry about it until you know you need to (e.g. something produces some text in an encoding you weren't expecting).  The locale encoding is a good bet though since it will *typically* match what the terminal is using.",
    "created_at": "2017-11-22T15:47:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336097",
    "user": "embray"
}
```

Replying to [comment:40 jdemeyer]:
> I owe you an apology... I read some Python docs and sources and it turns out that Python uses `locale.getpreferredencoding()` for more things than I thought. So with that in mind, `locale.getpreferredencoding()` might actually be a reasonable default after all.

That's okay, I'm just going off experience here.  But it's a hazy topic so I don't mind having my assumptions challenged.

What's nice about having a sensible default is that, especially starting out, one needs to use a *lot* of these and it's not always immediately obvious what to do.  It's easier to not worry about it until you know you need to (e.g. something produces some text in an encoding you weren't expecting).  The locale encoding is a good bet though since it will *typically* match what the terminal is using.



---

archive/issue_comments_336098.json:
```json
{
    "body": "Replying to [comment:35 embray]:\n> Let's please not get too hung up about micro-optimization here.  Compared to actual string decoding (except in some trivial cases) this kind of point is pretty trivial.\n\nAnother good point: `PyUnicode_AsUTF8` caches its own representation as UTF-8 string. So the `PyUnicode_AsUTF8()` calls for `encoding` and `errors` should be fast.",
    "created_at": "2017-11-23T14:23:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336098",
    "user": "jdemeyer"
}
```

Replying to [comment:35 embray]:
> Let's please not get too hung up about micro-optimization here.  Compared to actual string decoding (except in some trivial cases) this kind of point is pretty trivial.

Another good point: `PyUnicode_AsUTF8` caches its own representation as UTF-8 string. So the `PyUnicode_AsUTF8()` calls for `encoding` and `errors` should be fast.



---

archive/issue_comments_336099.json:
```json
{
    "body": "Yes, especially since they'll likely be interned anyways.\n\nI'm still going to look into your point about argument types.",
    "created_at": "2017-11-23T15:55:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336099",
    "user": "embray"
}
```

Yes, especially since they'll likely be interned anyways.

I'm still going to look into your point about argument types.



---

archive/issue_comments_336100.json:
```json
{
    "body": "Replying to [comment:44 embray]:\n> I'm still going to look into your point about argument types.\n\nNo. I'm preparing a small reviewer patch.",
    "created_at": "2017-11-23T16:03:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336100",
    "user": "jdemeyer"
}
```

Replying to [comment:44 embray]:
> I'm still going to look into your point about argument types.

No. I'm preparing a small reviewer patch.



---

archive/issue_comments_336101.json:
```json
{
    "body": "I made some minor changes, please review.\n----\nNew commits:",
    "created_at": "2017-11-23T18:20:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336101",
    "user": "jdemeyer"
}
```

I made some minor changes, please review.
----
New commits:



---

archive/issue_comments_336102.json:
```json
{
    "body": "Note that my commit does not affect the API of these functions, so this shouldn't require any changes for tickets depending on this one.",
    "created_at": "2017-11-24T09:23:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336102",
    "user": "jdemeyer"
}
```

Note that my commit does not affect the API of these functions, so this shouldn't require any changes for tickets depending on this one.



---

archive/issue_comments_336103.json:
```json
{
    "body": "Replying to [comment:38 jdemeyer]:\n> Replying to [comment:37 embray]:\n> > I don't know what isn't explicit about specifying the argument type?\n> \n> It's explicit but not what you want. Cython always allows `None` to be passed as any type. If you really want `bytes` and not `None`, you need to check for it. And if you do an explicit check, there is no reason for the typing of the argument.\n\nI'm still not following you here.  Dropping the type specification seems to make things worse, not better.  I do see what you're saying about `None` which is weird.  I don't like that.  But specifying the argument of the type provides some compile-time static checking that's already been helpful a few times.  It's not foolproof of course because in many cases Cython can't be sure what type a Python object will be.  But in cases where it can (e.g. something \"obvious\" like `foo = b'abc'; str_to_bytes(foo)`) you get:\n\n\n```\nError compiling Cython file:\n------------------------------------------------------------\n...\n    foo = b'abc'\n    bar = str_to_bytes(foo)\n                      ^\n------------------------------------------------------------\n\nCannot convert 'bytes' object to str implicitly. This is not portable to Py3.\n```\n\n\nWhile this seems to be specific to bytes -> str, it is very useful in this case.\n\nAlso, without this type check you get much less useful errors if you pass in the wrong type.  With the type specification:\n\n\n```\n>>> str_to_bytes(b'a')\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\nTypeError: Argument 's' has incorrect type (expected str, got bytes)\n```\n\n\nWithout it\n\n\n```\n>>> str_to_bytes(b'a')\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\n  File \"sage/cpython/string.pxd\", line 70, in sage.cpython.string.str_to_bytes (build/cythonized/sage/cpython/string.c:1660)\n  File \"sage/cpython/string.pxd\", line 99, in sage.cpython.string.str_to_bytes (build/cythonized/sage/cpython/string.c:1523)\nTypeError: bad argument type for built-in operation\n```\n\n\nThis error happens to be raising from `PyUnicode_EncodeLocale`, but one wouldn't guess that just from looking at it.  It seems sloppy.\n\nOne thing I did recently run into, however, is that `str_to_bytes(str s, ...)` does not allow subclasses of `str` which is inconvenient.  Your version does seem allow `str` subclasses (and I guess likewise `bytes` subclasses for `bytes_to_str`).  It would be nice to have a middle ground between accepting subclasses, but also having better type checking.",
    "created_at": "2017-11-24T09:54:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336103",
    "user": "embray"
}
```

Replying to [comment:38 jdemeyer]:
> Replying to [comment:37 embray]:
> > I don't know what isn't explicit about specifying the argument type?
> 
> It's explicit but not what you want. Cython always allows `None` to be passed as any type. If you really want `bytes` and not `None`, you need to check for it. And if you do an explicit check, there is no reason for the typing of the argument.

I'm still not following you here.  Dropping the type specification seems to make things worse, not better.  I do see what you're saying about `None` which is weird.  I don't like that.  But specifying the argument of the type provides some compile-time static checking that's already been helpful a few times.  It's not foolproof of course because in many cases Cython can't be sure what type a Python object will be.  But in cases where it can (e.g. something "obvious" like `foo = b'abc'; str_to_bytes(foo)`) you get:


```
Error compiling Cython file:
------------------------------------------------------------
...
    foo = b'abc'
    bar = str_to_bytes(foo)
                      ^
------------------------------------------------------------

Cannot convert 'bytes' object to str implicitly. This is not portable to Py3.
```


While this seems to be specific to bytes -> str, it is very useful in this case.

Also, without this type check you get much less useful errors if you pass in the wrong type.  With the type specification:


```
>>> str_to_bytes(b'a')
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
TypeError: Argument 's' has incorrect type (expected str, got bytes)
```


Without it


```
>>> str_to_bytes(b'a')
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "sage/cpython/string.pxd", line 70, in sage.cpython.string.str_to_bytes (build/cythonized/sage/cpython/string.c:1660)
  File "sage/cpython/string.pxd", line 99, in sage.cpython.string.str_to_bytes (build/cythonized/sage/cpython/string.c:1523)
TypeError: bad argument type for built-in operation
```


This error happens to be raising from `PyUnicode_EncodeLocale`, but one wouldn't guess that just from looking at it.  It seems sloppy.

One thing I did recently run into, however, is that `str_to_bytes(str s, ...)` does not allow subclasses of `str` which is inconvenient.  Your version does seem allow `str` subclasses (and I guess likewise `bytes` subclasses for `bytes_to_str`).  It would be nice to have a middle ground between accepting subclasses, but also having better type checking.



---

archive/issue_comments_336104.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-11-24T09:54:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336104",
    "user": "embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_336105.json:
```json
{
    "body": "As you suggested earlier, using explicit type-checking casts like `PyUnicode_EncodeLocale(<str?>s, err)` gets part of the way there--it at least provides better exceptions when the wrong type is passed in.\n\nUnfortunately in the case of `str` Cython wants to use `PyString_CheckExact`, instead of some more generic check, and this disallows `str` subclasses (even though for user-defined types it will use a check that allows subclasses).  I feel like this a bug in Cython--why use `PyString_CheckExact` instead of `PyString_Check`?  The latter still does the equivalent of the former first as a special case.  This is also especially nicely optimized on Python 3 where they added a `Py_TPFLAGS_UNICODE_SUBCLASS` flag as a special case :)",
    "created_at": "2017-11-24T10:20:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336105",
    "user": "embray"
}
```

As you suggested earlier, using explicit type-checking casts like `PyUnicode_EncodeLocale(<str?>s, err)` gets part of the way there--it at least provides better exceptions when the wrong type is passed in.

Unfortunately in the case of `str` Cython wants to use `PyString_CheckExact`, instead of some more generic check, and this disallows `str` subclasses (even though for user-defined types it will use a check that allows subclasses).  I feel like this a bug in Cython--why use `PyString_CheckExact` instead of `PyString_Check`?  The latter still does the equivalent of the former first as a special case.  This is also especially nicely optimized on Python 3 where they added a `Py_TPFLAGS_UNICODE_SUBCLASS` flag as a special case :)



---

archive/issue_comments_336106.json:
```json
{
    "body": "Replying to [comment:50 embray]:\n> I feel like this a bug in Cython--why use `PyString_CheckExact` instead of `PyString_Check`?\n\nFeature, not a bug :-)\n\nCython uses this typing as an *optimization* tool, not as a *checking* tool. It happens to do some checking (like assigning `cdef str x = []` will fail) but that is just to avoid segfaults. For certain builtin types, Cython accesses the internals of those types. But accessing those internals is only valid for the exact type, it might not be valid for subtypes.",
    "created_at": "2017-11-24T10:35:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336106",
    "user": "jdemeyer"
}
```

Replying to [comment:50 embray]:
> I feel like this a bug in Cython--why use `PyString_CheckExact` instead of `PyString_Check`?

Feature, not a bug :-)

Cython uses this typing as an *optimization* tool, not as a *checking* tool. It happens to do some checking (like assigning `cdef str x = []` will fail) but that is just to avoid segfaults. For certain builtin types, Cython accesses the internals of those types. But accessing those internals is only valid for the exact type, it might not be valid for subtypes.



---

archive/issue_comments_336107.json:
```json
{
    "body": "Replying to [comment:51 jdemeyer]:\n> Replying to [comment:50 embray]:\n> > I feel like this a bug in Cython--why use `PyString_CheckExact` instead of `PyString_Check`?\n> \n> Feature, not a bug :-)\n\nYep, I just confirmed this myself--although it doesn't really make this explicit the way the code is written definitely implies that it's intentional.\n\n> Cython uses this typing as an *optimization* tool, not as a *checking* tool. It happens to do some checking (like assigning `cdef str x = []` will fail) but that is just to avoid segfaults. For certain builtin types, Cython accesses the internals of those types. But accessing those internals is only valid for the exact type, it might not be valid for subtypes.\n\nRight.  It depends.  I feel like one should be able to ask for allowing subtypes explicitly though, if nothing else.  If Cython needs to muck around with the internals it can still make an \"exact\" check...",
    "created_at": "2017-11-24T10:39:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336107",
    "user": "embray"
}
```

Replying to [comment:51 jdemeyer]:
> Replying to [comment:50 embray]:
> > I feel like this a bug in Cython--why use `PyString_CheckExact` instead of `PyString_Check`?
> 
> Feature, not a bug :-)

Yep, I just confirmed this myself--although it doesn't really make this explicit the way the code is written definitely implies that it's intentional.

> Cython uses this typing as an *optimization* tool, not as a *checking* tool. It happens to do some checking (like assigning `cdef str x = []` will fail) but that is just to avoid segfaults. For certain builtin types, Cython accesses the internals of those types. But accessing those internals is only valid for the exact type, it might not be valid for subtypes.

Right.  It depends.  I feel like one should be able to ask for allowing subtypes explicitly though, if nothing else.  If Cython needs to muck around with the internals it can still make an "exact" check...



---

archive/issue_comments_336108.json:
```json
{
    "body": "Also I'd say Cython does use types for checking, not just optimization, for example it obviously won't let you do things like\n\n\n```\ncdef int i\ni = \"abc\"\n```\n\n\nI guess it depends on what you mean by \"typing\"--is this referring to Python types or C types?\n\nSo in the mean time what do we do?  Write the explicit checks manually?  Or just not allow `str` subclasses and require a manual `str()` when passing in objects that might be `str` subclasses (ew, very un-Pythonic).",
    "created_at": "2017-11-24T10:44:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336108",
    "user": "embray"
}
```

Also I'd say Cython does use types for checking, not just optimization, for example it obviously won't let you do things like


```
cdef int i
i = "abc"
```


I guess it depends on what you mean by "typing"--is this referring to Python types or C types?

So in the mean time what do we do?  Write the explicit checks manually?  Or just not allow `str` subclasses and require a manual `str()` when passing in objects that might be `str` subclasses (ew, very un-Pythonic).



---

archive/issue_comments_336109.json:
```json
{
    "body": "Replying to [comment:53 embray]:\n> So in the mean time what do we do?\n\nI would argue that the current branch works and that nothing needs to be changed. Even if the error message from `PyUnicode_Decode` is obscure, the traceback would easily point to the right place.",
    "created_at": "2017-11-24T10:46:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336109",
    "user": "jdemeyer"
}
```

Replying to [comment:53 embray]:
> So in the mean time what do we do?

I would argue that the current branch works and that nothing needs to be changed. Even if the error message from `PyUnicode_Decode` is obscure, the traceback would easily point to the right place.



---

archive/issue_comments_336110.json:
```json
{
    "body": "Replying to [comment:53 embray]:\n> I guess it depends on what you mean by \"typing\"--is this referring to Python types or C types?\n\nI was specifically talking about builtin Python types (not C types nor `cdef classes`).",
    "created_at": "2017-11-24T10:47:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336110",
    "user": "jdemeyer"
}
```

Replying to [comment:53 embray]:
> I guess it depends on what you mean by "typing"--is this referring to Python types or C types?

I was specifically talking about builtin Python types (not C types nor `cdef classes`).



---

archive/issue_comments_336111.json:
```json
{
    "body": "Replying to [comment:54 jdemeyer]:\n> Replying to [comment:53 embray]:\n> > So in the mean time what do we do?\n> \n> I would argue that the current branch works and that nothing needs to be changed. Even if the error message from `PyUnicode_Decode` is obscure, the traceback would easily point to the right place.\n\nOkay--I'm really not happy about that--given that the `<str?>` syntax is the programmer explicitly asking for a type *check* it should allow some flexibility in how that's performed.  But that's a Cython issue.  I can live with this in the meantime. However, one thing that still needs to be fixed then is to remove the type checks in the Python 2 cases.  I'm not sure what good they're doing, and they are restricting the use of subtypes on Python 2...",
    "created_at": "2017-11-24T10:58:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336111",
    "user": "embray"
}
```

Replying to [comment:54 jdemeyer]:
> Replying to [comment:53 embray]:
> > So in the mean time what do we do?
> 
> I would argue that the current branch works and that nothing needs to be changed. Even if the error message from `PyUnicode_Decode` is obscure, the traceback would easily point to the right place.

Okay--I'm really not happy about that--given that the `<str?>` syntax is the programmer explicitly asking for a type *check* it should allow some flexibility in how that's performed.  But that's a Cython issue.  I can live with this in the meantime. However, one thing that still needs to be fixed then is to remove the type checks in the Python 2 cases.  I'm not sure what good they're doing, and they are restricting the use of subtypes on Python 2...



---

archive/issue_comments_336112.json:
```json
{
    "body": "Replying to [comment:56 embray]:\n> given that the `<str?>` syntax is the programmer explicitly asking for a type *check* it should allow some flexibility in how that's performed.  But that's a Cython issue.\n\nAgain, feature, not a bug. It is meant as \"optimize this code assuming that this is a `str` but check it just in case\". Of course, it is too tempting to use this to replace `isinstance()` checks as I have done. I'll fix it right now.",
    "created_at": "2017-11-24T11:06:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336112",
    "user": "jdemeyer"
}
```

Replying to [comment:56 embray]:
> given that the `<str?>` syntax is the programmer explicitly asking for a type *check* it should allow some flexibility in how that's performed.  But that's a Cython issue.

Again, feature, not a bug. It is meant as "optimize this code assuming that this is a `str` but check it just in case". Of course, it is too tempting to use this to replace `isinstance()` checks as I have done. I'll fix it right now.



---

archive/issue_comments_336113.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-24T11:26:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336113",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_336114.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-11-24T11:26:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336114",
    "user": "jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_336115.json:
```json
{
    "body": "Okay, I take your word for it, but in that case I think the the [Cython documentation](http://cython.readthedocs.io/en/latest/src/reference/language_basics.html#type-checking) is a little deceptive about how this works / is meant to be used.  Not deliberately of course, it's just unclear.  This is like with `importlib.import_module`--the documentation is unhelpful here, but I'm sure you're right...",
    "created_at": "2017-11-24T12:17:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336115",
    "user": "embray"
}
```

Okay, I take your word for it, but in that case I think the the [Cython documentation](http://cython.readthedocs.io/en/latest/src/reference/language_basics.html#type-checking) is a little deceptive about how this works / is meant to be used.  Not deliberately of course, it's just unclear.  This is like with `importlib.import_module`--the documentation is unhelpful here, but I'm sure you're right...



---

archive/issue_comments_336116.json:
```json
{
    "body": "Replying to [comment:60 embray]:\n> Okay, I take your word for it, but in that case I think the the [Cython documentation](http://cython.readthedocs.io/en/latest/src/reference/language_basics.html#type-checking) is a little deceptive about how this works / is meant to be used.\n\nhttps://github.com/cython/cython/pull/2021",
    "created_at": "2017-11-24T13:49:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336116",
    "user": "jdemeyer"
}
```

Replying to [comment:60 embray]:
> Okay, I take your word for it, but in that case I think the the [Cython documentation](http://cython.readthedocs.io/en/latest/src/reference/language_basics.html#type-checking) is a little deceptive about how this works / is meant to be used.

https://github.com/cython/cython/pull/2021



---

archive/issue_comments_336117.json:
```json
{
    "body": "Alright, I'm good with this.",
    "created_at": "2017-11-27T10:37:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336117",
    "user": "embray"
}
```

Alright, I'm good with this.



---

archive/issue_comments_336118.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-11-27T10:37:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336118",
    "user": "embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_336119.json:
```json
{
    "body": "I think it would actually be best if `char_to_str` took a `const char *` instead of just `char *`.  I was lazy about that at first, but for the sake of correctness I think this should be updated.",
    "created_at": "2017-12-08T14:31:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336119",
    "user": "embray"
}
```

I think it would actually be best if `char_to_str` took a `const char *` instead of just `char *`.  I was lazy about that at first, but for the sake of correctness I think this should be updated.



---

archive/issue_comments_336120.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-12-08T14:31:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336120",
    "user": "embray"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_336121.json:
```json
{
    "body": "Right. But don't rewrite history, just add a new commit.",
    "created_at": "2017-12-08T14:35:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336121",
    "user": "jdemeyer"
}
```

Right. But don't rewrite history, just add a new commit.



---

archive/issue_comments_336122.json:
```json
{
    "body": "Sure--I can do it if you want.  I'll just set it back to positive_review then since we're in agreement.",
    "created_at": "2017-12-08T14:58:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336122",
    "user": "embray"
}
```

Sure--I can do it if you want.  I'll just set it back to positive_review then since we're in agreement.



---

archive/issue_comments_336123.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2017-12-08T15:03:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336123",
    "user": "embray"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_336124.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-12-08T15:03:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336124",
    "user": "embray"
}
```

New commits:



---

archive/issue_comments_336125.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-12-11T11:28:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336125",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_336126.json:
```json
{
    "body": "PDF docs don't build",
    "created_at": "2017-12-11T11:28:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336126",
    "user": "vbraun"
}
```

PDF docs don't build



---

archive/issue_comments_336127.json:
```json
{
    "body": "It would be helpful if you linked to a build result page demonstrating the issue.",
    "created_at": "2017-12-11T15:08:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336127",
    "user": "embray"
}
```

It would be helpful if you linked to a build result page demonstrating the issue.



---

archive/issue_comments_336128.json:
```json
{
    "body": "That was before putting it on the buildbot...",
    "created_at": "2017-12-11T15:35:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336128",
    "user": "vbraun"
}
```

That was before putting it on the buildbot...



---

archive/issue_comments_336129.json:
```json
{
    "body": "Well I have unrelated problems building the PDF docs (is there a list somewhere of the dependencies? I have a pretty big texlive install and it still doesn't seem to have all the necessary fonts or something, even for some characters not related to this ticket).\n\nStill if I had to guess it seems likely the problem is my use of the Snowman character (my favorite go-to unicode character).  I'll just change it to something a little more likely to be already supported...",
    "created_at": "2017-12-12T09:09:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336129",
    "user": "embray"
}
```

Well I have unrelated problems building the PDF docs (is there a list somewhere of the dependencies? I have a pretty big texlive install and it still doesn't seem to have all the necessary fonts or something, even for some characters not related to this ticket).

Still if I had to guess it seems likely the problem is my use of the Snowman character (my favorite go-to unicode character).  I'll just change it to something a little more likely to be already supported...



---

archive/issue_comments_336130.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-12-12T09:17:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336130",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_336131.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-12-12T09:18:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336131",
    "user": "embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_336132.json:
```json
{
    "body": "maybe you should add `r\"\"\"`} when the doctests contains something that can perturb the pdf doc ?",
    "created_at": "2017-12-12T11:01:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336132",
    "user": "chapoton"
}
```

maybe you should add `r"""`} when the doctests contains something that can perturb the pdf doc ?



---

archive/issue_comments_336133.json:
```json
{
    "body": "Ah, there are some slashes in there too; I should make it an r-string just in case.",
    "created_at": "2017-12-12T12:54:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336133",
    "user": "embray"
}
```

Ah, there are some slashes in there too; I should make it an r-string just in case.



---

archive/issue_comments_336134.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-12-12T12:57:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336134",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_336135.json:
```json
{
    "body": "Have a look at build/pkgs/texlive/package-list.txt\n\nYou can add custom codepoints in src/doc/common/conf.py",
    "created_at": "2017-12-12T14:53:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336135",
    "user": "vbraun"
}
```

Have a look at build/pkgs/texlive/package-list.txt

You can add custom codepoints in src/doc/common/conf.py



---

archive/issue_comments_336136.json:
```json
{
    "body": "pdf doc seems to be ok now",
    "created_at": "2017-12-13T13:40:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336136",
    "user": "chapoton"
}
```

pdf doc seems to be ok now



---

archive/issue_comments_336137.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-12-13T13:40:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336137",
    "user": "chapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_336138.json:
```json
{
    "body": "Breaks the python 3.6 build for me in sage-on-gentoo\n\n```\n[477/483] Cythonizing sage/symbolic/function.pyx\n\nError compiling Cython file:\n------------------------------------------------------------\n...\n            err = NULL  # implies \"strict\"\n        else:\n            err = PyUnicode_AsUTF8(errors)\n\n        if encoding is None:\n            return PyUnicode_DecodeLocale(c, err)\n                                        ^\n------------------------------------------------------------\n\nsage/cpython/string.pxd:37:41: Cannot convert Unicode string to 'str' implicitly. This is not portable and requires explicit encoding.\nTraceback (most recent call last):\n  File \"/usr/lib64/python3.6/site-packages/Cython/Build/Dependencies.py\", line 1179, in cythonize_one_helper\n    return cythonize_one(*m)\n  File \"/usr/lib64/python3.6/site-packages/Cython/Build/Dependencies.py\", line 1161, in cythonize_one\n    raise CompileError(None, pyx_file)\nCython.Compiler.Errors.CompileError: sage/cpython/string.pyx\n```\n\ncython 0.27.3 and python-3.6.3. \nSince this is from python3 specific section it won't show up on Volker's build bots.",
    "created_at": "2017-12-14T08:11:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336138",
    "user": "fbissey"
}
```

Breaks the python 3.6 build for me in sage-on-gentoo

```
[477/483] Cythonizing sage/symbolic/function.pyx

Error compiling Cython file:
------------------------------------------------------------
...
            err = NULL  # implies "strict"
        else:
            err = PyUnicode_AsUTF8(errors)

        if encoding is None:
            return PyUnicode_DecodeLocale(c, err)
                                        ^
------------------------------------------------------------

sage/cpython/string.pxd:37:41: Cannot convert Unicode string to 'str' implicitly. This is not portable and requires explicit encoding.
Traceback (most recent call last):
  File "/usr/lib64/python3.6/site-packages/Cython/Build/Dependencies.py", line 1179, in cythonize_one_helper
    return cythonize_one(*m)
  File "/usr/lib64/python3.6/site-packages/Cython/Build/Dependencies.py", line 1161, in cythonize_one
    raise CompileError(None, pyx_file)
Cython.Compiler.Errors.CompileError: sage/cpython/string.pyx
```

cython 0.27.3 and python-3.6.3. 
Since this is from python3 specific section it won't show up on Volker's build bots.



---

archive/issue_comments_336139.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-12-14T10:44:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336139",
    "user": "embray"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_336140.json:
```json
{
    "body": "Hrm. It seems I never actually merged/tested Jeroen's changes on my Python 3 branch.  I assumed he tested it.",
    "created_at": "2017-12-14T10:44:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336140",
    "user": "embray"
}
```

Hrm. It seems I never actually merged/tested Jeroen's changes on my Python 3 branch.  I assumed he tested it.



---

archive/issue_comments_336141.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-12-14T11:16:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336141",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_336142.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-12-14T11:20:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336142",
    "user": "embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_336143.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-12-14T12:41:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336143",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_336144.json:
```json
{
    "body": "Instead of removing the return type specifications, it would be better to fix them. Replacing the `unicode` return value by `str` should work.",
    "created_at": "2017-12-14T12:41:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336144",
    "user": "jdemeyer"
}
```

Instead of removing the return type specifications, it would be better to fix them. Replacing the `unicode` return value by `str` should work.



---

archive/issue_comments_336145.json:
```json
{
    "body": "Fine but it really doesn't make much difference.",
    "created_at": "2017-12-15T10:37:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336145",
    "user": "embray"
}
```

Fine but it really doesn't make much difference.



---

archive/issue_comments_336146.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-12-15T11:14:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336146",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_336147.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-12-15T12:29:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336147",
    "user": "chapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_336148.json:
```json
{
    "body": "Good for me if it passes testing.",
    "created_at": "2017-12-15T12:32:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336148",
    "user": "jdemeyer"
}
```

Good for me if it passes testing.



---

archive/issue_comments_336149.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-12-15T15:16:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336149",
    "user": "chapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_336150.json:
```json
{
    "body": "one green bot. I am setting to positive this important ticket.",
    "created_at": "2017-12-15T15:16:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336150",
    "user": "chapoton"
}
```

one green bot. I am setting to positive this important ticket.



---

archive/issue_comments_336151.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-12-17T10:51:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336151",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_336152.json:
```json
{
    "body": "Merge conflict",
    "created_at": "2017-12-17T10:51:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336152",
    "user": "vbraun"
}
```

Merge conflict



---

archive/issue_comments_336153.json:
```json
{
    "body": "Volker, do you by chance have any idea about what was the conflicting ticket ?",
    "created_at": "2017-12-20T09:13:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336153",
    "user": "chapoton"
}
```

Volker, do you by chance have any idea about what was the conflicting ticket ?



---

archive/issue_comments_336154.json:
```json
{
    "body": "Merge conflict with what?  If there were a normal \"master\" branch into which tickets were merged regularly against which I could compare that would be one thing, but you can't just secretly merge a bunch of tickets all at once, claim \"merge conflict\", and expect me to guess what it conflicts with.",
    "created_at": "2017-12-21T11:12:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336154",
    "user": "embray"
}
```

Merge conflict with what?  If there were a normal "master" branch into which tickets were merged regularly against which I could compare that would be one thing, but you can't just secretly merge a bunch of tickets all at once, claim "merge conflict", and expect me to guess what it conflicts with.



---

archive/issue_comments_336155.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-12-21T11:17:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336155",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_336156.json:
```json
{
    "body": "Rebased on current develop branch if it helps, but there was no merge conflict.\n----\nNew commits:",
    "created_at": "2017-12-21T11:17:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336156",
    "user": "embray"
}
```

Rebased on current develop branch if it helps, but there was no merge conflict.
----
New commits:



---

archive/issue_comments_336157.json:
```json
{
    "body": "Replying to [comment:91 embray]:\n> Merge conflict with what?  If there were a normal \"master\" branch into which tickets were merged regularly against which I could compare that would be one thing, but you can't just secretly merge a bunch of tickets all at once, claim \"merge conflict\", and expect me to guess what it conflicts with.\n\nIt's not secret: https://github.com/vbraun/sage/tree/develop",
    "created_at": "2017-12-21T12:14:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336157",
    "user": "jdemeyer"
}
```

Replying to [comment:91 embray]:
> Merge conflict with what?  If there were a normal "master" branch into which tickets were merged regularly against which I could compare that would be one thing, but you can't just secretly merge a bunch of tickets all at once, claim "merge conflict", and expect me to guess what it conflicts with.

It's not secret: https://github.com/vbraun/sage/tree/develop



---

archive/issue_comments_336158.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2017-12-25T02:06:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336158",
    "user": "jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_336159.json:
```json
{
    "body": "I don't see any conflict...",
    "created_at": "2017-12-25T02:06:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336159",
    "user": "jdemeyer"
}
```

I don't see any conflict...



---

archive/issue_comments_336160.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-12-26T09:25:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23985#issuecomment-336160",
    "user": "vbraun"
}
```

Resolution: fixed
