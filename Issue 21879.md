# Issue 21879: installation of gap_packages fails on some gentoo systems

Issue created by migration from Trac.

Original creator: dimpase

Original creation time: 2016-12-31 22:31:11

The symptom is the error at the line `cd leon make` coming from a `Makefile` in `guava` package.

```
make[3]: Entering directory '/home/dima/Sage/sage-dev/local/gap/gap-4.8.3/pkg/guava-3.13/src'
gcc  -O2 -L/home/dima/Sage/sage-dev/local/lib -Wl,-rpath,/home/dima/Sage/sage-dev/local/lib  -o leonconv leonconv.c
cd leon make
/bin/sh: line 0: cd: too many arguments
make[3]: *** [Makefile:14: all] Error 1
```

See also the corresponding gentoo [github thread](https://github.com/cschwan/sage-on-gentoo/issues/447).

On a system I see this error, `/bin/sh` is a link to `bash`.


---

Comment by fbissey created at 2017-01-01 21:31:00

Like I said on github I have no idea why it works in the first place on most system. The code is __bad__.


---

Comment by fbissey created at 2017-01-01 21:46:00

Changing status from new to needs_review.


---

Comment by fbissey created at 2017-01-01 21:46:00

As, also mentioned in github, my own gentoo systems are quite unaffected by the bug - one day I may understand why that is. In any case, can you pass it upstream Dima?
----
New commits:


---

Comment by fbissey created at 2017-01-01 21:57:43

Hum... Apart from not doing exactly the same thing as in sage-on-gentoo (not woken yet may be) there is the issue that autoreconf is called in `src/leon`. Do you see that on other systems? It fails miserably in any case but that's not normal or wanted.


---

Comment by dimpase created at 2017-01-02 09:50:29

Replying to [comment:3 fbissey]:
> Hum... Apart from not doing exactly the same thing as in sage-on-gentoo (not woken yet may be) there is the issue that autoreconf is called in `src/leon`. Do you see that on other systems? It fails miserably in any case but that's not normal or wanted.

I don't understand how your patch would make it work; there is no makefile in src/leon/


---

Comment by dimpase created at 2017-01-02 09:54:15

IMHO it should be

```
-       cd leon make
+       cd leon && ./configure && $(MAKE)
```



---

Comment by fbissey created at 2017-01-02 10:08:59

The build system is a right mess. 

```
SRCDIR  = ./src/leon
CJSRCDIR= ./src/ctjhai
BINDIR = bin/$(GAPARCH)
#GAP_PATH=../..
#PKG_PATH=.
#SRCDISTFILE=guava

targets: default

default: bindir minimum-weight leonconv desauto install

# this target creates a bin-directory
bindir:
	if test ! -d $(BINDIR);  then mkdir -p $(BINDIR);  fi

minimum-weight: $(CJSRCDIR)/minimum-weight.o $(CJSRCDIR)/minimum-weight-gf2.o $(CJSRCDIR)/minimum-weight-gf3.o $(CJSRCDIR)/popcount.o
	$(CC) $(LDFLAGS) -o $(CJSRCDIR)/minimum-weight \
$(CJSRCDIR)/minimum-weight.o $(CJSRCDIR)/minimum-weight-gf2.o \
$(CJSRCDIR)/minimum-weight-gf3.o $(CJSRCDIR)/popcount.o -lm

leonconv: 
	cd ./src; $(MAKE) CC="$(CC)" CPPFLAGS="$(CPPFLAGS)" CFLAGS="$(CFLAGS)" LDFLAGS="$(LDFLAGS)";

desauto: 
	cd $(SRCDIR); autoreconf --install --force || true ; ./configure; $(MAKE) CC="$(CC)" CPPFLAGS="$(CPPFLAGS)" CFLAGS="$(CFLAGS)" LDFLAGS="$(LDFLAGS)";
```

so the `desauto` target will produce a makefile in `src/leon` and run make. In effect that little bit in `src/Makefile` would be "useful" if the `desauto` target was run before `leonconv`. As it is, it indeed does nothing.


---

Comment by dimpase created at 2017-01-02 10:10:53

It probably fails for me due to a race condition (with make -jX with X>>1).


---

Comment by jdemeyer created at 2017-01-02 10:14:31

This should be reported upstream


---

Comment by fbissey created at 2017-01-02 10:15:54

Indeed you could fail because you try to run make while it is being produced. That makes the bit of my gentoo patch where I make the `leoconv` target depend on `desauto` the real resolution. I think the dependencies of the `install` target should be fixed as I did in Gentoo as well.


---

Comment by jdemeyer created at 2017-01-02 10:20:40

Which version of `bash` are you using?

With

```
GNU bash, version 4.2.49(1)-release (x86_64-pc-linux-gnu)
```

it seems that extra arguments to `cd` are silently ignored.


---

Comment by dimpase created at 2017-01-02 10:27:18

Replying to [comment:10 jdemeyer]:
> Which version of `bash` are you using?
> 
> With
> {{{
> GNU bash, version 4.2.49(1)-release (x86_64-pc-linux-gnu)
> }}}
> it seems that extra arguments to `cd` are silently ignored.

I'm on bash 4.4.5(1) (according to manpages of bash, the args of cd after dir are ignored). If I merely use the branch I still cannot build, I need to run configure in src/leon first. I need to check that this can be replaced by adding
the explicit dependency (but I guess it will do).

I'm experimenting with stock GAP 4.8.6 now, same issues.


---

Comment by fbissey created at 2017-01-02 10:32:03

And I am on bash 4.3 myself. It could indeed be down to behavior depending on the bash version, and once you fix the problem with `src/Makefile` we need to fix the dependencies.


---

Comment by jdemeyer created at 2017-01-02 10:32:33

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-01-02 10:32:33

Given that the line `cd leon make` is essentially a no-op (it behaves like `cd leon`), maybe it should be removed?


---

Comment by dimpase created at 2017-01-02 10:34:43

Replying to [comment:13 jdemeyer]:
> Given that the line `cd leon make` is essentially a no-op (it behaves like `cd leon`), maybe it should be removed?

this is not the original intention, of course. Although it's very old code there.


---

Comment by jdemeyer created at 2017-01-02 10:38:37

Replying to [comment:14 dimpase]:
> this is not the original intention, of course. Although it's very old code there. 

Given that guava has worked for years with that broken line, I think it's best to keep the behaviour (i.e. doing nothing).


---

Comment by fbissey created at 2017-01-02 10:39:05

Replying to [comment:14 dimpase]:
> Replying to [comment:13 jdemeyer]:
> > Given that the line `cd leon make` is essentially a no-op (it behaves like `cd leon`), maybe it should be removed?
> 
> this is not the original intention, of course. Although it's very old code there. 

Very organic. Lots of stuff is decrepit and not used. So excision, as suggested by Jeroen, is warranted.


---

Comment by dimpase created at 2017-01-02 10:42:48

No, it must be fixed (upstream as well) and preserved. It is working code.


---

Comment by git created at 2017-01-02 10:50:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2017-01-02 10:52:00

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2017-01-02 10:52:00

This is closer to what I do in Gentoo and make sure it will work properly with parallel make.


---

Comment by jdemeyer created at 2017-01-02 10:57:35

I would only accept this patch if upstream accepts it.

I would accept removing the line `cd leon make` (with no further changes) unconditionally.


---

Comment by dimpase created at 2017-01-02 11:01:00

Replying to [comment:22 jdemeyer]:
> I would only accept this patch if upstream accepts it.

I am pretty much OK with accepting it, as this seems to be a general GAP(packages) slackness with not fixing obvious things for years.


---

Comment by fbissey created at 2017-01-02 11:05:15

Replying to [comment:22 jdemeyer]:
> I would only accept this patch if upstream accepts it.
> 
> I would accept removing the line `cd leon make` (with no further changes) unconditionally.

Considering the cruft, I would suggest more invasive changes upstream. `src/Makefile` is really full of unused stuff beside that line. Once it is done the target dependencies in the top makefile could be pushed to the `install` target only. And finally could we get rid of running `autoreconf` (note the artful way things are handled on line 29 of `Makefile.in` so that absence of `autoreconf` or its failure is not a problem - and because there is an automake statement in `src/leon/configure.ac` and no `Makefile.am`, `autoreconf` will fail if run).


---

Comment by jdemeyer created at 2017-01-02 11:28:15

Replying to [comment:24 fbissey]:
> Considering the cruft, I would suggest more invasive changes upstream.

I don't care.

For Sage for now, why not do the minimal change which is needed to fix the problem with bash 4.4? We can leave further changes for the future, after discussing with upstream.


---

Comment by fbissey created at 2017-01-02 11:42:32

Replying to [comment:25 jdemeyer]:
> Replying to [comment:24 fbissey]:
> > Considering the cruft, I would suggest more invasive changes upstream.
> 
> I don't care.
> 
> For Sage for now, why not do the minimal change which is needed to fix the problem with bash 4.4? We can leave further changes for the future, after discussing with upstream.

Sure. My only other changes on that branch are considerations that parallel make will fail for someone sooner or later.


---

Comment by dimpase created at 2017-01-23 19:20:12

I've put the patch into the branch on #20914. Thanks :-)


---

Comment by dimpase created at 2017-01-23 19:20:39

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2017-01-23 21:43:30

For the record: I *disagree* with that patch (but if other people are happy with it, I will not object).


---

Comment by jdemeyer created at 2017-01-24 08:08:47

I think that this bug is important enough that it should be fixed independently of #20914. However, again, I don't want to interfere with what you guys are doing...


---

Comment by embray created at 2017-07-12 11:54:34

Resolution: wontfix


---

Comment by embray created at 2017-07-12 11:54:34

Since this is duplicate/invalid/wontfix I guess it can be closed?
