# Issue 30450: "make python3-clean" should always remove local/lib/python3*

Issue created by migration from https://trac.sagemath.org/ticket/30687

Original creator: dimpase

Original creation time: 2020-10-01 11:54:01

CC:  mkoeppe mjo jhpalmieri

`make python3-clean` does not remove `$SAGE_LOCAL/lib/python3*` - certainly not if  an external `python3` is used. This is certainly a bug.


---

Comment by mkoeppe created at 2020-10-01 15:53:34

Not really `make python3-clean`, more like `make python3_venv-clean`; see #29708 ("Fix switching between `--with-system-python3` and `--without-system-python3`"). I had hoped to fix it via #29386, but this won't be ready for Sage 9.2.

We can try a hotfix for this issue by adding `build/pkgs/python3/legacy-uninstall`


---

Comment by mkoeppe created at 2020-10-01 15:53:53

Changing priority from major to critical.


---

Comment by mkoeppe created at 2020-10-01 17:17:48

Here's an attempt. Untested
----
New commits:


---

Comment by mkoeppe created at 2020-10-02 02:27:15

"Of course" the `spkg-legacy-uninstall` mechanism is broken... It is one of the `WRAPPED_SCRIPTS` of `build/bin/sage-spkg`, but `sage_bootstrap.uninstall.legacy_uninstall` tries to execute `spkg-legacy-uninstall` directly out of `SAGE_ROOT/build` with bash...


---

Comment by git created at 2020-10-02 02:44:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-10-02 02:48:39

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2020-10-03 19:49:49

So the problem with #29096 is that the uninstall script wasn't being run by `sage-spkg`, so the conversion from `SCRIPT.in` to `SCRIPT` didn't do anything useful?

I also don't understand how the use of the `spkg-legacy-uninstall` script compares to its documentation. R and gap, for example, are modern packages. Why do they need legacy uninstall scripts?


---

Comment by mkoeppe created at 2020-10-03 19:57:35

Replying to [comment:11 jhpalmieri]:
> So the problem with #29096 is that the uninstall script wasn't being run by `sage-spkg`, so the conversion from `SCRIPT.in` to `SCRIPT` didn't do anything useful?

Yes, prior to #29096 there was an inconsistency - the file `build/pkgs/SPKG/spkg-legacy-uninstall` was transformed to the wrapped script (in the temporary build location) but that was never used. Instead, `sage-spkg-uninstall` was directly invoked `spkg-legacy-uninstall`.

I unfortunately overlooked this in #29096 and so the renaming broke `spkg-legacy-uninstall` for all packages - this script was no longer getting invoked for any package.

> I also don't understand how the use of the `spkg-legacy-uninstall` script compares to its usage. R and gap, for example, are modern packages. Why do they need legacy uninstall scripts?

I think it is for cleaning out very old installs in long-lived installation trees. 
Given that #29096 has not led to obvious error reports, it does not seem to be an important function.


---

Comment by jhpalmieri created at 2020-10-03 20:10:59

Okay, good. The ticket description says that we should remove `$SAGE_LOCAL/lib/python3*`, but the script removes `$SAGE_LOCAL/bin/python3*`. Which is correct?


---

Comment by mkoeppe created at 2020-10-03 20:46:43

Not sure if the original report really meant "lib", and I don't think there is any problem with it.  The branch, in any case, takes care of removing the problematic symlinks in "bin". I have update ticket summary and description.


---

Comment by dimpase created at 2020-10-03 21:34:15

The original report did mean `lib` rather than `bin`. I guess both should be taken care of.


---

Comment by jhpalmieri created at 2020-10-03 21:38:31

If I've built Sage with a system Python 3, I'm not sure what `make python3-clean` should do. Should it really remove all Python site libraries? If it does this, it has to somehow let the build system know to rebuild all of those packages.


---

Comment by mkoeppe created at 2020-10-03 21:45:20

Replying to [comment:15 dimpase]:
> The original report did mean `lib` rather than `bin`. I guess both should be taken care of.

If you install `python3` from spkg, then `make clean` already works because it goes through DESTDIR staging.

If you use system python3 (venv), then nothing is installed in `/usr/lib/python3.8`... except for stuff installed into `site-packages`, which have their own uninstallation procedures.


---

Comment by mkoeppe created at 2020-10-03 21:53:05

Replying to [comment:16 jhpalmieri]:
> If I've built Sage with a system Python 3, I'm not sure what `make python3-clean` should do.

It should be a no-op because `python3` is not installed.


---

Comment by mkoeppe created at 2020-10-03 21:54:22

Replying to [comment:16 jhpalmieri]:
> Should it really remove all Python site libraries?

No, the files that are installed there belong to the individual spkgs.


---

Comment by jhpalmieri created at 2020-10-04 04:52:43

Right, I understand that, so Dima, what did you have in mind?


---

Comment by dimpase created at 2020-10-04 10:21:54

while these files are installed by individual  packages, they "belong" to python. 

Also there should be no difference in what happens to the $SAGE_LOCAL/lib/python3*  whether python3 is installed by Sage or not. Isn't it true that cleaning a  Sage-installed Python leads to removal of  $SAGE_LOCAL/lib/python3* ?


---

Comment by mkoeppe created at 2020-10-04 15:30:23

Replying to [comment:21 dimpase]:
> Isn't it true that cleaning a  Sage-installed Python leads to removal of  $SAGE_LOCAL/lib/python3* ?

No.  The files that belong to the package, recorded in `SAGE_LOCAL/var/lib/sage/installed` are removed.  It does not remove the installed site-packages.

When you reinstall the python3 spkg, then dependencies cause all python packages to be rebuilt.


---

Comment by mkoeppe created at 2020-10-04 15:32:13

Replying to [comment:21 dimpase]:
> while these files are installed by individual  packages, they "belong" to python. 

I think we need to start from the beginning here. What failure do you observe, with or without the branch on this ticket.


---

Comment by dimpase created at 2020-10-04 16:04:32

weird things happen if you switch from one external python3 to another.


---

Comment by mkoeppe created at 2020-10-04 16:10:20

I think the branch of this ticket addresses this by making `make python3-clean` remove the interpreter symlinks and the `pyvenv.cfg`. Please try


---

Comment by mkoeppe created at 2020-10-05 19:47:36

Let's please get this ticket in.


---

Comment by jhpalmieri created at 2020-10-05 21:57:07

I don't have any objections to it. Dima?


---

Comment by dimpase created at 2020-10-06 08:21:23

A nitpick, but I don't like mass renaming of spkg-legacy-uninstall.in involving adding boilerplate into each of them. Couldn't build/sage_bootstrap/uninstall.py, the only place it is called from, just prepend the `#!` line?


---

Comment by jhpalmieri created at 2020-10-06 17:08:08

Replying to [comment:28 dimpase]:
> A nitpick, but I don't like mass renaming of spkg-legacy-uninstall.in involving adding boilerplate into each of them. Couldn't build/sage_bootstrap/uninstall.py, the only place it is called from, just prepend the `#!` line?

This is literally just undoing a change from #29096 which completely broke the use of the `spkg-legacy-uninstall` scripts. Otherwise I would agree with you.


---

Comment by jhpalmieri created at 2020-10-06 17:08:21

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-10-06 17:51:38

Thanks!


---

Comment by mkoeppe created at 2020-10-15 04:55:06

Changing priority from critical to blocker.


---

Comment by vbraun created at 2020-10-18 08:38:31

Resolution: fixed
