# Issue 17976: A lot of polytopes constructor are broken

Issue created by migration from https://trac.sagemath.org/ticket/18213

Original creator: vdelecroix

Original creation time: 2015-04-15 21:42:33

CC:  ncohen

A lot of polytopes constructors in `sage.geometry.polyhedron.library`.

1. The Rhombicuboctahedron does not return what it should (as Python division was thought as Sage integer divisions). There is in the code

```
verts = [ [-3/2, -1/2, -1/2], [-3/2, -1/2, 1/2], [-3/2, 1/2, -1/2],
...
```


2. The `great_rhombicuboctahedron` is defined over `QQ` but it should be defined over `QQ[sqrt(2)]`!! There are in two places rough approximation of sqrt(2) in the code

```
v1 = QQ(131739771357/54568400000)   # ~ sqrt(2) + 1
v2 = QQ(104455571357/27284200000)   # ~ 2 sqrt(2)
```

  Now that Sage supports Polyhedron over number fields, we should use them!


---

Comment by vdelecroix created at 2015-04-16 09:13:06

I have a big commit to push in few minutes...


---

Comment by vdelecroix created at 2015-04-16 14:33:54

New commits:


---

Comment by vdelecroix created at 2015-04-16 14:33:54

Changing status from new to needs_review.


---

Comment by ncohen created at 2015-04-16 14:34:43

Depends on #18211?


---

Comment by vdelecroix created at 2015-04-16 14:35:31

Replying to [comment:5 ncohen]:
> Depends on #18211?

Yes
----
New commits:


---

Comment by git created at 2015-04-16 15:36:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-04-16 17:15:14

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-04-16 20:56:29

The `golden_ratio()` can obviously be defined in terms of `sqrt(5)`, so I don't see the need for that. I'm also really wondering whether you need the custom `sqrt()` function, doesn't `QuadraticField(n)` work?


---

Comment by vdelecroix created at 2015-04-16 22:13:32

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2015-04-16 22:13:32

Replying to [comment:11 jdemeyer]:
> The `golden_ratio()` can obviously be defined in terms of `sqrt(5)`, so I don't see the need for that. I'm also really wondering whether you need the custom `sqrt()` function, doesn't `QuadraticField(n)` work?

Right. The problem of embedding should be done elsewhere (my version embedds in `QQbar` whereas the generic `QuadraticField(n)` embedds into `RLF`).


---

Comment by vdelecroix created at 2015-04-16 22:40:20

Replying to [comment:12 vdelecroix]:
> Replying to [comment:11 jdemeyer]:
> > The `golden_ratio()` can obviously be defined in terms of `sqrt(5)`, so I don't see the need for that. I'm also really wondering whether you need the custom `sqrt()` function, doesn't `QuadraticField(n)` work?
> 
> Right. The problem of embedding should be done elsewhere (my version embedds in `QQbar` whereas the generic `QuadraticField(n)` embedds into `RLF`).

Here is one reason. The generator name of `QuadraticField(2)` is `a` and it better be `sqrt2` in this case. For the golden ratio, the advantage is that its get printed as `phi`. In particular you have

```
sage: polytopes.icosahedron().volume()
5/6*phi + 5/6
```

The answer `5/6*a + 5/6` would have been terrible here. I have nothing against using `phi = (sqrt5+1)/2`. So I will at least remove this one. For the quadratic fields, one option is to globally make this change in another ticket. What do you think?


---

Comment by git created at 2015-04-17 07:14:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-04-17 07:15:15

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-04-17 07:15:15

All right. I removed the `sqrt` and `golden_ratio` function. Needs review!

Vincent


---

Comment by ncohen created at 2015-04-17 07:20:02

Vincent: the diff of your main commit is very, very very hard to read. Could you split in order to make it easier to understand?


---

Comment by vdelecroix created at 2015-04-17 07:24:32

Replying to [comment:16 ncohen]:
> Vincent: the diff of your main commit is very, very very hard to read. Could you split in order to make it easier to understand?

Not sure. It is basically a complete rewrite. I added a ton of documentation, and modify many functions to fit with the actual definition!


---

Comment by ncohen created at 2015-04-17 07:27:52

Okay. Then could you at least change the description of this ticket to explain all changes that you made? (you apparently reated new functions, for example.. Why?)


---

Comment by vdelecroix created at 2015-04-17 07:34:25

Replying to [comment:18 ncohen]:
> Okay. Then could you at least change the description of this ticket to explain all changes that you made? (you apparently reated new functions, for example.. Why?)

done in the ticket description.


---

Comment by ncohen created at 2015-04-17 08:09:36

About `golden_ratio` and `sqrt`: shouldn't they be in `number_field_element_quadratic` instead ?

About `zero_sum_projection` what about having it in `matrix.<tab>` ?

Nathann


---

Comment by vdelecroix created at 2015-04-17 11:39:38

Replying to [comment:20 ncohen]:
> About `golden_ratio` and `sqrt`: shouldn't they be in `number_field_element_quadratic` instead ?

Removed in ​c1804d5.

> About `zero_sum_projection` what about having it in `matrix.<tab>` ?

It is very specific. I am not sure how I would call it in `matrix.<tab>`.


---

Comment by git created at 2015-04-17 11:57:57

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by ncohen created at 2015-04-17 11:58:30

`O_o`


---

Comment by vdelecroix created at 2015-04-17 11:59:04

Cleaner version based on sage-6.7.beta1 and the complete #18211.


---

Comment by ncohen created at 2015-04-17 14:24:20

Here are some comments. Please understand that doing everything at once makes things *MUCH* harder to understand for the reviewer.

Improving the implementation and improving the doc could have been two separate commits. The work that you do on each function could have been a separate commit. Removing deprecations could have been a separate commit. There are also things that anybody can review (only code) and things for which you need to be used to the tools you deal with.

- The projection is not the orthogona projection I expected:
  {{{
  sage: sage: zero_sum_projection(3)*vector([1,0,0])
  (0.7071067811865475, 0.4082482904638631)
  }}}
  You can either change the matrix or emphasize in the docstring that the
  projection is not unique. Something like "returns a (d-1)xd matrix of rank d
  whose kernel contain (1,...,1). At first sight, I expected the function to
  return a matrix of dimensions `d\times d`. I updated the docstring on this
  matter.

- I do not understand the paragraph in the doc of `project_points` but that's
  probably because I don't know the maths behind.

- Compatible?
  {{{
  This projection is the only one compatible with the restriction to the
  first coordinates
  }}}

- You should probably add a `# tol`
  after this
  {{{
  Its volume is `\sqrt{d+1} / d!`
  }}}
  Or even better, check that the difference between the two is 0
  (still, with some tolerance)

- At this point I still do not know if it is very wise to use this definition of
  the projection, but it would be cool if every function which uses this
  projection (like !Simplex) could redirect toward the matrix function. This way
  people would have a chance to learn what exactly they get as a result.

- What about this error?

  {{{
  sage: polytopes.icosahedron(base_ring=QQ)
  ...
  TypeError: unable to convert 1/4*sqrt(5) + 1/4 to a rational
  }}}

I added a small commit at public/18213

Nathann


---

Comment by vdelecroix created at 2015-04-17 15:02:13

Replying to [comment:25 ncohen]:
> Here are some comments. Please understand that doing everything at once makes things *MUCH* harder to understand for the reviewer.

I am very sorry.
 
> - The projection is not the orthogona projection I expected:

Which one did you expected? I improved the documentation.

> - At this point I still do not know if it is very wise to use this definition of
>   the projection, but it would be cool if every function which uses this
>   projection (like !Simplex) could redirect toward the matrix function. This way
>   people would have a chance to learn what exactly they get as a result.

I see. But I am really not confortable in moving this to `matrix.<tab>` as well. One possibility is to move it back to `polytopes.<tab>`. What do you think?

> - What about this error?
> 
>   {{{
>   sage: polytopes.icosahedron(base_ring=QQ)
>   ...
>   TypeError: unable to convert 1/4*sqrt(5) + 1/4 to a rational
>   }}}

Is it not clear enough? The coordinates of the icosahedron need to be defined in `QQ[sqrt(5)]`, hence the error. The following is ok (but very slow, ~3secs on my computer)

```
sage: I = polytopes.icosahedron(base_ring=AA)
```

Apart adding your example to the documentation, I do not see much what I can do (see the last commit). A deprecation?

Vincent


---

Comment by git created at 2015-04-17 15:02:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-04-17 21:08:49

Hello,

> Which one did you expected? I improved the documentation.

Well, I expected an orthogonal projection on this hyperplane. And I probably expected the base of the hyperplane to be the projection of d-1 vectors of the base from the original space I guess.

> > - At this point I still do not know if it is very wise to use this definition of
> >   the projection, but it would be cool if every function which uses this
> >   projection (like !Simplex) could redirect toward the matrix function. This way
> >   people would have a chance to learn what exactly they get as a result.
> 
> I see. But I am really not confortable in moving this to `matrix.<tab>` as well. One possibility is to move it back to `polytopes.<tab>`. What do you think?

All I was suggesting in the message above was to add a link in the doc. The message you added in `project_points` is perfect

```
The projection used is the matrix given by :func:`zero_sum_projection`.
```


To me it should appear whenever there is a 'project' argument in the function.

> Is it not clear enough? The coordinates of the icosahedron need to be defined in `QQ[sqrt(5)]`, hence the error.

Precisely: Could you add somewhere in the doc that the field must contain `QQ(sqrt(5))`?

Nathann


---

Comment by ncohen created at 2015-04-17 21:20:43

the function dodecahedron does nothing with its `base_ring` argument. Also, why should the projection function return 'None' instead of '[]' when it is called with no argument?

Nathann


---

Comment by vdelecroix created at 2015-04-17 21:23:54

Replying to [comment:29 ncohen]:
> the function dodecahedron does nothing with its `base_ring` argument. Also, why should the projection function return 'None' instead of '[]' when it is called with no argument?

You corrected it in 7eb2326


---

Comment by vdelecroix created at 2015-04-17 21:25:20

Replying to [comment:28 ncohen]:
> Hello,
> 
> > Which one did you expected? I improved the documentation.
> 
> Well, I expected an orthogonal projection on this hyperplane. And I probably expected the base of the hyperplane to be the projection of d-1 vectors of the base from the original space I guess.

The description is explicit in the doc (commit ​fac3cff)

> > > - At this point I still do not know if it is very wise to use this definition of
> > >   the projection, but it would be cool if every function which uses this
> > >   projection (like !Simplex) could redirect toward the matrix function. This way
> > >   people would have a chance to learn what exactly they get as a result.
> > 
> > I see. But I am really not confortable in moving this to `matrix.<tab>` as well. One possibility is to move it back to `polytopes.<tab>`. What do you think?
> 
> All I was suggesting in the message above was to add a link in the doc. The message you added in `project_points` is perfect
> {{{
> The projection used is the matrix given by :func:`zero_sum_projection`.
> }}}
> 
> To me it should appear whenever there is a 'project' argument in the function.

Will do!

> > Is it not clear enough? The coordinates of the icosahedron need to be defined in `QQ[sqrt(5)]`, hence the error.
> 
> Precisely: Could you add somewhere in the doc that the field must contain `QQ(sqrt(5))`?

There is one example at the end of the doc (from fac3cff)


---

Comment by ncohen created at 2015-04-17 21:34:22

> You corrected it in 7eb2326

Arggggg... I was looking at the original commit again. I was wondering why it has been removed `>_<`

> The description is explicit in the doc (commit ​fac3cff)

Yes yes now it's good!

> There is one example at the end of the doc (from fac3cff)

It happens several times though. Could you add it in the doc of `base_ring`? You already talk about this field there. It could be something like "If set to None then it will be `QQ[\phi]`, otherwise it must be a field that contains it".

Nathann


---

Comment by ncohen created at 2015-04-17 21:43:03

The 600-cell code would look a bit better if you were building all points at once instead of interrupting the flow to decide which ring you should work with.


---

Comment by ncohen created at 2015-04-17 21:44:46

Funny. There is no `automorphism_group` function for polytopes `O_o`


---

Comment by ncohen created at 2015-04-17 21:46:23


```                                                                                                                                                                         
        OUTPUT: 

        EXAMPLES::
```



---

Comment by vdelecroix created at 2015-04-17 21:46:47

Replying to [comment:34 ncohen]:
> Funny. There is no `automorphism_group` function for polytopes `O_o`

Yes! This is very sad... But you have to be careful about what it means. There is the combinatorial automorphism group and the isometry group. I have no idea how to implement the latter efficiently.


---

Comment by ncohen created at 2015-04-17 21:54:04

Most probably the ugliest thing I ever saw

```
sage: Sequence([Graph()]).universe()
<class 'sage.graphs.graph.Graph'>
sage: Sequence([Graph(),1]).universe()
Category of objects
sage: Sequence([1]).universe()
Integer Ring
```



---

Comment by ncohen created at 2015-04-17 21:55:34

HMmmmmmmm... I don't exactly know what the isometry group is, but let's try anyway: what about defining a complete graph on your points, in which each edge has a color associated to its length. Wouldn't the automorphism group of that be what you want?


---

Comment by ncohen created at 2015-04-17 21:58:13

Okayyyyyyyyyyyyyy. End of the review. Nothing else to add `;-)`

Very good job. This code needed to be cleaned, and it is much better now.

But please, next time: smaller patches. You waste your reviewers' health `:-P`

Nathann


---

Comment by vdelecroix created at 2015-04-17 21:59:00

Replying to [comment:38 ncohen]:
> HMmmmmmmm... I don't exactly know what the isometry group is, but let's try anyway: what about defining a complete graph on your points, in which each edge has a color associated to its length. Wouldn't the automorphism group of that be what you want?

That is a valid definition. But the standard one is the set of orthogonal matrices that preserve the polyhedron. And it would be nice for `isometry_group` to be a finite matrix group (and not permutations)!


---

Comment by git created at 2015-04-17 22:20:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-04-17 22:21:00

Patchbot should be happy after that.


---

Comment by ncohen created at 2015-04-18 06:50:04

Some broken doctests in the patchbot's report. Also, can you be sure that the `sqrt(6.) / factorial(5)` are not subject to numerical noise? There is no `#tol` on them right now.

Nathann


---

Comment by ncohen created at 2015-04-18 07:48:45

Hmmmmmm.. I can't seem to find on google an implementation of an isometry group function anywhere `O_o`


---

Comment by jkeitel created at 2015-04-18 08:41:25

Hi Vincent and Nathann

Just a quick comment, as I'm not sure how useful this will be for general polyhedra: There is a method for lattice polytopes:
`LatticePolytope_PPL` (in `sage.geometry.polyhedron.ppl_lattice_polytope`) has a method `lattice_automorphism_group()`

Cheers,
Jan


---

Comment by ncohen created at 2015-04-18 09:22:30

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-04-18 09:30:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-04-18 09:30:55

Replying to [comment:43 ncohen]:
> Some broken doctests in the patchbot's report. Also, can you be sure that the `sqrt(6.) / factorial(5)` are not subject to numerical noise? There is no `#tol` on them right now.

I don't know... Patchbot did not complain about this.


---

Comment by vdelecroix created at 2015-04-18 09:31:19

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2015-04-18 10:18:18

Changing status from needs_review to positive_review.


---

Comment by ncohen created at 2015-04-18 10:18:18

Okayyyyyyy. Then `positive_review`!

Nathann


---

Comment by vbraun created at 2015-04-19 01:52:06

Resolution: fixed
