# Issue 18495: Add tableau query functions glp_eval_tab_row, glp_eval_tab_col to GLPK backend

archive/issues_018495.json:
```json
{
    "body": "CC:  @nathanncohen @yuan-zhou zwang @jdemeyer\n\nKeywords: LP, glpk\n\nExpose the GLPK functions glp_eval_tab_row, glp_eval_tab_col in Sage's GLPKBackend class.\n\nSee [GLPK manual](http://fossies.org/linux/glpk/doc/glpk.pdf), section 4.3 \"Simplex tableau routines\".\n\nOne needs these functions if one wants to implement tableau cutting planes such as Gomory's fractional cut.\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/18732\n\n",
    "created_at": "2015-06-19T03:05:56Z",
    "labels": [
        "numerical",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.8",
    "title": "Add tableau query functions glp_eval_tab_row, glp_eval_tab_col to GLPK backend",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18495",
    "user": "@mkoeppe"
}
```
CC:  @nathanncohen @yuan-zhou zwang @jdemeyer

Keywords: LP, glpk

Expose the GLPK functions glp_eval_tab_row, glp_eval_tab_col in Sage's GLPKBackend class.

See [GLPK manual](http://fossies.org/linux/glpk/doc/glpk.pdf), section 4.3 "Simplex tableau routines".

One needs these functions if one wants to implement tableau cutting planes such as Gomory's fractional cut.



Issue created by migration from https://trac.sagemath.org/ticket/18732





---

archive/issue_comments_251367.json:
```json
{
    "body": "Hello !\n\nCould you allocate memory *after* raising an exception? Otherwise, those exceptions trigger memory leaks.\n\n`sig_on` and `sig_off` should always appear in pairs, but perhaps you should use `sig_check` in this special case?\nhttp://www.sagemath.org/documentation/html/en/developer/coding_in_cython.html#interrupt-and-signal-handling\n\nCan you check that the pointers you allocate are not 'null'?\n\nNathann\n----\nNew commits:",
    "created_at": "2015-06-21T10:52:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18495#issuecomment-251367",
    "user": "@nathanncohen"
}
```

Hello !

Could you allocate memory *after* raising an exception? Otherwise, those exceptions trigger memory leaks.

`sig_on` and `sig_off` should always appear in pairs, but perhaps you should use `sig_check` in this special case?
http://www.sagemath.org/documentation/html/en/developer/coding_in_cython.html#interrupt-and-signal-handling

Can you check that the pointers you allocate are not 'null'?

Nathann
----
New commits:



---

archive/issue_comments_251368.json:
```json
{
    "body": "Bonjour Nathann,\n\nThanks for the reference! It says that `sig_str` behaves the same as `sig_on`. I just mimic the code in the `GLPKBackend.solve` and `GLPKBackend.row` methods.\n\nDoes one need to deallocate the memory if an Error is raised between `sig_on` and `sig_off`?\n\nHow to check that the pointers are not 'null'?\n\nYuan",
    "created_at": "2015-06-21T11:16:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18495#issuecomment-251368",
    "user": "@yuan-zhou"
}
```

Bonjour Nathann,

Thanks for the reference! It says that `sig_str` behaves the same as `sig_on`. I just mimic the code in the `GLPKBackend.solve` and `GLPKBackend.row` methods.

Does one need to deallocate the memory if an Error is raised between `sig_on` and `sig_off`?

How to check that the pointers are not 'null'?

Yuan



---

archive/issue_comments_251369.json:
```json
{
    "body": "Helloooooo,\n\n> Thanks for the reference! It says that `sig_str` behaves the same as `sig_on`.\n\nOh. My mistake. I did not notice `sig_str`, and did not even know about it. Sorry.\n\n> Does one need to deallocate the memory if an Error is raised between `sig_on` and `sig_off`?\n\nWell, if you allocate memory somewhere and the function ends, then it is never deallocated. If you can avoid this easily, it is better to do it.\n\n> How to check that the pointers are not 'null'?\n\nwith \"if my_pointer == NULL\" ?\n\nNathann",
    "created_at": "2015-06-21T11:19:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18495#issuecomment-251369",
    "user": "@nathanncohen"
}
```

Helloooooo,

> Thanks for the reference! It says that `sig_str` behaves the same as `sig_on`.

Oh. My mistake. I did not notice `sig_str`, and did not even know about it. Sorry.

> Does one need to deallocate the memory if an Error is raised between `sig_on` and `sig_off`?

Well, if you allocate memory somewhere and the function ends, then it is never deallocated. If you can avoid this easily, it is better to do it.

> How to check that the pointers are not 'null'?

with "if my_pointer == NULL" ?

Nathann



---

archive/issue_comments_251370.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-21T22:01:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18495#issuecomment-251370",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_251371.json:
```json
{
    "body": "It now raises `MIPSolverException` if GLPK returns an error message \"basis factorization does not exist\". Memory checks are also added. Please review.",
    "created_at": "2015-06-21T22:08:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18495#issuecomment-251371",
    "user": "@yuan-zhou"
}
```

It now raises `MIPSolverException` if GLPK returns an error message "basis factorization does not exist". Memory checks are also added. Please review.



---

archive/issue_comments_251372.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-06-21T22:08:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18495#issuecomment-251372",
    "user": "@yuan-zhou"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_251373.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-06-22T21:44:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18495#issuecomment-251373",
    "user": "@nathanncohen"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_251374.json:
```json
{
    "body": "\n```\n+        cdef int * c_indices = <int*> sage_malloc((n+1)*sizeof(int))\n+        if c_indices == NULL:\n+            raise MemoryError(\"failed to allocate %s bytes\" % ((n+1)*sizeof(int)))\n+        cdef double * c_values = <double*> sage_malloc((n+1)*sizeof(double))\n+        if c_values == NULL:\n+            sage_free(c_indices)\n+            raise MemoryError(\"failed to allocate %s bytes\" % ((n+1)*sizeof(double)))\n```\n\n\ncan be replaced by \n\n\n```\n+        cdef int * c_indices = <int*> sage_malloc((n+1)*sizeof(int))\n+        cdef double * c_values = <double*> sage_malloc((n+1)*sizeof(double))\n+        if c_indices == NULL or c_values == NULL:\n+            raise MemoryError\n```\n\n\nThis occurs twice.\n\n`for 0 < j <= i:` is \"old-style\", you should use \"for j in range(i)\" instead, which is translated into the very same C code.\n\nFinally, this piece of code had bad side-effects:\n\n\n```\n+        try:\n+            sig_on()\n+            i = glp_eval_tab_row(self.lp, k + 1, c_indices, c_values)\n+            sig_off()\n+        except Exception:\n+            sage_free(c_indices)\n+            sage_free(c_values)\n+            raise MIPSolverException('GLPK : basis factorization does not exist')\n```\n\n\nIndeed, as it catches everything and only raises MIPSolverException, it can transform a KeyboardInterrupt into a \"GLPK: basis factorization does not exist\". And of course the C function `glp_eval_tab_row` cannot be expected to raise any exception.\n\nI don't think that it is worth adding a sig_on/sig_off in this function, considering how short it is. \n\nNathann",
    "created_at": "2015-06-22T21:44:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18495#issuecomment-251374",
    "user": "@nathanncohen"
}
```


```
+        cdef int * c_indices = <int*> sage_malloc((n+1)*sizeof(int))
+        if c_indices == NULL:
+            raise MemoryError("failed to allocate %s bytes" % ((n+1)*sizeof(int)))
+        cdef double * c_values = <double*> sage_malloc((n+1)*sizeof(double))
+        if c_values == NULL:
+            sage_free(c_indices)
+            raise MemoryError("failed to allocate %s bytes" % ((n+1)*sizeof(double)))
```


can be replaced by 


```
+        cdef int * c_indices = <int*> sage_malloc((n+1)*sizeof(int))
+        cdef double * c_values = <double*> sage_malloc((n+1)*sizeof(double))
+        if c_indices == NULL or c_values == NULL:
+            raise MemoryError
```


This occurs twice.

`for 0 < j <= i:` is "old-style", you should use "for j in range(i)" instead, which is translated into the very same C code.

Finally, this piece of code had bad side-effects:


```
+        try:
+            sig_on()
+            i = glp_eval_tab_row(self.lp, k + 1, c_indices, c_values)
+            sig_off()
+        except Exception:
+            sage_free(c_indices)
+            sage_free(c_values)
+            raise MIPSolverException('GLPK : basis factorization does not exist')
```


Indeed, as it catches everything and only raises MIPSolverException, it can transform a KeyboardInterrupt into a "GLPK: basis factorization does not exist". And of course the C function `glp_eval_tab_row` cannot be expected to raise any exception.

I don't think that it is worth adding a sig_on/sig_off in this function, considering how short it is. 

Nathann



---

archive/issue_comments_251375.json:
```json
{
    "body": "Replying to [comment:9 ncohen]:\n> {{{\n> +        cdef int * c_indices = <int*> sage_malloc((n+1)*sizeof(int))\n> +        if c_indices == NULL:\n> +            raise MemoryError(\"failed to allocate %s bytes\" % ((n+1)*sizeof(int)))\n> +        cdef double * c_values = <double*> sage_malloc((n+1)*sizeof(double))\n> +        if c_values == NULL:\n> +            sage_free(c_indices)\n> +            raise MemoryError(\"failed to allocate %s bytes\" % ((n+1)*sizeof(double)))\n> }}}\n> \n> can be replaced by \n> \n> {{{\n> +        cdef int * c_indices = <int*> sage_malloc((n+1)*sizeof(int))\n> +        cdef double * c_values = <double*> sage_malloc((n+1)*sizeof(double))\n> +        if c_indices == NULL or c_values == NULL:\n> +            raise MemoryError\n> }}}\n> \n> This occurs twice.\n\nNathann, if the second allocation fails, your version would leak the memory of the first allocation. \n\n\n\n> `for 0 < j <= i:` is \"old-style\", you should use \"for j in range(i)\" instead, which is translated into the very same C code.\n> \n> Finally, this piece of code had bad side-effects:\n> \n> {{{\n> +        try:\n> +            sig_on()\n> +            i = glp_eval_tab_row(self.lp, k + 1, c_indices, c_values)\n> +            sig_off()\n> +        except Exception:\n> +            sage_free(c_indices)\n> +            sage_free(c_values)\n> +            raise MIPSolverException('GLPK : basis factorization does not exist')\n> }}}\n> \n> Indeed, as it catches everything and only raises MIPSolverException, it can transform a KeyboardInterrupt into a \"GLPK: basis factorization does not exist\". And of course the C function `glp_eval_tab_row` cannot be expected to raise any exception.\n> \n> I don't think that it is worth adding a sig_on/sig_off in this function, considering how short it is. \n\nsig_on/sig_off catches all kinds of signals, and here it is used to catch SIGABRT, which GLPK invokes via abort() whenever there is an error. \n\nIs there a way to distinguish which signal was caught?",
    "created_at": "2015-06-22T22:28:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18495#issuecomment-251375",
    "user": "@mkoeppe"
}
```

Replying to [comment:9 ncohen]:
> {{{
> +        cdef int * c_indices = <int*> sage_malloc((n+1)*sizeof(int))
> +        if c_indices == NULL:
> +            raise MemoryError("failed to allocate %s bytes" % ((n+1)*sizeof(int)))
> +        cdef double * c_values = <double*> sage_malloc((n+1)*sizeof(double))
> +        if c_values == NULL:
> +            sage_free(c_indices)
> +            raise MemoryError("failed to allocate %s bytes" % ((n+1)*sizeof(double)))
> }}}
> 
> can be replaced by 
> 
> {{{
> +        cdef int * c_indices = <int*> sage_malloc((n+1)*sizeof(int))
> +        cdef double * c_values = <double*> sage_malloc((n+1)*sizeof(double))
> +        if c_indices == NULL or c_values == NULL:
> +            raise MemoryError
> }}}
> 
> This occurs twice.

Nathann, if the second allocation fails, your version would leak the memory of the first allocation. 



> `for 0 < j <= i:` is "old-style", you should use "for j in range(i)" instead, which is translated into the very same C code.
> 
> Finally, this piece of code had bad side-effects:
> 
> {{{
> +        try:
> +            sig_on()
> +            i = glp_eval_tab_row(self.lp, k + 1, c_indices, c_values)
> +            sig_off()
> +        except Exception:
> +            sage_free(c_indices)
> +            sage_free(c_values)
> +            raise MIPSolverException('GLPK : basis factorization does not exist')
> }}}
> 
> Indeed, as it catches everything and only raises MIPSolverException, it can transform a KeyboardInterrupt into a "GLPK: basis factorization does not exist". And of course the C function `glp_eval_tab_row` cannot be expected to raise any exception.
> 
> I don't think that it is worth adding a sig_on/sig_off in this function, considering how short it is. 

sig_on/sig_off catches all kinds of signals, and here it is used to catch SIGABRT, which GLPK invokes via abort() whenever there is an error. 

Is there a way to distinguish which signal was caught?



---

archive/issue_comments_251376.json:
```json
{
    "body": "> Nathann, if the second allocation fails, your version would leak the memory of the first allocation. \n\nSorry, I wrote this yesterday evening just before going to sleep and I was exhausted:\n\n\n```\n+        cdef int * c_indices = <int*> sage_malloc((n+1)*sizeof(int))\n+        cdef double * c_values = <double*> sage_malloc((n+1)*sizeof(double))\n+        if c_indices == NULL or c_values == NULL:\n+            sage_free(c_indices)\n+            sage_free(c_values)\n+            raise MemoryError\n```\n\n\n> sig_on/sig_off catches all kinds of signals, and here it is used to catch SIGABRT, which GLPK invokes via abort() whenever there is an error. \n\nOh, okay. Sorry.\n\n> Is there a way to distinguish which signal was caught?\n\nJust type \"raise\" instead of \"raise <something>\". It will raise what was caught. You can also use this model:\n\n\n```\ntry:\n    your_glpk_function(...)\nelse: # only executed if everything went well\n    <copy the C data wherever you need>\nfinally: #whatever happens\n    <free the memory>\nreturn <whatever you need> \n```\n\n\nAlso, I don't think you should both with a loop of 'append'. Something like `values = [c_values[j] for j in range(i)]` works fine.\n\nNathann",
    "created_at": "2015-06-23T07:20:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18495#issuecomment-251376",
    "user": "@nathanncohen"
}
```

> Nathann, if the second allocation fails, your version would leak the memory of the first allocation. 

Sorry, I wrote this yesterday evening just before going to sleep and I was exhausted:


```
+        cdef int * c_indices = <int*> sage_malloc((n+1)*sizeof(int))
+        cdef double * c_values = <double*> sage_malloc((n+1)*sizeof(double))
+        if c_indices == NULL or c_values == NULL:
+            sage_free(c_indices)
+            sage_free(c_values)
+            raise MemoryError
```


> sig_on/sig_off catches all kinds of signals, and here it is used to catch SIGABRT, which GLPK invokes via abort() whenever there is an error. 

Oh, okay. Sorry.

> Is there a way to distinguish which signal was caught?

Just type "raise" instead of "raise <something>". It will raise what was caught. You can also use this model:


```
try:
    your_glpk_function(...)
else: # only executed if everything went well
    <copy the C data wherever you need>
finally: #whatever happens
    <free the memory>
return <whatever you need> 
```


Also, I don't think you should both with a loop of 'append'. Something like `values = [c_values[j] for j in range(i)]` works fine.

Nathann



---

archive/issue_comments_251377.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-23T07:53:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18495#issuecomment-251377",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_251378.json:
```json
{
    "body": "Thanks for the suggestions; I've made these changes. Needs review.",
    "created_at": "2015-06-23T07:55:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18495#issuecomment-251378",
    "user": "@mkoeppe"
}
```

Thanks for the suggestions; I've made these changes. Needs review.



---

archive/issue_comments_251379.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-06-23T07:55:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18495#issuecomment-251379",
    "user": "@mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_251380.json:
```json
{
    "body": "`except Exception: raise` is useless, isn't it?\n\nCould you also update the malloc blocks?",
    "created_at": "2015-06-23T08:02:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18495#issuecomment-251380",
    "user": "@nathanncohen"
}
```

`except Exception: raise` is useless, isn't it?

Could you also update the malloc blocks?



---

archive/issue_comments_251381.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-23T18:45:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18495#issuecomment-251381",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_251382.json:
```json
{
    "body": "Replying to [comment:16 ncohen]:\n> `except Exception: raise` is useless, isn't it?\n\nYou are right, of course. I've removed it.\n\n> Could you also update the malloc blocks?\n\nDone.",
    "created_at": "2015-06-23T18:45:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18495#issuecomment-251382",
    "user": "@mkoeppe"
}
```

Replying to [comment:16 ncohen]:
> `except Exception: raise` is useless, isn't it?

You are right, of course. I've removed it.

> Could you also update the malloc blocks?

Done.



---

archive/issue_comments_251383.json:
```json
{
    "body": "Hello !\n\nI made some modifications, in a commit at public/18732:\n\n- The first line of each docstring must be a short sentence describing what the function does\n\n- Some inequations could be turned into latex formulas\n\n- A row/col problem? Please check\n  {{{\n-        cdef int n = glp_get_num_rows(self.lp)\n+        cdef int n = glp_get_num_cols(self.lp)\n  }}}\n\nIf you agree with this, you can set the ticket's status to `positive_review`.\n\nNathann\n\nP.S.: Please fill the 'author' field.",
    "created_at": "2015-06-23T21:54:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18495#issuecomment-251383",
    "user": "@nathanncohen"
}
```

Hello !

I made some modifications, in a commit at public/18732:

- The first line of each docstring must be a short sentence describing what the function does

- Some inequations could be turned into latex formulas

- A row/col problem? Please check
  {{{
-        cdef int n = glp_get_num_rows(self.lp)
+        cdef int n = glp_get_num_cols(self.lp)
  }}}

If you agree with this, you can set the ticket's status to `positive_review`.

Nathann

P.S.: Please fill the 'author' field.



---

archive/issue_comments_251384.json:
```json
{
    "body": "I agree with your changes. Thanks!\n\nI have made another minor change to the docstrings to correctly reflect the type of exception that is raised.\n----\nNew commits:",
    "created_at": "2015-06-23T23:53:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18495#issuecomment-251384",
    "user": "@mkoeppe"
}
```

I agree with your changes. Thanks!

I have made another minor change to the docstrings to correctly reflect the type of exception that is raised.
----
New commits:



---

archive/issue_comments_251385.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-06-23T23:53:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18495#issuecomment-251385",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_251386.json:
```json
{
    "body": "> I have made another minor change to the docstrings to correctly reflect the type of exception that is raised.\n\n+1\n\nNathann",
    "created_at": "2015-06-24T07:48:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18495#issuecomment-251386",
    "user": "@nathanncohen"
}
```

> I have made another minor change to the docstrings to correctly reflect the type of exception that is raised.

+1

Nathann



---

archive/issue_comments_251387.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-06-24T11:37:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18495",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18495#issuecomment-251387",
    "user": "@vbraun"
}
```

Resolution: fixed
