# Issue 29576: Add pytest as a type=optional, source=pip package

Issue created by migration from https://trac.sagemath.org/ticket/29813

Original creator: mkoeppe

Original creation time: 2020-06-06 04:54:49

CC:  dimpase vdelecroix fbissey jhpalmieri mjo embray

(Following a discussion in #19680, #28998.)


---

Comment by git created at 2020-06-06 05:07:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-06 05:40:05

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-06-06 20:41:32

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-06-06 20:41:32

In #29766 at https://github.com/mkoeppe/sage/runs/744591025:

```
 make[1]: *** No rule to make target '/sage/local/var/lib/sage/installed/pytest-none', needed by '/sage/local/var/lib/sage/installed/networkx-2.4'.
```



---

Comment by mkoeppe created at 2020-06-06 20:53:00

Doesn't work because dependencies on pip packages is broken.


---

Comment by mkoeppe created at 2020-06-06 20:56:11

From `build/make/Makefile.in`:

``` 
# Note: In these rules the $(INST)/<pkgname>-<pkgvers> target is used
# explicitly, rather than expanding the $(inst_<pkgname>) variable, since
# it may expand to $(INST)/.dummy for packages that were not configured
# for installation by default.
```

(That's exactly what's failing.)


---

Comment by mkoeppe created at 2020-06-07 06:23:05

Replying to [comment:9 mkoeppe]:
> (That's exactly what's failing.)
Well, not exactly


---

Comment by git created at 2020-06-07 06:34:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-07 06:35:11

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2020-06-07 07:37:51

is this ready? I don't see how the current branch is going to affect installing this package if needed.

How about just force tox etc configs to install this package? (using a configure option).


---

Comment by mkoeppe created at 2020-06-07 16:22:19

Yes, it's ready. Try it with the networkx ticket where it is merged.


---

Comment by mkoeppe created at 2020-06-08 04:49:31

Of course the problem with this approach is that it depends on SSL...
for example on `ubuntu-focal-standard` (https://github.com/mkoeppe/sage/runs/748390636):

```
  [pytest]   Could not fetch URL https://pypi.org/simple/pytest/: There was a problem confirming the ssl certificate: HTTPSConnectionPool(host='pypi.org', port=443): Max retries exceeded with url: /simple/pytest/ (Caused by SSLError("Can't connect to HTTPS URL because the SSL module is not available.")) - skipping
  [pytest]   ERROR: Could not find a version that satisfies the requirement pytest (from -r /sage/build/pkgs/pytest/requirements.txt (line 1)) (from versions: none)
  [pytest]   ERROR: No matching distribution found for pytest (from -r /sage/build/pkgs/pytest/requirements.txt (line 1))
  [pytest]   WARNING: pip is configured with locations that require TLS/SSL, however the ssl module in Python is not available.
  [pytest]   Could not fetch URL https://pypi.org/simple/pip/: There was a problem confirming the ssl certificate: HTTPSConnectionPool(host='pypi.org', port=443): Max retries exceeded with url: /simple/pip/ (Caused by SSLError("Can't connect to HTTPS URL because the SSL module is not available.")) - skipping
  [pytest] Full log file: /sage/logs/pkgs/pytest.log
```



---

Comment by dimpase created at 2020-06-09 10:27:49

Does this mean that SSL needs to be installed on the hosts to use pytest?
Why is this a problem?


---

Comment by mkoeppe created at 2020-06-09 16:49:24

Yes. Not a big problem, but:
 - we need system package info for build/pkgs/openssl/distros (see also #29555)
 - it does not really fit well into the standard/optional/experimental categories (and hence for example the `-standard` build configurations in tox does not include it at the moment)
 - it is another potential source for user confusion


---

Comment by dimpase created at 2020-06-10 11:03:50

lgtm


---

Comment by dimpase created at 2020-06-10 11:03:56

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-06-10 15:36:47

Thanks!


---

Comment by vbraun created at 2020-06-27 09:26:06

Resolution: fixed
