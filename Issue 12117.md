# Issue 12117: pass algorithm argument to custom numeric evalution methods

Issue created by migration from Trac.

Original creator: burcin

Original creation time: 2012-01-10 06:38:35

Assignee: burcin

CC:  benjaminfjones dsm kcrisman kini eviatarbach vbraun

Keywords: pynac

Custom numeric evaluation functions defined in the `_evalf_()` method of symbolic functions accept only the parent of the result as an argument. We should expand this to allow passing an `argument` parameter as well.


---

Attachment


---

Attachment


---

Comment by burcin created at 2012-01-10 08:05:24

The `evalf_dict` branch of Pynac [available here](https://bitbucket.org/burcin/pynac-wip/), with the attached patches applied to the Sage library, allows this:


```
sage: cot(1/2).n(algorithm='foo')
11.0000000000000
sage: cot(1/2).n()
1.83048772171245
```


The docstrings for `_convert()` etc. methods of symbolic expressions need to be updated to reflect these changes.


---

Comment by benjaminfjones created at 2012-01-10 15:46:42

I'm doing some testing of these patches along with rebasing #1173. Thanks Burcin!


---

Comment by benjaminfjones created at 2012-01-10 15:46:42

Changing keywords from "pynac" to "pynac sd35.5".


---

Comment by benjaminfjones created at 2012-05-25 02:27:32

Changing keywords from "pynac sd35.5" to "pynac sd35.5 sd40.5".


---

Comment by benjaminfjones created at 2012-05-26 00:26:32

I'm trying to rebase the patch [This is the Trac macro *attachment:trac_12289-evalf_dictionary.patch* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#attachment:trac_12289-evalf_dictionary.patch-macro) to sage-5.0, but I'm running into a problem with the type of `py_funcs.py_float`. In the patch py_float has type `object (*)(object, object)` but in sage-5.0, it has type `object (*)(object, PyObject *)` I guess because of a pynac change in the meantime. 

To be more specific, with this type def for `py_float`:


```
cdef public object py_float(object n, object kwds) except +:
```


I rebuild sage and get:


```

Error compiling Cython file:
------------------------------------------------------------
...
    py_funcs.py_is_prime = &py_is_prime

    py_funcs.py_integer_from_long = &py_integer_from_long
    py_funcs.py_integer_from_python_obj = &py_integer_from_python_obj
    
    py_funcs.py_float = &py_float
                       ^
------------------------------------------------------------

sage/symbolic/pynac.pyx:2040:24: Cannot assign type 'object (*)(object, object)' to 'object (*)(object, PyObject *)'
```


Any suggestions (burcin?)


---

Attachment

rebase to sage-5.0 + pynac-0.2.4 spkg


---

Attachment

fix py_float delcaration


---

Comment by benjaminfjones created at 2012-05-28 02:33:32

I've been working on this ticket today at sd40.5. I've got burcin's changes working in sage-5.0 with a caveat. Here's how to get the example in comment:1 working in sage-5.0:

 1. install the __patched__ pynac-0.2.4.p1 spkg at http://sage.math.washington.edu/home/bjones/pynac-0.2.4.p1.spkg. this spkg is the pynac-0.2.4 spkg from #12950 which has been patched to include the changes from burcin's `pynac-wip` branch of pynac mentioned above.

 2. apply all patches at #12950, here is a shell script to help that (run from `$SAGE_ROOT/devel/sage`): http://sage.math.washington.edu/home/bjones/trac_12950_apply.sh

 3. apply the patches to `$SAGE_ROOT/devel/sage`
  * [This is the Trac macro *attachment:trac_12289-evalf_dictionary_rebase.patch* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#attachment:trac_12289-evalf_dictionary_rebase.patch-macro)
  * [This is the Trac macro *attachment:trac_12289-add_algorithm_arg.patch* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#attachment:trac_12289-add_algorithm_arg.patch-macro)
  * [This is the Trac macro *attachment:trac_12289-example.patch* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#attachment:trac_12289-example.patch-macro)
  * [This is the Trac macro *attachment:trac_12289_py_float_fix.patch* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#attachment:trac_12289_py_float_fix.patch-macro) (fixes the problem I had in comment:4)

4. `sage -b`


---

Comment by kcrisman created at 2012-05-28 04:28:06

Patchbot, though, should only apply trac_12289-evalf_dictionary_rebase.patch, trac_12289-add_algorithm_arg.patch, and trac_12289_py_float_fix.patch


---

Comment by dsm created at 2012-05-28 18:10:51

So that we don't forget to fix it later:



```

sage: erf(1).n(algorithm='foo')
0.842700792949715
sage: erf(0)
0
sage: parent(erf(0))
Integer Ring
sage: erf(0).n(algorithm='foo')
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)

/Users/mcneil/sagedev/sage-5.1.beta0b/sage-5.1.beta0/devel/sage-hack2/sage/<ipython console> in <module>()

/Users/mcneil/sagedev/sage-5.1.beta0b/sage-5.1.beta0/local/lib/python2.7/site-packages/sage/structure/element.so in sage.structure.element.Element.numerical_approx (sage/structure/element.c:4988)()

TypeError: numerical_approx() got an unexpected keyword argument 'algorithm'
```



---

Comment by kcrisman created at 2013-04-25 02:23:41

>  1. install the __patched__ pynac-0.2.4.p1 spkg at http://sage.math.washington.edu/home/bjones/pynac-0.2.4.p1.spkg. this spkg is the pynac-0.2.4 spkg from #12950 which has been patched to include the changes from burcin's `pynac-wip` branch of pynac mentioned above.
Is this stuff in the current Pynac 0.2.6?
>  2. apply all patches at #12950, here is a shell script to help that (run from `$SAGE_ROOT/devel/sage`): http://sage.math.washington.edu/home/bjones/trac_12950_apply.sh
Can now be skipped, presumably.
>  3. apply the patches to `$SAGE_ROOT/devel/sage`
>   * [This is the Trac macro *attachment:trac_12289-evalf_dictionary_rebase.patch* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#attachment:trac_12289-evalf_dictionary_rebase.patch-macro)
>   * [This is the Trac macro *attachment:trac_12289-add_algorithm_arg.patch* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#attachment:trac_12289-add_algorithm_arg.patch-macro)
>   * [This is the Trac macro *attachment:trac_12289-example.patch* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#attachment:trac_12289-example.patch-macro)
>   * [This is the Trac macro *attachment:trac_12289_py_float_fix.patch* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#attachment:trac_12289_py_float_fix.patch-macro) (fixes the problem I had in comment:4)
> 
> 4. `sage -b`


---

Comment by kcrisman created at 2013-06-19 00:55:45

Some of these patches have bitrotted slightly.  Updates coming up.


---

Comment by kcrisman created at 2013-06-19 01:03:06

Regarding Doug's comment on 

```
erf(0).n(algorithm='foo')
```

Is this something we want to fix here?  I'm not sure whether this is behavior that is supported with this patch, though perhaps it should be.  I think that so far this is _only_ putting in infrastructure, right?  I don't see any doctests here, for instance.


---

Attachment


---

Attachment


---

Comment by kcrisman created at 2013-06-19 01:17:12

Patchbot, apply trac_12289-evalf_dictionary_rebase.patch , trac_12289-add_algorithm-rebase.patch , and trac_12289-py_float-fix-rebase.patch


---

Comment by kcrisman created at 2013-06-19 01:50:36

I think that we definitely need at least one example of how to do this if we aren't going to have any other documentation here.


---

Comment by kcrisman created at 2013-06-19 02:03:40

We need to fix this.

```
----------------------------------------------------------------------
sage -t sage/symbolic/expression.pyx  # 3 doctests failed
sage -t sage/functions/other.py  # Killed due to segmentation fault
sage -t sage/functions/exp_integral.py  # 25 doctests failed
sage -t sage/functions/log.py  # 4 doctests failed
sage -t sage/symbolic/pynac.pyx  # 2 doctests failed
sage -t sage/symbolic/function.pyx  # 1 doctest failed
----------------------------------------------------------------------
```

But it does work!


---

Comment by kcrisman created at 2013-06-19 02:03:40

Changing status from new to needs_review.


---

Comment by kcrisman created at 2013-06-19 02:03:45

Changing status from needs_review to needs_work.


---

Comment by eviatarbach created at 2013-06-19 02:05:18

Changing keywords from "pynac sd35.5 sd40.5" to "pynac sd35.5 sd40.5 sd48".


---

Comment by kcrisman created at 2013-06-19 02:40:40

Okay, Burcin figured out what he forgot here :) and most of the rest should be easily fixable.


---

Comment by kcrisman created at 2013-06-19 03:07:57

Okay, everything fixed except a segfault on beta which is exactly the same one which [this](http://trac.sagemath.org/sage_trac/attachment/ticket/9130/trac_9130-py_float_segfault.take2.patch) fixed.  Burcin says that this needs to be handled properly and so 

```

static ex beta_evalf(const ex & x, const ex & y, PyObject* parent)
{
        if (is_exactly_a<numeric>(x) && is_exactly_a<numeric>(y)) {
                try {
                        return exp(lgamma(ex_to<numeric>(x))+lgamma(ex_to<numeric>(y))-lgamma(ex_to<numeric>(x+y)));
                } catch (const dunno &e) { }
        }

        return beta(x,y).hold();
}
```

in ginac/inifcns_gamma.cpp needs to be worked on in addition to other stuff.


---

Attachment


---

Comment by kcrisman created at 2013-06-19 03:12:48

Patchbot, apply trac_12289-evalf_dictionary_rebase.patch , trac_12289-add_algorithm-rebase.patch, trac_12289-py_float-fix-rebase.patch, and trac_12289-more-alg.patch


---

Attachment


---

Attachment

New patches up. All doctests pass in `sage/{symbolics,calculus}/`.


---

Comment by burcin created at 2013-06-19 20:18:27

Changing status from needs_work to needs_review.


---

Comment by kcrisman created at 2013-06-19 20:59:32

> So that we don't forget to fix it later:
> {{{
> sage: erf(1).n(algorithm='foo')
> 0.842700792949715
> sage: erf(0)
> 0
> sage: parent(erf(0))
> Integer Ring
> sage: erf(0).n(algorithm='foo')
> ---------------------------------------------------------------------------
> TypeError                                 Traceback (most recent call last)
> 
> /Users/mcneil/sagedev/sage-5.1.beta0b/sage-5.1.beta0/devel/sage-hack2/sage/<ipython console> in <module>()
> 
> /Users/mcneil/sagedev/sage-5.1.beta0b/sage-5.1.beta0/local/lib/python2.7/site-packages/sage/structure/element.so in sage.structure.element.Element.numerical_approx (sage/structure/element.c:4988)()
> 
> TypeError: numerical_approx() got an unexpected keyword argument 'algorithm'
> }}}
This is now #14778.  Shouldn't impact this being merged.

By which to say, this passes all tests.  The most recent fixes are fine.  Burcin, what would need to be reviewed still?


---

Comment by kcrisman created at 2013-07-03 17:56:20

This (or possibly a closely related patch) fails a doctest, actually.  Sorry if this isn't the precise ticket.

```
sage -t sage/misc/sagedoc.py
**********************************************************************
File "sage/misc/sagedoc.py", line 22, in sage.misc.sagedoc
Failed example:
    for line in open(docfilename):
          if "#sage.symbolic.expression.Expression.N" in line:
              print line
Expected:
    <tt class="descname">N</tt><big>(</big><em>prec=None</em>, <em>digits=None</em><big>)</big>...
Got:
    <tt class="descname">N</tt><big>(</big><em>prec=None</em>, <em>digits=None</em>, <em>algorithm=None</em><big>)</big><a class="headerlink" href="#sage.symbolic.expression.Expression.N" title="Permalink to this definition">¶</a></dt>
    <BLANKLINE>
**********************************************************************
1 item had failures:
   1 of   3 in sage.misc.sagedoc
    [73 tests, 1 failure, 9.81 s]
```


Patchbot, apply trac_12289-evalf_dictionary_rebase.take2.patch ,
trac_12289-add_algorithm-rebase.patch ,
trac_12289-more-alg.patch 
trac_12289-last_touches.patch


---

Comment by kcrisman created at 2013-09-23 17:48:17

Replying to [comment:25 kcrisman]:
> This (or possibly a closely related patch) fails a doctest, actually.  Sorry if this isn't the precise ticket.
> {{{
> sage -t sage/misc/sagedoc.py
> **********************************************************************
> File "sage/misc/sagedoc.py", line 22, in sage.misc.sagedoc
> Failed example:
>     for line in open(docfilename):
>           if "#sage.symbolic.expression.Expression.N" in line:
>               print line
> Expected:
>     <tt class="descname">N</tt><big>(</big><em>prec=None</em>, <em>digits=None</em><big>)</big>...
> Got:
>     <tt class="descname">N</tt><big>(</big><em>prec=None</em>, <em>digits=None</em>, <em>algorithm=None</em><big>)</big><a class="headerlink" href="#sage.symbolic.expression.Expression.N" title="Permalink to this definition">¶</a></dt>
>     <BLANKLINE>
> }}}

Yeah, I'm pretty sure this would do it, because of

```
def _numerical_approx(self, prec=None, digits=None, algorithm=None): 
```

in the symbolic expression file.


---

Comment by chapoton created at 2013-11-15 10:15:44

for the *patchbots*:

apply trac_12289-evalf_dictionary_rebase.take2.patch trac_12289-add_algorithm-rebase.patch trac_12289-more-alg.patch trac_12289-last_touches.patch


---

Comment by burcin created at 2013-11-15 10:29:05

This ticket depends on an SPKG update. The patchbot cannot handle those ATM.

IIRC, the pynac update is complete and waiting for review. See #15198 for details.


---

Comment by jpflori created at 2014-02-20 11:30:49

New commits:


---

Comment by git created at 2014-02-20 11:43:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-02-20 11:54:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2014-02-20 13:18:37

I just rebased the old patches and fixed an additional missing new keyword.
I'm happy with the changes.
There is still the blankline issue of comment:29.


---

Comment by git created at 2014-02-20 14:12:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2014-02-20 14:35:29

In fact the doctest was expected to change... so needs review for the two basic changes I made.
What was done before was already reviewed and I'm happy in case it was not.
----
New commits:


---

Comment by kcrisman created at 2014-02-28 15:45:37

I can't do actual testing now (or any time soon, I've really fallen off the development radar screen) but these minor changes in the last two commits are completely fine as long as the doc change fixes the problem.  Hopefully we'll actually start implementing some of these algorithms now...


---

Comment by jpflori created at 2014-02-28 15:46:57

Changing status from needs_review to positive_review.


---

Comment by jpflori created at 2014-02-28 15:46:57

Testing will be done automatically by the patchbots, so I'll take your comment as positive review.


---

Comment by vbraun created at 2014-03-04 16:58:44

Resolution: fixed


---

Comment by jdemeyer created at 2014-12-19 21:05:25

Is there any particular reason that this was done for `_evalf_` and not also plain `_eval_`?


---

Comment by jdemeyer created at 2014-12-19 21:13:33

Similarly: shouldn't `__call__` support an `algorithm` argument such that one could do

```
sage: f(0.12345, algorithm="foobar")
```

