# Issue 16381: Fix: the optimization Category_over_base._subcategory_hook_ really belongs to Category_over_base_ring

Issue created by migration from Trac.

Original creator: nthiery

Original creation time: 2014-07-04 21:42:32

CC:  darij simonking


```
           sage: from sage.categories.category_types import Category_over_base
           sage: D = Modules(Rings())
           sage: class Cs(Category_over_base):
           ....:    def super_categories(self):
           ....:        return [D]
           sage: C = Cs(SymmetricGroup(3))
           sage: C.is_subcategory(D)         # OOPS
           False
```


This is due to:

```
           sage: D._subcategory_hook_(C)
           False
```


My analysis is that the optimization implemented in
`Category_over_base._subcategory_hook_` (if the base is not the same,
then they can't be comparable) is only actually valid for
`Category_over_base_ring`s. So I moved `_subcategory_hook_` down
there. This allows for improving the answer in one corner case that
was pinpointed in the doctests.

Does this sound reasonable? Are there `Category_over_base` for which
we care about such an optimization that are not
`Category_over_base_ring`?

For the record: this issue was detected while trying with Darij to use
categories over a base ring category in symmetric functions, while the
homset ticket #10668 was applied; this triggered a recursion loop in:

```
            sage: Sym = SymmetricFunctions(FractionField(QQ['q','t']))
            sage: P = Sym.macdonald().P()
            sage: m = Sym.monomial()
            sage: P.transition_matrix(m,2)
```




---

Comment by nthiery created at 2014-07-04 21:42:50

I'll try to push later tonight ...


---

Comment by nthiery created at 2014-07-04 22:16:49

Btw: `git diff` is doing a confusing job here: the only thing that I actually changed is the `_subcategory_hook_` method and its location.


---

Comment by nthiery created at 2014-07-04 22:16:49

Changing status from new to needs_review.


---

Comment by SimonKing created at 2014-07-05 08:16:56

Why did you delete the branch field?


---

Comment by SimonKing created at 2014-07-05 08:18:52

PS: How does one download a branch "the hard way" (i.e., how do I access your branch ` u/nthiery/the_optimization_category_over_base__subcategory_hook__really_belongs_to_category_over_base_ring` if it is not accessible by `git trac 16618`)?


---

Comment by ncohen created at 2014-07-05 17:48:42


```
git fetch trac u/nthiery/the_optimization_category_over_base__subcategory_hook__really_belongs_to_category_over_base_ring:the_new_branch
git checkout the_new_branch
```



---

Comment by git created at 2014-07-06 21:24:55

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by SimonKing created at 2014-07-06 21:42:52

Argh. I just finished building the `u/nthiery/the_optimization_category_over_base__subcategory_hook__really_belongs_to_category_over_base_ring` branch. Well, I'll switch to the new "official" branch now.


---

Comment by nthiery created at 2014-07-09 14:41:44

Hi Simon!

Sorry for the mess; I was travelling with an intermitent connection. E.g. the branch field deletion was an accident when merging a manual change in the ticket and a push ...

Cheers,
                                  Nicolas


---

Comment by nthiery created at 2014-07-11 08:59:24

For the record: if I read my logs properly, all long tests passed.


---

Comment by nthiery created at 2014-09-03 12:49:09

Ping


---

Comment by SimonKing created at 2015-07-23 14:17:57

Sorry for not reacting 11 months ago.

Some comments:
- Some methods (`construction(self)`, `_homset(self, X, Y)`, `is_abelian(self)`) need documentation/tests.
- There is :trac:`???`. Should be :trac:`16618`.


---

Comment by tscrim created at 2015-10-12 16:02:21

I fixed the above comments (and while I was at it, I gave the file full coverage). 
----
New commits:


---

Comment by git created at 2015-11-30 01:23:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-01-09 12:43:18

Message to self: Review it!


---

Comment by tscrim created at 2017-05-21 01:56:47

ping


---

Comment by tscrim created at 2017-10-26 00:23:26

**ping**


---

Comment by tscrim created at 2018-02-03 19:34:27

I had forgotten about this. Pinging again.


---

Comment by SimonKing created at 2018-03-03 09:35:08

According to the patchbots, it does pass all tests on 8.2.beta6, but fails to build with 8.2.beta7. However, it seems from the patchbot's log that the errors are unrelated with the sage library (the errors occur before building the sage library).

I am thus believe it can be given a positive review.


---

Comment by SimonKing created at 2018-03-03 09:35:08

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-03-04 23:29:14

Resolution: fixed
