# Issue 17312: Rephrase the 'doctest flags' section of the developer's manual

Issue created by migration from Trac.

Original creator: ncohen

Original creation time: 2014-12-26 04:31:13

CC:  kcrisman vdelecroix tmonteil

As with previous patches, this branch is meant to make this section easier to read/browse through.

Nathann


---

Comment by ncohen created at 2014-12-26 04:31:44

Changing status from new to needs_review.


---

Comment by git created at 2014-12-26 04:31:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-12-26 04:37:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2014-12-26 09:12:09

The tolerance checks do not "work with complex numbers". The example only works because a complex number is seen as `<real number><real number>*I`.


---

Comment by jdemeyer created at 2014-12-26 09:12:09

Changing status from needs_review to needs_work.


---

Comment by ncohen created at 2014-12-26 09:26:40

> The tolerance checks do not "work with complex numbers". The example only works because a complex number is seen as `<real number><real number>*I`.

So does it work with complex number in general, or not ? Could you tell me how you would like me to rephrase that ? Or could you add a commit ? I do not see exactly how I should say it.

Nathann


---

Comment by jdemeyer created at 2014-12-26 09:42:35

Perhaps add something along the lines of

```
If a doctest with tolerance contains several numbers, each of them is checked individually::

    sage: print "The sum of 1 and 1 equals 5"  # abs tol 1
    The sum of 2 and 2 equals 4

As a consequence of this, tests involving complex numbers, matrices or polynomials usually work as expected::

    sage: <complex number example here>
    sage: M = Matrix(RR, 3, 3, [-13, 1, 1, -3, 0, -2, -4, -2, 0])
    sage: M^-1 * M   # actual result
    [     1.00000000000000  6.93889390390723e-18 -6.24500451351651e-17]
    [ 4.44089209850063e-16      1.00000000000000  1.11022302462516e-16]
    [-1.94289029309402e-16 -1.38777878078145e-17      1.00000000000000]
    sage: M^-1 * M   # tol 2e-16
    [ 1.00000000000000 0.000000000000000 0.000000000000000]
    [0.000000000000000  1.00000000000000 0.000000000000000]
    [0.000000000000000 0.000000000000000  1.00000000000000]

Note that, in the last example, the zeros are checked with **absolute** tolerance, while the non-zero entries are checked with **relative** tolerance.
```



---

Comment by git created at 2014-12-26 10:12:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2014-12-26 10:13:37

What do you think of that ? I rather like the result, I find it clearer and more complete. I simplified your example a bit, if you do not mind.

Nathann


---

Comment by ncohen created at 2014-12-26 10:13:37

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2014-12-26 17:09:19

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2014-12-26 17:09:19

This is wrong:

```
**Zero** values are always tested relative error.
```



---

Comment by ncohen created at 2014-12-26 17:11:33

> This is wrong:
> {{{
> **Zero** values are always tested relative error.
> }}}

Why is it wrong ? I thought that it is what was written in the manual already.

Nathann


---

Comment by ncohen created at 2014-12-26 17:11:58

Oh. Sorry. Absolute. And the sentence is not even correct. Will be fixed in a second.

Nathann


---

Comment by jdemeyer created at 2014-12-26 17:12:57

What was written:

```
this defaults to relative error except
when the expected value is exactly zero::
```



---

Comment by jdemeyer created at 2014-12-26 17:13:26

There is a difference between "X is always true" and "X is the default".


---

Comment by ncohen created at 2014-12-26 17:15:34

> There is a difference between "X is always true" and "X is the default".

Yes, but wasn't it written somewhere that when you had multiple output and one of them was a zero then the absolute was also used ?

Nathann


---

Comment by ncohen created at 2014-12-26 17:17:27

So is the rule like that ?

- Single output: absolute is the default for 0 output

- Multiple output: zeroes are always tested with absolute ?

Nathann


---

Comment by git created at 2014-12-26 17:26:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2014-12-26 17:26:50

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2014-12-27 08:54:26

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2014-12-27 08:54:26

Replying to [comment:15 ncohen]:
> So is the rule like that ?
> 
> - Single output: absolute is the default for 0 output
> 
> - Multiple output: zeroes are always tested with absolute ?
No!

The rule is:

- zero values: tested with absolute tolerance by default

- non-zero values: tested with relative tolerance by default

But `abs` or `rel` can override the default for both cases.


---

Comment by jdemeyer created at 2014-12-27 08:59:04

Replying to [comment:14 ncohen]:
> Yes, but wasn't it written somewhere that when you had multiple output
Every value is tested independently, every value has its own default.


---

Comment by git created at 2014-12-27 09:17:25

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by ncohen created at 2014-12-27 09:17:58

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2014-12-27 09:17:58

> Every value is tested independently, every value has its own default.

What about this last (updated) commit ?

Nathann


---

Comment by git created at 2014-12-27 09:29:39

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vbraun created at 2014-12-27 13:03:46

`sage -t --optional=internet` only runs the internet tests, and not any of the tests that are run by default. You almost always want `sage -t --optional=sage,internet`, and similar for other optional packages. IMHO this should be spelled out in more detail as it is a frequent cause for confusion.


---

Comment by ncohen created at 2014-12-27 13:08:57

Yo !

> `sage -t --optional=internet` only runs the internet tests, and not any of the tests that are run by default. You almost always want `sage -t --optional=sage,internet`, and similar for other optional packages.

True. Actually, I never ran --optional without having 'sage' inside. Should we change that instead ? I can't think of any good reason for this kind of behaviour, as it does create confusion.

Nathann


---

Comment by jdemeyer created at 2014-12-28 20:47:34

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2014-12-28 20:47:34

`The numerical values returned by the line is` -> last word should be `are`


---

Comment by jdemeyer created at 2014-12-28 20:50:22

I think the remark `(rounding error/floating point arithmetic)` is important enough that it should be clarified and expanded further: what about `(due to system-dependent floating point arithmetic or math libraries or non-deterministic algorithms)`.


---

Comment by jdemeyer created at 2014-12-28 20:52:02

`the representation of complex numbers, matrices, or polynomials involve` -> change last word to `usually involves`


---

Comment by jdemeyer created at 2014-12-28 20:54:46

The sentence `Neither of this applies to files or directories which are explicitly given as command line arguments: those are always tested.` should be outside the list, since it refers both to files and directories. It should not be just in the "directory" item.


---

Comment by git created at 2014-12-29 03:20:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2014-12-29 03:22:26

Yo !

I implemented all changes that you asked. I only omitted "math libraries" from 
`(due to system-dependent floating point arithmetic or math libraries or non-deterministic algorithms)`

Because in my understanding, most of what Sage contains is a math library. Fortunately what causes problems in the third-party math librarires that we use is precisely floating-point airethmetic or non-deterministic algorithms, so that's fine.

Nathann


---

Comment by ncohen created at 2014-12-29 03:22:37

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2014-12-29 10:01:33

I actually meant

```
system-dependent (floating point arithmetic or math libraries) or non-deterministic algorithms
```

i.e. system-dependent math libraries, not Sage math libraries.

> Fortunately what causes problems in the third-party math librarires that we use is precisely floating-point airethmetic or non-deterministic algorithms, so that's fine.
That's not actually true. You could have exactly the same hardware with different deterministic results for `log()` because the system uses a different library to compute `log()`. That's what I meant.


---

Comment by git created at 2014-12-29 10:07:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2014-12-29 10:08:57

> That's what I meant.

Done.

Nathann


---

Comment by ncohen created at 2014-12-30 13:12:41

Is there anything else Jeroen ?


---

Comment by vbraun created at 2014-12-30 17:22:06

What about the `--optional=sage,keyword`? The rationale was that you might be able to speed up testing by only running the optional tests, but in practice that pretty much never works (since some intermediate steps tend to not have the `#optional` tag) and I've never used it. IMHO: Either document it clearly or change the behavior.

Maybe Karl-Dieter wants to give it a read since he's the only native English speaker...


---

Comment by jdemeyer created at 2014-12-30 20:20:02

`A line flagged with ``optional - keyword``, it is not tested`: remove "`, it`"


---

Comment by jdemeyer created at 2014-12-30 20:22:00

In the sentence `the representation of complex numbers, matrices, or polynomials usually involve ...`, I really think that it should be `involves` since "representation" is singular.


---

Comment by jdemeyer created at 2014-12-30 20:31:32

Replying to [comment:37 vbraun]:
> What about the `--optional=sage,keyword`? The rationale was that you might be able to speed up testing by only running the optional tests, but in practice that pretty much never works (since some intermediate steps tend to not have the `#optional` tag) and I've never used it. IMHO: Either document it clearly or change the behavior.
I wouldn't change the behavior now, but I agree that it should be documented.


---

Comment by jhpalmieri created at 2014-12-30 21:57:14

Replying to [comment:37 vbraun]:
> What about the `--optional=sage,keyword`? The rationale was that you might be able to speed up testing by only running the optional tests, but in practice that pretty much never works (since some intermediate steps tend to not have the `#optional` tag) and I've never used it. IMHO: Either document it clearly or change the behavior.

I agree that this should be documented.

> Maybe Karl-Dieter wants to give it a read since he's the only native English speaker...

The English looks okay to me.

Two more suggestions: we should define relative and absolute tolerance, or at least give a link to a definition. Also, maybe we should emphasize that the "32-bit" and "64-bit" flags go on the **output** lines, not the input lines the way the other flags do. (Either before or after the example: "`Note that unlike the other flags, these keywords go on the *output* lines, not the input lines.`)


---

Comment by git created at 2014-12-31 03:23:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2014-12-31 03:37:00

Hello guys !

> What about the --optional=sage,keyword?

It is already documented in the chapter (that this patch renames to) "Running the doctests". The section about the 'optional' flag begins with a link toward that page

http://www.sagemath.org/doc/developer/doctesting.html#run-optional-tests

I think that it is sufficient for the moment, especially since we all seem to agree that this behaviour should be changed so that 'sage' is always included in `--optional=<a list>`.

> `A line flagged with ``optional - keyword```, it is not tested: remove `", it"`
Done.

> I really think that it should be involves since "representation" is singular.
Done.

> Also, maybe we should emphasize that the "32-bit" and "64-bit" flags go on the output lines.
Done

From the look of your comments I have no idea if you consider that this ticket can be switched to `positive_review` yet, but I would really appreciate it if you could make all your comments at once, next time. I have already pushed 6 different review commits here, and that is much more work than implementing at once all of the reviewer's comments.

Thanks,

Nathann


---

Comment by jdemeyer created at 2014-12-31 09:24:08

Replying to [comment:43 ncohen]:
> I would really appreciate it if you could make all your comments at once, next time. I have already pushed 6 different review commits here, and that is much more work than implementing at once all of the reviewer's comments.

Don't forget that there was a lot of confusion about the tolerance stuff... I think that's mainly what caused the many commits. Also, it's not also always to give all reviewer comments at once: when there are major mistakes, I find it harder to concentrate on spelling errors. Also, sometimes I have comments about the review commits...

I was also busy doing other things these days, so I didn't have the time to make those review commits myself like I would usually do.


---

Comment by ncohen created at 2014-12-31 09:28:35

> Don't forget that there was a lot of confusion about the tolerance stuff...

Yeah that's true.

Well. Hopefully it is all good now `:-P`

Nathann


---

Comment by jdemeyer created at 2014-12-31 09:47:41

New commits:


---

Comment by jdemeyer created at 2014-12-31 09:47:41

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2014-12-31 09:48:00

I fixed one more typo which was not your fault :-)


---

Comment by ncohen created at 2014-12-31 09:55:21

> I fixed one more typo which was not your fault :-)

Oh, right.... `O_o`

Thanks for the review !

Nathann


---

Comment by jhpalmieri created at 2014-12-31 15:56:00

I won't object to the positive review, but I still think that we should explain what relative vs. absolute tolerance is.


---

Comment by ncohen created at 2015-01-01 05:09:31

Changing status from positive_review to needs_review.


---

Comment by ncohen created at 2015-01-01 05:09:31

> I won't object to the positive review, but I still think that we should explain what relative vs. absolute tolerance is. 

Can you review this new commit ?

Nathann
----
New commits:


---

Comment by jhpalmieri created at 2015-01-01 15:53:52

Great, thanks!


---

Comment by jhpalmieri created at 2015-01-01 15:53:52

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-01-02 15:46:00

Resolution: fixed
