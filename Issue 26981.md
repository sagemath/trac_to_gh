# Issue 26981: add GAP package crypting and possibly more.

Issue created by migration from https://trac.sagemath.org/ticket/27218

Original creator: dimpase

Original creation time: 2019-02-04 18:53:29

CC:  zerline embray fbissey

Keywords: GAP packages

see the subject (to be edited)


---

Comment by dimpase created at 2019-02-04 20:08:41

The following patch (to the branch of #26930) installs crypting to the right place, and starts installation

```
--- a/build/pkgs/gap_packages/spkg-install
+++ b/build/pkgs/gap_packages/spkg-install
@@ -17,6 +17,7 @@ sdh_install \
     crime-* \
     cryst \
     crystcat \
+    crypting-* \
     design \
     gbnp \
     Hap* \
@@ -63,7 +64,7 @@ install_compiled_pkg()
 #
 # These packages have an old ./configure that take the GAP_ROOT as a positional
 # argument
-for pkg in cohomolo-* grape-* guava-*
+for pkg in cohomolo-* crypting-* grape-* guava-*
 do
     echo "Building GAP package $pkg"
     cd "$PKG_SRC_DIR/$pkg"
```


However, this still needs work, as building fails with 

```
[gap_packages-4.10.0] Building GAP package crypting-0.9
[gap_packages-4.10.0] Using config in /home/dimpase/Sage/sagetrac-mirror/local/share/gap/sysinfo.gap
[gap_packages-4.10.0] Building gap_packages-4.10.0
[gap_packages-4.10.0] make[2]: Entering directory '/home/dimpase/Sage/sagetrac-mirror/local/var/tmp/sage/build/gap_packages-4.10.0/src/pkg/crypting-0.9'
[gap_packages-4.10.0] /home/dimpase/Sage/sagetrac-mirror/local/share/gap/gac: 73: .: Can't open /home/dimpase/Sage/sagetrac-mirror/local/var/tmp/sage/build/gap-4.10.0/src/sysinfo.gap
[gap_packages-4.10.0] Makefile:104: recipe for target 'obj/crypting.lo' failed
```


Basically, `gac` expects `sysinfo.gap` in the build tree, not in place announced in the 2nd line: `Using config in...`.


---

Comment by dimpase created at 2019-02-04 23:35:40

I didn't look in detail into libtool yet...


---

Comment by dimpase created at 2019-02-04 23:58:10

After fixing `gac` as above, I get


```
[gap_packages-4.10.0] Building GAP package crypting-0.9
[gap_packages-4.10.0] Using config in /home/dimpase/Sage/sagetrac-mirror/local/share/gap/sysinfo.gap
[gap_packages-4.10.0] Building gap_packages-4.10.0
[gap_packages-4.10.0] make[2]: Entering directory '/home/dimpase/Sage/sagetrac-mirror/local/var/tmp/sage/build/gap_packages-4.10.0/src/pkg/crypting-0.9'
[gap_packages-4.10.0] /bin/bash /home/dimpase/Sage/sagetrac-mirror/local/share/gap/src/libtool --mode=compile gcc -O2 -g -MQ obj/crypting.lo -MMD -MP -MF obj/.deps/crypting.d -o obj/crypting.lo -I/home/dimpase/Sage/sagetrac-mirror/local/var/tmp/sage/build/gap-4.10.0/src/gen -I/home/dimpase/Sage/sagetrac-mirror/local/var/tmp/sage/build/gap-4.10.0/src/src -I/home/dimpase/Sage/sagetrac-mirror/local/var/tmp/sage/build/gap-4.10.0/src -DHAVE_CONFIG_H -I/home/dimpase/Sage/sagetrac-mirror/local/include -c src/crypting.c
[gap_packages-4.10.0] /bin/bash: /home/dimpase/Sage/sagetrac-mirror/local/share/gap/src/libtool: No such file or directory
[gap_packages-4.10.0] Makefile:104: recipe for target 'obj/crypting.lo' failed
```



---

Comment by fbissey created at 2019-02-05 01:38:01

What an horrible little thing. It relies on gap's libtool to be configured I am guessing. `gac` should just go and die, I haven't changed my opinion since previous version of gap. Using all this stuff to fail to build something from one source file and installing it? Priceless.

At least `IO` uses real autotools so things are more easily correctable. Here I feel like using
* a patch (same issue as `IO`)
* a one liner compilation in spkg-install - libtool makes it easy to have the right extension so may be more line just to have that right
* manual installation where gap expect it. That involves sourcing `sysinfo.gap` to find `GAParch`.

One liner: `$CC -shared -fPIC ${CFLAGS} crypting.{SOEXT} src/crypting.c`


---

Comment by dimpase created at 2019-02-05 13:39:18

Changing status from new to needs_review.


---

Comment by dimpase created at 2019-02-05 13:39:18

The following works:

1) create a symbolic link from SAGE_LOCAL/include/gap to SAGE_LOCAL/include/src
(this makes the patch for include locations unnecessary, also for GAP's IO

2) install GAP's libtool the same way we install gac.
(it should be one level below gac, in src/ subdirectory)

3) patch gac as explained

after this, with the patch in comment 2, crypting gets installed just fine.


----

my plan is now to do everything on #26930, and close this one, because it's too many small interconnecting things.


---

Comment by dimpase created at 2019-02-05 13:40:01

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2019-02-05 13:40:01

further work on this on #26930


---

Comment by embray created at 2019-02-05 15:37:15

I think you're trying to combine too many different things in #26930.  Let's repurpose this ticket for fixing aspects of the GAP "installation" such as `sysinfo.gap` and correct installation of `gac`.

Then you can make #26930 depend on this.


---

Comment by embray created at 2019-02-05 15:37:15

Changing status from positive_review to needs_work.


---

Comment by embray created at 2019-02-05 15:41:24

So it appears that for building various compiled packages, their build system assumes you're also running GAP itself out of a source tree, such that various build-related utilities and files used for building GAP itself can be repurposed for building GAP packages.

Part of me is almost tempted to say that GAP packages should be built in a GAP build tree (i.e. re-extracting the main GAP source tarball, running `./configure` in it (though maybe not `make`; unclear) and then building the extension package.

However, what is actually needed for this might be narrow enough that we can install it into `share/gap`.  It's also clear that the `sysinfo.gap` file needs to be patched up.  Let me examine exactly what the "crypting" package is trying to do before moving forward.


---

Comment by dimpase created at 2019-02-05 15:48:47

I got crypting pkg building out of the build tree, see my comments above.


---

Comment by embray created at 2019-02-05 15:58:21

Also clearly `gac` needs to be fixed.  It _is_ installed (something I recall making sure of), but I didn't realize that it was partially generated, with hard-coded paths in it :(


---

Comment by dimpase created at 2019-02-05 16:21:41

Replying to [comment:14 embray]:
> Also clearly `gac` needs to be fixed.  It _is_ installed (something I recall making sure of), but I didn't realize that it was partially generated, with hard-coded paths in it :(

Well, this should have been clear from the ticket description.It suffices to do the changes as indicated there for it to be good enough for the job. And while clearing up sysinfo.gap would be nice, I'd rather leave it to upstream.


---

Comment by embray created at 2019-02-05 16:31:17

Replying to [comment:15 dimpase]:
> Replying to [comment:14 embray]:
> > Also clearly `gac` needs to be fixed.  It _is_ installed (something I recall making sure of), but I didn't realize that it was partially generated, with hard-coded paths in it :(
> 
> Well, this should have been clear from the ticket description.It suffices to do the changes as indicated there for it to be good enough for the job. And while clearing up sysinfo.gap would be nice, I'd rather leave it to upstream.

Yes, I was just confirming.

I think sysinfo.gap needs to be fixed as well, but that's easy enough.

I would rather leave _all_ of this to upstream, though maybe our experiences here will help me help them improve the installation system for GAP.


---

Comment by dimpase created at 2019-02-05 16:33:58

Are you planning to work on this? If not, should I have a go at it?


---

Comment by embray created at 2019-02-05 16:37:09

With this fix, which is admittedly a hack (but an appropriate one), I was able to compile the crypting package from just any arbitrary location so long as I ran `configure $SAGE_LOCAL/share/gap` first.

Actually _installing_ is another question, albeit mostly just a question of copying the source tree for the package into `$SAGE_LOCAL/share/gap/pkg` while making sure to strip out any build artifacts.
----
New commits:


---

Comment by embray created at 2019-02-05 16:37:09

Changing status from needs_work to needs_review.


---

Comment by embray created at 2019-02-05 16:42:25

This also worked for configuring and compiling the IO package without any needless patches.


---

Comment by dimpase created at 2019-02-05 16:45:34

could you also add to this branch the installation of crypting and io in gap_packages/spkg-install ? This would be a good test.


---

Comment by embray created at 2019-02-05 16:46:10

Changing priority from major to critical.


---

Comment by embray created at 2019-02-05 16:46:10

This is important if anyone wants to install compiled GAP packages with Sage's GAP, whether manually, or through an SPKG.


---

Comment by embray created at 2019-02-05 16:46:27

Replying to [comment:21 dimpase]:
> could you also add to this branch the installation of crypting and io in gap_packages/spkg-install ? This would be a good test.

Working on that now.


---

Comment by embray created at 2019-02-05 16:47:03

Actually, this should also bump the patch-level on the GAP SPKG.


---

Comment by git created at 2019-02-05 16:47:47

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by fbissey created at 2019-02-05 19:30:38

For the record I don't intend to install gap's libtool in sage-on-gentoo. Yes gap has ugly bits just like sage had 10 years ago. `gac` could be an interesting tool once fixed and `sysinfo.gap` similarly needs to be more conform to an installation rather than an in tree thing. 

In the few packages where it was important so far, only `GAParch` was really needed for an install for me. The rest was superfluous. It would be useful if `sysinfo.gap` had the proper include path so the problem of `#include "src/..."` versus `#include "gap/..."` would go away. Sounds like a job for pkg-config.


---

Comment by jdemeyer created at 2019-02-06 09:57:28

Replying to [comment:26 fbissey]:
> For the record I don't intend to install gap's libtool in sage-on-gentoo.

Typically, `libtool` is not installed. It is shipped as part of the package installer and only used as build tool, analogous to `configure` for example.


---

Comment by jdemeyer created at 2019-02-06 10:01:22

Given that we use the same tarball for gap and for gap_packages, couldn't we just run `libtool` from the source tarball, the way how it's usually done?


---

Comment by dimpase created at 2019-02-06 10:07:43

Replying to [comment:28 jdemeyer]:
> Given that we use the same tarball for gap and for gap_packages, couldn't we just run `libtool` from the source tarball, the way how it's usually done?

not all GAP packages live in this tarball. Not installing the necessary components to build GAP packages will lead to a half-broken GAP installation. I don't think it's a good idea.


---

Comment by dimpase created at 2019-02-06 11:24:30

Changing status from needs_review to needs_info.


---

Comment by dimpase created at 2019-02-06 11:24:30

Regarding this branch:

```
[gap_packages-4.10.0.p0] Building GAP package crypting-0.9
[gap_packages-4.10.0.p0] Using config in /mnt/opt/Sage/sage-dev/local/share/gap/sysinfo.gap
[gap_packages-4.10.0.p0] Building gap_packages-4.10.0.p0
[gap_packages-4.10.0.p0] make[2]: Entering directory '/mnt/opt/Sage/sage-dev/local/var/tmp/sage/build/gap_packages-4.10.0.p0/src/pkg/crypting-0.9'
[gap_packages-4.10.0.p0] /usr/bin/bash /mnt/opt/Sage/sage-dev/local/share/gap/libtool --mode=compile gcc -O2 -g -MQ obj/crypting.lo -MMD -MP -MF obj/.deps/crypting.d -o obj/crypting.lo -I/mnt/opt/Sage/sage-dev/local/share/gap/gen -I/mnt/opt/Sage/sage-dev/local/var/tmp/sage/build/gap-4.10.0.p0/src/src -I/mnt/opt/Sage/sage-dev/local/var/tmp/sage/build/gap-4.10.0.p0/src -DHAVE_CONFIG_H -I/mnt/opt/Sage/sage-dev/local/include -c src/crypting.c
[gap_packages-4.10.0.p0] libtool: compile:  gcc -O2 -g -MQ obj/crypting.lo -MMD -MP -MF obj/.deps/crypting.d -I/mnt/opt/Sage/sage-dev/local/share/gap/gen -I/mnt/opt/Sage/sage-dev/local/var/tmp/sage/build/gap-4.10.0.p0/src/src -I/mnt/opt/Sage/sage-dev/local/var/tmp/sage/build/gap-4.10.0.p0/src -DHAVE_CONFIG_H -I/mnt/opt/Sage/sage-dev/local/include -c src/crypting.c  -fPIC -DPIC -o obj/.libs/crypting.o
[gap_packages-4.10.0.p0] src/crypting.c:5:10: fatal error: src/compiled.h: No such file or directory
[gap_packages-4.10.0.p0]  #include "src/compiled.h"          /* GAP headers */
[gap_packages-4.10.0.p0]           ^~~~~~~~~~~~~~~~
```


That is, one still needs to take care of header location.
E.g.

```
ln -s $SAGE_LOCAL/include/gap $SAGE_LOCAL/include/src
```

allows crypting to be installed using the patch in comment 2.
Would you like this header issue to be solved here, or done on #26930?


---

Comment by embray created at 2019-02-06 12:19:11

Replying to [comment:26 fbissey]:
> For the record I don't intend to install gap's libtool in sage-on-gentoo. Yes gap has ugly bits just like sage had 10 years ago.

You mean just like sage has now? ;)


---

Comment by embray created at 2019-02-06 12:27:11

Something about this still isn't working right then, because this


```
-I/mnt/opt/Sage/sage-dev/local/var/tmp/sage/build/gap-4.10.0.p0/src/src
```


should not be in the compile flags.  I thought I made sure there would be no more references to the build directory, but I was tired last night when I was working on this so I must have missed something.

Also I agree with Jeroen of course that normally a libtool script should not be installed, though in this case it might be reasonable to do.


---

Comment by embray created at 2019-02-06 12:27:51

Changing status from needs_info to needs_work.


---

Comment by embray created at 2019-02-06 12:35:42

Oops, duh, I left a `g` off the sed replacement pattern.  That's why you correctly have `-I/mnt/opt/Sage/sage-dev/local/share/gap/gen`, but then the rest of the `-I` flags still have the wrong path 🤦🏼‍♀️


---

Comment by dimpase created at 2019-02-06 12:42:22

By the way, you should use `$SED`, not `sed`, right?


---

Comment by dimpase created at 2019-02-06 12:56:05

I can confirm that after adding that `|g` to `sed` pattern, everything is fine, great!
Please fix this in your branch, and you can flip it to positive review then.


---

Comment by git created at 2019-02-06 13:59:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2019-02-06 14:14:39

Should also fix up `bin/gap.sh` (although we don't use it in Sage, it should still contain the correct paths, maybe just in case some pkg uses it during a build) and also `doc/make_doc` contains references to the GAP builddir.


---

Comment by git created at 2019-02-06 14:19:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2019-02-06 14:22:11

Replying to [comment:35 dimpase]:
> By the way, you should use `$SED`, not `sed`, right?

That's generally just in an autoconf macro, where if you have done `AC_PROG_SED`.  It's not necessarily bad practice to use a `$SED` variable either, in case it needs to be overridden for some reason, but in that case you'd still have to set a default somewhere, and we aren't doing that in any other `spkg-install` script.


---

Comment by embray created at 2019-02-06 14:22:26

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2019-02-06 15:23:55

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2019-02-06 15:23:55

OK, thanks!


---

Comment by fbissey created at 2019-02-06 17:59:45

Replying to [comment:31 embray]:
> Replying to [comment:26 fbissey]:
> > For the record I don't intend to install gap's libtool in sage-on-gentoo. Yes gap has ugly bits just like sage had 10 years ago.
> 
> You mean just like sage has now? ;)

Yes :) but 10 years ago it was way worse. Where do you want me to start ;) Enough off topic from me.


---

Comment by vbraun created at 2019-02-08 12:35:00

On OSX:

```
sed: 1: "/Users/buildslave-sage/ ...": undefined label 'uildslave-sage/slave/sage_git/build/local/var/tmp/sage/build/gap-4.10.0.p0/inst/Users/buildslave-sage/slave/sage_git/build/local/bin/gac'
```



---

Comment by vbraun created at 2019-02-08 12:35:00

Changing status from positive_review to needs_work.


---

Comment by embray created at 2019-02-08 12:53:54

It appears on OSX you need `sed -i -e <pattern>` or else it will treat `<pattern>` as the optional parameter to `-i`.  I really hate this platform.


---

Comment by git created at 2019-02-08 13:03:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by slelievre created at 2019-02-09 00:37:33

Replying to [comment:45 embray]:
> It appears on OSX you need `sed -i -e <pattern>` or else it will treat `<pattern>` as the optional parameter to `-i`.  I really hate this platform.

Yes, this hit us already at #25321 ("sed -i is not portable").


---

Comment by dimpase created at 2019-02-09 08:27:13

This particular bug is fixed, but I still cannot reinstall GAP spkg on OSX without first manually removing all of `SAGE_LOCAL/share/gap`. Some file permissions are wrong (on OSX)...


---

Comment by dimpase created at 2019-02-09 10:50:44

Also, on OSX paths to binary files of GAP packages are not correct. E.g. `local/lib/gap/pkg/io-4.5.4/x86_64-apple-darwin17.7.0-default64/` instead of `local/lib/gap/pkg/io-4.5.4/bin/x86_64-apple-darwin17.7.0-default64/`, and IO package does not load.
If I do 

```
$ mkdir local/lib/gap/pkg/io-4.5.4/bin
$ mv local/lib/gap/pkg/io-4.5.4/x86_64-apple-darwin17.7.0-default64 local/lib/gap/pkg/io-4.5.4
```

then it works.


---

Comment by dimpase created at 2019-02-09 13:29:15

perhaps one should switch from doing `cp` etc. to doing `install`, as suggested on https://github.com/gap-system/gap-distribution/issues/72


---

Comment by embray created at 2019-02-22 14:08:41

Changing status from needs_work to positive_review.


---

Comment by embray created at 2019-02-22 14:08:41

Forgot to set this back to needs review after fixing the sed call.  Other problems about uninstalling packages on OSX are separate and unrelated to this ticket (see e.g. #27124).


---

Comment by vbraun created at 2019-02-23 23:14:52

Resolution: fixed
