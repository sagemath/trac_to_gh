# Issue 29385: cygwin: Fixes for CI

Issue created by migration from https://trac.sagemath.org/ticket/29622

Original creator: mkoeppe

Original creation time: 2020-04-29 23:58:19

CC:  dimpase slelievre embray

Hopefully the last change for the CI for 9.1


---

Comment by mkoeppe created at 2020-04-30 00:02:13

Last 10 new commits:


---

Comment by mkoeppe created at 2020-05-01 00:55:59

This fixes some syntax errors in the cygwin build. Now it times out in stage 3. This would need to be rebalanced or split into several parallel stages


---

Comment by mkoeppe created at 2020-05-01 20:03:38

Changing status from new to needs_review.


---

Comment by git created at 2020-05-02 18:08:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-05-02 18:09:54

getting closer - https://github.com/mkoeppe/sage/runs/639064085


---

Comment by mkoeppe created at 2020-05-02 19:30:19

`Fatal error: can't write 24 bytes to section .text of build/temp.cygwin-3.1.4-x86_64-3.7/build/cythonized/sage/rings/laurent_series_ring_element.o: 'No space left on device'`


---

Comment by git created at 2020-05-02 20:14:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-05-02 20:27:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-05-02 22:59:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-05-03 15:24:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-05-03 15:52:39

This now manages to build Sage on Cygwin (see `cygwin-stage-iii` in https://github.com/mkoeppe/sage/runs/640373882)


---

Comment by git created at 2020-05-03 16:02:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-05-03 16:14:38

Ready for review


---

Comment by mkoeppe created at 2020-05-04 02:49:43

`cygwin-minimal`, stage-ii-a and stage-ii-c still time out (https://github.com/mkoeppe/sage/runs/641053384); more rebalancing should be done in the next release cycle. I stop for this ticket and 9.1. 

Uploading and downloading of our large sage-local artifacts is somewhat brittle, a game of chance: For example, in https://github.com/mkoeppe/sage/runs/641209977 (`cygwin-standard`), stage-iii :

```
Exponential backoff for retry #5. Waiting for 33036.92082171844 milliseconds before continuing the upload at offset 1379926016
Total file count: 1 ---- Processed file #0 (0.0%)
Finished backoff for retry #5, continuing with upload
Total file count: 1 ---- Processed file #0 (0.0%)
An error has been caught http-client index 0, retrying the upload
Error: read ECONNRESET
    at TLSWrap.onStreamRead (internal/stream_base_commons.js:201:27) {
  errno: 'ECONNRESET',
  code: 'ECONNRESET',
  syscall: 'read'
}
Retry limit has been reached for chunk at offset 1379926016 to https://pipelines.actions.githubusercontent.com/4D1poTSDSSApU42GXYeGgQX6WjHwGPK9ZzdaE2SeHdlUs0ZBhW/_apis/resources/Containers/3201477?itemPath=sage-local-commit-b2c012bfed0fb9414e0db531acc43a3abf1ae1ba-cygwin-standard%5Csage-local-iii.tar
##[warning]Aborting upload for C:\tools\cygwin\tmp\sage-local-iii.tar due to failure
Total size of all the files uploaded is 1379926016 bytes
```


In the same run, for https://github.com/mkoeppe/sage/runs/641394549 (`cygwin-standard-python2`), the upload of stage-iii succeeded,
and stage-iv-a ... stage-iv-d downloaded it successfully. 
- stage-iv-a (`make ptest`, https://github.com/mkoeppe/sage/runs/641394549) terminates, with a number of doctest errors and timeouts:
  {{{
sage -t src/doc/en/constructions/plotting.rst  # Timed out
sage -t src/doc/fr/tutorial/interfaces.rst  # 1 doctest failed
sage -t src/doc/ja/tutorial/interfaces.rst  # 2 doctests failed
sage -t src/doc/pt/tutorial/interfaces.rst  # Timed out
sage -t src/doc/ru/tutorial/interfaces.rst  # 6 doctests failed
sage -t src/sage/coding/binary_code.pyx  # Timed out
sage -t src/sage/doctest/control.py  # 1 doctest failed
sage -t src/sage/functions/log.py  # 1 doctest failed
sage -t src/sage/functions/orthogonal_polys.py  # 1 doctest failed
sage -t src/sage/functions/other.py  # 2 doctests failed
sage -t src/sage/dynamics/arithmetic_dynamics/projective_ds.py  # Timed out
sage -t src/sage/interfaces/gap.py  # 1 doctest failed
sage -t src/sage/groups/class_function.py  # Timed out
sage -t src/sage/interfaces/giac.py  # 41 doctests failed
sage -t src/sage/libs/gap/element.pyx  # 1 doctest failed
sage -t src/sage/libs/glpk/error.pyx  # 2 doctests failed
sage -t src/sage/matrix/matrix1.pyx  # 1 doctest failed
sage -t src/sage/numerical/backends/glpk_backend.pyx  # 2 doctests failed
sage -t src/sage/parallel/map_reduce.py  # Timed out after testing finished
sage -t src/sage/repl/interpreter.py  # 3 doctests failed
sage -t src/sage/rings/number_field/number_field_element.pyx  # Timed out
sage -t src/sage/sandpiles/sandpile.py  # Timed out
sage -t src/sage/symbolic/constants.py  # 3 doctests failed
sage -t src/sage/symbolic/expression_conversions.py  # 1 doctest failed
sage -t src/sage/symbolic/expression.pyx  # 1 doctest failed
sage -t src/sage/tests/benchmark.py  # 2 doctests failed
sage -t src/sage/tests/books/computational-mathematics-with-sagemath/sol/graphique_doctest.py  # 1 doctest failed
sage -t src/sage/tests/cmdline.py  # 3 doctests failed
  }}}
  Looks like the giac interface is broken. 

- stage-iv-b builds a few optional packages; I have noted build failures in some separate tickets.

- stage-iv-c builds `cbc`, `sage_numerical_backends_coin` successfully.

- stage-iv-d (https://github.com/mkoeppe/sage/runs/641394565) builds a long list of optional packages, times out;  I have noted build failures in some separate tickets.


---

Comment by mkoeppe created at 2020-05-04 17:36:49

Needs review. Let's get this into 9.1 please


---

Comment by mkoeppe created at 2020-05-04 17:40:43

Changing priority from major to critical.


---

Comment by dimpase created at 2020-05-04 18:11:32

this looks good; one minor question is how to get logs for particular failed spkg builds.
Is the latter possible/documented, and I'm just not looking at the right place?


---

Comment by dimpase created at 2020-05-04 18:11:32

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-05-04 18:16:06

Replying to [comment:19 dimpase]:
> one minor question is how to get logs for particular failed spkg builds.
> Is the latter possible/documented, and I'm just not looking at the right place?

Do you see the artifact named "logs-...." in
https://github.com/mkoeppe/sage/actions/runs/94565308?


---

Comment by mkoeppe created at 2020-05-04 18:20:13

It contains both the logs of all packages, 
and the contents of $SAGE_LOCAL/var/tmp/sage/build/ (all failed packages)


---

Comment by mkoeppe created at 2020-05-04 18:21:35

Alternatively, if one does not want to download these huge log archives, one can open the section "Print out logs for immediate inspection" (for example in https://github.com/mkoeppe/sage/runs/641394520?check_suite_focus=true) to see logs of packages with errors. (This already works before artifacts are made available.)


---

Comment by dimpase created at 2020-05-04 19:36:25

Replying to [comment:21 mkoeppe]:
> It contains both the logs of all packages, 
> and the contents of $SAGE_LOCAL/var/tmp/sage/build/ (all failed packages)
> 
ok - I only looked at "view raw logs" - and these are, despite the name, less complete than artefacts, right?


---

Comment by mkoeppe created at 2020-05-04 19:57:26

"View raw logs" just gives you what is displayed in the right pane. This is a [GitHub](GitHub) Actions feature.
The log artefacts have a lot more, from my scripts.


---

Comment by mkoeppe created at 2020-05-06 00:41:43

Changing priority from critical to blocker.


---

Comment by vbraun created at 2020-05-07 22:21:04

Resolution: fixed
