# Issue 24004: unstopped MapReduce workers

archive/issues_024004.json:
```json
{
    "body": "CC:  @hivert\n\nSome patchbots report unstopped workers\n\n```\nsage -t --long src/sage/parallel/map_reduce.py\n**********************************************************************\nFile \"src/sage/parallel/map_reduce.py\", line 1090, in sage.parallel.map_reduce.RESetMapReduce.start_workers\nFailed example:\n    all(w.is_alive() for w in S._workers)\nExpected:\n    True\nGot:\n    False\n**********************************************************************\n1 item had failures:\n   1 of   9 in sage.parallel.map_reduce.RESetMapReduce.start_workers\n    [296 tests, 1 failure, 28.70 s]\n----------------------------------------------------------------------\nsage -t --long src/sage/parallel/map_reduce.py  # 1 doctest failed\n----------------------------------------------------------------------\n```\n\nsee\n- [this sardonis log](https://patchbot.sagemath.org/log/24215/Ubuntu/16.04/ppc64le/4.4.0-57-generic/sardonis/2017-11-18%2015:55:51?short)\n\nIssue created by migration from https://trac.sagemath.org/ticket/24241\n\n",
    "created_at": "2017-11-19T12:38:09Z",
    "labels": [
        "component: combinatorics",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "unstopped MapReduce workers",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24004",
    "user": "https://github.com/videlec"
}
```
CC:  @hivert

Some patchbots report unstopped workers

```
sage -t --long src/sage/parallel/map_reduce.py
**********************************************************************
File "src/sage/parallel/map_reduce.py", line 1090, in sage.parallel.map_reduce.RESetMapReduce.start_workers
Failed example:
    all(w.is_alive() for w in S._workers)
Expected:
    True
Got:
    False
**********************************************************************
1 item had failures:
   1 of   9 in sage.parallel.map_reduce.RESetMapReduce.start_workers
    [296 tests, 1 failure, 28.70 s]
----------------------------------------------------------------------
sage -t --long src/sage/parallel/map_reduce.py  # 1 doctest failed
----------------------------------------------------------------------
```

see
- [this sardonis log](https://patchbot.sagemath.org/log/24215/Ubuntu/16.04/ppc64le/4.4.0-57-generic/sardonis/2017-11-18%2015:55:51?short)

Issue created by migration from https://trac.sagemath.org/ticket/24241





---

archive/issue_comments_336053.json:
```json
{
    "body": "I'm not sure an obvious way to reproduce this, but maybe we could go ahead and merge #21233 and see if that fixes it?  I've been waiting forever for someone to just give it positive review (which it had previously but Volker removed it...)",
    "created_at": "2017-11-22T12:26:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24004#issuecomment-336053",
    "user": "https://github.com/embray"
}
```

I'm not sure an obvious way to reproduce this, but maybe we could go ahead and merge #21233 and see if that fixes it?  I've been waiting forever for someone to just give it positive review (which it had previously but Volker removed it...)



---

archive/issue_comments_336054.json:
```json
{
    "body": "Replying to [comment:2 embray]:\n> I'm not sure an obvious way to reproduce this, but maybe we could go ahead and merge #21233 and see if that fixes it?\n\n+1. And I would love to have a way to grep through the patchbot reports easily!",
    "created_at": "2017-11-22T14:30:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24004#issuecomment-336054",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:2 embray]:
> I'm not sure an obvious way to reproduce this, but maybe we could go ahead and merge #21233 and see if that fixes it?

+1. And I would love to have a way to grep through the patchbot reports easily!



---

archive/issue_comments_336055.json:
```json
{
    "body": "Replying to [comment:3 vdelecroix]:\n> Replying to [comment:2 embray]:\n> > I'm not sure an obvious way to reproduce this, but maybe we could go ahead and merge #21233 and see if that fixes it?\n> \n> +1. And I would love to have a way to grep through the patchbot reports easily!\n\nOpen an issue on the patchbot GitHub project for that.  I would love that too but it's probably not entirely trivial (if nothing else we'd want to index the report logs).",
    "created_at": "2017-11-22T15:54:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24004#issuecomment-336055",
    "user": "https://github.com/embray"
}
```

Replying to [comment:3 vdelecroix]:
> Replying to [comment:2 embray]:
> > I'm not sure an obvious way to reproduce this, but maybe we could go ahead and merge #21233 and see if that fixes it?
> 
> +1. And I would love to have a way to grep through the patchbot reports easily!

Open an issue on the patchbot GitHub project for that.  I would love that too but it's probably not entirely trivial (if nothing else we'd want to index the report logs).



---

archive/issue_comments_336056.json:
```json
{
    "body": "I'm not totally sure this was fixed by #21233.  Now, on several of my Cygwin patchbot runs, this module fails on the initial test run, not quite in the way reported by this ticket, but possibly similar.  I get `sage -t --long src/sage/parallel/map_reduce.py  # Timed out after testing finished` which is something I've never seen before...",
    "created_at": "2017-12-21T10:22:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24004#issuecomment-336056",
    "user": "https://github.com/embray"
}
```

I'm not totally sure this was fixed by #21233.  Now, on several of my Cygwin patchbot runs, this module fails on the initial test run, not quite in the way reported by this ticket, but possibly similar.  I get `sage -t --long src/sage/parallel/map_reduce.py  # Timed out after testing finished` which is something I've never seen before...



---

archive/issue_comments_336057.json:
```json
{
    "body": "I'm also seeing this on the buildbot",
    "created_at": "2017-12-25T18:17:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24004#issuecomment-336057",
    "user": "https://github.com/vbraun"
}
```

I'm also seeing this on the buildbot



---

archive/issue_comments_336058.json:
```json
{
    "body": "Changing keywords from \"\" to \"random_fail\".",
    "created_at": "2017-12-25T18:17:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24004#issuecomment-336058",
    "user": "https://github.com/vbraun"
}
```

Changing keywords from "" to "random_fail".



---

archive/issue_comments_336059.json:
```json
{
    "body": "This is just to say that I got this again.",
    "created_at": "2018-07-12T11:35:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24004#issuecomment-336059",
    "user": "https://github.com/jdemeyer"
}
```

This is just to say that I got this again.



---

archive/issue_comments_336060.json:
```json
{
    "body": "The doctest looks like a race condition. If I'm understanding things correctly, the workers are started and will then stop naturally (after an unspecified amount of time). If they stop really quickly, then this doctest will fail:\n\n```\n            sage: from sage.parallel.map_reduce import RESetMapReduce\n            sage: S = RESetMapReduce(roots=[])\n            sage: S.setup_workers(2)\n            sage: S.start_workers()\n            sage: all(w.is_alive() for w in S._workers)\n            True\n```\n",
    "created_at": "2018-07-12T11:41:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24004#issuecomment-336060",
    "user": "https://github.com/jdemeyer"
}
```

The doctest looks like a race condition. If I'm understanding things correctly, the workers are started and will then stop naturally (after an unspecified amount of time). If they stop really quickly, then this doctest will fail:

```
            sage: from sage.parallel.map_reduce import RESetMapReduce
            sage: S = RESetMapReduce(roots=[])
            sage: S.setup_workers(2)
            sage: S.start_workers()
            sage: all(w.is_alive() for w in S._workers)
            True
```




---

archive/issue_comments_336061.json:
```json
{
    "body": "I can make this test fail pretty consistently with\n\n```\nsage: sleep(0.02); all(w.is_alive() for w in S._workers)\n```\n\n\nIf a doctest is sensitive to 20ms delays, it's a bad test.",
    "created_at": "2018-07-12T11:47:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24004#issuecomment-336061",
    "user": "https://github.com/jdemeyer"
}
```

I can make this test fail pretty consistently with

```
sage: sleep(0.02); all(w.is_alive() for w in S._workers)
```


If a doctest is sensitive to 20ms delays, it's a bad test.



---

archive/issue_comments_336062.json:
```json
{
    "body": "Indeed; I see the problem here.  When I originally commented on this ticket, I admit, I don't think I looked very closely at the exact test that was failing.\n\nIf there's no work for the workers to do, then there's no guarantee that you'll ever find them all running simultaneously.\n\nIf you really wanted to test this, one possibility might be to set up a test logger that collects all log messages in a list, and then checks that the expected log messages are found (e.g. one \"Started\" and one \"Exiting\" for each worker started.",
    "created_at": "2018-07-12T12:51:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24004#issuecomment-336062",
    "user": "https://github.com/embray"
}
```

Indeed; I see the problem here.  When I originally commented on this ticket, I admit, I don't think I looked very closely at the exact test that was failing.

If there's no work for the workers to do, then there's no guarantee that you'll ever find them all running simultaneously.

If you really wanted to test this, one possibility might be to set up a test logger that collects all log messages in a list, and then checks that the expected log messages are found (e.g. one "Started" and one "Exiting" for each worker started.



---

archive/issue_comments_336063.json:
```json
{
    "body": "Replying to [comment:11 embray]:\n> If you really wanted to test this, one possibility might be to set up a test logger that collects all log messages in a list, and then checks that the expected log messages are found (e.g. one \"Started\" and one \"Exiting\" for each worker started.\n\nThanks to all of you for catching this one. I'm confirming jdemeyer analysis. If there is no work to do, there is no robust lower bound for the time the worker stays alive. \n\n`@`embray: there is a logger is the code but the level is normally set too low to see the message. Another possibilities would be to give as work to the worker a `sleep(1)` instruction.",
    "created_at": "2018-07-12T14:23:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24004#issuecomment-336063",
    "user": "https://github.com/hivert"
}
```

Replying to [comment:11 embray]:
> If you really wanted to test this, one possibility might be to set up a test logger that collects all log messages in a list, and then checks that the expected log messages are found (e.g. one "Started" and one "Exiting" for each worker started.

Thanks to all of you for catching this one. I'm confirming jdemeyer analysis. If there is no work to do, there is no robust lower bound for the time the worker stays alive. 

`@`embray: there is a logger is the code but the level is normally set too low to see the message. Another possibilities would be to give as work to the worker a `sleep(1)` instruction.



---

archive/issue_comments_336064.json:
```json
{
    "body": "Sorry based my file on the wrong branch... Fixing it",
    "created_at": "2018-07-12T14:27:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24004#issuecomment-336064",
    "user": "https://github.com/hivert"
}
```

Sorry based my file on the wrong branch... Fixing it



---

archive/issue_comments_336065.json:
```json
{
    "body": "The doctest fix looks good on first sight, I would still keep the `sleep(1)` in the last test though.\n\nI cannot really comment on the other changes, which seem to be related to Python 3.\n----\nNew commits:",
    "created_at": "2018-07-12T14:31:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24004#issuecomment-336065",
    "user": "https://github.com/jdemeyer"
}
```

The doctest fix looks good on first sight, I would still keep the `sleep(1)` in the last test though.

I cannot really comment on the other changes, which seem to be related to Python 3.
----
New commits:



---

archive/issue_comments_336066.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-12T14:35:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24004#issuecomment-336066",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_336067.json:
```json
{
    "body": "Replying to [comment:14 jdemeyer]:\n> The doctest fix looks good on first sight, I would still keep the `sleep(1)` in the last test though.\n> \n> I cannot really comment on the other changes, which seem to be related to Python 3.\n\nSorry based my file on the wrong branch... Should be fixed now\n----\nNew commits:",
    "created_at": "2018-07-12T14:35:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24004#issuecomment-336067",
    "user": "https://github.com/hivert"
}
```

Replying to [comment:14 jdemeyer]:
> The doctest fix looks good on first sight, I would still keep the `sleep(1)` in the last test though.
> 
> I cannot really comment on the other changes, which seem to be related to Python 3.

Sorry based my file on the wrong branch... Should be fixed now
----
New commits:



---

archive/issue_comments_336068.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-12T16:04:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24004#issuecomment-336068",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_336069.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-07-12T16:14:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24004#issuecomment-336069",
    "user": "https://github.com/hivert"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_336070.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-07-13T09:08:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24004#issuecomment-336070",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_336071.json:
```json
{
    "body": "Replying to [comment:19 jdemeyer]:\nThanks Jeroen",
    "created_at": "2018-07-13T14:12:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24004#issuecomment-336071",
    "user": "https://github.com/hivert"
}
```

Replying to [comment:19 jdemeyer]:
Thanks Jeroen



---

archive/issue_comments_336072.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-08-05T08:43:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24004#issuecomment-336072",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
