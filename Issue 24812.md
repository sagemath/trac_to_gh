# Issue 24812: Add DESTDIR support for r, and other cleanup

Issue created by migration from https://trac.sagemath.org/ticket/25049

Original creator: embray

Original creation time: 2018-03-28 13:13:07

CC:  dimpase

Implements #24024, incorporating changes to the `spkg-install` for R originally from #22509 as well as #23733.


---

Comment by embray created at 2018-03-28 13:13:36

This already got some pretty good OSX testing when it was part of #22509, but that was a while ago so it should be tested again.


---

Comment by embray created at 2018-03-28 15:01:33

Tested on OSX 10.13 and it works--R builds, its installed files are correctly listed in the manifest, and it runs at least basically.


---

Comment by embray created at 2018-03-28 15:01:38

Changing status from new to needs_review.


---

Comment by saraedum created at 2018-03-28 22:25:17

Looks good. Is the build script now run with a `set -e` so no error checking needs to be done explicitly anymore?


---

Comment by embray created at 2018-03-29 09:08:26

I'm not sure I understand your question about error checking, but it might be related to #23179.  Ever since that ticket all the stuff about checking that `$SAGE_LOCAL` is set is not necessary when writing spkg installers.


---

Comment by saraedum created at 2018-03-29 11:24:52

Hmâ€¦I had a look at #23179 but I could not find the bit I was looking for so let me rephrase my question. I can not find a `set -e` at the top of the proposed `spkg-install` script. Is that not necessary anymore? Is this somehow set from the outside now?


---

Comment by saraedum created at 2018-03-29 11:24:59

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2018-03-29 12:20:02

Can't we get rid of the "move old installs" part? Doesn't `DESTDIR` solve that problem?


---

Comment by jdemeyer created at 2018-03-29 12:21:25

Replying to [comment:4 saraedum]:
> Looks good. Is the build script now run with a `set -e`

No: `set -e` was *not* used before and it is still *not* used.


---

Comment by embray created at 2018-03-29 13:57:25

Replying to [comment:8 jdemeyer]:
> Can't we get rid of the "move old installs" part? Doesn't `DESTDIR` solve that problem?

It definitely does not _necessarily_ solve that problem.  What will solve it later will be #22510--once uninstall is in place then I think the behavior for all packages should be, when upgrading them, to uninstall the old version (and optionally make a backup), with restoration of the backup occurring on error.


---

Comment by embray created at 2018-03-29 13:57:25

Changing status from needs_info to needs_review.


---

Comment by saraedum created at 2018-03-30 06:00:52

Replying to [comment:9 jdemeyer]:
> Replying to [comment:4 saraedum]:
> > Looks good. Is the build script now run with a `set -e`
> 
> No: `set -e` was *not* used before and it is still *not* used.

So, should it be used?


---

Comment by saraedum created at 2018-03-30 06:09:20

Changing status from needs_review to needs_info.


---

Comment by embray created at 2018-03-30 13:27:40

Changing status from needs_info to needs_review.


---

Comment by embray created at 2018-03-30 13:27:40

No, I don't know why you think so.


---

Comment by jdemeyer created at 2018-03-30 13:30:49

Still, can we get rid of the "move old installs" part anyway? If the build breaks, just let it be broken.


---

Comment by embray created at 2018-03-30 13:32:08

I don't mind, but tbh I'm not sure exactly what it was for in the first place.  I assume we probably have to at least _remove_ the old install.  The restoring part can go (as I said we'll implement that capability more generally later).


---

Comment by saraedum created at 2018-04-01 08:45:35

Replying to [comment:13 embray]:
> No, I don't know why you think so.

```
-config
-if [ $? -ne 0 ]; then
+# Run in a subshell in case config with X11 support fails
+if ! (config); then
     echo "Configuring R without X11"
     XSUPPORT=no
     config
-    if [ $? -ne 0 ]; then
-        echo >&2 "Error configuring R."
-        exit 1
-    fi
 fi
```

So we won't abort if the inner `config` fails here?


---

Comment by saraedum created at 2018-04-01 08:47:06

Changing status from needs_review to needs_info.


---

Comment by embray created at 2018-04-03 15:22:30

No, please check the implementation of `sdh_configure` in `src/bin/sage-dist-helpers`.  Part of the point of all the `sdh_` helpers is that they exit upon failure (that's why the first `config` needs to be run in a sub-shell).


---

Comment by saraedum created at 2018-04-03 16:41:02

Changing status from needs_info to positive_review.


---

Comment by saraedum created at 2018-04-03 16:42:09

Sorry, I had misunderstood `config()`.


---

Comment by vbraun created at 2018-05-09 18:46:50

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2018-05-09 18:46:50

Merge conflict


---

Comment by embray created at 2018-07-18 11:47:03

I believe this issue can reasonably be addressed for Sage 8.4.


---

Comment by git created at 2018-09-06 14:00:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-09-06 14:01:43

Changing status from needs_work to needs_review.


---

Comment by git created at 2018-09-06 14:16:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-06 14:18:19

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-09-06 14:18:36

(accidentally split 1 commit into 2; fixed now)


---

Comment by embray created at 2018-12-28 14:10:15

Retargeting some of my tickets (somewhat optimistically for now).


---

Comment by chapoton created at 2019-03-10 10:49:38

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2019-03-10 10:49:38

red branch


---

Comment by embray created at 2019-03-25 10:43:18

Moving all my in-progress tickets to 8.8 milestone.


---

Comment by embray created at 2019-06-14 14:50:27

Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).


---

Comment by embray created at 2019-12-30 14:48:17

Ticket retargeted after milestone closed


---

Comment by git created at 2020-01-31 15:24:53

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-01-31 15:26:14

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2020-01-31 15:27:29

Changing status from needs_work to needs_review.


---

Comment by embray created at 2020-01-31 15:27:29

Reviving this ticket because it still needs to be done.

It's a bit simpler now: because we always uninstall old packages before reinstalling/upgrading them, some of the OSX hacks are no longer needed (if they even ever really were...)
----
New commits:


---

Comment by dimpase created at 2020-01-31 19:02:05

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-01-31 19:02:05

looks good to me


---

Comment by vbraun created at 2020-02-10 20:06:03

Resolution: fixed
