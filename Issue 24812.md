# Issue 24812: Add DESTDIR support for r, and other cleanup

archive/issues_024812.json:
```json
{
    "body": "CC:  @dimpase\n\nImplements #24024, incorporating changes to the `spkg-install` for R originally from #22509 as well as #23733.\n\nIssue created by migration from https://trac.sagemath.org/ticket/25049\n\n",
    "created_at": "2018-03-28T13:13:07Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "Add DESTDIR support for r, and other cleanup",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24812",
    "user": "https://github.com/embray"
}
```
CC:  @dimpase

Implements #24024, incorporating changes to the `spkg-install` for R originally from #22509 as well as #23733.

Issue created by migration from https://trac.sagemath.org/ticket/25049





---

archive/issue_comments_348082.json:
```json
{
    "body": "This already got some pretty good OSX testing when it was part of #22509, but that was a while ago so it should be tested again.",
    "created_at": "2018-03-28T13:13:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348082",
    "user": "https://github.com/embray"
}
```

This already got some pretty good OSX testing when it was part of #22509, but that was a while ago so it should be tested again.



---

archive/issue_comments_348083.json:
```json
{
    "body": "Tested on OSX 10.13 and it works--R builds, its installed files are correctly listed in the manifest, and it runs at least basically.",
    "created_at": "2018-03-28T15:01:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348083",
    "user": "https://github.com/embray"
}
```

Tested on OSX 10.13 and it works--R builds, its installed files are correctly listed in the manifest, and it runs at least basically.



---

archive/issue_comments_348084.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-03-28T15:01:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348084",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_348085.json:
```json
{
    "body": "Looks good. Is the build script now run with a `set -e` so no error checking needs to be done explicitly anymore?",
    "created_at": "2018-03-28T22:25:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348085",
    "user": "https://github.com/saraedum"
}
```

Looks good. Is the build script now run with a `set -e` so no error checking needs to be done explicitly anymore?



---

archive/issue_comments_348086.json:
```json
{
    "body": "I'm not sure I understand your question about error checking, but it might be related to #23179.  Ever since that ticket all the stuff about checking that `$SAGE_LOCAL` is set is not necessary when writing spkg installers.",
    "created_at": "2018-03-29T09:08:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348086",
    "user": "https://github.com/embray"
}
```

I'm not sure I understand your question about error checking, but it might be related to #23179.  Ever since that ticket all the stuff about checking that `$SAGE_LOCAL` is set is not necessary when writing spkg installers.



---

archive/issue_comments_348087.json:
```json
{
    "body": "Hm\u2026I had a look at #23179 but I could not find the bit I was looking for so let me rephrase my question. I can not find a `set -e` at the top of the proposed `spkg-install` script. Is that not necessary anymore? Is this somehow set from the outside now?",
    "created_at": "2018-03-29T11:24:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348087",
    "user": "https://github.com/saraedum"
}
```

Hmâ€¦I had a look at #23179 but I could not find the bit I was looking for so let me rephrase my question. I can not find a `set -e` at the top of the proposed `spkg-install` script. Is that not necessary anymore? Is this somehow set from the outside now?



---

archive/issue_comments_348088.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2018-03-29T11:24:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348088",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_348089.json:
```json
{
    "body": "Can't we get rid of the \"move old installs\" part? Doesn't `DESTDIR` solve that problem?",
    "created_at": "2018-03-29T12:20:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348089",
    "user": "https://github.com/jdemeyer"
}
```

Can't we get rid of the "move old installs" part? Doesn't `DESTDIR` solve that problem?



---

archive/issue_comments_348090.json:
```json
{
    "body": "Replying to [comment:4 saraedum]:\n> Looks good. Is the build script now run with a `set -e`\n\nNo: `set -e` was **not** used before and it is still **not** used.",
    "created_at": "2018-03-29T12:21:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348090",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:4 saraedum]:
> Looks good. Is the build script now run with a `set -e`

No: `set -e` was **not** used before and it is still **not** used.



---

archive/issue_comments_348091.json:
```json
{
    "body": "Replying to [comment:8 jdemeyer]:\n> Can't we get rid of the \"move old installs\" part? Doesn't `DESTDIR` solve that problem?\n\nIt definitely does not *necessarily* solve that problem.  What will solve it later will be #22510--once uninstall is in place then I think the behavior for all packages should be, when upgrading them, to uninstall the old version (and optionally make a backup), with restoration of the backup occurring on error.",
    "created_at": "2018-03-29T13:57:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348091",
    "user": "https://github.com/embray"
}
```

Replying to [comment:8 jdemeyer]:
> Can't we get rid of the "move old installs" part? Doesn't `DESTDIR` solve that problem?

It definitely does not *necessarily* solve that problem.  What will solve it later will be #22510--once uninstall is in place then I think the behavior for all packages should be, when upgrading them, to uninstall the old version (and optionally make a backup), with restoration of the backup occurring on error.



---

archive/issue_comments_348092.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2018-03-29T13:57:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348092",
    "user": "https://github.com/embray"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_348093.json:
```json
{
    "body": "Replying to [comment:9 jdemeyer]:\n> Replying to [comment:4 saraedum]:\n> > Looks good. Is the build script now run with a `set -e`\n> \n> No: `set -e` was **not** used before and it is still **not** used.\n\nSo, should it be used?",
    "created_at": "2018-03-30T06:00:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348093",
    "user": "https://github.com/saraedum"
}
```

Replying to [comment:9 jdemeyer]:
> Replying to [comment:4 saraedum]:
> > Looks good. Is the build script now run with a `set -e`
> 
> No: `set -e` was **not** used before and it is still **not** used.

So, should it be used?



---

archive/issue_comments_348094.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2018-03-30T06:09:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348094",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_348095.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2018-03-30T13:27:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348095",
    "user": "https://github.com/embray"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_348096.json:
```json
{
    "body": "No, I don't know why you think so.",
    "created_at": "2018-03-30T13:27:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348096",
    "user": "https://github.com/embray"
}
```

No, I don't know why you think so.



---

archive/issue_comments_348097.json:
```json
{
    "body": "Still, can we get rid of the \"move old installs\" part anyway? If the build breaks, just let it be broken.",
    "created_at": "2018-03-30T13:30:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348097",
    "user": "https://github.com/jdemeyer"
}
```

Still, can we get rid of the "move old installs" part anyway? If the build breaks, just let it be broken.



---

archive/issue_comments_348098.json:
```json
{
    "body": "I don't mind, but tbh I'm not sure exactly what it was for in the first place.  I assume we probably have to at least *remove* the old install.  The restoring part can go (as I said we'll implement that capability more generally later).",
    "created_at": "2018-03-30T13:32:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348098",
    "user": "https://github.com/embray"
}
```

I don't mind, but tbh I'm not sure exactly what it was for in the first place.  I assume we probably have to at least *remove* the old install.  The restoring part can go (as I said we'll implement that capability more generally later).



---

archive/issue_comments_348099.json:
```json
{
    "body": "Replying to [comment:13 embray]:\n> No, I don't know why you think so.\n\n```\n-config\n-if [ $? -ne 0 ]; then\n+# Run in a subshell in case config with X11 support fails\n+if ! (config); then\n     echo \"Configuring R without X11\"\n     XSUPPORT=no\n     config\n-    if [ $? -ne 0 ]; then\n-        echo >&2 \"Error configuring R.\"\n-        exit 1\n-    fi\n fi\n```\n\nSo we won't abort if the inner `config` fails here?",
    "created_at": "2018-04-01T08:45:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348099",
    "user": "https://github.com/saraedum"
}
```

Replying to [comment:13 embray]:
> No, I don't know why you think so.

```
-config
-if [ $? -ne 0 ]; then
+# Run in a subshell in case config with X11 support fails
+if ! (config); then
     echo "Configuring R without X11"
     XSUPPORT=no
     config
-    if [ $? -ne 0 ]; then
-        echo >&2 "Error configuring R."
-        exit 1
-    fi
 fi
```

So we won't abort if the inner `config` fails here?



---

archive/issue_comments_348100.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2018-04-01T08:47:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348100",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_348101.json:
```json
{
    "body": "No, please check the implementation of `sdh_configure` in `src/bin/sage-dist-helpers`.  Part of the point of all the `sdh_` helpers is that they exit upon failure (that's why the first `config` needs to be run in a sub-shell).",
    "created_at": "2018-04-03T15:22:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348101",
    "user": "https://github.com/embray"
}
```

No, please check the implementation of `sdh_configure` in `src/bin/sage-dist-helpers`.  Part of the point of all the `sdh_` helpers is that they exit upon failure (that's why the first `config` needs to be run in a sub-shell).



---

archive/issue_comments_348102.json:
```json
{
    "body": "Changing status from needs_info to positive_review.",
    "created_at": "2018-04-03T16:41:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348102",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_info to positive_review.



---

archive/issue_comments_348103.json:
```json
{
    "body": "Sorry, I had misunderstood `config()`.",
    "created_at": "2018-04-03T16:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348103",
    "user": "https://github.com/saraedum"
}
```

Sorry, I had misunderstood `config()`.



---

archive/issue_comments_348104.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-05-09T18:46:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348104",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_348105.json:
```json
{
    "body": "Merge conflict",
    "created_at": "2018-05-09T18:46:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348105",
    "user": "https://github.com/vbraun"
}
```

Merge conflict



---

archive/issue_comments_348106.json:
```json
{
    "body": "I believe this issue can reasonably be addressed for Sage 8.4.",
    "created_at": "2018-07-18T11:47:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348106",
    "user": "https://github.com/embray"
}
```

I believe this issue can reasonably be addressed for Sage 8.4.



---

archive/issue_comments_348107.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-09-06T14:00:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348107",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_348108.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-09-06T14:01:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348108",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_348109.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-09-06T14:16:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348109",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_348110.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-09-06T14:18:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348110",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_348111.json:
```json
{
    "body": "(accidentally split 1 commit into 2; fixed now)",
    "created_at": "2018-09-06T14:18:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348111",
    "user": "https://github.com/embray"
}
```

(accidentally split 1 commit into 2; fixed now)



---

archive/issue_comments_348112.json:
```json
{
    "body": "Retargeting some of my tickets (somewhat optimistically for now).",
    "created_at": "2018-12-28T14:10:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348112",
    "user": "https://github.com/embray"
}
```

Retargeting some of my tickets (somewhat optimistically for now).



---

archive/issue_comments_348113.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-03-10T10:49:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348113",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_348114.json:
```json
{
    "body": "red branch",
    "created_at": "2019-03-10T10:49:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348114",
    "user": "https://github.com/fchapoton"
}
```

red branch



---

archive/issue_comments_348115.json:
```json
{
    "body": "Moving all my in-progress tickets to 8.8 milestone.",
    "created_at": "2019-03-25T10:43:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348115",
    "user": "https://github.com/embray"
}
```

Moving all my in-progress tickets to 8.8 milestone.



---

archive/issue_comments_348116.json:
```json
{
    "body": "Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).",
    "created_at": "2019-06-14T14:50:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348116",
    "user": "https://github.com/embray"
}
```

Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).



---

archive/issue_comments_348117.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2019-12-30T14:48:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348117",
    "user": "https://github.com/embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_348118.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-01-31T15:24:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348118",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_348119.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-01-31T15:26:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348119",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_348120.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-01-31T15:27:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348120",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_348121.json:
```json
{
    "body": "Reviving this ticket because it still needs to be done.\n\nIt's a bit simpler now: because we always uninstall old packages before reinstalling/upgrading them, some of the OSX hacks are no longer needed (if they even ever really were...)\n----\nNew commits:",
    "created_at": "2020-01-31T15:27:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348121",
    "user": "https://github.com/embray"
}
```

Reviving this ticket because it still needs to be done.

It's a bit simpler now: because we always uninstall old packages before reinstalling/upgrading them, some of the OSX hacks are no longer needed (if they even ever really were...)
----
New commits:



---

archive/issue_comments_348122.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-01-31T19:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348122",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_348123.json:
```json
{
    "body": "looks good to me",
    "created_at": "2020-01-31T19:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348123",
    "user": "https://github.com/dimpase"
}
```

looks good to me



---

archive/issue_comments_348124.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-02-10T20:06:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24812#issuecomment-348124",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
