# Issue 17957: Speedup of calculation of Macdonald H and Ht bases

archive/issues_017957.json:
```json
{
    "body": "CC:  sage-combinat @darijgr @tscrim @anneschilling\n\nKeywords: Macdonald symmetric functions\n\nA formula of F. Bergeron, A. Garsia and M. Haiman gives a Pieri rule for `h_r^\\perp {\\tilde H}_\\mu` and this formula can be used to compute the `H` and `Ht` bases much quicker than previous implementations.  The current implementation computes the `H` and `Ht` basis through the `J` basis and this basis is implemented through creation operators.\n\nFor instance a command that takes a relatively long time to compute is\n\n```\nsage: %time H([3,2]).nabla(q=H.q,t=1/H.t)\nCPU times: user 2.75 s, sys: 86.6 ms, total: 2.83 s\nWall time: 2.95 s\nq^4/t^2*McdH[3, 2]\n```\nand with the new implementation the same command has the timing\n\n```\nCPU times: user 184 ms, sys: 18.7 ms, total: 203 ms\nWall time: 196 ms\n```\n\nOne reason that some of the computations in the `H` and `Ht` bases take a long time is that the entire basis a given degree is cached and so subsequent computations will be faster.  However it seems that the new implementation is cached more efficiently and is faster.\n\nIssue created by migration from https://trac.sagemath.org/ticket/18194\n\n",
    "created_at": "2015-04-14T19:47:31Z",
    "labels": [
        "component: combinatorics",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.7",
    "title": "Speedup of calculation of Macdonald H and Ht bases",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17957",
    "user": "https://github.com/zabrocki"
}
```
CC:  sage-combinat @darijgr @tscrim @anneschilling

Keywords: Macdonald symmetric functions

A formula of F. Bergeron, A. Garsia and M. Haiman gives a Pieri rule for `h_r^\perp {\tilde H}_\mu` and this formula can be used to compute the `H` and `Ht` bases much quicker than previous implementations.  The current implementation computes the `H` and `Ht` basis through the `J` basis and this basis is implemented through creation operators.

For instance a command that takes a relatively long time to compute is

```
sage: %time H([3,2]).nabla(q=H.q,t=1/H.t)
CPU times: user 2.75 s, sys: 86.6 ms, total: 2.83 s
Wall time: 2.95 s
q^4/t^2*McdH[3, 2]
```
and with the new implementation the same command has the timing

```
CPU times: user 184 ms, sys: 18.7 ms, total: 203 ms
Wall time: 196 ms
```

One reason that some of the computations in the `H` and `Ht` bases take a long time is that the entire basis a given degree is cached and so subsequent computations will be faster.  However it seems that the new implementation is cached more efficiently and is faster.

Issue created by migration from https://trac.sagemath.org/ticket/18194





---

archive/issue_comments_241002.json:
```json
{
    "body": "Changing keywords from \"Macdonald symmetric functions\" to \"sf, days67, sage-combinat\".",
    "created_at": "2015-04-14T19:55:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241002",
    "user": "https://github.com/zabrocki"
}
```

Changing keywords from "Macdonald symmetric functions" to "sf, days67, sage-combinat".



---

archive/issue_comments_241003.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-14T21:15:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241003",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_241004.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-14T21:32:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241004",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_241005.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2015-04-14T21:34:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241005",
    "user": "https://github.com/zabrocki"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_241006.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-04-14T21:34:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241006",
    "user": "https://github.com/zabrocki"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_241007.json:
```json
{
    "body": "Time tests (former implementation)\n\n```\nsage: %time qt_kostka([3,3,2],[4,2,2])\nCPU times: user 1min 49s, sys: 418 ms, total: 1min 50s\nWall time: 1min 49s\n```\n(new implementation):\n\n```\nsage: %time qt_kostka([3,3,2],[4,2,2])\nCPU times: user 3.69 s, sys: 238 ms, total: 3.93 s\nWall time: 3.77 s\n```\n\n###\n\n(former implementation):\n\n```\nsage: %time s[1,1,1,1,1,1].nabla()\nCPU times: user 6.33 s, sys: 125 ms, total: 6.45 s\nWall time: 6.39 s\n```\n(new implementation):\n\n```\nsage: %time s[1,1,1,1,1,1].nabla()\nCPU times: user 1.15 s, sys: 69 ms, total: 1.22 s\nWall time: 1.17 s\n```",
    "created_at": "2015-04-14T21:52:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241007",
    "user": "https://github.com/zabrocki"
}
```

Time tests (former implementation)

```
sage: %time qt_kostka([3,3,2],[4,2,2])
CPU times: user 1min 49s, sys: 418 ms, total: 1min 50s
Wall time: 1min 49s
```
(new implementation):

```
sage: %time qt_kostka([3,3,2],[4,2,2])
CPU times: user 3.69 s, sys: 238 ms, total: 3.93 s
Wall time: 3.77 s
```

###

(former implementation):

```
sage: %time s[1,1,1,1,1,1].nabla()
CPU times: user 6.33 s, sys: 125 ms, total: 6.45 s
Wall time: 6.39 s
```
(new implementation):

```
sage: %time s[1,1,1,1,1,1].nabla()
CPU times: user 1.15 s, sys: 69 ms, total: 1.22 s
Wall time: 1.17 s
```



---

archive/issue_comments_241008.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-14T22:02:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241008",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_241009.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-19T17:14:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241009",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_241010.json:
```json
{
    "body": "two failing doctests, see patchbot report",
    "created_at": "2015-04-20T06:52:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241010",
    "user": "https://github.com/fchapoton"
}
```

two failing doctests, see patchbot report



---

archive/issue_comments_241011.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-04-20T06:52:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241011",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_241012.json:
```json
{
    "body": "I did some cleanup of the docstrings and imports. However there are some doctest failures:\n\n```\n----------------------------------------------------------------------\nsage -t ../../tests/book_schilling_zabrocki_kschur_primer.py  # 1 doctest failed\nsage -t ../../structure/parent.pyx  # 1 doctest failed\n----------------------------------------------------------------------\n```\nThe second one is slightly worrysome in that the coercion path has gotten longer, but it is not so bad. The first one is much more serious as I (and the patchbot) get a division by zero error on this test:\n\n```\nsage: Sym = SymmetricFunctions(FractionField(QQ['q']))\nsage: Mac = Sym.macdonald(t=0)\nsage: H = Mac.H()\nsage: s = Sym.schur()\nsage: for la in Partitions(3):\n....:    print \"H\",la, \"=\", s(H(la))\n```\nI suspect your computational assumptions are not always being met and lead to this error.\n\n---\nNew commits:",
    "created_at": "2015-04-20T06:55:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241012",
    "user": "https://github.com/tscrim"
}
```

I did some cleanup of the docstrings and imports. However there are some doctest failures:

```
----------------------------------------------------------------------
sage -t ../../tests/book_schilling_zabrocki_kschur_primer.py  # 1 doctest failed
sage -t ../../structure/parent.pyx  # 1 doctest failed
----------------------------------------------------------------------
```
The second one is slightly worrysome in that the coercion path has gotten longer, but it is not so bad. The first one is much more serious as I (and the patchbot) get a division by zero error on this test:

```
sage: Sym = SymmetricFunctions(FractionField(QQ['q']))
sage: Mac = Sym.macdonald(t=0)
sage: H = Mac.H()
sage: s = Sym.schur()
sage: for la in Partitions(3):
....:    print "H",la, "=", s(H(la))
```
I suspect your computational assumptions are not always being met and lead to this error.

---
New commits:



---

archive/issue_comments_241013.json:
```json
{
    "body": "I had not tested `t=0` or `q=0` and should have.  The reason it is failing is because there were a few places where I calculated \"f[X(t-1)]\" using `f.theta_qt(1/t,0)`.  There are ways around this because I can also use `f.omega_qt(t,0)`",
    "created_at": "2015-04-20T10:48:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241013",
    "user": "https://github.com/zabrocki"
}
```

I had not tested `t=0` or `q=0` and should have.  The reason it is failing is because there were a few places where I calculated "f[X(t-1)]" using `f.theta_qt(1/t,0)`.  There are ways around this because I can also use `f.omega_qt(t,0)`



---

archive/issue_comments_241014.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-20T14:05:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241014",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_241015.json:
```json
{
    "body": "The fact that there is a change in the coercion path from `J` to `H` is to be expected because the new implementation takes `H` and `Ht` to and from the monomial basis while `J`, `P` and `Q` must pass through the Schur basis.  However, I do not know why the path it finds from Schur to monomial passes through homogeneous and the power basis.\n\n```\nsage: copy(H._internal_coerce_map_from(J))\nComposite map:\n  From: Symmetric Functions over Fraction Field of Multivariate Polynomial Ring in q, t over Rational Field in the Macdonald J basis\n  To:   Symmetric Functions over Fraction Field of Multivariate Polynomial Ring in q, t over Rational Field in the Macdonald H basis\n  Defn:   Generic morphism:\n          From: Symmetric Functions over Fraction Field of Multivariate Polynomial Ring in q, t over Rational Field in the Macdonald J basis\n          To:   Symmetric Functions over Fraction Field of Multivariate Polynomial Ring in q, t over Rational Field in the Schur basis\n        then\n          Generic morphism:\n          From: Symmetric Functions over Fraction Field of Multivariate Polynomial Ring in q, t over Rational Field in the Schur basis\n          To:   Symmetric Functions over Fraction Field of Multivariate Polynomial Ring in q, t over Rational Field in the homogeneous basis\n        then\n          Generic morphism:\n          From: Symmetric Functions over Fraction Field of Multivariate Polynomial Ring in q, t over Rational Field in the homogeneous basis\n          To:   Symmetric Functions over Fraction Field of Multivariate Polynomial Ring in q, t over Rational Field in the powersum basis\n        then\n          Generic morphism:\n          From: Symmetric Functions over Fraction Field of Multivariate Polynomial Ring in q, t over Rational Field in the powersum basis\n          To:   Symmetric Functions over Fraction Field of Multivariate Polynomial Ring in q, t over Rational Field in the monomial basis\n        then\n          Generic morphism:\n          From: Symmetric Functions over Fraction Field of Multivariate Polynomial Ring in q, t over Rational Field in the monomial basis\n          To:   Symmetric Functions over Fraction Field of Multivariate Polynomial Ring in q, t over Rational Field in the Macdonald H basis\n```\n\nWhat is the technique for ensuring that Sage finds the shortest coercion path?",
    "created_at": "2015-04-20T14:23:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241015",
    "user": "https://github.com/zabrocki"
}
```

The fact that there is a change in the coercion path from `J` to `H` is to be expected because the new implementation takes `H` and `Ht` to and from the monomial basis while `J`, `P` and `Q` must pass through the Schur basis.  However, I do not know why the path it finds from Schur to monomial passes through homogeneous and the power basis.

```
sage: copy(H._internal_coerce_map_from(J))
Composite map:
  From: Symmetric Functions over Fraction Field of Multivariate Polynomial Ring in q, t over Rational Field in the Macdonald J basis
  To:   Symmetric Functions over Fraction Field of Multivariate Polynomial Ring in q, t over Rational Field in the Macdonald H basis
  Defn:   Generic morphism:
          From: Symmetric Functions over Fraction Field of Multivariate Polynomial Ring in q, t over Rational Field in the Macdonald J basis
          To:   Symmetric Functions over Fraction Field of Multivariate Polynomial Ring in q, t over Rational Field in the Schur basis
        then
          Generic morphism:
          From: Symmetric Functions over Fraction Field of Multivariate Polynomial Ring in q, t over Rational Field in the Schur basis
          To:   Symmetric Functions over Fraction Field of Multivariate Polynomial Ring in q, t over Rational Field in the homogeneous basis
        then
          Generic morphism:
          From: Symmetric Functions over Fraction Field of Multivariate Polynomial Ring in q, t over Rational Field in the homogeneous basis
          To:   Symmetric Functions over Fraction Field of Multivariate Polynomial Ring in q, t over Rational Field in the powersum basis
        then
          Generic morphism:
          From: Symmetric Functions over Fraction Field of Multivariate Polynomial Ring in q, t over Rational Field in the powersum basis
          To:   Symmetric Functions over Fraction Field of Multivariate Polynomial Ring in q, t over Rational Field in the monomial basis
        then
          Generic morphism:
          From: Symmetric Functions over Fraction Field of Multivariate Polynomial Ring in q, t over Rational Field in the monomial basis
          To:   Symmetric Functions over Fraction Field of Multivariate Polynomial Ring in q, t over Rational Field in the Macdonald H basis
```

What is the technique for ensuring that Sage finds the shortest coercion path?



---

archive/issue_comments_241016.json:
```json
{
    "body": "Unfortunately I don't think there is a way to do so unless you explicitly specify the coercion. IIRC, there are known issues with finding efficient paths. Often times it comes from finding some path depending upon prior object creation (i.e., the monomial basis was perhaps [not] created this time whereas previously it was not?). It might lead to some slowdown, but it may not be a significant part of the computation.",
    "created_at": "2015-04-20T15:42:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241016",
    "user": "https://github.com/tscrim"
}
```

Unfortunately I don't think there is a way to do so unless you explicitly specify the coercion. IIRC, there are known issues with finding efficient paths. Often times it comes from finding some path depending upon prior object creation (i.e., the monomial basis was perhaps [not] created this time whereas previously it was not?). It might lead to some slowdown, but it may not be a significant part of the computation.



---

archive/issue_comments_241017.json:
```json
{
    "body": "I'm willing to leave that as the coercion path because one would not normally convert from `Q`, `P` or `J` bases to `Ht` or `H` bases.  Where there might see a slowdown is between the `Qp` and `H` or `Ht` because `copy(H._internal_coerce_map_from(Qp))` has the extra two steps (although the reverse direction does not) and for mathematical reasons one *might* want to convert between these bases.\n\nI could write the `_self_to_s` and `_s_to_self` functions and add those as coercions, but mathematically they are equivalent to converting between the Schur and monomial basis.",
    "created_at": "2015-04-20T16:00:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241017",
    "user": "https://github.com/zabrocki"
}
```

I'm willing to leave that as the coercion path because one would not normally convert from `Q`, `P` or `J` bases to `Ht` or `H` bases.  Where there might see a slowdown is between the `Qp` and `H` or `Ht` because `copy(H._internal_coerce_map_from(Qp))` has the extra two steps (although the reverse direction does not) and for mathematical reasons one *might* want to convert between these bases.

I could write the `_self_to_s` and `_s_to_self` functions and add those as coercions, but mathematically they are equivalent to converting between the Schur and monomial basis.



---

archive/issue_comments_241018.json:
```json
{
    "body": "You could just explicitly compose the respective coercions and set that composition as the coercion map as well (this is what the coercion framework essentially does).",
    "created_at": "2015-04-20T17:16:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241018",
    "user": "https://github.com/tscrim"
}
```

You could just explicitly compose the respective coercions and set that composition as the coercion map as well (this is what the coercion framework essentially does).



---

archive/issue_comments_241019.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-21T01:17:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241019",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_241020.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-04-21T01:38:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241020",
    "user": "https://github.com/zabrocki"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_241021.json:
```json
{
    "body": "I added the `_self_to_s` and `_s_to_self` methods.  This restores old coercion paths because I registered these coercions before the ones to and from the `m` basis (if I did it in a different order the coercion paths were different).",
    "created_at": "2015-04-21T01:38:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241021",
    "user": "https://github.com/zabrocki"
}
```

I added the `_self_to_s` and `_s_to_self` methods.  This restores old coercion paths because I registered these coercions before the ones to and from the `m` basis (if I did it in a different order the coercion paths were different).



---

archive/issue_comments_241022.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-04-21T13:23:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241022",
    "user": "https://github.com/zabrocki"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_241023.json:
```json
{
    "body": "I have no good explanation yet, but the commits that I made in comment 14 added a full second (roughly 3.7 -> 4.7) on the computation of the `qt_kostka` computation that I listed the timing above.\n\n```\nsage: qt_kostka = sage.combinat.sf.macdonald.qt_kostka\nsage: %time qt_kostka([3,3,2],[4,2,2])\nCPU times: user 4.68 s, sys: 85.8 ms, total: 4.77 s\nWall time: 4.72 s\n```\nI am also having issues with the docstring viewer.  Is this a problem with 6.7.beta1?",
    "created_at": "2015-04-21T13:23:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241023",
    "user": "https://github.com/zabrocki"
}
```

I have no good explanation yet, but the commits that I made in comment 14 added a full second (roughly 3.7 -> 4.7) on the computation of the `qt_kostka` computation that I listed the timing above.

```
sage: qt_kostka = sage.combinat.sf.macdonald.qt_kostka
sage: %time qt_kostka([3,3,2],[4,2,2])
CPU times: user 4.68 s, sys: 85.8 ms, total: 4.77 s
Wall time: 4.72 s
```
I am also having issues with the docstring viewer.  Is this a problem with 6.7.beta1?



---

archive/issue_comments_241024.json:
```json
{
    "body": "I'm doing some profiling now (`%prun`). How are the docstrings behaving?",
    "created_at": "2015-04-21T16:11:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241024",
    "user": "https://github.com/tscrim"
}
```

I'm doing some profiling now (`%prun`). How are the docstrings behaving?



---

archive/issue_comments_241025.json:
```json
{
    "body": "Here's at 9196d33:\n\n```\n         1354375 function calls (1342455 primitive calls) in 18.690 seconds\n\n   Ordered by: internal time\n\n   ncalls  tottime  percall  cumtime  percall filename:lineno(function)\n      484    8.666    0.018   10.441    0.022 {method 'subs' of 'sage.structure.element.Element' objects}\n    19061    1.364    0.000    1.460    0.000 fraction_field.py:293(<lambda>)\n6231/2951    1.089    0.000   15.034    0.005 {sum}\n    25/23    0.832    0.033    2.594    0.113 {sage.combinat.dict_addition.dict_linear_combination}\n     1289    0.475    0.000    1.076    0.001 macdonald.py:722(<genexpr>)\n1859/1005    0.393    0.000    1.577    0.002 macdonald.py:1388(<genexpr>)\n     4664    0.294    0.000    0.323    0.000 free_module.py:2028(<genexpr>)\n    14485    0.270    0.000    0.702    0.000 partition.py:608(__init__)\n    62071    0.245    0.000    0.357    0.000 combinat.py:1069(__hash__)\n     1958    0.229    0.000   14.979    0.008 macdonald.py:1245(<genexpr>)\n      484    0.225    0.000    1.215    0.003 {sage.libs.symmetrica.symmetrica.t_MONOMIAL_SCHUR_symmetrica}\n    82819    0.210    0.000    0.210    0.000 non_negative_integers.py:94(__contains__)\n  840/701    0.188    0.000    2.481    0.004 macdonald.py:1391(<genexpr>)\n      642    0.177    0.000    0.179    0.000 dynamic_class.py:324(dynamic_class_internal)\n    14620    0.173    0.000    0.469    0.000 partition.py:5049(__contains__)\n    47261    0.172    0.000    0.258    0.000 partition.py:632(<genexpr>)\n     8878    0.162    0.000    1.227    0.000 partition.py:552(__classcall_private__)\n   183978    0.160    0.000    0.160    0.000 rational_field.py:825(is_finite)\n   102278    0.158    0.000    0.158    0.000 {isinstance}\n   194018    0.133    0.000    0.133    0.000 rational_field.py:814(is_field)\n    10814    0.123    0.000    1.104    0.000 partition.py:5030(_element_constructor_)\n    35558    0.123    0.000    0.184    0.000 partition.py:5081(<genexpr>)\n  835/356    0.123    0.000    1.987    0.006 macdonald.py:677(cmunu)\n     1474    0.121    0.000    0.136    0.000 free_module.py:670(support)\n     1487    0.105    0.000    0.109    0.000 macdonald.py:636(<genexpr>)\n       22    0.104    0.005   15.518    0.705 macdonald.py:1244(<dictcomp>)\n      290    0.092    0.000    0.164    0.001 macdonald.py:669(<genexpr>)\n      290    0.082    0.000    0.144    0.000 macdonald.py:672(<genexpr>)\n22609/20887    0.080    0.000    0.112    0.000 combinat.py:951(__eq__)\n     3497    0.077    0.000    0.440    0.000 free_module.py:1976(_from_dict)\n    15893    0.076    0.000    0.076    0.000 combinat.py:821(__init__)\n    24936    0.071    0.000    0.583    0.000 {all}\n      968    0.066    0.000    0.085    0.000 free_module.py:519(_coefficient_fast)\n    73371    0.066    0.000    0.095    0.000 {len}\n    67171    0.066    0.000    0.066    0.000 fraction_field.py:463(ring)\n 2331/484    0.058    0.000    4.225    0.009 macdonald.py:1338(_Lmunu)\n```\nWith the current branch:\n\n```\n         1666331 function calls (1654153 primitive calls) in 24.257 seconds\n\n   Ordered by: internal time\n\n   ncalls  tottime  percall  cumtime  percall filename:lineno(function)\n      968   12.717    0.013   16.142    0.017 {method 'subs' of 'sage.structure.element.Element' objects}\n    37990    2.681    0.000    2.871    0.000 fraction_field.py:293(<lambda>)\n6231/2951    1.070    0.000   20.717    0.007 {sum}\n    25/23    0.833    0.033    2.509    0.109 {sage.combinat.dict_addition.dict_linear_combination}\n     1289    0.476    0.000    1.074    0.001 macdonald.py:722(<genexpr>)\n1859/1005    0.397    0.000    1.578    0.002 macdonald.py:1453(<genexpr>)\n     4664    0.294    0.000    0.322    0.000 free_module.py:2028(<genexpr>)\n    14485    0.275    0.000    0.711    0.000 partition.py:608(__init__)\n   281963    0.253    0.000    0.253    0.000 rational_field.py:825(is_finite)\n    62071    0.245    0.000    0.360    0.000 combinat.py:1069(__hash__)\n     1958    0.232    0.000   20.663    0.011 macdonald.py:1304(<genexpr>)\n    82819    0.218    0.000    0.218    0.000 non_negative_integers.py:94(__contains__)\n   291562    0.195    0.000    0.195    0.000 rational_field.py:814(is_field)\n  840/701    0.189    0.000    2.463    0.004 macdonald.py:1456(<genexpr>)\n      642    0.172    0.000    0.174    0.000 dynamic_class.py:324(dynamic_class_internal)\n    47261    0.172    0.000    0.261    0.000 partition.py:632(<genexpr>)\n     8878    0.161    0.000    1.196    0.000 partition.py:552(__classcall_private__)\n   104289    0.159    0.000    0.159    0.000 {isinstance}\n    14620    0.144    0.000    0.434    0.000 partition.py:5049(__contains__)\n      484    0.140    0.000    1.127    0.002 {sage.libs.symmetrica.symmetrica.t_MONOMIAL_SCHUR_symmetrica}\n    35558    0.126    0.000    0.190    0.000 partition.py:5081(<genexpr>)\n    10814    0.124    0.000    1.076    0.000 partition.py:5030(_element_constructor_)\n     1474    0.122    0.000    0.137    0.000 free_module.py:670(support)\n  835/356    0.122    0.000    1.966    0.006 macdonald.py:677(cmunu)\n     1487    0.107    0.000    0.111    0.000 macdonald.py:636(<genexpr>)\n       22    0.106    0.005   21.207    0.964 macdonald.py:1303(<dictcomp>)\n   105995    0.103    0.000    0.103    0.000 fraction_field.py:463(ring)\n     3445    0.083    0.000    0.112    0.000 {method 'sub' of '_sre.SRE_Pattern' objects}\n22609/20887    0.082    0.000    0.114    0.000 combinat.py:951(__eq__)\n    15893    0.076    0.000    0.076    0.000 combinat.py:821(__init__)\n      290    0.075    0.000    0.146    0.001 macdonald.py:669(<genexpr>)\n     3497    0.074    0.000    0.440    0.000 free_module.py:1976(_from_dict)\n    24936    0.072    0.000    0.592    0.000 {all}\n      290    0.071    0.000    0.135    0.000 macdonald.py:672(<genexpr>)\n      968    0.067    0.000    0.085    0.000 free_module.py:519(_coefficient_fast)\n    73394    0.066    0.000    0.095    0.000 {len}\n     1968    0.065    0.000    0.067    0.000 fraction_field.py:412(_repr_)\n```\nSo the issue is doing the 2 substitutions, which are quite expensive, instead of 1. (Although it's quite worrisome the sheer number of calls to certain things, like `is_finite`, but they are minor in terms of speed).",
    "created_at": "2015-04-21T16:22:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241025",
    "user": "https://github.com/tscrim"
}
```

Here's at 9196d33:

```
         1354375 function calls (1342455 primitive calls) in 18.690 seconds

   Ordered by: internal time

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
      484    8.666    0.018   10.441    0.022 {method 'subs' of 'sage.structure.element.Element' objects}
    19061    1.364    0.000    1.460    0.000 fraction_field.py:293(<lambda>)
6231/2951    1.089    0.000   15.034    0.005 {sum}
    25/23    0.832    0.033    2.594    0.113 {sage.combinat.dict_addition.dict_linear_combination}
     1289    0.475    0.000    1.076    0.001 macdonald.py:722(<genexpr>)
1859/1005    0.393    0.000    1.577    0.002 macdonald.py:1388(<genexpr>)
     4664    0.294    0.000    0.323    0.000 free_module.py:2028(<genexpr>)
    14485    0.270    0.000    0.702    0.000 partition.py:608(__init__)
    62071    0.245    0.000    0.357    0.000 combinat.py:1069(__hash__)
     1958    0.229    0.000   14.979    0.008 macdonald.py:1245(<genexpr>)
      484    0.225    0.000    1.215    0.003 {sage.libs.symmetrica.symmetrica.t_MONOMIAL_SCHUR_symmetrica}
    82819    0.210    0.000    0.210    0.000 non_negative_integers.py:94(__contains__)
  840/701    0.188    0.000    2.481    0.004 macdonald.py:1391(<genexpr>)
      642    0.177    0.000    0.179    0.000 dynamic_class.py:324(dynamic_class_internal)
    14620    0.173    0.000    0.469    0.000 partition.py:5049(__contains__)
    47261    0.172    0.000    0.258    0.000 partition.py:632(<genexpr>)
     8878    0.162    0.000    1.227    0.000 partition.py:552(__classcall_private__)
   183978    0.160    0.000    0.160    0.000 rational_field.py:825(is_finite)
   102278    0.158    0.000    0.158    0.000 {isinstance}
   194018    0.133    0.000    0.133    0.000 rational_field.py:814(is_field)
    10814    0.123    0.000    1.104    0.000 partition.py:5030(_element_constructor_)
    35558    0.123    0.000    0.184    0.000 partition.py:5081(<genexpr>)
  835/356    0.123    0.000    1.987    0.006 macdonald.py:677(cmunu)
     1474    0.121    0.000    0.136    0.000 free_module.py:670(support)
     1487    0.105    0.000    0.109    0.000 macdonald.py:636(<genexpr>)
       22    0.104    0.005   15.518    0.705 macdonald.py:1244(<dictcomp>)
      290    0.092    0.000    0.164    0.001 macdonald.py:669(<genexpr>)
      290    0.082    0.000    0.144    0.000 macdonald.py:672(<genexpr>)
22609/20887    0.080    0.000    0.112    0.000 combinat.py:951(__eq__)
     3497    0.077    0.000    0.440    0.000 free_module.py:1976(_from_dict)
    15893    0.076    0.000    0.076    0.000 combinat.py:821(__init__)
    24936    0.071    0.000    0.583    0.000 {all}
      968    0.066    0.000    0.085    0.000 free_module.py:519(_coefficient_fast)
    73371    0.066    0.000    0.095    0.000 {len}
    67171    0.066    0.000    0.066    0.000 fraction_field.py:463(ring)
 2331/484    0.058    0.000    4.225    0.009 macdonald.py:1338(_Lmunu)
```
With the current branch:

```
         1666331 function calls (1654153 primitive calls) in 24.257 seconds

   Ordered by: internal time

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
      968   12.717    0.013   16.142    0.017 {method 'subs' of 'sage.structure.element.Element' objects}
    37990    2.681    0.000    2.871    0.000 fraction_field.py:293(<lambda>)
6231/2951    1.070    0.000   20.717    0.007 {sum}
    25/23    0.833    0.033    2.509    0.109 {sage.combinat.dict_addition.dict_linear_combination}
     1289    0.476    0.000    1.074    0.001 macdonald.py:722(<genexpr>)
1859/1005    0.397    0.000    1.578    0.002 macdonald.py:1453(<genexpr>)
     4664    0.294    0.000    0.322    0.000 free_module.py:2028(<genexpr>)
    14485    0.275    0.000    0.711    0.000 partition.py:608(__init__)
   281963    0.253    0.000    0.253    0.000 rational_field.py:825(is_finite)
    62071    0.245    0.000    0.360    0.000 combinat.py:1069(__hash__)
     1958    0.232    0.000   20.663    0.011 macdonald.py:1304(<genexpr>)
    82819    0.218    0.000    0.218    0.000 non_negative_integers.py:94(__contains__)
   291562    0.195    0.000    0.195    0.000 rational_field.py:814(is_field)
  840/701    0.189    0.000    2.463    0.004 macdonald.py:1456(<genexpr>)
      642    0.172    0.000    0.174    0.000 dynamic_class.py:324(dynamic_class_internal)
    47261    0.172    0.000    0.261    0.000 partition.py:632(<genexpr>)
     8878    0.161    0.000    1.196    0.000 partition.py:552(__classcall_private__)
   104289    0.159    0.000    0.159    0.000 {isinstance}
    14620    0.144    0.000    0.434    0.000 partition.py:5049(__contains__)
      484    0.140    0.000    1.127    0.002 {sage.libs.symmetrica.symmetrica.t_MONOMIAL_SCHUR_symmetrica}
    35558    0.126    0.000    0.190    0.000 partition.py:5081(<genexpr>)
    10814    0.124    0.000    1.076    0.000 partition.py:5030(_element_constructor_)
     1474    0.122    0.000    0.137    0.000 free_module.py:670(support)
  835/356    0.122    0.000    1.966    0.006 macdonald.py:677(cmunu)
     1487    0.107    0.000    0.111    0.000 macdonald.py:636(<genexpr>)
       22    0.106    0.005   21.207    0.964 macdonald.py:1303(<dictcomp>)
   105995    0.103    0.000    0.103    0.000 fraction_field.py:463(ring)
     3445    0.083    0.000    0.112    0.000 {method 'sub' of '_sre.SRE_Pattern' objects}
22609/20887    0.082    0.000    0.114    0.000 combinat.py:951(__eq__)
    15893    0.076    0.000    0.076    0.000 combinat.py:821(__init__)
      290    0.075    0.000    0.146    0.001 macdonald.py:669(<genexpr>)
     3497    0.074    0.000    0.440    0.000 free_module.py:1976(_from_dict)
    24936    0.072    0.000    0.592    0.000 {all}
      290    0.071    0.000    0.135    0.000 macdonald.py:672(<genexpr>)
      968    0.067    0.000    0.085    0.000 free_module.py:519(_coefficient_fast)
    73394    0.066    0.000    0.095    0.000 {len}
     1968    0.065    0.000    0.067    0.000 fraction_field.py:412(_repr_)
```
So the issue is doing the 2 substitutions, which are quite expensive, instead of 1. (Although it's quite worrisome the sheer number of calls to certain things, like `is_finite`, but they are minor in terms of speed).



---

archive/issue_comments_241026.json:
```json
{
    "body": "The command `from sphinx.ext import doctest` raises the error `AttributeError: 'module' object has no attribute 'DocTestParser'` (but this is triggered by typing ?? after anything).  Is this a problem with this branch or I need to build from scratch?  This is clearly not related to changes to sf.",
    "created_at": "2015-04-21T16:22:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241026",
    "user": "https://github.com/zabrocki"
}
```

The command `from sphinx.ext import doctest` raises the error `AttributeError: 'module' object has no attribute 'DocTestParser'` (but this is triggered by typing ?? after anything).  Is this a problem with this branch or I need to build from scratch?  This is clearly not related to changes to sf.



---

archive/issue_comments_241027.json:
```json
{
    "body": "We need the two subs though for this to work properly because if `t=0` then you can't substitute `t->1/t` (as one would need to in order to compute the `H` values from the `Ht` values), it needs to be done symbolically and then substitute the value for `t` afterwards.  \nIf the main culprit is are the subs then one workaround is that I can figure out the formulas for the functions `cmunu` which work for the `H` basis and create a separate cache for the `H` functions.  This is not ideal because then it memorizes the values for `H` and `Ht` bases separately.  On current branch it computes `Ht` values first and them computes `H` values with `t->1/t`.",
    "created_at": "2015-04-21T16:47:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241027",
    "user": "https://github.com/zabrocki"
}
```

We need the two subs though for this to work properly because if `t=0` then you can't substitute `t->1/t` (as one would need to in order to compute the `H` values from the `Ht` values), it needs to be done symbolically and then substitute the value for `t` afterwards.  
If the main culprit is are the subs then one workaround is that I can figure out the formulas for the functions `cmunu` which work for the `H` basis and create a separate cache for the `H` functions.  This is not ideal because then it memorizes the values for `H` and `Ht` bases separately.  On current branch it computes `Ht` values first and them computes `H` values with `t->1/t`.



---

archive/issue_comments_241028.json:
```json
{
    "body": "Are you running Sage from `$SAGE_ROOT/src/sage`? This has been known to cause problems.\n\nPerhaps what we should do is special case the `t=0` cases when we end up doing a `t -> 1/t` substitution?",
    "created_at": "2015-04-21T17:50:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241028",
    "user": "https://github.com/tscrim"
}
```

Are you running Sage from `$SAGE_ROOT/src/sage`? This has been known to cause problems.

Perhaps what we should do is special case the `t=0` cases when we end up doing a `t -> 1/t` substitution?



---

archive/issue_comments_241029.json:
```json
{
    "body": "Thanks, the `$SAGE_ROOT/src/sage` was exactly the problem.\n\nAt t=0, `H(mu).subs(t=0) == Qp(mu.conjugate()).subs(t=q).omega()`\n\nThat doesn't quite cut it for the `Ht` basis, but then maybe we never have to invert `t`.  I'll see if I can cover all cases this way.",
    "created_at": "2015-04-21T18:05:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241029",
    "user": "https://github.com/zabrocki"
}
```

Thanks, the `$SAGE_ROOT/src/sage` was exactly the problem.

At t=0, `H(mu).subs(t=0) == Qp(mu.conjugate()).subs(t=q).omega()`

That doesn't quite cut it for the `Ht` basis, but then maybe we never have to invert `t`.  I'll see if I can cover all cases this way.



---

archive/issue_comments_241030.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-22T01:08:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241030",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_241031.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-22T01:22:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241031",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_241032.json:
```json
{
    "body": "This version seems to have the faster timings.  I did as you suggested and handled the `t==0` case separately and this only needs to happen in the `H` basis (the `Ht` basis doesn't invert `t` so does not need to be handled separately).  To handle the `t==0` case separately I use the Hall-Littlewood `Qp` basis.  That corner case will probably run even faster than before but I didn't test it beyond ensuring that it works.",
    "created_at": "2015-04-22T01:29:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241032",
    "user": "https://github.com/zabrocki"
}
```

This version seems to have the faster timings.  I did as you suggested and handled the `t==0` case separately and this only needs to happen in the `H` basis (the `Ht` basis doesn't invert `t` so does not need to be handled separately).  To handle the `t==0` case separately I use the Hall-Littlewood `Qp` basis.  That corner case will probably run even faster than before but I didn't test it beyond ensuring that it works.



---

archive/issue_comments_241033.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-04-22T01:29:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241033",
    "user": "https://github.com/zabrocki"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_241034.json:
```json
{
    "body": "This is way over my head -- sorry, Mike...\n\nBut there is one thing I can suggest: correcting \"rational polynomial\" to \"rational functional\". Even if the former would have been a better notion, were it not also a synonym for a polynomial over `QQ`...",
    "created_at": "2015-04-22T01:39:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241034",
    "user": "https://github.com/darijgr"
}
```

This is way over my head -- sorry, Mike...

But there is one thing I can suggest: correcting "rational polynomial" to "rational functional". Even if the former would have been a better notion, were it not also a synonym for a polynomial over `QQ`...



---

archive/issue_events_051448.json:
```json
{
    "actor": "https://github.com/darijgr",
    "created_at": "2015-04-22T01:39:33Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "milestone": "sage-6.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17957#event-51448"
}
```



---

archive/issue_comments_241035.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-22T01:48:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241035",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_241036.json:
```json
{
    "body": "It took me while to figure out precisely what you were referring to.  I changed to fraction field of polynomials in q and t.",
    "created_at": "2015-04-22T01:50:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241036",
    "user": "https://github.com/zabrocki"
}
```

It took me while to figure out precisely what you were referring to.  I changed to fraction field of polynomials in q and t.



---

archive/issue_comments_241037.json:
```json
{
    "body": "Some timing tests.  On branch \u200b54336b9\n\n```\nsage: H = SymmetricFunctions(QQ['q','t'].fraction_field()).macdonald(t=0).H()\nsage: s = H.symmetric_function_ring().s()\nsage: %time H(s[4,3,2,1])\nCPU times: user 14.6 s, sys: 113 ms, total: 14.7 s\nWall time: 14.7 s\n```\n\non current branch\n\n```\nsage: %time H(s[4,3,2,1])\nCPU times: user 667 ms, sys: 66.2 ms, total: 734 ms\nWall time: 719 ms\n```\n\nThis is a huge improvement for this corner case.  For arbitrary `t` case on branch 54336b9\n\n```\nsage: H = SymmetricFunctions(QQ['q','t'].fraction_field()).macdonald().H()\nsage: s = H.symmetric_function_ring().s()\nsage: %time H(s[4,3,2,1])\nCPU times: user 1min 8s, sys: 213 ms, total: 1min 8s\nWall time: 1min 8s\n```\n\nWhile on the current branch\n\n```\nsage: %time H(s[4,3,2,1])\nCPU times: user 59.5 s, sys: 172 ms, total: 59.7 s\nWall time: 59.6 s\n```\n\nThis is a small but healthy improvement.  Timings for the `Ht` basis and applications of `nabla` seem to be similar on both of these branches.  These computations would not run in a reasonable amount of time without this ticket.",
    "created_at": "2015-04-22T14:33:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241037",
    "user": "https://github.com/zabrocki"
}
```

Some timing tests.  On branch ​54336b9

```
sage: H = SymmetricFunctions(QQ['q','t'].fraction_field()).macdonald(t=0).H()
sage: s = H.symmetric_function_ring().s()
sage: %time H(s[4,3,2,1])
CPU times: user 14.6 s, sys: 113 ms, total: 14.7 s
Wall time: 14.7 s
```

on current branch

```
sage: %time H(s[4,3,2,1])
CPU times: user 667 ms, sys: 66.2 ms, total: 734 ms
Wall time: 719 ms
```

This is a huge improvement for this corner case.  For arbitrary `t` case on branch 54336b9

```
sage: H = SymmetricFunctions(QQ['q','t'].fraction_field()).macdonald().H()
sage: s = H.symmetric_function_ring().s()
sage: %time H(s[4,3,2,1])
CPU times: user 1min 8s, sys: 213 ms, total: 1min 8s
Wall time: 1min 8s
```

While on the current branch

```
sage: %time H(s[4,3,2,1])
CPU times: user 59.5 s, sys: 172 ms, total: 59.7 s
Wall time: 59.6 s
```

This is a small but healthy improvement.  Timings for the `Ht` basis and applications of `nabla` seem to be similar on both of these branches.  These computations would not run in a reasonable amount of time without this ticket.



---

archive/issue_comments_241038.json:
```json
{
    "body": "That's quite a huge speedup. Do you want me to go through the code en masse and do some old-fashion profiling and tuning or just merge this in as-is?",
    "created_at": "2015-04-22T18:56:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241038",
    "user": "https://github.com/tscrim"
}
```

That's quite a huge speedup. Do you want me to go through the code en masse and do some old-fashion profiling and tuning or just merge this in as-is?



---

archive/issue_comments_241039.json:
```json
{
    "body": "The major speed enhancement here is mathematical (the formula for computing the Macdonald symmetric functions).  If you want to tune it up I can see we might get a few seconds here and there.  Here are the places I can see algorithmic improvements:\n\n* `cmunu`, `cmunu1` and `Bmu` are a cached functions.  Are there improvements to be gained from using a global dictionary cache rather than a ``@`cached_function`?\n* carefully look at `_self_to_m`.  That would be my main concern where efficiency gains are to be had.  This function uses `_Lmunu` and this is the coefficient of the monomial symmetric function in a Macdonald symmetric function.",
    "created_at": "2015-04-23T01:52:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241039",
    "user": "https://github.com/zabrocki"
}
```

The major speed enhancement here is mathematical (the formula for computing the Macdonald symmetric functions).  If you want to tune it up I can see we might get a few seconds here and there.  Here are the places I can see algorithmic improvements:

* `cmunu`, `cmunu1` and `Bmu` are a cached functions.  Are there improvements to be gained from using a global dictionary cache rather than a ``@`cached_function`?
* carefully look at `_self_to_m`.  That would be my main concern where efficiency gains are to be had.  This function uses `_Lmunu` and this is the coefficient of the monomial symmetric function in a Macdonald symmetric function.



---

archive/issue_comments_241040.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-23T03:42:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241040",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_241041.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-23T03:52:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241041",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_241042.json:
```json
{
    "body": "Okay, so I've managed to gain another 5~10% it seems but doing some mild code duplication with specialization. I've also had to fix this doctest in `sfa.py`:\n\n```\nsage: all( GR_def2(lam) == h.gessel_reutenauer(lam)\n....:      for n in range(5) for lam in Partitions(n) )\n```\nby explicitly casting the left-hand side to `h` as it now seems to ignore the equality check by coercion. However this worked for me on a smaller example, so something subtle seems to have changed with 5ff5d5a... I will look into this tomorrow for sure, but I will try tonight (after dinner).",
    "created_at": "2015-04-23T04:03:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241042",
    "user": "https://github.com/tscrim"
}
```

Okay, so I've managed to gain another 5~10% it seems but doing some mild code duplication with specialization. I've also had to fix this doctest in `sfa.py`:

```
sage: all( GR_def2(lam) == h.gessel_reutenauer(lam)
....:      for n in range(5) for lam in Partitions(n) )
```
by explicitly casting the left-hand side to `h` as it now seems to ignore the equality check by coercion. However this worked for me on a smaller example, so something subtle seems to have changed with 5ff5d5a... I will look into this tomorrow for sure, but I will try tonight (after dinner).



---

archive/issue_comments_241043.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-23T04:19:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241043",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_241044.json:
```json
{
    "body": "A combination of \"it's bugging me\" and some clever testing made me realize that `to_symmetric_function` is returning compositions instead of partitions! Now why this is just being realized with my recent set of changes, I have no idea. Anyways, it's fixed and I'm okay with the state of things. At least, I couldn't figure out a way to twist out some more speed without doing some moderate cythonization and changing fraction field elements. There might be some gain from doing some of the arithmetic on the polynomial ring and then converting the numerator and denominator to the fraction field, but I'm too hungry and don't know if there will be a sizable enough gain to warrant such an experiment (at this point).",
    "created_at": "2015-04-23T04:23:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241044",
    "user": "https://github.com/tscrim"
}
```

A combination of "it's bugging me" and some clever testing made me realize that `to_symmetric_function` is returning compositions instead of partitions! Now why this is just being realized with my recent set of changes, I have no idea. Anyways, it's fixed and I'm okay with the state of things. At least, I couldn't figure out a way to twist out some more speed without doing some moderate cythonization and changing fraction field elements. There might be some gain from doing some of the arithmetic on the polynomial ring and then converting the numerator and denominator to the fraction field, but I'm too hungry and don't know if there will be a sizable enough gain to warrant such an experiment (at this point).



---

archive/issue_comments_241045.json:
```json
{
    "body": "Well I see some clever ways that you have added a bit of efficiency, but unfortunately I am not seeing a speedup on at least one computation.  On 59394c6\n\n```\nsage: s = SymmetricFunctions(QQ['q','t'].fraction_field()).s()\nsage: %time s[3,3,3,3].nabla()\nCPU times: user 4min 8s, sys: 512 ms, total: 4min 8s\nWall time: 4min 8s\n```\non current branch\n\n```\nsage: %time s[3,3,3,3].nabla()\nCPU times: user 4min 29s, sys: 454 ms, total: 4min 29s\nWall time: 4min 29s\n```\nThis computation uses only the `Ht` basis (it does a conversion to the `Ht`, multiply by eigenvalue, then from `Ht` to `s`).",
    "created_at": "2015-04-23T11:24:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241045",
    "user": "https://github.com/zabrocki"
}
```

Well I see some clever ways that you have added a bit of efficiency, but unfortunately I am not seeing a speedup on at least one computation.  On 59394c6

```
sage: s = SymmetricFunctions(QQ['q','t'].fraction_field()).s()
sage: %time s[3,3,3,3].nabla()
CPU times: user 4min 8s, sys: 512 ms, total: 4min 8s
Wall time: 4min 8s
```
on current branch

```
sage: %time s[3,3,3,3].nabla()
CPU times: user 4min 29s, sys: 454 ms, total: 4min 29s
Wall time: 4min 29s
```
This computation uses only the `Ht` basis (it does a conversion to the `Ht`, multiply by eigenvalue, then from `Ht` to `s`).



---

archive/issue_comments_241046.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-23T15:18:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241046",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_241047.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-23T16:23:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241047",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_241048.json:
```json
{
    "body": "So in small scale, just calling the element directly is faster, but at this scale, doing `subs` is actually faster because of some preprocessing it seems to do. *shrugs* I also did some other things which should be faster.\n\nThe testing I did previously was on `H(s[3,2,2,1])`, and looking at the profile, the coercions between bases are faster, but some other parts of the computation seems to be slower (for reasons currently unknown to me).",
    "created_at": "2015-04-23T16:26:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241048",
    "user": "https://github.com/tscrim"
}
```

So in small scale, just calling the element directly is faster, but at this scale, doing `subs` is actually faster because of some preprocessing it seems to do. *shrugs* I also did some other things which should be faster.

The testing I did previously was on `H(s[3,2,2,1])`, and looking at the profile, the coercions between bases are faster, but some other parts of the computation seems to be slower (for reasons currently unknown to me).



---

archive/issue_comments_241049.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-23T18:24:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241049",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_241050.json:
```json
{
    "body": "I know that your sum looks faster (by changing `mu in x.support...` to `c, mu in x`), but this seems to cut off 20 seconds in my test computation.\n\n```\nsage: %time s[3,3,3,3].nabla()\nCPU times: user 4min 5s, sys: 389 ms, total: 4min 6s\nWall time: 4min 6s\n```",
    "created_at": "2015-04-23T18:26:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241050",
    "user": "https://github.com/zabrocki"
}
```

I know that your sum looks faster (by changing `mu in x.support...` to `c, mu in x`), but this seems to cut off 20 seconds in my test computation.

```
sage: %time s[3,3,3,3].nabla()
CPU times: user 4min 5s, sys: 389 ms, total: 4min 6s
Wall time: 4min 6s
```



---

archive/issue_comments_241051.json:
```json
{
    "body": "Really? O_o I really don't believe that is faster because `homogeneous component` is:\n\n```python\ndegree_on_basis = self.parent().degree_on_basis\nreturn self.parent().sum_of_terms((i, c)\n                                  for (i, c) in self\n                                  if degree_on_basis(i) == n)\n```\nPlus there is a `sorted` being called in `support`, not to mention the intermediate element created. I don't see how we'd be doing fewer terms in the sum.\n\nAhhh...here's a thought, it's the call to `sorted` that results in the speedup because the smaller elements result in fewer terms that have to be resolved until the end. I'm going to experiment, but if that's true, then that's one subtle issue.\n\nAlthough that call to `QQqt` is superfluous as `_Lmunu` returns an element of `QQqt`.",
    "created_at": "2015-04-23T18:42:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241051",
    "user": "https://github.com/tscrim"
}
```

Really? O_o I really don't believe that is faster because `homogeneous component` is:

```python
degree_on_basis = self.parent().degree_on_basis
return self.parent().sum_of_terms((i, c)
                                  for (i, c) in self
                                  if degree_on_basis(i) == n)
```
Plus there is a `sorted` being called in `support`, not to mention the intermediate element created. I don't see how we'd be doing fewer terms in the sum.

Ahhh...here's a thought, it's the call to `sorted` that results in the speedup because the smaller elements result in fewer terms that have to be resolved until the end. I'm going to experiment, but if that's true, then that's one subtle issue.

Although that call to `QQqt` is superfluous as `_Lmunu` returns an element of `QQqt`.



---

archive/issue_comments_241052.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-23T18:56:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241052",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_241053.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-23T18:57:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241053",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_241054.json:
```json
{
    "body": "A couple comments on the cmunu1(mu, nu) function:\n\nThe comments on lines 640-641 of macdonald.py are obsolete, right?\n\nYou use prod(...) and QQqt(prod(...)). I have not done any profiling, but wouldn't QQqt.prod(...) be the \"right\" way in both situations?\n\nOn line 936, what is \\mu'? The conjugate?",
    "created_at": "2015-04-23T19:10:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241054",
    "user": "https://github.com/darijgr"
}
```

A couple comments on the cmunu1(mu, nu) function:

The comments on lines 640-641 of macdonald.py are obsolete, right?

You use prod(...) and QQqt(prod(...)). I have not done any profiling, but wouldn't QQqt.prod(...) be the "right" way in both situations?

On line 936, what is \mu'? The conjugate?



---

archive/issue_comments_241055.json:
```json
{
    "body": "Yes, it is the call to `sorted` that causes the slowdown, which does make sense because the coefficients we obtain have fewer terms (at least, that's my assumption). Quite a subtle issue IMO (perhaps this is more expected to you?). This version is faster than your version in my testing with `s[3,2,2].nabla()` and `H(s[3,2,2,1])`. If this is faster, then I think we can set this to positive review. (BTW, we are wanting to remove the call to `sorted` in `support`)",
    "created_at": "2015-04-23T19:10:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241055",
    "user": "https://github.com/tscrim"
}
```

Yes, it is the call to `sorted` that causes the slowdown, which does make sense because the coefficients we obtain have fewer terms (at least, that's my assumption). Quite a subtle issue IMO (perhaps this is more expected to you?). This version is faster than your version in my testing with `s[3,2,2].nabla()` and `H(s[3,2,2,1])`. If this is faster, then I think we can set this to positive review. (BTW, we are wanting to remove the call to `sorted` in `support`)



---

archive/issue_comments_241056.json:
```json
{
    "body": "Strangely, this is not faster.\n\n```\nsage: %time s[3,3,3,3].nabla()\nCPU times: user 4min 11s, sys: 555 ms, total: 4min 12s\nWall time: 4min 12s\n```",
    "created_at": "2015-04-23T19:23:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241056",
    "user": "https://github.com/zabrocki"
}
```

Strangely, this is not faster.

```
sage: %time s[3,3,3,3].nabla()
CPU times: user 4min 11s, sys: 555 ms, total: 4min 12s
Wall time: 4min 12s
```



---

archive/issue_comments_241057.json:
```json
{
    "body": "*bangs head into the nearest wall* I'll have to test and profile on a larger example then...",
    "created_at": "2015-04-23T20:15:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241057",
    "user": "https://github.com/tscrim"
}
```

*bangs head into the nearest wall* I'll have to test and profile on a larger example then...



---

archive/issue_comments_241058.json:
```json
{
    "body": "For the record, this is what I get.\nCurrent version:\n\n```\nsage: %time s[3,2,2].nabla()\nCPU times: user 7.61 s, sys: 73.2 ms, total: 7.68 s\nWall time: 7.6 s\n```\nYour commit:\n\n```\nsage: %time s[3,2,2].nabla()\nCPU times: user 7.7 s, sys: 25.1 ms, total: 7.72 s\nWall time: 7.68 s\n```\nCurrent:\n\n```\nsage: %time s[3,2,2,1].nabla()\nCPU times: user 27.4 s, sys: 74.8 ms, total: 27.5 s\nWall time: 27.5 s\n```\nYours:\n\n```\nsage: %time s[3,2,2,1].nabla()\nCPU times: user 27.5 s, sys: 42.3 ms, total: 27.5 s\nWall time: 27.5 s\n```\nFrom profiling, the current branch of the above example has fewer function calls by ~5%, and at the very least, this should not increase the time when they do the same functionality (except for checking for coefficients of 0). For smaller partitions, the recent commit seems to be faster, but the larger ones it slows down. I don't understand and am missing something. Perhaps we should just revert back to `da67e9a` and go with that.",
    "created_at": "2015-04-23T20:48:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241058",
    "user": "https://github.com/tscrim"
}
```

For the record, this is what I get.
Current version:

```
sage: %time s[3,2,2].nabla()
CPU times: user 7.61 s, sys: 73.2 ms, total: 7.68 s
Wall time: 7.6 s
```
Your commit:

```
sage: %time s[3,2,2].nabla()
CPU times: user 7.7 s, sys: 25.1 ms, total: 7.72 s
Wall time: 7.68 s
```
Current:

```
sage: %time s[3,2,2,1].nabla()
CPU times: user 27.4 s, sys: 74.8 ms, total: 27.5 s
Wall time: 27.5 s
```
Yours:

```
sage: %time s[3,2,2,1].nabla()
CPU times: user 27.5 s, sys: 42.3 ms, total: 27.5 s
Wall time: 27.5 s
```
From profiling, the current branch of the above example has fewer function calls by ~5%, and at the very least, this should not increase the time when they do the same functionality (except for checking for coefficients of 0). For smaller partitions, the recent commit seems to be faster, but the larger ones it slows down. I don't understand and am missing something. Perhaps we should just revert back to `da67e9a` and go with that.



---

archive/issue_comments_241059.json:
```json
{
    "body": "I am no longer convinced `da67e9a` is faster.  I ran about 15-20 timings of `s[3,3,3,3].nabla()` and sometimes it was faster, sometimes it wasn't.  They seem about the same, but if you say there are ~5% less function calls with current, lets go with that.",
    "created_at": "2015-04-23T23:06:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241059",
    "user": "https://github.com/zabrocki"
}
```

I am no longer convinced `da67e9a` is faster.  I ran about 15-20 timings of `s[3,3,3,3].nabla()` and sometimes it was faster, sometimes it wasn't.  They seem about the same, but if you say there are ~5% less function calls with current, lets go with that.



---

archive/issue_comments_241060.json:
```json
{
    "body": "I closed all other applications and windows, dimmed the lights, very quietly breathed through my nose and ran some more timing tests.  Current: 3.55, 3.53 and 3.55 and on branch `da67e9a`: 3.55, 3.54 and 3.56.  My conclusion: close enough.",
    "created_at": "2015-04-24T12:29:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241060",
    "user": "https://github.com/zabrocki"
}
```

I closed all other applications and windows, dimmed the lights, very quietly breathed through my nose and ran some more timing tests.  Current: 3.55, 3.53 and 3.55 and on branch `da67e9a`: 3.55, 3.54 and 3.56.  My conclusion: close enough.



---

archive/issue_comments_241061.json:
```json
{
    "body": "One typo in the doctests, see patchbot reports",
    "created_at": "2015-04-24T19:27:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241061",
    "user": "https://github.com/fchapoton"
}
```

One typo in the doctests, see patchbot reports



---

archive/issue_comments_241062.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-25T06:14:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241062",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_241063.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-25T06:22:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241063",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_241064.json:
```json
{
    "body": "I'd ask if you put on some mood music, but that would've disrupted the timings. :P I also addressed [comment:52 Darij's questions].\n\nDarij, I found that running `prod` is faster than `QQqt.prod` on this scale because the C/cython implementation of the `prod` function plus the one coercion beats the python implementation of the `prod` method without a coercion.\n\nSo I think we're at positive review?",
    "created_at": "2015-04-25T06:26:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241064",
    "user": "https://github.com/tscrim"
}
```

I'd ask if you put on some mood music, but that would've disrupted the timings. :P I also addressed [comment:52 Darij's questions].

Darij, I found that running `prod` is faster than `QQqt.prod` on this scale because the C/cython implementation of the `prod` function plus the one coercion beats the python implementation of the `prod` method without a coercion.

So I think we're at positive review?



---

archive/issue_comments_241065.json:
```json
{
    "body": "Ouch, this speaks badly of our OOP. Thanks for timing!",
    "created_at": "2015-04-25T06:28:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241065",
    "user": "https://github.com/darijgr"
}
```

Ouch, this speaks badly of our OOP. Thanks for timing!



---

archive/issue_comments_241066.json:
```json
{
    "body": "It's not OOP per say, it's just Python vs. Cython. Usually performing the coercion is the slow step. However, in this case because the multiplication is slow and frequent. The little python difference adds up.",
    "created_at": "2015-04-25T06:38:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241066",
    "user": "https://github.com/tscrim"
}
```

It's not OOP per say, it's just Python vs. Cython. Usually performing the coercion is the slow step. However, in this case because the multiplication is slow and frequent. The little python difference adds up.



---

archive/issue_comments_241067.json:
```json
{
    "body": "What I mean is that the implementation in Sage makes the OOP-friendly methods slower than the hacky ducktyped ones. It's not a good state to be in... Is there a way to implement `M.sum` and `R.prod` in Cython without refactoring the whole classes?",
    "created_at": "2015-04-25T06:41:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241067",
    "user": "https://github.com/darijgr"
}
```

What I mean is that the implementation in Sage makes the OOP-friendly methods slower than the hacky ducktyped ones. It's not a good state to be in... Is there a way to implement `M.sum` and `R.prod` in Cython without refactoring the whole classes?



---

archive/issue_comments_241068.json:
```json
{
    "body": "That's not quite being fair to Sage as: the built-in python version is just as ducktyped, it is a shortcoming of support in Cython to not be able to handle multiple inheritance, and `M.sum` and `M.prod` don't guarantee the result is in `M`. If you want the builtin/cython speed, then call `prod(args, M.one())` (the coercion really is non-existent in terms of time here).",
    "created_at": "2015-04-25T06:48:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241068",
    "user": "https://github.com/tscrim"
}
```

That's not quite being fair to Sage as: the built-in python version is just as ducktyped, it is a shortcoming of support in Cython to not be able to handle multiple inheritance, and `M.sum` and `M.prod` don't guarantee the result is in `M`. If you want the builtin/cython speed, then call `prod(args, M.one())` (the coercion really is non-existent in terms of time here).



---

archive/issue_comments_241069.json:
```json
{
    "body": "Ah, nice trick with `M.one()`.",
    "created_at": "2015-04-25T06:50:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241069",
    "user": "https://github.com/darijgr"
}
```

Ah, nice trick with `M.one()`.



---

archive/issue_comments_241070.json:
```json
{
    "body": "I am pleased.  I think it is ready for positive review.  Thanks for all the effort put into it.",
    "created_at": "2015-04-25T13:04:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241070",
    "user": "https://github.com/zabrocki"
}
```

I am pleased.  I think it is ready for positive review.  Thanks for all the effort put into it.



---

archive/issue_comments_241071.json:
```json
{
    "body": "Thanks for all your testing and timings too.",
    "created_at": "2015-04-25T16:05:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241071",
    "user": "https://github.com/tscrim"
}
```

Thanks for all your testing and timings too.



---

archive/issue_comments_241072.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-04-25T16:05:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241072",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_051449.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-04-26T02:21:40Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17957#event-51449"
}
```



---

archive/issue_comments_241073.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-04-26T02:21:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17957#issuecomment-241073",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
