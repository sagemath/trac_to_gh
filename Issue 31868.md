# Issue 31868: numpy 1.21.x, scipy 1.7.x

Issue created by migration from https://trac.sagemath.org/ticket/32105

Original creator: mkoeppe

Original creation time: 2021-07-03 06:27:08

CC:  fbissey arojas dimpase @kliem

https://github.com/numpy/numpy/releases

https://docs.scipy.org/doc/scipy/reference/release.1.7.0.html


---

Comment by slelievre created at 2021-07-19 23:45:50

NumPy 1.21.1 was released.

- https://github.com/numpy/numpy/releases/tag/v1.21.1

> The NumPy 1.21.1 is a maintenance release that fixes bugs
> discovered after the 1.21.0 release and updates OpenBLAS
> to v0.3.17 to deal with problems on arm64.
>
> The Python versions supported for this release are 3.7-3.9.
> The 1.21.x series is compatible with development Python 3.10.
> Python 3.10 will be officially supported after it is released.
>
> ⚠️ There are unresolved problems compiling NumPy 1.20.0
> with gcc-11.1.
>
> - Optimization level -O3 results in many incorrect
>   warnings when running the tests.
> - On some hardware NumPy will hang in an infinite loop.


---

Comment by mkoeppe created at 2021-08-12 02:29:17

New commits:


---

Comment by git created at 2021-08-14 23:39:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-25 18:41:14

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-08-25 21:48:26

Changing status from new to needs_review.


---

Comment by fbissey created at 2021-08-25 21:54:35

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2021-08-25 21:54:35

LGTM


---

Comment by vbraun created at 2021-08-29 12:42:51


```
[scipy-1.7.1]       FOUND:
[scipy-1.7.1]         libraries = ['openblas', 'openblas']
[scipy-1.7.1]         library_dirs = ['/usr/lib64']
[scipy-1.7.1]         language = f77
[scipy-1.7.1]         define_macros = [('NO_ATLAS_INFO', 1)]
[scipy-1.7.1]         include_dirs = ['/usr/local/include', '/home/release/Sage/local/include']
[scipy-1.7.1] 
[scipy-1.7.1]     Traceback (most recent call last):
[scipy-1.7.1]       File "/home/release/Sage/local/lib64/python3.9/site-packages/pip/_vendor/pep517/in_process/_in_process.py", line 280, in <module>
[scipy-1.7.1]         main()
[scipy-1.7.1]       File "/home/release/Sage/local/lib64/python3.9/site-packages/pip/_vendor/pep517/in_process/_in_process.py", line 263, in main
[scipy-1.7.1]         json_out['return_val'] = hook(**hook_input['kwargs'])
[scipy-1.7.1]       File "/home/release/Sage/local/lib64/python3.9/site-packages/pip/_vendor/pep517/in_process/_in_process.py", line 133, in prepare_metadata_for_build_wheel
[scipy-1.7.1]         return hook(metadata_directory, config_settings)
[scipy-1.7.1]       File "/home/release/Sage/local/lib64/python3.9/site-packages/setuptools/build_meta.py", line 166, in prepare_metadata_for_build_wheel
[scipy-1.7.1]         self.run_setup()
[scipy-1.7.1]       File "/home/release/Sage/local/lib64/python3.9/site-packages/setuptools/build_meta.py", line 258, in run_setup
[scipy-1.7.1]         super(_BuildMetaLegacyBackend,
[scipy-1.7.1]       File "/home/release/Sage/local/lib64/python3.9/site-packages/setuptools/build_meta.py", line 150, in run_setup
[scipy-1.7.1]         exec(compile(code, __file__, 'exec'), locals())
[scipy-1.7.1]       File "setup.py", line 629, in <module>
[scipy-1.7.1]         setup_package()
[scipy-1.7.1]       File "setup.py", line 625, in setup_package
[scipy-1.7.1]         setup(**metadata)
[scipy-1.7.1]       File "/home/release/Sage/local/lib64/python3.9/site-packages/numpy/distutils/core.py", line 135, in setup
[scipy-1.7.1]         config = configuration()
[scipy-1.7.1]       File "setup.py", line 536, in configuration
[scipy-1.7.1]         config.add_subpackage('scipy')
[scipy-1.7.1]       File "/home/release/Sage/local/lib64/python3.9/site-packages/numpy/distutils/misc_util.py", line 1016, in add_subpackage
[scipy-1.7.1]         config_list = self.get_subpackage(subpackage_name, subpackage_path,
[scipy-1.7.1]       File "/home/release/Sage/local/lib64/python3.9/site-packages/numpy/distutils/misc_util.py", line 982, in get_subpackage
[scipy-1.7.1]         config = self._get_configuration_from_setup_py(
[scipy-1.7.1]       File "/home/release/Sage/local/lib64/python3.9/site-packages/numpy/distutils/misc_util.py", line 924, in _get_configuration_from_setup_py
[scipy-1.7.1]         config = setup_module.configuration(*args)
[scipy-1.7.1]       File "scipy/setup.py", line 12, in configuration
[scipy-1.7.1]         config.add_subpackage('interpolate')
[scipy-1.7.1]       File "/home/release/Sage/local/lib64/python3.9/site-packages/numpy/distutils/misc_util.py", line 1016, in add_subpackage
[scipy-1.7.1]         config_list = self.get_subpackage(subpackage_name, subpackage_path,
[scipy-1.7.1]       File "/home/release/Sage/local/lib64/python3.9/site-packages/numpy/distutils/misc_util.py", line 982, in get_subpackage
[scipy-1.7.1]         config = self._get_configuration_from_setup_py(
[scipy-1.7.1]       File "/home/release/Sage/local/lib64/python3.9/site-packages/numpy/distutils/misc_util.py", line 924, in _get_configuration_from_setup_py
[scipy-1.7.1]         config = setup_module.configuration(*args)
[scipy-1.7.1]       File "scipy/interpolate/setup.py", line 58, in configuration
[scipy-1.7.1]         from pythran.dist import PythranExtension
[scipy-1.7.1]       File "/home/release/Sage/local/lib64/python3.9/site-packages/pythran/__init__.py", line 41, in <module>
[scipy-1.7.1]         from pythran.toolchain import (generate_cxx, compile_cxxfile, compile_cxxcode,
[scipy-1.7.1]       File "/home/release/Sage/local/lib64/python3.9/site-packages/pythran/toolchain.py", line 6, in <module>
[scipy-1.7.1]         from pythran.backend import Cxx, Python
[scipy-1.7.1]       File "/home/release/Sage/local/lib64/python3.9/site-packages/pythran/backend.py", line 7, in <module>
[scipy-1.7.1]         from pythran.analyses import LocalNodeDeclarations, GlobalDeclarations, Scope
[scipy-1.7.1]       File "/home/release/Sage/local/lib64/python3.9/site-packages/pythran/analyses/__init__.py", line 12, in <module>
[scipy-1.7.1]         from .aliases import Aliases, StrictAliases
[scipy-1.7.1]       File "/home/release/Sage/local/lib64/python3.9/site-packages/pythran/analyses/aliases.py", line 3, in <module>
[scipy-1.7.1]         from pythran.analyses.global_declarations import GlobalDeclarations
[scipy-1.7.1]       File "/home/release/Sage/local/lib64/python3.9/site-packages/pythran/analyses/global_declarations.py", line 3, in <module>
[scipy-1.7.1]         from pythran.passmanager import ModuleAnalysis
[scipy-1.7.1]       File "/home/release/Sage/local/lib64/python3.9/site-packages/pythran/passmanager.py", line 14, in <module>
[scipy-1.7.1]         import gast as ast
[scipy-1.7.1]     ModuleNotFoundError: No module named 'gast'
[scipy-1.7.1]     Preparing wheel metadata: finished with status 'error'
[scipy-1.7.1] WARNING: Discarding file:///home/release/Sage/local/var/tmp/sage/build/scipy-1.7.1/src. Command errored out with exit status 1: /home/release/Sage/local/bin/python3 /home/release/Sage/local/lib64/python3.9/site-packages/pip/_vendor/pep517/in_process/_in_process.py prepare_metadata_for_build_wheel /tmp/tmpne_r946f Check the logs for full command output.
[scipy-1.7.1] ERROR: Command errored out with exit status 1: /home/release/Sage/local/bin/python3 /home/release/Sage/local/lib64/python3.9/site-packages/pip/_vendor/pep517/in_process/_in_process.py prepare_metadata_for_build_wheel /tmp/tmpne_r946f Check the logs for full command output.
```



---

Comment by vbraun created at 2021-08-29 12:42:51

Changing status from positive_review to needs_work.


---

Comment by mkoeppe created at 2021-08-29 19:29:27

Indeed, from https://github.com/serge-sans-paille/pythran/blob/0.9.12.post1/requirements.txt:

```
ply>=3.4
gast~=0.5.0
numpy
beniget~=0.4.0
```



---

Comment by mkoeppe created at 2021-08-30 01:02:28

https://github.com/serge-sans-paille/gast is basically a backport package for Python 3's `ast`. I tried to patch it out in https://github.com/mkoeppe/pythran/pull/3, but that did not work, apparently because of https://github.com/serge-sans-paille/gast#ast-changes


---

Comment by mkoeppe created at 2021-09-07 22:20:50

I'm splitting out the easier numpy update to #32488.


---

Comment by git created at 2021-09-18 04:58:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-09-18 04:59:32

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-09-18 05:18:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-11-02 20:07:24

lgtm - perhaps, merge the current beta in, and run tests on GH Actions?


---

Comment by git created at 2021-11-02 20:24:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-11-02 20:37:17

Running the CI tests on top of Volker's current branch, which includes critical build fixes such as #32746


---

Comment by dimpase created at 2021-11-05 13:15:27

looks OK, modulo unrelated errors, and the usual Cygwin blues


---

Comment by dimpase created at 2021-11-05 13:15:27

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-11-05 17:25:20

Thanks.


---

Comment by vbraun created at 2021-11-11 00:04:21

After a make distclean (and not just an incremental build, and not just make clean) test fail with

```
sage -t --warn-long 59.1 --random-seed=32710823712882651180286903013949123952 src/sage/ext/memory_allocator.pxd  # 2 doctests failed
sage -t --warn-long 59.1 --random-seed=32710823712882651180286903013949123952 src/sage/ext/memory_allocator.pyx  # 1 doctest failed
```



---

Comment by vbraun created at 2021-11-11 00:04:21

Changing status from positive_review to needs_work.


---

Comment by git created at 2021-11-15 04:03:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-11-15 04:03:40

In the meantime new versions have come out


---

Comment by git created at 2021-11-15 04:45:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-11-15 07:25:56

Replying to [comment:30 vbraun]:
> After a make distclean (and not just an incremental build, and not just make clean) test fail with
> {{{
> sage -t --warn-long 59.1 --random-seed=32710823712882651180286903013949123952 src/sage/ext/memory_allocator.pxd  # 2 doctests failed
> sage -t --warn-long 59.1 --random-seed=32710823712882651180286903013949123952 src/sage/ext/memory_allocator.pyx  # 1 doctest failed
> }}}

I can reproduce those failures and they are trivial:


```
sage -t --warn-long 59.1 --random-seed=32710823712882651180286903013949123952 src/sage/ext/memory_allocator.pxd
**********************************************************************
File "src/sage/ext/memory_allocator.pxd", line 88, in sage.ext.memory_allocator.MemoryAllocator.?
Failed example:
    cython('''
    from sage.ext.memory_allocator cimport MemoryAllocator
    cdef MemoryAllocator mem = MemoryAllocator()
    cdef void* ptr
    for i in range(12):
        ptr = mem.aligned_calloc(2**i, i, 2**i)
        assert <size_t> ptr == (<size_t> ptr) & ~(2**i-1)
    ''')
Expected nothing
Got:
    doctest:warning
      File "/srv/public/kliem/sage/src/bin/sage-runtests", line 151, in <module>
        err = DC.run()
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/doctest/control.py", line 1257, in run
        self.run_doctests()
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/doctest/control.py", line 959, in run_doctests
        self.dispatcher.dispatch()
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1996, in dispatch
        self.parallel_dispatch()
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1891, in parallel_dispatch
        w.start()  # This might take some time
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 2163, in start
        super(DocTestWorker, self).start()
      File "/usr/lib/python3.7/multiprocessing/process.py", line 112, in start
        self._popen = self._Popen(self)
      File "/usr/lib/python3.7/multiprocessing/context.py", line 223, in _Popen
        return _default_context.get_context().Process._Popen(process_obj)
      File "/usr/lib/python3.7/multiprocessing/context.py", line 277, in _Popen
        return Popen(process_obj)
      File "/usr/lib/python3.7/multiprocessing/popen_fork.py", line 20, in __init__
        self._launch(process_obj)
      File "/usr/lib/python3.7/multiprocessing/popen_fork.py", line 74, in _launch
        code = process_obj._bootstrap()
      File "/usr/lib/python3.7/multiprocessing/process.py", line 297, in _bootstrap
        self.run()
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 2135, in run
        task(self.options, self.outtmpfile, msgpipe, self.result_queue)
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 2465, in __call__
        doctests, extras = self._run(runner, options, results)
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 2517, in _run
        result = runner.run(test)
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 861, in run
        return self._run(test, compileflags, out)
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.ext.memory_allocator.MemoryAllocator.?[0]>", line 8, in <module>
        ''')
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/misc/cython.py", line 661, in cython_compile
        return cython_import_all(tmpfile, get_globals(), **kwds)
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/misc/cython.py", line 551, in cython_import_all
        m = cython_import(filename, **kwds)
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/misc/cython.py", line 531, in cython_import
        return builtins.__import__(name)
      File "<frozen importlib._bootstrap>", line 983, in _find_and_load
      File "<frozen importlib._bootstrap>", line 967, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 677, in _load_unlocked
      File "<frozen importlib._bootstrap_external>", line 1050, in exec_module
      File "<frozen importlib._bootstrap>", line 219, in _call_with_frames_removed
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/misc/superseded.py", line 99, in deprecation
        warning(trac_number, message, DeprecationWarning, stacklevel)
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/misc/superseded.py", line 180, in warning
        warn(message, warning_class, stacklevel)
      File "/usr/lib/python3.7/warnings.py", line 110, in _showwarnmsg
        msg.file, msg.line)
    :
    DeprecationWarning: this class is deprecated; use the class from the python package `memory_allocator`
    See https://trac.sagemath.org/31591 for details.
**********************************************************************
File "src/sage/ext/memory_allocator.pxd", line 119, in sage.ext.memory_allocator.MemoryAllocator.?
Failed example:
    cython('''
    from sage.ext.memory_allocator cimport MemoryAllocator
    cdef MemoryAllocator mem = MemoryAllocator()
    cdef void* ptr
    for i in range(12):
        ptr = mem.aligned_allocarray(2**i, i, 2**i)
        assert <size_t> ptr == (<size_t> ptr) & ~(2**i-1)
    ''')
Expected nothing
Got:
    doctest:warning
      File "/srv/public/kliem/sage/src/bin/sage-runtests", line 151, in <module>
        err = DC.run()
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/doctest/control.py", line 1257, in run
        self.run_doctests()
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/doctest/control.py", line 959, in run_doctests
        self.dispatcher.dispatch()
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1996, in dispatch
        self.parallel_dispatch()
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1891, in parallel_dispatch
        w.start()  # This might take some time
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 2163, in start
        super(DocTestWorker, self).start()
      File "/usr/lib/python3.7/multiprocessing/process.py", line 112, in start
        self._popen = self._Popen(self)
      File "/usr/lib/python3.7/multiprocessing/context.py", line 223, in _Popen
        return _default_context.get_context().Process._Popen(process_obj)
      File "/usr/lib/python3.7/multiprocessing/context.py", line 277, in _Popen
        return Popen(process_obj)
      File "/usr/lib/python3.7/multiprocessing/popen_fork.py", line 20, in __init__
        self._launch(process_obj)
      File "/usr/lib/python3.7/multiprocessing/popen_fork.py", line 74, in _launch
        code = process_obj._bootstrap()
      File "/usr/lib/python3.7/multiprocessing/process.py", line 297, in _bootstrap
        self.run()
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 2135, in run
        task(self.options, self.outtmpfile, msgpipe, self.result_queue)
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 2465, in __call__
        doctests, extras = self._run(runner, options, results)
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 2517, in _run
        result = runner.run(test)
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 861, in run
        return self._run(test, compileflags, out)
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.ext.memory_allocator.MemoryAllocator.?[0]>", line 8, in <module>
        ''')
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/misc/cython.py", line 661, in cython_compile
        return cython_import_all(tmpfile, get_globals(), **kwds)
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/misc/cython.py", line 551, in cython_import_all
        m = cython_import(filename, **kwds)
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/misc/cython.py", line 531, in cython_import
        return builtins.__import__(name)
      File "<frozen importlib._bootstrap>", line 983, in _find_and_load
      File "<frozen importlib._bootstrap>", line 967, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 677, in _load_unlocked
      File "<frozen importlib._bootstrap_external>", line 1050, in exec_module
      File "<frozen importlib._bootstrap>", line 219, in _call_with_frames_removed
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/misc/superseded.py", line 99, in deprecation
        warning(trac_number, message, DeprecationWarning, stacklevel)
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/misc/superseded.py", line 180, in warning
        warn(message, warning_class, stacklevel)
      File "/usr/lib/python3.7/warnings.py", line 110, in _showwarnmsg
        msg.file, msg.line)
    :
    DeprecationWarning: this class is deprecated; use the class from the python package `memory_allocator`
    See https://trac.sagemath.org/31591 for details.
**********************************************************************
1 item had failures:
   2 of   6 in sage.ext.memory_allocator.MemoryAllocator.?
    [3 tests, 2 failures, 1.77 s]
----------------------------------------------------------------------
sage -t --warn-long 59.1 --random-seed=32710823712882651180286903013949123952 src/sage/ext/memory_allocator.pxd  # 2 doctests failed
```



```
sage -t --warn-long 59.1 --random-seed=32710823712882651180286903013949123952 src/sage/ext/memory_allocator.pyx
**********************************************************************
File "src/sage/ext/memory_allocator.pyx", line 34, in sage.ext.memory_allocator.MemoryAllocator.__cinit__
Failed example:
    cython(
    '''
    from sage.ext.memory_allocator cimport MemoryAllocator
    cdef MemoryAllocator mem = MemoryAllocator.__new__(MemoryAllocator)
    mem.malloc(10000)
    print(mem.n)
    print(mem.size)
    ''')
Expected:
    1
    16
Got:
    doctest:warning
      File "/srv/public/kliem/sage/src/bin/sage-runtests", line 151, in <module>
        err = DC.run()
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/doctest/control.py", line 1257, in run
        self.run_doctests()
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/doctest/control.py", line 959, in run_doctests
        self.dispatcher.dispatch()
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1996, in dispatch
        self.parallel_dispatch()
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1891, in parallel_dispatch
        w.start()  # This might take some time
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 2163, in start
        super(DocTestWorker, self).start()
      File "/usr/lib/python3.7/multiprocessing/process.py", line 112, in start
        self._popen = self._Popen(self)
      File "/usr/lib/python3.7/multiprocessing/context.py", line 223, in _Popen
        return _default_context.get_context().Process._Popen(process_obj)
      File "/usr/lib/python3.7/multiprocessing/context.py", line 277, in _Popen
        return Popen(process_obj)
      File "/usr/lib/python3.7/multiprocessing/popen_fork.py", line 20, in __init__
        self._launch(process_obj)
      File "/usr/lib/python3.7/multiprocessing/popen_fork.py", line 74, in _launch
        code = process_obj._bootstrap()
      File "/usr/lib/python3.7/multiprocessing/process.py", line 297, in _bootstrap
        self.run()
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 2135, in run
        task(self.options, self.outtmpfile, msgpipe, self.result_queue)
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 2465, in __call__
        doctests, extras = self._run(runner, options, results)
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 2517, in _run
        result = runner.run(test)
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 861, in run
        return self._run(test, compileflags, out)
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.ext.memory_allocator.MemoryAllocator.__cinit__[0]>", line 8, in <module>
        ''')
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/misc/cython.py", line 661, in cython_compile
        return cython_import_all(tmpfile, get_globals(), **kwds)
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/misc/cython.py", line 551, in cython_import_all
        m = cython_import(filename, **kwds)
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/misc/cython.py", line 531, in cython_import
        return builtins.__import__(name)
      File "<frozen importlib._bootstrap>", line 983, in _find_and_load
      File "<frozen importlib._bootstrap>", line 967, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 677, in _load_unlocked
      File "<frozen importlib._bootstrap_external>", line 1050, in exec_module
      File "<frozen importlib._bootstrap>", line 219, in _call_with_frames_removed
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/misc/superseded.py", line 99, in deprecation
        warning(trac_number, message, DeprecationWarning, stacklevel)
      File "/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/misc/superseded.py", line 180, in warning
        warn(message, warning_class, stacklevel)
      File "/usr/lib/python3.7/warnings.py", line 110, in _showwarnmsg
        msg.file, msg.line)
    :
    DeprecationWarning: this class is deprecated; use the class from the python package `memory_allocator`
    See https://trac.sagemath.org/31591 for details.
    1
    16
**********************************************************************
1 item had failures:
   1 of   2 in sage.ext.memory_allocator.MemoryAllocator.__cinit__
    [8 tests, 1 failure, 1.76 s]
----------------------------------------------------------------------
sage -t --warn-long 59.1 --random-seed=32710823712882651180286903013949123952 src/sage/ext/memory_allocator.pyx  # 1 doctest failed
```


Doesn't require a distclean in my case. I have no idea why this is happening now and how to determine when deprecation messages are raised and when not.

For some reason it changed now.


---

Comment by @kliem created at 2021-11-15 07:47:47

Changing status from needs_work to positive_review.


---

Comment by @kliem created at 2021-11-15 07:47:47

This has nothing to do with the current ticket. Something change in the new develop:

On debian buster I get (not on ubuntu bionic):


```
sage -t --random-seed=217031171464721311270444360210868711734 src/sage/ext/memory_allocator.pxd  # 2 doctests failed
sage -t --random-seed=217031171464721311270444360210868711734 src/sage/ext/memory_allocator.pyx  # 1 doctest failed
```



---

Comment by @kliem created at 2021-11-15 10:51:12

Sorry about the mess. It has something to do with the ticket. When running on `make distclean` on develop, the error goes away again. I'm not sure exactly what packages caused this.


---

Comment by @kliem created at 2021-11-15 10:51:12

Changing status from positive_review to needs_work.


---

Comment by @kliem created at 2021-11-15 14:02:30

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2021-11-15 14:02:30

Don't ask me why those deprecation warnings are somewhat random. They are given in each case, but sometimes they are given again and sometimes not and for some strange reason the current branch changed that.

I pushed a patch that works on top of develop and on this ticket.
----
New commits:


---

Comment by mkoeppe created at 2021-11-15 17:32:39

Try if using `deprecation_cython` instead of `deprecation` helps


---

Comment by @kliem created at 2021-11-15 19:09:32

Not really. It only changes the stacklevel. Then there are two failures each in the files, one of which is also on develop. So it remains that we must have a workaround for the other 3 cases.


---

Comment by mkoeppe created at 2021-11-16 18:27:39

LGTM, thanks.


---

Comment by mkoeppe created at 2021-11-16 18:27:39

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2021-11-16 18:56:45

I missed that last commit. I guess I am quite busy elsewhere. I would have treated all those like the second block

```
sage: foo()  # random  # might raise deprecation warning
sage: foo()
```

I have noticed this very failure in sage-on-gentoo for the last couple of weeks wondering where it was coming from. I was tempted to add the deprecation warning to the output when I noticed that some earlier tests already had it.
https://github.com/sagemath/sage/blob/develop/src/sage/ext/memory_allocator.pxd#L67
https://github.com/sagemath/sage/blob/develop/src/sage/ext/memory_allocator.pyx#L27

So, it followed the pattern of one warning per session and somehow we are not having one session anymore.

I think the current branch will work because this is the "new stable", rather than being unstable. If I am wrong and it is unstable, we can expect failures on some systems because a warning was displayed that wasn't expected.


---

Comment by slelievre created at 2021-11-24 22:01:23

Bugfix release SciPy 1.7.3 was just released,
with fixes for Apple M1 processors.

- https://mail.python.org/archives/list/python-announce-list`@`python.org/thread/GDFAHAADIZEGQS6ZK4ITROE3GUJBTABJ/


---

Comment by fbissey created at 2021-11-24 22:04:48

Current branch is in Volker's merging branch, so it will need to be in a follow up unless Volker finds a reason to reject it. From my perspective in sage-on-gentoo the current branch is all good.


---

Comment by vbraun created at 2021-12-05 11:15:37

Resolution: fixed
