# Issue 15280: Run sage-upgrade *outside* of the Sage shell

archive/issues_015280.json:
```json
{
    "body": "CC:  @vbraun @ohanar\n\nRunning `make` inside a Sage shell doesn't really work well, because `sage-env` isn't resourced during the build. This breaks upgrading if new packages are installed in the upgrade which require environment variable changes.\n\nNow that nothing can upgrade **to** Sage 6.0, we should make sure that upgrading **from** Sage 6.0 doesn't suffer this problem.\n\nIssue created by migration from https://trac.sagemath.org/ticket/15517\n\n",
    "created_at": "2013-12-13T13:30:19Z",
    "labels": [
        "component: build",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.0",
    "title": "Run sage-upgrade *outside* of the Sage shell",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15280",
    "user": "https://github.com/jdemeyer"
}
```
CC:  @vbraun @ohanar

Running `make` inside a Sage shell doesn't really work well, because `sage-env` isn't resourced during the build. This breaks upgrading if new packages are installed in the upgrade which require environment variable changes.

Now that nothing can upgrade **to** Sage 6.0, we should make sure that upgrading **from** Sage 6.0 doesn't suffer this problem.

Issue created by migration from https://trac.sagemath.org/ticket/15517





---

archive/issue_comments_196290.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2013-12-13T19:12:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15280#issuecomment-196290",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_196291.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2013-12-13T19:23:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15280#issuecomment-196291",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_196292.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2013-12-13T19:29:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15280#issuecomment-196292",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_196293.json:
```json
{
    "body": "In theory, this needs_review, but I don't manage to test upgrading because I don't know what command line to give to `sage -upgrade`.",
    "created_at": "2013-12-13T19:48:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15280#issuecomment-196293",
    "user": "https://github.com/jdemeyer"
}
```

In theory, this needs_review, but I don't manage to test upgrading because I don't know what command line to give to `sage -upgrade`.



---

archive/issue_comments_196294.json:
```json
{
    "body": "There is no need to name a temporary branch, you can just work with commits:\n\n```\ngit fetch trac master\ngit merge --ff-only FETCH_HEAD\n```\n",
    "created_at": "2013-12-13T19:58:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15280#issuecomment-196294",
    "user": "https://github.com/vbraun"
}
```

There is no need to name a temporary branch, you can just work with commits:

```
git fetch trac master
git merge --ff-only FETCH_HEAD
```




---

archive/issue_comments_196295.json:
```json
{
    "body": "The point is that I want to test the actual `sage -upgrade` command, not emulate it with `git` commands.",
    "created_at": "2013-12-13T20:06:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15280#issuecomment-196295",
    "user": "https://github.com/jdemeyer"
}
```

The point is that I want to test the actual `sage -upgrade` command, not emulate it with `git` commands.



---

archive/issue_comments_196296.json:
```json
{
    "body": "No I get that, but I'm saying that the contraption in the `sage-update` script to generate a random string (as branch name) is entirely unnecessary.",
    "created_at": "2013-12-13T20:07:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15280#issuecomment-196296",
    "user": "https://github.com/vbraun"
}
```

No I get that, but I'm saying that the contraption in the `sage-update` script to generate a random string (as branch name) is entirely unnecessary.



---

archive/issue_comments_196297.json:
```json
{
    "body": "Replying to [comment:10 vbraun]:\n> No I get that, but I'm saying that the contraption in the `sage-update` script to generate a random string (as branch name) is entirely unnecessary.\nPerhaps, but I guess Andrew wrote that, feel free to simplify it.",
    "created_at": "2013-12-13T20:13:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15280#issuecomment-196297",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:10 vbraun]:
> No I get that, but I'm saying that the contraption in the `sage-update` script to generate a random string (as branch name) is entirely unnecessary.
Perhaps, but I guess Andrew wrote that, feel free to simplify it.



---

archive/issue_comments_196298.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-12-15T10:40:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15280#issuecomment-196298",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_196299.json:
```json
{
    "body": "I've simplified the script and added the `--ff-only`.\n----\nNew commits:",
    "created_at": "2013-12-15T20:22:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15280#issuecomment-196299",
    "user": "https://github.com/vbraun"
}
```

I've simplified the script and added the `--ff-only`.
----
New commits:



---

archive/issue_comments_196300.json:
```json
{
    "body": "Andrew, can you review this please?",
    "created_at": "2013-12-15T21:29:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15280#issuecomment-196300",
    "user": "https://github.com/jdemeyer"
}
```

Andrew, can you review this please?



---

archive/issue_comments_196301.json:
```json
{
    "body": "Why are you always upgrading to the current development version, unless otherwise specified? IMO this is a user feature, developers will just be using git directly, so I would argue that it should update to the latest released version by default (which is more or less what the old one was doing -- it just checked if you were on either a released tag, or the release branch).",
    "created_at": "2013-12-15T22:49:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15280#issuecomment-196301",
    "user": "https://github.com/ohanar"
}
```

Why are you always upgrading to the current development version, unless otherwise specified? IMO this is a user feature, developers will just be using git directly, so I would argue that it should update to the latest released version by default (which is more or less what the old one was doing -- it just checked if you were on either a released tag, or the release branch).



---

archive/issue_comments_196302.json:
```json
{
    "body": "There is no release branch yet. Has there been any decision on using (master, release) or (beta, master) or some variation of it? \n\nIn any case, all we have to make sure NOW is that we can update 6.0 to a future version that fixes the update script...",
    "created_at": "2013-12-15T22:53:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15280#issuecomment-196302",
    "user": "https://github.com/vbraun"
}
```

There is no release branch yet. Has there been any decision on using (master, release) or (beta, master) or some variation of it? 

In any case, all we have to make sure NOW is that we can update 6.0 to a future version that fixes the update script...



---

archive/issue_comments_196303.json:
```json
{
    "body": "Replying to [comment:17 vbraun]:\n> There is no release branch yet. Has there been any decision on using (master, release) or (beta, master) or some variation of it?\n\nWhat I was imagining (although you are welcome to do whatever you wish) was that there would be a beta branch (or whatever you would want to call it) -- which would be our release candidate (i.e. only bug fix type things would get merged in here, and when the release manager is happy, it would become the next release). Secondly, when I initially wrote this (like 9 months ago), I was imagining only one release branch, however, I could easily imagine more in the future (e.g. 6.0.x, 6.1.x, etc.).\n\n> \n> In any case, all we have to make sure NOW is that we can update 6.0 to a future version that fixes the update script...\n\nSure. One other thing that I just noticed before I can hand off a positive review, is using origin as the remove server name. Why not just specify the actual repository, since we have no idea where origin would point to (if anywhere)? (i.e. `$SAGE_REPO_ANONYMOUS`)",
    "created_at": "2013-12-15T23:18:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15280#issuecomment-196303",
    "user": "https://github.com/ohanar"
}
```

Replying to [comment:17 vbraun]:
> There is no release branch yet. Has there been any decision on using (master, release) or (beta, master) or some variation of it?

What I was imagining (although you are welcome to do whatever you wish) was that there would be a beta branch (or whatever you would want to call it) -- which would be our release candidate (i.e. only bug fix type things would get merged in here, and when the release manager is happy, it would become the next release). Secondly, when I initially wrote this (like 9 months ago), I was imagining only one release branch, however, I could easily imagine more in the future (e.g. 6.0.x, 6.1.x, etc.).

> 
> In any case, all we have to make sure NOW is that we can update 6.0 to a future version that fixes the update script...

Sure. One other thing that I just noticed before I can hand off a positive review, is using origin as the remove server name. Why not just specify the actual repository, since we have no idea where origin would point to (if anywhere)? (i.e. `$SAGE_REPO_ANONYMOUS`)



---

archive/issue_comments_196304.json:
```json
{
    "body": "I wanted to use *master* as the release branch since we've been publicizing it for a while now. Checking out *master* should give you something that has a high probability of working ;-) Beta versions will go into *develop*. That also matches the git flow thing so far. There can be more short-lived branches but there is probably no need to publish those.\n\nAbout origin, I thought about it. But if origin does not point at our repository then you must have changed it yourself after checking out Sage. The update script shouldn't try to outsmart the user.",
    "created_at": "2013-12-16T01:27:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15280#issuecomment-196304",
    "user": "https://github.com/vbraun"
}
```

I wanted to use *master* as the release branch since we've been publicizing it for a while now. Checking out *master* should give you something that has a high probability of working ;-) Beta versions will go into *develop*. That also matches the git flow thing so far. There can be more short-lived branches but there is probably no need to publish those.

About origin, I thought about it. But if origin does not point at our repository then you must have changed it yourself after checking out Sage. The update script shouldn't try to outsmart the user.



---

archive/issue_comments_196305.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-12-16T18:04:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15280#issuecomment-196305",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_196306.json:
```json
{
    "body": "Resolution changed from fixed to ",
    "created_at": "2013-12-16T18:07:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15280#issuecomment-196306",
    "user": "https://github.com/vbraun"
}
```

Resolution changed from fixed to 



---

archive/issue_comments_196307.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2013-12-16T18:07:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15280#issuecomment-196307",
    "user": "https://github.com/vbraun"
}
```

Changing status from closed to new.



---

archive/issue_comments_196308.json:
```json
{
    "body": "Sorry wrong button... needs review",
    "created_at": "2013-12-16T18:07:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15280#issuecomment-196308",
    "user": "https://github.com/vbraun"
}
```

Sorry wrong button... needs review



---

archive/issue_comments_196309.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-12-16T18:07:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15280#issuecomment-196309",
    "user": "https://github.com/vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_196310.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-12-16T20:21:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15280#issuecomment-196310",
    "user": "https://github.com/ohanar"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_196311.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-12-16T22:53:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15280",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15280#issuecomment-196311",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
