# Issue 15280: Run sage-upgrade *outside* of the Sage shell

Issue created by migration from https://trac.sagemath.org/ticket/15517

Original creator: jdemeyer

Original creation time: 2013-12-13 13:30:19

CC:  vbraun ohanar

Running `make` inside a Sage shell doesn't really work well, because `sage-env` isn't resourced during the build. This breaks upgrading if new packages are installed in the upgrade which require environment variable changes.

Now that nothing can upgrade *to* Sage 6.0, we should make sure that upgrading *from* Sage 6.0 doesn't suffer this problem.


---

Comment by git created at 2013-12-13 19:12:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2013-12-13 19:23:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2013-12-13 19:29:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2013-12-13 19:48:22

In theory, this needs_review, but I don't manage to test upgrading because I don't know what command line to give to `sage -upgrade`.


---

Comment by vbraun created at 2013-12-13 19:58:57

There is no need to name a temporary branch, you can just work with commits:

```
git fetch trac master
git merge --ff-only FETCH_HEAD
```



---

Comment by jdemeyer created at 2013-12-13 20:06:35

The point is that I want to test the actual `sage -upgrade` command, not emulate it with `git` commands.


---

Comment by vbraun created at 2013-12-13 20:07:50

No I get that, but I'm saying that the contraption in the `sage-update` script to generate a random string (as branch name) is entirely unnecessary.


---

Comment by jdemeyer created at 2013-12-13 20:13:19

Replying to [comment:10 vbraun]:
> No I get that, but I'm saying that the contraption in the `sage-update` script to generate a random string (as branch name) is entirely unnecessary.
Perhaps, but I guess Andrew wrote that, feel free to simplify it.


---

Comment by jdemeyer created at 2013-12-15 10:40:53

Changing status from new to needs_review.


---

Comment by vbraun created at 2013-12-15 20:22:53

I've simplified the script and added the `--ff-only`.
----
New commits:


---

Comment by jdemeyer created at 2013-12-15 21:29:28

Andrew, can you review this please?


---

Comment by ohanar created at 2013-12-15 22:49:24

Why are you always upgrading to the current development version, unless otherwise specified? IMO this is a user feature, developers will just be using git directly, so I would argue that it should update to the latest released version by default (which is more or less what the old one was doing -- it just checked if you were on either a released tag, or the release branch).


---

Comment by vbraun created at 2013-12-15 22:53:42

There is no release branch yet. Has there been any decision on using (master, release) or (beta, master) or some variation of it? 

In any case, all we have to make sure NOW is that we can update 6.0 to a future version that fixes the update script...


---

Comment by ohanar created at 2013-12-15 23:18:00

Replying to [comment:17 vbraun]:
> There is no release branch yet. Has there been any decision on using (master, release) or (beta, master) or some variation of it?

What I was imagining (although you are welcome to do whatever you wish) was that there would be a beta branch (or whatever you would want to call it) -- which would be our release candidate (i.e. only bug fix type things would get merged in here, and when the release manager is happy, it would become the next release). Secondly, when I initially wrote this (like 9 months ago), I was imagining only one release branch, however, I could easily imagine more in the future (e.g. 6.0.x, 6.1.x, etc.).

> 
> In any case, all we have to make sure NOW is that we can update 6.0 to a future version that fixes the update script...

Sure. One other thing that I just noticed before I can hand off a positive review, is using origin as the remove server name. Why not just specify the actual repository, since we have no idea where origin would point to (if anywhere)? (i.e. `$SAGE_REPO_ANONYMOUS`)


---

Comment by vbraun created at 2013-12-16 01:27:15

I wanted to use _master_ as the release branch since we've been publicizing it for a while now. Checking out _master_ should give you something that has a high probability of working ;-) Beta versions will go into _develop_. That also matches the git flow thing so far. There can be more short-lived branches but there is probably no need to publish those.

About origin, I thought about it. But if origin does not point at our repository then you must have changed it yourself after checking out Sage. The update script shouldn't try to outsmart the user.


---

Comment by vbraun created at 2013-12-16 18:04:47

Resolution: fixed


---

Comment by vbraun created at 2013-12-16 18:07:34

Resolution changed from fixed to 


---

Comment by vbraun created at 2013-12-16 18:07:34

Changing status from closed to new.


---

Comment by vbraun created at 2013-12-16 18:07:50

Sorry wrong button... needs review


---

Comment by vbraun created at 2013-12-16 18:07:50

Changing status from new to needs_review.


---

Comment by ohanar created at 2013-12-16 20:21:01

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2013-12-16 22:53:31

Resolution: fixed
