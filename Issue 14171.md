# Issue 14171: Indicate escape codes in doctest output

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2013-03-28 19:08:05

Assignee: mvngu

CC:  vbraun

Split off from #14290.


---

Attachment


---

Comment by roed created at 2013-03-28 19:14:21

Apparently CSI stands for Control Sequence Introducer (see [wikipedia](http://en.wikipedia.org/wiki/ANSI_escape_code)).


---

Comment by roed created at 2013-03-28 19:17:43

As for \x9b, I don't have a strong opinion.  I guess I would lean toward escaping it, since it is a valid CSI.


---

Comment by jdemeyer created at 2013-03-28 19:35:48

Replying to [comment:2 roed]:
> As for \x9b, I don't have a strong opinion.  I guess I would lean toward escaping it, since it is a valid CSI.
And how are you going to distinguish between `\x9b` appearing as part of a UTF-8 code?


---

Comment by vbraun created at 2013-03-28 20:53:28

Don't shoot the messenger about the \x9b CSI, I just implemented the specs ;-)

As far as I know the whole Python 2.x doctesting just operates on byte strings without any unicode awareness (see also #14359). How do you specify the encoding of the doctest output, for starters? Since when is it UTF-8?


---

Comment by roed created at 2013-03-28 23:28:46

Changing component from doctest to doctest framework.


---

Comment by roed created at 2013-03-28 23:28:46

Changing assignee from mvngu to roed.


---

Comment by jdemeyer created at 2013-03-29 05:12:34

Replying to [comment:4 vbraun]:
> How do you specify the encoding of the doctest output, for starters? Since when is it UTF-8? 
It's essentially undefined, it could be anything. But it could be UTF-8 with a `\x9b` byte appearing not from a CSI.

Unrelated: I really like Python's `.*?` for regular expressions, this is a nice use of that.


---

Comment by vbraun created at 2013-03-29 10:38:20

We don't have a doctest that spews wide UTF-8 characters containing \x1b or \x9b. The proper solution is to make the doctest framework use unicode instead of byte strings. We will have to revisit this when we switch to python 3. But at this point I don't think there is anything that I can do on this ticket.


---

Comment by jdemeyer created at 2013-03-29 16:26:13

Replying to [comment:7 vbraun]:
> We don't have a doctest that spews wide UTF-8 characters containing \x1b or \x9b.
....yet

> The proper solution is to make the doctest framework use unicode instead of byte strings.
Indeed, see #14153.

> But at this point I don't think there is anything that I can do on this ticket.
Since those `\x9b` codes are rarely/never actually used, simply leave them alone. I think that would be a good compromise.


---

Comment by vbraun created at 2013-03-29 17:39:48

Can we actually finish #14153 before switching to python 3? Without checking, I would guess that there are tons of things that will go wrong when feeding the python 2.7 doctest module with unicode strings. 

If/when we switch to a unicode framework we just replace the byte string regex by its unicode version. There is still a single code point `U+009B` for CSI in addition to the two code point version `U+001B[`. There is no compromise needed since the byte string version of this ticket should never meet the unicode version of the doctest framework.


---

Comment by jdemeyer created at 2013-03-29 17:53:35

Replying to [comment:9 vbraun]:
> Can we actually finish #14153 before switching to python 3? Without checking, I would guess that there are tons of things that will go wrong when feeding the python 2.7 doctest module with unicode strings.
We're actually using quite little of the Python doctest module. Besides, with Python's duck-typing, there is not that much difference between strings and unicode strings.

> There is no compromise needed since the byte string version of this ticket should never meet the unicode version of the doctest framework.
What I'm trying to say is that the current string version of the doctesting framework might see byte strings encoded as UTF-8, even when not using the `unicode` type. Remember that Sage uses UTF-8 encoded source files, so any strings defined in doctests will be encoded as UTF-8.


---

Comment by vbraun created at 2013-03-29 18:17:49

Mix & matching byte string and unicode mostly works if you are willing to ignore the UnicodeWarning ;-)

I agree that the doctest code can see arbitrary binary data (including UTF-8) right now as anything might be printed by the code being tested. Its possible (but unlikely) that some of the non-ascii garbage will be translated into `<ESC-?>` by this patch. So what? The end goal should be unicode + 100% coverage of ansi control sequences, and this patch is closer to that goal than leaving out some random control sequences because they aren't used much.


---

Comment by jdemeyer created at 2013-03-29 18:23:21

Put it a different way: imagine we see a `\x9b` in doctest output, which is more likely:
 1. It is part of a UTF-8 sequence.
 2. It is a CSI code in a different encoding.

I would say the first is more likely.


---

Comment by vbraun created at 2013-03-29 18:36:18

Changing status from new to needs_review.


---

Comment by vbraun created at 2013-03-29 18:36:18

Since all doctests pass with this ticket I'm pretty sure we are talking about the empty set. Both are currently equally likely, with probability zero.


---

Comment by roed created at 2013-04-03 08:24:06

Any conclusion on `\x9b`?


---

Comment by jdemeyer created at 2013-04-03 08:26:19

Replying to [comment:14 roed]:
> Any conclusion on `\x9b`?
Yes, unfortunately, two different conclusions depending on who you ask :-)


---

Comment by vbraun created at 2013-04-03 12:04:46

Version with the wrong regex


---

Attachment

Since incomplete coverage of escape codes is still better than doing nothing at all, here is a version of the patch with the wrong regex.


---

Comment by jdemeyer created at 2013-04-03 18:29:20

The "right" regex would obviously be the UTF-8 encoded version of `\x9b`, not the byte `\x9b` itself.


---

Comment by vbraun created at 2013-04-03 18:44:59

The UTF-8 encoded `\x1b` / `x9b` won't match escape sequences unless we encode the output of the doctest in UTF-8. Right now its byte strings. Once we switch to unicode we have to match the `U+001B` / `U+009B` code points. At no point is it a good idea to match for UTF-8 encoded escape sequences imho.


---

Comment by roed created at 2013-04-03 18:58:31

If we ever have a `\x9b` byte coming out of a doctest, I'd like it to fail doctesting so that we can figure out what it actually was.  Perhaps we should look for that byte and raise an error message referencing this ticket?


---

Comment by vbraun created at 2013-04-03 19:18:16

Or you take the first version of the patch and it'll be printed as CSI.


---

Comment by roed created at 2013-04-03 19:23:13

Replying to [comment:20 vbraun]:
> Or you take the first version of the patch and it'll be printed as CSI.

Yeah.  I'm fine with that, but apparently Jeroen isn't.


---

Comment by jdemeyer created at 2013-04-03 20:46:29

Replying to [comment:18 vbraun]:
> Right now its byte strings.
Which simply means that the encoding is "undefined". It's not the opposite of UTF-8. It's maybe UTF-8, maybe something else.

> Once we switch to unicode
"We" already partially switched to UTF-8: Sage source files are UTF-8 and some terminals (more and more these days) use UTF-8 encoding by default.

> At no point is it a good idea to match for UTF-8 encoded escape sequences imho.
Fair enough, but I think matching literal `\x9b` bytes is even worse.


---

Comment by vbraun created at 2013-04-03 21:09:56

Replying to [comment:22 jdemeyer]:
> "We" already partially switched to UTF-8: Sage source files are UTF-8 and some terminals (more and more these days) use UTF-8 encoding by default.

The terminal has no say in doctesting. The "want" is UTF-8 (or at least comes from the UTF-8 encoded sage source), but the "got" is whatever byte string was printed by the worker.


---

Comment by jdemeyer created at 2013-05-01 07:59:31

Please review my reviewer patch.


---

Comment by jdemeyer created at 2013-05-09 07:43:24

** ping **

[attachment:14375_review.patch] needs review.


---

Comment by vbraun created at 2013-05-09 08:34:49

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2013-05-09 08:34:49

I don't agree with it but its still an improvement over the current state, so positive review.


---

Comment by jdemeyer created at 2013-05-10 07:54:34

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-05-10 07:54:34


```
! Package inputenc Error: Keyboard character used is undefined
(inputenc)                in inputencoding `utf8x'.

See the inputenc package documentation for explanation.
Type  H <return>  for immediate help.
 ...                                              
                                                  
l.3239 ...is is ^^[[1mbold^^[[0m text}\PYG{l+s}{'}
                                                  
? 
! Emergency stop.
 ...                                              
                                                  
l.3239 ...is is ^^[[1mbold^^[[0m text}\PYG{l+s}{'}
                                                  
!  ==> Fatal error occurred, no output PDF file produced!
Transcript written on doctest.log.
```



---

Comment by vbraun created at 2013-05-10 11:38:23

Oh we are still building pdf docs, that uses the deprecated utf8x that doesn't even ship with TeXlive-2012 any more. Here is first version of a patch that fixes that. Still needs some work...


---

Comment by vbraun created at 2013-05-10 13:57:51

Updated patch


---

Attachment

Everything works now for me...


---

Comment by vbraun created at 2013-05-10 13:58:18

Changing status from needs_work to needs_review.


---

Attachment


---

Comment by jdemeyer created at 2013-05-12 09:39:57

Volker, I confirm the utf8 problem, but that's for a different ticket (I don't know enough about `TeX` to review that): #14571.

I fixed the problem on this ticket by simply using a `r"""` string instead of `"""`. Needs review.


---

Comment by vbraun created at 2013-05-12 09:42:48

Well I can't test it because TeXlive doesn't ship utf8x any more.


---

Comment by vbraun created at 2013-05-12 09:44:10

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-05-13 13:24:46

Resolution: fixed
