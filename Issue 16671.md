# Issue 16671: Upgrade Maxima to 5.34.0

Issue created by migration from Trac.

Original creator: pbruin

Original creation time: 2014-08-29 23:29:15

CC:  zimmerma jpflori was

Keywords: maxima

Tarball: â€‹http://homepages.warwick.ac.uk/staff/P.Bruin/sage/maxima-5.34.0.tar.bz2


---

Comment by kcrisman created at 2014-08-31 01:19:22

Any tix this fixes, btw?


---

Comment by pbruin created at 2014-09-03 11:55:44

Replying to [comment:1 kcrisman]:
> Any tix this fixes, btw?
I haven't had the time to investigate this in detail.  It doesn't fix any of the tickets listed in #13973 that are still open, but I haven't looked at other open Maxima-related tickets.  The update shouldn't be too difficult, but there are some problems, such as my fix for the matrix exponentation bug (see #13973) not working anymore.


---

Comment by rws created at 2014-09-04 08:39:41

Changelog is here: https://sourceforge.net/p/maxima/code/ci/master/tree/ChangeLog-5.34


---

Comment by jdemeyer created at 2014-09-04 19:55:55

Replying to [comment:1 kcrisman]:
> Any tix this fixes, btw?
#14965 claims to be fixed by Maxima 5.34


---

Comment by fbissey created at 2014-09-04 21:51:19

How many patches can we drop with this version?


---

Comment by pbruin created at 2014-09-05 08:12:52

Changing status from new to needs_review.


---

Comment by pbruin created at 2014-09-05 08:13:24

Replying to [comment:4 jdemeyer]:
> Replying to [comment:1 kcrisman]:
> > Any tix this fixes, btw?
> #14965 claims to be fixed by Maxima 5.34
It does appear to be fixed; I am not getting an error, but haven't checked if the answer is correct.

[Edit: actually I couldn't reproduce the error with Maxima 5.33.0.]


---

Comment by pbruin created at 2014-09-05 08:14:17

Replying to [comment:5 fbissey]:
> How many patches can we drop with this version?
This branch removes two patches and updates another one.

[Edit: the one added patch was not necessary after all, there was a better solution.]


---

Comment by pbruin created at 2014-09-05 08:15:22

I have tested this (and all tests pass) on x86_64 and ARM 32-bit.


---

Comment by git created at 2014-09-06 10:53:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pbruin created at 2014-09-10 08:24:34

Maxima 5.34.1 has been released, an updated branch is coming soon.


---

Comment by pbruin created at 2014-09-10 08:24:34

Changing status from needs_review to needs_work.


---

Comment by pbruin created at 2014-09-10 09:17:41

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2014-09-10 12:13:53

Could you justify this change?

```diff
- sage: latex(integrate(1/(1+sqrt(x)),x,0,1))
- \int_{0}^{1} \frac{1}{\sqrt{x} + 1}\,{d x}
```


I think the purpose of this test is to show an integral that Maxima cannot compute. You could replace this by a different integral...


---

Comment by pbruin created at 2014-09-10 12:20:04

Maxima is now able to compute the integral (it equals 2 - 2 log(2)), so the doctest did not test the `_print_latex_()` method anymore.  Of course we could put in another doctest with an integral that Maxima isn't able to evaluate, but I thought this `_print_latex_()` method was simple enough that it wasn't necessary to keep a second doctest.


---

Comment by jdemeyer created at 2014-09-10 12:27:53

Replying to [comment:15 pbruin]:
> Maxima is now able to compute the integral (it equals 2 - 2 log(2)), so the doctest did not test the `_print_latex_()` method anymore.  Of course we could put in another doctest with an integral that Maxima isn't able to evaluate, but I thought this `_print_latex_()` method was simple enough that it wasn't necessary to keep a second doctest.
Well, the 2 doctests are somewhat different, one calls directly `print_latex` while the removed one uses `latex()`. So yes, please but back a second doctests.

Apart from this trivial thing, this ticket looks good to me.


---

Comment by git created at 2014-09-10 12:59:23

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by pbruin created at 2014-09-10 13:02:08

I amended the existing commit instead of adding a new one, because the commit message mentioned the wrong Maxima version.  I added the following doctests:

```diff
--- a/src/sage/symbolic/integration/integral.py
+++ b/src/sage/symbolic/integration/integral.py
`@``@` -116,6 +116,8 `@``@` class IndefiniteIntegral(BuiltinFunction):
             sage: f = function('f')
             sage: print_latex(f(x),x)
             '\\int f\\left(x\\right)\\,{d x}'
+            sage: latex(integrate(tan(x)/x, x))
+            \int \frac{\tan\left(x\right)}{x}\,{d x}
         """
         from sage.misc.latex import latex
         if not is_SymbolicVariable(x):
`@``@` -236,8 +238,8 `@``@` class DefiniteIntegral(BuiltinFunction):
             sage: f = function('f')
             sage: print_latex(f(x),x,0,1)
             '\\int_{0}^{1} f\\left(x\\right)\\,{d x}'
-            sage: latex(integrate(1/(1+sqrt(x)),x,0,1))
-            \int_{0}^{1} \frac{1}{\sqrt{x} + 1}\,{d x}
+            sage: latex(integrate(tan(x)/x, x, 0, 1))
+            \int_{0}^{1} \frac{\tan\left(x\right)}{x}\,{d x}
         """
         from sage.misc.latex import latex
         if not is_SymbolicVariable(x):
```



---

Comment by jdemeyer created at 2014-09-10 14:40:36

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-09-10 21:58:28

Conflicts with #16651 or #16858


---

Comment by vbraun created at 2014-09-10 21:58:28

Changing status from positive_review to needs_work.


---

Comment by git created at 2014-09-11 11:38:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pbruin created at 2014-09-11 11:38:45

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2014-09-11 14:34:55

I get various doctest failures on top of 6.4.beta3:

```
sage -t --long --warn-long 40.1 src/sage/calculus/desolvers.py  # 2 doctests failed
sage -t --long --warn-long 40.1 src/sage/rings/number_field/number_field_element.pyx  # 1 doctest failed
sage -t --long --warn-long 40.1 src/sage/tests/french_book/integration_doctest.py  # 1 doctest failed
sage -t --long --warn-long 40.1 src/sage/modules/free_module_element.pyx  # 1 doctest failed
sage -t --long --warn-long 40.1 src/sage/symbolic/relation.py  # 1 doctest failed
sage -t --long --warn-long 40.1 src/sage/functions/other.py  # 1 doctest failed
sage -t --long --warn-long 40.1 src/sage/functions/special.py  # 2 doctests failed
```

Looks like it is all due to changed precision of floats


---

Comment by vbraun created at 2014-09-11 14:35:01

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2014-09-12 07:51:51

I'll have a look at the doctest failures.


---

Comment by pbruin created at 2014-09-12 07:56:38

Replying to [comment:25 jdemeyer]:
> I'll have a look at the doctest failures.
There is no need to, I just fixed them and only have to test them on 32-bit.


---

Comment by git created at 2014-09-12 07:57:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2014-09-12 07:59:29

Another trivial change to a French book test.


---

Comment by jdemeyer created at 2014-09-12 08:01:38

Do you understand why floats from Maxima are now printed with one digit less of precision???


---

Comment by pbruin created at 2014-09-12 08:12:39

Replying to [comment:29 jdemeyer]:
> Do you understand why floats from Maxima are now printed with one digit less of precision???
This is because of recent changes (between 5.33.0 and 5.34.0) to Maxima's `exploden-format-float` function.  In fact, on certain Lisp implementations and platforms (including ECL on x86_64), Maxima used to often print one digit too many; see #15921 for details.


---

Comment by pbruin created at 2014-09-12 09:38:50

All relevant doctests (the failed ones above, and everything in `sage/interfaces/maxima_*`, `sage/calculus`, `sage/functions`, `sage/symbolic`) pass on x86_64 and ARM.  Since I ran all long doctests before, I now leave it to the buildbot to catch any unlikely remaining failures...


---

Comment by pbruin created at 2014-09-12 09:38:50

Changing status from needs_work to positive_review.


---

Comment by zimmerma created at 2014-09-12 09:40:47

I'm not happy with the changes in the French book tests. In some places you use `...`
which should make tests pass both with the previous versions of Sage (this should be checked), in some places more digits are printed, which will fail with previous versions,
and might fail with future versions, for example:

```
     sage: t, y = var('t, y')
     sage: desolve_rk4(t*y*(2-y), y, ics=[0,1], end_points=[0, 1], step=0.5)
-    [[0, 1], [0.5, 1.12419127425], [1.0, 1.46159016229]]
+    [[0, 1], [0.5, 1.12419127424558], [1.0, 1.4615901622888245]]
```

Paul


---

Comment by pbruin created at 2014-09-12 10:00:27

Replying to [comment:32 zimmerma]:
> I'm not happy with the changes in the French book tests.
I assume you are mostly referring to the changes made by #16858; this ticket only removes one digit.

> In some places you use `...`
> which should make tests pass both with the previous versions of Sage (this should be checked), in some places more digits are printed, which will fail with previous versions,
> and might fail with future versions, for example:
> {{{
>      sage: t, y = var('t, y')
>      sage: desolve_rk4(t*y*(2-y), y, ics=[0,1], end_points=[0, 1], step=0.5)
> -    [[0, 1], [0.5, 1.12419127425], [1.0, 1.46159016229]]
> +    [[0, 1], [0.5, 1.12419127424558], [1.0, 1.4615901622888245]]
> }}}
Do I understand correctly that you propose to always use `...` and only keep the minimum among the various numbers of digits that are output by all existing versions of Sage?

Could you explain more precisely why you object to showing the output of the doctests with the (increased) precision used by the current Sage version?  Does it cause more work for you to keep them updated, or do you expect it may cause confusion among users with different versions of Sage?


---

Comment by zimmerma created at 2014-09-12 10:55:03

> I assume you are mostly referring to the changes made by #16858; this ticket only removes one digit.

I refer to changeset `e216b6f` in comment [comment:27].

Yes it would be better to only keep the minimum number of digits output by all versions of Sage (since the one we use in our book, i.e., 5.9).

The intent of those doctests is to only to check the examples that were **printed** in the book still work in versions of Sage after 5.9. Thus it makes no sense to add more digits than those that were actually printed on http://sagebook.gforge.inria.fr/. Any doctests with a different intent should go elsewhere in my opinion.

Paul


---

Comment by pbruin created at 2014-09-12 11:12:37

Replying to [comment:34 zimmerma]:
> > I assume you are mostly referring to the changes made by #16858; this ticket only removes one digit.
> 
> I refer to changeset `e216b6f` in comment [comment:27].
The only change made by that changeset in the `french_book` directory is

```diff
--- a/src/sage/tests/french_book/integration_doctest.py
+++ b/src/sage/tests/french_book/integration_doctest.py
`@``@` -180,7 +180,7 `@``@` Sage example in ./integration.tex, line 838::
 
     sage: t, y = var('t, y')
     sage: desolve_rk4(t*y*(2-y), y, ics=[0,1], end_points=[0, 1], step=0.5)
-    [[0, 1], [0.5, 1.12419127424558], [1.0, 1.4615901622888245]]
+    [[0, 1], [0.5, 1.12419127424558], [1.0, 1.461590162288825]]
 
     Sage example in ./integration.tex, line 861::
 
```

The (earlier) commit that added the extra digits was 7cb1dd50 in #16858.
> Yes it would be better to only keep the minimum number of digits output by all versions of Sage (since the one we use in our book, i.e., 5.9).
> 
> The intent of those doctests is to only to check the examples that were **printed** in the book still work in versions of Sage after 5.9.
OK, but surely a doctest where the only change is an increased precision should be classified as "still working"?  In any case, a user who types the doctest in a newer version of Sage will also see the extra digits.
> Thus it makes no sense to add more digits than those that were actually printed on http://sagebook.gforge.inria.fr/. Any doctests with a different intent should go elsewhere in my opinion.
I don't disagree, but given that the doctests need to be updated in any case, I don't understand why adding the extra digits is bad and adding `...` is better.  Feel free to open a ticket for it, though!


---

Comment by zimmerma created at 2014-09-12 11:25:51

I won't spend more time on this, please remove the tests corresponding to examples in our book that you break, it makes no sense to maintain them since the original goal is lost.

Paul


---

Comment by jdemeyer created at 2014-09-12 11:39:12

Replying to [comment:36 zimmerma]:
> I won't spend more time on this, please remove the tests corresponding to examples in our book that you break, it makes no sense to maintain them since the original goal is lost.

I agree with Peter Bruin that printing a few less or more digits doesn't really "break" the test. Even if the goal of reproducing the _exact output_ of the book cannot be achieved, at least the goal of having output _reasonably close_ to the book can be maintained.


---

Comment by vbraun created at 2014-09-16 18:47:42

Resolution: fixed
