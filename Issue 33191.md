# Issue 33191: prompt_toolkit 3.0.25+ breaks Ctrl-C

Issue created by migration from https://trac.sagemath.org/ticket/33428

Original creator: tornaria

Original creation time: 2022-02-28 13:27:54

CC:  arojas mjo jhpalmieri

Keywords: prompt_toolkit

For the record, Ctrl-C is broken starting with version 3.0.25 of prompt_toolkit (current version 3.0.28 still broken, sage-the-distribution bundles 3.0.22 so it's ok).

```
$ xbps-query -s python3-prompt_toolkit
[*] python3-prompt_toolkit-3.0.28_1 Python3 library for building powerful interactive command lines
$ sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.5, Release Date: 2022-01-30                     │
│ Using Python 3.10.2. Type "help()" for help.                       │
└────────────────────────────────────────────────────────────────────┘
sage: factor(54853908712446157179434453567343931596301333824416758692208077566613224454501131209)
^C^C^C^C
```

If one waits the half hour or so that it takes to factor the number above, then the ^C gets through, but waiting kind of defeats the purpose of hitting ^C. This is not specific to factoring -- anything that depends on cysignals for Ctrl-C working is broken.

Upstream issue: https://github.com/prompt-toolkit/python-prompt-toolkit/issues/1576

In the GH issue there are two different fixes suggested (with patches), IMHO the second one is better for sage (the downside is that introduces a dependency on cysignals, but sage already depends on cysignals).

No action is needed now, but one of the patches will be necessary if/when prompt_toolkit is updated, or for distro packages on systems with a recent version of prompt_toolkit (void linux issue and discussion in https://github.com/void-linux/void-packages/pull/35730)


---

Comment by mkoeppe created at 2022-02-28 18:24:14

Let's put in an upper version bound in `build/pkgs/prompt_toolkit/install-requires.txt` to document this


---

Comment by mkoeppe created at 2022-03-03 06:42:39

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2022-03-03 06:42:39

New commits:


---

Comment by mkoeppe created at 2022-03-03 06:42:39

Changing priority from major to minor.


---

Comment by mkoeppe created at 2022-04-30 23:20:11

Upstream has merged https://github.com/prompt-toolkit/python-prompt-toolkit/pull/1582 - do we know if it fixes the issue?


---

Comment by tornaria created at 2022-05-01 01:16:17

Replying to [comment:5 mkoeppe]:
> Upstream has merged https://github.com/prompt-toolkit/python-prompt-toolkit/pull/1582 - do we know if it fixes the issue?

I don't think so, we are patching 3.0.29 in void linux, see here:
https://github.com/void-linux/void-packages/blob/master/srcpkgs/python3-prompt_toolkit/patches/dont-handle-sigint.patch


---

Comment by jhpalmieri created at 2022-07-16 20:30:58

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2022-07-16 20:30:58

Confirmed: I just downloaded and installed 3.0.30 (OS X) and it does not seem to have fixed the interrupt problems.


---

Comment by jhpalmieri created at 2022-07-16 20:33:11

Is this going to cause problems with the IPython upgrade (#33530)? That branch uses version 3.0.29.


---

Comment by mkoeppe created at 2022-07-16 20:48:10

Thanks for catching this.


---

Comment by mkoeppe created at 2022-07-16 20:48:10

Changing priority from minor to critical.


---

Comment by vbraun created at 2022-07-18 19:49:01

Merge failure on top of:

1c98f0ae41 Trac #31563: Upgrade giac to 1.9.0-15

83a3df1c99 Trac #34131: some doc polishing in symbolic

dee5229b00 Trac #34130: some doc polishing in groups

fd80fa111f Trac #34126: some doc polishing in categories

718d356f1c Trac #34125: some doc polishing in modular

49390d8bcf Trac #34124: some doc polishing in combinat

af94c25b54 Trac #34096: Fix typo: enviroment -> environment

d04c189c8e Trac #34050: add some space around == in paths and rational

1634bb6946 Trac #34047: Typo in _repr_Expression in symbolic/expression.pyx

dc8086fd57 Trac #34154: Fix repeated word typos

17b1c177aa Trac #34148: fix and activate pycodestyle E306

785bdbd0ec Trac #34136: modernize super() in rings (part one)

9882001355 Trac #34129: Dummy packages should write proper log files

dbc6b9e161 Trac #34109: pep8 for sagedoc.py

5e6a3318c8 Trac #34103: randomize infinite recursion

17ba76f00b Trac #34093: Wrong evaluation of elements of CBF[x] on polynomials from other rings

4657052737 Trac #34122: Bug in is_planar() method for directed graphs

c9cfb5395f Trac #34087: inverse reciprocal trig functions not (back)translated to/from Mathematica

1d6d055563 Trac #34076: pycodestyle cleanup in src/sage/graphs/genus.pyx

043d862b5d Trac #34071: pycodestyle cleanup in asteroidal_triples.pyx, chrompoly.pyx, cliquer.pyx, convexity_properties.pyx

b9b25dc735 Trac #34070: pycodestyle cleanup in src/sage/graphs/centrality.pyx

4ef2c6597d Trac #34069: pycodestyle cleanup in src/sage/graphs/comparability.pyx

5b1146766b Trac #34066: Tachyon help message

798adaa5a3 Trac #34065: pycodestyle cleanup in src/sage/graphs/bliss.pyx

ce62be23a2 Trac #34063: pycodestyle cleanup in src/sage/graphs/base/

a0eadb3e40 Trac #34059: Fix trivial case in conversion of list to number field element

fea0ac50a6 Trac #34057: changes about avoiding double dieses

9eefd5c27e Trac #34145: modernize super in geometry/

01e117dfd8 Trac #34137: modernize super in categories/

6c79334402 Trac #33819: build.yml: In workflow_dispatch, make container and base tag selectable; add doc

6a64ab8d00 Trac #33760: do not update _pos, _pos3d, _embedding on vertex/edge deletions

dbf091dbbb Trac #34139: fix the linter

625ac58151 Updated [SageMath](SageMath) version to 9.7.beta5



ticket milestone is not intended to be merged:


---

Comment by vbraun created at 2022-07-18 19:49:01

Changing status from positive_review to needs_work.


---

Comment by mkoeppe created at 2022-07-18 19:50:34

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2022-07-28 19:10:27

Resolution: fixed
