# Issue 12628: Upgrade zlib to 1.2.6

Issue created by migration from https://trac.sagemath.org/ticket/12800

Original creator: jdemeyer

Original creation time: 2012-04-03 16:13:07

Assignee: tbd

CC:  mjo


```
Changes in 1.2.6 (29 Jan 2012)
- Update the Pascal interface in contrib/pascal
- Fix function numbers for gzgetc_ in zlibvc.def files
- Fix configure.ac for contrib/minizip [Schiffer]
- Fix large-entry detection in minizip on 64-bit systems [Schiffer]
- Have ./configure use the compiler return code for error indication
- Fix CMakeLists.txt for cross compilation [McClure]
- Fix contrib/minizip/zip.c for 64-bit architectures [Dalsnes]
- Fix compilation of contrib/minizip on FreeBSD [Marquez]
- Correct suggested usages in win32/Makefile.msc [Shachar, Horvath]
- Include io.h for Turbo C / Borland C on all platforms [Truta]
- Make version explicit in contrib/minizip/configure.ac [Bosmans]
- Avoid warning for no encryption in contrib/minizip/zip.c [Vollant]
- Minor cleanup up contrib/minizip/unzip.c [Vollant]
- Fix bug when compiling minizip with C++ [Vollant]
- Protect for long name and extra fields in contrib/minizip [Vollant]
- Avoid some warnings in contrib/minizip [Vollant]
- Add -I../.. -L../.. to CFLAGS for minizip and miniunzip
- Add missing libs to minizip linker command
- Add support for VPATH builds in contrib/minizip
- Add an --enable-demos option to contrib/minizip/configure
- Add the generation of configure.log by ./configure
- Exit when required parameters not provided to win32/Makefile.gcc
- Have gzputc return the character written instead of the argument
- Use the -m option on ldconfig for BSD systems [Tobias]
- Correct in zlib.map when deflateResetKeep was added
```


In particular, it builds on the Skynet machine mark (SunOS 5.10-32) with GCC-4.7.0, unlike zlib-1.2.5.


---

Comment by jdemeyer created at 2012-04-03 16:24:02

Changing status from new to needs_review.


---

Comment by mjo created at 2012-04-11 04:05:24

We might as well just get of the commented-out lines. We're using version control, after all. If they're done in a separate commit, just those lines can be `hg backout`ed.


---

Comment by mjo created at 2012-04-11 04:09:44

Alternately, fix the patch routine =)


---

Comment by jdemeyer created at 2012-04-11 06:23:16

Well, #12432 adds a patch again, so it doesn't really matter.


---

Comment by Snark created at 2012-04-11 07:58:40

The spkg compiled fine with sage-4.8 on ARM.


---

Attachment

Reviewer patch.  Apply to Jeroen's spkg.


---

Comment by leif created at 2012-04-11 12:11:04

`spkg-install` needs some work; see my attached reviewer patch.

Doesn't make sense to comment out the `patch` loop; I wouldn't have deleted the `patches/` directory either (but my patch doesn't restore it).


---

Comment by leif created at 2012-04-11 12:11:04

Changing status from needs_review to needs_work.


---

Comment by leif created at 2012-04-11 12:14:37

Replying to [ticket:12800 jdemeyer]:
> {{{
> Changes in 1.2.6 (29 Jan 2012)
> [...]
> }}}
> 
> In particular, it builds on the Skynet machine mark (SunOS 5.10-32) with GCC-4.7.0, unlike zlib-1.2.5.

Well, none of the other changes seem to be relevant for Sage.  (But regarding the size of the spkg, it IMHO isn't worth deleting some parts from the upstream tree.)


---

Attachment

Diff for the zlib spkg. For review only


---

Comment by jdemeyer created at 2012-04-11 12:56:21

Leif, I added almost all of your changes, the spkg is at the same location.  I patched the `patch` loop in a different way, now it is:

```
# Apply all patches
for patch in ../patches/*.patch; do
    [ -f "$patch" ] || continue
    basename "$patch"
    if ! patch -p1 <"$patch"; then
        echo >&2 "Error: patch '$patch' failed to apply."
        exit 1
    fi
done
```



---

Comment by jdemeyer created at 2012-04-11 12:56:21

Changing status from needs_work to needs_review.


---

Comment by Snark created at 2012-04-11 13:06:25

Does that loop works even if the ../patches/ directory is empty? Or does it give a file not found error? Not that it matters as long as there is a patch, but that's the first thing that came to my mind reading this...


---

Comment by jdemeyer created at 2012-04-11 13:11:53

Replying to [comment:9 Snark]:
> Does that loop works even if the ../patches/ directory is empty? Or does it give a file not found error?

If `../patches` is either empty or non-existent, then `../patches/*` will expand literally to "`../patches/*`".  Since "`../patches/*`" isn't a file, the line

```
[ -f "$patch" ] || continue
```

will ensure that there are no error messages.


---

Comment by leif created at 2012-04-11 16:17:17

Replying to [comment:10 jdemeyer]:
> Replying to [comment:9 Snark]:
> > Does that loop works even if the ../patches/ directory is empty? Or does it give a file not found error?
> 
> If `../patches` is either empty or non-existent, then `../patches/*` will expand literally to "`../patches/*`".  Since "`../patches/*`" isn't a file, the line
> {{{
> [ -f "$patch" ] || continue
> }}}
> will ensure that there are no error messages.

Yes, but it then would make more sense to `break` rather than `continue`.

But to perform some loop-invariant code motion, it would be better to just use


```sh
ls ../patches/*.patch &>/dev/null &&
echo "Applying patches to upstream source..." &&
for patch in ../patches/*.patch; do
    ...
```



---

Comment by leif created at 2012-04-11 16:23:44

P.S.:

```sh
$ ls patches/
*.patch
```


Then your `continue` would be correct... ;-)


---

Comment by leif created at 2012-04-11 16:27:10

Replying to [comment:12 leif]:
> P.S.:
> {{{
> #!sh
> $ ls patches/
> *.patch
> }}}
> 
> Then your `continue` would be correct... ;-)

Although in that case also `[ -f "$patch" ]` yields true, so `continue` isn't reached.


---

Comment by jdemeyer created at 2012-04-11 17:32:54

Replying to [comment:11 leif]:
> Yes, but it then would make more sense to `break` rather than `continue`.
I don't think there is anything wrong with my code.  It's simple and actually catches more special cases than your proposals (such as `patches/foo.patch` being a directory).


---

Comment by leif created at 2012-04-11 17:50:30

Replying to [comment:14 jdemeyer]:
> Replying to [comment:11 leif]:
> > Yes, but it then would make more sense to `break` rather than `continue`.
> I don't think there is anything wrong with my code.  It's simple and actually catches more special cases than your proposals (such as `patches/foo.patch` being a directory).

Well, I think the only "special cases" we want to (or have to) handle here are:

 * `../patches/` doesn't exist.

 * The directory exists, but it is empty, or at least doesn't contain files matching `*.patch`.


(I won't insist on changing the `continue`, but it seems more natural [and actually is more efficient] to place a single test outside the loop.  Also, conditionally printing "Applying patches..." seems reasonable to me.)

----

If you wanted to go triple-safe, you'd have to use `[ -r "$patch" ]` instead of `[ -f ... ]`.


---

Comment by Snark created at 2012-04-11 18:04:20

Debian maintainers manage their patches to upstream using
[quilt](http://en.wikipedia.org/wiki/Quilt_%28software%29).

Debian has about fourty thousand packages, with eleven official ports and a few unofficial ones, so I guess they know what they're doing.


---

Comment by mjo created at 2012-04-11 18:07:40

We could just apply the patches in a mercurial queue, since we ship a repo with every spkg. Anyway, this is pointless: I've built a fresh beta13 with this spkg, and it passes a ptestlong. I manually checked the error conditions. When you figure out what to do with the patch routine (delete it!), it's ready.


---

Comment by leif created at 2012-04-11 18:28:24

Replying to [comment:17 mjo]:
> I've built a fresh beta13 with this spkg, and it passes a ptestlong. I manually checked the error conditions. When you figure out what to do with the patch routine (delete it!), it's ready.

Yep.  I'm ok with the spkg as is, so setting it to positive review.

If anybody should disagree, feel free to revert that.


---

Comment by leif created at 2012-04-11 18:28:24

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-04-19 06:40:48

Resolution: fixed


---

Comment by jhpalmieri created at 2012-06-14 14:40:22

I'm having problems with this on the OpenSolaris machine hawk: when trying to build sage-5.1.beta3, I see

```
gcc -O3  -D_LARGEFILE64_SOURCE=1 -o example64 example64.o -L. libz.a
gcc -O3  -D_LARGEFILE64_SOURCE=1 -o minigzip64 minigzip64.o -L. libz.a
ld: fatal: relocation error: R_386_GOTOFF: file deflate.lo: symbol _length_code: a GOT relative relocation must reference a local symbol
ld: fatal: relocation error: R_386_GOTOFF: file deflate.lo: symbol _dist_code: a GOT relative relocation must reference a local symbol
ld: fatal: relocation error: R_386_GOTOFF: file deflate.lo: symbol _dist_code: a GOT relative relocation must reference a local symbol
ld: fatal: relocation error: R_386_GOTOFF: file deflate.lo: symbol _length_code: a GOT relative relocation must reference a local symbol
ld: fatal: relocation error: R_386_GOTOFF: file deflate.lo: symbol _dist_code: a GOT relative relocation must reference a local symbol
ld: fatal: relocation error: R_386_GOTOFF: file deflate.lo: symbol _dist_code: a GOT relative relocation must reference a local symbol
ld: fatal: relocation error: R_386_GOTOFF: file deflate.lo: symbol _length_code: a GOT relative relocation must reference a local symbol
ld: fatal: relocation error: R_386_GOTOFF: file deflate.lo: symbol _dist_code: a GOT relative relocation must reference a local symbol
ld: fatal: relocation error: R_386_GOTOFF: file deflate.lo: symbol zcalloc: a GOT relative relocation must reference a local symbol
ld: fatal: relocation error: R_386_GOTOFF: file deflate.lo: symbol zcfree: a GOT relative relocation must reference a local symbol
collect2: ld returned 1 exit status
make[2]: *** [libz.so.1.2.6] Error 1
make[2]: *** Waiting for unfinished jobs....
make[2]: Leaving directory `/export/home/palmieri/testing/clean/sage-5.1.beta3/spkg/build/zlib-1.2.6/src'
Error building zlib.
```

Any suggestions?


---

Comment by jdemeyer created at 2012-06-15 06:43:37

I don't have the same problem on `hawk`.  Are you using `/usr/local/bin/gcc`, i.e. gcc 4.4.3 on hawk?

Compiling with `CC=suncc` should also work.


---

Comment by jhpalmieri created at 2012-06-15 17:30:51

I had some old environment variables set. Unsetting them seems to help.
