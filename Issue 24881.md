# Issue 24881: gfan fails when compiled with XCode 9.3

Issue created by migration from https://trac.sagemath.org/ticket/25118

Original creator: vbraun

Original creation time: 2018-04-08 15:54:07

CC:  dimpase

On certain architectures only, gfan compiled with XCode 9.3 fails

```
sage -t --long src/doc/de/tutorial/tour_advanced.rst  # 2 doctests failed
sage -t --long src/doc/en/tutorial/tour_advanced.rst  # 2 doctests failed
sage -t --long src/doc/fr/tutorial/tour_advanced.rst  # 2 doctests failed
sage -t --long src/doc/ja/tutorial/tour_advanced.rst  # 2 doctests failed
sage -t --long src/doc/pt/tutorial/tour_advanced.rst  # 2 doctests failed
sage -t --long src/doc/ru/tutorial/tour_advanced.rst  # 2 doctests failed
sage -t --long src/sage/rings/polynomial/groebner_fan.py  # 70 doctests failed
sage -t --long src/sage/rings/polynomial/multi_polynomial_ideal.py  # 1 doctest failed
}}}  
There are also reported Cython testsuite failures, so it might be a compiler issue.


---

Comment by dimpase created at 2018-04-09 06:42:31

See testing results for the "stand-alone" gfan-6.2 on https://github.com/rwst/gfan06/issues/2

Basically, one test fails on OSX Xeon with Xcode 9.3  (same as on Ubuntu with gcc 5.4),
while a slew of tests fail on OSX i5/7 with Xcode 9.3.


---

Comment by dimpase created at 2018-04-09 06:46:42

gfan-6.2 source assumes that cdd headers are in cdd/, so one can e.g. 

```
cd $SAGE_LOCAL/include
mkdir cdd
cp cdd*.h cdd/
cp setoper.h cdd/
```

before hitting make. Also, the makefile needs to be modified not to use `-fno-guess-branch-probability` on clang.


---

Comment by fbissey created at 2018-04-09 07:36:48

Replying to [comment:3 dimpase]:
> gfan-6.2 source assumes that cdd headers are in cdd/, so one can e.g. 
> {{{
> cd $SAGE_LOCAL/include
> mkdir cdd
> cp cdd*.h cdd/
> cp setoper.h cdd/
> }}}
> before hitting make. Also, the makefile needs to be modified not to use `-fno-guess-branch-probability` on clang.

For cdd's header you can pass `-DNOCDDPREFIX` that's one of the things I have learnt from looking at the new spkg at #23353. We probably should depend on it.


---

Comment by dimpase created at 2018-04-09 09:12:51

Can one try building/testing gfan with -O0 on affected Xcode/CPUs, see if this provides a fix?

(i.e. with CXXFLAGS (and CFLAGS?) having -O0 instead of the default?)


---

Comment by dimpase created at 2018-04-10 09:03:18

Travis CI can now do Xcode 9.3 for you,so it's matter of writing a suitable yaml file to test gfan there...


---

Comment by dimpase created at 2018-04-11 15:26:28

The crashes in gfan's 0.6.2 testsuite come from line 208 of app_main.cpp

```
    delete ep;//<--- In next release, make the class virtual
```

It's a pointer to an object of type EnumerationFilePrinter handling output.

it's perhaps safe to just delete it, as it is at the end of `main()` member function
of GCats class. (I'll figure it out exactly, anyway, it's a small thing to fix).

If I delete this line then 44 out of 45 tests pass (same as on Ubunty).

This was tried on OSX 10.13.4 on very old Core2 Duo CPU, with clang from XCode 9.3, 
which is `Apple LLVM version 9.1.0 (clang-902.0.39.1)`.

Please, please, try this on i5/i7.


---

Comment by jhpalmieri created at 2018-04-11 21:36:59

I wonâ€™t be able to try until the weekend.


---

Comment by fbissey created at 2018-04-11 22:25:58

Nice work Dima. So I took my broken 8.2.rc1. Digged the source for gfan-0.5, found the line in those sources, created a patch and put it in the build tree. Check ed that the `multi_polynomial_ideal.py` test is broken - yup. Rebuild gfan with my patch, gfan do not produces libraries, so there is no need to rebuild sage. We really want to upgrade and hope stuff like these is fixed by the way

```
[gfan-0.5.p2] ./intsinpolytope.h:1:9: warning: 'INTSINPOLYTOPE_H_INCLUDED' is used as a header guard here, followed by #define of a different macro [-Wheader-guard]
[gfan-0.5.p2] #ifndef INTSINPOLYTOPE_H_INCLUDED
[gfan-0.5.p2]         ^~~~~~~~~~~~~~~~~~~~~~~~~
[gfan-0.5.p2] ./intsinpolytope.h:2:9: note: 'INTSINPOLYTOPE_H_INLCUDED' is defined here; did you mean 'INTSINPOLYTOPE_H_INCLUDED'?
[gfan-0.5.p2] #define INTSINPOLYTOPE_H_INLCUDED
[gfan-0.5.p2]         ^~~~~~~~~~~~~~~~~~~~~~~~~
[gfan-0.5.p2]         INTSINPOLYTOPE_H_INCLUDED
[gfan-0.5.p2] 1 warning generated.
```

Tried the `multi_polynomial_ideal.py` test again. Success! I checked the other tests (well only one of the .rst, after all they are all copies of the same tests) and they work too.

I am doing full doctesting now in case something broke in the process.

And the patch

```diff
diff --git a/app_main.cpp b/app_main.cpp
index f6fcb66..e24b0b2 100644
--- a/app_main.cpp
+++ b/app_main.cpp
@@ -180,7 +180,6 @@ public:
     }
 
     ep->close();
-    delete ep;
 
     printf("\n");
 
```



---

Comment by fbissey created at 2018-04-12 02:41:50

All doctests passed. We can go ahead with this.


---

Comment by dimpase created at 2018-04-12 07:10:26

Yep, I also tried the same as in comment 9 patch on 8.2.rc1 with latest Xcode on my museum Core2 Duo, and only some timeouts from tests, no real problems.


---

Comment by dimpase created at 2018-04-12 09:21:19

Changing status from new to needs_review.


---

Comment by dimpase created at 2018-04-12 09:21:19

Changing priority from major to blocker.


---

Comment by dimpase created at 2018-04-12 09:21:19

Done. Hopefully this can still make it into 8.2.
----
New commits:


---

Comment by fbissey created at 2018-04-12 09:23:02

I am going to be a pain in your ass. Please make it a revision bump of gfan.


---

Comment by git created at 2018-04-12 09:26:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2018-04-12 09:27:56

Done, sorry for forgetting this.


---

Comment by dimpase created at 2018-04-12 09:29:04

I wonder if something needs to be done with configure, as this changes configure.ac.


---

Comment by fbissey created at 2018-04-12 09:32:15

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2018-04-12 09:32:15

Depends on the flow of the release manager, but Volker didn't do a bump for #25113 so hopefully he has a procedure for that now.


---

Comment by vbraun created at 2018-04-12 12:22:20

Changing priority from blocker to critical.


---

Comment by vbraun created at 2018-05-08 17:27:48

Resolution: fixed
