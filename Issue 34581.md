# Issue 34581: Error when defining differentials over GCA's with relations.

archive/issues_034581.json:
```json
{
    "body": "CC:  tscrim jhpalmieri\n\nThe following code\n\n\n```\nsage: A.<a,b,x,u> = GradedCommutativeAlgebra(QQ,degrees=(2,2,3,3))\nsage: A = A.quotient(A.ideal([a*u,b*u,x*u]))\nsage: A.cdg_algebra({a:u,x:a*b})\n```\n\n\nProduces an error\n\n\n```\n...\n\nFile ~/sage/src/sage/algebras/commutative_dga.py:253, in Differential.__init__(self, A, im_gens)\n    251 for i in A.gens():\n    252     if not self(self(i)).is_zero():\n--> 253         raise ValueError(\"The given dictionary does not determine a valid differential\")\n\nValueError: The given dictionary does not determine a valid differential\n\n```\n\n\nwhich is wrong, because the differential is valid in the quotient algebra.\n\nIt seems that the computations for the differential are done in the free algebra instead of the quotient one.\n\nIssue created by migration from https://trac.sagemath.org/ticket/34818\n\n",
    "created_at": "2022-12-02T14:46:44Z",
    "labels": [
        "algebra",
        "major",
        "bug"
    ],
    "title": "Error when defining differentials over GCA's with relations.",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34581",
    "user": "mmarco"
}
```
CC:  tscrim jhpalmieri

The following code


```
sage: A.<a,b,x,u> = GradedCommutativeAlgebra(QQ,degrees=(2,2,3,3))
sage: A = A.quotient(A.ideal([a*u,b*u,x*u]))
sage: A.cdg_algebra({a:u,x:a*b})
```


Produces an error


```
...

File ~/sage/src/sage/algebras/commutative_dga.py:253, in Differential.__init__(self, A, im_gens)
    251 for i in A.gens():
    252     if not self(self(i)).is_zero():
--> 253         raise ValueError("The given dictionary does not determine a valid differential")

ValueError: The given dictionary does not determine a valid differential

```


which is wrong, because the differential is valid in the quotient algebra.

It seems that the computations for the differential are done in the free algebra instead of the quotient one.

Issue created by migration from https://trac.sagemath.org/ticket/34818





---

archive/issue_comments_489093.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-12-03T13:55:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34581",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34581#issuecomment-489093",
    "user": "mmarco"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_489094.json:
```json
{
    "body": "New commits:",
    "created_at": "2022-12-03T13:55:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34581",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34581#issuecomment-489094",
    "user": "mmarco"
}
```

New commits:



---

archive/issue_comments_489095.json:
```json
{
    "body": "A few minor things:\n\n```diff\n-Check that #34818 is solved::\n+Check that :trac:`34818` is solved::\n```\n\n\n```diff\n         if isinstance(im_gens, (list, tuple)):\n-           im_gens = {A.gen(i): x for i, x in enumerate(im_gens)}\n-\n-        im_gens = {A(a): A(im_gens[a]) for a in im_gens}\n+           im_gens = {A.gen(i): A(x) for i, x in enumerate(im_gens)}\n+        else:\n+            im_gens = {A(a): A(im_gens[a]) for a in im_gens}\n```\n\n\n```diff\n         def image_monomial(exponent):\n             i = 0\n             cexp = list(exponent)\n             while i < len(cexp):\n-                if cexp[i] == 0:\n+                if not cexp[i]:\n                     i +=1\n                     continue\n                 a = A.gen(i)\n                 try:\n                     da = im_gens[a]\n                 except KeyError:\n                     da = A.zero()\n                 cexp[i] -= 1\n-                b = prod([A.gen(j)**cexp[j] for j in range(len(cexp))])\n+                b = prod(A.gen(j) ** cexp[j] for j in range(len(cexp)))\n                 db = image_monomial(cexp)\n-                im =  da * b + (-1)**A._degrees[i]*a*db\n-                return(A(im))\n+                im =  da * b + (-1)**A._degrees[i] * a * db\n+                return A(im)\n             return A.zero()\n \n         for g in I.gens():\n             d = g.dict()\n-            res = A(sum([d[ex]*image_monomial(ex) for ex in d]))\n+            res = A.sum(d[ex] * image_monomial(ex) for ex in d)\n             if not res.is_zero():\n-                raise ValueError(\"The differential does not preserve the ideal\")\n+                raise ValueError(\"the differential does not preserve the ideal\")\n```\n\nNote that this last change might change a few error messages, but this is to follow a Python convention.",
    "created_at": "2022-12-06T06:01:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34581",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34581#issuecomment-489095",
    "user": "tscrim"
}
```

A few minor things:

```diff
-Check that #34818 is solved::
+Check that :trac:`34818` is solved::
```


```diff
         if isinstance(im_gens, (list, tuple)):
-           im_gens = {A.gen(i): x for i, x in enumerate(im_gens)}
-
-        im_gens = {A(a): A(im_gens[a]) for a in im_gens}
+           im_gens = {A.gen(i): A(x) for i, x in enumerate(im_gens)}
+        else:
+            im_gens = {A(a): A(im_gens[a]) for a in im_gens}
```


```diff
         def image_monomial(exponent):
             i = 0
             cexp = list(exponent)
             while i < len(cexp):
-                if cexp[i] == 0:
+                if not cexp[i]:
                     i +=1
                     continue
                 a = A.gen(i)
                 try:
                     da = im_gens[a]
                 except KeyError:
                     da = A.zero()
                 cexp[i] -= 1
-                b = prod([A.gen(j)**cexp[j] for j in range(len(cexp))])
+                b = prod(A.gen(j) ** cexp[j] for j in range(len(cexp)))
                 db = image_monomial(cexp)
-                im =  da * b + (-1)**A._degrees[i]*a*db
-                return(A(im))
+                im =  da * b + (-1)**A._degrees[i] * a * db
+                return A(im)
             return A.zero()
 
         for g in I.gens():
             d = g.dict()
-            res = A(sum([d[ex]*image_monomial(ex) for ex in d]))
+            res = A.sum(d[ex] * image_monomial(ex) for ex in d)
             if not res.is_zero():
-                raise ValueError("The differential does not preserve the ideal")
+                raise ValueError("the differential does not preserve the ideal")
```

Note that this last change might change a few error messages, but this is to follow a Python convention.



---

archive/issue_comments_489096.json:
```json
{
    "body": "Your changes look good. Can you push them?",
    "created_at": "2022-12-06T10:48:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34581",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34581#issuecomment-489096",
    "user": "mmarco"
}
```

Your changes look good. Can you push them?



---

archive/issue_comments_489097.json:
```json
{
    "body": "Done. I also took the liberty of making all of the error messages in the file follow the Python convention (to help prevent any inconsistencies).\n----\nNew commits:",
    "created_at": "2022-12-07T00:35:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34581",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34581#issuecomment-489097",
    "user": "tscrim"
}
```

Done. I also took the liberty of making all of the error messages in the file follow the Python convention (to help prevent any inconsistencies).
----
New commits:



---

archive/issue_comments_489098.json:
```json
{
    "body": "Great!\n\nIt can be set to positive review if nobody objects.",
    "created_at": "2022-12-07T14:58:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34581",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34581#issuecomment-489098",
    "user": "mmarco"
}
```

Great!

It can be set to positive review if nobody objects.



---

archive/issue_comments_489099.json:
```json
{
    "body": "pyflakes plugin says\n\n```\n+src/sage/algebras/commutative_dga.py:203:13 local variable 'squares' is assigned to but never used\n```\n",
    "created_at": "2022-12-07T16:29:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34581",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34581#issuecomment-489099",
    "user": "chapoton"
}
```

pyflakes plugin says

```
+src/sage/algebras/commutative_dga.py:203:13 local variable 'squares' is assigned to but never used
```




---

archive/issue_comments_489100.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-12-09T02:44:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34581",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34581#issuecomment-489100",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_489101.json:
```json
{
    "body": "Fixed.",
    "created_at": "2022-12-09T02:44:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34581",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34581#issuecomment-489101",
    "user": "tscrim"
}
```

Fixed.



---

archive/issue_comments_489102.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-12-14T05:05:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34581",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34581#issuecomment-489102",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_489103.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-12-19T08:11:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34581",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34581#issuecomment-489103",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_489104.json:
```json
{
    "body": "Green bot modulo the pyflakes unused variable I just removed.",
    "created_at": "2022-12-19T08:11:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34581",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34581#issuecomment-489104",
    "user": "tscrim"
}
```

Green bot modulo the pyflakes unused variable I just removed.



---

archive/issue_comments_489105.json:
```json
{
    "body": "Morally green bot.",
    "created_at": "2022-12-21T03:30:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34581",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34581#issuecomment-489105",
    "user": "tscrim"
}
```

Morally green bot.



---

archive/issue_comments_489106.json:
```json
{
    "body": "Positive review then?",
    "created_at": "2022-12-21T10:31:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34581",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34581#issuecomment-489106",
    "user": "mmarco"
}
```

Positive review then?



---

archive/issue_comments_489107.json:
```json
{
    "body": "Assuming Fr\u00e9d\u00e9ric has no further ones, I think so.",
    "created_at": "2022-12-23T06:52:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34581",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34581#issuecomment-489107",
    "user": "tscrim"
}
```

Assuming Frédéric has no further ones, I think so.
