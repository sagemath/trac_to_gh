# Issue 34581: Error when defining differentials over GCA's with relations.

Issue created by migration from https://trac.sagemath.org/ticket/34818

Original creator: mmarco

Original creation time: 2022-12-02 14:46:44

CC:  tscrim jhpalmieri

The following code


```
sage: A.<a,b,x,u> = GradedCommutativeAlgebra(QQ,degrees=(2,2,3,3))
sage: A = A.quotient(A.ideal([a*u,b*u,x*u]))
sage: A.cdg_algebra({a:u,x:a*b})
```


Produces an error


```
...

File ~/sage/src/sage/algebras/commutative_dga.py:253, in Differential.__init__(self, A, im_gens)
    251 for i in A.gens():
    252     if not self(self(i)).is_zero():
--> 253         raise ValueError("The given dictionary does not determine a valid differential")

ValueError: The given dictionary does not determine a valid differential

```


which is wrong, because the differential is valid in the quotient algebra.

It seems that the computations for the differential are done in the free algebra instead of the quotient one.


---

Comment by mmarco created at 2022-12-03 13:55:35

Changing status from new to needs_review.


---

Comment by mmarco created at 2022-12-03 13:55:35

New commits:


---

Comment by tscrim created at 2022-12-06 06:01:54

A few minor things:

```diff
-Check that #34818 is solved::
+Check that :trac:`34818` is solved::
```


```diff
         if isinstance(im_gens, (list, tuple)):
-           im_gens = {A.gen(i): x for i, x in enumerate(im_gens)}
-
-        im_gens = {A(a): A(im_gens[a]) for a in im_gens}
+           im_gens = {A.gen(i): A(x) for i, x in enumerate(im_gens)}
+        else:
+            im_gens = {A(a): A(im_gens[a]) for a in im_gens}
```


```diff
         def image_monomial(exponent):
             i = 0
             cexp = list(exponent)
             while i < len(cexp):
-                if cexp[i] == 0:
+                if not cexp[i]:
                     i +=1
                     continue
                 a = A.gen(i)
                 try:
                     da = im_gens[a]
                 except KeyError:
                     da = A.zero()
                 cexp[i] -= 1
-                b = prod([A.gen(j)**cexp[j] for j in range(len(cexp))])
+                b = prod(A.gen(j) ** cexp[j] for j in range(len(cexp)))
                 db = image_monomial(cexp)
-                im =  da * b + (-1)**A._degrees[i]*a*db
-                return(A(im))
+                im =  da * b + (-1)**A._degrees[i] * a * db
+                return A(im)
             return A.zero()
 
         for g in I.gens():
             d = g.dict()
-            res = A(sum([d[ex]*image_monomial(ex) for ex in d]))
+            res = A.sum(d[ex] * image_monomial(ex) for ex in d)
             if not res.is_zero():
-                raise ValueError("The differential does not preserve the ideal")
+                raise ValueError("the differential does not preserve the ideal")
```

Note that this last change might change a few error messages, but this is to follow a Python convention.


---

Comment by mmarco created at 2022-12-06 10:48:23

Your changes look good. Can you push them?


---

Comment by tscrim created at 2022-12-07 00:35:06

Done. I also took the liberty of making all of the error messages in the file follow the Python convention (to help prevent any inconsistencies).
----
New commits:


---

Comment by mmarco created at 2022-12-07 14:58:01

Great!

It can be set to positive review if nobody objects.


---

Comment by chapoton created at 2022-12-07 16:29:44

pyflakes plugin says

```
+src/sage/algebras/commutative_dga.py:203:13 local variable 'squares' is assigned to but never used
```



---

Comment by git created at 2022-12-09 02:44:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-12-09 02:44:38

Fixed.


---

Comment by git created at 2022-12-14 05:05:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-12-19 08:11:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-12-19 08:11:37

Green bot modulo the pyflakes unused variable I just removed.


---

Comment by tscrim created at 2022-12-21 03:30:38

Morally green bot.


---

Comment by mmarco created at 2022-12-21 10:31:49

Positive review then?


---

Comment by tscrim created at 2022-12-23 06:52:28

Assuming Frédéric has no further ones, I think so.
