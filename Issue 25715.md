# Issue 25715: smallest coefficient model for binary forms and dynamical systems

archive/issues_025715.json:
```json
{
    "body": "CC:  @loops7\n\nThere is a natural action by GL(2) on binary forms and dynamical systems. When restricted to SL(2) this action preserves discriminant (binary forms) or resultant (dynamical systems).\n\nA reduced form in the notion of Cremona-Stoll (covariant in fundamental domain of the upper half plane) can be computed for binary forms and dynamical systems (#21248). The reduced form should have 'small' coefficients but they will not necessarily be the smallest. With the updates to minimal models in #25446, we are ready to add the smallest coefficient model from Hutz-Stoll for binary forms and dynamical systems. This is the model with smallest coefficients (either height or norm) in the SL_2(Z) orbit of the binary form. For dynamical systems, this is the model with smallest coefficients and minimal resultant (may need to consider multiple SL_2(Z) orbits).\n\nIssue created by migration from https://trac.sagemath.org/ticket/25952\n\n",
    "created_at": "2018-07-27T14:55:47Z",
    "labels": [
        "component: dynamics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.4",
    "title": "smallest coefficient model for binary forms and dynamical systems",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25715",
    "user": "https://github.com/bhutz"
}
```
CC:  @loops7

There is a natural action by GL(2) on binary forms and dynamical systems. When restricted to SL(2) this action preserves discriminant (binary forms) or resultant (dynamical systems).

A reduced form in the notion of Cremona-Stoll (covariant in fundamental domain of the upper half plane) can be computed for binary forms and dynamical systems (#21248). The reduced form should have 'small' coefficients but they will not necessarily be the smallest. With the updates to minimal models in #25446, we are ready to add the smallest coefficient model from Hutz-Stoll for binary forms and dynamical systems. This is the model with smallest coefficients (either height or norm) in the SL_2(Z) orbit of the binary form. For dynamical systems, this is the model with smallest coefficients and minimal resultant (may need to consider multiple SL_2(Z) orbits).

Issue created by migration from https://trac.sagemath.org/ticket/25952





---

archive/issue_comments_362559.json:
```json
{
    "body": "Initial implementation.\n\nMoved covariant calculation and helper binary form functions to separate file. Also made the covariant more robust for fringe cases.\n\nsmallest coefficient calculations now possible for binary forms and dynamical systems.\n\nI had no failures in my ~90 function test list, so I'm pushing this initial implementation.\n----\nLast 10 new commits:",
    "created_at": "2018-08-02T18:10:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25715#issuecomment-362559",
    "user": "https://github.com/bhutz"
}
```

Initial implementation.

Moved covariant calculation and helper binary form functions to separate file. Also made the covariant more robust for fringe cases.

smallest coefficient calculations now possible for binary forms and dynamical systems.

I had no failures in my ~90 function test list, so I'm pushing this initial implementation.
----
Last 10 new commits:



---

archive/issue_comments_362560.json:
```json
{
    "body": "Set assignee to @bhutz.",
    "created_at": "2018-08-02T18:10:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25715#issuecomment-362560",
    "user": "https://github.com/bhutz"
}
```

Set assignee to @bhutz.



---

archive/issue_comments_362561.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-08T21:00:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25715#issuecomment-362561",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_362562.json:
```json
{
    "body": "Okay, here are my typed up comments that we talked over today.\n\n----\n\n\n`projective_ds.py`:\n\n1. Lines 4066 and 4086, the coercion to ZZ:\n\n\n\n```\nZZ(d = pts_poly.degree())\n```\n\n\nis redundant since degree() returns an int, and Sage automatically converts pts_poly.degree()/2 to a rational as intended. This same unnecessary coercion shows up in other files as well.\n\n----\n\n`endPN_minimal_model.py`\n\n1. Line 993 \"be\" instead of \"me\"\n\n2. Maybe a little clearer description of the condition on line 1142\n\n3. Commented out code on lines 1079 and 1090. \n\n----\n\n`multi_polynomial.pyx`\n\n1. The documentation:\n\n\n\n```\nIf Newton's method fails to converge to a point\nin the upper half plane, the function will use the less precise `Q_0`\ncovariant as defined in [CS2003]_. Additionally, if this polynomial has\na root with multiplicity at lease half the total degree of the polynomial,\nthen we must also use the `Q_0` covariant. See [CS2003]_ for details.\n```\n\n\nis potentially confusing. Q_0 is a covariant quadratic, but the covariant we are really concerned with here is the value z_0, the root of Q_0 in the upper half plane. Maybe it would be clearer to say that what is returned instead of a true reduced form is a Q_0-reduced binary form as defined on p.7 of Cremona-Stoll. \n\n2. Line 2273, \n\n\n```\n# this moves z to our fundamental domain using the three steps laid\n# out in the algorithim by [CS2003]\n# this is found in section 5 of their paper\n```\n\n\nshould read \"moves **z_0** to the fundamental domain...\"\n\n3. We can condense the implementation of Cremona-Stoll's reduction algorithm from section 5 of their paper by combining the first two cases into one, for example:\n\n\n```\nif zc.real() < RF(-0.5) or zc.real() >= RF(0.5): \n    m = QQ(zc.real().round()) \n    M = M * matrix(QQ, [[1,m], [0,1]]) \n    z -= m  \n```\n\n\nThis implementation shows up twice in the method. \n\n\n----\n\n`binary_form_reduce.py`\n\n- `covariant_z0`\n\n1. Line 47 method documentation:\n\n\n\n```\nReturn the `z_0` covariant and Julia invariant from Cremona-Stoll [CS2003]_.\n```\n\n\nWe only return z_0 if we set an explicit parameter. Otherwise we return the \"true\" covariant z. \n\n2. The paramter `z0_inv` is misleading in that z0 is a covariant, not an invariant. \n\n3. Similarly confusing wording at the end of line 51, \n\n```\nNote that you may get faster convergence if you first move \n`z_0(F)` to the fundamental domain before computing the true invariant\n```\n\n\n4. Non-pythonic iteration on lines 180 and 218. We don't need the index, so much cleaner to do: \n\n```\nfor root in roots:\n```\n\n\n5. Line 184, replace \n\n```\nq = sum([Q[i] for i in range(len(Q))])\n```\n\n\n    with \n    {{{\n    q = sum(Q)\n    }}}\n\nor just abandon the list creation in the first place as you hinted at. \n\n\n- `epsinv`\n\n1. Commented out print statements left around\n\n2. Maybe a single line comment that RQ means the R-quotient from Lemma 4.2 in Hutz-Stoll\n\n3. A comment for line 348 that performing this change of variables on f gives us an f_0 such that z(f_0) = j. \n\n4. Loops initiated on lines 212 and 255 should have '_' as dummy variable to be more \"pythonic\" for whatever that is worth.\n\n- `smallest_poly`\n\n1. Clarify comments on lines 570 and 571 (same as endPN_minimal line 1142).",
    "created_at": "2018-08-30T05:05:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25715#issuecomment-362562",
    "user": "https://github.com/Loops7"
}
```

Okay, here are my typed up comments that we talked over today.

----


`projective_ds.py`:

1. Lines 4066 and 4086, the coercion to ZZ:



```
ZZ(d = pts_poly.degree())
```


is redundant since degree() returns an int, and Sage automatically converts pts_poly.degree()/2 to a rational as intended. This same unnecessary coercion shows up in other files as well.

----

`endPN_minimal_model.py`

1. Line 993 "be" instead of "me"

2. Maybe a little clearer description of the condition on line 1142

3. Commented out code on lines 1079 and 1090. 

----

`multi_polynomial.pyx`

1. The documentation:



```
If Newton's method fails to converge to a point
in the upper half plane, the function will use the less precise `Q_0`
covariant as defined in [CS2003]_. Additionally, if this polynomial has
a root with multiplicity at lease half the total degree of the polynomial,
then we must also use the `Q_0` covariant. See [CS2003]_ for details.
```


is potentially confusing. Q_0 is a covariant quadratic, but the covariant we are really concerned with here is the value z_0, the root of Q_0 in the upper half plane. Maybe it would be clearer to say that what is returned instead of a true reduced form is a Q_0-reduced binary form as defined on p.7 of Cremona-Stoll. 

2. Line 2273, 


```
# this moves z to our fundamental domain using the three steps laid
# out in the algorithim by [CS2003]
# this is found in section 5 of their paper
```


should read "moves **z_0** to the fundamental domain..."

3. We can condense the implementation of Cremona-Stoll's reduction algorithm from section 5 of their paper by combining the first two cases into one, for example:


```
if zc.real() < RF(-0.5) or zc.real() >= RF(0.5): 
    m = QQ(zc.real().round()) 
    M = M * matrix(QQ, [[1,m], [0,1]]) 
    z -= m  
```


This implementation shows up twice in the method. 


----

`binary_form_reduce.py`

- `covariant_z0`

1. Line 47 method documentation:



```
Return the `z_0` covariant and Julia invariant from Cremona-Stoll [CS2003]_.
```


We only return z_0 if we set an explicit parameter. Otherwise we return the "true" covariant z. 

2. The paramter `z0_inv` is misleading in that z0 is a covariant, not an invariant. 

3. Similarly confusing wording at the end of line 51, 

```
Note that you may get faster convergence if you first move 
`z_0(F)` to the fundamental domain before computing the true invariant
```


4. Non-pythonic iteration on lines 180 and 218. We don't need the index, so much cleaner to do: 

```
for root in roots:
```


5. Line 184, replace 

```
q = sum([Q[i] for i in range(len(Q))])
```


    with 
    {{{
    q = sum(Q)
    }}}

or just abandon the list creation in the first place as you hinted at. 


- `epsinv`

1. Commented out print statements left around

2. Maybe a single line comment that RQ means the R-quotient from Lemma 4.2 in Hutz-Stoll

3. A comment for line 348 that performing this change of variables on f gives us an f_0 such that z(f_0) = j. 

4. Loops initiated on lines 212 and 255 should have '_' as dummy variable to be more "pythonic" for whatever that is worth.

- `smallest_poly`

1. Clarify comments on lines 570 and 571 (same as endPN_minimal line 1142).



---

archive/issue_comments_362563.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-08-30T05:10:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25715#issuecomment-362563",
    "user": "https://github.com/Loops7"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_362564.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-08-30T05:10:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25715#issuecomment-362564",
    "user": "https://github.com/Loops7"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_362565.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-31T01:00:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25715#issuecomment-362565",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_362566.json:
```json
{
    "body": "I made all the changes except one. btw, don't forget to add your name in Reviewer.\n\n- Lines 4066 and 4086, the coercion to ZZ: \n\n```\nd = ZZ(pts_poly.degree())\n```\n\nwhile int/2 gets converted automatically to a rational in the notebook, the same is not true in the source. So some kind of conversion is necessary.",
    "created_at": "2018-08-31T01:03:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25715#issuecomment-362566",
    "user": "https://github.com/bhutz"
}
```

I made all the changes except one. btw, don't forget to add your name in Reviewer.

- Lines 4066 and 4086, the coercion to ZZ: 

```
d = ZZ(pts_poly.degree())
```

while int/2 gets converted automatically to a rational in the notebook, the same is not true in the source. So some kind of conversion is necessary.



---

archive/issue_comments_362567.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-08-31T01:03:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25715#issuecomment-362567",
    "user": "https://github.com/bhutz"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_362568.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-09-03T20:29:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25715#issuecomment-362568",
    "user": "https://github.com/Loops7"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_362569.json:
```json
{
    "body": "I agree that my last comment regarding the ZZ inclusion was not particularly relevant, and I did some digging to see what was going on. Having worked mainly with Python3, I was accustomed to `3/2` returning 1.5 and `3//2` returning 1 through floor division. Evidently with Python2, the `/` operator is floor division, which I didn't know. We can `import division` from `__future__` to change the behavior of `/` to the Python3 standard, or just keep the coercion code.\n\nEither way, everything looks good to go.",
    "created_at": "2018-09-03T20:29:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25715#issuecomment-362569",
    "user": "https://github.com/Loops7"
}
```

I agree that my last comment regarding the ZZ inclusion was not particularly relevant, and I did some digging to see what was going on. Having worked mainly with Python3, I was accustomed to `3/2` returning 1.5 and `3//2` returning 1 through floor division. Evidently with Python2, the `/` operator is floor division, which I didn't know. We can `import division` from `__future__` to change the behavior of `/` to the Python3 standard, or just keep the coercion code.

Either way, everything looks good to go.



---

archive/issue_comments_362570.json:
```json
{
    "body": "\n```\nsage -t --long src/sage/schemes/projective/projective_morphism.py\n**********************************************************************\nFile \"src/sage/schemes/projective/projective_morphism.py\", line 1728, in sage.schemes.projective.projective_morphism.SchemeMorphism_polynomial_projective_space.reduced_form\nFailed example:\n    f.reduced_form()\nException raised:\n    Traceback (most recent call last):\n      File \"/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 650, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1061, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.schemes.projective.projective_morphism.SchemeMorphism_polynomial_projective_space.reduced_form[3]>\", line 1, in <module>\n        f.reduced_form()\n      File \"/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/schemes/projective/projective_morphism.py\", line 1743, in reduced_form\n        return self.as_dynamical_system().reduced_form(prec, return_conjugation, error_limit)\n    TypeError: reduced_form() takes exactly 1 argument (4 given)\n**********************************************************************\n1 item had failures:\n   1 of   5 in sage.schemes.projective.projective_morphism.SchemeMorphism_polynomial_projective_space.reduced_form\n    [641 tests, 1 failure, 6.12 s]\n----------------------------------------------------------------------\nsage -t --long src/sage/schemes/projective/projective_morphism.py  # 1 doctest failed\n----------------------------------------------------------------------\n```\n",
    "created_at": "2018-09-04T20:35:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25715#issuecomment-362570",
    "user": "https://github.com/vbraun"
}
```


```
sage -t --long src/sage/schemes/projective/projective_morphism.py
**********************************************************************
File "src/sage/schemes/projective/projective_morphism.py", line 1728, in sage.schemes.projective.projective_morphism.SchemeMorphism_polynomial_projective_space.reduced_form
Failed example:
    f.reduced_form()
Exception raised:
    Traceback (most recent call last):
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 650, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1061, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.schemes.projective.projective_morphism.SchemeMorphism_polynomial_projective_space.reduced_form[3]>", line 1, in <module>
        f.reduced_form()
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/schemes/projective/projective_morphism.py", line 1743, in reduced_form
        return self.as_dynamical_system().reduced_form(prec, return_conjugation, error_limit)
    TypeError: reduced_form() takes exactly 1 argument (4 given)
**********************************************************************
1 item had failures:
   1 of   5 in sage.schemes.projective.projective_morphism.SchemeMorphism_polynomial_projective_space.reduced_form
    [641 tests, 1 failure, 6.12 s]
----------------------------------------------------------------------
sage -t --long src/sage/schemes/projective/projective_morphism.py  # 1 doctest failed
----------------------------------------------------------------------
```




---

archive/issue_comments_362571.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-09-04T20:35:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25715#issuecomment-362571",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_362572.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-09-04T22:07:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25715#issuecomment-362572",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_362573.json:
```json
{
    "body": "sorry, missed that one.",
    "created_at": "2018-09-04T22:07:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25715#issuecomment-362573",
    "user": "https://github.com/bhutz"
}
```

sorry, missed that one.



---

archive/issue_comments_362574.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-09-04T22:07:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25715#issuecomment-362574",
    "user": "https://github.com/bhutz"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_362575.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-09-08T11:08:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25715#issuecomment-362575",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_362576.json:
```json
{
    "body": "Green patchbot.",
    "created_at": "2018-09-08T11:08:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25715#issuecomment-362576",
    "user": "https://github.com/tscrim"
}
```

Green patchbot.



---

archive/issue_events_023926.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2018-09-09T07:38:42Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/25715",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25715#event-23926"
}
```



---

archive/issue_comments_362577.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-09-09T07:38:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25715#issuecomment-362577",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
