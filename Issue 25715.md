# Issue 25715: smallest coefficient model for binary forms and dynamical systems

Issue created by migration from https://trac.sagemath.org/ticket/25952

Original creator: bhutz

Original creation time: 2018-07-27 14:55:47

CC:  @loops7

There is a natural action by GL(2) on binary forms and dynamical systems. When restricted to SL(2) this action preserves discriminant (binary forms) or resultant (dynamical systems).

A reduced form in the notion of Cremona-Stoll (covariant in fundamental domain of the upper half plane) can be computed for binary forms and dynamical systems (#21248). The reduced form should have 'small' coefficients but they will not necessarily be the smallest. With the updates to minimal models in #25446, we are ready to add the smallest coefficient model from Hutz-Stoll for binary forms and dynamical systems. This is the model with smallest coefficients (either height or norm) in the SL_2(Z) orbit of the binary form. For dynamical systems, this is the model with smallest coefficients and minimal resultant (may need to consider multiple SL_2(Z) orbits).


---

Comment by bhutz created at 2018-08-02 18:10:47

Initial implementation.

Moved covariant calculation and helper binary form functions to separate file. Also made the covariant more robust for fringe cases.

smallest coefficient calculations now possible for binary forms and dynamical systems.

I had no failures in my ~90 function test list, so I'm pushing this initial implementation.
----
Last 10 new commits:


---

Comment by bhutz created at 2018-08-02 18:10:47

Set assignee to bhutz.


---

Comment by git created at 2018-08-08 21:00:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @Loops7 created at 2018-08-30 05:05:05

Okay, here are my typed up comments that we talked over today.

----


`projective_ds.py`:

1. Lines 4066 and 4086, the coercion to ZZ:



```
ZZ(d = pts_poly.degree())
```


is redundant since degree() returns an int, and Sage automatically converts pts_poly.degree()/2 to a rational as intended. This same unnecessary coercion shows up in other files as well.

----

`endPN_minimal_model.py`

1. Line 993 "be" instead of "me"

2. Maybe a little clearer description of the condition on line 1142

3. Commented out code on lines 1079 and 1090. 

----

`multi_polynomial.pyx`

1. The documentation:



```
If Newton's method fails to converge to a point
in the upper half plane, the function will use the less precise `Q_0`
covariant as defined in [CS2003]_. Additionally, if this polynomial has
a root with multiplicity at lease half the total degree of the polynomial,
then we must also use the `Q_0` covariant. See [CS2003]_ for details.
```


is potentially confusing. Q_0 is a covariant quadratic, but the covariant we are really concerned with here is the value z_0, the root of Q_0 in the upper half plane. Maybe it would be clearer to say that what is returned instead of a true reduced form is a Q_0-reduced binary form as defined on p.7 of Cremona-Stoll. 

2. Line 2273, 


```
# this moves z to our fundamental domain using the three steps laid
# out in the algorithim by [CS2003]
# this is found in section 5 of their paper
```


should read "moves **z_0** to the fundamental domain..."

3. We can condense the implementation of Cremona-Stoll's reduction algorithm from section 5 of their paper by combining the first two cases into one, for example:


```
if zc.real() < RF(-0.5) or zc.real() >= RF(0.5): 
    m = QQ(zc.real().round()) 
    M = M * matrix(QQ, [[1,m], [0,1]]) 
    z -= m  
```


This implementation shows up twice in the method. 


----

`binary_form_reduce.py`

- `covariant_z0`

1. Line 47 method documentation:



```
Return the `z_0` covariant and Julia invariant from Cremona-Stoll [CS2003]_.
```


We only return z_0 if we set an explicit parameter. Otherwise we return the "true" covariant z. 

2. The paramter `z0_inv` is misleading in that z0 is a covariant, not an invariant. 

3. Similarly confusing wording at the end of line 51, 

```
Note that you may get faster convergence if you first move 
`z_0(F)` to the fundamental domain before computing the true invariant
```


4. Non-pythonic iteration on lines 180 and 218. We don't need the index, so much cleaner to do: 

```
for root in roots:
```


5. Line 184, replace 

```
q = sum([Q[i] for i in range(len(Q))])
```


    with 
    {{{
    q = sum(Q)
    }}}

or just abandon the list creation in the first place as you hinted at. 


- `epsinv`

1. Commented out print statements left around

2. Maybe a single line comment that RQ means the R-quotient from Lemma 4.2 in Hutz-Stoll

3. A comment for line 348 that performing this change of variables on f gives us an f_0 such that z(f_0) = j. 

4. Loops initiated on lines 212 and 255 should have '_' as dummy variable to be more "pythonic" for whatever that is worth.

- `smallest_poly`

1. Clarify comments on lines 570 and 571 (same as endPN_minimal line 1142).


---

Comment by @Loops7 created at 2018-08-30 05:10:47

Changing status from new to needs_review.


---

Comment by @Loops7 created at 2018-08-30 05:10:54

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-08-31 01:00:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bhutz created at 2018-08-31 01:03:45

I made all the changes except one. btw, don't forget to add your name in Reviewer.

- Lines 4066 and 4086, the coercion to ZZ: 

```
d = ZZ(pts_poly.degree())
```

while int/2 gets converted automatically to a rational in the notebook, the same is not true in the source. So some kind of conversion is necessary.


---

Comment by bhutz created at 2018-08-31 01:03:45

Changing status from needs_work to needs_review.


---

Comment by @Loops7 created at 2018-09-03 20:29:33

Changing status from needs_review to positive_review.


---

Comment by @Loops7 created at 2018-09-03 20:29:33

I agree that my last comment regarding the ZZ inclusion was not particularly relevant, and I did some digging to see what was going on. Having worked mainly with Python3, I was accustomed to `3/2` returning 1.5 and `3//2` returning 1 through floor division. Evidently with Python2, the `/` operator is floor division, which I didn't know. We can `import division` from `__future__` to change the behavior of `/` to the Python3 standard, or just keep the coercion code.

Either way, everything looks good to go.


---

Comment by vbraun created at 2018-09-04 20:35:25


```
sage -t --long src/sage/schemes/projective/projective_morphism.py
**********************************************************************
File "src/sage/schemes/projective/projective_morphism.py", line 1728, in sage.schemes.projective.projective_morphism.SchemeMorphism_polynomial_projective_space.reduced_form
Failed example:
    f.reduced_form()
Exception raised:
    Traceback (most recent call last):
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 650, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1061, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.schemes.projective.projective_morphism.SchemeMorphism_polynomial_projective_space.reduced_form[3]>", line 1, in <module>
        f.reduced_form()
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/schemes/projective/projective_morphism.py", line 1743, in reduced_form
        return self.as_dynamical_system().reduced_form(prec, return_conjugation, error_limit)
    TypeError: reduced_form() takes exactly 1 argument (4 given)
**********************************************************************
1 item had failures:
   1 of   5 in sage.schemes.projective.projective_morphism.SchemeMorphism_polynomial_projective_space.reduced_form
    [641 tests, 1 failure, 6.12 s]
----------------------------------------------------------------------
sage -t --long src/sage/schemes/projective/projective_morphism.py  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by vbraun created at 2018-09-04 20:35:25

Changing status from positive_review to needs_work.


---

Comment by git created at 2018-09-04 22:07:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bhutz created at 2018-09-04 22:07:42

sorry, missed that one.


---

Comment by bhutz created at 2018-09-04 22:07:42

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2018-09-08 11:08:02

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2018-09-08 11:08:02

Green patchbot.


---

Comment by vbraun created at 2018-09-09 07:38:42

Resolution: fixed
