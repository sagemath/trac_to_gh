# Issue 17766: Extract non-crossing matching from Fully Packed Loop

Issue created by migration from https://trac.sagemath.org/ticket/18003

Original creator: kdilks

Original creation time: 2015-03-19 21:57:37

CC:  tscrim jessicapalencia egunawan vinceknight jcampbell kdilks nadialafreniere mlapointe

Keywords: fpl, ncp, days64

Use methods from FullyPackedLoop to extract the information of the corresponding non-crossing matchings.


---

Comment by jessicapalencia created at 2015-03-20 20:43:33

Changing keywords from "fpl, ncp, days64" to "fpl, ncp, days64, asm".


---

Comment by egunawan created at 2015-03-22 00:49:54

Changing keywords from "fpl, ncp, days64, asm" to "fpl, ncp, days64, asm, lp".


---

Comment by egunawan created at 2015-03-22 00:51:29

I'm sorry Vince for using trac for development process, but I don't have everyone's email addresses. This is from the latest u/jcampbell/lp pull:

sage: mat = AlternatingSignMatrix([[0,0,0,1,0,0], [0,0,1,-1,1,0], [0,1,0,0,-1,1], [1,0,-1,1,0,0], \
....: ....:             [0,0,1,0,0,0], [0,0,0,0,1,0]])
sage: mat
[ 0  0  0  1  0  0]
[ 0  0  1 -1  1  0]
[ 0  1  0  0 -1  1]
[ 1  0 -1  1  0  0]
[ 0  0  1  0  0  0]
[ 0  0  0  0  1  0]
sage: fpl = FullyPackedLoop(mat) 
sage: ncp = fpl.link_pattern()
---------------------------------------------------------------------------
KeyError                                  Traceback (most recent call last)
<ipython-input-62-beb825ee7c96> in <module>()
----> 1 ncp = fpl.link_pattern()

/Users/eg/sageMar2015/sage/local/lib/python2.7/site-packages/sage/combinat/fully_packed_loop.pyc in link_pattern(self)
    637             vertices_d[position] = 0 # allows us to start
    638 
--> 639             while not vertices_d[position]:
    640                 vertices_d.pop(position)
    641                 choices = self._get_coordinates(position)

KeyError: (0, 2)


---

Comment by jcampbell created at 2015-03-22 01:57:14

yeah it's not currently working quite right, i'll keep working on it over the flight though and hopefully figure out what's going wrong.
G+ is probably the best way to contact me so add me on there :)


---

Comment by egunawan created at 2015-03-23 00:06:37

Last 10 new commits:


---

Comment by kdilks created at 2015-03-23 16:47:27

I think the code for link pattern isn't properly tab aligned. Right now when I take an ASM and send it to a link pattern, I get the right result the first time, and then subsequent times I only get the last pair.


---

Comment by git created at 2015-03-24 03:37:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-03-24 04:30:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egunawan created at 2015-03-24 04:38:00

Changing keywords from "fpl, ncp, days64, asm, lp" to "fpl, ncp, days64, asm, lp, fully packed loop".


---

Comment by egunawan created at 2015-03-24 04:42:29

I believe this is ready to be reviewed by Travis?

I added the equality functionality. I wanted to do a test like isinstance(other,FullyPackedLoop), but I did not because of this behavior which I don't understand:

sage: A=AlternatingSignMatrices(3)
sage: M=A.random_element()
sage: f=FullyPackedLoop(M)
sage: type(f)
<class 'sage.combinat.fully_packed_loop.FullyPackedLoop'>
sage: isinstance(f,FullyPackedLoop)
False


---

Comment by egunawan created at 2015-03-24 04:42:43

Changing status from new to needs_review.


---

Comment by tscrim created at 2015-03-24 05:01:10

On my todo list.


---

Comment by tscrim created at 2015-03-24 15:14:25

Okay, some comments after a quick look-over:

- I think you should implement a `toggle` map which swaps 2 vertical lines and 2 horizontal lines.
- You should make a parent class for all fully packed loops (on an `n x n` (m?) grid). The iterator could be a `TransitiveIdeal` generated by the toggles (or some other type of search using toggles), but perhaps there is a better way to do this. Also `FullyPackedLoop` then should be a subclass of `Element`.
- The `.. math::` should be `.. MATH::`.
- You need more docuemntation for the class `FullyPackedLoop`, and the first line should be something like `A fully packed loop.` (a sentence which does not say "class", "implement", or other similar things). Also, it would be good to have some more references.
- Perhaps the vertices could be `+` instead of `#`, or we set that as a `global_option` (this is something I could do if you want)?
- Remove the commented out lines.
- The `fpl.plot().description()` output could potentially be machine dependent, so it would be better to test the number of such elements.

I will possibly have more comments as I make a more detailed review. However it's looking quite good.

This is more a note for myself to look at in more detail, but I think contains some interesting followup ideas: http://www.lpthe.jussieu.fr/~pzinn/semi/steklov.pdf.


---

Comment by kdilks created at 2015-03-24 18:37:32

* I think we were putting off adding toggles and further functionality until we had things settled with defining the FPL class and extracting a link pattern. But it might not be too hard to add right now.
 * Right now we're just assuming square ice boundary conditions, which forces n by n. At some point we'd like to have arbitrary boundary conditions (which would allow n by m, and would probably require some modification of previous code that implicitly assumes square shape). But again, conscious decision to try and limit how much we're taking on.
 * Couldn't we just inherit whatever iterator SixVertexModel or AlternatingSignMatrices uses?
 * I'm fine with vertices being '+' .
 * I've been meaning to remove those commented lines, and make some other small edits to the documentation.


---

Comment by git created at 2015-03-25 03:13:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jessicapalencia created at 2015-04-15 16:23:16

Hi all, What's going on with this ticket at the moment? I see Emily addressed some of Travis's comments in the most recently pushed branch. Has anyone worked on the rest? (It looks like what is left is making a parent class, is this right?) Kevin, you said you have something to add to the doc, but I didn't see a commit. I'd be happy to work on the doc as well, but I don't think I can add the parent class. Could we either close this ticket without that, or can someone implement that? Thanks!


---

Comment by vinceknight created at 2015-04-18 11:32:26

I'm a bit confused... When the gyration ticket got merged in I assumed that meant that this also got merged in. Did gyration not depend on this ticket?


---

Comment by jessicapalencia created at 2015-04-19 13:39:51

No, I think #18021 just implemented gyration orbits in alternating_sign_matrix.py, but didn't do anything with the fpl class. There was #17988 which was closed since it was a duplicate of #18003 (this ticket). But this ticket is what implements fpl's and link patterns, and it's still at 'needs review'. I'd be happy to review this ticket as is and we could just open another ticket for adding the parent class if need be. I think I'll work on this tomorrow or Tuesday unless I hear otherwise.


---

Comment by git created at 2015-04-19 19:58:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kdilks created at 2015-04-19 20:01:12

Added some sort of definition to the beginning of the file, and touched up a few typos/grammar problems. Definition at the beginning could probably use some touching up, and per Travis's  comment, could still use some more citations.


---

Comment by tscrim created at 2015-04-21 19:11:34

Something else to change would be to make `self._six_vertex_model` (add the underscore) and then access it via a method so the FPL class acts as immutable. I'm also not happy with comparing equality by the repr's. I think it would be better to compare the underlying 6 vertex models. Also you should consider implementing a `__ne__` method as well.

I also believe we should not merge this ticket without a corresponding parent class. The basic framework would be

```python
class FullyPackedLoops(Parent, UniqueRepresentation):
    def __init__(self, n):
        self._n = n
        Parent.__init__(self, category=FiniteEnumeratedSets())

    def __iter__(self):
        for X in SixVertexModel(self._n):
            yield self.element_class(self, X)

    Element = FullyPackedLoops
```



---

Comment by tscrim created at 2015-04-21 19:11:34

Changing status from needs_review to needs_work.


---

Comment by egunawan created at 2015-06-09 02:50:57

Changing keywords from "fpl, ncp, days64, asm, lp, fully packed loop" to "fpl, ncp, days64, days65, asm, lp, fully packed loop".


---

Comment by git created at 2015-06-09 20:57:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-09 21:05:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-10 03:53:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egunawan created at 2015-06-10 03:55:19

I added a method six_vertex_model and add underscore to self._six_vertex_model, but I'm not sure how to make sure that the FPL class acts as immutable or how to make it so.


---

Comment by git created at 2015-06-10 05:23:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-10 16:47:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-10 17:13:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-12 07:18:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2015-06-12 15:27:47

Some notes about your `_element_constructor_`, you don't need to check `fpl.parent() is self`, as the coercion model has already checked that and would have returned that. Which is why your test actually works. If you try to pass in the ASM, your `_element_constructor_` will return `None`. I think what you should do is copy the implementation from `__classcall_private__` into `_element_constructor_` and then have `__classcall_private__` return `FPLs(generator)`. You might also want to consider passing other types of data to a corresponding SVM in the `_element_constructor_`.

You can test for a SVM to be the square ice configuration by `isinstance(SVM, SquareIceModel.Element)`.


---

Comment by git created at 2015-06-12 16:35:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egunawan created at 2015-06-12 16:39:10

How come AlternatingSignMatrices._element_constructor_ checks if asm.parent() is self? Is that also redundant?


---

Comment by tscrim created at 2015-06-12 16:41:25

Replying to [comment:37 egunawan]:
> How come AlternatingSignMatrices._element_constructor_ checks if asm.parent() is self? Is that also redundant?

It is also redundant (I might have suggested it, or at least thought it was necessary, before Nicolas told me about the fact the coercion framework handles that case before `_element_constructor_` even sees it).


---

Comment by egunawan created at 2015-06-12 17:21:06

Does it matter which line we write "Element = FullyPackedLoop"? Anywhere under "class FullyPackedLoops(Parent, UniqueRepresentation):"?


---

Comment by tscrim created at 2015-06-12 17:24:10

No, for the same reason the order of the methods doesn't matter.


---

Comment by git created at 2015-06-12 18:44:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egunawan created at 2015-06-12 18:47:23

Replying to [comment:35 tscrim]:
> You might also want to consider passing other types of data to a corresponding SVM in the `_element_constructor_`.
What types of data for example?


---

Comment by tscrim created at 2015-06-13 01:29:58

Replying to [comment:42 egunawan]:
> Replying to [comment:35 tscrim]:
> > You might also want to consider passing other types of data to a corresponding SVM in the `_element_constructor_`.
> What types of data for example?

Something that could be used to construct a six-vertex configuration:

```
SVM = SixVertexModel(2)
SVM([[3,1],[5,3]])
```

So it would make this work:

```
sage: FPL = FullyPackedLoops(2)
sage: FPL([[3,1],[5,3]])
```



---

Comment by git created at 2015-08-29 22:37:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-08-30 10:11:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egunawan created at 2015-09-01 15:27:53

Changing status from needs_work to needs_review.


---

Comment by egunawan created at 2015-09-01 15:35:38

I'm not sure what is causing the PluginOnlyFailed.


---

Comment by tscrim created at 2015-09-01 17:48:00

Changing status from needs_review to needs_work.


---

Comment by tscrim created at 2015-09-01 17:48:00

The coverage failure, I'm no so sure (FYI you can click on the patchbot info to see details). However the import modules failure is reflecting the fact that you are not lazily importing this new file (which is there in an effort to try and keep startup time down). So I would add this line instead of the straight import:

```
lazy_import('sage.combinat.fully_packed_loop', ['FullyPackedLoop', 'FullyPackedLoops'])
```


A couple of things about the ticket/code itself:

- `matrix and also extract the link pattern.::` either remove the period or put a space after it.
- You should not put examples/information for the user in the `__init__`, instead move it to the class level docstring (for `FullyPackedLoop`). The `__init__` still needs to have a doctest, and a good one is to typically create an element `X` and then do `TestSuite(X).run()`, but you already have this, so leave the `TESTS::` block.
- In `to_alternating_sign_matrix`, remove the blank line at the beginning of the docstring and start with `Return`.
- You don't need `:math:`x = y``, just ``x = y`` with the backticks is sufficient. If you want it similar to equation mode in latex, do

```
.. MATH::

    x = y
```

- The `EXAMPLES::` block in `plot` is indented one to many times.
- For notes, you might want to consider using the `.. NOTE::` block (in `link_pattern`).
- Period missing in `six_vertex_model` one-line sentence.
- I would make `_vertex_dictionary` a lazy attribute (grep for ``@`lazy_attribute`). FYI - This means it's created on-demand and acts like a regular attribute, so `self._vertex_dictionary[i]` works. Essentially it is cached, so the downside to this is that the dictionary gets kept alive as long as that FPL is, but I think each instance is not kept alive too long. It's up to you.
- Same for `_end_point_dictionary`. In a similar vein, I would remove the (public) attribute `end_points` and just use `_end_point_dictionary`.
- First line of `FullyPackedLoops` needs a period and an empty line of space.
- `cardinality` is missing a period at the end of the equation.
- Remove the commented out code in `_element_constructor_`.
- You need to provide a description of `link_pattern`.
- You should describe the bijection with ASMs somewhere, most likely in the `FullyPackedLoops` (resp. `FullyPackedLoop`) class and add `.. SEEALSO::` to that class in `FullyPackedLoop` (resp. `FullyPackedLoops`) and `to_fully_packed_loop`.
- The documentation at the top of the file is good, but you can't read it interactively (only on the online/compiled documentation). I would suggest moving it to either `FullyPackedLoops` or `FullyPackedLoop`, depending on which you think is the more common entry point.
- I think the variable name of `current` in `_get_coordinates` is confusing and you should rename it to something more descriptive.

Looking very good overall, as almost all of these are trivial to minor tweaks. That's all for now.


---

Comment by git created at 2015-09-05 03:44:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egunawan created at 2015-09-05 03:48:07

I don't understand your comment about :math:`x = y`?


---

Comment by git created at 2015-09-05 03:56:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-09-05 18:45:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nadialafreniere created at 2015-09-05 18:55:06

New commits:


---

Comment by git created at 2015-09-05 23:08:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egunawan created at 2015-09-05 23:10:25

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2015-09-06 18:43:13

In regard to the `:math:`...`` comment, I would make this change:

```
     def plot(self):
-        """
+        r"""
         Return a graphical object of the Fully Packed Loop
 
         EXAMPLES:
 
-         Here is the fully packed for :math:`\\begin{pmatrix}0&1&1\\\\1&-1&1\\\\0&1&0\end{pmatrix}`:
+         Here is the fully packed for
+
+         .. MATH::
+
+             \begin{pmatrix} 0&1&1 \\ 1&-1&1 \\ 0&1&0 \end{pmatrix}:
 
```

There is also a `[TODO]` that you added that needs to be either removed, expanded (and put in a `.. TODO::` block), or done. Thanks.


---

Comment by git created at 2015-09-11 08:26:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2015-09-11 14:03:51

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2015-09-11 14:03:51

Looks good to me now. Thanks!


---

Comment by jessicapalencia created at 2015-09-11 14:58:27

That's really exciting - great work everyone!


---

Comment by vbraun created at 2015-09-12 09:53:34

Resolution: fixed


---

Comment by vinceknight created at 2015-09-12 15:46:49

Nice job guys! :)


---

Comment by egunawan created at 2018-07-11 23:05:55

Hi all, 
Why did we choose FullyPackedLoop to be an Element class (as opposed to, say, ClonableArray like SixVertexConfiguration)? 
(I am working on a creating a new combinatorial object now and deciding which data type to use.) Thank you!


---

Comment by tscrim created at 2018-07-12 21:13:16

Replying to [comment:64 egunawan]:
> Hi all, 
> Why did we choose FullyPackedLoop to be an Element class (as opposed to, say, ClonableArray like SixVertexConfiguration)? 
> (I am working on a creating a new combinatorial object now and deciding which data type to use.) Thank you!

Because internally it is not a list but essentially a wrapper around a `SixVertexConfiguration`. Feel free to send me an email if you want to talk in more detail.
