# Issue 18631: a MemoryAllocator object for easier Cython memory management

archive/issues_018631.json:
```json
{
    "body": "CC:  @dimpase borassi @dcoudert @vbraun @jdemeyer simonking\n\nThis is a re-implementation of an example appearing in Cython's documentation (see bottom of [1]).\n\nThe idea is simple: an object has a `.malloc` method, and returns arrays of memory. When that object is garbage-collected, the memory it allocated is automatically freed.\n\nThis makes it much easier to deal with C pointers in Cython code, which must be freed before any 'return' and whenever an exception can be raised.\n\nAs an illustration of how useful this can be, I removed a *lot* of graph code.\n\nNathann\n\n[1] http://docs.cython.org/src/tutorial/memory_allocation.html\n\nIssue created by migration from https://trac.sagemath.org/ticket/18868\n\n",
    "created_at": "2015-07-08T10:00:53Z",
    "labels": [
        "component: cython"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.8",
    "title": "a MemoryAllocator object for easier Cython memory management",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18631",
    "user": "https://github.com/nathanncohen"
}
```
CC:  @dimpase borassi @dcoudert @vbraun @jdemeyer simonking

This is a re-implementation of an example appearing in Cython's documentation (see bottom of [1]).

The idea is simple: an object has a `.malloc` method, and returns arrays of memory. When that object is garbage-collected, the memory it allocated is automatically freed.

This makes it much easier to deal with C pointers in Cython code, which must be freed before any 'return' and whenever an exception can be raised.

As an illustration of how useful this can be, I removed a *lot* of graph code.

Nathann

[1] http://docs.cython.org/src/tutorial/memory_allocation.html

Issue created by migration from https://trac.sagemath.org/ticket/18868





---

archive/issue_comments_253395.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-07-08T10:01:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253395",
    "user": "https://github.com/nathanncohen"
}
```

New commits:



---

archive/issue_comments_253396.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-07-08T10:01:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253396",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_253397.json:
```json
{
    "body": "This\n\n```\ninclude 'sage/ext/interrupt.pxi'\n```\n\nshould be in the `.pyx` file.",
    "created_at": "2015-07-08T10:06:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253397",
    "user": "https://github.com/jdemeyer"
}
```

This

```
include 'sage/ext/interrupt.pxi'
```

should be in the `.pyx` file.



---

archive/issue_comments_253398.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-07-08T10:06:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253398",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_253399.json:
```json
{
    "body": "For performance, replace\n\n```\ncdef MemoryAllocator mem = MemoryAllocator()\n```\n\nby\n\n```\ncdef MemoryAllocator mem = <MemoryAllocator>MemoryAllocator.__new__(MemoryAllocator)\n```\n",
    "created_at": "2015-07-08T10:11:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253399",
    "user": "https://github.com/jdemeyer"
}
```

For performance, replace

```
cdef MemoryAllocator mem = MemoryAllocator()
```

by

```
cdef MemoryAllocator mem = <MemoryAllocator>MemoryAllocator.__new__(MemoryAllocator)
```




---

archive/issue_comments_253400.json:
```json
{
    "body": "Can you please support all memory-allocation functions, like `calloc`, `realloc`, `(re)allocarray` and replace the dangerous(*) calls like\n\n```\nmem.malloc( n * sizeof(unsigned short *))\n```\n\nby\n\n```\nmem.allocarray(n, sizeof(unsigned short *))\n```\n\n\n(*) the multiplication can overflow.",
    "created_at": "2015-07-08T10:12:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253400",
    "user": "https://github.com/jdemeyer"
}
```

Can you please support all memory-allocation functions, like `calloc`, `realloc`, `(re)allocarray` and replace the dangerous(*) calls like

```
mem.malloc( n * sizeof(unsigned short *))
```

by

```
mem.allocarray(n, sizeof(unsigned short *))
```


(*) the multiplication can overflow.



---

archive/issue_comments_253401.json:
```json
{
    "body": "Also for performance: keep `calloc`, do not replace it with `malloc + memset`.",
    "created_at": "2015-07-08T10:14:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253401",
    "user": "https://github.com/jdemeyer"
}
```

Also for performance: keep `calloc`, do not replace it with `malloc + memset`.



---

archive/issue_comments_253402.json:
```json
{
    "body": "I guess that `realloc(array)` might not be so easy to support, so you can forget about that. But I would certainly support `allocarray` and `calloc`.\n\nAnd I don't understand why you use\n\n```\ncdef void * val = malloc(size)\nif val == NULL:\n    raise MemoryError()\n```\n\ninstead of\n\n```\ncdef void * val = check_malloc(size)\n```\n",
    "created_at": "2015-07-08T10:18:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253402",
    "user": "https://github.com/jdemeyer"
}
```

I guess that `realloc(array)` might not be so easy to support, so you can forget about that. But I would certainly support `allocarray` and `calloc`.

And I don't understand why you use

```
cdef void * val = malloc(size)
if val == NULL:
    raise MemoryError()
```

instead of

```
cdef void * val = check_malloc(size)
```




---

archive/issue_comments_253403.json:
```json
{
    "body": "[1] recommends `PyMem_Malloc, PyMem_Realloc, PyMem_Free` over the system functions. Why do you \nstick with `malloc` etc?",
    "created_at": "2015-07-08T10:25:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253403",
    "user": "https://github.com/dimpase"
}
```

[1] recommends `PyMem_Malloc, PyMem_Realloc, PyMem_Free` over the system functions. Why do you 
stick with `malloc` etc?



---

archive/issue_comments_253404.json:
```json
{
    "body": "More about performance: note that your use of `MemoryAllocator` needs at least 2 extra memory allocation calls compared to not using `MemoryAllocator`: one to allocate the `MemoryAllocator` object and one to allocate the `pointers` member. If you allocate several pointers, it's worse because you again need more additional `realloc()` calls for `pointers.`\n\nTo solve some of these problems, I propose the following: add a small fixed array\n\n```\ncdef void* local_pointers[16]\n```\n\nin the `MemoryAllocator` class and initialize\n\n```\nself.max_size = 16\nself.pointers = self.local_pointers\n```\n\nsuch that you avoid any allocations for `pointers` if you need to store at most 16 pointers (which is the usual case I guess).",
    "created_at": "2015-07-08T10:26:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253404",
    "user": "https://github.com/jdemeyer"
}
```

More about performance: note that your use of `MemoryAllocator` needs at least 2 extra memory allocation calls compared to not using `MemoryAllocator`: one to allocate the `MemoryAllocator` object and one to allocate the `pointers` member. If you allocate several pointers, it's worse because you again need more additional `realloc()` calls for `pointers.`

To solve some of these problems, I propose the following: add a small fixed array

```
cdef void* local_pointers[16]
```

in the `MemoryAllocator` class and initialize

```
self.max_size = 16
self.pointers = self.local_pointers
```

such that you avoid any allocations for `pointers` if you need to store at most 16 pointers (which is the usual case I guess).



---

archive/issue_comments_253405.json:
```json
{
    "body": "Replying to [comment:7 dimpase]:\n> Why do you stick with `malloc` etc?\nIn Sage, you should use absolutely use `sage_malloc` (or `check_malloc`) because it behaves well w.r.t. interrupts!",
    "created_at": "2015-07-08T10:27:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253405",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:7 dimpase]:
> Why do you stick with `malloc` etc?
In Sage, you should use absolutely use `sage_malloc` (or `check_malloc`) because it behaves well w.r.t. interrupts!



---

archive/issue_comments_253406.json:
```json
{
    "body": "More for performance: replace\n\n```\ncdef enlarge_if_needed(self):\n```\n\nby\n\n```\ncdef int enlarge_if_needed(self) except -1:\n```\n",
    "created_at": "2015-07-08T10:28:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253406",
    "user": "https://github.com/jdemeyer"
}
```

More for performance: replace

```
cdef enlarge_if_needed(self):
```

by

```
cdef int enlarge_if_needed(self) except -1:
```




---

archive/issue_comments_253407.json:
```json
{
    "body": "One more detail: replace\n\n```\ncdef int n\ncdef int max_size\n```\n\nby\n\n```\ncdef size_t n\ncdef size_t max_size\n```\n\n(and adjust the loop index in `__dealloc__`) in case I ever need more than 2<sup>31</sup> pointers :-)",
    "created_at": "2015-07-08T10:33:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253407",
    "user": "https://github.com/jdemeyer"
}
```

One more detail: replace

```
cdef int n
cdef int max_size
```

by

```
cdef size_t n
cdef size_t max_size
```

(and adjust the loop index in `__dealloc__`) in case I ever need more than 2<sup>31</sup> pointers :-)



---

archive/issue_comments_253408.json:
```json
{
    "body": "Replying to [comment:9 jdemeyer]:\n> Replying to [comment:7 dimpase]:\n> > Why do you stick with `malloc` etc?\n> In Sage, you should use absolutely use `sage_malloc` (or `check_malloc`) because it behaves well w.r.t. interrupts!\n\nAnd why does `sage_malloc` use `malloc`, and not `PyMem_Malloc`?",
    "created_at": "2015-07-08T11:24:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253408",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:9 jdemeyer]:
> Replying to [comment:7 dimpase]:
> > Why do you stick with `malloc` etc?
> In Sage, you should use absolutely use `sage_malloc` (or `check_malloc`) because it behaves well w.r.t. interrupts!

And why does `sage_malloc` use `malloc`, and not `PyMem_Malloc`?



---

archive/issue_comments_253409.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-07-08T11:35:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253409",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_253410.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-07-08T11:36:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253410",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_253411.json:
```json
{
    "body": "> This `include 'sage/ext/interrupt.pxi'` should be in the .pyx file.\nDone\n\n> For performance, replace \n> `cdef MemoryAllocator mem = MemoryAllocator()`\n> by\n> `cdef MemoryAllocator mem = <MemoryAllocator>MemoryAllocator.__new__(MemoryAllocator)`\n\nMakes no difference in any of the functions I touched, so I did not do it. Less\nreadable.\n\n> Can you please support all memory-allocation functions, like calloc, realloc,\n> (re)allocarray and replace the dangerous(*) calls like\n\nI added support for calloc. I do not need realloc (you can add a commit if you\nneed it).\n\nAbout realloc:\n\n> I guess that realloc(array) might not be so easy to support, so you can forget\n> about that.\n+1\n\n> But I would certainly support allocarray\n\nAdd a commit if you like. My problem with 'allocarray' is that it is Sage's\nterminology (as far as I know), and that I prefer to stick to more widely\nunderstood terms like 'malloc/calloc'. I was just saying to David that we may\neventually move some C graph code away from sage and make it an independent C\nlibrary.\n\n> And I don't understand why you use\n>\n> {{{\n> cdef void * val = malloc(size)\n> if val == NULL:\n>     raise MemoryError()\n> }}}\n> instead of\n> {{{\n> cdef void * val = check_malloc(size)\n> }}}\n\nDone\n\n> [1] recommends PyMem_Malloc, PyMem_Realloc, PyMem_Free over the system\n> functions. Why do you stick with malloc etc?\n\nPersonally, for a simple reason: I trust C functions. Officially, it is for the\nreason Jeroen mentionned. Note that we can satisfy everybody: it is possible to\nhave `sage_malloc` (which behaves properly with respect to interrupts) call your\nfunctions instead of C ones.\n\n> More about performance: note that your use of MemoryAllocator needs at least 2\n> extra memory allocation calls compared to not using MemoryAllocator\n\nThis is not a problem for the codes I touched, for malloc is never a dominant\ncost in any of them. You can add a commit if you like, though please keep the\ncode simple and understandable if you do.\n\n> More for performance: replace\n> `cdef enlarge_if_needed(self):`\n> by\n> `cdef int enlarge_if_needed(self) except -1:`\n\nDone.\n\n> One more detail: replace `int` with `size_t`\nDone.\n\nJeroen, could you send reviews as one big comment rather than adding one every\ntime you notice something? Everybody in Cc receives an email for each comments,\nand it is also a bit harder to address your points:\n\n- One never knows if you are done reading the code or if we can expect a new\n  comment in the next seconds\n\n- Answering your points like I do now is a bit harder: instead of clicking on\n  'reply' (to your comment), I copy/paste all your individual messages into a\n  text file, then start answering them.\n\nThaaaaaaaaanks,\n\nNathann",
    "created_at": "2015-07-08T11:36:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253411",
    "user": "https://github.com/nathanncohen"
}
```

> This `include 'sage/ext/interrupt.pxi'` should be in the .pyx file.
Done

> For performance, replace 
> `cdef MemoryAllocator mem = MemoryAllocator()`
> by
> `cdef MemoryAllocator mem = <MemoryAllocator>MemoryAllocator.__new__(MemoryAllocator)`

Makes no difference in any of the functions I touched, so I did not do it. Less
readable.

> Can you please support all memory-allocation functions, like calloc, realloc,
> (re)allocarray and replace the dangerous(*) calls like

I added support for calloc. I do not need realloc (you can add a commit if you
need it).

About realloc:

> I guess that realloc(array) might not be so easy to support, so you can forget
> about that.
+1

> But I would certainly support allocarray

Add a commit if you like. My problem with 'allocarray' is that it is Sage's
terminology (as far as I know), and that I prefer to stick to more widely
understood terms like 'malloc/calloc'. I was just saying to David that we may
eventually move some C graph code away from sage and make it an independent C
library.

> And I don't understand why you use
>
> {{{
> cdef void * val = malloc(size)
> if val == NULL:
>     raise MemoryError()
> }}}
> instead of
> {{{
> cdef void * val = check_malloc(size)
> }}}

Done

> [1] recommends PyMem_Malloc, PyMem_Realloc, PyMem_Free over the system
> functions. Why do you stick with malloc etc?

Personally, for a simple reason: I trust C functions. Officially, it is for the
reason Jeroen mentionned. Note that we can satisfy everybody: it is possible to
have `sage_malloc` (which behaves properly with respect to interrupts) call your
functions instead of C ones.

> More about performance: note that your use of MemoryAllocator needs at least 2
> extra memory allocation calls compared to not using MemoryAllocator

This is not a problem for the codes I touched, for malloc is never a dominant
cost in any of them. You can add a commit if you like, though please keep the
code simple and understandable if you do.

> More for performance: replace
> `cdef enlarge_if_needed(self):`
> by
> `cdef int enlarge_if_needed(self) except -1:`

Done.

> One more detail: replace `int` with `size_t`
Done.

Jeroen, could you send reviews as one big comment rather than adding one every
time you notice something? Everybody in Cc receives an email for each comments,
and it is also a bit harder to address your points:

- One never knows if you are done reading the code or if we can expect a new
  comment in the next seconds

- Answering your points like I do now is a bit harder: instead of clicking on
  'reply' (to your comment), I copy/paste all your individual messages into a
  text file, then start answering them.

Thaaaaaaaaanks,

Nathann



---

archive/issue_comments_253412.json:
```json
{
    "body": "Replying to [comment:7 dimpase]:\n> [1] recommends `PyMem_Malloc, PyMem_Realloc, PyMem_Free` over the system functions.\n\nWhat is [1]?",
    "created_at": "2015-07-08T11:58:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253412",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:7 dimpase]:
> [1] recommends `PyMem_Malloc, PyMem_Realloc, PyMem_Free` over the system functions.

What is [1]?



---

archive/issue_comments_253413.json:
```json
{
    "body": "Replying to [comment:15 ncohen]:\n> My problem with 'allocarray' is that it is Sage's terminology (as far as I know)\nIt actually comes from BSD, where it was added for security reasons (like I said, the multiplication in `malloc(n * sizeof(foo))` can overflow, a potential security issue). For Sage, it's not so much the \"security\" aspect which is important, but the reliability.",
    "created_at": "2015-07-08T12:01:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253413",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:15 ncohen]:
> My problem with 'allocarray' is that it is Sage's terminology (as far as I know)
It actually comes from BSD, where it was added for security reasons (like I said, the multiplication in `malloc(n * sizeof(foo))` can overflow, a potential security issue). For Sage, it's not so much the "security" aspect which is important, but the reliability.



---

archive/issue_comments_253414.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2015-07-08T12:06:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253414",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_253415.json:
```json
{
    "body": "Replying to [comment:15 ncohen]:\n> You can add a commit if you like, though please keep the\n> code simple and understandable if you do.\n\nI thought that speed was an important reason to invent this new class. If you don't care so much about speed, there are several already-existing alternatives, such as [Cython arrays](http://docs.cython.org/src/userguide/memoryviews.html#cython-arrays).\n\nIf speed is not so much a concern, then why are you reinventing the wheel?",
    "created_at": "2015-07-08T12:06:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253415",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:15 ncohen]:
> You can add a commit if you like, though please keep the
> code simple and understandable if you do.

I thought that speed was an important reason to invent this new class. If you don't care so much about speed, there are several already-existing alternatives, such as [Cython arrays](http://docs.cython.org/src/userguide/memoryviews.html#cython-arrays).

If speed is not so much a concern, then why are you reinventing the wheel?



---

archive/issue_comments_253416.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2015-07-08T12:09:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253416",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_253417.json:
```json
{
    "body": "> I thought that speed was an important reason to invent this new class.\n\nI care about the speed of the algorithm themselves. I need real C arrays. The time it takes to allocate them is not a problem in the graph code.\n\nNathann",
    "created_at": "2015-07-08T12:09:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253417",
    "user": "https://github.com/nathanncohen"
}
```

> I thought that speed was an important reason to invent this new class.

I care about the speed of the algorithm themselves. I need real C arrays. The time it takes to allocate them is not a problem in the graph code.

Nathann



---

archive/issue_comments_253418.json:
```json
{
    "body": "Replying to [comment:15 ncohen]:\n> Makes no difference in any of the functions I touched, so I did not do it. Less\n> readable.\nYou are right. I was confused with *explicit* calls to `__init__` (i.e. `foo.__init__()` should be avoided in Cython).",
    "created_at": "2015-07-08T12:19:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253418",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:15 ncohen]:
> Makes no difference in any of the functions I touched, so I did not do it. Less
> readable.
You are right. I was confused with *explicit* calls to `__init__` (i.e. `foo.__init__()` should be avoided in Cython).



---

archive/issue_comments_253419.json:
```json
{
    "body": "Replying to [comment:16 jdemeyer]:\n> Replying to [comment:7 dimpase]:\n> > [1] recommends `PyMem_Malloc, PyMem_Realloc, PyMem_Free` over the system functions.\n> \n> What is [1]?\n\nsee the ticket description",
    "created_at": "2015-07-08T12:22:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253419",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:16 jdemeyer]:
> Replying to [comment:7 dimpase]:
> > [1] recommends `PyMem_Malloc, PyMem_Realloc, PyMem_Free` over the system functions.
> 
> What is [1]?

see the ticket description



---

archive/issue_comments_253420.json:
```json
{
    "body": "I wonder whether there are ways to avoid syntactic clutter such as\n\n```\ncdef uint32_t * _connected_structure = <uint32_t *> mem.calloc(n * n , sizeof(uint32_t))\n```\n\nYou know, in C such thing would be best written as macro call like\n\n```\nnewdef(_connected_structure, uint32_t, n*n)\n```\n\navoiding mentioning `uint32_t` three times...",
    "created_at": "2015-07-08T12:35:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253420",
    "user": "https://github.com/dimpase"
}
```

I wonder whether there are ways to avoid syntactic clutter such as

```
cdef uint32_t * _connected_structure = <uint32_t *> mem.calloc(n * n , sizeof(uint32_t))
```

You know, in C such thing would be best written as macro call like

```
newdef(_connected_structure, uint32_t, n*n)
```

avoiding mentioning `uint32_t` three times...



---

archive/issue_comments_253421.json:
```json
{
    "body": "> I wonder whether there are ways to avoid syntactic clutter such as\n\n+1 `:-/`\n\nNathann",
    "created_at": "2015-07-08T12:38:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253421",
    "user": "https://github.com/nathanncohen"
}
```

> I wonder whether there are ways to avoid syntactic clutter such as

+1 `:-/`

Nathann



---

archive/issue_comments_253422.json:
```json
{
    "body": "Replying to [comment:19 ncohen]:\n> I need real C arrays. The time it takes to allocate them is not a problem in the graph code.\n\nOK, here is a deal: if you really mean what you say (that you don't care about the time to allocate, just the access time), then I'm pretty sure that your problem can be solved with Cython arrays. A memoryview like `cdef int[::1]` should be as fast as a C pointer.",
    "created_at": "2015-07-08T12:49:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253422",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:19 ncohen]:
> I need real C arrays. The time it takes to allocate them is not a problem in the graph code.

OK, here is a deal: if you really mean what you say (that you don't care about the time to allocate, just the access time), then I'm pretty sure that your problem can be solved with Cython arrays. A memoryview like `cdef int[::1]` should be as fast as a C pointer.



---

archive/issue_comments_253423.json:
```json
{
    "body": "> A memoryview like `cdef int[::1]` should be as fast as a C pointer.\n\nIf your 'should' is a 'is', and if you do not need to replace each pointer allocation by 1) creationg of a Cython object 2) Linking it to the C array then yes. Can you give an example of that? I read your link toward 'Cython arrays' and it seems to have this drawback, i.e. 2 lines per allocation.\n\nNathann",
    "created_at": "2015-07-08T12:53:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253423",
    "user": "https://github.com/nathanncohen"
}
```

> A memoryview like `cdef int[::1]` should be as fast as a C pointer.

If your 'should' is a 'is', and if you do not need to replace each pointer allocation by 1) creationg of a Cython object 2) Linking it to the C array then yes. Can you give an example of that? I read your link toward 'Cython arrays' and it seems to have this drawback, i.e. 2 lines per allocation.

Nathann



---

archive/issue_comments_253424.json:
```json
{
    "body": "Replying to [comment:25 ncohen]:\n> Can you give an example of that?\n\nA created a new ticket #18870 to discuss it.",
    "created_at": "2015-07-08T13:01:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253424",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:25 ncohen]:
> Can you give an example of that?

A created a new ticket #18870 to discuss it.



---

archive/issue_comments_253425.json:
```json
{
    "body": "I looked into #18870 and personally, I don't like it.",
    "created_at": "2015-07-08T13:52:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253425",
    "user": "https://github.com/jdemeyer"
}
```

I looked into #18870 and personally, I don't like it.



---

archive/issue_comments_253426.json:
```json
{
    "body": "Why wouldn't we discuss it with the cython guys? Perhaps they would be willing to provide something we could use?",
    "created_at": "2015-07-08T13:54:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253426",
    "user": "https://github.com/nathanncohen"
}
```

Why wouldn't we discuss it with the cython guys? Perhaps they would be willing to provide something we could use?



---

archive/issue_comments_253427.json:
```json
{
    "body": "Replying to [comment:28 ncohen]:\n> Why wouldn't we discuss it with the cython guys? Perhaps they would be willing to provide something we could use?\n\nsure, why not; also, how about asking them about comment [23](http://trac.sagemath.org/ticket/18868#comment:23) ?",
    "created_at": "2015-07-08T13:58:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253427",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:28 ncohen]:
> Why wouldn't we discuss it with the cython guys? Perhaps they would be willing to provide something we could use?

sure, why not; also, how about asking them about comment [23](http://trac.sagemath.org/ticket/18868#comment:23) ?



---

archive/issue_comments_253428.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-07-08T15:46:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253428",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_253429.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-07-08T18:55:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253429",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_253430.json:
```json
{
    "body": "This is ok for me, but someone needs to review my changes.",
    "created_at": "2015-07-08T18:55:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253430",
    "user": "https://github.com/jdemeyer"
}
```

This is ok for me, but someone needs to review my changes.



---

archive/issue_comments_253431.json:
```json
{
    "body": "still, how about `PyMem_Malloc, PyMem_Realloc, PyMem_Free`, as mentioned in  http://docs.cython.org/src/tutorial/memory_allocation.html ?\n\nApart from performance, there could be advantages in sense of debugging, as one can \n`./configure` Python with `--with-pydebug` to catch memory errors...",
    "created_at": "2015-07-09T10:42:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253431",
    "user": "https://github.com/dimpase"
}
```

still, how about `PyMem_Malloc, PyMem_Realloc, PyMem_Free`, as mentioned in  http://docs.cython.org/src/tutorial/memory_allocation.html ?

Apart from performance, there could be advantages in sense of debugging, as one can 
`./configure` Python with `--with-pydebug` to catch memory errors...



---

archive/issue_comments_253432.json:
```json
{
    "body": "Replying to [comment:33 dimpase]:\n> still, how about `PyMem_Malloc, PyMem_Realloc, PyMem_Free`, as mentioned in  http://docs.cython.org/src/tutorial/memory_allocation.html ?\n\nIn any case, that's independent of this ticket.\n\nSecond, `sage_malloc()` can be called without the GIL. I guess `PyMem_Malloc` cannot...",
    "created_at": "2015-07-09T11:11:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253432",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:33 dimpase]:
> still, how about `PyMem_Malloc, PyMem_Realloc, PyMem_Free`, as mentioned in  http://docs.cython.org/src/tutorial/memory_allocation.html ?

In any case, that's independent of this ticket.

Second, `sage_malloc()` can be called without the GIL. I guess `PyMem_Malloc` cannot...



---

archive/issue_comments_253433.json:
```json
{
    "body": "Third, Python's memory allocator does not support `calloc()` or `allocarray()`, two very useful functions.\n\nAnd if you're speaking about performance, recall that `malloc()` + `memset()` is slower than `calloc()`.",
    "created_at": "2015-07-09T11:18:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253433",
    "user": "https://github.com/jdemeyer"
}
```

Third, Python's memory allocator does not support `calloc()` or `allocarray()`, two very useful functions.

And if you're speaking about performance, recall that `malloc()` + `memset()` is slower than `calloc()`.



---

archive/issue_comments_253434.json:
```json
{
    "body": "Can somebody review this please?",
    "created_at": "2015-07-17T10:33:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253434",
    "user": "https://github.com/jdemeyer"
}
```

Can somebody review this please?



---

archive/issue_comments_253435.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-07-17T11:20:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253435",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_253436.json:
```json
{
    "body": "Your were faster than me.\nI can at least confirm that all long tests pass on `src/sage/graphs/`.\nDavid.",
    "created_at": "2015-07-17T11:23:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253436",
    "user": "https://github.com/dcoudert"
}
```

Your were faster than me.
I can at least confirm that all long tests pass on `src/sage/graphs/`.
David.



---

archive/issue_comments_253437.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. Last 10 new commits:",
    "created_at": "2015-07-24T09:40:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253437",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. Last 10 new commits:



---

archive/issue_comments_253438.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2015-07-24T09:40:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253438",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_253439.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-07-24T09:41:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253439",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_253440.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2015-07-28T18:42:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253440",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_253441.json:
```json
{
    "body": "Conflict with #18868",
    "created_at": "2015-07-28T18:42:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253441",
    "user": "https://github.com/vbraun"
}
```

Conflict with #18868



---

archive/issue_events_017814.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-07-28T22:47:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18631#event-17814"
}
```



---

archive/issue_comments_253442.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-07-28T22:47:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18631",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18631#issuecomment-253442",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
