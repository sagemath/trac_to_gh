# Issue 17449: computel.gp: "unable to start pari because the command 'gp --emacs --quiet --stacksize 10000000' failed"

Issue created by migration from https://trac.sagemath.org/ticket/17686

Original creator: alexc

Original creation time: 2015-01-29 00:16:09

I get the following error after a runtime of several minutes. If I change parts of my code, the error occurs in different places. Running just snippets of the code does not produce the error. I'm running sage 6.4 on a fresh installation of Ubuntu 14.04 64bit on a fairly powerful computer.

The only previous mention of this error that I could find is http://trac.sagemath.org/ticket/9866.

Can anyone suggest workarounds?

Let me know what additional information I can provide to help.


```
Traceback (most recent call last):
  File "RHS.py", line 275, in DokchitserDirichlet
    L.init_coeffs('chi(k)', 1, 'conj(chi(k))', pari_precode=pari_precode)
  File "/home/blatm/sage/sage-6.4.1-x86_64-Linux1404/local/lib/python2.7/site-packages/sage/lfunctions/dokchitser.py", line 340, in init_coeffs
    gp = self.gp()
  File "/home/blatm/sage/sage-6.4.1-x86_64-Linux1404/local/lib/python2.7/site-packages/sage/lfunctions/dokchitser.py", line 225, in gp
    g.read('computel.gp')
  File "/home/blatm/sage/sage-6.4.1-x86_64-Linux1404/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 634, in read
    self.eval(self._read_in_file_command(filename))
  File "/home/blatm/sage/sage-6.4.1-x86_64-Linux1404/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1223, in eval
    for L in code.split('\n') if L != ''])
  File "/home/blatm/sage/sage-6.4.1-x86_64-Linux1404/local/lib/python2.7/site-packages/sage/interfaces/gp.py", line 400, in _eval_line
    wait_for_prompt=wait_for_prompt)
  File "/home/blatm/sage/sage-6.4.1-x86_64-Linux1404/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 817, in _eval_line
    self._start()
  File "/home/blatm/sage/sage-6.4.1-x86_64-Linux1404/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 432, in _start
    self.name(), cmd, self._install_hints()))
RuntimeError: unable to start pari because the command 'gp --emacs --quiet --stacksize 10000000' failed

Exception RuntimeError: RuntimeError('sys.path must be a list of directory names',) in <bound method Dokchitser.__del__ of Dokchitser L-series of conductor 7 and weight 1> ignored
```



---

Comment by jdemeyer created at 2015-01-29 06:31:57

Replying to [ticket:17686 alexc]:
> Let me know what additional information I can provide to help.
A reproducible example...


---

Attachment

Example


---

Comment by alexc created at 2015-01-30 05:30:28

Replying to [comment:1 jdemeyer]:
> Replying to [ticket:17686 alexc]:
> > Let me know what additional information I can provide to help.
> A reproducible example...

I've attached a program which produces the error. The program fails after count = 160 for me.


---

Comment by jdemeyer created at 2015-01-30 11:30:37

Changing component from number theory to interfaces.


---

Comment by jdemeyer created at 2015-02-02 22:02:44

New commits:


---

Comment by jdemeyer created at 2015-02-02 22:02:44

Changing status from new to needs_review.


---

Comment by git created at 2015-02-03 11:31:32

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by rws created at 2015-02-25 16:20:37

Changing status from needs_review to needs_work.


---

Comment by rws created at 2015-02-25 16:20:37

With #17718 merged:

```
sage -t --long src/sage/interfaces/sagespawn.pyx  # 2 doctests failed
sage -t --long src/sage/interfaces/quit.py  # 1 doctest failed
```



---

Comment by git created at 2015-02-25 17:13:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-02-25 17:14:20

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-02-25 17:14:20

Merged #17718 and latest `develop`. I also trivially fixed the `quit.py` failure but I don't get any failures in `sagespawn.pyx`. Can you try again and post the details of the failure if they still occur?


---

Comment by rws created at 2015-02-26 06:43:37

Yes, `quit.py` is fine but I still get this twice:

```
File "src/sage/interfaces/sagespawn.pyx", line 69, in sage.interfaces.sagespawn.SageSpawn.__repr__
Failed example:
    s  # indirect doctest
Expected:
    stupid process with PID ... running /bin/true
Got:
    stupid process with PID 3742 running /usr/bin/true
```



---

Comment by git created at 2015-02-26 08:47:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2015-02-28 14:27:38

Patchbot says tests are fine, whines about startup time, but on my machine there is no change. My Unix programming doesn't suffice for a code review, however.


---

Comment by git created at 2015-03-02 14:59:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2015-05-07 09:28:40

doesn't merge cleanly againts the latest 6.7.beta4:

```
CONFLICT (content): Merge conflict in src/doc/en/reference/interfaces/index.rst
```

can this be rebased?


---

Comment by jdemeyer created at 2015-05-07 09:39:37

Replying to [comment:17 dimpase]:
> doesn't merge cleanly againts the latest 6.7.beta4:
> {{{
> CONFLICT (content): Merge conflict in src/doc/en/reference/interfaces/index.rst
> }}}
> can this be rebased?
Will it be reviewed then?


---

Comment by dimpase created at 2015-05-07 09:51:28

Replying to [comment:18 jdemeyer]:
> Replying to [comment:17 dimpase]:
> > doesn't merge cleanly againts the latest 6.7.beta4:
> > {{{
> > CONFLICT (content): Merge conflict in src/doc/en/reference/interfaces/index.rst
> > }}}
> > can this be rebased?
> Will it be reviewed then?

I will do my best.


---

Comment by git created at 2015-05-08 08:03:21

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by malb created at 2015-05-21 08:55:48

Why is `SageSpawn` written in Cython? Reading over it, I couldn't find a reason, which probably just means I missed it.


---

Comment by jdemeyer created at 2015-05-21 09:01:01

Replying to [comment:21 malb]:
> Why is `SageSpawn` written in Cython?
1. it uses various system calls (of course, you could argue about using Python's `os` module but I think directly using system calls is better).
2. it needs `Py_INCREF()` which cannot be done in pure Python.


---

Comment by malb created at 2015-05-21 10:20:18

Thanks for explaining, that makes sense.


---

Comment by git created at 2015-05-27 08:21:46

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-05-29 20:05:05

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vbraun created at 2015-06-17 12:03:21

The original spawn class checks `self.closed` in the dtor:

```
    def __del__(self):
        if self.closed:
            return
        try:
            self.close()
        except:
            pass
```

So why not just set that flag in `_keep_alive`? Or is there another resource managed by an attribute with a non-trivial dtor? This seems better than keeping the spawn instance alive forever... maybe I'm missing something?


---

Comment by jdemeyer created at 2015-06-17 12:29:47

Replying to [comment:27 vbraun]:
> So why not just set that flag in `_keep_alive`? Or is there another resource managed by an attribute with a non-trivial dtor? This seems better than keeping the spawn instance alive forever... maybe I'm missing something?

`Py_INCREF(self)` makes no assumptions on how `pexpect.spawn` works internally. Setting `self.closed` would work currently, but it would for example break with a newer version of `pexpect`.


---

Comment by vbraun created at 2015-06-17 17:36:52

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-06-17 20:08:42

Fails on OSX:

```
sage -t --long src/sage/interfaces/expect.py  # 26 doctests failed
sage -t --long src/sage/interfaces/gap.py  # 95 doctests failed
sage -t --long src/sage/interfaces/mwrank.py  # 6 doctests failed
```



---

Comment by vbraun created at 2015-06-17 20:08:42

Changing status from positive_review to needs_work.


---

Comment by git created at 2015-06-18 08:49:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-06-18 08:51:31

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2015-06-18 14:07:56

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-06-18 20:27:34

I got this (with #17924, only randomly fails)

```
sage -t --long src/sage/interfaces/sagespawn.pyx
**********************************************************************
File "src/sage/interfaces/sagespawn.pyx", line 125, in sage.interfaces.sagespawn.SageSpawn.close
Failed example:
    while s.isalive():  # long time (5 seconds)
        sleep(0.1)
Exception raised:
    Traceback (most recent call last):
      File "/home/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.sagespawn.SageSpawn.close[3]>", line 1, in <module>
        while s.isalive():  # long time (5 seconds)
      File "/home/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/pexpect.py", line 762, in isalive
        pid, status = os.waitpid(self.pid, waitpid_options)
      File "sage/ext/interrupt/interrupt.pyx", line 197, in sage.ext.interrupt.interrupt.sage_python_check_interrupt (/home/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/ext/interrupt/interrupt.c:1743)
        sig_check()
      File "sage/ext/interrupt/interrupt.pyx", line 86, in sage.ext.interrupt.interrupt.sig_raise_exception (/home/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/ext/interrupt/interrupt.c:884)
        raise KeyboardInterrupt
    KeyboardInterrupt
**********************************************************************
1 item had failures:
   1 of   5 in sage.interfaces.sagespawn.SageSpawn.close
    [24 tests, 1 failure, 5.08 s]
```



---

Comment by jdemeyer created at 2015-06-19 08:03:32

Replying to [comment:34 vbraun]:
> I got this (with #17924, only randomly fails)

On which machine?

This is probably yet another race condition: it looks like we are killing the process group of the child process when it has not yet created a new process group. So, we end up killing ourselves.


---

Comment by vbraun created at 2015-06-19 08:24:31

That was on arando. I'm going to close this ticket and leave the remaining race to you, then ;-)


---

Comment by vbraun created at 2015-06-19 08:25:05

Resolution: fixed


---

Comment by vbraun created at 2015-06-19 22:24:21

Followup at #18741
