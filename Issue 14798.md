# Issue 14798: removing redundant set/iter conversions in graph backend

Issue created by migration from Trac.

Original creator: slani

Original creation time: 2013-08-11 16:42:22

CC:  ncohen azi

Hello,

this patch speeds up neighbor iterator method when the original graph is not directed. The speed up is achieved by removing unnecessary set conversions in the graph backend.
(as seen on a figure in ticket [http://trac.sagemath.org/ticket/13730](http://trac.sagemath.org/ticket/13730).)

Before:

```
sage: G = graphs.RandomBarabasiAlbert(1000,2)
sage: %timeit E = [(u,v) for u in G for v in G.neighbor_iterator(u)]
100 loops, best of 3: 7.8 ms per loop

```


After:

```
sage: G = graphs.RandomBarabasiAlbert(10**6,2)
sage: %timeit E = [(u,v) for u in G for v in G.neighbor_iterator(u)]
100 loops, best of 3: 3.58 ms per loop

```



---

Attachment

Hello!

I have discussed this with slani, reviewed it and tested it. I think the patch is good to go and would like to give it a positive review, but I give you (Nathann) the last word on this!

What do you think?


---

Comment by ncohen created at 2013-08-12 09:25:49

Changing status from new to needs_review.


---

Comment by ncohen created at 2013-08-12 09:25:49

Well `O_O`

I was worried that removing this "iter(set(" would create problems with multiple edges, but the code from sparse_graph already avoids that... `:-P`

I would say "good to go", while crossing my fingers with the hope that no code which is not doctested will be reported as broken in a couple of weeks `:-P`

Did you run the tests on the whole Sage library ? Some guys create weird graphs outside of the graph/ folder, and there may be changes to make there too.

Nathann


---

Comment by ncohen created at 2013-08-12 09:25:49

Changing type from PLEASE CHANGE to enhancement.


---

Comment by azi created at 2013-08-12 11:36:57

Yes, we've made sure that at least the default backend does not return duplicated neighbors in case of multiple edges.

I've now also ran the tests on the whole library. A bunch of things fails but none appears to be relate to the change of this patch :-)




```
sage -t sage-5.10.beta1/devel/sage/sage/tests/cmdline.py  # 3 doctests failed
sage -t sage-5.10.beta1/devel/sage/sage/stats/r.py  # 1 doctest failed
sage -t sage-5.10.beta1/devel/sage/sage/misc/sageinspect.py  # 1 doctest failed
sage -t sage-5.10.beta1/devel/sage/sage/misc/interpreter.py  # 2 doctests failed
sage -t sage-5.10.beta1/devel/sage/sage/interfaces/interface.py  # 4 doctests failed
sage -t sage-5.10.beta1/devel/sage/sage/interfaces/r.py  # 186 doctests failed
sage -t sage-5.10.beta1/devel/sage/sage/interfaces/expect.py  # 7 doctests failed
sage -t sage-5.10.beta1/devel/sage/sage/modular/hecke/ambient_module.py  # 1 doctest failed
sage -t sage-5.10.beta1/devel/sage/sage/modular/hecke/hecke_operator.py  # Killed due to segmentation fault
sage -t sage-5.10.beta1/devel/sage/sage/modular/modsym/ambient.py  # 2 doctests failed
```



That said I'll mark this with a positive review and add the relevant ticket information.


---

Comment by azi created at 2013-08-12 11:37:33

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-08-20 13:27:31

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-08-20 13:27:31

This needs to be rebased to sage-5.12.beta2.


---

Comment by ncohen created at 2013-08-20 16:31:57

I just rebased this patch and oddly, when it is applied the doctest 


```
    sage: g = graphs.JohnsonGraph(7, 3)
    sage: g.is_hamiltonian()
```


from `generators/families.py` takes forever `O_o`

Nathann


---

Comment by azi created at 2013-08-20 18:28:36

And you're sure it's because of this patch?


---

Comment by slani created at 2013-08-27 23:48:07

Hello!

I rebased this patch to sage-5.12.beta3 and it passes all graph tests.

Best,

Uros

P.S.
It's also works for hamiltonian cycle test.


```
sage: g = graphs.JohnsonGraph(7, 3)
sage: %timeit g.is_hamiltonian()
10 loops, best of 3: 50.9 ms per loop
```



---

Attachment


---

Comment by slani created at 2013-08-27 23:50:00

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2013-08-28 09:19:26

Well... Of course it was still hanging on my computer, and a couple of hours later I now have a patch fixing the `traveling_salesman` method which had a problem with those f.... non-integer vertices `>_<`

If you agree with this additional patch you can set the ticket to `positive_review`.

Nathann


---

Attachment


---

Comment by slani created at 2013-08-28 09:58:25

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-08-29 08:52:09

Which patch(es) need to be applied?


---

Comment by ncohen created at 2013-08-29 08:57:38

Sorryyyyyyyyyyyyyyyyyyyyyy !!!

Apply nbrspeedup_5_12beta3.patch, trac_15035-rev.patchâ€‹


---

Comment by jdemeyer created at 2013-09-02 10:25:24

Resolution: fixed
