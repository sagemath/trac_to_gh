# Issue 14798: removing redundant set/iter conversions in graph backend

archive/issues_014798.json:
```json
{
    "body": "CC:  @nathanncohen azi\n\nHello,\n\nthis patch speeds up neighbor iterator method when the original graph is not directed. The speed up is achieved by removing unnecessary set conversions in the graph backend.\n(as seen on a figure in ticket [http://trac.sagemath.org/ticket/13730](http://trac.sagemath.org/ticket/13730).)\n\nBefore:\n\n```\nsage: G = graphs.RandomBarabasiAlbert(1000,2)\nsage: %timeit E = [(u,v) for u in G for v in G.neighbor_iterator(u)]\n100 loops, best of 3: 7.8 ms per loop\n\n```\n\n\nAfter:\n\n```\nsage: G = graphs.RandomBarabasiAlbert(10**6,2)\nsage: %timeit E = [(u,v) for u in G for v in G.neighbor_iterator(u)]\n100 loops, best of 3: 3.58 ms per loop\n\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/15035\n\n",
    "created_at": "2013-08-11T16:42:22Z",
    "labels": [
        "graph theory",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.12",
    "title": "removing redundant set/iter conversions in graph backend",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14798",
    "user": "@lobiCode"
}
```
CC:  @nathanncohen azi

Hello,

this patch speeds up neighbor iterator method when the original graph is not directed. The speed up is achieved by removing unnecessary set conversions in the graph backend.
(as seen on a figure in ticket [http://trac.sagemath.org/ticket/13730](http://trac.sagemath.org/ticket/13730).)

Before:

```
sage: G = graphs.RandomBarabasiAlbert(1000,2)
sage: %timeit E = [(u,v) for u in G for v in G.neighbor_iterator(u)]
100 loops, best of 3: 7.8 ms per loop

```


After:

```
sage: G = graphs.RandomBarabasiAlbert(10**6,2)
sage: %timeit E = [(u,v) for u in G for v in G.neighbor_iterator(u)]
100 loops, best of 3: 3.58 ms per loop

```


Issue created by migration from https://trac.sagemath.org/ticket/15035





---

archive/issue_comments_188710.json:
```json
{
    "body": "Attachment [nbrspeedup.patch](tarball://root/attachments/some-uuid/ticket15035/nbrspeedup.patch) by azi created at 2013-08-11 18:43:29\n\nHello!\n\nI have discussed this with slani, reviewed it and tested it. I think the patch is good to go and would like to give it a positive review, but I give you (Nathann) the last word on this!\n\nWhat do you think?",
    "created_at": "2013-08-11T18:43:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14798#issuecomment-188710",
    "user": "azi"
}
```

Attachment [nbrspeedup.patch](tarball://root/attachments/some-uuid/ticket15035/nbrspeedup.patch) by azi created at 2013-08-11 18:43:29

Hello!

I have discussed this with slani, reviewed it and tested it. I think the patch is good to go and would like to give it a positive review, but I give you (Nathann) the last word on this!

What do you think?



---

archive/issue_comments_188711.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-08-12T09:25:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14798#issuecomment-188711",
    "user": "@nathanncohen"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_188712.json:
```json
{
    "body": "Well `O_O`\n\nI was worried that removing this \"iter(set(\" would create problems with multiple edges, but the code from sparse_graph already avoids that... `:-P`\n\nI would say \"good to go\", while crossing my fingers with the hope that no code which is not doctested will be reported as broken in a couple of weeks `:-P`\n\nDid you run the tests on the whole Sage library ? Some guys create weird graphs outside of the graph/ folder, and there may be changes to make there too.\n\nNathann",
    "created_at": "2013-08-12T09:25:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14798#issuecomment-188712",
    "user": "@nathanncohen"
}
```

Well `O_O`

I was worried that removing this "iter(set(" would create problems with multiple edges, but the code from sparse_graph already avoids that... `:-P`

I would say "good to go", while crossing my fingers with the hope that no code which is not doctested will be reported as broken in a couple of weeks `:-P`

Did you run the tests on the whole Sage library ? Some guys create weird graphs outside of the graph/ folder, and there may be changes to make there too.

Nathann



---

archive/issue_comments_188713.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2013-08-12T09:25:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14798#issuecomment-188713",
    "user": "@nathanncohen"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_188714.json:
```json
{
    "body": "Yes, we've made sure that at least the default backend does not return duplicated neighbors in case of multiple edges.\n\nI've now also ran the tests on the whole library. A bunch of things fails but none appears to be relate to the change of this patch :-)\n\n\n\n\n```\nsage -t sage-5.10.beta1/devel/sage/sage/tests/cmdline.py  # 3 doctests failed\nsage -t sage-5.10.beta1/devel/sage/sage/stats/r.py  # 1 doctest failed\nsage -t sage-5.10.beta1/devel/sage/sage/misc/sageinspect.py  # 1 doctest failed\nsage -t sage-5.10.beta1/devel/sage/sage/misc/interpreter.py  # 2 doctests failed\nsage -t sage-5.10.beta1/devel/sage/sage/interfaces/interface.py  # 4 doctests failed\nsage -t sage-5.10.beta1/devel/sage/sage/interfaces/r.py  # 186 doctests failed\nsage -t sage-5.10.beta1/devel/sage/sage/interfaces/expect.py  # 7 doctests failed\nsage -t sage-5.10.beta1/devel/sage/sage/modular/hecke/ambient_module.py  # 1 doctest failed\nsage -t sage-5.10.beta1/devel/sage/sage/modular/hecke/hecke_operator.py  # Killed due to segmentation fault\nsage -t sage-5.10.beta1/devel/sage/sage/modular/modsym/ambient.py  # 2 doctests failed\n```\n\n\n\nThat said I'll mark this with a positive review and add the relevant ticket information.",
    "created_at": "2013-08-12T11:36:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14798#issuecomment-188714",
    "user": "azi"
}
```

Yes, we've made sure that at least the default backend does not return duplicated neighbors in case of multiple edges.

I've now also ran the tests on the whole library. A bunch of things fails but none appears to be relate to the change of this patch :-)




```
sage -t sage-5.10.beta1/devel/sage/sage/tests/cmdline.py  # 3 doctests failed
sage -t sage-5.10.beta1/devel/sage/sage/stats/r.py  # 1 doctest failed
sage -t sage-5.10.beta1/devel/sage/sage/misc/sageinspect.py  # 1 doctest failed
sage -t sage-5.10.beta1/devel/sage/sage/misc/interpreter.py  # 2 doctests failed
sage -t sage-5.10.beta1/devel/sage/sage/interfaces/interface.py  # 4 doctests failed
sage -t sage-5.10.beta1/devel/sage/sage/interfaces/r.py  # 186 doctests failed
sage -t sage-5.10.beta1/devel/sage/sage/interfaces/expect.py  # 7 doctests failed
sage -t sage-5.10.beta1/devel/sage/sage/modular/hecke/ambient_module.py  # 1 doctest failed
sage -t sage-5.10.beta1/devel/sage/sage/modular/hecke/hecke_operator.py  # Killed due to segmentation fault
sage -t sage-5.10.beta1/devel/sage/sage/modular/modsym/ambient.py  # 2 doctests failed
```



That said I'll mark this with a positive review and add the relevant ticket information.



---

archive/issue_comments_188715.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-08-12T11:37:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14798#issuecomment-188715",
    "user": "azi"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_188716.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2013-08-20T13:27:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14798#issuecomment-188716",
    "user": "@jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_188717.json:
```json
{
    "body": "This needs to be rebased to sage-5.12.beta2.",
    "created_at": "2013-08-20T13:27:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14798#issuecomment-188717",
    "user": "@jdemeyer"
}
```

This needs to be rebased to sage-5.12.beta2.



---

archive/issue_comments_188718.json:
```json
{
    "body": "I just rebased this patch and oddly, when it is applied the doctest \n\n\n```\n    sage: g = graphs.JohnsonGraph(7, 3)\n    sage: g.is_hamiltonian()\n```\n\n\nfrom `generators/families.py` takes forever `O_o`\n\nNathann",
    "created_at": "2013-08-20T16:31:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14798#issuecomment-188718",
    "user": "@nathanncohen"
}
```

I just rebased this patch and oddly, when it is applied the doctest 


```
    sage: g = graphs.JohnsonGraph(7, 3)
    sage: g.is_hamiltonian()
```


from `generators/families.py` takes forever `O_o`

Nathann



---

archive/issue_comments_188719.json:
```json
{
    "body": "And you're sure it's because of this patch?",
    "created_at": "2013-08-20T18:28:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14798#issuecomment-188719",
    "user": "azi"
}
```

And you're sure it's because of this patch?



---

archive/issue_comments_188720.json:
```json
{
    "body": "Hello!\n\nI rebased this patch to sage-5.12.beta3 and it passes all graph tests.\n\nBest,\n\nUros\n\nP.S.\nIt's also works for hamiltonian cycle test.\n\n\n```\nsage: g = graphs.JohnsonGraph(7, 3)\nsage: %timeit g.is_hamiltonian()\n10 loops, best of 3: 50.9 ms per loop\n```\n",
    "created_at": "2013-08-27T23:48:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14798#issuecomment-188720",
    "user": "@lobiCode"
}
```

Hello!

I rebased this patch to sage-5.12.beta3 and it passes all graph tests.

Best,

Uros

P.S.
It's also works for hamiltonian cycle test.


```
sage: g = graphs.JohnsonGraph(7, 3)
sage: %timeit g.is_hamiltonian()
10 loops, best of 3: 50.9 ms per loop
```




---

archive/issue_comments_188721.json:
```json
{
    "body": "Attachment [nbrspeedup_5_12beta3.patch](tarball://root/attachments/some-uuid/ticket15035/nbrspeedup_5_12beta3.patch) by @lobiCode created at 2013-08-27 23:50:00",
    "created_at": "2013-08-27T23:50:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14798#issuecomment-188721",
    "user": "@lobiCode"
}
```

Attachment [nbrspeedup_5_12beta3.patch](tarball://root/attachments/some-uuid/ticket15035/nbrspeedup_5_12beta3.patch) by @lobiCode created at 2013-08-27 23:50:00



---

archive/issue_comments_188722.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-08-27T23:50:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14798#issuecomment-188722",
    "user": "@lobiCode"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_188723.json:
```json
{
    "body": "Well... Of course it was still hanging on my computer, and a couple of hours later I now have a patch fixing the `traveling_salesman` method which had a problem with those f.... non-integer vertices `>_<`\n\nIf you agree with this additional patch you can set the ticket to `positive_review`.\n\nNathann",
    "created_at": "2013-08-28T09:19:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14798#issuecomment-188723",
    "user": "@nathanncohen"
}
```

Well... Of course it was still hanging on my computer, and a couple of hours later I now have a patch fixing the `traveling_salesman` method which had a problem with those f.... non-integer vertices `>_<`

If you agree with this additional patch you can set the ticket to `positive_review`.

Nathann



---

archive/issue_comments_188724.json:
```json
{
    "body": "Attachment [trac_15035-rev.patch](tarball://root/attachments/some-uuid/ticket15035/trac_15035-rev.patch) by @nathanncohen created at 2013-08-28 09:22:41",
    "created_at": "2013-08-28T09:22:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14798#issuecomment-188724",
    "user": "@nathanncohen"
}
```

Attachment [trac_15035-rev.patch](tarball://root/attachments/some-uuid/ticket15035/trac_15035-rev.patch) by @nathanncohen created at 2013-08-28 09:22:41



---

archive/issue_comments_188725.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-08-28T09:58:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14798#issuecomment-188725",
    "user": "@lobiCode"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_188726.json:
```json
{
    "body": "Which patch(es) need to be applied?",
    "created_at": "2013-08-29T08:52:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14798#issuecomment-188726",
    "user": "@jdemeyer"
}
```

Which patch(es) need to be applied?



---

archive/issue_comments_188727.json:
```json
{
    "body": "Sorryyyyyyyyyyyyyyyyyyyyyy !!!\n\nApply nbrspeedup_5_12beta3.patch, trac_15035-rev.patch\u200b",
    "created_at": "2013-08-29T08:57:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14798#issuecomment-188727",
    "user": "@nathanncohen"
}
```

Sorryyyyyyyyyyyyyyyyyyyyyy !!!

Apply nbrspeedup_5_12beta3.patch, trac_15035-rev.patch​



---

archive/issue_comments_188728.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-09-02T10:25:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14798",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14798#issuecomment-188728",
    "user": "@jdemeyer"
}
```

Resolution: fixed
