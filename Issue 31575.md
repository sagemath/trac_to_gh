# Issue 31575: Bug in polygons3d and IndexFaceSet

archive/issues_031575.json:
```json
{
    "body": "CC:  @jcamp0x2a @mkoeppe @paulmasson @slel\n\n`polygons3d` calls `sage.plot.plot3d.index_face_set.IndexFaceSetIndexFaceSet`, which should show the same graphic as calling `polygon3d` repeatedly.\n\n```\nsage: points = [(0, 0, 0), (1, 0, 0), (-1, 0, 0), (0, 0, 1), (0, 1, 0), (1, 0, 1), (1, 1, 0), (-1, 0, 1), \n....: (-1, 1, 0)]                                                                                         \nsage: faces = [[3, 0, 1, 5], [0, 4, 6, 1], [3, 0, 2, 7], [0, 4, 8, 2]]                                    \nsage: polygons3d(faces, points, color='blue')                                \nGraphics3d Object\n```\n\nThis gives all black faces, instead of blue. It is different than\n\n```\nsage: sum(polygon3d([points[i] for i in face], color='blue') for face in faces)\nGraphics3d Object\n```\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/31812\n\n",
    "created_at": "2021-05-11T09:22:27Z",
    "labels": [
        "component: graphics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Bug in polygons3d and IndexFaceSet",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31575",
    "user": "https://github.com/yuan-zhou"
}
```
CC:  @jcamp0x2a @mkoeppe @paulmasson @slel

`polygons3d` calls `sage.plot.plot3d.index_face_set.IndexFaceSetIndexFaceSet`, which should show the same graphic as calling `polygon3d` repeatedly.

```
sage: points = [(0, 0, 0), (1, 0, 0), (-1, 0, 0), (0, 0, 1), (0, 1, 0), (1, 0, 1), (1, 1, 0), (-1, 0, 1), 
....: (-1, 1, 0)]                                                                                         
sage: faces = [[3, 0, 1, 5], [0, 4, 6, 1], [3, 0, 2, 7], [0, 4, 8, 2]]                                    
sage: polygons3d(faces, points, color='blue')                                
Graphics3d Object
```

This gives all black faces, instead of blue. It is different than

```
sage: sum(polygon3d([points[i] for i in face], color='blue') for face in faces)
Graphics3d Object
```



Issue created by migration from https://trac.sagemath.org/ticket/31812





---

archive/issue_comments_450640.json:
```json
{
    "body": "works for me (with the default viewer) - it's blue.",
    "created_at": "2021-05-11T18:04:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31575#issuecomment-450640",
    "user": "https://github.com/mkoeppe"
}
```

works for me (with the default viewer) - it's blue.



---

archive/issue_comments_450641.json:
```json
{
    "body": "\n```\npolygons3d(faces, points, color='blue')\n```\n\nall black faces, but \n\n```\npolygons3d(faces, points, color='blue', viewer='jmol')\n```\n\nall blue",
    "created_at": "2021-05-11T18:50:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31575#issuecomment-450641",
    "user": "https://github.com/sheerluck"
}
```


```
polygons3d(faces, points, color='blue')
```

all black faces, but 

```
polygons3d(faces, points, color='blue', viewer='jmol')
```

all blue



---

archive/issue_comments_450642.json:
```json
{
    "body": "Replying to [comment:2 gh-sheerluck]:\n> {{{\n> polygons3d(faces, points, color='blue')\n> }}}\n> all black faces, but \n> {{{\n> polygons3d(faces, points, color='blue', viewer='jmol')\n> }}}\n> all blue\nSame behavior here.\n \nBlue with `viewer='jmol'` or `'tachyon'` but black with default `viewer='threejs'`.\n\nMysteriously, if I call `viewer='threejs'` after `viewer='jmol'` was used, then it shows blue.\n\n```\np = polygons3d(faces, points, color='blue')\np.show()   # default is threejs, black\np.show(viewer='jmol') # blue\np.show(viewer='threejs') # now this mysteriously becomes blue\n```\n\nIn any case, this is not a bug in `polygons3d` or `IndexFaceSet` then.",
    "created_at": "2021-05-11T20:46:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31575#issuecomment-450642",
    "user": "https://github.com/yuan-zhou"
}
```

Replying to [comment:2 gh-sheerluck]:
> {{{
> polygons3d(faces, points, color='blue')
> }}}
> all black faces, but 
> {{{
> polygons3d(faces, points, color='blue', viewer='jmol')
> }}}
> all blue
Same behavior here.
 
Blue with `viewer='jmol'` or `'tachyon'` but black with default `viewer='threejs'`.

Mysteriously, if I call `viewer='threejs'` after `viewer='jmol'` was used, then it shows blue.

```
p = polygons3d(faces, points, color='blue')
p.show()   # default is threejs, black
p.show(viewer='jmol') # blue
p.show(viewer='threejs') # now this mysteriously becomes blue
```

In any case, this is not a bug in `polygons3d` or `IndexFaceSet` then.



---

archive/issue_comments_450643.json:
```json
{
    "body": "cc-ing three.js experts",
    "created_at": "2021-05-11T21:48:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31575#issuecomment-450643",
    "user": "https://github.com/slel"
}
```

cc-ing three.js experts



---

archive/issue_comments_450644.json:
```json
{
    "body": "I think the reason using `viewer='jmol'` first fixes it is because the `IndexFaceSet.jmol_repr` method has [a side effect](https://github.com/sagemath/sage/blob/d6c5cd9be78cc448ee4c54bac93385b1244a234c/src/sage/plot/plot3d/index_face_set.pyx#L1517), defined [here](https://github.com/sagemath/sage/blob/d6c5cd9be78cc448ee4c54bac93385b1244a234c/src/sage/plot/plot3d/index_face_set.pyx#L509). Looks like it duplicates vertices so that each face has its own unique set, similar to what you get summing polygon3d, which also shows the correct color.\n\nI'm not sure why the `polygons3d` version is showing up all black, though. The color is being passed to the template correctly. Interestingly, while rotating the camera around in Edge, it will occasionally flash the correct color blue for a split second. Doesn't happen in Firefox. Also, using `threejs_flat_shading=True` fixes it, so perhaps something related to lighting/normals?",
    "created_at": "2021-05-12T00:56:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31575#issuecomment-450644",
    "user": "https://github.com/jcamp0x2a"
}
```

I think the reason using `viewer='jmol'` first fixes it is because the `IndexFaceSet.jmol_repr` method has [a side effect](https://github.com/sagemath/sage/blob/d6c5cd9be78cc448ee4c54bac93385b1244a234c/src/sage/plot/plot3d/index_face_set.pyx#L1517), defined [here](https://github.com/sagemath/sage/blob/d6c5cd9be78cc448ee4c54bac93385b1244a234c/src/sage/plot/plot3d/index_face_set.pyx#L509). Looks like it duplicates vertices so that each face has its own unique set, similar to what you get summing polygon3d, which also shows the correct color.

I'm not sure why the `polygons3d` version is showing up all black, though. The color is being passed to the template correctly. Interestingly, while rotating the camera around in Edge, it will occasionally flash the correct color blue for a split second. Doesn't happen in Firefox. Also, using `threejs_flat_shading=True` fixes it, so perhaps something related to lighting/normals?



---

archive/issue_comments_450645.json:
```json
{
    "body": "It is related to the orientation of the vertices in a face. In the following example, the first face and the last face in `faces_a` have opposite orientations, while the two in `faces_b` have the same. The plot is black using `faces_a` and is blue using `faces_b`.\n\n```\nsage: points = [(0, 0, 0), (1, 0, 0), (-1, 0, 0), (0, 0, 1), (0, 1, 0), (1, 0, 1), (1, 1, 0), (-1, 0, 1)]               \nsage: faces_a = [[3, 0, 1, 5], [0, 4, 6, 1], [3, 0, 2, 7]]  \nsage: faces_b =  [[3, 0, 1, 5], [0, 4, 6, 1], [7, 2, 0, 3]] \nsage: polygons3d(faces_a, points, color='blue') # shows black\nsage: polygons3d(faces_b, points, color='blue') # shows blue\n```\n\nReplying to [comment:5 gh-jcamp0x2a]:\n> I think the reason using `viewer='jmol'` first fixes it is because the `IndexFaceSet.jmol_repr` method has [a side effect](https://github.com/sagemath/sage/blob/d6c5cd9be78cc448ee4c54bac93385b1244a234c/src/sage/plot/plot3d/index_face_set.pyx#L1517), defined [here](https://github.com/sagemath/sage/blob/d6c5cd9be78cc448ee4c54bac93385b1244a234c/src/sage/plot/plot3d/index_face_set.pyx#L509). Looks like it duplicates vertices so that each face has its own unique set, similar to what you get summing polygon3d, which also shows the correct color.\n> \n> I'm not sure why the `polygons3d` version is showing up all black, though. The color is being passed to the template correctly. Interestingly, while rotating the camera around in Edge, it will occasionally flash the correct color blue for a split second. Doesn't happen in Firefox. Also, using `threejs_flat_shading=True` fixes it, so perhaps something related to lighting/normals?",
    "created_at": "2021-05-12T03:40:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31575#issuecomment-450645",
    "user": "https://github.com/yuan-zhou"
}
```

It is related to the orientation of the vertices in a face. In the following example, the first face and the last face in `faces_a` have opposite orientations, while the two in `faces_b` have the same. The plot is black using `faces_a` and is blue using `faces_b`.

```
sage: points = [(0, 0, 0), (1, 0, 0), (-1, 0, 0), (0, 0, 1), (0, 1, 0), (1, 0, 1), (1, 1, 0), (-1, 0, 1)]               
sage: faces_a = [[3, 0, 1, 5], [0, 4, 6, 1], [3, 0, 2, 7]]  
sage: faces_b =  [[3, 0, 1, 5], [0, 4, 6, 1], [7, 2, 0, 3]] 
sage: polygons3d(faces_a, points, color='blue') # shows black
sage: polygons3d(faces_b, points, color='blue') # shows blue
```

Replying to [comment:5 gh-jcamp0x2a]:
> I think the reason using `viewer='jmol'` first fixes it is because the `IndexFaceSet.jmol_repr` method has [a side effect](https://github.com/sagemath/sage/blob/d6c5cd9be78cc448ee4c54bac93385b1244a234c/src/sage/plot/plot3d/index_face_set.pyx#L1517), defined [here](https://github.com/sagemath/sage/blob/d6c5cd9be78cc448ee4c54bac93385b1244a234c/src/sage/plot/plot3d/index_face_set.pyx#L509). Looks like it duplicates vertices so that each face has its own unique set, similar to what you get summing polygon3d, which also shows the correct color.
> 
> I'm not sure why the `polygons3d` version is showing up all black, though. The color is being passed to the template correctly. Interestingly, while rotating the camera around in Edge, it will occasionally flash the correct color blue for a split second. Doesn't happen in Firefox. Also, using `threejs_flat_shading=True` fixes it, so perhaps something related to lighting/normals?
