# Issue 31575: Bug in polygons3d and IndexFaceSet

Issue created by migration from https://trac.sagemath.org/ticket/31812

Original creator: yzh

Original creation time: 2021-05-11 09:22:27

CC:  @jcamp0x2a mkoeppe paulmasson slelievre

`polygons3d` calls `sage.plot.plot3d.index_face_set.IndexFaceSetIndexFaceSet`, which should show the same graphic as calling `polygon3d` repeatedly.

```
sage: points = [(0, 0, 0), (1, 0, 0), (-1, 0, 0), (0, 0, 1), (0, 1, 0), (1, 0, 1), (1, 1, 0), (-1, 0, 1), 
....: (-1, 1, 0)]                                                                                         
sage: faces = [[3, 0, 1, 5], [0, 4, 6, 1], [3, 0, 2, 7], [0, 4, 8, 2]]                                    
sage: polygons3d(faces, points, color='blue')                                
Graphics3d Object
```

This gives all black faces, instead of blue. It is different than

```
sage: sum(polygon3d([points[i] for i in face], color='blue') for face in faces)
Graphics3d Object
```




---

Comment by mkoeppe created at 2021-05-11 18:04:13

works for me (with the default viewer) - it's blue.


---

Comment by @sheerluck created at 2021-05-11 18:50:10


```
polygons3d(faces, points, color='blue')
```

all black faces, but 

```
polygons3d(faces, points, color='blue', viewer='jmol')
```

all blue


---

Comment by yzh created at 2021-05-11 20:46:40

Replying to [comment:2 gh-sheerluck]:
> {{{
> polygons3d(faces, points, color='blue')
> }}}
> all black faces, but 
> {{{
> polygons3d(faces, points, color='blue', viewer='jmol')
> }}}
> all blue
Same behavior here.
 
Blue with `viewer='jmol'` or `'tachyon'` but black with default `viewer='threejs'`.

Mysteriously, if I call `viewer='threejs'` after `viewer='jmol'` was used, then it shows blue.

```
p = polygons3d(faces, points, color='blue')
p.show()   # default is threejs, black
p.show(viewer='jmol') # blue
p.show(viewer='threejs') # now this mysteriously becomes blue
```

In any case, this is not a bug in `polygons3d` or `IndexFaceSet` then.


---

Comment by slelievre created at 2021-05-11 21:48:10

cc-ing three.js experts


---

Comment by @jcamp0x2a created at 2021-05-12 00:56:51

I think the reason using `viewer='jmol'` first fixes it is because the `IndexFaceSet.jmol_repr` method has [a side effect](https://github.com/sagemath/sage/blob/d6c5cd9be78cc448ee4c54bac93385b1244a234c/src/sage/plot/plot3d/index_face_set.pyx#L1517), defined [here](https://github.com/sagemath/sage/blob/d6c5cd9be78cc448ee4c54bac93385b1244a234c/src/sage/plot/plot3d/index_face_set.pyx#L509). Looks like it duplicates vertices so that each face has its own unique set, similar to what you get summing polygon3d, which also shows the correct color.

I'm not sure why the `polygons3d` version is showing up all black, though. The color is being passed to the template correctly. Interestingly, while rotating the camera around in Edge, it will occasionally flash the correct color blue for a split second. Doesn't happen in Firefox. Also, using `threejs_flat_shading=True` fixes it, so perhaps something related to lighting/normals?


---

Comment by yzh created at 2021-05-12 03:40:40

It is related to the orientation of the vertices in a face. In the following example, the first face and the last face in `faces_a` have opposite orientations, while the two in `faces_b` have the same. The plot is black using `faces_a` and is blue using `faces_b`.

```
sage: points = [(0, 0, 0), (1, 0, 0), (-1, 0, 0), (0, 0, 1), (0, 1, 0), (1, 0, 1), (1, 1, 0), (-1, 0, 1)]               
sage: faces_a = [[3, 0, 1, 5], [0, 4, 6, 1], [3, 0, 2, 7]]  
sage: faces_b =  [[3, 0, 1, 5], [0, 4, 6, 1], [7, 2, 0, 3]] 
sage: polygons3d(faces_a, points, color='blue') # shows black
sage: polygons3d(faces_b, points, color='blue') # shows blue
```

Replying to [comment:5 gh-jcamp0x2a]:
> I think the reason using `viewer='jmol'` first fixes it is because the `IndexFaceSet.jmol_repr` method has [a side effect](https://github.com/sagemath/sage/blob/d6c5cd9be78cc448ee4c54bac93385b1244a234c/src/sage/plot/plot3d/index_face_set.pyx#L1517), defined [here](https://github.com/sagemath/sage/blob/d6c5cd9be78cc448ee4c54bac93385b1244a234c/src/sage/plot/plot3d/index_face_set.pyx#L509). Looks like it duplicates vertices so that each face has its own unique set, similar to what you get summing polygon3d, which also shows the correct color.
> 
> I'm not sure why the `polygons3d` version is showing up all black, though. The color is being passed to the template correctly. Interestingly, while rotating the camera around in Edge, it will occasionally flash the correct color blue for a split second. Doesn't happen in Firefox. Also, using `threejs_flat_shading=True` fixes it, so perhaps something related to lighting/normals?
