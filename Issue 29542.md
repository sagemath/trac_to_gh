# Issue 29542: pkg-config installed from SPKG pkgconf should not depend on environment variable SAGE_LOCAL

Issue created by migration from https://trac.sagemath.org/ticket/29779

Original creator: mkoeppe

Original creation time: 2020-06-02 03:05:34

CC:  mjo dimpase vbraun

(from #29411)


---

Comment by mjo created at 2020-07-14 01:14:44

It looks like we can specify the `*.pc` file location at build time using `--with-pkg-config-dir`:

https://github.com/pkgconf/pkgconf/blob/master/configure.ac

Afterwards, we can probably just symlink pkgconf to "pkg-config", and then rely on PATH to choose the right one.


---

Comment by mjo created at 2020-07-14 01:24:14

src/bin/sage-env already prepends the sage-specific `*.pc` file path to `PKG_CONFIG_PATH` in case the system pkg-config is used. From pkgconf's spkg-configure.m4:


```
AS_IF([test -z "$ac_cv_path_PKGCONF"], [
   sage_spkg_install_pkgconf=yes
   AC_SUBST(SAGE_PKG_CONFIG_PATH, [''])
   AC_MSG_RESULT([installing pkgconf spkg])], [
dnl the following as needed as long as Sage creates .pc files during build and/or configure
   AC_SUBST(SAGE_PKG_CONFIG_PATH, ['$SAGE_LOCAL/lib/pkgconfig'])
   AC_MSG_RESULT([using pkg-config from the system])
])
```


Then in sage-env,


```
if [ -n "$SAGE_PKG_CONFIG_PATH" ]; then
    # set up external pkg-config to look into SAGE_LOCAL/lib/pkgconfig/
    # (Sage's pkgconf spkg takes care of this, if installed)
    export PKG_CONFIG_PATH="$SAGE_PKG_CONFIG_PATH${PKG_CONFIG_PATH:+:$PKG_CONFIG_PATH}"
fi
```


So we "shouldn't" be hurt by ditching the pkgconf wrapper script and hard-coding the full list of paths into pkgconf at build time.


---

Comment by mkoeppe created at 2020-07-14 01:59:40

Sounds right to me


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Changing keywords from "" to "sd111".


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111


---

Comment by mkoeppe created at 2021-03-24 02:04:25

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-05-27 18:27:21

Any progress here?


---

Comment by mkoeppe created at 2022-04-27 02:36:23

`@`mjo, it sounds like you have some free time. Care to work on this ticket?


---

Comment by mjo created at 2022-04-27 11:29:36

I never wanted to work on it in the first place. pkg-config is a standard, stable, system utility that's available everywhere. We should delete the SPKG and require that the user have it installed. Treadmill tickets like these are a complete waste of time, but not mine.


---

Comment by mkoeppe created at 2022-05-09 23:07:09

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2022-05-09 23:07:09

New commits:


---

Comment by dimpase created at 2022-05-11 08:16:30

there are changes of `$SAGE_LOCAL` to unprefixed by `$`. What does it do - if it was to be substituted I'd expect ``@`SAGE_LOCAL`@``?


---

Comment by mkoeppe created at 2022-05-11 16:54:41

These are resolved as m4 macros - see the m4 invocation in spkg-postinst.in


---

Comment by git created at 2022-05-19 16:16:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-06-26 18:27:23

Let's get this in please


---

Comment by dimpase created at 2022-06-28 12:15:45

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2022-06-28 12:15:45

lgtm


---

Comment by mkoeppe created at 2022-06-28 17:30:18

Thanks!


---

Comment by vbraun created at 2022-07-03 22:06:08

Resolution: fixed
