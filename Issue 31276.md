# Issue 31276: jupyter: "%display latex" completely breaks @interact

Issue created by migration from https://trac.sagemath.org/ticket/31513

Original creator: was

Original creation time: 2021-03-18 18:22:34

CC:  dimpase klee enriqueartal @jcamp0x2a slelievre vbraun

In sage-9.1, this works fine with Jupyter:

```
%display latex

then in another cell

@interact
def f(n=10):
    print(n)
```

However, in sage-9.2, the output of Interact is **displayed as latex**, i.e., somebody changed %display latex in such a way that it also breaks widgets. 

```
ğ™¸ğš—ğšğšğš›ğšŠğšŒğšğš’ğšŸğšğšğšğš—ğšŒğšğš’ğš˜ğš—<ğšğšğš—ğšŒğšğš’ğš˜ğš—ğšğšŠğšğŸ¶ğš¡ğŸ½ğšğšğŸ¹ğšŠğšŠğŸ¸ğŸ¿ğš‹ğšğŸ½ğŸ¶>ğš ğš’ğšğš‘ğŸ·ğš ğš’ğšğšğšğšğš—:ğ™¸ğš—ğšğš‚ğš•ğš’ğšğšğš›(ğšŸğšŠğš•ğšğš=ğŸ·ğŸ¶,ğšğšğšœğšŒğš›ğš’ğš™ğšğš’ğš˜ğš—='ğš—',ğš–ğšŠğš¡=ğŸ¹ğŸ¶,ğš–ğš’ğš—=â¯ğŸ·ğŸ¶)
```



---

Attachment

Screenshot illustrating this bug.


---

Comment by mkoeppe created at 2021-03-18 19:14:06

Changing priority from major to blocker.


---

Comment by klee created at 2021-03-19 05:01:09

Perhaps introduced by ipython upgrade in #28197?


---

Comment by egourgoulhon created at 2021-03-24 20:16:55

FWIW, `%display latex` also breaks `%matplotlib notebook`. For instance the following cell in a Jupyter notebook

```
%display latex
%matplotlib notebook
import matplotlib.pyplot as plt
plt.plot([1, 2, 3, 4])
plt.ylabel('some numbers')
plt.show()
```

yields

```
<ğ™¸ğ™¿ğš¢ğšğš‘ğš˜ğš—.ğšŒğš˜ğš›ğš.ğšğš’ğšœğš™ğš•ğšŠğš¢.ğ™¹ğšŠğšŸğšŠğšœğšŒğš›ğš’ğš™ğšğš˜ğš‹ğš“ğšğšŒğš>
<ğ™¸ğ™¿ğš¢ğšğš‘ğš˜ğš—.ğšŒğš˜ğš›ğš.ğšğš’ğšœğš™ğš•ğšŠğš¢.ğ™·ğšƒğ™¼ğ™»ğš˜ğš‹ğš“ğšğšŒğš>
```

instead of the pyplot window.
If one suppresses `%display latex` or replaces it by `%display plain`, then everything is fine: the interactive pyplot window appears, with the requested plot. 

Contrary to the issue with ``@`interact`, this one is also there in Sage 9.1, except that the output is only

```
<ğ™¸ğ™¿ğš¢ğšğš‘ğš˜ğš—.ğšŒğš˜ğš›ğš.ğšğš’ğšœğš™ğš•ğšŠğš¢.ğ™·ğšƒğ™¼ğ™»ğš˜ğš‹ğš“ğšğšŒğš>
```



---

Comment by klee created at 2021-03-25 05:50:16

Here is the bug.

https://trac.sagemath.org/ticket/23330


```diff
diff --git a/src/sage/repl/rich_output/backend_ipython.py b/src/sage/repl/rich_output/backend_ipython.py
index a2c17e2841..38ae60ce70 100644
--- a/src/sage/repl/rich_output/backend_ipython.py
+++ b/src/sage/repl/rich_output/backend_ipython.py
@@ -544,6 +544,7 @@ class BackendIPythonNotebook(BackendIPython):
             return ({u'text/plain': rich_output.unicode_art.get_unicode()}, {})
         elif isinstance(rich_output, OutputLatex):
             return ({u'text/html':  rich_output.mathjax(),
+                     u'text/latex': rich_output.inline_equation(),
                      u'text/plain': plain_text.text.get_unicode(),
             }, {})
         elif isinstance(rich_output, OutputHtml):
```



---

Comment by egourgoulhon created at 2021-03-25 07:16:15

Replying to [comment:7 klee]:
> Here is the bug.
> 
> #23330
> 
Shall we revert #23330? It looks more important to have ipywidgets working than a correct pdf export.


---

Comment by klee created at 2021-03-25 07:24:22

Replying to [comment:8 egourgoulhon]:
> Replying to [comment:7 klee]:
> > Here is the bug.
> > 
> > #23330
> > 
> Shall we revert #23330? It looks more important to have ipywidgets working than a correct pdf export. 

Moreover, in the spirit of #31536, `tex/latex` mime type is to be deprecated in favor of `tex/html`.


---

Comment by egourgoulhon created at 2021-03-25 07:38:39

BTW, this points to the need to move to the default Jupyter rich output display for latex (i.e. use `_repr_latex_` instead of `%display latex`), since the pdf export works out of the box with `_repr_latex_` and there is no interference with ipywidgets.


---

Comment by egourgoulhon created at 2021-03-25 08:03:41

Replying to [comment:9 klee]:
> Replying to [comment:8 egourgoulhon]:
> > Replying to [comment:7 klee]:
> > > Here is the bug.
> > > 
> > > #23330
> > > 
> > Shall we revert #23330? It looks more important to have ipywidgets working than a correct pdf export. 
> 
> Moreover, in the spirit of #31536, `tex/latex` mime type is to be deprecated in favor of `tex/html`.

But then, there cannot be pdf export of latex-typeset formulas from `text/html`.


---

Comment by egourgoulhon created at 2021-03-26 11:40:16

Changing status from new to needs_review.


---

Comment by egourgoulhon created at 2021-03-26 11:40:16

Here is a possible fix, which does not revert the pdf export fix introduced in #23330. I have instead modified `sage.repl.display.formatter.SageDisplayFormatter.format` so that IPython widgets are tried before Sage rich output. I've performed a few tests and things seem OK, but I am not completly sure about possible side effects of this fix. So please test it on your side. 
----
New commits:


---

Comment by klee created at 2021-03-26 15:42:07

Replying to [comment:11 egourgoulhon]:
> Replying to [comment:9 klee]:
> > Moreover, in the spirit of #31536, `tex/latex` mime type is to be deprecated in favor of `tex/html`.
> 
> But then, there cannot be pdf export of latex-typeset formulas from `text/html`.

Right. `tex/latex` is the right mime type for pdf output. What I don't like is the use of `latex` for mathjax+html. I misdirected my arrow.


---

Comment by klee created at 2021-03-26 15:58:00

Replying to [comment:12 egourgoulhon]:
> Here is a possible fix, which does not revert the pdf export fix introduced in #23330. I have instead modified `sage.repl.display.formatter.SageDisplayFormatter.format` so that IPython widgets are tried before Sage rich output. I've performed a few tests and things seem OK, but I am not completly sure about possible side effects of this fix. So please test it on your side. 

Then you bypass the test `set(sage_format.keys()).issubset(self.default_mime())` checked before calling `self.ipython_display_formatter(obj)`. I guess the author (Volker?) of the test thought the test is necessary before resorting to ipython for output.

Do you understand the logic of the test? I don't. If you do, would you explain? As it is practically impossible to check all side effects of the change, I think we need to understand the logic correctly and be sure it is safe to bypass the test.


---

Comment by egourgoulhon created at 2021-03-26 17:20:29

Replying to [comment:14 klee]:
> 
> Then you bypass the test `set(sage_format.keys()).issubset(self.default_mime())` checked before calling `self.ipython_display_formatter(obj)`. I guess the author (Volker?) of the test thought the test is necessary before resorting to ipython for output.
> 
> Do you understand the logic of the test? 

No. I have to look deeper. Certainly Volker should check this.


---

Comment by klee created at 2021-03-27 02:12:22

Now #31536 also contains fixes both for jupyter pdf export problem and this ticket.

Hope for no unexpected side effects..


---

Comment by egourgoulhon created at 2021-03-27 09:55:00

Replying to [comment:16 klee]:
> Now #31536 also contains fixes both for jupyter pdf export problem and this ticket.
> 

This sounds nice! I'll look at it today.


---

Comment by vbraun created at 2021-03-28 09:27:25

Morally thats wrong, we should prefer our own formatter which gives e.g. the emacs backend a chance of handling things correctly. The problem is that ipython/jupyter doesn't have a blessed way of recognizing interact output, and moreover keeps adding more magic methods over time. The proposed patch is reasonable to me, hopefully the jupyter guys can keep `ipython_display_formatter` sufficently specific that only output is captured that is 100% ipython specific (like the current ``@`interact`s which cannot work anywhere else)

Note that I didn't actually check this ticket for regressions.


---

Comment by egourgoulhon created at 2021-03-28 14:45:05

Replying to [comment:18 vbraun]:
> Morally thats wrong, we should prefer our own formatter which gives e.g. the emacs backend a chance of handling things correctly. The problem is that ipython/jupyter doesn't have a blessed way of recognizing interact output, and moreover keeps adding more magic methods over time. The proposed patch is reasonable to me, hopefully the jupyter guys can keep `ipython_display_formatter` sufficently specific that only output is captured that is 100% ipython specific (like the current ``@`interact`s which cannot work anywhere else)
> 
Thanks for your feedback.


---

Comment by egourgoulhon created at 2021-03-30 10:14:13

#31536 seems in a good shape and would be a better fix for the issue reported here.


---

Comment by egourgoulhon created at 2021-03-30 10:14:13

Changing status from needs_review to needs_info.


---

Comment by egourgoulhon created at 2021-03-31 07:37:15

Now that #31536 is ready, we should use it to fix the issue reported here. In particular, #31536 complies with the moral behaviour expressed in comment:18.


---

Comment by egourgoulhon created at 2021-03-31 07:37:15

Changing status from needs_info to needs_review.


---

Comment by mkoeppe created at 2021-03-31 17:00:12

Changing priority from blocker to major.


---

Comment by klee created at 2021-04-07 02:15:56

Changing status from needs_review to positive_review.


---

Comment by klee created at 2021-04-07 02:15:56

fixed in Sage 9.3.rc2


---

Comment by slelievre created at 2021-05-23 08:30:57

Resolution: fixed
