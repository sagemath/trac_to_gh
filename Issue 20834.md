# Issue 20834: substitution in denomintor is skipped

archive/issues_020834.json:
```json
{
    "body": "CC:  @tscrim @dkrenn\n\nThe following comes very unexpected\n\n```\nsage: ((1+x^2)/x^2).subs({x^2: 42})\n43/x^2\n```\n\n\nThe problem is the internal representation as\n\n```\nsage: ((1+x^2)/x^2).operands()\n[x^2 + 1, x^(-2)]\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/21071\n\n",
    "created_at": "2016-07-21T07:28:31Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.4",
    "title": "substitution in denomintor is skipped",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20834",
    "user": "https://github.com/dkrenn"
}
```
CC:  @tscrim @dkrenn

The following comes very unexpected

```
sage: ((1+x^2)/x^2).subs({x^2: 42})
43/x^2
```


The problem is the internal representation as

```
sage: ((1+x^2)/x^2).operands()
[x^2 + 1, x^(-2)]
```


Issue created by migration from https://trac.sagemath.org/ticket/21071





---

archive/issue_comments_287512.json:
```json
{
    "body": "Note that there is the walkaround of substituting twice, i.e. as given followed by a substitution of the inverse pattern with the inverse replacement, e.g., `((1+x<sup>2)/(x</sup>2)).subs({x^2: 42}).subs({x^-2: 1/42})`",
    "created_at": "2016-08-10T14:22:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20834#issuecomment-287512",
    "user": "https://github.com/rwst"
}
```

Note that there is the walkaround of substituting twice, i.e. as given followed by a substitution of the inverse pattern with the inverse replacement, e.g., `((1+x<sup>2)/(x</sup>2)).subs({x^2: 42}).subs({x^-2: 1/42})`



---

archive/issue_comments_287513.json:
```json
{
    "body": "Remaining fail, hopefully the author(s) can see where they worked around this bug so that their workaround can be removed:\n\n```\nFile \"src/sage/rings/asymptotic/asymptotics_multivariate_generating_functions.py\", line 1717, in sage.rings.asymptotic.asymptotics_multivariate_generating_functions.FractionWithFactoredDenominator.?\nFailed example:\n    asy # long time\nExpected:\n    (4/3*sqrt(3)*sqrt(r)/sqrt(pi) + 47/216*sqrt(3)/(sqrt(pi)*sqrt(r)),\n     1, 4/3*sqrt(3)*sqrt(r)/sqrt(pi) + 47/216*sqrt(3)/(sqrt(pi)*sqrt(r)))\nGot:\n    (4/3*sqrt(3)*sqrt(r)/sqrt(pi) + 587/216*sqrt(3)/(sqrt(pi)*sqrt(r)),\n     1,\n     4/3*sqrt(3)*sqrt(r)/sqrt(pi) + 587/216*sqrt(3)/(sqrt(pi)*sqrt(r)))\n**********************************************************************\nFile \"src/sage/rings/asymptotic/asymptotics_multivariate_generating_functions.py\", line 1720, in sage.rings.asymptotic.asymptotics_multivariate_generating_functions.FractionWithFactoredDenominator.?\nFailed example:\n    F.relative_error(asy[0], alpha, [1, 2, 4, 8], asy[1]) # long time\nExpected:\n    [((3, 3, 2), 0.9812164307, [1.515572606], [-0.54458543...]),\n     ((6, 6, 4), 1.576181132, [1.992989399], [-0.26444185...]),\n     ((12, 12, 8), 2.485286378, [2.712196351], [-0.091301338...]),\n     ((24, 24, 16), 3.700576827, [3.760447895], [-0.016178847...])]\nGot:\n    [((3, 3, 2), 0.9812164307, [3.958585166], [-3.034364939]),\n     ((6, 6, 4), 1.576181132, [3.720460147], [-1.360426775]),\n     ((12, 12, 8), 2.485286378, [3.933702631], [-0.5827965202]),\n     ((24, 24, 16), 3.700576827, [4.624183269], [-0.2495844526])]\n```\n\n----\nNew commits:",
    "created_at": "2016-08-13T07:46:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20834#issuecomment-287513",
    "user": "https://github.com/rwst"
}
```

Remaining fail, hopefully the author(s) can see where they worked around this bug so that their workaround can be removed:

```
File "src/sage/rings/asymptotic/asymptotics_multivariate_generating_functions.py", line 1717, in sage.rings.asymptotic.asymptotics_multivariate_generating_functions.FractionWithFactoredDenominator.?
Failed example:
    asy # long time
Expected:
    (4/3*sqrt(3)*sqrt(r)/sqrt(pi) + 47/216*sqrt(3)/(sqrt(pi)*sqrt(r)),
     1, 4/3*sqrt(3)*sqrt(r)/sqrt(pi) + 47/216*sqrt(3)/(sqrt(pi)*sqrt(r)))
Got:
    (4/3*sqrt(3)*sqrt(r)/sqrt(pi) + 587/216*sqrt(3)/(sqrt(pi)*sqrt(r)),
     1,
     4/3*sqrt(3)*sqrt(r)/sqrt(pi) + 587/216*sqrt(3)/(sqrt(pi)*sqrt(r)))
**********************************************************************
File "src/sage/rings/asymptotic/asymptotics_multivariate_generating_functions.py", line 1720, in sage.rings.asymptotic.asymptotics_multivariate_generating_functions.FractionWithFactoredDenominator.?
Failed example:
    F.relative_error(asy[0], alpha, [1, 2, 4, 8], asy[1]) # long time
Expected:
    [((3, 3, 2), 0.9812164307, [1.515572606], [-0.54458543...]),
     ((6, 6, 4), 1.576181132, [1.992989399], [-0.26444185...]),
     ((12, 12, 8), 2.485286378, [2.712196351], [-0.091301338...]),
     ((24, 24, 16), 3.700576827, [3.760447895], [-0.016178847...])]
Got:
    [((3, 3, 2), 0.9812164307, [3.958585166], [-3.034364939]),
     ((6, 6, 4), 1.576181132, [3.720460147], [-1.360426775]),
     ((12, 12, 8), 2.485286378, [3.933702631], [-0.5827965202]),
     ((24, 24, 16), 3.700576827, [4.624183269], [-0.2495844526])]
```

----
New commits:



---

archive/issue_comments_287514.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-17T07:24:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20834#issuecomment-287514",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_287515.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-08-17T07:24:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20834#issuecomment-287515",
    "user": "https://github.com/rwst"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_287516.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-12-20T15:51:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20834#issuecomment-287516",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_287517.json:
```json
{
    "body": "I'm not completely sure I agree with this:\n\n```diff\n     sage: eq.substitute(a=x, x=1)\n-    x + 1 == sin(1/x)\n+    x + 1 == sin(1)\n```\n\nOn the LHS, you simplify `x` then `a` (or simultaneously where one substitution does not affect the other), whereas on the RHS, you currently do `a`, then `x` (with the new `x` from the `a`). So I see this as an inconsistency. IMO, they should be done simultaneously, and the RHS should be `sin(1/x)`.",
    "created_at": "2016-12-20T20:58:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20834#issuecomment-287517",
    "user": "https://github.com/tscrim"
}
```

I'm not completely sure I agree with this:

```diff
     sage: eq.substitute(a=x, x=1)
-    x + 1 == sin(1/x)
+    x + 1 == sin(1)
```

On the LHS, you simplify `x` then `a` (or simultaneously where one substitution does not affect the other), whereas on the RHS, you currently do `a`, then `x` (with the new `x` from the `a`). So I see this as an inconsistency. IMO, they should be done simultaneously, and the RHS should be `sin(1/x)`.



---

archive/issue_comments_287518.json:
```json
{
    "body": "I agree, but the inconsistency already exists in develop:\n\n```\nsage: sin(x/a).subs({1/x : 1, a : x, x : 1})\nsin(1)\nsage: sin(x/a).subs({a^-1 : x^-1, x^-1 : 1})\nsin(1)\n```\n\n(EDIT: simplified)",
    "created_at": "2016-12-26T15:43:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20834#issuecomment-287518",
    "user": "https://github.com/rwst"
}
```

I agree, but the inconsistency already exists in develop:

```
sage: sin(x/a).subs({1/x : 1, a : x, x : 1})
sin(1)
sage: sin(x/a).subs({a^-1 : x^-1, x^-1 : 1})
sin(1)
```

(EDIT: simplified)



---

archive/issue_comments_287519.json:
```json
{
    "body": "However, the following shows that it is not due to sequential application but premature evaluation (`x/x --> 1`).\n\n```\nsage: sin(x/a).subs({a^-1:x^-1,x^-1:pi})\nsin(1)\n```\n",
    "created_at": "2016-12-26T16:13:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20834#issuecomment-287519",
    "user": "https://github.com/rwst"
}
```

However, the following shows that it is not due to sequential application but premature evaluation (`x/x --> 1`).

```
sage: sin(x/a).subs({a^-1:x^-1,x^-1:pi})
sin(1)
```




---

archive/issue_comments_287520.json:
```json
{
    "body": "Quoting from [http://www.ginac.de/reference/basic_8cpp_source.html#l00606](http://www.ginac.de/reference/basic_8cpp_source.html#l00606), it looks like this is pretty fundamental:\n\n``` \n  606 ex basic::subs(const exmap & m, unsigned options) const\n  607 {\n  608     size_t num = nops();\n  609     if (num) {\n  610 \n  611         // Substitute in subexpressions\n  612         for (size_t i=0; i<num; i++) {\n  613             const ex & orig_op = op(i);\n  614             const ex & subsed_op = orig_op.subs(m, options);\n  615             if (!are_ex_trivially_equal(orig_op, subsed_op)) {\n  616 \n  617                 // Something changed, clone the object\n  618                 basic *copy = duplicate();\n  619                 copy->clearflag(status_flags::hash_calculated | status_flags::expanded);\n  620 \n  621                 // Substitute the changed operand\n  622                 copy->let_op(i++) = subsed_op;\n  623 \n  624                 // Substitute the other operands\n  625                 for (; i<num; i++)\n  626                     copy->let_op(i) = op(i).subs(m, options);\n  627 \n  628                 // Perform substitutions on the new object as a whole\n  629                 return copy->subs_one_level(m, options);\n  630             }\n  631         }\n  632     }\n  633 \n  634     // Nothing changed or no subexpressions\n  635     return subs_one_level(m, options);\n  636 }\n```\n\nThe problem is that substitutions are done on the subexpressions and *then* on the entire expression. So, we have:\n\n```\nsage: (x/a).subs({a:x,x:1})\n1/x\nsage: (x/a).subs({a:x,x:1,1/x:17})\n17\n```\n\nI'm pretty sure this is because of line 629. This is not because of premature evaluation (which, as you show, can also be an issue)",
    "created_at": "2016-12-26T18:42:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20834#issuecomment-287520",
    "user": "https://github.com/nbruin"
}
```

Quoting from [http://www.ginac.de/reference/basic_8cpp_source.html#l00606](http://www.ginac.de/reference/basic_8cpp_source.html#l00606), it looks like this is pretty fundamental:

``` 
  606 ex basic::subs(const exmap & m, unsigned options) const
  607 {
  608     size_t num = nops();
  609     if (num) {
  610 
  611         // Substitute in subexpressions
  612         for (size_t i=0; i<num; i++) {
  613             const ex & orig_op = op(i);
  614             const ex & subsed_op = orig_op.subs(m, options);
  615             if (!are_ex_trivially_equal(orig_op, subsed_op)) {
  616 
  617                 // Something changed, clone the object
  618                 basic *copy = duplicate();
  619                 copy->clearflag(status_flags::hash_calculated | status_flags::expanded);
  620 
  621                 // Substitute the changed operand
  622                 copy->let_op(i++) = subsed_op;
  623 
  624                 // Substitute the other operands
  625                 for (; i<num; i++)
  626                     copy->let_op(i) = op(i).subs(m, options);
  627 
  628                 // Perform substitutions on the new object as a whole
  629                 return copy->subs_one_level(m, options);
  630             }
  631         }
  632     }
  633 
  634     // Nothing changed or no subexpressions
  635     return subs_one_level(m, options);
  636 }
```

The problem is that substitutions are done on the subexpressions and *then* on the entire expression. So, we have:

```
sage: (x/a).subs({a:x,x:1})
1/x
sage: (x/a).subs({a:x,x:1,1/x:17})
17
```

I'm pretty sure this is because of line 629. This is not because of premature evaluation (which, as you show, can also be an issue)



---

archive/issue_comments_287521.json:
```json
{
    "body": "I would like to solve this outside Pynac via an intermediate substitution step. It would depend on #22102.",
    "created_at": "2016-12-27T14:25:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20834#issuecomment-287521",
    "user": "https://github.com/rwst"
}
```

I would like to solve this outside Pynac via an intermediate substitution step. It would depend on #22102.



---

archive/issue_comments_287522.json:
```json
{
    "body": "There is an ambiguity. What is the expected result of\n\n```\nsage: f = piecewise([((0,2), x), ([-2,0], -x)]\nsage: (x+f).subs(x==1)\n\npiecewise(x|-->1 on (0, 2), x|-->-1 on [-2, 0]; x) + 1\nor\n2?\n```\n\nPlot expects this to be `2`.",
    "created_at": "2016-12-28T06:58:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20834#issuecomment-287522",
    "user": "https://github.com/rwst"
}
```

There is an ambiguity. What is the expected result of

```
sage: f = piecewise([((0,2), x), ([-2,0], -x)]
sage: (x+f).subs(x==1)

piecewise(x|-->1 on (0, 2), x|-->-1 on [-2, 0]; x) + 1
or
2?
```

Plot expects this to be `2`.



---

archive/issue_comments_287523.json:
```json
{
    "body": "I think `subs` should do nothing inside `piecewise` and only evaluate if the main variable is substituted. If one wishes to change the piece definition one should use another method that is still to be implemented, like e.g. `substitute_piece`. Otherwise I don't see how to untangle this issue.",
    "created_at": "2016-12-28T07:28:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20834#issuecomment-287523",
    "user": "https://github.com/rwst"
}
```

I think `subs` should do nothing inside `piecewise` and only evaluate if the main variable is substituted. If one wishes to change the piece definition one should use another method that is still to be implemented, like e.g. `substitute_piece`. Otherwise I don't see how to untangle this issue.



---

archive/issue_comments_287524.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-12-30T06:30:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20834#issuecomment-287524",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_287525.json:
```json
{
    "body": "I think what it should do is return the constant function 3 as this would be in line with how `subs` works on general functions/expressions:\n\n```\nsage: f(x) = x^2\nsage: f.subs(x=2)\nx |--> 4\nsage: f\nx |--> x^2\nsage: (f+2).subs(x=2)\nx |--> 6\nsage: (f(x)+2).subs(x=2)\n6\n```\n",
    "created_at": "2016-12-31T12:50:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20834#issuecomment-287525",
    "user": "https://github.com/tscrim"
}
```

I think what it should do is return the constant function 3 as this would be in line with how `subs` works on general functions/expressions:

```
sage: f(x) = x^2
sage: f.subs(x=2)
x |--> 4
sage: f
x |--> x^2
sage: (f+2).subs(x=2)
x |--> 6
sage: (f(x)+2).subs(x=2)
6
```




---

archive/issue_comments_287526.json:
```json
{
    "body": "Substitution in computer algebra systems doesn't tend to be semantically defined. It's an operation on syntax trees. So I think piecewise functions can be treated in two ways:\n\nEither you regard them as \"atomic\" objects. Then substitution doesn't do anything within them. That's not unreasonable. A piecewise function cannot be evaluated at a symbolic input either ...\n\nOr you regard them as a syntax tree (probably a list of (a,b,expression) tuples or so) and you do a substitution on that (hopefully raising an error when the substitution leads to something illegal).",
    "created_at": "2016-12-31T17:19:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20834#issuecomment-287526",
    "user": "https://github.com/nbruin"
}
```

Substitution in computer algebra systems doesn't tend to be semantically defined. It's an operation on syntax trees. So I think piecewise functions can be treated in two ways:

Either you regard them as "atomic" objects. Then substitution doesn't do anything within them. That's not unreasonable. A piecewise function cannot be evaluated at a symbolic input either ...

Or you regard them as a syntax tree (probably a list of (a,b,expression) tuples or so) and you do a substitution on that (hopefully raising an error when the substitution leads to something illegal).
