# Issue 11949: floor/ceil can be very slow at integral values

archive/issues_011949.json:
```json
{
    "body": "Assignee: AlexGhitza\n\nCC:  kcrisman jdemeyer pelegm\n\nReported (in slightly different form) on [ask.sagemath.org](http://ask.sagemath.org/question/964/lenlist-ceillog42-bugs):\n\n\n\n```\nsage: %timeit floor(log(3)/log(2))\n625 loops, best of 3: 586 \u00b5s per loop\nsage: %timeit floor(log(4)/log(2))\n5 loops, best of 3: 3.79 s per loop\nsage: %timeit ceil(log(3)/log(2))\n625 loops, best of 3: 586 \u00b5s per loop\nsage: %timeit ceil(log(4)/log(2))\n5 loops, best of 3: 3.79 s per loop\n```\n\n\nThis happens because ceil and floor first try to increase the precision of a coercion of the input argument to a `RealInterval` by 100 bits from 53 to 20000 before finally trying a full_simplify, which succeeds.\n\nOne possible solution would be to try\n\n\n```\nsage: %timeit bool(log(4)/log(2) == round(log(4)/log(2)))\n125 loops, best of 3: 5.57 ms per loop\n```\n\n\nafter some number (maybe even 1?) of `RealInterval` attempts, and then get back to increasing the precision.  Trying to think of use cases, ceil and floor are probably called 95%+ of the time on things which only require a round or two at most to determine the answer, so it makes sense to optimize that end. \n\nAs well, the \"+100 bits\" approach (rather than going up by some factor each time, say) probably penalizes numbers requiring lots of bits too much relative to those requiring only a few, but the integer case is probably more important.\n\nIssue created by migration from https://trac.sagemath.org/ticket/12121\n\n",
    "created_at": "2011-12-06T15:35:19Z",
    "labels": [
        "basic arithmetic",
        "major",
        "bug"
    ],
    "title": "floor/ceil can be very slow at integral values",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11949",
    "user": "dsm"
}
```
Assignee: AlexGhitza

CC:  kcrisman jdemeyer pelegm

Reported (in slightly different form) on [ask.sagemath.org](http://ask.sagemath.org/question/964/lenlist-ceillog42-bugs):



```
sage: %timeit floor(log(3)/log(2))
625 loops, best of 3: 586 µs per loop
sage: %timeit floor(log(4)/log(2))
5 loops, best of 3: 3.79 s per loop
sage: %timeit ceil(log(3)/log(2))
625 loops, best of 3: 586 µs per loop
sage: %timeit ceil(log(4)/log(2))
5 loops, best of 3: 3.79 s per loop
```


This happens because ceil and floor first try to increase the precision of a coercion of the input argument to a `RealInterval` by 100 bits from 53 to 20000 before finally trying a full_simplify, which succeeds.

One possible solution would be to try


```
sage: %timeit bool(log(4)/log(2) == round(log(4)/log(2)))
125 loops, best of 3: 5.57 ms per loop
```


after some number (maybe even 1?) of `RealInterval` attempts, and then get back to increasing the precision.  Trying to think of use cases, ceil and floor are probably called 95%+ of the time on things which only require a round or two at most to determine the answer, so it makes sense to optimize that end. 

As well, the "+100 bits" approach (rather than going up by some factor each time, say) probably penalizes numbers requiring lots of bits too much relative to those requiring only a few, but the integer case is probably more important.

Issue created by migration from https://trac.sagemath.org/ticket/12121





---

archive/issue_comments_137366.json:
```json
{
    "body": "Note to self (and others): we can use is_int to decide when we should test for equality.  Test (once) the first time there's only one integer in the interval.  If you have equality there, you're done.  If not, you never will (or won't be able to prove it, anyway) and can carry on.",
    "created_at": "2012-03-03T16:43:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137366",
    "user": "dsm"
}
```

Note to self (and others): we can use is_int to decide when we should test for equality.  Test (once) the first time there's only one integer in the interval.  If you have equality there, you're done.  If not, you never will (or won't be able to prove it, anyway) and can carry on.



---

archive/issue_comments_137367.json:
```json
{
    "body": "Apparently [is_int is deprecated](http://thread.gmane.org/gmane.comp.mathematics.sage.devel/57910/).",
    "created_at": "2012-06-22T19:10:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137367",
    "user": "kini"
}
```

Apparently [is_int is deprecated](http://thread.gmane.org/gmane.comp.mathematics.sage.devel/57910/).



---

archive/issue_comments_137368.json:
```json
{
    "body": "I'm not sure if this should go to this ticket, but the following never returns:\n\n```\nsage: z\n(11/9*sqrt(3)*sqrt(2) + 3)^(1/3) + 1/3/(11/9*sqrt(3)*sqrt(2) + 3)^(1/3) - 1\nsage: floor(z)\n```\n\nEven `floor(z, maximum_bits=53)` loops infinitely.\nShould I open a separate ticket?",
    "created_at": "2015-07-07T12:22:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137368",
    "user": "zimmerma"
}
```

I'm not sure if this should go to this ticket, but the following never returns:

```
sage: z
(11/9*sqrt(3)*sqrt(2) + 3)^(1/3) + 1/3/(11/9*sqrt(3)*sqrt(2) + 3)^(1/3) - 1
sage: floor(z)
```

Even `floor(z, maximum_bits=53)` loops infinitely.
Should I open a separate ticket?



---

archive/issue_comments_137369.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-02-11T20:17:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137369",
    "user": "ajagekar.akshay"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_137370.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-02-11T20:17:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137370",
    "user": "ajagekar.akshay"
}
```

New commits:



---

archive/issue_comments_137371.json:
```json
{
    "body": "Replying to [comment:9 zimmerma]:\n> I'm not sure if this should go to this ticket, but the following never returns:\n> {{{\n> sage: z\n> (11/9*sqrt(3)*sqrt(2) + 3)^(1/3) + 1/3/(11/9*sqrt(3)*sqrt(2) + 3)^(1/3) - 1\n> sage: floor(z)\n> }}}\n> Even `floor(z, maximum_bits=53)` loops infinitely.\n\nWhereas the following actually works\n\n```\nsage: bool(z == 1)\nTrue\n```\n\n\n> Should I open a separate ticket?\n\nI think that \"very slow\" includes \"infinite amount of time\". For me it is worth it to also fix this kind of endless loops in this ticket.",
    "created_at": "2016-03-09T18:53:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137371",
    "user": "vdelecroix"
}
```

Replying to [comment:9 zimmerma]:
> I'm not sure if this should go to this ticket, but the following never returns:
> {{{
> sage: z
> (11/9*sqrt(3)*sqrt(2) + 3)^(1/3) + 1/3/(11/9*sqrt(3)*sqrt(2) + 3)^(1/3) - 1
> sage: floor(z)
> }}}
> Even `floor(z, maximum_bits=53)` loops infinitely.

Whereas the following actually works

```
sage: bool(z == 1)
True
```


> Should I open a separate ticket?

I think that "very slow" includes "infinite amount of time". For me it is worth it to also fix this kind of endless loops in this ticket.



---

archive/issue_comments_137372.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-03-09T18:56:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137372",
    "user": "vdelecroix"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_137373.json:
```json
{
    "body": "`@`ajagekar.akshay: why did you remove your branch? The commit lacks some examples (as the one of [comment:9 comment:9]).",
    "created_at": "2016-03-09T18:56:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137373",
    "user": "vdelecroix"
}
```

`@`ajagekar.akshay: why did you remove your branch? The commit lacks some examples (as the one of [comment:9 comment:9]).



---

archive/issue_comments_137374.json:
```json
{
    "body": "Replying to [comment:14 vdelecroix]:\n> `@`ajagekar.akshay: why did you remove your branch? The commit lacks some examples (as the one of [comment:9 comment:9]).\nSorry but I pushed that branch without testing, some tests failed.",
    "created_at": "2016-03-09T19:06:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137374",
    "user": "ajagekar.akshay"
}
```

Replying to [comment:14 vdelecroix]:
> `@`ajagekar.akshay: why did you remove your branch? The commit lacks some examples (as the one of [comment:9 comment:9]).
Sorry but I pushed that branch without testing, some tests failed.



---

archive/issue_comments_137375.json:
```json
{
    "body": "Replying to [comment:15 ajagekar.akshay]:\n> Replying to [comment:14 vdelecroix]:\n> > `@`ajagekar.akshay: why did you remove your branch? The commit lacks some examples (as the one of [comment:9 comment:9]).\n> Sorry but I pushed that branch without testing, some tests failed.\n\nThat is not a problem. Tickets can have different status: `closed`, `positive_review`, `needs_review`, `needs_work`, `new`. If there is no branch associated to a ticket it makes no sense to keep it into \"needs review\" state. (I already changed it to needs_work)",
    "created_at": "2016-03-09T19:08:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137375",
    "user": "vdelecroix"
}
```

Replying to [comment:15 ajagekar.akshay]:
> Replying to [comment:14 vdelecroix]:
> > `@`ajagekar.akshay: why did you remove your branch? The commit lacks some examples (as the one of [comment:9 comment:9]).
> Sorry but I pushed that branch without testing, some tests failed.

That is not a problem. Tickets can have different status: `closed`, `positive_review`, `needs_review`, `needs_work`, `new`. If there is no branch associated to a ticket it makes no sense to keep it into "needs review" state. (I already changed it to needs_work)



---

archive/issue_comments_137376.json:
```json
{
    "body": "Indeed, your code was good... and there is a bug somewhere else in the conversion from `SR` to the real interval fields:\n\n```\nsage: RealIntervalField(256)(SR(10^50 + 10^(-50))).is_int()\n(True, 100000000000000000000000000000000000000000000000000)\n```\n\n\nSorry, I was wrong. The method `is_int` is **not** intended to test if the interval is actually restricted to one integer! It only tests if the interval contains only one integer.",
    "created_at": "2016-03-09T19:14:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137376",
    "user": "vdelecroix"
}
```

Indeed, your code was good... and there is a bug somewhere else in the conversion from `SR` to the real interval fields:

```
sage: RealIntervalField(256)(SR(10^50 + 10^(-50))).is_int()
(True, 100000000000000000000000000000000000000000000000000)
```


Sorry, I was wrong. The method `is_int` is **not** intended to test if the interval is actually restricted to one integer! It only tests if the interval contains only one integer.



---

archive/issue_comments_137377.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-03-09T19:46:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137377",
    "user": "vdelecroix"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_137378.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-03-09T19:46:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137378",
    "user": "vdelecroix"
}
```

New commits:



---

archive/issue_comments_137379.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-03-09T19:58:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137379",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_137380.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-03-10T02:44:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137380",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_137381.json:
```json
{
    "body": "I pushed a tiny fix because we currently have\n\n```\nsage: log(8) / log(2) == 3\nFalse\n```\n\nSee the discussion at [this sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/xAlQmUF_cdU).",
    "created_at": "2016-03-10T02:45:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137381",
    "user": "vdelecroix"
}
```

I pushed a tiny fix because we currently have

```
sage: log(8) / log(2) == 3
False
```

See the discussion at [this sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/xAlQmUF_cdU).



---

archive/issue_comments_137382.json:
```json
{
    "body": "#15786 is a partial duplicate. I find the fix posted there a bit cleaner, though it needs to be rebased.",
    "created_at": "2016-03-24T14:35:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137382",
    "user": "mmezzarobba"
}
```

#15786 is a partial duplicate. I find the fix posted there a bit cleaner, though it needs to be rebased.



---

archive/issue_comments_137383.json:
```json
{
    "body": "Rebased on what!?\n\nThere is one thing I am not happy with. I think we should try to make the interval much smaller than 1 in\n\n```\nwhile x_interval.absolute_diameter() >= 1:\n    bits *= 2\n    x_interval = RealIntervalField(bits)(x)\n```\n\nbefore trying to simplify the expression. I guess that 2<sup>-30</sup> would be much more reasonable and avoid many attempts of (costly) simplification. What do you think?",
    "created_at": "2016-03-24T14:41:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137383",
    "user": "vdelecroix"
}
```

Rebased on what!?

There is one thing I am not happy with. I think we should try to make the interval much smaller than 1 in

```
while x_interval.absolute_diameter() >= 1:
    bits *= 2
    x_interval = RealIntervalField(bits)(x)
```

before trying to simplify the expression. I guess that 2<sup>-30</sup> would be much more reasonable and avoid many attempts of (costly) simplification. What do you think?



---

archive/issue_comments_137384.json:
```json
{
    "body": "Sorry if I wasn't clear. I'm saying that the *other* branch (the one at #15786) should be rebased.",
    "created_at": "2016-03-24T14:46:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137384",
    "user": "mmezzarobba"
}
```

Sorry if I wasn't clear. I'm saying that the *other* branch (the one at #15786) should be rebased.



---

archive/issue_comments_137385.json:
```json
{
    "body": "Be aware you might be using symbolics when doing bool( == ). To not end up with surprises you might want to break out the actual functionality you need out of `Expression.__nonzero__` or review #16397 and use `cmp`.",
    "created_at": "2016-03-24T14:59:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137385",
    "user": "rws"
}
```

Be aware you might be using symbolics when doing bool( == ). To not end up with surprises you might want to break out the actual functionality you need out of `Expression.__nonzero__` or review #16397 and use `cmp`.



---

archive/issue_comments_137386.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-03-24T15:52:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137386",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_137387.json:
```json
{
    "body": "Replying to [comment:25 rws]:\n> Be aware you might be using symbolics when doing bool( == ). To not end up with surprises you might want to break out the actual functionality you need out of `Expression.__nonzero__` or review #16397 and use `cmp`.\n\nYou mean that there is no way to check that `expr1 == expr2`? I do not want to copy/paste anything from other place. If testing equality is not available, there is a big problem.\n\nUsing `cmp` for that purpose is a bad idea. The purpose of `cmp` in Python 2 is to sort things out. Not to compare.",
    "created_at": "2016-03-24T15:55:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137387",
    "user": "vdelecroix"
}
```

Replying to [comment:25 rws]:
> Be aware you might be using symbolics when doing bool( == ). To not end up with surprises you might want to break out the actual functionality you need out of `Expression.__nonzero__` or review #16397 and use `cmp`.

You mean that there is no way to check that `expr1 == expr2`? I do not want to copy/paste anything from other place. If testing equality is not available, there is a big problem.

Using `cmp` for that purpose is a bad idea. The purpose of `cmp` in Python 2 is to sort things out. Not to compare.



---

archive/issue_comments_137388.json:
```json
{
    "body": "Testing equality of symbolics in general is undecidable. If you remove all expressions with variables however, it is easy: convert symbolic constants and function expressions to float as in `N()`, compare. Of course there are precision problems but that's nothing in comparison to what you get with variables.\n\nThe idea to abuse `cmp` is not mine. Somewhere here `RLF(1) < RLF(sqrt(2))` for example, symbolic `cmp` is called. Should I file a bug report for such usage?\n\nEDIT: typos",
    "created_at": "2016-03-24T16:11:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137388",
    "user": "rws"
}
```

Testing equality of symbolics in general is undecidable. If you remove all expressions with variables however, it is easy: convert symbolic constants and function expressions to float as in `N()`, compare. Of course there are precision problems but that's nothing in comparison to what you get with variables.

The idea to abuse `cmp` is not mine. Somewhere here `RLF(1) < RLF(sqrt(2))` for example, symbolic `cmp` is called. Should I file a bug report for such usage?

EDIT: typos



---

archive/issue_comments_137389.json:
```json
{
    "body": "Replying to [comment:28 rws]:\n> Testing equality of symbolics in general is undecidable. If you remove all expressions with variables however, it is easy\n\nIt is unknown if it is decidable (afaik) even without variables.\n\n> The idea to abuse `cmp` is not mine. Somewhere here `RLF(1) < RLF(sqrt(2))` for example, symbolic `cmp` is called. Should I file a bug report for such usage?\n\nI'd say it probably is a bug. As to whether you should file a bug report, I don't know\u2014I doubt anyone really reads them, and the issue is probably already covered somewhere in the myriad of known bugs with comparisons...",
    "created_at": "2016-03-24T16:19:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137389",
    "user": "mmezzarobba"
}
```

Replying to [comment:28 rws]:
> Testing equality of symbolics in general is undecidable. If you remove all expressions with variables however, it is easy

It is unknown if it is decidable (afaik) even without variables.

> The idea to abuse `cmp` is not mine. Somewhere here `RLF(1) < RLF(sqrt(2))` for example, symbolic `cmp` is called. Should I file a bug report for such usage?

I'd say it probably is a bug. As to whether you should file a bug report, I don't know—I doubt anyone really reads them, and the issue is probably already covered somewhere in the myriad of known bugs with comparisons...



---

archive/issue_comments_137390.json:
```json
{
    "body": "Replying to [comment:28 rws]:\n> Testing equality of symbolics in general is undecidable. If you remove all expressions with variables however, it is easy: convert symbolic constants and function expressions to float as in `N()`, compare. Of course there are precision problems but that's nothing in comparison to what you get with variables.\n\nWhat I need is a method that either returns a reliable answer `True` or `False` or raise an error which can either be `This comparison is meaningless` or `I don't know how to compare this`.",
    "created_at": "2016-03-24T16:20:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137390",
    "user": "vdelecroix"
}
```

Replying to [comment:28 rws]:
> Testing equality of symbolics in general is undecidable. If you remove all expressions with variables however, it is easy: convert symbolic constants and function expressions to float as in `N()`, compare. Of course there are precision problems but that's nothing in comparison to what you get with variables.

What I need is a method that either returns a reliable answer `True` or `False` or raise an error which can either be `This comparison is meaningless` or `I don't know how to compare this`.



---

archive/issue_comments_137391.json:
```json
{
    "body": "Replying to [comment:30 vdelecroix]:\n> What I need is a method that either returns a reliable answer `True` or `False` or raise an error which can either be `This comparison is meaningless` or `I don't know how to compare this`.\nThen `bool( == )` is right for the moment and may be replaced with #19040. As said don't be surprised if it takes a long time.",
    "created_at": "2016-03-24T16:39:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137391",
    "user": "rws"
}
```

Replying to [comment:30 vdelecroix]:
> What I need is a method that either returns a reliable answer `True` or `False` or raise an error which can either be `This comparison is meaningless` or `I don't know how to compare this`.
Then `bool( == )` is right for the moment and may be replaced with #19040. As said don't be surprised if it takes a long time.



---

archive/issue_comments_137392.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-03-24T18:20:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137392",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_137393.json:
```json
{
    "body": "Replying to [comment:31 rws]:\n> Replying to [comment:30 vdelecroix]:\n> > What I need is a method that either returns a reliable answer `True` or `False` or raise an error which can either be `This comparison is meaningless` or `I don't know how to compare this`.\n> Then `bool( == )` is right for the moment and may be replaced with #19040. As said don't be surprised if it takes a long time.\n\nI added a note about #19040.",
    "created_at": "2016-03-24T18:21:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137393",
    "user": "vdelecroix"
}
```

Replying to [comment:31 rws]:
> Replying to [comment:30 vdelecroix]:
> > What I need is a method that either returns a reliable answer `True` or `False` or raise an error which can either be `This comparison is meaningless` or `I don't know how to compare this`.
> Then `bool( == )` is right for the moment and may be replaced with #19040. As said don't be surprised if it takes a long time.

I added a note about #19040.



---

archive/issue_comments_137394.json:
```json
{
    "body": "Hi Vincent,\n\nSorry for my unclear comments above, I didn't look closely enough at your code before posting them.\n\nBeside the issue with comparisons raised by Ralf, I find the code on your branch a bit complicated, and I don't like the fact that you drop the `maximum_bits` parameters at the risk of looping forever if you cannot prove that the input is an integer. I pushed to `u/mmezzarobba/12121-ceil` a rough attempt to fix these issues (in the case of `ceil` only at the moment, and not well tested yet), please tell me what you think of it.",
    "created_at": "2016-03-25T15:59:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137394",
    "user": "mmezzarobba"
}
```

Hi Vincent,

Sorry for my unclear comments above, I didn't look closely enough at your code before posting them.

Beside the issue with comparisons raised by Ralf, I find the code on your branch a bit complicated, and I don't like the fact that you drop the `maximum_bits` parameters at the risk of looping forever if you cannot prove that the input is an integer. I pushed to `u/mmezzarobba/12121-ceil` a rough attempt to fix these issues (in the case of `ceil` only at the moment, and not well tested yet), please tell me what you think of it.



---

archive/issue_comments_137395.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-03-25T15:59:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137395",
    "user": "mmezzarobba"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_137396.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-04-05T21:11:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137396",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_137397.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-04-05T21:12:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137397",
    "user": "vdelecroix"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_137398.json:
```json
{
    "body": "All right. I factorized the two implementations in a new function `incremental_rounding`. It is cleaner and the parameter `maximum_bits` is reintroduced.",
    "created_at": "2016-04-05T21:12:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137398",
    "user": "vdelecroix"
}
```

All right. I factorized the two implementations in a new function `incremental_rounding`. It is cleaner and the parameter `maximum_bits` is reintroduced.



---

archive/issue_comments_137399.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-04-06T01:57:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137399",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_137400.json:
```json
{
    "body": "I fear I won't have time to review your new version in the next few days at least, but from a quick look at it there are a lot of things I don't understand. In no particular order:\n* why do you make `maximum_bits` an `Integer`?\n* what don't you like about `unique_integer()`?\n* is it really better to have an absolute bound for the diameter that makes us suspect we found an exact integer, rather than something that depends on the precision?\n* why do you insist on using `==` on symbolic expressions instead of `is_trivial_zero()`?\n* are you sure you want to raise an error when `maximum_bits` does not suffice to conclude? this is a symbolic function that may be buried deep in the middle of a symbolic expression; returning unevaluated seems more reasonable to me...\n* do we really need two loops that do essentially the same thing (including raising errors with the exact same message)?",
    "created_at": "2016-04-06T08:41:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137400",
    "user": "mmezzarobba"
}
```

I fear I won't have time to review your new version in the next few days at least, but from a quick look at it there are a lot of things I don't understand. In no particular order:
* why do you make `maximum_bits` an `Integer`?
* what don't you like about `unique_integer()`?
* is it really better to have an absolute bound for the diameter that makes us suspect we found an exact integer, rather than something that depends on the precision?
* why do you insist on using `==` on symbolic expressions instead of `is_trivial_zero()`?
* are you sure you want to raise an error when `maximum_bits` does not suffice to conclude? this is a symbolic function that may be buried deep in the middle of a symbolic expression; returning unevaluated seems more reasonable to me...
* do we really need two loops that do essentially the same thing (including raising errors with the exact same message)?



---

archive/issue_comments_137401.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-04-06T17:17:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137401",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_137402.json:
```json
{
    "body": "I removed the `__call__` in both `Function_floor` and `Function_ceil`. The code is now much simpler. Though there was some adaptation needed in `symbolic/expression.pyx`.\n\nReplying to [comment:39 mmezzarobba]:\n> I fear I won't have time to review your new version in the next few days at least, but from a quick look at it there are a lot of things I don't understand. In no particular order:\n> * why do you make `maximum_bits` an `Integer`?\n\nall right. `int` is fine as well.\n\n> * what don't you like about `unique_integer()`?\n\nan `assert` does not cost anything. And `unique_integer` silently fails if the interval does not enclose a unique integer.\n\n> * is it really better to have an absolute bound for the diameter that makes us suspect we found an exact integer, rather than something that depends on the precision?\n\nthe precision of what? there is the field used for the evaluation which is different from the diameter of the interval. If you have more than one integer in your interval which one are you using to test equality?\n\n> * why do you insist on using `==` on symbolic expressions instead of `is_trivial_zero()`?\n\nBecause I want to check equality with an integer. Not if it is a trivial equality.\n\n> * are you sure you want to raise an error when `maximum_bits` does not suffice to conclude? this is a symbolic function that may be buried deep in the middle of a symbolic expression; returning unevaluated seems more reasonable to me...\n\nDone with an example.\n\n> * do we really need two loops that do essentially the same thing (including raising errors with the exact same message)?\n\nThe equality test is potentially costly. And we want to avoid it as much as possible. In particular, it makes no sense to test this equality within each step of the loop as it is in your version. On a related note, I noticed that for `round` you need to test equality with elements of `ZZ + 1/2`.",
    "created_at": "2016-04-06T17:18:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137402",
    "user": "vdelecroix"
}
```

I removed the `__call__` in both `Function_floor` and `Function_ceil`. The code is now much simpler. Though there was some adaptation needed in `symbolic/expression.pyx`.

Replying to [comment:39 mmezzarobba]:
> I fear I won't have time to review your new version in the next few days at least, but from a quick look at it there are a lot of things I don't understand. In no particular order:
> * why do you make `maximum_bits` an `Integer`?

all right. `int` is fine as well.

> * what don't you like about `unique_integer()`?

an `assert` does not cost anything. And `unique_integer` silently fails if the interval does not enclose a unique integer.

> * is it really better to have an absolute bound for the diameter that makes us suspect we found an exact integer, rather than something that depends on the precision?

the precision of what? there is the field used for the evaluation which is different from the diameter of the interval. If you have more than one integer in your interval which one are you using to test equality?

> * why do you insist on using `==` on symbolic expressions instead of `is_trivial_zero()`?

Because I want to check equality with an integer. Not if it is a trivial equality.

> * are you sure you want to raise an error when `maximum_bits` does not suffice to conclude? this is a symbolic function that may be buried deep in the middle of a symbolic expression; returning unevaluated seems more reasonable to me...

Done with an example.

> * do we really need two loops that do essentially the same thing (including raising errors with the exact same message)?

The equality test is potentially costly. And we want to avoid it as much as possible. In particular, it makes no sense to test this equality within each step of the loop as it is in your version. On a related note, I noticed that for `round` you need to test equality with elements of `ZZ + 1/2`.



---

archive/issue_comments_137403.json:
```json
{
    "body": "Replying to [comment:41 vdelecroix]:\n> Replying to [comment:39 mmezzarobba]:\n> > * do we really need two loops that do essentially the same thing (including raising errors with the exact same message)?\n> \n> The equality test is potentially costly. And we want to avoid it as much as possible. In particular, it makes no sense to test this equality within each step of the loop as it is in your version. On a related note, I noticed that for `round` you need to test equality with elements of `ZZ + 1/2`. \n\nAnd I also would like to use the very same function `incremental_rounding` for elements of `QQbar`. For the very same reason, you only want very lately the equality test.",
    "created_at": "2016-04-06T19:06:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137403",
    "user": "vdelecroix"
}
```

Replying to [comment:41 vdelecroix]:
> Replying to [comment:39 mmezzarobba]:
> > * do we really need two loops that do essentially the same thing (including raising errors with the exact same message)?
> 
> The equality test is potentially costly. And we want to avoid it as much as possible. In particular, it makes no sense to test this equality within each step of the loop as it is in your version. On a related note, I noticed that for `round` you need to test equality with elements of `ZZ + 1/2`. 

And I also would like to use the very same function `incremental_rounding` for elements of `QQbar`. For the very same reason, you only want very lately the equality test.



---

archive/issue_comments_137404.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-04-06T19:31:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137404",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_137405.json:
```json
{
    "body": "ping?!",
    "created_at": "2016-04-28T22:49:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137405",
    "user": "vdelecroix"
}
```

ping?!



---

archive/issue_comments_137406.json:
```json
{
    "body": "Sorry, I have about zero time for Sage development before at least 1-2 weeks. All I can say is that I wasn't completely convinced by your answers and would need to think things over more carefully. If someone wants to review the ticket in the meantime, please do.",
    "created_at": "2016-04-29T11:27:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137406",
    "user": "mmezzarobba"
}
```

Sorry, I have about zero time for Sage development before at least 1-2 weeks. All I can say is that I wasn't completely convinced by your answers and would need to think things over more carefully. If someone wants to review the ticket in the meantime, please do.



---

archive/issue_comments_137407.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-05-08T02:45:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137407",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_137408.json:
```json
{
    "body": "rebased on 7-2.rc1",
    "created_at": "2016-05-08T02:45:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137408",
    "user": "vdelecroix"
}
```

rebased on 7-2.rc1



---

archive/issue_comments_137409.json:
```json
{
    "body": "Okay, I'm back. Sorry that it took so long.\n\nReplying to [comment:41 vdelecroix]:\n> > * what don't you like about `unique_integer()`?\n> \n> an `assert` does not cost anything. And `unique_integer` silently fails if the interval does not enclose a unique integer.\n\nUh? No, it doesn't.\n\n> > * is it really better to have an absolute bound for the diameter that makes us suspect we found an exact integer, rather than something that depends on the precision?\n> \n> the precision of what? there is the field used for the evaluation which is different from the diameter of the interval. If you have more than one integer in your interval which one are you using to test equality?\n\nThe precision of the interval computation, i.e. `bits`. The idea being that if we found an interval of width (say) 2\u207b\u00b2\u2070 containing an integer by computing with 1000 bits of precision, we may want to see if the width of the interval keeps decreasing when the precision increases and only run the symbolic part of the algorithm if that's the case. But I agree that this is a very minor issue at best.\n\n> > * why do you insist on using `==` on symbolic expressions instead of `is_trivial_zero()`?\n> \n> Because I want to check equality with an integer. Not if it is a trivial equality.\n\nI mean using `is_trivial_zero()` after calling `full_simplify()` & co, as in my version: this is safer than relying on `==` and essentially as powerful.\n\n> > * do we really need two loops that do essentially the same thing (including raising errors with the exact same message)?\n> \n> The equality test is potentially costly. And we want to avoid it as much as possible. In particular, it makes no sense to test this equality within each step of the loop as it is in your version.\n\nYes\u2014as I said, my version was just a rough sketch of the changes I'd b tempted to make, nothing finished. As the code I was starting with used to loop forever in the typical situation where mine would do the symbolic test repeatedly (that is, `x` \u2208 \u2124 integer but we don't manage to prove it), I thought the additional cost would be acceptable. `;-)` But anyway, it is not hard to do the test only once while avoiding the code duplication.\n\n> On a related note, I noticed that for `round` you need to test equality with elements of `ZZ + 1/2`. \n\nCouldn't you just compute ceil(x-1/2)?\n\n------\n\nNow for some comments on the current code:\n\n* To summarize the above, I still think the main logic in `incremental_rounding()` could be shortened to something like (not tested):\n\n```\n    unique_rounding = getattr(RealIntervalFieldElement, 'unique_' + mode)\n    r = RR.one() >> 20\n\n    bits = 64\n    candidate = None\n    while bits < maximum_bits:\n        interval = RealIntervalField(bits)(x) # may raise a TypeError\n        try:\n            return unique_rounding(interval)\n        except ValueError:\n            pass\n        if candidate is None and interval.absolute_diameter() > r:\n            candidate = interval.unique_integer()\n            try:\n                delta = x - candidate\n                if (delta.is_zero()\n                        or SR(delta).full_simplify().canonicalize_radical()\n                                    .is_trivial_zero()\n                        or QQbar(delta).is_zero()):\n                    return candidate\n                except (TypeError, ValueError):\n                    pass\n        bits *= 2\n```\n\n\n* I'd also make `incremental_rounding()` private and dispense with the argument checking (and perhaps move it to `real_mpfi` if your plan is to use it from elsewhere)\u2014but I'm okay with keeping it as it is. An advantage of making it private is that you could take the \u201cunique rounding\u201d function on intervals as input instead of accessing it via `getattr()`. Another option would be to introduce a common base class for `Function_floor`, `Function_ceil` and `Function_round`.\n\n* I'm a little uneasy about the changes you made to `BuiltinFunction.__call__()`. The fact that it used to convert non-Element inputs to Elements looks intentional and pretty reasonable to me. Is it really necessary to change that behavior? That being said, I'm a bit lost in the maze of `Function.__call__`, `BuiltinFunction.__call__`, `_eval_`, `_evalf_`, `_evalf_try_` and friends, so if you tell me you are confident that the change is correct I'll trust you!\n\n* If these changes stay, then I guess this\n\n```\nif module is not None:\n    func = getattr(module, self._name, None)\n    if func is None and self._alt_name is not None:\n        func = getattr(module, self._name, None)\n                                    ^^^^^\n```\n\n  should be `_alt_name`.\n\n* Note that these changes also make\n\n```\nsage: sin(numpy.int32(0))\n0.0\n```\n\n  which is at odds with\n\n```\nsage: sin(ZZ(0)).parent()\nInteger Ring\n```\n\n  (perhaps not ideal, but predictable at least).\n\n* In `Function_*`, what is the point of calling `_evalf_()` from `_eval_()`?\n\n* And why isn't the logic for choosing `maximum_bits` in `_evalf_()` the same in `floor`, `ceil` and `round`?\n\n* I wouldn't bother with checking that `x` is not a relation. First, `_eval_()` methods of individual functions are probably not the right place for that (either `BuiltinFunction.__call__()` or perhaps methods `ceil()`, `floor()` etc. in a future subclass `RelationalExpression` of `Expression` would be more reasonable). Besides, various other nonsensical inputs (e.g. series, booleans) are accepted without error, so it is a bit strange to have an ad hoc check dealing with this one.",
    "created_at": "2016-05-17T13:42:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137409",
    "user": "mmezzarobba"
}
```

Okay, I'm back. Sorry that it took so long.

Replying to [comment:41 vdelecroix]:
> > * what don't you like about `unique_integer()`?
> 
> an `assert` does not cost anything. And `unique_integer` silently fails if the interval does not enclose a unique integer.

Uh? No, it doesn't.

> > * is it really better to have an absolute bound for the diameter that makes us suspect we found an exact integer, rather than something that depends on the precision?
> 
> the precision of what? there is the field used for the evaluation which is different from the diameter of the interval. If you have more than one integer in your interval which one are you using to test equality?

The precision of the interval computation, i.e. `bits`. The idea being that if we found an interval of width (say) 2⁻²⁰ containing an integer by computing with 1000 bits of precision, we may want to see if the width of the interval keeps decreasing when the precision increases and only run the symbolic part of the algorithm if that's the case. But I agree that this is a very minor issue at best.

> > * why do you insist on using `==` on symbolic expressions instead of `is_trivial_zero()`?
> 
> Because I want to check equality with an integer. Not if it is a trivial equality.

I mean using `is_trivial_zero()` after calling `full_simplify()` & co, as in my version: this is safer than relying on `==` and essentially as powerful.

> > * do we really need two loops that do essentially the same thing (including raising errors with the exact same message)?
> 
> The equality test is potentially costly. And we want to avoid it as much as possible. In particular, it makes no sense to test this equality within each step of the loop as it is in your version.

Yes—as I said, my version was just a rough sketch of the changes I'd b tempted to make, nothing finished. As the code I was starting with used to loop forever in the typical situation where mine would do the symbolic test repeatedly (that is, `x` ∈ ℤ integer but we don't manage to prove it), I thought the additional cost would be acceptable. `;-)` But anyway, it is not hard to do the test only once while avoiding the code duplication.

> On a related note, I noticed that for `round` you need to test equality with elements of `ZZ + 1/2`. 

Couldn't you just compute ceil(x-1/2)?

------

Now for some comments on the current code:

* To summarize the above, I still think the main logic in `incremental_rounding()` could be shortened to something like (not tested):

```
    unique_rounding = getattr(RealIntervalFieldElement, 'unique_' + mode)
    r = RR.one() >> 20

    bits = 64
    candidate = None
    while bits < maximum_bits:
        interval = RealIntervalField(bits)(x) # may raise a TypeError
        try:
            return unique_rounding(interval)
        except ValueError:
            pass
        if candidate is None and interval.absolute_diameter() > r:
            candidate = interval.unique_integer()
            try:
                delta = x - candidate
                if (delta.is_zero()
                        or SR(delta).full_simplify().canonicalize_radical()
                                    .is_trivial_zero()
                        or QQbar(delta).is_zero()):
                    return candidate
                except (TypeError, ValueError):
                    pass
        bits *= 2
```


* I'd also make `incremental_rounding()` private and dispense with the argument checking (and perhaps move it to `real_mpfi` if your plan is to use it from elsewhere)—but I'm okay with keeping it as it is. An advantage of making it private is that you could take the “unique rounding” function on intervals as input instead of accessing it via `getattr()`. Another option would be to introduce a common base class for `Function_floor`, `Function_ceil` and `Function_round`.

* I'm a little uneasy about the changes you made to `BuiltinFunction.__call__()`. The fact that it used to convert non-Element inputs to Elements looks intentional and pretty reasonable to me. Is it really necessary to change that behavior? That being said, I'm a bit lost in the maze of `Function.__call__`, `BuiltinFunction.__call__`, `_eval_`, `_evalf_`, `_evalf_try_` and friends, so if you tell me you are confident that the change is correct I'll trust you!

* If these changes stay, then I guess this

```
if module is not None:
    func = getattr(module, self._name, None)
    if func is None and self._alt_name is not None:
        func = getattr(module, self._name, None)
                                    ^^^^^
```

  should be `_alt_name`.

* Note that these changes also make

```
sage: sin(numpy.int32(0))
0.0
```

  which is at odds with

```
sage: sin(ZZ(0)).parent()
Integer Ring
```

  (perhaps not ideal, but predictable at least).

* In `Function_*`, what is the point of calling `_evalf_()` from `_eval_()`?

* And why isn't the logic for choosing `maximum_bits` in `_evalf_()` the same in `floor`, `ceil` and `round`?

* I wouldn't bother with checking that `x` is not a relation. First, `_eval_()` methods of individual functions are probably not the right place for that (either `BuiltinFunction.__call__()` or perhaps methods `ceil()`, `floor()` etc. in a future subclass `RelationalExpression` of `Expression` would be more reasonable). Besides, various other nonsensical inputs (e.g. series, booleans) are accepted without error, so it is a bit strange to have an ad hoc check dealing with this one.



---

archive/issue_comments_137410.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-05-17T13:42:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137410",
    "user": "mmezzarobba"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_137411.json:
```json
{
    "body": "You may be interested in #20624. It looks like implementing `_evalf_` by calling `_eval_` is VERY bad: currently evaluation of `ceil` may lead to running out the python call stack before doing anything useful. Obviously, this takes some time. Inheriting from `BuiltinFunction` is a real bugtrap: its init reassigns a whole bunch of methods.",
    "created_at": "2016-05-19T02:38:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137411",
    "user": "nbruin"
}
```

You may be interested in #20624. It looks like implementing `_evalf_` by calling `_eval_` is VERY bad: currently evaluation of `ceil` may lead to running out the python call stack before doing anything useful. Obviously, this takes some time. Inheriting from `BuiltinFunction` is a real bugtrap: its init reassigns a whole bunch of methods.



---

archive/issue_comments_137412.json:
```json
{
    "body": "Replying to [comment:50 nbruin]:\n> Inheriting from `BuiltinFunction` is a real bugtrap: its init reassigns a whole bunch of methods.\nThat must be the reason why Sage crashes all the time. Seriously, I agree the construction of functions is messy and it limits the developer somewhat, see \"other symbolic function tickets\" in http://trac.sagemath.org/wiki/symbolics/functions. Note also there are a bunch of tickets needing review there. However, I think the design is sound. You just have to read how other functions (the more recently implemented) are using it. In the end, I or someone will be transferring the Python you write to Pynac, anyway.\n\nCc: the author of the `_evalf_try_` mechanism.",
    "created_at": "2016-05-19T05:39:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137412",
    "user": "rws"
}
```

Replying to [comment:50 nbruin]:
> Inheriting from `BuiltinFunction` is a real bugtrap: its init reassigns a whole bunch of methods.
That must be the reason why Sage crashes all the time. Seriously, I agree the construction of functions is messy and it limits the developer somewhat, see "other symbolic function tickets" in http://trac.sagemath.org/wiki/symbolics/functions. Note also there are a bunch of tickets needing review there. However, I think the design is sound. You just have to read how other functions (the more recently implemented) are using it. In the end, I or someone will be transferring the Python you write to Pynac, anyway.

Cc: the author of the `_evalf_try_` mechanism.



---

archive/issue_comments_137413.json:
```json
{
    "body": "Replying to [comment:50 nbruin]:\n> You may be interested in #20624. It looks like implementing `_evalf_` by calling `_eval_` is VERY bad: currently evaluation of `ceil` may lead to running out the python call stack before doing anything useful.\n\nI may be mistaken but actually `_eval_` calls `_evalf_` here which is a completely different matter.\n----\nNew commits:",
    "created_at": "2016-06-11T15:43:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137413",
    "user": "rws"
}
```

Replying to [comment:50 nbruin]:
> You may be interested in #20624. It looks like implementing `_evalf_` by calling `_eval_` is VERY bad: currently evaluation of `ceil` may lead to running out the python call stack before doing anything useful.

I may be mistaken but actually `_eval_` calls `_evalf_` here which is a completely different matter.
----
New commits:



---

archive/issue_comments_137414.json:
```json
{
    "body": "Replying to [comment:49 mmezzarobba]:\n> > On a related note, I noticed that for `round` you need to test equality with elements of `ZZ + 1/2`. \n> \n> Couldn't you just compute ceil(x-1/2)?\n\n\n```\nsage: x = 0.5\nsage: print x.round() == (x-0.5).ceil()\nFalse\n```\n",
    "created_at": "2016-07-13T15:48:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137414",
    "user": "vdelecroix"
}
```

Replying to [comment:49 mmezzarobba]:
> > On a related note, I noticed that for `round` you need to test equality with elements of `ZZ + 1/2`. 
> 
> Couldn't you just compute ceil(x-1/2)?


```
sage: x = 0.5
sage: print x.round() == (x-0.5).ceil()
False
```




---

archive/issue_comments_137415.json:
```json
{
    "body": "Replying to [comment:49 mmezzarobba]:\n> * In `Function_*`, what is the point of calling `_evalf_()` from `_eval_()`?\n\nBecause I want the answer of `floor(pi)` to be `3`.",
    "created_at": "2016-07-13T16:23:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137415",
    "user": "vdelecroix"
}
```

Replying to [comment:49 mmezzarobba]:
> * In `Function_*`, what is the point of calling `_evalf_()` from `_eval_()`?

Because I want the answer of `floor(pi)` to be `3`.



---

archive/issue_comments_137416.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-07-13T16:39:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137416",
    "user": "vdelecroix"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_137417.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-07-13T16:39:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137417",
    "user": "vdelecroix"
}
```

New commits:



---

archive/issue_comments_137418.json:
```json
{
    "body": "`Function` mechanics looking very good. Can't comment on the `incremental_rounding()` function part.",
    "created_at": "2016-07-14T06:08:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137418",
    "user": "rws"
}
```

`Function` mechanics looking very good. Can't comment on the `incremental_rounding()` function part.



---

archive/issue_comments_137419.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-08-10T23:16:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137419",
    "user": "vdelecroix"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_137420.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-08-17T21:54:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137420",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_137421.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-08-17T21:55:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137421",
    "user": "vdelecroix"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_137422.json:
```json
{
    "body": "Rebased on the last beta (which includes #21216).\n\nI slightly modified `incremental_rounding`. The simplification part is implemented outside. As soon as there is a reliable `is_zero` available for elements of SR (as it is the case for `QQbar` with `is_zero`) we could make it cleaner.",
    "created_at": "2016-08-17T21:55:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137422",
    "user": "vdelecroix"
}
```

Rebased on the last beta (which includes #21216).

I slightly modified `incremental_rounding`. The simplification part is implemented outside. As soon as there is a reliable `is_zero` available for elements of SR (as it is the case for `QQbar` with `is_zero`) we could make it cleaner.



---

archive/issue_comments_137423.json:
```json
{
    "body": "Hi Vincent,\n\nSorry for taking so long to reply once again. The code is starting to look really good to me overall, but calling the buggy `is_zero()` causes regressions such as:\n\n```\nsage: foo = sin(1 + 10^(-30)) - sin(1)\nsage: ceil(foo)\n0\nsage: floor(foo)\n0\n```\n\nI know we already talked about that above, but are you sure you don't want `incremental_rounding()` to use `is_trivial_zero()` (probably after some simplification) instead?",
    "created_at": "2016-09-16T09:59:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137423",
    "user": "mmezzarobba"
}
```

Hi Vincent,

Sorry for taking so long to reply once again. The code is starting to look really good to me overall, but calling the buggy `is_zero()` causes regressions such as:

```
sage: foo = sin(1 + 10^(-30)) - sin(1)
sage: ceil(foo)
0
sage: floor(foo)
0
```

I know we already talked about that above, but are you sure you don't want `incremental_rounding()` to use `is_trivial_zero()` (probably after some simplification) instead?



---

archive/issue_comments_137424.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-09-16T09:59:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137424",
    "user": "mmezzarobba"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_137425.json:
```json
{
    "body": "I definitely want a `incremental_rounding` that is symbolic ring agnostic. A solution would be to have an optional argument `is_zero`. What do you think?",
    "created_at": "2016-09-17T07:05:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137425",
    "user": "vdelecroix"
}
```

I definitely want a `incremental_rounding` that is symbolic ring agnostic. A solution would be to have an optional argument `is_zero`. What do you think?



---

archive/issue_comments_137426.json:
```json
{
    "body": "(of course the argument would have default \"the_object.is_zero\")",
    "created_at": "2016-09-17T07:14:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137426",
    "user": "vdelecroix"
}
```

(of course the argument would have default "the_object.is_zero")



---

archive/issue_comments_137427.json:
```json
{
    "body": "Replying to [comment:63 vdelecroix]:\n> I definitely want a `incremental_rounding` that is symbolic ring agnostic. A solution would be to have an optional argument `is_zero`. What do you think?\n\nThat sounds good.",
    "created_at": "2016-09-17T11:09:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137427",
    "user": "mmezzarobba"
}
```

Replying to [comment:63 vdelecroix]:
> I definitely want a `incremental_rounding` that is symbolic ring agnostic. A solution would be to have an optional argument `is_zero`. What do you think?

That sounds good.



---

archive/issue_comments_137428.json:
```json
{
    "body": "And `is_trivial_zero` could not be a solution anyway\n\n```\nsage: delta = (11/9*sqrt(3)*sqrt(2) + 3)^(1/3) + 1/3/(11/9*sqrt(3)*sqrt(2) + 3)^(1/3) - 2\nsage: delta.is_zero()\nTrue\nsage: delta.is_trivial_zero()\nFalse\nsage: delta2 = delta.full_simplify().canonicalize_radical()\nsage: delta2.is_zero()\nTrue\nsage: delta2.is_trivial_zero()\nFalse\n```\n",
    "created_at": "2016-09-17T11:31:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137428",
    "user": "vdelecroix"
}
```

And `is_trivial_zero` could not be a solution anyway

```
sage: delta = (11/9*sqrt(3)*sqrt(2) + 3)^(1/3) + 1/3/(11/9*sqrt(3)*sqrt(2) + 3)^(1/3) - 2
sage: delta.is_zero()
True
sage: delta.is_trivial_zero()
False
sage: delta2 = delta.full_simplify().canonicalize_radical()
sage: delta2.is_zero()
True
sage: delta2.is_trivial_zero()
False
```




---

archive/issue_comments_137429.json:
```json
{
    "body": "Even better\n\n```\nsage: (sin(1 - 10^(-100)) - sin(1)).is_zero()\nTrue\nage: bool(sin(1 - 10^(-100)) - sin(1) == 0)\nTrue\n```\n\nI thought that we should only worry about false negatives...",
    "created_at": "2016-09-17T11:44:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137429",
    "user": "vdelecroix"
}
```

Even better

```
sage: (sin(1 - 10^(-100)) - sin(1)).is_zero()
True
age: bool(sin(1 - 10^(-100)) - sin(1) == 0)
True
```

I thought that we should only worry about false negatives...



---

archive/issue_comments_137430.json:
```json
{
    "body": "See the following thread\n\n    https://groups.google.com/forum/#!topic/sage-devel/qitYHanQiEo",
    "created_at": "2016-09-17T11:50:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137430",
    "user": "vdelecroix"
}
```

See the following thread

    https://groups.google.com/forum/#!topic/sage-devel/qitYHanQiEo



---

archive/issue_comments_137431.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-09-17T13:51:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137431",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_137432.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-09-17T13:53:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137432",
    "user": "vdelecroix"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_137433.json:
```json
{
    "body": "You removed the symbolic property of `frac()` and you didn't give any justification for it.",
    "created_at": "2016-09-17T14:14:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137433",
    "user": "rws"
}
```

You removed the symbolic property of `frac()` and you didn't give any justification for it.



---

archive/issue_comments_137434.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-09-17T14:24:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137434",
    "user": "rws"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_137435.json:
```json
{
    "body": "Please try to fix your code so previous frac doctests work.",
    "created_at": "2016-09-17T14:24:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137435",
    "user": "rws"
}
```

Please try to fix your code so previous frac doctests work.



---

archive/issue_comments_137436.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-09-17T16:19:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137436",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_137437.json:
```json
{
    "body": "Ralf, what do you call the \"symbolic property\" of `frac`?\n\nOn the other hand I have comments about the previous code of `frac`\n- it is the role of the function `floor` to call the method `floor` if needed. There is no need to redo it now and then\n- special casing `int` and `float` when the generic `x - floor(x)` does work is weird (not mentioning that this was not tested). In this case I would prefer that it behaves like floor and ceil (ie frac(float) returning float). The previous version returned Sage integer, why is that?\n\nI let the `frac(x + y)` not be transformed in `x + y - floor(x + y)` in my new last commit. Please tell me if you like it better.",
    "created_at": "2016-09-17T16:24:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137437",
    "user": "vdelecroix"
}
```

Ralf, what do you call the "symbolic property" of `frac`?

On the other hand I have comments about the previous code of `frac`
- it is the role of the function `floor` to call the method `floor` if needed. There is no need to redo it now and then
- special casing `int` and `float` when the generic `x - floor(x)` does work is weird (not mentioning that this was not tested). In this case I would prefer that it behaves like floor and ceil (ie frac(float) returning float). The previous version returned Sage integer, why is that?

I let the `frac(x + y)` not be transformed in `x + y - floor(x + y)` in my new last commit. Please tell me if you like it better.



---

archive/issue_comments_137438.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-09-17T16:24:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137438",
    "user": "vdelecroix"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_137439.json:
```json
{
    "body": "Replying to [comment:66 vdelecroix]:\n> And `is_trivial_zero` could not be a solution anyway\n> {{{\n> sage: delta = (11/9*sqrt(3)*sqrt(2) + 3)^(1/3) + 1/3/(11/9*sqrt(3)*sqrt(2) + 3)^(1/3) - 2\n> }}}\n\nWell, of course there will always be examples where the zero-test fails! Above I suggested to try both simplification followed by `is_trivial_zero()` and conversion to `QQbar`, this would take care of this example.",
    "created_at": "2016-09-17T17:04:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137439",
    "user": "mmezzarobba"
}
```

Replying to [comment:66 vdelecroix]:
> And `is_trivial_zero` could not be a solution anyway
> {{{
> sage: delta = (11/9*sqrt(3)*sqrt(2) + 3)^(1/3) + 1/3/(11/9*sqrt(3)*sqrt(2) + 3)^(1/3) - 2
> }}}

Well, of course there will always be examples where the zero-test fails! Above I suggested to try both simplification followed by `is_trivial_zero()` and conversion to `QQbar`, this would take care of this example.



---

archive/issue_comments_137440.json:
```json
{
    "body": "Replying to [comment:67 vdelecroix]:\n> Even better\n> {{{\n> sage: (sin(1 - 10^(-100)) - sin(1)).is_zero()\n> True\n> age: bool(sin(1 - 10^(-100)) - sin(1) == 0)\n> True\n> }}}\n\nYes; I thought that was what the comment about `is_zero()` being unreliable was about.",
    "created_at": "2016-09-17T17:07:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137440",
    "user": "mmezzarobba"
}
```

Replying to [comment:67 vdelecroix]:
> Even better
> {{{
> sage: (sin(1 - 10^(-100)) - sin(1)).is_zero()
> True
> age: bool(sin(1 - 10^(-100)) - sin(1) == 0)
> True
> }}}

Yes; I thought that was what the comment about `is_zero()` being unreliable was about.



---

archive/issue_comments_137441.json:
```json
{
    "body": "Replying to [comment:77 mmezzarobba]:\n> Replying to [comment:67 vdelecroix]:\n> > Even better\n> > {{{\n> > sage: (sin(1 - 10^(-100)) - sin(1)).is_zero()\n> > True\n> > age: bool(sin(1 - 10^(-100)) - sin(1) == 0)\n> > True\n> > }}}\n> \n> Yes; I thought that was what the comment about `is_zero()` being unreliable was about.\n\nFor me unreliable was \"sometimes there are false negative\". But it is not only that as there are \"false positive\". Meaning that\n\n```\ndef is_zero(x):\n    return randint(0, 1)\n```\n\nis equally good.",
    "created_at": "2016-09-17T19:03:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137441",
    "user": "vdelecroix"
}
```

Replying to [comment:77 mmezzarobba]:
> Replying to [comment:67 vdelecroix]:
> > Even better
> > {{{
> > sage: (sin(1 - 10^(-100)) - sin(1)).is_zero()
> > True
> > age: bool(sin(1 - 10^(-100)) - sin(1) == 0)
> > True
> > }}}
> 
> Yes; I thought that was what the comment about `is_zero()` being unreliable was about.

For me unreliable was "sometimes there are false negative". But it is not only that as there are "false positive". Meaning that

```
def is_zero(x):
    return randint(0, 1)
```

is equally good.



---

archive/issue_comments_137442.json:
```json
{
    "body": "If you have a `reliable_is_zero_for_SR` I will of course include it ;-)",
    "created_at": "2016-09-17T19:04:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137442",
    "user": "vdelecroix"
}
```

If you have a `reliable_is_zero_for_SR` I will of course include it ;-)



---

archive/issue_comments_137443.json:
```json
{
    "body": "Replying to [comment:74 vdelecroix]:\n> Ralf, what do you call the \"symbolic property\" of `frac`?\n\nThat it can be part of expressions. In the first version of your \"fix frac\" commit you unconditionally expanded `frac(...)` and forced the user to use `hold=True` to get the symbolic `frac()`.\n\n> I let the `frac(x + y)` not be transformed in `x + y - floor(x + y)` in my new last commit. Please tell me if you like it better.\n\nI do!\n\nMarc:\n> Well, of course there will always be examples where the zero-test fails! Above I suggested to try both simplification followed by is_trivial_zero() and conversion to QQbar, this would take care of this example.\n\nIn #16397 I implemented this already in https://github.com/sagemath/sage/blob/master/src/sage/symbolic/comparison.pyx#L291 to have some code usable for `__nonzero__` later.",
    "created_at": "2016-09-18T06:18:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137443",
    "user": "rws"
}
```

Replying to [comment:74 vdelecroix]:
> Ralf, what do you call the "symbolic property" of `frac`?

That it can be part of expressions. In the first version of your "fix frac" commit you unconditionally expanded `frac(...)` and forced the user to use `hold=True` to get the symbolic `frac()`.

> I let the `frac(x + y)` not be transformed in `x + y - floor(x + y)` in my new last commit. Please tell me if you like it better.

I do!

Marc:
> Well, of course there will always be examples where the zero-test fails! Above I suggested to try both simplification followed by is_trivial_zero() and conversion to QQbar, this would take care of this example.

In #16397 I implemented this already in https://github.com/sagemath/sage/blob/master/src/sage/symbolic/comparison.pyx#L291 to have some code usable for `__nonzero__` later.



---

archive/issue_comments_137444.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-09-20T07:50:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137444",
    "user": "mmezzarobba"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_137445.json:
```json
{
    "body": "A minor suggestion: perhaps make `rounding()` to `_rounding()`?\n\nAlso, I'm not sure how bad the existing implementation of `floor()` and friends is, but unless it is really terrible, I'd prefer to either avoid relying on `is_zero()` (even with known bugs marked as such) or to have `is_zero()` fixed before merging this ticket.",
    "created_at": "2016-09-20T08:01:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137445",
    "user": "mmezzarobba"
}
```

A minor suggestion: perhaps make `rounding()` to `_rounding()`?

Also, I'm not sure how bad the existing implementation of `floor()` and friends is, but unless it is really terrible, I'd prefer to either avoid relying on `is_zero()` (even with known bugs marked as such) or to have `is_zero()` fixed before merging this ticket.



---

archive/issue_comments_137446.json:
```json
{
    "body": "Replying to [comment:80 rws]:\n> > Well, of course there will always be examples where the zero-test fails! Above I suggested to try both simplification followed by is_trivial_zero() and conversion to QQbar, this would take care of this example.\n> \n> In #16397 I implemented this already in https://github.com/sagemath/sage/blob/master/src/sage/symbolic/comparison.pyx#L291 to have some code usable for `__nonzero__` later.\n\nI think I don't follow you, sorry. The code you link to looks like it is intended to sort expressions for printing etc., not to provide reliable mathematical results, isn't it? Besides (but this is starting to be off-topic for this ticket), I'm tempted to think that, for non-relational expressions at least, `__nonzero__()` should simply be the negation of `is_trivial_zero()`. As far as I understand, what `__nonzero__()` is intended to test is whether something is \u201cempty\u201d, \u201ctrivial\u201d; it should be as fast as possible, and there is no expectation that it tries hard to prove the nullity of its argument. For a \u201cmathematical\u201d example, I'd find it entirely reasonable to have `(x - x)*y + 1 \u2208 SR[y]` be considered a polynomial of degree **one**\u2014and that's the kind of things `__nonzero__()` is for. I'm less certain about *relational* expressions: perhaps `bool(expr == 0)`, unlike `bool(expr)`, should keep trying hard to show that `expr` is zero.",
    "created_at": "2016-09-20T08:18:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137446",
    "user": "mmezzarobba"
}
```

Replying to [comment:80 rws]:
> > Well, of course there will always be examples where the zero-test fails! Above I suggested to try both simplification followed by is_trivial_zero() and conversion to QQbar, this would take care of this example.
> 
> In #16397 I implemented this already in https://github.com/sagemath/sage/blob/master/src/sage/symbolic/comparison.pyx#L291 to have some code usable for `__nonzero__` later.

I think I don't follow you, sorry. The code you link to looks like it is intended to sort expressions for printing etc., not to provide reliable mathematical results, isn't it? Besides (but this is starting to be off-topic for this ticket), I'm tempted to think that, for non-relational expressions at least, `__nonzero__()` should simply be the negation of `is_trivial_zero()`. As far as I understand, what `__nonzero__()` is intended to test is whether something is “empty”, “trivial”; it should be as fast as possible, and there is no expectation that it tries hard to prove the nullity of its argument. For a “mathematical” example, I'd find it entirely reasonable to have `(x - x)*y + 1 ∈ SR[y]` be considered a polynomial of degree **one**—and that's the kind of things `__nonzero__()` is for. I'm less certain about *relational* expressions: perhaps `bool(expr == 0)`, unlike `bool(expr)`, should keep trying hard to show that `expr` is zero.



---

archive/issue_comments_137447.json:
```json
{
    "body": "See also #22079.",
    "created_at": "2016-12-19T19:58:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137447",
    "user": "mmezzarobba"
}
```

See also #22079.



---

archive/issue_comments_137448.json:
```json
{
    "body": "Rebased following the discussion at #22079.\n----\nNew commits:",
    "created_at": "2017-09-04T14:23:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137448",
    "user": "mmezzarobba"
}
```

Rebased following the discussion at #22079.
----
New commits:



---

archive/issue_comments_137449.json:
```json
{
    "body": "I have an implementation fixing `floor()`/`ceil()` at #22079.",
    "created_at": "2017-09-04T15:04:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137449",
    "user": "jdemeyer"
}
```

I have an implementation fixing `floor()`/`ceil()` at #22079.



---

archive/issue_comments_137450.json:
```json
{
    "body": "This branch does a whole lot more than fixing `floor()`/`ceil()`. Now that this has been fixed in #22079, feel free to change the purpose of this ticket.",
    "created_at": "2017-11-29T15:53:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11949#issuecomment-137450",
    "user": "jdemeyer"
}
```

This branch does a whole lot more than fixing `floor()`/`ceil()`. Now that this has been fixed in #22079, feel free to change the purpose of this ticket.
