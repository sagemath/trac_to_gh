# Issue 28717: polynomial degree is broken for weighted block orders

archive/issues_028717.json:
```json
{
    "body": "CC:  @kwankyu jpflori\n\nKeywords: singular\n\n\n```\nsage: T = TermOrder('wdegrevlex', (1,2,3,4))\nsage: R = PolynomialRing(QQ, 'x', 12, order=T+T+T)\nsage: [x.degree() for x in R.gens()]    # wrong\n[1, 2, 3, 4, 1, 1, 1, 1, 1, 1, 1, 1]\n\nsage: from sage.libs.singular.function_factory import ff\nsage: [ff.deg(x, ring=R) for x in R.gens()]    # correct\n[1, 2, 3, 4, 1, 2, 3, 4, 1, 2, 3, 4]\n```\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/28954\n\n",
    "created_at": "2020-01-05T18:38:08Z",
    "labels": [
        "component: algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "polynomial degree is broken for weighted block orders",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28717",
    "user": "https://github.com/mwageringel"
}
```
CC:  @kwankyu jpflori

Keywords: singular


```
sage: T = TermOrder('wdegrevlex', (1,2,3,4))
sage: R = PolynomialRing(QQ, 'x', 12, order=T+T+T)
sage: [x.degree() for x in R.gens()]    # wrong
[1, 2, 3, 4, 1, 1, 1, 1, 1, 1, 1, 1]

sage: from sage.libs.singular.function_factory import ff
sage: [ff.deg(x, ring=R) for x in R.gens()]    # correct
[1, 2, 3, 4, 1, 2, 3, 4, 1, 2, 3, 4]
```



Issue created by migration from https://trac.sagemath.org/ticket/28954





---

archive/issue_comments_405129.json:
```json
{
    "body": "A related changed is \n\nhttps://trac.sagemath.org/ticket/21631#comment:23\n\nAt least I checked reverting to `p_WTotaldegree` solves the present problem. But there must have been some reason to have used `p_WDegree`.",
    "created_at": "2020-01-06T04:14:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28717#issuecomment-405129",
    "user": "https://github.com/kwankyu"
}
```

A related changed is 

https://trac.sagemath.org/ticket/21631#comment:23

At least I checked reverting to `p_WTotaldegree` solves the present problem. But there must have been some reason to have used `p_WDegree`.



---

archive/issue_comments_405130.json:
```json
{
    "body": "The reason for that change seems to be to fix the example in [ticket:17254#comment:199] where a matrix ordering is used. Interestingly though, with current versions of Singular, the degree with a matrix ordering is not based on the first row of the matrix anymore:\n\n\n```\nsage: R.<x,y,z> = PolynomialRing(QQ, 3, order=TermOrder(matrix([3,0,1,1,1,0,1,0,0])))\nsage: [a.degree() for a in R.gens()]\n[3, 0, 1]\nsage: [a._singular_().deg() for a in R.gens()]\n[3, 0, 1]   # singular 3.1.7p1\n[1, 1, 1]   # singular 4.1.1p2\n```\n\n\nTherefore, I think the degree function in Sage should be changed to return results consistent with Singular in case of matrix orderings. Based on [this document](https://github.com/Singular/Sources/blob/ed085278a0d1c84d197cb3b6dea54a2e5cbabdc0/libpolys/polys/monomials/degree.txt), I replaced `p_WDegree` by `p_FDeg`, which fixes both examples here \u2013 though I am not completely certain this is the correct function to call.\n\nI guess such a behavior change would need a deprecation period. How would one implement this in practice?",
    "created_at": "2020-01-06T18:39:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28717#issuecomment-405130",
    "user": "https://github.com/mwageringel"
}
```

The reason for that change seems to be to fix the example in [ticket:17254#comment:199] where a matrix ordering is used. Interestingly though, with current versions of Singular, the degree with a matrix ordering is not based on the first row of the matrix anymore:


```
sage: R.<x,y,z> = PolynomialRing(QQ, 3, order=TermOrder(matrix([3,0,1,1,1,0,1,0,0])))
sage: [a.degree() for a in R.gens()]
[3, 0, 1]
sage: [a._singular_().deg() for a in R.gens()]
[3, 0, 1]   # singular 3.1.7p1
[1, 1, 1]   # singular 4.1.1p2
```


Therefore, I think the degree function in Sage should be changed to return results consistent with Singular in case of matrix orderings. Based on [this document](https://github.com/Singular/Sources/blob/ed085278a0d1c84d197cb3b6dea54a2e5cbabdc0/libpolys/polys/monomials/degree.txt), I replaced `p_WDegree` by `p_FDeg`, which fixes both examples here – though I am not completely certain this is the correct function to call.

I guess such a behavior change would need a deprecation period. How would one implement this in practice?



---

archive/issue_comments_405131.json:
```json
{
    "body": "Singular's deg function calls `p_LDeg` [(source)](https://github.com/Singular/Sources/blob/Release-4-1-2/Singular/iparith.cc#L3866), so we should use that instead. This eliminates the need to explicitly loop over the monomials.",
    "created_at": "2020-01-06T19:00:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28717#issuecomment-405131",
    "user": "https://github.com/mwageringel"
}
```

Singular's deg function calls `p_LDeg` [(source)](https://github.com/Singular/Sources/blob/Release-4-1-2/Singular/iparith.cc#L3866), so we should use that instead. This eliminates the need to explicitly loop over the monomials.



---

archive/issue_comments_405132.json:
```json
{
    "body": "I am quite certain that the best thing to do is to patch `polynomial.pyx` such that\n\n```\ncdef long singular_polynomial_deg(poly *p, poly *x, ring *r):\n    ...\n    if x == NULL:\n        return p_WTotaldegree(p,r)\n\n    cdef int i = 0\n    ...\n```\n\nNote that the \"loop\" thing is not necessary. So this will speed up things.\n\nBut then we get \n\n```\nsage: R.<x,y,z> = PolynomialRing(QQ, 3, order=TermOrder(matrix([3,0,1,1,1,0,1,0,0])))\nsage: [a.degree() for a in R.gens()]\n[-3, 0, -1]\nsage: [a._singular_().deg() for a in R.gens()]\n[1, 1, 1]\n```\n\nI don't care the Singular degrees. They are  `p_Totaldegree` (via `p_FDeg` via `p_LDeg`), as expected since Singular' deg function calls `p_LDeg`.\n\nBut the negative values above look strange. They are negative because the value `OrdSgn` is -1 for the ring. It means that the monomial ordering of R is not well-ordering. This is wrong! It is well-ordering since the first nonzero values of each column of the matrix is positive. So `OrdSgn` should be 1. I suspect that there is a bug somewhere in Sage or possibly in Singular. But I could not look deep into the Singular code to find the bug...",
    "created_at": "2020-01-07T08:43:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28717#issuecomment-405132",
    "user": "https://github.com/kwankyu"
}
```

I am quite certain that the best thing to do is to patch `polynomial.pyx` such that

```
cdef long singular_polynomial_deg(poly *p, poly *x, ring *r):
    ...
    if x == NULL:
        return p_WTotaldegree(p,r)

    cdef int i = 0
    ...
```

Note that the "loop" thing is not necessary. So this will speed up things.

But then we get 

```
sage: R.<x,y,z> = PolynomialRing(QQ, 3, order=TermOrder(matrix([3,0,1,1,1,0,1,0,0])))
sage: [a.degree() for a in R.gens()]
[-3, 0, -1]
sage: [a._singular_().deg() for a in R.gens()]
[1, 1, 1]
```

I don't care the Singular degrees. They are  `p_Totaldegree` (via `p_FDeg` via `p_LDeg`), as expected since Singular' deg function calls `p_LDeg`.

But the negative values above look strange. They are negative because the value `OrdSgn` is -1 for the ring. It means that the monomial ordering of R is not well-ordering. This is wrong! It is well-ordering since the first nonzero values of each column of the matrix is positive. So `OrdSgn` should be 1. I suspect that there is a bug somewhere in Sage or possibly in Singular. But I could not look deep into the Singular code to find the bug...



---

archive/issue_comments_405133.json:
```json
{
    "body": "> Note that the \"loop\" thing is not necessary. So this will speed up things.\n\nThis is wrong. I forgot that the monomial ordering might be incompatible with degrees. Anyway, this part needs to be optimized as this would affect the overall performance of polynomial arithmetic of Sage...",
    "created_at": "2020-01-07T11:22:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28717#issuecomment-405133",
    "user": "https://github.com/kwankyu"
}
```

> Note that the "loop" thing is not necessary. So this will speed up things.

This is wrong. I forgot that the monomial ordering might be incompatible with degrees. Anyway, this part needs to be optimized as this would affect the overall performance of polynomial arithmetic of Sage...



---

archive/issue_comments_405134.json:
```json
{
    "body": "The bug in Singular about the wrong `OrdSgn` value was reported in \n\nhttps://www.singular.uni-kl.de/forum/viewtopic.php?f=10&t=2899",
    "created_at": "2020-01-08T02:13:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28717#issuecomment-405134",
    "user": "https://github.com/kwankyu"
}
```

The bug in Singular about the wrong `OrdSgn` value was reported in 

https://www.singular.uni-kl.de/forum/viewtopic.php?f=10&t=2899



---

archive/issue_comments_405135.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-13T04:03:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28717#issuecomment-405135",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_405136.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-13T04:05:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28717#issuecomment-405136",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_405137.json:
```json
{
    "body": "The branch modulo the fix in Singular part fixes the bug of this ticket.\n\nI wish to remove the loop thing for the cases when the monomial ordering is compatible with the degrees, to speed up Sage polynomial arithmetic. But I don't know how to detect these cases, and this issue is for another ticket.\n\nPerhaps we need to delay this ticket until the fix in Singular is available in Sage...",
    "created_at": "2020-01-13T04:15:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28717#issuecomment-405137",
    "user": "https://github.com/kwankyu"
}
```

The branch modulo the fix in Singular part fixes the bug of this ticket.

I wish to remove the loop thing for the cases when the monomial ordering is compatible with the degrees, to speed up Sage polynomial arithmetic. But I don't know how to detect these cases, and this issue is for another ticket.

Perhaps we need to delay this ticket until the fix in Singular is available in Sage...



---

archive/issue_comments_405138.json:
```json
{
    "body": "`@`gh-mwageringel:\n\nI don't object to using `p_LDeg` if this is practically (that is, ignoring not-so-useful matrix orderings) consistent with the rest of Sage, as this has advantage in performance.",
    "created_at": "2020-01-13T04:33:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28717#issuecomment-405138",
    "user": "https://github.com/kwankyu"
}
```

`@`gh-mwageringel:

I don't object to using `p_LDeg` if this is practically (that is, ignoring not-so-useful matrix orderings) consistent with the rest of Sage, as this has advantage in performance.



---

archive/issue_comments_405139.json:
```json
{
    "body": "Should we not add the upstream fix as a patch here? The regular upgrade of Singular might still take quite a while.\n\n\nReplying to [comment:12 klee]:\n> I don't object to using `p_LDeg` if this is practically (that is, ignoring not-so-useful matrix orderings) consistent with the rest of Sage, as this has advantage in performance.\n\n\nThis would be a practical thing to do, as it leaves it to Singular to provide an efficient implementation. Note that this only affects matrix orderings with zeros in the first row \u2013 if the entries in the first row are positive, these are returned as degrees as before.\n\n(A potential downside of this is that it forces Singular's notion of degree upon Sage, whereas, if one ignores the Singular backend, Sage could have its own notion. In Macaulay2 for example, the notions of degree and weight are independent. For now, this seems fine though, as much of polynomial arithmetics in Sage is dictated by the Singular backend anyway.)",
    "created_at": "2020-01-14T20:14:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28717#issuecomment-405139",
    "user": "https://github.com/mwageringel"
}
```

Should we not add the upstream fix as a patch here? The regular upgrade of Singular might still take quite a while.


Replying to [comment:12 klee]:
> I don't object to using `p_LDeg` if this is practically (that is, ignoring not-so-useful matrix orderings) consistent with the rest of Sage, as this has advantage in performance.


This would be a practical thing to do, as it leaves it to Singular to provide an efficient implementation. Note that this only affects matrix orderings with zeros in the first row – if the entries in the first row are positive, these are returned as degrees as before.

(A potential downside of this is that it forces Singular's notion of degree upon Sage, whereas, if one ignores the Singular backend, Sage could have its own notion. In Macaulay2 for example, the notions of degree and weight are independent. For now, this seems fine though, as much of polynomial arithmetics in Sage is dictated by the Singular backend anyway.)



---

archive/issue_comments_405140.json:
```json
{
    "body": "Replying to [comment:13 gh-mwageringel]:\n> Should we not add the upstream fix as a patch here? The regular upgrade of Singular might still take quite a while.\n\nIf we do not wait the regular upgrade of Singular, the upstream fix should go to the Singular package of Sage, as a patch (and be removed when the regular upgrade arrives). I guess this is not a good thing to do.\n\n> > I don't object to using `p_LDeg` if this is practically (that is, ignoring not-so-useful matrix orderings) consistent with the rest of Sage, as this has advantage in performance.\n> \n> This would be a practical thing to do, as it leaves it to Singular to provide an efficient implementation. Note that this only affects matrix orderings with zeros in the first row \u2013 if the entries in the first row are positive, these are returned as degrees as before.\n\nAfter looking into the implementation of `p_LDeg` in Singular and some experiments, it seems that `p_LDeg` is not that faster than the loop thing with `p_WTotaldegree` as I expected initially. \n\nThen I don't see any advantage of using `p_LDeg` while introducing a backward incompatible change in regard to matrix orderings.\n\nI would prefer the present branch and bear with the bug until Singular gets the regular upgrade.",
    "created_at": "2020-01-15T10:02:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28717#issuecomment-405140",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:13 gh-mwageringel]:
> Should we not add the upstream fix as a patch here? The regular upgrade of Singular might still take quite a while.

If we do not wait the regular upgrade of Singular, the upstream fix should go to the Singular package of Sage, as a patch (and be removed when the regular upgrade arrives). I guess this is not a good thing to do.

> > I don't object to using `p_LDeg` if this is practically (that is, ignoring not-so-useful matrix orderings) consistent with the rest of Sage, as this has advantage in performance.
> 
> This would be a practical thing to do, as it leaves it to Singular to provide an efficient implementation. Note that this only affects matrix orderings with zeros in the first row – if the entries in the first row are positive, these are returned as degrees as before.

After looking into the implementation of `p_LDeg` in Singular and some experiments, it seems that `p_LDeg` is not that faster than the loop thing with `p_WTotaldegree` as I expected initially. 

Then I don't see any advantage of using `p_LDeg` while introducing a backward incompatible change in regard to matrix orderings.

I would prefer the present branch and bear with the bug until Singular gets the regular upgrade.



---

archive/issue_comments_405141.json:
```json
{
    "body": "> After looking into the implementation of `p_LDeg` in Singular and some experiments, it seems that `p_LDeg` is not that faster than the loop thing with `p_WTotaldegree` as I expected initially. \n\nThis is wrong. I did more experiments. \n\n```\nsage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder('degrevlex'))\nsage: [a.degree() for a in R.gens()]\n[1, 1, 1, 1]\nsage: f = (x - y*z - 2*z + w)^100\nsage: f.degree()\n200\nsage: timeit('f.degree()')\n125 loops, best of 3: 3.18 ms per loop\n```\n\nwith `p_WTotaldegree` vs \n\n```\nsage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder('degrevlex'))\nsage: [a.degree() for a in R.gens()]\n[1, 1, 1, 1]\nsage: f = (x - y*z - 2*z + w)^100\nsage: f.degree()\n200\nsage: timeit('f.degree()')\n125 loops, best of 3: 2.47 ms per loop\n```\n\nwith `p_LDeg`\n---------------------\n\n```\nsage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder('lex'))\nsage: [a.degree() for a in R.gens()]\n[1, 1, 1, 1]\nsage: f = (x - y*z - 2*z + w)^100\nsage: f.degree()\n200\nsage: timeit('f.degree()')\n125 loops, best of 3: 2.25 ms per loop\n```\n\nwith `p_WTotaldegree` vs \n\n```\nsage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder('lex'))\nsage: [a.degree() for a in R.gens()]\n[1, 1, 1, 1]\nsage: f = (x - y*z - 2*z + w)^100\nsage: f.degree()\n200\nsage: timeit('f.degree()')\n625 loops, best of 3: 777 \u03bcs per loop\n```\n\nwith `p_LDeg`\n---------------------\n\n```\nsage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder('wdeglex',(1,2,3,4)))\nsage: [a.degree() for a in R.gens()]\n[1, 2, 3, 4]\nsage: f = (x - y*z - 2*z + w)^100\nsage: f.degree()\n500\nsage: timeit('f.degree()')\n125 loops, best of 3: 3.88 ms per loop\n```\n\nwith `p_WTotaldegree` vs \n\n```\nsage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder('wdeglex',(1,2,3,4)))\nsage: [a.degree() for a in R.gens()]\n[1, 2, 3, 4]\nsage: f = (x - y*z - 2*z + w)^100\nsage: f.degree()\n500\nsage: timeit('f.degree()')\n125 loops, best of 3: 2.54 ms per loop\n```\n\nwith `p_LDeg`\n---------------------\n\n```\nsage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder('deglex'))\nsage: [a.degree() for a in R.gens()]\n[1, 1, 1, 1]\nsage: f = (x - y*z - 2*z + w)^100\nsage: f.degree()\n200\nsage: timeit('f.degree()')\n125 loops, best of 3: 3.81 ms per loop\n```\n\nwith `p_WTotaldegree` vs \n\n```\nsage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder('deglex'))\nsage: [a.degree() for a in R.gens()]\n[1, 1, 1, 1]\nsage: f = (x - y*z - 2*z + w)^100\nsage: f.degree()\n200\nsage: timeit('f.degree()')\n125 loops, best of 3: 2.75 ms per loop\n```\n\nwith `p_LDeg`\n---------------------\n\n```\nsage: m = matrix(4,[4,3,2,1,1,0,0,0,0,1,0,0,0,0,1,0])\nsage: m\n[4 3 2 1]\n[1 0 0 0]\n[0 1 0 0]\n[0 0 1 0]\nsage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder(m))\nsage: [a.degree() for a in R.gens()]\n[4, 3, 2, 1]\nsage: f = (x - y*z - 2*z + w)^100\nsage: f.degree()\n500\nsage: timeit('f.degree()')\n125 loops, best of 3: 2.84 ms per loop\n```\n\nwith `p_WTotaldegree` vs \n\n```\nsage: m = matrix(4,[4,3,2,1,1,0,0,0,0,1,0,0,0,0,1,0])\nsage: m\n[4 3 2 1]\n[1 0 0 0]\n[0 1 0 0]\n[0 0 1 0]\nsage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder(m))\nsage: [a.degree() for a in R.gens()]\n[4, 3, 2, 1]\nsage: f = (x - y*z - 2*z + w)^100\nsage: f.degree()\n500\nsage: timeit('f.degree()')\n125 loops, best of 3: 2.84 ms per loop\n```\n\nwith `p_LDeg`\n---------------------\n\n```\nsage: m = matrix(2,[3,2,1,0])\nsage: m\n[3 2]\n[1 0]\nsage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder(m)+TermOrder(m))\nsage: [a.degree() for a in R.gens()]\n[3, 2, 3, 2]\nsage: f = (x - y*z - 2*z + w)^100\nsage: f.degree()\n500\nsage: timeit('f.degree()')\n125 loops, best of 3: 3.17 ms per loop\nsage: timeit('f.degree()')\n125 loops, best of 3: 3.18 ms per loop\n```\n\nwith `p_WTotaldegree` vs \n\n```\nsage: m = matrix(2,[3,2,1,0])\nsage: m\n[3 2]\n[1 0]\nsage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder(m)+TermOrder(m))\nsage: [a.degree() for a in R.gens()]\n[3, 2, 3, 2]\nsage: f = (x - y*z - 2*z + w)^100\nsage: f.degree()\n500\nsage: timeit('f.degree()')\n125 loops, best of 3: 3.26 ms per loop\nsage: timeit('f.degree()')\n125 loops, best of 3: 3.28 ms per loop\n```\n\nwith `p_LDeg`\n---------------------\n\n```\nsage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder('neglex'))\nsage: [a.degree() for a in R.gens()]\n[1, 1, 1, 1]\nsage: f = (x - y*z - 2*z + w)^100\nsage: f.degree()\n200\nsage: timeit('f.degree()')\n125 loops, best of 3: 2.18 ms per loop\n```\n\nwith `p_WTotaldegree` vs \n\n```\nsage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder('neglex'))\nsage: [a.degree() for a in R.gens()]\n[1, 1, 1, 1]\nsage: f = (x - y*z - 2*z + w)^100\nsage: f.degree()\n200\nsage: timeit('f.degree()')\n625 loops, best of 3: 750 \u03bcs per loop\n```\n\nwith `p_LDeg`\n---------------------\n\n```\nsage: m = matrix(4,[4,0,2,1,1,0,0,0,0,1,0,0,0,0,1,0])\nsage: m\n[4 0 2 1]\n[1 0 0 0]\n[0 1 0 0]\n[0 0 1 0]\nsage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder(m))\nsage: [a.degree() for a in R.gens()]\n[4, 0, 2, 1]\nsage: f = (x - y*z - 2*z + w)^100\nsage: f.degree()\n400\nsage: timeit('f.degree()')\n125 loops, best of 3: 2.82 ms per loop\nsage: timeit('f.degree()')\n125 loops, best of 3: 2.78 ms per loop\n```\n\nwith `p_WTotaldegree` vs \n\n```\nsage: m = matrix(4,[4,0,2,1,1,0,0,0,0,1,0,0,0,0,1,0])\nsage: m\n[4 0 2 1]\n[1 0 0 0]\n[0 1 0 0]\n[0 0 1 0]\nsage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder(m))\nsage: [a.degree() for a in R.gens()]\n[1, 1, 1, 1]\nsage: f = (x - y*z - 2*z + w)^100\nsage: f.degree()\n200\nsage: timeit('f.degree()')\n625 loops, best of 3: 1.33 ms per loop\nsage: timeit('f.degree()')\n625 loops, best of 3: 1.37 ms per loop\n```\n\nwith `p_LDeg`\n---------------------\n\n```\nsage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder('invlex'))\nsage: [a.degree() for a in R.gens()]\n[1, 1, 1, 1]\nsage: f = (x - y*z - 2*z + w)^100\nsage: f.degree()\n200\nsage: timeit('f.degree()')\n125 loops, best of 3: 2.21 ms per loop\n```\n\nwith `p_WTotaldegree` vs \n\n```\nsage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder('invlex'))\nsage: [a.degree() for a in R.gens()]\n[1, 1, 1, 1]\nsage: f = (x - y*z - 2*z + w)^100\nsage: f.degree()\n200\nsage: timeit('f.degree()')\n625 loops, best of 3: 766 \u03bcs per loop\n```\n\nwith `p_LDeg`",
    "created_at": "2020-01-15T15:10:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28717#issuecomment-405141",
    "user": "https://github.com/kwankyu"
}
```

> After looking into the implementation of `p_LDeg` in Singular and some experiments, it seems that `p_LDeg` is not that faster than the loop thing with `p_WTotaldegree` as I expected initially. 

This is wrong. I did more experiments. 

```
sage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder('degrevlex'))
sage: [a.degree() for a in R.gens()]
[1, 1, 1, 1]
sage: f = (x - y*z - 2*z + w)^100
sage: f.degree()
200
sage: timeit('f.degree()')
125 loops, best of 3: 3.18 ms per loop
```

with `p_WTotaldegree` vs 

```
sage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder('degrevlex'))
sage: [a.degree() for a in R.gens()]
[1, 1, 1, 1]
sage: f = (x - y*z - 2*z + w)^100
sage: f.degree()
200
sage: timeit('f.degree()')
125 loops, best of 3: 2.47 ms per loop
```

with `p_LDeg`
---------------------

```
sage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder('lex'))
sage: [a.degree() for a in R.gens()]
[1, 1, 1, 1]
sage: f = (x - y*z - 2*z + w)^100
sage: f.degree()
200
sage: timeit('f.degree()')
125 loops, best of 3: 2.25 ms per loop
```

with `p_WTotaldegree` vs 

```
sage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder('lex'))
sage: [a.degree() for a in R.gens()]
[1, 1, 1, 1]
sage: f = (x - y*z - 2*z + w)^100
sage: f.degree()
200
sage: timeit('f.degree()')
625 loops, best of 3: 777 μs per loop
```

with `p_LDeg`
---------------------

```
sage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder('wdeglex',(1,2,3,4)))
sage: [a.degree() for a in R.gens()]
[1, 2, 3, 4]
sage: f = (x - y*z - 2*z + w)^100
sage: f.degree()
500
sage: timeit('f.degree()')
125 loops, best of 3: 3.88 ms per loop
```

with `p_WTotaldegree` vs 

```
sage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder('wdeglex',(1,2,3,4)))
sage: [a.degree() for a in R.gens()]
[1, 2, 3, 4]
sage: f = (x - y*z - 2*z + w)^100
sage: f.degree()
500
sage: timeit('f.degree()')
125 loops, best of 3: 2.54 ms per loop
```

with `p_LDeg`
---------------------

```
sage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder('deglex'))
sage: [a.degree() for a in R.gens()]
[1, 1, 1, 1]
sage: f = (x - y*z - 2*z + w)^100
sage: f.degree()
200
sage: timeit('f.degree()')
125 loops, best of 3: 3.81 ms per loop
```

with `p_WTotaldegree` vs 

```
sage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder('deglex'))
sage: [a.degree() for a in R.gens()]
[1, 1, 1, 1]
sage: f = (x - y*z - 2*z + w)^100
sage: f.degree()
200
sage: timeit('f.degree()')
125 loops, best of 3: 2.75 ms per loop
```

with `p_LDeg`
---------------------

```
sage: m = matrix(4,[4,3,2,1,1,0,0,0,0,1,0,0,0,0,1,0])
sage: m
[4 3 2 1]
[1 0 0 0]
[0 1 0 0]
[0 0 1 0]
sage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder(m))
sage: [a.degree() for a in R.gens()]
[4, 3, 2, 1]
sage: f = (x - y*z - 2*z + w)^100
sage: f.degree()
500
sage: timeit('f.degree()')
125 loops, best of 3: 2.84 ms per loop
```

with `p_WTotaldegree` vs 

```
sage: m = matrix(4,[4,3,2,1,1,0,0,0,0,1,0,0,0,0,1,0])
sage: m
[4 3 2 1]
[1 0 0 0]
[0 1 0 0]
[0 0 1 0]
sage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder(m))
sage: [a.degree() for a in R.gens()]
[4, 3, 2, 1]
sage: f = (x - y*z - 2*z + w)^100
sage: f.degree()
500
sage: timeit('f.degree()')
125 loops, best of 3: 2.84 ms per loop
```

with `p_LDeg`
---------------------

```
sage: m = matrix(2,[3,2,1,0])
sage: m
[3 2]
[1 0]
sage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder(m)+TermOrder(m))
sage: [a.degree() for a in R.gens()]
[3, 2, 3, 2]
sage: f = (x - y*z - 2*z + w)^100
sage: f.degree()
500
sage: timeit('f.degree()')
125 loops, best of 3: 3.17 ms per loop
sage: timeit('f.degree()')
125 loops, best of 3: 3.18 ms per loop
```

with `p_WTotaldegree` vs 

```
sage: m = matrix(2,[3,2,1,0])
sage: m
[3 2]
[1 0]
sage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder(m)+TermOrder(m))
sage: [a.degree() for a in R.gens()]
[3, 2, 3, 2]
sage: f = (x - y*z - 2*z + w)^100
sage: f.degree()
500
sage: timeit('f.degree()')
125 loops, best of 3: 3.26 ms per loop
sage: timeit('f.degree()')
125 loops, best of 3: 3.28 ms per loop
```

with `p_LDeg`
---------------------

```
sage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder('neglex'))
sage: [a.degree() for a in R.gens()]
[1, 1, 1, 1]
sage: f = (x - y*z - 2*z + w)^100
sage: f.degree()
200
sage: timeit('f.degree()')
125 loops, best of 3: 2.18 ms per loop
```

with `p_WTotaldegree` vs 

```
sage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder('neglex'))
sage: [a.degree() for a in R.gens()]
[1, 1, 1, 1]
sage: f = (x - y*z - 2*z + w)^100
sage: f.degree()
200
sage: timeit('f.degree()')
625 loops, best of 3: 750 μs per loop
```

with `p_LDeg`
---------------------

```
sage: m = matrix(4,[4,0,2,1,1,0,0,0,0,1,0,0,0,0,1,0])
sage: m
[4 0 2 1]
[1 0 0 0]
[0 1 0 0]
[0 0 1 0]
sage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder(m))
sage: [a.degree() for a in R.gens()]
[4, 0, 2, 1]
sage: f = (x - y*z - 2*z + w)^100
sage: f.degree()
400
sage: timeit('f.degree()')
125 loops, best of 3: 2.82 ms per loop
sage: timeit('f.degree()')
125 loops, best of 3: 2.78 ms per loop
```

with `p_WTotaldegree` vs 

```
sage: m = matrix(4,[4,0,2,1,1,0,0,0,0,1,0,0,0,0,1,0])
sage: m
[4 0 2 1]
[1 0 0 0]
[0 1 0 0]
[0 0 1 0]
sage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder(m))
sage: [a.degree() for a in R.gens()]
[1, 1, 1, 1]
sage: f = (x - y*z - 2*z + w)^100
sage: f.degree()
200
sage: timeit('f.degree()')
625 loops, best of 3: 1.33 ms per loop
sage: timeit('f.degree()')
625 loops, best of 3: 1.37 ms per loop
```

with `p_LDeg`
---------------------

```
sage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder('invlex'))
sage: [a.degree() for a in R.gens()]
[1, 1, 1, 1]
sage: f = (x - y*z - 2*z + w)^100
sage: f.degree()
200
sage: timeit('f.degree()')
125 loops, best of 3: 2.21 ms per loop
```

with `p_WTotaldegree` vs 

```
sage: R.<x,y,z,w>=PolynomialRing(QQ,order=TermOrder('invlex'))
sage: [a.degree() for a in R.gens()]
[1, 1, 1, 1]
sage: f = (x - y*z - 2*z + w)^100
sage: f.degree()
200
sage: timeit('f.degree()')
625 loops, best of 3: 766 μs per loop
```

with `p_LDeg`



---

archive/issue_comments_405142.json:
```json
{
    "body": "> I would prefer the present branch and bear with the bug until Singular gets the regular upgrade. \n\nNow I prefer using `p_LDeg'!",
    "created_at": "2020-01-15T15:13:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28717#issuecomment-405142",
    "user": "https://github.com/kwankyu"
}
```

> I would prefer the present branch and bear with the bug until Singular gets the regular upgrade. 

Now I prefer using `p_LDeg'!



---

archive/issue_comments_405143.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-01-16T02:57:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28717#issuecomment-405143",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_405144.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-01-16T03:05:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28717#issuecomment-405144",
    "user": "https://github.com/kwankyu"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_405145.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-16T03:12:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28717#issuecomment-405145",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_405146.json:
```json
{
    "body": "Replying to [comment:14 klee]:\n> If we do not wait the regular upgrade of Singular, the upstream fix should go to the Singular package of Sage, as a patch (and be removed when the regular upgrade arrives). I guess this is not a good thing to do.\n\nOk, if we use `p_LDeg`, we do not actually need the upstream fix.\n\nCould you add a doctest for the example in the ticket description, please? Also, I think we should keep one example of a matrix ordering with zeros in the first row, in order to document the fact that standard grading is now used in that case.\n\nFinally, the imports `p_Deg, p_Totaldegree, p_WTotaldegree, p_WDegree` are not used anymore and could be removed.\n\nOtherwise, this looks good to me. Thanks a lot for the comparisons and the fix.",
    "created_at": "2020-01-16T21:06:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28717#issuecomment-405146",
    "user": "https://github.com/mwageringel"
}
```

Replying to [comment:14 klee]:
> If we do not wait the regular upgrade of Singular, the upstream fix should go to the Singular package of Sage, as a patch (and be removed when the regular upgrade arrives). I guess this is not a good thing to do.

Ok, if we use `p_LDeg`, we do not actually need the upstream fix.

Could you add a doctest for the example in the ticket description, please? Also, I think we should keep one example of a matrix ordering with zeros in the first row, in order to document the fact that standard grading is now used in that case.

Finally, the imports `p_Deg, p_Totaldegree, p_WTotaldegree, p_WDegree` are not used anymore and could be removed.

Otherwise, this looks good to me. Thanks a lot for the comparisons and the fix.



---

archive/issue_comments_405147.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-17T02:52:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28717#issuecomment-405147",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_405148.json:
```json
{
    "body": "Replying to [comment:20 gh-mwageringel]:\n> Replying to [comment:14 klee]:\n> > If we do not wait the regular upgrade of Singular, the upstream fix should go to the Singular package of Sage, as a patch (and be removed when the regular upgrade arrives). I guess this is not a good thing to do.\n> \n> Ok, if we use `p_LDeg`, we do not actually need the upstream fix.\n\nRight.\n \n> Could you add a doctest for the example in the ticket description, please? Also, I think we should keep one example of a matrix ordering with zeros in the first row, in order to document the fact that standard grading is now used in that case.\n\nDone.\n\n> Finally, the imports `p_Deg, p_Totaldegree, p_WTotaldegree, p_WDegree` are not used anymore and could be removed.\n\nDone.",
    "created_at": "2020-01-17T02:54:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28717#issuecomment-405148",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:20 gh-mwageringel]:
> Replying to [comment:14 klee]:
> > If we do not wait the regular upgrade of Singular, the upstream fix should go to the Singular package of Sage, as a patch (and be removed when the regular upgrade arrives). I guess this is not a good thing to do.
> 
> Ok, if we use `p_LDeg`, we do not actually need the upstream fix.

Right.
 
> Could you add a doctest for the example in the ticket description, please? Also, I think we should keep one example of a matrix ordering with zeros in the first row, in order to document the fact that standard grading is now used in that case.

Done.

> Finally, the imports `p_Deg, p_Totaldegree, p_WTotaldegree, p_WDegree` are not used anymore and could be removed.

Done.



---

archive/issue_comments_405149.json:
```json
{
    "body": "Thank you.",
    "created_at": "2020-01-17T08:21:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28717#issuecomment-405149",
    "user": "https://github.com/mwageringel"
}
```

Thank you.



---

archive/issue_comments_405150.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-01-17T08:21:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28717#issuecomment-405150",
    "user": "https://github.com/mwageringel"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_405151.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-01-20T21:18:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28717#issuecomment-405151",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
