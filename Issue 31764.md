# Issue 31764: Singular update: 4.2.1

Issue created by migration from https://trac.sagemath.org/ticket/32001

Original creator: mkoeppe

Original creation time: 2021-06-18 06:20:26

CC:  fbissey mkoeppe mjo

released 2021-06-09

Previous update: #31642 (4.2.0p3)



---

Comment by mkoeppe created at 2021-06-25 04:07:40

This will need careful checking in particular on Cygwin.
It appears that the last update to 4.2.0p3 broke Cygwin again - https://github.com/mkoeppe/sage/runs/2909494587?check_suite_focus=true

```
 [pynac-0.7.27.p8]   /usr/lib/gcc/x86_64-pc-cygwin/10/../../../../x86_64-pc-cygwin/bin/ld: .libs/libpynac_la-mpoly-singular.o:/opt/sage-a9c3c18820b8c96cd2336b90dc480417eaefd6d6/var/tmp/sage/build/pynac-0.7.27.p8/src/ginac/mpoly-singular.cpp:110: undefined reference to `operator-(CanonicalForm const&)'
  [pynac-0.7.27.p8]   /usr/lib/gcc/x86_64-pc-cygwin/10/../../../../x86_64-pc-cygwin/bin/ld: .libs/libpynac_la-mpoly-singular.o: in function `num2canonical':
  [pynac-0.7.27.p8]   /opt/sage-a9c3c18820b8c96cd2336b90dc480417eaefd6d6/var/tmp/sage/build/pynac-0.7.27.p8/src/ginac/mpoly-singular.cpp:94: undefined reference to `operator-(CanonicalForm const&)'
  [pynac-0.7.27.p8]   /usr/lib/gcc/x86_64-pc-cygwin/10/../../../../x86_64-pc-cygwin/bin/ld: /opt/sage-a9c3c18820b8c96cd2336b90dc480417eaefd6d6/var/tmp/sage/build/pynac-0.7.27.p8/src/ginac/mpoly-singular.cpp:104: undefined reference to `operator-(CanonicalForm const&)'
  [pynac-0.7.27.p8]   collect2: error: ld returned 1 exit status
  [pynac-0.7.27.p8]   make[5]: *** [Makefile:560: libpynac.la] Error 1
  [pynac-0.7.27.p8]   make[5]: Target 'all' not remade because of errors.
  [pynac-0.7.27.p8]   make[4]: *** [Makefile:495: all-recursive] Error 1
  [pynac-0.7.27.p8]   make[3]: *** [Makefile:402: all] Error 2
  [pynac-0.7.27.p8]   ********************************************************************************
```


(this is #32156)


---

Comment by slelievre created at 2021-07-11 22:38:35

Where to download the sources from? There seems to be two options:

- https://github.com/Singular/Singular/releases/tag/Release-4-2-1
- ftp://jim.mathematik.uni-kl.de/pub/Math/Singular/SOURCES/


---

Comment by fbissey created at 2021-07-11 22:40:26

Usually the ftp has a complete dist tarball while github just have the source (not autoconf generated), although I haven't checked lately.


---

Comment by dimpase created at 2021-07-18 09:57:13

GitHub seems to have only the GitHub's automatically generated tarballs.


---

Comment by slelievre created at 2021-07-18 19:01:34

Changing status from new to needs_review.


---

Comment by slelievre created at 2021-07-18 19:01:34

This branch passes testlong on Debian.

(Except one test in `src/sage/modular/local_comp/local_comp.py`
which has a hotfix in #29977 and is the object of #32134.)

Launching GitHub actions on this would be useful.

I've pushed a branch to my fork on [GitHub](GitHub):

- https://github.com/slel/sage/tree/32001

but I don't remember if that's enough to launch tests
on multiple platforms. I can see

- https://github.com/slel/sage/actions/runs/1042993351

which indicates linting tests have failed (unsurprisingly
as linting the whole Sage code base is work in progress);
does that block further tests from running?
----
New commits:


---

Comment by dimpase created at 2021-07-18 19:09:19

you need to choose TOX workflow by Actions
and pick the branch to test manually


---

Comment by mkoeppe created at 2021-07-18 19:09:39

... or push a tag.


---

Comment by slelievre created at 2021-07-20 00:03:36

Thanks for the reminder. I pushed tag 32001,
which launched some bots.

- https://github.com/slel/sage/actions


---

Comment by dimpase created at 2021-07-20 10:01:42

A new trouble with GH Actions, not enough disk space:

```
[sagelib-9.4.beta4]   build/cythonized/sage/ext/interpreters/wrapper_rdf.c:9127:1: fatal error: error writing to /tmp/ccRPWbhl.s: No space left on device
```


:-( (that's on Ubuntu 20.04)


---

Comment by mkoeppe created at 2021-07-21 00:11:04

The pynac failure on `cygwin-standard` is unfortunately still there with this update https://github.com/slel/sage/runs/3114171604?check_suite_focus=true


---

Comment by slelievre created at 2021-07-22 05:25:21

Adding #32257 as a dependency as it makes this work on Cygwin.


---

Comment by mkoeppe created at 2021-07-22 15:55:41

Another round of GH Actions on top of 9.4.beta5 + #32257 would be good


---

Comment by slelievre created at 2021-07-22 17:11:31

Rebased on #32257.

Pushed tag ci-32001 to launch a new round of gh-actions.

https://github.com/slel/sage/actions
----
New commits:


---

Comment by slelievre created at 2021-07-24 08:24:42

Some github-actions workflows are running out of disk space.

https://github.com/slel/sage/actions?query=branch%3Aci-32001


---

Comment by dimpase created at 2021-07-24 21:40:46

perhaps one can try this: https://github.com/easimon/maximize-build-space


---

Comment by git created at 2021-07-25 12:20:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by slelievre created at 2021-07-25 12:22:14

Rebased on Sage 9.4.beta6. Pushed tag to run github-actions at:

https://github.com/slel/sage/actions?query=branch:ci-s94b6-32001


---

Comment by slelievre created at 2021-07-26 00:16:55

Replying to [comment:17 dimpase]:
> perhaps one can try this: https://github.com/easimon/maximize-build-space

Thanks for the pointer, looks promising.

Meanwhile, successfully ran `make -s V=0 ptestlong` on macOS and Debian.


---

Comment by @sheerluck created at 2021-07-27 05:27:12

Replying to [comment:19 slelievre]:
> Rebased on Sage 9.4.beta6. Pushed tag to run github-actions at:
> 
> https://github.com/slel/sage/actions?query=branch:ci-s94b6-32001
But `sci-mathematics/singular-4.2.1` is already installed in gentoo image. 
I expected to see

```
configure: will use system package and not install SPKG singular
```



---

Comment by dimpase created at 2021-07-27 09:02:52

Replying to [comment:21 gh-sheerluck]:
> Replying to [comment:19 slelievre]:
> > Rebased on Sage 9.4.beta6. Pushed tag to run github-actions at:
> > 
> > https://github.com/slel/sage/actions?query=branch:ci-s94b6-32001
> But `sci-mathematics/singular-4.2.1` is already installed in gentoo image. 
> I expected to see
> {{{
> configure: will use system package and not install SPKG singular
> }}}

this won't happen until #29024 is done. 

You can try putting
https://trac.sagemath.org/attachment/ticket/29024/spkg-configure.m4
into build/pkgs/singular/spkg-configure.m4
and run ./bootstrap
(then, assuming Singular is known to pkg-config, it might work...)


---

Comment by chapoton created at 2021-07-31 09:15:48

may we please also fix the following cython warning:

```diff
diff --git a/src/sage/rings/polynomial/multi_polynomial_libsingular.pyx b/src/sage/rings/polynomial/multi_polynomial_libsingular.pyx
index b043ce719a..ec706f3129 100644
--- a/src/sage/rings/polynomial/multi_polynomial_libsingular.pyx
+++ b/src/sage/rings/polynomial/multi_polynomial_libsingular.pyx
@@ -3181,7 +3181,8 @@ cdef class MPolynomial_libsingular(MPolynomial):
         cdef ring *_ring = parent._ring
         if _ring != currRing: rChangeCurrRing(_ring)
         base = parent._base
-        cdef poly *t, *p = p_Copy(self._poly, _ring)
+        cdef poly *t
+        cdef poly *p = p_Copy(self._poly, _ring)
 
         while p:
             t = pNext(p)
```



---

Comment by slelievre created at 2021-07-31 12:26:03

Rebased on Sage 9.4.rc0. Fixed Cython warning as requested.
----
New commits:


---

Comment by slelievre created at 2021-07-31 12:26:03

Changing keywords from "" to "upgrade, singular".


---

Comment by mkoeppe created at 2021-08-01 21:15:38

Replying to [comment:23 chapoton]:
> may we please also fix the following cython warning:

I think it is poor practice to put unrelated changes on an update ticket. It just adds ambiguity for packagers.


---

Comment by mkoeppe created at 2021-08-01 22:12:57

As noted in #32323, the file `singular.idx` is not getting installed (neither before nor after this upgrade). This is an issue both in upstream and our fallback docbuild (which only makes `singular.hlp`)


---

Comment by mkoeppe created at 2021-08-01 22:47:26

Several of the GH Actions tests failed with:

```
  [singular-4.2.1]   Attempting to download from ftp://jim.mathematik.uni-kl.de/pub/Math/Singular/SOURCES/4-2-1/singular-4.2.1.tar.gz
  [singular-4.2.1]   [xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]
  [singular-4.2.1]   ERROR [transfer|run:135]: [Errno ftp error] 550 Failed to change directory.
  [singular-4.2.1]   ************************************************************************
  [singular-4.2.1]   Traceback (most recent call last):
  [singular-4.2.1]     File "/sage/build/bin/../sage_bootstrap/download/cmdline.py", line 126, in run_safe
```

This may have been caused by an intermittent server error


---

Comment by mkoeppe created at 2021-08-01 22:49:53

The tests that went through look fine, including Cygwin.

Thanks for preparing this upgrade!


---

Comment by mkoeppe created at 2021-08-01 22:49:53

Changing status from needs_review to positive_review.


---

Comment by slelievre created at 2021-08-02 12:40:19

Replying to [comment:25 mkoeppe]:
> Replying to [comment:23 chapoton]:
> > may we please also fix the following cython warning:
> 
> I think it is poor practice to put unrelated changes on an update ticket. It just adds ambiguity for packagers.

Let me know if I should split that off to a separate ticket.


---

Comment by vbraun created at 2021-08-29 09:36:18

Resolution: fixed
