# Issue 20484: Unpack all upstream tarballs into 'src' directory

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2016-05-30 17:13:01

When building an spkg the upstream tarball is unpacked into the temporary build directory, and then with a 'hack' [here http://git.sagemath.org/sage.git/tree/build/bin/sage-spkg?h=develop&id=769ff190413123f3b0c21a16ea69c63e3f99c43a#n537] to try to figure out what directory the tarball is extracted to, and then rename it to `src`.  This doesn't always work for all packages, and in some packages they get extracted to something else, leading to inconsistencies in `spkg-installs`.  It would be nice if the upstream source can always be found in `src`.

This idea came about in the discussion in #20692 starting around here: http://trac.sagemath.org/ticket/20692#comment:18

This adds one more small step toward more consistency between spkgs.

It might also be worth clarifying in the documentation that (as of this patch) the upstream source should always wind up in `src/`.


---

Comment by embray created at 2016-05-30 17:14:19

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2016-05-31 09:23:46

I can confirm that it builds the "latte_int" package correctly with this change.


---

Comment by mkoeppe created at 2016-05-31 09:28:18

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2016-05-31 09:28:18

However, 

```
SAGE_CHECK=yes sage -f latte_int
```

yields an error because of the changed directories.


---

Comment by embray created at 2016-05-31 10:51:57

Oops, I'll fix that, and check the other updated packages as well.


---

Comment by git created at 2016-05-31 14:14:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2016-05-31 14:20:24

Fixed the relevant spkg-checks.  

Incidentally, one of the tests for latte_int failed until I installed 4ti2.  Not relevant to this ticket, but I thought it was worth noting--4ti2 is not listed as a dependency of latte_int.  Should it be?  (I have no idea what these packages are.)


---

Comment by mkoeppe created at 2016-05-31 14:36:03

Replying to [comment:6 embray]:
> Fixed the relevant spkg-checks.  

Thanks.

> Incidentally, one of the tests for latte_int failed until I installed 4ti2.  Not relevant to this ticket, but I thought it was worth noting--4ti2 is not listed as a dependency of latte_int.  Should it be?  (I have no idea what these packages are.)

Yes, it should. In fact, both 4ti2 and latte_int should get 'dependencies' files. This is an spkg feature I wasn't aware of, thanks for mentioning it.


---

Comment by mkoeppe created at 2016-06-02 13:26:59

Changing status from needs_work to positive_review.


---

Comment by embray created at 2016-06-02 15:01:26

Before merging this I should also add a note in http://doc.sagemath.org/html/en/developer/packaging.html stating explicitly that the upstream sources are now always unpacked into "src/"


---

Comment by vbraun created at 2016-06-03 21:49:30

Resolution: fixed


---

Comment by vbraun created at 2016-06-03 21:56:24

Argparse is Python 2.7+ only, this ticket implicitly removed support for building sage with Python 2.6 and below. See also #19984, #20023


---

Comment by vbraun created at 2016-06-04 19:20:31

Fails on OSX:

```
**********************************************************************
File "src/sage/structure/sage_object.pyx", line 1526, in sage.structure.sage_object.unpickle_all
Failed example:
    sage.structure.sage_object.unpickle_all()
Expected:
    Successfully unpickled ... objects.
    Failed to unpickle 0 objects.
Got:
    tar: Failed to set default locale
    Successfully unpickled 586 objects.
    Failed to unpickle 0 objects.
**********************************************************************
1 item had failures:
   2 of  11 in sage.structure.sage_object.unpickle_all
    [204 tests, 2 failures, 12.10 s]
```



---

Comment by vbraun created at 2016-06-04 19:20:31

Resolution changed from fixed to 


---

Comment by vbraun created at 2016-06-04 19:20:31

Changing status from closed to new.


---

Comment by vbraun created at 2016-06-05 01:06:47

Never mind that was due to an environment variable change.


---

Comment by vbraun created at 2016-06-05 01:06:47

Resolution: fixed
