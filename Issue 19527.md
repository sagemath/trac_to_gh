# Issue 19527: rpath trouble with PARI

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2015-12-23 10:10:54

CC:  vbraun jpflori


```
jdemeyer`@`tamiyo:/usr/local/src/sage-config$ ./sage --gp
gp: error while loading shared libraries: libgmp.so.16: cannot open shared object file: No such file or directory
```


`ldd` gives:

```
        linux-vdso.so.1 (0x00007ffff1fb9000)
        libreadline.so.6 => /usr/local/src/sage-config/local/lib/libreadline.so.6 (0x00007f03d2037000)
        libpari-gmp-2.8.so.0 => /usr/local/src/sage-config/local/lib/libpari-gmp-2.8.so.0 (0x00007f03d1798000)
        libm.so.6 => /lib64/libm.so.6 (0x00007f03d14aa000)
        libc.so.6 => /lib64/libc.so.6 (0x00007f03d1102000)
        libtinfo.so.5 => /usr/local/src/sage-config/local/lib/libtinfo.so.5 (0x00007f03d0ecb000)
        libgmp.so.16 => not found
        libdl.so.2 => /lib64/libdl.so.2 (0x00007f03d0cc7000)
        /lib64/ld-linux-x86-64.so.2 (0x00007f03d2281000)
```



---

Comment by fbissey created at 2015-12-23 10:14:53

`readelf -d ` of same to see if the runpath is there? Possibly of `libpari` as well because `gmp` is pulled by `libpari-gmp` and not directly by `gp` so it is probably where the failure is.


---

Attachment

Hum https://github.com/sagemath/sage/blob/develop/build/pkgs/pari/patches/get_ld.patch is probably not a good idea if you want to set runpath. Also it looks like I am adding stuff in gentoo to respect `LDFLAGS` but there is no equivalent in sage:


```
	# propagate ldflags
	sed -i \
		-e 's/$shared $extra/$shared $extra \\$(LDFLAGS)/' \
		config/get_dlld || die "failed to fix LDFLAGS"
```



---

Comment by jdemeyer created at 2015-12-23 10:22:57


```
$ readelf -d local/bin/gp

Dynamic section at offset 0x2ada0 contains 30 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libpari-gmp-2.8.so.0]
 0x0000000000000001 (NEEDED)             Shared library: [libreadline.so.6]
 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x000000000000000f (RPATH)              Library rpath: [/usr/local/src/sage-config/local/lib:/usr/local/src/sage-config/local/lib64]
 0x000000000000001d (RUNPATH)            Library runpath: [/usr/local/src/sage-config/local/lib:/usr/local/src/sage-config/local/lib64]
 0x000000000000000c (INIT)               0x405ac0
 0x000000000000000d (FINI)               0x41c594
 0x0000000000000019 (INIT_ARRAY)         0x62ad88
 0x000000000000001b (INIT_ARRAYSZ)       8 (bytes)
 0x000000000000001a (FINI_ARRAY)         0x62ad90
 0x000000000000001c (FINI_ARRAYSZ)       8 (bytes)
 0x0000000000000004 (HASH)               0x4002b0
 0x000000006ffffef5 (GNU_HASH)           0x400c18
 0x0000000000000005 (STRTAB)             0x4030c0
 0x0000000000000006 (SYMTAB)             0x401140
 0x000000000000000a (STRSZ)              4342 (bytes)
 0x000000000000000b (SYMENT)             24 (bytes)
 0x0000000000000015 (DEBUG)              0x0
 0x0000000000000003 (PLTGOT)             0x62afe8
 0x0000000000000002 (PLTRELSZ)           4176 (bytes)
 0x0000000000000014 (PLTREL)             RELA                                                                                                                           
 0x0000000000000017 (JMPREL)             0x404a70                                                                                                                       
 0x0000000000000007 (RELA)               0x4044e8                                                                                                                       
 0x0000000000000008 (RELASZ)             1416 (bytes)                                                                                                                   
 0x0000000000000009 (RELAENT)            24 (bytes)
 0x000000006ffffffe (VERNEED)            0x404458
 0x000000006fffffff (VERNEEDNUM)         2
 0x000000006ffffff0 (VERSYM)             0x4041b6
 0x0000000000000000 (NULL)               0x0
```



```
$ readelf -d local/lib/libpari-gmp-2.8.so.0

Dynamic section at offset 0x6636f8 contains 29 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]
 0x0000000000000001 (NEEDED)             Shared library: [libgmp.so.16]
 0x0000000000000001 (NEEDED)             Shared library: [libdl.so.2]
 0x000000000000000e (SONAME)             Library soname: [libpari-gmp-2.8.so.0]
 0x000000000000000c (INIT)               0x749b0
 0x000000000000000d (FINI)               0x57e4b8
 0x0000000000000019 (INIT_ARRAY)         0x8628f0
 0x000000000000001b (INIT_ARRAYSZ)       8 (bytes)
 0x000000000000001a (FINI_ARRAY)         0x8628f8
 0x000000000000001c (FINI_ARRAYSZ)       8 (bytes)
 0x0000000000000004 (HASH)               0x1c8
 0x000000006ffffef5 (GNU_HASH)           0x92b8
 0x0000000000000005 (STRTAB)             0x316d8
 0x0000000000000006 (SYMTAB)             0x131b0
 0x000000000000000a (STRSZ)              57245 (bytes)
 0x000000000000000b (SYMENT)             24 (bytes)
 0x0000000000000003 (PLTGOT)             0x863fe8
 0x0000000000000002 (PLTRELSZ)           85752 (bytes)
 0x0000000000000014 (PLTREL)             RELA
 0x0000000000000017 (JMPREL)             0x5fab8
 0x0000000000000007 (RELA)               0x41f98
 0x0000000000000008 (RELASZ)             121632 (bytes)
 0x0000000000000009 (RELAENT)            24 (bytes)
 0x000000006ffffffe (VERNEED)            0x41ee8
 0x000000006fffffff (VERNEEDNUM)         3
 0x000000006ffffff0 (VERSYM)             0x3f676
 0x000000006ffffff9 (RELACOUNT)          3899
 0x0000000000000000 (NULL)               0x0
```



---

Comment by fbissey created at 2015-12-23 10:29:03

That's conclusive `gp` has a rpath but not `libgmp`, `libpari` has `libgmp` but no rpath...


---

Comment by vbraun created at 2015-12-23 10:32:48

I have a patch, one sec...


---

Comment by vbraun created at 2015-12-23 10:49:17

Changing status from new to needs_review.


---

Comment by vbraun created at 2015-12-23 10:49:17

Earlier today while adding tests for rpath issues (#19760)  noticed that libpari-gmp doesn't have one. This patch fixes it and I can run sage -gp just fine.
----
New commits:


---

Comment by jdemeyer created at 2015-12-23 11:01:00

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2015-12-23 11:01:00

Works for me.


---

Comment by jdemeyer created at 2015-12-23 13:10:42

For the record: `make ptestlong` passes.

I still don't get why I am the only one with this problem... Is there any chance of a quick beta1 with this included?


---

Comment by vbraun created at 2015-12-23 15:58:51

I guess nobody else uses the command-line gp ;-)

For beta1 it would be good to also include #19760 to help with debugging, if somebody can review it...


---

Comment by jdemeyer created at 2015-12-23 16:30:20

Replying to [comment:11 vbraun]:
> I guess nobody else uses the command-line gp ;-)

Well, it does (obviously) lead to doctest failures.


---

Comment by vbraun created at 2015-12-23 16:54:28

Hmm it does? I assumed we just hadn't tested it. Running gp without rpath might pick up the system gmp, maybe thats what happened on the buildbot.


---

Comment by jdemeyer created at 2015-12-23 19:05:43

I think it is safer to increase the version number of PARI.
----
New commits:


---

Comment by vbraun created at 2015-12-23 19:39:56

Conflicts with #19649, I'll just merge that right after this one to bump the version
----
New commits:


---

Comment by jdemeyer created at 2015-12-23 19:54:04

Replying to [comment:16 vbraun]:
> Conflicts with #19649, I'll just merge that right after this one to bump the version

Excellent!


---

Comment by vbraun created at 2015-12-24 10:53:20

Resolution: fixed


---

Comment by ehlen created at 2016-05-11 17:32:39

I'm getting a similar issue with the binary distribution of sage 7.1 (64 bit) on Ubuntu 14.04:

# sage -gp
gp: error while loading shared libraries: libpari-gmp-2.8.so.0: cannot open shared object file: No such file or directory
# ldd libpari-gmp-2.8.so.0
        linux-vdso.so.1 =>  (0x00007fff480b7000)
        libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f8cc3ec1000)
        libm.so.6 => /lib/x86_64-linux-gnu/libm.so.6 (0x00007f8cc3bbb000)
        libgmp.so.16 => /lmfdb/SageMath/local/lib/libgmp.so.16 (0x00007f8cc392b000)
        libdl.so.2 => /lib/x86_64-linux-gnu/libdl.so.2 (0x00007f8cc3727000)
        /lib64/ld-linux-x86-64.so.2 (0x000055aa62509000)

Not sure if this is the same issue or if I should rather open a new one.


---

Comment by vbraun created at 2016-05-11 18:10:38

This ticket is closed, open another one.
