# Issue 28815: Create build/bin/sage-build-env and call it from build/make/deps; add sage --buildsh

Issue created by migration from https://trac.sagemath.org/ticket/29052

Original creator: mkoeppe

Original creation time: 2020-01-20 14:49:59

CC:  dimpase embray jdemeyer fbissey isuruf

This is part of #21707 - "Split `sage-env` into 5". 

We set up a new `configure`-generated, to-be-`source`d shell script `build/bin/sage-build-env` to which we move environment variable settings from `src/bin/sage-env[-config]` that are only needed for:

1. Sage-the-distribution while building spkgs,
2. Sage-the-distribution for building sagelib.

The new script sources `src/bin/sage-env`.

We add a command `sage --buildsh`, like `sage --sh` but using the larger environment.


---

Comment by git created at 2020-01-20 17:26:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-01-20 17:27:23

Updated the branch that was on #21707.


---

Comment by mkoeppe created at 2020-01-20 17:27:23

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2020-01-21 18:10:56

You need to document `sage --buildsh`: at the top of `src/bin/sage`, in `src/doc/en/reference/repl/options.rst`, maybe in `src/doc/en/installation/source.rst`, maybe in the developer's guide.


---

Comment by mkoeppe created at 2020-01-21 18:47:42

Thanks! Will do.


---

Comment by git created at 2020-01-21 19:49:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-01-22 22:57:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-01-22 23:04:29

Merged, ready for review


---

Comment by git created at 2020-02-06 20:38:16

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-02-06 20:38:36

Rebased on 9.1.beta3, needs review


---

Comment by dimpase created at 2020-02-13 17:41:58

some places say `-buildsh`, some say `--build-sh`, some say `--buildsh`

what's the correct one?


---

Comment by git created at 2020-02-14 03:00:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-02-14 03:00:54

Both `-buildsh` and `--buildsh` work.


---

Comment by git created at 2020-02-16 18:16:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-02-21 18:44:17

Patchbot errors on `helmholtz` are due to bootstrap prerequisites missing on that host.

Needs review...


---

Comment by git created at 2020-02-22 22:53:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-02-24 05:24:28

ok


---

Comment by dimpase created at 2020-02-24 05:24:28

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-02-24 07:31:43

Thank you!


---

Comment by vbraun created at 2020-02-25 23:23:10


```
[dochtml] Error building the documentation.
[dochtml] Traceback (most recent call last):
[dochtml]   File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/runpy.py", line 193, in _run_module_as_main
[dochtml]     "__main__", mod_spec)
[dochtml]   File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/runpy.py", line 85, in _run_code
[dochtml]     exec(code, run_globals)
[dochtml]   File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage_setup/docbuild/__main__.py", line 2, in <module>
[dochtml]     main()
[dochtml]   File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 1720, in main
[dochtml]     builder()
[dochtml]   File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 327, in _wrapper
[dochtml]     getattr(get_builder(document), 'inventory')(*args, **kwds)
[dochtml]   File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 552, in _wrapper
[dochtml]     self._build_everything_except_bibliography(lang, format, *args, **kwds)
[dochtml]   File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 538, in _build_everything_except_bibliography
[dochtml]     build_many(build_ref_doc, non_references)
[dochtml]   File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 280, in build_many
[dochtml]     _build_many(target, args, processes=NUM_THREADS)
[dochtml]   File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage_setup/docbuild/utils.py", line 283, in build_many
[dochtml]     raise worker_exc.original_exception
[dochtml] pkgconfig.pkgconfig.PackageNotFoundError: cblas not found not found
```



---

Comment by vbraun created at 2020-02-25 23:23:10

Changing status from positive_review to needs_work.


---

Comment by dimpase created at 2020-02-26 08:15:11

was it a build from scratch, or an incremental one?


---

Comment by vbraun created at 2020-02-26 20:37:50

Both incremental and after "make distclean"


---

Comment by git created at 2020-02-27 03:37:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-02-27 03:38:12

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-02-27 03:38:12

Thanks for catching this.


---

Comment by dimpase created at 2020-02-27 21:07:43

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-02-27 21:07:43

OK, it works now. The previous iteration somehow built, but didn't work, as it turned out, sorry.


---

Comment by vbraun created at 2020-02-29 09:08:49

Resolution: fixed
