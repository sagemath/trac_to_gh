# Issue 32095: using argparse in sage-runtests script

Issue created by migration from https://trac.sagemath.org/ticket/32332

Original creator: chapoton

Original creation time: 2021-08-04 07:54:04

CC:  tscrim slelievre @kliem arojas

instead of the deprecated optparse


---

Comment by chapoton created at 2021-08-04 07:56:30

Changing status from new to needs_review.


---

Comment by chapoton created at 2021-08-04 07:56:30

New commits:


---

Comment by git created at 2021-08-04 08:47:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-08-05 05:06:27

LGTM as far as I can tell. A good ticket for the initial 9.5.beta0 release.


---

Comment by tscrim created at 2021-08-05 05:06:27

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-09-05 22:44:35

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2021-09-05 22:44:35


```
make ptestlong
[...]
make[1]: Leaving directory '/home/release/Sage'
./sage -t -p --all --long --logfile=logs/ptestlong.log
usage: sage -t [options] filenames
sage-runtests: error: argument -p/--nthreads: expected one argument
make: *** [Makefile:201: ptestlong] Error 2
```



---

Comment by git created at 2021-09-06 07:10:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-09-06 07:18:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-09-06 07:18:54

ok, should be better now. I fixed the behaviour of -p and --logfile.


---

Comment by chapoton created at 2021-09-06 07:18:54

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-09-06 07:20:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-09-10 02:58:05

There are still issues:

```
$ ./sage -btp src/sage/combinat/partition.py
...
sage-runtests: error: argument -p/--nthreads: invalid int value: 'src/sage/combinat/partition.py'
$ ./sage -tp src/sage/combinat/partition.py 
usage: sage -t [options] filenames
sage-runtests: error: argument -p/--nthreads: invalid int value: 'src/sage/combinat/partition.py'
```

I at least use these shortcuts a lot, but I guess that is not a strict requirement to have them fixed. It would just mean a lot of relearning for me.

These both continue to not work (so they don't need to be fixed)

```
$ ./sage -btp8 src/sage/combinat/partition.py 
Error: unknown option: -btp8
$ ./sage -tp8 src/sage/combinat/partition.py 
Error: unknown option: -tp8
```

but this now works (before it didn't):

```
$ ./sage -t -p8 src/sage/combinat/partition.py
```



---

Comment by tscrim created at 2021-09-10 02:58:05

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2021-09-10 11:51:48

This may be difficult to fix. What's the point of tp alone, given that the default value for nthreads is 1 ? This amounts to say, parallel, but not parallel.

Note that
`./sage -tp 8 src/sage/combinat/partition.py`
works fine, and same for btp.

There is an inherent ambiguity in the options

```
-p filename.py
```

that argparse cannot really handle, if I understand correctly.


---

Comment by git created at 2021-09-10 12:14:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-09-10 21:34:27

Replying to [comment:11 chapoton]:
> This may be difficult to fix. What's the point of tp alone, given that the default value for nthreads is 1 ? This amounts to say, parallel, but not parallel.

From what I can tell, it does run it in parallel.


---

Comment by git created at 2021-09-11 07:47:00

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2021-09-11 07:50:47

Now the behaviour is

```
no option -p   =>   nthreads = 1
-p             =>   nthreads = 0
-p k           =>   nthreads = k
```


But I still do not see how to fix your concern.


---

Comment by git created at 2021-09-11 07:57:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-09-11 08:26:15

I would see a solution to avoid breaking `sage -tp file.py`

but at the prize of breaking

`sage -tp 4 [...]`

The idea is to always add the argument 0 to `-p` when using `-tp` or `-btp`.

So what would you prefer ?

People would still be able to use

```
sage -t -p 4 [...]
```



---

Comment by chapoton created at 2021-09-11 09:43:48

We have the same issue with other options

```
~/sage$ sage -t --short src/sage/combinat/partition.py 
either use --new or --all or some filenames
~/sage$ sage -t --warn-long src/sage/combinat/partition.py 
either use --new or --all or some filenames
```

A workaround seems to be

```
~/sage$ sage -t --warn-long -- src/sage/combinat/partition.py 
```



---

Comment by git created at 2021-09-11 10:10:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-09-11 10:36:35

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2021-09-11 10:37:16

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2021-09-11 10:37:16

I think I have found a solution. Maybe not perfect.


---

Comment by tscrim created at 2021-09-11 10:51:11

If we have to make a choice, I personally would prefer `-tp` and `-btp` to work, but that is because it is what I most frequently use. Does your solution keep both input formats?

What about `.pyx` (and probably `.pxd` and `.pxi`) files? I think those also need to be added to the list.


---

Comment by git created at 2021-09-11 11:19:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-09-11 11:21:13

Thanks for the suggestion about pyx. I have added that.

I think everything works smoothly now.

What would still fail would be something like

```
sage -tp src/sage/combinat/
```

which can easily be obtained as

```
sage -tp 0 src/sage/combinat
```



---

Comment by mkoeppe created at 2021-09-11 21:10:43

Replying to [comment:24 chapoton]:
> What would still fail would be something like
> {{{
> sage -tp src/sage/combinat/
> }}}
> which can easily be obtained as
> {{{
> sage -tp 0 src/sage/combinat
> }}}

-1 on making such incompatible changes, it will be annoying to developers


---

Comment by git created at 2021-09-12 07:28:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-09-12 07:30:07

Here is a new proposal. I tried to keep things simple.


---

Comment by tscrim created at 2021-09-13 04:55:07

Thank you. We are getting close.

```
$ ./sage -tp --warn-long src/sage/rings/function_field/function_field.py
```

works, but this does not (although it used to)

```
$ ./sage -tp src/sage/rings/function_field/function_field.py --warn-long
too few successful tests, not using stored timings
Running doctests with ID 2021-09-13-14-49-55-02c83a90.
Git branch: u/chapoton/32332
Using --optional=bliss,build,debian,dochtml,dot2tex,e_antic,libnauty,ninja_build,normaliz,pip,sage,sage_spkg
Traceback (most recent call last):
  File "/home/uqtscrim/sage-build/src/bin/sage-runtests", line 149, in <module>
    err = DC.run()
  File "/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/sage/doctest/control.py", line 1204, in run
    self.expand_files_into_sources()
  File "/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/sage/doctest/control.py", line 788, in expand_files_into_sources
    self.sources = [FileDocTestSource(path, self.options) for path in expand()]
  File "/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/sage/doctest/control.py", line 788, in <listcomp>
    self.sources = [FileDocTestSource(path, self.options) for path in expand()]
  File "/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/sage/doctest/sources.py", line 527, in __init__
    raise ValueError("unknown file extension %r"%ext)
ValueError: unknown file extension ''
```

Although I could very easily argue that this is not supported behavior, so it might be more luck than anything it worked before. This is a very minor point and not something I would withhold a positive review for.


---

Comment by chapoton created at 2021-09-13 07:13:32

I do not think that we should allow options after the filenames.

The usage is "options then filenames", and that's all.


---

Comment by git created at 2021-09-14 16:14:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-09-15 01:45:35

Okay, then let's not (unofficially) support that input format anymore.

Shouldn't `--short` take floating points? Granted, I find it unlikely that someone will want to do something in `321.0123` seconds, but perhaps for one file they don't want whole seconds? The output for `--short` has also become a lot more verbose. (Not that that is a bad thing, it is just a change in behavior.)

Anyways, this should hopefully be the last of it. The sooner we can get this merged and out for people to test it more in the wild, the better we can pick up other changes in behavior (that people care about).


---

Comment by git created at 2021-09-15 07:01:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-09-15 07:03:25

ok, short was indeed broken by the change of default value. Repaired now.

Short was taking integers and will still take integers. I would prefer not to change that.


---

Comment by tscrim created at 2021-09-15 09:10:07

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2021-09-15 09:10:07

Okay, thank you. Let's get this tested by the rest of the developers.


---

Comment by vbraun created at 2021-09-19 22:39:09

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2021-09-19 22:39:09


```
sage -t --long --warn-long 44.9 --random-seed=0 src/sage/doctest/test.py  # 21 doctests failed
sage -t --long --warn-long 44.9 --random-seed=0 src/sage/doctest/forker.py  # 11 doctests failed
sage -t --long --warn-long 44.9 --random-seed=0 src/sage/doctest/control.py  # Bad exit: 1 after testing finished
```



---

Comment by git created at 2021-09-20 08:34:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-09-20 08:36:30

damn. I have fixed a few things again.


---

Comment by chapoton created at 2021-09-20 08:36:30

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2021-09-21 08:17:39

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2021-09-21 08:17:39

Green bot and passes locally.


---

Comment by vbraun created at 2021-10-09 11:09:57

Resolution: fixed


---

Comment by arojas created at 2021-10-12 10:42:22

This breaks running `sage -t file --optional=foo` for me, regardless of the optional tags I specify

```
> sage -t /usr/lib/python3.9/site-packages/sage/sets/integer_range.py --optional=sage
too many failed tests, not using stored timings
Running doctests with ID 2021-10-12-12-41-27-6d41dc7c.
Using --optional=dochtml,pip,sage
Traceback (most recent call last):
  File "/usr/bin/sage-runtests", line 151, in <module>
    err = DC.run()
  File "/usr/lib/python3.9/site-packages/sage/doctest/control.py", line 1210, in run
    self.expand_files_into_sources()
  File "/usr/lib/python3.9/site-packages/sage/doctest/control.py", line 794, in expand_files_into_sources
    self.sources = [FileDocTestSource(path, self.options) for path in expand()]
  File "/usr/lib/python3.9/site-packages/sage/doctest/control.py", line 794, in <listcomp>
    self.sources = [FileDocTestSource(path, self.options) for path in expand()]
  File "/usr/lib/python3.9/site-packages/sage/doctest/sources.py", line 527, in __init__
    raise ValueError("unknown file extension %r"%ext)
ValueError: unknown file extension ''
```



---

Comment by arojas created at 2021-10-12 10:48:08

Nevermind, I see this is intentional (re comment 29)
