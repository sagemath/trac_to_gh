# Issue 28876: Reimplement `sage -i SPKG` as `configure --enable-SPKG && make build`

Issue created by migration from https://trac.sagemath.org/ticket/29113

Original creator: mkoeppe

Original creation time: 2020-01-30 17:50:26

CC:  dimpase embray jhpalmieri

#28095 adds `configure --enable-SPKG`.

As a follow-up, using this new interface we reimplement `sage -i`.


---

Comment by embray created at 2020-01-31 14:19:26

Ah, I misread this at first--I thought you were proposing to _replace_ `sage -i` as the way to install optional packages.

If I understand correctly though, you are just proposing a change to how it works internally.  If so I'm +1.


---

Comment by mkoeppe created at 2020-03-18 21:41:15

New commits:


---

Comment by mkoeppe created at 2020-03-18 21:41:15

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2020-03-23 21:59:00

I took a fresh tarball and merged this branch. When I ran `./sage -i meataxe`, it ran `configure` three times in a row. Is this expected?


---

Comment by jhpalmieri created at 2020-03-23 22:00:22

By the way, after running `./sage -i meataxe` or `./configure --enable-meataxe`, `config.log` still says

```
configure:30333: result: meataxe-1.0.p0: does not support check for system package; optional, use "./configure --enable-meataxe" to install
```

It would be nice if this actually noted that the user has requested its installation.


---

Comment by mkoeppe created at 2020-03-23 22:02:23

Replying to [comment:6 jhpalmieri]:
> I took a fresh tarball and merged this branch. When I ran `./sage -i meataxe`, it ran `configure` three times in a row. Is this expected?
That's clearly too much.


---

Comment by mkoeppe created at 2020-03-23 22:03:16

Replying to [comment:7 jhpalmieri]:
> By the way, after running `./sage -i meataxe` or `./configure --enable-meataxe`, `config.log` still says
> {{{
> configure:30333: result: meataxe-1.0.p0: does not support check for system package; optional, use "./configure --enable-meataxe" to install
> }}}
> It would be nice if this actually noted that the user has requested its installation.
That's #29363 "At the end of configure, indicate which optional/experimental packages are configured to be installed"


---

Comment by jhpalmieri created at 2020-03-23 23:10:50

Replying to [comment:8 mkoeppe]:
> Replying to [comment:6 jhpalmieri]:
> > I took a fresh tarball and merged this branch. When I ran `./sage -i meataxe`, it ran `configure` three times in a row. Is this expected?
> That's clearly too much.

With a fully built Sage, running `./sage -i -p_group_cohomology` just ran `configure` once.

Let me clarify about the other case. I took a fresh tarball for _9.1.beta8_, got this branch and ran `git rebase develop`. That's when `configure` ran three times. The first time:

```
% ./sage -i meataxe                           
make -j6 build/make/Makefile --stop
make[1]: warning: -jN forced in submake: disabling jobserver mode.
rm -f config.log
mkdir -p logs/pkgs
ln -s logs/pkgs/config.log config.log
checking for a BSD-compatible install... /usr/bin/install -c
checking whether build environment is sane... yes
checking for a thread-safe mkdir -p... config/install-sh -c -d
checking for gawk... no
...
```

The second time:

```
real	0m0.206s
user	0m0.156s
sys	0m0.038s
Sage build/upgrade complete!

running ./configure   '--enable-meataxe'
checking for a BSD-compatible install... /usr/bin/install -c
checking whether build environment is sane... yes
checking for a thread-safe mkdir -p... config/install-sh -c -d
checking for gawk... no
```

The third time:

```
checking for the package system in use... homebrew
configure: No equivalent system packages for homebrew are known to Sage
make -j6 build/make/Makefile --stop
make[1]: warning: -jN forced in submake: disabling jobserver mode.
rm -f config.log
mkdir -p logs/pkgs
ln -s logs/pkgs/config.log config.log
running CONFIG_SHELL=/bin/sh /bin/sh ./configure --enable-meataxe --no-create --no-recursion
checking for a BSD-compatible install... /usr/bin/install -c
checking whether build environment is sane... yes
checking for a thread-safe mkdir -p... config/install-sh -c -d
checking for gawk... no
```

If I start with a 9.1.beta7 tarball and use this branch, `configure` only runs twice.


---

Comment by dimpase created at 2020-03-24 02:15:47

these multiple runs of configure, in some cases up to 3 times, also happen without this branch. so this is not a regression.


---

Comment by mkoeppe created at 2020-03-24 02:27:14

Replying to [comment:11 dimpase]:
> these multiple runs of configure, in some cases up to 3 times, also happen without this branch. so this is not a regression.
I agree. But independent of this ticket, we should probably look at some point how to clean this up a bit.


---

Comment by jhpalmieri created at 2020-03-24 02:43:24

Well, I'm happy with this. Positive review from me. Dima (or `@`embray, if you're active these days), if you want to look at it more, feel free to set back to needs review.


---

Comment by jhpalmieri created at 2020-03-24 02:43:24

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-03-29 00:24:09

Resolution: fixed
