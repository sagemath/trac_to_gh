# Issue 32307: Meta-ticket: Fix unstable doctests detected after #29935

Issue created by migration from https://trac.sagemath.org/ticket/32544

Original creator: @kliem

Original creation time: 2021-09-21 06:34:28

- #32543: Mark unstable tests due do #29956.


---

Comment by jhpalmieri created at 2021-10-24 16:04:46

I see failures

```
./sage -t --long --warn-long 101.7 --random-seed=260367842280804525169259077536186393366 src/sage/modular/modform/numerical.py
```

In detail

```
Doctesting 1 file.
sage -t --long --warn-long 101.7 --random-seed=260367842280804525169259077536186393366 src/sage/modular/modform/numerical.py
**********************************************************************
File "src/sage/modular/modform/numerical.py", line 74, in sage.modular.modform.numerical.NumericalEigenforms
Failed example:
    n.ap(2)  # rel tol 2e-14
Expected:
    [3.0, -1.6180339887498947, 0.6180339887498968]
Got:
    [3.0, -1.6180339887498947, 0.6180339887498804]
Tolerance exceeded in 1 of 3:
    0.6180339887498968 vs 0.6180339887498804, tolerance 3e-14 > 2e-14
**********************************************************************
File "src/sage/modular/modform/numerical.py", line 76, in sage.modular.modform.numerical.NumericalEigenforms
Failed example:
    n.systems_of_eigenvalues(7)  # rel tol 2e-14
Expected:
    [
    [-1.6180339887498947, 2.2360679774997894, -3.2360679774997894],
    [0.6180339887498968, -2.236067977499788, 1.2360679774997936],
    [3.0, 4.0, 6.0]
    ]
Got:
    [
    [-1.6180339887498947, 2.2360679774997894, -3.2360679774997894],
    [0.6180339887498804, -2.2360679774998293, 1.2360679774997607],
    [3.0, 4.0, 6.0]
    ]
Tolerance exceeded in 2 of 9:
    0.6180339887498968 vs 0.6180339887498804, tolerance 3e-14 > 2e-14
    1.2360679774997936 vs 1.2360679774997607, tolerance 3e-14 > 2e-14
**********************************************************************
File "src/sage/modular/modform/numerical.py", line 88, in sage.modular.modform.numerical.NumericalEigenforms
Failed example:
    n.eigenvalues([2,3,5])  # rel tol 2e-14
Expected:
    [[3.0, -1.6180339887498947, 0.6180339887498968],
     [4.0, 2.2360679774997894, -2.236067977499788],
     [6.0, -3.2360679774997894, 1.2360679774997936]]
Got:
    [[3.0, -1.6180339887498947, 0.6180339887498804],
     [4.0, 2.2360679774997894, -2.2360679774998293],
     [6.0, -3.2360679774997894, 1.2360679774997607]]
Tolerance exceeded in 2 of 9:
    0.6180339887498968 vs 0.6180339887498804, tolerance 3e-14 > 2e-14
    1.2360679774997936 vs 1.2360679774997607, tolerance 3e-14 > 2e-14
**********************************************************************
1 item had failures:
   3 of   7 in sage.modular.modform.numerical.NumericalEigenforms
    [46 tests, 3 failures, 0.26 s]
----------------------------------------------------------------------
sage -t --long --warn-long 101.7 --random-seed=260367842280804525169259077536186393366 src/sage/modular/modform/numerical.py  # 3 doctests failed
```



---

Comment by @kliem created at 2021-10-26 07:34:38


```
sage -t --long --random-seed=180924489930967511277954046005685261728 src/sage/graphs/base/sparse_graph.pyx
**********************************************************************
File "src/sage/graphs/base/sparse_graph.pyx", line 1163, in sage.graphs.base.sparse_graph._test_adjacency_sequence_out
Failed example:
    _test_adjacency_sequence_out()  # long time
Exception raised:
    Traceback (most recent call last):
      File "/home/jonathan/Applications/sage/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/jonathan/Applications/sage/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.base.sparse_graph._test_adjacency_sequence_out[1]>", line 1, in <module>
        _test_adjacency_sequence_out()  # long time
      File "sage/graphs/base/sparse_graph.pyx", line 1189, in sage.graphs.base.sparse_graph._test_adjacency_sequence_out (build/cythonized/sage/graphs/base/sparse_graph.c:9302)
        u = randint(low, n - 1)
      File "/home/jonathan/Applications/sage/local/lib/python3.8/site-packages/sage/misc/prandom.py", line 137, in randint
        return _pyrand().randint(a, b)
      File "/home/jonathan/Applications/sage/local/lib/python3.8/site-packages/sage/cpython/_py2_random.py", line 220, in randint
        return self.randrange(a, b+1)
      File "/home/jonathan/Applications/sage/local/lib/python3.8/site-packages/sage/cpython/_py2_random.py", line 195, in randrange
        raise ValueError("empty range for randrange() (%d,%d, %d)" %
    ValueError: empty range for randrange() (0,0, 0)
```


```
sage -t --long --random-seed=180924489930967511277954046005685261728 src/sage/graphs/generators/families.py
**********************************************************************
File "src/sage/graphs/generators/families.py", line 1477, in sage.graphs.generators.families.FriendshipGraph
Failed example:
    G.diameter()
Expected:
    2
Got:
    1
```



---

Comment by @kliem created at 2021-10-26 07:42:39


```
sage -t --long --random-seed=23747002002644886606785003174022326205 src/sage/modules/free_module_integer.py
**********************************************************************
File "src/sage/modules/free_module_integer.py", line 370, in sage.modules.free_module_integer.FreeModule_submodule_with_basis_integer.LLL
Failed example:
    new_min <= old_min
Expected:
    True
Got:
    False

sage -t --long --random-seed=23747002002644886606785003174022326205 src/sage/schemes/toric/sheaf/klyachko.py
**********************************************************************
File "src/sage/schemes/toric/sheaf/klyachko.py", line 951, in sage.schemes.toric.sheaf.klyachko.KlyachkoBundle_class.random_deformation
Failed example:
    Vtilde.cohomology(dim=True, weight=(0,))
Expected:
    (1, 0)
Got:
    (0, 0)
```



---

Comment by @kliem created at 2021-10-26 08:37:47


```
sage -t --long --random-seed=77478494819088915365500074763386376542 src/sage/rings/continued_fraction.py
**********************************************************************
File "src/sage/rings/continued_fraction.py", line 265, in sage.rings.continued_fraction.rat_interval_cf_list
Failed example:
    for prec in range(10,54):
        R = RealIntervalField(20)
        for _ in range(100):
            x = R.random_element() * R.random_element() + R.random_element() / 100
            l = x.lower().exact_rational()
            u = x.upper().exact_rational()
            cf = rat_interval_cf_list(l,u)
            a = continued_fraction(cf).value()
            b = continued_fraction(cf+[1]).value()
            if a > b:
                a,b = b,a
            assert a <= l
            assert b >= u
Exception raised:
    Traceback (most recent call last):
      File "/home/jonathan/Applications/sage/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/jonathan/Applications/sage/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.continued_fraction.rat_interval_cf_list[2]>", line 8, in <module>
        a = continued_fraction(cf).value()
      File "/home/jonathan/Applications/sage/local/lib/python3.8/site-packages/sage/rings/continued_fraction.py", line 2625, in continued_fraction
        x1, x2 = check_and_reduce_pair(x)
      File "/home/jonathan/Applications/sage/local/lib/python3.8/site-packages/sage/rings/continued_fraction.py", line 2254, in check_and_reduce_pair
        raise ValueError("continued fraction can not represent infinity")
    ValueError: continued fraction can not represent infinity
**********************************************************************
1 item had failures:
   1 of   4 in sage.rings.continued_fraction.rat_interval_cf_list
    [437 tests, 1 failure, 5.09 s]
-------------------------------------------------------------
```



---

Comment by @kliem created at 2021-10-26 09:48:48

Created tickets for reported failures so far.


---

Comment by mkoeppe created at 2021-10-28 05:11:18

Seen in https://patchbot.sagemath.org/log/32777/Linux/1_SMP_Debian_5.10.70-1_(2021-09-30)/x86_64/5.10.0-9-amd64/tmonteil-lxc1/2021-10-27%2001:20:12

```
sage -t --long --random-seed=321172385432269463934777057410284981568 src/sage/rings/polynomial/multi_polynomial_ring_base.pyx
**********************************************************************
File "src/sage/rings/polynomial/multi_polynomial_ring_base.pyx", line 994, in sage.rings.polynomial.multi_polynomial_ring_base.MPolynomialRing_base.random_element
Failed example:
    len(list(f))
Expected:
    1
Got:
    0
```



---

Comment by mkoeppe created at 2021-10-28 06:22:12

From https://patchbot.sagemath.org/log/32762/Linux/1_SMP_Debian_5.10.70-1_(2021-09-30)/x86_64/5.10.0-9-amd64/tmonteil-lxc1/2021-10-25%2015:13:58

```
sage -t --long --random-seed=324642231642420052385517156149041216749 src/sage/dynamics/arithmetic_dynamics/projective_ds.py
**********************************************************************
File "src/sage/dynamics/arithmetic_dynamics/projective_ds.py", line 7076, in sage.dynamics.arithmetic_dynamics.projective_ds.?.conjugating_set
Failed example:
    D6.conjugating_set(D6)
Expected:
    [
    [1 0]  [0 1]  [0 2]  [4 0]  [2 0]  [0 4]
    [0 1], [1 0], [1 0], [0 1], [0 1], [1 0]
    ]
Got:
    [
    [4 0]  [2 0]  [0 4]  [1 0]  [0 1]  [0 2]
    [0 1], [0 1], [1 0], [0 1], [1 0], [1 0]
    ]
```



---

Comment by @kliem created at 2021-11-03 10:40:27

Created tickets for reported failures so far.


---

Comment by slelievre created at 2021-12-29 22:55:49

See also this discussion:

- [sage-devel, 2021-12, What's the plan for random doctests with floating point numbers?](https://groups.google.com/g/sage-devel/c/3G6Y-D4mTaI)


---

Comment by chapoton created at 2022-01-29 08:58:50

bump to 9.6


---

Comment by dcoudert created at 2022-07-20 11:58:55

2 random errors with 9.7.beta5 (both macOS and fedora):

```
sage -t --long --random-seed=224943010850339078223674527953664126031 src/sage/plot/plot.py
**********************************************************************
File "src/sage/plot/plot.py", line 1819, in sage.plot.plot.plot
Failed example:
    plot(f, (x, -3.5, 3.5), detect_poles='show', exclude=[-3..3], ymin=-5, ymax=5)
Expected:
    Graphics object consisting of 12 graphics primitives
Got:
    Graphics object consisting of 13 graphics primitives
```

and

```
sage -t --long --random-seed=224943010850339078223674527953664126031 src/sage/schemes/toric/sheaf/klyachko.py
**********************************************************************
File "src/sage/schemes/toric/sheaf/klyachko.py", line 951, in sage.schemes.toric.sheaf.klyachko.KlyachkoBundle_class.random_deformation
Failed example:
    Vtilde.cohomology(dim=True, weight=(0,))
Expected:
    (1, 0)
Got:
    (0, 0)
```



---

Comment by @DaveWitteMorris created at 2022-07-20 17:31:18

The failures in comment:29 already have tickets: the plot failure is #33129 and the Vtilde.cohomology failure is #32773 (which is already in the ticket description). So I added #33129 to the ticket description.


---

Comment by mkoeppe created at 2022-09-11 04:22:51


```
sage -t --random-seed=124699541928353137721504742146487601068 src/sage/graphs/generators/random.py
**********************************************************************
File "src/sage/graphs/generators/random.py", line 817, in sage.graphs.generators.random.RandomHolmeKim
Failed example:
    G.subgraph_search(C3)
Expected:
    Subgraph of (): Graph on 3 vertices
Got:
    <BLANKLINE>
**********************************************************************
1 item had failures:
   1 of   6 in sage.graphs.generators.random.RandomHolmeKim
    [197 tests, 1 failure, 1.92 s]
```



---

Comment by dcoudert created at 2022-09-11 10:56:08

This doctest checks for the existence of a triangle in `graphs.RandomHolmeKim(8, 2, 0.5)`.  To reduce the probability of getting a triangle free graph, we can go for a larger graph, or simply mark this test as random.


---

Comment by @DaveWitteMorris created at 2022-09-11 17:37:03

It's fine with me to mark this test as random, but I think it might be better to delete it, because it doesn't seem to be providing a very meaningful test of the Holme-Kim algorithm. (I am -1 on enlarging the graph or increasing the probability of triangle-formation.) Even if 0.5 is changed to 0 (which I think means that the triangle-formation step is being skipped), the graph still has at least one triangle with high probability.

```
sage: count = sum(graphs.RandomHolmeKim(8, 2, 0).triangles_count() > 0 for _ in range(1000))
sage: print(f"{round(count/10,1)}% of the graphs have at least one triangle")
99.1% of the graphs have at least one triangle
sage: [graphs.RandomHolmeKim(8, 2, 0).triangles_count() for _ in range(10)]
[4, 4, 3, 4, 3, 4, 3, 2, 2, 3]
```

Ideally, we would have a better test that the algorithm is working correctly, but I don't have any suggestions.


---

Comment by dcoudert created at 2022-09-11 17:59:27

I opened #34520. I agree that it's better to completely remove the doctest and I don't have better tests in mind yet.


---

Comment by dcoudert created at 2022-11-19 13:04:39

with sage 9.8.beta3

```
sage -t --long --warn-long 41.8 --random-seed=133497414867200611466007568756298202280 src/sage/homology/tests.py
**********************************************************************
File "src/sage/homology/tests.py", line 50, in sage.homology.tests.random_chain_complex
Failed example:
    C
Expected:
    Chain complex with at most ... nonzero terms over Integer Ring
Got:
    Trivial chain complex over Integer Ring
**********************************************************************
File "src/sage/homology/tests.py", line 52, in sage.homology.tests.random_chain_complex
Failed example:
    len(C.nonzero_degrees()) in [1, 2]
Expected:
    True
Got:
    False
**********************************************************************
```



---

Comment by jhpalmieri created at 2022-11-19 19:57:14

Replying to [comment:36 David Coudert]:
> with sage 9.8.beta3
> {{{
> sage -t --long --warn-long 41.8 --random-seed=133497414867200611466007568756298202280 src/sage/homology/tests.py
> **********************************************************************
> File "src/sage/homology/tests.py", line 50, in sage.homology.tests.random_chain_complex
> Failed example:
>     C
> Expected:
>     Chain complex with at most ... nonzero terms over Integer Ring
> Got:
>     Trivial chain complex over Integer Ring
> **********************************************************************
> File "src/sage/homology/tests.py", line 52, in sage.homology.tests.random_chain_complex
> Failed example:
>     len(C.nonzero_degrees()) in [1, 2]
> Expected:
>     True
> Got:
>     False
> **********************************************************************
> }}}

I have a fix in #34762.
