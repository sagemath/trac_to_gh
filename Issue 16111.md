# Issue 16111: Cdd linker path

Issue created by migration from Trac.

Original creator: vbraun

Original creation time: 2014-05-13 14:17:54




---

Comment by vbraun created at 2014-05-13 14:42:30

Changing type from PLEASE CHANGE to defect.


---

Comment by vbraun created at 2014-05-13 14:42:30

Changing component from PLEASE CHANGE to build.


---

Comment by vbraun created at 2014-05-13 14:42:30

New commits:


---

Comment by vbraun created at 2014-05-13 14:42:30

Changing status from new to needs_review.


---

Comment by leif created at 2014-05-13 15:15:08

Wouldn't it make sense to add a _separate_ patch for this?

(The other changes are unrelated, and probably subject to change/vanish with #15871.)


---

Comment by vbraun created at 2014-05-13 15:17:25

Feel free to change the way changes are split into patches.


---

Comment by leif created at 2014-05-13 15:24:10

The main culprit is

```make
export gmpdir := /usr/local
```

in `cddlib-094g.p0/src/Makefile`, so calling `$MAKE gmpdir="$SAGE_LOCAL` might also work without patching anything further, or just changing _that_ line.


---

Comment by leif created at 2014-05-13 15:25:09

Replying to [comment:4 vbraun]:
> Feel free to change the way changes are split into patches.

Not my job.


---

Comment by vbraun created at 2014-05-13 15:27:25

You can override gmpdir, but then SAGE_LOCAL will be added multiple times to the include/linker path.


---

Comment by vbraun created at 2014-05-13 15:34:40

Changing priority from major to blocker.


---

Comment by leif created at 2014-05-13 15:52:02

Replying to [comment:7 vbraun]:
> You can override gmpdir, but then SAGE_LOCAL will be added multiple times to the include/linker path.

... which doesn't hurt (unless we're e.g. exceeding the maximal number of command line arguments, but then other packages and especially the Sage library won't build either).


---

Comment by leif created at 2014-05-13 15:53:52

... or just remove adding `"$SAGE_LOCAL/..."` to `CPPFLAGS` and `LDFLAGS` in turn.


---

Comment by vbraun created at 2014-05-13 16:03:35

These are all equivalent solutions. None has any significant advantage over the others.


---

Comment by leif created at 2014-05-13 16:17:40

Well, even in Sage ;-) we have the convention

 * to only patch upstream if necessary (and submit such patches upstream if appropriate)

 * one issue per patch

 * ...

It's tedious and error-prone to later untangle cumulative patches, not to mention reviewing and documentation of patches.


---

Comment by vbraun created at 2014-05-13 16:44:15

Either off topic or doesn't work here (because its likely to trigger autoconf runs)


---

Comment by leif created at 2014-05-13 18:21:18

http://trac.sagemath.org/ticket/13026#comment:15

To go triple-safe, touch the autotools-generated files in `spkg-install` after patching.

But as mentioned, patching the autotools _source_ files is not even necessary in this case (although it would make sense to submit such a patch upstream, and hopefully remove it (and only this specific one!) upon one of the next upstream upgrades).

I can't follow what otherwise would be off-topic, but that's probably intended.


---

Comment by vbraun created at 2014-05-13 18:37:00

The `.am` patches are not applied in `spkg-install`, fyi.


---

Comment by leif created at 2014-05-13 18:41:52

Replying to [comment:15 vbraun]:
> The `.am` patches are not applied in `spkg-install`, fyi.

I know, which is IMHO a bad hack anyway.

But how is this related?


---

Comment by vbraun created at 2014-05-13 18:47:36

IMHO all of cddlib is a bad hack. We basically only have it because gfan depends on it.

In any case, this ticket is about making cddlib compile if there is something in `/usr/local`. Suggestions about how to reorganize the patches and still avoid re-running autoconf are off-topic, as you said.


---

Comment by leif created at 2014-05-13 19:09:31

I'm talking about making the spkg even less maintainable (and distro-unfriendly), which is what you currently IMHO do, for no reason.

The issue here btw. popped up again because a previous patch got removed upon the last upgrade.


---

Comment by vbraun created at 2014-05-13 19:15:55

No the issue popped up again because replacing the upstream insanity with a sane autotools project was removed.


---

Comment by fbissey created at 2014-05-13 22:11:36

This is so wrong. Volker's patch is just the minimal work to make it more distro friendly. I would remove the "export"s statements from the the top Makefile.am too.
That particular mistake is usually not too bad for distro preparing binary packages in a sensible way. But it is ugly as hell.

To finish with the comments on distro unfriendliness we fortunately start with upstream adding only the piece we deem necessary. We don't start from the sage spkg unless there is no other sources around :)

I am a bit uncomfortable with the way autotools patches are applied and enforced but I can  accept that. I am more to apply the full autotool solution that could be pushed upstream if they were responsive rather than the quick nice fix proposed by Leif.
So if I have a deciding vote I am going for Volker.


---

Comment by leif created at 2014-05-14 09:30:34

Replying to [comment:20 fbissey]:
> To finish with the comments on distro unfriendliness we fortunately start with upstream adding only the piece we deem necessary. We don't start from the sage spkg unless there is no other sources around :)

To clarify, I'm not against patching the autotools files, I'm against mixing completely unrelated patches.  Especially if we want to submit _parts of it_ upstream.  (And it's easy to make sure they get applied in the correct order if at all relevant.  Same for timestamps if patched files depend on other patched files.)

And I'm sorry to say, but unfortunately Gentoo still isn't the only distro. ;-)

Others prefer to have `patches/fix_upstream_bug_{foo,bar}.patch`, `patches/add_sage_functionality_baz.patch` rather than `patches/modifying_{this,that}_file_for_a_couple_of_reason_you_can_probably_guess.patch`. 

Even for just Sage, the former is by far more easy to maintain.




> I am a bit uncomfortable with the way autotools patches are applied and enforced but I can  accept that. I am more to apply the full autotool solution that could be pushed upstream if they were responsive rather than the quick nice fix proposed by Leif.
> So if I have a deciding vote I am going for Volker.

You have it, just give it positive review if you really feel it's _the right thing_<sup>TM</sup> to do.  Also in the light of #15871.

Although the Debianists should probably speak up, too.


---

Comment by fbissey created at 2014-05-14 09:42:49

Replying to [comment:21 leif]:
> Replying to [comment:20 fbissey]:
> > To finish with the comments on distro unfriendliness we fortunately start with upstream adding only the piece we deem necessary. We don't start from the sage spkg unless there is no other sources around :)
> 
> To clarify, I'm not against patching the autotools files, I'm against mixing completely unrelated patches.  Especially if we want to submit _parts of it_ upstream.  (And it's easy to make sure they get applied in the correct order if at all relevant.  Same for timestamps if patched files depend on other patched files.)
> 
> And I'm sorry to say, but unfortunately Gentoo still isn't the only distro. ;-)
> 

How very unfortunate ;) that's why I have to read rpm .spec files from time to time and even troll debian sources.But that was a long and boring dragging comment - the kind you make in the morning because you are gathering your thoughts.

> Others prefer to have `patches/fix_upstream_bug_{foo,bar}.patch`, `patches/add_sage_functionality_baz.patch` rather than `patches/modifying_{this,that}_file_for_a_couple_of_reason_you_can_probably_guess.patch`. 
> 
> Even for just Sage, the former is by far more easy to maintain.
> 
> 

> 
> > I am a bit uncomfortable with the way autotools patches are applied and enforced but I can  accept that. I am more to apply the full autotool solution that could be pushed upstream if they were responsive rather than the quick nice fix proposed by Leif.
> > So if I have a deciding vote I am going for Volker.
> 
> You have it, just give it positive review if you really feel it's _the right thing_<sup>TM</sup> to do.  Also in the light of #15871.
> 
> Although the Debianists should probably speak up, too.

I guess we would need to invite them next time ;)

In the absence of a nice way to run autoreconf and al. on pristine source (as Gentoo would) it is good enough for me. What we should send upstream and in which form is another discussion.


---

Comment by fbissey created at 2014-05-14 09:42:49

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-05-15 17:18:39

Resolution: fixed
