# Issue 22763: Assumptions on symbols not preserved with some unevaluated integrals

archive/issues_022526.json:
```json
{
    "body": "In a fresh Sage, assumptions on symbols within expressions are preserved when Maxima returns the same expression in an unevaluated integral. But in this case the domain/flag information of `m` is somehow cleared/deleted:\n\n```\nsage: _ = var('m')\nsage: (x^m / sqrt(2+3*x)).integral(x)\nintegrate(x^m/sqrt(3*x + 2), x)\nsage: _= var('m', domain='integer')\nsage: (x^m / sqrt(2+3*x)).integral(x)\nintegrate(x^m/sqrt(3*x + 2), x)\nsage: _.operands()[0].operands()[1]\nx^m\nsage: _.operands()[1].is_integer()\nFalse\n```\n`assume(m, 'integer')` cannot restore the flag of `m` in the returned integral.\n\nThe problem does not occur without the first two lines.  Maybe the first creation of `m` does somehow irrevocably set something in Maxima (or Sage's module for backtranslation)?\n\n\nCC:  @nbruin\n\nAuthor: Ralf Stephan\n\nBranch: u/rws/assumptions_on_symbols_not_preserved_with_some_unevaluated_integrals\n\nStatus: needs_work\n\nCommit: 39567f474257574983fb0f16bf6fc45aff4c238a\n\nIssue created by migration from https://trac.sagemath.org/ticket/22763\n\n",
    "created_at": "2017-04-05T14:14:29Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Assumptions on symbols not preserved with some unevaluated integrals",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22763",
    "user": "https://github.com/rwst"
}
```
In a fresh Sage, assumptions on symbols within expressions are preserved when Maxima returns the same expression in an unevaluated integral. But in this case the domain/flag information of `m` is somehow cleared/deleted:

```
sage: _ = var('m')
sage: (x^m / sqrt(2+3*x)).integral(x)
integrate(x^m/sqrt(3*x + 2), x)
sage: _= var('m', domain='integer')
sage: (x^m / sqrt(2+3*x)).integral(x)
integrate(x^m/sqrt(3*x + 2), x)
sage: _.operands()[0].operands()[1]
x^m
sage: _.operands()[1].is_integer()
False
```
`assume(m, 'integer')` cannot restore the flag of `m` in the returned integral.

The problem does not occur without the first two lines.  Maybe the first creation of `m` does somehow irrevocably set something in Maxima (or Sage's module for backtranslation)?


CC:  @nbruin

Author: Ralf Stephan

Branch: u/rws/assumptions_on_symbols_not_preserved_with_some_unevaluated_integrals

Status: needs_work

Commit: 39567f474257574983fb0f16bf6fc45aff4c238a

Issue created by migration from https://trac.sagemath.org/ticket/22763





---

archive/issue_comments_313563.json:
```json
{
    "body": "<a id='comment:1'></a>#22650 depends on this.",
    "created_at": "2017-04-05T14:22:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22763#issuecomment-313563",
    "user": "https://github.com/rwst"
}
```

<a id='comment:1'></a>#22650 depends on this.



---

archive/issue_comments_313564.json:
```json
{
    "body": "<a id='comment:2'></a>It looks like `sage.interfaces.maxima_lib.sr_to_max` has several symbol dicts. `sage_sym_dict`'s keys are symbols and registered constants. At the first encounter of `(x^m / sqrt(2+3*x)).integral(x)` `m` is inserted there. The hash of the second `m` is the same, and presumably that's why there is no change in the dictionary. As the `m`s are different the hash should be different too and there is the Pynac bug that if fixed should fix this ticket too. Alternatively the dicts should be updated in `var` when variables are created.",
    "created_at": "2017-04-06T07:31:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22763#issuecomment-313564",
    "user": "https://github.com/rwst"
}
```

<a id='comment:2'></a>It looks like `sage.interfaces.maxima_lib.sr_to_max` has several symbol dicts. `sage_sym_dict`'s keys are symbols and registered constants. At the first encounter of `(x^m / sqrt(2+3*x)).integral(x)` `m` is inserted there. The hash of the second `m` is the same, and presumably that's why there is no change in the dictionary. As the `m`s are different the hash should be different too and there is the Pynac bug that if fixed should fix this ticket too. Alternatively the dicts should be updated in `var` when variables are created.



---

archive/issue_comments_313565.json:
```json
{
    "body": "<a id='comment:3'></a>Actually hashes have nothing to do with it. The vars are not the keys in the dictionary and, even if they were, hash makes no difference because keys are compared via `bool(a==b)`, ie `ex.__nonzero__()` is used and there lhs-rhs is zero even for vars with different flags or hashes.",
    "created_at": "2017-04-06T15:32:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22763#issuecomment-313565",
    "user": "https://github.com/rwst"
}
```

<a id='comment:3'></a>Actually hashes have nothing to do with it. The vars are not the keys in the dictionary and, even if they were, hash makes no difference because keys are compared via `bool(a==b)`, ie `ex.__nonzero__()` is used and there lhs-rhs is zero even for vars with different flags or hashes.



---

archive/issue_comments_313566.json:
```json
{
    "body": "<a id='comment:5'></a>New commits:",
    "created_at": "2017-04-07T07:59:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22763#issuecomment-313566",
    "user": "https://github.com/rwst"
}
```

<a id='comment:5'></a>New commits:



---

archive/issue_comments_313567.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-04-07T07:59:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22763#issuecomment-313567",
    "user": "https://github.com/rwst"
}
```

Changing status from new to needs_review.



---

archive/issue_events_059251.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2018-03-03T16:51:20Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22763",
    "milestone": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22763#event-59251"
}
```



---

archive/issue_comments_313568.json:
```json
{
    "body": "<a id='comment:7'></a>red branch => needs work",
    "created_at": "2021-10-21T11:55:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22763#issuecomment-313568",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:7'></a>red branch => needs work



---

archive/issue_comments_313569.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-10-21T11:55:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22763#issuecomment-313569",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.
