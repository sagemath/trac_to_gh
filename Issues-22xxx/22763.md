# Issue 22763: Fix inconsistency in `Modules.FiniteDimensional.extra_super_categories`

archive/issues_022763.json:
```json
{
    "body": "CC:  @tscrim\n\nFinite dimensional modules over a finite field are known to Sage to be finite:\n\n```\n    sage: Modules(GF(3)).FiniteDimensional().is_subcategory(Sets().Finite())\n    True\n```\n\nHowever this piece of knowledge was ignored if a\nbase ring category instead of a base ring was passed to `Modules`:\n\n```\n    sage: Modules(Field().Finite()).FiniteDimensional().is_subcategory(Sets().Finite())\n    True\n```\n\nThis ticket fixes this.\n\n## Comments\n\nThis is yet another avatar of the current lack of robustness of\ncategories over base rings. With #20962 which will make module\ncategories singletons, this kind of inconsistency won't be possible\nanymore.\n\nThis issue was discovered while tracking a bug in #18700 which\nimplemented a new category `AdditiveGroups.Finite`, which triggered\nthe following doctest failure:\n\n```\nsage: K = simplicial_complexes.Simplex(2)\nsage: H = Hom(K,K)\nsage: id = H.identity()\nsage: id.induced_homology_morphism(GF(13)).base_ring()\nTraceback (most recent call last)\n.../opt/sage-git2/src/sage/misc/c3_controlled.pyx in sage.misc.c3_controlled.C3_sorted_merge (/opt/sage-git2/src/build/cythonized/sage/misc/c3_controlled.c:5151)()\n    936                     heads[j] = X\n    937                     tailset = tailsets[j]\n--> 938                     tailset.remove(key(X))\n    939                 else:\n    940                     del heads[j]\n\nKeyError: (258, 65)\n```\n\n## Detailed analysis\n\nRecall that:\n\n- categories are endowed with a total order which is used to ensure\n  that the Method Resolution Orders chosen by Python are always\n  consistent. This total order shall refine the subcategory relation.\n  This is achieved by assigning a comparison key to each category\n  according to the order in which they are created (and some further\n  data)\n\n- To avoid creating many copies of the same hierarchy of classes,\n  parametrized categories may share their parent/element/... classes,\n  and therefore the same comparison key.\n\nIn the case at hand,\n`C1=Modules(Fields().Finite().FiniteDimensional()` was created first.\nSince it was not a subcategory of `A=AdditiveGroups().Finite()`, there\nwas no constraint on their relative comparison keys; it then turned\nout that `C` was assigned a comparison key smaller than that of `A`.\n\nLater on, when `C2=Modules(GF(3)).FiniteDimensional()` got created, it\ngot the same comparison key as `C1` while simultaneously deriving from\n`A`, breaking the assumption.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/23000\n\n",
    "closed_at": "2017-05-20T20:07:40Z",
    "created_at": "2017-05-15T02:28:07Z",
    "labels": [
        "component: categories",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "Fix inconsistency in `Modules.FiniteDimensional.extra_super_categories`",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22763",
    "user": "https://github.com/nthiery"
}
```
CC:  @tscrim

Finite dimensional modules over a finite field are known to Sage to be finite:

```
    sage: Modules(GF(3)).FiniteDimensional().is_subcategory(Sets().Finite())
    True
```

However this piece of knowledge was ignored if a
base ring category instead of a base ring was passed to `Modules`:

```
    sage: Modules(Field().Finite()).FiniteDimensional().is_subcategory(Sets().Finite())
    True
```

This ticket fixes this.

## Comments

This is yet another avatar of the current lack of robustness of
categories over base rings. With #20962 which will make module
categories singletons, this kind of inconsistency won't be possible
anymore.

This issue was discovered while tracking a bug in #18700 which
implemented a new category `AdditiveGroups.Finite`, which triggered
the following doctest failure:

```
sage: K = simplicial_complexes.Simplex(2)
sage: H = Hom(K,K)
sage: id = H.identity()
sage: id.induced_homology_morphism(GF(13)).base_ring()
Traceback (most recent call last)
.../opt/sage-git2/src/sage/misc/c3_controlled.pyx in sage.misc.c3_controlled.C3_sorted_merge (/opt/sage-git2/src/build/cythonized/sage/misc/c3_controlled.c:5151)()
    936                     heads[j] = X
    937                     tailset = tailsets[j]
--> 938                     tailset.remove(key(X))
    939                 else:
    940                     del heads[j]

KeyError: (258, 65)
```

## Detailed analysis

Recall that:

- categories are endowed with a total order which is used to ensure
  that the Method Resolution Orders chosen by Python are always
  consistent. This total order shall refine the subcategory relation.
  This is achieved by assigning a comparison key to each category
  according to the order in which they are created (and some further
  data)

- To avoid creating many copies of the same hierarchy of classes,
  parametrized categories may share their parent/element/... classes,
  and therefore the same comparison key.

In the case at hand,
`C1=Modules(Fields().Finite().FiniteDimensional()` was created first.
Since it was not a subcategory of `A=AdditiveGroups().Finite()`, there
was no constraint on their relative comparison keys; it then turned
out that `C` was assigned a comparison key smaller than that of `A`.

Later on, when `C2=Modules(GF(3)).FiniteDimensional()` got created, it
got the same comparison key as `C1` while simultaneously deriving from
`A`, breaking the assumption.


Issue created by migration from https://trac.sagemath.org/ticket/23000





---

archive/issue_comments_317793.json:
```json
{
    "body": "All tests passed on my machine.\n\nNot yet \"needs review\" for I want to dig once more in to check a detail I did not quite fully understand yet in the failure.\n\n---\nNew commits:",
    "created_at": "2017-05-15T03:26:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22763#issuecomment-317793",
    "user": "https://github.com/nthiery"
}
```

All tests passed on my machine.

Not yet "needs review" for I want to dig once more in to check a detail I did not quite fully understand yet in the failure.

---
New commits:



---

archive/issue_comments_317794.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2017-05-15T03:26:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22763#issuecomment-317794",
    "user": "https://github.com/nthiery"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_317795.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2017-05-15T03:26:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22763#issuecomment-317795",
    "user": "https://github.com/nthiery"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_317796.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to categories.",
    "created_at": "2017-05-15T03:26:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22763#issuecomment-317796",
    "user": "https://github.com/nthiery"
}
```

Changing component from PLEASE CHANGE to categories.



---

archive/issue_comments_317797.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-05-15T03:27:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22763#issuecomment-317797",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_317798.json:
```json
{
    "body": "(force repushed after fixing the commit message).",
    "created_at": "2017-05-15T03:28:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22763#issuecomment-317798",
    "user": "https://github.com/nthiery"
}
```

(force repushed after fixing the commit message).



---

archive/issue_comments_317799.json:
```json
{
    "body": "Okay, I think I understand why this change is needed. Did you manage to track down the detail you mentioned in comment:3?",
    "created_at": "2017-05-15T16:07:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22763#issuecomment-317799",
    "user": "https://github.com/tscrim"
}
```

Okay, I think I understand why this change is needed. Did you manage to track down the detail you mentioned in comment:3?



---

archive/issue_comments_317800.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-05-15T22:30:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22763#issuecomment-317800",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_317801.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-16T01:55:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22763#issuecomment-317801",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_317802.json:
```json
{
    "body": "My analysis was actually incorrect. The culprit really was in the categories, not the infrastructure, and is fixed now. The infrastructure just made it easy to screw up and hard to track. This later point should be fixed with #22962.\n\nAll long tests pass.",
    "created_at": "2017-05-16T01:58:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22763#issuecomment-317802",
    "user": "https://github.com/nthiery"
}
```

My analysis was actually incorrect. The culprit really was in the categories, not the infrastructure, and is fixed now. The infrastructure just made it easy to screw up and hard to track. This later point should be fixed with #22962.

All long tests pass.



---

archive/issue_comments_317803.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2017-05-16T01:58:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22763#issuecomment-317803",
    "user": "https://github.com/nthiery"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_317804.json:
```json
{
    "body": "I'll now rebase #18700 on top of this one.",
    "created_at": "2017-05-16T01:59:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22763#issuecomment-317804",
    "user": "https://github.com/nthiery"
}
```

I'll now rebase #18700 on top of this one.



---

archive/issue_comments_317805.json:
```json
{
    "body": "Somehow this change and why it wasn't working seems like something we should have realized sooner. I don't think this check is done elsewhere. Positive review.",
    "created_at": "2017-05-16T03:24:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22763#issuecomment-317805",
    "user": "https://github.com/tscrim"
}
```

Somehow this change and why it wasn't working seems like something we should have realized sooner. I don't think this check is done elsewhere. Positive review.



---

archive/issue_comments_317806.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-05-16T03:24:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22763#issuecomment-317806",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_317807.json:
```json
{
    "body": "Thanks for the review!\n\nI had done a quick search for other `extra_super_categories` where similar checks, and indeed did not find any.",
    "created_at": "2017-05-16T03:52:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22763#issuecomment-317807",
    "user": "https://github.com/nthiery"
}
```

Thanks for the review!

I had done a quick search for other `extra_super_categories` where similar checks, and indeed did not find any.



---

archive/issue_comments_317808.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-05-20T20:07:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22763#issuecomment-317808",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_059588.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-05-20T20:07:40Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/22763",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22763#event-59588"
}
```
