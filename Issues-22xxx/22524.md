# Issue 22524: Optimize computing points of lattice polytopes

archive/issues_022287.json:
```json
{
    "body": "A follow up to #22391. My original problem was too slow computation of zero via\n\n```python\nDelta3 = LatticePolytope([(1,0,0), (0,1,0), (0,0,1), (-1,-4,-6)])\nsum(len(e.interior_points()) * len(e.dual().interior_points()) for e in Delta3.edges())\n```\nSage 7.6.beta4 gives\n- timeit: 5 loops, best of 3: 1.73 s per loop\n- profiler: 71844 function calls (71620 primitive calls) in 1.841 seconds\nWith #22391\n- timeit: 5 loops, best of 3: 451 ms per loop\n- profiler: 46502 function calls (46434 primitive calls) in 0.570 seconds\nWith this one\n- timeit: 25 loops, best of 3: 11.3 ms per loop\n- profiler: 7793 function calls (7747 primitive calls) in 0.031 seconds\n\nAs a less contrived example, it now takes 0.41s to get `ReflexivePolytopes(3)` (cached afterwards) instead of 7.61s. Part of the speed up is due to omitting some precomputation, but it is possible to do so because of speed up on demand.\n\nNext goal is not to rely on PALP for computing points of standalone polytopes at all, although for large sets of polytopes it still may be the fastest option.\n\nKeywords: sd91\n\nReviewer: Travis Scrimshaw\n\nAuthor: Andrey Novoseltsev\n\nBranch: e37e8f7a3280a89ee1328f39fc2e92b045397401\n\nDependencies: #22391, #22400\n\nCommit: e37e8f7a3280a89ee1328f39fc2e92b045397401\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/22524\n\n",
    "closed_at": "2017-12-11T01:03:57Z",
    "created_at": "2017-03-06T04:57:17Z",
    "labels": [
        "component: geometry"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Optimize computing points of lattice polytopes",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22524",
    "user": "https://github.com/novoselt"
}
```
A follow up to #22391. My original problem was too slow computation of zero via

```python
Delta3 = LatticePolytope([(1,0,0), (0,1,0), (0,0,1), (-1,-4,-6)])
sum(len(e.interior_points()) * len(e.dual().interior_points()) for e in Delta3.edges())
```
Sage 7.6.beta4 gives
- timeit: 5 loops, best of 3: 1.73 s per loop
- profiler: 71844 function calls (71620 primitive calls) in 1.841 seconds
With #22391
- timeit: 5 loops, best of 3: 451 ms per loop
- profiler: 46502 function calls (46434 primitive calls) in 0.570 seconds
With this one
- timeit: 25 loops, best of 3: 11.3 ms per loop
- profiler: 7793 function calls (7747 primitive calls) in 0.031 seconds

As a less contrived example, it now takes 0.41s to get `ReflexivePolytopes(3)` (cached afterwards) instead of 7.61s. Part of the speed up is due to omitting some precomputation, but it is possible to do so because of speed up on demand.

Next goal is not to rely on PALP for computing points of standalone polytopes at all, although for large sets of polytopes it still may be the fastest option.

Keywords: sd91

Reviewer: Travis Scrimshaw

Author: Andrey Novoseltsev

Branch: e37e8f7a3280a89ee1328f39fc2e92b045397401

Dependencies: #22391, #22400

Commit: e37e8f7a3280a89ee1328f39fc2e92b045397401

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/22524





---

archive/issue_comments_309489.json:
```json
{
    "body": "<a id='comment:2'></a>Had to fix a doctest, results of `sage -t --long src/sage/schemes/toric/fano_variety.py`\n\n```\nBEFORE (7.6.beta4)\nTotal time for all tests: 20.5 seconds\n    cpu time: 13.5 seconds\n    cumulative wall time: 20.4 seconds\n\nAFTER\nTotal time for all tests: 5.0 seconds\n    cpu time: 3.8 seconds\n    cumulative wall time: 4.9 seconds\n```\n\n---\nLast 10 new commits:",
    "created_at": "2017-03-06T05:13:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22524",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22524#issuecomment-309489",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:2'></a>Had to fix a doctest, results of `sage -t --long src/sage/schemes/toric/fano_variety.py`

```
BEFORE (7.6.beta4)
Total time for all tests: 20.5 seconds
    cpu time: 13.5 seconds
    cumulative wall time: 20.4 seconds

AFTER
Total time for all tests: 5.0 seconds
    cpu time: 3.8 seconds
    cumulative wall time: 4.9 seconds
```

---
Last 10 new commits:



---

archive/issue_comments_309490.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-03-06T05:13:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22524",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22524#issuecomment-309490",
    "user": "https://github.com/novoselt"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_309491.json:
```json
{
    "body": "<a id='comment:3'></a>For large enough lattice point listing problems, considering using normaliz. Recent tickets have added it as a backend for `Polyhedron`.",
    "created_at": "2017-03-06T10:13:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22524",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22524#issuecomment-309491",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'></a>For large enough lattice point listing problems, considering using normaliz. Recent tickets have added it as a backend for `Polyhedron`.



---

archive/issue_comments_309492.json:
```json
{
    "body": "<a id='comment:4'></a>Sure, but in toric geometry especially related to mirror symmetry it is important to handle very simple cases fast (e.g. all reflexive polytopes have precisely one interior lattice point, the origin).\n\nOf course, it would be nice to handle all cases efficiently, and to be able to choose new methods appropriately I tried to first optimize existing one as much as possible, in particular not to take too much time just to convert data between different types.\n\nThanks for taking a look!",
    "created_at": "2017-03-06T16:08:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22524",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22524#issuecomment-309492",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:4'></a>Sure, but in toric geometry especially related to mirror symmetry it is important to handle very simple cases fast (e.g. all reflexive polytopes have precisely one interior lattice point, the origin).

Of course, it would be nice to handle all cases efficiently, and to be able to choose new methods appropriately I tried to first optimize existing one as much as possible, in particular not to take too much time just to convert data between different types.

Thanks for taking a look!



---

archive/issue_comments_309493.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-09-10T20:43:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22524",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22524#issuecomment-309493",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_309494.json:
```json
{
    "body": "Changing keywords from \"\" to \"sd91\".",
    "created_at": "2017-10-11T13:35:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22524",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22524#issuecomment-309494",
    "user": "https://github.com/simonbrandhorst"
}
```

Changing keywords from "" to "sd91".



---

archive/issue_comments_309495.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-11-09T05:03:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22524",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22524#issuecomment-309495",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_309496.json:
```json
{
    "body": "<a id='comment:9'></a>I think an even faster way than\n\n```python\nn = N.zero_vector()\nfor i, coef in enumerate(c.coefficients()):\n    n[i] = coef\nn.set_immutable()\nnormals.append(n)\n```\nwould be\n\n```python\nn = N.element_class(N, c.coefficients(), coerce=False, copy=False)\nn.set_immutable()\n```\n(although perhaps the coerce and copy are unnecessary). In general, if you know your input is good, you can bypass the extra overhead of `__call__` and `_element_constructor_` (there are a few places where you can do this I believe).\n\nAlso, it might be better to do\n\n```diff\n-                points = list(p.vertices())\n-                for j in range(nv, m.ncols()):\n-                    current = M.zero_vector()\n-                    for i in range(M.rank()):\n-                        current[i] = m[i, j]\n-                    current.set_immutable()\n-                    points.append(current)\n+                points = list(p.vertices()) + m.columns(copy=False)\n                 p._points = PointCollection(points, M)\n```\nAlthough I have not checked if the columns are longer than `M.rank()`.\n\nOtherwise LGTM.",
    "created_at": "2017-11-13T01:16:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22524",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22524#issuecomment-309496",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:9'></a>I think an even faster way than

```python
n = N.zero_vector()
for i, coef in enumerate(c.coefficients()):
    n[i] = coef
n.set_immutable()
normals.append(n)
```
would be

```python
n = N.element_class(N, c.coefficients(), coerce=False, copy=False)
n.set_immutable()
```
(although perhaps the coerce and copy are unnecessary). In general, if you know your input is good, you can bypass the extra overhead of `__call__` and `_element_constructor_` (there are a few places where you can do this I believe).

Also, it might be better to do

```diff
-                points = list(p.vertices())
-                for j in range(nv, m.ncols()):
-                    current = M.zero_vector()
-                    for i in range(M.rank()):
-                        current[i] = m[i, j]
-                    current.set_immutable()
-                    points.append(current)
+                points = list(p.vertices()) + m.columns(copy=False)
                 p._points = PointCollection(points, M)
```
Although I have not checked if the columns are longer than `M.rank()`.

Otherwise LGTM.



---

archive/issue_events_058868.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2017-11-13T01:16:59Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22524",
    "milestone": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22524#event-58868"
}
```



---

archive/issue_comments_309497.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-11-13T05:47:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22524",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22524#issuecomment-309497",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_309498.json:
```json
{
    "body": "<a id='comment:11'></a>Thank you for the pointer, `element_class` does lead to better timing and fewer function calls.\n\nRegarding using matrix columns - that code deals with only some part of a matrix and, more importantly, is only used in \"bad\" cases: when dealing with non-full-dimensional polytopes or with a separate PALP call for a single polytope rather than sequence. My quick attempts to improve them now just broke things and I don't think they are worthy of more effort - the real solution is to rely on different backend. On the other hand, for computing points of many full-dimensional polytopes at once PALP interface still may be the fastest.",
    "created_at": "2017-11-13T05:56:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22524",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22524#issuecomment-309498",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:11'></a>Thank you for the pointer, `element_class` does lead to better timing and fewer function calls.

Regarding using matrix columns - that code deals with only some part of a matrix and, more importantly, is only used in "bad" cases: when dealing with non-full-dimensional polytopes or with a separate PALP call for a single polytope rather than sequence. My quick attempts to improve them now just broke things and I don't think they are worthy of more effort - the real solution is to rely on different backend. On the other hand, for computing points of many full-dimensional polytopes at once PALP interface still may be the fastest.



---

archive/issue_comments_309499.json:
```json
{
    "body": "<a id='comment:12'></a>I see. Well, you can do the same `element_class` trick for\n\n```python\n                        current = M.zero_vector()\n                        for i in range(M.rank()):\n                            current[i] = m[i, j]\n```\n(there are 2 of these) and\n\n```python\n            p = lattice.zero_vector()\n            for j, e in enumerate(f.readline().split()):\n                p[j] = int(e)\n```",
    "created_at": "2017-11-13T06:56:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22524",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22524#issuecomment-309499",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:12'></a>I see. Well, you can do the same `element_class` trick for

```python
                        current = M.zero_vector()
                        for i in range(M.rank()):
                            current[i] = m[i, j]
```
(there are 2 of these) and

```python
            p = lattice.zero_vector()
            for j, e in enumerate(f.readline().split()):
                p[j] = int(e)
```



---

archive/issue_comments_309500.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-14T03:17:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22524",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22524#issuecomment-309500",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_309501.json:
```json
{
    "body": "<a id='comment:14'></a>Travis - many many many thanks for reviewing all these tickets, making suggestions, and pushing me to implement them! I got 3-fold reduction in function calls for `lattice_polytope.all_points(ReflexivePolytopes(3))` and the actual call to PALP is now responsible for a half of the time.\n\nRegarding using columns of matrices - it is kind of incompatible with `element_constructor` since it expects lists or tuples, not vectors. Constructing a vector and then converting it to a list takes 3 times longer than just constructing this list directly from matrix elements.\n\nI have also dropped `copy=False, coerce=False` since they do not seem to be used in the code and (while I cannot use vectors...) I can feed strings directly into `element_constructor` without converting them to `int` first.",
    "created_at": "2017-11-14T03:29:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22524",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22524#issuecomment-309501",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:14'></a>Travis - many many many thanks for reviewing all these tickets, making suggestions, and pushing me to implement them! I got 3-fold reduction in function calls for `lattice_polytope.all_points(ReflexivePolytopes(3))` and the actual call to PALP is now responsible for a half of the time.

Regarding using columns of matrices - it is kind of incompatible with `element_constructor` since it expects lists or tuples, not vectors. Constructing a vector and then converting it to a list takes 3 times longer than just constructing this list directly from matrix elements.

I have also dropped `copy=False, coerce=False` since they do not seem to be used in the code and (while I cannot use vectors...) I can feed strings directly into `element_constructor` without converting them to `int` first.



---

archive/issue_comments_309502.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-11-14T03:39:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22524",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22524#issuecomment-309502",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_309503.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:14 novoselt]:\n> Travis - many many many thanks for reviewing all these tickets, making suggestions, and pushing me to implement them! I got 3-fold reduction in function calls for `lattice_polytope.all_points(ReflexivePolytopes(3))` and the actual call to PALP is now responsible for a half of the time.\n\n\nNot a problem. I'm sorry to took me a while to get through them all.\n\n> Regarding using columns of matrices - it is kind of incompatible with `element_constructor` since it expects lists or tuples, not vectors. Constructing a vector and then converting it to a list takes 3 times longer than just constructing this list directly from matrix elements.\n\n\nI see.\n\n> I have also dropped `copy=False, coerce=False` since they do not seem to be used in the code and (while I cannot use vectors...) I can feed strings directly into `element_constructor` without converting them to `int` first.\n\n\nYea, that's not too surprising. I didn't think they were being used considering the datatypes, but it was more just-in-case.\n\nLGTM. Positive review.",
    "created_at": "2017-11-14T03:39:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22524",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22524#issuecomment-309503",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:15'></a>Replying to [comment:14 novoselt]:
> Travis - many many many thanks for reviewing all these tickets, making suggestions, and pushing me to implement them! I got 3-fold reduction in function calls for `lattice_polytope.all_points(ReflexivePolytopes(3))` and the actual call to PALP is now responsible for a half of the time.


Not a problem. I'm sorry to took me a while to get through them all.

> Regarding using columns of matrices - it is kind of incompatible with `element_constructor` since it expects lists or tuples, not vectors. Constructing a vector and then converting it to a list takes 3 times longer than just constructing this list directly from matrix elements.


I see.

> I have also dropped `copy=False, coerce=False` since they do not seem to be used in the code and (while I cannot use vectors...) I can feed strings directly into `element_constructor` without converting them to `int` first.


Yea, that's not too surprising. I didn't think they were being used considering the datatypes, but it was more just-in-case.

LGTM. Positive review.



---

archive/issue_events_058869.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-12-11T01:03:57Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/22524",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22524#event-58869"
}
```



---

archive/issue_comments_309504.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-12-11T01:03:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22524",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22524#issuecomment-309504",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
