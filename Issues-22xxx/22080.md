# Issue 22080: Refactoring of sage_setup.docbuild

archive/issues_021843.json:
```json
{
    "body": "I found it possibly desirable to split up the `sage_setup.docbuild.__init__` module a bit, as it was getting a bit long and difficult to reason about.  As to exactly what was moved where, this is highly subjective and open to debate.  But I do think that overall this makes the code easier to understand.\n\nI had a couple additional motivations for this:\n\nIt is with an eye toward #6389.  I think organizing the code more clearly will make it easier to implement this--in fact I don't think there's a lot left to do except to replace every reference to `SAGE_DOC_SRC` with a reference to a source directory option.  #21732 may play a role here as well.\n\nSpeaking of #21732, I have some ideas for how to use this to further reduce runtime dependency on sage_setup.\n\n**CC:**  @jhpalmieri\n\n**Keywords:** docbuild\n\n**Branch:** [u/jdemeyer/docbuild/refactor](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/docbuild/refactor)\n\n**Commit:** [652c41e26b268bbe7860184e3129b9836da734b6](https://github.com/sagemath/sagetrac-mirror/commit/652c41e26b268bbe7860184e3129b9836da734b6)\n\nIssue created by migration from https://trac.sagemath.org/ticket/22080\n\n",
    "closed_at": "2022-08-02T06:31:03Z",
    "created_at": "2016-12-20T14:33:48Z",
    "labels": [
        "component: documentation",
        "minor",
        "enhancement",
        "invalid"
    ],
    "title": "Refactoring of sage_setup.docbuild",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/22080",
    "user": "https://github.com/embray"
}
```
I found it possibly desirable to split up the `sage_setup.docbuild.__init__` module a bit, as it was getting a bit long and difficult to reason about.  As to exactly what was moved where, this is highly subjective and open to debate.  But I do think that overall this makes the code easier to understand.

I had a couple additional motivations for this:

It is with an eye toward #6389.  I think organizing the code more clearly will make it easier to implement this--in fact I don't think there's a lot left to do except to replace every reference to `SAGE_DOC_SRC` with a reference to a source directory option.  #21732 may play a role here as well.

Speaking of #21732, I have some ideas for how to use this to further reduce runtime dependency on sage_setup.

**CC:**  @jhpalmieri

**Keywords:** docbuild

**Branch:** [u/jdemeyer/docbuild/refactor](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/docbuild/refactor)

**Commit:** [652c41e26b268bbe7860184e3129b9836da734b6](https://github.com/sagemath/sagetrac-mirror/commit/652c41e26b268bbe7860184e3129b9836da734b6)

Issue created by migration from https://trac.sagemath.org/ticket/22080





---

archive/issue_events_197377.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-12-20T14:33:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22080#event-197377"
}
```



---

archive/issue_comments_328147.json:
```json
{
    "body": "<a id='comment:2'></a>\nThere are a few more changes I need to add after actually testing this for use with #21732",
    "created_at": "2016-12-20T14:49:00Z",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22080#issuecomment-328147",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>
There are a few more changes I need to add after actually testing this for use with #21732



---

archive/issue_events_197378.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-12-20T14:49:00Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22080#event-197378"
}
```



---

archive/issue_events_197379.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-12-20T14:49:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22080#event-197379"
}
```



---

archive/issue_comments_328148.json:
```json
{
    "body": "**Changing commit** from \"[00e221f31ffa0e0aabce74b43e0b7908bf7c804d](https://github.com/sagemath/sagetrac-mirror/commit/00e221f31ffa0e0aabce74b43e0b7908bf7c804d)\" to \"[0bf054ae9f14d727d3e4e961efbb8c4d223aa0e3](https://github.com/sagemath/sagetrac-mirror/commit/0bf054ae9f14d727d3e4e961efbb8c4d223aa0e3)\".",
    "created_at": "2016-12-21T15:15:32Z",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22080#issuecomment-328148",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[00e221f31ffa0e0aabce74b43e0b7908bf7c804d](https://github.com/sagemath/sagetrac-mirror/commit/00e221f31ffa0e0aabce74b43e0b7908bf7c804d)" to "[0bf054ae9f14d727d3e4e961efbb8c4d223aa0e3](https://github.com/sagemath/sagetrac-mirror/commit/0bf054ae9f14d727d3e4e961efbb8c4d223aa0e3)".



---

archive/issue_comments_328149.json:
```json
{
    "body": "<a id='comment:3'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0887bf09f9136193966b0c980f38db451419c234\">0887bf0</a></td><td><code>Slight fixes to some of the tests to reflect the last changes.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/51daae0f857e876f5ec39202fe28c29dc1420103\">51daae0</a></td><td><code>Allow default_lang to be passed to get_documents, through to AllBuilder.get_all_documents</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0bf054ae9f14d727d3e4e961efbb8c4d223aa0e3\">0bf054a</a></td><td><code>This module should still work if sage hasn't been built yet and can't import complicated submodules</code></td></tr></table>\n",
    "created_at": "2016-12-21T15:15:32Z",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22080#issuecomment-328149",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0887bf09f9136193966b0c980f38db451419c234">0887bf0</a></td><td><code>Slight fixes to some of the tests to reflect the last changes.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/51daae0f857e876f5ec39202fe28c29dc1420103">51daae0</a></td><td><code>Allow default_lang to be passed to get_documents, through to AllBuilder.get_all_documents</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0bf054ae9f14d727d3e4e961efbb8c4d223aa0e3">0bf054a</a></td><td><code>This module should still work if sage hasn't been built yet and can't import complicated submodules</code></td></tr></table>




---

archive/issue_events_197380.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-12-21T15:15:52Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22080#event-197380"
}
```



---

archive/issue_events_197381.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2016-12-21T15:15:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22080#event-197381"
}
```



---

archive/issue_comments_328150.json:
```json
{
    "body": "<a id='comment:5'></a>\nAccording to the patchbot, the documentation doesn't actually build with this patch.",
    "created_at": "2017-01-04T12:27:27Z",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22080#issuecomment-328150",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>
According to the patchbot, the documentation doesn't actually build with this patch.



---

archive/issue_events_197382.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-01-04T12:27:27Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22080#event-197382"
}
```



---

archive/issue_events_197383.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-01-04T12:27:27Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22080#event-197383"
}
```



---

archive/issue_comments_328151.json:
```json
{
    "body": "<a id='comment:6'></a>\nQuestion: is this patch supposed to make any functional changes or is it really just a reorganisation?",
    "created_at": "2017-01-04T12:30:37Z",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22080#issuecomment-328151",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>
Question: is this patch supposed to make any functional changes or is it really just a reorganisation?



---

archive/issue_comments_328152.json:
```json
{
    "body": "<a id='comment:7'></a>\nHmm, the error I see in the buildbot is:\n\n```\ncd ../.. && sage-logger -p './sage --docbuild --no-pdf-links all html ' logs/dochtml.log\n[dochtml] \n[dochtml] Building reference manual, first pass.\n[dochtml] \n[dochtml] Error building the documentation.\n[dochtml] Traceback (most recent call last):\n[dochtml]   File \"/home/vdelecro/sage_patchbot/local/lib/python/runpy.py\", line 174, in _run_module_as_main\n[dochtml]     \"__main__\", fname, loader, pkg_name)\n[dochtml]   File \"/home/vdelecro/sage_patchbot/local/lib/python/runpy.py\", line 72, in _run_code\n[dochtml]     exec code in run_globals\n[dochtml]   File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage_setup/docbuild/__main__.py\", line 2, in <module>\n[dochtml]     main()\n[dochtml]   File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage_setup/docbuild/main.py\", line 274, in main\n[dochtml]     builder()\n[dochtml]   File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage_setup/docbuild/builders/__init__.py\", line 115, in _wrapper\n[dochtml]     getattr(get_builder(document), 'inventory')(*args, **kwds)\n[dochtml]   File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage_setup/docbuild/builders/reference.py\", line 105, in _wrapper\n[dochtml]     build_many(self._build_ref_doc, L)\n[dochtml]   File \"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage_setup/docbuild/builders/__init__.py\", line 182, in build_many\n[dochtml]     ret = x.get(99999)\n[dochtml]   File \"/home/vdelecro/sage_patchbot/local/lib/python/multiprocessing/pool.py\", line 567, in get\n[dochtml]     raise self._value\n[dochtml] PicklingError: Can't pickle <type 'function'>: attribute lookup __builtin__.function failed\nMakefile:1121: recipe for target 'doc-html' failed\nmake[1]: *** [doc-html] Error 1\n```\n\nI don't remember ever getting anything like that in testing, but I'll have to try it again.  It's possible I made some other minor changes after testing and then forgot to re-test.  I don't remember.\n\nAnyways, to answer your question yes this is just a reorganization and does not (modulo bugs) make any changes in functionality.",
    "created_at": "2017-01-04T13:43:10Z",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22080#issuecomment-328152",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>
Hmm, the error I see in the buildbot is:

```
cd ../.. && sage-logger -p './sage --docbuild --no-pdf-links all html ' logs/dochtml.log
[dochtml] 
[dochtml] Building reference manual, first pass.
[dochtml] 
[dochtml] Error building the documentation.
[dochtml] Traceback (most recent call last):
[dochtml]   File "/home/vdelecro/sage_patchbot/local/lib/python/runpy.py", line 174, in _run_module_as_main
[dochtml]     "__main__", fname, loader, pkg_name)
[dochtml]   File "/home/vdelecro/sage_patchbot/local/lib/python/runpy.py", line 72, in _run_code
[dochtml]     exec code in run_globals
[dochtml]   File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage_setup/docbuild/__main__.py", line 2, in <module>
[dochtml]     main()
[dochtml]   File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage_setup/docbuild/main.py", line 274, in main
[dochtml]     builder()
[dochtml]   File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage_setup/docbuild/builders/__init__.py", line 115, in _wrapper
[dochtml]     getattr(get_builder(document), 'inventory')(*args, **kwds)
[dochtml]   File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage_setup/docbuild/builders/reference.py", line 105, in _wrapper
[dochtml]     build_many(self._build_ref_doc, L)
[dochtml]   File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage_setup/docbuild/builders/__init__.py", line 182, in build_many
[dochtml]     ret = x.get(99999)
[dochtml]   File "/home/vdelecro/sage_patchbot/local/lib/python/multiprocessing/pool.py", line 567, in get
[dochtml]     raise self._value
[dochtml] PicklingError: Can't pickle <type 'function'>: attribute lookup __builtin__.function failed
Makefile:1121: recipe for target 'doc-html' failed
make[1]: *** [doc-html] Error 1
```

I don't remember ever getting anything like that in testing, but I'll have to try it again.  It's possible I made some other minor changes after testing and then forgot to re-test.  I don't remember.

Anyways, to answer your question yes this is just a reorganization and does not (modulo bugs) make any changes in functionality.



---

archive/issue_comments_328153.json:
```json
{
    "body": "<a id='comment:8'></a>\nReplying to [embray](#comment%3A7):\n> `[dochtml] PicklingError: Can't pickle <type 'function'>: attribute lookup __builtin__.function failed`\n\n\nThis is almost certainly due to docbuilding in parallel. Remember that single-process and multi-process docbuilding now take a different code path.",
    "created_at": "2017-01-05T13:37:45Z",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22080#issuecomment-328153",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>
Replying to [embray](#comment%3A7):
> `[dochtml] PicklingError: Can't pickle <type 'function'>: attribute lookup __builtin__.function failed`


This is almost certainly due to docbuilding in parallel. Remember that single-process and multi-process docbuilding now take a different code path.



---

archive/issue_comments_328154.json:
```json
{
    "body": "<a id='comment:9'></a>\nRight, that could be why I did't get it.  Though I thought docbuilding was in parallel by default.  I was testing this on Linux too.  Oh well, no matter.  It's a simple fix.",
    "created_at": "2017-01-06T12:47:43Z",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22080#issuecomment-328154",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>
Right, that could be why I did't get it.  Though I thought docbuilding was in parallel by default.  I was testing this on Linux too.  Oh well, no matter.  It's a simple fix.



---

archive/issue_comments_328155.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [embray](#comment%3A9):\n> Though I thought docbuilding was in parallel by default.\n\n\nNo, it's serial by default. But the patchbots all build in parallel.",
    "created_at": "2017-01-06T13:23:43Z",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22080#issuecomment-328155",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>
Replying to [embray](#comment%3A9):
> Though I thought docbuilding was in parallel by default.


No, it's serial by default. But the patchbots all build in parallel.



---

archive/issue_comments_328156.json:
```json
{
    "body": "<a id='comment:11'></a>\nAh, okay. That explains it then.",
    "created_at": "2017-01-06T13:32:30Z",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22080#issuecomment-328156",
    "user": "https://github.com/embray"
}
```

<a id='comment:11'></a>
Ah, okay. That explains it then.



---

archive/issue_events_197384.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-05-19T09:53:27Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "milestone": "sage-7.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22080#event-197384"
}
```



---

archive/issue_comments_328157.json:
```json
{
    "body": "**Changing commit** from \"[0bf054ae9f14d727d3e4e961efbb8c4d223aa0e3](https://github.com/sagemath/sagetrac-mirror/commit/0bf054ae9f14d727d3e4e961efbb8c4d223aa0e3)\" to \"[dfeaa78686c0c1476b7a7eafce4333c5ec02cee2](https://github.com/sagemath/sagetrac-mirror/commit/dfeaa78686c0c1476b7a7eafce4333c5ec02cee2)\".",
    "created_at": "2017-05-19T10:35:09Z",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22080#issuecomment-328157",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[0bf054ae9f14d727d3e4e961efbb8c4d223aa0e3](https://github.com/sagemath/sagetrac-mirror/commit/0bf054ae9f14d727d3e4e961efbb8c4d223aa0e3)" to "[dfeaa78686c0c1476b7a7eafce4333c5ec02cee2](https://github.com/sagemath/sagetrac-mirror/commit/dfeaa78686c0c1476b7a7eafce4333c5ec02cee2)".



---

archive/issue_comments_328158.json:
```json
{
    "body": "<a id='comment:13'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/974e238b3e22a0edd6d40e3f8f2e56fa8636467e\">974e238</a></td><td><code>Initial refactoring of sage_setup.docbuild.__init__ into a number of</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/92fc2356361d6f31ae81083aa5eee67e89d2464c\">92fc235</a></td><td><code>Ensure that AllBuilder.get_all_documents() handles 'reference' correctly when default_lang is 'en'</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2ff16e82dbd653ca5ea7e0c2142f83d59752a32b\">2ff16e8</a></td><td><code>Three more changes I had in mind, that were tricky to disentangle:</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d9755910ba197185437254ccb1bab2b4beddfc08\">d975591</a></td><td><code>Use importlib.import_module instead of `__import__` in a couple places</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6e87372eb1d6090914510a8543b43096c864756b\">6e87372</a></td><td><code>Implement a minor TODO item: although maybe unnecessary here it's lways good practice to restore globals in sys after we mess with them.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/701526bdd38e0522f3ac69affde51e2f3d972997\">701526b</a></td><td><code>Slight fixes to some of the tests to reflect the last changes.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5dab10a5ffe78f3687ea69f47dfb436d56d4c719\">5dab10a</a></td><td><code>Allow default_lang to be passed to get_documents, through to AllBuilder.get_all_documents</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1b532cfba2aba4ceeb9229fbaa570b02cb90c6f8\">1b532cf</a></td><td><code>This module should still work if sage hasn't been built yet and can't import complicated submodules</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1a88454d22186c7908308e75003c055592282e6a\">1a88454</a></td><td><code>Static methods not (easily) pickleable for use with multiprocessing; should be module-level functions.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/dfeaa78686c0c1476b7a7eafce4333c5ec02cee2\">dfeaa78</a></td><td><code>Restore this import which is (unfortunately) necessary for imports from sage to not break.</code></td></tr></table>\n",
    "created_at": "2017-05-19T10:35:09Z",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22080#issuecomment-328158",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/974e238b3e22a0edd6d40e3f8f2e56fa8636467e">974e238</a></td><td><code>Initial refactoring of sage_setup.docbuild.__init__ into a number of</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/92fc2356361d6f31ae81083aa5eee67e89d2464c">92fc235</a></td><td><code>Ensure that AllBuilder.get_all_documents() handles 'reference' correctly when default_lang is 'en'</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2ff16e82dbd653ca5ea7e0c2142f83d59752a32b">2ff16e8</a></td><td><code>Three more changes I had in mind, that were tricky to disentangle:</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d9755910ba197185437254ccb1bab2b4beddfc08">d975591</a></td><td><code>Use importlib.import_module instead of `__import__` in a couple places</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6e87372eb1d6090914510a8543b43096c864756b">6e87372</a></td><td><code>Implement a minor TODO item: although maybe unnecessary here it's lways good practice to restore globals in sys after we mess with them.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/701526bdd38e0522f3ac69affde51e2f3d972997">701526b</a></td><td><code>Slight fixes to some of the tests to reflect the last changes.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5dab10a5ffe78f3687ea69f47dfb436d56d4c719">5dab10a</a></td><td><code>Allow default_lang to be passed to get_documents, through to AllBuilder.get_all_documents</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1b532cfba2aba4ceeb9229fbaa570b02cb90c6f8">1b532cf</a></td><td><code>This module should still work if sage hasn't been built yet and can't import complicated submodules</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1a88454d22186c7908308e75003c055592282e6a">1a88454</a></td><td><code>Static methods not (easily) pickleable for use with multiprocessing; should be module-level functions.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/dfeaa78686c0c1476b7a7eafce4333c5ec02cee2">dfeaa78</a></td><td><code>Restore this import which is (unfortunately) necessary for imports from sage to not break.</code></td></tr></table>




---

archive/issue_comments_328159.json:
```json
{
    "body": "<a id='comment:14'></a>\nRebased (incorporating updates to `sage_setup.docbuild` since the last version of this), and fixed the remaining issues as far as I can tell.",
    "created_at": "2017-05-19T10:35:50Z",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22080#issuecomment-328159",
    "user": "https://github.com/embray"
}
```

<a id='comment:14'></a>
Rebased (incorporating updates to `sage_setup.docbuild` since the last version of this), and fixed the remaining issues as far as I can tell.



---

archive/issue_events_197385.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-05-19T10:35:56Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22080#event-197385"
}
```



---

archive/issue_events_197386.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-05-19T10:35:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22080#event-197386"
}
```



---

archive/issue_comments_328160.json:
```json
{
    "body": "<a id='comment:16'></a>\n1. Why this?\n\n```\ntry:\n    from sage.interfaces.gap import set_gap_memory_pool_size\n    set_gap_memory_pool_size(80 * 1024 * 1024)\nexcept ImportError:\n    pass\n```\nIf you really want this to work without Sage, I would prefer to see\n\n```\ntry:\n    import sage\nexcept ImportError:\n    pass\nelse:\n    from sage.interfaces.gap import set_gap_memory_pool_size\n    set_gap_memory_pool_size(80 * 1024 * 1024)\n```\n\n2. All functions in `src/sage_setup/docbuild/__init__.py` lack doctests. I know that the original functions didn't have doctests either, but since you changed the implementation, I think it's valid to ask for doctests. For `get_builder()`, it would be very good to have examples for various cases: just from reading the docstring, it's not totally clear what it does.\n\n3. In `get_builder`, can you use the `traceback` module to format the exceptions?",
    "created_at": "2017-05-22T09:23:36Z",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22080#issuecomment-328160",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'></a>
1. Why this?

```
try:
    from sage.interfaces.gap import set_gap_memory_pool_size
    set_gap_memory_pool_size(80 * 1024 * 1024)
except ImportError:
    pass
```
If you really want this to work without Sage, I would prefer to see

```
try:
    import sage
except ImportError:
    pass
else:
    from sage.interfaces.gap import set_gap_memory_pool_size
    set_gap_memory_pool_size(80 * 1024 * 1024)
```

2. All functions in `src/sage_setup/docbuild/__init__.py` lack doctests. I know that the original functions didn't have doctests either, but since you changed the implementation, I think it's valid to ask for doctests. For `get_builder()`, it would be very good to have examples for various cases: just from reading the docstring, it's not totally clear what it does.

3. In `get_builder`, can you use the `traceback` module to format the exceptions?



---

archive/issue_comments_328161.json:
```json
{
    "body": "<a id='comment:17'></a>\nFor 1), it's possible `import sage` works, but it's not fully built or fully working.  The point is that this code has to be there when using Sage *for some reason* that I don't know, but this module should work fine without Sage as well.",
    "created_at": "2017-05-22T09:34:15Z",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22080#issuecomment-328161",
    "user": "https://github.com/embray"
}
```

<a id='comment:17'></a>
For 1), it's possible `import sage` works, but it's not fully built or fully working.  The point is that this code has to be there when using Sage *for some reason* that I don't know, but this module should work fine without Sage as well.



---

archive/issue_comments_328162.json:
```json
{
    "body": "**Changing branch** from \"[u/embray/docbuild/refactor](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/docbuild/refactor)\" to \"[u/jdemeyer/docbuild/refactor](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/docbuild/refactor)\".",
    "created_at": "2017-05-22T10:03:42Z",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22080#issuecomment-328162",
    "user": "https://github.com/jdemeyer"
}
```

**Changing branch** from "[u/embray/docbuild/refactor](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/docbuild/refactor)" to "[u/jdemeyer/docbuild/refactor](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/docbuild/refactor)".



---

archive/issue_comments_328163.json:
```json
{
    "body": "**Changing commit** from \"[dfeaa78686c0c1476b7a7eafce4333c5ec02cee2](https://github.com/sagemath/sagetrac-mirror/commit/dfeaa78686c0c1476b7a7eafce4333c5ec02cee2)\" to \"[652c41e26b268bbe7860184e3129b9836da734b6](https://github.com/sagemath/sagetrac-mirror/commit/652c41e26b268bbe7860184e3129b9836da734b6)\".",
    "created_at": "2017-05-22T10:05:58Z",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22080#issuecomment-328163",
    "user": "https://github.com/jdemeyer"
}
```

**Changing commit** from "[dfeaa78686c0c1476b7a7eafce4333c5ec02cee2](https://github.com/sagemath/sagetrac-mirror/commit/dfeaa78686c0c1476b7a7eafce4333c5ec02cee2)" to "[652c41e26b268bbe7860184e3129b9836da734b6](https://github.com/sagemath/sagetrac-mirror/commit/652c41e26b268bbe7860184e3129b9836da734b6)".



---

archive/issue_comments_328164.json:
```json
{
    "body": "<a id='comment:19'></a>\nFor easier reviewing, I squashed this branch and made it into 2 commits: one which literally just moves code around and one which makes further changes.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d95a52bf4ade210ff9aa5d3739887dce9e286250\">d95a52b</a></td><td><code>Split up docbuilding code</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/652c41e26b268bbe7860184e3129b9836da734b6\">652c41e</a></td><td><code>Refactor sage_setup.docbuild</code></td></tr></table>\n",
    "created_at": "2017-05-22T10:05:58Z",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22080#issuecomment-328164",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'></a>
For easier reviewing, I squashed this branch and made it into 2 commits: one which literally just moves code around and one which makes further changes.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d95a52bf4ade210ff9aa5d3739887dce9e286250">d95a52b</a></td><td><code>Split up docbuilding code</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/652c41e26b268bbe7860184e3129b9836da734b6">652c41e</a></td><td><code>Refactor sage_setup.docbuild</code></td></tr></table>




---

archive/issue_comments_328165.json:
```json
{
    "body": "<a id='comment:20'></a>\nReplying to [embray](#comment%3A17):\n> For 1), it's possible `import sage` works, but it's not fully built or fully working.\n\n\nIf that's the case, that's a bug and we want to know about it. Hiding a bug inside an `except` statement is not good style.\n\nDo you plan to use the docbuilder outside of Sage? If not, there is no reason for the `try`/`except`.",
    "created_at": "2017-05-22T10:13:39Z",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22080#issuecomment-328165",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>
Replying to [embray](#comment%3A17):
> For 1), it's possible `import sage` works, but it's not fully built or fully working.


If that's the case, that's a bug and we want to know about it. Hiding a bug inside an `except` statement is not good style.

Do you plan to use the docbuilder outside of Sage? If not, there is no reason for the `try`/`except`.



---

archive/issue_comments_328166.json:
```json
{
    "body": "<a id='comment:21'></a>\n`pyflakes` complains about a few things:\n\n```\ndocbuild/main.py:267: local variable 'C' is assigned to but never used\ndocbuild/builders/docbuilder.py:111: undefined name 'logger'\ndocbuild/builders/reference.py:625: undefined name 'SAGE_SRC'\ndocbuild/builders/singlefile.py:5: 're' imported but unused\n```\nThe undefined names are surely bugs.",
    "created_at": "2017-05-22T10:18:04Z",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22080#issuecomment-328166",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>
`pyflakes` complains about a few things:

```
docbuild/main.py:267: local variable 'C' is assigned to but never used
docbuild/builders/docbuilder.py:111: undefined name 'logger'
docbuild/builders/reference.py:625: undefined name 'SAGE_SRC'
docbuild/builders/singlefile.py:5: 're' imported but unused
```
The undefined names are surely bugs.



---

archive/issue_comments_328167.json:
```json
{
    "body": "<a id='comment:22'></a>\nLet me say that I honestly want to move forward with this ticket. It would a pity to have this ticket stalled again. So even if I disagree with a minor thing, I might accept it anyway.",
    "created_at": "2017-05-22T10:35:27Z",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22080#issuecomment-328167",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>
Let me say that I honestly want to move forward with this ticket. It would a pity to have this ticket stalled again. So even if I disagree with a minor thing, I might accept it anyway.



---

archive/issue_comments_328168.json:
```json
{
    "body": "<a id='comment:23'></a>\nReplying to [jdemeyer](#comment%3A20):\n> Replying to [embray](#comment%3A17):\n> > For 1), it's possible `import sage` works, but it's not fully built or fully working.\n\n> \n> If that's the case, that's a bug and we want to know about it. Hiding a bug inside an `except` statement is not good style.\n\n\nThat depends.  It's not necessarily hiding a \"bug\" in this case.  That said, I don't remember the exact reason it was needed so changing this *might* be fine.  I just don't see why it matters.\n\n> Do you plan to use the docbuilder outside of Sage? If not, there is no reason for the `try`/`except`.\n\n\nYes, that's part of the point of this refactoring, as well as #21732.  I don't *personally* plan to use it, but it should be made more independent of Sage.",
    "created_at": "2017-05-22T12:07:44Z",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22080#issuecomment-328168",
    "user": "https://github.com/embray"
}
```

<a id='comment:23'></a>
Replying to [jdemeyer](#comment%3A20):
> Replying to [embray](#comment%3A17):
> > For 1), it's possible `import sage` works, but it's not fully built or fully working.

> 
> If that's the case, that's a bug and we want to know about it. Hiding a bug inside an `except` statement is not good style.


That depends.  It's not necessarily hiding a "bug" in this case.  That said, I don't remember the exact reason it was needed so changing this *might* be fine.  I just don't see why it matters.

> Do you plan to use the docbuilder outside of Sage? If not, there is no reason for the `try`/`except`.


Yes, that's part of the point of this refactoring, as well as #21732.  I don't *personally* plan to use it, but it should be made more independent of Sage.



---

archive/issue_comments_328169.json:
```json
{
    "body": "<a id='comment:24'></a>\nReplying to [jdemeyer](#comment%3A22):\n> Let me say that I honestly want to move forward with this ticket. It would a pity to have this ticket stalled again. So even if I disagree with a minor thing, I might accept it anyway.\n\n\nThat's fine, and I agree with your other comments.  I'm not sure what you want me to do now that you've switched it to your branch though.",
    "created_at": "2017-05-22T12:09:03Z",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22080#issuecomment-328169",
    "user": "https://github.com/embray"
}
```

<a id='comment:24'></a>
Replying to [jdemeyer](#comment%3A22):
> Let me say that I honestly want to move forward with this ticket. It would a pity to have this ticket stalled again. So even if I disagree with a minor thing, I might accept it anyway.


That's fine, and I agree with your other comments.  I'm not sure what you want me to do now that you've switched it to your branch though.



---

archive/issue_comments_328170.json:
```json
{
    "body": "<a id='comment:25'></a>\nReplying to [embray](#comment%3A24):\n> That's fine, and I agree with your other comments.  I'm not sure what you want me to do now that you've switched it to your branch though.\n\n\nPreferably, you continue your work on top of my branch.",
    "created_at": "2017-05-23T07:57:55Z",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22080#issuecomment-328170",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:25'></a>
Replying to [embray](#comment%3A24):
> That's fine, and I agree with your other comments.  I'm not sure what you want me to do now that you've switched it to your branch though.


Preferably, you continue your work on top of my branch.



---

archive/issue_events_197387.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-05-27T10:39:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "milestone": "sage-8.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22080#event-197387"
}
```



---

archive/issue_events_197388.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-05-27T10:39:58Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22080#event-197388"
}
```



---

archive/issue_events_197389.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-05-27T10:39:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22080#event-197389"
}
```



---

archive/issue_events_197390.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-07-09T19:56:38Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "milestone": "sage-8.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22080#event-197390"
}
```



---

archive/issue_comments_328171.json:
```json
{
    "body": "**Changing author** from \"Erik Bray\" to \"\".",
    "created_at": "2022-07-09T19:56:38Z",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22080#issuecomment-328171",
    "user": "https://github.com/mkoeppe"
}
```

**Changing author** from "Erik Bray" to "".



---

archive/issue_comments_328172.json:
```json
{
    "body": "<a id='comment:27'></a>\noutdated, should close",
    "created_at": "2022-07-09T19:56:38Z",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22080#issuecomment-328172",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:27'></a>
outdated, should close



---

archive/issue_events_197391.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-07-09T19:56:38Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22080#event-197391"
}
```



---

archive/issue_events_197392.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-07-09T19:56:38Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22080#event-197392"
}
```



---

archive/issue_comments_328173.json:
```json
{
    "body": "<a id='comment:28'></a>\nSure.",
    "created_at": "2022-07-09T22:59:52Z",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22080#issuecomment-328173",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:28'></a>
Sure.



---

archive/issue_events_197393.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2022-07-09T22:59:52Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22080#event-197393"
}
```



---

archive/issue_events_197394.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2022-07-09T22:59:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22080#event-197394"
}
```



---

archive/issue_events_197395.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-02T06:31:03Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22080#event-197395"
}
```



---

archive/issue_events_197396.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-02T06:31:03Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/22080",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22080#event-197396"
}
```
