# Issue 22941: Fix error in Sage's rich output display formatter

archive/issues_022704.json:
```json
{
    "body": "Follow up to an issue raised on [sage-devel](https://groups.google.com/d/msg/sage-devel/uyerGH7gEEc/XtXZ1BS6CQAJ): running `vars()` or `locals()` leads to an error. Here is a fix.\n\n\nCC:  @dimpase @vbraun\n\nBranch/Commit: 16de140f16af5e9e764b25d1b8c47da38784809b\n\nReviewer: Dima Pasechnik, Volker Braun\n\nAuthor: John Palmieri\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/22941\n\n",
    "closed_at": "2017-05-15T22:51:17Z",
    "created_at": "2017-05-03T19:39:30Z",
    "labels": [
        "component: refactoring",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "Fix error in Sage's rich output display formatter",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22941",
    "user": "https://github.com/jhpalmieri"
}
```
Follow up to an issue raised on [sage-devel](https://groups.google.com/d/msg/sage-devel/uyerGH7gEEc/XtXZ1BS6CQAJ): running `vars()` or `locals()` leads to an error. Here is a fix.


CC:  @dimpase @vbraun

Branch/Commit: 16de140f16af5e9e764b25d1b8c47da38784809b

Reviewer: Dima Pasechnik, Volker Braun

Author: John Palmieri

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/22941





---

archive/issue_comments_423443.json:
```json
{
    "body": "Changing branch from \"\" to \"u/jhpalmieri/formatter\"",
    "created_at": "2017-05-03T19:40:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423443",
    "user": "https://github.com/jhpalmieri"
}
```

Changing branch from "" to "u/jhpalmieri/formatter"



---

archive/issue_comments_423444.json:
```json
{
    "body": "Changing commit from \"\" to \"f6e0975e9a9564326bfbd1b5faa90cbdbe9a0eac\"",
    "created_at": "2017-05-03T19:41:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423444",
    "user": "https://github.com/jhpalmieri"
}
```

Changing commit from "" to "f6e0975e9a9564326bfbd1b5faa90cbdbe9a0eac"



---

archive/issue_comments_423445.json:
```json
{
    "body": "<a id='comment:2'></a>\nNew commits:\n|                                                                                                                                          |                                                                |\n|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------|\n|[f6e0975](https://github.com/sagemath/sagetrac-mirror/commit/f6e0975e9a9564326bfbd1b5faa90cbdbe9a0eac)|`trac 22941: in the format method in repl/display/formatter.py:`|",
    "created_at": "2017-05-03T19:41:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423445",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:2'></a>
New commits:
|                                                                                                                                          |                                                                |
|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------|
|[f6e0975](https://github.com/sagemath/sagetrac-mirror/commit/f6e0975e9a9564326bfbd1b5faa90cbdbe9a0eac)|`trac 22941: in the format method in repl/display/formatter.py:`|



---

archive/issue_comments_423446.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-05-03T19:41:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423446",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_423447.json:
```json
{
    "body": "<a id='comment:3'></a>\ndoes it depend on #22933 ?",
    "created_at": "2017-05-03T20:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423447",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:3'></a>
does it depend on #22933 ?



---

archive/issue_comments_423448.json:
```json
{
    "body": "<a id='comment:4'></a>\none way or another, `vars()` works now.",
    "created_at": "2017-05-03T21:00:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423448",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:4'></a>
one way or another, `vars()` works now.



---

archive/issue_comments_423449.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-05-03T21:00:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423449",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_423450.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Dima Pasechnik\"",
    "created_at": "2017-05-03T21:00:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423450",
    "user": "https://github.com/dimpase"
}
```

Changing reviewer from "" to "Dima Pasechnik"



---

archive/issue_comments_423451.json:
```json
{
    "body": "<a id='comment:5'></a>\nIt doesn't depend on #22933, by the way. Volker, I think you were responsible for this file originally, so please let us know if you have any objections.",
    "created_at": "2017-05-03T22:06:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423451",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:5'></a>
It doesn't depend on #22933, by the way. Volker, I think you were responsible for this file originally, so please let us know if you have any objections.



---

archive/issue_comments_423452.json:
```json
{
    "body": "<a id='comment:6'></a>\nPerhaps the question is whether `displayhook` can be `None`, or this is a bug.",
    "created_at": "2017-05-03T22:10:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423452",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:6'></a>
Perhaps the question is whether `displayhook` can be `None`, or this is a bug.



---

archive/issue_comments_423453.json:
```json
{
    "body": "<a id='comment:7'></a>\nThe `displayhook` method starts with\n\n```\n        if obj is None:\n            return\n```\nSo then the question is whether it is a bug if `obj is None`. (Well, `obj` can be `None`, certainly, but should that occur when you call `vars()` or `locals()`?)",
    "created_at": "2017-05-04T02:09:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423453",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:7'></a>
The `displayhook` method starts with

```
        if obj is None:
            return
```
So then the question is whether it is a bug if `obj is None`. (Well, `obj` can be `None`, certainly, but should that occur when you call `vars()` or `locals()`?)



---

archive/issue_comments_423454.json:
```json
{
    "body": "<a id='comment:8'></a>\nI don't think the patch fixes the underlying issue. What really goes wrong is that `__repr__` of vars() somewhere activates SageNB support:\n\n```\nsage: get_display_manager()\nThe Sage display manager using the IPython command line backend\nsage: vars()\n[...]\nsage: get_display_manager()\nThe Sage display manager using the SageNB backend\n[errors]\n```\nAnd having the SageNB backend with the IPython terminal frontend just isn't going to work well....",
    "created_at": "2017-05-04T19:46:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423454",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:8'></a>
I don't think the patch fixes the underlying issue. What really goes wrong is that `__repr__` of vars() somewhere activates SageNB support:

```
sage: get_display_manager()
The Sage display manager using the IPython command line backend
sage: vars()
[...]
sage: get_display_manager()
The Sage display manager using the SageNB backend
[errors]
```
And having the SageNB backend with the IPython terminal frontend just isn't going to work well....



---

archive/issue_comments_423455.json:
```json
{
    "body": "<a id='comment:9'></a>\nWe need to fix `repr(vars()['notebook'])` (surprise, surprise...) by some kind of \"guarding\" it, or perhaps by removing it from global namespace...\n\n\nIndeed, try running the following:\n\n```\nsage: v=vars()\nsage: f=open('/dev/null','w')\nsage: for k in v.keys():\n....:     if k!='v':   # to avoid recursion\n....:         f.write(repr(v[k]))\n....:         if 'NB' in str(get_display_manager()):\n....:            print(\"Achtung!!! \"+str(k))\n....:            break\n```\nYou will get some deprecation warnings and then\n\n```\n...\nAchtung!!! notebook\n```\nSo swithcing to SageNB backend is triggered by `repr(vars()['notebook'])`.\n\nIndeed\n\n```\nsage: get_display_manager()\nThe Sage display manager using the IPython command line backend\nsage: vars()['notebook']\n<sagenb.notebook.notebook_object.NotebookObject instance at 0x7fe63d83ae18>\n<sagenb.notebook.notebook_object.NotebookObject instance at 0x7fe63d83ae18>\nsage: get_display_manager()\nThe Sage display manager using the SageNB backend\nThe Sage display manager using the SageNB backend\n```\n\n(doubling of lines is caused by unsuitability of SageNB backend for the terminal.)",
    "created_at": "2017-05-04T20:49:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423455",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:9'></a>
We need to fix `repr(vars()['notebook'])` (surprise, surprise...) by some kind of "guarding" it, or perhaps by removing it from global namespace...


Indeed, try running the following:

```
sage: v=vars()
sage: f=open('/dev/null','w')
sage: for k in v.keys():
....:     if k!='v':   # to avoid recursion
....:         f.write(repr(v[k]))
....:         if 'NB' in str(get_display_manager()):
....:            print("Achtung!!! "+str(k))
....:            break
```
You will get some deprecation warnings and then

```
...
Achtung!!! notebook
```
So swithcing to SageNB backend is triggered by `repr(vars()['notebook'])`.

Indeed

```
sage: get_display_manager()
The Sage display manager using the IPython command line backend
sage: vars()['notebook']
<sagenb.notebook.notebook_object.NotebookObject instance at 0x7fe63d83ae18>
<sagenb.notebook.notebook_object.NotebookObject instance at 0x7fe63d83ae18>
sage: get_display_manager()
The Sage display manager using the SageNB backend
The Sage display manager using the SageNB backend
```

(doubling of lines is caused by unsuitability of SageNB backend for the terminal.)



---

archive/issue_comments_423456.json:
```json
{
    "body": "<a id='comment:10'></a>\nJust resolving the notebook lazy import, e.g. by `notebook?`, is also sufficient. The easiest solution is probably to duplicate the sagenb notebook functions and docstrings in a proxy module that doesn't drag in the remaining SagenB machinery.",
    "created_at": "2017-05-04T22:12:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423456",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:10'></a>
Just resolving the notebook lazy import, e.g. by `notebook?`, is also sufficient. The easiest solution is probably to duplicate the sagenb notebook functions and docstrings in a proxy module that doesn't drag in the remaining SagenB machinery.



---

archive/issue_comments_423457.json:
```json
{
    "body": "<a id='comment:11'></a>\nThis patch to SageNB fixes the problem for me. The point is to not import sagenb.misc.support at the top-level, since that file changes the displayhook.\n\n```diff\ndiff --git a/sagenb/notebook/worksheet.py b/sagenb/notebook/worksheet.py\nindex f5b7c26..e41b28a 100644\n--- a/sagenb/notebook/worksheet.py\n+++ b/sagenb/notebook/worksheet.py\n@@ -52,7 +52,6 @@ from sagenb.interfaces import (WorksheetProcess_ExpectImplementation,\n                                WorksheetProcess_ReferenceImplementation,\n                                WorksheetProcess_RemoteExpectImplementation)\n \n-import sagenb.misc.support  as support\n from sagenb.misc.format import relocate_future_imports\n \n # Imports specifically relevant to the sage notebook\n@@ -3812,7 +3811,8 @@ except (KeyError, IOError):\n         return out\n \n     def _get_last_identifier(self, s):\n-        return support.get_rightmost_identifier(s)\n+        import sagenb.misc.support\n+        return sagenb.misc.support.get_rightmost_identifier(s)\n \n     def preparse(self, s):\n         \"\"\"\n```",
    "created_at": "2017-05-04T22:31:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423457",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:11'></a>
This patch to SageNB fixes the problem for me. The point is to not import sagenb.misc.support at the top-level, since that file changes the displayhook.

```diff
diff --git a/sagenb/notebook/worksheet.py b/sagenb/notebook/worksheet.py
index f5b7c26..e41b28a 100644
--- a/sagenb/notebook/worksheet.py
+++ b/sagenb/notebook/worksheet.py
@@ -52,7 +52,6 @@ from sagenb.interfaces import (WorksheetProcess_ExpectImplementation,
                                WorksheetProcess_ReferenceImplementation,
                                WorksheetProcess_RemoteExpectImplementation)
 
-import sagenb.misc.support  as support
 from sagenb.misc.format import relocate_future_imports
 
 # Imports specifically relevant to the sage notebook
@@ -3812,7 +3811,8 @@ except (KeyError, IOError):
         return out
 
     def _get_last_identifier(self, s):
-        return support.get_rightmost_identifier(s)
+        import sagenb.misc.support
+        return sagenb.misc.support.get_rightmost_identifier(s)
 
     def preparse(self, s):
         """
```



---

archive/issue_comments_423458.json:
```json
{
    "body": "<a id='comment:12'></a>\nActually, both Volker's and my suggestion fix `vars()['notebook']`, but they don't fix the problem in general:\n\n```\nsage: notebook?\n...\nsage: get_display_manager()\nThe Sage display manager using the IPython command line backend\nsage: vars()['notebook']\n<sagenb.notebook.notebook_object.NotebookObject instance at 0x1bc7f57e8>\nsage: get_display_manager()\nThe Sage display manager using the IPython command line backend\nsage: vars()\n...\nsage: get_display_manager()\nThe Sage display manager using the SageNB backend\nThe Sage display manager using the SageNB backend\n```",
    "created_at": "2017-05-04T22:39:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423458",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:12'></a>
Actually, both Volker's and my suggestion fix `vars()['notebook']`, but they don't fix the problem in general:

```
sage: notebook?
...
sage: get_display_manager()
The Sage display manager using the IPython command line backend
sage: vars()['notebook']
<sagenb.notebook.notebook_object.NotebookObject instance at 0x1bc7f57e8>
sage: get_display_manager()
The Sage display manager using the IPython command line backend
sage: vars()
...
sage: get_display_manager()
The Sage display manager using the SageNB backend
The Sage display manager using the SageNB backend
```



---

archive/issue_comments_423459.json:
```json
{
    "body": "<a id='comment:13'></a>\nAfter making my change to SageNB, running Dima's code from[comment:9](#comment%3A9) gives\n\n```\nAchtung!!! v\n```\n(which strikes me as odd since we already have `if k != v:` there).",
    "created_at": "2017-05-04T22:45:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423459",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:13'></a>
After making my change to SageNB, running Dima's code from[comment:9](#comment%3A9) gives

```
Achtung!!! v
```
(which strikes me as odd since we already have `if k != v:` there).



---

archive/issue_comments_423460.json:
```json
{
    "body": "<a id='comment:14'></a>\nit seems to be more self-referential than I thought...",
    "created_at": "2017-05-05T13:02:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423460",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:14'></a>
it seems to be more self-referential than I thought...



---

archive/issue_comments_423461.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-05-05T20:36:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423461",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_423462.json:
```json
{
    "body": "<a id='comment:15'></a>\n`notebook` isn't the only thing tho, there is also `inotebook` and others ...",
    "created_at": "2017-05-05T20:36:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423462",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:15'></a>
`notebook` isn't the only thing tho, there is also `inotebook` and others ...



---

archive/issue_comments_423463.json:
```json
{
    "body": "<a id='comment:16'></a>\nYes, but I don't understand why my proposed change to SageNB doesn't seem to fix all of them.",
    "created_at": "2017-05-05T20:38:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423463",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:16'></a>
Yes, but I don't understand why my proposed change to SageNB doesn't seem to fix all of them.



---

archive/issue_comments_423464.json:
```json
{
    "body": "<a id='comment:17'></a>\nanyhow I will add the sagenb patch to sagenb repo now.",
    "created_at": "2017-05-10T11:29:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423464",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:17'></a>
anyhow I will add the sagenb patch to sagenb repo now.



---

archive/issue_comments_423465.json:
```json
{
    "body": "<a id='comment:18'></a>\ncould it be that also `import sagenb.misc.support as _support_` in the string in\n`initialize_sage()` in the same file is a problem?",
    "created_at": "2017-05-10T11:40:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423465",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:18'></a>
could it be that also `import sagenb.misc.support as _support_` in the string in
`initialize_sage()` in the same file is a problem?



---

archive/issue_comments_423466.json:
```json
{
    "body": "Changing commit from \"f6e0975e9a9564326bfbd1b5faa90cbdbe9a0eac\" to \"a7f6613942c2bcfc9c7a6590f7f44d15a5706afb\"",
    "created_at": "2017-05-10T20:52:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423466",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "f6e0975e9a9564326bfbd1b5faa90cbdbe9a0eac" to "a7f6613942c2bcfc9c7a6590f7f44d15a5706afb"



---

archive/issue_comments_423467.json:
```json
{
    "body": "<a id='comment:19'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                           |                                                                                |\n|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------|\n|[a7f6613](https://github.com/sagemath/sagetrac-mirror/commit/a7f6613942c2bcfc9c7a6590f7f44d15a5706afb)|`trac 22941: Do not import sagenb.misc.support! It changes the display manager.`|",
    "created_at": "2017-05-10T20:52:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423467",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                           |                                                                                |
|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------|
|[a7f6613](https://github.com/sagemath/sagetrac-mirror/commit/a7f6613942c2bcfc9c7a6590f7f44d15a5706afb)|`trac 22941: Do not import sagenb.misc.support! It changes the display manager.`|



---

archive/issue_comments_423468.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-05-10T20:56:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423468",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_423469.json:
```json
{
    "body": "<a id='comment:20'></a>\nI think I've found the problem. This branch gets rid of the only place in the Sage library that imports sagenb.misc.support. Together with the SageNB patch, this allows `vars()` to work for me without changing the display manager. When I was testing it, I also put in a print statement in sagenb.misc.support:\n\n```diff\n--- misc/support.py~\t2017-05-10 13:51:18.000000000 -0700\n+++ misc/support.py\t2017-05-10 13:55:00.000000000 -0700\n@@ -41,6 +41,7 @@\n         return False\n \n try:\n+    print ('Warning: changing the display hook!!!')\n     from sage.misc.displayhook import DisplayHook\n     sys.displayhook = DisplayHook()\n except ImportError as msg:\n```\nand with this branch and the modification to SageNB, the warning is not printed when I evaluate `vars()`.",
    "created_at": "2017-05-10T20:56:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423469",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:20'></a>
I think I've found the problem. This branch gets rid of the only place in the Sage library that imports sagenb.misc.support. Together with the SageNB patch, this allows `vars()` to work for me without changing the display manager. When I was testing it, I also put in a print statement in sagenb.misc.support:

```diff
--- misc/support.py~	2017-05-10 13:51:18.000000000 -0700
+++ misc/support.py	2017-05-10 13:55:00.000000000 -0700
@@ -41,6 +41,7 @@
         return False
 
 try:
+    print ('Warning: changing the display hook!!!')
     from sage.misc.displayhook import DisplayHook
     sys.displayhook = DisplayHook()
 except ImportError as msg:
```
and with this branch and the modification to SageNB, the warning is not printed when I evaluate `vars()`.



---

archive/issue_comments_423470.json:
```json
{
    "body": "<a id='comment:21'></a>\nReplying to [dimpase](#comment%3A18):\n> could it be that also `import sagenb.misc.support as _support_` in the string in\n> `initialize_sage()` in the same file is a problem?\n\n\nBy the way, I tested this, and it does not cause the problem. (I deleted that line and the problem remained.)",
    "created_at": "2017-05-10T21:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423470",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:21'></a>
Replying to [dimpase](#comment%3A18):
> could it be that also `import sagenb.misc.support as _support_` in the string in
> `initialize_sage()` in the same file is a problem?


By the way, I tested this, and it does not cause the problem. (I deleted that line and the problem remained.)



---

archive/issue_comments_423471.json:
```json
{
    "body": "<a id='comment:22'></a>\nWe could also add a doctest if you want, but I'm not sure where to put it. sage/graphs/all.py? sage/graphs/graph_editor.py? I don't really want it to appear in the reference manual, so maybe the former.\n\n```\n\n\"\"\"\nTESTS:\n\nTest that sagenb.misc.support is not imported (see :trac:`22941`)::\n\n    sage: import sage.graphs.graph_editor\n    sage: 'sagenb.misc.support' in sys.modules\n    False\n\"\"\"\n```",
    "created_at": "2017-05-10T21:13:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423471",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:22'></a>
We could also add a doctest if you want, but I'm not sure where to put it. sage/graphs/all.py? sage/graphs/graph_editor.py? I don't really want it to appear in the reference manual, so maybe the former.

```

"""
TESTS:

Test that sagenb.misc.support is not imported (see :trac:`22941`)::

    sage: import sage.graphs.graph_editor
    sage: 'sagenb.misc.support' in sys.modules
    False
"""
```



---

archive/issue_comments_423472.json:
```json
{
    "body": "<a id='comment:23'></a>\nGood catch. Regarding the doctest, yes, we can have it where you suggest.\n\nPerhaps Sage also needs a module called `customs` to control the imports properly :-)",
    "created_at": "2017-05-10T22:46:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423472",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:23'></a>
Good catch. Regarding the doctest, yes, we can have it where you suggest.

Perhaps Sage also needs a module called `customs` to control the imports properly :-)



---

archive/issue_comments_423473.json:
```json
{
    "body": "Changing commit from \"a7f6613942c2bcfc9c7a6590f7f44d15a5706afb\" to \"16de140f16af5e9e764b25d1b8c47da38784809b\"",
    "created_at": "2017-05-10T22:55:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423473",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "a7f6613942c2bcfc9c7a6590f7f44d15a5706afb" to "16de140f16af5e9e764b25d1b8c47da38784809b"



---

archive/issue_comments_423474.json:
```json
{
    "body": "<a id='comment:24'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                            |\n|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------|\n|[16de140](https://github.com/sagemath/sagetrac-mirror/commit/16de140f16af5e9e764b25d1b8c47da38784809b)|`trac 22941: add a doctest.`|",
    "created_at": "2017-05-10T22:55:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423474",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:24'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                            |
|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------|
|[16de140](https://github.com/sagemath/sagetrac-mirror/commit/16de140f16af5e9e764b25d1b8c47da38784809b)|`trac 22941: add a doctest.`|



---

archive/issue_comments_423475.json:
```json
{
    "body": "<a id='comment:25'></a>\nReplying to [dimpase](#comment%3A23):\n> Good catch. Regarding the doctest, yes, we can have it where you suggest.\n> \n> Perhaps Sage also needs a module called `customs` to control the imports properly :-)\n\n\nHeh. See #21636 for a start. Make Sage Great Again.",
    "created_at": "2017-05-10T22:56:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423475",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:25'></a>
Replying to [dimpase](#comment%3A23):
> Good catch. Regarding the doctest, yes, we can have it where you suggest.
> 
> Perhaps Sage also needs a module called `customs` to control the imports properly :-)


Heh. See #21636 for a start. Make Sage Great Again.



---

archive/issue_comments_423476.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-05-10T23:11:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423476",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_423477.json:
```json
{
    "body": "Changing reviewer from \"Dima Pasechnik\" to \"Dima Pasechnik, Volker Braun\"",
    "created_at": "2017-05-10T23:11:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423477",
    "user": "https://github.com/dimpase"
}
```

Changing reviewer from "Dima Pasechnik" to "Dima Pasechnik, Volker Braun"



---

archive/issue_comments_423478.json:
```json
{
    "body": "Changing branch from \"u/jhpalmieri/formatter\" to \"16de140f16af5e9e764b25d1b8c47da38784809b\"",
    "created_at": "2017-05-15T22:51:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423478",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/jhpalmieri/formatter" to "16de140f16af5e9e764b25d1b8c47da38784809b"



---

archive/issue_events_075480.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-05-15T22:51:17Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22941#event-75480"
}
```



---

archive/issue_comments_423479.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-05-15T22:51:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22941#issuecomment-423479",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
