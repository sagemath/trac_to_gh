# Issue 22591: coercion for base rings of free preLie algebras

archive/issues_022354.json:
```json
{
    "body": "This does not work:\n\n```\nsage: A = algebras.FreePreLie(ZZ,1)\nsage: x = A.gens()[0]; x\nB[[]]\nsage: 4/5*x\n```\nbut this should coerce to the free PreLie algebra over QQ.\n\nSame problem with algebras.Free and algebras.FreeZinbiel.\n\nCC:  @tscrim\n\nKeywords: days85, days88, IMA coding sprints\n\nBranch/Commit: 5b3ccd6d052f5bd9634cae6306a029a2d602369e\n\nReviewer: Fr\u00e9d\u00e9ric Chapoton, Travis Scrimshaw\n\nAuthor: Fr\u00e9d\u00e9ric Chapoton, Travis Scrimshaw\n\nDependencies: #23440\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/22591\n\n",
    "closed_at": "2017-08-29T19:51:14Z",
    "created_at": "2017-03-13T13:35:31Z",
    "labels": [
        "component: categories",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "coercion for base rings of free preLie algebras",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22591",
    "user": "https://github.com/fchapoton"
}
```
This does not work:

```
sage: A = algebras.FreePreLie(ZZ,1)
sage: x = A.gens()[0]; x
B[[]]
sage: 4/5*x
```
but this should coerce to the free PreLie algebra over QQ.

Same problem with algebras.Free and algebras.FreeZinbiel.

CC:  @tscrim

Keywords: days85, days88, IMA coding sprints

Branch/Commit: 5b3ccd6d052f5bd9634cae6306a029a2d602369e

Reviewer: Frédéric Chapoton, Travis Scrimshaw

Author: Frédéric Chapoton, Travis Scrimshaw

Dependencies: #23440

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/22591





---

archive/issue_comments_330892.json:
```json
{
    "body": "<a id='comment:1'></a>This is because there is not an appropriate construction functor analogous to `PolynomialFunctor`:\n\n```sage\nsage: R.<x> = ZZ[]\nsage: R.construction()\n(Poly[x], Integer Ring)\nsage: R.<x,y> = FreeAlgebra(ZZ)\nsage: R.construction()\n```",
    "created_at": "2017-03-13T13:42:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-330892",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:1'></a>This is because there is not an appropriate construction functor analogous to `PolynomialFunctor`:

```sage
sage: R.<x> = ZZ[]
sage: R.construction()
(Poly[x], Integer Ring)
sage: R.<x,y> = FreeAlgebra(ZZ)
sage: R.construction()
```



---

archive/issue_comments_330893.json:
```json
{
    "body": "<a id='comment:2'></a>I made a tentative for free PreLie algebras. Almost working, it seems.\n\nMaybe we are lacking a category of \"linear magmas\" or \"non associative rings\" ?\n\n---\nNew commits:",
    "created_at": "2017-03-14T10:19:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-330893",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:2'></a>I made a tentative for free PreLie algebras. Almost working, it seems.

Maybe we are lacking a category of "linear magmas" or "non associative rings" ?

---
New commits:



---

archive/issue_comments_330894.json:
```json
{
    "body": "<a id='comment:3'></a>This isn't a matter of having the correct category. Instead, I think we might need to have a more generic such functor to allow base ring pushouts. So I would maybe take the functor class you have now and generalize it to accept a construction method/class, as well as a name (for displaying the functor). This would be something that we would likely use in a number of other places than those simply listed here (e.g., `CombinatorialFreeModule`).",
    "created_at": "2017-03-14T11:19:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-330894",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:3'></a>This isn't a matter of having the correct category. Instead, I think we might need to have a more generic such functor to allow base ring pushouts. So I would maybe take the functor class you have now and generalize it to accept a construction method/class, as well as a name (for displaying the functor). This would be something that we would likely use in a number of other places than those simply listed here (e.g., `CombinatorialFreeModule`).



---

archive/issue_comments_330895.json:
```json
{
    "body": "<a id='comment:4'></a>I agree that something more general may be better, but I do not feel able to do that.\n\nAnd so far my tentative is not working on morphisms..",
    "created_at": "2017-03-14T11:27:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-330895",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:4'></a>I agree that something more general may be better, but I do not feel able to do that.

And so far my tentative is not working on morphisms..



---

archive/issue_comments_330896.json:
```json
{
    "body": "Changing keywords from \"\" to \"days85\".",
    "created_at": "2017-03-14T16:52:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-330896",
    "user": "https://github.com/tscrim"
}
```

Changing keywords from "" to "days85".



---

archive/issue_comments_330897.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to categories.",
    "created_at": "2017-03-14T16:52:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-330897",
    "user": "https://github.com/tscrim"
}
```

Changing component from PLEASE CHANGE to categories.



---

archive/issue_comments_330898.json:
```json
{
    "body": "<a id='comment:5'></a>Then I will try to do some work on this this week.",
    "created_at": "2017-03-14T16:52:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-330898",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:5'></a>Then I will try to do some work on this this week.



---

archive/issue_comments_330899.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-03-15T09:33:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-330899",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_330900.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-03-15T10:31:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-330900",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_330901.json:
```json
{
    "body": "<a id='comment:8'></a>If we do this in full generality, we will also solve #21405.",
    "created_at": "2017-03-16T17:00:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-330901",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:8'></a>If we do this in full generality, we will also solve #21405.



---

archive/issue_comments_330902.json:
```json
{
    "body": "<a id='comment:9'></a>Sadly, my tentative here is not working. There must be something missing.",
    "created_at": "2017-03-16T19:50:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-330902",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:9'></a>Sadly, my tentative here is not working. There must be something missing.



---

archive/issue_comments_330903.json:
```json
{
    "body": "<a id='comment:10'></a>help, someone ? this would be a major improvement..",
    "created_at": "2017-07-12T06:55:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-330903",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:10'></a>help, someone ? this would be a major improvement..



---

archive/issue_comments_330904.json:
```json
{
    "body": "<a id='comment:11'></a>Sorry for not looking at this in detail sooner. So the pushout construction is working correctly:\n\n```\nsage: A = algebras.FreePreLie(ZZ, 'x')\nsage: from sage.categories.pushout import pushout\nsage: pushout(A, QQ)\nFree PreLie algebra on one generator ['x'] over Rational Field\n```\nHowever, we have this:\n\n```\nsage: coercion_model.analyse(1/2, x)\n(['Will try _r_action and _l_action'], None)\n```\nin contrast to\n\n```\nsage: R.<y> = ZZ[]\nsage: coercion_model.analyse(1/2, y)\n(['Action discovered.',\n  Left scalar multiplication by Rational Field on Univariate Polynomial Ring in y over Integer Ring],\n Univariate Polynomial Ring in y over Rational Field)\n```\nThis is a result of this difference:\n\n```\nsage: from sage.structure.coerce_actions import LeftModuleAction\nsage: LeftModuleAction(QQ, R, QQ.an_element(), R.an_element())\nLeft scalar multiplication by Rational Field on Univariate Polynomial Ring in y over Integer Ring\nsage: LeftModuleAction(QQ, A, QQ.an_element(), A.an_element())\n---------------------------------------------------------------------------\nCoercionException                         Traceback (most recent call last)\n<ipython-input-86-e33515a394e6> in <module>()\n----> 1 LeftModuleAction(QQ, A, QQ.an_element(), A.an_element())\n\n/home/travis/sage-build/src/sage/structure/coerce_actions.pyx in sage.structure.coerce_actions.ModuleAction.__init__ (/home/travis/sage-build/src/build/cythonized/sage/structure/coerce_actions.c:7195)()\n    372             raise CoercionException(\"The parent of %s is not %s but %s\"%(a,S,parent(a)))\n    373         if not isinstance(g, Element) or not isinstance(a, ModuleElement):\n--> 374             raise CoercionException(\"not an Element acting on a ModuleElement\")\n    375         res = self.act(g, a)\n    376         if parent(res) is not the_set:\n\nCoercionException: not an Element acting on a ModuleElement\n```\nThis is worked around by #23440. However, I think the proper fix is to not check `isinstance(a, ModuleElement)`, but instead for its parent `S` to be in the category of modules.\n\nReally this should be done for CFM, but that one is too much of a base class and inheriting `construction()` would almost certainly cause too many (subtle) problems. Plus considering how the functors are implemented, it almost certainly is best to do this on a case-by-case basis.",
    "created_at": "2017-07-18T12:48:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-330904",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:11'></a>Sorry for not looking at this in detail sooner. So the pushout construction is working correctly:

```
sage: A = algebras.FreePreLie(ZZ, 'x')
sage: from sage.categories.pushout import pushout
sage: pushout(A, QQ)
Free PreLie algebra on one generator ['x'] over Rational Field
```
However, we have this:

```
sage: coercion_model.analyse(1/2, x)
(['Will try _r_action and _l_action'], None)
```
in contrast to

```
sage: R.<y> = ZZ[]
sage: coercion_model.analyse(1/2, y)
(['Action discovered.',
  Left scalar multiplication by Rational Field on Univariate Polynomial Ring in y over Integer Ring],
 Univariate Polynomial Ring in y over Rational Field)
```
This is a result of this difference:

```
sage: from sage.structure.coerce_actions import LeftModuleAction
sage: LeftModuleAction(QQ, R, QQ.an_element(), R.an_element())
Left scalar multiplication by Rational Field on Univariate Polynomial Ring in y over Integer Ring
sage: LeftModuleAction(QQ, A, QQ.an_element(), A.an_element())
---------------------------------------------------------------------------
CoercionException                         Traceback (most recent call last)
<ipython-input-86-e33515a394e6> in <module>()
----> 1 LeftModuleAction(QQ, A, QQ.an_element(), A.an_element())

/home/travis/sage-build/src/sage/structure/coerce_actions.pyx in sage.structure.coerce_actions.ModuleAction.__init__ (/home/travis/sage-build/src/build/cythonized/sage/structure/coerce_actions.c:7195)()
    372             raise CoercionException("The parent of %s is not %s but %s"%(a,S,parent(a)))
    373         if not isinstance(g, Element) or not isinstance(a, ModuleElement):
--> 374             raise CoercionException("not an Element acting on a ModuleElement")
    375         res = self.act(g, a)
    376         if parent(res) is not the_set:

CoercionException: not an Element acting on a ModuleElement
```
This is worked around by #23440. However, I think the proper fix is to not check `isinstance(a, ModuleElement)`, but instead for its parent `S` to be in the category of modules.

Really this should be done for CFM, but that one is too much of a base class and inheriting `construction()` would almost certainly cause too many (subtle) problems. Plus considering how the functors are implemented, it almost certainly is best to do this on a case-by-case basis.



---

archive/issue_comments_330905.json:
```json
{
    "body": "<a id='comment:12'></a>I should also say that with this branch and #23440, I get\n\n```\nsage: A = algebras.FreePreLie(ZZ, 'x')\nsage: x = A.gen(0)\nsage: A.<x> = algebras.FreePreLie(ZZ)\nsage: 1/2 * x\n1/2*B[[]]\nsage: _.parent()\nFree PreLie algebra on one generator ['x'] over Rational Field\n```",
    "created_at": "2017-07-18T12:49:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-330905",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:12'></a>I should also say that with this branch and #23440, I get

```
sage: A = algebras.FreePreLie(ZZ, 'x')
sage: x = A.gen(0)
sage: A.<x> = algebras.FreePreLie(ZZ)
sage: 1/2 * x
1/2*B[[]]
sage: _.parent()
Free PreLie algebra on one generator ['x'] over Rational Field
```



---

archive/issue_comments_330906.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-31T11:23:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-330906",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_330907.json:
```json
{
    "body": "<a id='comment:14'></a>There remains some failing doctest, to be investigated.",
    "created_at": "2017-07-31T11:26:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-330907",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:14'></a>There remains some failing doctest, to be investigated.



---

archive/issue_events_058967.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2017-07-31T11:26:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "milestone": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22591#event-58967"
}
```



---

archive/issue_comments_330908.json:
```json
{
    "body": "<a id='comment:16'></a>Travis, what do you think of the 2 remaining failures (see patchbot), when trying to find a common parent for `FreePreLie(QQ,'z,t')` and `FreePreLie(ZZ,'x,y,z')` ? Can we hope to make this work ? The same thing seems to work fine for polynomials, and I would very much like to enjoy the same comfort for pre-Lie algebras.",
    "created_at": "2017-08-21T19:41:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-330908",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:16'></a>Travis, what do you think of the 2 remaining failures (see patchbot), when trying to find a common parent for `FreePreLie(QQ,'z,t')` and `FreePreLie(ZZ,'x,y,z')` ? Can we hope to make this work ? The same thing seems to work fine for polynomials, and I would very much like to enjoy the same comfort for pre-Lie algebras.



---

archive/issue_comments_330909.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [comment:16 chapoton]:\n> Travis, what do you think of the 2 remaining failures (see patchbot), when trying to find a common parent for `FreePreLie(QQ,'z,t')` and `FreePreLie(ZZ,'x,y,z')` ? Can we hope to make this work ? The same thing seems to work fine for polynomials, and I would very much like to enjoy the same comfort for pre-Lie algebras.\n\n\nI do not have this for polynomials:\n\n```\nsage: R.<x,y> = ZZ[]\nsage: S.<a,b,c> = QQ[]\nsage: x + a\n...\nTypeError: unsupported operand parent(s) for +: ...\n```\nSo I think we should simply remove these tests.",
    "created_at": "2017-08-21T19:48:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-330909",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:17'></a>Replying to [comment:16 chapoton]:
> Travis, what do you think of the 2 remaining failures (see patchbot), when trying to find a common parent for `FreePreLie(QQ,'z,t')` and `FreePreLie(ZZ,'x,y,z')` ? Can we hope to make this work ? The same thing seems to work fine for polynomials, and I would very much like to enjoy the same comfort for pre-Lie algebras.


I do not have this for polynomials:

```
sage: R.<x,y> = ZZ[]
sage: S.<a,b,c> = QQ[]
sage: x + a
...
TypeError: unsupported operand parent(s) for +: ...
```
So I think we should simply remove these tests.



---

archive/issue_comments_330910.json:
```json
{
    "body": "<a id='comment:18'></a>What about that:\n\n```\nsage: x,y=polygens(QQ,'x,y')\nsage: a,b=polygens(ZZ,'y,z')\nsage: x+a\nx + y\nsage: x+b\nx + z\nsage: (x+b).parent()\nMultivariate Polynomial Ring in x, y, z over Rational Field\n```",
    "created_at": "2017-08-21T19:54:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-330910",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:18'></a>What about that:

```
sage: x,y=polygens(QQ,'x,y')
sage: a,b=polygens(ZZ,'y,z')
sage: x+a
x + y
sage: x+b
x + z
sage: (x+b).parent()
Multivariate Polynomial Ring in x, y, z over Rational Field
```



---

archive/issue_comments_330911.json:
```json
{
    "body": "<a id='comment:19'></a>Ah, right common variables, I misread what the test was. Looking into it now.",
    "created_at": "2017-08-21T19:59:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-330911",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:19'></a>Ah, right common variables, I misread what the test was. Looking into it now.



---

archive/issue_comments_330912.json:
```json
{
    "body": "Changing keywords from \"days85\" to \"days85, days88, IMA coding sprints\".",
    "created_at": "2017-08-21T20:30:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-330912",
    "user": "https://github.com/tscrim"
}
```

Changing keywords from "days85" to "days85, days88, IMA coding sprints".



---

archive/issue_comments_330913.json:
```json
{
    "body": "<a id='comment:20'></a>Okay, there seems to be a fundamental issue:\n\n```\nsage: F.<x,y,z> = algebras.FreePreLie(ZZ)\nsage: G.<z,t> = algebras.FreePreLie(QQ)\nsage: from sage.categories.pushout import \nsage: pushout(F, G)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-5-42a86045bbaa> in <module>()\n----> 1 pushout(F, G)\n\n/home/travis/sage/local/lib/python2.7/site-packages/sage/categories/pushout.pyc in pushout(R, S)\n   3920         # Rc is a list of functors from Z to R and Sc is a list of functors from Z to S\n   3921         R_tower = expand_tower(R_tower[:len(Rs)+1])\n-> 3922         S_tower = expand_tower(S_tower[:len(Ss)+1])\n   3923     Rc = [c[0] for c in R_tower[1:]]\n   3924     Sc = [c[0] for c in S_tower[1:]]\n\n/home/travis/sage/local/lib/python2.7/site-packages/sage/categories/pushout.pyc in expand_tower(tower)\n   4244             for ff in reversed(fs[1:]):\n   4245                 new_tower.append((ff, R))\n-> 4246                 R = ff(R)\n   4247             new_tower.append((fs[0], R))\n   4248     return list(reversed(new_tower))\n\n/home/travis/sage/src/sage/categories/functor.pyx in sage.categories.functor.Functor.__call__ (/home/travis/sage/src/build/cythonized/sage/categories/functor.c:3077)()\n    381         if is_Morphism(x):\n    382             return self._apply_functor_to_morphism(x)\n--> 383         y = self._apply_functor(self._coerce_into_domain(x))\n    384         if not ((y in self.__codomain) or (y in self.__codomain.hom_category())):\n    385             raise TypeError(\"%s is ill-defined, since it sends x (=%s) to something that is not in %s.\" % (repr(self), x, self.__codomain))\n\n/home/travis/sage/src/sage/categories/functor.pyx in sage.categories.functor.Functor._coerce_into_domain (/home/travis/sage/src/build/cythonized/sage/categories/functor.c:2719)()\n    296         \"\"\"\n    297         if not (x in  self.__domain):\n--> 298             raise TypeError(\"x (=%s) is not in %s\" % (x, self.__domain))\n    299         return x\n    300 \n\nTypeError: x (=Free PreLie algebra on one generator ['x'] over Integer Ring) is not in Category of rings\n```\nThis is ultimately the same problem when doing\n\n```\nsage: 1/2 * x\n```\n\nSo I think the issue is you cannot simply stack the functors in this case, at least with how we are defining our functor. In other words, `PreLie(PreLie(QQ, 'x'), 'y')` does not make sense because `PreLie(QQ, 'x')` is not a ring (as the error message indicates). Actually, is\n\n```\nPreLie(PreLie(QQ, 'x'), 'y') [isomorphic] PreLie(QQ, 'x,y')\n```\ntrue? I think we might need to do something a little different and more careful than the polynomial functors do. I'm not sure exactly what that is yet.",
    "created_at": "2017-08-21T20:30:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-330913",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:20'></a>Okay, there seems to be a fundamental issue:

```
sage: F.<x,y,z> = algebras.FreePreLie(ZZ)
sage: G.<z,t> = algebras.FreePreLie(QQ)
sage: from sage.categories.pushout import 
sage: pushout(F, G)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-5-42a86045bbaa> in <module>()
----> 1 pushout(F, G)

/home/travis/sage/local/lib/python2.7/site-packages/sage/categories/pushout.pyc in pushout(R, S)
   3920         # Rc is a list of functors from Z to R and Sc is a list of functors from Z to S
   3921         R_tower = expand_tower(R_tower[:len(Rs)+1])
-> 3922         S_tower = expand_tower(S_tower[:len(Ss)+1])
   3923     Rc = [c[0] for c in R_tower[1:]]
   3924     Sc = [c[0] for c in S_tower[1:]]

/home/travis/sage/local/lib/python2.7/site-packages/sage/categories/pushout.pyc in expand_tower(tower)
   4244             for ff in reversed(fs[1:]):
   4245                 new_tower.append((ff, R))
-> 4246                 R = ff(R)
   4247             new_tower.append((fs[0], R))
   4248     return list(reversed(new_tower))

/home/travis/sage/src/sage/categories/functor.pyx in sage.categories.functor.Functor.__call__ (/home/travis/sage/src/build/cythonized/sage/categories/functor.c:3077)()
    381         if is_Morphism(x):
    382             return self._apply_functor_to_morphism(x)
--> 383         y = self._apply_functor(self._coerce_into_domain(x))
    384         if not ((y in self.__codomain) or (y in self.__codomain.hom_category())):
    385             raise TypeError("%s is ill-defined, since it sends x (=%s) to something that is not in %s." % (repr(self), x, self.__codomain))

/home/travis/sage/src/sage/categories/functor.pyx in sage.categories.functor.Functor._coerce_into_domain (/home/travis/sage/src/build/cythonized/sage/categories/functor.c:2719)()
    296         """
    297         if not (x in  self.__domain):
--> 298             raise TypeError("x (=%s) is not in %s" % (x, self.__domain))
    299         return x
    300 

TypeError: x (=Free PreLie algebra on one generator ['x'] over Integer Ring) is not in Category of rings
```
This is ultimately the same problem when doing

```
sage: 1/2 * x
```

So I think the issue is you cannot simply stack the functors in this case, at least with how we are defining our functor. In other words, `PreLie(PreLie(QQ, 'x'), 'y')` does not make sense because `PreLie(QQ, 'x')` is not a ring (as the error message indicates). Actually, is

```
PreLie(PreLie(QQ, 'x'), 'y') [isomorphic] PreLie(QQ, 'x,y')
```
true? I think we might need to do something a little different and more careful than the polynomial functors do. I'm not sure exactly what that is yet.



---

archive/issue_comments_330914.json:
```json
{
    "body": "<a id='comment:21'></a>So, there is something problematic here. I must admit that I do not understand enough of all this to investigate.\n\nI would say that\n\n```\nPreLie(PreLie(QQ, 'x'), 'y') [isomorphic] PreLie(QQ, 'x,y')\n```\nmake no sense, because `PreLie(QQ, 'x'), 'y')` is not a ring.\n\nWhat is true (and comes from the operad structure) is that there is a natural \"product map\" from the free Pre-Lie algebra generated by a free pre-Lie algebra on V to the free pre-Lie algebra on V. Think of the natural product map from T(T(V)) to T(V). But maybe this is not so pertinent for the problem at stake.",
    "created_at": "2017-08-22T13:21:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-330914",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:21'></a>So, there is something problematic here. I must admit that I do not understand enough of all this to investigate.

I would say that

```
PreLie(PreLie(QQ, 'x'), 'y') [isomorphic] PreLie(QQ, 'x,y')
```
make no sense, because `PreLie(QQ, 'x'), 'y')` is not a ring.

What is true (and comes from the operad structure) is that there is a natural "product map" from the free Pre-Lie algebra generated by a free pre-Lie algebra on V to the free pre-Lie algebra on V. Think of the natural product map from T(T(V)) to T(V). But maybe this is not so pertinent for the problem at stake.



---

archive/issue_comments_330915.json:
```json
{
    "body": "<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-08-22T14:50:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-330915",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_330916.json:
```json
{
    "body": "<a id='comment:23'></a>Here we go, this seems to fix it. It was more of a mathematical misunderstanding, see below for details.\n\nSo what we were doing before by mimicking polynomials is constructing a tower and then multiplying/composing the functors. Basically, it was doing something like this:\n\n```\nZZ{x}{y}{z} = ZZ{x,y,z}\n```\nHowever, this is not how the construction works as you indicated in comment:21. So instead I am merging the functors into \"bigger\" functors during the `pushout` by implementing `merge` more carefully and removing `expand` (because they are not equivalent). Does that help explain things?",
    "created_at": "2017-08-22T14:54:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-330916",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:23'></a>Here we go, this seems to fix it. It was more of a mathematical misunderstanding, see below for details.

So what we were doing before by mimicking polynomials is constructing a tower and then multiplying/composing the functors. Basically, it was doing something like this:

```
ZZ{x}{y}{z} = ZZ{x,y,z}
```
However, this is not how the construction works as you indicated in comment:21. So instead I am merging the functors into "bigger" functors during the `pushout` by implementing `merge` more carefully and removing `expand` (because they are not equivalent). Does that help explain things?



---

archive/issue_comments_330917.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-08-23T12:57:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-330917",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_330918.json:
```json
{
    "body": "<a id='comment:24'></a>Great ! Thanks a lot. Do you agree that we can set to positive once a patchbot has been through ?",
    "created_at": "2017-08-23T12:57:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-330918",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:24'></a>Great ! Thanks a lot. Do you agree that we can set to positive once a patchbot has been through ?



---

archive/issue_comments_330919.json:
```json
{
    "body": "<a id='comment:25'></a>Replying to [comment:24 chapoton]:\n> Great ! Thanks a lot. Do you agree that we can set to positive once a patchbot has been through ?\n\n\nYep, that is correct.",
    "created_at": "2017-08-23T14:17:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-330919",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:25'></a>Replying to [comment:24 chapoton]:
> Great ! Thanks a lot. Do you agree that we can set to positive once a patchbot has been through ?


Yep, that is correct.



---

archive/issue_comments_330920.json:
```json
{
    "body": "<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-08-23T18:11:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-330920",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_330921.json:
```json
{
    "body": "<a id='comment:27'></a>I fixed two very small things. As bot was green, I am setting to positive.",
    "created_at": "2017-08-23T18:12:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-330921",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:27'></a>I fixed two very small things. As bot was green, I am setting to positive.



---

archive/issue_comments_330922.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-08-23T18:12:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-330922",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_330923.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-08-29T19:51:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-330923",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_058968.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-08-29T19:51:14Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22591#event-58968"
}
```
