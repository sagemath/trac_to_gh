# Issue 22152: speed up generic polynomials

archive/issues_021915.json:
```json
{
    "body": "Some hopefully representative examples:\n\n```\nQQi.<i> = QuadraticField(-1)\nPol.<x> = QQi[]\np = x + i + 1\nq = ( (8*i - 12)*x^10 + (-i + 2)*x^9 + (-i + 1)*x^8 + (-i + 7)*x^7 + (-i + 1)*x^6 + (-12*i + 2)*x^5 + (i + 1)*x^4 + (-7*i + 1)*x^3 + (2*i + 1)*x^2 + x - i - 2)\na = 42\nb = QQi(42)\nmat = matrix(QQi, [[1, i], [0,2]])\ny = polygen(Pol, 'y')\nfoo = y^2 + x + 1\nfl1 = 1.r\nRR1 = 1.\nfor cmd in [\n    'p*p',\n    'p**5',\n    'p._mul_trunc_(q, 3)',\n    'p(0)',\n    'q(0)',\n    'p(a)',\n    'p(b)',\n    'q(b)',\n    'q(fl1)',\n    'q(RR1)',\n    'q(a)',\n    'q(mat)',\n    'foo(x=1, y=2)',\n]:\n    timeit(cmd)\n```\n\n```\nsage: pol = MatrixSpace(ZZ, 1000, 1000)['x'].random_element(degree=10)\nsage: %timeit pol(42)\n```\n\nResults:\n\n```\ntest                  old      new\n--------------------------------------\np*p                   13.1 \u00b5s  8.14 \u00b5s\np**5                  53.7 \u00b5s  35.9 \u00b5s\np._mul_trunc_(q, 3)   17 \u00b5s    8.26 \u00b5s\np(0)                  3.49 \u00b5s  920 ns\nq(0)                  3.5 \u00b5s   877 ns\np(a)                  6.72 \u00b5s  3.78 \u00b5s\np(b)                  6.68 \u00b5s  2.48 \u00b5s\nq(b)                  13.8 \u00b5s  11.9 \u00b5s\nq(fl1)                7.47 ms  8.24 ms\nq(RR1)                7.48 ms  8.27 ms\nq(a)                  16.8 \u00b5s  15.8 \u00b5s\nq(mat)                290 \u00b5s   284 \u00b5s\nfoo(x=1, y=2)         64.1 \u00b5s  54 \u00b5s\n---------------------------------------\npol(42)               208 ms   202 ms\n```\n\n(Evaluations at floating-point numbers are very slow, and suffer from a small regression, due to the slowness of the generic coercion map through `CLF`.)\n\nEdit: add up to ~0.5 \u00b5s to some of the above timings due to subsequent fixes.\n\nCC:  @JohnCremona @nbruin simonking\n\nReviewer: Travis Scrimshaw, Marc Mezzarobba\n\nAuthor: Marc Mezzarobba, Travis Scrimshaw\n\nBranch: b846e12f17880b85c8929471308918ac572f30ea\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/22152\n\n",
    "closed_at": "2017-02-02T22:09:28Z",
    "created_at": "2017-01-08T10:21:24Z",
    "labels": [
        "component: performance"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.6",
    "title": "speed up generic polynomials",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22152",
    "user": "https://github.com/mezzarobba"
}
```
Some hopefully representative examples:

```
QQi.<i> = QuadraticField(-1)
Pol.<x> = QQi[]
p = x + i + 1
q = ( (8*i - 12)*x^10 + (-i + 2)*x^9 + (-i + 1)*x^8 + (-i + 7)*x^7 + (-i + 1)*x^6 + (-12*i + 2)*x^5 + (i + 1)*x^4 + (-7*i + 1)*x^3 + (2*i + 1)*x^2 + x - i - 2)
a = 42
b = QQi(42)
mat = matrix(QQi, [[1, i], [0,2]])
y = polygen(Pol, 'y')
foo = y^2 + x + 1
fl1 = 1.r
RR1 = 1.
for cmd in [
    'p*p',
    'p**5',
    'p._mul_trunc_(q, 3)',
    'p(0)',
    'q(0)',
    'p(a)',
    'p(b)',
    'q(b)',
    'q(fl1)',
    'q(RR1)',
    'q(a)',
    'q(mat)',
    'foo(x=1, y=2)',
]:
    timeit(cmd)
```

```
sage: pol = MatrixSpace(ZZ, 1000, 1000)['x'].random_element(degree=10)
sage: %timeit pol(42)
```

Results:

```
test                  old      new
--------------------------------------
p*p                   13.1 µs  8.14 µs
p**5                  53.7 µs  35.9 µs
p._mul_trunc_(q, 3)   17 µs    8.26 µs
p(0)                  3.49 µs  920 ns
q(0)                  3.5 µs   877 ns
p(a)                  6.72 µs  3.78 µs
p(b)                  6.68 µs  2.48 µs
q(b)                  13.8 µs  11.9 µs
q(fl1)                7.47 ms  8.24 ms
q(RR1)                7.48 ms  8.27 ms
q(a)                  16.8 µs  15.8 µs
q(mat)                290 µs   284 µs
foo(x=1, y=2)         64.1 µs  54 µs
---------------------------------------
pol(42)               208 ms   202 ms
```

(Evaluations at floating-point numbers are very slow, and suffer from a small regression, due to the slowness of the generic coercion map through `CLF`.)

Edit: add up to ~0.5 µs to some of the above timings due to subsequent fixes.

CC:  @JohnCremona @nbruin simonking

Reviewer: Travis Scrimshaw, Marc Mezzarobba

Author: Marc Mezzarobba, Travis Scrimshaw

Branch: b846e12f17880b85c8929471308918ac572f30ea

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/22152





---

archive/issue_comments_303843.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-01-08T14:09:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303843",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_303844.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-01-11T15:38:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303844",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_303845.json:
```json
{
    "body": "<a id='comment:3'></a>The tests in `rings/` pass; I haven't yet run the whole test suite.",
    "created_at": "2017-01-11T15:47:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303845",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:3'></a>The tests in `rings/` pass; I haven't yet run the whole test suite.



---

archive/issue_comments_303846.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-01-11T15:55:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303846",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_303847.json:
```json
{
    "body": "<a id='comment:5'></a>Looks good overall. From a quick look through the code, it seems like the inputs to the `do_*` methods always take lists as inputs. Likewise, should we make `list` a `cpdef` method that guarantees a list being returned? This might get us some extra speed as well.",
    "created_at": "2017-01-11T18:07:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303847",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:5'></a>Looks good overall. From a quick look through the code, it seems like the inputs to the `do_*` methods always take lists as inputs. Likewise, should we make `list` a `cpdef` method that guarantees a list being returned? This might get us some extra speed as well.



---

archive/issue_comments_303848.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:5 tscrim]:\n> Looks good overall. From a quick look through the code, it seems like the inputs to the `do_*` methods always take lists as inputs. Likewise, should we make `list` a `cpdef` method that guarantees a list being returned? This might get us some extra speed as well.\n\n\nThanks for the suggestion. Adding type annotations to `do_*` and brutally replacing `def list(...)` by `cdef list list(...)` everywhere actually seems to make things slower, though the difference is small. I didn't try to investigate any further. And I must confess that it is not at all clear to me what implications those `cdef` have with the relatively complex hierarchy of subclasses that override `list()` (sometimes from Cython, sometimes from Python, sometimes with additional arguments).",
    "created_at": "2017-01-11T20:24:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303848",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:6'></a>Replying to [comment:5 tscrim]:
> Looks good overall. From a quick look through the code, it seems like the inputs to the `do_*` methods always take lists as inputs. Likewise, should we make `list` a `cpdef` method that guarantees a list being returned? This might get us some extra speed as well.


Thanks for the suggestion. Adding type annotations to `do_*` and brutally replacing `def list(...)` by `cdef list list(...)` everywhere actually seems to make things slower, though the difference is small. I didn't try to investigate any further. And I must confess that it is not at all clear to me what implications those `cdef` have with the relatively complex hierarchy of subclasses that override `list()` (sometimes from Cython, sometimes from Python, sometimes with additional arguments).



---

archive/issue_comments_303849.json:
```json
{
    "body": "<a id='comment:7'></a>You might be loosing some speed by variables not being cdef'ed as a list. Did you happen to save your current branch? I can play around with it later tonight to see if I can get some extra speed out of it.",
    "created_at": "2017-01-11T21:30:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303849",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:7'></a>You might be loosing some speed by variables not being cdef'ed as a list. Did you happen to save your current branch? I can play around with it later tonight to see if I can get some extra speed out of it.



---

archive/issue_comments_303850.json:
```json
{
    "body": "<a id='comment:8'></a>I noticed a small problem with the last commit: it would cause terrible regression for cases like polynomials over large matrix spaces evaluated at scalars. I'll push a fix in a minute.\n\nReplying to [comment:7 tscrim]:\n> You might be loosing some speed by variables not being cdef'ed as a list. Did you happen to save your current branch?\n\n\nYes, see `u/mmezzarobba/speed_up_generic_polynomials-alt`.",
    "created_at": "2017-01-12T08:43:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303850",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:8'></a>I noticed a small problem with the last commit: it would cause terrible regression for cases like polynomials over large matrix spaces evaluated at scalars. I'll push a fix in a minute.

Replying to [comment:7 tscrim]:
> You might be loosing some speed by variables not being cdef'ed as a list. Did you happen to save your current branch?


Yes, see `u/mmezzarobba/speed_up_generic_polynomials-alt`.



---

archive/issue_comments_303851.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-01-12T08:43:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303851",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_303852.json:
```json
{
    "body": "<a id='comment:11'></a>I went through and made all of the `def list(self)` methods into `cpdef list list(self, bint copy=True)` to take advantage of the times when we don't have to copy the list and to specify the output type. This didn't give as much of a speed bump as I was expecting. I also made some other improvements by using `get_unsafe` and other things. Here are my timings:\n\nCurrent branch:\n\n```\n625 loops, best of 3: 6.68 \u00b5s per loop\n625 loops, best of 3: 29.2 \u00b5s per loop\n625 loops, best of 3: 6.77 \u00b5s per loop\n625 loops, best of 3: 739 ns per loop\n625 loops, best of 3: 699 ns per loop\n625 loops, best of 3: 3.3 \u00b5s per loop\n625 loops, best of 3: 2.23 \u00b5s per loop\n625 loops, best of 3: 10.4 \u00b5s per loop\n125 loops, best of 3: 7.11 ms per loop\n125 loops, best of 3: 7.1 ms per loop\n625 loops, best of 3: 13.2 \u00b5s per loop\n625 loops, best of 3: 247 \u00b5s per loop\n625 loops, best of 3: 46.7 \u00b5s per loop\n```\nvs my new branch\n\n```\n625 loops, best of 3: 6.5 \u00b5s per loop\n625 loops, best of 3: 28.6 \u00b5s per loop\n625 loops, best of 3: 6.64 \u00b5s per loop\n625 loops, best of 3: 739 ns per loop\n625 loops, best of 3: 737 ns per loop\n625 loops, best of 3: 3.13 \u00b5s per loop\n625 loops, best of 3: 2.19 \u00b5s per loop\n625 loops, best of 3: 10.6 \u00b5s per loop\n125 loops, best of 3: 6.88 ms per loop\n125 loops, best of 3: 6.84 ms per loop\n625 loops, best of 3: 13.4 \u00b5s per loop\n625 loops, best of 3: 240 \u00b5s per loop\n625 loops, best of 3: 44.4 \u00b5s per loop\n```\n\nThe small timings have too much variation to say there is a definitive regression. However, the arithmetic operations have improved.\n\nSomething else I noticed that probably could get us some speed is requiring *all* polynomials to have a `_new_constant_poly`. Currently only the dense ones have such a method. Shall we do that here?\n\n---\nNew commits:",
    "created_at": "2017-01-12T21:45:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303852",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:11'></a>I went through and made all of the `def list(self)` methods into `cpdef list list(self, bint copy=True)` to take advantage of the times when we don't have to copy the list and to specify the output type. This didn't give as much of a speed bump as I was expecting. I also made some other improvements by using `get_unsafe` and other things. Here are my timings:

Current branch:

```
625 loops, best of 3: 6.68 µs per loop
625 loops, best of 3: 29.2 µs per loop
625 loops, best of 3: 6.77 µs per loop
625 loops, best of 3: 739 ns per loop
625 loops, best of 3: 699 ns per loop
625 loops, best of 3: 3.3 µs per loop
625 loops, best of 3: 2.23 µs per loop
625 loops, best of 3: 10.4 µs per loop
125 loops, best of 3: 7.11 ms per loop
125 loops, best of 3: 7.1 ms per loop
625 loops, best of 3: 13.2 µs per loop
625 loops, best of 3: 247 µs per loop
625 loops, best of 3: 46.7 µs per loop
```
vs my new branch

```
625 loops, best of 3: 6.5 µs per loop
625 loops, best of 3: 28.6 µs per loop
625 loops, best of 3: 6.64 µs per loop
625 loops, best of 3: 739 ns per loop
625 loops, best of 3: 737 ns per loop
625 loops, best of 3: 3.13 µs per loop
625 loops, best of 3: 2.19 µs per loop
625 loops, best of 3: 10.6 µs per loop
125 loops, best of 3: 6.88 ms per loop
125 loops, best of 3: 6.84 ms per loop
625 loops, best of 3: 13.4 µs per loop
625 loops, best of 3: 240 µs per loop
625 loops, best of 3: 44.4 µs per loop
```

The small timings have too much variation to say there is a definitive regression. However, the arithmetic operations have improved.

Something else I noticed that probably could get us some speed is requiring *all* polynomials to have a `_new_constant_poly`. Currently only the dense ones have such a method. Shall we do that here?

---
New commits:



---

archive/issue_events_058241.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2017-01-12T21:45:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "milestone": "sage-7.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22152#event-58241"
}
```



---

archive/issue_comments_303853.json:
```json
{
    "body": "<a id='comment:12'></a>Thanks for the improvements! I cleaned up the branch a little (rebased, squashed my \"wip\" commit into the following one) without changing the code.\n\nRegarding `_new_constant_poly()` for sparse polynomials: I really don't think I'll have time to make further changes until Feb.\u00a08 at best, though I'll do my best to review yours if you make some. In any case I'm happy with the current branch; you can set the ticket to positive review if you agree, assuming the patchbot doesn't find anything to complain about.\n\n---\nNew commits:",
    "created_at": "2017-01-13T11:06:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303853",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:12'></a>Thanks for the improvements! I cleaned up the branch a little (rebased, squashed my "wip" commit into the following one) without changing the code.

Regarding `_new_constant_poly()` for sparse polynomials: I really don't think I'll have time to make further changes until Feb. 8 at best, though I'll do my best to review yours if you make some. In any case I'm happy with the current branch; you can set the ticket to positive review if you agree, assuming the patchbot doesn't find anything to complain about.

---
New commits:



---

archive/issue_comments_303854.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-01-13T19:14:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303854",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_303855.json:
```json
{
    "body": "<a id='comment:14'></a>Let's get this into Sage now and do further optimizations on a followup ticket.",
    "created_at": "2017-01-13T19:14:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303855",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:14'></a>Let's get this into Sage now and do further optimizations on a followup ticket.



---

archive/issue_comments_303856.json:
```json
{
    "body": "<a id='comment:15'></a>Merge conflict...",
    "created_at": "2017-01-21T17:59:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303856",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:15'></a>Merge conflict...



---

archive/issue_comments_303857.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-01-21T17:59:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303857",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_303858.json:
```json
{
    "body": "<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-01-21T19:24:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303858",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_303859.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-01-21T19:27:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303859",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_303860.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-01-22T10:25:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303860",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_303861.json:
```json
{
    "body": "<a id='comment:19'></a>Rebased.",
    "created_at": "2017-01-22T10:28:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303861",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:19'></a>Rebased.



---

archive/issue_comments_303862.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2017-01-22T10:28:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303862",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_303863.json:
```json
{
    "body": "<a id='comment:20'></a>merge conflict...",
    "created_at": "2017-01-23T23:05:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303863",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:20'></a>merge conflict...



---

archive/issue_comments_303864.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-01-23T23:05:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303864",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_303865.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [comment:20 vbraun]:\n> merge conflict...\n\n\nAgain? With which branch? This ticket's branch (as of `c4b9000`) is based on the current `trac:develop`.",
    "created_at": "2017-01-25T08:46:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303865",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:21'></a>Replying to [comment:20 vbraun]:
> merge conflict...


Again? With which branch? This ticket's branch (as of `c4b9000`) is based on the current `trac:develop`.



---

archive/issue_comments_303866.json:
```json
{
    "body": "<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-01-26T13:17:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303866",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_303867.json:
```json
{
    "body": "<a id='comment:23'></a>Rebased again, on top of 7.6.beta1.",
    "created_at": "2017-01-26T13:18:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303867",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:23'></a>Rebased again, on top of 7.6.beta1.



---

archive/issue_comments_303868.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2017-01-26T13:18:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303868",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_303869.json:
```json
{
    "body": "<a id='comment:24'></a>I am getting the same doctest failure as the patchbot:\n\n```\nsage -t --long src/sage/schemes/elliptic_curves/padics.py\n**********************************************************************\nFile \"src/sage/schemes/elliptic_curves/padics.py\", line 1058, in sage.schemes.elliptic_curves.padics.padic_sigma\nFailed example:\n    for N in range(3, max_N):                     # long time\n       sigma = E.padic_sigma(p, N, E2=E2)         # long time\n       assert sigma == max_sigma\nException raised:\n    Traceback (most recent call last):\n      File \"/home/travis/sage-build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 498, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/travis/sage-build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 861, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.schemes.elliptic_curves.padics.padic_sigma[19]>\", line 3, in <module>\n        assert sigma == max_sigma\n    AssertionError\n**********************************************************************\n1 item had failures:\n   1 of  21 in sage.schemes.elliptic_curves.padics.padic_sigma\n    [197 tests, 1 failure, 11.79 s]\n----------------------------------------------------------------------\nsage -t --long src/sage/schemes/elliptic_curves/padics.py  # 1 doctest failed\n----------------------------------------------------------------------\n```\nI almost certainly did something wrong with my round of improvements. This will require some digging.",
    "created_at": "2017-01-28T17:39:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303869",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:24'></a>I am getting the same doctest failure as the patchbot:

```
sage -t --long src/sage/schemes/elliptic_curves/padics.py
**********************************************************************
File "src/sage/schemes/elliptic_curves/padics.py", line 1058, in sage.schemes.elliptic_curves.padics.padic_sigma
Failed example:
    for N in range(3, max_N):                     # long time
       sigma = E.padic_sigma(p, N, E2=E2)         # long time
       assert sigma == max_sigma
Exception raised:
    Traceback (most recent call last):
      File "/home/travis/sage-build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 498, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/travis/sage-build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 861, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.schemes.elliptic_curves.padics.padic_sigma[19]>", line 3, in <module>
        assert sigma == max_sigma
    AssertionError
**********************************************************************
1 item had failures:
   1 of  21 in sage.schemes.elliptic_curves.padics.padic_sigma
    [197 tests, 1 failure, 11.79 s]
----------------------------------------------------------------------
sage -t --long src/sage/schemes/elliptic_curves/padics.py  # 1 doctest failed
----------------------------------------------------------------------
```
I almost certainly did something wrong with my round of improvements. This will require some digging.



---

archive/issue_comments_303870.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-01-28T17:39:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303870",
    "user": "https://github.com/tscrim"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_303871.json:
```json
{
    "body": "<a id='comment:25'></a>This was introduced by me in [3532b34](https://git.sagemath.org/sage.git/commit/?id=3532b340bff5061b0262ae84953c51b5406d8a2a). Now to figure out exactly what the problem is...",
    "created_at": "2017-01-28T22:46:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303871",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:25'></a>This was introduced by me in [3532b34](https://git.sagemath.org/sage.git/commit/?id=3532b340bff5061b0262ae84953c51b5406d8a2a). Now to figure out exactly what the problem is...



---

archive/issue_comments_303872.json:
```json
{
    "body": "<a id='comment:26'></a>Okay, so the problem was in the change I made to the `__iter__` in that iterating over the list is not the same as iterating up to the degree. I don't understand why this results in different behavior. However, for now, I think we can just let it be.\n\n---\nNew commits:",
    "created_at": "2017-01-28T23:10:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303872",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:26'></a>Okay, so the problem was in the change I made to the `__iter__` in that iterating over the list is not the same as iterating up to the degree. I don't understand why this results in different behavior. However, for now, I think we can just let it be.

---
New commits:



---

archive/issue_comments_303873.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-01-28T23:10:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303873",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_303874.json:
```json
{
    "body": "<a id='comment:27'></a>Replying to [comment:26 tscrim]:\n> Okay, so the problem was in the change I made to the `__iter__` in that iterating over the list is not the same as iterating up to the degree. I don't understand why this results in different behavior.\n\n\nSince the failure has to do with p-adics, I suspect the reason may be that:\n\n```\nsage: Pol.<x> = Qp(5)[]\nsage: pol = 1 + O(5)*x\nsage: pol.degree()\n0\nsage: list(pol)\n[1 + O(5^20), O(5)]\n```\nI don't know if this is intentional, nor why the implementation of p-adics take this convention. (I'd have expected `degree()` to check that the coefficients are nonzero using `__nonzero__()`, and `__nonzero__()` to return true except when its argument is *exactly* zero, like it does for some other inexact parents.) But perhaps we need to check that our other changes don't break things like this.",
    "created_at": "2017-01-29T10:25:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303874",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:27'></a>Replying to [comment:26 tscrim]:
> Okay, so the problem was in the change I made to the `__iter__` in that iterating over the list is not the same as iterating up to the degree. I don't understand why this results in different behavior.


Since the failure has to do with p-adics, I suspect the reason may be that:

```
sage: Pol.<x> = Qp(5)[]
sage: pol = 1 + O(5)*x
sage: pol.degree()
0
sage: list(pol)
[1 + O(5^20), O(5)]
```
I don't know if this is intentional, nor why the implementation of p-adics take this convention. (I'd have expected `degree()` to check that the coefficients are nonzero using `__nonzero__()`, and `__nonzero__()` to return true except when its argument is *exactly* zero, like it does for some other inexact parents.) But perhaps we need to check that our other changes don't break things like this.



---

archive/issue_comments_303875.json:
```json
{
    "body": "<a id='comment:28'></a>I don't think we made any other functional changes as `get_unsafe` has to be consistent with `__getitem__` (for non-slices). Everything else is extending current behavior or passing type info to Cython.\n\nI'm not sure if that is intentional either. We might need to ask someone more familiar with the p-adics. Although that could be something we push to another ticket too.",
    "created_at": "2017-01-29T14:25:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303875",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:28'></a>I don't think we made any other functional changes as `get_unsafe` has to be consistent with `__getitem__` (for non-slices). Everything else is extending current behavior or passing type info to Cython.

I'm not sure if that is intentional either. We might need to ask someone more familiar with the p-adics. Although that could be something we push to another ticket too.



---

archive/issue_comments_303876.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-01-31T19:19:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303876",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_303877.json:
```json
{
    "body": "<a id='comment:29'></a>Agreed.",
    "created_at": "2017-01-31T19:19:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303877",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:29'></a>Agreed.



---

archive/issue_events_058242.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-02-02T22:09:28Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22152#event-58242"
}
```



---

archive/issue_comments_303878.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-02-02T22:09:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303878",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_303879.json:
```json
{
    "body": "<a id='comment:31'></a>Looks like we have another problem:\n\n```\nsage: Pol = ZZ['x']['y']['z']\n....: d = Pol.gens_dict_recursive()\n....: x, y, z = d['x'], d['y'], d['z']\n....: v = QQ(0)\n....: (x*z)(x=v)\n<BOOM>\n```",
    "created_at": "2017-02-06T14:37:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303879",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:31'></a>Looks like we have another problem:

```
sage: Pol = ZZ['x']['y']['z']
....: d = Pol.gens_dict_recursive()
....: x, y, z = d['x'], d['y'], d['z']
....: v = QQ(0)
....: (x*z)(x=v)
<BOOM>
```



---

archive/issue_comments_303880.json:
```json
{
    "body": "<a id='comment:32'></a>This is something very special about it being 0 with the coercion.",
    "created_at": "2017-02-06T15:12:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303880",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:32'></a>This is something very special about it being 0 with the coercion.



---

archive/issue_comments_303881.json:
```json
{
    "body": "<a id='comment:33'></a>This also works for `p = x*z`:\n\n```\nsage: p(1)(x=v)\n0\n```",
    "created_at": "2017-02-06T15:15:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303881",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:33'></a>This also works for `p = x*z`:

```
sage: p(1)(x=v)
0
```



---

archive/issue_comments_303882.json:
```json
{
    "body": "<a id='comment:34'></a>Followup on #22317.",
    "created_at": "2017-02-06T15:50:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22152",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22152#issuecomment-303882",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:34'></a>Followup on #22317.
