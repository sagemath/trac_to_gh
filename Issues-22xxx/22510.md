# Issue 22510: Enhanced package uninstallation for Sage spkgs

archive/issues_022273.json:
```json
{
    "body": "Currently spkg uninstallation is handled in an ad-hoc manner.  Many packages contain some rough uninstallation steps in their `spkg-install` scripts (to be run, for example, when upgrading/reinstalling a package).  But these are often imprecise and not thorough (though maybe still worth keeping where they already exist, as I will explain below).\n\n\n### implementation\n\n* #22509 - most packages are now installed with staged installation (i.e. DESTDIR installation), which enables creating a manifest of all files installed by that package (minus files created by the package's `spkg-postinst` script).  This is mostly working now for almost all packages (see #24024).\n\n* #25139 - add an spkg-uninstall script: this would read the file manifest for a package (if it exists) and remove those files from `$SAGE_LOCAL`--thus uninstalling the package thoroughly and precisely.\n  * #25139 - support legacy uninstallers: many existing spkgs have steps in their `spkg-install` for \"uninstalling\" that package--mostly just removing a few key files associated with the package (executables and libraries), but was rarely complete.  However, some of these legacy uninstall steps are still necessary for properly building the package if the package has not already been uninstalled.  This is an issue for the new system insofar as we want upgrades from older versions of Sage to work, so the legacy uninstallers are still needed at least for one upgrade, if uninstalling a package that doesn't have a proper file manifest.  Since these steps are no longer needed in the `spkg-install` (in fact ideally `spkg-install` should not modify `$SAGE_LOCAL` at all, we move those steps into a separate `spkg-legacy-uninstall` script which is run only when uninstalling a package that is missing its file manifest.\n    * #25140 - once this infrastructure is in place there are several packages with 'legacy uninstallers' that would need to be updated.\n  * #25139 - also add support for an `spkg-postrm` script that would be the complement to a `spkg-postinst` script, and may clean up files generated by a package that are not part of the package's file manifest\n\n\n### old design discussion\nHere are a few proposals for improving package uninstallation (which is useful even for required packages, such as in the case of upgrading them):\n\n* For all installed packages, maintain lists of the files installed by those packages.  For this, something like #22509 is a prerequisite. This list could even go into the `$SAGE_LOCAL/var/lib/sage/installed/` files we already have.  Uninstalling a package would consist primarily of removing all files in this list.  It would also remove directories that are left empty after all files are removed.\n\n* Add support an optional `spkg-uninstall` script for any spkgs.  This can be used to perform any additional uninstallation steps.  For example, it is a place to remove files / data added specifically for Sage by `spkg-install` (e.g. symlinks) that are not installed by the package's `make install`.  This would be run *before* the full uninstall described in the previous bullet point (in case any files from the package are necessary to determine additional uninstall steps).  So this would be sort of like a pre-uninstall.\n\n* Add support for an optional `spkg-legacy-uninstall` script.  This would contain whatever commands the `spkg-install` scripts currently perform for uninstall.  This would only be run when the installed file list described in the first bullet point is unavailable (e.g. for backwards compatibility when upgrading to this new system for the first time).  This feature could maybe be removed entirely later, but would be good to add at first and keep around for a while.\n\nThe new process for upgrading / reinstalling a package could be (especially if more progress is made toward supporting #21726 in all spkgs):\n\n1. Build\n2. Install to temporary directory (#22509)\n3. Upon successful completion of 1. and 2., uninstall old package\n4. Install new package by copying from temp dir into `$SAGE_LOCAL`\n5. Run post-install scripts, if any\n\nThis means a cleaner rollback from failed upgrades.\n\n**Keywords:** uninstall\n\n**Author:** Erik Bray\n\n**Resolution:** worksforme\n\nIssue created by migration from https://trac.sagemath.org/ticket/22510\n\n",
    "closed_at": "2019-01-09T17:38:20Z",
    "created_at": "2017-03-03T13:45:02Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Enhanced package uninstallation for Sage spkgs",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22510",
    "user": "https://github.com/embray"
}
```
Currently spkg uninstallation is handled in an ad-hoc manner.  Many packages contain some rough uninstallation steps in their `spkg-install` scripts (to be run, for example, when upgrading/reinstalling a package).  But these are often imprecise and not thorough (though maybe still worth keeping where they already exist, as I will explain below).


### implementation

* #22509 - most packages are now installed with staged installation (i.e. DESTDIR installation), which enables creating a manifest of all files installed by that package (minus files created by the package's `spkg-postinst` script).  This is mostly working now for almost all packages (see #24024).

* #25139 - add an spkg-uninstall script: this would read the file manifest for a package (if it exists) and remove those files from `$SAGE_LOCAL`--thus uninstalling the package thoroughly and precisely.
  * #25139 - support legacy uninstallers: many existing spkgs have steps in their `spkg-install` for "uninstalling" that package--mostly just removing a few key files associated with the package (executables and libraries), but was rarely complete.  However, some of these legacy uninstall steps are still necessary for properly building the package if the package has not already been uninstalled.  This is an issue for the new system insofar as we want upgrades from older versions of Sage to work, so the legacy uninstallers are still needed at least for one upgrade, if uninstalling a package that doesn't have a proper file manifest.  Since these steps are no longer needed in the `spkg-install` (in fact ideally `spkg-install` should not modify `$SAGE_LOCAL` at all, we move those steps into a separate `spkg-legacy-uninstall` script which is run only when uninstalling a package that is missing its file manifest.
    * #25140 - once this infrastructure is in place there are several packages with 'legacy uninstallers' that would need to be updated.
  * #25139 - also add support for an `spkg-postrm` script that would be the complement to a `spkg-postinst` script, and may clean up files generated by a package that are not part of the package's file manifest


### old design discussion
Here are a few proposals for improving package uninstallation (which is useful even for required packages, such as in the case of upgrading them):

* For all installed packages, maintain lists of the files installed by those packages.  For this, something like #22509 is a prerequisite. This list could even go into the `$SAGE_LOCAL/var/lib/sage/installed/` files we already have.  Uninstalling a package would consist primarily of removing all files in this list.  It would also remove directories that are left empty after all files are removed.

* Add support an optional `spkg-uninstall` script for any spkgs.  This can be used to perform any additional uninstallation steps.  For example, it is a place to remove files / data added specifically for Sage by `spkg-install` (e.g. symlinks) that are not installed by the package's `make install`.  This would be run *before* the full uninstall described in the previous bullet point (in case any files from the package are necessary to determine additional uninstall steps).  So this would be sort of like a pre-uninstall.

* Add support for an optional `spkg-legacy-uninstall` script.  This would contain whatever commands the `spkg-install` scripts currently perform for uninstall.  This would only be run when the installed file list described in the first bullet point is unavailable (e.g. for backwards compatibility when upgrading to this new system for the first time).  This feature could maybe be removed entirely later, but would be good to add at first and keep around for a while.

The new process for upgrading / reinstalling a package could be (especially if more progress is made toward supporting #21726 in all spkgs):

1. Build
2. Install to temporary directory (#22509)
3. Upon successful completion of 1. and 2., uninstall old package
4. Install new package by copying from temp dir into `$SAGE_LOCAL`
5. Run post-install scripts, if any

This means a cleaner rollback from failed upgrades.

**Keywords:** uninstall

**Author:** Erik Bray

**Resolution:** worksforme

Issue created by migration from https://trac.sagemath.org/ticket/22510





---

archive/issue_comments_420831.json:
```json
{
    "body": "**Dependencies:** #22509",
    "created_at": "2017-03-03T13:45:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22510#issuecomment-420831",
    "user": "https://github.com/embray"
}
```

**Dependencies:** #22509



---

archive/issue_comments_420832.json:
```json
{
    "body": "**Commit:** [ae503162358d7251f8132b02a568a154dda882bf](https://github.com/sagemath/sagetrac-mirror/commit/ae503162358d7251f8132b02a568a154dda882bf)",
    "created_at": "2017-06-01T14:04:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22510#issuecomment-420832",
    "user": "https://github.com/embray"
}
```

**Commit:** [ae503162358d7251f8132b02a568a154dda882bf](https://github.com/sagemath/sagetrac-mirror/commit/ae503162358d7251f8132b02a568a154dda882bf)



---

archive/issue_comments_420833.json:
```json
{
    "body": "**Branch:** [u/embray/build/uninstall](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/build/uninstall)",
    "created_at": "2017-06-01T14:04:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22510#issuecomment-420833",
    "user": "https://github.com/embray"
}
```

**Branch:** [u/embray/build/uninstall](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/build/uninstall)



---

archive/issue_comments_420834.json:
```json
{
    "body": "<a id='comment:2'></a>\nAdding initial work on the `sage-spkg-uninstall` script.\n\nI've already created `spkg-legacy-uninstall` scripts for most standard packages, but I'm still testing this mechanism.  These scripts are just created by taking any uninstall steps found in the `spkg-install` and splitting it out to a separate script.  Implementation of uninstall steps is of course very uneven across packages, and I'm not creating legacy-uninstall scripts for those packages that didn't already have uninstall steps--if it wasn't needed before it isn't needed now.  Many of the existing uninstall steps probably aren't needed either, but are (they reference specific tickets).  To be on the safe side I just took what already exists more or less at face value and didn't change any of the details.\n\nI haven't implemented support for the separate `spkg-uninstall` script yet as it hasn't been needed.  Though there are a handful of packages where it might be useful (for example maxima's `spkg-install` has a step that removes files from `$DOT_SAGE`).\n\n---\n**Last 10 new commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3a32187468218cd79e6a5c0defb1f365a488c147\">3a32187</a></td><td><code>Roll back accidental change from dc46ea2dfa97be79d7ef8ddbe9130d4c717acc3d that broke build of Python 2 on Cygwin.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8a621af7a5f3e10d1337c07b42d04edee6a8f1b8\">8a621af</a></td><td><code>Updated the python2/3 pacakges to use staged install.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1391089b36f43b45fa0eb7bf04e83fc1e351dfea\">1391089</a></td><td><code>Remove the '-v' from the 'cp' command.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e2941230aea00481d6cf1f58992faa006a7b63f2\">e294123</a></td><td><code>Add staged install support for atlas</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/00f6de8d173a25b865c26c6af3f588b49e8401eb\">00f6de8</a></td><td><code>This file should be deleted from the temp install dir during staged install on OSX</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8b06de143381a84489462f4478c7fd4c8fff0c0e\">8b06de1</a></td><td><code>This is pointless now that the symlinks are being installed in SAGE_INST_TEMP, so of course they don't exist</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e91fce48848c6fac9f2a3ea6d9f886ead7aee415\">e91fce4</a></td><td><code>Initial version of the sage-spkg-uninstall script, handling both legacy uninstall, and uninstall using file records in the new stamp file format.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/867f468ab49313aaca11c10d9ba2e4306b48669c\">867f468</a></td><td><code>Add a secret --debug flag to sage-spkg-uninstall, useful for debugging exceptions</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a476ccd7c1ac4fc9cae687cab43d376953285ea7\">a476ccd</a></td><td><code>Graceful fallback if it appears the package is not installed</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ae503162358d7251f8132b02a568a154dda882bf\">ae50316</a></td><td><code>Use sage-spkg-uninstal in sage-spkg</code></td></tr></table>\n",
    "created_at": "2017-06-01T14:04:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22510#issuecomment-420834",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>
Adding initial work on the `sage-spkg-uninstall` script.

I've already created `spkg-legacy-uninstall` scripts for most standard packages, but I'm still testing this mechanism.  These scripts are just created by taking any uninstall steps found in the `spkg-install` and splitting it out to a separate script.  Implementation of uninstall steps is of course very uneven across packages, and I'm not creating legacy-uninstall scripts for those packages that didn't already have uninstall steps--if it wasn't needed before it isn't needed now.  Many of the existing uninstall steps probably aren't needed either, but are (they reference specific tickets).  To be on the safe side I just took what already exists more or less at face value and didn't change any of the details.

I haven't implemented support for the separate `spkg-uninstall` script yet as it hasn't been needed.  Though there are a handful of packages where it might be useful (for example maxima's `spkg-install` has a step that removes files from `$DOT_SAGE`).

---
**Last 10 new commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3a32187468218cd79e6a5c0defb1f365a488c147">3a32187</a></td><td><code>Roll back accidental change from dc46ea2dfa97be79d7ef8ddbe9130d4c717acc3d that broke build of Python 2 on Cygwin.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8a621af7a5f3e10d1337c07b42d04edee6a8f1b8">8a621af</a></td><td><code>Updated the python2/3 pacakges to use staged install.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1391089b36f43b45fa0eb7bf04e83fc1e351dfea">1391089</a></td><td><code>Remove the '-v' from the 'cp' command.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e2941230aea00481d6cf1f58992faa006a7b63f2">e294123</a></td><td><code>Add staged install support for atlas</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/00f6de8d173a25b865c26c6af3f588b49e8401eb">00f6de8</a></td><td><code>This file should be deleted from the temp install dir during staged install on OSX</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8b06de143381a84489462f4478c7fd4c8fff0c0e">8b06de1</a></td><td><code>This is pointless now that the symlinks are being installed in SAGE_INST_TEMP, so of course they don't exist</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e91fce48848c6fac9f2a3ea6d9f886ead7aee415">e91fce4</a></td><td><code>Initial version of the sage-spkg-uninstall script, handling both legacy uninstall, and uninstall using file records in the new stamp file format.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/867f468ab49313aaca11c10d9ba2e4306b48669c">867f468</a></td><td><code>Add a secret --debug flag to sage-spkg-uninstall, useful for debugging exceptions</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a476ccd7c1ac4fc9cae687cab43d376953285ea7">a476ccd</a></td><td><code>Graceful fallback if it appears the package is not installed</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ae503162358d7251f8132b02a568a154dda882bf">ae50316</a></td><td><code>Use sage-spkg-uninstal in sage-spkg</code></td></tr></table>




---

archive/issue_comments_420835.json:
```json
{
    "body": "**Author:** Erik Bray",
    "created_at": "2017-06-01T14:04:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22510#issuecomment-420835",
    "user": "https://github.com/embray"
}
```

**Author:** Erik Bray



---

archive/issue_comments_420836.json:
```json
{
    "body": "<a id='comment:3'></a>\nThere is a *slight* possibility for a race condition here.  If two packages share a directory (other than some top level directory like `lib` that almost all packages use), but say something like `share/pari`, it's possible one package can be trying to install to that directory while the other is uninstalling from it and this could lead to errors.\n\nI haven't seen it come up in practice yet and it's probably pretty rare, but I might consider a mutex around the uninstall/install sections...",
    "created_at": "2017-06-01T16:52:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22510#issuecomment-420836",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>
There is a *slight* possibility for a race condition here.  If two packages share a directory (other than some top level directory like `lib` that almost all packages use), but say something like `share/pari`, it's possible one package can be trying to install to that directory while the other is uninstalling from it and this could lead to errors.

I haven't seen it come up in practice yet and it's probably pretty rare, but I might consider a mutex around the uninstall/install sections...



---

archive/issue_comments_420837.json:
```json
{
    "body": "**Changing commit** from \"[ae503162358d7251f8132b02a568a154dda882bf](https://github.com/sagemath/sagetrac-mirror/commit/ae503162358d7251f8132b02a568a154dda882bf)\" to \"[18530eddafc2e11f08ad01e3c6aa194edd88a5d8](https://github.com/sagemath/sagetrac-mirror/commit/18530eddafc2e11f08ad01e3c6aa194edd88a5d8)\".",
    "created_at": "2017-06-02T07:31:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22510#issuecomment-420837",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[ae503162358d7251f8132b02a568a154dda882bf](https://github.com/sagemath/sagetrac-mirror/commit/ae503162358d7251f8132b02a568a154dda882bf)" to "[18530eddafc2e11f08ad01e3c6aa194edd88a5d8](https://github.com/sagemath/sagetrac-mirror/commit/18530eddafc2e11f08ad01e3c6aa194edd88a5d8)".



---

archive/issue_comments_420838.json:
```json
{
    "body": "<a id='comment:4'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/18530eddafc2e11f08ad01e3c6aa194edd88a5d8\">18530ed</a></td><td><code>Adds separate spkg-legacy-uninstall scripts for most standard packages that even had explicit uninstall steps in their spkg-installs.</code></td></tr></table>\n",
    "created_at": "2017-06-02T07:31:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22510#issuecomment-420838",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/18530eddafc2e11f08ad01e3c6aa194edd88a5d8">18530ed</a></td><td><code>Adds separate spkg-legacy-uninstall scripts for most standard packages that even had explicit uninstall steps in their spkg-installs.</code></td></tr></table>




---

archive/issue_comments_420839.json:
```json
{
    "body": "<a id='comment:5'></a>\nOut of curiosity I had a look to see if any packages are installing (and hence uninstalling) the same file, as I figured there might be some such cases and indeed there are.  I don't have an exhaustive list, because I have not installed every optional and experimental package.\n\nThe duplicate files fall into a few different categories:\n\n1. Most are due to packages that conflict with/replace another package.  Either because two packages provide the same functionality (e.g. openblas/atlas, mpir/gmp) or because one package is a stripped down version of another (e.g. boost_cropped/boost, pari_seadata_small/database_pari). \n\n   I think it might be good if we had explicit conflicts/replaces markers for some packages.  If a package conflicts with an installed package, it will not be installed unless forced.  If a package *replaces* another package, the package it replaces is explicitly uninstalled first.  In effect this already happens implicitly.  If I install pari_seadata_small, and then install database_pari, the latter will override the former.  But I think it would be better to do this explicitly.\n\n2. `share/info/dir`--this is a file shared by many packages.  It is written/updated by the `install-info` program.  Of course, when installing into a temp root, there will be no existing `share/info/dir` file, and `install-info` will create it.  But then each package that installs it overrides each other. \n\n   Debian handles this file by stripping it from the installation, then calling `install-info` from a post-install (and pre-uninstall) script.  This is the sort of thing for which I anticipated possibly needing post-install/uninstall hooks.  That said, this is the only example like this I've encountered so far in Sage-the-dist.  So I might just make a special case for it for now, directly in `sage-spkg`, rather than placing the onus on each package that updates this file to do it correctly.\n\n3. `__init__.py` in Python namespace packages (e.g. backports_ssl_match_hostname/backports_shutil_get_terminal_size).  If both are installed and one clobbers the other that's fine, but if one is then uninstalled it should *not* remove the shared `__init__.py`.  I'll have to look at how Debian handles this.  It might be handled contextually--these files usually contain some boilerplate like `__path__ = extend_path(__path__, `__name__`)`.  But the boilerplate is not always spelled exactly the same, so it might be tricky to check for.  Maybe this just needs to be handled explicitly on a case-by-case basis.\n\n4. `bin/2to3`--just one special case of a script that is being installed by both Python 2 and Python 3.  This should of course be fixed in those packages.",
    "created_at": "2017-06-06T11:50:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22510#issuecomment-420839",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>
Out of curiosity I had a look to see if any packages are installing (and hence uninstalling) the same file, as I figured there might be some such cases and indeed there are.  I don't have an exhaustive list, because I have not installed every optional and experimental package.

The duplicate files fall into a few different categories:

1. Most are due to packages that conflict with/replace another package.  Either because two packages provide the same functionality (e.g. openblas/atlas, mpir/gmp) or because one package is a stripped down version of another (e.g. boost_cropped/boost, pari_seadata_small/database_pari). 

   I think it might be good if we had explicit conflicts/replaces markers for some packages.  If a package conflicts with an installed package, it will not be installed unless forced.  If a package *replaces* another package, the package it replaces is explicitly uninstalled first.  In effect this already happens implicitly.  If I install pari_seadata_small, and then install database_pari, the latter will override the former.  But I think it would be better to do this explicitly.

2. `share/info/dir`--this is a file shared by many packages.  It is written/updated by the `install-info` program.  Of course, when installing into a temp root, there will be no existing `share/info/dir` file, and `install-info` will create it.  But then each package that installs it overrides each other. 

   Debian handles this file by stripping it from the installation, then calling `install-info` from a post-install (and pre-uninstall) script.  This is the sort of thing for which I anticipated possibly needing post-install/uninstall hooks.  That said, this is the only example like this I've encountered so far in Sage-the-dist.  So I might just make a special case for it for now, directly in `sage-spkg`, rather than placing the onus on each package that updates this file to do it correctly.

3. `__init__.py` in Python namespace packages (e.g. backports_ssl_match_hostname/backports_shutil_get_terminal_size).  If both are installed and one clobbers the other that's fine, but if one is then uninstalled it should *not* remove the shared `__init__.py`.  I'll have to look at how Debian handles this.  It might be handled contextually--these files usually contain some boilerplate like `__path__ = extend_path(__path__, `__name__`)`.  But the boilerplate is not always spelled exactly the same, so it might be tricky to check for.  Maybe this just needs to be handled explicitly on a case-by-case basis.

4. `bin/2to3`--just one special case of a script that is being installed by both Python 2 and Python 3.  This should of course be fixed in those packages.



---

archive/issue_comments_420840.json:
```json
{
    "body": "<a id='comment:6'></a>\nReplying to [embray](#comment%3A5):\n> 2. `share/info/dir`--this is a file shared by many packages.  It is written/updated by the `install-info` program.  Of course, when installing into a temp root, there will be no existing `share/info/dir` file, and `install-info` will create it.  But then each package that installs it overrides each other. \n\n\n   Debian handles this file by stripping it from the installation, then calling `install-info` from a post-install (and pre-uninstall) script.  This is the sort of thing for which I anticipated possibly needing post-install/uninstall hooks.  That said, this is the only example like this I've encountered so far in Sage-the-dist.  So I might just make a special case for it for now, directly in `sage-spkg`, rather than placing the onus on each package that updates this file to do it correctly.\n\nIn retrospect, I've come back around to thinking there should be a mechanism for `post-install/pre-uninstall` scripts.  For common examples like `share/info/dir` there can be a boilerplate that's linked to or something.\n\nAnother example I found where this would be useful, which granted is an experimental package, while be `compilerwrapper`.  This package conflicts with `gcc` unless the step of creating the wrapper scripts is done as a post-install step (and undone, if necessary, pre-uninstall).",
    "created_at": "2017-06-07T12:59:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22510#issuecomment-420840",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>
Replying to [embray](#comment%3A5):
> 2. `share/info/dir`--this is a file shared by many packages.  It is written/updated by the `install-info` program.  Of course, when installing into a temp root, there will be no existing `share/info/dir` file, and `install-info` will create it.  But then each package that installs it overrides each other. 


   Debian handles this file by stripping it from the installation, then calling `install-info` from a post-install (and pre-uninstall) script.  This is the sort of thing for which I anticipated possibly needing post-install/uninstall hooks.  That said, this is the only example like this I've encountered so far in Sage-the-dist.  So I might just make a special case for it for now, directly in `sage-spkg`, rather than placing the onus on each package that updates this file to do it correctly.

In retrospect, I've come back around to thinking there should be a mechanism for `post-install/pre-uninstall` scripts.  For common examples like `share/info/dir` there can be a boilerplate that's linked to or something.

Another example I found where this would be useful, which granted is an experimental package, while be `compilerwrapper`.  This package conflicts with `gcc` unless the step of creating the wrapper scripts is done as a post-install step (and undone, if necessary, pre-uninstall).



---

archive/issue_comments_420841.json:
```json
{
    "body": "<a id='comment:7'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **Last 10 new commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/843936734f87d712cee4e152c0d9947a743ab310\">8439367</a></td><td><code>A little better debug output here</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0c4fcd6ff78e5d894d61956e493522ae60c801bd\">0c4fcd6</a></td><td><code>Added the ability for packages to have an spkg-postrm script that is called</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0e73f89a9cc00eb0098aa5cdd0fae1bea0cc50b6\">0e73f89</a></td><td><code>Change how pkgconf is installed to better handle uninstallation.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3f073189f2b082dd4f52c2c96b2a98b014e5f322\">3f07318</a></td><td><code>Handle errors when running the spkg-postrm script.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b79d581354cd6e6a57322443fbf07f6b11e3cc5c\">b79d581</a></td><td><code>Restore IFS after this loop so that later loops aren't broken.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/edada31de57737f2b71f4365ca3628c6d039a98e\">edada31</a></td><td><code>Better handling of missing directories when uninstalling broken packages</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b043628756a129378021995125241ac18ea33d16\">b043628</a></td><td><code>Add the ability for packages to have a pre-uninstall script too.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0b316b584ffaa07e0a617a6bd6f7b984ad5d8ecd\">0b316b5</a></td><td><code>It seems the best way to handle notebook extensions is to disable them in a prerm script.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e1a97163a7754a7fa95a1e86784add332c48e71f\">e1a9716</a></td><td><code>These packages should have their versions bumped now that they require installing pre/post-uninstall scripts.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/620287c2606f30fe3ea5623c87015dbc1b73817c\">620287c</a></td><td><code>Move execution of spkg- scripts to a simple utility function, avoiding a bit of boilerplate</code></td></tr></table>\n",
    "created_at": "2017-09-05T08:41:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22510#issuecomment-420841",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **Last 10 new commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/843936734f87d712cee4e152c0d9947a743ab310">8439367</a></td><td><code>A little better debug output here</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0c4fcd6ff78e5d894d61956e493522ae60c801bd">0c4fcd6</a></td><td><code>Added the ability for packages to have an spkg-postrm script that is called</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0e73f89a9cc00eb0098aa5cdd0fae1bea0cc50b6">0e73f89</a></td><td><code>Change how pkgconf is installed to better handle uninstallation.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3f073189f2b082dd4f52c2c96b2a98b014e5f322">3f07318</a></td><td><code>Handle errors when running the spkg-postrm script.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b79d581354cd6e6a57322443fbf07f6b11e3cc5c">b79d581</a></td><td><code>Restore IFS after this loop so that later loops aren't broken.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/edada31de57737f2b71f4365ca3628c6d039a98e">edada31</a></td><td><code>Better handling of missing directories when uninstalling broken packages</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b043628756a129378021995125241ac18ea33d16">b043628</a></td><td><code>Add the ability for packages to have a pre-uninstall script too.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0b316b584ffaa07e0a617a6bd6f7b984ad5d8ecd">0b316b5</a></td><td><code>It seems the best way to handle notebook extensions is to disable them in a prerm script.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e1a97163a7754a7fa95a1e86784add332c48e71f">e1a9716</a></td><td><code>These packages should have their versions bumped now that they require installing pre/post-uninstall scripts.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/620287c2606f30fe3ea5623c87015dbc1b73817c">620287c</a></td><td><code>Move execution of spkg- scripts to a simple utility function, avoiding a bit of boilerplate</code></td></tr></table>




---

archive/issue_comments_420842.json:
```json
{
    "body": "**Changing commit** from \"[18530eddafc2e11f08ad01e3c6aa194edd88a5d8](https://github.com/sagemath/sagetrac-mirror/commit/18530eddafc2e11f08ad01e3c6aa194edd88a5d8)\" to \"[620287c2606f30fe3ea5623c87015dbc1b73817c](https://github.com/sagemath/sagetrac-mirror/commit/620287c2606f30fe3ea5623c87015dbc1b73817c)\".",
    "created_at": "2017-09-05T08:41:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22510#issuecomment-420842",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[18530eddafc2e11f08ad01e3c6aa194edd88a5d8](https://github.com/sagemath/sagetrac-mirror/commit/18530eddafc2e11f08ad01e3c6aa194edd88a5d8)" to "[620287c2606f30fe3ea5623c87015dbc1b73817c](https://github.com/sagemath/sagetrac-mirror/commit/620287c2606f30fe3ea5623c87015dbc1b73817c)".



---

archive/issue_comments_420843.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2017-09-05T08:45:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22510#issuecomment-420843",
    "user": "https://github.com/embray"
}
```

**Changing status** from new to needs_review.



---

archive/issue_events_066902.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-09-05T08:45:12Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "milestone": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22510#event-66902"
}
```



---

archive/issue_comments_420844.json:
```json
{
    "body": "<a id='comment:8'></a>\nRebased on latest #22509; addressed issue of properly uninstalling the widgetsnbextension.  It's working pretty well now, after multiple around of install/uninstall and upgrading from old builds from before these changes.\n\nOf course #22509 should be reviewed and merged first as it lays most of the groundwork for this.  If diff'd against #22509 the changes in this ticket don't look as big.",
    "created_at": "2017-09-05T08:45:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22510#issuecomment-420844",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>
Rebased on latest #22509; addressed issue of properly uninstalling the widgetsnbextension.  It's working pretty well now, after multiple around of install/uninstall and upgrading from old builds from before these changes.

Of course #22509 should be reviewed and merged first as it lays most of the groundwork for this.  If diff'd against #22509 the changes in this ticket don't look as big.



---

archive/issue_comments_420845.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -12,5 +12,6 @@\n 2. Install to temporary directory (#22509)\n 3. Upon successful completion of 1. and 2., uninstall old package\n 4. Install new package by copying from temp dir into `$SAGE_LOCAL`\n+5. Run post-install scripts, if any\n \n This means a cleaner rollback from failed upgrades.\n``````\n",
    "created_at": "2017-09-05T08:45:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22510#issuecomment-420845",
    "user": "https://github.com/embray"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -12,5 +12,6 @@
 2. Install to temporary directory (#22509)
 3. Upon successful completion of 1. and 2., uninstall old package
 4. Install new package by copying from temp dir into `$SAGE_LOCAL`
+5. Run post-install scripts, if any
 
 This means a cleaner rollback from failed upgrades.
``````




---

archive/issue_comments_420846.json:
```json
{
    "body": "<a id='comment:9'></a>\nNeeds to be rebased (but maybe not right now).",
    "created_at": "2017-11-28T10:17:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22510#issuecomment-420846",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>
Needs to be rebased (but maybe not right now).



---

archive/issue_comments_420847.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2017-11-28T10:17:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22510#issuecomment-420847",
    "user": "https://github.com/jdemeyer"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_420848.json:
```json
{
    "body": "<a id='comment:10'></a>\nYes, there's more work needed to be done in breaking up #22509 into smaller bites before this ticket can even work again (at least for all packages--it will probably work for *most* packages with #24106).",
    "created_at": "2017-11-28T13:44:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22510#issuecomment-420848",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'></a>
Yes, there's more work needed to be done in breaking up #22509 into smaller bites before this ticket can even work again (at least for all packages--it will probably work for *most* packages with #24106).



---

archive/issue_events_066903.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-12-12T08:27:24Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "milestone": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22510#event-66903"
}
```



---

archive/issue_events_066904.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-12-12T08:27:24Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "milestone": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22510#event-66904"
}
```



---

archive/issue_comments_420849.json:
```json
{
    "body": "**Changing dependencies** from \"#22509\" to \"\".",
    "created_at": "2018-04-05T14:52:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22510#issuecomment-420849",
    "user": "https://github.com/embray"
}
```

**Changing dependencies** from "#22509" to "".



---

archive/issue_comments_420850.json:
```json
{
    "body": "<a id='comment:12'></a>\nI've had this on hold pending total completion of #22509 but it's still taking some time to get all the packages updated for DESTDIR support (see #24024).  However, for many packages this is already working, and the general infrastructure is in place.  So there's no reason not to move forward with the uninstallation work--the only problem is that packages that aren't installed with staged installation won't be properly uninstallable...yet.\n\nSimilarly, this work can be split up into a few smaller tickets, so I will move forward on that.",
    "created_at": "2018-04-05T14:52:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22510#issuecomment-420850",
    "user": "https://github.com/embray"
}
```

<a id='comment:12'></a>
I've had this on hold pending total completion of #22509 but it's still taking some time to get all the packages updated for DESTDIR support (see #24024).  However, for many packages this is already working, and the general infrastructure is in place.  So there's no reason not to move forward with the uninstallation work--the only problem is that packages that aren't installed with staged installation won't be properly uninstallable...yet.

Similarly, this work can be split up into a few smaller tickets, so I will move forward on that.



---

archive/issue_comments_420851.json:
```json
{
    "body": "**Changing commit** from \"[620287c2606f30fe3ea5623c87015dbc1b73817c](https://github.com/sagemath/sagetrac-mirror/commit/620287c2606f30fe3ea5623c87015dbc1b73817c)\" to \"\".",
    "created_at": "2018-04-05T15:31:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22510#issuecomment-420851",
    "user": "https://github.com/embray"
}
```

**Changing commit** from "[620287c2606f30fe3ea5623c87015dbc1b73817c](https://github.com/sagemath/sagetrac-mirror/commit/620287c2606f30fe3ea5623c87015dbc1b73817c)" to "".



---

archive/issue_comments_420852.json:
```json
{
    "body": "<a id='comment:13'></a>\nSome new explanation of the work planned for this ticket, so I can break it up into multiple smaller chunks.",
    "created_at": "2018-04-05T15:31:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22510#issuecomment-420852",
    "user": "https://github.com/embray"
}
```

<a id='comment:13'></a>
Some new explanation of the work planned for this ticket, so I can break it up into multiple smaller chunks.



---

archive/issue_comments_420853.json:
```json
{
    "body": "**Changing branch** from \"[u/embray/build/uninstall](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/build/uninstall)\" to \"\".",
    "created_at": "2018-04-05T15:31:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22510#issuecomment-420853",
    "user": "https://github.com/embray"
}
```

**Changing branch** from "[u/embray/build/uninstall](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/build/uninstall)" to "".



---

archive/issue_comments_420854.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,18 @@\n-Currently spkg uninstallation is handled in an ad-hoc manner.  Many packages contain some rough uninstallation steps in their `spkg-install` scripts (to be run, for example, when upgrading/reinstalling a package).  But these are often imprecise and not thorough (though maybe still worth keeping where they already exist, as I will explain below).  Here are a few proposals for improving package uninstallation (which is useful even for required packages, such as in the case of upgrading them):\n+Currently spkg uninstallation is handled in an ad-hoc manner.  Many packages contain some rough uninstallation steps in their `spkg-install` scripts (to be run, for example, when upgrading/reinstalling a package).  But these are often imprecise and not thorough (though maybe still worth keeping where they already exist, as I will explain below).\n+\n+\n+### implementation\n+\n+* #22509 - most packages are now installed with staged installation (i.e. DESTDIR installation), which enables creating a manifest of all files installed by that package (minus files created by the package's `spkg-postinst` script).  This is mostly working now for almost all packages (see #24024).\n+\n+* #????? - add an spkg-uninstall script: this would read the file manifest for a package (if it exists) and remove those files from `$SAGE_LOCAL`--thus uninstalling the package thoroughly and precisely.\n+  * #????? - support legacy uninstallers: many existing spkgs have steps in their `spkg-install` for \"uninstalling\" that package--mostly just removing a few key files associated with the package (executables and libraries), but was rarely complete.  However, some of these legacy uninstall steps are still necessary for properly building the package if the package has not already been uninstalled.  This is an issue for the new system insofar as we want upgrades from older versions of Sage to work, so the legacy uninstallers are still needed at least for one upgrade, if uninstalling a package that doesn't have a proper file manifest.  Since these steps are no longer needed in the `spkg-install` (in fact ideally `spkg-install` should not modify `$SAGE_LOCAL` at all, we move those steps into a separate `spkg-legacy-uninstall` script which is run only when uninstalling a package that is missing its file manifest.\n+    * #????? - once this infrastructure is in place there are several packages with 'legacy uninstallers' that would need to be updated.\n+  * #????? - also add support for an `spkg-postrm` script that would be the complement to a `spkg-postinst` script, and may clean up files generated by a package that are not part of the package's file manifest\n+\n+\n+### old design discussion\n+Here are a few proposals for improving package uninstallation (which is useful even for required packages, such as in the case of upgrading them):\n \n * For all installed packages, maintain lists of the files installed by those packages.  For this, something like #22509 is a prerequisite. This list could even go into the `$SAGE_LOCAL/var/lib/sage/installed/` files we already have.  Uninstalling a package would consist primarily of removing all files in this list.  It would also remove directories that are left empty after all files are removed.\n \n@@ -6,7 +20,7 @@\n \n * Add support for an optional `spkg-legacy-uninstall` script.  This would contain whatever commands the `spkg-install` scripts currently perform for uninstall.  This would only be run when the installed file list described in the first bullet point is unavailable (e.g. for backwards compatibility when upgrading to this new system for the first time).  This feature could maybe be removed entirely later, but would be good to add at first and keep around for a while.\n \n-The new process for upgrading / reinstalling a package could b (especially if more progress is made toward supporting #21726 in all spkgs):\n+The new process for upgrading / reinstalling a package could be (especially if more progress is made toward supporting #21726 in all spkgs):\n \n 1. Build\n 2. Install to temporary directory (#22509)\n``````\n",
    "created_at": "2018-04-05T15:31:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22510#issuecomment-420854",
    "user": "https://github.com/embray"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,18 @@
-Currently spkg uninstallation is handled in an ad-hoc manner.  Many packages contain some rough uninstallation steps in their `spkg-install` scripts (to be run, for example, when upgrading/reinstalling a package).  But these are often imprecise and not thorough (though maybe still worth keeping where they already exist, as I will explain below).  Here are a few proposals for improving package uninstallation (which is useful even for required packages, such as in the case of upgrading them):
+Currently spkg uninstallation is handled in an ad-hoc manner.  Many packages contain some rough uninstallation steps in their `spkg-install` scripts (to be run, for example, when upgrading/reinstalling a package).  But these are often imprecise and not thorough (though maybe still worth keeping where they already exist, as I will explain below).
+
+
+### implementation
+
+* #22509 - most packages are now installed with staged installation (i.e. DESTDIR installation), which enables creating a manifest of all files installed by that package (minus files created by the package's `spkg-postinst` script).  This is mostly working now for almost all packages (see #24024).
+
+* #????? - add an spkg-uninstall script: this would read the file manifest for a package (if it exists) and remove those files from `$SAGE_LOCAL`--thus uninstalling the package thoroughly and precisely.
+  * #????? - support legacy uninstallers: many existing spkgs have steps in their `spkg-install` for "uninstalling" that package--mostly just removing a few key files associated with the package (executables and libraries), but was rarely complete.  However, some of these legacy uninstall steps are still necessary for properly building the package if the package has not already been uninstalled.  This is an issue for the new system insofar as we want upgrades from older versions of Sage to work, so the legacy uninstallers are still needed at least for one upgrade, if uninstalling a package that doesn't have a proper file manifest.  Since these steps are no longer needed in the `spkg-install` (in fact ideally `spkg-install` should not modify `$SAGE_LOCAL` at all, we move those steps into a separate `spkg-legacy-uninstall` script which is run only when uninstalling a package that is missing its file manifest.
+    * #????? - once this infrastructure is in place there are several packages with 'legacy uninstallers' that would need to be updated.
+  * #????? - also add support for an `spkg-postrm` script that would be the complement to a `spkg-postinst` script, and may clean up files generated by a package that are not part of the package's file manifest
+
+
+### old design discussion
+Here are a few proposals for improving package uninstallation (which is useful even for required packages, such as in the case of upgrading them):
 
 * For all installed packages, maintain lists of the files installed by those packages.  For this, something like #22509 is a prerequisite. This list could even go into the `$SAGE_LOCAL/var/lib/sage/installed/` files we already have.  Uninstalling a package would consist primarily of removing all files in this list.  It would also remove directories that are left empty after all files are removed.
 
@@ -6,7 +20,7 @@
 
 * Add support for an optional `spkg-legacy-uninstall` script.  This would contain whatever commands the `spkg-install` scripts currently perform for uninstall.  This would only be run when the installed file list described in the first bullet point is unavailable (e.g. for backwards compatibility when upgrading to this new system for the first time).  This feature could maybe be removed entirely later, but would be good to add at first and keep around for a while.
 
-The new process for upgrading / reinstalling a package could b (especially if more progress is made toward supporting #21726 in all spkgs):
+The new process for upgrading / reinstalling a package could be (especially if more progress is made toward supporting #21726 in all spkgs):
 
 1. Build
 2. Install to temporary directory (#22509)
``````




---

archive/issue_comments_420855.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -5,10 +5,10 @@\n \n * #22509 - most packages are now installed with staged installation (i.e. DESTDIR installation), which enables creating a manifest of all files installed by that package (minus files created by the package's `spkg-postinst` script).  This is mostly working now for almost all packages (see #24024).\n \n-* #????? - add an spkg-uninstall script: this would read the file manifest for a package (if it exists) and remove those files from `$SAGE_LOCAL`--thus uninstalling the package thoroughly and precisely.\n-  * #????? - support legacy uninstallers: many existing spkgs have steps in their `spkg-install` for \"uninstalling\" that package--mostly just removing a few key files associated with the package (executables and libraries), but was rarely complete.  However, some of these legacy uninstall steps are still necessary for properly building the package if the package has not already been uninstalled.  This is an issue for the new system insofar as we want upgrades from older versions of Sage to work, so the legacy uninstallers are still needed at least for one upgrade, if uninstalling a package that doesn't have a proper file manifest.  Since these steps are no longer needed in the `spkg-install` (in fact ideally `spkg-install` should not modify `$SAGE_LOCAL` at all, we move those steps into a separate `spkg-legacy-uninstall` script which is run only when uninstalling a package that is missing its file manifest.\n+* #25139 - add an spkg-uninstall script: this would read the file manifest for a package (if it exists) and remove those files from `$SAGE_LOCAL`--thus uninstalling the package thoroughly and precisely.\n+  * #25139 - support legacy uninstallers: many existing spkgs have steps in their `spkg-install` for \"uninstalling\" that package--mostly just removing a few key files associated with the package (executables and libraries), but was rarely complete.  However, some of these legacy uninstall steps are still necessary for properly building the package if the package has not already been uninstalled.  This is an issue for the new system insofar as we want upgrades from older versions of Sage to work, so the legacy uninstallers are still needed at least for one upgrade, if uninstalling a package that doesn't have a proper file manifest.  Since these steps are no longer needed in the `spkg-install` (in fact ideally `spkg-install` should not modify `$SAGE_LOCAL` at all, we move those steps into a separate `spkg-legacy-uninstall` script which is run only when uninstalling a package that is missing its file manifest.\n     * #????? - once this infrastructure is in place there are several packages with 'legacy uninstallers' that would need to be updated.\n-  * #????? - also add support for an `spkg-postrm` script that would be the complement to a `spkg-postinst` script, and may clean up files generated by a package that are not part of the package's file manifest\n+  * #25139 - also add support for an `spkg-postrm` script that would be the complement to a `spkg-postinst` script, and may clean up files generated by a package that are not part of the package's file manifest\n \n \n ### old design discussion\n``````\n",
    "created_at": "2018-04-10T17:12:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22510#issuecomment-420855",
    "user": "https://github.com/embray"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -5,10 +5,10 @@
 
 * #22509 - most packages are now installed with staged installation (i.e. DESTDIR installation), which enables creating a manifest of all files installed by that package (minus files created by the package's `spkg-postinst` script).  This is mostly working now for almost all packages (see #24024).
 
-* #????? - add an spkg-uninstall script: this would read the file manifest for a package (if it exists) and remove those files from `$SAGE_LOCAL`--thus uninstalling the package thoroughly and precisely.
-  * #????? - support legacy uninstallers: many existing spkgs have steps in their `spkg-install` for "uninstalling" that package--mostly just removing a few key files associated with the package (executables and libraries), but was rarely complete.  However, some of these legacy uninstall steps are still necessary for properly building the package if the package has not already been uninstalled.  This is an issue for the new system insofar as we want upgrades from older versions of Sage to work, so the legacy uninstallers are still needed at least for one upgrade, if uninstalling a package that doesn't have a proper file manifest.  Since these steps are no longer needed in the `spkg-install` (in fact ideally `spkg-install` should not modify `$SAGE_LOCAL` at all, we move those steps into a separate `spkg-legacy-uninstall` script which is run only when uninstalling a package that is missing its file manifest.
+* #25139 - add an spkg-uninstall script: this would read the file manifest for a package (if it exists) and remove those files from `$SAGE_LOCAL`--thus uninstalling the package thoroughly and precisely.
+  * #25139 - support legacy uninstallers: many existing spkgs have steps in their `spkg-install` for "uninstalling" that package--mostly just removing a few key files associated with the package (executables and libraries), but was rarely complete.  However, some of these legacy uninstall steps are still necessary for properly building the package if the package has not already been uninstalled.  This is an issue for the new system insofar as we want upgrades from older versions of Sage to work, so the legacy uninstallers are still needed at least for one upgrade, if uninstalling a package that doesn't have a proper file manifest.  Since these steps are no longer needed in the `spkg-install` (in fact ideally `spkg-install` should not modify `$SAGE_LOCAL` at all, we move those steps into a separate `spkg-legacy-uninstall` script which is run only when uninstalling a package that is missing its file manifest.
     * #????? - once this infrastructure is in place there are several packages with 'legacy uninstallers' that would need to be updated.
-  * #????? - also add support for an `spkg-postrm` script that would be the complement to a `spkg-postinst` script, and may clean up files generated by a package that are not part of the package's file manifest
+  * #25139 - also add support for an `spkg-postrm` script that would be the complement to a `spkg-postinst` script, and may clean up files generated by a package that are not part of the package's file manifest
 
 
 ### old design discussion
``````




---

archive/issue_comments_420856.json:
```json
{
    "body": "**Changing keywords** from \"\" to \"uninstall\".",
    "created_at": "2018-04-10T17:12:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22510#issuecomment-420856",
    "user": "https://github.com/embray"
}
```

**Changing keywords** from "" to "uninstall".



---

archive/issue_comments_420857.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -7,7 +7,7 @@\n \n * #25139 - add an spkg-uninstall script: this would read the file manifest for a package (if it exists) and remove those files from `$SAGE_LOCAL`--thus uninstalling the package thoroughly and precisely.\n   * #25139 - support legacy uninstallers: many existing spkgs have steps in their `spkg-install` for \"uninstalling\" that package--mostly just removing a few key files associated with the package (executables and libraries), but was rarely complete.  However, some of these legacy uninstall steps are still necessary for properly building the package if the package has not already been uninstalled.  This is an issue for the new system insofar as we want upgrades from older versions of Sage to work, so the legacy uninstallers are still needed at least for one upgrade, if uninstalling a package that doesn't have a proper file manifest.  Since these steps are no longer needed in the `spkg-install` (in fact ideally `spkg-install` should not modify `$SAGE_LOCAL` at all, we move those steps into a separate `spkg-legacy-uninstall` script which is run only when uninstalling a package that is missing its file manifest.\n-    * #????? - once this infrastructure is in place there are several packages with 'legacy uninstallers' that would need to be updated.\n+    * #25140 - once this infrastructure is in place there are several packages with 'legacy uninstallers' that would need to be updated.\n   * #25139 - also add support for an `spkg-postrm` script that would be the complement to a `spkg-postinst` script, and may clean up files generated by a package that are not part of the package's file manifest\n \n \n``````\n",
    "created_at": "2018-04-10T17:49:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22510#issuecomment-420857",
    "user": "https://github.com/embray"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -7,7 +7,7 @@
 
 * #25139 - add an spkg-uninstall script: this would read the file manifest for a package (if it exists) and remove those files from `$SAGE_LOCAL`--thus uninstalling the package thoroughly and precisely.
   * #25139 - support legacy uninstallers: many existing spkgs have steps in their `spkg-install` for "uninstalling" that package--mostly just removing a few key files associated with the package (executables and libraries), but was rarely complete.  However, some of these legacy uninstall steps are still necessary for properly building the package if the package has not already been uninstalled.  This is an issue for the new system insofar as we want upgrades from older versions of Sage to work, so the legacy uninstallers are still needed at least for one upgrade, if uninstalling a package that doesn't have a proper file manifest.  Since these steps are no longer needed in the `spkg-install` (in fact ideally `spkg-install` should not modify `$SAGE_LOCAL` at all, we move those steps into a separate `spkg-legacy-uninstall` script which is run only when uninstalling a package that is missing its file manifest.
-    * #????? - once this infrastructure is in place there are several packages with 'legacy uninstallers' that would need to be updated.
+    * #25140 - once this infrastructure is in place there are several packages with 'legacy uninstallers' that would need to be updated.
   * #25139 - also add support for an `spkg-postrm` script that would be the complement to a `spkg-postinst` script, and may clean up files generated by a package that are not part of the package's file manifest
 
 
``````




---

archive/issue_events_066905.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-26T12:13:55Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "milestone": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22510#event-66905"
}
```



---

archive/issue_events_066906.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-26T12:13:55Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "milestone": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22510#event-66906"
}
```



---

archive/issue_events_066907.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-07-18T11:47:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "milestone": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22510#event-66907"
}
```



---

archive/issue_events_066908.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-07-18T11:47:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "milestone": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22510#event-66908"
}
```



---

archive/issue_comments_420858.json:
```json
{
    "body": "<a id='comment:17'></a>\nI believe this issue can reasonably be addressed for Sage 8.4.",
    "created_at": "2018-07-18T11:47:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22510#issuecomment-420858",
    "user": "https://github.com/embray"
}
```

<a id='comment:17'></a>
I believe this issue can reasonably be addressed for Sage 8.4.



---

archive/issue_events_066909.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-10-28T11:41:42Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "milestone": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22510#event-66909"
}
```



---

archive/issue_events_066910.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-10-28T11:41:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "milestone": "sage-8.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22510#event-66910"
}
```



---

archive/issue_events_066911.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-12-28T14:10:15Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "milestone": "sage-8.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22510#event-66911"
}
```



---

archive/issue_events_066912.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-12-28T14:10:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "milestone": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22510#event-66912"
}
```



---

archive/issue_comments_420859.json:
```json
{
    "body": "<a id='comment:19'></a>\nRetargeting some of my tickets (somewhat optimistically for now).",
    "created_at": "2018-12-28T14:10:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22510#issuecomment-420859",
    "user": "https://github.com/embray"
}
```

<a id='comment:19'></a>
Retargeting some of my tickets (somewhat optimistically for now).



---

archive/issue_events_066913.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-01-09T17:38:20Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22510#event-66913"
}
```



---

archive/issue_events_066914.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-01-09T17:38:20Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "milestone": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22510#event-66914"
}
```



---

archive/issue_events_066915.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-01-09T17:38:20Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22510#event-66915"
}
```



---

archive/issue_comments_420860.json:
```json
{
    "body": "<a id='comment:20'></a>\nThis is essentially done since #25139.  There are still some packages that should have `spkg-legacy-uninstall` scripts, but that is tracked in #25140.  Some packages still need to be ported to the new install system in order to be properly uninstallable, but that is being tracked in #24024.",
    "created_at": "2019-01-09T17:38:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22510#issuecomment-420860",
    "user": "https://github.com/embray"
}
```

<a id='comment:20'></a>
This is essentially done since #25139.  There are still some packages that should have `spkg-legacy-uninstall` scripts, but that is tracked in #25140.  Some packages still need to be ported to the new install system in order to be properly uninstallable, but that is being tracked in #24024.



---

archive/issue_comments_420861.json:
```json
{
    "body": "**Resolution:** worksforme",
    "created_at": "2019-01-09T17:38:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22510",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22510#issuecomment-420861",
    "user": "https://github.com/embray"
}
```

**Resolution:** worksforme
