# Issue 22198: Make cypari2 Python2 / Python3 compatible

archive/issues_021961.json:
```json
{
    "body": "Currently string handling in `cypari2` is done via `PyString_AsString` which does not exist in Python 3. We rely on Cython to make proper conversions to `bytes`.\n\nCC:  @defeo @jdemeyer\n\nBranch/Commit: 7096c82b4ec94c5d148231b7df518ca5154aad2a\n\nReviewer: Jeroen Demeyer, Vincent Delecroix\n\nAuthor: Vincent Delecroix, Jeroen Demeyer\n\nDependencies: #22185\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/22198\n\n",
    "closed_at": "2017-01-29T12:04:46Z",
    "created_at": "2017-01-17T18:09:13Z",
    "labels": [
        "component: c_lib"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.6",
    "title": "Make cypari2 Python2 / Python3 compatible",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22198",
    "user": "https://github.com/videlec"
}
```
Currently string handling in `cypari2` is done via `PyString_AsString` which does not exist in Python 3. We rely on Cython to make proper conversions to `bytes`.

CC:  @defeo @jdemeyer

Branch/Commit: 7096c82b4ec94c5d148231b7df518ca5154aad2a

Reviewer: Jeroen Demeyer, Vincent Delecroix

Author: Vincent Delecroix, Jeroen Demeyer

Dependencies: #22185

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/22198





---

archive/issue_comments_411631.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-01-17T23:52:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411631",
    "user": "https://github.com/videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_411632.json:
```json
{
    "body": "Changing branch from \"\" to \"u/vdelecroix/22198\"",
    "created_at": "2017-01-17T23:52:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411632",
    "user": "https://github.com/videlec"
}
```

Changing branch from "" to "u/vdelecroix/22198"



---

archive/issue_comments_411633.json:
```json
{
    "body": "<a id='comment:1'></a>\nLast 10 new commits:\n|                                                                                                                                          |                                        |\n|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------|\n|[183588e](https://git.sagemath.org/sage.git/commit?id=183588ea9ef578966fa62bd1a47db3a81fdebc29)|`21808: fix some more .python() .sage()`|\n|[8828867](https://git.sagemath.org/sage.git/commit?id=88288670d22328ea0ff386c826c65d729504cb58)|`Python 3 compatibility in doctests`|\n|[87b6ac3](https://git.sagemath.org/sage.git/commit?id=87b6ac3b975a5b5a51f29d3f2b552dac2ba54615)|`Merge branch 't/21807/21807' into HEAD`|\n|[ee54f07](https://git.sagemath.org/sage.git/commit?id=ee54f071a26c63821f475d2832c7bb1fbbdd7e95)|`Python 3 compatibility in doctests`|\n|[7a35c89](https://git.sagemath.org/sage.git/commit?id=7a35c89fe2e02d7bc31c531180c82918bebf7ee2)|`Merge commit '6022cab1880d6f3820e0f028671ddd2983eae42b'; commit 'ee54f071a26c63821f475d2832c7bb1fbbdd7e95' into ticket/22183`|\n|[235efd3](https://git.sagemath.org/sage.git/commit?id=235efd32d22100011b78e882ccb1bff284c702f5)|`Rename PariInstance -> Pari`|\n|[6f04aba](https://git.sagemath.org/sage.git/commit?id=6f04abaa16a6770e952f8f803623f65c4236df29)|`Remove unused imports from sage`|\n|[c258dca](https://git.sagemath.org/sage.git/commit?id=c258dcad4c117684ce00d9002eb23da79196f47e)|`Rename gen -> Gen`|\n|[0c4433c](https://git.sagemath.org/sage.git/commit?id=0c4433cf66fb6d9f5fcb5b4429d9f25978008f36)|`Fix documentation`|\n|[ff6a3fd](https://git.sagemath.org/sage.git/commit?id=ff6a3fd4bedecacb6f3061ccd51c1ee725b2a864)|`22198: do not depend on PyString_AsString`|",
    "created_at": "2017-01-17T23:52:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411633",
    "user": "https://github.com/videlec"
}
```

<a id='comment:1'></a>
Last 10 new commits:
|                                                                                                                                          |                                        |
|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------|
|[183588e](https://git.sagemath.org/sage.git/commit?id=183588ea9ef578966fa62bd1a47db3a81fdebc29)|`21808: fix some more .python() .sage()`|
|[8828867](https://git.sagemath.org/sage.git/commit?id=88288670d22328ea0ff386c826c65d729504cb58)|`Python 3 compatibility in doctests`|
|[87b6ac3](https://git.sagemath.org/sage.git/commit?id=87b6ac3b975a5b5a51f29d3f2b552dac2ba54615)|`Merge branch 't/21807/21807' into HEAD`|
|[ee54f07](https://git.sagemath.org/sage.git/commit?id=ee54f071a26c63821f475d2832c7bb1fbbdd7e95)|`Python 3 compatibility in doctests`|
|[7a35c89](https://git.sagemath.org/sage.git/commit?id=7a35c89fe2e02d7bc31c531180c82918bebf7ee2)|`Merge commit '6022cab1880d6f3820e0f028671ddd2983eae42b'; commit 'ee54f071a26c63821f475d2832c7bb1fbbdd7e95' into ticket/22183`|
|[235efd3](https://git.sagemath.org/sage.git/commit?id=235efd32d22100011b78e882ccb1bff284c702f5)|`Rename PariInstance -> Pari`|
|[6f04aba](https://git.sagemath.org/sage.git/commit?id=6f04abaa16a6770e952f8f803623f65c4236df29)|`Remove unused imports from sage`|
|[c258dca](https://git.sagemath.org/sage.git/commit?id=c258dcad4c117684ce00d9002eb23da79196f47e)|`Rename gen -> Gen`|
|[0c4433c](https://git.sagemath.org/sage.git/commit?id=0c4433cf66fb6d9f5fcb5b4429d9f25978008f36)|`Fix documentation`|
|[ff6a3fd](https://git.sagemath.org/sage.git/commit?id=ff6a3fd4bedecacb6f3061ccd51c1ee725b2a864)|`22198: do not depend on PyString_AsString`|



---

archive/issue_comments_411634.json:
```json
{
    "body": "Changing commit from \"\" to \"ff6a3fd4bedecacb6f3061ccd51c1ee725b2a864\"",
    "created_at": "2017-01-17T23:52:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411634",
    "user": "https://github.com/videlec"
}
```

Changing commit from "" to "ff6a3fd4bedecacb6f3061ccd51c1ee725b2a864"



---

archive/issue_comments_411635.json:
```json
{
    "body": "<a id='comment:2'></a>\nDid you actually check that Python 3 works with this patch?",
    "created_at": "2017-01-18T11:53:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411635",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>
Did you actually check that Python 3 works with this patch?



---

archive/issue_comments_411636.json:
```json
{
    "body": "<a id='comment:3'></a>\nHow can I do that?!\n\nAt least it works in cypari2 with commit [88bf24e](https://github.com/defeo/cypari2/commit/88bf24e073c1cd76b1ca197cb6079895f47ac7c6).",
    "created_at": "2017-01-18T11:56:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411636",
    "user": "https://github.com/videlec"
}
```

<a id='comment:3'></a>
How can I do that?!

At least it works in cypari2 with commit [88bf24e](https://github.com/defeo/cypari2/commit/88bf24e073c1cd76b1ca197cb6079895f47ac7c6).



---

archive/issue_comments_411637.json:
```json
{
    "body": "Changing branch from \"u/vdelecroix/22198\" to \"u/jdemeyer/22198\"",
    "created_at": "2017-01-18T16:30:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411637",
    "user": "https://github.com/jdemeyer"
}
```

Changing branch from "u/vdelecroix/22198" to "u/jdemeyer/22198"



---

archive/issue_comments_411638.json:
```json
{
    "body": "Changing commit from \"ff6a3fd4bedecacb6f3061ccd51c1ee725b2a864\" to \"683816d54d501f344124ae80f4a90170e517b186\"",
    "created_at": "2017-01-18T16:38:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411638",
    "user": "https://github.com/jdemeyer"
}
```

Changing commit from "ff6a3fd4bedecacb6f3061ccd51c1ee725b2a864" to "683816d54d501f344124ae80f4a90170e517b186"



---

archive/issue_comments_411639.json:
```json
{
    "body": "<a id='comment:5'></a>\nThis is a much simpler version, relying on Cython to convert `str` -> `bytes`.\n\n---\nNew commits:\n|                                                                                                                                          |                                           |\n|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------|\n|[683816d](https://git.sagemath.org/sage.git/commit?id=683816d54d501f344124ae80f4a90170e517b186)|`22198: do not depend on PyString_AsString`|",
    "created_at": "2017-01-18T16:38:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411639",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>
This is a much simpler version, relying on Cython to convert `str` -> `bytes`.

---
New commits:
|                                                                                                                                          |                                           |
|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------|
|[683816d](https://git.sagemath.org/sage.git/commit?id=683816d54d501f344124ae80f4a90170e517b186)|`22198: do not depend on PyString_AsString`|



---

archive/issue_comments_411640.json:
```json
{
    "body": "<a id='comment:6'></a>\nNote: Cython converts Unicode strings to `bytes` by using `sys.getdefaultencoding()` which seems like a reasonable thing to do. In Python 2, this encoding is ASCII by default, in Python 3 it is UTF-8 by default.",
    "created_at": "2017-01-18T17:29:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411640",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>
Note: Cython converts Unicode strings to `bytes` by using `sys.getdefaultencoding()` which seems like a reasonable thing to do. In Python 2, this encoding is ASCII by default, in Python 3 it is UTF-8 by default.



---

archive/issue_comments_411641.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-01-19T09:50:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411641",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_411642.json:
```json
{
    "body": "<a id='comment:7'></a>\nFor me it compiles but does not work in Python 3\n\n```\n>>> import cypari2\n>>> pari = cypari2.Pari()\n>>> pari(\"zeta(2)\")\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\n  File \"cypari2/pari_instance.pyx\", line 831, in cypari2.pari_instance.Pari.__call__ (cypari2/pari_instance.c:13408)\n  File \"cypari2/gen.pyx\", line 4534, in cypari2.gen.objtogen (cypari2/gen.c:128337)\nTypeError: expected bytes, str found\n```",
    "created_at": "2017-01-19T09:50:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411642",
    "user": "https://github.com/videlec"
}
```

<a id='comment:7'></a>
For me it compiles but does not work in Python 3

```
>>> import cypari2
>>> pari = cypari2.Pari()
>>> pari("zeta(2)")
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "cypari2/pari_instance.pyx", line 831, in cypari2.pari_instance.Pari.__call__ (cypari2/pari_instance.c:13408)
  File "cypari2/gen.pyx", line 4534, in cypari2.gen.objtogen (cypari2/gen.c:128337)
TypeError: expected bytes, str found
```



---

archive/issue_comments_411643.json:
```json
{
    "body": "<a id='comment:8'></a>\nActually, in Cython for Python 3 given a string `s` the conversion\n\n```\n<bytes> s\n```\ndoes not do anything!! (tested with Cython version 0.25.2)",
    "created_at": "2017-01-19T10:23:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411643",
    "user": "https://github.com/videlec"
}
```

<a id='comment:8'></a>
Actually, in Cython for Python 3 given a string `s` the conversion

```
<bytes> s
```
does not do anything!! (tested with Cython version 0.25.2)



---

archive/issue_comments_411644.json:
```json
{
    "body": "<a id='comment:9'></a>\nIn your patch, `bytes` do not get catch in Python 3.",
    "created_at": "2017-01-19T12:11:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411644",
    "user": "https://github.com/videlec"
}
```

<a id='comment:9'></a>
In your patch, `bytes` do not get catch in Python 3.



---

archive/issue_comments_411645.json:
```json
{
    "body": "<a id='comment:10'></a>\n`<bytes>s` is **not** a conversion, it's a cast! So yes, it doesn't \"do\" anything and that's a feature.",
    "created_at": "2017-01-19T13:01:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411645",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>
`<bytes>s` is **not** a conversion, it's a cast! So yes, it doesn't "do" anything and that's a feature.



---

archive/issue_comments_411646.json:
```json
{
    "body": "<a id='comment:11'></a>\nWith your patch, unicode are also not treated correctly (see [comment:7]).",
    "created_at": "2017-01-19T14:45:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411646",
    "user": "https://github.com/videlec"
}
```

<a id='comment:11'></a>
With your patch, unicode are also not treated correctly (see [comment:7]).



---

archive/issue_comments_411647.json:
```json
{
    "body": "<a id='comment:12'></a>\nAnd conversion does fail\n\n```\nPython 3.5.2\n>>> bytes(\"hello\")\nTraceback (most recent call last):\n...\nTypeError: string argument without an encoding\n```\nI don't understand where the default encoding that you mentioned in [comment:6] is intended to happen.\n\nEDIT: this command fails in the same way in Cython",
    "created_at": "2017-01-19T15:59:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411647",
    "user": "https://github.com/videlec"
}
```

<a id='comment:12'></a>
And conversion does fail

```
Python 3.5.2
>>> bytes("hello")
Traceback (most recent call last):
...
TypeError: string argument without an encoding
```
I don't understand where the default encoding that you mentioned in [comment:6] is intended to happen.

EDIT: this command fails in the same way in Cython



---

archive/issue_comments_411648.json:
```json
{
    "body": "<a id='comment:13'></a>\nThe default encoding is something Cython-specific when passing `unicode` or `bytes` to C as a `char*`. It's not about converting within Python from `unicode` to `bytes`.",
    "created_at": "2017-01-19T16:40:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411648",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>
The default encoding is something Cython-specific when passing `unicode` or `bytes` to C as a `char*`. It's not about converting within Python from `unicode` to `bytes`.



---

archive/issue_comments_411649.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [jdemeyer](#comment%3A13):\n> The default encoding is something Cython-specific when passing `unicode` or `bytes` to C as a `char*`. It's not about converting within Python from `unicode` to `bytes`.\n\n\nI know and I already mentioned it in [comment:12]: the code behaves the same when compiled in Cython. You can check with\n\n```\nPython 3.5.2\n>>> import cython\n>>> cython.inline('bytes(\"hello\")')\nTraceback (most recent call last):\n...\nTypeError: string argument without an encoding\n```",
    "created_at": "2017-01-19T16:44:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411649",
    "user": "https://github.com/videlec"
}
```

<a id='comment:14'></a>
Replying to [jdemeyer](#comment%3A13):
> The default encoding is something Cython-specific when passing `unicode` or `bytes` to C as a `char*`. It's not about converting within Python from `unicode` to `bytes`.


I know and I already mentioned it in [comment:12]: the code behaves the same when compiled in Cython. You can check with

```
Python 3.5.2
>>> import cython
>>> cython.inline('bytes("hello")')
Traceback (most recent call last):
...
TypeError: string argument without an encoding
```



---

archive/issue_comments_411650.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [vdelecroix](#comment%3A14):\n> I know and I already mentioned it in [comment:12]: the code behaves the same when compiled in Cython.\n\n\nYes, and I already mentioned that it's *not* about `bytes(foo)`, it's about passing `foo` as a `char*` to C.",
    "created_at": "2017-01-19T16:50:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411650",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:15'></a>
Replying to [vdelecroix](#comment%3A14):
> I know and I already mentioned it in [comment:12]: the code behaves the same when compiled in Cython.


Yes, and I already mentioned that it's *not* about `bytes(foo)`, it's about passing `foo` as a `char*` to C.



---

archive/issue_comments_411651.json:
```json
{
    "body": "<a id='comment:17'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                           |                                                 |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------|\n|[819ed9e](https://git.sagemath.org/sage.git/commit/?id=819ed9ec1916e2a8f4104b2b937ffb42a76db350)|`Trac #22198: do not depend on PyString_AsString`|",
    "created_at": "2017-01-19T22:49:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411651",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                           |                                                 |
|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------|
|[819ed9e](https://git.sagemath.org/sage.git/commit/?id=819ed9ec1916e2a8f4104b2b937ffb42a76db350)|`Trac #22198: do not depend on PyString_AsString`|



---

archive/issue_comments_411652.json:
```json
{
    "body": "Changing commit from \"683816d54d501f344124ae80f4a90170e517b186\" to \"819ed9ec1916e2a8f4104b2b937ffb42a76db350\"",
    "created_at": "2017-01-19T22:49:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411652",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "683816d54d501f344124ae80f4a90170e517b186" to "819ed9ec1916e2a8f4104b2b937ffb42a76db350"



---

archive/issue_comments_411653.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-01-19T22:50:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411653",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_411654.json:
```json
{
    "body": "<a id='comment:18'></a>\nDoes this work?",
    "created_at": "2017-01-19T22:50:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411654",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>
Does this work?



---

archive/issue_comments_411655.json:
```json
{
    "body": "<a id='comment:19'></a>\nI don't think so: `bytes` and `basestring` are disjoint in Python 3. Let me try.",
    "created_at": "2017-01-20T09:52:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411655",
    "user": "https://github.com/videlec"
}
```

<a id='comment:19'></a>
I don't think so: `bytes` and `basestring` are disjoint in Python 3. Let me try.



---

archive/issue_comments_411656.json:
```json
{
    "body": "<a id='comment:20'></a>\nActually it fails at compilation\n\n```\nImportError: Building module cython_string failed: ['LookupError: unknown encoding: default\\n']\n```\nThe encoding used seems to be the encoding of the file, not of the system. Adding `# encoding: utf-8` at the top of the file make it works.",
    "created_at": "2017-01-20T10:06:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411656",
    "user": "https://github.com/videlec"
}
```

<a id='comment:20'></a>
Actually it fails at compilation

```
ImportError: Building module cython_string failed: ['LookupError: unknown encoding: default\n']
```
The encoding used seems to be the encoding of the file, not of the system. Adding `# encoding: utf-8` at the top of the file make it works.



---

archive/issue_comments_411657.json:
```json
{
    "body": "Attachment [cython_string.pyx](tarball://root/attachments/some-uuid/ticket22198/cython_string.pyx) by @videlec created at 2017-01-20 10:07:39",
    "created_at": "2017-01-20T10:07:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411657",
    "user": "https://github.com/videlec"
}
```

Attachment [cython_string.pyx](tarball://root/attachments/some-uuid/ticket22198/cython_string.pyx) by @videlec created at 2017-01-20 10:07:39



---

archive/issue_comments_411658.json:
```json
{
    "body": "<a id='comment:21'></a>\nReplying to [vdelecroix](#comment%3A19):\n> I don't think so: `bytes` and `basestring` are disjoint in Python 3. Let me try.\n\n\nIndeed\n\n```\nPython 3.5.2\n>>> import cypari2\n>>> pari = cypari2.Pari()\n>>> pari(b\"zeta(2)\")\nTraceback (most recent call last):\n...\nPariError: syntax error, unexpected variable name, expecting $end\n```",
    "created_at": "2017-01-20T12:20:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411658",
    "user": "https://github.com/videlec"
}
```

<a id='comment:21'></a>
Replying to [vdelecroix](#comment%3A19):
> I don't think so: `bytes` and `basestring` are disjoint in Python 3. Let me try.


Indeed

```
Python 3.5.2
>>> import cypari2
>>> pari = cypari2.Pari()
>>> pari(b"zeta(2)")
Traceback (most recent call last):
...
PariError: syntax error, unexpected variable name, expecting $end
```



---

archive/issue_comments_411659.json:
```json
{
    "body": "Changing branch from \"u/jdemeyer/22198\" to \"u/vdelecroix/22198\"",
    "created_at": "2017-01-20T12:25:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411659",
    "user": "https://github.com/videlec"
}
```

Changing branch from "u/jdemeyer/22198" to "u/vdelecroix/22198"



---

archive/issue_comments_411660.json:
```json
{
    "body": "Changing commit from \"819ed9ec1916e2a8f4104b2b937ffb42a76db350\" to \"ff6a3fd4bedecacb6f3061ccd51c1ee725b2a864\"",
    "created_at": "2017-01-20T12:25:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411660",
    "user": "https://github.com/videlec"
}
```

Changing commit from "819ed9ec1916e2a8f4104b2b937ffb42a76db350" to "ff6a3fd4bedecacb6f3061ccd51c1ee725b2a864"



---

archive/issue_comments_411661.json:
```json
{
    "body": "<a id='comment:22'></a>\nNew commits:\n|                                                                                                                                          |                                           |\n|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------|\n|[ff6a3fd](https://git.sagemath.org/sage.git/commit?id=ff6a3fd4bedecacb6f3061ccd51c1ee725b2a864)|`22198: do not depend on PyString_AsString`|",
    "created_at": "2017-01-20T12:25:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411661",
    "user": "https://github.com/videlec"
}
```

<a id='comment:22'></a>
New commits:
|                                                                                                                                          |                                           |
|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------|
|[ff6a3fd](https://git.sagemath.org/sage.git/commit?id=ff6a3fd4bedecacb6f3061ccd51c1ee725b2a864)|`22198: do not depend on PyString_AsString`|



---

archive/issue_comments_411662.json:
```json
{
    "body": "<a id='comment:23'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                           |                                                 |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------|\n|[819ed9e](https://git.sagemath.org/sage.git/commit/?id=819ed9ec1916e2a8f4104b2b937ffb42a76db350)|`Trac #22198: do not depend on PyString_AsString`|\n|[6c55c78](https://git.sagemath.org/sage.git/commit/?id=6c55c787706ed2205cb85a554b752ae829d710c5)|`Trac #22198: fix bytes for Python3`|",
    "created_at": "2017-01-20T12:26:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411662",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:23'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                           |                                                 |
|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------|
|[819ed9e](https://git.sagemath.org/sage.git/commit/?id=819ed9ec1916e2a8f4104b2b937ffb42a76db350)|`Trac #22198: do not depend on PyString_AsString`|
|[6c55c78](https://git.sagemath.org/sage.git/commit/?id=6c55c787706ed2205cb85a554b752ae829d710c5)|`Trac #22198: fix bytes for Python3`|



---

archive/issue_comments_411663.json:
```json
{
    "body": "Changing commit from \"ff6a3fd4bedecacb6f3061ccd51c1ee725b2a864\" to \"6c55c787706ed2205cb85a554b752ae829d710c5\"",
    "created_at": "2017-01-20T12:26:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411663",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "ff6a3fd4bedecacb6f3061ccd51c1ee725b2a864" to "6c55c787706ed2205cb85a554b752ae829d710c5"



---

archive/issue_comments_411664.json:
```json
{
    "body": "<a id='comment:24'></a>\nplease see my last commit 6c55c78 that does work in the standalone cypari.",
    "created_at": "2017-01-20T12:26:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411664",
    "user": "https://github.com/videlec"
}
```

<a id='comment:24'></a>
please see my last commit 6c55c78 that does work in the standalone cypari.



---

archive/issue_comments_411665.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-01-20T13:39:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411665",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_411666.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Jeroen Demeyer, Vincent Delecroix\"",
    "created_at": "2017-01-20T13:39:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411666",
    "user": "https://github.com/videlec"
}
```

Changing reviewer from "" to "Jeroen Demeyer, Vincent Delecroix"



---

archive/issue_comments_411667.json:
```json
{
    "body": "Changing author from \"Vincent Delecroix\" to \"Vincent Delecroix, Jeroen Demeyer\"",
    "created_at": "2017-01-20T13:39:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411667",
    "user": "https://github.com/videlec"
}
```

Changing author from "Vincent Delecroix" to "Vincent Delecroix, Jeroen Demeyer"



---

archive/issue_comments_411668.json:
```json
{
    "body": "Changing branch from \"u/vdelecroix/22198\" to \"u/jdemeyer/22198\"",
    "created_at": "2017-01-21T13:05:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411668",
    "user": "https://github.com/jdemeyer"
}
```

Changing branch from "u/vdelecroix/22198" to "u/jdemeyer/22198"



---

archive/issue_comments_411669.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2017-01-21T13:19:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411669",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_411670.json:
```json
{
    "body": "Changing commit from \"6c55c787706ed2205cb85a554b752ae829d710c5\" to \"7096c82b4ec94c5d148231b7df518ca5154aad2a\"",
    "created_at": "2017-01-21T13:19:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411670",
    "user": "https://github.com/jdemeyer"
}
```

Changing commit from "6c55c787706ed2205cb85a554b752ae829d710c5" to "7096c82b4ec94c5d148231b7df518ca5154aad2a"



---

archive/issue_comments_411671.json:
```json
{
    "body": "<a id='comment:27'></a>\nDoes this work too? It's a slightly more efficient version of your code.\n\n---\nNew commits:\n|                                                                                                                                          |                                    |\n|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------|\n|[7096c82](https://git.sagemath.org/sage.git/commit?id=7096c82b4ec94c5d148231b7df518ca5154aad2a)|`Trac #22198: fix bytes for Python3`|",
    "created_at": "2017-01-21T13:19:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411671",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:27'></a>
Does this work too? It's a slightly more efficient version of your code.

---
New commits:
|                                                                                                                                          |                                    |
|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------|
|[7096c82](https://git.sagemath.org/sage.git/commit?id=7096c82b4ec94c5d148231b7df518ca5154aad2a)|`Trac #22198: fix bytes for Python3`|



---

archive/issue_comments_411672.json:
```json
{
    "body": "<a id='comment:28'></a>\nIt does.",
    "created_at": "2017-01-27T15:40:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411672",
    "user": "https://github.com/videlec"
}
```

<a id='comment:28'></a>
It does.



---

archive/issue_comments_411673.json:
```json
{
    "body": "<a id='comment:29'></a>\nPositive review then?",
    "created_at": "2017-01-27T15:43:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411673",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:29'></a>
Positive review then?



---

archive/issue_comments_411674.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-01-27T15:45:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411674",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_411675.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-01-29T12:04:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411675",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_411676.json:
```json
{
    "body": "Changing branch from \"u/jdemeyer/22198\" to \"7096c82b4ec94c5d148231b7df518ca5154aad2a\"",
    "created_at": "2017-01-29T12:04:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-411676",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/jdemeyer/22198" to "7096c82b4ec94c5d148231b7df518ca5154aad2a"



---

archive/issue_events_058371.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-01-29T12:04:46Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22198#event-58371"
}
```
