# Issue 22198: Make cypari2 Python2 / Python3 compatible

archive/issues_021961.json:
```json
{
    "body": "Currently string handling in `cypari2` is done via `PyString_AsString` which does not exist in Python 3. We rely on Cython to make proper conversions to `bytes`.\n\nCC:  @defeo @jdemeyer\n\nBranch/Commit: 7096c82b4ec94c5d148231b7df518ca5154aad2a\n\nReviewer: Jeroen Demeyer, Vincent Delecroix\n\nAuthor: Vincent Delecroix, Jeroen Demeyer\n\nDependencies: #22185\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/22198\n\n",
    "closed_at": "2017-01-29T12:04:46Z",
    "created_at": "2017-01-17T18:09:13Z",
    "labels": [
        "component: c_lib"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.6",
    "title": "Make cypari2 Python2 / Python3 compatible",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22198",
    "user": "https://github.com/videlec"
}
```
Currently string handling in `cypari2` is done via `PyString_AsString` which does not exist in Python 3. We rely on Cython to make proper conversions to `bytes`.

CC:  @defeo @jdemeyer

Branch/Commit: 7096c82b4ec94c5d148231b7df518ca5154aad2a

Reviewer: Jeroen Demeyer, Vincent Delecroix

Author: Vincent Delecroix, Jeroen Demeyer

Dependencies: #22185

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/22198





---

archive/issue_comments_305001.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-01-17T23:52:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-305001",
    "user": "https://github.com/videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_305002.json:
```json
{
    "body": "<a id='comment:1'></a>Last 10 new commits:",
    "created_at": "2017-01-17T23:52:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-305002",
    "user": "https://github.com/videlec"
}
```

<a id='comment:1'></a>Last 10 new commits:



---

archive/issue_comments_305003.json:
```json
{
    "body": "<a id='comment:2'></a>Did you actually check that Python 3 works with this patch?",
    "created_at": "2017-01-18T11:53:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-305003",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>Did you actually check that Python 3 works with this patch?



---

archive/issue_comments_305004.json:
```json
{
    "body": "<a id='comment:3'></a>How can I do that?!\n\nAt least it works in cypari2 with commit [88bf24e](https://github.com/defeo/cypari2/commit/88bf24e073c1cd76b1ca197cb6079895f47ac7c6).",
    "created_at": "2017-01-18T11:56:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-305004",
    "user": "https://github.com/videlec"
}
```

<a id='comment:3'></a>How can I do that?!

At least it works in cypari2 with commit [88bf24e](https://github.com/defeo/cypari2/commit/88bf24e073c1cd76b1ca197cb6079895f47ac7c6).



---

archive/issue_comments_305005.json:
```json
{
    "body": "<a id='comment:5'></a>This is a much simpler version, relying on Cython to convert `str` -> `bytes`.\n\n---\nNew commits:",
    "created_at": "2017-01-18T16:38:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-305005",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>This is a much simpler version, relying on Cython to convert `str` -> `bytes`.

---
New commits:



---

archive/issue_comments_305006.json:
```json
{
    "body": "<a id='comment:6'></a>Note: Cython converts Unicode strings to `bytes` by using `sys.getdefaultencoding()` which seems like a reasonable thing to do. In Python 2, this encoding is ASCII by default, in Python 3 it is UTF-8 by default.",
    "created_at": "2017-01-18T17:29:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-305006",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>Note: Cython converts Unicode strings to `bytes` by using `sys.getdefaultencoding()` which seems like a reasonable thing to do. In Python 2, this encoding is ASCII by default, in Python 3 it is UTF-8 by default.



---

archive/issue_comments_305007.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-01-19T09:50:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-305007",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_305008.json:
```json
{
    "body": "<a id='comment:7'></a>For me it compiles but does not work in Python 3\n\n```\n>>> import cypari2\n>>> pari = cypari2.Pari()\n>>> pari(\"zeta(2)\")\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\n  File \"cypari2/pari_instance.pyx\", line 831, in cypari2.pari_instance.Pari.__call__ (cypari2/pari_instance.c:13408)\n  File \"cypari2/gen.pyx\", line 4534, in cypari2.gen.objtogen (cypari2/gen.c:128337)\nTypeError: expected bytes, str found\n```",
    "created_at": "2017-01-19T09:50:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-305008",
    "user": "https://github.com/videlec"
}
```

<a id='comment:7'></a>For me it compiles but does not work in Python 3

```
>>> import cypari2
>>> pari = cypari2.Pari()
>>> pari("zeta(2)")
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "cypari2/pari_instance.pyx", line 831, in cypari2.pari_instance.Pari.__call__ (cypari2/pari_instance.c:13408)
  File "cypari2/gen.pyx", line 4534, in cypari2.gen.objtogen (cypari2/gen.c:128337)
TypeError: expected bytes, str found
```



---

archive/issue_comments_305009.json:
```json
{
    "body": "<a id='comment:8'></a>Actually, in Cython for Python 3 given a string `s` the conversion\n\n```\n<bytes> s\n```\ndoes not do anything!! (tested with Cython version 0.25.2)",
    "created_at": "2017-01-19T10:23:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-305009",
    "user": "https://github.com/videlec"
}
```

<a id='comment:8'></a>Actually, in Cython for Python 3 given a string `s` the conversion

```
<bytes> s
```
does not do anything!! (tested with Cython version 0.25.2)



---

archive/issue_comments_305010.json:
```json
{
    "body": "<a id='comment:9'></a>In your patch, `bytes` do not get catch in Python 3.",
    "created_at": "2017-01-19T12:11:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-305010",
    "user": "https://github.com/videlec"
}
```

<a id='comment:9'></a>In your patch, `bytes` do not get catch in Python 3.



---

archive/issue_comments_305011.json:
```json
{
    "body": "<a id='comment:10'></a>`<bytes>s` is **not** a conversion, it's a cast! So yes, it doesn't \"do\" anything and that's a feature.",
    "created_at": "2017-01-19T13:01:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-305011",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>`<bytes>s` is **not** a conversion, it's a cast! So yes, it doesn't "do" anything and that's a feature.



---

archive/issue_comments_305012.json:
```json
{
    "body": "<a id='comment:11'></a>With your patch, unicode are also not treated correctly (see [comment:7]).",
    "created_at": "2017-01-19T14:45:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-305012",
    "user": "https://github.com/videlec"
}
```

<a id='comment:11'></a>With your patch, unicode are also not treated correctly (see [comment:7]).



---

archive/issue_comments_305013.json:
```json
{
    "body": "<a id='comment:12'></a>And conversion does fail\n\n```\nPython 3.5.2\n>>> bytes(\"hello\")\nTraceback (most recent call last):\n...\nTypeError: string argument without an encoding\n```\nI don't understand where the default encoding that you mentioned in [comment:6] is intended to happen.\n\nEDIT: this command fails in the same way in Cython",
    "created_at": "2017-01-19T15:59:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-305013",
    "user": "https://github.com/videlec"
}
```

<a id='comment:12'></a>And conversion does fail

```
Python 3.5.2
>>> bytes("hello")
Traceback (most recent call last):
...
TypeError: string argument without an encoding
```
I don't understand where the default encoding that you mentioned in [comment:6] is intended to happen.

EDIT: this command fails in the same way in Cython



---

archive/issue_comments_305014.json:
```json
{
    "body": "<a id='comment:13'></a>The default encoding is something Cython-specific when passing `unicode` or `bytes` to C as a `char*`. It's not about converting within Python from `unicode` to `bytes`.",
    "created_at": "2017-01-19T16:40:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-305014",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>The default encoding is something Cython-specific when passing `unicode` or `bytes` to C as a `char*`. It's not about converting within Python from `unicode` to `bytes`.



---

archive/issue_comments_305015.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [comment:13 jdemeyer]:\n> The default encoding is something Cython-specific when passing `unicode` or `bytes` to C as a `char*`. It's not about converting within Python from `unicode` to `bytes`.\n\n\nI know and I already mentioned it in [comment:12]: the code behaves the same when compiled in Cython. You can check with\n\n```\nPython 3.5.2\n>>> import cython\n>>> cython.inline('bytes(\"hello\")')\nTraceback (most recent call last):\n...\nTypeError: string argument without an encoding\n```",
    "created_at": "2017-01-19T16:44:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-305015",
    "user": "https://github.com/videlec"
}
```

<a id='comment:14'></a>Replying to [comment:13 jdemeyer]:
> The default encoding is something Cython-specific when passing `unicode` or `bytes` to C as a `char*`. It's not about converting within Python from `unicode` to `bytes`.


I know and I already mentioned it in [comment:12]: the code behaves the same when compiled in Cython. You can check with

```
Python 3.5.2
>>> import cython
>>> cython.inline('bytes("hello")')
Traceback (most recent call last):
...
TypeError: string argument without an encoding
```



---

archive/issue_comments_305016.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:14 vdelecroix]:\n> I know and I already mentioned it in [comment:12]: the code behaves the same when compiled in Cython.\n\n\nYes, and I already mentioned that it's *not* about `bytes(foo)`, it's about passing `foo` as a `char*` to C.",
    "created_at": "2017-01-19T16:50:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-305016",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:15'></a>Replying to [comment:14 vdelecroix]:
> I know and I already mentioned it in [comment:12]: the code behaves the same when compiled in Cython.


Yes, and I already mentioned that it's *not* about `bytes(foo)`, it's about passing `foo` as a `char*` to C.



---

archive/issue_comments_305017.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-01-19T22:49:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-305017",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_305018.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-01-19T22:50:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-305018",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_305019.json:
```json
{
    "body": "<a id='comment:18'></a>Does this work?",
    "created_at": "2017-01-19T22:50:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-305019",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>Does this work?



---

archive/issue_comments_305020.json:
```json
{
    "body": "<a id='comment:19'></a>I don't think so: `bytes` and `basestring` are disjoint in Python 3. Let me try.",
    "created_at": "2017-01-20T09:52:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-305020",
    "user": "https://github.com/videlec"
}
```

<a id='comment:19'></a>I don't think so: `bytes` and `basestring` are disjoint in Python 3. Let me try.



---

archive/issue_comments_305021.json:
```json
{
    "body": "<a id='comment:20'></a>Actually it fails at compilation\n\n```\nImportError: Building module cython_string failed: ['LookupError: unknown encoding: default\\n']\n```\nThe encoding used seems to be the encoding of the file, not of the system. Adding `# encoding: utf-8` at the top of the file make it works.",
    "created_at": "2017-01-20T10:06:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-305021",
    "user": "https://github.com/videlec"
}
```

<a id='comment:20'></a>Actually it fails at compilation

```
ImportError: Building module cython_string failed: ['LookupError: unknown encoding: default\n']
```
The encoding used seems to be the encoding of the file, not of the system. Adding `# encoding: utf-8` at the top of the file make it works.



---

archive/issue_comments_305022.json:
```json
{
    "body": "Attachment [cython_string.pyx](tarball://root/attachments/some-uuid/ticket22198/cython_string.pyx) by @videlec created at 2017-01-20 10:07:39",
    "created_at": "2017-01-20T10:07:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-305022",
    "user": "https://github.com/videlec"
}
```

Attachment [cython_string.pyx](tarball://root/attachments/some-uuid/ticket22198/cython_string.pyx) by @videlec created at 2017-01-20 10:07:39



---

archive/issue_comments_305023.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [comment:19 vdelecroix]:\n> I don't think so: `bytes` and `basestring` are disjoint in Python 3. Let me try.\n\n\nIndeed\n\n```\nPython 3.5.2\n>>> import cypari2\n>>> pari = cypari2.Pari()\n>>> pari(b\"zeta(2)\")\nTraceback (most recent call last):\n...\nPariError: syntax error, unexpected variable name, expecting $end\n```",
    "created_at": "2017-01-20T12:20:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-305023",
    "user": "https://github.com/videlec"
}
```

<a id='comment:21'></a>Replying to [comment:19 vdelecroix]:
> I don't think so: `bytes` and `basestring` are disjoint in Python 3. Let me try.


Indeed

```
Python 3.5.2
>>> import cypari2
>>> pari = cypari2.Pari()
>>> pari(b"zeta(2)")
Traceback (most recent call last):
...
PariError: syntax error, unexpected variable name, expecting $end
```



---

archive/issue_comments_305024.json:
```json
{
    "body": "<a id='comment:22'></a>New commits:",
    "created_at": "2017-01-20T12:25:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-305024",
    "user": "https://github.com/videlec"
}
```

<a id='comment:22'></a>New commits:



---

archive/issue_comments_305025.json:
```json
{
    "body": "<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-01-20T12:26:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-305025",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_305026.json:
```json
{
    "body": "<a id='comment:24'></a>please see my last commit 6c55c78 that does work in the standalone cypari.",
    "created_at": "2017-01-20T12:26:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-305026",
    "user": "https://github.com/videlec"
}
```

<a id='comment:24'></a>please see my last commit 6c55c78 that does work in the standalone cypari.



---

archive/issue_comments_305027.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-01-20T13:39:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-305027",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_305028.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2017-01-21T13:19:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-305028",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_305029.json:
```json
{
    "body": "<a id='comment:27'></a>Does this work too? It's a slightly more efficient version of your code.\n\n---\nNew commits:",
    "created_at": "2017-01-21T13:19:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-305029",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:27'></a>Does this work too? It's a slightly more efficient version of your code.

---
New commits:



---

archive/issue_comments_305030.json:
```json
{
    "body": "<a id='comment:28'></a>It does.",
    "created_at": "2017-01-27T15:40:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-305030",
    "user": "https://github.com/videlec"
}
```

<a id='comment:28'></a>It does.



---

archive/issue_comments_305031.json:
```json
{
    "body": "<a id='comment:29'></a>Positive review then?",
    "created_at": "2017-01-27T15:43:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-305031",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:29'></a>Positive review then?



---

archive/issue_comments_305032.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-01-27T15:45:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-305032",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_305033.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-01-29T12:04:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22198#issuecomment-305033",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_058371.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-01-29T12:04:46Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/22198",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22198#event-58371"
}
```
