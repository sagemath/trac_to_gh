# Issue 22755: Various fixes to lazy imports

archive/issues_022518.json:
```json
{
    "body": "Assorted fixes to lazy imports:\n\n1. Drop support for `lazy_import(overwrite=False)` which was used only in one place in a dubious way to implement a 2-level lazy import (a lazy import being lazily imported).\n\n2. More optimal code for binary operations like `__add__` by avoiding the `operator` module.\n\n3. Move the code to replace a lazy import in a class namespace from `_get_object()` to `__get__`.\n\n4. Partially inline `_get_object()` with a new `cdef inline` function for the case that the object has been initialized.\n\n5. A lazy import without `at_startup` being imported at startup is now an error (it used to just print a message, which is less useful than an error traceback).\n\n6. Implement [__matmul__](https://www.python.org/dev/peps/pep-0465/) (pointless in Python 2, but useful for Python 3).\n\n7. Clean up the function `lazy_import` a bit.\n\nBranch/Commit: 4dda1ae48c5cfcf4a2b0325ae80cb7d6bfb4e2dc\n\nReviewer: Vincent Delecroix\n\nAuthor: Jeroen Demeyer\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/22755\n\n",
    "closed_at": "2017-06-22T07:24:37Z",
    "created_at": "2017-04-04T15:01:25Z",
    "labels": [
        "component: misc"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "Various fixes to lazy imports",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22755",
    "user": "https://github.com/jdemeyer"
}
```
Assorted fixes to lazy imports:

1. Drop support for `lazy_import(overwrite=False)` which was used only in one place in a dubious way to implement a 2-level lazy import (a lazy import being lazily imported).

2. More optimal code for binary operations like `__add__` by avoiding the `operator` module.

3. Move the code to replace a lazy import in a class namespace from `_get_object()` to `__get__`.

4. Partially inline `_get_object()` with a new `cdef inline` function for the case that the object has been initialized.

5. A lazy import without `at_startup` being imported at startup is now an error (it used to just print a message, which is less useful than an error traceback).

6. Implement [__matmul__](https://www.python.org/dev/peps/pep-0465/) (pointless in Python 2, but useful for Python 3).

7. Clean up the function `lazy_import` a bit.

Branch/Commit: 4dda1ae48c5cfcf4a2b0325ae80cb7d6bfb4e2dc

Reviewer: Vincent Delecroix

Author: Jeroen Demeyer

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/22755





---

archive/issue_comments_334111.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-04-04T15:29:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22755#issuecomment-334111",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_334112.json:
```json
{
    "body": "<a id='comment:2'></a>New commits:",
    "created_at": "2017-04-04T15:29:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22755#issuecomment-334112",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>New commits:



---

archive/issue_comments_334113.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,16 @@\n-Assorted fixes to lazy imports.\n+Assorted fixes to lazy imports:\n+\n+1. Drop support for \\`lazy_import(overwrite=False)\\` which was used only in one place in a dubious way to implement a 2-level lazy import (a lazy import being lazily imported).\n+\n+2. More optimal code for binary operations like \\`__add__\\` by avoiding the \\`operator\\` module.\n+\n+3. Move the code to replace a lazy import in a class namespace from \\`_get_object()\\` to \\`__get__\\`.\n+\n+4. A lazy import without \\`at_startup\\` being imported at startup is now an error (it used to just print a message, which is less useful than an error traceback).\n+\n+5. Implement \\`__matmul__\\` (pointless in Python 2, but useful for Python 3).\n+\n+6. Clean up the function \\`lazy_import\\` a bit.\n \n Author: Jeroen Demeyer\n \n```\n",
    "created_at": "2017-04-05T08:12:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22755#issuecomment-334113",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,16 @@
-Assorted fixes to lazy imports.
+Assorted fixes to lazy imports:
+
+1. Drop support for \`lazy_import(overwrite=False)\` which was used only in one place in a dubious way to implement a 2-level lazy import (a lazy import being lazily imported).
+
+2. More optimal code for binary operations like \`__add__\` by avoiding the \`operator\` module.
+
+3. Move the code to replace a lazy import in a class namespace from \`_get_object()\` to \`__get__\`.
+
+4. A lazy import without \`at_startup\` being imported at startup is now an error (it used to just print a message, which is less useful than an error traceback).
+
+5. Implement \`__matmul__\` (pointless in Python 2, but useful for Python 3).
+
+6. Clean up the function \`lazy_import\` a bit.
 
 Author: Jeroen Demeyer
 
```




---

archive/issue_comments_334114.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,16 @@\n+Assorted fixes to lazy imports:\n \n+1. Drop support for \\`lazy_import(overwrite=False)\\` which was used only in one place in a dubious way to implement a 2-level lazy import (a lazy import being lazily imported).\n+\n+2. More optimal code for binary operations like \\`__add__\\` by avoiding the \\`operator\\` module.\n+\n+3. Move the code to replace a lazy import in a class namespace from \\`_get_object()\\` to \\`__get__\\`.\n+\n+4. A lazy import without \\`at_startup\\` being imported at startup is now an error (it used to just print a message, which is less useful than an error traceback).\n+\n+5. Implement [__matmul__](https://www.python.org/dev/peps/pep-0465/) (pointless in Python 2, but useful for Python 3).\n+\n+6. Clean up the function \\`lazy_import\\` a bit.\n \n Author: Jeroen Demeyer\n \n```\n",
    "created_at": "2017-04-05T08:15:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22755#issuecomment-334114",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,16 @@
+Assorted fixes to lazy imports:
 
+1. Drop support for \`lazy_import(overwrite=False)\` which was used only in one place in a dubious way to implement a 2-level lazy import (a lazy import being lazily imported).
+
+2. More optimal code for binary operations like \`__add__\` by avoiding the \`operator\` module.
+
+3. Move the code to replace a lazy import in a class namespace from \`_get_object()\` to \`__get__\`.
+
+4. A lazy import without \`at_startup\` being imported at startup is now an error (it used to just print a message, which is less useful than an error traceback).
+
+5. Implement [__matmul__](https://www.python.org/dev/peps/pep-0465/) (pointless in Python 2, but useful for Python 3).
+
+6. Clean up the function \`lazy_import\` a bit.
 
 Author: Jeroen Demeyer
 
```




---

archive/issue_comments_334115.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-04-05T10:10:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22755#issuecomment-334115",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_334116.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-05T12:27:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22755#issuecomment-334116",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_334117.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-10T17:33:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22755#issuecomment-334117",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_334118.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,18 @@\n+Assorted fixes to lazy imports:\n \n+1. Drop support for \\`lazy_import(overwrite=False)\\` which was used only in one place in a dubious way to implement a 2-level lazy import (a lazy import being lazily imported).\n+\n+2. More optimal code for binary operations like \\`__add__\\` by avoiding the \\`operator\\` module.\n+\n+3. Move the code to replace a lazy import in a class namespace from \\`_get_object()\\` to \\`__get__\\`.\n+\n+4. Partially inline \\`_get_object()\\` with a new \\`cdef inline\\` function for the case that the object has been initialized.\n+\n+5. A lazy import without \\`at_startup\\` being imported at startup is now an error (it used to just print a message, which is less useful than an error traceback).\n+\n+6. Implement [__matmul__](https://www.python.org/dev/peps/pep-0465/) (pointless in Python 2, but useful for Python 3).\n+\n+7. Clean up the function \\`lazy_import\\` a bit.\n \n Author: Jeroen Demeyer\n \n```\n",
    "created_at": "2017-04-10T19:59:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22755#issuecomment-334118",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,18 @@
+Assorted fixes to lazy imports:
 
+1. Drop support for \`lazy_import(overwrite=False)\` which was used only in one place in a dubious way to implement a 2-level lazy import (a lazy import being lazily imported).
+
+2. More optimal code for binary operations like \`__add__\` by avoiding the \`operator\` module.
+
+3. Move the code to replace a lazy import in a class namespace from \`_get_object()\` to \`__get__\`.
+
+4. Partially inline \`_get_object()\` with a new \`cdef inline\` function for the case that the object has been initialized.
+
+5. A lazy import without \`at_startup\` being imported at startup is now an error (it used to just print a message, which is less useful than an error traceback).
+
+6. Implement [__matmul__](https://www.python.org/dev/peps/pep-0465/) (pointless in Python 2, but useful for Python 3).
+
+7. Clean up the function \`lazy_import\` a bit.
 
 Author: Jeroen Demeyer
 
```




---

archive/issue_comments_334119.json:
```json
{
    "body": "<a id='comment:10'></a>You expect the following traceback to be accepted by doctests?\n\n```\nTraceback (most recent call last):\n  File \"/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 498, in _run\n    self.compile_and_execute(example, compiler, test.globs)\n  File \"/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 861, in compile_and_execute\n    exec(compiled, globs)\n  File \"<doctest sage.misc.lazy_import.test_fake_startup[3]>\", line 1, in <module>\n    my_ZZ(Integer(123))\n  File \"sage/misc/lazy_import.pyx\", line 346, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:3495)\n    return self._get_object()(*args, **kwds)\n  File \"sage/misc/lazy_import.pyx\", line 210, in sage.misc.lazy_import.LazyImport._get_object (build/cythonized/sage/misc/lazy_import.c:2139)\n    raise RuntimeError(f\"resolving lazy import {self._name} during startup\")\nRuntimeError: resolving lazy import ZZ during startup\n```",
    "created_at": "2017-05-19T18:11:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22755#issuecomment-334119",
    "user": "https://github.com/videlec"
}
```

<a id='comment:10'></a>You expect the following traceback to be accepted by doctests?

```
Traceback (most recent call last):
  File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 498, in _run
    self.compile_and_execute(example, compiler, test.globs)
  File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 861, in compile_and_execute
    exec(compiled, globs)
  File "<doctest sage.misc.lazy_import.test_fake_startup[3]>", line 1, in <module>
    my_ZZ(Integer(123))
  File "sage/misc/lazy_import.pyx", line 346, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:3495)
    return self._get_object()(*args, **kwds)
  File "sage/misc/lazy_import.pyx", line 210, in sage.misc.lazy_import.LazyImport._get_object (build/cythonized/sage/misc/lazy_import.c:2139)
    raise RuntimeError(f"resolving lazy import {self._name} during startup")
RuntimeError: resolving lazy import ZZ during startup
```



---

archive/issue_comments_334120.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-19T18:31:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22755#issuecomment-334120",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_334121.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:10 vdelecroix]:\n> You expect the following traceback to be accepted by doctests?\n\n\nApparently yes (see patchbot) :-)\n\nAnyway, I fixed it.",
    "created_at": "2017-05-19T18:36:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22755#issuecomment-334121",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>Replying to [comment:10 vdelecroix]:
> You expect the following traceback to be accepted by doctests?


Apparently yes (see patchbot) :-)

Anyway, I fixed it.



---

archive/issue_comments_334122.json:
```json
{
    "body": "<a id='comment:13'></a>Weird patchbot failure on quasar! Do you think it is related to your ticket?",
    "created_at": "2017-05-23T16:14:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22755#issuecomment-334122",
    "user": "https://github.com/videlec"
}
```

<a id='comment:13'></a>Weird patchbot failure on quasar! Do you think it is related to your ticket?



---

archive/issue_comments_334123.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [comment:13 vdelecroix]:\n> Weird patchbot failure on quasar! Do you think it is related to your ticket?\n\n\nAlmost certainly not.",
    "created_at": "2017-05-24T04:55:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22755#issuecomment-334123",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>Replying to [comment:13 vdelecroix]:
> Weird patchbot failure on quasar! Do you think it is related to your ticket?


Almost certainly not.



---

archive/issue_comments_334124.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:14 jdemeyer]:\n> Replying to [comment:13 vdelecroix]:\n> > Weird patchbot failure on quasar! Do you think it is related to your ticket?\n\n> \n> Almost certainly not.\n\n\nNote that all tests pass on some other tickets. I will relaunch it.",
    "created_at": "2017-05-24T13:17:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22755#issuecomment-334124",
    "user": "https://github.com/videlec"
}
```

<a id='comment:15'></a>Replying to [comment:14 jdemeyer]:
> Replying to [comment:13 vdelecroix]:
> > Weird patchbot failure on quasar! Do you think it is related to your ticket?

> 
> Almost certainly not.


Note that all tests pass on some other tickets. I will relaunch it.



---

archive/issue_comments_334125.json:
```json
{
    "body": "<a id='comment:16'></a>The most recent patchbot run passes all tests.",
    "created_at": "2017-06-02T12:47:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22755#issuecomment-334125",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'></a>The most recent patchbot run passes all tests.



---

archive/issue_comments_334126.json:
```json
{
    "body": "<a id='comment:17'></a>The documentation of the `overwrite` argument in `lazy_import` disappeard.\n\nNOTE: though it is deprecated",
    "created_at": "2017-06-03T17:52:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22755#issuecomment-334126",
    "user": "https://github.com/videlec"
}
```

<a id='comment:17'></a>The documentation of the `overwrite` argument in `lazy_import` disappeard.

NOTE: though it is deprecated



---

archive/issue_comments_334127.json:
```json
{
    "body": "<a id='comment:18'></a>Why stuff from `sage.dynamics.interval_exchanges` and `sage.dynamics.flat_surfaces` not lazily imported anymore?",
    "created_at": "2017-06-03T17:59:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22755#issuecomment-334127",
    "user": "https://github.com/videlec"
}
```

<a id='comment:18'></a>Why stuff from `sage.dynamics.interval_exchanges` and `sage.dynamics.flat_surfaces` not lazily imported anymore?



---

archive/issue_comments_334128.json:
```json
{
    "body": "<a id='comment:19'></a>As I tried to explain in the ticket description, it was lazily importing a lazy import.",
    "created_at": "2017-06-03T18:39:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22755#issuecomment-334128",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'></a>As I tried to explain in the ticket description, it was lazily importing a lazy import.



---

archive/issue_comments_334129.json:
```json
{
    "body": "<a id='comment:20'></a>Ping?",
    "created_at": "2017-06-20T13:37:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22755#issuecomment-334129",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>Ping?



---

archive/issue_comments_334130.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-06-20T17:14:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22755#issuecomment-334130",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_334131.json:
```json
{
    "body": "<a id='comment:22'></a>done!",
    "created_at": "2017-06-20T17:15:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22755#issuecomment-334131",
    "user": "https://github.com/videlec"
}
```

<a id='comment:22'></a>done!



---

archive/issue_comments_334132.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-06-22T07:24:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22755#issuecomment-334132",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_059240.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-06-22T07:24:37Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/22755",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22755#event-59240"
}
```
