# Issue 22361: Unhelpful error message in creation of SetPartition

archive/issues_022124.json:
```json
{
    "assignees": [],
    "body": "`SetPartition([[1,2],[2,3]])` gives `AssertionError`. It should give `ValueError` with a meaningful exception string.\n\n(Original example below.)\n\nThis code produces an assertion error:\n\n```\nsage: n=3\nsage: d = {pi: pi.descents(from_zero=False) for pi in Permutations(n)}\nsage: C = [[pi for pi in d if d[pi]==des] for des in d.values()]\nsage: SetPartition(C)\n...\nsage-develop/local/lib/python2.7/site-packages/sage/combinat/set_partition.pyc in check(self)\n    152             sage: s.check()\n    153         \"\"\"\n--> 154         assert self in self.parent()\n    155 \n    156     def __hash__(self):\n\nAssertionError: \n```\nAlthough after looking twice the reason for the error is clear, it would be good to have a more helpful error message, indicating that there were duplicate elements, etc.\n\nCC:  @sagetrac-sage-combinat @tscrim @darijgr @alauve @zabrocki\n\nBranch/Commit: **[public/combinat/improve_set_partitions-22361](https://github.com/sagemath/sagetrac-mirror/tree/public/combinat/improve_set_partitions-22361) @ [`74c437b`](https://github.com/sagemath/sagetrac-mirror/commit/74c437b5d1234d88f274d742707b239512744bcf)**\n\nAuthor: **Travis Scrimshaw**\n\nComponent: **combinatorics**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/22361_\n\n",
    "created_at": "2017-02-12T14:05:13Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20combinatorics",
        "https://github.com/sagemath/sage/labels/p%3A%20minor%20/%204",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Unhelpful error message in creation of SetPartition",
    "type": "issue",
    "updated_at": "2022-12-29T01:40:48Z",
    "url": "https://github.com/sagemath/sage/issues/22361",
    "user": "https://github.com/mantepse"
}
```
`SetPartition([[1,2],[2,3]])` gives `AssertionError`. It should give `ValueError` with a meaningful exception string.

(Original example below.)

This code produces an assertion error:

```
sage: n=3
sage: d = {pi: pi.descents(from_zero=False) for pi in Permutations(n)}
sage: C = [[pi for pi in d if d[pi]==des] for des in d.values()]
sage: SetPartition(C)
...
sage-develop/local/lib/python2.7/site-packages/sage/combinat/set_partition.pyc in check(self)
    152             sage: s.check()
    153         """
--> 154         assert self in self.parent()
    155 
    156     def __hash__(self):

AssertionError: 
```
Although after looking twice the reason for the error is clear, it would be good to have a more helpful error message, indicating that there were duplicate elements, etc.

CC:  @sagetrac-sage-combinat @tscrim @darijgr @alauve @zabrocki

Branch/Commit: **[public/combinat/improve_set_partitions-22361](https://github.com/sagemath/sagetrac-mirror/tree/public/combinat/improve_set_partitions-22361) @ [`74c437b`](https://github.com/sagemath/sagetrac-mirror/commit/74c437b5d1234d88f274d742707b239512744bcf)**

Author: **Travis Scrimshaw**

Component: **combinatorics**

_Issue created by migration from https://trac.sagemath.org/ticket/22361_





---

archive/issue_events_310003.json:
```json
{
    "actor": "https://github.com/mantepse",
    "created_at": "2017-02-12T14:05:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "milestone_number": null,
    "milestone_title": "sage-7.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22361#event-310003"
}
```



---

archive/issue_events_310004.json:
```json
{
    "actor": "https://github.com/mantepse",
    "created_at": "2017-02-12T14:05:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20combinatorics",
    "label_color": "0000ff",
    "label_name": "c: combinatorics",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22361#event-310004"
}
```



---

archive/issue_events_310005.json:
```json
{
    "actor": "https://github.com/mantepse",
    "created_at": "2017-02-12T14:05:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22361#event-310005"
}
```



---

archive/issue_events_310006.json:
```json
{
    "actor": "https://github.com/mantepse",
    "created_at": "2017-02-12T14:05:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22361#event-310006"
}
```



---

archive/issue_comments_330512.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nYour `C` is unhashable. Compare `SetPartition([[(1,2),(3,4)],[(5,6)]]` and `SetPartition([[[1,2],[3,4]],[This is the Trac macro *5,6* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#5,6-macro)])`; tuples are immutable, lists are mutable.\n\nAnyways, the error message should be better.",
    "created_at": "2017-02-12T14:14:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22361#issuecomment-330512",
    "user": "https://github.com/jm58660"
}
```

<div id="comment:1" align="right">comment:1</div>

Your `C` is unhashable. Compare `SetPartition([[(1,2),(3,4)],[(5,6)]]` and `SetPartition([[[1,2],[3,4]],[This is the Trac macro *5,6* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#5,6-macro)])`; tuples are immutable, lists are mutable.

Anyways, the error message should be better.



---

archive/issue_comments_330513.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nActually, I made a worse mistake.  `C` contains duplicate elements...\n\nCan I close this ticket?",
    "created_at": "2017-02-12T14:37:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22361#issuecomment-330513",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:2" align="right">comment:2</div>

Actually, I made a worse mistake.  `C` contains duplicate elements...

Can I close this ticket?



---

archive/issue_comments_330514.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nReplying to [@mantepse](#comment:2):\n\n> Can I close this ticket?\n\nChange milestone to sage-invalid/duplicate/wontfix and put to needs review -state. I can then mark as positive review.\n\nBut I think you found a kind of bug. Why was the error message like what you get?",
    "created_at": "2017-02-12T15:03:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22361#issuecomment-330514",
    "user": "https://github.com/jm58660"
}
```

<div id="comment:3" align="right">comment:3</div>

Replying to [@mantepse](#comment:2):

> Can I close this ticket?

Change milestone to sage-invalid/duplicate/wontfix and put to needs review -state. I can then mark as positive review.

But I think you found a kind of bug. Why was the error message like what you get?



---

archive/issue_events_310007.json:
```json
{
    "actor": "https://github.com/mantepse",
    "created_at": "2017-02-12T16:17:58Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22361#event-310007"
}
```



---

archive/issue_events_310008.json:
```json
{
    "actor": "https://github.com/mantepse",
    "created_at": "2017-02-12T16:17:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20minor%20/%204",
    "label_color": "ffe799",
    "label_name": "p: minor / 4",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22361#event-310008"
}
```



---

archive/issue_comments_330515.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,9 +1,18 @@\n-So far, I've no idea what's wrong.  Here is the code, it produces an assertion error:\n+This code produces an assertion error:\n \n ```\n sage: n=3\n sage: d = {pi: pi.descents(from_zero=False) for pi in Permutations(n)}\n sage: C = [[pi for pi in d if d[pi]==des] for des in d.values()]\n sage: SetPartition(C)\n+...\n+sage-develop/local/lib/python2.7/site-packages/sage/combinat/set_partition.pyc in check(self)\n+    152             sage: s.check()\n+    153         \"\"\"\n+--> 154         assert self in self.parent()\n+    155 \n+    156     def __hash__(self):\n+\n+AssertionError: \n ```\n-\n+Although after looking twice the reason for the error is clear, it would be good to have a more helpful error message, indicating that there were duplicate elements, etc.\n``````\n",
    "created_at": "2017-02-12T16:17:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22361#issuecomment-330515",
    "user": "https://github.com/mantepse"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,9 +1,18 @@
-So far, I've no idea what's wrong.  Here is the code, it produces an assertion error:
+This code produces an assertion error:
 
 ```
 sage: n=3
 sage: d = {pi: pi.descents(from_zero=False) for pi in Permutations(n)}
 sage: C = [[pi for pi in d if d[pi]==des] for des in d.values()]
 sage: SetPartition(C)
+...
+sage-develop/local/lib/python2.7/site-packages/sage/combinat/set_partition.pyc in check(self)
+    152             sage: s.check()
+    153         """
+--> 154         assert self in self.parent()
+    155 
+    156     def __hash__(self):
+
+AssertionError: 
 ```
-
+Although after looking twice the reason for the error is clear, it would be good to have a more helpful error message, indicating that there were duplicate elements, etc.
``````




---

archive/issue_events_310009.json:
```json
{
    "actor": "https://github.com/mantepse",
    "created_at": "2017-02-12T16:17:58Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "title_is": "Unhelpful error message in creation of SetPartition",
    "title_was": "Bug in creation of SetPartition",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22361#event-310009"
}
```



---

archive/issue_comments_330516.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nTravis knows more about how to correct this.",
    "created_at": "2017-02-12T18:52:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22361#issuecomment-330516",
    "user": "https://github.com/jm58660"
}
```

<div id="comment:5" align="right">comment:5</div>

Travis knows more about how to correct this.



---

archive/issue_comments_330517.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nThe problem is in how `SetPartition(foo)` works. It assumes that `foo` corresponds to an element in `SetPartitions()`, which is the disjoint union of all set partitions of `[n]`. I would make the `__classcall_private__` actually try somewhat to construct the correct set of set partitions. Another problem is that the constructor is not quite permissive enough when constructing the elements (or at least is trying enough to convert it to the correct datatypes).",
    "created_at": "2017-02-12T19:03:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22361#issuecomment-330517",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:6" align="right">comment:6</div>

The problem is in how `SetPartition(foo)` works. It assumes that `foo` corresponds to an element in `SetPartitions()`, which is the disjoint union of all set partitions of `[n]`. I would make the `__classcall_private__` actually try somewhat to construct the correct set of set partitions. Another problem is that the constructor is not quite permissive enough when constructing the elements (or at least is trying enough to convert it to the correct datatypes).



---

archive/issue_comments_330518.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nMinor correction: since `SetPartition([[pi] for pi in Permutations(3)])` works, I think that `SetPartitions` is what it promises to be.\n\nThus, I think the difficulty is rather to have `check` do something more fine grained than `self in self.parent()`.\n\nIf I understand correctly, `self in self.parent()` is shorthand for `self.parent().__contains__(self)` which does all the right checks, but only returns `True` or `False`.\n\nSo, the quick fix is to copy all these checks into `check`.  However, this is duplication of code.",
    "created_at": "2017-02-12T19:33:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22361#issuecomment-330518",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:7" align="right">comment:7</div>

Minor correction: since `SetPartition([[pi] for pi in Permutations(3)])` works, I think that `SetPartitions` is what it promises to be.

Thus, I think the difficulty is rather to have `check` do something more fine grained than `self in self.parent()`.

If I understand correctly, `self in self.parent()` is shorthand for `self.parent().__contains__(self)` which does all the right checks, but only returns `True` or `False`.

So, the quick fix is to copy all these checks into `check`.  However, this is duplication of code.



---

archive/issue_comments_330519.json:
```json
{
    "body": "Branch: **[u/mantepse/unhelpful_error_message_in_creation_of_setpartition](https://github.com/sagemath/sagetrac-mirror/tree/u/mantepse/unhelpful_error_message_in_creation_of_setpartition)**",
    "created_at": "2017-02-12T19:36:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22361#issuecomment-330519",
    "user": "https://github.com/mantepse"
}
```

Branch: **[u/mantepse/unhelpful_error_message_in_creation_of_setpartition](https://github.com/sagemath/sagetrac-mirror/tree/u/mantepse/unhelpful_error_message_in_creation_of_setpartition)**



---

archive/issue_comments_330520.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nVery strong -1.\n\nThe check is not the problem. The main problem that generates this error is the allowable data structures to construct elements:\n\n```\nsage: SetPartition(set(map(Set, C)))\n{{[1, 2, 3]}, {[1, 3, 2], [2, 3, 1]}, {[2, 1, 3], [3, 1, 2]}, {[3, 2, 1]}}\n```\nThe `__contains__` fails (as it should) because a list is not a set.\n\nHowever, there is another potential issue with the containment check not being strict enough because the set partition corresponding to, e.g., `C` is not in the enumerated set. I'm okay with `SetPartitions()` being a generic parent, but it is technically wrong that `set(map(Set, C)) in SetPartitions()`. Fixing this means we need to be more specific about the parent that `SetPartition.__classcall_private__` constructs.\n\nEdit - +1 to changing to raising `ValueError`.",
    "created_at": "2017-02-12T19:44:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22361#issuecomment-330520",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:9" align="right">comment:9</div>

Very strong -1.

The check is not the problem. The main problem that generates this error is the allowable data structures to construct elements:

```
sage: SetPartition(set(map(Set, C)))
{{[1, 2, 3]}, {[1, 3, 2], [2, 3, 1]}, {[2, 1, 3], [3, 1, 2]}, {[3, 2, 1]}}
```
The `__contains__` fails (as it should) because a list is not a set.

However, there is another potential issue with the containment check not being strict enough because the set partition corresponding to, e.g., `C` is not in the enumerated set. I'm okay with `SetPartitions()` being a generic parent, but it is technically wrong that `set(map(Set, C)) in SetPartitions()`. Fixing this means we need to be more specific about the parent that `SetPartition.__classcall_private__` constructs.

Edit - +1 to changing to raising `ValueError`.



---

archive/issue_comments_330521.json:
```json
{
    "body": "Commit: **[`ae7488d`](https://github.com/sagemath/sagetrac-mirror/commit/ae7488d45136782df7f3cbab33aa1819a3336fbb)**",
    "created_at": "2017-02-12T19:44:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22361#issuecomment-330521",
    "user": "https://github.com/tscrim"
}
```

Commit: **[`ae7488d`](https://github.com/sagemath/sagetrac-mirror/commit/ae7488d45136782df7f3cbab33aa1819a3336fbb)**



---

archive/issue_comments_330522.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,7 @@\n+`SetPartition([[1,2],[2,3]])` gives `AssertionError`. It should give `ValueError` with a meaningful exception string.\n+\n+(Original example below.)\n+\n This code produces an assertion error:\n \n ```\n``````\n",
    "created_at": "2017-02-13T08:11:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22361#issuecomment-330522",
    "user": "https://github.com/jm58660"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,7 @@
+`SetPartition([[1,2],[2,3]])` gives `AssertionError`. It should give `ValueError` with a meaningful exception string.
+
+(Original example below.)
+
 This code produces an assertion error:
 
 ```
``````




---

archive/issue_comments_330523.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nSorry, I do not understand.  Are you saying that `set(map(Set, C)) in SetPartitions()` should return `False`?\n\nIf so, then `SetPartitions.__contains__` should be as simple as `isinstance(x, SetPartition)`, no?",
    "created_at": "2017-02-13T15:24:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22361#issuecomment-330523",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:11" align="right">comment:11</div>

Sorry, I do not understand.  Are you saying that `set(map(Set, C)) in SetPartitions()` should return `False`?

If so, then `SetPartitions.__contains__` should be as simple as `isinstance(x, SetPartition)`, no?



---

archive/issue_comments_330524.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@mantepse](#comment:11):\n> Sorry, I do not understand.  Are you saying that `set(map(Set, C)) in SetPartitions()` should return `False`?\n\nI would say yes. However, that is a problem for another ticket since the fix is much more in-depth than what we should be doing on this ticket.\n\n> If so, then `SetPartitions.__contains__` should be as simple as `isinstance(x, SetPartition)`, no?\n\nNo! That would completely circumvent the checks.",
    "created_at": "2017-02-13T15:30:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22361#issuecomment-330524",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@mantepse](#comment:11):
> Sorry, I do not understand.  Are you saying that `set(map(Set, C)) in SetPartitions()` should return `False`?

I would say yes. However, that is a problem for another ticket since the fix is much more in-depth than what we should be doing on this ticket.

> If so, then `SetPartitions.__contains__` should be as simple as `isinstance(x, SetPartition)`, no?

No! That would completely circumvent the checks.



---

archive/issue_comments_330525.json:
```json
{
    "body": "<div id=\"comment:13\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/cde0e458741b69322ad3d6bf4c021fc9c706766c\"><code>cde0e45</code></a></td><td><code>remove SetPartitions.__contains__</code></td></tr></table>\n",
    "created_at": "2017-02-13T15:37:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22361#issuecomment-330525",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:13"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/cde0e458741b69322ad3d6bf4c021fc9c706766c"><code>cde0e45</code></a></td><td><code>remove SetPartitions.__contains__</code></td></tr></table>




---

archive/issue_comments_330526.json:
```json
{
    "body": "Changed commit from **[`ae7488d`](https://github.com/sagemath/sagetrac-mirror/commit/ae7488d45136782df7f3cbab33aa1819a3336fbb)** to **[`cde0e45`](https://github.com/sagemath/sagetrac-mirror/commit/cde0e458741b69322ad3d6bf4c021fc9c706766c)**",
    "created_at": "2017-02-13T15:37:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22361#issuecomment-330526",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`ae7488d`](https://github.com/sagemath/sagetrac-mirror/commit/ae7488d45136782df7f3cbab33aa1819a3336fbb)** to **[`cde0e45`](https://github.com/sagemath/sagetrac-mirror/commit/cde0e458741b69322ad3d6bf4c021fc9c706766c)**



---

archive/issue_comments_330527.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nTravis, I simply removed `SetPartitions.__contains__` and this seems to work.  Could you please let me know what you think is going wrong now?\n\n(concerning `SetPartitions` and `SetPartition` only, I didn't touch the rest right now.)",
    "created_at": "2017-02-13T15:41:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22361#issuecomment-330527",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:14" align="right">comment:14</div>

Travis, I simply removed `SetPartitions.__contains__` and this seems to work.  Could you please let me know what you think is going wrong now?

(concerning `SetPartitions` and `SetPartition` only, I didn't touch the rest right now.)



---

archive/issue_comments_330528.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nReplying to [@mantepse](#comment:14):\n> Travis, I simply removed `SetPartitions.__contains__` and this seems to work.  Could you please let me know what you think is going wrong now?\n\nThat defaults back to `Parent.__contains__`, which simply checks to see that the input can construct an element of itself. Hence, no check is actually performed. This is going in the wrong direction. I should have time to actually fix this today.",
    "created_at": "2017-02-13T15:49:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22361#issuecomment-330528",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:15" align="right">comment:15</div>

Replying to [@mantepse](#comment:14):
> Travis, I simply removed `SetPartitions.__contains__` and this seems to work.  Could you please let me know what you think is going wrong now?

That defaults back to `Parent.__contains__`, which simply checks to see that the input can construct an element of itself. Hence, no check is actually performed. This is going in the wrong direction. I should have time to actually fix this today.



---

archive/issue_comments_330529.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nTravis, I would like to understand (and there is no rush):\n\nI moved the check into `SetPartition.check`.  So, the check is performed when \"untrusted\" code creates a set partition.\n\nWhy is this going in the wrong direction?",
    "created_at": "2017-02-13T16:01:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22361#issuecomment-330529",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:16" align="right">comment:16</div>

Travis, I would like to understand (and there is no rush):

I moved the check into `SetPartition.check`.  So, the check is performed when "untrusted" code creates a set partition.

Why is this going in the wrong direction?



---

archive/issue_comments_330530.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@mantepse](#comment:16):\n> Travis, I would like to understand (and there is no rush):\n> \n> I moved the check into `SetPartition.check`.  So, the check is performed when \"untrusted\" code creates a set partition.\n> \n> Why is this going in the wrong direction?\n\nSorry, I forgot that you moved that into the `check` function. However, this now has `__contains__` construct an element and then perform the check, the first of which is relatively slow and also requires extra function calls. It also means that subclasses cannot strictly override the `__contains__` behavior (should they want to).",
    "created_at": "2017-02-13T16:14:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22361#issuecomment-330530",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@mantepse](#comment:16):
> Travis, I would like to understand (and there is no rush):
> 
> I moved the check into `SetPartition.check`.  So, the check is performed when "untrusted" code creates a set partition.
> 
> Why is this going in the wrong direction?

Sorry, I forgot that you moved that into the `check` function. However, this now has `__contains__` construct an element and then perform the check, the first of which is relatively slow and also requires extra function calls. It also means that subclasses cannot strictly override the `__contains__` behavior (should they want to).



---

archive/issue_comments_330531.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nAlso, thinking about it (i.e. not by testing), it should allow one to create set partitions that are not in the correct parent, such as `{{1}}` could be an element of `SetPartitions(2)`.",
    "created_at": "2017-02-13T16:16:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22361#issuecomment-330531",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:18" align="right">comment:18</div>

Also, thinking about it (i.e. not by testing), it should allow one to create set partitions that are not in the correct parent, such as `{{1}}` could be an element of `SetPartitions(2)`.



---

archive/issue_comments_330532.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nWhere is `check` perform a `__contains__`? \n\n```\nsage: SetPartition([[1]]) in SetPartitions(2)\nFalse\n```\nbecause that check is performed in the various `__contains__` methods of the subclasses.  More precisely, if you want to have, for example, Set partitions of a fixed set `S`, you'd implement `__contains__` there, which would check that the union of the parts of the argument is the given set.",
    "created_at": "2017-02-13T16:24:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22361#issuecomment-330532",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:19" align="right">comment:19</div>

Where is `check` perform a `__contains__`? 

```
sage: SetPartition([[1]]) in SetPartitions(2)
False
```
because that check is performed in the various `__contains__` methods of the subclasses.  More precisely, if you want to have, for example, Set partitions of a fixed set `S`, you'd implement `__contains__` there, which would check that the union of the parts of the argument is the given set.



---

archive/issue_comments_330533.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nAs I suspected, with your branch, I can do:\n\n```\nsage: P2 = SetPartitions(2)\nsage: P2([[1]])\n{{1}}\nsage: P2([[1]]) in P2\nFalse\n```\nin contrast to the current behavior, which raises an error.",
    "created_at": "2017-02-13T16:30:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22361#issuecomment-330533",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:20" align="right">comment:20</div>

As I suspected, with your branch, I can do:

```
sage: P2 = SetPartitions(2)
sage: P2([[1]])
{{1}}
sage: P2([[1]]) in P2
False
```
in contrast to the current behavior, which raises an error.



---

archive/issue_comments_330534.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nNo, it is the other way around. If you are checking a containment, then it creates an element and performs `check`. IMO, the check of `__contains__` should be as fast as possible.",
    "created_at": "2017-02-13T16:31:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22361#issuecomment-330534",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:21" align="right">comment:21</div>

No, it is the other way around. If you are checking a containment, then it creates an element and performs `check`. IMO, the check of `__contains__` should be as fast as possible.



---

archive/issue_comments_330535.json:
```json
{
    "body": "Changed commit from **[`cde0e45`](https://github.com/sagemath/sagetrac-mirror/commit/cde0e458741b69322ad3d6bf4c021fc9c706766c)** to **[`2a53879`](https://github.com/sagemath/sagetrac-mirror/commit/2a53879192b1e6782d3dff60d8ce3ee9ce42fa99)**",
    "created_at": "2017-02-13T17:26:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22361#issuecomment-330535",
    "user": "https://github.com/tscrim"
}
```

Changed commit from **[`cde0e45`](https://github.com/sagemath/sagetrac-mirror/commit/cde0e458741b69322ad3d6bf4c021fc9c706766c)** to **[`2a53879`](https://github.com/sagemath/sagetrac-mirror/commit/2a53879192b1e6782d3dff60d8ce3ee9ce42fa99)**



---

archive/issue_comments_330536.json:
```json
{
    "body": "Author: **Travis Scrimshaw**",
    "created_at": "2017-02-13T17:26:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22361#issuecomment-330536",
    "user": "https://github.com/tscrim"
}
```

Author: **Travis Scrimshaw**



---

archive/issue_comments_330537.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nHere's a branch where your approach could not work by optimizing the `__contains__` and a few other things. At least it would not work without pushing all of containment checking to `check()`, which would necessitate subclassing the element class as well.\n\nI think this is a situation of we can't have our cake and eat it too. If we want a more refined error message, then we need to duplicate some of the code in `check()`. :/ Although since it is not a big block of code, I wouldn't strictly object.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2a53879192b1e6782d3dff60d8ce3ee9ce42fa99\"><code>2a53879</code></a></td><td><code>Improving some things in set_partition.py.</code></td></tr></table>\n",
    "created_at": "2017-02-13T17:26:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22361#issuecomment-330537",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:22" align="right">comment:22</div>

Here's a branch where your approach could not work by optimizing the `__contains__` and a few other things. At least it would not work without pushing all of containment checking to `check()`, which would necessitate subclassing the element class as well.

I think this is a situation of we can't have our cake and eat it too. If we want a more refined error message, then we need to duplicate some of the code in `check()`. :/ Although since it is not a big block of code, I wouldn't strictly object.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2a53879192b1e6782d3dff60d8ce3ee9ce42fa99"><code>2a53879</code></a></td><td><code>Improving some things in set_partition.py.</code></td></tr></table>




---

archive/issue_comments_330538.json:
```json
{
    "body": "Changed branch from **[u/mantepse/unhelpful_error_message_in_creation_of_setpartition](https://github.com/sagemath/sagetrac-mirror/tree/u/mantepse/unhelpful_error_message_in_creation_of_setpartition)** to **[public/combinat/improve_set_partitions-22361](https://github.com/sagemath/sagetrac-mirror/tree/public/combinat/improve_set_partitions-22361)**",
    "created_at": "2017-02-13T17:26:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22361#issuecomment-330538",
    "user": "https://github.com/tscrim"
}
```

Changed branch from **[u/mantepse/unhelpful_error_message_in_creation_of_setpartition](https://github.com/sagemath/sagetrac-mirror/tree/u/mantepse/unhelpful_error_message_in_creation_of_setpartition)** to **[public/combinat/improve_set_partitions-22361](https://github.com/sagemath/sagetrac-mirror/tree/public/combinat/improve_set_partitions-22361)**



---

archive/issue_comments_330539.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nOK, I made a mistake (`check` would need to be implemented in all subclasses, too).  Anyway, I'm back to try to understand how all this works.  Here is what I thought.  Could you please point out precisely where I'm wrong?\n\n1) `x in SetPartitions(17)` should simply check whether the parent is correct.  That is, `__contains__` should *not* be overwritten.\n\n2) For each kind of set partition, we need to implement `check`, which should throw an error, if the argument is not good.  To make this work, `check` should actually be implemented in the parent class.  Is this impossible or undesirable?",
    "created_at": "2017-02-13T18:52:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22361#issuecomment-330539",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:23" align="right">comment:23</div>

OK, I made a mistake (`check` would need to be implemented in all subclasses, too).  Anyway, I'm back to try to understand how all this works.  Here is what I thought.  Could you please point out precisely where I'm wrong?

1) `x in SetPartitions(17)` should simply check whether the parent is correct.  That is, `__contains__` should *not* be overwritten.

2) For each kind of set partition, we need to implement `check`, which should throw an error, if the argument is not good.  To make this work, `check` should actually be implemented in the parent class.  Is this impossible or undesirable?



---

archive/issue_comments_330540.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nReplying to [@mantepse](#comment:23):\n> OK, I made a mistake (`check` would need to be implemented in all subclasses, too).  Anyway, I'm back to try to understand how all this works.  Here is what I thought.  Could you please point out precisely where I'm wrong?\n> \n> 1) `x in SetPartitions(17)` should simply check whether the parent is correct.  That is, `__contains__` should *not* be overwritten.\n\nThis is not true. If the parent of `x` is not `S = SetPartitions(17)`, then it tries `x == S(x)` (which could involve an additional coercion attempt for the `==`). In fact, I am advocating that `__contains__` *should* be overwritten.\n\n> 2) For each kind of set partition, we need to implement `check`, which should throw an error, if the argument is not good.  To make this work, `check` should actually be implemented in the parent class.  Is this impossible or undesirable?\n\nNo, we would need to implement `check` in each element class for the respective parents, which means a new element class for each parent. This is the first thing that we want to avoid. The second is that it makes `__contains__` much slower (relatively) because it has to construct a new element (which then has to be destroyed because it is transient no matter what). I don't think a (slightly) more detailed error message is worth this.",
    "created_at": "2017-02-13T23:35:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22361#issuecomment-330540",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:24" align="right">comment:24</div>

Replying to [@mantepse](#comment:23):
> OK, I made a mistake (`check` would need to be implemented in all subclasses, too).  Anyway, I'm back to try to understand how all this works.  Here is what I thought.  Could you please point out precisely where I'm wrong?
> 
> 1) `x in SetPartitions(17)` should simply check whether the parent is correct.  That is, `__contains__` should *not* be overwritten.

This is not true. If the parent of `x` is not `S = SetPartitions(17)`, then it tries `x == S(x)` (which could involve an additional coercion attempt for the `==`). In fact, I am advocating that `__contains__` *should* be overwritten.

> 2) For each kind of set partition, we need to implement `check`, which should throw an error, if the argument is not good.  To make this work, `check` should actually be implemented in the parent class.  Is this impossible or undesirable?

No, we would need to implement `check` in each element class for the respective parents, which means a new element class for each parent. This is the first thing that we want to avoid. The second is that it makes `__contains__` much slower (relatively) because it has to construct a new element (which then has to be destroyed because it is transient no matter what). I don't think a (slightly) more detailed error message is worth this.



---

archive/issue_comments_330541.json:
```json
{
    "body": "Changed commit from **[`2a53879`](https://github.com/sagemath/sagetrac-mirror/commit/2a53879192b1e6782d3dff60d8ce3ee9ce42fa99)** to **[`74c437b`](https://github.com/sagemath/sagetrac-mirror/commit/74c437b5d1234d88f274d742707b239512744bcf)**",
    "created_at": "2018-04-11T18:46:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22361#issuecomment-330541",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`2a53879`](https://github.com/sagemath/sagetrac-mirror/commit/2a53879192b1e6782d3dff60d8ce3ee9ce42fa99)** to **[`74c437b`](https://github.com/sagemath/sagetrac-mirror/commit/74c437b5d1234d88f274d742707b239512744bcf)**



---

archive/issue_comments_330542.json:
```json
{
    "body": "<div id=\"comment:25\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/74c437b5d1234d88f274d742707b239512744bcf\"><code>74c437b</code></a></td><td><code>Merge branch 'public/combinat/improve_set_partitions-22361' of git://trac.sagemath.org/sage into public/combinat/improve_set_partitions-22361</code></td></tr></table>\n",
    "created_at": "2018-04-11T18:46:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22361#issuecomment-330542",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:25"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/74c437b5d1234d88f274d742707b239512744bcf"><code>74c437b</code></a></td><td><code>Merge branch 'public/combinat/improve_set_partitions-22361' of git://trac.sagemath.org/sage into public/combinat/improve_set_partitions-22361</code></td></tr></table>




---

archive/issue_events_310010.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2018-04-11T18:49:07Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "milestone_number": null,
    "milestone_title": "sage-7.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22361#event-310010"
}
```



---

archive/issue_events_310011.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2018-04-11T18:49:07Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "milestone_number": null,
    "milestone_title": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22361#event-310011"
}
```



---

archive/issue_events_310012.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-12-29T01:40:48Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/22361",
    "milestone_number": null,
    "milestone_title": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22361#event-310012"
}
```
