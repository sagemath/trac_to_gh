# Issue 22990: Add cpdef declarations in pxd files when overwriting a cdef method

archive/issues_022990.json:
```json
{
    "body": "CC:  @saraedum\n\nSee https://github.com/cython/cython/issues/1732.\n\nIssue created by migration from https://trac.sagemath.org/ticket/23227\n\n",
    "closed_at": "2017-08-11T18:18:03Z",
    "created_at": "2017-06-13T06:11:00Z",
    "labels": [
        "component: cython",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "Add cpdef declarations in pxd files when overwriting a cdef method",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22990",
    "user": "https://github.com/roed314"
}
```
CC:  @saraedum

See https://github.com/cython/cython/issues/1732.

Issue created by migration from https://trac.sagemath.org/ticket/23227





---

archive/issue_comments_321383.json:
```json
{
    "body": "How did you come up with this? Is there a specific concrete problem or just a theoretical bug?\n\nBy the way, the gist link talks about \"`cpdef`'d without a corresponding entry in their pxd file\" while the Cython bug talks about \"`cpdef` override of a `cdef` method\". These are obviously different things, so what is the problem exactly? If the problem is only `cpdef` overrides of `cdef` methods, I guess that a large majority of the entries in the gist link are false positives, making that link not very informative.",
    "created_at": "2017-06-13T18:40:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22990",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22990#issuecomment-321383",
    "user": "https://github.com/jdemeyer"
}
```

How did you come up with this? Is there a specific concrete problem or just a theoretical bug?

By the way, the gist link talks about "`cpdef`'d without a corresponding entry in their pxd file" while the Cython bug talks about "`cpdef` override of a `cdef` method". These are obviously different things, so what is the problem exactly? If the problem is only `cpdef` overrides of `cdef` methods, I guess that a large majority of the entries in the gist link are false positives, making that link not very informative.



---

archive/issue_comments_321384.json:
```json
{
    "body": "Replying to [comment:3 jdemeyer]:\n> How did you come up with this? Is there a specific concrete problem or just a theoretical bug?\n\n\nYeah, this caused a segfault that saraedum and I spent 10 hours yesterday debugging, while working on #23218.  Because the vtable is screwed up, function calls behave unpredictably.\n \n> By the way, the gist link talks about \"`cpdef`'d without a corresponding entry in their pxd file\" while the Cython bug talks about \"`cpdef` override of a `cdef` method\". These are obviously different things, so what is the problem exactly? If the problem is only `cpdef` overrides of `cdef` methods, I guess that a large majority of the entries in the gist link are false positives, making that link not very informative.\n\n\nYeah, I agree that the link is not that informative.  I wrote something easy to try to get an idea of the scope of the problem, then determined that it wasn't easy to actually find the cases where the problem actually occurs (which is, indeed, where a cdef method is overwritten by a cpdef method without a corresponding entry in the pxd file).  I decided that I wanted to move on and work on other stuff, so I uploaded the gist as a place to start looking.",
    "created_at": "2017-06-13T19:13:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22990",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22990#issuecomment-321384",
    "user": "https://github.com/roed314"
}
```

Replying to [comment:3 jdemeyer]:
> How did you come up with this? Is there a specific concrete problem or just a theoretical bug?


Yeah, this caused a segfault that saraedum and I spent 10 hours yesterday debugging, while working on #23218.  Because the vtable is screwed up, function calls behave unpredictably.
 
> By the way, the gist link talks about "`cpdef`'d without a corresponding entry in their pxd file" while the Cython bug talks about "`cpdef` override of a `cdef` method". These are obviously different things, so what is the problem exactly? If the problem is only `cpdef` overrides of `cdef` methods, I guess that a large majority of the entries in the gist link are false positives, making that link not very informative.


Yeah, I agree that the link is not that informative.  I wrote something easy to try to get an idea of the scope of the problem, then determined that it wasn't easy to actually find the cases where the problem actually occurs (which is, indeed, where a cdef method is overwritten by a cpdef method without a corresponding entry in the pxd file).  I decided that I wanted to move on and work on other stuff, so I uploaded the gist as a place to start looking.



---

archive/issue_comments_321385.json:
```json
{
    "body": "Replying to [comment:4 roed]:\n> Replying to [comment:3 jdemeyer]:\n> > How did you come up with this? Is there a specific concrete problem or just a theoretical bug?\n\n> \n> Yeah, this caused a segfault that saraedum and I spent 10 hours yesterday debugging, while working on #23218.  Because the vtable is screwed up, function calls behave unpredictably.\n\n\nIn particular, we noticed the problem for `Polynomial_generic_dense`, where `_add_`, `_mul_` and `_floordiv_` have this issue.",
    "created_at": "2017-06-13T19:15:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22990",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22990#issuecomment-321385",
    "user": "https://github.com/roed314"
}
```

Replying to [comment:4 roed]:
> Replying to [comment:3 jdemeyer]:
> > How did you come up with this? Is there a specific concrete problem or just a theoretical bug?

> 
> Yeah, this caused a segfault that saraedum and I spent 10 hours yesterday debugging, while working on #23218.  Because the vtable is screwed up, function calls behave unpredictably.


In particular, we noticed the problem for `Polynomial_generic_dense`, where `_add_`, `_mul_` and `_floordiv_` have this issue.



---

archive/issue_comments_321386.json:
```json
{
    "body": "Honestly, I don't think it is realistic to fix the general problem in Sage since the underlying problem is in upstream Cython. Of course, we can fix specific cases like the `Polynomial_generic_dense` that you mentioned.",
    "created_at": "2017-06-13T19:46:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22990",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22990#issuecomment-321386",
    "user": "https://github.com/jdemeyer"
}
```

Honestly, I don't think it is realistic to fix the general problem in Sage since the underlying problem is in upstream Cython. Of course, we can fix specific cases like the `Polynomial_generic_dense` that you mentioned.



---

archive/issue_comments_321387.json:
```json
{
    "body": "Replying to [comment:6 jdemeyer]:\n> Honestly, I don't think it is realistic to fix the general problem in Sage since the underlying problem is in upstream Cython. Of course, we can fix specific cases like the `Polynomial_generic_dense` that you mentioned.\n\n\nSure, and I'm fine waiting to see what Cython does.  But one possible thing for them to do is to require a cpdef declaration in the pxd file, in which case this ticket can track those additions.",
    "created_at": "2017-06-13T19:55:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22990",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22990#issuecomment-321387",
    "user": "https://github.com/roed314"
}
```

Replying to [comment:6 jdemeyer]:
> Honestly, I don't think it is realistic to fix the general problem in Sage since the underlying problem is in upstream Cython. Of course, we can fix specific cases like the `Polynomial_generic_dense` that you mentioned.


Sure, and I'm fine waiting to see what Cython does.  But one possible thing for them to do is to require a cpdef declaration in the pxd file, in which case this ticket can track those additions.



---

archive/issue_comments_321388.json:
```json
{
    "body": "Replying to [comment:7 roed]:\n> Replying to [comment:6 jdemeyer]:\n> > Honestly, I don't think it is realistic to fix the general problem in Sage since the underlying problem is in upstream Cython. Of course, we can fix specific cases like the `Polynomial_generic_dense` that you mentioned.\n\n> \n> Sure, and I'm fine waiting to see what Cython does.  But one possible thing for them to do is to require a cpdef declaration in the pxd file, in which case this ticket can track those additions.\n\n\nCython will soon raise an error in these cases.  I think the best thing to do is to wait until we update to a new version of Cython and change these pxd files then.  I think it's worth leaving this ticket open until that point in case someone else runs into a similar problem.",
    "created_at": "2017-06-15T06:27:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22990",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22990#issuecomment-321388",
    "user": "https://github.com/roed314"
}
```

Replying to [comment:7 roed]:
> Replying to [comment:6 jdemeyer]:
> > Honestly, I don't think it is realistic to fix the general problem in Sage since the underlying problem is in upstream Cython. Of course, we can fix specific cases like the `Polynomial_generic_dense` that you mentioned.

> 
> Sure, and I'm fine waiting to see what Cython does.  But one possible thing for them to do is to require a cpdef declaration in the pxd file, in which case this ticket can track those additions.


Cython will soon raise an error in these cases.  I think the best thing to do is to wait until we update to a new version of Cython and change these pxd files then.  I think it's worth leaving this ticket open until that point in case someone else runs into a similar problem.



---

archive/issue_comments_321389.json:
```json
{
    "body": "Replying to [comment:8 roed]:\n> Cython will soon raise an error in these cases.\n\n\nI convinced Cython upstream to downgrade this to a warning for now. That will make our life easier, since we can first upgrade to Cython 0.26 (in beta now) and then fix this gradually.",
    "created_at": "2017-07-05T14:53:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22990",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22990#issuecomment-321389",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:8 roed]:
> Cython will soon raise an error in these cases.


I convinced Cython upstream to downgrade this to a warning for now. That will make our life easier, since we can first upgrade to Cython 0.26 (in beta now) and then fix this gradually.



---

archive/issue_comments_321390.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-08-03T16:54:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22990",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22990#issuecomment-321390",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_321391.json:
```json
{
    "body": "Ready for review?",
    "created_at": "2017-08-07T10:02:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22990",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22990#issuecomment-321391",
    "user": "https://github.com/jdemeyer"
}
```

Ready for review?



---

archive/issue_comments_321392.json:
```json
{
    "body": "Why restrict to `_add_` and `_mul_`? (edit: you are not doing that, it's just the commit message implying that you do)",
    "created_at": "2017-08-07T10:04:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22990",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22990#issuecomment-321392",
    "user": "https://github.com/jdemeyer"
}
```

Why restrict to `_add_` and `_mul_`? (edit: you are not doing that, it's just the commit message implying that you do)



---

archive/issue_comments_321393.json:
```json
{
    "body": "Yeah, I just got lazy going through and figuring out all the functions that I'd actually changed.  I used the log of warnings to find the places to edit, so I think I got them all, but I haven't rebuilt from scratch to check.",
    "created_at": "2017-08-07T17:32:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22990",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22990#issuecomment-321393",
    "user": "https://github.com/roed314"
}
```

Yeah, I just got lazy going through and figuring out all the functions that I'd actually changed.  I used the log of warnings to find the places to edit, so I think I got them all, but I haven't rebuilt from scratch to check.



---

archive/issue_comments_321394.json:
```json
{
    "body": "Yeah, I think this is ready for review.  I don't have anything else to add to it.",
    "created_at": "2017-08-07T17:33:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22990",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22990#issuecomment-321394",
    "user": "https://github.com/roed314"
}
```

Yeah, I think this is ready for review.  I don't have anything else to add to it.



---

archive/issue_comments_321395.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-08-07T17:33:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22990",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22990#issuecomment-321395",
    "user": "https://github.com/roed314"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_321396.json:
```json
{
    "body": "Replying to [comment:16 roed]:\n> Yeah, I just got lazy going through and figuring out all the functions that I'd actually changed.  I used the log of warnings to find the places to edit, so I think I got them all, but I haven't rebuilt from scratch to check.\n\n\nEven if you didn't catch them all, that's not really a problem.",
    "created_at": "2017-08-08T07:58:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22990",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22990#issuecomment-321396",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:16 roed]:
> Yeah, I just got lazy going through and figuring out all the functions that I'd actually changed.  I used the log of warnings to find the places to edit, so I think I got them all, but I haven't rebuilt from scratch to check.


Even if you didn't catch them all, that's not really a problem.



---

archive/issue_comments_321397.json:
```json
{
    "body": "Rebased to 8.1.beta1\n\n---\nNew commits:",
    "created_at": "2017-08-08T08:00:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22990",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22990#issuecomment-321397",
    "user": "https://github.com/jdemeyer"
}
```

Rebased to 8.1.beta1

---
New commits:



---

archive/issue_comments_321398.json:
```json
{
    "body": "Why this?\n\n```diff\n-    cpdef normalize(self)\n+    cpdef normalize(self, include_zeroth_moment = *)\n```",
    "created_at": "2017-08-08T08:02:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22990",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22990#issuecomment-321398",
    "user": "https://github.com/jdemeyer"
}
```

Why this?

```diff
-    cpdef normalize(self)
+    cpdef normalize(self, include_zeroth_moment = *)
```



---

archive/issue_comments_321399.json:
```json
{
    "body": "In some cases, I am wondering whether it is better to add \"abstract\" `_add_` and `_mul_` methods on a lower level. For example, instead of adding those functions to `QuaternionAlgebraElement_generic`, `QuaternionAlgebraElement_number_field` and `QuaternionAlgebraElement_rational_field`, add them to `QuaternionAlgebraElement_abstract` raising `NotImplementedError`.\n\nConcretely for this ticket, I would like to fix only the totally uncontroversial cases (for example, undoing the changes to quaternion algebra elements) and leave the rest for a follow-up.",
    "created_at": "2017-08-08T08:10:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22990",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22990#issuecomment-321399",
    "user": "https://github.com/jdemeyer"
}
```

In some cases, I am wondering whether it is better to add "abstract" `_add_` and `_mul_` methods on a lower level. For example, instead of adding those functions to `QuaternionAlgebraElement_generic`, `QuaternionAlgebraElement_number_field` and `QuaternionAlgebraElement_rational_field`, add them to `QuaternionAlgebraElement_abstract` raising `NotImplementedError`.

Concretely for this ticket, I would like to fix only the totally uncontroversial cases (for example, undoing the changes to quaternion algebra elements) and leave the rest for a follow-up.



---

archive/issue_comments_321400.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-08-08T08:48:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22990",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22990#issuecomment-321400",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_321401.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-08-08T12:38:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22990",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22990#issuecomment-321401",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_321402.json:
```json
{
    "body": "positive_review to this strict subset of the original patch.",
    "created_at": "2017-08-08T12:38:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22990",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22990#issuecomment-321402",
    "user": "https://github.com/jdemeyer"
}
```

positive_review to this strict subset of the original patch.



---

archive/issue_comments_321403.json:
```json
{
    "body": "See #23600 for the followup.",
    "created_at": "2017-08-08T21:28:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22990",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22990#issuecomment-321403",
    "user": "https://github.com/roed314"
}
```

See #23600 for the followup.



---

archive/issue_comments_321404.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-08-11T18:18:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22990",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22990#issuecomment-321404",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_059925.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-08-11T18:18:03Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/22990",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22990#event-59925"
}
```
