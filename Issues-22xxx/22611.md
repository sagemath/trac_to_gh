# Issue 22611: Replace _sage_doc_ by a __doc__ descriptor

archive/issues_022374.json:
```json
{
    "assignees": [],
    "body": "Currently, the method `_sage_doc_` is used to implement custom documentation for instances of a class. Such a use case makes sense, but it should be implemented as the `__doc__` attribute instead of the Sage-specific `_sage_doc_`.\n\nI tried various ways of implementing this and I found several Cython bugs along the way. The current solution is not the cleanest, but it works in all cases (Cython and Python, extension types and normal classes).\n\nIn the cases where `_sage_doc_` was implemented for a base class, this patch requires adding `@instancedoc` to every subclass. This is because Python never inherits the `__doc__` attribute. There is a way around this using a metaclass, but I avoided that because metaclasses have their own problems (see #21681).\n\nCC:  @hivert @nthiery\n\nKeywords: **days85**\n\nBranch/Commit: **[5fe7cb0](https://github.com/sagemath/sagetrac-mirror/commit/5fe7cb01a8cd117ac6754c8301fb5ddf94d82813)**\n\nReviewer: **Erik Bray**\n\nAuthor: **Jeroen Demeyer**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/22611_\n\n",
    "closed_at": "2017-03-29T16:51:16Z",
    "created_at": "2017-03-15T20:20:27Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20documentation",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-7.6",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Replace _sage_doc_ by a __doc__ descriptor",
    "type": "issue",
    "updated_at": "2017-03-29T16:51:16Z",
    "url": "https://github.com/sagemath/sage/issues/22611",
    "user": "https://github.com/jdemeyer"
}
```
Currently, the method `_sage_doc_` is used to implement custom documentation for instances of a class. Such a use case makes sense, but it should be implemented as the `__doc__` attribute instead of the Sage-specific `_sage_doc_`.

I tried various ways of implementing this and I found several Cython bugs along the way. The current solution is not the cleanest, but it works in all cases (Cython and Python, extension types and normal classes).

In the cases where `_sage_doc_` was implemented for a base class, this patch requires adding `@instancedoc` to every subclass. This is because Python never inherits the `__doc__` attribute. There is a way around this using a metaclass, but I avoided that because metaclasses have their own problems (see #21681).

CC:  @hivert @nthiery

Keywords: **days85**

Branch/Commit: **[5fe7cb0](https://github.com/sagemath/sagetrac-mirror/commit/5fe7cb01a8cd117ac6754c8301fb5ddf94d82813)**

Reviewer: **Erik Bray**

Author: **Jeroen Demeyer**

_Issue created by migration from https://trac.sagemath.org/ticket/22611_





---

archive/issue_events_287194.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-03-15T20:20:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "milestone_number": null,
    "milestone_title": "sage-7.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22611#event-287194"
}
```



---

archive/issue_events_287195.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-03-15T20:20:27Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20documentation",
    "label_color": "0075ca",
    "label_name": "component: documentation",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22611#event-287195"
}
```



---

archive/issue_events_287196.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-03-15T20:20:27Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22611#event-287196"
}
```



---

archive/issue_events_287197.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-03-15T20:20:27Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22611#event-287197"
}
```



---

archive/issue_comments_337900.json:
```json
{
    "body": "Changed keywords from **** to **days85**",
    "created_at": "2017-03-17T09:06:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22611#issuecomment-337900",
    "user": "https://github.com/jdemeyer"
}
```

Changed keywords from **** to **days85**



---

archive/issue_comments_337901.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,5 @@\n The method `_sage_doc_` is used to have custom documentation for instances of a class. Such a use case makes sense, but it should be implemented as the `__doc__` attribute instead of the Sage-specific `_sage_doc_`.\n \n This is easy for Python classes, but it might be problematic for `cdef class`es.\n+\n+Unfortunately, this hits some Cython bugs involving `@`decorators.\n``````\n",
    "created_at": "2017-03-17T09:06:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22611#issuecomment-337901",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,5 @@
 The method `_sage_doc_` is used to have custom documentation for instances of a class. Such a use case makes sense, but it should be implemented as the `__doc__` attribute instead of the Sage-specific `_sage_doc_`.
 
 This is easy for Python classes, but it might be problematic for `cdef class`es.
+
+Unfortunately, this hits some Cython bugs involving `@`decorators.
``````




---

archive/issue_comments_337902.json:
```json
{
    "body": "Branch: **[u/jdemeyer/ticket/22611](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/22611)**",
    "created_at": "2017-03-17T21:45:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22611#issuecomment-337902",
    "user": "https://github.com/jdemeyer"
}
```

Branch: **[u/jdemeyer/ticket/22611](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/22611)**



---

archive/issue_comments_337903.json:
```json
{
    "body": "Commit: **[3264657](https://github.com/sagemath/sagetrac-mirror/commit/326465738e5a563ebffc86196f400829650cee63)**",
    "created_at": "2017-03-17T21:46:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22611#issuecomment-337903",
    "user": "https://github.com/jdemeyer"
}
```

Commit: **[3264657](https://github.com/sagemath/sagetrac-mirror/commit/326465738e5a563ebffc86196f400829650cee63)**



---

archive/issue_events_287198.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-03-17T21:46:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22611#event-287198"
}
```



---

archive/issue_comments_337904.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,5 +1,3 @@\n The method `_sage_doc_` is used to have custom documentation for instances of a class. Such a use case makes sense, but it should be implemented as the `__doc__` attribute instead of the Sage-specific `_sage_doc_`.\n \n-This is easy for Python classes, but it might be problematic for `cdef class`es.\n-\n-Unfortunately, this hits some Cython bugs involving `@`decorators.\n+I tried various ways of implementing this and I was various Cython bugs along the way. The current solution is not the cleanest, but it works in all cases.\n``````\n",
    "created_at": "2017-03-17T21:46:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22611#issuecomment-337904",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,5 +1,3 @@
 The method `_sage_doc_` is used to have custom documentation for instances of a class. Such a use case makes sense, but it should be implemented as the `__doc__` attribute instead of the Sage-specific `_sage_doc_`.
 
-This is easy for Python classes, but it might be problematic for `cdef class`es.
-
-Unfortunately, this hits some Cython bugs involving `@`decorators.
+I tried various ways of implementing this and I was various Cython bugs along the way. The current solution is not the cleanest, but it works in all cases.
``````




---

archive/issue_comments_337905.json:
```json
{
    "body": "<a id='comment:3'>Comment 3:</a>\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/326465738e5a563ebffc86196f400829650cee63\">3264657</a></td><td><code>Replace `_sage_doc_` by a `__doc__` descriptor</code></td></tr></table>\n",
    "created_at": "2017-03-17T21:46:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22611#issuecomment-337905",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'>Comment 3:</a>
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/326465738e5a563ebffc86196f400829650cee63">3264657</a></td><td><code>Replace `_sage_doc_` by a `__doc__` descriptor</code></td></tr></table>




---

archive/issue_comments_337906.json:
```json
{
    "body": "<a id='comment:4'>Comment 4:</a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/fa42d8eb1966a7e1ade67bb40b42a80bb04059b1\">fa42d8e</a></td><td><code>Replace `_sage_doc_` by a `__doc__` descriptor</code></td></tr></table>\n",
    "created_at": "2017-03-17T23:08:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22611#issuecomment-337906",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:4'>Comment 4:</a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/fa42d8eb1966a7e1ade67bb40b42a80bb04059b1">fa42d8e</a></td><td><code>Replace `_sage_doc_` by a `__doc__` descriptor</code></td></tr></table>




---

archive/issue_comments_337907.json:
```json
{
    "body": "Changed commit from **[3264657](https://github.com/sagemath/sagetrac-mirror/commit/326465738e5a563ebffc86196f400829650cee63)** to **[fa42d8e](https://github.com/sagemath/sagetrac-mirror/commit/fa42d8eb1966a7e1ade67bb40b42a80bb04059b1)**",
    "created_at": "2017-03-17T23:08:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22611#issuecomment-337907",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[3264657](https://github.com/sagemath/sagetrac-mirror/commit/326465738e5a563ebffc86196f400829650cee63)** to **[fa42d8e](https://github.com/sagemath/sagetrac-mirror/commit/fa42d8eb1966a7e1ade67bb40b42a80bb04059b1)**



---

archive/issue_comments_337908.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\nThere was an issue building the docs due to `src/sage/parallel/decorate.py`. I did not understand the problem but I fixed it anyway with\n\n```diff\ndiff --git a/src/sage/parallel/decorate.py b/src/sage/parallel/decorate.py\nindex ebc06e2..3305724 100644\n--- a/src/sage/parallel/decorate.py\n+++ b/src/sage/parallel/decorate.py\n@@ -284,8 +287,7 @@ for a in args[0]))\n             sage: sage_getdoc(p(f))\n             'Test docstring\\n'\n         \"\"\"\n-        from sage.misc.sageinspect import sage_getdoc\n-        return sage_getdoc(self.func)\n+        return self.func.__doc__\n \n \n def parallel(p_iter='fork', ncpus=None, **kwds):\n```",
    "created_at": "2017-03-18T06:35:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22611#issuecomment-337908",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'>Comment 5:</a>
There was an issue building the docs due to `src/sage/parallel/decorate.py`. I did not understand the problem but I fixed it anyway with

```diff
diff --git a/src/sage/parallel/decorate.py b/src/sage/parallel/decorate.py
index ebc06e2..3305724 100644
--- a/src/sage/parallel/decorate.py
+++ b/src/sage/parallel/decorate.py
@@ -284,8 +287,7 @@ for a in args[0]))
             sage: sage_getdoc(p(f))
             'Test docstring\n'
         """
-        from sage.misc.sageinspect import sage_getdoc
-        return sage_getdoc(self.func)
+        return self.func.__doc__
 
 
 def parallel(p_iter='fork', ncpus=None, **kwds):
```



---

archive/issue_comments_337909.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nIn ticket description: `and I was various Cython bugs along the way`!?",
    "created_at": "2017-03-18T09:46:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22611#issuecomment-337909",
    "user": "https://github.com/videlec"
}
```

<a id='comment:6'>Comment 6:</a>
In ticket description: `and I was various Cython bugs along the way`!?



---

archive/issue_comments_337910.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,3 @@\n-The method `_sage_doc_` is used to have custom documentation for instances of a class. Such a use case makes sense, but it should be implemented as the `__doc__` attribute instead of the Sage-specific `_sage_doc_`.\n+Currently, the method `_sage_doc_` is used to implement custom documentation for instances of a class. Such a use case makes sense, but it should be implemented as the `__doc__` attribute instead of the Sage-specific `_sage_doc_`.\n \n-I tried various ways of implementing this and I was various Cython bugs along the way. The current solution is not the cleanest, but it works in all cases.\n+I tried various ways of implementing this and I found several Cython bugs along the way. The current solution is not the cleanest, but it works in all cases (Cython and Python, extension types and normal classes).\n``````\n",
    "created_at": "2017-03-18T09:52:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22611#issuecomment-337910",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,3 @@
-The method `_sage_doc_` is used to have custom documentation for instances of a class. Such a use case makes sense, but it should be implemented as the `__doc__` attribute instead of the Sage-specific `_sage_doc_`.
+Currently, the method `_sage_doc_` is used to implement custom documentation for instances of a class. Such a use case makes sense, but it should be implemented as the `__doc__` attribute instead of the Sage-specific `_sage_doc_`.
 
-I tried various ways of implementing this and I was various Cython bugs along the way. The current solution is not the cleanest, but it works in all cases.
+I tried various ways of implementing this and I found several Cython bugs along the way. The current solution is not the cleanest, but it works in all cases (Cython and Python, extension types and normal classes).
``````




---

archive/issue_comments_337911.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,5 @@\n Currently, the method `_sage_doc_` is used to implement custom documentation for instances of a class. Such a use case makes sense, but it should be implemented as the `__doc__` attribute instead of the Sage-specific `_sage_doc_`.\n \n I tried various ways of implementing this and I found several Cython bugs along the way. The current solution is not the cleanest, but it works in all cases (Cython and Python, extension types and normal classes).\n+\n+In the cases where `_sage_doc_` was implemented for a base class, this patch requires adding `@InstanceDoc` to every subclass. This is because Python never inherits the `__doc__` attribute. There is a way around this using a metaclass, but I avoided that because metaclasses have their own problems (see #21681).\n``````\n",
    "created_at": "2017-03-20T13:20:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22611#issuecomment-337911",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,5 @@
 Currently, the method `_sage_doc_` is used to implement custom documentation for instances of a class. Such a use case makes sense, but it should be implemented as the `__doc__` attribute instead of the Sage-specific `_sage_doc_`.
 
 I tried various ways of implementing this and I found several Cython bugs along the way. The current solution is not the cleanest, but it works in all cases (Cython and Python, extension types and normal classes).
+
+In the cases where `_sage_doc_` was implemented for a base class, this patch requires adding `@InstanceDoc` to every subclass. This is because Python never inherits the `__doc__` attribute. There is a way around this using a metaclass, but I avoided that because metaclasses have their own problems (see #21681).
``````




---

archive/issue_comments_337912.json:
```json
{
    "body": "Changed commit from **[fa42d8e](https://github.com/sagemath/sagetrac-mirror/commit/fa42d8eb1966a7e1ade67bb40b42a80bb04059b1)** to **[5eabe46](https://github.com/sagemath/sagetrac-mirror/commit/5eabe46ca0f929e8e09f0b90e295a0300afe3750)**",
    "created_at": "2017-03-21T09:52:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22611#issuecomment-337912",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[fa42d8e](https://github.com/sagemath/sagetrac-mirror/commit/fa42d8eb1966a7e1ade67bb40b42a80bb04059b1)** to **[5eabe46](https://github.com/sagemath/sagetrac-mirror/commit/5eabe46ca0f929e8e09f0b90e295a0300afe3750)**



---

archive/issue_comments_337913.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5eabe46ca0f929e8e09f0b90e295a0300afe3750\">5eabe46</a></td><td><code>Make coverage script happy</code></td></tr></table>\n",
    "created_at": "2017-03-21T09:52:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22611#issuecomment-337913",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:9'>Comment 9:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5eabe46ca0f929e8e09f0b90e295a0300afe3750">5eabe46</a></td><td><code>Make coverage script happy</code></td></tr></table>




---

archive/issue_comments_337914.json:
```json
{
    "body": "<a id='comment:10'>Comment 10:</a>\nThis is just a stupid comment, but I'm curious about the naming--why `@InstanceDoc` and not `@instance_doc`?  For whatever reason it's more common to name decorators with underscores instead of camel case (so much so that people will even go against the camel case convention for classes in cases where a decorator is implemented as a class).\n\nThen again, maybe the existing naming nicely calls attention to the fact that this is intended as a class decorator.",
    "created_at": "2017-03-22T13:27:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22611#issuecomment-337914",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'>Comment 10:</a>
This is just a stupid comment, but I'm curious about the naming--why `@InstanceDoc` and not `@instance_doc`?  For whatever reason it's more common to name decorators with underscores instead of camel case (so much so that people will even go against the camel case convention for classes in cases where a decorator is implemented as a class).

Then again, maybe the existing naming nicely calls attention to the fact that this is intended as a class decorator.



---

archive/issue_comments_337915.json:
```json
{
    "body": "<a id='comment:11'>Comment 11:</a>\nWhat happens if `_instancedoc_` is not defined?  Will Cython make sure an `AttributeError` is raised in this case?\n\nI think at the very least there should be a clear error message that `_instancedoc_` must be defined (including on base classes that may not have a sensible `_instancedoc_`, in which case it might be good if the descriptor also handled `NotImplemented` errors).",
    "created_at": "2017-03-22T13:36:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22611#issuecomment-337915",
    "user": "https://github.com/embray"
}
```

<a id='comment:11'>Comment 11:</a>
What happens if `_instancedoc_` is not defined?  Will Cython make sure an `AttributeError` is raised in this case?

I think at the very least there should be a clear error message that `_instancedoc_` must be defined (including on base classes that may not have a sensible `_instancedoc_`, in which case it might be good if the descriptor also handled `NotImplemented` errors).



---

archive/issue_comments_337916.json:
```json
{
    "body": "Reviewer: **Erik Bray**",
    "created_at": "2017-03-22T13:48:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22611#issuecomment-337916",
    "user": "https://github.com/embray"
}
```

Reviewer: **Erik Bray**



---

archive/issue_comments_337917.json:
```json
{
    "body": "<a id='comment:12'>Comment 12:</a>\nLGTM otherwise. Clever way to abuse the Python internals a bit, though I can't see anything inherently wrong with it, since tp_doc is suppose to be able to be NULL.",
    "created_at": "2017-03-22T13:48:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22611#issuecomment-337917",
    "user": "https://github.com/embray"
}
```

<a id='comment:12'>Comment 12:</a>
LGTM otherwise. Clever way to abuse the Python internals a bit, though I can't see anything inherently wrong with it, since tp_doc is suppose to be able to be NULL.



---

archive/issue_comments_337918.json:
```json
{
    "body": "<a id='comment:13'>Comment 13:</a>\nReplying to [@embray](#comment%3A12):\n> LGTM otherwise. Clever way to abuse the Python internals a bit\n\nLike I say on the ticket description, this is the only way to make it work for all classes. Any pure Python implementation wouldn't work for extension types.",
    "created_at": "2017-03-22T15:11:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22611#issuecomment-337918",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'>Comment 13:</a>
Replying to [@embray](#comment%3A12):
> LGTM otherwise. Clever way to abuse the Python internals a bit

Like I say on the ticket description, this is the only way to make it work for all classes. Any pure Python implementation wouldn't work for extension types.



---

archive/issue_events_287199.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-03-22T15:12:52Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22611#event-287199"
}
```



---

archive/issue_events_287200.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-03-22T15:12:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22611#event-287200"
}
```



---

archive/issue_comments_337919.json:
```json
{
    "body": "<a id='comment:14'>Comment 14:</a>\nReplying to [@embray](#comment%3A11):\n> What happens if `_instancedoc_` is not defined?  Will Cython make sure an `AttributeError` is raised in this case?\n\nYes, `AttributeError` works the same way in Cython.",
    "created_at": "2017-03-22T15:12:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22611#issuecomment-337919",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'>Comment 14:</a>
Replying to [@embray](#comment%3A11):
> What happens if `_instancedoc_` is not defined?  Will Cython make sure an `AttributeError` is raised in this case?

Yes, `AttributeError` works the same way in Cython.



---

archive/issue_comments_337920.json:
```json
{
    "body": "<a id='comment:15'>Comment 15:</a>\nReplying to [@embray](#comment%3A11):\n> What happens if `_instancedoc_` is not defined?  Will Cython make sure an `AttributeError` is raised in this case?\n> \n> I think at the very least there should be a clear error message that `_instancedoc_` must be defined\n\nYou mean an error which is not just `AttributeError: 'foo' object has no attribute '_instancedoc_'`?",
    "created_at": "2017-03-22T15:15:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22611#issuecomment-337920",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:15'>Comment 15:</a>
Replying to [@embray](#comment%3A11):
> What happens if `_instancedoc_` is not defined?  Will Cython make sure an `AttributeError` is raised in this case?
> 
> I think at the very least there should be a clear error message that `_instancedoc_` must be defined

You mean an error which is not just `AttributeError: 'foo' object has no attribute '_instancedoc_'`?



---

archive/issue_comments_337921.json:
```json
{
    "body": "<a id='comment:16'>Comment 16:</a>\nRight.  For example, in classes with the `ABCMeta` metaclass, if there are any unimplemented `abstractproperty` or `abstractmethod`, trying to instantiate the class results in:\n\n```\nTypeError: Can't instantiate abstract class A with abstract methods foo\n```\n\nThis is a slightly different case of course, since it's an error that would occur at class definition time.  I was just using this as an example of a clearer error message.",
    "created_at": "2017-03-22T16:04:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22611#issuecomment-337921",
    "user": "https://github.com/embray"
}
```

<a id='comment:16'>Comment 16:</a>
Right.  For example, in classes with the `ABCMeta` metaclass, if there are any unimplemented `abstractproperty` or `abstractmethod`, trying to instantiate the class results in:

```
TypeError: Can't instantiate abstract class A with abstract methods foo
```

This is a slightly different case of course, since it's an error that would occur at class definition time.  I was just using this as an example of a clearer error message.



---

archive/issue_comments_337922.json:
```json
{
    "body": "<a id='comment:17'>Comment 17:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f92c25856bd33edfe0b157f9504c2d5a73d4caac\">f92c258</a></td><td><code>Doctest an example where `_instancedoc_` is not defined</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/676a80428a980b326a936a42759ff3ba88398f27\">676a804</a></td><td><code>Rename InstanceDoc -> instancedoc</code></td></tr></table>\n",
    "created_at": "2017-03-22T16:12:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22611#issuecomment-337922",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:17'>Comment 17:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f92c25856bd33edfe0b157f9504c2d5a73d4caac">f92c258</a></td><td><code>Doctest an example where `_instancedoc_` is not defined</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/676a80428a980b326a936a42759ff3ba88398f27">676a804</a></td><td><code>Rename InstanceDoc -> instancedoc</code></td></tr></table>




---

archive/issue_comments_337923.json:
```json
{
    "body": "Changed commit from **[5eabe46](https://github.com/sagemath/sagetrac-mirror/commit/5eabe46ca0f929e8e09f0b90e295a0300afe3750)** to **[676a804](https://github.com/sagemath/sagetrac-mirror/commit/676a80428a980b326a936a42759ff3ba88398f27)**",
    "created_at": "2017-03-22T16:12:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22611#issuecomment-337923",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[5eabe46](https://github.com/sagemath/sagetrac-mirror/commit/5eabe46ca0f929e8e09f0b90e295a0300afe3750)** to **[676a804](https://github.com/sagemath/sagetrac-mirror/commit/676a80428a980b326a936a42759ff3ba88398f27)**



---

archive/issue_comments_337924.json:
```json
{
    "body": "<a id='comment:18'>Comment 18:</a>\nI replaced `InstanceDoc` with `instancedoc` (I didn't use `instance_doc` just because the method name `_instancedoc_` doesn't have an underscore either. And anyway, Python uses `staticmethod` and not `static_method`.)",
    "created_at": "2017-03-22T16:14:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22611#issuecomment-337924",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'>Comment 18:</a>
I replaced `InstanceDoc` with `instancedoc` (I didn't use `instance_doc` just because the method name `_instancedoc_` doesn't have an underscore either. And anyway, Python uses `staticmethod` and not `static_method`.)



---

archive/issue_comments_337925.json:
```json
{
    "body": "<a id='comment:19'>Comment 19:</a>\nI still don't think the `AttributeError` is very useful, especially considering that you're getting an exception from a builtin module and can't see in the traceback what's actually causing it.  Of course, if one is implementing a class using `@instancedoc` this should be expected, but it still might seem mysterious, I think, compared to a slightly customized message (it could still be an `AttributeError`, though `TypeError` is used more commonly for cases where an expected interface is not found--e.g. `len()` on an object with no `__len__`.).",
    "created_at": "2017-03-22T16:21:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22611#issuecomment-337925",
    "user": "https://github.com/embray"
}
```

<a id='comment:19'>Comment 19:</a>
I still don't think the `AttributeError` is very useful, especially considering that you're getting an exception from a builtin module and can't see in the traceback what's actually causing it.  Of course, if one is implementing a class using `@instancedoc` this should be expected, but it still might seem mysterious, I think, compared to a slightly customized message (it could still be an `AttributeError`, though `TypeError` is used more commonly for cases where an expected interface is not found--e.g. `len()` on an object with no `__len__`.).



---

archive/issue_comments_337926.json:
```json
{
    "body": "<a id='comment:20'>Comment 20:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5fe7cb01a8cd117ac6754c8301fb5ddf94d82813\">5fe7cb0</a></td><td><code>Change exception message for missing _instancedoc_</code></td></tr></table>\n",
    "created_at": "2017-03-23T10:17:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22611#issuecomment-337926",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:20'>Comment 20:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5fe7cb01a8cd117ac6754c8301fb5ddf94d82813">5fe7cb0</a></td><td><code>Change exception message for missing _instancedoc_</code></td></tr></table>




---

archive/issue_comments_337927.json:
```json
{
    "body": "Changed commit from **[676a804](https://github.com/sagemath/sagetrac-mirror/commit/676a80428a980b326a936a42759ff3ba88398f27)** to **[5fe7cb0](https://github.com/sagemath/sagetrac-mirror/commit/5fe7cb01a8cd117ac6754c8301fb5ddf94d82813)**",
    "created_at": "2017-03-23T10:17:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22611#issuecomment-337927",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[676a804](https://github.com/sagemath/sagetrac-mirror/commit/676a80428a980b326a936a42759ff3ba88398f27)** to **[5fe7cb0](https://github.com/sagemath/sagetrac-mirror/commit/5fe7cb01a8cd117ac6754c8301fb5ddf94d82813)**



---

archive/issue_comments_337928.json:
```json
{
    "body": "<a id='comment:21'>Comment 21:</a>\nHere you go...",
    "created_at": "2017-03-23T10:21:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22611#issuecomment-337928",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'>Comment 21:</a>
Here you go...



---

archive/issue_events_287201.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-03-23T10:21:30Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22611#event-287201"
}
```



---

archive/issue_events_287202.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-03-23T10:21:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22611#event-287202"
}
```



---

archive/issue_comments_337929.json:
```json
{
    "body": "<a id='comment:22'>Comment 22:</a>\nGreat, I think that's a lot nicer!  Thanks for this--honestly this is so useful I think some form of this should be implemented in Python.  I might suggest that, actually, since I see the question of per-instance docstrings come up from time to time, with no good solution.  If some kind of `__instancedoc__` special method were built into Python it would obviate the need for the special descriptor or the decorator.",
    "created_at": "2017-03-23T11:05:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22611#issuecomment-337929",
    "user": "https://github.com/embray"
}
```

<a id='comment:22'>Comment 22:</a>
Great, I think that's a lot nicer!  Thanks for this--honestly this is so useful I think some form of this should be implemented in Python.  I might suggest that, actually, since I see the question of per-instance docstrings come up from time to time, with no good solution.  If some kind of `__instancedoc__` special method were built into Python it would obviate the need for the special descriptor or the decorator.



---

archive/issue_events_287203.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-03-23T11:05:51Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22611#event-287203"
}
```



---

archive/issue_events_287204.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-03-23T11:05:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22611#event-287204"
}
```



---

archive/issue_comments_337930.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -2,4 +2,4 @@\n \n I tried various ways of implementing this and I found several Cython bugs along the way. The current solution is not the cleanest, but it works in all cases (Cython and Python, extension types and normal classes).\n \n-In the cases where `_sage_doc_` was implemented for a base class, this patch requires adding `@InstanceDoc` to every subclass. This is because Python never inherits the `__doc__` attribute. There is a way around this using a metaclass, but I avoided that because metaclasses have their own problems (see #21681).\n+In the cases where `_sage_doc_` was implemented for a base class, this patch requires adding `@instancedoc` to every subclass. This is because Python never inherits the `__doc__` attribute. There is a way around this using a metaclass, but I avoided that because metaclasses have their own problems (see #21681).\n``````\n",
    "created_at": "2017-03-23T20:36:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22611#issuecomment-337930",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -2,4 +2,4 @@
 
 I tried various ways of implementing this and I found several Cython bugs along the way. The current solution is not the cleanest, but it works in all cases (Cython and Python, extension types and normal classes).
 
-In the cases where `_sage_doc_` was implemented for a base class, this patch requires adding `@InstanceDoc` to every subclass. This is because Python never inherits the `__doc__` attribute. There is a way around this using a metaclass, but I avoided that because metaclasses have their own problems (see #21681).
+In the cases where `_sage_doc_` was implemented for a base class, this patch requires adding `@instancedoc` to every subclass. This is because Python never inherits the `__doc__` attribute. There is a way around this using a metaclass, but I avoided that because metaclasses have their own problems (see #21681).
``````




---

archive/issue_comments_337931.json:
```json
{
    "body": "<a id='comment:24'>Comment 24:</a>\nThanks!",
    "created_at": "2017-03-23T20:36:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22611#issuecomment-337931",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'>Comment 24:</a>
Thanks!



---

archive/issue_comments_337932.json:
```json
{
    "body": "Changed branch from **[u/jdemeyer/ticket/22611](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/22611)** to **[5fe7cb0](https://github.com/sagemath/sagetrac-mirror/commit/5fe7cb01a8cd117ac6754c8301fb5ddf94d82813)**",
    "created_at": "2017-03-29T16:51:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22611#issuecomment-337932",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/jdemeyer/ticket/22611](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/22611)** to **[5fe7cb0](https://github.com/sagemath/sagetrac-mirror/commit/5fe7cb01a8cd117ac6754c8301fb5ddf94d82813)**



---

archive/issue_events_287205.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-03-29T16:51:16Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22611#event-287205"
}
```



---

archive/issue_events_287206.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "8e22bbf0171c3e502a11c2e162140b219b5bce67",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2017-03-29T16:51:16Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/22611",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22611#event-287206"
}
```
