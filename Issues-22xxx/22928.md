# Issue 22928: Conversion between gmpy2 and sage objects

archive/issues_022691.json:
```json
{
    "body": "The library `gmpy2` supports conversions by the use of special methods. In order to allow conversion of Sage objects into gmpy2 objects, we implement the following methods\n- `__mpz__` on Sage Integer\n- `__mpq__` on Sage Rational\n- `__mpfr__` on relevant Sage real numbers\n   - `RealNumber` (`sage.rings.real_mpfr`)\n   - `RealDoubleElement` (`sage.rings.real_double`)\n- `__mpc__` on relevant Sage complex numbers\n   - `ComplexDoubleElement` (`sage.rings.complex_double`)\n   - `MPComplexNumber` (`sage.rings.complex_mpc`)\n   - `ComplexNumber` (`sage.rings.complex_number`)\n\nConversly, we make Sage integer, rational, real and complex constructors accept gmpy2 arguments.\n\nUpstream issues:\n- https://github.com/aleaxit/gmpy/pull/180\n- https://github.com/aleaxit/gmpy/pull/181\n\nAssignee: @vinklein\n\nCC:  @videlec\n\nKeywords: thursdaysbdx\n\nReviewer: Jeroen Demeyer, Vincent Delecroix\n\nAuthor: Vincent Klein\n\nBranch: e9a6fdaf5e130e826929c4d9a6617a2128afe3d0\n\nDependencies: #24549\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/22928\n\n",
    "closed_at": "2018-02-02T12:06:15Z",
    "created_at": "2017-05-02T09:03:14Z",
    "labels": [
        "component: interfaces"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Conversion between gmpy2 and sage objects",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22928",
    "user": "https://github.com/vinklein"
}
```
The library `gmpy2` supports conversions by the use of special methods. In order to allow conversion of Sage objects into gmpy2 objects, we implement the following methods
- `__mpz__` on Sage Integer
- `__mpq__` on Sage Rational
- `__mpfr__` on relevant Sage real numbers
   - `RealNumber` (`sage.rings.real_mpfr`)
   - `RealDoubleElement` (`sage.rings.real_double`)
- `__mpc__` on relevant Sage complex numbers
   - `ComplexDoubleElement` (`sage.rings.complex_double`)
   - `MPComplexNumber` (`sage.rings.complex_mpc`)
   - `ComplexNumber` (`sage.rings.complex_number`)

Conversly, we make Sage integer, rational, real and complex constructors accept gmpy2 arguments.

Upstream issues:
- https://github.com/aleaxit/gmpy/pull/180
- https://github.com/aleaxit/gmpy/pull/181

Assignee: @vinklein

CC:  @videlec

Keywords: thursdaysbdx

Reviewer: Jeroen Demeyer, Vincent Delecroix

Author: Vincent Klein

Branch: e9a6fdaf5e130e826929c4d9a6617a2128afe3d0

Dependencies: #24549

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/22928





---

archive/issue_comments_337148.json:
```json
{
    "body": "Set assignee to @vinklein.",
    "created_at": "2017-05-02T15:05:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337148",
    "user": "https://github.com/vinklein"
}
```

Set assignee to @vinklein.



---

archive/issue_comments_337149.json:
```json
{
    "body": "Changing keywords from \"\" to \"jsb++\".",
    "created_at": "2017-05-11T15:26:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337149",
    "user": "https://github.com/videlec"
}
```

Changing keywords from "" to "jsb++".



---

archive/issue_comments_337150.json:
```json
{
    "body": "Changing keywords from \"jsb++\" to \"thursdaysbdx\".",
    "created_at": "2017-05-11T15:28:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337150",
    "user": "https://github.com/videlec"
}
```

Changing keywords from "jsb++" to "thursdaysbdx".



---

archive/issue_comments_337151.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,7 +1,7 @@\n Conversion between gmpy2 and sage integers:\n - Implement method `__mpz__` on sage integer: return an gmpy2 mpz \n - Implement method `__mpq__` on sage rational: return an gmpy2 mpq\n-- Implement constructor for sage integer and rational with respectively mpz and mpq parameters.\n+- Add conversion functions from gmpy2's mpz and mpq to sage integer and rational.\n - Provide coercion.\n \n Author: Vincent Klein\n``````\n",
    "created_at": "2017-05-11T16:16:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337151",
    "user": "https://github.com/vinklein"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,7 +1,7 @@
 Conversion between gmpy2 and sage integers:
 - Implement method `__mpz__` on sage integer: return an gmpy2 mpz 
 - Implement method `__mpq__` on sage rational: return an gmpy2 mpq
-- Implement constructor for sage integer and rational with respectively mpz and mpq parameters.
+- Add conversion functions from gmpy2's mpz and mpq to sage integer and rational.
 - Provide coercion.
 
 Author: Vincent Klein
``````




---

archive/issue_comments_337152.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-16T14:06:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337152",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_337153.json:
```json
{
    "body": "<a id='comment:8'></a>Looks good. Some small remarks.\n\n1) For the error about missing `gmpy2` you can use `PackageNotFoundError` from `sage.misc.package`\n\n2) `add __mpz__() to class Rational` should be `add __mpq__() to class Rational`\n\n3) You have an indentation problem here\n\n``` \nCoercion for gmpy2 numbers    \n    sage: from gmpy2 import * # optional - gmpy2\n    sage: a, b = cm.canonical_coercion(mpz(5), 10) # optional - gmpy2\n    sage: a, b # optional - gmpy2\n```\nIt should be\n\n```\nCoercion for gmpy2 numbers::\n\n    sage: from gmpy2 import * # optional - gmpy2\n    sage: a, b = cm.canonical_coercion(mpz(5), 10) # optional - gmpy2\n    sage: a, b # optional - gmpy2\n```\n\n4) There should be tests for `a + b`, `a * b`, `a / b` when one of `a` or `b` is from Sage and the other from `gmpy2`\n\n5) Couldn't you share\n\n```\n#Handle gmpy2 objects\nelif is_gmpy2_type(type(x)):\n    return self.canonical_coercion(py_scalar_to_element(x), y)\nelif is_gmpy2_type(type(y)):\n    return self.canonical_coercion(x, py_scalar_to_element(y))\n```\n  with the associated code that deals with numpy types?",
    "created_at": "2017-05-17T17:22:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337153",
    "user": "https://github.com/videlec"
}
```

<a id='comment:8'></a>Looks good. Some small remarks.

1) For the error about missing `gmpy2` you can use `PackageNotFoundError` from `sage.misc.package`

2) `add __mpz__() to class Rational` should be `add __mpq__() to class Rational`

3) You have an indentation problem here

``` 
Coercion for gmpy2 numbers    
    sage: from gmpy2 import * # optional - gmpy2
    sage: a, b = cm.canonical_coercion(mpz(5), 10) # optional - gmpy2
    sage: a, b # optional - gmpy2
```
It should be

```
Coercion for gmpy2 numbers::

    sage: from gmpy2 import * # optional - gmpy2
    sage: a, b = cm.canonical_coercion(mpz(5), 10) # optional - gmpy2
    sage: a, b # optional - gmpy2
```

4) There should be tests for `a + b`, `a * b`, `a / b` when one of `a` or `b` is from Sage and the other from `gmpy2`

5) Couldn't you share

```
#Handle gmpy2 objects
elif is_gmpy2_type(type(x)):
    return self.canonical_coercion(py_scalar_to_element(x), y)
elif is_gmpy2_type(type(y)):
    return self.canonical_coercion(x, py_scalar_to_element(y))
```
  with the associated code that deals with numpy types?



---

archive/issue_comments_337154.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-18T11:33:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337154",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_337155.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:8 vdelecroix]:\nDone with commit [54c04ae](https://git.sagemath.org/sage.git/commit/?id=54c04ae7c0bf7d48ca89c1e21c4184133e4c6a9c)",
    "created_at": "2017-05-18T13:27:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337155",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:10'></a>Replying to [comment:8 vdelecroix]:
Done with commit [54c04ae](https://git.sagemath.org/sage.git/commit/?id=54c04ae7c0bf7d48ca89c1e21c4184133e4c6a9c)



---

archive/issue_comments_337156.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,16 @@\n+Conversion between gmpy2 and sage integers:\n+- Implement method `__mpz__` on sage integer: return an gmpy2 mpz \n+- Implement method `__mpq__` on sage rational: return an gmpy2 mpq\n+- Add conversion functions from gmpy2's mpz and mpq to sage integer and rational.\n+- Provide coercion.\n+\n+Once gmpy2 is a standard package with the following features :\n+- direct constructors GMPy_MPZ_From_mpz, GMPy_MPQ_From_mpq, GMPy_MPQ_From_mpz\n+- a gmpy2.pxd file with relevant declarations (to be installed at the same place as gmpy2.h)\n+- #136 robust header detection (ie what should the user do in her setup.py to find out where gmpy2.h/gmpy2.pxd are?)\n+see : [#134](https://github.com/aleaxit/gmpy/pull/134), [https://github.com/aleaxit/gmpy/issues/136136](https://github.com/aleaxit/gmpy/issues/136136).\n+\n+Then remove sage.libs.gmpy2 extension and replace conversion functions gmpy2_mpz_to_sage and gmpy2_mpq_to_sage by having sage integer and rational constructors working with gmpy2 number  \n \n \n Author: Vincent Klein\n``````\n",
    "created_at": "2017-05-18T13:52:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337156",
    "user": "https://github.com/vinklein"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,16 @@
+Conversion between gmpy2 and sage integers:
+- Implement method `__mpz__` on sage integer: return an gmpy2 mpz 
+- Implement method `__mpq__` on sage rational: return an gmpy2 mpq
+- Add conversion functions from gmpy2's mpz and mpq to sage integer and rational.
+- Provide coercion.
+
+Once gmpy2 is a standard package with the following features :
+- direct constructors GMPy_MPZ_From_mpz, GMPy_MPQ_From_mpq, GMPy_MPQ_From_mpz
+- a gmpy2.pxd file with relevant declarations (to be installed at the same place as gmpy2.h)
+- #136 robust header detection (ie what should the user do in her setup.py to find out where gmpy2.h/gmpy2.pxd are?)
+see : [#134](https://github.com/aleaxit/gmpy/pull/134), [https://github.com/aleaxit/gmpy/issues/136136](https://github.com/aleaxit/gmpy/issues/136136).
+
+Then remove sage.libs.gmpy2 extension and replace conversion functions gmpy2_mpz_to_sage and gmpy2_mpq_to_sage by having sage integer and rational constructors working with gmpy2 number  
 
 
 Author: Vincent Klein
``````




---

archive/issue_comments_337157.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,16 @@\n+Conversion between gmpy2 and sage integers:\n+- Implement method `__mpz__` on sage integer: return an gmpy2 mpz \n+- Implement method `__mpq__` on sage rational: return an gmpy2 mpq\n+- Add conversion functions from gmpy2's mpz and mpq to sage integer and rational.\n+- Provide coercion.\n+\n+Once gmpy2 is a standard package with the following features :\n+- direct constructors GMPy_MPZ_From_mpz, GMPy_MPQ_From_mpq, GMPy_MPQ_From_mpz\n+- a gmpy2.pxd file with relevant declarations (to be installed at the same place as gmpy2.h)\n+- #136 robust header detection (ie what should the user do in her setup.py to find out where gmpy2.h/gmpy2.pxd are?)\n+see : [#134](https://github.com/aleaxit/gmpy/pull/134), [136](https://github.com/aleaxit/gmpy/issues/136).\n+\n+Then remove sage.libs.gmpy2 extension and replace conversion functions gmpy2_mpz_to_sage and gmpy2_mpq_to_sage by having sage integer and rational constructors working with gmpy2 number  \n \n \n Author: Vincent Klein\n``````\n",
    "created_at": "2017-05-18T13:53:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337157",
    "user": "https://github.com/vinklein"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,16 @@
+Conversion between gmpy2 and sage integers:
+- Implement method `__mpz__` on sage integer: return an gmpy2 mpz 
+- Implement method `__mpq__` on sage rational: return an gmpy2 mpq
+- Add conversion functions from gmpy2's mpz and mpq to sage integer and rational.
+- Provide coercion.
+
+Once gmpy2 is a standard package with the following features :
+- direct constructors GMPy_MPZ_From_mpz, GMPy_MPQ_From_mpq, GMPy_MPQ_From_mpz
+- a gmpy2.pxd file with relevant declarations (to be installed at the same place as gmpy2.h)
+- #136 robust header detection (ie what should the user do in her setup.py to find out where gmpy2.h/gmpy2.pxd are?)
+see : [#134](https://github.com/aleaxit/gmpy/pull/134), [136](https://github.com/aleaxit/gmpy/issues/136).
+
+Then remove sage.libs.gmpy2 extension and replace conversion functions gmpy2_mpz_to_sage and gmpy2_mpq_to_sage by having sage integer and rational constructors working with gmpy2 number  
 
 
 Author: Vincent Klein
``````




---

archive/issue_comments_337158.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,16 @@\n+Conversion between gmpy2 and sage integers:\n+- Implement method `__mpz__` on sage integer: return an gmpy2 mpz \n+- Implement method `__mpq__` on sage rational: return an gmpy2 mpq\n+- Add conversion functions from gmpy2's mpz and mpq to sage integer and rational.\n+- Provide coercion.\n+\n+Once gmpy2 is a standard package with the following features :\n+- direct constructors GMPy_MPZ_From_mpz, GMPy_MPQ_From_mpq, GMPy_MPQ_From_mpz\n+- a gmpy2.pxd file with relevant declarations (to be installed at the same place as gmpy2.h)\n+- #136 robust header detection (ie what should the user do in her setup.py to find out where gmpy2.h/gmpy2.pxd are?)\n+see : [#134](https://github.com/aleaxit/gmpy/pull/134), [#136](https://github.com/aleaxit/gmpy/issues/136).\n+\n+Then remove sage.libs.gmpy2 extension and replace conversion functions gmpy2_mpz_to_sage and gmpy2_mpq_to_sage by having sage integer and rational constructors working with gmpy2 number  \n \n \n Author: Vincent Klein\n``````\n",
    "created_at": "2017-05-18T13:57:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337158",
    "user": "https://github.com/vinklein"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,16 @@
+Conversion between gmpy2 and sage integers:
+- Implement method `__mpz__` on sage integer: return an gmpy2 mpz 
+- Implement method `__mpq__` on sage rational: return an gmpy2 mpq
+- Add conversion functions from gmpy2's mpz and mpq to sage integer and rational.
+- Provide coercion.
+
+Once gmpy2 is a standard package with the following features :
+- direct constructors GMPy_MPZ_From_mpz, GMPy_MPQ_From_mpq, GMPy_MPQ_From_mpz
+- a gmpy2.pxd file with relevant declarations (to be installed at the same place as gmpy2.h)
+- #136 robust header detection (ie what should the user do in her setup.py to find out where gmpy2.h/gmpy2.pxd are?)
+see : [#134](https://github.com/aleaxit/gmpy/pull/134), [#136](https://github.com/aleaxit/gmpy/issues/136).
+
+Then remove sage.libs.gmpy2 extension and replace conversion functions gmpy2_mpz_to_sage and gmpy2_mpq_to_sage by having sage integer and rational constructors working with gmpy2 number  
 
 
 Author: Vincent Klein
``````




---

archive/issue_comments_337159.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,16 @@\n+Conversion between gmpy2 and sage integers:\n+- Implement method `__mpz__` on sage integer: return an gmpy2 mpz \n+- Implement method `__mpq__` on sage rational: return an gmpy2 mpq\n+- Add conversion functions from gmpy2's mpz and mpq to sage integer and rational.\n+- Provide coercion.\n+\n+Once gmpy2 is a standard package with the following features :\n+- direct constructors GMPy_MPZ_From_mpz, GMPy_MPQ_From_mpq, GMPy_MPQ_From_mpz\n+- #137 a gmpy2.pxd file with relevant declarations (to be installed at the same place as gmpy2.h)\n+- #136 robust header detection (ie what should the user do in her setup.py to find out where gmpy2.h/gmpy2.pxd are?)\n+see : [#134](https://github.com/aleaxit/gmpy/pull/134), [#136](https://github.com/aleaxit/gmpy/issues/136), [#137](https://github.com/aleaxit/gmpy/pull/137).\n+\n+Then remove sage.libs.gmpy2 extension and replace conversion functions gmpy2_mpz_to_sage and gmpy2_mpq_to_sage by having sage integer and rational constructors working with gmpy2 number  \n \n \n Author: Vincent Klein\n``````\n",
    "created_at": "2017-05-18T14:18:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337159",
    "user": "https://github.com/videlec"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,16 @@
+Conversion between gmpy2 and sage integers:
+- Implement method `__mpz__` on sage integer: return an gmpy2 mpz 
+- Implement method `__mpq__` on sage rational: return an gmpy2 mpq
+- Add conversion functions from gmpy2's mpz and mpq to sage integer and rational.
+- Provide coercion.
+
+Once gmpy2 is a standard package with the following features :
+- direct constructors GMPy_MPZ_From_mpz, GMPy_MPQ_From_mpq, GMPy_MPQ_From_mpz
+- #137 a gmpy2.pxd file with relevant declarations (to be installed at the same place as gmpy2.h)
+- #136 robust header detection (ie what should the user do in her setup.py to find out where gmpy2.h/gmpy2.pxd are?)
+see : [#134](https://github.com/aleaxit/gmpy/pull/134), [#136](https://github.com/aleaxit/gmpy/issues/136), [#137](https://github.com/aleaxit/gmpy/pull/137).
+
+Then remove sage.libs.gmpy2 extension and replace conversion functions gmpy2_mpz_to_sage and gmpy2_mpq_to_sage by having sage integer and rational constructors working with gmpy2 number  
 
 
 Author: Vincent Klein
``````




---

archive/issue_comments_337160.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,16 @@\n+Conversion between gmpy2 and sage integers:\n+- Implement method `__mpz__` on sage integer: return an gmpy2 mpz \n+- Implement method `__mpq__` on sage rational: return an gmpy2 mpq\n+- Add conversion functions from gmpy2's mpz and mpq to sage integer and rational.\n+- Provide coercion.\n+\n+Once gmpy2 is a standard package with the following features :\n+- direct constructors GMPy_MPZ_From_mpz, GMPy_MPQ_From_mpq, GMPy_MPQ_From_mpz\n+- [#137](https://github.com/aleaxit/gmpy/pull/137) a gmpy2.pxd file with relevant declarations (to be installed at the same place as gmpy2.h)\n+- [#136](https://github.com/aleaxit/gmpy/issues/136) robust header detection (ie what should the user do in her setup.py to find out where gmpy2.h/gmpy2.pxd are?)\n+see : [#134](https://github.com/aleaxit/gmpy/pull/134), [#136](https://github.com/aleaxit/gmpy/issues/136), [#137](https://github.com/aleaxit/gmpy/pull/137).\n+\n+Then remove sage.libs.gmpy2 extension and replace conversion functions gmpy2_mpz_to_sage and gmpy2_mpq_to_sage by having sage integer and rational constructors working with gmpy2 number  \n \n \n Author: Vincent Klein\n``````\n",
    "created_at": "2017-05-18T15:50:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337160",
    "user": "https://github.com/videlec"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,16 @@
+Conversion between gmpy2 and sage integers:
+- Implement method `__mpz__` on sage integer: return an gmpy2 mpz 
+- Implement method `__mpq__` on sage rational: return an gmpy2 mpq
+- Add conversion functions from gmpy2's mpz and mpq to sage integer and rational.
+- Provide coercion.
+
+Once gmpy2 is a standard package with the following features :
+- direct constructors GMPy_MPZ_From_mpz, GMPy_MPQ_From_mpq, GMPy_MPQ_From_mpz
+- [#137](https://github.com/aleaxit/gmpy/pull/137) a gmpy2.pxd file with relevant declarations (to be installed at the same place as gmpy2.h)
+- [#136](https://github.com/aleaxit/gmpy/issues/136) robust header detection (ie what should the user do in her setup.py to find out where gmpy2.h/gmpy2.pxd are?)
+see : [#134](https://github.com/aleaxit/gmpy/pull/134), [#136](https://github.com/aleaxit/gmpy/issues/136), [#137](https://github.com/aleaxit/gmpy/pull/137).
+
+Then remove sage.libs.gmpy2 extension and replace conversion functions gmpy2_mpz_to_sage and gmpy2_mpq_to_sage by having sage integer and rational constructors working with gmpy2 number  
 
 
 Author: Vincent Klein
``````




---

archive/issue_comments_337161.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,16 @@\n+Conversion between gmpy2 and sage integers:\n+- Implement method `__mpz__` on sage integer: return an gmpy2 mpz \n+- Implement method `__mpq__` on sage rational: return an gmpy2 mpq\n+- Add conversion functions from gmpy2's mpz and mpq to sage integer and rational.\n+- Provide coercion.\n+\n+Once gmpy2 is a standard package with the following features :\n+- [#137](https://github.com/aleaxit/gmpy/pull/137) direct constructors GMPy_MPZ_From_mpz, GMPy_MPQ_From_mpq, GMPy_MPQ_From_mpz\n+- [#137](https://github.com/aleaxit/gmpy/pull/137) a gmpy2.pxd file with relevant declarations (to be installed at the same place as gmpy2.h)\n+- [#136](https://github.com/aleaxit/gmpy/issues/136) robust header detection (ie what should the user do in her setup.py to find out where gmpy2.h/gmpy2.pxd are?)\n+see also: [#134](https://github.com/aleaxit/gmpy/pull/134)\n+\n+Then remove sage.libs.gmpy2 extension and replace conversion functions gmpy2_mpz_to_sage and gmpy2_mpq_to_sage by having sage integer and rational constructors working with gmpy2 number  \n \n \n Author: Vincent Klein\n``````\n",
    "created_at": "2017-05-18T15:51:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337161",
    "user": "https://github.com/videlec"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,16 @@
+Conversion between gmpy2 and sage integers:
+- Implement method `__mpz__` on sage integer: return an gmpy2 mpz 
+- Implement method `__mpq__` on sage rational: return an gmpy2 mpq
+- Add conversion functions from gmpy2's mpz and mpq to sage integer and rational.
+- Provide coercion.
+
+Once gmpy2 is a standard package with the following features :
+- [#137](https://github.com/aleaxit/gmpy/pull/137) direct constructors GMPy_MPZ_From_mpz, GMPy_MPQ_From_mpq, GMPy_MPQ_From_mpz
+- [#137](https://github.com/aleaxit/gmpy/pull/137) a gmpy2.pxd file with relevant declarations (to be installed at the same place as gmpy2.h)
+- [#136](https://github.com/aleaxit/gmpy/issues/136) robust header detection (ie what should the user do in her setup.py to find out where gmpy2.h/gmpy2.pxd are?)
+see also: [#134](https://github.com/aleaxit/gmpy/pull/134)
+
+Then remove sage.libs.gmpy2 extension and replace conversion functions gmpy2_mpz_to_sage and gmpy2_mpq_to_sage by having sage integer and rational constructors working with gmpy2 number  
 
 
 Author: Vincent Klein
``````




---

archive/issue_comments_337162.json:
```json
{
    "body": "<a id='comment:17'></a>With [PR #137 from gmpy2](https://github.com/aleaxit/gmpy/pull/137)\n\n- you can get rid of the function `get_gmpy2_path()` and most of the declarations in `sage/libs/gmpy2.pxd`.\n\n- you can add tests for conversions using the methods `__mpz__` and `__mpq__`\n\n```\nsage: import gmpy2\nsage: gmpy2.mpz(23)\n```\n  and\n\n```\nsage: import gmpy2\nsage: gmpy2.mpq(12/14)    \n```",
    "created_at": "2017-05-18T15:59:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337162",
    "user": "https://github.com/videlec"
}
```

<a id='comment:17'></a>With [PR #137 from gmpy2](https://github.com/aleaxit/gmpy/pull/137)

- you can get rid of the function `get_gmpy2_path()` and most of the declarations in `sage/libs/gmpy2.pxd`.

- you can add tests for conversions using the methods `__mpz__` and `__mpq__`

```
sage: import gmpy2
sage: gmpy2.mpz(23)
```
  and

```
sage: import gmpy2
sage: gmpy2.mpq(12/14)    
```



---

archive/issue_comments_337163.json:
```json
{
    "body": "<a id='comment:18'></a>Is the coercion really needed? I mean, we cannot add coercion in Sage for every single external package. Is it really important that we can add a Sage polynomial to a gmpy2 integer for example?",
    "created_at": "2017-05-18T16:00:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337163",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>Is the coercion really needed? I mean, we cannot add coercion in Sage for every single external package. Is it really important that we can add a Sage polynomial to a gmpy2 integer for example?



---

archive/issue_comments_337164.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [comment:18 jdemeyer]:\n> Is the coercion really needed? I mean, we cannot add coercion in Sage for every single external package. Is it really important that we can add a Sage polynomial to a gmpy2 integer for example?\n\n\nNot sure. Why do we provide coercion for `numpy`? It is convenient to have `Integer('2') + gmpy2.mpz('3')` working.",
    "created_at": "2017-05-18T16:07:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337164",
    "user": "https://github.com/videlec"
}
```

<a id='comment:19'></a>Replying to [comment:18 jdemeyer]:
> Is the coercion really needed? I mean, we cannot add coercion in Sage for every single external package. Is it really important that we can add a Sage polynomial to a gmpy2 integer for example?


Not sure. Why do we provide coercion for `numpy`? It is convenient to have `Integer('2') + gmpy2.mpz('3')` working.



---

archive/issue_comments_337165.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [comment:19 vdelecroix]:\n> It is convenient to have `Integer('2') + gmpy2.mpz('3')` working.\n\n\nEven if you agree with this, one needs to wonder whether the result should be a Sage integer or a gmpy2 integer (that's why I mentioned polynomials in [comment:18])",
    "created_at": "2017-05-18T17:23:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337165",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>Replying to [comment:19 vdelecroix]:
> It is convenient to have `Integer('2') + gmpy2.mpz('3')` working.


Even if you agree with this, one needs to wonder whether the result should be a Sage integer or a gmpy2 integer (that's why I mentioned polynomials in [comment:18])



---

archive/issue_comments_337166.json:
```json
{
    "body": "<a id='comment:21'></a>The coercion aspect has been moved into another ticket #23052.",
    "created_at": "2017-05-22T10:21:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337166",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:21'></a>The coercion aspect has been moved into another ticket #23052.



---

archive/issue_comments_337167.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,16 @@\n+Conversion between gmpy2 and sage integers:\n+- Implement method `__mpz__` on sage integer: return an gmpy2 mpz \n+- Implement method `__mpq__` on sage rational: return an gmpy2 mpq\n+-  Sage integer and rational constructors should work with gmpy2's mpz and mpq parameters.\n+\n+\n+Once gmpy2 is a standard package with the following features :\n+- [#137](https://github.com/aleaxit/gmpy/pull/137) direct constructors GMPy_MPZ_From_mpz, GMPy_MPQ_From_mpq, GMPy_MPQ_From_mpz\n+- [#137](https://github.com/aleaxit/gmpy/pull/137) a gmpy2.pxd file with relevant declarations (to be installed at the same place as gmpy2.h)\n+- [#136](https://github.com/aleaxit/gmpy/issues/136) robust header detection (ie what should the user do in her setup.py to find out where gmpy2.h/gmpy2.pxd are?)\n+see also: [#134](https://github.com/aleaxit/gmpy/pull/134)\n+\n+Then remove sage.libs.gmpy2 extension and replace conversion functions gmpy2_mpz_to_sage and gmpy2_mpq_to_sage by having sage integer and rational constructors working with gmpy2 number  \n \n \n Author: Vincent Klein\n``````\n",
    "created_at": "2017-05-22T10:21:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337167",
    "user": "https://github.com/vinklein"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,16 @@
+Conversion between gmpy2 and sage integers:
+- Implement method `__mpz__` on sage integer: return an gmpy2 mpz 
+- Implement method `__mpq__` on sage rational: return an gmpy2 mpq
+-  Sage integer and rational constructors should work with gmpy2's mpz and mpq parameters.
+
+
+Once gmpy2 is a standard package with the following features :
+- [#137](https://github.com/aleaxit/gmpy/pull/137) direct constructors GMPy_MPZ_From_mpz, GMPy_MPQ_From_mpq, GMPy_MPQ_From_mpz
+- [#137](https://github.com/aleaxit/gmpy/pull/137) a gmpy2.pxd file with relevant declarations (to be installed at the same place as gmpy2.h)
+- [#136](https://github.com/aleaxit/gmpy/issues/136) robust header detection (ie what should the user do in her setup.py to find out where gmpy2.h/gmpy2.pxd are?)
+see also: [#134](https://github.com/aleaxit/gmpy/pull/134)
+
+Then remove sage.libs.gmpy2 extension and replace conversion functions gmpy2_mpz_to_sage and gmpy2_mpq_to_sage by having sage integer and rational constructors working with gmpy2 number  
 
 
 Author: Vincent Klein
``````




---

archive/issue_comments_337168.json:
```json
{
    "body": "<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-05-22T12:43:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337168",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_337169.json:
```json
{
    "body": "<a id='comment:23'></a>Didn't we patch Cython in #22728 precisely to avoid needed to mess with include paths?",
    "created_at": "2017-05-22T16:03:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337169",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:23'></a>Didn't we patch Cython in #22728 precisely to avoid needed to mess with include paths?



---

archive/issue_comments_337170.json:
```json
{
    "body": "<a id='comment:24'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-22T23:37:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337170",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:24'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_337171.json:
```json
{
    "body": "<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-22T23:40:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337171",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_337172.json:
```json
{
    "body": "Changing component from packages: optional to packages: standard.",
    "created_at": "2017-05-23T06:48:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337172",
    "user": "https://github.com/videlec"
}
```

Changing component from packages: optional to packages: standard.



---

archive/issue_comments_337173.json:
```json
{
    "body": "<a id='comment:27'></a>- Is there a need of `get_gmpy2_path`?\n- I think we should avoid the import `gmpy2` completely and that `is_gmpy2_type` can be much faster. I made [issue #139](https://github.com/aleaxit/gmpy/issues/139)\n- Also test\n\n```\nsage: Integer(mpz(3))\nsage: Rational(mpq(2, 3))\nsage: Rational(mpz(5))\n```",
    "created_at": "2017-05-23T07:03:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337173",
    "user": "https://github.com/videlec"
}
```

<a id='comment:27'></a>- Is there a need of `get_gmpy2_path`?
- I think we should avoid the import `gmpy2` completely and that `is_gmpy2_type` can be much faster. I made [issue #139](https://github.com/aleaxit/gmpy/issues/139)
- Also test

```
sage: Integer(mpz(3))
sage: Rational(mpq(2, 3))
sage: Rational(mpz(5))
```



---

archive/issue_comments_337174.json:
```json
{
    "body": "<a id='comment:28'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-23T14:25:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337174",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:28'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_337175.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,18 @@\n+Conversion between gmpy2 and sage integers:\n+- Implement method `__mpz__` on sage integer: return an gmpy2 mpz \n+- Implement method `__mpq__` on sage rational: return an gmpy2 mpq\n+-  Sage integer and rational constructors should work with gmpy2's mpz and mpq parameters.\n \n+\n+Once gmpy2 is a standard package with the following features :\n+- [#137](https://github.com/aleaxit/gmpy/pull/137) direct constructors GMPy_MPZ_From_mpz, GMPy_MPQ_From_mpq, GMPy_MPQ_From_mpz\n+- [#137](https://github.com/aleaxit/gmpy/pull/137) a gmpy2.pxd file with relevant declarations (to be installed at the same place as gmpy2.h)\n+- [#136](https://github.com/aleaxit/gmpy/issues/136) robust header detection (ie what should the user do in her setup.py to find out where gmpy2.h/gmpy2.pxd are?)\n+see also: [#134](https://github.com/aleaxit/gmpy/pull/134)\n+\n+Then remove sage.libs.gmpy2 extension and replace conversion functions gmpy2_mpz_to_sage and gmpy2_mpq_to_sage by having sage integer and rational constructors working with gmpy2 number  \n+\n+Make gmpy2 an standard package (open a thread on sage-devel)\n \n Author: Vincent Klein\n \n``````\n",
    "created_at": "2017-05-23T15:41:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337175",
    "user": "https://github.com/vinklein"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,18 @@
+Conversion between gmpy2 and sage integers:
+- Implement method `__mpz__` on sage integer: return an gmpy2 mpz 
+- Implement method `__mpq__` on sage rational: return an gmpy2 mpq
+-  Sage integer and rational constructors should work with gmpy2's mpz and mpq parameters.
 
+
+Once gmpy2 is a standard package with the following features :
+- [#137](https://github.com/aleaxit/gmpy/pull/137) direct constructors GMPy_MPZ_From_mpz, GMPy_MPQ_From_mpq, GMPy_MPQ_From_mpz
+- [#137](https://github.com/aleaxit/gmpy/pull/137) a gmpy2.pxd file with relevant declarations (to be installed at the same place as gmpy2.h)
+- [#136](https://github.com/aleaxit/gmpy/issues/136) robust header detection (ie what should the user do in her setup.py to find out where gmpy2.h/gmpy2.pxd are?)
+see also: [#134](https://github.com/aleaxit/gmpy/pull/134)
+
+Then remove sage.libs.gmpy2 extension and replace conversion functions gmpy2_mpz_to_sage and gmpy2_mpq_to_sage by having sage integer and rational constructors working with gmpy2 number  
+
+Make gmpy2 an standard package (open a thread on sage-devel)
 
 Author: Vincent Klein
 
``````




---

archive/issue_comments_337176.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,18 @@\n+Conversion between gmpy2 and sage integers:\n+- Implement method `__mpz__` on sage integer: return an gmpy2 mpz \n+- Implement method `__mpq__` on sage rational: return an gmpy2 mpq\n+-  Sage integer and rational constructors should work with gmpy2's mpz and mpq parameters.\n \n+\n+Once gmpy2 is a standard package with the following features :\n+- [#137](https://github.com/aleaxit/gmpy/pull/137) direct constructors GMPy_MPZ_From_mpz, GMPy_MPQ_From_mpq, GMPy_MPQ_From_mpz\n+- [#137](https://github.com/aleaxit/gmpy/pull/137) a gmpy2.pxd file with relevant declarations (to be installed at the same place as gmpy2.h)\n+- [#136](https://github.com/aleaxit/gmpy/issues/136) robust header detection (ie what should the user do in her setup.py to find out where gmpy2.h/gmpy2.pxd are?)\n+see also: [#134](https://github.com/aleaxit/gmpy/pull/134)\n+\n+Then remove sage.libs.gmpy2 extension and replace conversion functions gmpy2_mpz_to_sage and gmpy2_mpq_to_sage by having sage integer and rational constructors working with gmpy2 number  \n+\n+Make gmpy2 a standard package (open a thread on sage-devel)\n \n Author: Vincent Klein\n \n``````\n",
    "created_at": "2017-05-23T15:41:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337176",
    "user": "https://github.com/vinklein"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,18 @@
+Conversion between gmpy2 and sage integers:
+- Implement method `__mpz__` on sage integer: return an gmpy2 mpz 
+- Implement method `__mpq__` on sage rational: return an gmpy2 mpq
+-  Sage integer and rational constructors should work with gmpy2's mpz and mpq parameters.
 
+
+Once gmpy2 is a standard package with the following features :
+- [#137](https://github.com/aleaxit/gmpy/pull/137) direct constructors GMPy_MPZ_From_mpz, GMPy_MPQ_From_mpq, GMPy_MPQ_From_mpz
+- [#137](https://github.com/aleaxit/gmpy/pull/137) a gmpy2.pxd file with relevant declarations (to be installed at the same place as gmpy2.h)
+- [#136](https://github.com/aleaxit/gmpy/issues/136) robust header detection (ie what should the user do in her setup.py to find out where gmpy2.h/gmpy2.pxd are?)
+see also: [#134](https://github.com/aleaxit/gmpy/pull/134)
+
+Then remove sage.libs.gmpy2 extension and replace conversion functions gmpy2_mpz_to_sage and gmpy2_mpq_to_sage by having sage integer and rational constructors working with gmpy2 number  
+
+Make gmpy2 a standard package (open a thread on sage-devel)
 
 Author: Vincent Klein
 
``````




---

archive/issue_comments_337177.json:
```json
{
    "body": "<a id='comment:31'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-24T15:08:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337177",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:31'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_337178.json:
```json
{
    "body": "<a id='comment:32'></a>In case a `mpz` is used to construct a `Rational` I would modify \n\n```\nself.__set_value(integer.Integer(x), base)\n```\nto\n\n```\nmpq_set_z(self.value, MPZ(<MPZ_Object *> x))\n```",
    "created_at": "2017-05-24T15:59:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337178",
    "user": "https://github.com/videlec"
}
```

<a id='comment:32'></a>In case a `mpz` is used to construct a `Rational` I would modify 

```
self.__set_value(integer.Integer(x), base)
```
to

```
mpq_set_z(self.value, MPZ(<MPZ_Object *> x))
```



---

archive/issue_comments_337179.json:
```json
{
    "body": "<a id='comment:33'></a>It may be faster but you lose a standard processing for all integer types.\nFor example if \n\n```\nelif isinstance(x, integer.Integer):\n            set_from_Integer(self, x)\n``` \nevolve in some way you must copy the modification for the MPZ_Object case.",
    "created_at": "2017-05-24T16:15:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337179",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:33'></a>It may be faster but you lose a standard processing for all integer types.
For example if 

```
elif isinstance(x, integer.Integer):
            set_from_Integer(self, x)
``` 
evolve in some way you must copy the modification for the MPZ_Object case.



---

archive/issue_comments_337180.json:
```json
{
    "body": "<a id='comment:34'></a>Replying to [comment:33 vklein]:\n> It may be faster but you lose a standard processing for all integer types.\n> For example if \n> \n> ```\n> elif isinstance(x, integer.Integer):\n>             set_from_Integer(self, x)\n> ``` \n> evolve in some way you must copy the modification for the MPZ_Object case. \n\n\nIt is not only faster, it is much easier to read.\n\nThe concerned code is the following\n\n```\nelif MPQ_Check(<PyObject *> x):\n    mpq_set(self.value, MPQ(<MPQ_Object *> x))\nelif MPZ_Check(<PyObject *> x):\n    self.__set_value(integer.Integer(x), base)\n```\nI don't see the logic in converting `x` to a Sage Integer and then calling `__set_value` instead of using the straightforward `mpq_set_z(...)`.\n\nBTW, I don't understand your comment. What should be an evolution of `set_from_Integer`? An integer is a rational with denominator 1. This will not change in any near future.",
    "created_at": "2017-06-01T19:54:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337180",
    "user": "https://github.com/videlec"
}
```

<a id='comment:34'></a>Replying to [comment:33 vklein]:
> It may be faster but you lose a standard processing for all integer types.
> For example if 
> 
> ```
> elif isinstance(x, integer.Integer):
>             set_from_Integer(self, x)
> ``` 
> evolve in some way you must copy the modification for the MPZ_Object case. 


It is not only faster, it is much easier to read.

The concerned code is the following

```
elif MPQ_Check(<PyObject *> x):
    mpq_set(self.value, MPQ(<MPQ_Object *> x))
elif MPZ_Check(<PyObject *> x):
    self.__set_value(integer.Integer(x), base)
```
I don't see the logic in converting `x` to a Sage Integer and then calling `__set_value` instead of using the straightforward `mpq_set_z(...)`.

BTW, I don't understand your comment. What should be an evolution of `set_from_Integer`? An integer is a rational with denominator 1. This will not change in any near future.



---

archive/issue_comments_337181.json:
```json
{
    "body": "<a id='comment:35'></a>Replying to [comment:34 vdelecroix]:\n> ...\n> It is not only faster, it is much easier to read.\n> \n\nNot sure if there is a clear difference in readability between the two options, \nby the way there are many recursive call in this function.\n\nAnother reason for the present choice was to be consistent with numpy.integer processing.\nWhen modifying an existing code i tend to stick to the preceding coding style,\n(And having a standard processing for all int type is an understandable design choice).\nOn the other hand in numpy.integer case doing a recursive call seems to be most concise way to do it, \nwich as you demonstrated is not the case for gmpy2 mpz.\n\nThat being said i got your point and prefer your solution.",
    "created_at": "2017-06-01T21:43:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337181",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:35'></a>Replying to [comment:34 vdelecroix]:
> ...
> It is not only faster, it is much easier to read.
> 

Not sure if there is a clear difference in readability between the two options, 
by the way there are many recursive call in this function.

Another reason for the present choice was to be consistent with numpy.integer processing.
When modifying an existing code i tend to stick to the preceding coding style,
(And having a standard processing for all int type is an understandable design choice).
On the other hand in numpy.integer case doing a recursive call seems to be most concise way to do it, 
wich as you demonstrated is not the case for gmpy2 mpz.

That being said i got your point and prefer your solution.



---

archive/issue_comments_337182.json:
```json
{
    "body": "<a id='comment:36'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-06-07T16:25:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337182",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:36'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_337183.json:
```json
{
    "body": "<a id='comment:37'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2017-06-15T12:18:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337183",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:37'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_337184.json:
```json
{
    "body": "<a id='comment:38'></a>I thought that we agreed on [comment:32 comment:32]...",
    "created_at": "2017-06-15T14:04:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337184",
    "user": "https://github.com/videlec"
}
```

<a id='comment:38'></a>I thought that we agreed on [comment:32 comment:32]...



---

archive/issue_comments_337185.json:
```json
{
    "body": "<a id='comment:39'></a>A merge error",
    "created_at": "2017-06-15T14:06:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337185",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:39'></a>A merge error



---

archive/issue_comments_337186.json:
```json
{
    "body": "<a id='comment:40'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-06-15T14:32:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337186",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:40'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_337187.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,18 @@\n+The library `gmpy2` support conversions by the use of special methods. In order to allow conversion of Sage objects into gmpy2 objects, we implement the following\n+- a method `__mpz__` on Sage Integer\n+- a method `__mpq__` on Sage Rational\n+- a method `__mpfr__` on relevant Sage real numbers\n+   - `RealNumber` (`sage.rings.real_mpfr`)\n+   - `RealDoubleElement` (`sage.rings.real_double`)\n+- a method `__mpc__` on relevant Sage complex numbers\n+   - `ComplexDoubleElement` (`sage.rings.complex_double`)\n+   - `MPComplexNumber` (`sage.rings.complex_mpc`)\n+   - `ComplexNumber` (`sage.rings.complex_number`)\n \n+Conversly, we make Sage integer, rational, real and complex constructors accept gmpy2 arguments.\n+\n+\n+**All these features need `gmpy2` being a standard package.**\n \n Author: Vincent Klein\n \n``````\n",
    "created_at": "2017-06-22T11:19:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337187",
    "user": "https://github.com/videlec"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,18 @@
+The library `gmpy2` support conversions by the use of special methods. In order to allow conversion of Sage objects into gmpy2 objects, we implement the following
+- a method `__mpz__` on Sage Integer
+- a method `__mpq__` on Sage Rational
+- a method `__mpfr__` on relevant Sage real numbers
+   - `RealNumber` (`sage.rings.real_mpfr`)
+   - `RealDoubleElement` (`sage.rings.real_double`)
+- a method `__mpc__` on relevant Sage complex numbers
+   - `ComplexDoubleElement` (`sage.rings.complex_double`)
+   - `MPComplexNumber` (`sage.rings.complex_mpc`)
+   - `ComplexNumber` (`sage.rings.complex_number`)
 
+Conversly, we make Sage integer, rational, real and complex constructors accept gmpy2 arguments.
+
+
+**All these features need `gmpy2` being a standard package.**
 
 Author: Vincent Klein
 
``````




---

archive/issue_comments_337188.json:
```json
{
    "body": "<a id='comment:42'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-06-22T12:26:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337188",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:42'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_337189.json:
```json
{
    "body": "Changing component from packages: standard to interfaces.",
    "created_at": "2017-06-22T16:51:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337189",
    "user": "https://github.com/videlec"
}
```

Changing component from packages: standard to interfaces.



---

archive/issue_comments_337190.json:
```json
{
    "body": "<a id='comment:45'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2017-06-23T12:03:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337190",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:45'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_337191.json:
```json
{
    "body": "<a id='comment:46'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2017-06-23T13:08:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337191",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:46'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_337192.json:
```json
{
    "body": "<a id='comment:47'></a>rebase on 8.0.beta12",
    "created_at": "2017-06-23T13:10:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337192",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:47'></a>rebase on 8.0.beta12



---

archive/issue_comments_337193.json:
```json
{
    "body": "<a id='comment:48'></a>With `RealNumber` you should check if precision is kept. Like with this number\n\n```\nsage: R = RealField(256)\nsage: R.pi()\n3.141592653589793238462643383279502884197169399375105820974944592307816406286\n```\nIs there a way to check the precision of a real number with gmpy2?",
    "created_at": "2017-06-23T13:11:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337193",
    "user": "https://github.com/videlec"
}
```

<a id='comment:48'></a>With `RealNumber` you should check if precision is kept. Like with this number

```
sage: R = RealField(256)
sage: R.pi()
3.141592653589793238462643383279502884197169399375105820974944592307816406286
```
Is there a way to check the precision of a real number with gmpy2?



---

archive/issue_comments_337194.json:
```json
{
    "body": "<a id='comment:49'></a>Yes you can do it with the mpfr's precision attribute.\n\n```\n\nsage: from gmpy2 import mpfr\nsage: R = RealField(256)\nsage: r = mpfr(R.pi())\nsage: r.precision\n256\n\n```\nI will add this as a doctest",
    "created_at": "2017-06-23T13:49:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337194",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:49'></a>Yes you can do it with the mpfr's precision attribute.

```

sage: from gmpy2 import mpfr
sage: R = RealField(256)
sage: r = mpfr(R.pi())
sage: r.precision
256

```
I will add this as a doctest



---

archive/issue_comments_337195.json:
```json
{
    "body": "<a id='comment:50'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-06-23T13:55:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337195",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:50'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_337196.json:
```json
{
    "body": "<a id='comment:51'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2017-11-13T14:22:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337196",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:51'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_337197.json:
```json
{
    "body": "Replying to [ticket:22928 vklein]:\n> **All these features need `gmpy2` being a standard package.**\n\n\nI don't think that this is completely true. I understand why you think so, but it shouldn't be too hard to implement this as an optional interface.",
    "created_at": "2017-11-13T14:40:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337197",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [ticket:22928 vklein]:
> **All these features need `gmpy2` being a standard package.**


I don't think that this is completely true. I understand why you think so, but it shouldn't be too hard to implement this as an optional interface.



---

archive/issue_comments_337198.json:
```json
{
    "body": "<a id='comment:53'></a>At the begining i ve tried to make it optional. I don't rememeber exactly why i have come to the conclusion that  it can't be optional.\nI will take a second look at it.",
    "created_at": "2017-11-13T15:02:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337198",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:53'></a>At the begining i ve tried to make it optional. I don't rememeber exactly why i have come to the conclusion that  it can't be optional.
I will take a second look at it.



---

archive/issue_comments_337199.json:
```json
{
    "body": "<a id='comment:54'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2017-11-14T09:11:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337199",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:54'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_337200.json:
```json
{
    "body": "<a id='comment:55'></a>rebase on 8.1.rc0",
    "created_at": "2017-11-14T09:21:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337200",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:55'></a>rebase on 8.1.rc0



---

archive/issue_comments_337201.json:
```json
{
    "body": "<a id='comment:56'></a>There is some very ugly Cython code in this branch. I guess this is mostly caused by upstream's ignorance on how to do Cython declarations correctly. I'll try to fix this.",
    "created_at": "2017-11-14T11:08:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337201",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:56'></a>There is some very ugly Cython code in this branch. I guess this is mostly caused by upstream's ignorance on how to do Cython declarations correctly. I'll try to fix this.



---

archive/issue_comments_337202.json:
```json
{
    "body": "<a id='comment:57'></a>Working on this...",
    "created_at": "2017-11-14T11:08:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337202",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:57'></a>Working on this...



---

archive/issue_comments_337203.json:
```json
{
    "body": "<a id='comment:58'></a>Is there any reason why we need this many commits? Can I just squash all that to 1 commit?",
    "created_at": "2017-11-14T11:10:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337203",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:58'></a>Is there any reason why we need this many commits? Can I just squash all that to 1 commit?



---

archive/issue_comments_337204.json:
```json
{
    "body": "<a id='comment:59'></a>Just historical reason.\nThe gmpy2's cython interface has evolved since this version. You can look if it covers what seems relevant to you [PR#155](https://github.com/aleaxit/gmpy/pull/155).\n\nThe plan of my last push was just to rebase this ticket before integrating the future stable version of gmpy2",
    "created_at": "2017-11-14T11:28:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337204",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:59'></a>Just historical reason.
The gmpy2's cython interface has evolved since this version. You can look if it covers what seems relevant to you [PR#155](https://github.com/aleaxit/gmpy/pull/155).

The plan of my last push was just to rebase this ticket before integrating the future stable version of gmpy2



---

archive/issue_comments_337205.json:
```json
{
    "body": "<a id='comment:61'></a>I made an upstream pull request https://github.com/aleaxit/gmpy/pull/169 to clean up some Cython declarations.\n\nThen, I cleaned up the branch on this ticket using that PR and I made this branch independent of the gmpy2 upgrade for easier development.\n\n---\nNew commits:",
    "created_at": "2017-11-14T12:35:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337205",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:61'></a>I made an upstream pull request https://github.com/aleaxit/gmpy/pull/169 to clean up some Cython declarations.

Then, I cleaned up the branch on this ticket using that PR and I made this branch independent of the gmpy2 upgrade for easier development.

---
New commits:



---

archive/issue_comments_337206.json:
```json
{
    "body": "<a id='comment:62'></a>Thanks ! I will update the tarball of #22927, so people can test this ticket without doing their own (as current one doesn't contain the new cython interface).",
    "created_at": "2017-11-14T12:51:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337206",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:62'></a>Thanks ! I will update the tarball of #22927, so people can test this ticket without doing their own (as current one doesn't contain the new cython interface).



---

archive/issue_comments_337207.json:
```json
{
    "body": "<a id='comment:63'></a>Now working on making gmpy2 optional...",
    "created_at": "2017-11-14T13:07:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337207",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:63'></a>Now working on making gmpy2 optional...



---

archive/issue_comments_337208.json:
```json
{
    "body": "<a id='comment:65'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-14T15:32:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337208",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:65'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_337209.json:
```json
{
    "body": "<a id='comment:66'></a>working on complex types (`__mpc__` function and constructor)",
    "created_at": "2017-11-14T15:40:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337209",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:66'></a>working on complex types (`__mpc__` function and constructor)



---

archive/issue_comments_337210.json:
```json
{
    "body": "<a id='comment:68'></a>New commits:",
    "created_at": "2017-11-16T18:39:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337210",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:68'></a>New commits:



---

archive/issue_comments_337211.json:
```json
{
    "body": "<a id='comment:69'></a>The documentation\n\n```\nConvert Sage ``ComplexNumber`` to gmpy2 ``Complex``.\n```\nrefers to a type `Complex` that does not exist in gmpy2 and `ComplexNumber` should be one of `ComplexDoubleElement`, `MPComplexNumber` or `ComplexNumber` which are three distinct classes.",
    "created_at": "2017-11-16T18:50:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337211",
    "user": "https://github.com/videlec"
}
```

<a id='comment:69'></a>The documentation

```
Convert Sage ``ComplexNumber`` to gmpy2 ``Complex``.
```
refers to a type `Complex` that does not exist in gmpy2 and `ComplexNumber` should be one of `ComplexDoubleElement`, `MPComplexNumber` or `ComplexNumber` which are three distinct classes.



---

archive/issue_events_059477.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2017-11-16T18:50:04Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "milestone": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22928#event-59477"
}
```



---

archive/issue_comments_337212.json:
```json
{
    "body": "<a id='comment:70'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-11-17T08:55:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337212",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:70'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_337213.json:
```json
{
    "body": "<a id='comment:71'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-24T16:53:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337213",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:71'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_337214.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,15 @@\n+The library `gmpy2` support conversions by the use of special methods. In order to allow conversion of Sage objects into gmpy2 objects, we implement the following\n+- a method `__mpz__` on Sage Integer\n+- a method `__mpq__` on Sage Rational\n+- a method `__mpfr__` on relevant Sage real numbers\n+   - `RealNumber` (`sage.rings.real_mpfr`)\n+   - `RealDoubleElement` (`sage.rings.real_double`)\n+- a method `__mpc__` on relevant Sage complex numbers\n+   - `ComplexDoubleElement` (`sage.rings.complex_double`)\n+   - `MPComplexNumber` (`sage.rings.complex_mpc`)\n+   - `ComplexNumber` (`sage.rings.complex_number`)\n \n+Conversly, we make Sage integer, rational, real and complex constructors accept gmpy2 arguments.\n \n Author: Vincent Klein\n \n``````\n",
    "created_at": "2017-11-24T16:55:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337214",
    "user": "https://github.com/vinklein"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,15 @@
+The library `gmpy2` support conversions by the use of special methods. In order to allow conversion of Sage objects into gmpy2 objects, we implement the following
+- a method `__mpz__` on Sage Integer
+- a method `__mpq__` on Sage Rational
+- a method `__mpfr__` on relevant Sage real numbers
+   - `RealNumber` (`sage.rings.real_mpfr`)
+   - `RealDoubleElement` (`sage.rings.real_double`)
+- a method `__mpc__` on relevant Sage complex numbers
+   - `ComplexDoubleElement` (`sage.rings.complex_double`)
+   - `MPComplexNumber` (`sage.rings.complex_mpc`)
+   - `ComplexNumber` (`sage.rings.complex_number`)
 
+Conversly, we make Sage integer, rational, real and complex constructors accept gmpy2 arguments.
 
 Author: Vincent Klein
 
``````




---

archive/issue_comments_337215.json:
```json
{
    "body": "<a id='comment:72'></a>Rebase on the last Trac #22927 HEAD",
    "created_at": "2017-11-24T16:55:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337215",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:72'></a>Rebase on the last Trac #22927 HEAD



---

archive/issue_comments_337216.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-11-24T16:56:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337216",
    "user": "https://github.com/vinklein"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_337217.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,15 @@\n+The library `gmpy2` supports conversions by the use of special methods. In order to allow conversion of Sage objects into gmpy2 objects, we implement the following methods\n+- `__mpz__` on Sage Integer\n+- `__mpq__` on Sage Rational\n+- `__mpfr__` on relevant Sage real numbers\n+   - `RealNumber` (`sage.rings.real_mpfr`)\n+   - `RealDoubleElement` (`sage.rings.real_double`)\n+- `__mpc__` on relevant Sage complex numbers\n+   - `ComplexDoubleElement` (`sage.rings.complex_double`)\n+   - `MPComplexNumber` (`sage.rings.complex_mpc`)\n+   - `ComplexNumber` (`sage.rings.complex_number`)\n \n+Conversly, we make Sage integer, rational, real and complex constructors accept gmpy2 arguments.\n \n Author: Vincent Klein\n \n``````\n",
    "created_at": "2017-11-24T16:58:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337217",
    "user": "https://github.com/videlec"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,15 @@
+The library `gmpy2` supports conversions by the use of special methods. In order to allow conversion of Sage objects into gmpy2 objects, we implement the following methods
+- `__mpz__` on Sage Integer
+- `__mpq__` on Sage Rational
+- `__mpfr__` on relevant Sage real numbers
+   - `RealNumber` (`sage.rings.real_mpfr`)
+   - `RealDoubleElement` (`sage.rings.real_double`)
+- `__mpc__` on relevant Sage complex numbers
+   - `ComplexDoubleElement` (`sage.rings.complex_double`)
+   - `MPComplexNumber` (`sage.rings.complex_mpc`)
+   - `ComplexNumber` (`sage.rings.complex_number`)
 
+Conversly, we make Sage integer, rational, real and complex constructors accept gmpy2 arguments.
 
 Author: Vincent Klein
 
``````




---

archive/issue_comments_337218.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-11-24T17:02:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337218",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_337219.json:
```json
{
    "body": "<a id='comment:75'></a>This branch will not work. The commit in #24215 is `7f06e71` but you rebased it here. So there will be a conflict.",
    "created_at": "2017-11-24T17:02:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337219",
    "user": "https://github.com/videlec"
}
```

<a id='comment:75'></a>This branch will not work. The commit in #24215 is `7f06e71` but you rebased it here. So there will be a conflict.



---

archive/issue_comments_337220.json:
```json
{
    "body": "<a id='comment:76'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-24T18:33:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337220",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:76'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_337221.json:
```json
{
    "body": "<a id='comment:77'></a>rework done",
    "created_at": "2017-11-24T18:39:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337221",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:77'></a>rework done



---

archive/issue_comments_337222.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-11-24T18:39:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337222",
    "user": "https://github.com/vinklein"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_337223.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-11-28T12:40:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337223",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_337224.json:
```json
{
    "body": "<a id='comment:78'></a>\n```\nsage: import gmpy2\nsage: gmpy2.mpz(1/2)\n--> SEGFAULT <--\n```",
    "created_at": "2017-11-28T12:40:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337224",
    "user": "https://github.com/videlec"
}
```

<a id='comment:78'></a>
```
sage: import gmpy2
sage: gmpy2.mpz(1/2)
--> SEGFAULT <--
```



---

archive/issue_comments_337225.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-11-28T12:44:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337225",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_337226.json:
```json
{
    "body": "<a id='comment:79'></a>Replying to [comment:78 vdelecroix]:\n> {{{\n> sage: import gmpy2\n> sage: gmpy2.mpz(1/2)\n> --> SEGFAULT <--\n> }}}\n\n\nThat is really a bug in `gmpy2`, not in Sage.",
    "created_at": "2017-11-28T12:44:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337226",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:79'></a>Replying to [comment:78 vdelecroix]:
> {{{
> sage: import gmpy2
> sage: gmpy2.mpz(1/2)
> --> SEGFAULT <--
> }}}


That is really a bug in `gmpy2`, not in Sage.



---

archive/issue_comments_337227.json:
```json
{
    "body": "<a id='comment:80'></a>Indeed https://github.com/aleaxit/gmpy/issues/173",
    "created_at": "2017-11-28T12:55:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337227",
    "user": "https://github.com/videlec"
}
```

<a id='comment:80'></a>Indeed https://github.com/aleaxit/gmpy/issues/173



---

archive/issue_comments_337228.json:
```json
{
    "body": "<a id='comment:81'></a>I might review this, but only after the dependencies have been merged in a beta.",
    "created_at": "2017-11-28T13:39:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337228",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:81'></a>I might review this, but only after the dependencies have been merged in a beta.



---

archive/issue_comments_337229.json:
```json
{
    "body": "<a id='comment:83'></a>Rebased to 8.2.beta0\n\n---\nNew commits:",
    "created_at": "2017-12-14T12:06:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337229",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:83'></a>Rebased to 8.2.beta0

---
New commits:



---

archive/issue_comments_337230.json:
```json
{
    "body": "<a id='comment:84'></a>Thanks for the rebase.",
    "created_at": "2017-12-14T15:18:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337230",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:84'></a>Thanks for the rebase.



---

archive/issue_comments_337231.json:
```json
{
    "body": "<a id='comment:86'></a>rebase on 24417 in progress.",
    "created_at": "2017-12-22T10:45:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337231",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:86'></a>rebase on 24417 in progress.



---

archive/issue_comments_337232.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-12-22T10:45:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337232",
    "user": "https://github.com/vinklein"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_337233.json:
```json
{
    "body": "<a id='comment:88'></a>New commits:",
    "created_at": "2017-12-22T17:07:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337233",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:88'></a>New commits:



---

archive/issue_comments_337234.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-12-22T17:07:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337234",
    "user": "https://github.com/vinklein"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_337235.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-01-02T20:24:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337235",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_337236.json:
```json
{
    "body": "<a id='comment:89'></a>Some trivial merge/rebase to be done on 8.2.beta2",
    "created_at": "2018-01-02T20:24:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337236",
    "user": "https://github.com/videlec"
}
```

<a id='comment:89'></a>Some trivial merge/rebase to be done on 8.2.beta2



---

archive/issue_comments_337237.json:
```json
{
    "body": "<a id='comment:90'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-01-14T17:18:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337237",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:90'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_337238.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-01-14T17:20:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337238",
    "user": "https://github.com/vinklein"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_337239.json:
```json
{
    "body": "<a id='comment:91'></a>Rebase on 8.2.beta2",
    "created_at": "2018-01-14T17:20:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337239",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:91'></a>Rebase on 8.2.beta2



---

archive/issue_comments_337240.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-01-15T16:00:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337240",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_337241.json:
```json
{
    "body": "<a id='comment:92'></a>Sage is crashing\n\n```\nImportError: /opt/sage/local/lib/python2.7/site-packages/sage/rings/complex_number.so: undefined symbol: mpc_set_fr_fr\n```\nThe reason is that you are importing `from sage.libs.mpc cimport *` in `complex_number.pyx` and that this header file does not have the proper distutils directive. Just apply the patch\n\n```diff\ndiff --git a/src/sage/libs/mpc.pxd b/src/sage/libs/mpc.pxd\nindex 0e12d31468..0067b8b126 100644\n--- a/src/sage/libs/mpc.pxd\n+++ b/src/sage/libs/mpc.pxd\n@@ -1,3 +1,5 @@\n+# distutils: libraries = gmp mpfr mpc\n+\n from sage.libs.gmp.types cimport *\n from sage.libs.mpfr.types cimport *\n```",
    "created_at": "2018-01-15T16:00:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337241",
    "user": "https://github.com/videlec"
}
```

<a id='comment:92'></a>Sage is crashing

```
ImportError: /opt/sage/local/lib/python2.7/site-packages/sage/rings/complex_number.so: undefined symbol: mpc_set_fr_fr
```
The reason is that you are importing `from sage.libs.mpc cimport *` in `complex_number.pyx` and that this header file does not have the proper distutils directive. Just apply the patch

```diff
diff --git a/src/sage/libs/mpc.pxd b/src/sage/libs/mpc.pxd
index 0e12d31468..0067b8b126 100644
--- a/src/sage/libs/mpc.pxd
+++ b/src/sage/libs/mpc.pxd
@@ -1,3 +1,5 @@
+# distutils: libraries = gmp mpfr mpc
+
 from sage.libs.gmp.types cimport *
 from sage.libs.mpfr.types cimport *
```



---

archive/issue_comments_337242.json:
```json
{
    "body": "<a id='comment:93'></a>You should test different precisions for each possible type (that is `RealField(prec)`, `ComplexField(prec)` and `MPComplexField(prec)`).",
    "created_at": "2018-01-15T16:04:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337242",
    "user": "https://github.com/videlec"
}
```

<a id='comment:93'></a>You should test different precisions for each possible type (that is `RealField(prec)`, `ComplexField(prec)` and `MPComplexField(prec)`).



---

archive/issue_comments_337243.json:
```json
{
    "body": "<a id='comment:94'></a>The following is not nice\n\n```\nsage: gmpy2.mpfr(gmpy2.mpq('1/3'), precision=123).precision\n123\nsage: RealNumber(gmpy2.mpfr(gmpy2.mpq('1/3'), precision=123))\n0.33333333333333333333333333333333333332\nsage: _.prec()    # why not 123?\n130\n```\nAnd this is even worse\n\n```\nsage: ComplexNumber(gmpy2.mpc(gmpy2.mpq('1/3'), precision=123r))\nTraceback (most recent call last):\n...\nTypeError: unable to coerce to a ComplexNumber: <type 'str'>\n```",
    "created_at": "2018-01-15T16:04:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337243",
    "user": "https://github.com/videlec"
}
```

<a id='comment:94'></a>The following is not nice

```
sage: gmpy2.mpfr(gmpy2.mpq('1/3'), precision=123).precision
123
sage: RealNumber(gmpy2.mpfr(gmpy2.mpq('1/3'), precision=123))
0.33333333333333333333333333333333333332
sage: _.prec()    # why not 123?
130
```
And this is even worse

```
sage: ComplexNumber(gmpy2.mpc(gmpy2.mpq('1/3'), precision=123r))
Traceback (most recent call last):
...
TypeError: unable to coerce to a ComplexNumber: <type 'str'>
```



---

archive/issue_comments_337244.json:
```json
{
    "body": "<a id='comment:95'></a>Funny behavior of `gmpy2` precision with Sage integers\n\n```\nsage: gmpy2.mpfr('1.0', precision=40)\nmpfr('1.0',40)\nsage: gmpy2.mpc('1.0', precision=40)\nTraceback (most recent call last):\n...\nTypeError: precision for mpc() must be integer or tuple\n```\nIs that worth an issue?",
    "created_at": "2018-01-15T16:05:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337244",
    "user": "https://github.com/videlec"
}
```

<a id='comment:95'></a>Funny behavior of `gmpy2` precision with Sage integers

```
sage: gmpy2.mpfr('1.0', precision=40)
mpfr('1.0',40)
sage: gmpy2.mpc('1.0', precision=40)
Traceback (most recent call last):
...
TypeError: precision for mpc() must be integer or tuple
```
Is that worth an issue?



---

archive/issue_comments_337245.json:
```json
{
    "body": "<a id='comment:96'></a>> {{{#!diff\n> diff --git a/src/sage/libs/mpc.pxd b/src/sage/libs/mpc.pxd\n> index 0e12d31468..0067b8b126 100644\n> --- a/src/sage/libs/mpc.pxd\n> +++ b/src/sage/libs/mpc.pxd\n> `@``@` -1,3 +1,5 `@``@`\n> +# distutils: libraries = gmp mpfr mpc\n> +\n>  from sage.libs.gmp.types cimport *\n>  from sage.libs.mpfr.types cimport *\n> }}}\n\nI have miss this one but encoutered it on 23024. It has been solved by updating module_list.py \nby adding mpc as a lib to sage.rings.complex_number Extension. \nWhat is the best way to fix it between these two ?",
    "created_at": "2018-01-15T16:13:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337245",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:96'></a>> {{{#!diff
> diff --git a/src/sage/libs/mpc.pxd b/src/sage/libs/mpc.pxd
> index 0e12d31468..0067b8b126 100644
> --- a/src/sage/libs/mpc.pxd
> +++ b/src/sage/libs/mpc.pxd
> `@``@` -1,3 +1,5 `@``@`
> +# distutils: libraries = gmp mpfr mpc
> +
>  from sage.libs.gmp.types cimport *
>  from sage.libs.mpfr.types cimport *
> }}}

I have miss this one but encoutered it on 23024. It has been solved by updating module_list.py 
by adding mpc as a lib to sage.rings.complex_number Extension. 
What is the best way to fix it between these two ?



---

archive/issue_comments_337246.json:
```json
{
    "body": "<a id='comment:97'></a>Modifying `module_list.py` is not a good idea. If I write my own Cython file with\n\n```\nfrom sage.rings.complex_number cimport whatever\n```\nThen my program will not compile.\n\naddendum: will not compile if I do not explicitely state that my program needs to be linked against mpc... that would better to be automatic (especially in interactive use of Cython inside Sage)",
    "created_at": "2018-01-15T16:17:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337246",
    "user": "https://github.com/videlec"
}
```

<a id='comment:97'></a>Modifying `module_list.py` is not a good idea. If I write my own Cython file with

```
from sage.rings.complex_number cimport whatever
```
Then my program will not compile.

addendum: will not compile if I do not explicitely state that my program needs to be linked against mpc... that would better to be automatic (especially in interactive use of Cython inside Sage)



---

archive/issue_comments_337247.json:
```json
{
    "body": "<a id='comment:98'></a>Ok i see.\n\nReplying to [comment:95 vdelecroix]:\n> Funny behavior of `gmpy2` precision with Sage integers\n> \n> ```\n> sage: gmpy2.mpfr('1.0', precision=40)\n> mpfr('1.0',40)\n> sage: gmpy2.mpc('1.0', precision=40)\n> Traceback (most recent call last):\n> ...\n> TypeError: precision for mpc() must be integer or tuple\n> ```\n> Is that worth an issue?\n\nI think it is. I will look at it and open an issue if needed.",
    "created_at": "2018-01-15T16:27:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337247",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:98'></a>Ok i see.

Replying to [comment:95 vdelecroix]:
> Funny behavior of `gmpy2` precision with Sage integers
> 
> ```
> sage: gmpy2.mpfr('1.0', precision=40)
> mpfr('1.0',40)
> sage: gmpy2.mpc('1.0', precision=40)
> Traceback (most recent call last):
> ...
> TypeError: precision for mpc() must be integer or tuple
> ```
> Is that worth an issue?

I think it is. I will look at it and open an issue if needed.



---

archive/issue_comments_337248.json:
```json
{
    "body": "<a id='comment:99'></a>Replying to [comment:92 vdelecroix]:\n> {{{#!diff\n> diff --git a/src/sage/libs/mpc.pxd b/src/sage/libs/mpc.pxd\n> index 0e12d31468..0067b8b126 100644\n> --- a/src/sage/libs/mpc.pxd\n> +++ b/src/sage/libs/mpc.pxd\n> `@``@` -1,3 +1,5 `@``@`\n> +# distutils: libraries = gmp mpfr mpc\n> +\n>  from sage.libs.gmp.types cimport *\n>  from sage.libs.mpfr.types cimport *\n> }}}\n\n\nSee #24549 for that.",
    "created_at": "2018-01-16T14:51:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337248",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:99'></a>Replying to [comment:92 vdelecroix]:
> {{{#!diff
> diff --git a/src/sage/libs/mpc.pxd b/src/sage/libs/mpc.pxd
> index 0e12d31468..0067b8b126 100644
> --- a/src/sage/libs/mpc.pxd
> +++ b/src/sage/libs/mpc.pxd
> `@``@` -1,3 +1,5 `@``@`
> +# distutils: libraries = gmp mpfr mpc
> +
>  from sage.libs.gmp.types cimport *
>  from sage.libs.mpfr.types cimport *
> }}}


See #24549 for that.



---

archive/issue_comments_337249.json:
```json
{
    "body": "<a id='comment:100'></a>Replying to [comment:94 vdelecroix]:\n> And this is even worse\n> \n> ```\n> sage: ComplexNumber(gmpy2.mpc(gmpy2.mpq('1/3'), precision=123r))\n> Traceback (most recent call last):\n> ...\n> TypeError: unable to coerce to a ComplexNumber: <type 'str'>\n> ```\n\n\nBut should we really use [ComplexNumber](ComplexNumber) this way ?\\\\\nThis call the function create_ComplexNumber and his first parameter is supposed to be the real part only.\n\\\\\nIn your call the first parameter is the whole complex number.\n\\\\\nSecondly create_ComplexNumber always try to convert the parameters (real and imag) into string before calling the [ComplexNumber](ComplexNumber) constructor. \\\\\nGiven that if you try to call ComplexNumber() with another complex type as parameter you will get the same result :\n\n```\nsage: cn = ComplexNumber(5,4)\nsage: ComplexNumber(cn)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n...\nTypeError: unable to coerce to a ComplexNumber: <type 'str'>\n```",
    "created_at": "2018-01-16T15:47:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337249",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:100'></a>Replying to [comment:94 vdelecroix]:
> And this is even worse
> 
> ```
> sage: ComplexNumber(gmpy2.mpc(gmpy2.mpq('1/3'), precision=123r))
> Traceback (most recent call last):
> ...
> TypeError: unable to coerce to a ComplexNumber: <type 'str'>
> ```


But should we really use [ComplexNumber](ComplexNumber) this way ?\\
This call the function create_ComplexNumber and his first parameter is supposed to be the real part only.
\\
In your call the first parameter is the whole complex number.
\\
Secondly create_ComplexNumber always try to convert the parameters (real and imag) into string before calling the [ComplexNumber](ComplexNumber) constructor. \\
Given that if you try to call ComplexNumber() with another complex type as parameter you will get the same result :

```
sage: cn = ComplexNumber(5,4)
sage: ComplexNumber(cn)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
...
TypeError: unable to coerce to a ComplexNumber: <type 'str'>
```



---

archive/issue_comments_337250.json:
```json
{
    "body": "<a id='comment:1'></a>The `ComplexNumber` function is wrong in several ways (see #13110). Just ignore it.",
    "created_at": "2018-01-17T12:35:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337250",
    "user": "https://github.com/videlec"
}
```

<a id='comment:1'></a>The `ComplexNumber` function is wrong in several ways (see #13110). Just ignore it.



---

archive/issue_comments_337251.json:
```json
{
    "body": "<a id='comment:102'></a>Replying to [comment:94 vdelecroix]:\n> The following is not nice\n> \n> ```\n> sage: gmpy2.mpfr(gmpy2.mpq('1/3'), precision=123).precision\n> 123\n> sage: RealNumber(gmpy2.mpfr(gmpy2.mpq('1/3'), precision=123))\n> 0.33333333333333333333333333333333333332\n> sage: _.prec()    # why not 123?\n> 130\n\nLike for `ComplexNumber` function it seems that `RealNumber` function it's not designed to be used this way. It's supposed to take a string as first parameter. \\\\\n\nThat being said the gmpy2's precision is not currently transmitted with `RR` function.\n\n{{{\nsage: RR(gmpy2.mpfr(gmpy2.mpq('1/3'), precision=123))\n0.333333333333333\nsage: _.prec()\n53\n}}}\n\nI am on it.",
    "created_at": "2018-01-22T09:26:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337251",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:102'></a>Replying to [comment:94 vdelecroix]:
> The following is not nice
> 
> ```
> sage: gmpy2.mpfr(gmpy2.mpq('1/3'), precision=123).precision
> 123
> sage: RealNumber(gmpy2.mpfr(gmpy2.mpq('1/3'), precision=123))
> 0.33333333333333333333333333333333333332
> sage: _.prec()    # why not 123?
> 130

Like for `ComplexNumber` function it seems that `RealNumber` function it's not designed to be used this way. It's supposed to take a string as first parameter. \\

That being said the gmpy2's precision is not currently transmitted with `RR` function.

{{{
sage: RR(gmpy2.mpfr(gmpy2.mpq('1/3'), precision=123))
0.333333333333333
sage: _.prec()
53
}}}

I am on it.



---

archive/issue_comments_337252.json:
```json
{
    "body": "<a id='comment:3'></a>The only fix i see so far would be do a new `mpfr_init2` during `_set ` call. It's a little ugly :\n\n```\n#real_mpfr.pyx line 1467\n   elif HAVE_GMPY2 and type(x) is gmpy2.mpfr:\n       self._parent = self._parent.to_prec(x.precision)\n       mpfr_init2(self.value, x.precision)\n       mpfr_set(self.value, (<gmpy2.mpfr>x).f, parent.rnd)\n```\n\nOr we can assume the user shoud do that :\n\n```\nsage: R = RealField(128)\nsage: R(gmpy2.mpfr(gmpy2.mpq('1/3'), precision=128))\n0.33333333333333333333333333333333333333\nsage: _.prec()\n128\n```",
    "created_at": "2018-01-22T10:54:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337252",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:3'></a>The only fix i see so far would be do a new `mpfr_init2` during `_set ` call. It's a little ugly :

```
#real_mpfr.pyx line 1467
   elif HAVE_GMPY2 and type(x) is gmpy2.mpfr:
       self._parent = self._parent.to_prec(x.precision)
       mpfr_init2(self.value, x.precision)
       mpfr_set(self.value, (<gmpy2.mpfr>x).f, parent.rnd)
```

Or we can assume the user shoud do that :

```
sage: R = RealField(128)
sage: R(gmpy2.mpfr(gmpy2.mpq('1/3'), precision=128))
0.33333333333333333333333333333333333333
sage: _.prec()
128
```



---

archive/issue_comments_337253.json:
```json
{
    "body": "<a id='comment:4'></a>`RealNumber` should be ignored for the same reason (it is aimed to be used by the preparser). You can read #13110 that I already mentioned in [comment:101 comment:101].",
    "created_at": "2018-01-22T14:28:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337253",
    "user": "https://github.com/videlec"
}
```

<a id='comment:4'></a>`RealNumber` should be ignored for the same reason (it is aimed to be used by the preparser). You can read #13110 that I already mentioned in [comment:101 comment:101].



---

archive/issue_comments_337254.json:
```json
{
    "body": "<a id='comment:5'></a>Sure ! My current question was more about what should we do for the `RR` function. Should we transmit the precision (and replacing the parent during `__c_init__` or during `_set`) or rely on a consistent usage of `RealField` ?",
    "created_at": "2018-01-22T14:35:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337254",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:5'></a>Sure ! My current question was more about what should we do for the `RR` function. Should we transmit the precision (and replacing the parent during `__c_init__` or during `_set`) or rely on a consistent usage of `RealField` ?



---

archive/issue_comments_337255.json:
```json
{
    "body": "<a id='comment:106'></a>Replying to [comment:102 vklein]:\n> Replying to [comment:94 vdelecroix]:\n> \n> ```\n> sage: RR(gmpy2.mpfr(gmpy2.mpq('1/3'), precision=123))\n> 0.333333333333333\n> sage: _.prec()\n> 53\n> ```\n\n\nThat's fine. `RR` is the field of floating-point numbers with 53 bits of precision (stupidly named).",
    "created_at": "2018-01-22T16:44:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337255",
    "user": "https://github.com/videlec"
}
```

<a id='comment:106'></a>Replying to [comment:102 vklein]:
> Replying to [comment:94 vdelecroix]:
> 
> ```
> sage: RR(gmpy2.mpfr(gmpy2.mpq('1/3'), precision=123))
> 0.333333333333333
> sage: _.prec()
> 53
> ```


That's fine. `RR` is the field of floating-point numbers with 53 bits of precision (stupidly named).



---

archive/issue_comments_337256.json:
```json
{
    "body": "<a id='comment:7'></a>That is to say: `RR` is not a function. It is the object `RealField(53)`.\n\n```\nsage: RR is RealField(53)\nTrue\n```",
    "created_at": "2018-01-22T18:05:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337256",
    "user": "https://github.com/videlec"
}
```

<a id='comment:7'></a>That is to say: `RR` is not a function. It is the object `RealField(53)`.

```
sage: RR is RealField(53)
True
```



---

archive/issue_comments_337257.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-01-23T10:51:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337257",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_337258.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-01-23T10:54:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337258",
    "user": "https://github.com/vinklein"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_337259.json:
```json
{
    "body": "<a id='comment:9'></a>Add some test with different precision [comment:93](https://trac.sagemath.org/ticket/22928#comment:93).\\\\\nRebase on #24549.",
    "created_at": "2018-01-23T10:54:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337259",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:9'></a>Add some test with different precision [comment:93](https://trac.sagemath.org/ticket/22928#comment:93).\\
Rebase on #24549.



---

archive/issue_comments_337260.json:
```json
{
    "body": "<a id='comment:0'></a>You do not need to put `# optional - gmpy2` everywhere. Only where you explicitely need `gmpy2`.\n\nCould you also doctest the fact that the composition of conversions `Sage number -> gmpy2 number -> Sage number` is the identity when precisions are set appropriately (ie we get back an equal element)? For example\n\n```\nsage: MPCF = MPComplexField(63)\nsage: x = MPCF('15.64E+128', '15.64E+128')\nsage: y = mpc(x)         # optional - gmpy2\nsage: y.precision        # optional - gmpy2\n(63, 63)\nsage: MPCF(y) == x       # optional - gmpy2\nTrue\n```\nAnd also the other way around `gmpy2 number -> Sage number -> gmpy2 number`\n\n```\nsage: x = gmpy2.mpc('1.324+4e50j', precision=(70,70))  # optional - gmpy2\nsage: y = ComplexField(70)(x)                          # optional - gmpy2\nsage: gmpy2.mpc(y) == x                                # optional - gmpy2\nTrue\n```",
    "created_at": "2018-01-23T11:04:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337260",
    "user": "https://github.com/videlec"
}
```

<a id='comment:0'></a>You do not need to put `# optional - gmpy2` everywhere. Only where you explicitely need `gmpy2`.

Could you also doctest the fact that the composition of conversions `Sage number -> gmpy2 number -> Sage number` is the identity when precisions are set appropriately (ie we get back an equal element)? For example

```
sage: MPCF = MPComplexField(63)
sage: x = MPCF('15.64E+128', '15.64E+128')
sage: y = mpc(x)         # optional - gmpy2
sage: y.precision        # optional - gmpy2
(63, 63)
sage: MPCF(y) == x       # optional - gmpy2
True
```
And also the other way around `gmpy2 number -> Sage number -> gmpy2 number`

```
sage: x = gmpy2.mpc('1.324+4e50j', precision=(70,70))  # optional - gmpy2
sage: y = ComplexField(70)(x)                          # optional - gmpy2
sage: gmpy2.mpc(y) == x                                # optional - gmpy2
True
```



---

archive/issue_comments_337261.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-01-23T13:03:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337261",
    "user": "https://github.com/vinklein"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_337262.json:
```json
{
    "body": "<a id='comment:111'></a>Ok i will add this type of doctest.",
    "created_at": "2018-01-23T13:03:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337262",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:111'></a>Ok i will add this type of doctest.



---

archive/issue_comments_337263.json:
```json
{
    "body": "<a id='comment:2'></a>These tests works with `MPComplexField` and `RealField` but they didn't work with `ComplexField` in `gmpy2 number -> Sage number -> gmpy2 number` way :\n\n```\nsage: x = gmpy2.mpc('1.324+4e50j', precision=(70,70))\nsage: y = ComplexField(70)(x)\nsage: gmpy2.mpc(y) == x\nFalse\nsage: x\nmpc('1.3240000000000000000005+3.9999999999999999999976e+50j',(70,70))\nsage: gmpy2.mpc(y)\nmpc('1.3240000000000000657252+4.0000000000000003051908e+50j',(70,70))\n```\nIs this an issue or a normal rounding behaviour ?",
    "created_at": "2018-01-23T13:56:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337263",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:2'></a>These tests works with `MPComplexField` and `RealField` but they didn't work with `ComplexField` in `gmpy2 number -> Sage number -> gmpy2 number` way :

```
sage: x = gmpy2.mpc('1.324+4e50j', precision=(70,70))
sage: y = ComplexField(70)(x)
sage: gmpy2.mpc(y) == x
False
sage: x
mpc('1.3240000000000000000005+3.9999999999999999999976e+50j',(70,70))
sage: gmpy2.mpc(y)
mpc('1.3240000000000000657252+4.0000000000000003051908e+50j',(70,70))
```
Is this an issue or a normal rounding behaviour ?



---

archive/issue_comments_337264.json:
```json
{
    "body": "<a id='comment:113'></a>Replying to [comment:112 vklein]:\n> These tests works with `MPComplexField` and `RealField` but they didn't work with `ComplexField` in `gmpy2 number -> Sage number -> gmpy2 number` way :\n> \n> \n> ```\n> sage: x = gmpy2.mpc('1.324+4e50j', precision=(70,70))\n> sage: y = ComplexField(70)(x)\n> sage: gmpy2.mpc(y) == x\n> False\n> ```\n> Is this an issue or a normal rounding behaviour ?\n\n\nTo me, this is an issue. The code in your example should just be copying `mpfr_t` values around.",
    "created_at": "2018-01-23T15:06:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337264",
    "user": "https://github.com/videlec"
}
```

<a id='comment:113'></a>Replying to [comment:112 vklein]:
> These tests works with `MPComplexField` and `RealField` but they didn't work with `ComplexField` in `gmpy2 number -> Sage number -> gmpy2 number` way :
> 
> 
> ```
> sage: x = gmpy2.mpc('1.324+4e50j', precision=(70,70))
> sage: y = ComplexField(70)(x)
> sage: gmpy2.mpc(y) == x
> False
> ```
> Is this an issue or a normal rounding behaviour ?


To me, this is an issue. The code in your example should just be copying `mpfr_t` values around.



---

archive/issue_comments_337265.json:
```json
{
    "body": "<a id='comment:4'></a>Are you sure that `precision` means the same thing on both sides?",
    "created_at": "2018-01-23T15:07:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337265",
    "user": "https://github.com/videlec"
}
```

<a id='comment:4'></a>Are you sure that `precision` means the same thing on both sides?



---

archive/issue_comments_337266.json:
```json
{
    "body": "<a id='comment:5'></a>I think that the problem is that we just copy the values of real and imag part and both of them are `gmpy2.mpfr` with their own precision.\n\n```\nsage: x = gmpy2.mpc('1.324+4e50j', precision=(70,70))\nsage: x.precision\n(70, 70)\nsage: x.real.precision\n53\nsage: x.imag.precision\n53\nsage: x\nmpc('1.3240000000000000000005+3.9999999999999999999976e+50j',(70,70))\nsage: x.real, x.imag\n(mpfr('1.3240000000000001'), mpfr('4.0000000000000003e+50'))\n```\n\n`MPComplexField` works fine because it use mpc_set and not two mpfr_set.",
    "created_at": "2018-01-23T15:54:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337266",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:5'></a>I think that the problem is that we just copy the values of real and imag part and both of them are `gmpy2.mpfr` with their own precision.

```
sage: x = gmpy2.mpc('1.324+4e50j', precision=(70,70))
sage: x.precision
(70, 70)
sage: x.real.precision
53
sage: x.imag.precision
53
sage: x
mpc('1.3240000000000000000005+3.9999999999999999999976e+50j',(70,70))
sage: x.real, x.imag
(mpfr('1.3240000000000001'), mpfr('4.0000000000000003e+50'))
```

`MPComplexField` works fine because it use mpc_set and not two mpfr_set.



---

archive/issue_comments_337267.json:
```json
{
    "body": "<a id='comment:6'></a>I don't know if it is a bug from `gmpy2` but having `x.real` to return a double precision and not the corresponding `gmpy2.mpfr` with the same precision as the real part is weird. Would be nice to see whether it is intended in `gmpy2`.\n\nFor this ticket you could just avoid using `.real` and `.imag` in the `ComplexNumber` code.",
    "created_at": "2018-01-23T15:59:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337267",
    "user": "https://github.com/videlec"
}
```

<a id='comment:6'></a>I don't know if it is a bug from `gmpy2` but having `x.real` to return a double precision and not the corresponding `gmpy2.mpfr` with the same precision as the real part is weird. Would be nice to see whether it is intended in `gmpy2`.

For this ticket you could just avoid using `.real` and `.imag` in the `ComplexNumber` code.



---

archive/issue_comments_337268.json:
```json
{
    "body": "<a id='comment:7'></a>Specification are really cool!\n\n```\nimag\n    Returns the imaginary component.\nreal\n    Returns the real component.\n```\n(see https://github.com/aleaxit/gmpy/blob/master/docs/mpc.rst)",
    "created_at": "2018-01-23T16:01:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337268",
    "user": "https://github.com/videlec"
}
```

<a id='comment:7'></a>Specification are really cool!

```
imag
    Returns the imaginary component.
real
    Returns the real component.
```
(see https://github.com/aleaxit/gmpy/blob/master/docs/mpc.rst)



---

archive/issue_comments_337269.json:
```json
{
    "body": "<a id='comment:8'></a>Yes very accurate !\n\nIt works fine without `.real` and `.imag`. Tests are running now.",
    "created_at": "2018-01-23T16:53:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337269",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:8'></a>Yes very accurate !

It works fine without `.real` and `.imag`. Tests are running now.



---

archive/issue_comments_337270.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-01-23T21:13:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337270",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_337271.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-01-23T21:14:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337271",
    "user": "https://github.com/vinklein"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_337272.json:
```json
{
    "body": "<a id='comment:1'></a>Do you really need the cast `<mpc_t>`? This is already explicit in the `gmpy2` Cython header.",
    "created_at": "2018-01-24T08:04:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337272",
    "user": "https://github.com/videlec"
}
```

<a id='comment:1'></a>Do you really need the cast `<mpc_t>`? This is already explicit in the `gmpy2` Cython header.



---

archive/issue_comments_337273.json:
```json
{
    "body": "<a id='comment:2'></a>I think i do at least \n\n```\n mpfr_set(self.__im, (<gmpy2.mpc>real).c.im, rnd)\n                                                      ^\n------------------------------------------------------------\n\nsage/rings/complex_number.pyx:197:55: Cannot convert Python object to '__mpfr_struct *'\n```\n\nWhat syntax would you suggest ?",
    "created_at": "2018-01-24T08:16:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337273",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:2'></a>I think i do at least 

```
 mpfr_set(self.__im, (<gmpy2.mpc>real).c.im, rnd)
                                                      ^
------------------------------------------------------------

sage/rings/complex_number.pyx:197:55: Cannot convert Python object to '__mpfr_struct *'
```

What syntax would you suggest ?



---

archive/issue_comments_337274.json:
```json
{
    "body": "<a id='comment:123'></a>Replying to [comment:122 vklein]:\n> I think i do at least \n> \n> ```\n>  mpfr_set(self.__im, (<gmpy2.mpc>real).c.im, rnd)\n>                                                       ^\n> ------------------------------------------------------------\n> \n> sage/rings/complex_number.pyx:197:55: Cannot convert Python object to '__mpfr_struct *'\n> ```\n> \n> What syntax would you suggest ?\n\n\nThe one in your comment. There might be something wrong with the Cython headers. Maybe the following change in `gmpy2.pxd` might be enough \n\n```diff\ndiff --git a/src/gmpy2.pxd b/src/gmpy2.pxd\nindex 7cdcc72..d6cac1b 100644\n--- a/src/gmpy2.pxd\n+++ b/src/gmpy2.pxd\n@@ -45,7 +45,8 @@ cdef extern from \"mpfr.h\":\n cdef extern from \"mpc.h\":\n     # mpc complexes\n     ctypedef struct __mpc_struct:\n-        pass\n+        mpfr_t re\n+        mpfr_t im\n     ctypedef __mpc_struct mpc_t[1];\n     ctypedef __mpc_struct *mpc_ptr;\n     ctypedef const __mpc_struct *mpc_srcptr;\n```",
    "created_at": "2018-01-24T09:31:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337274",
    "user": "https://github.com/videlec"
}
```

<a id='comment:123'></a>Replying to [comment:122 vklein]:
> I think i do at least 
> 
> ```
>  mpfr_set(self.__im, (<gmpy2.mpc>real).c.im, rnd)
>                                                       ^
> ------------------------------------------------------------
> 
> sage/rings/complex_number.pyx:197:55: Cannot convert Python object to '__mpfr_struct *'
> ```
> 
> What syntax would you suggest ?


The one in your comment. There might be something wrong with the Cython headers. Maybe the following change in `gmpy2.pxd` might be enough 

```diff
diff --git a/src/gmpy2.pxd b/src/gmpy2.pxd
index 7cdcc72..d6cac1b 100644
--- a/src/gmpy2.pxd
+++ b/src/gmpy2.pxd
@@ -45,7 +45,8 @@ cdef extern from "mpfr.h":
 cdef extern from "mpc.h":
     # mpc complexes
     ctypedef struct __mpc_struct:
-        pass
+        mpfr_t re
+        mpfr_t im
     ctypedef __mpc_struct mpc_t[1];
     ctypedef __mpc_struct *mpc_ptr;
     ctypedef const __mpc_struct *mpc_srcptr;
```



---

archive/issue_comments_337275.json:
```json
{
    "body": "<a id='comment:4'></a>It works with your solution. That being said i am not sure if avoiding a cast is worth patching `gmpy2`. \\\\\nI would rather keep the current syntax and do a proper pull request for `gmpy2`.",
    "created_at": "2018-01-24T09:57:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337275",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:4'></a>It works with your solution. That being said i am not sure if avoiding a cast is worth patching `gmpy2`. \\
I would rather keep the current syntax and do a proper pull request for `gmpy2`.



---

archive/issue_comments_337276.json:
```json
{
    "body": "<a id='comment:125'></a>Replying to [comment:118 vklein]:\n> Yes very accurate !\n> \n> It works fine without `.real` and `.imag`. Tests are running now.\n\n\nThis is also obviously an upstream bug.",
    "created_at": "2018-01-24T14:51:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337276",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:125'></a>Replying to [comment:118 vklein]:
> Yes very accurate !
> 
> It works fine without `.real` and `.imag`. Tests are running now.


This is also obviously an upstream bug.



---

archive/issue_comments_337277.json:
```json
{
    "body": "<a id='comment:6'></a>In `complex_number.pyx` you are only using the `mpc_t` type, nothing else from MPC. So just use `from sage.libs.mpc.types cimport mpc_t`.",
    "created_at": "2018-01-24T15:19:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337277",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>In `complex_number.pyx` you are only using the `mpc_t` type, nothing else from MPC. So just use `from sage.libs.mpc.types cimport mpc_t`.



---

archive/issue_comments_337278.json:
```json
{
    "body": "<a id='comment:7'></a>I think it would be good to at least *report* the bugs upstream to gmpy2.",
    "created_at": "2018-01-24T15:20:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337278",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>I think it would be good to at least *report* the bugs upstream to gmpy2.



---

archive/issue_comments_337279.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-01-24T15:21:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337279",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_337280.json:
```json
{
    "body": "<a id='comment:130'></a>Replying to [comment:127 jdemeyer]:\n> I think it would be good to at least *report* the bugs upstream to gmpy2.\n\n\nSure you're right. https://github.com/aleaxit/gmpy/issues/179",
    "created_at": "2018-01-24T18:48:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337280",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:130'></a>Replying to [comment:127 jdemeyer]:
> I think it would be good to at least *report* the bugs upstream to gmpy2.


Sure you're right. https://github.com/aleaxit/gmpy/issues/179



---

archive/issue_comments_337281.json:
```json
{
    "body": "<a id='comment:1'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-01-24T18:56:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337281",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:1'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_337282.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-01-24T18:59:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337282",
    "user": "https://github.com/vinklein"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_337283.json:
```json
{
    "body": "<a id='comment:132'></a>Replying to [comment:126 jdemeyer]:\n> In `complex_number.pyx` you are only using the `mpc_t` type, nothing else from MPC. So just use `from sage.libs.mpc.types cimport mpc_t`.\n\n\nDone",
    "created_at": "2018-01-24T18:59:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337283",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:132'></a>Replying to [comment:126 jdemeyer]:
> In `complex_number.pyx` you are only using the `mpc_t` type, nothing else from MPC. So just use `from sage.libs.mpc.types cimport mpc_t`.


Done



---

archive/issue_comments_337284.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-01-24T20:10:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337284",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_337285.json:
```json
{
    "body": "<a id='comment:133'></a>Replying to [comment:132 vklein]:\n> Replying to [comment:126 jdemeyer]:\n> > In `complex_number.pyx` you are only using the `mpc_t` type, nothing else from MPC. So just use `from sage.libs.mpc.types cimport mpc_t`.\n\n> \n> Done\n\n\nNo. I wrote `from sage.libs.mpc.types cimport mpc_t` and I meant exactly what I wrote.",
    "created_at": "2018-01-24T20:10:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337285",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:133'></a>Replying to [comment:132 vklein]:
> Replying to [comment:126 jdemeyer]:
> > In `complex_number.pyx` you are only using the `mpc_t` type, nothing else from MPC. So just use `from sage.libs.mpc.types cimport mpc_t`.

> 
> Done


No. I wrote `from sage.libs.mpc.types cimport mpc_t` and I meant exactly what I wrote.



---

archive/issue_comments_337286.json:
```json
{
    "body": "<a id='comment:4'></a>Doctests crash at runtime with the later syntax. \n\n```\nsage -t --long src/sage/rings/complex_number.pyx\nTraceback (most recent call last):\n  File \"/home/vklein/odk/sage/src/bin/sage-runtests\", line 123, in <module>\n    from sage.doctest.control import DocTestController\n  File \"/home/vklein/odk/sage/local/lib/python2.7/site-packages/sage/doctest/control.py\", line 33, in <module>\n    from .sources import FileDocTestSource, DictAsObject\n  File \"/home/vklein/odk/sage/local/lib/python2.7/site-packages/sage/doctest/sources.py\", line 32, in <module>\n    from .parsing import SageDocTestParser\n  File \"/home/vklein/odk/sage/local/lib/python2.7/site-packages/sage/doctest/parsing.py\", line 57, in <module>\n    from sage.all import RealIntervalField\n  File \"/home/vklein/odk/sage/local/lib/python2.7/site-packages/sage/all.py\", line 87, in <module>\n    from sage.misc.all       import *         # takes a while\n  File \"/home/vklein/odk/sage/local/lib/python2.7/site-packages/sage/misc/all.py\", line 84, in <module>\n    from .functional import (additive_order,\n  File \"/home/vklein/odk/sage/local/lib/python2.7/site-packages/sage/misc/functional.py\", line 27, in <module>\n    from sage.rings.complex_double import CDF\n  File \"sage/rings/integer.pxd\", line 7, in init sage.rings.complex_double\n  File \"sage/rings/rational.pxd\", line 8, in init sage.rings.integer\n  File \"sage/rings/rational.pyx\", line 94, in init sage.rings.rational\n  File \"sage/rings/real_mpfr.pyx\", line 1, in init sage.rings.real_mpfr\n  File \"sage/rings/complex_number.pxd\", line 6, in init sage.libs.mpmath.utils\nImportError: /home/vklein/odk/sage/local/lib/python2.7/site-packages/sage/rings/complex_number.so: undefined symbol: mpc_set_fr_fr\n```",
    "created_at": "2018-01-24T22:12:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337286",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:4'></a>Doctests crash at runtime with the later syntax. 

```
sage -t --long src/sage/rings/complex_number.pyx
Traceback (most recent call last):
  File "/home/vklein/odk/sage/src/bin/sage-runtests", line 123, in <module>
    from sage.doctest.control import DocTestController
  File "/home/vklein/odk/sage/local/lib/python2.7/site-packages/sage/doctest/control.py", line 33, in <module>
    from .sources import FileDocTestSource, DictAsObject
  File "/home/vklein/odk/sage/local/lib/python2.7/site-packages/sage/doctest/sources.py", line 32, in <module>
    from .parsing import SageDocTestParser
  File "/home/vklein/odk/sage/local/lib/python2.7/site-packages/sage/doctest/parsing.py", line 57, in <module>
    from sage.all import RealIntervalField
  File "/home/vklein/odk/sage/local/lib/python2.7/site-packages/sage/all.py", line 87, in <module>
    from sage.misc.all       import *         # takes a while
  File "/home/vklein/odk/sage/local/lib/python2.7/site-packages/sage/misc/all.py", line 84, in <module>
    from .functional import (additive_order,
  File "/home/vklein/odk/sage/local/lib/python2.7/site-packages/sage/misc/functional.py", line 27, in <module>
    from sage.rings.complex_double import CDF
  File "sage/rings/integer.pxd", line 7, in init sage.rings.complex_double
  File "sage/rings/rational.pxd", line 8, in init sage.rings.integer
  File "sage/rings/rational.pyx", line 94, in init sage.rings.rational
  File "sage/rings/real_mpfr.pyx", line 1, in init sage.rings.real_mpfr
  File "sage/rings/complex_number.pxd", line 6, in init sage.libs.mpmath.utils
ImportError: /home/vklein/odk/sage/local/lib/python2.7/site-packages/sage/rings/complex_number.so: undefined symbol: mpc_set_fr_fr
```



---

archive/issue_comments_337287.json:
```json
{
    "body": "<a id='comment:5'></a>Indeed, `mpc/types.pxd` does not contain the distutils directive for libraries. Since `types.pxd` is included in all other files in `mpc/` it makes more sense to have the directive in this file rather than in `__init__.pxd`.",
    "created_at": "2018-01-25T07:11:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337287",
    "user": "https://github.com/videlec"
}
```

<a id='comment:5'></a>Indeed, `mpc/types.pxd` does not contain the distutils directive for libraries. Since `types.pxd` is included in all other files in `mpc/` it makes more sense to have the directive in this file rather than in `__init__.pxd`.



---

archive/issue_comments_337288.json:
```json
{
    "body": "<a id='comment:6'></a>But who is calling `mpc_set_fr_fr` in that file?",
    "created_at": "2018-01-25T08:45:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337288",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>But who is calling `mpc_set_fr_fr` in that file?



---

archive/issue_comments_337289.json:
```json
{
    "body": "<a id='comment:7'></a>I see. The `gmpy2` function `GMPy_MPC_From_mpfr` requires MPC.",
    "created_at": "2018-01-25T08:52:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337289",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>I see. The `gmpy2` function `GMPy_MPC_From_mpfr` requires MPC.



---

archive/issue_comments_337290.json:
```json
{
    "body": "<a id='comment:8'></a>Should we add a distutils directive to the `gmpy2.pxd` header?",
    "created_at": "2018-01-25T09:07:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337290",
    "user": "https://github.com/videlec"
}
```

<a id='comment:8'></a>Should we add a distutils directive to the `gmpy2.pxd` header?



---

archive/issue_comments_337291.json:
```json
{
    "body": "<a id='comment:139'></a>Replying to [comment:138 vdelecroix]:\n> Should we add a distutils directive to the `gmpy2.pxd` header?\n\n\nNo because not everybody using that header will need every library. It seems overkill to require gmp and mpfr and mpc if you only ever use the `mpz_t` type.\n\nI was thinking about something else: it is trivial to replace `mpc_set_fr_fr` by two `mpfr_set` calls. So maybe we could just do that. I'll try to create a PR for gmpy2.",
    "created_at": "2018-01-25T09:10:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337291",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:139'></a>Replying to [comment:138 vdelecroix]:
> Should we add a distutils directive to the `gmpy2.pxd` header?


No because not everybody using that header will need every library. It seems overkill to require gmp and mpfr and mpc if you only ever use the `mpz_t` type.

I was thinking about something else: it is trivial to replace `mpc_set_fr_fr` by two `mpfr_set` calls. So maybe we could just do that. I'll try to create a PR for gmpy2.



---

archive/issue_comments_337292.json:
```json
{
    "body": "<a id='comment:140'></a>Replying to [comment:139 jdemeyer]:\n> Replying to [comment:138 vdelecroix]:\n> > Should we add a distutils directive to the `gmpy2.pxd` header?\n\n> \n> No because not everybody using that header will need every library. It seems overkill to require gmp and mpfr and mpc if you only ever use the `mpz_t` type.\n> \n> I was thinking about something else: it is trivial to replace `mpc_set_fr_fr` by two `mpfr_set` calls. So maybe we could just do that. I'll try to create a PR for gmpy2.\n\n\nUsing `mpc_set_fr_fr` would impose to link against mpfr. A cleaner possibility is to split the `gmpy2` headers into 3 headers `gmpy2.gmp`, `gmpy2.mpfr` and `gmpy2.mpc`. Each of them with a proper distutils directive.",
    "created_at": "2018-01-25T09:29:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337292",
    "user": "https://github.com/videlec"
}
```

<a id='comment:140'></a>Replying to [comment:139 jdemeyer]:
> Replying to [comment:138 vdelecroix]:
> > Should we add a distutils directive to the `gmpy2.pxd` header?

> 
> No because not everybody using that header will need every library. It seems overkill to require gmp and mpfr and mpc if you only ever use the `mpz_t` type.
> 
> I was thinking about something else: it is trivial to replace `mpc_set_fr_fr` by two `mpfr_set` calls. So maybe we could just do that. I'll try to create a PR for gmpy2.


Using `mpc_set_fr_fr` would impose to link against mpfr. A cleaner possibility is to split the `gmpy2` headers into 3 headers `gmpy2.gmp`, `gmpy2.mpfr` and `gmpy2.mpc`. Each of them with a proper distutils directive.



---

archive/issue_comments_337293.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,19 @@\n+The library `gmpy2` supports conversions by the use of special methods. In order to allow conversion of Sage objects into gmpy2 objects, we implement the following methods\n+- `__mpz__` on Sage Integer\n+- `__mpq__` on Sage Rational\n+- `__mpfr__` on relevant Sage real numbers\n+   - `RealNumber` (`sage.rings.real_mpfr`)\n+   - `RealDoubleElement` (`sage.rings.real_double`)\n+- `__mpc__` on relevant Sage complex numbers\n+   - `ComplexDoubleElement` (`sage.rings.complex_double`)\n+   - `MPComplexNumber` (`sage.rings.complex_mpc`)\n+   - `ComplexNumber` (`sage.rings.complex_number`)\n \n+Conversly, we make Sage integer, rational, real and complex constructors accept gmpy2 arguments.\n+\n+Upstream issues:\n+- https://github.com/aleaxit/gmpy/pull/179\n+- https://github.com/aleaxit/gmpy/pull/180\n \n Author: Vincent Klein\n \n``````\n",
    "created_at": "2018-01-25T09:34:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337293",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,19 @@
+The library `gmpy2` supports conversions by the use of special methods. In order to allow conversion of Sage objects into gmpy2 objects, we implement the following methods
+- `__mpz__` on Sage Integer
+- `__mpq__` on Sage Rational
+- `__mpfr__` on relevant Sage real numbers
+   - `RealNumber` (`sage.rings.real_mpfr`)
+   - `RealDoubleElement` (`sage.rings.real_double`)
+- `__mpc__` on relevant Sage complex numbers
+   - `ComplexDoubleElement` (`sage.rings.complex_double`)
+   - `MPComplexNumber` (`sage.rings.complex_mpc`)
+   - `ComplexNumber` (`sage.rings.complex_number`)
 
+Conversly, we make Sage integer, rational, real and complex constructors accept gmpy2 arguments.
+
+Upstream issues:
+- https://github.com/aleaxit/gmpy/pull/179
+- https://github.com/aleaxit/gmpy/pull/180
 
 Author: Vincent Klein
 
``````




---

archive/issue_comments_337294.json:
```json
{
    "body": "<a id='comment:142'></a>Replying to [comment:140 vdelecroix]:\n> Using `mpc_set_fr_fr` would impose to link against mpfr.\n\n\nI guess you mean \"using `mpfr_set` would impose to link against mpfr\".\n\nBut that is in fact a very logical requirement, since the input type of `GMPy_MPC_From_mpfr` is `mpfr_t`. So you already need to have an `mpfr_t` in order to use that function, which makes it likely that you are using MPFR already.",
    "created_at": "2018-01-25T09:38:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337294",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:142'></a>Replying to [comment:140 vdelecroix]:
> Using `mpc_set_fr_fr` would impose to link against mpfr.


I guess you mean "using `mpfr_set` would impose to link against mpfr".

But that is in fact a very logical requirement, since the input type of `GMPy_MPC_From_mpfr` is `mpfr_t`. So you already need to have an `mpfr_t` in order to use that function, which makes it likely that you are using MPFR already.



---

archive/issue_comments_337295.json:
```json
{
    "body": "<a id='comment:143'></a>Replying to [comment:142 jdemeyer]:\n> Replying to [comment:140 vdelecroix]:\n> > Using `mpc_set_fr_fr` would impose to link against mpfr.\n\n> \n> I guess you mean \"using `mpfr_set` would impose to link against mpfr\".\n> \n> But that is in fact a very logical requirement, since the input type of `GMPy_MPC_From_mpfr` is `mpfr_t`. So you already need to have an `mpfr_t` in order to use that function, which makes it likely that you are using MPFR already.\n\n\nAnd using a `mpc` from `gmpy2` does not imply that you are using `mpc`!?",
    "created_at": "2018-01-25T09:41:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337295",
    "user": "https://github.com/videlec"
}
```

<a id='comment:143'></a>Replying to [comment:142 jdemeyer]:
> Replying to [comment:140 vdelecroix]:
> > Using `mpc_set_fr_fr` would impose to link against mpfr.

> 
> I guess you mean "using `mpfr_set` would impose to link against mpfr".
> 
> But that is in fact a very logical requirement, since the input type of `GMPy_MPC_From_mpfr` is `mpfr_t`. So you already need to have an `mpfr_t` in order to use that function, which makes it likely that you are using MPFR already.


And using a `mpc` from `gmpy2` does not imply that you are using `mpc`!?



---

archive/issue_comments_337296.json:
```json
{
    "body": "<a id='comment:4'></a>Will it be so inconsistent to just stick with `from sage.libs.mpc cimport *` for this ticket? \\\\\nI don't see clearly how much impact it has on memory/performance.",
    "created_at": "2018-01-25T10:01:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337296",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:4'></a>Will it be so inconsistent to just stick with `from sage.libs.mpc cimport *` for this ticket? \\
I don't see clearly how much impact it has on memory/performance.



---

archive/issue_comments_337297.json:
```json
{
    "body": "<a id='comment:145'></a>Replying to [comment:143 vdelecroix]:\n> And using a `mpc` from `gmpy2` does not imply that you are using `mpc`!?\n\n\nSure, but in an indirect way, through the `gmpy2` package. My point is that you shouldn't require the MPC library in the Cython module which creates a `gmpy2.mpc` object.",
    "created_at": "2018-01-25T10:02:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337297",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:145'></a>Replying to [comment:143 vdelecroix]:
> And using a `mpc` from `gmpy2` does not imply that you are using `mpc`!?


Sure, but in an indirect way, through the `gmpy2` package. My point is that you shouldn't require the MPC library in the Cython module which creates a `gmpy2.mpc` object.



---

archive/issue_comments_337298.json:
```json
{
    "body": "<a id='comment:146'></a>Replying to [comment:144 vklein]:\n> Will it be so inconsistent to just stick with `from sage.libs.mpc cimport *` for this ticket? \\\\\n> I don't see clearly how much impact it has on memory/performance.\n\n\nI agree... we can still fix this later. I'd like to wait a little bit for an answer from upstream though.",
    "created_at": "2018-01-25T10:03:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337298",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:146'></a>Replying to [comment:144 vklein]:
> Will it be so inconsistent to just stick with `from sage.libs.mpc cimport *` for this ticket? \\
> I don't see clearly how much impact it has on memory/performance.


I agree... we can still fix this later. I'd like to wait a little bit for an answer from upstream though.



---

archive/issue_comments_337299.json:
```json
{
    "body": "<a id='comment:7'></a>With my patch to gmpy2, the following works:\n\n```diff\ndiff --git a/src/sage/rings/complex_number.pyx b/src/sage/rings/complex_number.pyx\nindex bf0e4a3..76782c3 100644\n--- a/src/sage/rings/complex_number.pyx\n+++ b/src/sage/rings/complex_number.pyx\n@@ -31,7 +31,7 @@ from __future__ import absolute_import, print_function\n import math\n import operator\n \n-from sage.libs.mpc cimport mpc_t\n+from sage.libs.mpc.types cimport mpc_t\n from sage.libs.mpfr cimport *\n from sage.structure.element cimport FieldElement, RingElement, Element, ModuleElement\n from sage.categories.map cimport Map\n@@ -193,8 +193,8 @@ cdef class ComplexNumber(sage.structure.element.FieldElement):\n             elif isinstance(real, complex):\n                 real, imag = real.real, real.imag\n             elif HAVE_GMPY2 and type(real) is gmpy2.mpc:\n-                mpfr_set(self.__re, (<mpc_t>(<gmpy2.mpc>real).c).re, rnd)\n-                mpfr_set(self.__im, (<mpc_t>(<gmpy2.mpc>real).c).im, rnd)\n+                mpfr_set(self.__re, (<gmpy2.mpc>real).c.re, rnd)\n+                mpfr_set(self.__im, (<gmpy2.mpc>real).c.im, rnd)\n                 return\n             else:\n                 imag = 0\n```",
    "created_at": "2018-01-25T10:04:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337299",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>With my patch to gmpy2, the following works:

```diff
diff --git a/src/sage/rings/complex_number.pyx b/src/sage/rings/complex_number.pyx
index bf0e4a3..76782c3 100644
--- a/src/sage/rings/complex_number.pyx
+++ b/src/sage/rings/complex_number.pyx
@@ -31,7 +31,7 @@ from __future__ import absolute_import, print_function
 import math
 import operator
 
-from sage.libs.mpc cimport mpc_t
+from sage.libs.mpc.types cimport mpc_t
 from sage.libs.mpfr cimport *
 from sage.structure.element cimport FieldElement, RingElement, Element, ModuleElement
 from sage.categories.map cimport Map
@@ -193,8 +193,8 @@ cdef class ComplexNumber(sage.structure.element.FieldElement):
             elif isinstance(real, complex):
                 real, imag = real.real, real.imag
             elif HAVE_GMPY2 and type(real) is gmpy2.mpc:
-                mpfr_set(self.__re, (<mpc_t>(<gmpy2.mpc>real).c).re, rnd)
-                mpfr_set(self.__im, (<mpc_t>(<gmpy2.mpc>real).c).im, rnd)
+                mpfr_set(self.__re, (<gmpy2.mpc>real).c.re, rnd)
+                mpfr_set(self.__im, (<gmpy2.mpc>real).c.im, rnd)
                 return
             else:
                 imag = 0
```



---

archive/issue_comments_337300.json:
```json
{
    "body": "<a id='comment:8'></a>And i have fixed issue \u200b[gmpy2 issue #179](https://github.com/aleaxit/gmpy/pull/179) with this PR\nhttps://github.com/aleaxit/gmpy/pull/181.\n\nWhat should we do next ? :\n- Waiting for a gmpy2 release.\n- Doing sage patchs for gmpy2 (maybe after `gmpy2` PR's are reviewed and merged).\n- Or switch this ticket in need_review as it is.",
    "created_at": "2018-01-25T15:12:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337300",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:8'></a>And i have fixed issue ​[gmpy2 issue #179](https://github.com/aleaxit/gmpy/pull/179) with this PR
https://github.com/aleaxit/gmpy/pull/181.

What should we do next ? :
- Waiting for a gmpy2 release.
- Doing sage patchs for gmpy2 (maybe after `gmpy2` PR's are reviewed and merged).
- Or switch this ticket in need_review as it is.



---

archive/issue_comments_337301.json:
```json
{
    "body": "<a id='comment:149'></a>Replying to [comment:148 vklein]:\n> And i have fixed issue \u200b[gmpy2 issue #179](https://github.com/aleaxit/gmpy/pull/179) with this PR\n> https://github.com/aleaxit/gmpy/pull/181.\n> \n> What should we do next ? :\n> - Waiting for a gmpy2 release.\n> - Doing sage patchs for gmpy2 (maybe after `gmpy2` PR's are reviewed and merged).\n> - Or switch this ticket in need_review as it is.\n\n\nI would say\n- create a patch and add it to gmpy2\n- move the ticket in needs review\n- wait for the PR to be accepted before setting it to positive review\nThe rationale is that we are currently testing gmpy2 integration. At the time it stabilizes, we should ask for a new release and remove all of Sage patches.",
    "created_at": "2018-01-25T15:54:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337301",
    "user": "https://github.com/videlec"
}
```

<a id='comment:149'></a>Replying to [comment:148 vklein]:
> And i have fixed issue ​[gmpy2 issue #179](https://github.com/aleaxit/gmpy/pull/179) with this PR
> https://github.com/aleaxit/gmpy/pull/181.
> 
> What should we do next ? :
> - Waiting for a gmpy2 release.
> - Doing sage patchs for gmpy2 (maybe after `gmpy2` PR's are reviewed and merged).
> - Or switch this ticket in need_review as it is.


I would say
- create a patch and add it to gmpy2
- move the ticket in needs review
- wait for the PR to be accepted before setting it to positive review
The rationale is that we are currently testing gmpy2 integration. At the time it stabilizes, we should ask for a new release and remove all of Sage patches.



---

archive/issue_comments_337302.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,19 @@\n+The library `gmpy2` supports conversions by the use of special methods. In order to allow conversion of Sage objects into gmpy2 objects, we implement the following methods\n+- `__mpz__` on Sage Integer\n+- `__mpq__` on Sage Rational\n+- `__mpfr__` on relevant Sage real numbers\n+   - `RealNumber` (`sage.rings.real_mpfr`)\n+   - `RealDoubleElement` (`sage.rings.real_double`)\n+- `__mpc__` on relevant Sage complex numbers\n+   - `ComplexDoubleElement` (`sage.rings.complex_double`)\n+   - `MPComplexNumber` (`sage.rings.complex_mpc`)\n+   - `ComplexNumber` (`sage.rings.complex_number`)\n \n+Conversly, we make Sage integer, rational, real and complex constructors accept gmpy2 arguments.\n+\n+Upstream issues:\n+- https://github.com/aleaxit/gmpy/pull/180\n+- https://github.com/aleaxit/gmpy/pull/181\n \n Author: Vincent Klein\n \n``````\n",
    "created_at": "2018-01-25T16:03:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337302",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,19 @@
+The library `gmpy2` supports conversions by the use of special methods. In order to allow conversion of Sage objects into gmpy2 objects, we implement the following methods
+- `__mpz__` on Sage Integer
+- `__mpq__` on Sage Rational
+- `__mpfr__` on relevant Sage real numbers
+   - `RealNumber` (`sage.rings.real_mpfr`)
+   - `RealDoubleElement` (`sage.rings.real_double`)
+- `__mpc__` on relevant Sage complex numbers
+   - `ComplexDoubleElement` (`sage.rings.complex_double`)
+   - `MPComplexNumber` (`sage.rings.complex_mpc`)
+   - `ComplexNumber` (`sage.rings.complex_number`)
 
+Conversly, we make Sage integer, rational, real and complex constructors accept gmpy2 arguments.
+
+Upstream issues:
+- https://github.com/aleaxit/gmpy/pull/180
+- https://github.com/aleaxit/gmpy/pull/181
 
 Author: Vincent Klein
 
``````




---

archive/issue_comments_337303.json:
```json
{
    "body": "<a id='comment:1'></a>Fine for me!",
    "created_at": "2018-01-25T16:03:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337303",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:1'></a>Fine for me!



---

archive/issue_comments_337304.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-01-26T10:31:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337304",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_337305.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-01-26T10:44:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337305",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_337306.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-01-26T10:48:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337306",
    "user": "https://github.com/vinklein"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_337307.json:
```json
{
    "body": "<a id='comment:4'></a>Patch are done. The corresponding PRs are merged.",
    "created_at": "2018-01-26T10:48:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337307",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:4'></a>Patch are done. The corresponding PRs are merged.



---

archive/issue_comments_337308.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-01-26T10:52:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337308",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_337309.json:
```json
{
    "body": "<a id='comment:5'></a>You need to bump the `gmpy2` version number for the patches to apply.",
    "created_at": "2018-01-26T10:52:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337309",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>You need to bump the `gmpy2` version number for the patches to apply.



---

archive/issue_comments_337310.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-01-26T10:58:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337310",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_337311.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-01-26T10:59:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337311",
    "user": "https://github.com/vinklein"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_337312.json:
```json
{
    "body": "<a id='comment:7'></a>I see, thanks.",
    "created_at": "2018-01-26T10:59:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337312",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:7'></a>I see, thanks.



---

archive/issue_comments_337313.json:
```json
{
    "body": "<a id='comment:8'></a>The following line misses a `# optional - gmpy2`\n\n```\n            sage: x = mpfr(R.pi())\n```",
    "created_at": "2018-01-26T13:26:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337313",
    "user": "https://github.com/videlec"
}
```

<a id='comment:8'></a>The following line misses a `# optional - gmpy2`

```
            sage: x = mpfr(R.pi())
```



---

archive/issue_comments_337314.json:
```json
{
    "body": "<a id='comment:9'></a>Yeah and two others after this one \n\n```\nsage: y = RealField(128)(x) \nsage: mpfr(y) == x\n```\n\nI will rerun tests without gmpy2 package installed",
    "created_at": "2018-01-26T13:32:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337314",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:9'></a>Yeah and two others after this one 

```
sage: y = RealField(128)(x) 
sage: mpfr(y) == x
```

I will rerun tests without gmpy2 package installed



---

archive/issue_comments_337315.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-01-26T13:33:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337315",
    "user": "https://github.com/vinklein"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_337316.json:
```json
{
    "body": "<a id='comment:1'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-01-26T16:16:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337316",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:1'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_337317.json:
```json
{
    "body": "<a id='comment:2'></a>All test without gmpy2 passed, tests with gmpy2 are runnings.",
    "created_at": "2018-01-26T16:20:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337317",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:2'></a>All test without gmpy2 passed, tests with gmpy2 are runnings.



---

archive/issue_comments_337318.json:
```json
{
    "body": "<a id='comment:3'></a>needs review? The branch is fine for me in the current state.",
    "created_at": "2018-01-26T16:31:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337318",
    "user": "https://github.com/videlec"
}
```

<a id='comment:3'></a>needs review? The branch is fine for me in the current state.



---

archive/issue_comments_337319.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-01-26T16:33:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337319",
    "user": "https://github.com/vinklein"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_337320.json:
```json
{
    "body": "<a id='comment:4'></a>Okay then.",
    "created_at": "2018-01-26T16:33:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337320",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:4'></a>Okay then.



---

archive/issue_comments_337321.json:
```json
{
    "body": "<a id='comment:5'></a>In `real_double.pyx` you call `cimport gmpy2` but does not do `gmpy2.import_gmpy2()`.",
    "created_at": "2018-01-26T16:37:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337321",
    "user": "https://github.com/videlec"
}
```

<a id='comment:5'></a>In `real_double.pyx` you call `cimport gmpy2` but does not do `gmpy2.import_gmpy2()`.



---

archive/issue_comments_337322.json:
```json
{
    "body": "<a id='comment:6'></a>Yes but `real_double.pyx` do `cimport sage.ring.integer` and the later call `gmpy2.import_gmpy2()`.",
    "created_at": "2018-01-26T20:40:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337322",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:6'></a>Yes but `real_double.pyx` do `cimport sage.ring.integer` and the later call `gmpy2.import_gmpy2()`.



---

archive/issue_comments_337323.json:
```json
{
    "body": "<a id='comment:167'></a>Replying to [comment:166 vklein]:\n> Yes but `real_double.pyx` do `cimport sage.ring.integer` and the later call `gmpy2.import_gmpy2()`. \n\n\nThis sentence makes me sad and worried at the same time. It shows that you absolutely do not understand what `import_gmpy2()` does.\n\nThe *real reason* that you don't need `import_gmpy2()` in that file is that you are simply not calling any gmpy2 functions in that Cython module.",
    "created_at": "2018-01-27T08:05:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337323",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:167'></a>Replying to [comment:166 vklein]:
> Yes but `real_double.pyx` do `cimport sage.ring.integer` and the later call `gmpy2.import_gmpy2()`. 


This sentence makes me sad and worried at the same time. It shows that you absolutely do not understand what `import_gmpy2()` does.

The *real reason* that you don't need `import_gmpy2()` in that file is that you are simply not calling any gmpy2 functions in that Cython module.



---

archive/issue_comments_337324.json:
```json
{
    "body": "<a id='comment:8'></a>Is it ok Jeroen?",
    "created_at": "2018-01-30T14:25:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337324",
    "user": "https://github.com/videlec"
}
```

<a id='comment:8'></a>Is it ok Jeroen?



---

archive/issue_comments_337325.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-01-30T14:30:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337325",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_059478.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-02-02T12:06:15Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22928#event-59478"
}
```



---

archive/issue_comments_337326.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-02-02T12:06:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337326",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_337327.json:
```json
{
    "body": "<a id='comment:1'></a>A small remark to say that some warnings associated to gmpy2 appear at each run of `sage -b` (without gmpy2):\n\n```\n[sagelib-8.2.rc3] sage/rings/complex_double.pyx: cannot find cimported module 'gmpy2'\n[sagelib-8.2.rc3] sage/rings/complex_number.pyx: cannot find cimported module 'gmpy2'\n[sagelib-8.2.rc3] sage/rings/integer.pyx: cannot find cimported module 'gmpy2'\n[sagelib-8.2.rc3] sage/rings/complex_mpc.pyx: cannot find cimported module 'gmpy2'\n[sagelib-8.2.rc3] sage/rings/rational.pyx: cannot find cimported module 'gmpy2'\n[sagelib-8.2.rc3] sage/rings/real_double.pyx: cannot find cimported module 'gmpy2'\n[sagelib-8.2.rc3] sage/rings/real_mpfr.pyx: cannot find cimported module 'gmpy2'\n```\n\nIs it possible to clean this?",
    "created_at": "2018-05-01T09:05:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337327",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:1'></a>A small remark to say that some warnings associated to gmpy2 appear at each run of `sage -b` (without gmpy2):

```
[sagelib-8.2.rc3] sage/rings/complex_double.pyx: cannot find cimported module 'gmpy2'
[sagelib-8.2.rc3] sage/rings/complex_number.pyx: cannot find cimported module 'gmpy2'
[sagelib-8.2.rc3] sage/rings/integer.pyx: cannot find cimported module 'gmpy2'
[sagelib-8.2.rc3] sage/rings/complex_mpc.pyx: cannot find cimported module 'gmpy2'
[sagelib-8.2.rc3] sage/rings/rational.pyx: cannot find cimported module 'gmpy2'
[sagelib-8.2.rc3] sage/rings/real_double.pyx: cannot find cimported module 'gmpy2'
[sagelib-8.2.rc3] sage/rings/real_mpfr.pyx: cannot find cimported module 'gmpy2'
```

Is it possible to clean this?



---

archive/issue_comments_337328.json:
```json
{
    "body": "<a id='comment:2'></a>According to Jeroen it's harmless and will require a cython patch to fix it.",
    "created_at": "2018-05-01T09:25:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337328",
    "user": "https://github.com/vinklein"
}
```

<a id='comment:2'></a>According to Jeroen it's harmless and will require a cython patch to fix it.



---

archive/issue_comments_337329.json:
```json
{
    "body": "<a id='comment:173'></a>Replying to [comment:171 slabbe]:\n> Is it possible to clean this?\n\n\nUnfortunately, it's not easy to properly fix. The basic problem is that the `cimport` is parsed very very early in the Cython build system, at a point where macros like `HAVE_GMPY2` are not considered yet.",
    "created_at": "2018-05-01T09:36:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22928#issuecomment-337329",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:173'></a>Replying to [comment:171 slabbe]:
> Is it possible to clean this?


Unfortunately, it's not easy to properly fix. The basic problem is that the `cimport` is parsed very very early in the Cython build system, at a point where macros like `HAVE_GMPY2` are not considered yet.
