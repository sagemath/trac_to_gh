# Issue 22179: Improve SAGE_FAT_BINARY for openblas

archive/issues_021942.json:
```json
{
    "assignees": [],
    "body": "At the moment it unconditionally passes TARGET=PRESCOTT.\nThis is unfortunate on non x86 CPUs.\n\nWe replace it by `DYNAMIC_ARCH=1`, which will work for non-x86 - and also give better performance for x86_64.\n\n\n\nCC:  @vbraun @jdemeyer @kliem\n\nBranch: **[75c9d68](https://github.com/sagemath/sagetrac-mirror/commit/75c9d68a7599e247c56c80cbe570c95501faca9b)**\n\nReviewer: **Jonathan Kliem**\n\nAuthor: **Matthias Koeppe**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/22179_\n\n",
    "closed_at": "2021-01-17T13:46:11Z",
    "created_at": "2017-01-12T14:10:53Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20packages%3A%20standard",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.3",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Improve SAGE_FAT_BINARY for openblas",
    "type": "issue",
    "updated_at": "2021-03-06T20:41:49Z",
    "url": "https://github.com/sagemath/sage/issues/22179",
    "user": "https://github.com/sagetrac-jpflori"
}
```
At the moment it unconditionally passes TARGET=PRESCOTT.
This is unfortunate on non x86 CPUs.

We replace it by `DYNAMIC_ARCH=1`, which will work for non-x86 - and also give better performance for x86_64.



CC:  @vbraun @jdemeyer @kliem

Branch: **[75c9d68](https://github.com/sagemath/sagetrac-mirror/commit/75c9d68a7599e247c56c80cbe570c95501faca9b)**

Reviewer: **Jonathan Kliem**

Author: **Matthias Koeppe**

_Issue created by migration from https://trac.sagemath.org/ticket/22179_





---

archive/issue_events_292621.json:
```json
{
    "actor": "https://github.com/sagetrac-jpflori",
    "created_at": "2017-01-12T14:10:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/22179",
    "milestone_number": null,
    "milestone_title": "sage-7.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22179#event-292621"
}
```



---

archive/issue_events_292622.json:
```json
{
    "actor": "https://github.com/sagetrac-jpflori",
    "created_at": "2017-01-12T14:10:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22179",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20packages%3A%20standard",
    "label_color": "000080",
    "label_name": "component: packages: standard",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22179#event-292622"
}
```



---

archive/issue_events_292623.json:
```json
{
    "actor": "https://github.com/sagetrac-jpflori",
    "created_at": "2017-01-12T14:10:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22179",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22179#event-292623"
}
```



---

archive/issue_events_292624.json:
```json
{
    "actor": "https://github.com/sagetrac-jpflori",
    "created_at": "2017-01-12T14:10:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22179",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22179#event-292624"
}
```



---

archive/issue_comments_330257.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">Comment 1</div>\n\nI guess it is, but we don't offer binaries for other CPUs at this stage do we?",
    "created_at": "2017-01-14T09:27:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22179#issuecomment-330257",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:1" align="right">Comment 1</div>

I guess it is, but we don't offer binaries for other CPUs at this stage do we?



---

archive/issue_events_292625.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-08-17T03:10:51Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/22179",
    "milestone_number": null,
    "milestone_title": "sage-7.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22179#event-292625"
}
```



---

archive/issue_events_292626.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-08-17T03:10:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/22179",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22179#event-292626"
}
```



---

archive/issue_comments_330258.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">Comment 3</div>\n\nFrom the readme:\n\nSupport for multiple targets in a single library\n\nOpenBLAS can be built for multiple targets with runtime detection of the target cpu by specifiying DYNAMIC_ARCH=1 in Makefile.rule, on the gmake command line or as -DDYNAMIC_ARCH=TRUE in cmake.\n\nFor x86_64, the list of targets this activates contains Prescott, Core2, Nehalem, Barcelona, Sandybridge, Bulldozer, Piledriver, Steamroller, Excavator, Haswell, Zen, SkylakeX. For cpu generations not included in this list, the corresponding older model is used. If you also specify DYNAMIC_OLDER=1, specific support for Penryn, Dunnington, Opteron, Opteron/SSE3, Bobcat, Atom and Nano is added. Finally there is an option DYNAMIC_LIST that allows to specify an individual list of targets to include instead of the default.\n\nDYNAMIC_ARCH is also supported on x86, where it translates to Katmai, Coppermine, Northwood, Prescott, Banias, Core2, Penryn, Dunnington, Nehalem, Athlon, Opteron, Opteron_SSE3, Barcelona, Bobcat, Atom and Nano.\n\nOn ARMV8, it enables support for CortexA53, CortexA57, CortexA72, CortexA73, Falkor, ThunderX, ThunderX2T99, TSV110 as well as generic ARMV8 cpus.\n\nFor POWER, the list encompasses POWER6, POWER8 and POWER9, on ZARCH it comprises Z13 and Z14.\n\nThe TARGET option can be used in conjunction with DYNAMIC_ARCH=1 to specify which cpu model should be assumed for all the common code in the library, usually you will want to set this to the oldest model you expect to encounter. Please note that it is not possible to combine support for different architectures, so no combined 32 and 64 bit or x86_64 and arm64 in the same library.",
    "created_at": "2020-08-21T18:38:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22179#issuecomment-330258",
    "user": "https://github.com/kliem"
}
```

<div id="comment:3" align="right">Comment 3</div>

From the readme:

Support for multiple targets in a single library

OpenBLAS can be built for multiple targets with runtime detection of the target cpu by specifiying DYNAMIC_ARCH=1 in Makefile.rule, on the gmake command line or as -DDYNAMIC_ARCH=TRUE in cmake.

For x86_64, the list of targets this activates contains Prescott, Core2, Nehalem, Barcelona, Sandybridge, Bulldozer, Piledriver, Steamroller, Excavator, Haswell, Zen, SkylakeX. For cpu generations not included in this list, the corresponding older model is used. If you also specify DYNAMIC_OLDER=1, specific support for Penryn, Dunnington, Opteron, Opteron/SSE3, Bobcat, Atom and Nano is added. Finally there is an option DYNAMIC_LIST that allows to specify an individual list of targets to include instead of the default.

DYNAMIC_ARCH is also supported on x86, where it translates to Katmai, Coppermine, Northwood, Prescott, Banias, Core2, Penryn, Dunnington, Nehalem, Athlon, Opteron, Opteron_SSE3, Barcelona, Bobcat, Atom and Nano.

On ARMV8, it enables support for CortexA53, CortexA57, CortexA72, CortexA73, Falkor, ThunderX, ThunderX2T99, TSV110 as well as generic ARMV8 cpus.

For POWER, the list encompasses POWER6, POWER8 and POWER9, on ZARCH it comprises Z13 and Z14.

The TARGET option can be used in conjunction with DYNAMIC_ARCH=1 to specify which cpu model should be assumed for all the common code in the library, usually you will want to set this to the oldest model you expect to encounter. Please note that it is not possible to combine support for different architectures, so no combined 32 and 64 bit or x86_64 and arm64 in the same library.



---

archive/issue_comments_330259.json:
```json
{
    "body": "Branch: **[u/mkoeppe/improve_sage_fat_binary_for_openblas](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/improve_sage_fat_binary_for_openblas)**",
    "created_at": "2021-01-03T00:56:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22179#issuecomment-330259",
    "user": "https://github.com/mkoeppe"
}
```

Branch: **[u/mkoeppe/improve_sage_fat_binary_for_openblas](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/improve_sage_fat_binary_for_openblas)**



---

archive/issue_comments_330260.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">Comment 5</div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/75c9d68a7599e247c56c80cbe570c95501faca9b\">75c9d68</a></td><td><code>build/pkgs/openblas/spkg-install.in: For SAGE_FAT_BINARY=yes, use DYNAMIC_ARCH=1</code></td></tr></table>\n",
    "created_at": "2021-01-03T01:01:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22179#issuecomment-330260",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:5" align="right">Comment 5</div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/75c9d68a7599e247c56c80cbe570c95501faca9b">75c9d68</a></td><td><code>build/pkgs/openblas/spkg-install.in: For SAGE_FAT_BINARY=yes, use DYNAMIC_ARCH=1</code></td></tr></table>




---

archive/issue_events_292627.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-01-03T01:01:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22179",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22179#event-292627"
}
```



---

archive/issue_comments_330261.json:
```json
{
    "body": "Reviewer: **https://github.com/mkoeppe/sage/actions/runs/458445502**",
    "created_at": "2021-01-03T01:01:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22179#issuecomment-330261",
    "user": "https://github.com/mkoeppe"
}
```

Reviewer: **https://github.com/mkoeppe/sage/actions/runs/458445502**



---

archive/issue_comments_330262.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,2 +1,6 @@\n At the moment it unconditionally passes TARGET=PRESCOTT.\n This is unfortunate on non x86 CPUs.\n+\n+We replace it by `DYNAMIC_ARCH=1`, which will work for non-x86 - and also give better performance for x86_64.\n+\n+\n``````\n",
    "created_at": "2021-01-03T01:01:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22179#issuecomment-330262",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,2 +1,6 @@
 At the moment it unconditionally passes TARGET=PRESCOTT.
 This is unfortunate on non x86 CPUs.
+
+We replace it by `DYNAMIC_ARCH=1`, which will work for non-x86 - and also give better performance for x86_64.
+
+
``````




---

archive/issue_comments_330263.json:
```json
{
    "body": "Commit: **[75c9d68](https://github.com/sagemath/sagetrac-mirror/commit/75c9d68a7599e247c56c80cbe570c95501faca9b)**",
    "created_at": "2021-01-03T01:01:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22179#issuecomment-330263",
    "user": "https://github.com/mkoeppe"
}
```

Commit: **[75c9d68](https://github.com/sagemath/sagetrac-mirror/commit/75c9d68a7599e247c56c80cbe570c95501faca9b)**



---

archive/issue_comments_330264.json:
```json
{
    "body": "Author: **Matthias Koeppe**",
    "created_at": "2021-01-03T01:01:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22179#issuecomment-330264",
    "user": "https://github.com/mkoeppe"
}
```

Author: **Matthias Koeppe**



---

archive/issue_comments_330265.json:
```json
{
    "body": "Changed reviewer from **https://github.com/mkoeppe/sage/actions/runs/458445502** to **Jonathan Kliem**",
    "created_at": "2021-01-03T17:57:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22179#issuecomment-330265",
    "user": "https://github.com/kliem"
}
```

Changed reviewer from **https://github.com/mkoeppe/sage/actions/runs/458445502** to **Jonathan Kliem**



---

archive/issue_comments_330266.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">Comment 6</div>\n\nLGTM and this is exactly what the README tells us to do.",
    "created_at": "2021-01-03T17:57:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22179#issuecomment-330266",
    "user": "https://github.com/kliem"
}
```

<div id="comment:6" align="right">Comment 6</div>

LGTM and this is exactly what the README tells us to do.



---

archive/issue_events_292628.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-01-03T17:57:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/22179",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22179#event-292628"
}
```



---

archive/issue_events_292629.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-01-03T17:57:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22179",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22179#event-292629"
}
```



---

archive/issue_comments_330267.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">Comment 7</div>\n\nThanks!",
    "created_at": "2021-01-03T18:44:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22179#issuecomment-330267",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:7" align="right">Comment 7</div>

Thanks!



---

archive/issue_comments_330268.json:
```json
{
    "body": "Changed branch from **[u/mkoeppe/improve_sage_fat_binary_for_openblas](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/improve_sage_fat_binary_for_openblas)** to **[75c9d68](https://github.com/sagemath/sagetrac-mirror/commit/75c9d68a7599e247c56c80cbe570c95501faca9b)**",
    "created_at": "2021-01-17T13:46:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22179#issuecomment-330268",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/mkoeppe/improve_sage_fat_binary_for_openblas](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/improve_sage_fat_binary_for_openblas)** to **[75c9d68](https://github.com/sagemath/sagetrac-mirror/commit/75c9d68a7599e247c56c80cbe570c95501faca9b)**



---

archive/issue_events_292630.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-01-17T13:46:11Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/22179",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22179#event-292630"
}
```



---

archive/issue_events_292631.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "d85f7b7e01d404e882a2a543d2bcd4e2435cafbf",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2021-01-17T13:46:11Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/22179",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22179#event-292631"
}
```



---

archive/issue_comments_330269.json:
```json
{
    "body": "Changed commit from **[75c9d68](https://github.com/sagemath/sagetrac-mirror/commit/75c9d68a7599e247c56c80cbe570c95501faca9b)** to none",
    "created_at": "2021-03-06T20:41:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22179#issuecomment-330269",
    "user": "https://github.com/mkoeppe"
}
```

Changed commit from **[75c9d68](https://github.com/sagemath/sagetrac-mirror/commit/75c9d68a7599e247c56c80cbe570c95501faca9b)** to none



---

archive/issue_comments_330270.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">Comment 9</div>\n\nFollow up in #29537",
    "created_at": "2021-03-06T20:41:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22179#issuecomment-330270",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:9" align="right">Comment 9</div>

Follow up in #29537
