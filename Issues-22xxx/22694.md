# Issue 22694: Cygwin: test failure in sage.manifolds.differentiable.affine_connection

archive/issues_022457.json:
```json
{
    "body": "I'm consistently getting these test failures in this module on my Cygwin branch (just rebased on the latest develop branch, but I've had this for a couple weeks now):\n\n```\nsage -t --long --warn-long 158.6 src/sage/manifolds/differentiable/affine_connection.py\n**********************************************************************\nFile \"src/sage/manifolds/differentiable/affine_connection.py\", line 1749, in sage.manifolds.differentiable.affine_connection.AffineConnection.riemann\nFailed example:\n    for i in M.irange():\n        for j in M.irange():\n            for k in M.irange():\n                nab.add_coef(eV)[i,j,k] = nab.coef(eVW)[i,j,k,c_uvW].expr()\nException raised:\n    Traceback (most recent call last):\n      File \"/home/embray/src/sagemath/sage-cygwin/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 498, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/embray/src/sagemath/sage-cygwin/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 861, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.manifolds.differentiable.affine_connection.AffineConnection.riemann[30]>\", line 4, in <module>\n        nab.add_coef(eV)[i,j,k] = nab.coef(eVW)[i,j,k,c_uvW].expr()\n      File \"/home/embray/src/sagemath/sage-cygwin/local/lib/python2.7/site-packages/sage/manifolds/differentiable/affine_connection.py\", line 628, in coef\n        gam[[k,i,j]] = self(ev[i])(ef[k],ev[j])\n      File \"/home/embray/src/sagemath/sage-cygwin/local/lib/python2.7/site-packages/sage/manifolds/differentiable/affine_connection.py\", line 1348, in __call__\n        return self._derive_paral(tensor_r)\n      File \"/home/embray/src/sagemath/sage-cygwin/local/lib/python2.7/site-packages/sage/manifolds/differentiable/affine_connection.py\", line 1470, in _derive_paral\n        for ii,val in make_CovDerivative(listParalInput):\n      File \"/home/embray/src/sagemath/sage-cygwin/local/lib/python2.7/site-packages/sage/parallel/multiprocessing_sage.py\", line 75, in parallel_iter\n        for res in result:\n      File \"/home/embray/src/sagemath/sage-cygwin/local/lib/python/multiprocessing/pool.py\", line 668, in next\n        raise value\n    RuntimeError: Aborted\n**********************************************************************\nFile \"src/sage/manifolds/differentiable/affine_connection.py\", line 1754, in sage.manifolds.differentiable.affine_connection.AffineConnection.riemann\nFailed example:\n    r = nab.riemann() ; r\nException raised:\n    Traceback (most recent call last):\n      File \"/home/embray/src/sagemath/sage-cygwin/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 498, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/embray/src/sagemath/sage-cygwin/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 861, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.manifolds.differentiable.affine_connection.AffineConnection.riemann[31]>\", line 1, in <module>\n        r = nab.riemann() ; r\n      File \"/home/embray/src/sagemath/sage-cygwin/local/lib/python2.7/site-packages/sage/manifolds/differentiable/affine_connection.py\", line 1776, in riemann\n        gam_gam = gam.contract(1, gam, 0)\n      File \"/home/embray/src/sagemath/sage-cygwin/local/lib/python2.7/site-packages/sage/tensor/modules/comp.py\", line 2316, in contract\n        for ii, val in make_Contraction(listParalInput):\n      File \"/home/embray/src/sagemath/sage-cygwin/local/lib/python2.7/site-packages/sage/parallel/multiprocessing_sage.py\", line 75, in parallel_iter\n        for res in result:\n      File \"/home/embray/src/sagemath/sage-cygwin/local/lib/python/multiprocessing/pool.py\", line 668, in next\n        raise value\n    TypeError: Aborted\n**********************************************************************\n1 item had failures:\n   2 of  36 in sage.manifolds.differentiable.affine_connection.AffineConnection.riemann\n    [418 tests, 2 failures, 229.98 s]\n```\n\nI can reproduce this outside the test suite as well.  The same code works fine without parallel processing, so my guess is a problem in the parallel processing itself (though the tests for `sage.parallel` itself all pass).\n\n**Upstream report:** https://lists.opendylan.org/pipermail/bdwgc/2017-March/006266.html\n\nCC:  @man74cio @egourgoulhon jpflori\n\nKeywords: windows cygwin manifolds parallel\n\nUpstream: Reported upstream. No feedback yet.\n\nReviewer: Eric Gourgoulhon, Jean-Pierre Flori\n\nAuthor: Erik Bray\n\nBranch: 877a3fd8c03101edb4e3e91b091372dfd8eb31b2\n\nCommit: 877a3fd8c03101edb4e3e91b091372dfd8eb31b2\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/22694\n\n",
    "closed_at": "2017-04-03T20:59:34Z",
    "created_at": "2017-03-28T09:13:30Z",
    "labels": [
        "component: porting: cygwin",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "Cygwin: test failure in sage.manifolds.differentiable.affine_connection",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22694",
    "user": "https://github.com/embray"
}
```
I'm consistently getting these test failures in this module on my Cygwin branch (just rebased on the latest develop branch, but I've had this for a couple weeks now):

```
sage -t --long --warn-long 158.6 src/sage/manifolds/differentiable/affine_connection.py
**********************************************************************
File "src/sage/manifolds/differentiable/affine_connection.py", line 1749, in sage.manifolds.differentiable.affine_connection.AffineConnection.riemann
Failed example:
    for i in M.irange():
        for j in M.irange():
            for k in M.irange():
                nab.add_coef(eV)[i,j,k] = nab.coef(eVW)[i,j,k,c_uvW].expr()
Exception raised:
    Traceback (most recent call last):
      File "/home/embray/src/sagemath/sage-cygwin/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 498, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/embray/src/sagemath/sage-cygwin/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 861, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.manifolds.differentiable.affine_connection.AffineConnection.riemann[30]>", line 4, in <module>
        nab.add_coef(eV)[i,j,k] = nab.coef(eVW)[i,j,k,c_uvW].expr()
      File "/home/embray/src/sagemath/sage-cygwin/local/lib/python2.7/site-packages/sage/manifolds/differentiable/affine_connection.py", line 628, in coef
        gam[[k,i,j]] = self(ev[i])(ef[k],ev[j])
      File "/home/embray/src/sagemath/sage-cygwin/local/lib/python2.7/site-packages/sage/manifolds/differentiable/affine_connection.py", line 1348, in __call__
        return self._derive_paral(tensor_r)
      File "/home/embray/src/sagemath/sage-cygwin/local/lib/python2.7/site-packages/sage/manifolds/differentiable/affine_connection.py", line 1470, in _derive_paral
        for ii,val in make_CovDerivative(listParalInput):
      File "/home/embray/src/sagemath/sage-cygwin/local/lib/python2.7/site-packages/sage/parallel/multiprocessing_sage.py", line 75, in parallel_iter
        for res in result:
      File "/home/embray/src/sagemath/sage-cygwin/local/lib/python/multiprocessing/pool.py", line 668, in next
        raise value
    RuntimeError: Aborted
**********************************************************************
File "src/sage/manifolds/differentiable/affine_connection.py", line 1754, in sage.manifolds.differentiable.affine_connection.AffineConnection.riemann
Failed example:
    r = nab.riemann() ; r
Exception raised:
    Traceback (most recent call last):
      File "/home/embray/src/sagemath/sage-cygwin/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 498, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/embray/src/sagemath/sage-cygwin/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 861, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.manifolds.differentiable.affine_connection.AffineConnection.riemann[31]>", line 1, in <module>
        r = nab.riemann() ; r
      File "/home/embray/src/sagemath/sage-cygwin/local/lib/python2.7/site-packages/sage/manifolds/differentiable/affine_connection.py", line 1776, in riemann
        gam_gam = gam.contract(1, gam, 0)
      File "/home/embray/src/sagemath/sage-cygwin/local/lib/python2.7/site-packages/sage/tensor/modules/comp.py", line 2316, in contract
        for ii, val in make_Contraction(listParalInput):
      File "/home/embray/src/sagemath/sage-cygwin/local/lib/python2.7/site-packages/sage/parallel/multiprocessing_sage.py", line 75, in parallel_iter
        for res in result:
      File "/home/embray/src/sagemath/sage-cygwin/local/lib/python/multiprocessing/pool.py", line 668, in next
        raise value
    TypeError: Aborted
**********************************************************************
1 item had failures:
   2 of  36 in sage.manifolds.differentiable.affine_connection.AffineConnection.riemann
    [418 tests, 2 failures, 229.98 s]
```

I can reproduce this outside the test suite as well.  The same code works fine without parallel processing, so my guess is a problem in the parallel processing itself (though the tests for `sage.parallel` itself all pass).

**Upstream report:** https://lists.opendylan.org/pipermail/bdwgc/2017-March/006266.html

CC:  @man74cio @egourgoulhon jpflori

Keywords: windows cygwin manifolds parallel

Upstream: Reported upstream. No feedback yet.

Reviewer: Eric Gourgoulhon, Jean-Pierre Flori

Author: Erik Bray

Branch: 877a3fd8c03101edb4e3e91b091372dfd8eb31b2

Commit: 877a3fd8c03101edb4e3e91b091372dfd8eb31b2

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/22694





---

archive/issue_comments_312574.json:
```json
{
    "body": "<a id='comment:1'></a>The `RuntimeError: Aborted` is from Cysignals.  Something is causing a `SIGABRT` somewhere, though I'm not sure why.",
    "created_at": "2017-03-28T09:21:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22694#issuecomment-312574",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>The `RuntimeError: Aborted` is from Cysignals.  Something is causing a `SIGABRT` somewhere, though I'm not sure why.



---

archive/issue_comments_312575.json:
```json
{
    "body": "<a id='comment:3'></a>Attachment [stacktrace.log](tarball://root/attachments/some-uuid/ticket22694/stacktrace.log) by @embray created at 2017-03-29 08:49:44\n\nBy the way, I've made significant progress in getting to the bottom of this.  The full traceback leading up to the SIGABRT is attached.\n\nBut the main issue here seems to have to do with libgc's handling of threads in the child process after a fork, on Cygwin.  In principle libgc explicitly supports Cygwin, but there still seems to be a bug somewhere related to this (or possibly just a build issue though I haven't found that to be the case yet...).  I'm trying to boil it down to a simpler test case, but the issue seems to be that for one reason or another the post-fork handler is either not running at all, or not working properly, because in the forked process it's leaving behind a reference to a thread from the parent process, which has a handle to a native (Windows) thread that is no longer valid in the child process.  The `pthread_atfork` handler for the child process should have removed that thread but it doesn't.\n\nA possible short-term workaround might be to compile libgc with threads disabled on Cygwin, but I don't know what other impacts that would have.",
    "created_at": "2017-03-29T08:49:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22694#issuecomment-312575",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>Attachment [stacktrace.log](tarball://root/attachments/some-uuid/ticket22694/stacktrace.log) by @embray created at 2017-03-29 08:49:44

By the way, I've made significant progress in getting to the bottom of this.  The full traceback leading up to the SIGABRT is attached.

But the main issue here seems to have to do with libgc's handling of threads in the child process after a fork, on Cygwin.  In principle libgc explicitly supports Cygwin, but there still seems to be a bug somewhere related to this (or possibly just a build issue though I haven't found that to be the case yet...).  I'm trying to boil it down to a simpler test case, but the issue seems to be that for one reason or another the post-fork handler is either not running at all, or not working properly, because in the forked process it's leaving behind a reference to a thread from the parent process, which has a handle to a native (Windows) thread that is no longer valid in the child process.  The `pthread_atfork` handler for the child process should have removed that thread but it doesn't.

A possible short-term workaround might be to compile libgc with threads disabled on Cygwin, but I don't know what other impacts that would have.



---

archive/issue_comments_312576.json:
```json
{
    "body": "<a id='comment:4'></a>Confirmed that building libgc with `./configure --enable-threads=none` works around this particular issue.\n\nBut I'd still like to get to the bottom of this; ISTM like it might be a simple bug at the end of the day.",
    "created_at": "2017-03-29T09:06:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22694#issuecomment-312576",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>Confirmed that building libgc with `./configure --enable-threads=none` works around this particular issue.

But I'd still like to get to the bottom of this; ISTM like it might be a simple bug at the end of the day.



---

archive/issue_comments_312577.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:3 embray]:\n> By the way, I've made significant progress in getting to the bottom of this.  The full traceback leading up to the SIGABRT is attached.\n\n\nThanks for this update. \nAnother place where doctests involve parallel processing is `src/sage/tensor/modules/comp.py`. Do you also experience any trouble with this file?",
    "created_at": "2017-03-29T09:09:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22694#issuecomment-312577",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:5'></a>Replying to [comment:3 embray]:
> By the way, I've made significant progress in getting to the bottom of this.  The full traceback leading up to the SIGABRT is attached.


Thanks for this update. 
Another place where doctests involve parallel processing is `src/sage/tensor/modules/comp.py`. Do you also experience any trouble with this file?



---

archive/issue_comments_312578.json:
```json
{
    "body": "<a id='comment:6'></a>Okay, it turns out the `pthread_atexit` handler doesn't actually get installed unless I explicitly build with `./configure --enable-handle-fork` (it can also be enabled at runtime, incidentally).\n\nThat said, the fact that it outright crashes on Windows *without* this option is also a bug, IMO, albeit fixable I think.  But for Sage's purposes it will be easy enough to add the appropriate flags when building on Cygwin \\o/",
    "created_at": "2017-03-29T12:24:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22694#issuecomment-312578",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>Okay, it turns out the `pthread_atexit` handler doesn't actually get installed unless I explicitly build with `./configure --enable-handle-fork` (it can also be enabled at runtime, incidentally).

That said, the fact that it outright crashes on Windows *without* this option is also a bug, IMO, albeit fixable I think.  But for Sage's purposes it will be easy enough to add the appropriate flags when building on Cygwin \o/



---

archive/issue_comments_312579.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:5 egourgoulhon]:\n> Another place where doctests involve parallel processing is `src/sage/tensor/modules/comp.py`. Do you also experience any trouble with this file? \n\n\nActually this doctest passes fine as is.  This issue only arises in certain cases if ECL is allocating a lot of small objects, and gc needs to suspend all the threads whose stacks it's monitoring so that it can make more room in its heap for more small objects (at least, that's how I understand the issue).",
    "created_at": "2017-03-29T12:26:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22694#issuecomment-312579",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>Replying to [comment:5 egourgoulhon]:
> Another place where doctests involve parallel processing is `src/sage/tensor/modules/comp.py`. Do you also experience any trouble with this file? 


Actually this doctest passes fine as is.  This issue only arises in certain cases if ECL is allocating a lot of small objects, and gc needs to suspend all the threads whose stacks it's monitoring so that it can make more room in its heap for more small objects (at least, that's how I understand the issue).



---

archive/issue_comments_312580.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:6 embray]:\n>But for Sage's purposes it will be easy enough to add the appropriate flags when building on Cygwin \\o/\n\n\nVery good!",
    "created_at": "2017-03-29T12:28:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22694#issuecomment-312580",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:8'></a>Replying to [comment:6 embray]:
>But for Sage's purposes it will be easy enough to add the appropriate flags when building on Cygwin \o/


Very good!



---

archive/issue_comments_312581.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:7 embray]:\n> Replying to [comment:5 egourgoulhon]:\n> \n> Actually this doctest passes fine as is.  This issue only arises in certain cases if ECL is allocating a lot of small objects, and gc needs to suspend all the threads whose stacks it's monitoring so that it can make more room in its heap for more small objects (at least, that's how I understand the issue).\n\n\nOK I see. Indeed the doctests in `src/sage/tensor/modules/comp.py` do not involve ECL (no symbolic calculus, hence no Maxima simplifications).",
    "created_at": "2017-03-29T12:36:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22694#issuecomment-312581",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:9'></a>Replying to [comment:7 embray]:
> Replying to [comment:5 egourgoulhon]:
> 
> Actually this doctest passes fine as is.  This issue only arises in certain cases if ECL is allocating a lot of small objects, and gc needs to suspend all the threads whose stacks it's monitoring so that it can make more room in its heap for more small objects (at least, that's how I understand the issue).


OK I see. Indeed the doctests in `src/sage/tensor/modules/comp.py` do not involve ECL (no symbolic calculus, hence no Maxima simplifications).



---

archive/issue_comments_312582.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-03-29T15:31:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22694#issuecomment-312582",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_312583.json:
```json
{
    "body": "<a id='comment:10'></a>I've attached a patch to Sage to configure GC to work properly on Cygwin.  I've also made an upstream report, but only to suggest that the default configuration for Cygwin should incorporate this (since it's broken otherwise).  I don't think there's a great way to work around the issue in the code *without* using `pthread_atfork` that doesn't incur too much overhead.\n\n---\nNew commits:",
    "created_at": "2017-03-29T15:31:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22694#issuecomment-312583",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'></a>I've attached a patch to Sage to configure GC to work properly on Cygwin.  I've also made an upstream report, but only to suggest that the default configuration for Cygwin should incorporate this (since it's broken otherwise).  I don't think there's a great way to work around the issue in the code *without* using `pthread_atfork` that doesn't incur too much overhead.

---
New commits:



---

archive/issue_comments_312584.json:
```json
{
    "body": "<a id='comment:11'></a>LGTM.\nJust putting Jean-Pierre in Cc for a cross-check, since he knows far better than me Sage build process and Cygwin.",
    "created_at": "2017-03-29T22:56:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22694#issuecomment-312584",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:11'></a>LGTM.
Just putting Jean-Pierre in Cc for a cross-check, since he knows far better than me Sage build process and Cygwin.



---

archive/issue_comments_312585.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-03-29T22:56:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22694#issuecomment-312585",
    "user": "https://github.com/egourgoulhon"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_312586.json:
```json
{
    "body": "<a id='comment:12'></a>Looks good to me.",
    "created_at": "2017-03-30T09:42:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22694#issuecomment-312586",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:12'></a>Looks good to me.



---

archive/issue_comments_312587.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [comment:12 jpflori]:\n> Looks good to me.\n\nThanks!",
    "created_at": "2017-03-30T12:38:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22694#issuecomment-312587",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:14'></a>Replying to [comment:12 jpflori]:
> Looks good to me.

Thanks!



---

archive/issue_comments_312588.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-04-03T20:59:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22694#issuecomment-312588",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_059139.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-04-03T20:59:34Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/22694",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22694#event-59139"
}
```
