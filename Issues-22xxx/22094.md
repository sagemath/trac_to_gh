# Issue 22094: setup.py: run_autogen is ran too late

archive/issues_021857.json:
```json
{
    "body": "When building Sage from scratch, the following happens:\n\n```\nImportError: No module named interpreters.wrapper_rdf\n```\n\nIn `src/setup.py`, the method `run_autogen` is ran *after* discovering and building the Python modules. So, the Python module `sage/ext/interpreters/__init__.py` is not installed.\n\nThis problem was introduced in #21613.\n\nCC:  @egourgoulhon @embray @kiwifb\n\nReviewer: Jeroen Demeyer\n\nAuthor: Fran\u00e7ois Bissey\n\nBranch: 8e172f646e284ed98b3c0d57dd0a43792084efcc\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/22094\n\n",
    "closed_at": "2016-12-28T10:40:46Z",
    "created_at": "2016-12-23T20:25:41Z",
    "labels": [
        "component: build",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.5",
    "title": "setup.py: run_autogen is ran too late",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22094",
    "user": "https://github.com/jdemeyer"
}
```
When building Sage from scratch, the following happens:

```
ImportError: No module named interpreters.wrapper_rdf
```

In `src/setup.py`, the method `run_autogen` is ran *after* discovering and building the Python modules. So, the Python module `sage/ext/interpreters/__init__.py` is not installed.

This problem was introduced in #21613.

CC:  @egourgoulhon @embray @kiwifb

Reviewer: Jeroen Demeyer

Author: François Bissey

Branch: 8e172f646e284ed98b3c0d57dd0a43792084efcc

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/22094





---

archive/issue_comments_323036.json:
```json
{
    "body": "<a id='comment:2'></a>Untested hypothesis: the \"Discovering !Python/Cython source code\" part below is run **before** auto-generating the sources, which is the wrong order:\n\n```\nprint(\"Discovering Python/Cython source code....\")\nt = time.time()\nfrom sage_setup.find import find_python_sources\npython_packages, python_modules = find_python_sources(\n    SAGE_SRC, ['sage', 'sage_setup'])\n```\n\nThe auto-generated files might not be discovered this way, leading to those files being considered for cleaning.",
    "created_at": "2016-12-23T20:42:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22094#issuecomment-323036",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>Untested hypothesis: the "Discovering !Python/Cython source code" part below is run **before** auto-generating the sources, which is the wrong order:

```
print("Discovering Python/Cython source code....")
t = time.time()
from sage_setup.find import find_python_sources
python_packages, python_modules = find_python_sources(
    SAGE_SRC, ['sage', 'sage_setup'])
```

The auto-generated files might not be discovered this way, leading to those files being considered for cleaning.



---

archive/issue_comments_323037.json:
```json
{
    "body": "<a id='comment:3'></a>OK I can reproduce it at will here by taking a full build and then doing `MAKE=\"make -j8\" ./sage -ba` (not sure if it fails with a single threaded build). `./sage` will crash and complain about `interpreters.wrapper_rdf` in the crash report.",
    "created_at": "2016-12-24T10:22:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22094#issuecomment-323037",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:3'></a>OK I can reproduce it at will here by taking a full build and then doing `MAKE="make -j8" ./sage -ba` (not sure if it fails with a single threaded build). `./sage` will crash and complain about `interpreters.wrapper_rdf` in the crash report.



---

archive/issue_comments_323038.json:
```json
{
    "body": "<a id='comment:4'></a>I just reproduced the problem by building Sage from scratch (`make distclean; make`). I thought the buildbots would test that? In the process, I found another problem: #22098.",
    "created_at": "2016-12-24T12:11:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22094#issuecomment-323038",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>I just reproduced the problem by building Sage from scratch (`make distclean; make`). I thought the buildbots would test that? In the process, I found another problem: #22098.



---

archive/issue_comments_323039.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,10 +1,10 @@\n-Several people reported seeing this error while building Sage:\n+When building Sage from scratch, the following happens:\n \n ```\n ImportError: No module named interpreters.wrapper_rdf\n ```\n \n-No idea how to reproduce it...\n+In `src/setup.py`, the method `run_autogen` is ran *after* discovering and building the Python modules. So, the Python module `sage/ext/interpreters/__init__.py` is not installed.\n \n Comment: 1\n \n``````\n",
    "created_at": "2016-12-24T12:45:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22094#issuecomment-323039",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,10 +1,10 @@
-Several people reported seeing this error while building Sage:
+When building Sage from scratch, the following happens:
 
 ```
 ImportError: No module named interpreters.wrapper_rdf
 ```
 
-No idea how to reproduce it...
+In `src/setup.py`, the method `run_autogen` is ran *after* discovering and building the Python modules. So, the Python module `sage/ext/interpreters/__init__.py` is not installed.
 
 Comment: 1
 
``````




---

archive/issue_comments_323040.json:
```json
{
    "body": "<a id='comment:6'></a>Here are some experiments regarding the reproductibility on my system (Ubuntu 16.04):\n- the error seems systematic: i.e. running `MAKE=\"make -j8\" make` in a new fresh git clone yields the same error; then running `make` finishes the build without any error\n- to determine whether this due to the parallel build, I ran simply `make` in another fresh git clone: then the build crashes due to another error: the `psutil` one  reported in #22098",
    "created_at": "2016-12-24T15:19:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22094#issuecomment-323040",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:6'></a>Here are some experiments regarding the reproductibility on my system (Ubuntu 16.04):
- the error seems systematic: i.e. running `MAKE="make -j8" make` in a new fresh git clone yields the same error; then running `make` finishes the build without any error
- to determine whether this due to the parallel build, I ran simply `make` in another fresh git clone: then the build crashes due to another error: the `psutil` one  reported in #22098



---

archive/issue_comments_323041.json:
```json
{
    "body": "<a id='comment:7'></a>With the correction proposed in #22098, the non-parallelized build with `make` goes further but\nhalts at the same error as reported in the current ticket, i.e. \n\n```\n[dochtml]   File \"sage/ext/interpreters/wrapper_rdf.pxd\", line 7, in init sage.plot.plot3d.parametric_surface (/home/eric/sage/7.5.rc0-22098/src/build/cythonized/sage/plot/plot3d/parametric_surface.c:12253)\n[dochtml] ImportError: No module named interpreters.wrapper_rdf\n```\nSo clearly the issue is not due to the parallel build.",
    "created_at": "2016-12-24T17:32:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22094#issuecomment-323041",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:7'></a>With the correction proposed in #22098, the non-parallelized build with `make` goes further but
halts at the same error as reported in the current ticket, i.e. 

```
[dochtml]   File "sage/ext/interpreters/wrapper_rdf.pxd", line 7, in init sage.plot.plot3d.parametric_surface (/home/eric/sage/7.5.rc0-22098/src/build/cythonized/sage/plot/plot3d/parametric_surface.c:12253)
[dochtml] ImportError: No module named interpreters.wrapper_rdf
```
So clearly the issue is not due to the parallel build.



---

archive/issue_comments_323042.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:7 egourgoulhon]:\n> So clearly the issue is not due to the parallel build.\n\nAs for the parallel build, running `make` a second time leads to a successful build.\nIn other words, `make && make` works, while a single `make` fails...",
    "created_at": "2016-12-24T18:29:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22094#issuecomment-323042",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:8'></a>Replying to [comment:7 egourgoulhon]:
> So clearly the issue is not due to the parallel build.

As for the parallel build, running `make` a second time leads to a successful build.
In other words, `make && make` works, while a single `make` fails...



---

archive/issue_comments_323043.json:
```json
{
    "body": "<a id='comment:9'></a>The buildbot tests building from scratch but for some reasons succeeds... there is most likely a random component to it.",
    "created_at": "2016-12-25T20:13:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22094#issuecomment-323043",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:9'></a>The buildbot tests building from scratch but for some reasons succeeds... there is most likely a random component to it.



---

archive/issue_comments_323044.json:
```json
{
    "body": "<a id='comment:10'></a>On the machine it fails, it looks quite systematic. Something in the environment?",
    "created_at": "2016-12-25T20:27:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22094#issuecomment-323044",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:10'></a>On the machine it fails, it looks quite systematic. Something in the environment?



---

archive/issue_comments_323045.json:
```json
{
    "body": "<a id='comment:11'></a>I think it's pointless to figure out the exact circumstances when the problem occurs. I analysed it well enough (see ticket description) that somebody could fix it.",
    "created_at": "2016-12-26T09:25:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22094#issuecomment-323045",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>I think it's pointless to figure out the exact circumstances when the problem occurs. I analysed it well enough (see ticket description) that somebody could fix it.



---

archive/issue_comments_323046.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,12 @@\n+When building Sage from scratch, the following happens:\n \n+```\n+ImportError: No module named interpreters.wrapper_rdf\n+```\n+\n+In `src/setup.py`, the method `run_autogen` is ran *after* discovering and building the Python modules. So, the Python module `sage/ext/interpreters/__init__.py` is not installed.\n+\n+This problem was introduced in #21613.\n \n Comment: 1\n \n``````\n",
    "created_at": "2016-12-26T09:27:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22094#issuecomment-323046",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,12 @@
+When building Sage from scratch, the following happens:
 
+```
+ImportError: No module named interpreters.wrapper_rdf
+```
+
+In `src/setup.py`, the method `run_autogen` is ran *after* discovering and building the Python modules. So, the Python module `sage/ext/interpreters/__init__.py` is not installed.
+
+This problem was introduced in #21613.
 
 Comment: 1
 
``````




---

archive/issue_comments_323047.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-12-27T04:16:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22094#issuecomment-323047",
    "user": "https://github.com/kiwifb"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_323048.json:
```json
{
    "body": "<a id='comment:13'></a>OK, this branch works for me but I don't know if it is the most appropriate way to do it. Needs review.\n\n---\nNew commits:",
    "created_at": "2016-12-27T04:16:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22094#issuecomment-323048",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:13'></a>OK, this branch works for me but I don't know if it is the most appropriate way to do it. Needs review.

---
New commits:



---

archive/issue_comments_323049.json:
```json
{
    "body": "<a id='comment:14'></a>It's not \"Generating Interpreter Sources\", it's \"Generating auto-generated sources\". So both the comment and the `print` statement are wrong in this regard.\n\nAbout the actual solution: I'm pretty sure that Erik won't like it (in `setup.py`, you are supposed to only do stuff within the `setup()` call). However, this fixes a blocker issue, so I am OK with this branch being a stopgap.",
    "created_at": "2016-12-27T09:08:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22094#issuecomment-323049",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>It's not "Generating Interpreter Sources", it's "Generating auto-generated sources". So both the comment and the `print` statement are wrong in this regard.

About the actual solution: I'm pretty sure that Erik won't like it (in `setup.py`, you are supposed to only do stuff within the `setup()` call). However, this fixes a blocker issue, so I am OK with this branch being a stopgap.



---

archive/issue_comments_323050.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-12-27T09:08:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22094#issuecomment-323050",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_323051.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:14 jdemeyer]:\n> It's not \"Generating Interpreter Sources\", it's \"Generating auto-generated sources\". So both the comment and the `print` statement are wrong in this regard.\n> \n\n\nAmusing considering I copied pasted the original `print` statement from Erik. I can see it was more general before #21613.\n\n> About the actual solution: I'm pretty sure that Erik won't like it (in `setup.py`, you are supposed to only do stuff within the `setup()` call). However, this fixes a blocker issue, so I am OK with this branch being a stopgap.\n\n\nOK for the stopgap status. If Erik, think it can be done better he is welcome to do it, but it is the last blocker for 7.5 so getting things out is important. New commit coming soon.",
    "created_at": "2016-12-27T09:17:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22094#issuecomment-323051",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:15'></a>Replying to [comment:14 jdemeyer]:
> It's not "Generating Interpreter Sources", it's "Generating auto-generated sources". So both the comment and the `print` statement are wrong in this regard.
> 


Amusing considering I copied pasted the original `print` statement from Erik. I can see it was more general before #21613.

> About the actual solution: I'm pretty sure that Erik won't like it (in `setup.py`, you are supposed to only do stuff within the `setup()` call). However, this fixes a blocker issue, so I am OK with this branch being a stopgap.


OK for the stopgap status. If Erik, think it can be done better he is welcome to do it, but it is the last blocker for 7.5 so getting things out is important. New commit coming soon.



---

archive/issue_comments_323052.json:
```json
{
    "body": "<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-12-27T09:22:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22094#issuecomment-323052",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_323053.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-12-27T09:23:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22094#issuecomment-323053",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_323054.json:
```json
{
    "body": "<a id='comment:17'></a>I also forgotten, I wanted to include the ticket number in the comment, so that was a good opportunity.",
    "created_at": "2016-12-27T09:23:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22094#issuecomment-323054",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:17'></a>I also forgotten, I wanted to include the ticket number in the comment, so that was a good opportunity.



---

archive/issue_comments_323055.json:
```json
{
    "body": "<a id='comment:19'></a>Just to tell that Fran\u00e7ois' commit fixes the build from scratch for me too.",
    "created_at": "2016-12-27T12:45:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22094#issuecomment-323055",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:19'></a>Just to tell that François' commit fixes the build from scratch for me too.



---

archive/issue_comments_323056.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-12-27T13:48:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22094#issuecomment-323056",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_058119.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-12-28T10:40:46Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/22094",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22094#event-58119"
}
```



---

archive/issue_comments_323057.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-12-28T10:40:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22094#issuecomment-323057",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_323058.json:
```json
{
    "body": "<a id='comment:22'></a>Follow-up: #22106",
    "created_at": "2016-12-29T05:06:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22094#issuecomment-323058",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:22'></a>Follow-up: #22106
