# Issue 22766: Trying completion list of maxima_lib crashes Sage

archive/issues_022529.json:
```json
{
    "assignees": [],
    "body": "If Maxima's commands list is not stored, then initialising Maxima/ECL and then hitting TAB after `maxima_lib` crashes Sage, as shown below. Other similar crashes may be triggered, see e.g. #23956. \n\nThe reason for these crashes is the design of tab completion in `IPython` 5+ using \n[prompt_toolkit](http://python-prompt-toolkit.readthedocs.io/en/stable/), which uses Python threading, and does tab completion in a separate thread. \n\n```\n$ rm -f ~/.sage/maxima_commandlist_cache.sobj\n$ sage\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 8.0.beta0, Release Date: 2017-03-30               \u2502\n\u2502 Type \"notebook()\" for the browser-based notebook interface.        \u2502\n\u2502 Type \"help()\" for help.                                            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\nsage: from sage.interfaces.maxima_lib import maxima_lib\nsage: maxima_lib.\nBuilding Maxima command completion list (this takes\na few seconds only the first time you do it).\nTo force rebuild later, delete /home/ralf/.sage//maxima_commandlist_cache.sobj.\nA\n;;;\n;;; Stack overflow.\n;;; Jumping to the outermost toplevel prompt\n;;;\n\n\nInternal or unrecoverable error in:\n\n;;;\n;;; No frame to jump to\n;;; Aborting ECL\n;;;\n\n;;; ECL C Backtrace\n;;; /home/ralf/sage/local/lib/libecl.so.16.1(si_dump_c_backtrace+0x26) [0x7f012]\n;;; /home/ralf/sage/local/lib/libecl.so.16.1(ecl_internal_error+0x3f) [0x7f0127]\n;;; /home/ralf/sage/local/lib/libecl.so.16.1(FEerror+0) [0x7f0127706f20]\n;;; /home/ralf/sage/local/lib/libecl.so.16.1(+0x1adb1a) [0x7f012772eb1a]\n;;; /home/ralf/sage/local/lib/libecl.so.16.1(+0x12b3c5) [0x7f01276ac3c5]\n;;; /home/ralf/sage/local/lib/libecl.so.16.1(cl_funcall+0x70) [0x7f01276e7c90]\n;;; /home/ralf/sage/local/lib/libecl.so.16.1(si_serror+0xd9) [0x7f0127708299]\n;;; /home/ralf/sage/local/lib/libecl.so.16.1(ecl_cs_overflow+0xac) [0x7f012772e]\n;;; /home/ralf/sage/local/lib/libecl.so.16.1(+0x12b3c5) [0x7f01276ac3c5]\n;;; /home/ralf/sage/local/lib/libecl.so.16.1(cl_funcall+0x70) [0x7f01276e7c90]\n;;; /home/ralf/sage/local/lib/libecl.so.16.1(si_serror+0xd9) [0x7f0127708299]\n;;; /home/ralf/sage/local/lib/libecl.so.16.1(ecl_cs_overflow+0xac) [0x7f012772e]\n;;; /home/ralf/sage/local/lib/libecl.so.16.1(ecl_interpret+0x1d67) [0x7f01276ea]\n;;; /home/ralf/sage/local/lib/libecl.so.16.1(cl_apply+0x145) [0x7f01276e7e95]\n;;; /home/ralf/sage/local/lib/python2.7/site-packages/sage/libs/ecl.so(+0xcf1d)]\n;;; /home/ralf/sage/local/lib/python2.7/site-packages/sage/libs/ecl.so(+0x15511]\n;;; /home/ralf/sage/local/lib/python2.7/site-packages/sage/libs/ecl.so(+0x15d6b]\n;;; /home/ralf/sage/local/lib/python2.7/site-packages/sage/libs/ecl.so(+0x16d47]\n;;; /home/ralf/sage/local/lib/libpython2.7.so.1.0(+0xc0c7f) [0x7f038ea92c7f]\n;;; /home/ralf/sage/local/lib/python2.7/site-packages/sage/libs/ecl.so(+0xcad8)]\n;;; /home/ralf/sage/local/lib/libpython2.7.so.1.0(PyObject_Call+0x43) [0x7f038e]\n;;; /home/ralf/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x56da) [0]\n;;; /home/ralf/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x81c) [0x7]\n;;; /home/ralf/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x8020) [0]\n;;; /home/ralf/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x81c) [0x7]\n;;; /home/ralf/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x8020) [0]\n;;; /home/ralf/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x81c) [0x7]\n;;; /home/ralf/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x8020) [0]\n;;; /home/ralf/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x81c) [0x7]\n;;; /home/ralf/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x8020) [0]\n;;; /home/ralf/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x81c) [0x7]\n;;; /home/ralf/sage/local/lib/libpython2.7.so.1.0(+0x87ecc) [0x7f038ea59ecc]\nAborted (core dumped)\n```\n\nDepends on #23956\n\nCC:  @jdemeyer\n\nReviewer: **Dima Pasechnik**\n\nComponent: **interfaces**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/22766_\n\n",
    "closed_at": "2021-06-24T20:15:37Z",
    "created_at": "2017-04-06T06:22:35Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/bug",
        "https://github.com/sagemath/sage/labels/c%3A%20interfaces",
        "https://github.com/sagemath/sage/labels/invalid"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Trying completion list of maxima_lib crashes Sage",
    "type": "issue",
    "updated_at": "2021-06-24T20:15:37Z",
    "url": "https://github.com/sagemath/sage/issues/22766",
    "user": "https://github.com/rwst"
}
```
If Maxima's commands list is not stored, then initialising Maxima/ECL and then hitting TAB after `maxima_lib` crashes Sage, as shown below. Other similar crashes may be triggered, see e.g. #23956. 

The reason for these crashes is the design of tab completion in `IPython` 5+ using 
[prompt_toolkit](http://python-prompt-toolkit.readthedocs.io/en/stable/), which uses Python threading, and does tab completion in a separate thread. 

```
$ rm -f ~/.sage/maxima_commandlist_cache.sobj
$ sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 8.0.beta0, Release Date: 2017-03-30               │
│ Type "notebook()" for the browser-based notebook interface.        │
│ Type "help()" for help.                                            │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: from sage.interfaces.maxima_lib import maxima_lib
sage: maxima_lib.
Building Maxima command completion list (this takes
a few seconds only the first time you do it).
To force rebuild later, delete /home/ralf/.sage//maxima_commandlist_cache.sobj.
A
;;;
;;; Stack overflow.
;;; Jumping to the outermost toplevel prompt
;;;


Internal or unrecoverable error in:

;;;
;;; No frame to jump to
;;; Aborting ECL
;;;

;;; ECL C Backtrace
;;; /home/ralf/sage/local/lib/libecl.so.16.1(si_dump_c_backtrace+0x26) [0x7f012]
;;; /home/ralf/sage/local/lib/libecl.so.16.1(ecl_internal_error+0x3f) [0x7f0127]
;;; /home/ralf/sage/local/lib/libecl.so.16.1(FEerror+0) [0x7f0127706f20]
;;; /home/ralf/sage/local/lib/libecl.so.16.1(+0x1adb1a) [0x7f012772eb1a]
;;; /home/ralf/sage/local/lib/libecl.so.16.1(+0x12b3c5) [0x7f01276ac3c5]
;;; /home/ralf/sage/local/lib/libecl.so.16.1(cl_funcall+0x70) [0x7f01276e7c90]
;;; /home/ralf/sage/local/lib/libecl.so.16.1(si_serror+0xd9) [0x7f0127708299]
;;; /home/ralf/sage/local/lib/libecl.so.16.1(ecl_cs_overflow+0xac) [0x7f012772e]
;;; /home/ralf/sage/local/lib/libecl.so.16.1(+0x12b3c5) [0x7f01276ac3c5]
;;; /home/ralf/sage/local/lib/libecl.so.16.1(cl_funcall+0x70) [0x7f01276e7c90]
;;; /home/ralf/sage/local/lib/libecl.so.16.1(si_serror+0xd9) [0x7f0127708299]
;;; /home/ralf/sage/local/lib/libecl.so.16.1(ecl_cs_overflow+0xac) [0x7f012772e]
;;; /home/ralf/sage/local/lib/libecl.so.16.1(ecl_interpret+0x1d67) [0x7f01276ea]
;;; /home/ralf/sage/local/lib/libecl.so.16.1(cl_apply+0x145) [0x7f01276e7e95]
;;; /home/ralf/sage/local/lib/python2.7/site-packages/sage/libs/ecl.so(+0xcf1d)]
;;; /home/ralf/sage/local/lib/python2.7/site-packages/sage/libs/ecl.so(+0x15511]
;;; /home/ralf/sage/local/lib/python2.7/site-packages/sage/libs/ecl.so(+0x15d6b]
;;; /home/ralf/sage/local/lib/python2.7/site-packages/sage/libs/ecl.so(+0x16d47]
;;; /home/ralf/sage/local/lib/libpython2.7.so.1.0(+0xc0c7f) [0x7f038ea92c7f]
;;; /home/ralf/sage/local/lib/python2.7/site-packages/sage/libs/ecl.so(+0xcad8)]
;;; /home/ralf/sage/local/lib/libpython2.7.so.1.0(PyObject_Call+0x43) [0x7f038e]
;;; /home/ralf/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x56da) [0]
;;; /home/ralf/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x81c) [0x7]
;;; /home/ralf/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x8020) [0]
;;; /home/ralf/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x81c) [0x7]
;;; /home/ralf/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x8020) [0]
;;; /home/ralf/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x81c) [0x7]
;;; /home/ralf/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x8020) [0]
;;; /home/ralf/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x81c) [0x7]
;;; /home/ralf/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x8020) [0]
;;; /home/ralf/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x81c) [0x7]
;;; /home/ralf/sage/local/lib/libpython2.7.so.1.0(+0x87ecc) [0x7f038ea59ecc]
Aborted (core dumped)
```

Depends on #23956

CC:  @jdemeyer

Reviewer: **Dima Pasechnik**

Component: **interfaces**

_Issue created by migration from https://trac.sagemath.org/ticket/22766_





---

archive/issue_events_317788.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2017-04-06T06:22:35Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "milestone_number": null,
    "milestone_title": "sage-8.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22766#event-317788"
}
```



---

archive/issue_events_317789.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2017-04-06T06:22:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20interfaces",
    "label_color": "0000ff",
    "label_name": "c: interfaces",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22766#event-317789"
}
```



---

archive/issue_events_317790.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2017-04-06T06:22:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "label": "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p: 2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22766#event-317790"
}
```



---

archive/issue_events_317791.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2017-04-06T06:22:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22766#event-317791"
}
```



---

archive/issue_comments_339010.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nI think the crash happens in line `281\tin /home/ralf/sage/local/var/tmp/sage/build/ecl-16.1.2.p2/src/src/c/interpreter.d`.",
    "created_at": "2017-04-06T06:29:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339010",
    "user": "https://github.com/rwst"
}
```

<div id="comment:1" align="right">comment:1</div>

I think the crash happens in line `281	in /home/ralf/sage/local/var/tmp/sage/build/ecl-16.1.2.p2/src/src/c/interpreter.d`.



---

archive/issue_comments_339011.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nIt is because since IPython 5.*, tab completion happens in a different thread.\nAnd here you initialise Maxima in the main thread, but run Maxima (via triggering tab completion) in a separate thread.\n\nSee also #23700 and #23956 for a different way to trigger the same bug.",
    "created_at": "2017-10-02T16:38:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339011",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:2" align="right">comment:2</div>

It is because since IPython 5.*, tab completion happens in a different thread.
And here you initialise Maxima in the main thread, but run Maxima (via triggering tab completion) in a separate thread.

See also #23700 and #23956 for a different way to trigger the same bug.



---

archive/issue_comments_339012.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nOn OS X (10.12.6, Xcode 8.3.3, Sage 8.1.beta6), I don't get this crash, and I also don't see the message \"Building Maxima command completion list ...\": I just immediately get a list of completions.",
    "created_at": "2017-10-02T17:36:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339012",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:3" align="right">comment:3</div>

On OS X (10.12.6, Xcode 8.3.3, Sage 8.1.beta6), I don't get this crash, and I also don't see the message "Building Maxima command completion list ...": I just immediately get a list of completions.



---

archive/issue_comments_339013.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nReplying to [@jhpalmieri](#comment:3):\n> On OS X (10.12.6, Xcode 8.3.3, Sage 8.1.beta6), I don't get this crash, and I also don't see the message \"Building Maxima command completion list ...\": I just immediately get a list of completions.\n\nIt's because you already have this list built and stored in somewhere in `~/.sage`, I suppose. Try moving it out of the way 1st.",
    "created_at": "2017-10-02T17:44:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339013",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:4" align="right">comment:4</div>

Replying to [@jhpalmieri](#comment:3):
> On OS X (10.12.6, Xcode 8.3.3, Sage 8.1.beta6), I don't get this crash, and I also don't see the message "Building Maxima command completion list ...": I just immediately get a list of completions.

It's because you already have this list built and stored in somewhere in `~/.sage`, I suppose. Try moving it out of the way 1st.



---

archive/issue_comments_339014.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nOkay, I get the crash after deleting `.sage/maxima_commandlist_cache.sobj`. Do you know why starting Sage and then doing `maxima.<TAB>` doesn't trigger the crash, but instead rebuilds this file?",
    "created_at": "2017-10-02T17:50:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339014",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:5" align="right">comment:5</div>

Okay, I get the crash after deleting `.sage/maxima_commandlist_cache.sobj`. Do you know why starting Sage and then doing `maxima.<TAB>` doesn't trigger the crash, but instead rebuilds this file?



---

archive/issue_comments_339015.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nReplying to [@jhpalmieri](#comment:5):\n> Okay, I get the crash after deleting `.sage/maxima_commandlist_cache.sobj`. Do you know why starting Sage and then doing `maxima.<TAB>` doesn't trigger the crash, but instead rebuilds this file?\n\nYes, it is because in this case everything happens in the same thread (the one of the tab completion).",
    "created_at": "2017-10-02T18:36:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339015",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:6" align="right">comment:6</div>

Replying to [@jhpalmieri](#comment:5):
> Okay, I get the crash after deleting `.sage/maxima_commandlist_cache.sobj`. Do you know why starting Sage and then doing `maxima.<TAB>` doesn't trigger the crash, but instead rebuilds this file?

Yes, it is because in this case everything happens in the same thread (the one of the tab completion).



---

archive/issue_comments_339016.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nMaking maxima_lib \"thread-safe\" would consist of *locking* it to one thread. Due to the signal management switching that happens upon entering/exiting ecllib makes it fundamentally incompatible with multi-threading, because signal handlers are process-specific; not thread-specific.\n\nSage installs special signal handlers (for SIGINT, for instance), and so does ECL. If ECL runs with multi-threading, ECL even goes further with signal handling (it makes a dedicated signal handling thread), and it uses signals to synchronize threads for critical GC operations.\n\nIf you want to get ecllib to a state where it can safely be used in a multi-threaded environment, I think one would have to unify the signal management of sage and ecl.\n\nThe result would not actually make maxima_lib threadsafe, because maxima itself is rather fundamentally not thread-safe.",
    "created_at": "2017-10-03T05:26:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339016",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:7" align="right">comment:7</div>

Making maxima_lib "thread-safe" would consist of *locking* it to one thread. Due to the signal management switching that happens upon entering/exiting ecllib makes it fundamentally incompatible with multi-threading, because signal handlers are process-specific; not thread-specific.

Sage installs special signal handlers (for SIGINT, for instance), and so does ECL. If ECL runs with multi-threading, ECL even goes further with signal handling (it makes a dedicated signal handling thread), and it uses signals to synchronize threads for critical GC operations.

If you want to get ecllib to a state where it can safely be used in a multi-threaded environment, I think one would have to unify the signal management of sage and ecl.

The result would not actually make maxima_lib threadsafe, because maxima itself is rather fundamentally not thread-safe.



---

archive/issue_comments_339017.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nRemoving dependencies seems so much more promising, see https://trac.sagemath.org/wiki/symbolics/maxima",
    "created_at": "2017-10-03T06:06:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339017",
    "user": "https://github.com/rwst"
}
```

<div id="comment:8" align="right">comment:8</div>

Removing dependencies seems so much more promising, see https://trac.sagemath.org/wiki/symbolics/maxima



---

archive/issue_comments_339018.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nHere is another scenario with two threads, only leading to an abort, not to a segfault.\nHere I tab-complete `from sage.libs.ecl import ` to force initialisation in non-main thread.\n\n```\nsage: from sage.libs.ecl import                        \n at  init_ecl\n thread id  <Thread(Thread-32, started 139989416191744)> \n active threads  [<_MainThread(MainThread, started 140000333952768)>, <HistorySavingThread(IPythonHistorySavingThread, started 140000088241920)>, <Thread(Thread-32, started 139989416191744)>] \nsage: from sage.libs.ecl import *\nsage: from sage.interfaces.maxima_lib import *\n at  ecl_eval\n thread id  <_MainThread(MainThread, started 140000333952768)> \n active threads  [<_MainThread(MainThread, started 140000333952768)>, <HistorySavingThread(IPythonHistorySavingThread, started 140000088241920)>] \n at  ecl_safe_eval\n thread id  <_MainThread(MainThread, started 140000333952768)> \n active threads  [<_MainThread(MainThread, started 140000333952768)>, <HistorySavingThread(IPythonHistorySavingThread, started 140000088241920)>] \n at  ecl_eval\n thread id  <_MainThread(MainThread, started 140000333952768)> \n active threads  [<_MainThread(MainThread, started 140000333952768)>, <HistorySavingThread(IPythonHistorySavingThread, started 140000088241920)>] \n at  ecl_safe_eval\n thread id  <_MainThread(MainThread, started 140000333952768)> \n active threads  [<_MainThread(MainThread, started 140000333952768)>, <HistorySavingThread(IPythonHistorySavingThread, started 140000088241920)>] \nCollecting from unknown thread\n---------------------------------------------------------------------------\nRuntimeError                              Traceback (most recent call last)\n<ipython-input-2-5e6d4a068396> in <module>()\n----> 1 from sage.interfaces.maxima_lib import *\n\n/home/dima/Sage/sage-dev/local/lib/python2.7/site-packages/sage/interfaces/maxima_lib.py in <module>()\n    102 ## i.e. loading it into ECL\n    103 ecl_eval(\"(setf *load-verbose* NIL)\")\n--> 104 ecl_eval(\"(require 'maxima)\")\n    105 ecl_eval(\"(in-package :maxima)\")\n    106 ecl_eval(\"(setq $nolabels t))\")\n\n/home/dima/Sage/sage-dev/src/sage/libs/ecl.pyx in sage.libs.ecl.ecl_eval (build/cythonized/sage/libs/ecl.c:10977)()\n   1328 \n   1329 #convenience routine to more easily evaluate strings\n-> 1330 cpdef EclObject ecl_eval(bytes s):\n   1331     \"\"\"\n   1332     Read and evaluate string in Lisp and return the result\n\n/home/dima/Sage/sage-dev/src/sage/libs/ecl.pyx in sage.libs.ecl.ecl_eval (build/cythonized/sage/libs/ecl.c:10916)()\n   1344     cdef cl_object o\n   1345     o=ecl_safe_read_string(s)\n-> 1346     o=ecl_safe_eval(o)\n   1347     return ecl_wrap(o)\n   1348 \n\n/home/dima/Sage/sage-dev/src/sage/libs/ecl.pyx in sage.libs.ecl.ecl_safe_eval (build/cythonized/sage/libs/ecl.c:5710)()\n    343     report_threading_status(\"ecl_safe_eval\")\n    344     cdef cl_object s\n--> 345     ecl_sig_on()\n    346     cl_funcall(2,safe_eval_clobj,form)\n    347     ecl_sig_off()\n\nRuntimeError: Aborted\nsage: \n```\nwith the following prints inserted into `ecl.pyx`:\n\n```\ndiff --git a/src/sage/libs/ecl.pyx b/src/sage/libs/ecl.pyx\nindex 20e937876d..879d405d78 100644\n--- a/src/sage/libs/ecl.pyx\n+++ b/src/sage/libs/ecl.pyx\n@@ -240,6 +240,7 @@ def init_ecl():\n     cdef sigaction_t sage_action[32]\n     cdef int i\n \n+    report_threading_status(\"init_ecl\")\n     if ecl_has_booted:\n         raise RuntimeError(\"ECL is already initialized\")\n \n@@ -339,6 +340,7 @@ cdef cl_object ecl_safe_eval(cl_object form) except NULL:\n         ...\n         RuntimeError: ECL says: Console interrupt.\n     \"\"\"\n+    report_threading_status(\"ecl_safe_eval\")\n     cdef cl_object s\n     ecl_sig_on()\n     cl_funcall(2,safe_eval_clobj,form)\n@@ -1318,6 +1320,12 @@ cdef EclObject ecl_wrap(cl_object o):\n     obj.set_obj(o)\n     return obj\n \n+cpdef report_threading_status(s):\n+    import threading\n+    print(\"\\n at \", s)\n+    print(\"\\n thread id \", threading.current_thread(), \"\\n\")\n+    print(\" active threads \", threading.enumerate(), \"\\n\")\n+\n #convenience routine to more easily evaluate strings\n cpdef EclObject ecl_eval(bytes s):\n     \"\"\"\n@@ -1332,6 +1340,7 @@ cpdef EclObject ecl_eval(bytes s):\n         <ECL: (1 1 2 3 5 8 13)>\n \n     \"\"\"\n+    report_threading_status(\"ecl_eval\")\n     cdef cl_object o\n     o=ecl_safe_read_string(s)\n     o=ecl_safe_eval(o)\n```",
    "created_at": "2017-10-03T13:25:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339018",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:9" align="right">comment:9</div>

Here is another scenario with two threads, only leading to an abort, not to a segfault.
Here I tab-complete `from sage.libs.ecl import ` to force initialisation in non-main thread.

```
sage: from sage.libs.ecl import                        
 at  init_ecl
 thread id  <Thread(Thread-32, started 139989416191744)> 
 active threads  [<_MainThread(MainThread, started 140000333952768)>, <HistorySavingThread(IPythonHistorySavingThread, started 140000088241920)>, <Thread(Thread-32, started 139989416191744)>] 
sage: from sage.libs.ecl import *
sage: from sage.interfaces.maxima_lib import *
 at  ecl_eval
 thread id  <_MainThread(MainThread, started 140000333952768)> 
 active threads  [<_MainThread(MainThread, started 140000333952768)>, <HistorySavingThread(IPythonHistorySavingThread, started 140000088241920)>] 
 at  ecl_safe_eval
 thread id  <_MainThread(MainThread, started 140000333952768)> 
 active threads  [<_MainThread(MainThread, started 140000333952768)>, <HistorySavingThread(IPythonHistorySavingThread, started 140000088241920)>] 
 at  ecl_eval
 thread id  <_MainThread(MainThread, started 140000333952768)> 
 active threads  [<_MainThread(MainThread, started 140000333952768)>, <HistorySavingThread(IPythonHistorySavingThread, started 140000088241920)>] 
 at  ecl_safe_eval
 thread id  <_MainThread(MainThread, started 140000333952768)> 
 active threads  [<_MainThread(MainThread, started 140000333952768)>, <HistorySavingThread(IPythonHistorySavingThread, started 140000088241920)>] 
Collecting from unknown thread
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
<ipython-input-2-5e6d4a068396> in <module>()
----> 1 from sage.interfaces.maxima_lib import *

/home/dima/Sage/sage-dev/local/lib/python2.7/site-packages/sage/interfaces/maxima_lib.py in <module>()
    102 ## i.e. loading it into ECL
    103 ecl_eval("(setf *load-verbose* NIL)")
--> 104 ecl_eval("(require 'maxima)")
    105 ecl_eval("(in-package :maxima)")
    106 ecl_eval("(setq $nolabels t))")

/home/dima/Sage/sage-dev/src/sage/libs/ecl.pyx in sage.libs.ecl.ecl_eval (build/cythonized/sage/libs/ecl.c:10977)()
   1328 
   1329 #convenience routine to more easily evaluate strings
-> 1330 cpdef EclObject ecl_eval(bytes s):
   1331     """
   1332     Read and evaluate string in Lisp and return the result

/home/dima/Sage/sage-dev/src/sage/libs/ecl.pyx in sage.libs.ecl.ecl_eval (build/cythonized/sage/libs/ecl.c:10916)()
   1344     cdef cl_object o
   1345     o=ecl_safe_read_string(s)
-> 1346     o=ecl_safe_eval(o)
   1347     return ecl_wrap(o)
   1348 

/home/dima/Sage/sage-dev/src/sage/libs/ecl.pyx in sage.libs.ecl.ecl_safe_eval (build/cythonized/sage/libs/ecl.c:5710)()
    343     report_threading_status("ecl_safe_eval")
    344     cdef cl_object s
--> 345     ecl_sig_on()
    346     cl_funcall(2,safe_eval_clobj,form)
    347     ecl_sig_off()

RuntimeError: Aborted
sage: 
```
with the following prints inserted into `ecl.pyx`:

```
diff --git a/src/sage/libs/ecl.pyx b/src/sage/libs/ecl.pyx
index 20e937876d..879d405d78 100644
--- a/src/sage/libs/ecl.pyx
+++ b/src/sage/libs/ecl.pyx
@@ -240,6 +240,7 @@ def init_ecl():
     cdef sigaction_t sage_action[32]
     cdef int i
 
+    report_threading_status("init_ecl")
     if ecl_has_booted:
         raise RuntimeError("ECL is already initialized")
 
@@ -339,6 +340,7 @@ cdef cl_object ecl_safe_eval(cl_object form) except NULL:
         ...
         RuntimeError: ECL says: Console interrupt.
     """
+    report_threading_status("ecl_safe_eval")
     cdef cl_object s
     ecl_sig_on()
     cl_funcall(2,safe_eval_clobj,form)
@@ -1318,6 +1320,12 @@ cdef EclObject ecl_wrap(cl_object o):
     obj.set_obj(o)
     return obj
 
+cpdef report_threading_status(s):
+    import threading
+    print("\n at ", s)
+    print("\n thread id ", threading.current_thread(), "\n")
+    print(" active threads ", threading.enumerate(), "\n")
+
 #convenience routine to more easily evaluate strings
 cpdef EclObject ecl_eval(bytes s):
     """
@@ -1332,6 +1340,7 @@ cpdef EclObject ecl_eval(bytes s):
         <ECL: (1 1 2 3 5 8 13)>
 
     """
+    report_threading_status("ecl_eval")
     cdef cl_object o
     o=ecl_safe_read_string(s)
     o=ecl_safe_eval(o)
```



---

archive/issue_comments_339019.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nI think what we see here is ECL being initialised in a thread (number 32) that later is shut down, and then `maxima_lib` import breaks, as ECL isn't available to run.\n\nIt seems that indeed we must make sure that ECL is always started in the main thread, which does not disappear.",
    "created_at": "2017-10-04T14:32:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339019",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:10" align="right">comment:10</div>

I think what we see here is ECL being initialised in a thread (number 32) that later is shut down, and then `maxima_lib` import breaks, as ECL isn't available to run.

It seems that indeed we must make sure that ECL is always started in the main thread, which does not disappear.



---

archive/issue_comments_339020.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nA part of the relevant discussion is on #23956, which I'll close as duplicate.",
    "created_at": "2017-10-05T17:42:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339020",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:11" align="right">comment:11</div>

A part of the relevant discussion is on #23956, which I'll close as duplicate.



---

archive/issue_events_317792.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2017-10-05T17:42:48Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "milestone_number": null,
    "milestone_title": "sage-8.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22766#event-317792"
}
```



---

archive/issue_events_317793.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2017-10-05T17:42:48Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "milestone_number": null,
    "milestone_title": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22766#event-317793"
}
```



---

archive/issue_events_317794.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2017-10-05T17:42:48Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "label": "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p: 2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22766#event-317794"
}
```



---

archive/issue_events_317795.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2017-10-05T17:42:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "label": "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p: 1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22766#event-317795"
}
```



---

archive/issue_comments_339021.json:
```json
{
    "body": "Dependencies: **#23956**",
    "created_at": "2017-10-05T17:43:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339021",
    "user": "https://github.com/dimpase"
}
```

Dependencies: **#23956**



---

archive/issue_comments_339022.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,7 @@\n-Hitting TAB after `maxima_lib`:\n+If Maxima's commands list is not stored, then initialising Maxima/ECL and then hitting TAB after `maxima_lib` crashes Sage, as shown below. Other similar crashes may be triggered, see e.g. #23956. \n+\n+The reason for these crashes is the design of tab completion in `IPython` 5+ using \n+[prompt_toolkit](http://python-prompt-toolkit.readthedocs.io/en/stable/), which uses Python threading, and does tab completion in a separate thread. \n \n ```\n \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n``````\n",
    "created_at": "2017-10-05T17:57:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339022",
    "user": "https://github.com/dimpase"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,7 @@
-Hitting TAB after `maxima_lib`:
+If Maxima's commands list is not stored, then initialising Maxima/ECL and then hitting TAB after `maxima_lib` crashes Sage, as shown below. Other similar crashes may be triggered, see e.g. #23956. 
+
+The reason for these crashes is the design of tab completion in `IPython` 5+ using 
+[prompt_toolkit](http://python-prompt-toolkit.readthedocs.io/en/stable/), which uses Python threading, and does tab completion in a separate thread. 
 
 ```
 ┌────────────────────────────────────────────────────────────────────┐
``````




---

archive/issue_comments_339023.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nI wonder whether any other extension (apart from ECL/Maxima) is affected by this issue.",
    "created_at": "2017-10-05T18:24:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339023",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:14" align="right">comment:14</div>

I wonder whether any other extension (apart from ECL/Maxima) is affected by this issue.



---

archive/issue_comments_339024.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nReiterating from 23956:\n\n\nThe effect of `ecl_sig_on` and `ecl_sig_off` is NOT thread-local. Thus during the clock time that `ecl_sig_on` is active (i.e., that `ecl` code is being executed), signals that are supposed to be handled by the sage signal handler will be handled in the wrong way.\n\nThat means it is NOT safe to execute sage code in a thread parallel to a thread that is executing ecl code (properly).\n\nSo, if we allow for multiple threads in sage, we'd strictly have to halt all the other threads upon executing `ecl_sig_on`, and start them again when the corresponding `ecl_sig_off` is entered.\nThat, or cross your fingers no signals destined for python arrive during that time period.\n\nIn addition, we're running ECL with threading support on their end *disabled*. I would be surprised if, with that configuration, it is still possible to have multiple threads configured to be able to execute ECL (ECL cares a lot about knowing which threads might be executing ECL code, because they need to be stopped during critical GC events. I expect that all of that is turned off when threading support is turned off).\n\nGiven that IPython apparently runs tab completion in a separate thread, I think the most straightforward way of solving the immediate problem here is to avoid that ecl code will be run upon tab completion. That can be done by building the completion cache upon build time, rather than on-demand.",
    "created_at": "2017-10-06T08:15:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339024",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:15" align="right">comment:15</div>

Reiterating from 23956:


The effect of `ecl_sig_on` and `ecl_sig_off` is NOT thread-local. Thus during the clock time that `ecl_sig_on` is active (i.e., that `ecl` code is being executed), signals that are supposed to be handled by the sage signal handler will be handled in the wrong way.

That means it is NOT safe to execute sage code in a thread parallel to a thread that is executing ecl code (properly).

So, if we allow for multiple threads in sage, we'd strictly have to halt all the other threads upon executing `ecl_sig_on`, and start them again when the corresponding `ecl_sig_off` is entered.
That, or cross your fingers no signals destined for python arrive during that time period.

In addition, we're running ECL with threading support on their end *disabled*. I would be surprised if, with that configuration, it is still possible to have multiple threads configured to be able to execute ECL (ECL cares a lot about knowing which threads might be executing ECL code, because they need to be stopped during critical GC events. I expect that all of that is turned off when threading support is turned off).

Given that IPython apparently runs tab completion in a separate thread, I think the most straightforward way of solving the immediate problem here is to avoid that ecl code will be run upon tab completion. That can be done by building the completion cache upon build time, rather than on-demand.



---

archive/issue_comments_339025.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@nbruin](#comment:15):\n> The effect of `ecl_sig_on` and `ecl_sig_off` is NOT thread-local. Thus during the clock time that `ecl_sig_on` is active (i.e., that `ecl` code is being executed), signals that are supposed to be handled by the sage signal handler will be handled in the wrong way.\n> \n> That means it is NOT safe to execute sage code in a thread parallel to a thread that is executing ecl code (properly).\n\nRight, I think I finally understand your point about signals---sorry for being thick.\n\nIt's even worse, I think - apart from signals, ecllib does non-thread-safe things to global variables...\nIt's known that in such a case GIL does not suffice, you also need a lock from Python `threading` \n\n```\nlock=threading.Lock()\nwith lock:\n    <do unsafe (non-atomic) stuff here>\n```\n\nThat is we potentially might still get hit by many threads here, even if something seemingly innocent happens.\n\nTo me it looks that to disable threads in tab completion is a more robust solution, and it will also make sure that other extensions are safe and sound in this respect, not only ECL/Maxima.",
    "created_at": "2017-10-06T08:44:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339025",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@nbruin](#comment:15):
> The effect of `ecl_sig_on` and `ecl_sig_off` is NOT thread-local. Thus during the clock time that `ecl_sig_on` is active (i.e., that `ecl` code is being executed), signals that are supposed to be handled by the sage signal handler will be handled in the wrong way.
> 
> That means it is NOT safe to execute sage code in a thread parallel to a thread that is executing ecl code (properly).

Right, I think I finally understand your point about signals---sorry for being thick.

It's even worse, I think - apart from signals, ecllib does non-thread-safe things to global variables...
It's known that in such a case GIL does not suffice, you also need a lock from Python `threading` 

```
lock=threading.Lock()
with lock:
    <do unsafe (non-atomic) stuff here>
```

That is we potentially might still get hit by many threads here, even if something seemingly innocent happens.

To me it looks that to disable threads in tab completion is a more robust solution, and it will also make sure that other extensions are safe and sound in this respect, not only ECL/Maxima.



---

archive/issue_comments_339026.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@dimpase](#comment:16):\n> It's even worse, I think - apart from signals, ecllib does non-thread-safe things to global variables...\n\nAfter initialization that should pretty much be limited to the modifications that are made to the ECL doubly linked list `*SAGE-LIST-OF-OBJECTS*`. The modifications run in ECL whenever an `EclObject` is made or deleted (so that should lock, probably). Otherwise I think the signal stuff is the main obstruction to thread-safety.\n\nmaximalib is a different issue: maxima is just not thread-safe in its design at all. So I don't think it's worth investing in making ecllib thread-safe (and the signals are a real obstruction), because our main application doesn't allow it anyway.",
    "created_at": "2017-10-06T09:18:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339026",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@dimpase](#comment:16):
> It's even worse, I think - apart from signals, ecllib does non-thread-safe things to global variables...

After initialization that should pretty much be limited to the modifications that are made to the ECL doubly linked list `*SAGE-LIST-OF-OBJECTS*`. The modifications run in ECL whenever an `EclObject` is made or deleted (so that should lock, probably). Otherwise I think the signal stuff is the main obstruction to thread-safety.

maximalib is a different issue: maxima is just not thread-safe in its design at all. So I don't think it's worth investing in making ecllib thread-safe (and the signals are a real obstruction), because our main application doesn't allow it anyway.



---

archive/issue_comments_339027.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@nbruin](#comment:7):\n> It uses signals to synchronize threads for critical GC operations.\n\nIt seems that `ecl_sig_on()` changes `SIGINT`, `SIGBUS` and `SIGSEGV`. Does it really use one of those standard signals to deal with GC operations? Because if none of those 3 signals are involved, the issue can't be signal handlers.\n\nIt is true that signals and threads generally do not mix well. Signal handlers are set on the level of the process, not threads.",
    "created_at": "2017-10-06T09:19:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339027",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@nbruin](#comment:7):
> It uses signals to synchronize threads for critical GC operations.

It seems that `ecl_sig_on()` changes `SIGINT`, `SIGBUS` and `SIGSEGV`. Does it really use one of those standard signals to deal with GC operations? Because if none of those 3 signals are involved, the issue can't be signal handlers.

It is true that signals and threads generally do not mix well. Signal handlers are set on the level of the process, not threads.



---

archive/issue_comments_339028.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -4,6 +4,8 @@\n [prompt_toolkit](http://python-prompt-toolkit.readthedocs.io/en/stable/), which uses Python threading, and does tab completion in a separate thread. \n \n ```\n+$ rm -f ~/.sage/maxima_commandlist_cache.sobj\n+$ sage\n \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n \u2502 SageMath version 8.0.beta0, Release Date: 2017-03-30               \u2502\n \u2502 Type \"notebook()\" for the browser-based notebook interface.        \u2502\n``````\n",
    "created_at": "2017-10-06T09:22:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339028",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -4,6 +4,8 @@
 [prompt_toolkit](http://python-prompt-toolkit.readthedocs.io/en/stable/), which uses Python threading, and does tab completion in a separate thread. 
 
 ```
+$ rm -f ~/.sage/maxima_commandlist_cache.sobj
+$ sage
 ┌────────────────────────────────────────────────────────────────────┐
 │ SageMath version 8.0.beta0, Release Date: 2017-03-30               │
 │ Type "notebook()" for the browser-based notebook interface.        │
``````




---

archive/issue_comments_339029.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nI don't think that signal handling has anything to do with this bug here. I don't see any signals being raised in a `strace` dump and also the error message from ECL says \"Stack overflow\".",
    "created_at": "2017-10-06T09:26:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339029",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:20" align="right">comment:20</div>

I don't think that signal handling has anything to do with this bug here. I don't see any signals being raised in a `strace` dump and also the error message from ECL says "Stack overflow".



---

archive/issue_comments_339030.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nWait a minute... the \"stack overflow\" reminds me of a very similar issue that affected PARI/GP: #17773",
    "created_at": "2017-10-06T09:34:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339030",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:21" align="right">comment:21</div>

Wait a minute... the "stack overflow" reminds me of a very similar issue that affected PARI/GP: #17773



---

archive/issue_comments_339031.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nBoehm GC (which is used by ECL) installs its own signal handlers in order to be able to scan for garbage. Thus if another thread does something  to signals, then GC and thus ECL might go belly up. \n\n\"Stack overflow\" might be due to GC being given data to work on from another thread it does not know about. \n\nThe more I think about it the more inclined I become towards disabling tab completion in a separate thread.",
    "created_at": "2017-10-06T09:51:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339031",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:22" align="right">comment:22</div>

Boehm GC (which is used by ECL) installs its own signal handlers in order to be able to scan for garbage. Thus if another thread does something  to signals, then GC and thus ECL might go belly up. 

"Stack overflow" might be due to GC being given data to work on from another thread it does not know about. 

The more I think about it the more inclined I become towards disabling tab completion in a separate thread.



---

archive/issue_comments_339032.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nReplying to [@dimpase](#comment:22):\n> Boehm GC (which is used by ECL) installs its own signal handlers in order to be able to scan for garbage.\n\nI understand what you are saying but I don't believe that this has anything to do with this ticket.",
    "created_at": "2017-10-06T09:55:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339032",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:23" align="right">comment:23</div>

Replying to [@dimpase](#comment:22):
> Boehm GC (which is used by ECL) installs its own signal handlers in order to be able to scan for garbage.

I understand what you are saying but I don't believe that this has anything to do with this ticket.



---

archive/issue_comments_339033.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nReplying to [@jdemeyer](#comment:23):\n> Replying to [@dimpase](#comment:22):\n> > Boehm GC (which is used by ECL) installs its own signal handlers in order to be able to scan for garbage.\n\n> \n> I understand what you are saying but I don't believe that this has anything to do with this ticket.\n\nAs Nils explains, Maxima is not thread-safe, and thus invoking it from non-main thread (e.g. from the tab-completion one) is prone to errors. Thus invoking ECL from non-main thread does not need to be allowed.\nAssuming this, indeed, signals issue has nothing to do with this ticket, at least if limited to ECL/Maxima scope.",
    "created_at": "2017-10-06T10:09:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339033",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:24" align="right">comment:24</div>

Replying to [@jdemeyer](#comment:23):
> Replying to [@dimpase](#comment:22):
> > Boehm GC (which is used by ECL) installs its own signal handlers in order to be able to scan for garbage.

> 
> I understand what you are saying but I don't believe that this has anything to do with this ticket.

As Nils explains, Maxima is not thread-safe, and thus invoking it from non-main thread (e.g. from the tab-completion one) is prone to errors. Thus invoking ECL from non-main thread does not need to be allowed.
Assuming this, indeed, signals issue has nothing to do with this ticket, at least if limited to ECL/Maxima scope.



---

archive/issue_comments_339034.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nRight. There are two issues:\n\n1. The signal switching that Sage does for ECL is not thread-safe.\n\n2. The ECL check for \"stack overflow\" is broken if run in a different thread.\n\nThis ticket is about the second issue. It can be fixed independently.",
    "created_at": "2017-10-06T10:15:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339034",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:25" align="right">comment:25</div>

Right. There are two issues:

1. The signal switching that Sage does for ECL is not thread-safe.

2. The ECL check for "stack overflow" is broken if run in a different thread.

This ticket is about the second issue. It can be fixed independently.



---

archive/issue_comments_339035.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nIt turns out that both issues are actually relevant. After fixing the second issue (in plain IPython, not Sage):\n\n```\nIn [1]: import sage.all; from sage.interfaces.maxima_lib import maxima_lib\n\nIn [2]: maxima_lib.\nBuilding Maxima command completion list (this takes\na few seconds only the first time you do it).\nTo force rebuild later, delete /home/jdemeyer/.sage//maxima_commandlist_cache.sobj.\nAaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPower failure\n```\n\nThe `Power failure` is clearly due to an ECL signal. When fixing also this, it still doesn't work:\n\n```\nBuilding Maxima command completion list (this takes\na few seconds only the first time you do it).\nTo force rebuild later, delete /home/jdemeyer/.sage//maxima_commandlist_cache.sobj.\nAaBbCcDdEeFfGgHhIiJjKkLlMmNnOoCollecting from unknown thread\n```\n\nSo it seems that running ECL only in the main thread is the only solution.",
    "created_at": "2017-10-06T10:51:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339035",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:26" align="right">comment:26</div>

It turns out that both issues are actually relevant. After fixing the second issue (in plain IPython, not Sage):

```
In [1]: import sage.all; from sage.interfaces.maxima_lib import maxima_lib

In [2]: maxima_lib.
Building Maxima command completion list (this takes
a few seconds only the first time you do it).
To force rebuild later, delete /home/jdemeyer/.sage//maxima_commandlist_cache.sobj.
AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPower failure
```

The `Power failure` is clearly due to an ECL signal. When fixing also this, it still doesn't work:

```
Building Maxima command completion list (this takes
a few seconds only the first time you do it).
To force rebuild later, delete /home/jdemeyer/.sage//maxima_commandlist_cache.sobj.
AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoCollecting from unknown thread
```

So it seems that running ECL only in the main thread is the only solution.



---

archive/issue_comments_339036.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nReplying to [@jdemeyer](#comment:26):\n> So it seems that running ECL only in the main thread is the only solution.\n\nECL does have facilities for registering/de-registering threads, \n`ecl_import_current_thread` and `ecl_release_current_thread`,\nonly available if you build it with `--enable-threads`, and with somewhat unclear usage rules. Not even sure if they are compatible with our gc version, or whether they would work at all in our setting - I tried with gc-7.6.0 from #23700, it didn't work - perhaps due to the signals trouble you mention?\n\nIMHO making this work seems to be a tough call, and in particular in the upcoming ECL 16.2 this code (and the signals-handling code) is being changed, so what works for 16.1.2 might break in the next version.",
    "created_at": "2017-10-06T11:07:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339036",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:27" align="right">comment:27</div>

Replying to [@jdemeyer](#comment:26):
> So it seems that running ECL only in the main thread is the only solution.

ECL does have facilities for registering/de-registering threads, 
`ecl_import_current_thread` and `ecl_release_current_thread`,
only available if you build it with `--enable-threads`, and with somewhat unclear usage rules. Not even sure if they are compatible with our gc version, or whether they would work at all in our setting - I tried with gc-7.6.0 from #23700, it didn't work - perhaps due to the signals trouble you mention?

IMHO making this work seems to be a tough call, and in particular in the upcoming ECL 16.2 this code (and the signals-handling code) is being changed, so what works for 16.1.2 might break in the next version.



---

archive/issue_comments_339037.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nReplying to [@dimpase](#comment:27):\n> IMHO making this work seems to be a tough call, and in particular in the upcoming ECL 16.2 this code (and the signals-handling code) is being changed, so what works for 16.1.2 might break in the next version.\n\nIn that case: perhaps downgrade from blocker and solve later? The issue is a serious one, but the symptoms seem to be easily avoided (it's a rather specific tab completion).\n\nConcerning threading: at least a while ago, enabling threading in ECL meant that ECL would start up a dedicated signal handling thread, and really start using (very strange!) signals to signal GC events to other threads. That setup looked very hard to make compatible with sage. That's why I think we want to stick with ECL *without* threading (and hope they keep supporting that! They really should if they want to keep the \"embeddable\" a serious option, because in many embedding scenarios having the library take control of signal handling in such an invasive way will be very hard to work with.)",
    "created_at": "2017-10-08T08:34:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339037",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:28" align="right">comment:28</div>

Replying to [@dimpase](#comment:27):
> IMHO making this work seems to be a tough call, and in particular in the upcoming ECL 16.2 this code (and the signals-handling code) is being changed, so what works for 16.1.2 might break in the next version.

In that case: perhaps downgrade from blocker and solve later? The issue is a serious one, but the symptoms seem to be easily avoided (it's a rather specific tab completion).

Concerning threading: at least a while ago, enabling threading in ECL meant that ECL would start up a dedicated signal handling thread, and really start using (very strange!) signals to signal GC events to other threads. That setup looked very hard to make compatible with sage. That's why I think we want to stick with ECL *without* threading (and hope they keep supporting that! They really should if they want to keep the "embeddable" a serious option, because in many embedding scenarios having the library take control of signal handling in such an invasive way will be very hard to work with.)



---

archive/issue_comments_339038.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nI was just pointed out at a solved  IPython issue I missed, which reverts reliance on prompt_toolkit, and brings back single-threading behaviour of IPython:\nhttps://github.com/ipython/ipython/issues/10364/#issuecomment-300829008\n\nThere is another reason for avoiding prompt_toolkit - it does multi-threaded importing of Python modules, and given how fragile Sage is in its dependencies handling, this is something to avoid, unless we want more mysterious crashes to happen.",
    "created_at": "2017-10-08T08:53:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339038",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:29" align="right">comment:29</div>

I was just pointed out at a solved  IPython issue I missed, which reverts reliance on prompt_toolkit, and brings back single-threading behaviour of IPython:
https://github.com/ipython/ipython/issues/10364/#issuecomment-300829008

There is another reason for avoiding prompt_toolkit - it does multi-threaded importing of Python modules, and given how fragile Sage is in its dependencies handling, this is something to avoid, unless we want more mysterious crashes to happen.



---

archive/issue_comments_339039.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nBy the way, FriCAS is another (soon to be optional (see #23847), currently experimental) Sage package dependent on ECL in a substantial way.",
    "created_at": "2017-10-08T10:24:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339039",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:30" align="right">comment:30</div>

By the way, FriCAS is another (soon to be optional (see #23847), currently experimental) Sage package dependent on ECL in a substantial way.



---

archive/issue_comments_339040.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nReplying to [@dimpase](#comment:30):\n> By the way, FriCAS is another (soon to be optional (see #23847), currently experimental) Sage package dependent on ECL in a substantial way.\n\nThat shouldn't interact with the issue here at all, as long as FriCas runs via a proper expect interface. If people start running FriCas in ecllib, I expect bigger trouble, because I don't expect that one can run maxima and fricas in the same lisp without special measures -- both are legacy applications that were originally designed to have the world (or at least their process) to themselves.\n\nGetting rid of multi-threading in IPython sounds like a very good idea.",
    "created_at": "2017-10-09T08:43:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339040",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:31" align="right">comment:31</div>

Replying to [@dimpase](#comment:30):
> By the way, FriCAS is another (soon to be optional (see #23847), currently experimental) Sage package dependent on ECL in a substantial way.

That shouldn't interact with the issue here at all, as long as FriCas runs via a proper expect interface. If people start running FriCas in ecllib, I expect bigger trouble, because I don't expect that one can run maxima and fricas in the same lisp without special measures -- both are legacy applications that were originally designed to have the world (or at least their process) to themselves.

Getting rid of multi-threading in IPython sounds like a very good idea.



---

archive/issue_comments_339041.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nHere is one way to try the old new IPython prompt---this gets rid of crashes for me.\nThis is only IPython hack - I don't know how to force Sage's IPython switch to this.\nOne can do the following (I also removed `~/.sage/` for a good measure, not sure if this is needed; also not sure if it really needs 5.5.0, it also seems to work with the IPython 5.0 that we ship):\n\n```\n$ ./sage --pip install git+https://github.com/ipython/ipython/@5.5.0\n$ ./sage --pip install rlipython\n$ ./sage --ipython\n```\nonce at IPython prompt, type\n\n```\nimport rlipython; rlipython.install()\n```\nand quit. Then IPython will use readline for completion, as in good old days of version 4.x.\nTo test that this fixes the bug: start IPython as `./sage --ipython`, and run\n\n```\nfrom sage.all import *\nfrom sage.interfaces.maxima_lib import maxima_lib\nmaxima_lib.\n```\n(notice the 1st import---needed to initialise Sage).",
    "created_at": "2017-10-09T09:54:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339041",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:32" align="right">comment:32</div>

Here is one way to try the old new IPython prompt---this gets rid of crashes for me.
This is only IPython hack - I don't know how to force Sage's IPython switch to this.
One can do the following (I also removed `~/.sage/` for a good measure, not sure if this is needed; also not sure if it really needs 5.5.0, it also seems to work with the IPython 5.0 that we ship):

```
$ ./sage --pip install git+https://github.com/ipython/ipython/@5.5.0
$ ./sage --pip install rlipython
$ ./sage --ipython
```
once at IPython prompt, type

```
import rlipython; rlipython.install()
```
and quit. Then IPython will use readline for completion, as in good old days of version 4.x.
To test that this fixes the bug: start IPython as `./sage --ipython`, and run

```
from sage.all import *
from sage.interfaces.maxima_lib import maxima_lib
maxima_lib.
```
(notice the 1st import---needed to initialise Sage).



---

archive/issue_comments_339042.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nReplying to [@nbruin](#comment:28):\n> Replying to [@dimpase](#comment:27):\n> > IMHO making this work seems to be a tough call, and in particular in the upcoming ECL 16.2 this code (and the signals-handling code) is being changed, so what works for 16.1.2 might break in the next version.\n\n> \n> In that case: perhaps downgrade from blocker and solve later? The issue is a serious one, but the symptoms seem to be easily avoided (it's a rather specific tab completion).\n> \n> Concerning threading: at least a while ago, enabling threading in ECL meant that ECL would start up a dedicated signal handling thread, and really start using (very strange!) signals to signal GC events to other threads. That setup looked very hard to make compatible with sage. That's why I think we want to stick with ECL *without* threading (and hope they keep supporting that! They really should if they want to keep the \"embeddable\" a serious option, because in many embedding scenarios having the library take control of signal handling in such an invasive way will be very hard to work with.)\n\nOne thing I've been investigating--the relevance of which I'm not sure--is that we compile libgc with threading support but ECL without.  The implications of this are complicated enough that I don't fully understand yet, but it makes me wonder if this can lead to bugs (this is possibly related to #23973).",
    "created_at": "2017-10-09T10:34:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339042",
    "user": "https://github.com/embray"
}
```

<div id="comment:33" align="right">comment:33</div>

Replying to [@nbruin](#comment:28):
> Replying to [@dimpase](#comment:27):
> > IMHO making this work seems to be a tough call, and in particular in the upcoming ECL 16.2 this code (and the signals-handling code) is being changed, so what works for 16.1.2 might break in the next version.

> 
> In that case: perhaps downgrade from blocker and solve later? The issue is a serious one, but the symptoms seem to be easily avoided (it's a rather specific tab completion).
> 
> Concerning threading: at least a while ago, enabling threading in ECL meant that ECL would start up a dedicated signal handling thread, and really start using (very strange!) signals to signal GC events to other threads. That setup looked very hard to make compatible with sage. That's why I think we want to stick with ECL *without* threading (and hope they keep supporting that! They really should if they want to keep the "embeddable" a serious option, because in many embedding scenarios having the library take control of signal handling in such an invasive way will be very hard to work with.)

One thing I've been investigating--the relevance of which I'm not sure--is that we compile libgc with threading support but ECL without.  The implications of this are complicated enough that I don't fully understand yet, but it makes me wonder if this can lead to bugs (this is possibly related to #23973).



---

archive/issue_comments_339043.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nReplying to [@embray](#comment:33):\n> Replying to [@nbruin](#comment:28):\n> > Replying to [@dimpase](#comment:27):\n\n...\n> > \n> > Concerning threading: at least a while ago, enabling threading in ECL meant that ECL would start up a dedicated signal handling thread, and really start using (very strange!) signals to signal GC events to other threads. That setup looked very hard to make compatible with sage.\n\nIMHO one takes care of this in `ecl.pyx`:\n\n```\n    ecl_set_option(ECL_OPT_SIGNAL_HANDLING_THREAD, 0)\n    cl_boot(1, argv)\n```\nmaking sure that signals are not handled in a separate thread, no?\n\n\n\n That's why I think we want to stick with ECL *without* threading (and hope they keep supporting that! They really should if they want to keep the \"embeddable\" a serious option, because in many embedding scenarios having the library take control of signal handling in such an invasive way will be very hard to work with.)\n> \n> One thing I've been investigating--the relevance of which I'm not sure--is that we compile libgc with threading support but ECL without.  The implications of this are complicated enough that I don't fully understand yet, but it makes me wonder if this can lead to bugs (this is possibly related to #23973).\n\nMind you, I came to this ticket via #23956 via #22679; on the latter I had a lot of trouble with threads (yes, in docbuilding with `-jx`, `x>1` too), until finding out that GC folks have not supplied a complete multithreading interface for FreeBSD---now fixed in https://github.com/ivmai/bdwgc/issues/180\nand only then realising that some multithreading-related segfaults happen on Linux too :-)\n \nI am not sure what \"multithreading for GC\" really means; it can be any combination of 2 things:\n\n    1) GC using threads to speed itself up\n\n    2) GC properly handles the situation of being initialised/called from a multithreaded application.\n\nIMHO 1) is disabled by `--disable-parallel-mark` (in perhaps more recent that 7.2f versions...).",
    "created_at": "2017-10-09T11:31:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339043",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:34" align="right">comment:34</div>

Replying to [@embray](#comment:33):
> Replying to [@nbruin](#comment:28):
> > Replying to [@dimpase](#comment:27):

...
> > 
> > Concerning threading: at least a while ago, enabling threading in ECL meant that ECL would start up a dedicated signal handling thread, and really start using (very strange!) signals to signal GC events to other threads. That setup looked very hard to make compatible with sage.

IMHO one takes care of this in `ecl.pyx`:

```
    ecl_set_option(ECL_OPT_SIGNAL_HANDLING_THREAD, 0)
    cl_boot(1, argv)
```
making sure that signals are not handled in a separate thread, no?



 That's why I think we want to stick with ECL *without* threading (and hope they keep supporting that! They really should if they want to keep the "embeddable" a serious option, because in many embedding scenarios having the library take control of signal handling in such an invasive way will be very hard to work with.)
> 
> One thing I've been investigating--the relevance of which I'm not sure--is that we compile libgc with threading support but ECL without.  The implications of this are complicated enough that I don't fully understand yet, but it makes me wonder if this can lead to bugs (this is possibly related to #23973).

Mind you, I came to this ticket via #23956 via #22679; on the latter I had a lot of trouble with threads (yes, in docbuilding with `-jx`, `x>1` too), until finding out that GC folks have not supplied a complete multithreading interface for FreeBSD---now fixed in https://github.com/ivmai/bdwgc/issues/180
and only then realising that some multithreading-related segfaults happen on Linux too :-)
 
I am not sure what "multithreading for GC" really means; it can be any combination of 2 things:

    1) GC using threads to speed itself up

    2) GC properly handles the situation of being initialised/called from a multithreaded application.

IMHO 1) is disabled by `--disable-parallel-mark` (in perhaps more recent that 7.2f versions...).



---

archive/issue_comments_339044.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nI don't think that this should be a blocker issue. It's an annoying bug which crashes Sage, but it's not very likely to appear since the TAB completion is cashed.",
    "created_at": "2017-11-13T13:21:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339044",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:35" align="right">comment:35</div>

I don't think that this should be a blocker issue. It's an annoying bug which crashes Sage, but it's not very likely to appear since the TAB completion is cashed.



---

archive/issue_events_317796.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-11-13T13:21:47Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "label": "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p: 1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22766#event-317796"
}
```



---

archive/issue_events_317797.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-11-13T13:21:47Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "label": "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p: 2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22766#event-317797"
}
```



---

archive/issue_comments_339045.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nI already mentioned in comment 9 above that even with the TAB cache present, one can get an annoying runtime error; to replicate, \n\n```\nsage: from sage.libs.ecl import <TAB>\n```\nand choose something from the list that pops up, then the following input leads to a runtime error.\n\n```\nsage: from sage.interfaces.maxima_lib import *\nCollecting from unknown thread\n---------------------------------------------------------------------------\nRuntimeError                              Traceback (most recent call last)\n<ipython-input-2-5e6d4a068396> in <module>()\n----> 1 from sage.interfaces.maxima_lib import *\n\n/home/dima/Sage/sage-dev/local/lib/python2.7/site-packages/sage/interfaces/maxima_lib.py in <module>()\n    102 ## i.e. loading it into ECL\n    103 ecl_eval(\"(setf *load-verbose* NIL)\")\n--> 104 ecl_eval(\"(require 'maxima)\")\n    105 ecl_eval(\"(in-package :maxima)\")\n    106 ecl_eval(\"(setq $nolabels t))\")\n\n/home/dima/Sage/sage-dev/src/sage/libs/ecl.pyx in sage.libs.ecl.ecl_eval (build/cythonized/sage/libs/ecl.c:10787)()\n   1320 \n   1321 #convenience routine to more easily evaluate strings\n-> 1322 cpdef EclObject ecl_eval(bytes s):\n   1323     \"\"\"\n   1324     Read and evaluate string in Lisp and return the result\n\n/home/dima/Sage/sage-dev/src/sage/libs/ecl.pyx in sage.libs.ecl.ecl_eval (build/cythonized/sage/libs/ecl.c:10726)()\n   1335     cdef cl_object o\n   1336     o=ecl_safe_read_string(s)\n-> 1337     o=ecl_safe_eval(o)\n   1338     return ecl_wrap(o)\n   1339 \n\n/home/dima/Sage/sage-dev/src/sage/libs/ecl.pyx in sage.libs.ecl.ecl_safe_eval (build/cythonized/sage/libs/ecl.c:5716)()\n    341     \"\"\"\n    342     cdef cl_object s\n--> 343     ecl_sig_on()\n    344     cl_funcall(2,safe_eval_clobj,form)\n    345     ecl_sig_off()\n\nRuntimeError: Aborted\n```\n\nOn the positive side, ipython folks are apparently going to disable tab completion in a separate thread, once a version of `prompt_toolkit` with the relevant option is released.",
    "created_at": "2017-11-13T14:24:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339045",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:36" align="right">comment:36</div>

I already mentioned in comment 9 above that even with the TAB cache present, one can get an annoying runtime error; to replicate, 

```
sage: from sage.libs.ecl import <TAB>
```
and choose something from the list that pops up, then the following input leads to a runtime error.

```
sage: from sage.interfaces.maxima_lib import *
Collecting from unknown thread
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
<ipython-input-2-5e6d4a068396> in <module>()
----> 1 from sage.interfaces.maxima_lib import *

/home/dima/Sage/sage-dev/local/lib/python2.7/site-packages/sage/interfaces/maxima_lib.py in <module>()
    102 ## i.e. loading it into ECL
    103 ecl_eval("(setf *load-verbose* NIL)")
--> 104 ecl_eval("(require 'maxima)")
    105 ecl_eval("(in-package :maxima)")
    106 ecl_eval("(setq $nolabels t))")

/home/dima/Sage/sage-dev/src/sage/libs/ecl.pyx in sage.libs.ecl.ecl_eval (build/cythonized/sage/libs/ecl.c:10787)()
   1320 
   1321 #convenience routine to more easily evaluate strings
-> 1322 cpdef EclObject ecl_eval(bytes s):
   1323     """
   1324     Read and evaluate string in Lisp and return the result

/home/dima/Sage/sage-dev/src/sage/libs/ecl.pyx in sage.libs.ecl.ecl_eval (build/cythonized/sage/libs/ecl.c:10726)()
   1335     cdef cl_object o
   1336     o=ecl_safe_read_string(s)
-> 1337     o=ecl_safe_eval(o)
   1338     return ecl_wrap(o)
   1339 

/home/dima/Sage/sage-dev/src/sage/libs/ecl.pyx in sage.libs.ecl.ecl_safe_eval (build/cythonized/sage/libs/ecl.c:5716)()
    341     """
    342     cdef cl_object s
--> 343     ecl_sig_on()
    344     cl_funcall(2,safe_eval_clobj,form)
    345     ecl_sig_off()

RuntimeError: Aborted
```

On the positive side, ipython folks are apparently going to disable tab completion in a separate thread, once a version of `prompt_toolkit` with the relevant option is released.



---

archive/issue_comments_339046.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nIt appears that this has nuked GAP pexpect interface, too:\nhitting Tab at\n`sage: gap.`\nleads to \n`Warning: this should never happen` printed ABOVE the line\n\n```\nsage: gap.\n```\n\nand Sage becomes irresponsive and has to be killed.\n(this is with Sage 8.2.beta5)",
    "created_at": "2018-02-17T09:07:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339046",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:37" align="right">comment:37</div>

It appears that this has nuked GAP pexpect interface, too:
hitting Tab at
`sage: gap.`
leads to 
`Warning: this should never happen` printed ABOVE the line

```
sage: gap.
```

and Sage becomes irresponsive and has to be killed.
(this is with Sage 8.2.beta5)



---

archive/issue_comments_339047.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nReplying to [@dimpase](#comment:37):\n> It appears that this has nuked GAP pexpect interface, too:\n> hitting Tab at\n> `sage: gap.`\n> leads to \n> `Warning: this should never happen` printed ABOVE the line\n> \n> ```\n> sage: gap.\n> ```\n> \n> and Sage becomes irresponsive and has to be killed.\n> (this is with Sage 8.2.beta5)\n\nThis doesn't happen to me with Sage 8.2.beta6, or maybe I don't understand the necessary steps. If I run Sage and then immediately run \"gap.<TAB>\", it works fine (OS X 10.13.3). Am I missing some aspect of triggering this?",
    "created_at": "2018-03-01T00:46:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339047",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:38" align="right">comment:38</div>

Replying to [@dimpase](#comment:37):
> It appears that this has nuked GAP pexpect interface, too:
> hitting Tab at
> `sage: gap.`
> leads to 
> `Warning: this should never happen` printed ABOVE the line
> 
> ```
> sage: gap.
> ```
> 
> and Sage becomes irresponsive and has to be killed.
> (this is with Sage 8.2.beta5)

This doesn't happen to me with Sage 8.2.beta6, or maybe I don't understand the necessary steps. If I run Sage and then immediately run "gap.<TAB>", it works fine (OS X 10.13.3). Am I missing some aspect of triggering this?



---

archive/issue_comments_339048.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nConfirmed that `gap.` works on OpenSuSE with beta6. But `maxima_lib.` as in the ticket description still crashes.",
    "created_at": "2018-03-01T06:26:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339048",
    "user": "https://github.com/rwst"
}
```

<div id="comment:39" align="right">comment:39</div>

Confirmed that `gap.` works on OpenSuSE with beta6. But `maxima_lib.` as in the ticket description still crashes.



---

archive/issue_comments_339049.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nMoreover if I `rm -f ~/.sage/giac_commandlist_cache.sobj` then `giac.<TAB>` does not crash. Probably the peculiar properties of ECL make maxima a special case.",
    "created_at": "2018-03-01T06:31:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339049",
    "user": "https://github.com/rwst"
}
```

<div id="comment:40" align="right">comment:40</div>

Moreover if I `rm -f ~/.sage/giac_commandlist_cache.sobj` then `giac.<TAB>` does not crash. Probably the peculiar properties of ECL make maxima a special case.



---

archive/issue_comments_339050.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\nReplying to [@rwst](#comment:39):\n> Confirmed that `gap.` works on OpenSuSE with beta6. But `maxima_lib.` as in the ticket description still crashes.\n\nSorry, it appears that in case of `gap.` I have been barking up the wrong tree.",
    "created_at": "2018-03-01T10:19:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339050",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:41" align="right">comment:41</div>

Replying to [@rwst](#comment:39):
> Confirmed that `gap.` works on OpenSuSE with beta6. But `maxima_lib.` as in the ticket description still crashes.

Sorry, it appears that in case of `gap.` I have been barking up the wrong tree.



---

archive/issue_events_317798.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-04-11T13:30:18Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "milestone_number": null,
    "milestone_title": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22766#event-317798"
}
```



---

archive/issue_events_317799.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-04-11T13:30:18Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "label": "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p: 2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22766#event-317799"
}
```



---

archive/issue_events_317800.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-04-11T13:30:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "label": "https://github.com/sagemath/sage/labels/invalid",
    "label_color": "a6a6a6",
    "label_name": "invalid",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22766#event-317800"
}
```



---

archive/issue_events_317801.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-04-11T13:30:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22766#event-317801"
}
```



---

archive/issue_comments_339051.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nall is good in Sage 9.3.rc1",
    "created_at": "2021-04-11T13:30:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339051",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:42" align="right">comment:42</div>

all is good in Sage 9.3.rc1



---

archive/issue_comments_339052.json:
```json
{
    "body": "Reviewer: **Dima Pasechnik**",
    "created_at": "2021-04-11T13:30:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22766#issuecomment-339052",
    "user": "https://github.com/dimpase"
}
```

Reviewer: **Dima Pasechnik**



---

archive/issue_events_317802.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-04-11T13:30:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22766#event-317802"
}
```



---

archive/issue_events_317803.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-04-11T13:30:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22766#event-317803"
}
```



---

archive/issue_events_317804.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-06-24T20:15:37Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22766#event-317804"
}
```



---

archive/issue_events_317805.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-06-24T20:15:37Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/22766",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22766#event-317805"
}
```
