# Issue 22626: Upgrade to GAP 4.10

archive/issues_022389.json:
```json
{
    "body": "GAP 4.10 comes with a completely rewritten build system that will simplify\nour packaging. In particular, libGAP no longer needs to be a separate package.\n\nWhat the branch does:\n\n- Remove the libgap spkg\n\n- Update the gap spkg to the new build system and build and install libgap\n\n- Replace `gap.shi.patch` by a plain gap startup script for Sage\n\n  Rationale: GAP used to provide a startup shell script. The GAP devs\n  are in the process of getting rid of it and provide a very minimal\n  one. They recommend to just write our own rather than patching it.\n\n- Update a few doctests w.r.t. changes of output of some GAP functions\n\n- Reworks how gap is installed in `$SAGE_LOCAL`: Rather than installing the entire source tree we just install the `gap` and `libgap` binaries to standard locations, and add a `$SAGE_LOCAL/share/gap` containing the `GAP_ROOT_DIR` which is stripped down to the minimum needed for GAP to work (standard libs and packages, docs, as well as the source code for introspection of kernel functions, but all build artifacts are carefully omitted).\n\n  - Some of how this is done is still broken w.r.t. building compiled packages; need to work on it a bit more.\n\n- - **Possibly controversial:** The new libgap currently 'does not come' with symbol rewriting (`foobar` -> `libGAP_foobar`). This avoids messing around with GAP's sources; in particular opening the door for using a stock GAP from the OS distribution. However there always is a risk of name conflicts. And indeed, GAP's enums `T_INT`, `T_FLOAT`, ... conflict with Python's constants defined in `structmember.h`. This is hopefully not actually a problem in practice due to the way how Cython orders includes.\n\n  Something similar was started by Volker at #19915.\n\n- Removes configure.patch: it was patching configure for better GMP\n  detection under Cygwin (#13954). This should not be needed anymore\n  with the new build system and use of --with-gmp. If it is, upstream\n  asked for it to be reported and they will fix it.\n\n- Removes additional patches for now--we would like to focus on being\n  able to work with a system GAP as much as possible.\n\n- Revert #19726 (not needed anymore)\n\n### Status\nCurrently broken - crashes deep inside GAP error handling system after few simple commands. \n\nBasic tests on libgap:\n\n```\nsage: libgap.eval(\"GAPInfo.Version\")\nsage: libgap.DihedralGroup(10).CharacterTable()\nCharacterTable( <pc group of size 10 with 2 generators> )\nsage: libgap.Group(libgap.eval(\"[(1,2,3),(1,2)]\")).Size()\n6\n```\n\nRunning most relevant tests:\n\n```\nsage -tp 8 sage/groups sage/libs/gap\n```\nCurrent status: lots of errors\n\n- Still have some miscellaneous segfaults and other weird crashes\n\n- Still have work to do on improving error handling; replacing the built-in `ErrorInner` function might help here.\n\n- SIGINT handling by Python is broken by `GAP_Intialize`; need to work around this.\n\nTesting packages with dynamic loading (e.g. IO):\n\nInstall IO:\n\n```\ncd $SAGE_LOCAL/share/gap/pkg\nwget https://www.gap-system.org/pub/gap/gap4/tar.gz/packages/io-4.5.4.tar.gz\ntar xvf io-4.5.4.tar.gz\ncd io-4.5.4\n./configure --with-gaproot=../..\nmake\n```\n\nTest it locally:\n\n```\ncd $SAGE_ROOT\ngap\ngap> LoadPackage(\"IO\");\ntrue\n```\n\nThis does not yet work:\n\n```\n#W dlopen() error: /home/embray/src/sagemath/sage/local/share/gap/pkg/io-4.5.4/bin/x86_64-pc-linux-gnu-default64/io.so: undefine\\\nd symbol: ChangedBags\nError, module '/home/embray/src/sagemath/sage/local/share/gap/pkg/io-4.5.4/bin/x86_64-pc-linux-gnu-default64/io.so' not found\nError, was not in any namespace\nSyntax warning: Unbound global variable in /home/embray/src/sagemath/sage/local/share/gap/lib/init.g:803\n    ColorPrompt( UserPreference( \"UseColorPrompt\" ) );\n               ^\nError, SetGasmanMessageStatus: function is not yet defined\ntrue\n```\nThis should be fixed once GAP's gap binary is built on top of libgap.\nSee: https://github.com/markuspf/gap/issues/1 I believe this is fixed, but there are still some problems with the way this ticket is \"installing\" GAP for `$SAGE_LOCAL`.\n\nNote:\n\n- Max Horn reviewed the list of GAP symbols we use in Sage; some have already changed in 4.9. See this [pad](https://hackmd.io/emNi76svSWCh1fBeLKqPdA?edit#) for notes.\n\n\n### Upstream PRs\n\nA few pull requests we made to improve use of GAP as a library:\n\n* https://github.com/gap-system/gap/pull/3043\n* https://github.com/gap-system/gap/pull/3072\n* https://github.com/gap-system/gap/pull/3096\n* https://github.com/gap-system/gap/pull/3102\n\nOther open issues that don't have PRs yet:\n\n* https://github.com/gap-system/gap/issues/3089\n* https://github.com/gap-system/gap/issues/3030\n* https://github.com/gap-system/gap/issues/3028\n\nSome other PRs useful to this effort:\n\n* https://github.com/gap-system/gap/pull/3065\n* https://github.com/gap-system/gap/pull/2952\n\nThe update of gap_packages and database_gap is on #26856\n\n**Tarball**: https://www.gap-system.org/pub/gap/gap-4.10/tar.gz/gap-4.10.0.tar.gz\n\n**CC:**  alexk @dimpase @embray @kiwifb @antonio-rojas @sebasguts jpflori markuspf @nthiery @slel @vbraun wstein @timokau\n\n**Keywords:** days85, libgap\n\n**Branch:** [b446ebb496d45c4408aa949f98f855f962d9388a](https://github.com/sagemath/sagetrac-mirror/commit/b446ebb496d45c4408aa949f98f855f962d9388a)\n\n**Stopgaps:** error handling in libgap, documentation display\n\n**Reviewer:** Erik Bray, Dima Pasechnik,  Jeroen Demeyer\n\n**Author:** Nicolas M. Thi\u00e9ry, Dima Pasechnik, Erik Bray, Jeroen Demeyer\n\n**Dependencies:** #26874\n\n**Resolution:** fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/22626\n\n",
    "closed_at": "2018-12-23T23:40:57Z",
    "created_at": "2017-03-16T22:41:33Z",
    "labels": [
        "component: interfaces",
        "critical"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.6",
    "title": "Upgrade to GAP 4.10",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22626",
    "user": "https://github.com/nthiery"
}
```
GAP 4.10 comes with a completely rewritten build system that will simplify
our packaging. In particular, libGAP no longer needs to be a separate package.

What the branch does:

- Remove the libgap spkg

- Update the gap spkg to the new build system and build and install libgap

- Replace `gap.shi.patch` by a plain gap startup script for Sage

  Rationale: GAP used to provide a startup shell script. The GAP devs
  are in the process of getting rid of it and provide a very minimal
  one. They recommend to just write our own rather than patching it.

- Update a few doctests w.r.t. changes of output of some GAP functions

- Reworks how gap is installed in `$SAGE_LOCAL`: Rather than installing the entire source tree we just install the `gap` and `libgap` binaries to standard locations, and add a `$SAGE_LOCAL/share/gap` containing the `GAP_ROOT_DIR` which is stripped down to the minimum needed for GAP to work (standard libs and packages, docs, as well as the source code for introspection of kernel functions, but all build artifacts are carefully omitted).

  - Some of how this is done is still broken w.r.t. building compiled packages; need to work on it a bit more.

- - **Possibly controversial:** The new libgap currently 'does not come' with symbol rewriting (`foobar` -> `libGAP_foobar`). This avoids messing around with GAP's sources; in particular opening the door for using a stock GAP from the OS distribution. However there always is a risk of name conflicts. And indeed, GAP's enums `T_INT`, `T_FLOAT`, ... conflict with Python's constants defined in `structmember.h`. This is hopefully not actually a problem in practice due to the way how Cython orders includes.

  Something similar was started by Volker at #19915.

- Removes configure.patch: it was patching configure for better GMP
  detection under Cygwin (#13954). This should not be needed anymore
  with the new build system and use of --with-gmp. If it is, upstream
  asked for it to be reported and they will fix it.

- Removes additional patches for now--we would like to focus on being
  able to work with a system GAP as much as possible.

- Revert #19726 (not needed anymore)

### Status
Currently broken - crashes deep inside GAP error handling system after few simple commands. 

Basic tests on libgap:

```
sage: libgap.eval("GAPInfo.Version")
sage: libgap.DihedralGroup(10).CharacterTable()
CharacterTable( <pc group of size 10 with 2 generators> )
sage: libgap.Group(libgap.eval("[(1,2,3),(1,2)]")).Size()
6
```

Running most relevant tests:

```
sage -tp 8 sage/groups sage/libs/gap
```
Current status: lots of errors

- Still have some miscellaneous segfaults and other weird crashes

- Still have work to do on improving error handling; replacing the built-in `ErrorInner` function might help here.

- SIGINT handling by Python is broken by `GAP_Intialize`; need to work around this.

Testing packages with dynamic loading (e.g. IO):

Install IO:

```
cd $SAGE_LOCAL/share/gap/pkg
wget https://www.gap-system.org/pub/gap/gap4/tar.gz/packages/io-4.5.4.tar.gz
tar xvf io-4.5.4.tar.gz
cd io-4.5.4
./configure --with-gaproot=../..
make
```

Test it locally:

```
cd $SAGE_ROOT
gap
gap> LoadPackage("IO");
true
```

This does not yet work:

```
#W dlopen() error: /home/embray/src/sagemath/sage/local/share/gap/pkg/io-4.5.4/bin/x86_64-pc-linux-gnu-default64/io.so: undefine\
d symbol: ChangedBags
Error, module '/home/embray/src/sagemath/sage/local/share/gap/pkg/io-4.5.4/bin/x86_64-pc-linux-gnu-default64/io.so' not found
Error, was not in any namespace
Syntax warning: Unbound global variable in /home/embray/src/sagemath/sage/local/share/gap/lib/init.g:803
    ColorPrompt( UserPreference( "UseColorPrompt" ) );
               ^
Error, SetGasmanMessageStatus: function is not yet defined
true
```
This should be fixed once GAP's gap binary is built on top of libgap.
See: https://github.com/markuspf/gap/issues/1 I believe this is fixed, but there are still some problems with the way this ticket is "installing" GAP for `$SAGE_LOCAL`.

Note:

- Max Horn reviewed the list of GAP symbols we use in Sage; some have already changed in 4.9. See this [pad](https://hackmd.io/emNi76svSWCh1fBeLKqPdA?edit#) for notes.


### Upstream PRs

A few pull requests we made to improve use of GAP as a library:

* https://github.com/gap-system/gap/pull/3043
* https://github.com/gap-system/gap/pull/3072
* https://github.com/gap-system/gap/pull/3096
* https://github.com/gap-system/gap/pull/3102

Other open issues that don't have PRs yet:

* https://github.com/gap-system/gap/issues/3089
* https://github.com/gap-system/gap/issues/3030
* https://github.com/gap-system/gap/issues/3028

Some other PRs useful to this effort:

* https://github.com/gap-system/gap/pull/3065
* https://github.com/gap-system/gap/pull/2952

The update of gap_packages and database_gap is on #26856

**Tarball**: https://www.gap-system.org/pub/gap/gap-4.10/tar.gz/gap-4.10.0.tar.gz

**CC:**  alexk @dimpase @embray @kiwifb @antonio-rojas @sebasguts jpflori markuspf @nthiery @slel @vbraun wstein @timokau

**Keywords:** days85, libgap

**Branch:** [b446ebb496d45c4408aa949f98f855f962d9388a](https://github.com/sagemath/sagetrac-mirror/commit/b446ebb496d45c4408aa949f98f855f962d9388a)

**Stopgaps:** error handling in libgap, documentation display

**Reviewer:** Erik Bray, Dima Pasechnik,  Jeroen Demeyer

**Author:** Nicolas M. Thi√©ry, Dima Pasechnik, Erik Bray, Jeroen Demeyer

**Dependencies:** #26874

**Resolution:** fixed

Issue created by migration from https://trac.sagemath.org/ticket/22626





---

archive/issue_comments_423161.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -3,9 +3,34 @@\n so that we can get rid of our separate libgap package.\n \n The branch to be attached to this ticket is a preliminary experiment\n-from a fork of Markus to be merged in the devel version of GAP.\n+from a fork by Markus to be merged in the devel version of GAP.\n \n-Fetching the Markus's GAP sources:\n+\n+What the branch does:\n+- Remove the libgap spkg\n+\n+- Update the gap spkg to the new build system and build and install libgap\n+\n+- Replace gap.shi.patch by a plain gap startup script for Sage\n+\n+  Rationale: GAP used to provide a startup shell script. The GAP devs\n+  are in the process of getting rid of it and provide a very minimal\n+  one. They recommend to just write our own rather than patching it.\n+\n+- Update a few doctests w.r.t. changes of output of some GAP functions\n+\n+- ???\n+\n+TODO:\n+\n+- Automatic handling of headers (see below for how to do it by hand).\n+  GAP's build system will eventuall provide a rule to install headers\n+  which will make this trivial.\n+\n+- Use GAP's own `make install` when it will be implemented.\n+\n+\n+Fetching Markus's GAP sources:\n \n ```\n     git clone git@github.com:markuspf/gap.git $LIBGAP\n@@ -42,9 +67,10 @@\n     sage -f gap                      # -s\n ```\n \n-Copy GAP's header files, as well as gen/config.h to $SAGE/local/include\n-\n-Fix them to adapt the include path: #include <src/...> -> #include <gap/...>\n+Header files:\n+- Copy GAP's header files, as well as gen/config.h to $SAGE/local/include\n+- Fix them to adapt the include path: #include <src/...> -> #include <gap/...>\n+- **Replace T_INT by 0 in TNUM_OBJ, around line 414 of objects.h**\n \n Run:\n \n@@ -52,3 +78,52 @@\n     sage -b\n ```\n \n+Basic tests on libgap:\n+\n+```\n+    sage: libgap.eval(\"GAPInfo.Version\")\n+    sage: libgap.DihedralGroup(10).CharacterTable()\n+    CharacterTable( <pc group of size 10 with 2 generators> )\n+    sage: libgap.Group(libgap.eval(\"[(1,2,3),(1,2)]\")).Size()\n+    6\n+```\n+\n+Running most relevant tests:\n+\n+```\n+    sage -tp 8 sage/groups sage/libs/gap\n+```\n+Current status: all tests pass!\n+\n+Testing packages with dynamic loading (e.g. IO):\n+\n+Install IO:\n+\n+```\n+    cd $SAGE/local/gap/latest/pkg\n+    wget http://www.gap-system.org/pub/gap/gap4/tar.gz/packages/io-4.4.6.tar.gz\n+    tar xvf /tmp/io-4.4.6.tar.gz\n+    mv io-4.4.6 io\n+    cd io\n+    ./configure\n+    make\n+```\n+\n+Test it locally:\n+\n+```\n+    cd ../..\n+    ./gap -l .\n+    gap> LoadPackage(\"IO\");\n+    true\n+```\n+\n+This does not yet work:\n+\n+```\n+    sage: libgap.LoadPackage(\"IO\")\n+    ValueError: libGAP: Error, module '/opt/sage-git/local/gap/latest/pkg/io/bin/x86_64-pc-linux-gnu-gcc-default64/io.so' not found\n+```\n+This should be fixed once GAP's gap binary is built on top of libgap.\n+See: https://github.com/markuspf/gap/issues/1.\n+\n``````\n",
    "created_at": "2017-03-16T22:55:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423161",
    "user": "https://github.com/nthiery"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -3,9 +3,34 @@
 so that we can get rid of our separate libgap package.
 
 The branch to be attached to this ticket is a preliminary experiment
-from a fork of Markus to be merged in the devel version of GAP.
+from a fork by Markus to be merged in the devel version of GAP.
 
-Fetching the Markus's GAP sources:
+
+What the branch does:
+- Remove the libgap spkg
+
+- Update the gap spkg to the new build system and build and install libgap
+
+- Replace gap.shi.patch by a plain gap startup script for Sage
+
+  Rationale: GAP used to provide a startup shell script. The GAP devs
+  are in the process of getting rid of it and provide a very minimal
+  one. They recommend to just write our own rather than patching it.
+
+- Update a few doctests w.r.t. changes of output of some GAP functions
+
+- ???
+
+TODO:
+
+- Automatic handling of headers (see below for how to do it by hand).
+  GAP's build system will eventuall provide a rule to install headers
+  which will make this trivial.
+
+- Use GAP's own `make install` when it will be implemented.
+
+
+Fetching Markus's GAP sources:
 
 ```
     git clone git@github.com:markuspf/gap.git $LIBGAP
@@ -42,9 +67,10 @@
     sage -f gap                      # -s
 ```
 
-Copy GAP's header files, as well as gen/config.h to $SAGE/local/include
-
-Fix them to adapt the include path: #include <src/...> -> #include <gap/...>
+Header files:
+- Copy GAP's header files, as well as gen/config.h to $SAGE/local/include
+- Fix them to adapt the include path: #include <src/...> -> #include <gap/...>
+- **Replace T_INT by 0 in TNUM_OBJ, around line 414 of objects.h**
 
 Run:
 
@@ -52,3 +78,52 @@
     sage -b
 ```
 
+Basic tests on libgap:
+
+```
+    sage: libgap.eval("GAPInfo.Version")
+    sage: libgap.DihedralGroup(10).CharacterTable()
+    CharacterTable( <pc group of size 10 with 2 generators> )
+    sage: libgap.Group(libgap.eval("[(1,2,3),(1,2)]")).Size()
+    6
+```
+
+Running most relevant tests:
+
+```
+    sage -tp 8 sage/groups sage/libs/gap
+```
+Current status: all tests pass!
+
+Testing packages with dynamic loading (e.g. IO):
+
+Install IO:
+
+```
+    cd $SAGE/local/gap/latest/pkg
+    wget http://www.gap-system.org/pub/gap/gap4/tar.gz/packages/io-4.4.6.tar.gz
+    tar xvf /tmp/io-4.4.6.tar.gz
+    mv io-4.4.6 io
+    cd io
+    ./configure
+    make
+```
+
+Test it locally:
+
+```
+    cd ../..
+    ./gap -l .
+    gap> LoadPackage("IO");
+    true
+```
+
+This does not yet work:
+
+```
+    sage: libgap.LoadPackage("IO")
+    ValueError: libGAP: Error, module '/opt/sage-git/local/gap/latest/pkg/io/bin/x86_64-pc-linux-gnu-gcc-default64/io.so' not found
+```
+This should be fixed once GAP's gap binary is built on top of libgap.
+See: https://github.com/markuspf/gap/issues/1.
+
``````




---

archive/issue_comments_423162.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -18,6 +18,16 @@\n   one. They recommend to just write our own rather than patching it.\n \n - Update a few doctests w.r.t. changes of output of some GAP functions\n+\n+- **Possibly controversial:** The new libgap currently *does not come*\n+  with symbol rewriting (Foo -> libGAP_Foo). This avoids messing\n+  around with GAP's sources; in particular opening the door for using\n+  a stock GAP from the OS distribution. However there always is a risk\n+  of name conflict. And indeed, GAP's constants (actually cpp macros)\n+  T_INT, T_FLOAT, ... conflict with Python's constants. This is worked\n+  around by duplicating and forcing their value in gap_include.pxd.\n+  Another conflict in objects.h currently needs to be workedaround by\n+  hand (see below).\n \n - ???\n \n``````\n",
    "created_at": "2017-03-16T23:00:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423162",
    "user": "https://github.com/nthiery"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -18,6 +18,16 @@
   one. They recommend to just write our own rather than patching it.
 
 - Update a few doctests w.r.t. changes of output of some GAP functions
+
+- **Possibly controversial:** The new libgap currently *does not come*
+  with symbol rewriting (Foo -> libGAP_Foo). This avoids messing
+  around with GAP's sources; in particular opening the door for using
+  a stock GAP from the OS distribution. However there always is a risk
+  of name conflict. And indeed, GAP's constants (actually cpp macros)
+  T_INT, T_FLOAT, ... conflict with Python's constants. This is worked
+  around by duplicating and forcing their value in gap_include.pxd.
+  Another conflict in objects.h currently needs to be workedaround by
+  hand (see below).
 
 - ???
 
``````




---

archive/issue_comments_423163.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -26,7 +26,7 @@\n   of name conflict. And indeed, GAP's constants (actually cpp macros)\n   T_INT, T_FLOAT, ... conflict with Python's constants. This is worked\n   around by duplicating and forcing their value in gap_include.pxd.\n-  Another conflict in objects.h currently needs to be workedaround by\n+  Another conflict in objects.h currently needs to be worked around by\n   hand (see below).\n \n - ???\n``````\n",
    "created_at": "2017-03-16T23:01:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423163",
    "user": "https://github.com/nthiery"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -26,7 +26,7 @@
   of name conflict. And indeed, GAP's constants (actually cpp macros)
   T_INT, T_FLOAT, ... conflict with Python's constants. This is worked
   around by duplicating and forcing their value in gap_include.pxd.
-  Another conflict in objects.h currently needs to be workedaround by
+  Another conflict in objects.h currently needs to be worked around by
   hand (see below).
 
 - ???
``````




---

archive/issue_comments_423164.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -39,6 +39,8 @@\n \n - Use GAP's own `make install` when it will be implemented.\n \n+- Update the documentation in sage.libs.gap.libgap.pyx to not mention\n+  the `libgap_` prefix\n \n Fetching Markus's GAP sources:\n \n``````\n",
    "created_at": "2017-03-16T23:05:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423164",
    "user": "https://github.com/nthiery"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -39,6 +39,8 @@
 
 - Use GAP's own `make install` when it will be implemented.
 
+- Update the documentation in sage.libs.gap.libgap.pyx to not mention
+  the `libgap_` prefix
 
 Fetching Markus's GAP sources:
 
``````




---

archive/issue_comments_423165.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -28,6 +28,11 @@\n   around by duplicating and forcing their value in gap_include.pxd.\n   Another conflict in objects.h currently needs to be worked around by\n   hand (see below).\n+\n+- Removes configure.patch: it was patching configure for better GMP\n+  detection under Cygwin (#13954). This should not be needed anymore\n+  with the new build system and use of --with-gmp. If it is, upstream\n+  asked for it to be reported and they will fix it.\n \n - ???\n \n``````\n",
    "created_at": "2017-03-16T23:30:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423165",
    "user": "https://github.com/nthiery"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -28,6 +28,11 @@
   around by duplicating and forcing their value in gap_include.pxd.
   Another conflict in objects.h currently needs to be worked around by
   hand (see below).
+
+- Removes configure.patch: it was patching configure for better GMP
+  detection under Cygwin (#13954). This should not be needed anymore
+  with the new build system and use of --with-gmp. If it is, upstream
+  asked for it to be reported and they will fix it.
 
 - ???
 
``````




---

archive/issue_comments_423166.json:
```json
{
    "body": "**Branch:** [u/nthiery/upgrade_to_gap_4_9](https://github.com/sagemath/sagetrac-mirror/tree/u/nthiery/upgrade_to_gap_4_9)",
    "created_at": "2017-03-16T23:39:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423166",
    "user": "https://github.com/nthiery"
}
```

**Branch:** [u/nthiery/upgrade_to_gap_4_9](https://github.com/sagemath/sagetrac-mirror/tree/u/nthiery/upgrade_to_gap_4_9)



---

archive/issue_comments_423167.json:
```json
{
    "body": "<a id='comment:7'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1c645e0c73fdf4d43012e9e355fa6d58a9cb7ae2\">1c645e0</a></td><td><code>#22626: remove GAP's symbol prefixing in libgap: libGAP_Foo -> Foo</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1ecc67b401783220abfa8c8f2d27e5a2d0f81753\">1ecc67b</a></td><td><code>#22626: doctest update w.r.t. minor changes of output in GAP</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e8ebbcae28e3522095fa85b80c7d6c5ebe96feea\">e8ebbca</a></td><td><code>#22626: GMP detection patch for cygwin should not be needed anymore</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/fd65b06224cb81911a783e8765fc0fafc7178ab9\">fd65b06</a></td><td><code>#22626: Remove libgap spkg</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9511733798f125bd3c6a1fdeb89d0e7db40d1454\">9511733</a></td><td><code>#22626: replace patch for GAP's startup script template in favor of a custom script</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/550625ec6aeab76b3777f24be898c265651ac33f\">550625e</a></td><td><code>#22626: remove GAP's symbol prefixing in libgap: libGAP_Foo -> Foo, and workaround GAP <-> Python symbol conflict</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a9c859c59018f274cf744e8a0557d499a1ee6dc3\">a9c859c</a></td><td><code>#22626: updated gap spkg w.r.t. GAP's devel version and its new build system; also include compilation and installation of libgap</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3011ac0908d667c0f245ca21859e336511106b5f\">3011ac0</a></td><td><code>Merge branch 'develop' into t/22626/upgrade_to_gap_4_9</code></td></tr></table>\n",
    "created_at": "2017-03-16T23:48:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423167",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1c645e0c73fdf4d43012e9e355fa6d58a9cb7ae2">1c645e0</a></td><td><code>#22626: remove GAP's symbol prefixing in libgap: libGAP_Foo -> Foo</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1ecc67b401783220abfa8c8f2d27e5a2d0f81753">1ecc67b</a></td><td><code>#22626: doctest update w.r.t. minor changes of output in GAP</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e8ebbcae28e3522095fa85b80c7d6c5ebe96feea">e8ebbca</a></td><td><code>#22626: GMP detection patch for cygwin should not be needed anymore</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/fd65b06224cb81911a783e8765fc0fafc7178ab9">fd65b06</a></td><td><code>#22626: Remove libgap spkg</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9511733798f125bd3c6a1fdeb89d0e7db40d1454">9511733</a></td><td><code>#22626: replace patch for GAP's startup script template in favor of a custom script</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/550625ec6aeab76b3777f24be898c265651ac33f">550625e</a></td><td><code>#22626: remove GAP's symbol prefixing in libgap: libGAP_Foo -> Foo, and workaround GAP <-> Python symbol conflict</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a9c859c59018f274cf744e8a0557d499a1ee6dc3">a9c859c</a></td><td><code>#22626: updated gap spkg w.r.t. GAP's devel version and its new build system; also include compilation and installation of libgap</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3011ac0908d667c0f245ca21859e336511106b5f">3011ac0</a></td><td><code>Merge branch 'develop' into t/22626/upgrade_to_gap_4_9</code></td></tr></table>




---

archive/issue_comments_423168.json:
```json
{
    "body": "**Commit:** [3011ac0908d667c0f245ca21859e336511106b5f](https://github.com/sagemath/sagetrac-mirror/commit/3011ac0908d667c0f245ca21859e336511106b5f)",
    "created_at": "2017-03-16T23:48:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423168",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Commit:** [3011ac0908d667c0f245ca21859e336511106b5f](https://github.com/sagemath/sagetrac-mirror/commit/3011ac0908d667c0f245ca21859e336511106b5f)



---

archive/issue_comments_423169.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,9 +1,12 @@\n GAP 4.9 will come with a completely rewritten build system that will\n-simplify our packaging. It will also enable building GAP as a library,\n-so that we can get rid of our separate libgap package.\n+simplify our packaging. In fact, it may well enable Sage to use a vanilla GAP installation as provided by the distribution. It will also enable building GAP as a library, so that we can get rid of our separate libgap package.\n \n-The branch to be attached to this ticket is a preliminary experiment\n-from a fork by Markus to be merged in the devel version of GAP.\n+The branch attached to this ticket updates Sage to run on top of\n+[a branch of GAP](https://github.com/markuspf/gap/tree/hpc-merge-libgap)\n+by Markus Pfeiffer that adds libgap compilation and will merged soon\n+in the devel version of GAP.\n+\n+Tentatively, all tests pass!\n \n \n What the branch does:\n``````\n",
    "created_at": "2017-03-17T08:59:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423169",
    "user": "https://github.com/nthiery"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,9 +1,12 @@
 GAP 4.9 will come with a completely rewritten build system that will
-simplify our packaging. It will also enable building GAP as a library,
-so that we can get rid of our separate libgap package.
+simplify our packaging. In fact, it may well enable Sage to use a vanilla GAP installation as provided by the distribution. It will also enable building GAP as a library, so that we can get rid of our separate libgap package.
 
-The branch to be attached to this ticket is a preliminary experiment
-from a fork by Markus to be merged in the devel version of GAP.
+The branch attached to this ticket updates Sage to run on top of
+[a branch of GAP](https://github.com/markuspf/gap/tree/hpc-merge-libgap)
+by Markus Pfeiffer that adds libgap compilation and will merged soon
+in the devel version of GAP.
+
+Tentatively, all tests pass!
 
 
 What the branch does:
``````




---

archive/issue_comments_423170.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -3,7 +3,7 @@\n \n The branch attached to this ticket updates Sage to run on top of\n [a branch of GAP](https://github.com/markuspf/gap/tree/hpc-merge-libgap)\n-by Markus Pfeiffer that adds libgap compilation and will merged soon\n+by Markus Pfeiffer that adds libgap compilation and will be merged soon\n in the devel version of GAP.\n \n Tentatively, all tests pass!\n``````\n",
    "created_at": "2017-03-17T09:00:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423170",
    "user": "https://github.com/nthiery"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -3,7 +3,7 @@
 
 The branch attached to this ticket updates Sage to run on top of
 [a branch of GAP](https://github.com/markuspf/gap/tree/hpc-merge-libgap)
-by Markus Pfeiffer that adds libgap compilation and will merged soon
+by Markus Pfeiffer that adds libgap compilation and will be merged soon
 in the devel version of GAP.
 
 Tentatively, all tests pass!
``````




---

archive/issue_comments_423171.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -3,7 +3,7 @@\n \n The branch attached to this ticket updates Sage to run on top of\n [a branch of GAP](https://github.com/markuspf/gap/tree/hpc-merge-libgap)\n-by Markus Pfeiffer that adds libgap compilation and will be merged soon\n+by Markus Pfeiffer that adds libgap compilation and [|will be merged](https://github.com/fingolfin/gap/pull/64) soon\n in the devel version of GAP.\n \n Tentatively, all tests pass!\n``````\n",
    "created_at": "2017-03-17T09:03:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423171",
    "user": "https://github.com/nthiery"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -3,7 +3,7 @@
 
 The branch attached to this ticket updates Sage to run on top of
 [a branch of GAP](https://github.com/markuspf/gap/tree/hpc-merge-libgap)
-by Markus Pfeiffer that adds libgap compilation and will be merged soon
+by Markus Pfeiffer that adds libgap compilation and [|will be merged](https://github.com/fingolfin/gap/pull/64) soon
 in the devel version of GAP.
 
 Tentatively, all tests pass!
``````




---

archive/issue_comments_423172.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -45,7 +45,7 @@\n   GAP's build system will eventuall provide a rule to install headers\n   which will make this trivial.\n \n-- Use GAP's own `make install` when it will be implemented.\n+- Use GAP's own `make install` [when it will be implemented](https://github.com/fingolfin/gap/issues/44).\n \n - Update the documentation in sage.libs.gap.libgap.pyx to not mention\n   the `libgap_` prefix\n``````\n",
    "created_at": "2017-03-17T09:06:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423172",
    "user": "https://github.com/nthiery"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -45,7 +45,7 @@
   GAP's build system will eventuall provide a rule to install headers
   which will make this trivial.
 
-- Use GAP's own `make install` when it will be implemented.
+- Use GAP's own `make install` [when it will be implemented](https://github.com/fingolfin/gap/issues/44).
 
 - Update the documentation in sage.libs.gap.libgap.pyx to not mention
   the `libgap_` prefix
``````




---

archive/issue_comments_423173.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -30,14 +30,12 @@\n   T_INT, T_FLOAT, ... conflict with Python's constants. This is worked\n   around by duplicating and forcing their value in gap_include.pxd.\n   Another conflict in objects.h currently needs to be worked around by\n-  hand (see below).\n+  hand (see below). Something similar was started at #19915.\n \n - Removes configure.patch: it was patching configure for better GMP\n   detection under Cygwin (#13954). This should not be needed anymore\n   with the new build system and use of --with-gmp. If it is, upstream\n   asked for it to be reported and they will fix it.\n-\n-- ???\n \n TODO:\n \n@@ -49,6 +47,11 @@\n \n - Update the documentation in sage.libs.gap.libgap.pyx to not mention\n   the `libgap_` prefix\n+\n+- Check against #19915 to see if any of the changes there should be\n+  ported here. Then close as won't fix.\n+\n+- ???\n \n Fetching Markus's GAP sources:\n \n``````\n",
    "created_at": "2017-03-17T09:59:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423173",
    "user": "https://github.com/nthiery"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -30,14 +30,12 @@
   T_INT, T_FLOAT, ... conflict with Python's constants. This is worked
   around by duplicating and forcing their value in gap_include.pxd.
   Another conflict in objects.h currently needs to be worked around by
-  hand (see below).
+  hand (see below). Something similar was started at #19915.
 
 - Removes configure.patch: it was patching configure for better GMP
   detection under Cygwin (#13954). This should not be needed anymore
   with the new build system and use of --with-gmp. If it is, upstream
   asked for it to be reported and they will fix it.
-
-- ???
 
 TODO:
 
@@ -49,6 +47,11 @@
 
 - Update the documentation in sage.libs.gap.libgap.pyx to not mention
   the `libgap_` prefix
+
+- Check against #19915 to see if any of the changes there should be
+  ported here. Then close as won't fix.
+
+- ???
 
 Fetching Markus's GAP sources:
 
``````




---

archive/issue_comments_423174.json:
```json
{
    "body": "**Work_Issues:** Wait for gap 4.9 release",
    "created_at": "2017-03-17T10:00:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423174",
    "user": "https://github.com/nthiery"
}
```

**Work_Issues:** Wait for gap 4.9 release



---

archive/issue_comments_423175.json:
```json
{
    "body": "**Changing keywords** from \"\" to \"days85, libgap\".",
    "created_at": "2017-03-17T10:00:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423175",
    "user": "https://github.com/nthiery"
}
```

**Changing keywords** from "" to "days85, libgap".



---

archive/issue_comments_423176.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -36,6 +36,8 @@\n   detection under Cygwin (#13954). This should not be needed anymore\n   with the new build system and use of --with-gmp. If it is, upstream\n   asked for it to be reported and they will fix it.\n+\n+- Revert #19726 (not needed anymore)\n \n TODO:\n \n``````\n",
    "created_at": "2017-03-17T10:25:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423176",
    "user": "https://github.com/nthiery"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -36,6 +36,8 @@
   detection under Cygwin (#13954). This should not be needed anymore
   with the new build system and use of --with-gmp. If it is, upstream
   asked for it to be reported and they will fix it.
+
+- Revert #19726 (not needed anymore)
 
 TODO:
 
``````




---

archive/issue_comments_423177.json:
```json
{
    "body": "<a id='comment:16'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/234c54b4b7e0495e343c3ab1b925e2c99f37e391\">234c54b</a></td><td><code>#22626: revert #19726 as it won't be needed for gap 4.9</code></td></tr></table>\n",
    "created_at": "2017-03-17T10:34:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423177",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/234c54b4b7e0495e343c3ab1b925e2c99f37e391">234c54b</a></td><td><code>#22626: revert #19726 as it won't be needed for gap 4.9</code></td></tr></table>




---

archive/issue_comments_423178.json:
```json
{
    "body": "**Changing commit** from \"[3011ac0908d667c0f245ca21859e336511106b5f](https://github.com/sagemath/sagetrac-mirror/commit/3011ac0908d667c0f245ca21859e336511106b5f)\" to \"[234c54b4b7e0495e343c3ab1b925e2c99f37e391](https://github.com/sagemath/sagetrac-mirror/commit/234c54b4b7e0495e343c3ab1b925e2c99f37e391)\".",
    "created_at": "2017-03-17T10:34:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423178",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[3011ac0908d667c0f245ca21859e336511106b5f](https://github.com/sagemath/sagetrac-mirror/commit/3011ac0908d667c0f245ca21859e336511106b5f)" to "[234c54b4b7e0495e343c3ab1b925e2c99f37e391](https://github.com/sagemath/sagetrac-mirror/commit/234c54b4b7e0495e343c3ab1b925e2c99f37e391)".



---

archive/issue_comments_423179.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -3,10 +3,11 @@\n \n The branch attached to this ticket updates Sage to run on top of\n [a branch of GAP](https://github.com/markuspf/gap/tree/hpc-merge-libgap)\n-by Markus Pfeiffer that adds libgap compilation and [|will be merged](https://github.com/fingolfin/gap/pull/64) soon\n-in the devel version of GAP.\n+by Markus Pfeiffer that adds libgap compilation and [will be merged](https://github.com/fingolfin/gap/pull/64) soon in the devel version of GAP.\n \n Tentatively, all tests pass!\n+\n+See https://github.com/markuspf/gap/issues/2 for the few sticking points that could prevent using a vanilla GAP from the distribution (please edit further if you think about more of them).\n \n \n What the branch does:\n``````\n",
    "created_at": "2017-03-17T10:42:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423179",
    "user": "https://github.com/nthiery"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -3,10 +3,11 @@
 
 The branch attached to this ticket updates Sage to run on top of
 [a branch of GAP](https://github.com/markuspf/gap/tree/hpc-merge-libgap)
-by Markus Pfeiffer that adds libgap compilation and [|will be merged](https://github.com/fingolfin/gap/pull/64) soon
-in the devel version of GAP.
+by Markus Pfeiffer that adds libgap compilation and [will be merged](https://github.com/fingolfin/gap/pull/64) soon in the devel version of GAP.
 
 Tentatively, all tests pass!
+
+See https://github.com/markuspf/gap/issues/2 for the few sticking points that could prevent using a vanilla GAP from the distribution (please edit further if you think about more of them).
 
 
 What the branch does:
``````




---

archive/attachments_020892.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "ptestlong.log",
    "asset_url": "tarball://root/attachments/some-uuid/ticket22626/ptestlong.log",
    "created_at": "2017-03-17T13:35:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.log",
    "user": "https://github.com/nthiery"
}
```



---

archive/issue_comments_423180.json:
```json
{
    "body": "",
    "created_at": "2017-03-17T13:35:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423180",
    "user": "https://github.com/nthiery"
}
```





---

archive/issue_comments_423181.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -4,8 +4,6 @@\n The branch attached to this ticket updates Sage to run on top of\n [a branch of GAP](https://github.com/markuspf/gap/tree/hpc-merge-libgap)\n by Markus Pfeiffer that adds libgap compilation and [will be merged](https://github.com/fingolfin/gap/pull/64) soon in the devel version of GAP.\n-\n-Tentatively, all tests pass!\n \n See https://github.com/markuspf/gap/issues/2 for the few sticking points that could prevent using a vanilla GAP from the distribution (please edit further if you think about more of them).\n \n@@ -40,6 +38,15 @@\n \n - Revert #19726 (not needed anymore)\n \n+Status: Most long test pass. Tentatively, the 38 remaining failing\n+tests are due to changes in GAP since 4.8.6: Max mentioned that the\n+library has been cleaned up to always use the same random generation\n+source, and some of the group algorithms were changed as well, which\n+can explain, e.g. change of orders in lists of elements. So those\n+should be nothing to worry about. There is not much point in updating\n+those doctests right away; we may as well wait for a more final\n+version of 4.9 to be out.\n+\n TODO:\n \n - Automatic handling of headers (see below for how to do it by hand).\n@@ -53,6 +60,8 @@\n \n - Check against #19915 to see if any of the changes there should be\n   ported here. Then close as won't fix.\n+\n+  - Update doctests as needed\n \n - ???\n \n``````\n",
    "created_at": "2017-03-17T13:51:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423181",
    "user": "https://github.com/nthiery"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -4,8 +4,6 @@
 The branch attached to this ticket updates Sage to run on top of
 [a branch of GAP](https://github.com/markuspf/gap/tree/hpc-merge-libgap)
 by Markus Pfeiffer that adds libgap compilation and [will be merged](https://github.com/fingolfin/gap/pull/64) soon in the devel version of GAP.
-
-Tentatively, all tests pass!
 
 See https://github.com/markuspf/gap/issues/2 for the few sticking points that could prevent using a vanilla GAP from the distribution (please edit further if you think about more of them).
 
@@ -40,6 +38,15 @@
 
 - Revert #19726 (not needed anymore)
 
+Status: Most long test pass. Tentatively, the 38 remaining failing
+tests are due to changes in GAP since 4.8.6: Max mentioned that the
+library has been cleaned up to always use the same random generation
+source, and some of the group algorithms were changed as well, which
+can explain, e.g. change of orders in lists of elements. So those
+should be nothing to worry about. There is not much point in updating
+those doctests right away; we may as well wait for a more final
+version of 4.9 to be out.
+
 TODO:
 
 - Automatic handling of headers (see below for how to do it by hand).
@@ -53,6 +60,8 @@
 
 - Check against #19915 to see if any of the changes there should be
   ported here. Then close as won't fix.
+
+  - Update doctests as needed
 
 - ???
 
``````




---

archive/issue_comments_423182.json:
```json
{
    "body": "<a id='comment:19'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b301e4ca55c643a24f8b2c94337700ca5a37c2a2\">b301e4c</a></td><td><code>#22626: ReST fix</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/431845f6da27d20c78b5e7a42b5f47bea866201c\">431845f</a></td><td><code>#22626: better work around for the GAP-Python name clash on T_INT, ...</code></td></tr></table>\n",
    "created_at": "2017-03-17T15:11:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423182",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b301e4ca55c643a24f8b2c94337700ca5a37c2a2">b301e4c</a></td><td><code>#22626: ReST fix</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/431845f6da27d20c78b5e7a42b5f47bea866201c">431845f</a></td><td><code>#22626: better work around for the GAP-Python name clash on T_INT, ...</code></td></tr></table>




---

archive/issue_comments_423183.json:
```json
{
    "body": "**Changing commit** from \"[234c54b4b7e0495e343c3ab1b925e2c99f37e391](https://github.com/sagemath/sagetrac-mirror/commit/234c54b4b7e0495e343c3ab1b925e2c99f37e391)\" to \"[431845f6da27d20c78b5e7a42b5f47bea866201c](https://github.com/sagemath/sagetrac-mirror/commit/431845f6da27d20c78b5e7a42b5f47bea866201c)\".",
    "created_at": "2017-03-17T15:11:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423183",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[234c54b4b7e0495e343c3ab1b925e2c99f37e391](https://github.com/sagemath/sagetrac-mirror/commit/234c54b4b7e0495e343c3ab1b925e2c99f37e391)" to "[431845f6da27d20c78b5e7a42b5f47bea866201c](https://github.com/sagemath/sagetrac-mirror/commit/431845f6da27d20c78b5e7a42b5f47bea866201c)".



---

archive/issue_comments_423184.json:
```json
{
    "body": "<a id='comment:20'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b301e4ca55c643a24f8b2c94337700ca5a37c2a2\">b301e4c</a></td><td><code>#22626: ReST fix</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/431845f6da27d20c78b5e7a42b5f47bea866201c\">431845f</a></td><td><code>#22626: better work around for the GAP-Python name clash on T_INT, ...</code></td></tr></table>\n",
    "created_at": "2017-03-17T15:15:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423184",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:20'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b301e4ca55c643a24f8b2c94337700ca5a37c2a2">b301e4c</a></td><td><code>#22626: ReST fix</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/431845f6da27d20c78b5e7a42b5f47bea866201c">431845f</a></td><td><code>#22626: better work around for the GAP-Python name clash on T_INT, ...</code></td></tr></table>




---

archive/issue_comments_423185.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -26,10 +26,11 @@\n   around with GAP's sources; in particular opening the door for using\n   a stock GAP from the OS distribution. However there always is a risk\n   of name conflict. And indeed, GAP's constants (actually cpp macros)\n-  T_INT, T_FLOAT, ... conflict with Python's constants. This is worked\n-  around by duplicating and forcing their value in gap_include.pxd.\n-  Another conflict in objects.h currently needs to be worked around by\n-  hand (see below). Something similar was started at #19915.\n+  T_INT, T_FLOAT, ... conflict with Python's constants. This is\n+  currently worked around by forcing the inclusion of Python's\n+  `structmember.h` before the gap headers.\n+\n+  Something similar was started by Volker at #19915.\n \n - Removes configure.patch: it was patching configure for better GMP\n   detection under Cygwin (#13954). This should not be needed anymore\n``````\n",
    "created_at": "2017-03-17T15:15:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423185",
    "user": "https://github.com/nthiery"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -26,10 +26,11 @@
   around with GAP's sources; in particular opening the door for using
   a stock GAP from the OS distribution. However there always is a risk
   of name conflict. And indeed, GAP's constants (actually cpp macros)
-  T_INT, T_FLOAT, ... conflict with Python's constants. This is worked
-  around by duplicating and forcing their value in gap_include.pxd.
-  Another conflict in objects.h currently needs to be worked around by
-  hand (see below). Something similar was started at #19915.
+  T_INT, T_FLOAT, ... conflict with Python's constants. This is
+  currently worked around by forcing the inclusion of Python's
+  `structmember.h` before the gap headers.
+
+  Something similar was started by Volker at #19915.
 
 - Removes configure.patch: it was patching configure for better GMP
   detection under Cygwin (#13954). This should not be needed anymore
``````




---

archive/issue_comments_423186.json:
```json
{
    "body": "<a id='comment:21'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7c04025083d61cab671df3302c32f353c4e28313\">7c04025</a></td><td><code>22626: document the work around for the GAP-Python name clash on T_INT, ...</code></td></tr></table>\n",
    "created_at": "2017-03-17T15:27:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423186",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7c04025083d61cab671df3302c32f353c4e28313">7c04025</a></td><td><code>22626: document the work around for the GAP-Python name clash on T_INT, ...</code></td></tr></table>




---

archive/issue_comments_423187.json:
```json
{
    "body": "**Changing commit** from \"[431845f6da27d20c78b5e7a42b5f47bea866201c](https://github.com/sagemath/sagetrac-mirror/commit/431845f6da27d20c78b5e7a42b5f47bea866201c)\" to \"[7c04025083d61cab671df3302c32f353c4e28313](https://github.com/sagemath/sagetrac-mirror/commit/7c04025083d61cab671df3302c32f353c4e28313)\".",
    "created_at": "2017-03-17T15:27:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423187",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[431845f6da27d20c78b5e7a42b5f47bea866201c](https://github.com/sagemath/sagetrac-mirror/commit/431845f6da27d20c78b5e7a42b5f47bea866201c)" to "[7c04025083d61cab671df3302c32f353c4e28313](https://github.com/sagemath/sagetrac-mirror/commit/7c04025083d61cab671df3302c32f353c4e28313)".



---

archive/issue_comments_423188.json:
```json
{
    "body": "<a id='comment:22'></a>\nSo if I understand the mechanics involved, at the moment you have to configure and install gap. Then clean and configure and install for libgap. So it is still behaving like \"two packages\" with the same source code. Do we have an idea on when we'll have just have gap linking on libgap which would also solve this particular problem?",
    "created_at": "2017-03-20T02:55:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423188",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:22'></a>
So if I understand the mechanics involved, at the moment you have to configure and install gap. Then clean and configure and install for libgap. So it is still behaving like "two packages" with the same source code. Do we have an idea on when we'll have just have gap linking on libgap which would also solve this particular problem?



---

archive/issue_comments_423189.json:
```json
{
    "body": "<a id='comment:23'></a>\nSalut Fran\u00e7ois,\n\nReplying to [fbissey](#comment%3A22):\n> So if I understand the mechanics involved, at the moment you have to configure and install gap. Then clean and configure and install for libgap. So it is still behaving like \"two packages\" with the same source code. \n\n\nExactly.\n\n> Do we have an idea on when we'll have just have gap linking on libgap which would also solve this particular problem?\n\n\nThe GAP developers are well aware of that and planning to implement it. They have not yet done yet just to be more incremental; their new build system is a big PR already :-) I would assume that this will be done before GAP 4.9 which they are planning for a couple months from now.\n\nSee: https://github.com/markuspf/gap/issues/2\n\nBtw: feel free to comment / expand on the list there. I'll advertise this issue for additional feedback on the sage-packaging mailing list.",
    "created_at": "2017-03-20T08:59:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423189",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:23'></a>
Salut Fran√ßois,

Replying to [fbissey](#comment%3A22):
> So if I understand the mechanics involved, at the moment you have to configure and install gap. Then clean and configure and install for libgap. So it is still behaving like "two packages" with the same source code. 


Exactly.

> Do we have an idea on when we'll have just have gap linking on libgap which would also solve this particular problem?


The GAP developers are well aware of that and planning to implement it. They have not yet done yet just to be more incremental; their new build system is a big PR already :-) I would assume that this will be done before GAP 4.9 which they are planning for a couple months from now.

See: https://github.com/markuspf/gap/issues/2

Btw: feel free to comment / expand on the list there. I'll advertise this issue for additional feedback on the sage-packaging mailing list.



---

archive/issue_comments_423190.json:
```json
{
    "body": "<a id='comment:24'></a>\nReplying to [fbissey](#comment%3A22):\n> So if I understand the mechanics involved, at the moment you have to configure and install gap. Then clean and configure and install for libgap. So it is still behaving like \"two packages\" with the same source code.\n\n\nFor this reason, I wonder why you didn't keep the separation GAP + libGAP in Sage too. If it effectively behaves as two packages, it seems more natural to keep it as two packages in Sage too. Imagine for example that we need to patch GAP but not libGAP or conversely, that would be harder with the current approach. That being said, this is mostly bikeshedding. So, if the current setup works well, there might be no reason to change it.",
    "created_at": "2017-03-20T10:19:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423190",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'></a>
Replying to [fbissey](#comment%3A22):
> So if I understand the mechanics involved, at the moment you have to configure and install gap. Then clean and configure and install for libgap. So it is still behaving like "two packages" with the same source code.


For this reason, I wonder why you didn't keep the separation GAP + libGAP in Sage too. If it effectively behaves as two packages, it seems more natural to keep it as two packages in Sage too. Imagine for example that we need to patch GAP but not libGAP or conversely, that would be harder with the current approach. That being said, this is mostly bikeshedding. So, if the current setup works well, there might be no reason to change it.



---

archive/issue_comments_423191.json:
```json
{
    "body": "<a id='comment:25'></a>\nReplying to [jdemeyer](#comment%3A24):\n> Replying to [fbissey](#comment%3A22):\n> > So if I understand the mechanics involved, at the moment you have to configure and install gap. Then clean and configure and install for libgap. So it is still behaving like \"two packages\" with the same source code.\n\n> \n> For this reason, I wonder why you didn't keep the separation GAP + libGAP in Sage too. If it effectively behaves as two packages, it seems more natural to keep it as two packages in Sage too. Imagine for example that we need to patch GAP but not libGAP or conversely, that would be harder with the current approach. That being said, this is mostly bikeshedding. So, if the current setup works well, there might be no reason to change it.\n\n\nTwo completely separate packages would also mean that `gap_packages` should come in two different flavours, etc. I'd rather keep it simple and do not multiply these instances (but rather hope that `libGAP` will support all of GAP packages soon).",
    "created_at": "2017-03-20T10:30:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423191",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:25'></a>
Replying to [jdemeyer](#comment%3A24):
> Replying to [fbissey](#comment%3A22):
> > So if I understand the mechanics involved, at the moment you have to configure and install gap. Then clean and configure and install for libgap. So it is still behaving like "two packages" with the same source code.

> 
> For this reason, I wonder why you didn't keep the separation GAP + libGAP in Sage too. If it effectively behaves as two packages, it seems more natural to keep it as two packages in Sage too. Imagine for example that we need to patch GAP but not libGAP or conversely, that would be harder with the current approach. That being said, this is mostly bikeshedding. So, if the current setup works well, there might be no reason to change it.


Two completely separate packages would also mean that `gap_packages` should come in two different flavours, etc. I'd rather keep it simple and do not multiply these instances (but rather hope that `libGAP` will support all of GAP packages soon).



---

archive/issue_comments_423192.json:
```json
{
    "body": "<a id='comment:26'></a>\nReplying to [dimpase](#comment%3A25):\n> Two completely separate packages would also mean that `gap_packages` should come in two different flavours, etc.\n\n\nSo, you are saying that we need to install `gap_packages` twice too? Once for GAP and once for libGAP?",
    "created_at": "2017-03-20T10:33:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423192",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:26'></a>
Replying to [dimpase](#comment%3A25):
> Two completely separate packages would also mean that `gap_packages` should come in two different flavours, etc.


So, you are saying that we need to install `gap_packages` twice too? Once for GAP and once for libGAP?



---

archive/issue_comments_423193.json:
```json
{
    "body": "<a id='comment:27'></a>\nReplying to [jdemeyer](#comment%3A24):\n> For this reason, I wonder why you didn't keep the separation GAP + libGAP in Sage too.\n\n\nI wanted to experiment with how far we were from having a proper\nsingle package, so as to give early feedback to the gap developers on\nany sticking points. And indeed, linking gap to libgap is basically\nthe only sticking point. Since this point will be most likely resolved\nby the time this ticket gets merged in, we might as well shoot\ndirectly for the \"right thing\".",
    "created_at": "2017-03-20T10:35:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423193",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:27'></a>
Replying to [jdemeyer](#comment%3A24):
> For this reason, I wonder why you didn't keep the separation GAP + libGAP in Sage too.


I wanted to experiment with how far we were from having a proper
single package, so as to give early feedback to the gap developers on
any sticking points. And indeed, linking gap to libgap is basically
the only sticking point. Since this point will be most likely resolved
by the time this ticket gets merged in, we might as well shoot
directly for the "right thing".



---

archive/issue_comments_423194.json:
```json
{
    "body": "<a id='comment:28'></a>\nReplying to [jdemeyer](#comment%3A26):\n> Replying to [dimpase](#comment%3A25):\n> > Two completely separate packages would also mean that `gap_packages` should come in two different flavours, etc.\n\n> \n> So, you are saying that we need to install `gap_packages` twice too? Once for GAP and once for libGAP?\n\n\nno, not at all---I mean to say that there exist GAP packages (not part of Sage ATM) that break libGAP now. As some of these packages are very useful, it's important to have this fixed (but not at expense of having 2 separate `gap_packages`).",
    "created_at": "2017-03-20T10:37:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423194",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:28'></a>
Replying to [jdemeyer](#comment%3A26):
> Replying to [dimpase](#comment%3A25):
> > Two completely separate packages would also mean that `gap_packages` should come in two different flavours, etc.

> 
> So, you are saying that we need to install `gap_packages` twice too? Once for GAP and once for libGAP?


no, not at all---I mean to say that there exist GAP packages (not part of Sage ATM) that break libGAP now. As some of these packages are very useful, it's important to have this fixed (but not at expense of having 2 separate `gap_packages`).



---

archive/issue_comments_423195.json:
```json
{
    "body": "<a id='comment:29'></a>\nReplying to [dimpase](#comment%3A28):\n> As some of these packages are very useful, it's important to have this fixed\n\n\nYES. In fact that is my main motivation to work on the libgap\nintegration: I badly want to use Semigroups that requires IO! We went\nthrough the details with Markus and Max, and the shared aim is indeed\nto have this resolved with the upgrade to 4.9.",
    "created_at": "2017-03-20T10:49:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423195",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:29'></a>
Replying to [dimpase](#comment%3A28):
> As some of these packages are very useful, it's important to have this fixed


YES. In fact that is my main motivation to work on the libgap
integration: I badly want to use Semigroups that requires IO! We went
through the details with Markus and Max, and the shared aim is indeed
to have this resolved with the upgrade to 4.9.



---

archive/issue_comments_423196.json:
```json
{
    "body": "<a id='comment:31'></a>\nIs there any news here?",
    "created_at": "2017-07-05T13:18:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423196",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:31'></a>
Is there any news here?



---

archive/issue_comments_423197.json:
```json
{
    "body": "<a id='comment:32'></a>\nGAP 4.9.0, a beta release for GAP 4.9, has been released.\n\nThis means we can start working on building Sage with it.\n\n- Release notes: https://github.com/gap-system/gap/wiki/GAP-4.9-release-notes",
    "created_at": "2018-02-08T06:03:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423197",
    "user": "https://github.com/slel"
}
```

<a id='comment:32'></a>
GAP 4.9.0, a beta release for GAP 4.9, has been released.

This means we can start working on building Sage with it.

- Release notes: https://github.com/gap-system/gap/wiki/GAP-4.9-release-notes



---

archive/issue_comments_423198.json:
```json
{
    "body": "<a id='comment:33'></a>\nDo you know if they now provide a replacement for `libGAP`?",
    "created_at": "2018-02-08T07:58:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423198",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:33'></a>
Do you know if they now provide a replacement for `libGAP`?



---

archive/issue_comments_423199.json:
```json
{
    "body": "<a id='comment:34'></a>\nCc-ing `@`alexk and `@`markuspf.",
    "created_at": "2018-02-08T17:19:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423199",
    "user": "https://github.com/slel"
}
```

<a id='comment:34'></a>
Cc-ing `@`alexk and `@`markuspf.



---

archive/issue_comments_423200.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -7,8 +7,8 @@\n \n See https://github.com/markuspf/gap/issues/2 for the few sticking points that could prevent using a vanilla GAP from the distribution (please edit further if you think about more of them).\n \n+What the branch does:\n \n-What the branch does:\n - Remove the libgap spkg\n \n - Update the gap spkg to the new build system and build and install libgap\n@@ -69,38 +69,38 @@\n Fetching Markus's GAP sources:\n \n ```\n-    git clone git@github.com:markuspf/gap.git $LIBGAP\n-    cd $LIBGAP\n-    git remote add markuspf git@github.com:markuspf/gap.git\n-    git fetch markuspf\n-    git checkout -b markuspf/hpc-merge-libgap\n-    ./autogen.sh\n-    ./configure\n-    make bootstrap-pkg-minimal\n+git clone git@github.com:markuspf/gap.git $LIBGAP\n+cd $LIBGAP\n+git remote add markuspf git@github.com:markuspf/gap.git\n+git fetch markuspf\n+git checkout -b markuspf/hpc-merge-libgap\n+./autogen.sh\n+./configure\n+make bootstrap-pkg-minimal\n ```\n \n \n Testing libgap:\n \n ```\n-    ./configure --enable-libgap\n-    make -j4 libgap\n-    make test-libgap\n+./configure --enable-libgap\n+make -j4 libgap\n+make test-libgap\n ```\n \n Build and install a tardist for Sage, and rebuild the spkg:\n \n ```\n-    make distclean\n-    ./autogen.sh\n-    ./configure\n-    make manuals\n-    make clean\n+make distclean\n+./autogen.sh\n+./configure\n+make manuals\n+make clean\n \n-    (cd ..; tar zcvf $SAGE/upstream/$GAP.tar.gz --exclude .git $GAP)\n+(cd ..; tar zcvf $SAGE/upstream/$GAP.tar.gz --exclude .git $GAP)\n \n-    sage --package fix-checksum\n-    sage -f gap                      # -s\n+sage --package fix-checksum\n+sage -f gap                      # -s\n ```\n \n Header files:\n@@ -111,23 +111,23 @@\n Run:\n \n ```\n-    sage -b\n+sage -b\n ```\n \n Basic tests on libgap:\n \n ```\n-    sage: libgap.eval(\"GAPInfo.Version\")\n-    sage: libgap.DihedralGroup(10).CharacterTable()\n-    CharacterTable( <pc group of size 10 with 2 generators> )\n-    sage: libgap.Group(libgap.eval(\"[(1,2,3),(1,2)]\")).Size()\n-    6\n+sage: libgap.eval(\"GAPInfo.Version\")\n+sage: libgap.DihedralGroup(10).CharacterTable()\n+CharacterTable( <pc group of size 10 with 2 generators> )\n+sage: libgap.Group(libgap.eval(\"[(1,2,3),(1,2)]\")).Size()\n+6\n ```\n \n Running most relevant tests:\n \n ```\n-    sage -tp 8 sage/groups sage/libs/gap\n+sage -tp 8 sage/groups sage/libs/gap\n ```\n Current status: all tests pass!\n \n@@ -136,29 +136,29 @@\n Install IO:\n \n ```\n-    cd $SAGE/local/gap/latest/pkg\n-    wget http://www.gap-system.org/pub/gap/gap4/tar.gz/packages/io-4.4.6.tar.gz\n-    tar xvf /tmp/io-4.4.6.tar.gz\n-    mv io-4.4.6 io\n-    cd io\n-    ./configure\n-    make\n+cd $SAGE/local/gap/latest/pkg\n+wget http://www.gap-system.org/pub/gap/gap4/tar.gz/packages/io-4.4.6.tar.gz\n+tar xvf /tmp/io-4.4.6.tar.gz\n+mv io-4.4.6 io\n+cd io\n+./configure\n+make\n ```\n \n Test it locally:\n \n ```\n-    cd ../..\n-    ./gap -l .\n-    gap> LoadPackage(\"IO\");\n-    true\n+cd ../..\n+./gap -l .\n+gap> LoadPackage(\"IO\");\n+true\n ```\n \n This does not yet work:\n \n ```\n-    sage: libgap.LoadPackage(\"IO\")\n-    ValueError: libGAP: Error, module '/opt/sage-git/local/gap/latest/pkg/io/bin/x86_64-pc-linux-gnu-gcc-default64/io.so' not found\n+sage: libgap.LoadPackage(\"IO\")\n+ValueError: libGAP: Error, module '/opt/sage-git/local/gap/latest/pkg/io/bin/x86_64-pc-linux-gnu-gcc-default64/io.so' not found\n ```\n This should be fixed once GAP's gap binary is built on top of libgap.\n See: https://github.com/markuspf/gap/issues/1.\n``````\n",
    "created_at": "2018-02-08T17:19:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423200",
    "user": "https://github.com/slel"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -7,8 +7,8 @@
 
 See https://github.com/markuspf/gap/issues/2 for the few sticking points that could prevent using a vanilla GAP from the distribution (please edit further if you think about more of them).
 
+What the branch does:
 
-What the branch does:
 - Remove the libgap spkg
 
 - Update the gap spkg to the new build system and build and install libgap
@@ -69,38 +69,38 @@
 Fetching Markus's GAP sources:
 
 ```
-    git clone git@github.com:markuspf/gap.git $LIBGAP
-    cd $LIBGAP
-    git remote add markuspf git@github.com:markuspf/gap.git
-    git fetch markuspf
-    git checkout -b markuspf/hpc-merge-libgap
-    ./autogen.sh
-    ./configure
-    make bootstrap-pkg-minimal
+git clone git@github.com:markuspf/gap.git $LIBGAP
+cd $LIBGAP
+git remote add markuspf git@github.com:markuspf/gap.git
+git fetch markuspf
+git checkout -b markuspf/hpc-merge-libgap
+./autogen.sh
+./configure
+make bootstrap-pkg-minimal
 ```
 
 
 Testing libgap:
 
 ```
-    ./configure --enable-libgap
-    make -j4 libgap
-    make test-libgap
+./configure --enable-libgap
+make -j4 libgap
+make test-libgap
 ```
 
 Build and install a tardist for Sage, and rebuild the spkg:
 
 ```
-    make distclean
-    ./autogen.sh
-    ./configure
-    make manuals
-    make clean
+make distclean
+./autogen.sh
+./configure
+make manuals
+make clean
 
-    (cd ..; tar zcvf $SAGE/upstream/$GAP.tar.gz --exclude .git $GAP)
+(cd ..; tar zcvf $SAGE/upstream/$GAP.tar.gz --exclude .git $GAP)
 
-    sage --package fix-checksum
-    sage -f gap                      # -s
+sage --package fix-checksum
+sage -f gap                      # -s
 ```
 
 Header files:
@@ -111,23 +111,23 @@
 Run:
 
 ```
-    sage -b
+sage -b
 ```
 
 Basic tests on libgap:
 
 ```
-    sage: libgap.eval("GAPInfo.Version")
-    sage: libgap.DihedralGroup(10).CharacterTable()
-    CharacterTable( <pc group of size 10 with 2 generators> )
-    sage: libgap.Group(libgap.eval("[(1,2,3),(1,2)]")).Size()
-    6
+sage: libgap.eval("GAPInfo.Version")
+sage: libgap.DihedralGroup(10).CharacterTable()
+CharacterTable( <pc group of size 10 with 2 generators> )
+sage: libgap.Group(libgap.eval("[(1,2,3),(1,2)]")).Size()
+6
 ```
 
 Running most relevant tests:
 
 ```
-    sage -tp 8 sage/groups sage/libs/gap
+sage -tp 8 sage/groups sage/libs/gap
 ```
 Current status: all tests pass!
 
@@ -136,29 +136,29 @@
 Install IO:
 
 ```
-    cd $SAGE/local/gap/latest/pkg
-    wget http://www.gap-system.org/pub/gap/gap4/tar.gz/packages/io-4.4.6.tar.gz
-    tar xvf /tmp/io-4.4.6.tar.gz
-    mv io-4.4.6 io
-    cd io
-    ./configure
-    make
+cd $SAGE/local/gap/latest/pkg
+wget http://www.gap-system.org/pub/gap/gap4/tar.gz/packages/io-4.4.6.tar.gz
+tar xvf /tmp/io-4.4.6.tar.gz
+mv io-4.4.6 io
+cd io
+./configure
+make
 ```
 
 Test it locally:
 
 ```
-    cd ../..
-    ./gap -l .
-    gap> LoadPackage("IO");
-    true
+cd ../..
+./gap -l .
+gap> LoadPackage("IO");
+true
 ```
 
 This does not yet work:
 
 ```
-    sage: libgap.LoadPackage("IO")
-    ValueError: libGAP: Error, module '/opt/sage-git/local/gap/latest/pkg/io/bin/x86_64-pc-linux-gnu-gcc-default64/io.so' not found
+sage: libgap.LoadPackage("IO")
+ValueError: libGAP: Error, module '/opt/sage-git/local/gap/latest/pkg/io/bin/x86_64-pc-linux-gnu-gcc-default64/io.so' not found
 ```
 This should be fixed once GAP's gap binary is built on top of libgap.
 See: https://github.com/markuspf/gap/issues/1.
``````




---

archive/issue_comments_423201.json:
```json
{
    "body": "<a id='comment:35'></a>\nReplying to [dimpase](#comment%3A33):\n> Do you know if they now provide a replacement for `libGAP`?\n\n\nIn principle yes: the branch I posted here last April was using their stock alpha version. Now the next step is to revive the branch and adapt it if needed.\n\nI can work on this, but probably not at once. Any volunteer to take over welcome.\n\n\nMarkus: do you foresee any major changes in how GAP's lib is to be built that could affect what I was doing last April?",
    "created_at": "2018-02-09T08:40:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423201",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:35'></a>
Replying to [dimpase](#comment%3A33):
> Do you know if they now provide a replacement for `libGAP`?


In principle yes: the branch I posted here last April was using their stock alpha version. Now the next step is to revive the branch and adapt it if needed.

I can work on this, but probably not at once. Any volunteer to take over welcome.


Markus: do you foresee any major changes in how GAP's lib is to be built that could affect what I was doing last April?



---

archive/issue_comments_423202.json:
```json
{
    "body": "<a id='comment:36'></a>\nI just noticed that in 4.9 smallgrps and transgrps are released under a GPL-compatible license. This is great! We really should make them (i.e. database_gap) standard Sage package, and do away with the extra hurdle of having database_gap optional.",
    "created_at": "2018-02-17T22:50:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423202",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:36'></a>
I just noticed that in 4.9 smallgrps and transgrps are released under a GPL-compatible license. This is great! We really should make them (i.e. database_gap) standard Sage package, and do away with the extra hurdle of having database_gap optional.



---

archive/issue_comments_423203.json:
```json
{
    "body": "<a id='comment:37'></a>\nIf you're willing to wait 2 months, this might be a good task for the Cernay workshop https://github.com/OpenDreamKit/OpenDreamKit/issues/251",
    "created_at": "2018-02-18T09:40:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423203",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:37'></a>
If you're willing to wait 2 months, this might be a good task for the Cernay workshop https://github.com/OpenDreamKit/OpenDreamKit/issues/251



---

archive/issue_comments_423204.json:
```json
{
    "body": "<a id='comment:38'></a>\nReplying to [jdemeyer](#comment%3A37):\n> If you're willing to wait 2 months, this might be a good task for the Cernay workshop https://github.com/OpenDreamKit/OpenDreamKit/issues/251\n\n\nYes indeed; it will be helpful to have GAP people under hand. I may just become impatient before that for some research project of mine, in which case I'll have a head start :-)",
    "created_at": "2018-02-18T20:04:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423204",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:38'></a>
Replying to [jdemeyer](#comment%3A37):
> If you're willing to wait 2 months, this might be a good task for the Cernay workshop https://github.com/OpenDreamKit/OpenDreamKit/issues/251


Yes indeed; it will be helpful to have GAP people under hand. I may just become impatient before that for some research project of mine, in which case I'll have a head start :-)



---

archive/issue_comments_423205.json:
```json
{
    "body": "<a id='comment:39'></a>\nReplying to [dimpase](#comment%3A36):\n> I just noticed that in 4.9 smallgrps and transgrps are released under a GPL-compatible license. This is great! We really should make them (i.e. database_gap) standard Sage package, and do away with the extra hurdle of having database_gap optional.\n\n\nYes! I can't wait for all the simplifications this will bring to us!",
    "created_at": "2018-02-18T20:05:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423205",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:39'></a>
Replying to [dimpase](#comment%3A36):
> I just noticed that in 4.9 smallgrps and transgrps are released under a GPL-compatible license. This is great! We really should make them (i.e. database_gap) standard Sage package, and do away with the extra hurdle of having database_gap optional.


Yes! I can't wait for all the simplifications this will bring to us!



---

archive/issue_comments_423206.json:
```json
{
    "body": "<a id='comment:40'></a>\nReplying to [fbissey](#comment%3A22):\n> So if I understand the mechanics involved, at the moment you have to configure and install gap. Then clean and configure and install for libgap. So it is still behaving like \"two packages\".\n\n\nWith the past and future modifications to the Sage build system in mind, I now object more strongly than before to treating two separate packages (GAP + libGAP) as one package.\n\nThe reason is that we now try to separate the build and install stages of packages. But that is incompatible with the recipe here of first \"build and install GAP\" and then \"build and install libGAP\".",
    "created_at": "2018-02-22T08:49:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423206",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:40'></a>
Replying to [fbissey](#comment%3A22):
> So if I understand the mechanics involved, at the moment you have to configure and install gap. Then clean and configure and install for libgap. So it is still behaving like "two packages".


With the past and future modifications to the Sage build system in mind, I now object more strongly than before to treating two separate packages (GAP + libGAP) as one package.

The reason is that we now try to separate the build and install stages of packages. But that is incompatible with the recipe here of first "build and install GAP" and then "build and install libGAP".



---

archive/issue_comments_423207.json:
```json
{
    "body": "<a id='comment:41'></a>\nFor an example of two Sage packages with the same sources, see `gcc` and `gfortran`. IMHO, you should do the same for GAP and libGAP (unless they are merged upstream but my impression is that this has not happened yet).",
    "created_at": "2018-02-22T08:53:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423207",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:41'></a>
For an example of two Sage packages with the same sources, see `gcc` and `gfortran`. IMHO, you should do the same for GAP and libGAP (unless they are merged upstream but my impression is that this has not happened yet).



---

archive/issue_comments_423208.json:
```json
{
    "body": "<a id='comment:42'></a>\nReplying to [jdemeyer](#comment%3A40):\n> Replying to [fbissey](#comment%3A22):\n> > So if I understand the mechanics involved, at the moment you have to configure and install gap. Then clean and configure and install for libgap. So it is still behaving like \"two packages\".\n\n> \n> With the past and future modifications to the Sage build system in mind, I now object more strongly than before to treating two separate packages (GAP + libGAP) as one package.\n> \n> The reason is that we now try to separate the build and install stages of packages. But that is incompatible with the recipe here of first \"build and install GAP\" and then \"build and install libGAP\".\n\n\nHopefully we will be getting something more serious at final release time, like with pari where you build libpari and then the gp executable. That would be the ideal scenario where it is really one package. Have to see how far they have gone with 4.9.",
    "created_at": "2018-02-22T08:54:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423208",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:42'></a>
Replying to [jdemeyer](#comment%3A40):
> Replying to [fbissey](#comment%3A22):
> > So if I understand the mechanics involved, at the moment you have to configure and install gap. Then clean and configure and install for libgap. So it is still behaving like "two packages".

> 
> With the past and future modifications to the Sage build system in mind, I now object more strongly than before to treating two separate packages (GAP + libGAP) as one package.
> 
> The reason is that we now try to separate the build and install stages of packages. But that is incompatible with the recipe here of first "build and install GAP" and then "build and install libGAP".


Hopefully we will be getting something more serious at final release time, like with pari where you build libpari and then the gp executable. That would be the ideal scenario where it is really one package. Have to see how far they have gone with 4.9.



---

archive/issue_comments_423209.json:
```json
{
    "body": "<a id='comment:43'></a>\nA lot of changes on this ticket (also the changes likely to lead to merge conflicts) are related to the unprefixing of libGAP symbols. To ease development, maybe we should try to do that separately from the upgrade to GAP 4.9.\n\nI was thinking to do something like #19915 but changing only the Sage source code (not libGAP) and undoing the prefixing with macros like `#define SomeGapFunction libGAP_SomeGapFunction`. What do you think?",
    "created_at": "2018-02-22T09:06:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423209",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:43'></a>
A lot of changes on this ticket (also the changes likely to lead to merge conflicts) are related to the unprefixing of libGAP symbols. To ease development, maybe we should try to do that separately from the upgrade to GAP 4.9.

I was thinking to do something like #19915 but changing only the Sage source code (not libGAP) and undoing the prefixing with macros like `#define SomeGapFunction libGAP_SomeGapFunction`. What do you think?



---

archive/issue_comments_423210.json:
```json
{
    "body": "<a id='comment:44'></a>\nthere is also libgap unprefixing in Python/Cython that has to be done.\nPerhaps separating these from C level unprefixing would help making it smoother.",
    "created_at": "2018-02-22T09:28:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423210",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:44'></a>
there is also libgap unprefixing in Python/Cython that has to be done.
Perhaps separating these from C level unprefixing would help making it smoother.



---

archive/issue_comments_423211.json:
```json
{
    "body": "<a id='comment:45'></a>\nReplying to [dimpase](#comment%3A44):\n> there is also libgap unprefixing in Python/Cython that has to be done.\n> Perhaps separating these from C level unprefixing would help making it smoother.\n\n\nYes, that is what I meant. Creating a separate ticket for unprefixing only at the Cython level by using macros to translate between the unprefixed names in Cython and the prefixed names in libGAP.",
    "created_at": "2018-02-22T09:50:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423211",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:45'></a>
Replying to [dimpase](#comment%3A44):
> there is also libgap unprefixing in Python/Cython that has to be done.
> Perhaps separating these from C level unprefixing would help making it smoother.


Yes, that is what I meant. Creating a separate ticket for unprefixing only at the Cython level by using macros to translate between the unprefixed names in Cython and the prefixed names in libGAP.



---

archive/issue_comments_423212.json:
```json
{
    "body": "<a id='comment:46'></a>\nReplying to [jdemeyer](#comment%3A45):\n> Replying to [dimpase](#comment%3A44):\n> > there is also libgap unprefixing in Python/Cython that has to be done.\n> > Perhaps separating these from C level unprefixing would help making it smoother.\n\n> \n> Yes, that is what I meant. Creating a separate ticket for unprefixing only at the Cython level by using macros to translate between the unprefixed names in Cython and the prefixed names in libGAP.\n\n\nI am not sure I understand. Currently in Cython on can do something like\n\n```\n    from sage.libs.gap.libgap import libgap\n    g=libgap.ProjectiveGeneralLinearGroup(3,3)\n```\nHow will this change under what you propose?",
    "created_at": "2018-02-22T10:20:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423212",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:46'></a>
Replying to [jdemeyer](#comment%3A45):
> Replying to [dimpase](#comment%3A44):
> > there is also libgap unprefixing in Python/Cython that has to be done.
> > Perhaps separating these from C level unprefixing would help making it smoother.

> 
> Yes, that is what I meant. Creating a separate ticket for unprefixing only at the Cython level by using macros to translate between the unprefixed names in Cython and the prefixed names in libGAP.


I am not sure I understand. Currently in Cython on can do something like

```
    from sage.libs.gap.libgap import libgap
    g=libgap.ProjectiveGeneralLinearGroup(3,3)
```
How will this change under what you propose?



---

archive/issue_comments_423213.json:
```json
{
    "body": "<a id='comment:47'></a>\nReplying to [dimpase](#comment%3A46):\n> \n> ```\n>     from sage.libs.gap.libgap import libgap\n>     g=libgap.ProjectiveGeneralLinearGroup(3,3)\n> ```\n> How will this change under what you propose?\n\n\nThe Python interface won't change at all. I am talking about how `sage.libs.gap` calls libGAP.",
    "created_at": "2018-02-22T12:38:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423213",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:47'></a>
Replying to [dimpase](#comment%3A46):
> 
> ```
>     from sage.libs.gap.libgap import libgap
>     g=libgap.ProjectiveGeneralLinearGroup(3,3)
> ```
> How will this change under what you propose?


The Python interface won't change at all. I am talking about how `sage.libs.gap` calls libGAP.



---

archive/issue_comments_423214.json:
```json
{
    "body": "<a id='comment:48'></a>\nAs far as I can tell, GAP 4.9 has not been released. Does anybody know how close we are to an actual release?",
    "created_at": "2018-03-15T09:53:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423214",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:48'></a>
As far as I can tell, GAP 4.9 has not been released. Does anybody know how close we are to an actual release?



---

archive/issue_comments_423215.json:
```json
{
    "body": "<a id='comment:49'></a>\nI think GAP 4.9.0 is considered a public beta for GAP 4.9.\n\nThe list of releases at\n\n* https://www.gap-system.org/Releases/\n\nstill displays GAP 4.8.10 as the latest release.\n\nIn the list of past releases there, the GAP 4.8, 4.7, 4.6, 4.5 series\nstart at GAP 4.8.2, 4.7.2, 4.6.2, 4.5.4, so probably GAP 4.x.y with\nthose x and lower y were considered beta.\n\nStill, seeing how 4.9.0 works with Sage would be nice.",
    "created_at": "2018-03-15T10:07:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423215",
    "user": "https://github.com/slel"
}
```

<a id='comment:49'></a>
I think GAP 4.9.0 is considered a public beta for GAP 4.9.

The list of releases at

* https://www.gap-system.org/Releases/

still displays GAP 4.8.10 as the latest release.

In the list of past releases there, the GAP 4.8, 4.7, 4.6, 4.5 series
start at GAP 4.8.2, 4.7.2, 4.6.2, 4.5.4, so probably GAP 4.x.y with
those x and lower y were considered beta.

Still, seeing how 4.9.0 works with Sage would be nice.



---

archive/issue_comments_423216.json:
```json
{
    "body": "**Dependencies:** #25273",
    "created_at": "2018-05-01T09:45:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423216",
    "user": "https://github.com/jdemeyer"
}
```

**Dependencies:** #25273



---

archive/issue_comments_423217.json:
```json
{
    "body": "<a id='comment:51'></a>\nWhere is the GAP source tarball which is supposed to be used here?",
    "created_at": "2018-05-01T11:30:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423217",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:51'></a>
Where is the GAP source tarball which is supposed to be used here?



---

archive/issue_comments_423218.json:
```json
{
    "body": "**Changing branch** from \"[u/nthiery/upgrade_to_gap_4_9](https://github.com/sagemath/sagetrac-mirror/tree/u/nthiery/upgrade_to_gap_4_9)\" to \"[u/jdemeyer/upgrade_to_gap_4_9](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/upgrade_to_gap_4_9)\".",
    "created_at": "2018-05-01T11:31:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423218",
    "user": "https://github.com/jdemeyer"
}
```

**Changing branch** from "[u/nthiery/upgrade_to_gap_4_9](https://github.com/sagemath/sagetrac-mirror/tree/u/nthiery/upgrade_to_gap_4_9)" to "[u/jdemeyer/upgrade_to_gap_4_9](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/upgrade_to_gap_4_9)".



---

archive/issue_comments_423219.json:
```json
{
    "body": "**Changing commit** from \"[7c04025083d61cab671df3302c32f353c4e28313](https://github.com/sagemath/sagetrac-mirror/commit/7c04025083d61cab671df3302c32f353c4e28313)\" to \"[b7278a120c5db710d1e11297b3dd1411d69d302b](https://github.com/sagemath/sagetrac-mirror/commit/b7278a120c5db710d1e11297b3dd1411d69d302b)\".",
    "created_at": "2018-05-01T11:33:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423219",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[7c04025083d61cab671df3302c32f353c4e28313](https://github.com/sagemath/sagetrac-mirror/commit/7c04025083d61cab671df3302c32f353c4e28313)" to "[b7278a120c5db710d1e11297b3dd1411d69d302b](https://github.com/sagemath/sagetrac-mirror/commit/b7278a120c5db710d1e11297b3dd1411d69d302b)".



---

archive/issue_comments_423220.json:
```json
{
    "body": "<a id='comment:53'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/72b5066bb6b1606bef5d7e88c1a8d5fab62b5192\">72b5066</a></td><td><code>Unprefixed libGAP interface</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b7278a120c5db710d1e11297b3dd1411d69d302b\">b7278a1</a></td><td><code>Upgrade to GAP 4.9</code></td></tr></table>\n",
    "created_at": "2018-05-01T11:33:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423220",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:53'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/72b5066bb6b1606bef5d7e88c1a8d5fab62b5192">72b5066</a></td><td><code>Unprefixed libGAP interface</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b7278a120c5db710d1e11297b3dd1411d69d302b">b7278a1</a></td><td><code>Upgrade to GAP 4.9</code></td></tr></table>




---

archive/issue_comments_423221.json:
```json
{
    "body": "<a id='comment:54'></a>\nReplying to [jdemeyer](#comment%3A51):\n> Where is the GAP source tarball which is supposed to be used here?\n\nhere:\nhttps://www.gap-system.org/pub/gap/gap-4.9/beta/",
    "created_at": "2018-05-01T11:35:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423221",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:54'></a>
Replying to [jdemeyer](#comment%3A51):
> Where is the GAP source tarball which is supposed to be used here?

here:
https://www.gap-system.org/pub/gap/gap-4.9/beta/



---

archive/issue_comments_423222.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -3,7 +3,7 @@\n \n The branch attached to this ticket updates Sage to run on top of\n [a branch of GAP](https://github.com/markuspf/gap/tree/hpc-merge-libgap)\n-by Markus Pfeiffer that adds libgap compilation and [will be merged](https://github.com/fingolfin/gap/pull/64) soon in the devel version of GAP.\n+by Markus Pfeiffer that adds libgap compilation and [will be merged](https://github.com/gap-system/gap/pull/1205) soon in the devel version of GAP.\n \n See https://github.com/markuspf/gap/issues/2 for the few sticking points that could prevent using a vanilla GAP from the distribution (please edit further if you think about more of them).\n \n@@ -13,7 +13,7 @@\n \n - Update the gap spkg to the new build system and build and install libgap\n \n-- Replace gap.shi.patch by a plain gap startup script for Sage\n+- Replace `gap.shi.patch` by a plain gap startup script for Sage\n \n   Rationale: GAP used to provide a startup shell script. The GAP devs\n   are in the process of getting rid of it and provide a very minimal\n@@ -22,7 +22,7 @@\n - Update a few doctests w.r.t. changes of output of some GAP functions\n \n - **Possibly controversial:** The new libgap currently *does not come*\n-  with symbol rewriting (Foo -> libGAP_Foo). This avoids messing\n+  with symbol rewriting (`foobar` -> `libGAP_foobar`). This avoids messing\n   around with GAP's sources; in particular opening the door for using\n   a stock GAP from the OS distribution. However there always is a risk\n   of name conflict. And indeed, GAP's constants (actually cpp macros)\n@@ -51,13 +51,10 @@\n TODO:\n \n - Automatic handling of headers (see below for how to do it by hand).\n-  GAP's build system will eventuall provide a rule to install headers\n+  GAP's build system will eventually provide a rule to install headers\n   which will make this trivial.\n \n - Use GAP's own `make install` [when it will be implemented](https://github.com/fingolfin/gap/issues/44).\n-\n-- Update the documentation in sage.libs.gap.libgap.pyx to not mention\n-  the `libgap_` prefix\n \n - Check against #19915 to see if any of the changes there should be\n   ported here. Then close as won't fix.\n@@ -162,4 +159,3 @@\n ```\n This should be fixed once GAP's gap binary is built on top of libgap.\n See: https://github.com/markuspf/gap/issues/1.\n-\n``````\n",
    "created_at": "2018-05-01T13:06:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423222",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -3,7 +3,7 @@
 
 The branch attached to this ticket updates Sage to run on top of
 [a branch of GAP](https://github.com/markuspf/gap/tree/hpc-merge-libgap)
-by Markus Pfeiffer that adds libgap compilation and [will be merged](https://github.com/fingolfin/gap/pull/64) soon in the devel version of GAP.
+by Markus Pfeiffer that adds libgap compilation and [will be merged](https://github.com/gap-system/gap/pull/1205) soon in the devel version of GAP.
 
 See https://github.com/markuspf/gap/issues/2 for the few sticking points that could prevent using a vanilla GAP from the distribution (please edit further if you think about more of them).
 
@@ -13,7 +13,7 @@
 
 - Update the gap spkg to the new build system and build and install libgap
 
-- Replace gap.shi.patch by a plain gap startup script for Sage
+- Replace `gap.shi.patch` by a plain gap startup script for Sage
 
   Rationale: GAP used to provide a startup shell script. The GAP devs
   are in the process of getting rid of it and provide a very minimal
@@ -22,7 +22,7 @@
 - Update a few doctests w.r.t. changes of output of some GAP functions
 
 - **Possibly controversial:** The new libgap currently *does not come*
-  with symbol rewriting (Foo -> libGAP_Foo). This avoids messing
+  with symbol rewriting (`foobar` -> `libGAP_foobar`). This avoids messing
   around with GAP's sources; in particular opening the door for using
   a stock GAP from the OS distribution. However there always is a risk
   of name conflict. And indeed, GAP's constants (actually cpp macros)
@@ -51,13 +51,10 @@
 TODO:
 
 - Automatic handling of headers (see below for how to do it by hand).
-  GAP's build system will eventuall provide a rule to install headers
+  GAP's build system will eventually provide a rule to install headers
   which will make this trivial.
 
 - Use GAP's own `make install` [when it will be implemented](https://github.com/fingolfin/gap/issues/44).
-
-- Update the documentation in sage.libs.gap.libgap.pyx to not mention
-  the `libgap_` prefix
 
 - Check against #19915 to see if any of the changes there should be
   ported here. Then close as won't fix.
@@ -162,4 +159,3 @@
 ```
 This should be fixed once GAP's gap binary is built on top of libgap.
 See: https://github.com/markuspf/gap/issues/1.
-
``````




---

archive/issue_comments_423223.json:
```json
{
    "body": "Replying to [ticket:22626 nthiery]:\n> The branch attached to this ticket updates Sage to run on top of\n> [a branch of GAP](https://github.com/markuspf/gap/tree/hpc-merge-libgap)\n> by Markus Pfeiffer that adds libgap compilation and [will be merged](https://github.com/gap-system/gap/pull/1205) soon in the devel version of GAP.\n\n\nIt seems that this branch which \"will be merged soon\" is still not merged. It would be good to have an idea of whether or not that will happen.",
    "created_at": "2018-05-01T13:12:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423223",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [ticket:22626 nthiery]:
> The branch attached to this ticket updates Sage to run on top of
> [a branch of GAP](https://github.com/markuspf/gap/tree/hpc-merge-libgap)
> by Markus Pfeiffer that adds libgap compilation and [will be merged](https://github.com/gap-system/gap/pull/1205) soon in the devel version of GAP.


It seems that this branch which "will be merged soon" is still not merged. It would be good to have an idea of whether or not that will happen.



---

archive/issue_comments_423224.json:
```json
{
    "body": "<a id='comment:57'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d28b5757ad45cd54ae70adf25c72fcefef8b1a01\">d28b575</a></td><td><code>Unprefixed libGAP interface</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/daf8754b706bf416680d7693b71d73ca95329ad5\">daf8754</a></td><td><code>Unprefixed libGAP interface</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/40e644a16bafa77e4b93e72c215f53a4afb19cc1\">40e644a</a></td><td><code>Upgrade to GAP 4.9</code></td></tr></table>\n",
    "created_at": "2018-05-01T13:14:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423224",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:57'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d28b5757ad45cd54ae70adf25c72fcefef8b1a01">d28b575</a></td><td><code>Unprefixed libGAP interface</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/daf8754b706bf416680d7693b71d73ca95329ad5">daf8754</a></td><td><code>Unprefixed libGAP interface</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/40e644a16bafa77e4b93e72c215f53a4afb19cc1">40e644a</a></td><td><code>Upgrade to GAP 4.9</code></td></tr></table>




---

archive/issue_comments_423225.json:
```json
{
    "body": "**Changing commit** from \"[b7278a120c5db710d1e11297b3dd1411d69d302b](https://github.com/sagemath/sagetrac-mirror/commit/b7278a120c5db710d1e11297b3dd1411d69d302b)\" to \"[40e644a16bafa77e4b93e72c215f53a4afb19cc1](https://github.com/sagemath/sagetrac-mirror/commit/40e644a16bafa77e4b93e72c215f53a4afb19cc1)\".",
    "created_at": "2018-05-01T13:14:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423225",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[b7278a120c5db710d1e11297b3dd1411d69d302b](https://github.com/sagemath/sagetrac-mirror/commit/b7278a120c5db710d1e11297b3dd1411d69d302b)" to "[40e644a16bafa77e4b93e72c215f53a4afb19cc1](https://github.com/sagemath/sagetrac-mirror/commit/40e644a16bafa77e4b93e72c215f53a4afb19cc1)".



---

archive/issue_comments_423226.json:
```json
{
    "body": "<a id='comment:58'></a>\nAccording to https://github.com/gap-system/gap/pull/1205#issuecomment-385670578,\nMarkus's libgap branch won't be merged in GAP 4.9: it's not yet ready enough. Bummer.\n\nWe are discussing with Sebastian and Thomas what we can do to move forward here. They\nare very interested as well by libgap for the integration between GAP and Julia.\n\nTentative steps:\n- As a warm up, upgrade our current gap and libgap spkg to 4.8.10\n- Upgrade our current gap and libgap spkg to 4.9; with the many changes to\n  the build system, this may get more tricky\n- To make the switch to GAP's libgap less urgent, investigate whether we could change\n  our current libgap spkg to not prefix GAP symbols, in order to be able to \n  use GAP's dynamic packages; see #25273\n- On the GAP side: move toward more incremental changes. In particular,\n  extract the changesets from Markus branch that are non\n  controversial and ready, and get them merged in GAP (4.9? 4.10?)",
    "created_at": "2018-05-01T15:41:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423226",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:58'></a>
According to https://github.com/gap-system/gap/pull/1205#issuecomment-385670578,
Markus's libgap branch won't be merged in GAP 4.9: it's not yet ready enough. Bummer.

We are discussing with Sebastian and Thomas what we can do to move forward here. They
are very interested as well by libgap for the integration between GAP and Julia.

Tentative steps:
- As a warm up, upgrade our current gap and libgap spkg to 4.8.10
- Upgrade our current gap and libgap spkg to 4.9; with the many changes to
  the build system, this may get more tricky
- To make the switch to GAP's libgap less urgent, investigate whether we could change
  our current libgap spkg to not prefix GAP symbols, in order to be able to 
  use GAP's dynamic packages; see #25273
- On the GAP side: move toward more incremental changes. In particular,
  extract the changesets from Markus branch that are non
  controversial and ready, and get them merged in GAP (4.9? 4.10?)



---

archive/issue_events_067112.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2018-05-14T11:17:35Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "milestone": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22626#event-67112"
}
```



---

archive/issue_comments_423227.json:
```json
{
    "body": "<a id='comment:61'></a>\n[GAP 4.9.1 was released](https://mail.gap-system.org/pipermail/forum/2018/005741.html) in May 2018.\n\nThis is the first stable release of GAP 4.9 (GAP 4.9.0 was a beta for GAP 4.9).",
    "created_at": "2018-05-14T11:17:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423227",
    "user": "https://github.com/slel"
}
```

<a id='comment:61'></a>
[GAP 4.9.1 was released](https://mail.gap-system.org/pipermail/forum/2018/005741.html) in May 2018.

This is the first stable release of GAP 4.9 (GAP 4.9.0 was a beta for GAP 4.9).



---

archive/issue_comments_423228.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,11 +1,18 @@\n-GAP 4.9 will come with a completely rewritten build system that will\n-simplify our packaging. In fact, it may well enable Sage to use a vanilla GAP installation as provided by the distribution. It will also enable building GAP as a library, so that we can get rid of our separate libgap package.\n+GAP 4.9 comes with a completely rewritten build system that will simplify\n+our packaging. In fact, it may well enable Sage to use a vanilla GAP\n+installation as provided by the distribution.\n+\n+The GAP team will not provide libGAP with GAP 4.9, but only with GAP 4.10.\n \n The branch attached to this ticket updates Sage to run on top of\n [a branch of GAP](https://github.com/markuspf/gap/tree/hpc-merge-libgap)\n-by Markus Pfeiffer that adds libgap compilation and [will be merged](https://github.com/gap-system/gap/pull/1205) soon in the devel version of GAP.\n+by Markus Pfeiffer that adds libgap compilation and\n+[might be merged](https://github.com/gap-system/gap/pull/1205)\n+soon in the devel version of GAP.\n \n-See https://github.com/markuspf/gap/issues/2 for the few sticking points that could prevent using a vanilla GAP from the distribution (please edit further if you think about more of them).\n+See https://github.com/markuspf/gap/issues/2 for the few sticking points\n+that could prevent using a vanilla GAP from the distribution (please edit\n+further if you think about more of them).\n \n What the branch does:\n \n@@ -159,3 +166,8 @@\n ```\n This should be fixed once GAP's gap binary is built on top of libgap.\n See: https://github.com/markuspf/gap/issues/1.\n+\n+Note:\n+\n+- [GAP 4.9.1 was released](https://mail.gap-system.org/pipermail/forum/2018/005741.html) in May 2018.\n+  This is the first stable release of GAP 4.9 (GAP 4.9.0 was a beta for GAP 4.9).\n``````\n",
    "created_at": "2018-05-14T11:17:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423228",
    "user": "https://github.com/slel"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,11 +1,18 @@
-GAP 4.9 will come with a completely rewritten build system that will
-simplify our packaging. In fact, it may well enable Sage to use a vanilla GAP installation as provided by the distribution. It will also enable building GAP as a library, so that we can get rid of our separate libgap package.
+GAP 4.9 comes with a completely rewritten build system that will simplify
+our packaging. In fact, it may well enable Sage to use a vanilla GAP
+installation as provided by the distribution.
+
+The GAP team will not provide libGAP with GAP 4.9, but only with GAP 4.10.
 
 The branch attached to this ticket updates Sage to run on top of
 [a branch of GAP](https://github.com/markuspf/gap/tree/hpc-merge-libgap)
-by Markus Pfeiffer that adds libgap compilation and [will be merged](https://github.com/gap-system/gap/pull/1205) soon in the devel version of GAP.
+by Markus Pfeiffer that adds libgap compilation and
+[might be merged](https://github.com/gap-system/gap/pull/1205)
+soon in the devel version of GAP.
 
-See https://github.com/markuspf/gap/issues/2 for the few sticking points that could prevent using a vanilla GAP from the distribution (please edit further if you think about more of them).
+See https://github.com/markuspf/gap/issues/2 for the few sticking points
+that could prevent using a vanilla GAP from the distribution (please edit
+further if you think about more of them).
 
 What the branch does:
 
@@ -159,3 +166,8 @@
 ```
 This should be fixed once GAP's gap binary is built on top of libgap.
 See: https://github.com/markuspf/gap/issues/1.
+
+Note:
+
+- [GAP 4.9.1 was released](https://mail.gap-system.org/pipermail/forum/2018/005741.html) in May 2018.
+  This is the first stable release of GAP 4.9 (GAP 4.9.0 was a beta for GAP 4.9).
``````




---

archive/issue_comments_423229.json:
```json
{
    "body": "<a id='comment:63'></a>\nI'm confused - I just built GAP 4.9.1 from the upstream tarball and 'make install' *does* install /usr/lib/libgap.so and libgap's headers. Is this a different libgap than the one mentioned here to be included in 4.10?",
    "created_at": "2018-05-14T11:24:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423229",
    "user": "https://github.com/antonio-rojas"
}
```

<a id='comment:63'></a>
I'm confused - I just built GAP 4.9.1 from the upstream tarball and 'make install' *does* install /usr/lib/libgap.so and libgap's headers. Is this a different libgap than the one mentioned here to be included in 4.10?



---

archive/issue_comments_423230.json:
```json
{
    "body": "<a id='comment:64'></a>\nOne comment at pull request 1205 in GAP's github repo said\nGAP won't ship libGAP before GAP 4.10:\n\n- [GAP discussion: no libgap before GAP 4.10](https://github.com/gap-system/gap/pull/1205#issuecomment-385670578)\n\nMaybe this was changed though.",
    "created_at": "2018-05-14T13:47:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423230",
    "user": "https://github.com/slel"
}
```

<a id='comment:64'></a>
One comment at pull request 1205 in GAP's github repo said
GAP won't ship libGAP before GAP 4.10:

- [GAP discussion: no libgap before GAP 4.10](https://github.com/gap-system/gap/pull/1205#issuecomment-385670578)

Maybe this was changed though.



---

archive/issue_comments_423231.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -171,3 +171,4 @@\n \n - [GAP 4.9.1 was released](https://mail.gap-system.org/pipermail/forum/2018/005741.html) in May 2018.\n   This is the first stable release of GAP 4.9 (GAP 4.9.0 was a beta for GAP 4.9).\n+- Max Horn reviewed the list of GAP symbols we use in Sage; some have already changed in 4.9. See this [pad](https://hackmd.io/emNi76svSWCh1fBeLKqPdA?edit#) for notes.\n``````\n",
    "created_at": "2018-06-07T15:20:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423231",
    "user": "https://github.com/nthiery"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -171,3 +171,4 @@
 
 - [GAP 4.9.1 was released](https://mail.gap-system.org/pipermail/forum/2018/005741.html) in May 2018.
   This is the first stable release of GAP 4.9 (GAP 4.9.0 was a beta for GAP 4.9).
+- Max Horn reviewed the list of GAP symbols we use in Sage; some have already changed in 4.9. See this [pad](https://hackmd.io/emNi76svSWCh1fBeLKqPdA?edit#) for notes.
``````




---

archive/issue_comments_423232.json:
```json
{
    "body": "<a id='comment:66'></a>\nHas anybody asked GAP developers for a policy on the prefixing?\n\nIn Cernay, I proposed that GAP should prefix some/all of their names like `T_INT` -> `GAP_T_INT`. For compiling GAP (+ GAP packages) itself, we can use a file with defines like\n\n```\n#define  T_INT  GAP_T_INT\n```\nto ensure backwards compatibility. This way, in GAP itself, one could use either `T_INT` or `GAP_T_INT`. Outside of GAP, only `GAP_T_INT` would work.\n\nI think this is relatively easy to implement (I'm willing to do it) but I don't know what upstream GAP thinks of it.",
    "created_at": "2018-06-07T15:33:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423232",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:66'></a>
Has anybody asked GAP developers for a policy on the prefixing?

In Cernay, I proposed that GAP should prefix some/all of their names like `T_INT` -> `GAP_T_INT`. For compiling GAP (+ GAP packages) itself, we can use a file with defines like

```
#define  T_INT  GAP_T_INT
```
to ensure backwards compatibility. This way, in GAP itself, one could use either `T_INT` or `GAP_T_INT`. Outside of GAP, only `GAP_T_INT` would work.

I think this is relatively easy to implement (I'm willing to do it) but I don't know what upstream GAP thinks of it.



---

archive/issue_comments_423233.json:
```json
{
    "body": "<a id='comment:68'></a>\n[GAP 4.9.2](http://www.gap-system.org/Releases/4.9.2.html) was released in July 2018.",
    "created_at": "2018-07-09T12:05:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423233",
    "user": "https://github.com/slel"
}
```

<a id='comment:68'></a>
[GAP 4.9.2](http://www.gap-system.org/Releases/4.9.2.html) was released in July 2018.



---

archive/issue_comments_423234.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -169,6 +169,7 @@\n \n Note:\n \n-- [GAP 4.9.1 was released](https://mail.gap-system.org/pipermail/forum/2018/005741.html) in May 2018.\n-  This is the first stable release of GAP 4.9 (GAP 4.9.0 was a beta for GAP 4.9).\n+- [GAP 4.9.2](http://www.gap-system.org/Releases/4.9.2.html) was released in July 2018.\n+- [GAP 4.9.1](http://www.gap-system.org/Releases/4.9.1.html), released in May 2018,\n+  was the first stable release of GAP 4.9 (GAP 4.9.0 was a beta for GAP 4.9).\n - Max Horn reviewed the list of GAP symbols we use in Sage; some have already changed in 4.9. See this [pad](https://hackmd.io/emNi76svSWCh1fBeLKqPdA?edit#) for notes.\n``````\n",
    "created_at": "2018-07-09T12:05:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423234",
    "user": "https://github.com/slel"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -169,6 +169,7 @@
 
 Note:
 
-- [GAP 4.9.1 was released](https://mail.gap-system.org/pipermail/forum/2018/005741.html) in May 2018.
-  This is the first stable release of GAP 4.9 (GAP 4.9.0 was a beta for GAP 4.9).
+- [GAP 4.9.2](http://www.gap-system.org/Releases/4.9.2.html) was released in July 2018.
+- [GAP 4.9.1](http://www.gap-system.org/Releases/4.9.1.html), released in May 2018,
+  was the first stable release of GAP 4.9 (GAP 4.9.0 was a beta for GAP 4.9).
 - Max Horn reviewed the list of GAP symbols we use in Sage; some have already changed in 4.9. See this [pad](https://hackmd.io/emNi76svSWCh1fBeLKqPdA?edit#) for notes.
``````




---

archive/issue_comments_423235.json:
```json
{
    "body": "<a id='comment:70'></a>\nHi,\n\nFor the record: I experimented a bit a month ago and a bit more\nthis morning with Dima with the latest gap master that\nhas `make libgap` and `make install-libgap` rules.\nSee the following branch, which builds libgap from GAP's pristine\nsources:\n\nhttps://git.sagemath.org/sage.git/log/?h=u/nthiery/gap-libgap\n\nNote that, at this stage, Sage won't start with it; maybe even not compile.",
    "created_at": "2018-07-14T12:40:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423235",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:70'></a>
Hi,

For the record: I experimented a bit a month ago and a bit more
this morning with Dima with the latest gap master that
has `make libgap` and `make install-libgap` rules.
See the following branch, which builds libgap from GAP's pristine
sources:

https://git.sagemath.org/sage.git/log/?h=u/nthiery/gap-libgap

Note that, at this stage, Sage won't start with it; maybe even not compile.



---

archive/issue_comments_423236.json:
```json
{
    "body": "<a id='comment:71'></a>\n> Has anybody asked GAP developers for a policy on the prefixing?\n> \n> In Cernay, I proposed that GAP should prefix some/all of their names like `T_INT` -> `GAP_T_INT`. For compiling GAP (+ GAP packages) itself, we can use a file with defines like\n> \n> ```\n> #define  T_INT  GAP_T_INT\n> ```\n> to ensure backwards compatibility. This way, in GAP itself, one could use either `T_INT` or `GAP_T_INT`. Outside of GAP, only `GAP_T_INT` would work.\n> \n> I think this is relatively easy to implement (I'm willing to do it) but I don't know what upstream GAP thinks of it.\n\n\nThat's the idea indeed. Eventually they will provide a standalone header file that will\ndefine the official GAP API, and where all symbols will be prefixed. To bootstrap the\nprocess, we (well mostly Max!) reviewed and annotated the symbols that are used in Sage:\n\n    https://hackmd.io/emNi76svSWCh1fBeLKqPdA#",
    "created_at": "2018-07-14T12:45:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423236",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:71'></a>
> Has anybody asked GAP developers for a policy on the prefixing?
> 
> In Cernay, I proposed that GAP should prefix some/all of their names like `T_INT` -> `GAP_T_INT`. For compiling GAP (+ GAP packages) itself, we can use a file with defines like
> 
> ```
> #define  T_INT  GAP_T_INT
> ```
> to ensure backwards compatibility. This way, in GAP itself, one could use either `T_INT` or `GAP_T_INT`. Outside of GAP, only `GAP_T_INT` would work.
> 
> I think this is relatively easy to implement (I'm willing to do it) but I don't know what upstream GAP thinks of it.


That's the idea indeed. Eventually they will provide a standalone header file that will
define the official GAP API, and where all symbols will be prefixed. To bootstrap the
process, we (well mostly Max!) reviewed and annotated the symbols that are used in Sage:

    https://hackmd.io/emNi76svSWCh1fBeLKqPdA#



---

archive/issue_comments_423237.json:
```json
{
    "body": "<a id='comment:72'></a>\nThank you for working on this! Sage using an up-to-date gap and doing away with the additional libgap package will simplify packaging.",
    "created_at": "2018-07-14T17:27:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423237",
    "user": "https://github.com/timokau"
}
```

<a id='comment:72'></a>
Thank you for working on this! Sage using an up-to-date gap and doing away with the additional libgap package will simplify packaging.



---

archive/issue_comments_423238.json:
```json
{
    "body": "<a id='comment:73'></a>\nupdate milestone 8.3 -> 8.4",
    "created_at": "2018-08-03T19:20:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423238",
    "user": "https://github.com/videlec"
}
```

<a id='comment:73'></a>
update milestone 8.3 -> 8.4



---

archive/issue_events_067113.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-08-03T19:20:18Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "milestone": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22626#event-67113"
}
```



---

archive/issue_events_067114.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-08-03T19:20:18Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "milestone": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22626#event-67114"
}
```



---

archive/issue_comments_423239.json:
```json
{
    "body": "<a id='comment:74'></a>\nGAP 4.9.3 was released.\n\n- [GAP 4.9.3 release announcement](https://mail.gap-system.org/pipermail/forum/2018/005791.html)",
    "created_at": "2018-09-12T08:00:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423239",
    "user": "https://github.com/slel"
}
```

<a id='comment:74'></a>
GAP 4.9.3 was released.

- [GAP 4.9.3 release announcement](https://mail.gap-system.org/pipermail/forum/2018/005791.html)



---

archive/issue_comments_423240.json:
```json
{
    "body": "**Changing work_issues** from \"Wait for gap 4.9 release\" to \"Wait for gap 4.10 release\".",
    "created_at": "2018-09-16T14:51:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423240",
    "user": "https://github.com/dimpase"
}
```

**Changing work_issues** from "Wait for gap 4.9 release" to "Wait for gap 4.10 release".



---

archive/issue_events_067115.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "rename": {
        "from": "Upgrade to GAP 4.9",
        "to": "Upgrade to GAP 4.10"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22626#event-67115"
}
```



---

archive/issue_comments_423241.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -2,7 +2,7 @@\n our packaging. In fact, it may well enable Sage to use a vanilla GAP\n installation as provided by the distribution.\n \n-The GAP team will not provide libGAP with GAP 4.9, but only with GAP 4.10.\n+The GAP team will provide libGAP with GAP 4.10.\n \n The branch attached to this ticket updates Sage to run on top of\n [a branch of GAP](https://github.com/markuspf/gap/tree/hpc-merge-libgap)\n``````\n",
    "created_at": "2018-09-16T14:51:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423241",
    "user": "https://github.com/dimpase"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -2,7 +2,7 @@
 our packaging. In fact, it may well enable Sage to use a vanilla GAP
 installation as provided by the distribution.
 
-The GAP team will not provide libGAP with GAP 4.9, but only with GAP 4.10.
+The GAP team will provide libGAP with GAP 4.10.
 
 The branch attached to this ticket updates Sage to run on top of
 [a branch of GAP](https://github.com/markuspf/gap/tree/hpc-merge-libgap)
``````




---

archive/issue_comments_423242.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,18 +1,14 @@\n-GAP 4.9 comes with a completely rewritten build system that will simplify\n+GAP 4.9 came with a completely rewritten build system that will simplify\n our packaging. In fact, it may well enable Sage to use a vanilla GAP\n installation as provided by the distribution.\n \n The GAP team will provide libGAP with GAP 4.10.\n \n-The branch attached to this ticket updates Sage to run on top of\n-[a branch of GAP](https://github.com/markuspf/gap/tree/hpc-merge-libgap)\n-by Markus Pfeiffer that adds libgap compilation and\n-[might be merged](https://github.com/gap-system/gap/pull/1205)\n-soon in the devel version of GAP.\n+The branch attached to this ticket updates Sage to run on top of the current GAP dev branch. (the  branch of GAP \n+by Markus Pfeiffer that adds libgap compilation has been merged).\n \n-See https://github.com/markuspf/gap/issues/2 for the few sticking points\n-that could prevent using a vanilla GAP from the distribution (please edit\n-further if you think about more of them).\n+Some historical notes may be found in https://github.com/markuspf/gap/issues/2\n+\n \n What the branch does:\n \n@@ -53,7 +49,7 @@\n can explain, e.g. change of orders in lists of elements. So those\n should be nothing to worry about. There is not much point in updating\n those doctests right away; we may as well wait for a more final\n-version of 4.9 to be out.\n+version of 4.10 to be out.\n \n TODO:\n \n@@ -70,14 +66,11 @@\n \n - ???\n \n-Fetching Markus's GAP sources:\n+Fetching  GAP sources:\n \n ```\n-git clone git@github.com:markuspf/gap.git $LIBGAP\n+git clone git@github.com:gap-system/gap.git $LIBGAP\n cd $LIBGAP\n-git remote add markuspf git@github.com:markuspf/gap.git\n-git fetch markuspf\n-git checkout -b markuspf/hpc-merge-libgap\n ./autogen.sh\n ./configure\n make bootstrap-pkg-minimal\n@@ -87,9 +80,9 @@\n Testing libgap:\n \n ```\n-./configure --enable-libgap\n-make -j4 libgap\n-make test-libgap\n+./configure\n+make -j4\n+make testlibgap\n ```\n \n Build and install a tardist for Sage, and rebuild the spkg:\n@@ -101,7 +94,7 @@\n make manuals\n make clean\n \n-(cd ..; tar zcvf $SAGE/upstream/$GAP.tar.gz --exclude .git $GAP)\n+(cd ..; mv $GAP src; tar zcvf $SAGE/upstream/$GAP.tar.gz --exclude .git src)\n \n sage --package fix-checksum\n sage -f gap                      # -s\n``````\n",
    "created_at": "2018-09-17T14:00:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423242",
    "user": "https://github.com/dimpase"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,18 +1,14 @@
-GAP 4.9 comes with a completely rewritten build system that will simplify
+GAP 4.9 came with a completely rewritten build system that will simplify
 our packaging. In fact, it may well enable Sage to use a vanilla GAP
 installation as provided by the distribution.
 
 The GAP team will provide libGAP with GAP 4.10.
 
-The branch attached to this ticket updates Sage to run on top of
-[a branch of GAP](https://github.com/markuspf/gap/tree/hpc-merge-libgap)
-by Markus Pfeiffer that adds libgap compilation and
-[might be merged](https://github.com/gap-system/gap/pull/1205)
-soon in the devel version of GAP.
+The branch attached to this ticket updates Sage to run on top of the current GAP dev branch. (the  branch of GAP 
+by Markus Pfeiffer that adds libgap compilation has been merged).
 
-See https://github.com/markuspf/gap/issues/2 for the few sticking points
-that could prevent using a vanilla GAP from the distribution (please edit
-further if you think about more of them).
+Some historical notes may be found in https://github.com/markuspf/gap/issues/2
+
 
 What the branch does:
 
@@ -53,7 +49,7 @@
 can explain, e.g. change of orders in lists of elements. So those
 should be nothing to worry about. There is not much point in updating
 those doctests right away; we may as well wait for a more final
-version of 4.9 to be out.
+version of 4.10 to be out.
 
 TODO:
 
@@ -70,14 +66,11 @@
 
 - ???
 
-Fetching Markus's GAP sources:
+Fetching  GAP sources:
 
 ```
-git clone git@github.com:markuspf/gap.git $LIBGAP
+git clone git@github.com:gap-system/gap.git $LIBGAP
 cd $LIBGAP
-git remote add markuspf git@github.com:markuspf/gap.git
-git fetch markuspf
-git checkout -b markuspf/hpc-merge-libgap
 ./autogen.sh
 ./configure
 make bootstrap-pkg-minimal
@@ -87,9 +80,9 @@
 Testing libgap:
 
 ```
-./configure --enable-libgap
-make -j4 libgap
-make test-libgap
+./configure
+make -j4
+make testlibgap
 ```
 
 Build and install a tardist for Sage, and rebuild the spkg:
@@ -101,7 +94,7 @@
 make manuals
 make clean
 
-(cd ..; tar zcvf $SAGE/upstream/$GAP.tar.gz --exclude .git $GAP)
+(cd ..; mv $GAP src; tar zcvf $SAGE/upstream/$GAP.tar.gz --exclude .git src)
 
 sage --package fix-checksum
 sage -f gap                      # -s
``````




---

archive/issue_comments_423243.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,14 +1,18 @@\n-GAP 4.9 came with a completely rewritten build system that will simplify\n+GAP 4.9 comes with a completely rewritten build system that will simplify\n our packaging. In fact, it may well enable Sage to use a vanilla GAP\n installation as provided by the distribution.\n \n The GAP team will provide libGAP with GAP 4.10.\n \n-The branch attached to this ticket updates Sage to run on top of the current GAP dev branch. (the  branch of GAP \n-by Markus Pfeiffer that adds libgap compilation has been merged).\n+The branch attached to this ticket updates Sage to run on top of\n+[a branch of GAP](https://github.com/markuspf/gap/tree/hpc-merge-libgap)\n+by Markus Pfeiffer that adds libgap compilation and\n+[might be merged](https://github.com/gap-system/gap/pull/1205)\n+soon in the devel version of GAP.\n \n-Some historical notes may be found in https://github.com/markuspf/gap/issues/2\n-\n+See https://github.com/markuspf/gap/issues/2 for the few sticking points\n+that could prevent using a vanilla GAP from the distribution (please edit\n+further if you think about more of them).\n \n What the branch does:\n \n@@ -49,7 +53,7 @@\n can explain, e.g. change of orders in lists of elements. So those\n should be nothing to worry about. There is not much point in updating\n those doctests right away; we may as well wait for a more final\n-version of 4.10 to be out.\n+version of 4.9 to be out.\n \n TODO:\n \n@@ -66,11 +70,14 @@\n \n - ???\n \n-Fetching  GAP sources:\n+Fetching Markus's GAP sources:\n \n ```\n-git clone git@github.com:gap-system/gap.git $LIBGAP\n+git clone git@github.com:markuspf/gap.git $LIBGAP\n cd $LIBGAP\n+git remote add markuspf git@github.com:markuspf/gap.git\n+git fetch markuspf\n+git checkout -b markuspf/hpc-merge-libgap\n ./autogen.sh\n ./configure\n make bootstrap-pkg-minimal\n@@ -80,9 +87,9 @@\n Testing libgap:\n \n ```\n-./configure\n-make -j4\n-make testlibgap\n+./configure --enable-libgap\n+make -j4 libgap\n+make test-libgap\n ```\n \n Build and install a tardist for Sage, and rebuild the spkg:\n@@ -94,7 +101,7 @@\n make manuals\n make clean\n \n-(cd ..; mv $GAP src; tar zcvf $SAGE/upstream/$GAP.tar.gz --exclude .git src)\n+(cd ..; tar zcvf $SAGE/upstream/$GAP.tar.gz --exclude .git $GAP)\n \n sage --package fix-checksum\n sage -f gap                      # -s\n``````\n",
    "created_at": "2018-09-17T14:08:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423243",
    "user": "https://github.com/dimpase"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,14 +1,18 @@
-GAP 4.9 came with a completely rewritten build system that will simplify
+GAP 4.9 comes with a completely rewritten build system that will simplify
 our packaging. In fact, it may well enable Sage to use a vanilla GAP
 installation as provided by the distribution.
 
 The GAP team will provide libGAP with GAP 4.10.
 
-The branch attached to this ticket updates Sage to run on top of the current GAP dev branch. (the  branch of GAP 
-by Markus Pfeiffer that adds libgap compilation has been merged).
+The branch attached to this ticket updates Sage to run on top of
+[a branch of GAP](https://github.com/markuspf/gap/tree/hpc-merge-libgap)
+by Markus Pfeiffer that adds libgap compilation and
+[might be merged](https://github.com/gap-system/gap/pull/1205)
+soon in the devel version of GAP.
 
-Some historical notes may be found in https://github.com/markuspf/gap/issues/2
-
+See https://github.com/markuspf/gap/issues/2 for the few sticking points
+that could prevent using a vanilla GAP from the distribution (please edit
+further if you think about more of them).
 
 What the branch does:
 
@@ -49,7 +53,7 @@
 can explain, e.g. change of orders in lists of elements. So those
 should be nothing to worry about. There is not much point in updating
 those doctests right away; we may as well wait for a more final
-version of 4.10 to be out.
+version of 4.9 to be out.
 
 TODO:
 
@@ -66,11 +70,14 @@
 
 - ???
 
-Fetching  GAP sources:
+Fetching Markus's GAP sources:
 
 ```
-git clone git@github.com:gap-system/gap.git $LIBGAP
+git clone git@github.com:markuspf/gap.git $LIBGAP
 cd $LIBGAP
+git remote add markuspf git@github.com:markuspf/gap.git
+git fetch markuspf
+git checkout -b markuspf/hpc-merge-libgap
 ./autogen.sh
 ./configure
 make bootstrap-pkg-minimal
@@ -80,9 +87,9 @@
 Testing libgap:
 
 ```
-./configure
-make -j4
-make testlibgap
+./configure --enable-libgap
+make -j4 libgap
+make test-libgap
 ```
 
 Build and install a tardist for Sage, and rebuild the spkg:
@@ -94,7 +101,7 @@
 make manuals
 make clean
 
-(cd ..; mv $GAP src; tar zcvf $SAGE/upstream/$GAP.tar.gz --exclude .git src)
+(cd ..; tar zcvf $SAGE/upstream/$GAP.tar.gz --exclude .git $GAP)
 
 sage --package fix-checksum
 sage -f gap                      # -s
``````




---

archive/issue_comments_423244.json:
```json
{
    "body": "<a id='comment:77'></a>\nnote that the prefix of the tarball should start with `src/` - else one gets weird error messages from the python's tar.\n\nGAPs `make install` target now works in a preliminary form - on Linux for sure.",
    "created_at": "2018-09-17T14:08:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423244",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:77'></a>
note that the prefix of the tarball should start with `src/` - else one gets weird error messages from the python's tar.

GAPs `make install` target now works in a preliminary form - on Linux for sure.



---

archive/issue_comments_423245.json:
```json
{
    "body": "<a id='comment:78'></a>\nThis is WIP - builds, but libgap.pyx interaction loop has to be rewritten using new API.\n\nAlso, `sage --gap` is broken\n\n```\ngap: hmm, I cannot find 'lib/init.g' maybe use option '-l <gaproot>'?\n```\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c766ad6a8dba05e3eed69e6dc08c3d914ad23a08\">c766ad6</a></td><td><code>Merge branch 'u/jdemeyer/upgrade_to_gap_4_9' of trac.sagemath.org:sage into libgap</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5152637a7bd8afeb0653f23b24552036dba8e1a7\">5152637</a></td><td><code>building GAP and libGAP from GAP</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6bed83a9286c198f1137749a81add816d14c860e\">6bed83a</a></td><td><code>changes for using libGAP from GAP - part 1</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f06912253d01557727041fe3b4d03e459fb90a11\">f069122</a></td><td><code>removing util*</code></td></tr></table>\n",
    "created_at": "2018-09-18T13:51:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423245",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:78'></a>
This is WIP - builds, but libgap.pyx interaction loop has to be rewritten using new API.

Also, `sage --gap` is broken

```
gap: hmm, I cannot find 'lib/init.g' maybe use option '-l <gaproot>'?
```

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c766ad6a8dba05e3eed69e6dc08c3d914ad23a08">c766ad6</a></td><td><code>Merge branch 'u/jdemeyer/upgrade_to_gap_4_9' of trac.sagemath.org:sage into libgap</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5152637a7bd8afeb0653f23b24552036dba8e1a7">5152637</a></td><td><code>building GAP and libGAP from GAP</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6bed83a9286c198f1137749a81add816d14c860e">6bed83a</a></td><td><code>changes for using libGAP from GAP - part 1</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f06912253d01557727041fe3b4d03e459fb90a11">f069122</a></td><td><code>removing util*</code></td></tr></table>




---

archive/issue_comments_423246.json:
```json
{
    "body": "**Changing commit** from \"[40e644a16bafa77e4b93e72c215f53a4afb19cc1](https://github.com/sagemath/sagetrac-mirror/commit/40e644a16bafa77e4b93e72c215f53a4afb19cc1)\" to \"[f06912253d01557727041fe3b4d03e459fb90a11](https://github.com/sagemath/sagetrac-mirror/commit/f06912253d01557727041fe3b4d03e459fb90a11)\".",
    "created_at": "2018-09-18T13:51:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423246",
    "user": "https://github.com/dimpase"
}
```

**Changing commit** from "[40e644a16bafa77e4b93e72c215f53a4afb19cc1](https://github.com/sagemath/sagetrac-mirror/commit/40e644a16bafa77e4b93e72c215f53a4afb19cc1)" to "[f06912253d01557727041fe3b4d03e459fb90a11](https://github.com/sagemath/sagetrac-mirror/commit/f06912253d01557727041fe3b4d03e459fb90a11)".



---

archive/issue_comments_423247.json:
```json
{
    "body": "**Changing branch** from \"[u/jdemeyer/upgrade_to_gap_4_9](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/upgrade_to_gap_4_9)\" to \"[u/dimpase/WIP/libgap410](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/WIP/libgap410)\".",
    "created_at": "2018-09-18T13:51:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423247",
    "user": "https://github.com/dimpase"
}
```

**Changing branch** from "[u/jdemeyer/upgrade_to_gap_4_9](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/upgrade_to_gap_4_9)" to "[u/dimpase/WIP/libgap410](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/WIP/libgap410)".



---

archive/issue_comments_423248.json:
```json
{
    "body": "<a id='comment:79'></a>\noops, one still needs initialize() from util.pyx, in some form...",
    "created_at": "2018-09-18T20:42:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423248",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:79'></a>
oops, one still needs initialize() from util.pyx, in some form...



---

archive/issue_comments_423249.json:
```json
{
    "body": "**Changing commit** from \"[f06912253d01557727041fe3b4d03e459fb90a11](https://github.com/sagemath/sagetrac-mirror/commit/f06912253d01557727041fe3b4d03e459fb90a11)\" to \"[9c22e727f7a87271c26885e9cdc9b52583f598c5](https://github.com/sagemath/sagetrac-mirror/commit/9c22e727f7a87271c26885e9cdc9b52583f598c5)\".",
    "created_at": "2018-09-20T16:54:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423249",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[f06912253d01557727041fe3b4d03e459fb90a11](https://github.com/sagemath/sagetrac-mirror/commit/f06912253d01557727041fe3b4d03e459fb90a11)" to "[9c22e727f7a87271c26885e9cdc9b52583f598c5](https://github.com/sagemath/sagetrac-mirror/commit/9c22e727f7a87271c26885e9cdc9b52583f598c5)".



---

archive/issue_comments_423250.json:
```json
{
    "body": "<a id='comment:80'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8c28e13d0bae6909f3a3645d9951150ceffb6c09\">8c28e13</a></td><td><code>Revert \"removing util*\"</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9c22e727f7a87271c26885e9cdc9b52583f598c5\">9c22e72</a></td><td><code>few comments</code></td></tr></table>\n",
    "created_at": "2018-09-20T16:54:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423250",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:80'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8c28e13d0bae6909f3a3645d9951150ceffb6c09">8c28e13</a></td><td><code>Revert "removing util*"</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9c22e727f7a87271c26885e9cdc9b52583f598c5">9c22e72</a></td><td><code>few comments</code></td></tr></table>




---

archive/issue_comments_423251.json:
```json
{
    "body": "<a id='comment:81'></a>\nGreat to see the progress! Sounds like a productive week in Siegen. Thanks so much.",
    "created_at": "2018-09-21T09:49:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423251",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:81'></a>
Great to see the progress! Sounds like a productive week in Siegen. Thanks so much.



---

archive/issue_comments_423252.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -173,3 +173,5 @@\n - [GAP 4.9.1](http://www.gap-system.org/Releases/4.9.1.html), released in May 2018,\n   was the first stable release of GAP 4.9 (GAP 4.9.0 was a beta for GAP 4.9).\n - Max Horn reviewed the list of GAP symbols we use in Sage; some have already changed in 4.9. See this [pad](https://hackmd.io/emNi76svSWCh1fBeLKqPdA?edit#) for notes.\n+\n+Tarball : https://github.com/dimpase/gap/releases/download/dev/gap-4.dev.tar.gz\n``````\n",
    "created_at": "2018-09-21T11:03:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423252",
    "user": "https://github.com/dimpase"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -173,3 +173,5 @@
 - [GAP 4.9.1](http://www.gap-system.org/Releases/4.9.1.html), released in May 2018,
   was the first stable release of GAP 4.9 (GAP 4.9.0 was a beta for GAP 4.9).
 - Max Horn reviewed the list of GAP symbols we use in Sage; some have already changed in 4.9. See this [pad](https://hackmd.io/emNi76svSWCh1fBeLKqPdA?edit#) for notes.
+
+Tarball : https://github.com/dimpase/gap/releases/download/dev/gap-4.dev.tar.gz
``````




---

archive/issue_comments_423253.json:
```json
{
    "body": "<a id='comment:83'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/14919d3d32074d36ece1da26815e5f5d7a24812b\">14919d3</a></td><td><code>update util and the GAP package</code></td></tr></table>\n",
    "created_at": "2018-09-21T11:04:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423253",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:83'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/14919d3d32074d36ece1da26815e5f5d7a24812b">14919d3</a></td><td><code>update util and the GAP package</code></td></tr></table>




---

archive/issue_comments_423254.json:
```json
{
    "body": "**Changing commit** from \"[9c22e727f7a87271c26885e9cdc9b52583f598c5](https://github.com/sagemath/sagetrac-mirror/commit/9c22e727f7a87271c26885e9cdc9b52583f598c5)\" to \"[14919d3d32074d36ece1da26815e5f5d7a24812b](https://github.com/sagemath/sagetrac-mirror/commit/14919d3d32074d36ece1da26815e5f5d7a24812b)\".",
    "created_at": "2018-09-21T11:04:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423254",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[9c22e727f7a87271c26885e9cdc9b52583f598c5](https://github.com/sagemath/sagetrac-mirror/commit/9c22e727f7a87271c26885e9cdc9b52583f598c5)" to "[14919d3d32074d36ece1da26815e5f5d7a24812b](https://github.com/sagemath/sagetrac-mirror/commit/14919d3d32074d36ece1da26815e5f5d7a24812b)".



---

archive/issue_comments_423255.json:
```json
{
    "body": "<a id='comment:84'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b3dc304efe7be5f6676d14dd29afd4eec5d98f9c\">b3dc304</a></td><td><code>Merge branch 'develop' into libgap</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8a8a1463c8a6ca6b4d30db9b701324467c890332\">8a8a146</a></td><td><code>use MarkBag instead of MARK_BAG</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c5a5d4fdc4df0b498e5d122171fb4046fd547c6e\">c5a5d4f</a></td><td><code>no more *_BAG, and a call signature fix</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d13fc80ab79ffb9c2bea07718918f05b17cc27b6\">d13fc80</a></td><td><code>more compilation fixes</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8b5ccbe6323feb8ded8cf71cf1d00faa71da59c5\">8b5ccbe</a></td><td><code>removed debugging utils (they need a rewrite)</code></td></tr></table>\n",
    "created_at": "2018-09-25T16:05:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423255",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:84'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b3dc304efe7be5f6676d14dd29afd4eec5d98f9c">b3dc304</a></td><td><code>Merge branch 'develop' into libgap</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8a8a1463c8a6ca6b4d30db9b701324467c890332">8a8a146</a></td><td><code>use MarkBag instead of MARK_BAG</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c5a5d4fdc4df0b498e5d122171fb4046fd547c6e">c5a5d4f</a></td><td><code>no more *_BAG, and a call signature fix</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d13fc80ab79ffb9c2bea07718918f05b17cc27b6">d13fc80</a></td><td><code>more compilation fixes</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8b5ccbe6323feb8ded8cf71cf1d00faa71da59c5">8b5ccbe</a></td><td><code>removed debugging utils (they need a rewrite)</code></td></tr></table>




---

archive/issue_comments_423256.json:
```json
{
    "body": "**Changing commit** from \"[14919d3d32074d36ece1da26815e5f5d7a24812b](https://github.com/sagemath/sagetrac-mirror/commit/14919d3d32074d36ece1da26815e5f5d7a24812b)\" to \"[8b5ccbe6323feb8ded8cf71cf1d00faa71da59c5](https://github.com/sagemath/sagetrac-mirror/commit/8b5ccbe6323feb8ded8cf71cf1d00faa71da59c5)\".",
    "created_at": "2018-09-25T16:05:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423256",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[14919d3d32074d36ece1da26815e5f5d7a24812b](https://github.com/sagemath/sagetrac-mirror/commit/14919d3d32074d36ece1da26815e5f5d7a24812b)" to "[8b5ccbe6323feb8ded8cf71cf1d00faa71da59c5](https://github.com/sagemath/sagetrac-mirror/commit/8b5ccbe6323feb8ded8cf71cf1d00faa71da59c5)".



---

archive/issue_comments_423257.json:
```json
{
    "body": "<a id='comment:85'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a0616deb562afcf9d5b1a8a4e02406b4a0479038\">a0616de</a></td><td><code>adding --nointeract to libgap startup options</code></td></tr></table>\n",
    "created_at": "2018-09-25T16:46:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423257",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:85'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a0616deb562afcf9d5b1a8a4e02406b4a0479038">a0616de</a></td><td><code>adding --nointeract to libgap startup options</code></td></tr></table>




---

archive/issue_comments_423258.json:
```json
{
    "body": "**Changing commit** from \"[8b5ccbe6323feb8ded8cf71cf1d00faa71da59c5](https://github.com/sagemath/sagetrac-mirror/commit/8b5ccbe6323feb8ded8cf71cf1d00faa71da59c5)\" to \"[a0616deb562afcf9d5b1a8a4e02406b4a0479038](https://github.com/sagemath/sagetrac-mirror/commit/a0616deb562afcf9d5b1a8a4e02406b4a0479038)\".",
    "created_at": "2018-09-25T16:46:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423258",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[8b5ccbe6323feb8ded8cf71cf1d00faa71da59c5](https://github.com/sagemath/sagetrac-mirror/commit/8b5ccbe6323feb8ded8cf71cf1d00faa71da59c5)" to "[a0616deb562afcf9d5b1a8a4e02406b4a0479038](https://github.com/sagemath/sagetrac-mirror/commit/a0616deb562afcf9d5b1a8a4e02406b4a0479038)".



---

archive/issue_comments_423259.json:
```json
{
    "body": "<a id='comment:86'></a>\nat this point I am at\n\n```\nsage: libgap(1)\nError, Variable: '_rich_repr_' must have a value\nError, Variable: '_ipython_canary_method_should_not_exist_' must have a\\\n value\n[... several more errors like above]\ngap: panic, could not open *errout*!\n```",
    "created_at": "2018-09-25T16:49:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423259",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:86'></a>
at this point I am at

```
sage: libgap(1)
Error, Variable: '_rich_repr_' must have a value
Error, Variable: '_ipython_canary_method_should_not_exist_' must have a\
 value
[... several more errors like above]
gap: panic, could not open *errout*!
```



---

archive/issue_comments_423260.json:
```json
{
    "body": "<a id='comment:87'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9cc327f6004c1a16819774fd34cf5fc48ff4a001\">9cc327f</a></td><td><code>adding --nointeract to libgap startup options</code></td></tr></table>\n",
    "created_at": "2018-09-25T17:59:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423260",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:87'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9cc327f6004c1a16819774fd34cf5fc48ff4a001">9cc327f</a></td><td><code>adding --nointeract to libgap startup options</code></td></tr></table>




---

archive/issue_comments_423261.json:
```json
{
    "body": "**Changing commit** from \"[a0616deb562afcf9d5b1a8a4e02406b4a0479038](https://github.com/sagemath/sagetrac-mirror/commit/a0616deb562afcf9d5b1a8a4e02406b4a0479038)\" to \"[9cc327f6004c1a16819774fd34cf5fc48ff4a001](https://github.com/sagemath/sagetrac-mirror/commit/9cc327f6004c1a16819774fd34cf5fc48ff4a001)\".",
    "created_at": "2018-09-25T17:59:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423261",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[a0616deb562afcf9d5b1a8a4e02406b4a0479038](https://github.com/sagemath/sagetrac-mirror/commit/a0616deb562afcf9d5b1a8a4e02406b4a0479038)" to "[9cc327f6004c1a16819774fd34cf5fc48ff4a001](https://github.com/sagemath/sagetrac-mirror/commit/9cc327f6004c1a16819774fd34cf5fc48ff4a001)".



---

archive/issue_comments_423262.json:
```json
{
    "body": "<a id='comment:88'></a>\nIn the current branch I am able to run\n\n```\nsage: g=libgap.SymmetricGroup(4)\nsage: print(g.Order())\n24\nsage: i=g.Order().sage()\nsage: i\n24\n```\nSo it's outputting GAP object that is broken ATM.\n\nI'll try fixing the \"old\" GAP interface, perhaps it will help.",
    "created_at": "2018-09-25T18:08:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423262",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:88'></a>
In the current branch I am able to run

```
sage: g=libgap.SymmetricGroup(4)
sage: print(g.Order())
24
sage: i=g.Order().sage()
sage: i
24
```
So it's outputting GAP object that is broken ATM.

I'll try fixing the "old" GAP interface, perhaps it will help.



---

archive/issue_comments_423263.json:
```json
{
    "body": "<a id='comment:89'></a>\nReplying to [dimpase](#comment%3A88):\n> In the current branch I am able to run\n> \n> ```\n> sage: g=libgap.SymmetricGroup(4)\n> sage: print(g.Order())\n> 24\n> sage: i=g.Order().sage()\n> sage: i\n> 24\n> ```\n\n\nNice! Making good progress!\n\n> So it's outputting GAP object that is broken ATM.\n> I'll try fixing the \"old\" GAP interface, perhaps it will help.\n\n\nI am not sure what's broken above?",
    "created_at": "2018-09-25T18:51:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423263",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:89'></a>
Replying to [dimpase](#comment%3A88):
> In the current branch I am able to run
> 
> ```
> sage: g=libgap.SymmetricGroup(4)
> sage: print(g.Order())
> 24
> sage: i=g.Order().sage()
> sage: i
> 24
> ```


Nice! Making good progress!

> So it's outputting GAP object that is broken ATM.
> I'll try fixing the "old" GAP interface, perhaps it will help.


I am not sure what's broken above?



---

archive/issue_comments_423264.json:
```json
{
    "body": "<a id='comment:90'></a>\nReplying to [nthiery](#comment%3A89):\n\n> \n> > So it's outputting GAP object that is broken ATM.\n> > I'll try fixing the \"old\" GAP interface, perhaps it will help.\n\n> \n> I am not sure what's broken above?\n\n\nsee[comment:86](#comment%3A86) - displaying (lib)GAP objects is broken.\nAlso, \n\n```\nsage: gap(1)\n** Gap crashed or quit executing 'SetUserPreference(\"HistoryMaxLines\", 30);' **\nRestarting Gap and trying again\n** Gap crashed or quit executing '\\$sage1:=1;;' **\n...\n```\nthe latter is probably due to some scripts gotten messed up by the upgrade.\n\nAnd error handling in libgap interface needs work, too.",
    "created_at": "2018-09-25T20:59:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423264",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:90'></a>
Replying to [nthiery](#comment%3A89):

> 
> > So it's outputting GAP object that is broken ATM.
> > I'll try fixing the "old" GAP interface, perhaps it will help.

> 
> I am not sure what's broken above?


see[comment:86](#comment%3A86) - displaying (lib)GAP objects is broken.
Also, 

```
sage: gap(1)
** Gap crashed or quit executing 'SetUserPreference("HistoryMaxLines", 30);' **
Restarting Gap and trying again
** Gap crashed or quit executing '\$sage1:=1;;' **
...
```
the latter is probably due to some scripts gotten messed up by the upgrade.

And error handling in libgap interface needs work, too.



---

archive/issue_comments_423265.json:
```json
{
    "body": "<a id='comment:91'></a>\nlibgap's display problem seems to be ipython-specific. Indeed\n\n```\n$ ./sage --python\nPython 2.7.15 (default, Sep 15 2018, 05:05:36) \n[GCC 8.2.0] on linux2\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> from sage.all import *\n>>> libgap(1)\n1\n```",
    "created_at": "2018-09-25T21:05:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423265",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:91'></a>
libgap's display problem seems to be ipython-specific. Indeed

```
$ ./sage --python
Python 2.7.15 (default, Sep 15 2018, 05:05:36) 
[GCC 8.2.0] on linux2
Type "help", "copyright", "credits" or "license" for more information.
>>> from sage.all import *
>>> libgap(1)
1
```



---

archive/issue_comments_423266.json:
```json
{
    "body": "<a id='comment:92'></a>\nSome discussions related to libgap API:\n\n* https://github.com/gap-system/gap/issues/2864\n* https://github.com/gap-system/gap/issues/2839\n\nand an accepted PR to fix a bug that was breaking libgap/Sage interface:\n\nhttps://github.com/gap-system/gap/pull/2840",
    "created_at": "2018-09-25T21:15:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423266",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:92'></a>
Some discussions related to libgap API:

* https://github.com/gap-system/gap/issues/2864
* https://github.com/gap-system/gap/issues/2839

and an accepted PR to fix a bug that was breaking libgap/Sage interface:

https://github.com/gap-system/gap/pull/2840



---

archive/issue_comments_423267.json:
```json
{
    "body": "**Changing commit** from \"[9cc327f6004c1a16819774fd34cf5fc48ff4a001](https://github.com/sagemath/sagetrac-mirror/commit/9cc327f6004c1a16819774fd34cf5fc48ff4a001)\" to \"[ece8cfc39e5f4258a5ec2c8dc2a307f988218891](https://github.com/sagemath/sagetrac-mirror/commit/ece8cfc39e5f4258a5ec2c8dc2a307f988218891)\".",
    "created_at": "2018-09-26T09:40:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423267",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[9cc327f6004c1a16819774fd34cf5fc48ff4a001](https://github.com/sagemath/sagetrac-mirror/commit/9cc327f6004c1a16819774fd34cf5fc48ff4a001)" to "[ece8cfc39e5f4258a5ec2c8dc2a307f988218891](https://github.com/sagemath/sagetrac-mirror/commit/ece8cfc39e5f4258a5ec2c8dc2a307f988218891)".



---

archive/issue_comments_423268.json:
```json
{
    "body": "<a id='comment:93'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ece8cfc39e5f4258a5ec2c8dc2a307f988218891\">ece8cfc</a></td><td><code>fix gap() interface and gap_console, removed some old stuff</code></td></tr></table>\n",
    "created_at": "2018-09-26T09:40:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423268",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:93'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ece8cfc39e5f4258a5ec2c8dc2a307f988218891">ece8cfc</a></td><td><code>fix gap() interface and gap_console, removed some old stuff</code></td></tr></table>




---

archive/issue_comments_423269.json:
```json
{
    "body": "<a id='comment:94'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/043fb95c1ee6360ef5df9ac879d643a662bf6dbc\">043fb95</a></td><td><code>fixing all but one doctests in interfaces/gap.py</code></td></tr></table>\n",
    "created_at": "2018-09-26T11:21:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423269",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:94'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/043fb95c1ee6360ef5df9ac879d643a662bf6dbc">043fb95</a></td><td><code>fixing all but one doctests in interfaces/gap.py</code></td></tr></table>




---

archive/issue_comments_423270.json:
```json
{
    "body": "**Changing commit** from \"[ece8cfc39e5f4258a5ec2c8dc2a307f988218891](https://github.com/sagemath/sagetrac-mirror/commit/ece8cfc39e5f4258a5ec2c8dc2a307f988218891)\" to \"[043fb95c1ee6360ef5df9ac879d643a662bf6dbc](https://github.com/sagemath/sagetrac-mirror/commit/043fb95c1ee6360ef5df9ac879d643a662bf6dbc)\".",
    "created_at": "2018-09-26T11:21:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423270",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[ece8cfc39e5f4258a5ec2c8dc2a307f988218891](https://github.com/sagemath/sagetrac-mirror/commit/ece8cfc39e5f4258a5ec2c8dc2a307f988218891)" to "[043fb95c1ee6360ef5df9ac879d643a662bf6dbc](https://github.com/sagemath/sagetrac-mirror/commit/043fb95c1ee6360ef5df9ac879d643a662bf6dbc)".



---

archive/issue_comments_423271.json:
```json
{
    "body": "<a id='comment:95'></a>\nOne error - tab completion does not work on GAP objects:\n\n```\nsage -t --long --warn-long 49.3 src/sage/interfaces/gap.py\n**********************************************************************\nFile \"src/sage/interfaces/gap.py\", line 1628, in sage.interfaces.gap.GapElement._tab_completion\nFailed example:\n    'Centralizer' in s5._tab_completion()\nException raised:\n    Traceback (most recent call last):\n      File \"/mnt/opt/Sage/sage-dev/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 659, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/mnt/opt/Sage/sage-dev/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1070, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.interfaces.gap.GapElement._tab_completion[1]>\", line 1, in <module>\n        'Centralizer' in s5._tab_completion()\n      File \"sage/misc/cachefunc.pyx\", line 2316, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (build/cythonized/sage/misc/cachefunc.c:13467)\n        self.cache = f(self._instance)\n      File \"/mnt/opt/Sage/sage-dev/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 1633, in _tab_completion\n        v = P.eval(r'\\$SAGE.OperationsAdmittingFirstArgument(%s)'%self.name())\n      File \"/mnt/opt/Sage/sage-dev/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 583, in eval\n        result = Expect.eval(self, input_line, **kwds)\n      File \"/mnt/opt/Sage/sage-dev/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 1354, in eval\n        for L in code.split('\\n') if L != ''])\n      File \"/mnt/opt/Sage/sage-dev/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 789, in _eval_line\n        raise RuntimeError(message)\n    RuntimeError: Gap produced error output\n    Error, no method found! For debugging hints type ?Recovery from NoMethodFound\n    Error, no 1st choice method found for `Iterator' on 1 arguments\n\n       executing \\$SAGE.OperationsAdmittingFirstArgument(x);\n**********************************************************************\n1 item had failures:\n   1 of   3 in sage.interfaces.gap.GapElement._tab_completion\n```",
    "created_at": "2018-09-26T11:23:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423271",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:95'></a>
One error - tab completion does not work on GAP objects:

```
sage -t --long --warn-long 49.3 src/sage/interfaces/gap.py
**********************************************************************
File "src/sage/interfaces/gap.py", line 1628, in sage.interfaces.gap.GapElement._tab_completion
Failed example:
    'Centralizer' in s5._tab_completion()
Exception raised:
    Traceback (most recent call last):
      File "/mnt/opt/Sage/sage-dev/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 659, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/mnt/opt/Sage/sage-dev/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1070, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.gap.GapElement._tab_completion[1]>", line 1, in <module>
        'Centralizer' in s5._tab_completion()
      File "sage/misc/cachefunc.pyx", line 2316, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (build/cythonized/sage/misc/cachefunc.c:13467)
        self.cache = f(self._instance)
      File "/mnt/opt/Sage/sage-dev/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 1633, in _tab_completion
        v = P.eval(r'\$SAGE.OperationsAdmittingFirstArgument(%s)'%self.name())
      File "/mnt/opt/Sage/sage-dev/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 583, in eval
        result = Expect.eval(self, input_line, **kwds)
      File "/mnt/opt/Sage/sage-dev/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1354, in eval
        for L in code.split('\n') if L != ''])
      File "/mnt/opt/Sage/sage-dev/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 789, in _eval_line
        raise RuntimeError(message)
    RuntimeError: Gap produced error output
    Error, no method found! For debugging hints type ?Recovery from NoMethodFound
    Error, no 1st choice method found for `Iterator' on 1 arguments

       executing \$SAGE.OperationsAdmittingFirstArgument(x);
**********************************************************************
1 item had failures:
   1 of   3 in sage.interfaces.gap.GapElement._tab_completion
```



---

archive/issue_comments_423272.json:
```json
{
    "body": "**Stopgaps:** tab completion on GAP objects, error handling in libgap",
    "created_at": "2018-09-26T11:25:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423272",
    "user": "https://github.com/dimpase"
}
```

**Stopgaps:** tab completion on GAP objects, error handling in libgap



---

archive/issue_comments_423273.json:
```json
{
    "body": "**Changing commit** from \"[043fb95c1ee6360ef5df9ac879d643a662bf6dbc](https://github.com/sagemath/sagetrac-mirror/commit/043fb95c1ee6360ef5df9ac879d643a662bf6dbc)\" to \"[0128112b501a6c66d21b570dde09526ecf63c9b1](https://github.com/sagemath/sagetrac-mirror/commit/0128112b501a6c66d21b570dde09526ecf63c9b1)\".",
    "created_at": "2018-09-26T13:27:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423273",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[043fb95c1ee6360ef5df9ac879d643a662bf6dbc](https://github.com/sagemath/sagetrac-mirror/commit/043fb95c1ee6360ef5df9ac879d643a662bf6dbc)" to "[0128112b501a6c66d21b570dde09526ecf63c9b1](https://github.com/sagemath/sagetrac-mirror/commit/0128112b501a6c66d21b570dde09526ecf63c9b1)".



---

archive/issue_comments_423274.json:
```json
{
    "body": "<a id='comment:97'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0128112b501a6c66d21b570dde09526ecf63c9b1\">0128112</a></td><td><code>few important Cython types fixed</code></td></tr></table>\n",
    "created_at": "2018-09-26T13:27:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423274",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:97'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0128112b501a6c66d21b570dde09526ecf63c9b1">0128112</a></td><td><code>few important Cython types fixed</code></td></tr></table>




---

archive/issue_comments_423275.json:
```json
{
    "body": "<a id='comment:98'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c4d128eb99842262bf96c7ba8ecf576065f79443\">c4d128e</a></td><td><code>pass the correct error callback function</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/732cbdd54e24ac35c3fd52c75fb7608ad41603ce\">732cbdd</a></td><td><code>removing libgap_enter/exit</code></td></tr></table>\n",
    "created_at": "2018-09-26T16:57:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423275",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:98'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c4d128eb99842262bf96c7ba8ecf576065f79443">c4d128e</a></td><td><code>pass the correct error callback function</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/732cbdd54e24ac35c3fd52c75fb7608ad41603ce">732cbdd</a></td><td><code>removing libgap_enter/exit</code></td></tr></table>




---

archive/issue_comments_423276.json:
```json
{
    "body": "**Changing commit** from \"[0128112b501a6c66d21b570dde09526ecf63c9b1](https://github.com/sagemath/sagetrac-mirror/commit/0128112b501a6c66d21b570dde09526ecf63c9b1)\" to \"[732cbdd54e24ac35c3fd52c75fb7608ad41603ce](https://github.com/sagemath/sagetrac-mirror/commit/732cbdd54e24ac35c3fd52c75fb7608ad41603ce)\".",
    "created_at": "2018-09-26T16:57:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423276",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[0128112b501a6c66d21b570dde09526ecf63c9b1](https://github.com/sagemath/sagetrac-mirror/commit/0128112b501a6c66d21b570dde09526ecf63c9b1)" to "[732cbdd54e24ac35c3fd52c75fb7608ad41603ce](https://github.com/sagemath/sagetrac-mirror/commit/732cbdd54e24ac35c3fd52c75fb7608ad41603ce)".



---

archive/issue_comments_423277.json:
```json
{
    "body": "<a id='comment:99'></a>\nin `gap.*` interface, tab completion is broken due to outdated code in `src/ext/gap/sage.g`: with GAP 4.10 one gets\n\n```\ngap> Read(\"sage.g\");\ngap> s5:=SymmetricGroup(5);\nSym( [ 1 .. 5 ] )\ngap> \\$SAGE.OperationsAdmittingFirstArgument(s5);\nError, no method found! For debugging hints type ?Recovery from NoMethodFound\nError, no 1st choice method found for `Iterator' on 1 arguments at /mnt/opt/Sage/sage-dev/local/gap/latest/lib/methsel2.g:250 called from\nOPERATIONS[i + 1] at sage.g:69 called from\n<function \"LastReadValue\">( <arguments> )\n called from read-eval loop at *stdin*:4\ntype 'quit;' to quit to outer loop\n```\n\nin GAP 4.8.6 this works:\n\n```\ngap> Read(\"sage.g\");\ngap> s5:=SymmetricGroup(5);\nSym( [ 1 .. 5 ] )\ngap> \\$SAGE.OperationsAdmittingFirstArgument(s5);\n[ <Operation \"ViewObj\">, <Operation \"ViewString\">, <Operation \"NameFunction\">, <Operation \"SetNameFunction\">, \n...\n```\n\nI've asked [here](https://github.com/gap-system/gap/issues/2875), as this is due to format change of internal GAP data...",
    "created_at": "2018-09-27T05:34:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423277",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:99'></a>
in `gap.*` interface, tab completion is broken due to outdated code in `src/ext/gap/sage.g`: with GAP 4.10 one gets

```
gap> Read("sage.g");
gap> s5:=SymmetricGroup(5);
Sym( [ 1 .. 5 ] )
gap> \$SAGE.OperationsAdmittingFirstArgument(s5);
Error, no method found! For debugging hints type ?Recovery from NoMethodFound
Error, no 1st choice method found for `Iterator' on 1 arguments at /mnt/opt/Sage/sage-dev/local/gap/latest/lib/methsel2.g:250 called from
OPERATIONS[i + 1] at sage.g:69 called from
<function "LastReadValue">( <arguments> )
 called from read-eval loop at *stdin*:4
type 'quit;' to quit to outer loop
```

in GAP 4.8.6 this works:

```
gap> Read("sage.g");
gap> s5:=SymmetricGroup(5);
Sym( [ 1 .. 5 ] )
gap> \$SAGE.OperationsAdmittingFirstArgument(s5);
[ <Operation "ViewObj">, <Operation "ViewString">, <Operation "NameFunction">, <Operation "SetNameFunction">, 
...
```

I've asked [here](https://github.com/gap-system/gap/issues/2875), as this is due to format change of internal GAP data...



---

archive/issue_comments_423278.json:
```json
{
    "body": "<a id='comment:0'></a>\nVery similar outdated code is in `OperationInspector.operations` in `sage/libs/gap/operations.py`.",
    "created_at": "2018-09-27T13:39:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423278",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:0'></a>
Very similar outdated code is in `OperationInspector.operations` in `sage/libs/gap/operations.py`.



---

archive/issue_comments_423279.json:
```json
{
    "body": "**Changing commit** from \"[732cbdd54e24ac35c3fd52c75fb7608ad41603ce](https://github.com/sagemath/sagetrac-mirror/commit/732cbdd54e24ac35c3fd52c75fb7608ad41603ce)\" to \"[41218248115922fdae5c4ebb01a03a7df7bafc91](https://github.com/sagemath/sagetrac-mirror/commit/41218248115922fdae5c4ebb01a03a7df7bafc91)\".",
    "created_at": "2018-09-27T16:09:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423279",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[732cbdd54e24ac35c3fd52c75fb7608ad41603ce](https://github.com/sagemath/sagetrac-mirror/commit/732cbdd54e24ac35c3fd52c75fb7608ad41603ce)" to "[41218248115922fdae5c4ebb01a03a7df7bafc91](https://github.com/sagemath/sagetrac-mirror/commit/41218248115922fdae5c4ebb01a03a7df7bafc91)".



---

archive/issue_comments_423280.json:
```json
{
    "body": "<a id='comment:1'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/41218248115922fdae5c4ebb01a03a7df7bafc91\">4121824</a></td><td><code>fix for tab completion for GAP interface</code></td></tr></table>\n",
    "created_at": "2018-09-27T16:09:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423280",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:1'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/41218248115922fdae5c4ebb01a03a7df7bafc91">4121824</a></td><td><code>fix for tab completion for GAP interface</code></td></tr></table>




---

archive/issue_comments_423281.json:
```json
{
    "body": "**Changing commit** from \"[41218248115922fdae5c4ebb01a03a7df7bafc91](https://github.com/sagemath/sagetrac-mirror/commit/41218248115922fdae5c4ebb01a03a7df7bafc91)\" to \"[1d60fdd386b98b11474df00074039f3b3ef26bca](https://github.com/sagemath/sagetrac-mirror/commit/1d60fdd386b98b11474df00074039f3b3ef26bca)\".",
    "created_at": "2018-09-27T18:35:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423281",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[41218248115922fdae5c4ebb01a03a7df7bafc91](https://github.com/sagemath/sagetrac-mirror/commit/41218248115922fdae5c4ebb01a03a7df7bafc91)" to "[1d60fdd386b98b11474df00074039f3b3ef26bca](https://github.com/sagemath/sagetrac-mirror/commit/1d60fdd386b98b11474df00074039f3b3ef26bca)".



---

archive/issue_comments_423282.json:
```json
{
    "body": "<a id='comment:2'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1d60fdd386b98b11474df00074039f3b3ef26bca\">1d60fdd</a></td><td><code>fix tab completion in libgap interface</code></td></tr></table>\n",
    "created_at": "2018-09-27T18:35:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423282",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1d60fdd386b98b11474df00074039f3b3ef26bca">1d60fdd</a></td><td><code>fix tab completion in libgap interface</code></td></tr></table>




---

archive/issue_comments_423283.json:
```json
{
    "body": "<a id='comment:3'></a>\nbroken error handling:\n\n```\nsage: a=libgap(1)\nsage: getattr(a,'_rich_repr_',None)\nError, Variable: '_rich_repr_' must have a value\nsage: \n```\n(with a default argument, `getattr` should just return it, with raising anything)",
    "created_at": "2018-09-28T07:29:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423283",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:3'></a>
broken error handling:

```
sage: a=libgap(1)
sage: getattr(a,'_rich_repr_',None)
Error, Variable: '_rich_repr_' must have a value
sage: 
```
(with a default argument, `getattr` should just return it, with raising anything)



---

archive/issue_comments_423284.json:
```json
{
    "body": "**Changing dependencies** from \"#25273\" to \"\".",
    "created_at": "2018-09-28T07:29:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423284",
    "user": "https://github.com/dimpase"
}
```

**Changing dependencies** from "#25273" to "".



---

archive/issue_comments_423285.json:
```json
{
    "body": "**Changing stopgaps** from \"tab completion on GAP objects, error handling in libgap\" to \"error handling in libgap\".",
    "created_at": "2018-09-28T07:29:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423285",
    "user": "https://github.com/dimpase"
}
```

**Changing stopgaps** from "tab completion on GAP objects, error handling in libgap" to "error handling in libgap".



---

archive/issue_comments_423286.json:
```json
{
    "body": "**Changing stopgaps** from \"error handling in libgap\" to \"error handling in libgap, documentation display\".",
    "created_at": "2018-09-28T16:05:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423286",
    "user": "https://github.com/dimpase"
}
```

**Changing stopgaps** from "error handling in libgap" to "error handling in libgap, documentation display".



---

archive/issue_comments_423287.json:
```json
{
    "body": "<a id='comment:4'></a>\nPlease see\nhttps://github.com/gap-system/gap/issues/2874 for the current sticking point, which is error handling and processing of error messages.\nBasically, the question is whether it's possible to retain the behaviour of libGAP without patches to the GAP's kernel.\n\nI'd like someone who knows more about libGAP error handling to have a look at badly butchered by me parts in the branch dealing with it, and suggest what should be done.\n\nAnother (easier) thing to fix is GAP and libgap documentation display.",
    "created_at": "2018-09-28T16:05:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423287",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:4'></a>
Please see
https://github.com/gap-system/gap/issues/2874 for the current sticking point, which is error handling and processing of error messages.
Basically, the question is whether it's possible to retain the behaviour of libGAP without patches to the GAP's kernel.

I'd like someone who knows more about libGAP error handling to have a look at badly butchered by me parts in the branch dealing with it, and suggest what should be done.

Another (easier) thing to fix is GAP and libgap documentation display.



---

archive/issue_comments_423288.json:
```json
{
    "body": "**Changing status** from new to needs_info.",
    "created_at": "2018-09-28T16:28:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423288",
    "user": "https://github.com/dimpase"
}
```

**Changing status** from new to needs_info.



---

archive/issue_comments_423289.json:
```json
{
    "body": "**Changing commit** from \"[1d60fdd386b98b11474df00074039f3b3ef26bca](https://github.com/sagemath/sagetrac-mirror/commit/1d60fdd386b98b11474df00074039f3b3ef26bca)\" to \"[e352f7e4ad34dfc1422afc04506332ef7674755a](https://github.com/sagemath/sagetrac-mirror/commit/e352f7e4ad34dfc1422afc04506332ef7674755a)\".",
    "created_at": "2018-10-02T22:52:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423289",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[1d60fdd386b98b11474df00074039f3b3ef26bca](https://github.com/sagemath/sagetrac-mirror/commit/1d60fdd386b98b11474df00074039f3b3ef26bca)" to "[e352f7e4ad34dfc1422afc04506332ef7674755a](https://github.com/sagemath/sagetrac-mirror/commit/e352f7e4ad34dfc1422afc04506332ef7674755a)".



---

archive/issue_comments_423290.json:
```json
{
    "body": "<a id='comment:6'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e352f7e4ad34dfc1422afc04506332ef7674755a\">e352f7e</a></td><td><code>modest progress - can do libgap(1)</code></td></tr></table>\n",
    "created_at": "2018-10-02T22:52:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423290",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e352f7e4ad34dfc1422afc04506332ef7674755a">e352f7e</a></td><td><code>modest progress - can do libgap(1)</code></td></tr></table>




---

archive/issue_comments_423291.json:
```json
{
    "body": "**Changing work_issues** from \"Wait for gap 4.10 release\" to \"work...\".",
    "created_at": "2018-10-02T22:58:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423291",
    "user": "https://github.com/dimpase"
}
```

**Changing work_issues** from "Wait for gap 4.10 release" to "work...".



---

archive/issue_comments_423292.json:
```json
{
    "body": "**Changing status** from needs_info to needs_work.",
    "created_at": "2018-10-02T22:58:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423292",
    "user": "https://github.com/dimpase"
}
```

**Changing status** from needs_info to needs_work.



---

archive/issue_comments_423293.json:
```json
{
    "body": "<a id='comment:7'></a>\nthe interaction with ipython (which tries to get things like `_rich_repr_` from GAP to display GAP objects) is far from done. The current problem:\n\n```\nsage: a=libgap(41)\nsage: a\n41\nsage: b=libgap(42)\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n...\nValueError: libGAP: PrintTo: cannot open stream for output\nError, Length: <list> must be a list (not a boolean or fail)\n...\n```\nthis looks like a bug in my new (bad) implementation of GAP objects printing in Sage.",
    "created_at": "2018-10-02T22:58:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423293",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:7'></a>
the interaction with ipython (which tries to get things like `_rich_repr_` from GAP to display GAP objects) is far from done. The current problem:

```
sage: a=libgap(41)
sage: a
41
sage: b=libgap(42)
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
...
ValueError: libGAP: PrintTo: cannot open stream for output
Error, Length: <list> must be a list (not a boolean or fail)
...
```
this looks like a bug in my new (bad) implementation of GAP objects printing in Sage.



---

archive/issue_comments_423294.json:
```json
{
    "body": "<a id='comment:8'></a>\nperhaps we should rather try rebasing libGAP to GAP 4.10, which looks a less daunting task now than a total replacement with \"native\" GAP's libgap, get it working, and then replace all the `libgap_*` functions by the native ones.",
    "created_at": "2018-10-04T12:04:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423294",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:8'></a>
perhaps we should rather try rebasing libGAP to GAP 4.10, which looks a less daunting task now than a total replacement with "native" GAP's libgap, get it working, and then replace all the `libgap_*` functions by the native ones.



---

archive/issue_comments_423295.json:
```json
{
    "body": "<a id='comment:9'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/406cae67f059056df29413b8fa36ac9964eb3c5b\">406cae6</a></td><td><code>still the interaction with ipython is broken</code></td></tr></table>\n",
    "created_at": "2018-10-04T12:14:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423295",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/406cae67f059056df29413b8fa36ac9964eb3c5b">406cae6</a></td><td><code>still the interaction with ipython is broken</code></td></tr></table>




---

archive/issue_comments_423296.json:
```json
{
    "body": "**Changing commit** from \"[e352f7e4ad34dfc1422afc04506332ef7674755a](https://github.com/sagemath/sagetrac-mirror/commit/e352f7e4ad34dfc1422afc04506332ef7674755a)\" to \"[406cae67f059056df29413b8fa36ac9964eb3c5b](https://github.com/sagemath/sagetrac-mirror/commit/406cae67f059056df29413b8fa36ac9964eb3c5b)\".",
    "created_at": "2018-10-04T12:14:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423296",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[e352f7e4ad34dfc1422afc04506332ef7674755a](https://github.com/sagemath/sagetrac-mirror/commit/e352f7e4ad34dfc1422afc04506332ef7674755a)" to "[406cae67f059056df29413b8fa36ac9964eb3c5b](https://github.com/sagemath/sagetrac-mirror/commit/406cae67f059056df29413b8fa36ac9964eb3c5b)".



---

archive/issue_comments_423297.json:
```json
{
    "body": "<a id='comment:0'></a>\nOn the present branch, I get\n\n```\nsage: a=libgap(1)\nsage: a\n*** trouble in PRINT_OR_APPEND_TO_STREAM***\n...\n*** trouble in PRINT_OR_APPEND_TO_STREAM***\n1\n```\nafter this GAP is pretty much nuked. This happens during ipython's attempts to pretty-print `a`, so that it tries to find `_rich_repr_` etc. Specifically, at least on the system I am running this, the trouble starts not immediately, but where `_rich_png_` (or the previous thing in the loop) is checked for by `get_real_method` in `IPython/utils/dir2.py`.\n\nIf I run the same from `./sage --python` (after loading Sage there as usual) at least this much (and more) works.\n\nI don't have a good idea how to debug this, so I'd like to pass the token now.",
    "created_at": "2018-10-04T12:26:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423297",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:0'></a>
On the present branch, I get

```
sage: a=libgap(1)
sage: a
*** trouble in PRINT_OR_APPEND_TO_STREAM***
...
*** trouble in PRINT_OR_APPEND_TO_STREAM***
1
```
after this GAP is pretty much nuked. This happens during ipython's attempts to pretty-print `a`, so that it tries to find `_rich_repr_` etc. Specifically, at least on the system I am running this, the trouble starts not immediately, but where `_rich_png_` (or the previous thing in the loop) is checked for by `get_real_method` in `IPython/utils/dir2.py`.

If I run the same from `./sage --python` (after loading Sage there as usual) at least this much (and more) works.

I don't have a good idea how to debug this, so I'd like to pass the token now.



---

archive/issue_comments_423298.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2018-10-05T10:24:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423298",
    "user": "https://github.com/dimpase"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_423299.json:
```json
{
    "body": "<a id='comment:1'></a>\noops, wrong ticket",
    "created_at": "2018-10-05T10:24:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423299",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:1'></a>
oops, wrong ticket



---

archive/issue_comments_423300.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2018-10-05T10:25:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423300",
    "user": "https://github.com/dimpase"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_423301.json:
```json
{
    "body": "<a id='comment:3'></a>\nAs long as we're upgrading GAP we should make sure DESTDIR builds work now; see #25044 which this conflicts with.  But if this can get done soon we can skip #25044 and incorporate it into this.  I'll give you a patch for it if you want.\n\nI'm working on testing this on Cygwin now.",
    "created_at": "2018-10-05T11:09:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423301",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>
As long as we're upgrading GAP we should make sure DESTDIR builds work now; see #25044 which this conflicts with.  But if this can get done soon we can skip #25044 and incorporate it into this.  I'll give you a patch for it if you want.

I'm working on testing this on Cygwin now.



---

archive/issue_comments_423302.json:
```json
{
    "body": "<a id='comment:4'></a>\nOkay, I am again confused as to what upstream tarball to use, because the one in the ticket description no longer matches the checksum.",
    "created_at": "2018-10-05T12:06:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423302",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>
Okay, I am again confused as to what upstream tarball to use, because the one in the ticket description no longer matches the checksum.



---

archive/issue_comments_423303.json:
```json
{
    "body": "<a id='comment:5'></a>\nI just checked that md5=017738e0ba9e166a19084d68123d3e1f as in GAP package checksum\nmatches the md5 of https://github.com/dimpase/gap/releases/download/dev/gap-4.dev.tar.gz\n\nPerhaps your download just got corrupted?",
    "created_at": "2018-10-05T22:31:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423303",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:5'></a>
I just checked that md5=017738e0ba9e166a19084d68123d3e1f as in GAP package checksum
matches the md5 of https://github.com/dimpase/gap/releases/download/dev/gap-4.dev.tar.gz

Perhaps your download just got corrupted?



---

archive/issue_comments_423304.json:
```json
{
    "body": "<a id='comment:6'></a>\nGAP 4.9.3 was uploaded to Debian unstable yesterday, the sagemath Debian package is broken until we can use GAP 4.9. Is the patch here already enough to use libgap from GAP 4.9 directly? It does not apply cleanly to sage 8.4. Or would you say updating the separate libgap to 4.9 is a better idea?",
    "created_at": "2018-11-04T21:01:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423304",
    "user": "https://github.com/tobihan"
}
```

<a id='comment:6'></a>
GAP 4.9.3 was uploaded to Debian unstable yesterday, the sagemath Debian package is broken until we can use GAP 4.9. Is the patch here already enough to use libgap from GAP 4.9 directly? It does not apply cleanly to sage 8.4. Or would you say updating the separate libgap to 4.9 is a better idea?



---

archive/issue_comments_423305.json:
```json
{
    "body": "<a id='comment:117'></a>\nReplying to [thansen](#comment%3A116):\n> GAP 4.9.3 was uploaded to Debian unstable yesterday, the sagemath Debian package is broken until we can use GAP 4.9. Is the patch here already enough to use libgap from GAP 4.9 directly? It does not apply cleanly to sage 8.4.\n\n\nthe patch here is very far from a working one.\n\n> Or would you say updating the separate libgap to 4.9 is a better idea?\n\n\nIf you could manage this, it would be great and very useful, but it's a very nontrivial amount of work, due to substantial changes in GAP internals that happened in GAP 4.9.",
    "created_at": "2018-11-04T23:36:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423305",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:117'></a>
Replying to [thansen](#comment%3A116):
> GAP 4.9.3 was uploaded to Debian unstable yesterday, the sagemath Debian package is broken until we can use GAP 4.9. Is the patch here already enough to use libgap from GAP 4.9 directly? It does not apply cleanly to sage 8.4.


the patch here is very far from a working one.

> Or would you say updating the separate libgap to 4.9 is a better idea?


If you could manage this, it would be great and very useful, but it's a very nontrivial amount of work, due to substantial changes in GAP internals that happened in GAP 4.9.



---

archive/issue_comments_423306.json:
```json
{
    "body": "<a id='comment:8'></a>\nI see. If there was progress on this from you guys it would be very much appreciated. The freeze period for the next Debian release starts in January. If we can't fix the problem in time, sage will not be in the next Debian release, which will be the stable release for two years.",
    "created_at": "2018-11-05T10:33:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423306",
    "user": "https://github.com/tobihan"
}
```

<a id='comment:8'></a>
I see. If there was progress on this from you guys it would be very much appreciated. The freeze period for the next Debian release starts in January. If we can't fix the problem in time, sage will not be in the next Debian release, which will be the stable release for two years.



---

archive/issue_comments_423307.json:
```json
{
    "body": "<a id='comment:119'></a>\nReplying to [thansen](#comment%3A118):\n> The freeze period for the next Debian release starts in January.\n\n\nFor those of us who are not Debian experts, where is this documented? And what kind of changes are still allowed during the \"freeze\" period? For example, suppose for the sake of argument that this [SageMath](SageMath) ticket is only merged in February, could it still be added as a patch to the Debian [SageMath](SageMath) package?",
    "created_at": "2018-11-05T11:11:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423307",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:119'></a>
Replying to [thansen](#comment%3A118):
> The freeze period for the next Debian release starts in January.


For those of us who are not Debian experts, where is this documented? And what kind of changes are still allowed during the "freeze" period? For example, suppose for the sake of argument that this [SageMath](SageMath) ticket is only merged in February, could it still be added as a patch to the Debian [SageMath](SageMath) package?



---

archive/issue_comments_423308.json:
```json
{
    "body": "<a id='comment:0'></a>\nIt is documented here: https://release.debian.org/buster/freeze_policy.html\n\nThe broken sagemath will eventually be automatically removed from Debian testing, which will become the next Debian release. After February 12 it cannot migrate back to testing even if it is fixed. The earlier transition freeze on January 12 means that no more library updates with SONAME change can be done (which might be relevant for a sage update too).",
    "created_at": "2018-11-05T11:34:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423308",
    "user": "https://github.com/tobihan"
}
```

<a id='comment:0'></a>
It is documented here: https://release.debian.org/buster/freeze_policy.html

The broken sagemath will eventually be automatically removed from Debian testing, which will become the next Debian release. After February 12 it cannot migrate back to testing even if it is fixed. The earlier transition freeze on January 12 means that no more library updates with SONAME change can be done (which might be relevant for a sage update too).



---

archive/issue_comments_423309.json:
```json
{
    "body": "<a id='comment:1'></a>\nAbout the example you mentioned: This ticket does not need to be merged, we just need a usable patch. It seems that the gap maintainer is open to providing libgap.la, see https://bugs.debian.org/912862 . It is not yet clear if gap 4.10 is released in time to be included before the freeze.",
    "created_at": "2018-11-05T12:16:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423309",
    "user": "https://github.com/tobihan"
}
```

<a id='comment:1'></a>
About the example you mentioned: This ticket does not need to be merged, we just need a usable patch. It seems that the gap maintainer is open to providing libgap.la, see https://bugs.debian.org/912862 . It is not yet clear if gap 4.10 is released in time to be included before the freeze.



---

archive/issue_comments_423310.json:
```json
{
    "body": "<a id='comment:2'></a>\nThis ticket mentions GAP 4.10, but should we not be focusing instead on GAP 4.9?  Or would getting Sage working against GAP 4.10 imply support for 4.9 as well?  I would want to check against both, and starting with the existing release (4.9) seems simpler...\n\nIs there something at the system integration level I could be able to help with?  ISTM this needs to be a high priority.",
    "created_at": "2018-11-06T10:21:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423310",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>
This ticket mentions GAP 4.10, but should we not be focusing instead on GAP 4.9?  Or would getting Sage working against GAP 4.10 imply support for 4.9 as well?  I would want to check against both, and starting with the existing release (4.9) seems simpler...

Is there something at the system integration level I could be able to help with?  ISTM this needs to be a high priority.



---

archive/issue_events_067116.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-11-06T10:21:44Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "milestone": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22626#event-67116"
}
```



---

archive/issue_events_067117.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-11-06T10:21:44Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "milestone": "sage-8.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22626#event-67117"
}
```



---

archive/issue_comments_423311.json:
```json
{
    "body": "<a id='comment:123'></a>\nReplying to [thansen](#comment%3A121):\n> About the example you mentioned: This ticket does not need to be merged, we just need a usable patch. It seems that the gap maintainer is open to providing libgap.la, see https://bugs.debian.org/912862 . It is not yet clear if gap 4.10 is released in time to be included before the freeze.\n\n\nIf that's the case, for the sake of integration, it might make more sense to pin GAP in Debia to 4.9 and focus on getting a Sage out that works against GAP 4.9 instead of focusing on 4.10.  Given the amount of time left to do this, waiting on an uncertain GAP 4.10 package(s) landing in Debian seems a bit risky...",
    "created_at": "2018-11-06T10:24:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423311",
    "user": "https://github.com/embray"
}
```

<a id='comment:123'></a>
Replying to [thansen](#comment%3A121):
> About the example you mentioned: This ticket does not need to be merged, we just need a usable patch. It seems that the gap maintainer is open to providing libgap.la, see https://bugs.debian.org/912862 . It is not yet clear if gap 4.10 is released in time to be included before the freeze.


If that's the case, for the sake of integration, it might make more sense to pin GAP in Debia to 4.9 and focus on getting a Sage out that works against GAP 4.9 instead of focusing on 4.10.  Given the amount of time left to do this, waiting on an uncertain GAP 4.10 package(s) landing in Debian seems a bit risky...



---

archive/issue_comments_423312.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -5,14 +5,7 @@\n The GAP team will provide libGAP with GAP 4.10.\n \n The branch attached to this ticket updates Sage to run on top of\n-[a branch of GAP](https://github.com/markuspf/gap/tree/hpc-merge-libgap)\n-by Markus Pfeiffer that adds libgap compilation and\n-[might be merged](https://github.com/gap-system/gap/pull/1205)\n-soon in the devel version of GAP.\n-\n-See https://github.com/markuspf/gap/issues/2 for the few sticking points\n-that could prevent using a vanilla GAP from the distribution (please edit\n-further if you think about more of them).\n+of a recent GAP master branch, close to the future 4.10.\n \n What the branch does:\n \n@@ -46,50 +39,27 @@\n \n - Revert #19726 (not needed anymore)\n \n-Status: Most long test pass. Tentatively, the 38 remaining failing\n-tests are due to changes in GAP since 4.8.6: Max mentioned that the\n-library has been cleaned up to always use the same random generation\n-source, and some of the group algorithms were changed as well, which\n-can explain, e.g. change of orders in lists of elements. So those\n-should be nothing to worry about. There is not much point in updating\n-those doctests right away; we may as well wait for a more final\n-version of 4.9 to be out.\n+Status: currently broken  - crashes deep inside GAP error handling system after few simple commands. \n \n TODO:\n \n-- Automatic handling of headers (see below for how to do it by hand).\n-  GAP's build system will eventually provide a rule to install headers\n-  which will make this trivial.\n-\n-- Use GAP's own `make install` [when it will be implemented](https://github.com/fingolfin/gap/issues/44).\n-\n-- Check against #19915 to see if any of the changes there should be\n-  ported here. Then close as won't fix.\n-\n-  - Update doctests as needed\n-\n - ???\n \n-Fetching Markus's GAP sources:\n+To make a GAP package: get their sources from https://github.com/gap-system/gap, then run\n \n ```\n-git clone git@github.com:markuspf/gap.git $LIBGAP\n-cd $LIBGAP\n-git remote add markuspf git@github.com:markuspf/gap.git\n-git fetch markuspf\n-git checkout -b markuspf/hpc-merge-libgap\n ./autogen.sh\n-./configure\n+./configure --prefix=$SAGE_LOCAL\n make bootstrap-pkg-minimal\n+make libgap\n+make install\n ```\n \n \n-Testing libgap:\n+Testing libgap in GAP (there are few tests written in C):\n \n ```\n-./configure --enable-libgap\n-make -j4 libgap\n-make test-libgap\n+make testlibgap\n ```\n \n Build and install a tardist for Sage, and rebuild the spkg:\n@@ -133,7 +103,7 @@\n ```\n sage -tp 8 sage/groups sage/libs/gap\n ```\n-Current status: all tests pass!\n+Current status: lots of errors\n \n Testing packages with dynamic loading (e.g. IO):\n \n``````\n",
    "created_at": "2018-11-06T11:22:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423312",
    "user": "https://github.com/dimpase"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -5,14 +5,7 @@
 The GAP team will provide libGAP with GAP 4.10.
 
 The branch attached to this ticket updates Sage to run on top of
-[a branch of GAP](https://github.com/markuspf/gap/tree/hpc-merge-libgap)
-by Markus Pfeiffer that adds libgap compilation and
-[might be merged](https://github.com/gap-system/gap/pull/1205)
-soon in the devel version of GAP.
-
-See https://github.com/markuspf/gap/issues/2 for the few sticking points
-that could prevent using a vanilla GAP from the distribution (please edit
-further if you think about more of them).
+of a recent GAP master branch, close to the future 4.10.
 
 What the branch does:
 
@@ -46,50 +39,27 @@
 
 - Revert #19726 (not needed anymore)
 
-Status: Most long test pass. Tentatively, the 38 remaining failing
-tests are due to changes in GAP since 4.8.6: Max mentioned that the
-library has been cleaned up to always use the same random generation
-source, and some of the group algorithms were changed as well, which
-can explain, e.g. change of orders in lists of elements. So those
-should be nothing to worry about. There is not much point in updating
-those doctests right away; we may as well wait for a more final
-version of 4.9 to be out.
+Status: currently broken  - crashes deep inside GAP error handling system after few simple commands. 
 
 TODO:
 
-- Automatic handling of headers (see below for how to do it by hand).
-  GAP's build system will eventually provide a rule to install headers
-  which will make this trivial.
-
-- Use GAP's own `make install` [when it will be implemented](https://github.com/fingolfin/gap/issues/44).
-
-- Check against #19915 to see if any of the changes there should be
-  ported here. Then close as won't fix.
-
-  - Update doctests as needed
-
 - ???
 
-Fetching Markus's GAP sources:
+To make a GAP package: get their sources from https://github.com/gap-system/gap, then run
 
 ```
-git clone git@github.com:markuspf/gap.git $LIBGAP
-cd $LIBGAP
-git remote add markuspf git@github.com:markuspf/gap.git
-git fetch markuspf
-git checkout -b markuspf/hpc-merge-libgap
 ./autogen.sh
-./configure
+./configure --prefix=$SAGE_LOCAL
 make bootstrap-pkg-minimal
+make libgap
+make install
 ```
 
 
-Testing libgap:
+Testing libgap in GAP (there are few tests written in C):
 
 ```
-./configure --enable-libgap
-make -j4 libgap
-make test-libgap
+make testlibgap
 ```
 
 Build and install a tardist for Sage, and rebuild the spkg:
@@ -133,7 +103,7 @@
 ```
 sage -tp 8 sage/groups sage/libs/gap
 ```
-Current status: all tests pass!
+Current status: lots of errors
 
 Testing packages with dynamic loading (e.g. IO):
 
``````




---

archive/issue_comments_423313.json:
```json
{
    "body": "<a id='comment:5'></a>\nI think getting Sage's `libGAP` work with GAP 4.9 and/or 4.10 is much harder than in used to be in 4.8.x, due to major changes to GAP internals (although I have not tried it yet).",
    "created_at": "2018-11-06T11:25:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423313",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:5'></a>
I think getting Sage's `libGAP` work with GAP 4.9 and/or 4.10 is much harder than in used to be in 4.8.x, due to major changes to GAP internals (although I have not tried it yet).



---

archive/issue_comments_423314.json:
```json
{
    "body": "<a id='comment:6'></a>\nPosting on behalf of Alexander Konovalov who does not yet have a trac account:\n>        http://www.gap-system.org/pub/gap/gap-4.10/\n\n>\n> has now GAP 4.10.0. The website will be updated in due course, but that\n> means that GAP 4.10 is out.\n\n\nThat's excellent news. Now it's up to Sage to catch up.",
    "created_at": "2018-11-07T06:56:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423314",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:6'></a>
Posting on behalf of Alexander Konovalov who does not yet have a trac account:
>        http://www.gap-system.org/pub/gap/gap-4.10/

>
> has now GAP 4.10.0. The website will be updated in due course, but that
> means that GAP 4.10 is out.


That's excellent news. Now it's up to Sage to catch up.



---

archive/issue_comments_423315.json:
```json
{
    "body": "<a id='comment:7'></a>\nGreat! From what I saw yesterday it seemed like there were some doubts about how soon 4.10 would be released. But this being the case I rescind my previous comment.",
    "created_at": "2018-11-07T11:59:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423315",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>
Great! From what I saw yesterday it seemed like there were some doubts about how soon 4.10 would be released. But this being the case I rescind my previous comment.



---

archive/issue_comments_423316.json:
```json
{
    "body": "<a id='comment:128'></a>\nReplying to [git](#comment%3A109):\n> Branch pushed to git repo; I updated commit sha1. **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/406cae67f059056df29413b8fa36ac9964eb3c5b\">406cae6</a></td><td><code>still the interaction with ipython is broken</code></td></tr></table>\n\n\nIf I'm to understand correctly, you just added this patch for debugging purposes, right? It's not intended to go into the final product is it?  I'm going to look into this problem.",
    "created_at": "2018-11-08T14:15:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423316",
    "user": "https://github.com/embray"
}
```

<a id='comment:128'></a>
Replying to [git](#comment%3A109):
> Branch pushed to git repo; I updated commit sha1. **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/406cae67f059056df29413b8fa36ac9964eb3c5b">406cae6</a></td><td><code>still the interaction with ipython is broken</code></td></tr></table>


If I'm to understand correctly, you just added this patch for debugging purposes, right? It's not intended to go into the final product is it?  I'm going to look into this problem.



---

archive/issue_comments_423317.json:
```json
{
    "body": "<a id='comment:129'></a>\nReplying to [embray](#comment%3A128):\n> Replying to [git](#comment%3A109):\n> > Branch pushed to git repo; I updated commit sha1. **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/406cae67f059056df29413b8fa36ac9964eb3c5b\">406cae6</a></td><td><code>still the interaction with ipython is broken</code></td></tr></table>\n\n> \n> If I'm to understand correctly, you just added this patch for debugging purposes, right? It's not intended to go into the final product is it?  I'm going to look into this problem.\n\n\nThat's right, it's for debugging purposes (although it merely shows that something is going wrong, not more :-)).\nYou might like to coordinate this with Jeroen, as he's going to work on this branch too...",
    "created_at": "2018-11-08T14:52:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423317",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:129'></a>
Replying to [embray](#comment%3A128):
> Replying to [git](#comment%3A109):
> > Branch pushed to git repo; I updated commit sha1. **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/406cae67f059056df29413b8fa36ac9964eb3c5b">406cae6</a></td><td><code>still the interaction with ipython is broken</code></td></tr></table>

> 
> If I'm to understand correctly, you just added this patch for debugging purposes, right? It's not intended to go into the final product is it?  I'm going to look into this problem.


That's right, it's for debugging purposes (although it merely shows that something is going wrong, not more :-)).
You might like to coordinate this with Jeroen, as he's going to work on this branch too...



---

archive/issue_comments_423318.json:
```json
{
    "body": "<a id='comment:0'></a>\nI'm updating it right now to the 4.10 release.  Jeroen is probably a better person to work on the LibGAP integration just because he has more experience with it.  But if there any specific segfaults or anything I could look at I will.  I'll take a look, for example, at the tab-completion issue...",
    "created_at": "2018-11-08T15:01:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423318",
    "user": "https://github.com/embray"
}
```

<a id='comment:0'></a>
I'm updating it right now to the 4.10 release.  Jeroen is probably a better person to work on the LibGAP integration just because he has more experience with it.  But if there any specific segfaults or anything I could look at I will.  I'll take a look, for example, at the tab-completion issue...



---

archive/issue_comments_423319.json:
```json
{
    "body": "<a id='comment:1'></a>\nI'm also rebasing this branch on current develop, which needs a bit of work...",
    "created_at": "2018-11-08T15:05:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423319",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>
I'm also rebasing this branch on current develop, which needs a bit of work...



---

archive/issue_comments_423320.json:
```json
{
    "body": "<a id='comment:132'></a>\nReplying to [nthiery](#comment%3A126):\n> Posting on behalf of Alexander Konovalov who does not yet have a trac account:\n> >        http://www.gap-system.org/pub/gap/gap-4.10/\n\n\nAlex should be aware that he can post on trac using his github account!",
    "created_at": "2018-11-08T15:52:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423320",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:132'></a>
Replying to [nthiery](#comment%3A126):
> Posting on behalf of Alexander Konovalov who does not yet have a trac account:
> >        http://www.gap-system.org/pub/gap/gap-4.10/


Alex should be aware that he can post on trac using his github account!



---

archive/issue_comments_423321.json:
```json
{
    "body": "<a id='comment:3'></a>\nAnother thing that it seems still hasn't been done is to update the spkg-install for GAP to use DESTDIR-based installation.  I'll just work on that simultaneously with this.  If we have to upgrade GAP anyways that should be part of the process (and may expose some flaws in GAP's new installation process...)",
    "created_at": "2018-11-08T15:57:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423321",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>
Another thing that it seems still hasn't been done is to update the spkg-install for GAP to use DESTDIR-based installation.  I'll just work on that simultaneously with this.  If we have to upgrade GAP anyways that should be part of the process (and may expose some flaws in GAP's new installation process...)



---

archive/issue_comments_423322.json:
```json
{
    "body": "<a id='comment:4'></a>\nNeeded to modify `build/make/deps` to directly make GAP a build dependency of sagelib as well, which is now needed (and remove the obsolete reference to the libgap spkg).",
    "created_at": "2018-11-08T15:59:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423322",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>
Needed to modify `build/make/deps` to directly make GAP a build dependency of sagelib as well, which is now needed (and remove the obsolete reference to the libgap spkg).



---

archive/issue_comments_423323.json:
```json
{
    "body": "**Changing author** from \"Nicolas M. Thi\u00e9ry, ...\" to \"Nicolas M. Thi\u00e9ry, Dima Pasechnik, Jeroen Demeyer\".",
    "created_at": "2018-11-09T10:23:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423323",
    "user": "https://github.com/jdemeyer"
}
```

**Changing author** from "Nicolas M. Thi√©ry, ..." to "Nicolas M. Thi√©ry, Dima Pasechnik, Jeroen Demeyer".



---

archive/issue_comments_423324.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,11 +1,5 @@\n GAP 4.9 comes with a completely rewritten build system that will simplify\n-our packaging. In fact, it may well enable Sage to use a vanilla GAP\n-installation as provided by the distribution.\n-\n-The GAP team will provide libGAP with GAP 4.10.\n-\n-The branch attached to this ticket updates Sage to run on top of\n-of a recent GAP master branch, close to the future 4.10.\n+our packaging. In particular, libGAP no longer needs to be a separate package.\n \n What the branch does:\n \n@@ -40,53 +34,6 @@\n - Revert #19726 (not needed anymore)\n \n Status: currently broken  - crashes deep inside GAP error handling system after few simple commands. \n-\n-TODO:\n-\n-- ???\n-\n-To make a GAP package: get their sources from https://github.com/gap-system/gap, then run\n-\n-```\n-./autogen.sh\n-./configure --prefix=$SAGE_LOCAL\n-make bootstrap-pkg-minimal\n-make libgap\n-make install\n-```\n-\n-\n-Testing libgap in GAP (there are few tests written in C):\n-\n-```\n-make testlibgap\n-```\n-\n-Build and install a tardist for Sage, and rebuild the spkg:\n-\n-```\n-make distclean\n-./autogen.sh\n-./configure\n-make manuals\n-make clean\n-\n-(cd ..; tar zcvf $SAGE/upstream/$GAP.tar.gz --exclude .git $GAP)\n-\n-sage --package fix-checksum\n-sage -f gap                      # -s\n-```\n-\n-Header files:\n-- Copy GAP's header files, as well as gen/config.h to $SAGE/local/include\n-- Fix them to adapt the include path: #include <src/...> -> #include <gap/...>\n-- **Replace T_INT by 0 in TNUM_OBJ, around line 414 of objects.h**\n-\n-Run:\n-\n-```\n-sage -b\n-```\n \n Basic tests on libgap:\n \n@@ -144,4 +91,4 @@\n   was the first stable release of GAP 4.9 (GAP 4.9.0 was a beta for GAP 4.9).\n - Max Horn reviewed the list of GAP symbols we use in Sage; some have already changed in 4.9. See this [pad](https://hackmd.io/emNi76svSWCh1fBeLKqPdA?edit#) for notes.\n \n-Tarball : https://github.com/dimpase/gap/releases/download/dev/gap-4.dev.tar.gz\n+**Tarball**: https://www.gap-system.org/pub/gap/gap-4.10/tar.bz2/gap-4.10.0.tar.bz2\n``````\n",
    "created_at": "2018-11-09T10:23:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423324",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,11 +1,5 @@
 GAP 4.9 comes with a completely rewritten build system that will simplify
-our packaging. In fact, it may well enable Sage to use a vanilla GAP
-installation as provided by the distribution.
-
-The GAP team will provide libGAP with GAP 4.10.
-
-The branch attached to this ticket updates Sage to run on top of
-of a recent GAP master branch, close to the future 4.10.
+our packaging. In particular, libGAP no longer needs to be a separate package.
 
 What the branch does:
 
@@ -40,53 +34,6 @@
 - Revert #19726 (not needed anymore)
 
 Status: currently broken  - crashes deep inside GAP error handling system after few simple commands. 
-
-TODO:
-
-- ???
-
-To make a GAP package: get their sources from https://github.com/gap-system/gap, then run
-
-```
-./autogen.sh
-./configure --prefix=$SAGE_LOCAL
-make bootstrap-pkg-minimal
-make libgap
-make install
-```
-
-
-Testing libgap in GAP (there are few tests written in C):
-
-```
-make testlibgap
-```
-
-Build and install a tardist for Sage, and rebuild the spkg:
-
-```
-make distclean
-./autogen.sh
-./configure
-make manuals
-make clean
-
-(cd ..; tar zcvf $SAGE/upstream/$GAP.tar.gz --exclude .git $GAP)
-
-sage --package fix-checksum
-sage -f gap                      # -s
-```
-
-Header files:
-- Copy GAP's header files, as well as gen/config.h to $SAGE/local/include
-- Fix them to adapt the include path: #include <src/...> -> #include <gap/...>
-- **Replace T_INT by 0 in TNUM_OBJ, around line 414 of objects.h**
-
-Run:
-
-```
-sage -b
-```
 
 Basic tests on libgap:
 
@@ -144,4 +91,4 @@
   was the first stable release of GAP 4.9 (GAP 4.9.0 was a beta for GAP 4.9).
 - Max Horn reviewed the list of GAP symbols we use in Sage; some have already changed in 4.9. See this [pad](https://hackmd.io/emNi76svSWCh1fBeLKqPdA?edit#) for notes.
 
-Tarball : https://github.com/dimpase/gap/releases/download/dev/gap-4.dev.tar.gz
+**Tarball**: https://www.gap-system.org/pub/gap/gap-4.10/tar.bz2/gap-4.10.0.tar.bz2
``````




---

archive/issue_comments_423325.json:
```json
{
    "body": "<a id='comment:136'></a>\nReplying to [embray](#comment%3A130):\n> I'm updating it right now to the 4.10 release.\n\n\nAre you actually doing that? I haven't seen any update on the branch here.",
    "created_at": "2018-11-09T10:24:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423325",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:136'></a>
Replying to [embray](#comment%3A130):
> I'm updating it right now to the 4.10 release.


Are you actually doing that? I haven't seen any update on the branch here.



---

archive/issue_comments_423326.json:
```json
{
    "body": "**Changing author** from \"Nicolas M. Thi\u00e9ry, Dima Pasechnik, Jeroen Demeyer\" to \"Nicolas M. Thi\u00e9ry, Dima Pasechnik, Erik Bray, Jeroen Demeyer\".",
    "created_at": "2018-11-09T10:25:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423326",
    "user": "https://github.com/jdemeyer"
}
```

**Changing author** from "Nicolas M. Thi√©ry, Dima Pasechnik, Jeroen Demeyer" to "Nicolas M. Thi√©ry, Dima Pasechnik, Erik Bray, Jeroen Demeyer".



---

archive/issue_comments_423327.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -86,9 +86,6 @@\n \n Note:\n \n-- [GAP 4.9.2](http://www.gap-system.org/Releases/4.9.2.html) was released in July 2018.\n-- [GAP 4.9.1](http://www.gap-system.org/Releases/4.9.1.html), released in May 2018,\n-  was the first stable release of GAP 4.9 (GAP 4.9.0 was a beta for GAP 4.9).\n - Max Horn reviewed the list of GAP symbols we use in Sage; some have already changed in 4.9. See this [pad](https://hackmd.io/emNi76svSWCh1fBeLKqPdA?edit#) for notes.\n \n **Tarball**: https://www.gap-system.org/pub/gap/gap-4.10/tar.bz2/gap-4.10.0.tar.bz2\n``````\n",
    "created_at": "2018-11-09T10:36:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423327",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -86,9 +86,6 @@
 
 Note:
 
-- [GAP 4.9.2](http://www.gap-system.org/Releases/4.9.2.html) was released in July 2018.
-- [GAP 4.9.1](http://www.gap-system.org/Releases/4.9.1.html), released in May 2018,
-  was the first stable release of GAP 4.9 (GAP 4.9.0 was a beta for GAP 4.9).
 - Max Horn reviewed the list of GAP symbols we use in Sage; some have already changed in 4.9. See this [pad](https://hackmd.io/emNi76svSWCh1fBeLKqPdA?edit#) for notes.
 
 **Tarball**: https://www.gap-system.org/pub/gap/gap-4.10/tar.bz2/gap-4.10.0.tar.bz2
``````




---

archive/issue_comments_423328.json:
```json
{
    "body": "<a id='comment:9'></a>\nThanks to this Cython PR (by me!), the libGAP `T_INT` thing might not be an issue anymore: https://github.com/cython/cython/pull/2006\n\nCython will still include `<structmember.h>` but only *after* all user code. It's still very fragile to have two different meanings for `T_INT` in the same source file (one `enum` value and one `#define`), but it should work for now. Of course, nobody can promise that it will remain working in the future.",
    "created_at": "2018-11-09T11:30:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423328",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>
Thanks to this Cython PR (by me!), the libGAP `T_INT` thing might not be an issue anymore: https://github.com/cython/cython/pull/2006

Cython will still include `<structmember.h>` but only *after* all user code. It's still very fragile to have two different meanings for `T_INT` in the same source file (one `enum` value and one `#define`), but it should work for now. Of course, nobody can promise that it will remain working in the future.



---

archive/issue_comments_423329.json:
```json
{
    "body": "<a id='comment:140'></a>\nReplying to [jdemeyer](#comment%3A136):\n> Replying to [embray](#comment%3A130):\n> > I'm updating it right now to the 4.10 release.\n\n> \n> Are you actually doing that? I haven't seen any update on the branch here.\n\n\nJust locally.  It doesn't even build for me yet so no point in pushing.",
    "created_at": "2018-11-09T12:02:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423329",
    "user": "https://github.com/embray"
}
```

<a id='comment:140'></a>
Replying to [jdemeyer](#comment%3A136):
> Replying to [embray](#comment%3A130):
> > I'm updating it right now to the 4.10 release.

> 
> Are you actually doing that? I haven't seen any update on the branch here.


Just locally.  It doesn't even build for me yet so no point in pushing.



---

archive/issue_comments_423330.json:
```json
{
    "body": "<a id='comment:1'></a>\nI should clarify: GAP itself compiles just fine.  But \"installation\", such that there is any, is still a partially-broken headache, and I'm experimenting how best to incorporate a GAP installation into Sage.\n\nFor now I'll probably keep with something similar to what we have currently, of having a GAP_DIR under `$SAGE_LOCAL/gap`.  But I'm trying to decide, in that case, what the best thing to do with libgap might be.\n\nThough I'm also trying to see if we can do something entirely different with the installation.  There's something close to a standard \"make install\" but it isn't quite right, and I don't know how it works with GAP packages.",
    "created_at": "2018-11-09T15:08:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423330",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>
I should clarify: GAP itself compiles just fine.  But "installation", such that there is any, is still a partially-broken headache, and I'm experimenting how best to incorporate a GAP installation into Sage.

For now I'll probably keep with something similar to what we have currently, of having a GAP_DIR under `$SAGE_LOCAL/gap`.  But I'm trying to decide, in that case, what the best thing to do with libgap might be.

Though I'm also trying to see if we can do something entirely different with the installation.  There's something close to a standard "make install" but it isn't quite right, and I don't know how it works with GAP packages.



---

archive/issue_comments_423331.json:
```json
{
    "body": "<a id='comment:2'></a>\nIt seems that currently `make install` actually just installs the libtool wrapper script for `gap`, and not the plain `gap` executable.  I'm not sure if this is intentional or not--normally this would not make a whole lot of sense I think.  Though one advantage to it is that the libtool wrapper script adds the \"GAP_ROOT\" that it was built in to `PATH`, and thus it seems capable of finding its way to the original GAP_ROOT it was installed from.  This doesn't really work though, from the perspective of system packaging.  The paths hard-coded in the libtool wrapper script are to the build directory itself, so when we move all the GAP_ROOT files to a new location such as `$SAGE_LOCAL/gap/gap-4.10` it doesn't work properly with that GAP_ROOT.\n\nBetter to do what we did traditionally of having `bin/gap` as a shell script that wraps the real `gap` executable and passes an appropriate `-l` flag.  Dima's branch already has something to that effect, though rather than patching `bin/gap.sh` I think we should just install our own custom `gap` script, such as the one that's currently in this branch but unused.  \n\nI'm also experimenting with adding the actual executable under something like `bin/gap-bin`.  I don't think we need all the files from the GAP source tree, much less build artifacts.  I think we can have a minimal GAP_ROOT of sorts (e.g. under `share/gap`) that includes `grp/`, `lib/`, `pkg/` at a minimum...  Maybe `doc/`?  And possibly also `src/` (so that `PageSource` can work for kernel functions) but I'm not sure if that's needed or not...",
    "created_at": "2018-11-09T16:14:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423331",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>
It seems that currently `make install` actually just installs the libtool wrapper script for `gap`, and not the plain `gap` executable.  I'm not sure if this is intentional or not--normally this would not make a whole lot of sense I think.  Though one advantage to it is that the libtool wrapper script adds the "GAP_ROOT" that it was built in to `PATH`, and thus it seems capable of finding its way to the original GAP_ROOT it was installed from.  This doesn't really work though, from the perspective of system packaging.  The paths hard-coded in the libtool wrapper script are to the build directory itself, so when we move all the GAP_ROOT files to a new location such as `$SAGE_LOCAL/gap/gap-4.10` it doesn't work properly with that GAP_ROOT.

Better to do what we did traditionally of having `bin/gap` as a shell script that wraps the real `gap` executable and passes an appropriate `-l` flag.  Dima's branch already has something to that effect, though rather than patching `bin/gap.sh` I think we should just install our own custom `gap` script, such as the one that's currently in this branch but unused.  

I'm also experimenting with adding the actual executable under something like `bin/gap-bin`.  I don't think we need all the files from the GAP source tree, much less build artifacts.  I think we can have a minimal GAP_ROOT of sorts (e.g. under `share/gap`) that includes `grp/`, `lib/`, `pkg/` at a minimum...  Maybe `doc/`?  And possibly also `src/` (so that `PageSource` can work for kernel functions) but I'm not sure if that's needed or not...



---

archive/issue_comments_423332.json:
```json
{
    "body": "<a id='comment:3'></a>\nSo far this \"relatively minimal\" GAP install seems to be working pretty well, and is much cleaner.  I'm sure there are some glitches here and there, but I don't have the expertise to really know how to break it.  A lot of the test suites under `tst/` seem to work, or mostly work.",
    "created_at": "2018-11-09T17:12:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423332",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>
So far this "relatively minimal" GAP install seems to be working pretty well, and is much cleaner.  I'm sure there are some glitches here and there, but I don't have the expertise to really know how to break it.  A lot of the test suites under `tst/` seem to work, or mostly work.



---

archive/issue_comments_423333.json:
```json
{
    "body": "<a id='comment:144'></a>\nReplying to [embray](#comment%3A143):\n> So far this \"relatively minimal\" GAP install seems to be working pretty well, and is much cleaner.  I'm sure there are some glitches here and there, but I don't have the expertise to really know how to break it.  A lot of the test suites under `tst/` seem to work, or mostly work.\n\n\nBreaking libGAP should be easy, but GAP itself should be OK, I think.",
    "created_at": "2018-11-09T17:18:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423333",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:144'></a>
Replying to [embray](#comment%3A143):
> So far this "relatively minimal" GAP install seems to be working pretty well, and is much cleaner.  I'm sure there are some glitches here and there, but I don't have the expertise to really know how to break it.  A lot of the test suites under `tst/` seem to work, or mostly work.


Breaking libGAP should be easy, but GAP itself should be OK, I think.



---

archive/issue_comments_423334.json:
```json
{
    "body": "<a id='comment:5'></a>\nFWIW I'm also developing and testing this on Cygwin, just for some extra wind in my face.",
    "created_at": "2018-11-09T17:19:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423334",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>
FWIW I'm also developing and testing this on Cygwin, just for some extra wind in my face.



---

archive/issue_comments_423335.json:
```json
{
    "body": "<a id='comment:6'></a>\nNote: Also need to manually install `config.h` into the headers.  There's even a note in GAP's Makefile: `# TODO: take care of config.h` :(",
    "created_at": "2018-11-09T17:50:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423335",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>
Note: Also need to manually install `config.h` into the headers.  There's even a note in GAP's Makefile: `# TODO: take care of config.h` :(



---

archive/issue_comments_423336.json:
```json
{
    "body": "<a id='comment:7'></a>\nProgress on my branch so far [here](https://git.sagemath.org/sage.git/log?q=0082a23a2eede93181b0de453998352115214b33..ad2ea5562d6b90ec6325cd82080b8989195f211b&h=ad2ea5562d6b90ec6325cd82080b8989195f211b&qt=range).\n\nCurrently it builds, but is broken (trying to do anything with libgap just hangs).",
    "created_at": "2018-11-09T18:55:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423336",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>
Progress on my branch so far [here](https://git.sagemath.org/sage.git/log?q=0082a23a2eede93181b0de453998352115214b33..ad2ea5562d6b90ec6325cd82080b8989195f211b&h=ad2ea5562d6b90ec6325cd82080b8989195f211b&qt=range).

Currently it builds, but is broken (trying to do anything with libgap just hangs).



---

archive/issue_comments_423337.json:
```json
{
    "body": "<a id='comment:148'></a>\nReplying to [embray](#comment%3A140):\n> Just locally.  It doesn't even build for me yet so no point in pushing.\n\n\nDepends. If it's an improvement over Dima's branch...\n\nThe question is basically: if I want to work on the libGAP interface, on which branch should I work?",
    "created_at": "2018-11-09T20:24:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423337",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:148'></a>
Replying to [embray](#comment%3A140):
> Just locally.  It doesn't even build for me yet so no point in pushing.


Depends. If it's an improvement over Dima's branch...

The question is basically: if I want to work on the libGAP interface, on which branch should I work?



---

archive/issue_comments_423338.json:
```json
{
    "body": "<a id='comment:9'></a>\nI'm building Erik's branch now, once done, I'll be able to say how well it does its job (Erik works on Windows, so this makes things even more interesting for him).",
    "created_at": "2018-11-09T21:10:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423338",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:9'></a>
I'm building Erik's branch now, once done, I'll be able to say how well it does its job (Erik works on Windows, so this makes things even more interesting for him).



---

archive/issue_comments_423339.json:
```json
{
    "body": "<a id='comment:0'></a>\nErik's branch does refer to *.gz tarball, but GAP has .*bz2 tarball. Thus\n\n```\n--- a/build/pkgs/gap/checksums.ini\n+++ b/build/pkgs/gap/checksums.ini\n@@ -1,4 +1,4 @@\n-tarball=gap-VERSION.tar.gz\n-sha1=ab95077df0775bc39dbf13becdc05818935a53d2\n-md5=4d3cd775a7dcf5582b8b4dbc2b484bd4\n-cksum=1444102593\n+tarball=gap-VERSION.tar.bz2\n+sha1=60d0b6b0127758da4270569c6ff42ad2364cac7e\n+md5=7a94c54d2b1190d6471084b8fcbda6a9\n+cksum=40709676\n```",
    "created_at": "2018-11-09T22:10:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423339",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:0'></a>
Erik's branch does refer to *.gz tarball, but GAP has .*bz2 tarball. Thus

```
--- a/build/pkgs/gap/checksums.ini
+++ b/build/pkgs/gap/checksums.ini
@@ -1,4 +1,4 @@
-tarball=gap-VERSION.tar.gz
-sha1=ab95077df0775bc39dbf13becdc05818935a53d2
-md5=4d3cd775a7dcf5582b8b4dbc2b484bd4
-cksum=1444102593
+tarball=gap-VERSION.tar.bz2
+sha1=60d0b6b0127758da4270569c6ff42ad2364cac7e
+md5=7a94c54d2b1190d6471084b8fcbda6a9
+cksum=40709676
```



---

archive/issue_comments_423340.json:
```json
{
    "body": "**Changing work_issues** from \"work...\" to \"fix libgap workspace loading, etc, and much more  work...\".",
    "created_at": "2018-11-10T00:21:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423340",
    "user": "https://github.com/dimpase"
}
```

**Changing work_issues** from "work..." to "fix libgap workspace loading, etc, and much more  work...".



---

archive/issue_comments_423341.json:
```json
{
    "body": "<a id='comment:1'></a>\nApart from this little issue, Erik's branch (u/embray/spkgs/gap-410) is OK---in the sense I can basically do what I was able to do on my branch. E.g. (after not forgetting to remove the stale (lib)GAP workspaces - all bets are off if they are present, e.g. it might be why Erik's job hang, probably something to rectify in the installation prcedure) I can do\n\n```\nsage: a=libgap(1)\nsage: b=libgap(1)\nsage: c=a+b\nsage: c.sage()\n2\n```\nand then get a segfault as follows:\n\n```\nsage: a\n---------------------------------------------------------------------------\nSignalError                               Traceback (most recent call last)\n<ipython-input-5-3f786850e387> in <module>()\n----> 1 a\n\n/home/scratch2/dimpase/sage/sage/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in __call__(self, result)\n    244             self.start_displayhook()\n    245             self.write_output_prompt()\n--> 246             format_dict, md_dict = self.compute_format_data(result)\n    247             self.update_user_ns(result)\n    248             self.fill_exec_result(result)\n\n/home/scratch2/dimpase/sage/sage/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in compute_format_data(self, result)\n    148 \n    149         \"\"\"\n--> 150         return self.shell.display_formatter.format(result)\n    151 \n    152     # This can be set to True by the write_output_prompt method in a subclass\n\n/home/scratch2/dimpase/sage/sage/local/lib/python2.7/site-packages/sage/repl/display/formatter.pyc in format(self, obj, include, exclude)\n    211             exclude = self.default_mime()\n    212         ipy_format, ipy_metadata = super(SageDisplayFormatter, self).format(\n--> 213             obj, include=include, exclude=exclude)\n    214         if not ipy_format:\n    215             return sage_format, sage_metadata\n\n/home/scratch2/dimpase/sage/sage/local/lib/python2.7/site-packages/IPython/core/formatters.pyc in format(self, obj, include, exclude)\n    171             md = None\n    172             try:\n--> 173                 data = formatter(obj)\n    174             except:\n    175                 # FIXME: log the exception\n\n<decorator-gen-9> in __call__(self, obj)\n\n/home/scratch2/dimpase/sage/sage/local/lib/python2.7/site-packages/IPython/core/formatters.pyc in catch_format_error(method, self, *args, **kwargs)\n    215     \"\"\"show traceback on failed format call\"\"\"\n    216     try:\n--> 217         r = method(self, *args, **kwargs)\n    218     except NotImplementedError:\n    219         # don't warn on NotImplementedErrors\n\n/home/scratch2/dimpase/sage/sage/local/lib/python2.7/site-packages/IPython/core/formatters.pyc in __call__(self, obj)\n    334                 return printer(obj)\n    335             # Finally look for special method names\n--> 336             method = get_real_method(obj, self.print_method)\n    337             if method is not None:\n    338                 return method()\n\n/home/scratch2/dimpase/sage/sage/local/lib/python2.7/site-packages/IPython/utils/dir2.pyc in get_real_method(obj, name)\n     72 \n     73     try:\n---> 74         m = getattr(obj, name, None)\n     75     except Exception:\n     76         return None\n\n/home/scratch2/dimpase/sage/sage/local/lib/python2.7/site-packages/sage/libs/gap/element.pyx in sage.libs.gap.element.GapElement.__getattr__ (build/cythonized/sage/libs/gap/element.c:6741)()\n    581         try:\n    582             proxy = make_GapElement_MethodProxy\\\n--> 583                 (self.parent(), gap_eval(name), self)\n    584         except ValueError:\n    585             raise AttributeError('name \"'+str(name)+'\" is not defined in GAP.')\n\n/home/scratch2/dimpase/sage/sage/local/lib/python2.7/site-packages/sage/libs/gap/util.pyx in sage.libs.gap.util.gap_eval (build/cythonized/sage/libs/gap/util.c:5412)()\n    310 #    print(\"gap_string: \"+gap_string+\"\\n\")\n    311     try:\n--> 312             sig_on()\n    313             result = GAP_EvalString(cmd)\n    314             nresults = LEN_LIST(result)\n\nSignalError: Segmentation fault\n```\n\nThis is the sort of crashes I traced to ipython trying to do a rich display of `a`, basically, making GAP repeatedly report errors.\n\nIt seems that now I can reproduce this hanging, it seems that libgap workspace does not load correctly, so to start Sage and libgap I have to manually remove it in `~/.sage/gap/`.",
    "created_at": "2018-11-10T00:21:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423341",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:1'></a>
Apart from this little issue, Erik's branch (u/embray/spkgs/gap-410) is OK---in the sense I can basically do what I was able to do on my branch. E.g. (after not forgetting to remove the stale (lib)GAP workspaces - all bets are off if they are present, e.g. it might be why Erik's job hang, probably something to rectify in the installation prcedure) I can do

```
sage: a=libgap(1)
sage: b=libgap(1)
sage: c=a+b
sage: c.sage()
2
```
and then get a segfault as follows:

```
sage: a
---------------------------------------------------------------------------
SignalError                               Traceback (most recent call last)
<ipython-input-5-3f786850e387> in <module>()
----> 1 a

/home/scratch2/dimpase/sage/sage/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in __call__(self, result)
    244             self.start_displayhook()
    245             self.write_output_prompt()
--> 246             format_dict, md_dict = self.compute_format_data(result)
    247             self.update_user_ns(result)
    248             self.fill_exec_result(result)

/home/scratch2/dimpase/sage/sage/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in compute_format_data(self, result)
    148 
    149         """
--> 150         return self.shell.display_formatter.format(result)
    151 
    152     # This can be set to True by the write_output_prompt method in a subclass

/home/scratch2/dimpase/sage/sage/local/lib/python2.7/site-packages/sage/repl/display/formatter.pyc in format(self, obj, include, exclude)
    211             exclude = self.default_mime()
    212         ipy_format, ipy_metadata = super(SageDisplayFormatter, self).format(
--> 213             obj, include=include, exclude=exclude)
    214         if not ipy_format:
    215             return sage_format, sage_metadata

/home/scratch2/dimpase/sage/sage/local/lib/python2.7/site-packages/IPython/core/formatters.pyc in format(self, obj, include, exclude)
    171             md = None
    172             try:
--> 173                 data = formatter(obj)
    174             except:
    175                 # FIXME: log the exception

<decorator-gen-9> in __call__(self, obj)

/home/scratch2/dimpase/sage/sage/local/lib/python2.7/site-packages/IPython/core/formatters.pyc in catch_format_error(method, self, *args, **kwargs)
    215     """show traceback on failed format call"""
    216     try:
--> 217         r = method(self, *args, **kwargs)
    218     except NotImplementedError:
    219         # don't warn on NotImplementedErrors

/home/scratch2/dimpase/sage/sage/local/lib/python2.7/site-packages/IPython/core/formatters.pyc in __call__(self, obj)
    334                 return printer(obj)
    335             # Finally look for special method names
--> 336             method = get_real_method(obj, self.print_method)
    337             if method is not None:
    338                 return method()

/home/scratch2/dimpase/sage/sage/local/lib/python2.7/site-packages/IPython/utils/dir2.pyc in get_real_method(obj, name)
     72 
     73     try:
---> 74         m = getattr(obj, name, None)
     75     except Exception:
     76         return None

/home/scratch2/dimpase/sage/sage/local/lib/python2.7/site-packages/sage/libs/gap/element.pyx in sage.libs.gap.element.GapElement.__getattr__ (build/cythonized/sage/libs/gap/element.c:6741)()
    581         try:
    582             proxy = make_GapElement_MethodProxy\
--> 583                 (self.parent(), gap_eval(name), self)
    584         except ValueError:
    585             raise AttributeError('name "'+str(name)+'" is not defined in GAP.')

/home/scratch2/dimpase/sage/sage/local/lib/python2.7/site-packages/sage/libs/gap/util.pyx in sage.libs.gap.util.gap_eval (build/cythonized/sage/libs/gap/util.c:5412)()
    310 #    print("gap_string: "+gap_string+"\n")
    311     try:
--> 312             sig_on()
    313             result = GAP_EvalString(cmd)
    314             nresults = LEN_LIST(result)

SignalError: Segmentation fault
```

This is the sort of crashes I traced to ipython trying to do a rich display of `a`, basically, making GAP repeatedly report errors.

It seems that now I can reproduce this hanging, it seems that libgap workspace does not load correctly, so to start Sage and libgap I have to manually remove it in `~/.sage/gap/`.



---

archive/issue_comments_423342.json:
```json
{
    "body": "<a id='comment:152'></a>\nReplying to [embray](#comment%3A142):\n> It seems that currently `make install` actually just installs the libtool wrapper script for `gap`, and not the plain `gap` executable.  I'm not sure if this is intentional or not--normally this would not make a whole lot of sense I think.  Though one advantage to it is that the libtool wrapper script adds the \"GAP_ROOT\" that it was built in to `PATH`, and thus it seems capable of finding its way to the original GAP_ROOT it was installed from.  This doesn't really work though, from the perspective of system packaging.  The paths hard-coded in the libtool wrapper script are to the build directory itself, so when we move all the GAP_ROOT files to a new location such as `$SAGE_LOCAL/gap/gap-4.10` it doesn't work properly with that GAP_ROOT.\n> \n> Better to do what we did traditionally of having `bin/gap` as a shell script that wraps the real `gap` executable and passes an appropriate `-l` flag.  Dima's branch already has something to that effect, though rather than patching `bin/gap.sh` I think we should just install our own custom `gap` script, such as the one that's currently in this branch but unused.  \n> \n> I'm also experimenting with adding the actual executable under something like `bin/gap-bin`.  I don't think we need all the files from the GAP source tree, much less build artifacts.  I think we can have a minimal GAP_ROOT of sorts (e.g. under `share/gap`) that includes `grp/`, `lib/`, `pkg/` at a minimum...  Maybe `doc/`?  And possibly also `src/` (so that `PageSource` can work for kernel functions) but I'm not sure if that's needed or not...\n\n\n\nThis is not my experience here with just plain gap-4.10.0 package\n\n```\nfbissey@moonloop ~/sandbox/local-gap/bin $ ldd -r gap\n        linux-vdso.so.1 (0x00007ffc039c2000)\n        libgmp.so.10 => /usr/lib64/libgmp.so.10 (0x00007fa163a4a000)\n        libz.so.1 => /lib64/libz.so.1 (0x00007fa163833000)\n        libreadline.so.7 => /lib64/libreadline.so.7 (0x00007fa1635e6000)\n        libm.so.6 => /lib64/libm.so.6 (0x00007fa16325c000)\n        libdl.so.2 => /lib64/libdl.so.2 (0x00007fa163058000)\n        libutil.so.1 => /lib64/libutil.so.1 (0x00007fa162e55000)\n        libc.so.6 => /lib64/libc.so.6 (0x00007fa162a8d000)\n        libncurses.so.6 => /lib64/libncurses.so.6 (0x00007fa162831000)\n        /lib64/ld-linux-x86-64.so.2 (0x00007fa1645f2000)\nfbissey@moonloop ~/sandbox/local-gap/bin $ file gap\ngap: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, with debug_info, not stripped\n```\nI just get plain executable binaries not libtool scripts after install. Both with the tarball in the description and the one from github (which is lighter because it doesn't include gap packages).",
    "created_at": "2018-11-11T20:24:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423342",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:152'></a>
Replying to [embray](#comment%3A142):
> It seems that currently `make install` actually just installs the libtool wrapper script for `gap`, and not the plain `gap` executable.  I'm not sure if this is intentional or not--normally this would not make a whole lot of sense I think.  Though one advantage to it is that the libtool wrapper script adds the "GAP_ROOT" that it was built in to `PATH`, and thus it seems capable of finding its way to the original GAP_ROOT it was installed from.  This doesn't really work though, from the perspective of system packaging.  The paths hard-coded in the libtool wrapper script are to the build directory itself, so when we move all the GAP_ROOT files to a new location such as `$SAGE_LOCAL/gap/gap-4.10` it doesn't work properly with that GAP_ROOT.
> 
> Better to do what we did traditionally of having `bin/gap` as a shell script that wraps the real `gap` executable and passes an appropriate `-l` flag.  Dima's branch already has something to that effect, though rather than patching `bin/gap.sh` I think we should just install our own custom `gap` script, such as the one that's currently in this branch but unused.  
> 
> I'm also experimenting with adding the actual executable under something like `bin/gap-bin`.  I don't think we need all the files from the GAP source tree, much less build artifacts.  I think we can have a minimal GAP_ROOT of sorts (e.g. under `share/gap`) that includes `grp/`, `lib/`, `pkg/` at a minimum...  Maybe `doc/`?  And possibly also `src/` (so that `PageSource` can work for kernel functions) but I'm not sure if that's needed or not...



This is not my experience here with just plain gap-4.10.0 package

```
fbissey@moonloop ~/sandbox/local-gap/bin $ ldd -r gap
        linux-vdso.so.1 (0x00007ffc039c2000)
        libgmp.so.10 => /usr/lib64/libgmp.so.10 (0x00007fa163a4a000)
        libz.so.1 => /lib64/libz.so.1 (0x00007fa163833000)
        libreadline.so.7 => /lib64/libreadline.so.7 (0x00007fa1635e6000)
        libm.so.6 => /lib64/libm.so.6 (0x00007fa16325c000)
        libdl.so.2 => /lib64/libdl.so.2 (0x00007fa163058000)
        libutil.so.1 => /lib64/libutil.so.1 (0x00007fa162e55000)
        libc.so.6 => /lib64/libc.so.6 (0x00007fa162a8d000)
        libncurses.so.6 => /lib64/libncurses.so.6 (0x00007fa162831000)
        /lib64/ld-linux-x86-64.so.2 (0x00007fa1645f2000)
fbissey@moonloop ~/sandbox/local-gap/bin $ file gap
gap: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, with debug_info, not stripped
```
I just get plain executable binaries not libtool scripts after install. Both with the tarball in the description and the one from github (which is lighter because it doesn't include gap packages).



---

archive/issue_comments_423343.json:
```json
{
    "body": "<a id='comment:3'></a>\nI was getting outright hanging as soon as libgap is initialized (the `sage.libs.gap.util.initialize` function.  It would hang so badly that I could only terminate the process with a SIGKILL, and it would leave my terminal in some invalid state (I have to type `reset` to get it back--the characters aren't even echo'd).  I should note, this was on Cygwin.  I will try now on Linux and see if I get any further.\n\nRegardless, libgap probably shouldn't be doing any monkeying around with the terminal, and that might be part of the problem on Cygwin.  \n\nDima, from where did you download the 4.10.0 tarball?  The one I got from gap-system.org was a tar.gz as in my branch.",
    "created_at": "2018-11-12T09:52:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423343",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>
I was getting outright hanging as soon as libgap is initialized (the `sage.libs.gap.util.initialize` function.  It would hang so badly that I could only terminate the process with a SIGKILL, and it would leave my terminal in some invalid state (I have to type `reset` to get it back--the characters aren't even echo'd).  I should note, this was on Cygwin.  I will try now on Linux and see if I get any further.

Regardless, libgap probably shouldn't be doing any monkeying around with the terminal, and that might be part of the problem on Cygwin.  

Dima, from where did you download the 4.10.0 tarball?  The one I got from gap-system.org was a tar.gz as in my branch.



---

archive/issue_comments_423344.json:
```json
{
    "body": "<a id='comment:154'></a>\nReplying to [fbissey](#comment%3A152):\n> \n> \n> This is not my experience here with just plain gap-4.10.0 package\n> \n> ```\n> fbissey@moonloop ~/sandbox/local-gap/bin $ ldd -r gap\n>         linux-vdso.so.1 (0x00007ffc039c2000)\n>         libgmp.so.10 => /usr/lib64/libgmp.so.10 (0x00007fa163a4a000)\n>         libz.so.1 => /lib64/libz.so.1 (0x00007fa163833000)\n>         libreadline.so.7 => /lib64/libreadline.so.7 (0x00007fa1635e6000)\n>         libm.so.6 => /lib64/libm.so.6 (0x00007fa16325c000)\n>         libdl.so.2 => /lib64/libdl.so.2 (0x00007fa163058000)\n>         libutil.so.1 => /lib64/libutil.so.1 (0x00007fa162e55000)\n>         libc.so.6 => /lib64/libc.so.6 (0x00007fa162a8d000)\n>         libncurses.so.6 => /lib64/libncurses.so.6 (0x00007fa162831000)\n>         /lib64/ld-linux-x86-64.so.2 (0x00007fa1645f2000)\n> fbissey@moonloop ~/sandbox/local-gap/bin $ file gap\n> gap: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, with debug_info, not stripped\n> ```\n> I just get plain executable binaries not libtool scripts after install. Both with the tarball in the description and the one from github (which is lighter because it doesn't include gap packages).\n\n\nI can't tell exactly what file you're looking at, but if the `bin/` directory you reference above is the one that gets created in the gap source three, that's the normal executable.  I'm taking about the `gap` that gets installed to `$PREFIX` when you run `make install`.",
    "created_at": "2018-11-12T10:09:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423344",
    "user": "https://github.com/embray"
}
```

<a id='comment:154'></a>
Replying to [fbissey](#comment%3A152):
> 
> 
> This is not my experience here with just plain gap-4.10.0 package
> 
> ```
> fbissey@moonloop ~/sandbox/local-gap/bin $ ldd -r gap
>         linux-vdso.so.1 (0x00007ffc039c2000)
>         libgmp.so.10 => /usr/lib64/libgmp.so.10 (0x00007fa163a4a000)
>         libz.so.1 => /lib64/libz.so.1 (0x00007fa163833000)
>         libreadline.so.7 => /lib64/libreadline.so.7 (0x00007fa1635e6000)
>         libm.so.6 => /lib64/libm.so.6 (0x00007fa16325c000)
>         libdl.so.2 => /lib64/libdl.so.2 (0x00007fa163058000)
>         libutil.so.1 => /lib64/libutil.so.1 (0x00007fa162e55000)
>         libc.so.6 => /lib64/libc.so.6 (0x00007fa162a8d000)
>         libncurses.so.6 => /lib64/libncurses.so.6 (0x00007fa162831000)
>         /lib64/ld-linux-x86-64.so.2 (0x00007fa1645f2000)
> fbissey@moonloop ~/sandbox/local-gap/bin $ file gap
> gap: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, with debug_info, not stripped
> ```
> I just get plain executable binaries not libtool scripts after install. Both with the tarball in the description and the one from github (which is lighter because it doesn't include gap packages).


I can't tell exactly what file you're looking at, but if the `bin/` directory you reference above is the one that gets created in the gap source three, that's the normal executable.  I'm taking about the `gap` that gets installed to `$PREFIX` when you run `make install`.



---

archive/issue_comments_423345.json:
```json
{
    "body": "<a id='comment:5'></a>\nIt's possible this is only a bug on Cygwin too. I haven't played with it on Linux yet, but I am beginning to now.",
    "created_at": "2018-11-12T10:10:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423345",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>
It's possible this is only a bug on Cygwin too. I haven't played with it on Linux yet, but I am beginning to now.



---

archive/issue_comments_423346.json:
```json
{
    "body": "<a id='comment:6'></a>\nOn Linux I was able to reproduce Dima's results.  The first `libgap()` call is a little slow, which is to be expected--the GAP interface is initialized lazily.  After that it works up to outputting `a`, whereas `a.sage()` and the like works.  I also get the tab-completion segfault.\n\nJeroen: do you have anything to report from your investigation so far?  I'd like to look into these segfaults but I don't want to duplicate your effort if you've already made significant progress.",
    "created_at": "2018-11-12T11:00:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423346",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>
On Linux I was able to reproduce Dima's results.  The first `libgap()` call is a little slow, which is to be expected--the GAP interface is initialized lazily.  After that it works up to outputting `a`, whereas `a.sage()` and the like works.  I also get the tab-completion segfault.

Jeroen: do you have anything to report from your investigation so far?  I'd like to look into these segfaults but I don't want to duplicate your effort if you've already made significant progress.



---

archive/issue_comments_423347.json:
```json
{
    "body": "<a id='comment:7'></a>\nOoh, interesting.  After my initial crash I started Sage up again, tried `libgap(1)`, and it hanged just like on Cygwin.  The process just sits without any CPU usage and does not respond to ctrl-C.  It does respond to a SIGTERM.  Could this have something to do with a corrupt GAP workspace?",
    "created_at": "2018-11-12T11:08:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423347",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>
Ooh, interesting.  After my initial crash I started Sage up again, tried `libgap(1)`, and it hanged just like on Cygwin.  The process just sits without any CPU usage and does not respond to ctrl-C.  It does respond to a SIGTERM.  Could this have something to do with a corrupt GAP workspace?



---

archive/issue_comments_423348.json:
```json
{
    "body": "<a id='comment:8'></a>\nI suspected something like this: GAP is installing its own readline callbacks, overriding the Python REPL's.  I think it should not be doing that at all if `--nointeract`.",
    "created_at": "2018-11-12T11:28:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423348",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>
I suspected something like this: GAP is installing its own readline callbacks, overriding the Python REPL's.  I think it should not be doing that at all if `--nointeract`.



---

archive/issue_comments_423349.json:
```json
{
    "body": "<a id='comment:159'></a>\nReplying to [embray](#comment%3A156):\n> On Linux I was able to reproduce Dima's results.  The first `libgap()` call is a little slow, which is to be expected--the GAP interface is initialized lazily.  After that it works up to outputting `a`, whereas `a.sage()` and the like works.  I also get the tab-completion segfault.\n> \n> Jeroen: do you have anything to report from your investigation so far?  I'd like to look into these segfaults but I don't want to duplicate your effort if you've already made significant progress.\n\n\nI suspect that I forgot that we must not hold pointers to GAP objects - as GAP\u2019s GC is moving things, this would be asking for trouble. So this could be a rich source of bugs I introduced in my branch :(",
    "created_at": "2018-11-12T11:30:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423349",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:159'></a>
Replying to [embray](#comment%3A156):
> On Linux I was able to reproduce Dima's results.  The first `libgap()` call is a little slow, which is to be expected--the GAP interface is initialized lazily.  After that it works up to outputting `a`, whereas `a.sage()` and the like works.  I also get the tab-completion segfault.
> 
> Jeroen: do you have anything to report from your investigation so far?  I'd like to look into these segfaults but I don't want to duplicate your effort if you've already made significant progress.


I suspect that I forgot that we must not hold pointers to GAP objects - as GAP‚Äôs GC is moving things, this would be asking for trouble. So this could be a rich source of bugs I introduced in my branch :(



---

archive/issue_comments_423350.json:
```json
{
    "body": "<a id='comment:0'></a>\nhttps://github.com/gap-system/gap/pull/2988 is introducing more things to libgap API, have a look (and say)",
    "created_at": "2018-11-12T11:39:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423350",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:0'></a>
https://github.com/gap-system/gap/pull/2988 is introducing more things to libgap API, have a look (and say)



---

archive/issue_comments_423351.json:
```json
{
    "body": "<a id='comment:1'></a>\nGAP 4.10 tarballs are here: http://www.gap-system.org/Releases/",
    "created_at": "2018-11-12T11:43:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423351",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:1'></a>
GAP 4.10 tarballs are here: http://www.gap-system.org/Releases/



---

archive/issue_comments_423352.json:
```json
{
    "body": "<a id='comment:2'></a>\nApparently passing the `-E` argument disables readline support so we should do that.  Trying it now.",
    "created_at": "2018-11-12T11:53:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423352",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>
Apparently passing the `-E` argument disables readline support so we should do that.  Trying it now.



---

archive/issue_comments_423353.json:
```json
{
    "body": "<a id='comment:3'></a>\n~~The issue with \"corrupt\" (?) gap workspaces seems to affect old versions too.  After a crash, I switched over to a Sage build with GAP 4.8 just to compare something, and calling libgap hanged again.  I have to `rm -rf` the old workspace to get it to work again.~~ Nevermind; was still running the development Sage. Old Sage does not appear to be impacted.",
    "created_at": "2018-11-12T12:19:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423353",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>
~~The issue with "corrupt" (?) gap workspaces seems to affect old versions too.  After a crash, I switched over to a Sage build with GAP 4.8 just to compare something, and calling libgap hanged again.  I have to `rm -rf` the old workspace to get it to work again.~~ Nevermind; was still running the development Sage. Old Sage does not appear to be impacted.



---

archive/issue_comments_423354.json:
```json
{
    "body": "<a id='comment:4'></a>\nThis comment from Markus seems relevant: https://github.com/gap-system/gap/pull/2702#issuecomment-414960197  I am observing something that sounds like what he describes, and it would explain the terminal non-responsiveness.  I'm not exactly sure where or why this is happening though.",
    "created_at": "2018-11-12T12:52:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423354",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>
This comment from Markus seems relevant: https://github.com/gap-system/gap/pull/2702#issuecomment-414960197  I am observing something that sounds like what he describes, and it would explain the terminal non-responsiveness.  I'm not exactly sure where or why this is happening though.



---

archive/issue_comments_423355.json:
```json
{
    "body": "<a id='comment:5'></a>\n`-E` fixed problems with readline, but we're still having problems in error handling.  Somehow the error handling code--particularly manipulation of the `ERROR_OUTPUT` stream, results in a stack overflow \\o/",
    "created_at": "2018-11-12T14:16:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423355",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>
`-E` fixed problems with readline, but we're still having problems in error handling.  Somehow the error handling code--particularly manipulation of the `ERROR_OUTPUT` stream, results in a stack overflow \o/



---

archive/issue_comments_423356.json:
```json
{
    "body": "<a id='comment:6'></a>\nlibgap is started in `sage.libs.gap.util.initialize()`, and you see that \n\n```\nargv[11] = \"--nointeract\"\n```\ni.e. `--nointeract` is passed. So you add `-E` to this list, right?\n\nThe GAP [patch](https://git.sagemath.org/sage.git/diff/build/pkgs/gap/patches/nolooping.patch?id=d86c61698a259b8ff0209500cf154676177c7208) you disabled in your branch makes the stack overflow you see a bit more transparent, I think...",
    "created_at": "2018-11-12T14:24:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423356",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:6'></a>
libgap is started in `sage.libs.gap.util.initialize()`, and you see that 

```
argv[11] = "--nointeract"
```
i.e. `--nointeract` is passed. So you add `-E` to this list, right?

The GAP [patch](https://git.sagemath.org/sage.git/diff/build/pkgs/gap/patches/nolooping.patch?id=d86c61698a259b8ff0209500cf154676177c7208) you disabled in your branch makes the stack overflow you see a bit more transparent, I think...



---

archive/issue_comments_423357.json:
```json
{
    "body": "<a id='comment:7'></a>\nin my branch in `sage.libs.gap.util.initialize()` I have `cdef int argc = 11`, and this seems to be off by 1. Is it the root of all the evil?",
    "created_at": "2018-11-12T14:43:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423357",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:7'></a>
in my branch in `sage.libs.gap.util.initialize()` I have `cdef int argc = 11`, and this seems to be off by 1. Is it the root of all the evil?



---

archive/issue_comments_423358.json:
```json
{
    "body": "<a id='comment:168'></a>\nReplying to [dimpase](#comment%3A167):\n> in my branch in `sage.libs.gap.util.initialize()` I have `cdef int argc = 11`, and this seems to be off by 1. Is it the root of all the evil?\n\n\n~~No, that seems right to me...?~~ No, you're right.  It's off by one.",
    "created_at": "2018-11-12T15:20:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423358",
    "user": "https://github.com/embray"
}
```

<a id='comment:168'></a>
Replying to [dimpase](#comment%3A167):
> in my branch in `sage.libs.gap.util.initialize()` I have `cdef int argc = 11`, and this seems to be off by 1. Is it the root of all the evil?


~~No, that seems right to me...?~~ No, you're right.  It's off by one.



---

archive/issue_comments_423359.json:
```json
{
    "body": "<a id='comment:169'></a>\nReplying to [dimpase](#comment%3A166):\n> libgap is started in `sage.libs.gap.util.initialize()`, and you see that \n> \n> ```\n> argv[11] = \"--nointeract\"\n> ```\n> i.e. `--nointeract` is passed. So you add `-E` to this list, right?\n\n\nBasically.  I replaced `-T` with `-E`, since `-T` is *implied* by `--no-interact` (which should probably also imply `-E`, but it doesn't).\n\nHowever, as you pointed out, there's an off-by-one and now I'm not so sure if `--no-interact` was being processed at all.",
    "created_at": "2018-11-12T15:23:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423359",
    "user": "https://github.com/embray"
}
```

<a id='comment:169'></a>
Replying to [dimpase](#comment%3A166):
> libgap is started in `sage.libs.gap.util.initialize()`, and you see that 
> 
> ```
> argv[11] = "--nointeract"
> ```
> i.e. `--nointeract` is passed. So you add `-E` to this list, right?


Basically.  I replaced `-T` with `-E`, since `-T` is *implied* by `--no-interact` (which should probably also imply `-E`, but it doesn't).

However, as you pointed out, there's an off-by-one and now I'm not so sure if `--no-interact` was being processed at all.



---

archive/issue_comments_423360.json:
```json
{
    "body": "<a id='comment:0'></a>\nThere's what I would consider a bug in GAP, where the function `PRINT_OR_APPEND_TO_STREAM` goes:\n\n```\n    /* try to open the file for output                                     */\n    i = OpenOutputStream(stream);\n    if ( ! i ) {\n        ErrorQuit( \"%s: cannot open stream for output\", (Int)funcname, 0L );\n        return 0;\n    }\n```\n\nbut if this is called to print to the `ERROR_OUTPUT` stream *during* `ErrorQuit` then we get an infinite recursion.  This is the root cause of the segfault's we're seeing.  What I'm not sure about is why `OpenOutputStream` would fail, since we close `ERROR_OUTPUT` after each error, and then re-open it as a new stream.  That part bothers me.  But I think GAP should check here if `stream == ERROR_OUTPUT` and if so reset `ERROR_OUTPUT` to its default value as a last resort, or something to that effect.",
    "created_at": "2018-11-12T17:52:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423360",
    "user": "https://github.com/embray"
}
```

<a id='comment:0'></a>
There's what I would consider a bug in GAP, where the function `PRINT_OR_APPEND_TO_STREAM` goes:

```
    /* try to open the file for output                                     */
    i = OpenOutputStream(stream);
    if ( ! i ) {
        ErrorQuit( "%s: cannot open stream for output", (Int)funcname, 0L );
        return 0;
    }
```

but if this is called to print to the `ERROR_OUTPUT` stream *during* `ErrorQuit` then we get an infinite recursion.  This is the root cause of the segfault's we're seeing.  What I'm not sure about is why `OpenOutputStream` would fail, since we close `ERROR_OUTPUT` after each error, and then re-open it as a new stream.  That part bothers me.  But I think GAP should check here if `stream == ERROR_OUTPUT` and if so reset `ERROR_OUTPUT` to its default value as a last resort, or something to that effect.



---

archive/issue_comments_423361.json:
```json
{
    "body": "<a id='comment:1'></a>\nErik, do you have your updated branch somewhere online?\nMy last attempt to build your branch ends with a glorious collision of GAP's `T_INT` and Python's `T_INT`...\n\nYes, I agree that `PRINT_OR_APPEND_TO_STREAM` is a problem, and the patch in my branch I mentioned in comment 166 provides a crude workaround.\nI already mentioned this to GAP devs more than once, see e.g. https://github.com/gap-system/gap/issues/2487",
    "created_at": "2018-11-12T19:01:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423361",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:1'></a>
Erik, do you have your updated branch somewhere online?
My last attempt to build your branch ends with a glorious collision of GAP's `T_INT` and Python's `T_INT`...

Yes, I agree that `PRINT_OR_APPEND_TO_STREAM` is a problem, and the patch in my branch I mentioned in comment 166 provides a crude workaround.
I already mentioned this to GAP devs more than once, see e.g. https://github.com/gap-system/gap/issues/2487



---

archive/issue_comments_423362.json:
```json
{
    "body": "<a id='comment:2'></a>\nNo, I don't have an updated branch.  I'm not seeing that problem before.\n\nI think I have some idea what the issue is.  The problem is that because we call `sig_error()` in our error handler, we jump out of GAP's eval loop before it can perform certain cleanup, including closing the output stream that it's using to capture output in `GAP_EvalString`.\n\nSo we're leaving things in a slightly fragile state; and more importantly we're not cleaning up after ourselves.  I believe that's the case here.  I wonder if we should forgo `sig_error()` entirely and just let `GAP_EvalString` return naturally.  The error handler can just record somewhere that an error occurred, and we can raise an exception from within gap_eval`.",
    "created_at": "2018-11-12T19:27:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423362",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>
No, I don't have an updated branch.  I'm not seeing that problem before.

I think I have some idea what the issue is.  The problem is that because we call `sig_error()` in our error handler, we jump out of GAP's eval loop before it can perform certain cleanup, including closing the output stream that it's using to capture output in `GAP_EvalString`.

So we're leaving things in a slightly fragile state; and more importantly we're not cleaning up after ourselves.  I believe that's the case here.  I wonder if we should forgo `sig_error()` entirely and just let `GAP_EvalString` return naturally.  The error handler can just record somewhere that an error occurred, and we can raise an exception from within gap_eval`.



---

archive/issue_comments_423363.json:
```json
{
    "body": "<a id='comment:3'></a>\nYep. This patch fixes it:\n\n```diff\ndiff --git a/src/sage/libs/gap/gap_includes.pxd b/src/sage/libs/gap/gap_includes.pxd\nindex 06a82ee..f348e2c 100644\n--- a/src/sage/libs/gap/gap_includes.pxd\n+++ b/src/sage/libs/gap/gap_includes.pxd\n@@ -129,7 +129,7 @@ cdef extern from \"<gap/libgap-api.h>\":\n     ctypedef void (*CallbackFunc)()\n     void GAP_Initialize(int argc, char ** argv, char ** env,\n         CallbackFunc, CallbackFunc)\n-    Obj GAP_EvalString(const char *)\n+    Obj GAP_EvalString(const char *) except *\n     Obj GAP_ValueGlobalVariable(const char *)\n #    void libgap_start_interaction(char* inputline)\n #    char* libgap_get_output()\ndiff --git a/src/sage/libs/gap/util.pyx b/src/sage/libs/gap/util.pyx\nindex aa94e89..fb1e5e1 100644\n--- a/src/sage/libs/gap/util.pyx\n+++ b/src/sage/libs/gap/util.pyx\n@@ -221,8 +221,8 @@ cdef initialize():\n     argv[8] = \"64m\"\n\n     argv[9] = \"-q\"    # no prompt!\n-    argv[10] = \"-T\"    # no debug loop\n-    argv[11] = \"--nointeract\"\n+    argv[10] = \"-E\"    # don't use readline as this will interfere with Python\n+    argv[11] = \"--nointeract\"  # Implies -T\n     argv[12] = NULL\n     cdef int argc = 11   # argv[argc] must be NULL\n\n@@ -237,17 +237,15 @@ cdef initialize():\n\n     # Initialize GAP and capture any error messages\n     # The initialization just prints error and does not use the error handler\n-    # libgap_initialize(argc, argv)\n     try:\n         GAP_Initialize(argc, argv, environ, &gasman_callback, &error_handler)\n     except RuntimeError as msg:\n         raise RuntimeError('libGAP initialization failed\\n' + msg)\n\n-    # gap_error_msg = char_to_str(libgap_get_output())\n-    GAP_EvalString('libgap_errout := \\\"\\\"; ERROR_OUTPUT := OutputTextString(libgap_errout, false);')\n-\n-    # The error handler is called if a GAP evaluation fails, e.g. 1/0\n-    # libgap_set_error_handler(&error_handler)\n+    # Set the ERROR_OUTPUT global in GAP to an output stream in which to\n+    # receive error output\n+    GAP_EvalString('libgap_errout := \"\"; '\n+                   'ERROR_OUTPUT := OutputTextString(libgap_errout, false);')\n\n     # Prepare global GAP variable to hold temporary GAP objects\n     global reference_holder\n@@ -307,23 +305,26 @@ cdef Obj gap_eval(str gap_string) except? NULL:\n     # so that Cython doesn't dereference it before libGAP is done with\n     # its contents.\n     cmd = str_to_bytes(gap_string + ';\\n')\n-#    print(\"gap_string: \"+gap_string+\"\\n\")\n     try:\n-            sig_on()\n-            result = GAP_EvalString(cmd)\n-            nresults = LEN_LIST(result)\n-#            print(\"nresults=\"+str(nresults)+\"\\n\")\n-            if nresults > 1: # to mimick the old libGAP\n-                raise ValueError('can only evaluate a single statement')\n-            result = ELM_LIST(result, 1) # 1-indexed!\n-#            print(\"result's length: \"+str(LEN_LIST(result))+\"\\n\")\n-            if ELM_LIST(result, 1) != GAP_True:\n-                # libgap_call_error_handler()\n-                        print(\"An error occurred, but libGAP has no handler set\")\n-                        return GAP_False # needs work\n-            sig_off()\n+        sig_on()\n+        result = GAP_EvalString(cmd)\n+\n+        # If an error occurred in GAP_EvalString we won't even get\n+        # here if the error handler was set; but in case it wasn't\n+        # let's still check the result...\n+        nresults = LEN_LIST(result)\n+        if nresults > 1:  # to mimick the old libGAP\n+            # TODO: Get rid of this restriction eventually?\n+            raise ValueError('can only evaluate a single statement')\n+\n+        result = ELM_LIST(result, 1) # 1-indexed!\n+        if ELM_LIST(result, 1) != GAP_True:\n+            raise RuntimeError(\"an error occurred, but libGAP has no \"\n+                               \"error handler set\")\n     except RuntimeError as msg:\n-            raise ValueError('libGAP: '+str(msg).strip())\n+        raise ValueError(f'libGAP: {msg}')\n+    finally:\n+        sig_off()\n\n     return ELM_LIST(result, 2)\n\n@@ -357,23 +358,45 @@ cdef void hold_reference(Obj obj):\n\n cdef void error_handler():\n     \"\"\"\n-    The libgap error handler\n+    The libgap error handler.\n\n-    We call ``sig_error()`` which causes us to jump back to the Sage\n-    signal handler. Since we wrap libGAP C calls in ``sig_on`` /\n-    ``sig_off`` blocks, this then jumps back to the ``sig_on`` where\n-    the ``RuntimeError`` we raise here will be seen.\n+    If an error occurred we set a RuntimeError; when the original\n+    GAP_EvalString returns this exception will be raised.\n+\n+    TODO: We should probably prevent re-entering this function if we\n+    are already handling an error; if there is an error in our stream\n+    handling code below it could result in a stack overflow.\n     \"\"\"\n     cdef Obj r\n+    cdef char *msg\n+\n+    # TODO: Do we need/want this ClearError??\n+    ClearError()\n+\n+    # Close the error stream: This flushes any remaining output and closes\n+    # the stream for further writing; reset ERROR_OUTPUT to something sane\n+    # just in case (trying to print to a closed stream segfaults GAP)\n+    GAP_EvalString('CloseStream(ERROR_OUTPUT); '\n+                   'ERROR_OUTPUT := \"*errout*\"; '\n+                   'MakeImmutable(libgap_errout);');\n     r = GAP_ValueGlobalVariable(\"libgap_errout\")\n-    GAP_EvalString(\"CloseStream(ERROR_OUTPUT);\");\n-    GAP_EvalString('libgap_errout := \\\"\\\"; ERROR_OUTPUT := OutputTextString(libgap_errout, false);')\n\n-    msg_py = char_to_str(CSTR_STRING(r))\n-    msg_py = msg_py.replace('For debugging hints type ?Recovery from NoMethodFound\\n', '')\n+    # Grab a pointer to the C string underlying the GAP string libgap_errout\n+    # then copy it to a Python str (char_to_str contains an implicit strcpy)\n+    msg = CSTR_STRING(r)\n+    if msg != NULL:\n+        msg_py = char_to_str(msg)\n+        msg_py = msg_py.replace('For debugging hints type ?Recovery from '\n+                                'NoMethodFound\\n', '')\n+    else:\n+        # Shouldn't happen but just in case...\n+        msg_py = \"An unknown error occurred in libGAP\"\n+\n+    # Reset ERROR_OUTPUT with a new text string stream\n+    GAP_EvalString('libgap_errout := \"\"; '\n+                   'ERROR_OUTPUT := OutputTextString(libgap_errout, false);')\n+\n     PyErr_SetObject(RuntimeError, msg_py)\n-    ClearError()\n-    sig_error()\n\n\n ############################################################################\n```\n\nNow printing GAP elements works, and it also fixes tab-completion.  So a lot of basic stuff works with this.  I make no guarantees about memory leaks, reference counting, etc.",
    "created_at": "2018-11-12T19:59:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423363",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>
Yep. This patch fixes it:

```diff
diff --git a/src/sage/libs/gap/gap_includes.pxd b/src/sage/libs/gap/gap_includes.pxd
index 06a82ee..f348e2c 100644
--- a/src/sage/libs/gap/gap_includes.pxd
+++ b/src/sage/libs/gap/gap_includes.pxd
@@ -129,7 +129,7 @@ cdef extern from "<gap/libgap-api.h>":
     ctypedef void (*CallbackFunc)()
     void GAP_Initialize(int argc, char ** argv, char ** env,
         CallbackFunc, CallbackFunc)
-    Obj GAP_EvalString(const char *)
+    Obj GAP_EvalString(const char *) except *
     Obj GAP_ValueGlobalVariable(const char *)
 #    void libgap_start_interaction(char* inputline)
 #    char* libgap_get_output()
diff --git a/src/sage/libs/gap/util.pyx b/src/sage/libs/gap/util.pyx
index aa94e89..fb1e5e1 100644
--- a/src/sage/libs/gap/util.pyx
+++ b/src/sage/libs/gap/util.pyx
@@ -221,8 +221,8 @@ cdef initialize():
     argv[8] = "64m"

     argv[9] = "-q"    # no prompt!
-    argv[10] = "-T"    # no debug loop
-    argv[11] = "--nointeract"
+    argv[10] = "-E"    # don't use readline as this will interfere with Python
+    argv[11] = "--nointeract"  # Implies -T
     argv[12] = NULL
     cdef int argc = 11   # argv[argc] must be NULL

@@ -237,17 +237,15 @@ cdef initialize():

     # Initialize GAP and capture any error messages
     # The initialization just prints error and does not use the error handler
-    # libgap_initialize(argc, argv)
     try:
         GAP_Initialize(argc, argv, environ, &gasman_callback, &error_handler)
     except RuntimeError as msg:
         raise RuntimeError('libGAP initialization failed\n' + msg)

-    # gap_error_msg = char_to_str(libgap_get_output())
-    GAP_EvalString('libgap_errout := \"\"; ERROR_OUTPUT := OutputTextString(libgap_errout, false);')
-
-    # The error handler is called if a GAP evaluation fails, e.g. 1/0
-    # libgap_set_error_handler(&error_handler)
+    # Set the ERROR_OUTPUT global in GAP to an output stream in which to
+    # receive error output
+    GAP_EvalString('libgap_errout := ""; '
+                   'ERROR_OUTPUT := OutputTextString(libgap_errout, false);')

     # Prepare global GAP variable to hold temporary GAP objects
     global reference_holder
@@ -307,23 +305,26 @@ cdef Obj gap_eval(str gap_string) except? NULL:
     # so that Cython doesn't dereference it before libGAP is done with
     # its contents.
     cmd = str_to_bytes(gap_string + ';\n')
-#    print("gap_string: "+gap_string+"\n")
     try:
-            sig_on()
-            result = GAP_EvalString(cmd)
-            nresults = LEN_LIST(result)
-#            print("nresults="+str(nresults)+"\n")
-            if nresults > 1: # to mimick the old libGAP
-                raise ValueError('can only evaluate a single statement')
-            result = ELM_LIST(result, 1) # 1-indexed!
-#            print("result's length: "+str(LEN_LIST(result))+"\n")
-            if ELM_LIST(result, 1) != GAP_True:
-                # libgap_call_error_handler()
-                        print("An error occurred, but libGAP has no handler set")
-                        return GAP_False # needs work
-            sig_off()
+        sig_on()
+        result = GAP_EvalString(cmd)
+
+        # If an error occurred in GAP_EvalString we won't even get
+        # here if the error handler was set; but in case it wasn't
+        # let's still check the result...
+        nresults = LEN_LIST(result)
+        if nresults > 1:  # to mimick the old libGAP
+            # TODO: Get rid of this restriction eventually?
+            raise ValueError('can only evaluate a single statement')
+
+        result = ELM_LIST(result, 1) # 1-indexed!
+        if ELM_LIST(result, 1) != GAP_True:
+            raise RuntimeError("an error occurred, but libGAP has no "
+                               "error handler set")
     except RuntimeError as msg:
-            raise ValueError('libGAP: '+str(msg).strip())
+        raise ValueError(f'libGAP: {msg}')
+    finally:
+        sig_off()

     return ELM_LIST(result, 2)

@@ -357,23 +358,45 @@ cdef void hold_reference(Obj obj):

 cdef void error_handler():
     """
-    The libgap error handler
+    The libgap error handler.

-    We call ``sig_error()`` which causes us to jump back to the Sage
-    signal handler. Since we wrap libGAP C calls in ``sig_on`` /
-    ``sig_off`` blocks, this then jumps back to the ``sig_on`` where
-    the ``RuntimeError`` we raise here will be seen.
+    If an error occurred we set a RuntimeError; when the original
+    GAP_EvalString returns this exception will be raised.
+
+    TODO: We should probably prevent re-entering this function if we
+    are already handling an error; if there is an error in our stream
+    handling code below it could result in a stack overflow.
     """
     cdef Obj r
+    cdef char *msg
+
+    # TODO: Do we need/want this ClearError??
+    ClearError()
+
+    # Close the error stream: This flushes any remaining output and closes
+    # the stream for further writing; reset ERROR_OUTPUT to something sane
+    # just in case (trying to print to a closed stream segfaults GAP)
+    GAP_EvalString('CloseStream(ERROR_OUTPUT); '
+                   'ERROR_OUTPUT := "*errout*"; '
+                   'MakeImmutable(libgap_errout);');
     r = GAP_ValueGlobalVariable("libgap_errout")
-    GAP_EvalString("CloseStream(ERROR_OUTPUT);");
-    GAP_EvalString('libgap_errout := \"\"; ERROR_OUTPUT := OutputTextString(libgap_errout, false);')

-    msg_py = char_to_str(CSTR_STRING(r))
-    msg_py = msg_py.replace('For debugging hints type ?Recovery from NoMethodFound\n', '')
+    # Grab a pointer to the C string underlying the GAP string libgap_errout
+    # then copy it to a Python str (char_to_str contains an implicit strcpy)
+    msg = CSTR_STRING(r)
+    if msg != NULL:
+        msg_py = char_to_str(msg)
+        msg_py = msg_py.replace('For debugging hints type ?Recovery from '
+                                'NoMethodFound\n', '')
+    else:
+        # Shouldn't happen but just in case...
+        msg_py = "An unknown error occurred in libGAP"
+
+    # Reset ERROR_OUTPUT with a new text string stream
+    GAP_EvalString('libgap_errout := ""; '
+                   'ERROR_OUTPUT := OutputTextString(libgap_errout, false);')
+
     PyErr_SetObject(RuntimeError, msg_py)
-    ClearError()
-    sig_error()


 ############################################################################
```

Now printing GAP elements works, and it also fixes tab-completion.  So a lot of basic stuff works with this.  I make no guarantees about memory leaks, reference counting, etc.



---

archive/issue_comments_423364.json:
```json
{
    "body": "<a id='comment:4'></a>\nyou still have wrong `argc` count on line 227.",
    "created_at": "2018-11-12T20:16:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423364",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:4'></a>
you still have wrong `argc` count on line 227.



---

archive/issue_comments_423365.json:
```json
{
    "body": "<a id='comment:5'></a>\nBut otherwise it's a lot of progress, great!!!",
    "created_at": "2018-11-12T20:17:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423365",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:5'></a>
But otherwise it's a lot of progress, great!!!



---

archive/issue_comments_423366.json:
```json
{
    "body": "<a id='comment:176'></a>\nReplying to [embray](#comment%3A156):\n> Jeroen: do you have anything to report from your investigation so far?  I'd like to look into these segfaults but I don't want to duplicate your effort if you've already made significant progress.\n\n\nNo, on the contrary: I'm not doing anything for the moment since I don't want to interfere were your (Erik and Dima) work.",
    "created_at": "2018-11-13T07:09:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423366",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:176'></a>
Replying to [embray](#comment%3A156):
> Jeroen: do you have anything to report from your investigation so far?  I'd like to look into these segfaults but I don't want to duplicate your effort if you've already made significant progress.


No, on the contrary: I'm not doing anything for the moment since I don't want to interfere were your (Erik and Dima) work.



---

archive/issue_comments_423367.json:
```json
{
    "body": "<a id='comment:177'></a>\nReplying to [dimpase](#comment%3A171):\n> My last attempt to build your branch ends with a glorious collision of GAP's `T_INT` and Python's `T_INT`...\n\n\nWhich branch is that? According to my earlier analysis, that shouldn't happen. So I'd like to see that branch.",
    "created_at": "2018-11-13T09:23:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423367",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:177'></a>
Replying to [dimpase](#comment%3A171):
> My last attempt to build your branch ends with a glorious collision of GAP's `T_INT` and Python's `T_INT`...


Which branch is that? According to my earlier analysis, that shouldn't happen. So I'd like to see that branch.



---

archive/issue_comments_423368.json:
```json
{
    "body": "<a id='comment:178'></a>\nReplying to [embray](#comment%3A172):\n> The problem is that because we call `sig_error()` in our error handler, we jump out of GAP's eval loop before it can perform certain cleanup, including closing the output stream that it's using to capture output in `GAP_EvalString`.\n\n\nIf so, the problem is not limited to `sig_error()` but also to interrupts. So it seems like your proposed solution of not using `sig_error()` will break interrupts, which I do not consider acceptable.\n\nWould there be a way of patching GAP to make `GAP_EvalString` stateless?",
    "created_at": "2018-11-13T09:26:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423368",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:178'></a>
Replying to [embray](#comment%3A172):
> The problem is that because we call `sig_error()` in our error handler, we jump out of GAP's eval loop before it can perform certain cleanup, including closing the output stream that it's using to capture output in `GAP_EvalString`.


If so, the problem is not limited to `sig_error()` but also to interrupts. So it seems like your proposed solution of not using `sig_error()` will break interrupts, which I do not consider acceptable.

Would there be a way of patching GAP to make `GAP_EvalString` stateless?



---

archive/issue_comments_423369.json:
```json
{
    "body": "<a id='comment:9'></a>\nI don't know what you mean that it would \"break interrupts\".  Either way handling an interrupt with cysignals and not returning to GAP is going to break things.\n\nThere's definitely still a problem somewhere:\n\n```\nsage: b = libgap.eval('Sleep(5);')\nCaught error at top-most level, probably quit from library loading\n```\n\nIt sleeps, then displays that message immediately and quits the process.  Strangely, the only source I can find for that message is at the end of `InitializeGap` which should have already exited.  I think there is still some strange things going on in GAP's error handling...\n\nOn the other hand if I do:\n\n```\nsage: f = libgap.eval('Sleep;')\nsage: f\n<Gap function \"Sleep\">\nsage: f(5)\n```\n\nit works.  But when I hit Ctrl-C:\n\n```\nsage: f(10)\n^CCaught error at top-most level, probably quit from library loading\n```\n\nand the process quits again.",
    "created_at": "2018-11-13T10:25:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423369",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>
I don't know what you mean that it would "break interrupts".  Either way handling an interrupt with cysignals and not returning to GAP is going to break things.

There's definitely still a problem somewhere:

```
sage: b = libgap.eval('Sleep(5);')
Caught error at top-most level, probably quit from library loading
```

It sleeps, then displays that message immediately and quits the process.  Strangely, the only source I can find for that message is at the end of `InitializeGap` which should have already exited.  I think there is still some strange things going on in GAP's error handling...

On the other hand if I do:

```
sage: f = libgap.eval('Sleep;')
sage: f
<Gap function "Sleep">
sage: f(5)
```

it works.  But when I hit Ctrl-C:

```
sage: f(10)
^CCaught error at top-most level, probably quit from library loading
```

and the process quits again.



---

archive/issue_comments_423370.json:
```json
{
    "body": "<a id='comment:180'></a>\nReplying to [embray](#comment%3A179):\n> I don't know what you mean that it would \"break interrupts\".\n\n\n(A) If the keep the `sig_on()` statements, then CTRL-C would break GAP in the same way as `sig_error()` breaks GAP.\n\n(B) If you remove the `sig_on()` statements, then GAP can no longer be interrupted with CTRL-C.\n\nI consider both alternatives not acceptable.",
    "created_at": "2018-11-13T10:31:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423370",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:180'></a>
Replying to [embray](#comment%3A179):
> I don't know what you mean that it would "break interrupts".


(A) If the keep the `sig_on()` statements, then CTRL-C would break GAP in the same way as `sig_error()` breaks GAP.

(B) If you remove the `sig_on()` statements, then GAP can no longer be interrupted with CTRL-C.

I consider both alternatives not acceptable.



---

archive/issue_comments_423371.json:
```json
{
    "body": "<a id='comment:1'></a>\nI'm not even sure yet how GAP handles signals.  Do you know anything about it?  I haven't looked into it yet.",
    "created_at": "2018-11-13T10:34:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423371",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>
I'm not even sure yet how GAP handles signals.  Do you know anything about it?  I haven't looked into it yet.



---

archive/issue_comments_423372.json:
```json
{
    "body": "<a id='comment:2'></a>\nThere is a `RegisterSyLongjmpObserver` that might be useful.  I'm not sure if it's used at all in signal handling though.",
    "created_at": "2018-11-13T10:37:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423372",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>
There is a `RegisterSyLongjmpObserver` that might be useful.  I'm not sure if it's used at all in signal handling though.



---

archive/issue_comments_423373.json:
```json
{
    "body": "<a id='comment:3'></a>\nLooking at the GAP sources right now... GAP seems to handle interrupts similar to CPython, by setting some global state. The function below is called by the `SIGINT` handler:\n\n```\n/****************************************************************************\n**\n*F  InterruptExecStat() . . . . . . . . interrupt the execution of statements\n**\n**  'InterruptExecStat'  interrupts the execution of   statements at the next\n**  possible moment.  It is called from 'SyAnsIntr' if an interrupt signal is\n**  received.  It is never called on systems that do not support signals.  On\n**  those systems the executors test 'SyIsIntr' at regular intervals.\n**\n**  'InterruptExecStat' changes all entries   in the executor  dispatch table\n**  'ExecStatFuncs'  to point to  'ExecIntrStat',  which changes  the entries\n**  back, calls 'Error', and redispatches after a return from the break-loop.\n*/\nvoid InterruptExecStat ( void )\n{\n    /* remember the original entries from the table 'ExecStatFuncs'        */\n    STATE(CurrExecStatFuncs) = IntrExecStatFuncs;\n}\n```",
    "created_at": "2018-11-13T10:48:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423373",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>
Looking at the GAP sources right now... GAP seems to handle interrupts similar to CPython, by setting some global state. The function below is called by the `SIGINT` handler:

```
/****************************************************************************
**
*F  InterruptExecStat() . . . . . . . . interrupt the execution of statements
**
**  'InterruptExecStat'  interrupts the execution of   statements at the next
**  possible moment.  It is called from 'SyAnsIntr' if an interrupt signal is
**  received.  It is never called on systems that do not support signals.  On
**  those systems the executors test 'SyIsIntr' at regular intervals.
**
**  'InterruptExecStat' changes all entries   in the executor  dispatch table
**  'ExecStatFuncs'  to point to  'ExecIntrStat',  which changes  the entries
**  back, calls 'Error', and redispatches after a return from the break-loop.
*/
void InterruptExecStat ( void )
{
    /* remember the original entries from the table 'ExecStatFuncs'        */
    STATE(CurrExecStatFuncs) = IntrExecStatFuncs;
}
```



---

archive/issue_comments_423374.json:
```json
{
    "body": "<a id='comment:4'></a>\nOkay.  GAP's own signal handling (which just handles SIGINT) uses `InterruptExecStat` to signal to the eval loop that an interrupt has occurred, so it will break out and return an error at the first opportunity.  We can probably make use of that.",
    "created_at": "2018-11-13T10:49:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423374",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>
Okay.  GAP's own signal handling (which just handles SIGINT) uses `InterruptExecStat` to signal to the eval loop that an interrupt has occurred, so it will break out and return an error at the first opportunity.  We can probably make use of that.



---

archive/issue_comments_423375.json:
```json
{
    "body": "<a id='comment:5'></a>\nI see we've got our noses on the same trail :)  I'm going to step away for a bit anyways.",
    "created_at": "2018-11-13T10:49:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423375",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>
I see we've got our noses on the same trail :)  I'm going to step away for a bit anyways.



---

archive/issue_comments_423376.json:
```json
{
    "body": "<a id='comment:186'></a>\nReplying to [embray](#comment%3A184):\n> We can probably make use of that.\n\n\nThis will need new hooks in cysignals though. Also, all `sig_on()` and `sig_off()` statements should be removed from the GAP interface.\n\nGiven that this is not the first priority, I'll let you guys work further. We can deal with interrupts once we have a mostly-finished GAP interface.",
    "created_at": "2018-11-13T10:59:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423376",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:186'></a>
Replying to [embray](#comment%3A184):
> We can probably make use of that.


This will need new hooks in cysignals though. Also, all `sig_on()` and `sig_off()` statements should be removed from the GAP interface.

Given that this is not the first priority, I'll let you guys work further. We can deal with interrupts once we have a mostly-finished GAP interface.



---

archive/issue_comments_423377.json:
```json
{
    "body": "<a id='comment:187'></a>\nReplying to [jdemeyer](#comment%3A186):\n> Replying to [embray](#comment%3A184):\n> > We can probably make use of that.\n\n> \n> This will need new hooks in cysignals though. Also, all `sig_on()` and `sig_off()` statements should be removed from the GAP interface.\n\n\nI was wondering about that.  I'm not sure cysignals is needed at all really, though if it can provide a wrapper interface to make things easier that might be nice.  I think it would be sufficient, when entering and leaving `GAP_EvalString`, to just register/unregister a custom signal handler, for SIGINT at the very least.\n\nWe also need to be careful around `GAP_Initialize` to restore any existing SIGINT handler that gets clobbered by GAP's initialization...",
    "created_at": "2018-11-13T11:18:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423377",
    "user": "https://github.com/embray"
}
```

<a id='comment:187'></a>
Replying to [jdemeyer](#comment%3A186):
> Replying to [embray](#comment%3A184):
> > We can probably make use of that.

> 
> This will need new hooks in cysignals though. Also, all `sig_on()` and `sig_off()` statements should be removed from the GAP interface.


I was wondering about that.  I'm not sure cysignals is needed at all really, though if it can provide a wrapper interface to make things easier that might be nice.  I think it would be sufficient, when entering and leaving `GAP_EvalString`, to just register/unregister a custom signal handler, for SIGINT at the very least.

We also need to be careful around `GAP_Initialize` to restore any existing SIGINT handler that gets clobbered by GAP's initialization...



---

archive/issue_comments_423378.json:
```json
{
    "body": "<a id='comment:188'></a>\nReplying to [embray](#comment%3A187):\n> to just register/unregister a custom signal handler, for SIGINT at the very least.\n\n\nSince that involves system calls, that would be less efficient than doing something within cysignals. I bet that this would cause a noticable slowdown for a calculation like `1 + 1`.",
    "created_at": "2018-11-13T11:39:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423378",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:188'></a>
Replying to [embray](#comment%3A187):
> to just register/unregister a custom signal handler, for SIGINT at the very least.


Since that involves system calls, that would be less efficient than doing something within cysignals. I bet that this would cause a noticable slowdown for a calculation like `1 + 1`.



---

archive/issue_comments_423379.json:
```json
{
    "body": "<a id='comment:189'></a>\nReplying to [embray](#comment%3A179):\n> I don't know what you mean that it would \"break interrupts\".  Either way handling an interrupt with cysignals and not returning to GAP is going to break things.\n> \n> There's definitely still a problem somewhere:\n> \n> ```\n> sage: b = libgap.eval('Sleep(5);')\n> Caught error at top-most level, probably quit from library loading\n> ```\n> \n> It sleeps, then displays that message immediately and quits the process.  Strangely, the only source I can find for that message is at the end of `InitializeGap` which should have already exited.  I think there is still some strange things going on in GAP's error handling...\n\n\nThe reason for this appears to be a bug in how we're processing the result list from `GAP_EvalString`--in particular it is the equivalent of a Python `IndexError` on the list.  GAP is treating this as a sort of internal error, meaning it jumps to the last invocation of its `TRY_IF_NO_ERROR/CATCH_ERROR` macros.  But since in our code we're not in a `TRY/CATCH`, perversely the last `TRY` is back in `InitializeGap`, so it invokes a longjmp back there.\n\nIt seems we can work around that by using the `ELM_PLIST` function directly rather than the higher-level generic `ELM_LIST`.  The lower-level function does not invoke GAP error handling.  I've added another comment about this here: https://github.com/gap-system/gap/pull/2988/files#r233021437",
    "created_at": "2018-11-13T13:18:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423379",
    "user": "https://github.com/embray"
}
```

<a id='comment:189'></a>
Replying to [embray](#comment%3A179):
> I don't know what you mean that it would "break interrupts".  Either way handling an interrupt with cysignals and not returning to GAP is going to break things.
> 
> There's definitely still a problem somewhere:
> 
> ```
> sage: b = libgap.eval('Sleep(5);')
> Caught error at top-most level, probably quit from library loading
> ```
> 
> It sleeps, then displays that message immediately and quits the process.  Strangely, the only source I can find for that message is at the end of `InitializeGap` which should have already exited.  I think there is still some strange things going on in GAP's error handling...


The reason for this appears to be a bug in how we're processing the result list from `GAP_EvalString`--in particular it is the equivalent of a Python `IndexError` on the list.  GAP is treating this as a sort of internal error, meaning it jumps to the last invocation of its `TRY_IF_NO_ERROR/CATCH_ERROR` macros.  But since in our code we're not in a `TRY/CATCH`, perversely the last `TRY` is back in `InitializeGap`, so it invokes a longjmp back there.

It seems we can work around that by using the `ELM_PLIST` function directly rather than the higher-level generic `ELM_LIST`.  The lower-level function does not invoke GAP error handling.  I've added another comment about this here: https://github.com/gap-system/gap/pull/2988/files#r233021437



---

archive/issue_comments_423380.json:
```json
{
    "body": "<a id='comment:0'></a>\nAnother annoyance--albeit one that I'm not sure if Sage's libGAP handles either--is that if GAP `Panic(...)`s it will just `exit(1)` the process and I'm not sure if there's any way around that currently...",
    "created_at": "2018-11-13T13:19:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423380",
    "user": "https://github.com/embray"
}
```

<a id='comment:0'></a>
Another annoyance--albeit one that I'm not sure if Sage's libGAP handles either--is that if GAP `Panic(...)`s it will just `exit(1)` the process and I'm not sure if there's any way around that currently...



---

archive/issue_comments_423381.json:
```json
{
    "body": "<a id='comment:191'></a>\nReplying to [jdemeyer](#comment%3A177):\n> Replying to [dimpase](#comment%3A171):\n> > My last attempt to build your branch ends with a glorious collision of GAP's `T_INT` and Python's `T_INT`...\n\n> \n> Which branch is that? According to my earlier analysis, that shouldn't happen. So I'd like to see that branch.\n\n\nWell, it was something cooked up a bit, it could be I just messed things up. I hope Erik can update his branch and share it, so that I can try again...",
    "created_at": "2018-11-13T15:42:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423381",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:191'></a>
Replying to [jdemeyer](#comment%3A177):
> Replying to [dimpase](#comment%3A171):
> > My last attempt to build your branch ends with a glorious collision of GAP's `T_INT` and Python's `T_INT`...

> 
> Which branch is that? According to my earlier analysis, that shouldn't happen. So I'd like to see that branch.


Well, it was something cooked up a bit, it could be I just messed things up. I hope Erik can update his branch and share it, so that I can try again...



---

archive/issue_comments_423382.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -15,14 +15,7 @@\n \n - Update a few doctests w.r.t. changes of output of some GAP functions\n \n-- **Possibly controversial:** The new libgap currently *does not come*\n-  with symbol rewriting (`foobar` -> `libGAP_foobar`). This avoids messing\n-  around with GAP's sources; in particular opening the door for using\n-  a stock GAP from the OS distribution. However there always is a risk\n-  of name conflict. And indeed, GAP's constants (actually cpp macros)\n-  T_INT, T_FLOAT, ... conflict with Python's constants. This is\n-  currently worked around by forcing the inclusion of Python's\n-  `structmember.h` before the gap headers.\n+- **Possibly controversial:** The new libgap currently *does not come* with symbol rewriting (`foobar` -> `libGAP_foobar`). This avoids messing around with GAP's sources; in particular opening the door for using a stock GAP from the OS distribution. However there always is a risk of name conflicts. And indeed, GAP's enums `T_INT`, `T_FLOAT`, ... conflict with Python's constants defined in `structmember.h`. This is hopefully not actually a problem in practice due to the way how Cython orders includes.\n \n   Something similar was started by Volker at #19915.\n \n``````\n",
    "created_at": "2018-11-13T16:17:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423382",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -15,14 +15,7 @@
 
 - Update a few doctests w.r.t. changes of output of some GAP functions
 
-- **Possibly controversial:** The new libgap currently *does not come*
-  with symbol rewriting (`foobar` -> `libGAP_foobar`). This avoids messing
-  around with GAP's sources; in particular opening the door for using
-  a stock GAP from the OS distribution. However there always is a risk
-  of name conflict. And indeed, GAP's constants (actually cpp macros)
-  T_INT, T_FLOAT, ... conflict with Python's constants. This is
-  currently worked around by forcing the inclusion of Python's
-  `structmember.h` before the gap headers.
+- **Possibly controversial:** The new libgap currently *does not come* with symbol rewriting (`foobar` -> `libGAP_foobar`). This avoids messing around with GAP's sources; in particular opening the door for using a stock GAP from the OS distribution. However there always is a risk of name conflicts. And indeed, GAP's enums `T_INT`, `T_FLOAT`, ... conflict with Python's constants defined in `structmember.h`. This is hopefully not actually a problem in practice due to the way how Cython orders includes.
 
   Something similar was started by Volker at #19915.
 
``````




---

archive/issue_comments_423383.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -15,7 +15,14 @@\n \n - Update a few doctests w.r.t. changes of output of some GAP functions\n \n-- **Possibly controversial:** The new libgap currently *does not come* with symbol rewriting (`foobar` -> `libGAP_foobar`). This avoids messing around with GAP's sources; in particular opening the door for using a stock GAP from the OS distribution. However there always is a risk of name conflicts. And indeed, GAP's enums `T_INT`, `T_FLOAT`, ... conflict with Python's constants defined in `structmember.h`. This is hopefully not actually a problem in practice due to the way how Cython orders includes.\n+- **Possibly controversial:** The new libgap currently *does not come*\n+  with symbol rewriting (`foobar` -> `libGAP_foobar`). This avoids messing\n+  around with GAP's sources; in particular opening the door for using\n+  a stock GAP from the OS distribution. However there always is a risk\n+  of name conflict. And indeed, GAP's constants (actually cpp macros)\n+  T_INT, T_FLOAT, ... conflict with Python's constants. This is\n+  currently worked around by forcing the inclusion of Python's\n+  `structmember.h` before the gap headers.\n \n   Something similar was started by Volker at #19915.\n \n``````\n",
    "created_at": "2018-11-13T16:20:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423383",
    "user": "https://github.com/embray"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -15,7 +15,14 @@
 
 - Update a few doctests w.r.t. changes of output of some GAP functions
 
-- **Possibly controversial:** The new libgap currently *does not come* with symbol rewriting (`foobar` -> `libGAP_foobar`). This avoids messing around with GAP's sources; in particular opening the door for using a stock GAP from the OS distribution. However there always is a risk of name conflicts. And indeed, GAP's enums `T_INT`, `T_FLOAT`, ... conflict with Python's constants defined in `structmember.h`. This is hopefully not actually a problem in practice due to the way how Cython orders includes.
+- **Possibly controversial:** The new libgap currently *does not come*
+  with symbol rewriting (`foobar` -> `libGAP_foobar`). This avoids messing
+  around with GAP's sources; in particular opening the door for using
+  a stock GAP from the OS distribution. However there always is a risk
+  of name conflict. And indeed, GAP's constants (actually cpp macros)
+  T_INT, T_FLOAT, ... conflict with Python's constants. This is
+  currently worked around by forcing the inclusion of Python's
+  `structmember.h` before the gap headers.
 
   Something similar was started by Volker at #19915.
 
``````




---

archive/issue_comments_423384.json:
```json
{
    "body": "<a id='comment:3'></a>\nShould I just go ahead and attach my branch to this ticket?\n\nIt's up to date with my current work, which mostly works pretty well except for three major issues that I'm aware of:\n\n1) The weirdness with hanging during GAP initialization if there is an existing workspace.  This might have something to do with the issue Markus has mentioned w.r.t. spawning a shell (??) for some reason.  I'm going to look into that next since I consider it the most severe issue for getting something usable.  I'm sure I can figure it out quickly; I just haven't investigated it at all yet.\n\n2) General issues regarding signal handling.  The situation there mostly isn't great--I found some cases where even GAP's eval loop can't be interrupted.  I agree with Jeroen that ideally that's \"not acceptable\", but I believe we may need to compromise in the near term (and the situation isn't all that better in current Sage either).\n\n3) The `Panic` issue.  I've confirmed that affects current Sage as well.  I believe Markus has made some comment to suggest he's thinking about that (among other related issues) so we may have a solution at some point (I think the obvious one, at least broadly speaking, is just having a hook for what `Panic` actually *does*).  But I'm not going to worry about that for the purposes of GAP 4.10 integration since it's at least not a regression.",
    "created_at": "2018-11-13T16:20:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423384",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>
Should I just go ahead and attach my branch to this ticket?

It's up to date with my current work, which mostly works pretty well except for three major issues that I'm aware of:

1) The weirdness with hanging during GAP initialization if there is an existing workspace.  This might have something to do with the issue Markus has mentioned w.r.t. spawning a shell (??) for some reason.  I'm going to look into that next since I consider it the most severe issue for getting something usable.  I'm sure I can figure it out quickly; I just haven't investigated it at all yet.

2) General issues regarding signal handling.  The situation there mostly isn't great--I found some cases where even GAP's eval loop can't be interrupted.  I agree with Jeroen that ideally that's "not acceptable", but I believe we may need to compromise in the near term (and the situation isn't all that better in current Sage either).

3) The `Panic` issue.  I've confirmed that affects current Sage as well.  I believe Markus has made some comment to suggest he's thinking about that (among other related issues) so we may have a solution at some point (I think the obvious one, at least broadly speaking, is just having a hook for what `Panic` actually *does*).  But I'm not going to worry about that for the purposes of GAP 4.10 integration since it's at least not a regression.



---

archive/issue_comments_423385.json:
```json
{
    "body": "<a id='comment:4'></a>\nregarding 1), I guess it is just off by one argc thing I already mentioned, cause in the case of workspace loading, argc is right, so it does notexpect a shell...\n\nby all means, change the branch to your branch...",
    "created_at": "2018-11-13T16:33:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423385",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:4'></a>
regarding 1), I guess it is just off by one argc thing I already mentioned, cause in the case of workspace loading, argc is right, so it does notexpect a shell...

by all means, change the branch to your branch...



---

archive/issue_comments_423386.json:
```json
{
    "body": "<a id='comment:195'></a>\nReplying to [dimpase](#comment%3A194):\n> regarding 1), I guess it is just off by one argc thing I already mentioned, cause in the case of workspace loading, argc is right, so it does notexpect a shell...\n> \n> by all means, change the branch to your branch...\n\n\nI don't think so, because I fixed that in my branch and it still happens.  I previously thought it might have something to do with the workspace being corrupted since I was causing segfaults, but now all it takes is for me to start sage, do one operation with GAP (enough to initialize the workspace), exit sage, and then try to start GAP again...",
    "created_at": "2018-11-13T16:38:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423386",
    "user": "https://github.com/embray"
}
```

<a id='comment:195'></a>
Replying to [dimpase](#comment%3A194):
> regarding 1), I guess it is just off by one argc thing I already mentioned, cause in the case of workspace loading, argc is right, so it does notexpect a shell...
> 
> by all means, change the branch to your branch...


I don't think so, because I fixed that in my branch and it still happens.  I previously thought it might have something to do with the workspace being corrupted since I was causing segfaults, but now all it takes is for me to start sage, do one operation with GAP (enough to initialize the workspace), exit sage, and then try to start GAP again...



---

archive/issue_comments_423387.json:
```json
{
    "body": "**Changing branch** from \"[u/dimpase/WIP/libgap410](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/WIP/libgap410)\" to \"[u/embray/spkgs/gap-410](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/spkgs/gap-410)\".",
    "created_at": "2018-11-13T16:39:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423387",
    "user": "https://github.com/embray"
}
```

**Changing branch** from "[u/dimpase/WIP/libgap410](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/WIP/libgap410)" to "[u/embray/spkgs/gap-410](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/spkgs/gap-410)".



---

archive/issue_comments_423388.json:
```json
{
    "body": "**Changing commit** from \"[406cae67f059056df29413b8fa36ac9964eb3c5b](https://github.com/sagemath/sagetrac-mirror/commit/406cae67f059056df29413b8fa36ac9964eb3c5b)\" to \"[30d1f7fa95fcc9855077c5ed6587748eed1a4cce](https://github.com/sagemath/sagetrac-mirror/commit/30d1f7fa95fcc9855077c5ed6587748eed1a4cce)\".",
    "created_at": "2018-11-13T16:39:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423388",
    "user": "https://github.com/embray"
}
```

**Changing commit** from "[406cae67f059056df29413b8fa36ac9964eb3c5b](https://github.com/sagemath/sagetrac-mirror/commit/406cae67f059056df29413b8fa36ac9964eb3c5b)" to "[30d1f7fa95fcc9855077c5ed6587748eed1a4cce](https://github.com/sagemath/sagetrac-mirror/commit/30d1f7fa95fcc9855077c5ed6587748eed1a4cce)".



---

archive/issue_comments_423389.json:
```json
{
    "body": "<a id='comment:6'></a>\nMy semi-working branch...\n\n---\n**Last 10 new commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/39e6c46ecccc436f71e71f638c68c4fae54d151a\">39e6c46</a></td><td><code>modest progress - can do libgap(1)</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/981e0998a877be88dfb2471ec652b5b518a66789\">981e099</a></td><td><code>still the interaction with ipython is broken</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/17df139a6ff1f8e94db7d12ca6c25610f6d3adf3\">17df139</a></td><td><code>Fix more libGAP prefixes</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e76f38d73c4fb64f6f16eb29364a3775da878e64\">e76f38d</a></td><td><code>remove bogus libgap dependency; add gap as a dependency for sagelib</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bcce30339921cf9ac3fbfad4b431f40588e6adf8\">bcce303</a></td><td><code>updated gap package to the 4.10.0 final release</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ad2ea5562d6b90ec6325cd82080b8989195f211b\">ad2ea55</a></td><td><code>minor source updates to account for new installation layout</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2c21db07714c4f5075682bceaaa370c29d982f4b\">2c21db0</a></td><td><code>Fix some argument handling:</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a797f42eaafb6e4811475a6ffefb713a919eeba4\">a797f42</a></td><td><code>some improvements to robustness of the ERROR_OUTPUT handling when handling</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e58b9edad79c51a4861d390c07b2c43ed019235f\">e58b9ed</a></td><td><code>Allow GAP_EvalString to raise a Python exception</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/30d1f7fa95fcc9855077c5ed6587748eed1a4cce\">30d1f7f</a></td><td><code>cysignals docs sage sig_on() should be outside try</code></td></tr></table>\n",
    "created_at": "2018-11-13T16:39:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423389",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>
My semi-working branch...

---
**Last 10 new commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/39e6c46ecccc436f71e71f638c68c4fae54d151a">39e6c46</a></td><td><code>modest progress - can do libgap(1)</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/981e0998a877be88dfb2471ec652b5b518a66789">981e099</a></td><td><code>still the interaction with ipython is broken</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/17df139a6ff1f8e94db7d12ca6c25610f6d3adf3">17df139</a></td><td><code>Fix more libGAP prefixes</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e76f38d73c4fb64f6f16eb29364a3775da878e64">e76f38d</a></td><td><code>remove bogus libgap dependency; add gap as a dependency for sagelib</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bcce30339921cf9ac3fbfad4b431f40588e6adf8">bcce303</a></td><td><code>updated gap package to the 4.10.0 final release</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ad2ea5562d6b90ec6325cd82080b8989195f211b">ad2ea55</a></td><td><code>minor source updates to account for new installation layout</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2c21db07714c4f5075682bceaaa370c29d982f4b">2c21db0</a></td><td><code>Fix some argument handling:</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a797f42eaafb6e4811475a6ffefb713a919eeba4">a797f42</a></td><td><code>some improvements to robustness of the ERROR_OUTPUT handling when handling</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e58b9edad79c51a4861d390c07b2c43ed019235f">e58b9ed</a></td><td><code>Allow GAP_EvalString to raise a Python exception</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/30d1f7fa95fcc9855077c5ed6587748eed1a4cce">30d1f7f</a></td><td><code>cysignals docs sage sig_on() should be outside try</code></td></tr></table>




---

archive/issue_comments_423390.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -88,4 +88,4 @@\n \n - Max Horn reviewed the list of GAP symbols we use in Sage; some have already changed in 4.9. See this [pad](https://hackmd.io/emNi76svSWCh1fBeLKqPdA?edit#) for notes.\n \n-**Tarball**: https://www.gap-system.org/pub/gap/gap-4.10/tar.bz2/gap-4.10.0.tar.bz2\n+**Tarball**: https://www.gap-system.org/pub/gap/gap-4.10/tar.gz/gap-4.10.0.tar.gz\n``````\n",
    "created_at": "2018-11-13T17:44:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423390",
    "user": "https://github.com/dimpase"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -88,4 +88,4 @@
 
 - Max Horn reviewed the list of GAP symbols we use in Sage; some have already changed in 4.9. See this [pad](https://hackmd.io/emNi76svSWCh1fBeLKqPdA?edit#) for notes.
 
-**Tarball**: https://www.gap-system.org/pub/gap/gap-4.10/tar.bz2/gap-4.10.0.tar.bz2
+**Tarball**: https://www.gap-system.org/pub/gap/gap-4.10/tar.gz/gap-4.10.0.tar.gz
``````




---

archive/issue_comments_423391.json:
```json
{
    "body": "<a id='comment:7'></a>\nlink to the tarball used by the branch",
    "created_at": "2018-11-13T17:44:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423391",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:7'></a>
link to the tarball used by the branch



---

archive/issue_comments_423392.json:
```json
{
    "body": "<a id='comment:8'></a>\nThanks--sorry about that.  No reason not to use the bz2-compressed tarball if it's smaller, either.  I just haven't bothered with it yet.  If you want to make a public branch off mine to mess around with things feel free to do so.",
    "created_at": "2018-11-13T17:45:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423392",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>
Thanks--sorry about that.  No reason not to use the bz2-compressed tarball if it's smaller, either.  I just haven't bothered with it yet.  If you want to make a public branch off mine to mess around with things feel free to do so.



---

archive/issue_comments_423393.json:
```json
{
    "body": "<a id='comment:9'></a>\nTo my surprise, it's *not* in `LoadWorkspace` that it hangs.  Regardless, there's something about there being an existing workspace to load that causes it to crash.   Continuing my gdb session...",
    "created_at": "2018-11-13T17:46:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423393",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>
To my surprise, it's *not* in `LoadWorkspace` that it hangs.  Regardless, there's something about there being an existing workspace to load that causes it to crash.   Continuing my gdb session...



---

archive/issue_comments_423394.json:
```json
{
    "body": "<a id='comment:200'></a>\nReplying to [embray](#comment%3A198):\n> Thanks--sorry about that.  No reason not to use the bz2-compressed tarball if it's smaller, either.  I just haven't bothered with it yet.  If you want to make a public branch off mine to mess around with things feel free to do so.\n\n\nI'll have time in about 7 hours - taking a flight from Boston to London tonight. Please update your branch with whatever good things find...",
    "created_at": "2018-11-13T17:55:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423394",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:200'></a>
Replying to [embray](#comment%3A198):
> Thanks--sorry about that.  No reason not to use the bz2-compressed tarball if it's smaller, either.  I just haven't bothered with it yet.  If you want to make a public branch off mine to mess around with things feel free to do so.


I'll have time in about 7 hours - taking a flight from Boston to London tonight. Please update your branch with whatever good things find...



---

archive/issue_comments_423395.json:
```json
{
    "body": "<a id='comment:1'></a>\nAh, there's a global function called `POST_RESTORE`, which I guess gets set by the workspace, which is where it hangs.  It also appears in `lib/session.g` which is probably worth looking at.",
    "created_at": "2018-11-13T18:01:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423395",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>
Ah, there's a global function called `POST_RESTORE`, which I guess gets set by the workspace, which is where it hangs.  It also appears in `lib/session.g` which is probably worth looking at.



---

archive/issue_comments_423396.json:
```json
{
    "body": "<a id='comment:2'></a>\nAh, the goldmine is in `GAPInfo.PostRestoreFuncs`.  All kind of system-level and terminal-related stuff in here:\n\n```\n[ function (  )\n        local option;\n        for option in GAPInfo.CommandLineOptionData do\n            if IsBound( option.short ) then\n                GAPInfo.CommandLineOptionCanonicalName.(option.short) := option.short;\n                if IsBound( option.long ) then\n                    GAPInfo.CommandLineOptionCanonicalName.(option.long) := option.short;\n                fi;\n            else\n                GAPInfo.CommandLineOptionCanonicalName.(option.long) := option.long;\n            fi;\n        od;\n        return;\n    end, function (  )\n        local j, i, CommandLineOptions, opt, InitFiles, line, word, value, padspace;\n        GAPInfo.KernelInfo := KERNEL_INFO(  );\n        GAPInfo.KernelVersion := GAPInfo.KernelInfo.KERNEL_VERSION;\n        GAPInfo.BuildVersion := GAPInfo.KernelInfo.BUILD_VERSION;\n        GAPInfo.BuildDateTime := GAPInfo.KernelInfo.BUILD_DATETIME;\n        GAPInfo.Architecture := GAPInfo.KernelInfo.GAP_ARCHITECTURE;\n        GAPInfo.SystemCommandLine := GAPInfo.KernelInfo.COMMAND_LINE;\n        GAPInfo.SystemEnvironment := GAPInfo.KernelInfo.ENVIRONMENT;\n        GAPInfo.RootPaths := GAPInfo.KernelInfo.GAP_ROOT_PATHS;\n        if IsBound( GAPInfo.SystemEnvironment.HOME ) then\n            GAPInfo.UserHome := GAPInfo.SystemEnvironment.HOME;\n        else\n            GAPInfo.UserHome := fail;\n        fi;\n        if IsBound( GAPInfo.KernelInfo.DOT_GAP_PATH ) then\n            GAPInfo.UserGapRoot := GAPInfo.KernelInfo.DOT_GAP_PATH;\n        else\n            GAPInfo.UserGapRoot := fail;\n        fi;\n        GAPInfo.DirectoriesPrograms := false;\n        GAPInfo.DirectoryCurrent := false;\n        GAPInfo.DirectoriesLibrary := rec(\n             );\n        GAPInfo.DirectoriesTemporary := [  ];\n        GAPInfo.DirectoriesSystemPrograms := [  ];\n        if IsBound( GAPInfo.SystemEnvironment.PATH ) then\n            j := 1;\n            for i in [ 1 .. LENGTH( GAPInfo.SystemEnvironment.PATH ) ] do\n                if GAPInfo.SystemEnvironment.PATH[i] = ':' then\n                    if i > j then\n                        ADD_LIST_DEFAULT( GAPInfo.DirectoriesSystemPrograms,\n                         MakeImmutable( GAPInfo.SystemEnvironment.PATH{[ j .. i - 1 ]} ) );\n                    fi;\n                    j := i + 1;\n                fi;\n            od;\n            if j <= LENGTH( GAPInfo.SystemEnvironment.PATH ) then\n                ADD_LIST_DEFAULT( GAPInfo.DirectoriesSystemPrograms,\n                 MakeImmutable(\n                   GAPInfo.SystemEnvironment.PATH{[ j .. LENGTH( GAPInfo.SystemEnvironment.PATH ) ]} )\n                 );\n            fi;\n        fi;\n        CommandLineOptions := rec(\n             );\n        for opt in GAPInfo.CommandLineOptionData do\n            if IsBound( opt.short ) then\n                CommandLineOptions.(opt.short) := SHALLOW_COPY_OBJ( opt.default );\n            else\n                CommandLineOptions.(opt.long) := SHALLOW_COPY_OBJ( opt.default );\n            fi;\n        od;\n        InitFiles := [  ];\n        line := GAPInfo.SystemCommandLine;\n        i := 2;\n        while i <= LENGTH( line ) do\n            word := line[i];\n            i := i + 1;\n            if word = \"\" then\n                PRINT_TO( \"*errout*\", \"Ignoring empty command line argument\\n\" );\n            elif word[1] = '-' and (LENGTH( word ) = 2 or word[2] = '-') then\n                opt := word{[ 2 .. LENGTH( word ) ]};\n                if opt[1] = '-' then\n                    opt := opt{[ 2 .. LENGTH( opt ) ]};\n                fi;\n                if not IsBound( GAPInfo.CommandLineOptionCanonicalName.(opt) ) then\n                    PRINT_TO( \"*errout*\", \"Unrecognised command line option: \", word, \"\\n\" );\n                else\n                    opt := GAPInfo.CommandLineOptionCanonicalName.(opt);\n                    value := CommandLineOptions.(opt);\n                    if IS_BOOL( value ) then\n                        CommandLineOptions.(opt) := not CommandLineOptions.(opt);\n                    elif IS_INT( value ) then\n                        CommandLineOptions.(opt) := CommandLineOptions.(opt) + 1;\n                    elif i <= LENGTH( line ) then\n                        if IS_STRING_REP( value ) then\n                            CommandLineOptions.(opt) := line[i];\n                            i := i + 1;\n                        elif IS_LIST( value ) then\n                            ADD_LIST_DEFAULT( CommandLineOptions.(opt), line[i] );\n                            i := i + 1;\n                        fi;\n                    else\n                        PRINT_TO( \"*errout*\", \"Command line option \", word, \" needs an argument.\\n\" );\n                    fi;\n                fi;\n            else\n                ADD_LIST_DEFAULT( InitFiles, word );\n            fi;\n        od;\n        CommandLineOptions.g := CommandLineOptions.g mod 3;\n        CommandLineOptions.E := GAPInfo.KernelInfo.HAVE_LIBREADLINE;\n        if CommandLineOptions.nointeract then\n            CommandLineOptions.T := true;\n            CommandLineOptions.norepl := true;\n        fi;\n        MakeImmutable( CommandLineOptions );\n        MakeImmutable( InitFiles );\n        if CommandLineOptions.L = \"\" or CommandLineOptions.R then\n            GAPInfo.CommandLineOptionsPrev := [  ];\n            GAPInfo.InitFilesPrev := [  ];\n        else\n            ADD_LIST_DEFAULT( GAPInfo.CommandLineOptionsPrev, GAPInfo.CommandLineOptions );\n            ADD_LIST_DEFAULT( GAPInfo.InitFilesPrev, GAPInfo.InitFiles );\n        fi;\n        GAPInfo.CommandLineOptions := CommandLineOptions;\n        GAPInfo.InitFiles := InitFiles;\n        if GAPInfo.CommandLineOptions.D then\n            InfoRead1 := Print;\n        fi;\n        padspace := function ( strlen, len )\n              local i;\n              for i in [ strlen + 1 .. len ] do\n                  PRINT_TO( \"*errout*\", \" \" );\n              od;\n              return;\n          end;\n        if GAPInfo.CommandLineOptions.h then\n            PRINT_TO( \"*errout*\", \"usage: gap [OPTIONS] [FILES]\\n\",\n             \"       run the Groups, Algorithms and Programming system, Version \",\n             GAPInfo.KernelVersion, \"\\n\\n\" );\n            for i in [ 1 .. LENGTH( GAPInfo.CommandLineOptionData ) ] do\n                if\n                 IsBound( GAPInfo.CommandLineOptionData[i] )\n                    and IsBound( GAPInfo.CommandLineOptionData[i].help ) then\n                    opt := GAPInfo.CommandLineOptionData[i];\n                    if IsBound( opt.short ) then\n                        PRINT_TO( \"*errout*\", \" -\", opt.short );\n                        if IsBound( opt.long ) then\n                            PRINT_TO( \"*errout*\", \", --\", opt.long );\n                            padspace( 4 + LENGTH( opt.long ), 16 );\n                        else\n                            padspace( 0, 16 );\n                        fi;\n                        if IsBound( opt.arg ) then\n                            PRINT_TO( \"*errout*\", \" \", opt.arg );\n                            padspace( LENGTH( opt.arg ) + 1, 8 );\n                        else\n                            padspace( 0, 8 );\n                        fi;\n                    else\n                        PRINT_TO( \"*errout*\", \"   \" );\n                        PRINT_TO( \"*errout*\", \"  --\", opt.long );\n                        padspace( 4 + LENGTH( opt.long ), 16 );\n                        if IsBound( opt.arg ) then\n                            PRINT_TO( \"*errout*\", \" \", opt.arg );\n                            padspace( LENGTH( opt.arg ) + 1, 8 );\n                        else\n                            padspace( 0, 8 );\n                        fi;\n                    fi;\n                    if IsBound( opt.long ) and LENGTH( opt.long ) > 12 then\n                        PRINT_TO( \"*errout*\", \"\\n\" );\n                        padspace( 0, 3 + 16 + 8 + 3 );\n                    else\n                        PRINT_TO( \"*errout*\", \"   \" );\n                    fi;\n                    PRINT_TO( \"*errout*\", opt.help[1], \"\\n\" );\n                    for j in [ 2 .. LENGTH( opt.help ) ] do\n                        padspace( 0, 3 + 16 + 8 + 3 );\n                        PRINT_TO( \"*errout*\", opt.help[j], \"\\n\" );\n                    od;\n                else\n                    if not IsBound( GAPInfo.CommandLineOptionData[i] ) then\n                        PRINT_TO( \"*errout*\", \"\\n\" );\n                    fi;\n                fi;\n            od;\n            PRINT_TO( \"*errout*\", \"\\n\",\n             \"  Boolean options (b,q,e,r,A,D,E,M,N,T,X,Y) toggle the current value\\n\",\n             \"  each time they are called. Default actions are indicated first.\\n\", \"\\n\" );\n            QUIT_GAP(  );\n        fi;\n        return;\n    end, function (  )\n        if DEBUG_LOADING then\n            InfoRead1 := Print;\n        else\n            InfoRead1 := Ignore;\n        fi;\n        MAKE_READ_WRITE_GLOBAL( \"DEBUG_LOADING\" );\n        UNBIND_GLOBAL( \"DEBUG_LOADING\" );\n        ASS_GVAR( \"BreakOnError\", not GAPInfo.CommandLineOptions.T );\n        ASS_GVAR( \"AlwaysPrintTracebackOnError\", GAPInfo.CommandLineOptions.alwaystrace );\n        ASS_GVAR( \"SilentNonInteractiveErrors\", false );\n        return;\n    end, function (  )\n        local nondigits, digits, i, char, have, need, haveint, needint;\n        if\n         not IS_STRING( GAPInfo.NeedKernelVersion )\n              and not GAPInfo.KernelVersion in GAPInfo.NeedKernelVersion\n            or IS_STRING( GAPInfo.NeedKernelVersion )\n              and GAPInfo.KernelVersion <> GAPInfo.NeedKernelVersion then\n            Print( \"\\n\\n\", \"You are running a GAP kernel which does not fit with the library.\\n\\n\" );\n            nondigits := [  ];\n            digits := \"0123456789\";\n            for i in [ 0 .. 255 ] do\n                char := CHAR_INT( i );\n                if not char in digits then\n                    ADD_LIST_DEFAULT( nondigits, char );\n                fi;\n            od;\n            have := SplitStringInternal( GAPInfo.KernelVersion, nondigits, \"\" );\n            need := SplitStringInternal( GAPInfo.NeedKernelVersion, nondigits, \"\" );\n            haveint := [  ];\n            needint := [  ];\n            for i in [ 1 .. 3 ] do\n                haveint[i] := IntHexString( have[i] );\n                needint[i] := IntHexString( need[i] );\n            od;\n            Print( \"Current kernel version:   \", haveint[1], \".\", haveint[2], \".\", haveint[3], \"\\n\" );\n            Print( \"Library requires version: \", needint[1], \".\", needint[2], \".\", needint[3], \"\\n\" );\n            if haveint > needint then\n                Print( \"The GAP kernel is newer than the library.\\n\\n\" );\n            else\n                Print(\n                 \"The GAP kernel is older than the library. Perhaps you forgot to recompile?\\n\\n\" );\n            fi;\n            Error( \"Update to correct kernel version!\\n\\n\" );\n        fi;\n        return;\n    end, function (  )\n        local tmp, a;\n        tmp := [  ];\n        for a in REC_NAMES( OPER_FLAGS ) do\n            ADD_LIST( tmp, OPER_FLAGS.(a) );\n            Unbind( OPER_FLAGS.(a) );\n        od;\n        for a in tmp do\n            OPER_FLAGS.(MASTER_POINTER_NUMBER( a[1] )) := a;\n        od;\n        return;\n    end, function (  )\n        ASS_GVAR( \"ERROR_COUNT\", 0 );\n        ASS_GVAR( \"ErrorLevel\", 0 );\n        ;\n        ASS_GVAR( \"QUITTING\", false );\n        return;\n    end, function (  )\n        local env, pos, enc, a, PositionSublist;\n        PositionSublist := function ( str, sub )\n              local i;\n              for i in [ 1 .. Length( str ) - Length( sub ) + 1 ] do\n                  if str{[ i .. i + Length( sub ) - 1 ]} = sub then\n                      return i;\n                  fi;\n              od;\n              return fail;\n          end;\n        if not IsBound( GAPInfo.TermEncodingOverwrite ) then\n            if IsList( GAPInfo.SystemEnvironment ) then\n                env := rec(\n                     );\n                for a in GAPInfo.SystemEnvironment do\n                    pos := Position( a, '=' );\n                    env.(a{[ 1 .. pos - 1 ]}) := a{[ pos + 1 .. Length( a ) ]};\n                od;\n            else\n                env := GAPInfo.SystemEnvironment;\n            fi;\n            enc := fail;\n            if IsBound( env.LC_CTYPE ) then\n                enc := env.LC_CTYPE;\n            fi;\n            if enc = fail and IsBound( env.LC_ALL ) then\n                enc := env.LC_ALL;\n            fi;\n            if enc = fail and IsBound( env.LANG ) then\n                enc := env.LANG;\n            fi;\n            if enc <> fail then\n                enc := STRING_LOWER( enc );\n                if PositionSublist( enc, \"utf-8\" ) <> fail or PositionSublist( enc, \"utf8\" ) <> fail\n                    then\n                    GAPInfo.TermEncoding := \"UTF-8\";\n                fi;\n            fi;\n            if not IsBound( GAPInfo.TermEncoding ) then\n                GAPInfo.TermEncoding := \"ISO-8859-1\";\n            fi;\n        else\n            GAPInfo.TermEncoding := GAPInfo.TermEncodingOverwrite;\n        fi;\n        MakeImmutable( GAPInfo.TermEncoding );\n        return;\n    end, function (  )\n        if\n         not (GAPInfo.CommandLineOptions.q or GAPInfo.CommandLineOptions.b\n               or GAPInfo.CommandLineOptions.L <> \"\") then\n            ShowKernelInformation(  );\n        fi;\n        return;\n    end, function (  )\n        ASS_GVAR( \"IN_LOGGING_MODE\", false );\n        return;\n    end, function (  )\n        if IsBool( GAPInfo.DirectoryCurrent ) then\n            GAPInfo.DirectoryCurrent := Directory( \"./\" );\n        fi;\n        return GAPInfo.DirectoryCurrent;\n    end, function (  )\n        READ_GAP_ROOT( \"gap.ini\" );\n        return;\n    end, function (  )\n        if not GAPInfo.CommandLineOptions.O and UserPreference( \"ReadObsolete\" ) <> false\n            and not IsBound( GAPInfo.Read_obsolete_gd ) then\n            ReadLib( \"obsolete.gd\" );\n            GAPInfo.Read_obsolete_gd := true;\n        fi;\n        return;\n    end, function (  )\n        local env, pos, enc, a;\n        if not IsBound( GAPInfo.TermEncodingOverwrite ) then\n            if IsList( GAPInfo.SystemEnvironment ) then\n                env := rec(\n                     );\n                for a in GAPInfo.SystemEnvironment do\n                    pos := Position( a, '=' );\n                    env.(a{[ 1 .. pos - 1 ]}) := a{[ pos + 1 .. Length( a ) ]};\n                od;\n            else\n                env := GAPInfo.SystemEnvironment;\n            fi;\n            enc := fail;\n            if IsBound( env.LC_CTYPE ) then\n                enc := env.LC_CTYPE;\n            fi;\n            if enc = fail and IsBound( env.LC_ALL ) then\n                enc := env.LC_ALL;\n            fi;\n            if enc = fail and IsBound( env.LANG ) then\n                enc := env.LANG;\n            fi;\n            if\n             enc <> fail and (PositionSublist( enc, \".UTF-8\" ) <> fail\n                  or PositionSublist( enc, \".utf8\" ) <> fail) then\n                GAPInfo.TermEncoding := \"UTF-8\";\n            fi;\n            if not IsBound( GAPInfo.TermEncoding ) then\n                GAPInfo.TermEncoding := \"ISO-8859-1\";\n            fi;\n        else\n            GAPInfo.TermEncoding := GAPInfo.TermEncodingOverwrite;\n        fi;\n        MakeImmutable( GAPInfo.TermEncoding );\n        return;\n    end, function (  )\n        local banner, msg, pair, excludedpackages, name, record;\n        if IsBoundGlobal( \"BANNER\" ) then\n            banner := ValueGlobal( \"BANNER\" );\n            MakeReadWriteGlobal( \"BANNER\" );\n            UnbindGlobal( \"BANNER\" );\n        fi;\n        BindGlobal( \"BANNER\", false );\n        if GAPInfo.CommandLineOptions.L = \"\" then\n            msg := \"entering AutoloadPackages (no workspace)\";\n        else\n            msg := Concatenation( \"entering AutoloadPackages (workspace \", GAPInfo.CommandLineOptions.L\n                , \")\" );\n        fi;\n        LogPackageLoadingMessage( PACKAGE_DEBUG, msg, \"GAP\" );\n        SetInfoLevel( InfoPackageLoading, UserPreference( \"InfoPackageLoadingLevel\" ) );\n        GAPInfo.ExcludeFromAutoload := [  ];\n        GAPInfo.PackagesInfoInitialized := false;\n        InitializePackagesInfoRecords(  );\n        GAPInfo.delayedImplementationParts := [  ];\n        if ForAny( GAPInfo.Dependencies.NeededOtherPackages, function ( p )\n                  return not IsBound( GAPInfo.PackagesLoaded.(p[1]) );\n              end ) then\n            LogPackageLoadingMessage( PACKAGE_DEBUG,\n             Concatenation( [ \"trying to load needed packages\" ],\n               List( GAPInfo.Dependencies.NeededOtherPackages, function ( pair )\n                      return Concatenation( pair[1], \" (\", pair[2], \")\" );\n                  end ) ), \"GAP\" );\n            if GAPInfo.CommandLineOptions.A then\n                PushOptions( rec(\n                    OnlyNeeded := true ) );\n            fi;\n            for pair in GAPInfo.Dependencies.NeededOtherPackages do\n                if LoadPackage( pair[1], pair[2], false ) <> true then\n                    LogPackageLoadingMessage( PACKAGE_ERROR, Concatenation( \"needed package \",\n                       pair[1], \" cannot be loaded\" ), \"GAP\" );\n                    Error( \"failed to load needed package `\", pair[1], \"' (version \", pair[2], \")\" );\n                fi;\n            od;\n            LogPackageLoadingMessage( PACKAGE_DEBUG, \"needed packages loaded\", \"GAP\" );\n            if GAPInfo.CommandLineOptions.A then\n                PopOptions(  );\n            fi;\n        fi;\n        if not IsBound( GAPInfo.LibraryLoaded ) then\n            LogPackageLoadingMessage( PACKAGE_DEBUG, [ \"read the impl. part of the GAP library\" ],\n             \"GAP\" );\n            ReadGapRoot( \"lib/read.g\" );\n            GAPInfo.LibraryLoaded := true;\n            GAPInfo.LoadPackageLevel := GAPInfo.LoadPackageLevel + 1;\n            LoadPackage_ReadImplementationParts( GAPInfo.delayedImplementationParts, false );\n            GAPInfo.LoadPackageLevel := GAPInfo.LoadPackageLevel - 1;\n        fi;\n        Unbind( GAPInfo.delayedImplementationParts );\n        MakeReadWriteGlobal( \"BANNER\" );\n        UnbindGlobal( \"BANNER\" );\n        if IsBound( banner ) then\n            BindGlobal( \"BANNER\", banner );\n        fi;\n        if GAPInfo.CommandLineOptions.A then\n            LogPackageLoadingMessage( PACKAGE_DEBUG,\n             \"omitting packages suggested via \\\"PackagesToLoad\\\" (-A option)\", \"GAP\" );\n        elif ValueOption( \"OnlyNeeded\" ) = true then\n            LogPackageLoadingMessage( PACKAGE_DEBUG,\n             [ \"omitting packages suggested via \\\"PackagesToLoad\\\"\", \" ('OnlyNeeded' option)\" ], \"GAP\"\n             );\n        elif ForAny( List( UserPreference( \"PackagesToLoad\" ), LowercaseString ), function ( p )\n                  return not IsBound( GAPInfo.PackagesLoaded.(p) );\n              end ) then\n            excludedpackages := List( UserPreference( \"ExcludeFromAutoload\" ), LowercaseString );\n            LogPackageLoadingMessage( PACKAGE_DEBUG,\n             Concatenation( [ \"trying to load suggested packages\" ], UserPreference( \"PackagesToLoad\"\n                 ) ), \"GAP\" );\n            for name in UserPreference( \"PackagesToLoad\" ) do\n                if LowercaseString( name ) in excludedpackages then\n                    LogPackageLoadingMessage( PACKAGE_DEBUG,\n                     Concatenation( \"excluded from autoloading: \", name ), \"GAP\" );\n                elif not IsBound( GAPInfo.PackagesLoaded.(LowercaseString( name )) ) then\n                    LogPackageLoadingMessage( PACKAGE_DEBUG,\n                     Concatenation( \"considering for autoloading: \", name ), \"GAP\" );\n                    if LoadPackage( name, false ) <> true then\n                        LogPackageLoadingMessage( PACKAGE_DEBUG, Concatenation( \"suggested package \",\n                           name, \" cannot be loaded\" ), \"GAP\" );\n                    else\n                        LogPackageLoadingMessage( PACKAGE_DEBUG, Concatenation( name, \" loaded\" ),\n                         \"GAP\" );\n                    fi;\n                fi;\n            od;\n            LogPackageLoadingMessage( PACKAGE_DEBUG, \"suggested packages loaded\", \"GAP\" );\n        fi;\n        LogPackageLoadingMessage( PACKAGE_DEBUG,\n         \"call LoadPackageDocumentation for not loaded packages\", \"GAP\" );\n        for name in RecNames( GAPInfo.PackagesInfo ) do\n            if not IsBound( GAPInfo.PackagesLoaded.(name) ) then\n                record := First( GAPInfo.PackagesInfo.(name), IsRecord );\n                if record <> fail then\n                    LoadPackageDocumentation( record );\n                fi;\n            fi;\n        od;\n        LogPackageLoadingMessage( PACKAGE_DEBUG,\n         \"LoadPackageDocumentation for not loaded packages done\", \"GAP\" );\n        Unbind( GAPInfo.ExcludeFromAutoload );\n        LogPackageLoadingMessage( PACKAGE_DEBUG, \"return from AutoloadPackages\", \"GAP\" );\n        return;\n    end, function (  )\n        local xy;\n        xy := [  ];\n        if GAPInfo.CommandLineOptions.x <> \"\" then\n            xy[1] := SMALLINT_STR( GAPInfo.CommandLineOptions.x );\n        fi;\n        if GAPInfo.CommandLineOptions.y <> \"\" then\n            xy[2] := SMALLINT_STR( GAPInfo.CommandLineOptions.y );\n        fi;\n        if xy <> [  ] then\n            SizeScreen( xy );\n        fi;\n        if GAPInfo.CommandLineOptions.g = 0 then\n            SetGasmanMessageStatus( \"none\" );\n        elif GAPInfo.CommandLineOptions.g = 1 then\n            SetGasmanMessageStatus( \"full\" );\n        else\n            SetGasmanMessageStatus( \"all\" );\n        fi;\n        GAPInfo.ViewLength := UserPreference( \"ViewLength\" );\n        ColorPrompt( UserPreference( \"UseColorPrompt\" ) );\n        return;\n    end, function (  )\n        if not GAPInfo.CommandLineOptions.O and UserPreference( \"ReadObsolete\" ) <> false\n            and not IsBound( GAPInfo.Read_obsolete_gi ) then\n            ReadLib( \"obsolete.gi\" );\n            GAPInfo.Read_obsolete_gi := true;\n        fi;\n        return;\n    end, function (  )\n        if UserPreference( \"SaveAndRestoreHistory\" ) = true then\n            InstallAtExit( SaveCommandLineHistory );\n            ReadCommandLineHistory(  );\n        fi;\n        return;\n    end, function (  )\n        if READ_GAP_ROOT( \"gaprc\" ) then\n            GAPInfo.HasReadGAPRC := true;\n        elif not IsExistingFile( GAPInfo.UserGapRoot ) then\n            if not (GAPInfo.CommandLineOptions.r or GAPInfo.HasReadGAPRC) then\n                if ARCH_IS_UNIX(  ) then\n                    GAPInfo.gaprc := SHALLOW_COPY_OBJ( GAPInfo.UserHome );\n                    if IsString( GAPInfo.gaprc ) then\n                        APPEND_LIST_INTR( GAPInfo.gaprc, \"/.gaprc\" );\n                    fi;\n                else\n                    GAPInfo.gaprc := \"gap.rc\";\n                fi;\n                if IsString( GAPInfo.gaprc ) and READ( GAPInfo.gaprc ) then\n                    Info( InfoWarning, 1, \"You are using an old \", GAPInfo.gaprc, \" file. \" );\n                    Info( InfoWarning, 1, \"See '?Ref: The former .gaprc file' for hints to upgrade.\" );\n                    GAPInfo.HasReadGAPRC := true;\n                fi;\n            fi;\n        fi;\n        return;\n    end, function (  )\n        if not (GAPInfo.CommandLineOptions.q or GAPInfo.CommandLineOptions.b) then\n            if GAPInfo.CommandLineOptions.L <> \"\" then\n                ShowKernelInformation(  );\n            fi;\n            ShowPackageInformation(  );\n        fi;\n        return;\n    end, function (  )\n        local i, status;\n        for i in [ 1 .. Length( GAPInfo.InitFiles ) ] do\n            status := READ_NORECOVERY( GAPInfo.InitFiles[i] );\n            if status = fail then\n                PRINT_TO( \"*errout*\", \"Reading file \\\"\", GAPInfo.InitFiles[i],\n                 \"\\\" has been aborted.\\n\" );\n                if i < Length( GAPInfo.InitFiles ) then\n                    PRINT_TO( \"*errout*\",\n                     \"The remaining files on the command line will not be read.\\n\" );\n                fi;\n                break;\n            elif status = false then\n                PRINT_TO( \"*errout*\", \"Could not read file \\\"\", GAPInfo.InitFiles[i], \"\\\".\\n\" );\n            fi;\n        od;\n        return;\n    end ]\n```",
    "created_at": "2018-11-13T18:06:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423396",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>
Ah, the goldmine is in `GAPInfo.PostRestoreFuncs`.  All kind of system-level and terminal-related stuff in here:

```
[ function (  )
        local option;
        for option in GAPInfo.CommandLineOptionData do
            if IsBound( option.short ) then
                GAPInfo.CommandLineOptionCanonicalName.(option.short) := option.short;
                if IsBound( option.long ) then
                    GAPInfo.CommandLineOptionCanonicalName.(option.long) := option.short;
                fi;
            else
                GAPInfo.CommandLineOptionCanonicalName.(option.long) := option.long;
            fi;
        od;
        return;
    end, function (  )
        local j, i, CommandLineOptions, opt, InitFiles, line, word, value, padspace;
        GAPInfo.KernelInfo := KERNEL_INFO(  );
        GAPInfo.KernelVersion := GAPInfo.KernelInfo.KERNEL_VERSION;
        GAPInfo.BuildVersion := GAPInfo.KernelInfo.BUILD_VERSION;
        GAPInfo.BuildDateTime := GAPInfo.KernelInfo.BUILD_DATETIME;
        GAPInfo.Architecture := GAPInfo.KernelInfo.GAP_ARCHITECTURE;
        GAPInfo.SystemCommandLine := GAPInfo.KernelInfo.COMMAND_LINE;
        GAPInfo.SystemEnvironment := GAPInfo.KernelInfo.ENVIRONMENT;
        GAPInfo.RootPaths := GAPInfo.KernelInfo.GAP_ROOT_PATHS;
        if IsBound( GAPInfo.SystemEnvironment.HOME ) then
            GAPInfo.UserHome := GAPInfo.SystemEnvironment.HOME;
        else
            GAPInfo.UserHome := fail;
        fi;
        if IsBound( GAPInfo.KernelInfo.DOT_GAP_PATH ) then
            GAPInfo.UserGapRoot := GAPInfo.KernelInfo.DOT_GAP_PATH;
        else
            GAPInfo.UserGapRoot := fail;
        fi;
        GAPInfo.DirectoriesPrograms := false;
        GAPInfo.DirectoryCurrent := false;
        GAPInfo.DirectoriesLibrary := rec(
             );
        GAPInfo.DirectoriesTemporary := [  ];
        GAPInfo.DirectoriesSystemPrograms := [  ];
        if IsBound( GAPInfo.SystemEnvironment.PATH ) then
            j := 1;
            for i in [ 1 .. LENGTH( GAPInfo.SystemEnvironment.PATH ) ] do
                if GAPInfo.SystemEnvironment.PATH[i] = ':' then
                    if i > j then
                        ADD_LIST_DEFAULT( GAPInfo.DirectoriesSystemPrograms,
                         MakeImmutable( GAPInfo.SystemEnvironment.PATH{[ j .. i - 1 ]} ) );
                    fi;
                    j := i + 1;
                fi;
            od;
            if j <= LENGTH( GAPInfo.SystemEnvironment.PATH ) then
                ADD_LIST_DEFAULT( GAPInfo.DirectoriesSystemPrograms,
                 MakeImmutable(
                   GAPInfo.SystemEnvironment.PATH{[ j .. LENGTH( GAPInfo.SystemEnvironment.PATH ) ]} )
                 );
            fi;
        fi;
        CommandLineOptions := rec(
             );
        for opt in GAPInfo.CommandLineOptionData do
            if IsBound( opt.short ) then
                CommandLineOptions.(opt.short) := SHALLOW_COPY_OBJ( opt.default );
            else
                CommandLineOptions.(opt.long) := SHALLOW_COPY_OBJ( opt.default );
            fi;
        od;
        InitFiles := [  ];
        line := GAPInfo.SystemCommandLine;
        i := 2;
        while i <= LENGTH( line ) do
            word := line[i];
            i := i + 1;
            if word = "" then
                PRINT_TO( "*errout*", "Ignoring empty command line argument\n" );
            elif word[1] = '-' and (LENGTH( word ) = 2 or word[2] = '-') then
                opt := word{[ 2 .. LENGTH( word ) ]};
                if opt[1] = '-' then
                    opt := opt{[ 2 .. LENGTH( opt ) ]};
                fi;
                if not IsBound( GAPInfo.CommandLineOptionCanonicalName.(opt) ) then
                    PRINT_TO( "*errout*", "Unrecognised command line option: ", word, "\n" );
                else
                    opt := GAPInfo.CommandLineOptionCanonicalName.(opt);
                    value := CommandLineOptions.(opt);
                    if IS_BOOL( value ) then
                        CommandLineOptions.(opt) := not CommandLineOptions.(opt);
                    elif IS_INT( value ) then
                        CommandLineOptions.(opt) := CommandLineOptions.(opt) + 1;
                    elif i <= LENGTH( line ) then
                        if IS_STRING_REP( value ) then
                            CommandLineOptions.(opt) := line[i];
                            i := i + 1;
                        elif IS_LIST( value ) then
                            ADD_LIST_DEFAULT( CommandLineOptions.(opt), line[i] );
                            i := i + 1;
                        fi;
                    else
                        PRINT_TO( "*errout*", "Command line option ", word, " needs an argument.\n" );
                    fi;
                fi;
            else
                ADD_LIST_DEFAULT( InitFiles, word );
            fi;
        od;
        CommandLineOptions.g := CommandLineOptions.g mod 3;
        CommandLineOptions.E := GAPInfo.KernelInfo.HAVE_LIBREADLINE;
        if CommandLineOptions.nointeract then
            CommandLineOptions.T := true;
            CommandLineOptions.norepl := true;
        fi;
        MakeImmutable( CommandLineOptions );
        MakeImmutable( InitFiles );
        if CommandLineOptions.L = "" or CommandLineOptions.R then
            GAPInfo.CommandLineOptionsPrev := [  ];
            GAPInfo.InitFilesPrev := [  ];
        else
            ADD_LIST_DEFAULT( GAPInfo.CommandLineOptionsPrev, GAPInfo.CommandLineOptions );
            ADD_LIST_DEFAULT( GAPInfo.InitFilesPrev, GAPInfo.InitFiles );
        fi;
        GAPInfo.CommandLineOptions := CommandLineOptions;
        GAPInfo.InitFiles := InitFiles;
        if GAPInfo.CommandLineOptions.D then
            InfoRead1 := Print;
        fi;
        padspace := function ( strlen, len )
              local i;
              for i in [ strlen + 1 .. len ] do
                  PRINT_TO( "*errout*", " " );
              od;
              return;
          end;
        if GAPInfo.CommandLineOptions.h then
            PRINT_TO( "*errout*", "usage: gap [OPTIONS] [FILES]\n",
             "       run the Groups, Algorithms and Programming system, Version ",
             GAPInfo.KernelVersion, "\n\n" );
            for i in [ 1 .. LENGTH( GAPInfo.CommandLineOptionData ) ] do
                if
                 IsBound( GAPInfo.CommandLineOptionData[i] )
                    and IsBound( GAPInfo.CommandLineOptionData[i].help ) then
                    opt := GAPInfo.CommandLineOptionData[i];
                    if IsBound( opt.short ) then
                        PRINT_TO( "*errout*", " -", opt.short );
                        if IsBound( opt.long ) then
                            PRINT_TO( "*errout*", ", --", opt.long );
                            padspace( 4 + LENGTH( opt.long ), 16 );
                        else
                            padspace( 0, 16 );
                        fi;
                        if IsBound( opt.arg ) then
                            PRINT_TO( "*errout*", " ", opt.arg );
                            padspace( LENGTH( opt.arg ) + 1, 8 );
                        else
                            padspace( 0, 8 );
                        fi;
                    else
                        PRINT_TO( "*errout*", "   " );
                        PRINT_TO( "*errout*", "  --", opt.long );
                        padspace( 4 + LENGTH( opt.long ), 16 );
                        if IsBound( opt.arg ) then
                            PRINT_TO( "*errout*", " ", opt.arg );
                            padspace( LENGTH( opt.arg ) + 1, 8 );
                        else
                            padspace( 0, 8 );
                        fi;
                    fi;
                    if IsBound( opt.long ) and LENGTH( opt.long ) > 12 then
                        PRINT_TO( "*errout*", "\n" );
                        padspace( 0, 3 + 16 + 8 + 3 );
                    else
                        PRINT_TO( "*errout*", "   " );
                    fi;
                    PRINT_TO( "*errout*", opt.help[1], "\n" );
                    for j in [ 2 .. LENGTH( opt.help ) ] do
                        padspace( 0, 3 + 16 + 8 + 3 );
                        PRINT_TO( "*errout*", opt.help[j], "\n" );
                    od;
                else
                    if not IsBound( GAPInfo.CommandLineOptionData[i] ) then
                        PRINT_TO( "*errout*", "\n" );
                    fi;
                fi;
            od;
            PRINT_TO( "*errout*", "\n",
             "  Boolean options (b,q,e,r,A,D,E,M,N,T,X,Y) toggle the current value\n",
             "  each time they are called. Default actions are indicated first.\n", "\n" );
            QUIT_GAP(  );
        fi;
        return;
    end, function (  )
        if DEBUG_LOADING then
            InfoRead1 := Print;
        else
            InfoRead1 := Ignore;
        fi;
        MAKE_READ_WRITE_GLOBAL( "DEBUG_LOADING" );
        UNBIND_GLOBAL( "DEBUG_LOADING" );
        ASS_GVAR( "BreakOnError", not GAPInfo.CommandLineOptions.T );
        ASS_GVAR( "AlwaysPrintTracebackOnError", GAPInfo.CommandLineOptions.alwaystrace );
        ASS_GVAR( "SilentNonInteractiveErrors", false );
        return;
    end, function (  )
        local nondigits, digits, i, char, have, need, haveint, needint;
        if
         not IS_STRING( GAPInfo.NeedKernelVersion )
              and not GAPInfo.KernelVersion in GAPInfo.NeedKernelVersion
            or IS_STRING( GAPInfo.NeedKernelVersion )
              and GAPInfo.KernelVersion <> GAPInfo.NeedKernelVersion then
            Print( "\n\n", "You are running a GAP kernel which does not fit with the library.\n\n" );
            nondigits := [  ];
            digits := "0123456789";
            for i in [ 0 .. 255 ] do
                char := CHAR_INT( i );
                if not char in digits then
                    ADD_LIST_DEFAULT( nondigits, char );
                fi;
            od;
            have := SplitStringInternal( GAPInfo.KernelVersion, nondigits, "" );
            need := SplitStringInternal( GAPInfo.NeedKernelVersion, nondigits, "" );
            haveint := [  ];
            needint := [  ];
            for i in [ 1 .. 3 ] do
                haveint[i] := IntHexString( have[i] );
                needint[i] := IntHexString( need[i] );
            od;
            Print( "Current kernel version:   ", haveint[1], ".", haveint[2], ".", haveint[3], "\n" );
            Print( "Library requires version: ", needint[1], ".", needint[2], ".", needint[3], "\n" );
            if haveint > needint then
                Print( "The GAP kernel is newer than the library.\n\n" );
            else
                Print(
                 "The GAP kernel is older than the library. Perhaps you forgot to recompile?\n\n" );
            fi;
            Error( "Update to correct kernel version!\n\n" );
        fi;
        return;
    end, function (  )
        local tmp, a;
        tmp := [  ];
        for a in REC_NAMES( OPER_FLAGS ) do
            ADD_LIST( tmp, OPER_FLAGS.(a) );
            Unbind( OPER_FLAGS.(a) );
        od;
        for a in tmp do
            OPER_FLAGS.(MASTER_POINTER_NUMBER( a[1] )) := a;
        od;
        return;
    end, function (  )
        ASS_GVAR( "ERROR_COUNT", 0 );
        ASS_GVAR( "ErrorLevel", 0 );
        ;
        ASS_GVAR( "QUITTING", false );
        return;
    end, function (  )
        local env, pos, enc, a, PositionSublist;
        PositionSublist := function ( str, sub )
              local i;
              for i in [ 1 .. Length( str ) - Length( sub ) + 1 ] do
                  if str{[ i .. i + Length( sub ) - 1 ]} = sub then
                      return i;
                  fi;
              od;
              return fail;
          end;
        if not IsBound( GAPInfo.TermEncodingOverwrite ) then
            if IsList( GAPInfo.SystemEnvironment ) then
                env := rec(
                     );
                for a in GAPInfo.SystemEnvironment do
                    pos := Position( a, '=' );
                    env.(a{[ 1 .. pos - 1 ]}) := a{[ pos + 1 .. Length( a ) ]};
                od;
            else
                env := GAPInfo.SystemEnvironment;
            fi;
            enc := fail;
            if IsBound( env.LC_CTYPE ) then
                enc := env.LC_CTYPE;
            fi;
            if enc = fail and IsBound( env.LC_ALL ) then
                enc := env.LC_ALL;
            fi;
            if enc = fail and IsBound( env.LANG ) then
                enc := env.LANG;
            fi;
            if enc <> fail then
                enc := STRING_LOWER( enc );
                if PositionSublist( enc, "utf-8" ) <> fail or PositionSublist( enc, "utf8" ) <> fail
                    then
                    GAPInfo.TermEncoding := "UTF-8";
                fi;
            fi;
            if not IsBound( GAPInfo.TermEncoding ) then
                GAPInfo.TermEncoding := "ISO-8859-1";
            fi;
        else
            GAPInfo.TermEncoding := GAPInfo.TermEncodingOverwrite;
        fi;
        MakeImmutable( GAPInfo.TermEncoding );
        return;
    end, function (  )
        if
         not (GAPInfo.CommandLineOptions.q or GAPInfo.CommandLineOptions.b
               or GAPInfo.CommandLineOptions.L <> "") then
            ShowKernelInformation(  );
        fi;
        return;
    end, function (  )
        ASS_GVAR( "IN_LOGGING_MODE", false );
        return;
    end, function (  )
        if IsBool( GAPInfo.DirectoryCurrent ) then
            GAPInfo.DirectoryCurrent := Directory( "./" );
        fi;
        return GAPInfo.DirectoryCurrent;
    end, function (  )
        READ_GAP_ROOT( "gap.ini" );
        return;
    end, function (  )
        if not GAPInfo.CommandLineOptions.O and UserPreference( "ReadObsolete" ) <> false
            and not IsBound( GAPInfo.Read_obsolete_gd ) then
            ReadLib( "obsolete.gd" );
            GAPInfo.Read_obsolete_gd := true;
        fi;
        return;
    end, function (  )
        local env, pos, enc, a;
        if not IsBound( GAPInfo.TermEncodingOverwrite ) then
            if IsList( GAPInfo.SystemEnvironment ) then
                env := rec(
                     );
                for a in GAPInfo.SystemEnvironment do
                    pos := Position( a, '=' );
                    env.(a{[ 1 .. pos - 1 ]}) := a{[ pos + 1 .. Length( a ) ]};
                od;
            else
                env := GAPInfo.SystemEnvironment;
            fi;
            enc := fail;
            if IsBound( env.LC_CTYPE ) then
                enc := env.LC_CTYPE;
            fi;
            if enc = fail and IsBound( env.LC_ALL ) then
                enc := env.LC_ALL;
            fi;
            if enc = fail and IsBound( env.LANG ) then
                enc := env.LANG;
            fi;
            if
             enc <> fail and (PositionSublist( enc, ".UTF-8" ) <> fail
                  or PositionSublist( enc, ".utf8" ) <> fail) then
                GAPInfo.TermEncoding := "UTF-8";
            fi;
            if not IsBound( GAPInfo.TermEncoding ) then
                GAPInfo.TermEncoding := "ISO-8859-1";
            fi;
        else
            GAPInfo.TermEncoding := GAPInfo.TermEncodingOverwrite;
        fi;
        MakeImmutable( GAPInfo.TermEncoding );
        return;
    end, function (  )
        local banner, msg, pair, excludedpackages, name, record;
        if IsBoundGlobal( "BANNER" ) then
            banner := ValueGlobal( "BANNER" );
            MakeReadWriteGlobal( "BANNER" );
            UnbindGlobal( "BANNER" );
        fi;
        BindGlobal( "BANNER", false );
        if GAPInfo.CommandLineOptions.L = "" then
            msg := "entering AutoloadPackages (no workspace)";
        else
            msg := Concatenation( "entering AutoloadPackages (workspace ", GAPInfo.CommandLineOptions.L
                , ")" );
        fi;
        LogPackageLoadingMessage( PACKAGE_DEBUG, msg, "GAP" );
        SetInfoLevel( InfoPackageLoading, UserPreference( "InfoPackageLoadingLevel" ) );
        GAPInfo.ExcludeFromAutoload := [  ];
        GAPInfo.PackagesInfoInitialized := false;
        InitializePackagesInfoRecords(  );
        GAPInfo.delayedImplementationParts := [  ];
        if ForAny( GAPInfo.Dependencies.NeededOtherPackages, function ( p )
                  return not IsBound( GAPInfo.PackagesLoaded.(p[1]) );
              end ) then
            LogPackageLoadingMessage( PACKAGE_DEBUG,
             Concatenation( [ "trying to load needed packages" ],
               List( GAPInfo.Dependencies.NeededOtherPackages, function ( pair )
                      return Concatenation( pair[1], " (", pair[2], ")" );
                  end ) ), "GAP" );
            if GAPInfo.CommandLineOptions.A then
                PushOptions( rec(
                    OnlyNeeded := true ) );
            fi;
            for pair in GAPInfo.Dependencies.NeededOtherPackages do
                if LoadPackage( pair[1], pair[2], false ) <> true then
                    LogPackageLoadingMessage( PACKAGE_ERROR, Concatenation( "needed package ",
                       pair[1], " cannot be loaded" ), "GAP" );
                    Error( "failed to load needed package `", pair[1], "' (version ", pair[2], ")" );
                fi;
            od;
            LogPackageLoadingMessage( PACKAGE_DEBUG, "needed packages loaded", "GAP" );
            if GAPInfo.CommandLineOptions.A then
                PopOptions(  );
            fi;
        fi;
        if not IsBound( GAPInfo.LibraryLoaded ) then
            LogPackageLoadingMessage( PACKAGE_DEBUG, [ "read the impl. part of the GAP library" ],
             "GAP" );
            ReadGapRoot( "lib/read.g" );
            GAPInfo.LibraryLoaded := true;
            GAPInfo.LoadPackageLevel := GAPInfo.LoadPackageLevel + 1;
            LoadPackage_ReadImplementationParts( GAPInfo.delayedImplementationParts, false );
            GAPInfo.LoadPackageLevel := GAPInfo.LoadPackageLevel - 1;
        fi;
        Unbind( GAPInfo.delayedImplementationParts );
        MakeReadWriteGlobal( "BANNER" );
        UnbindGlobal( "BANNER" );
        if IsBound( banner ) then
            BindGlobal( "BANNER", banner );
        fi;
        if GAPInfo.CommandLineOptions.A then
            LogPackageLoadingMessage( PACKAGE_DEBUG,
             "omitting packages suggested via \"PackagesToLoad\" (-A option)", "GAP" );
        elif ValueOption( "OnlyNeeded" ) = true then
            LogPackageLoadingMessage( PACKAGE_DEBUG,
             [ "omitting packages suggested via \"PackagesToLoad\"", " ('OnlyNeeded' option)" ], "GAP"
             );
        elif ForAny( List( UserPreference( "PackagesToLoad" ), LowercaseString ), function ( p )
                  return not IsBound( GAPInfo.PackagesLoaded.(p) );
              end ) then
            excludedpackages := List( UserPreference( "ExcludeFromAutoload" ), LowercaseString );
            LogPackageLoadingMessage( PACKAGE_DEBUG,
             Concatenation( [ "trying to load suggested packages" ], UserPreference( "PackagesToLoad"
                 ) ), "GAP" );
            for name in UserPreference( "PackagesToLoad" ) do
                if LowercaseString( name ) in excludedpackages then
                    LogPackageLoadingMessage( PACKAGE_DEBUG,
                     Concatenation( "excluded from autoloading: ", name ), "GAP" );
                elif not IsBound( GAPInfo.PackagesLoaded.(LowercaseString( name )) ) then
                    LogPackageLoadingMessage( PACKAGE_DEBUG,
                     Concatenation( "considering for autoloading: ", name ), "GAP" );
                    if LoadPackage( name, false ) <> true then
                        LogPackageLoadingMessage( PACKAGE_DEBUG, Concatenation( "suggested package ",
                           name, " cannot be loaded" ), "GAP" );
                    else
                        LogPackageLoadingMessage( PACKAGE_DEBUG, Concatenation( name, " loaded" ),
                         "GAP" );
                    fi;
                fi;
            od;
            LogPackageLoadingMessage( PACKAGE_DEBUG, "suggested packages loaded", "GAP" );
        fi;
        LogPackageLoadingMessage( PACKAGE_DEBUG,
         "call LoadPackageDocumentation for not loaded packages", "GAP" );
        for name in RecNames( GAPInfo.PackagesInfo ) do
            if not IsBound( GAPInfo.PackagesLoaded.(name) ) then
                record := First( GAPInfo.PackagesInfo.(name), IsRecord );
                if record <> fail then
                    LoadPackageDocumentation( record );
                fi;
            fi;
        od;
        LogPackageLoadingMessage( PACKAGE_DEBUG,
         "LoadPackageDocumentation for not loaded packages done", "GAP" );
        Unbind( GAPInfo.ExcludeFromAutoload );
        LogPackageLoadingMessage( PACKAGE_DEBUG, "return from AutoloadPackages", "GAP" );
        return;
    end, function (  )
        local xy;
        xy := [  ];
        if GAPInfo.CommandLineOptions.x <> "" then
            xy[1] := SMALLINT_STR( GAPInfo.CommandLineOptions.x );
        fi;
        if GAPInfo.CommandLineOptions.y <> "" then
            xy[2] := SMALLINT_STR( GAPInfo.CommandLineOptions.y );
        fi;
        if xy <> [  ] then
            SizeScreen( xy );
        fi;
        if GAPInfo.CommandLineOptions.g = 0 then
            SetGasmanMessageStatus( "none" );
        elif GAPInfo.CommandLineOptions.g = 1 then
            SetGasmanMessageStatus( "full" );
        else
            SetGasmanMessageStatus( "all" );
        fi;
        GAPInfo.ViewLength := UserPreference( "ViewLength" );
        ColorPrompt( UserPreference( "UseColorPrompt" ) );
        return;
    end, function (  )
        if not GAPInfo.CommandLineOptions.O and UserPreference( "ReadObsolete" ) <> false
            and not IsBound( GAPInfo.Read_obsolete_gi ) then
            ReadLib( "obsolete.gi" );
            GAPInfo.Read_obsolete_gi := true;
        fi;
        return;
    end, function (  )
        if UserPreference( "SaveAndRestoreHistory" ) = true then
            InstallAtExit( SaveCommandLineHistory );
            ReadCommandLineHistory(  );
        fi;
        return;
    end, function (  )
        if READ_GAP_ROOT( "gaprc" ) then
            GAPInfo.HasReadGAPRC := true;
        elif not IsExistingFile( GAPInfo.UserGapRoot ) then
            if not (GAPInfo.CommandLineOptions.r or GAPInfo.HasReadGAPRC) then
                if ARCH_IS_UNIX(  ) then
                    GAPInfo.gaprc := SHALLOW_COPY_OBJ( GAPInfo.UserHome );
                    if IsString( GAPInfo.gaprc ) then
                        APPEND_LIST_INTR( GAPInfo.gaprc, "/.gaprc" );
                    fi;
                else
                    GAPInfo.gaprc := "gap.rc";
                fi;
                if IsString( GAPInfo.gaprc ) and READ( GAPInfo.gaprc ) then
                    Info( InfoWarning, 1, "You are using an old ", GAPInfo.gaprc, " file. " );
                    Info( InfoWarning, 1, "See '?Ref: The former .gaprc file' for hints to upgrade." );
                    GAPInfo.HasReadGAPRC := true;
                fi;
            fi;
        fi;
        return;
    end, function (  )
        if not (GAPInfo.CommandLineOptions.q or GAPInfo.CommandLineOptions.b) then
            if GAPInfo.CommandLineOptions.L <> "" then
                ShowKernelInformation(  );
            fi;
            ShowPackageInformation(  );
        fi;
        return;
    end, function (  )
        local i, status;
        for i in [ 1 .. Length( GAPInfo.InitFiles ) ] do
            status := READ_NORECOVERY( GAPInfo.InitFiles[i] );
            if status = fail then
                PRINT_TO( "*errout*", "Reading file \"", GAPInfo.InitFiles[i],
                 "\" has been aborted.\n" );
                if i < Length( GAPInfo.InitFiles ) then
                    PRINT_TO( "*errout*",
                     "The remaining files on the command line will not be read.\n" );
                fi;
                break;
            elif status = false then
                PRINT_TO( "*errout*", "Could not read file \"", GAPInfo.InitFiles[i], "\".\n" );
            fi;
        od;
        return;
    end ]
```



---

archive/issue_comments_423397.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -15,14 +15,7 @@\n \n - Update a few doctests w.r.t. changes of output of some GAP functions\n \n-- **Possibly controversial:** The new libgap currently *does not come*\n-  with symbol rewriting (`foobar` -> `libGAP_foobar`). This avoids messing\n-  around with GAP's sources; in particular opening the door for using\n-  a stock GAP from the OS distribution. However there always is a risk\n-  of name conflict. And indeed, GAP's constants (actually cpp macros)\n-  T_INT, T_FLOAT, ... conflict with Python's constants. This is\n-  currently worked around by forcing the inclusion of Python's\n-  `structmember.h` before the gap headers.\n+- **Possibly controversial:** The new libgap currently 'does not come' with symbol rewriting (`foobar` -> `libGAP_foobar`). This avoids messing around with GAP's sources; in particular opening the door for using a stock GAP from the OS distribution. However there always is a risk of name conflicts. And indeed, GAP's enums `T_INT`, `T_FLOAT`, ... conflict with Python's constants defined in `structmember.h`. This is hopefully not actually a problem in practice due to the way how Cython orders includes.\n \n   Something similar was started by Volker at #19915.\n \n``````\n",
    "created_at": "2018-11-13T19:24:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423397",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -15,14 +15,7 @@
 
 - Update a few doctests w.r.t. changes of output of some GAP functions
 
-- **Possibly controversial:** The new libgap currently *does not come*
-  with symbol rewriting (`foobar` -> `libGAP_foobar`). This avoids messing
-  around with GAP's sources; in particular opening the door for using
-  a stock GAP from the OS distribution. However there always is a risk
-  of name conflict. And indeed, GAP's constants (actually cpp macros)
-  T_INT, T_FLOAT, ... conflict with Python's constants. This is
-  currently worked around by forcing the inclusion of Python's
-  `structmember.h` before the gap headers.
+- **Possibly controversial:** The new libgap currently 'does not come' with symbol rewriting (`foobar` -> `libGAP_foobar`). This avoids messing around with GAP's sources; in particular opening the door for using a stock GAP from the OS distribution. However there always is a risk of name conflicts. And indeed, GAP's enums `T_INT`, `T_FLOAT`, ... conflict with Python's constants defined in `structmember.h`. This is hopefully not actually a problem in practice due to the way how Cython orders includes.
 
   Something similar was started by Volker at #19915.
 
``````




---

archive/issue_comments_423398.json:
```json
{
    "body": "<a id='comment:204'></a>\nReplying to [embray](#comment%3A193):\n> I think the obvious one, at least broadly speaking, is just having a hook for what `Panic` actually *does*.\n\n\nThe obvious thing to do would be to treat this as any other error condition.",
    "created_at": "2018-11-13T19:26:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423398",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:204'></a>
Replying to [embray](#comment%3A193):
> I think the obvious one, at least broadly speaking, is just having a hook for what `Panic` actually *does*.


The obvious thing to do would be to treat this as any other error condition.



---

archive/issue_comments_423399.json:
```json
{
    "body": "<a id='comment:205'></a>\nReplying to [jdemeyer](#comment%3A204):\n> Replying to [embray](#comment%3A193):\n> > I think the obvious one, at least broadly speaking, is just having a hook for what `Panic` actually *does*.\n\n> \n> The obvious thing to do would be to treat this as any other error condition.\n\n\nYes, but I don't know that that's necessarily the right thing to do in the case of GAP.  Much of GAP's error handling code is actually written in the GAP language (in the error.g library), where as Panic() seems primarily reserved for cases where the GAP kernel cannot be guaranteed to work anymore, much handle errors correctly.\n\nA similar, but more subtle approach, would be to bypass most of the normal higher-level error-handling functionality, but still use `JUMP_TO_CATCH` to allow the error to be handled.  If the GAP interpreter process wants to just exit upon such errors it can do that in the appropriate `CATCH` handler.\n\nThat's probably still na\u00efve but I would bet it's closer to what they might have in mind to do.  Of course, we can always ask...",
    "created_at": "2018-11-14T11:35:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423399",
    "user": "https://github.com/embray"
}
```

<a id='comment:205'></a>
Replying to [jdemeyer](#comment%3A204):
> Replying to [embray](#comment%3A193):
> > I think the obvious one, at least broadly speaking, is just having a hook for what `Panic` actually *does*.

> 
> The obvious thing to do would be to treat this as any other error condition.


Yes, but I don't know that that's necessarily the right thing to do in the case of GAP.  Much of GAP's error handling code is actually written in the GAP language (in the error.g library), where as Panic() seems primarily reserved for cases where the GAP kernel cannot be guaranteed to work anymore, much handle errors correctly.

A similar, but more subtle approach, would be to bypass most of the normal higher-level error-handling functionality, but still use `JUMP_TO_CATCH` to allow the error to be handled.  If the GAP interpreter process wants to just exit upon such errors it can do that in the appropriate `CATCH` handler.

That's probably still na√Øve but I would bet it's closer to what they might have in mind to do.  Of course, we can always ask...



---

archive/issue_comments_423400.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -15,7 +15,14 @@\n \n - Update a few doctests w.r.t. changes of output of some GAP functions\n \n-- **Possibly controversial:** The new libgap currently 'does not come' with symbol rewriting (`foobar` -> `libGAP_foobar`). This avoids messing around with GAP's sources; in particular opening the door for using a stock GAP from the OS distribution. However there always is a risk of name conflicts. And indeed, GAP's enums `T_INT`, `T_FLOAT`, ... conflict with Python's constants defined in `structmember.h`. This is hopefully not actually a problem in practice due to the way how Cython orders includes.\n+- **Possibly controversial:** The new libgap currently *does not come*\n+  with symbol rewriting (`foobar` -> `libGAP_foobar`). This avoids messing\n+  around with GAP's sources; in particular opening the door for using\n+  a stock GAP from the OS distribution. However there always is a risk\n+  of name conflict. And indeed, GAP's constants (actually cpp macros)\n+  T_INT, T_FLOAT, ... conflict with Python's constants. This is\n+  currently worked around by forcing the inclusion of Python's\n+  `structmember.h` before the gap headers.\n \n   Something similar was started by Volker at #19915.\n \n``````\n",
    "created_at": "2018-11-14T13:26:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423400",
    "user": "https://github.com/embray"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -15,7 +15,14 @@
 
 - Update a few doctests w.r.t. changes of output of some GAP functions
 
-- **Possibly controversial:** The new libgap currently 'does not come' with symbol rewriting (`foobar` -> `libGAP_foobar`). This avoids messing around with GAP's sources; in particular opening the door for using a stock GAP from the OS distribution. However there always is a risk of name conflicts. And indeed, GAP's enums `T_INT`, `T_FLOAT`, ... conflict with Python's constants defined in `structmember.h`. This is hopefully not actually a problem in practice due to the way how Cython orders includes.
+- **Possibly controversial:** The new libgap currently *does not come*
+  with symbol rewriting (`foobar` -> `libGAP_foobar`). This avoids messing
+  around with GAP's sources; in particular opening the door for using
+  a stock GAP from the OS distribution. However there always is a risk
+  of name conflict. And indeed, GAP's constants (actually cpp macros)
+  T_INT, T_FLOAT, ... conflict with Python's constants. This is
+  currently worked around by forcing the inclusion of Python's
+  `structmember.h` before the gap headers.
 
   Something similar was started by Volker at #19915.
 
``````




---

archive/issue_comments_423401.json:
```json
{
    "body": "<a id='comment:6'></a>\nI was slightly barking up the wrong tree with the `PostRestoreFuncs`.  Turns out it's hanging right after that in the function called `SESSION`.  That's where it invokes that problematic `SHELL()` call:\n\n```\n 36 BIND_GLOBAL(\"SESSION\",\n 37     function()\n 38     local   prompt;\n 39\n 40     if GAPInfo.CommandLineOptions.q then\n 41         prompt := \"\";\n 42     else\n 43         prompt := \"gap> \";\n 44     fi;\n 45\n 46     SHELL( GetBottomLVars(), # in global context\n 47         false, # no return\n 48         false, # no return  obj\n 49         3,     # set last, last2 and last3 each command\n 50         true,  # set time after each command\n 51         prompt,\n 52         function()\n 53             if IsBound(OnGAPPromptHook) and IsFunction(OnGAPPromptHook) then\n 54                 OnGAPPromptHook();\n 55             else\n 56                 return;\n 57             fi;\n 58         end,\n 59         \"*stdin*\",\n 60         \"*stdout*\",\n 61         true);\n 62\n 63     BreakOnError := false;\n 64 end);\n```\n\nI'm still no exactly sure what this is for or why it causes libgap to hang in Sage.  But it seems we can avoid it by using the `--norepl` option.  What's strange is that `--nointeract` should imply `--norepl` but that doesn't appear to be working.  That *would* have been the case with the off-by-one error in `argc` that Dima pointed out.  But I fixed that and it didn't seem to help :/\n\nPerhaps this is simple...",
    "created_at": "2018-11-14T13:26:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423401",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>
I was slightly barking up the wrong tree with the `PostRestoreFuncs`.  Turns out it's hanging right after that in the function called `SESSION`.  That's where it invokes that problematic `SHELL()` call:

```
 36 BIND_GLOBAL("SESSION",
 37     function()
 38     local   prompt;
 39
 40     if GAPInfo.CommandLineOptions.q then
 41         prompt := "";
 42     else
 43         prompt := "gap> ";
 44     fi;
 45
 46     SHELL( GetBottomLVars(), # in global context
 47         false, # no return
 48         false, # no return  obj
 49         3,     # set last, last2 and last3 each command
 50         true,  # set time after each command
 51         prompt,
 52         function()
 53             if IsBound(OnGAPPromptHook) and IsFunction(OnGAPPromptHook) then
 54                 OnGAPPromptHook();
 55             else
 56                 return;
 57             fi;
 58         end,
 59         "*stdin*",
 60         "*stdout*",
 61         true);
 62
 63     BreakOnError := false;
 64 end);
```

I'm still no exactly sure what this is for or why it causes libgap to hang in Sage.  But it seems we can avoid it by using the `--norepl` option.  What's strange is that `--nointeract` should imply `--norepl` but that doesn't appear to be working.  That *would* have been the case with the off-by-one error in `argc` that Dima pointed out.  But I fixed that and it didn't seem to help :/

Perhaps this is simple...



---

archive/issue_comments_423402.json:
```json
{
    "body": "<a id='comment:7'></a>\nErik, please take care not the change the ticket description again... you accidentally reverted a chance that I made twice now.",
    "created_at": "2018-11-14T13:47:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423402",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>
Erik, please take care not the change the ticket description again... you accidentally reverted a chance that I made twice now.



---

archive/issue_comments_423403.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -15,14 +15,7 @@\n \n - Update a few doctests w.r.t. changes of output of some GAP functions\n \n-- **Possibly controversial:** The new libgap currently *does not come*\n-  with symbol rewriting (`foobar` -> `libGAP_foobar`). This avoids messing\n-  around with GAP's sources; in particular opening the door for using\n-  a stock GAP from the OS distribution. However there always is a risk\n-  of name conflict. And indeed, GAP's constants (actually cpp macros)\n-  T_INT, T_FLOAT, ... conflict with Python's constants. This is\n-  currently worked around by forcing the inclusion of Python's\n-  `structmember.h` before the gap headers.\n+- - **Possibly controversial:** The new libgap currently 'does not come' with symbol rewriting (`foobar` -> `libGAP_foobar`). This avoids messing around with GAP's sources; in particular opening the door for using a stock GAP from the OS distribution. However there always is a risk of name conflicts. And indeed, GAP's enums `T_INT`, `T_FLOAT`, ... conflict with Python's constants defined in `structmember.h`. This is hopefully not actually a problem in practice due to the way how Cython orders includes.\n \n   Something similar was started by Volker at #19915.\n \n``````\n",
    "created_at": "2018-11-14T13:47:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423403",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -15,14 +15,7 @@
 
 - Update a few doctests w.r.t. changes of output of some GAP functions
 
-- **Possibly controversial:** The new libgap currently *does not come*
-  with symbol rewriting (`foobar` -> `libGAP_foobar`). This avoids messing
-  around with GAP's sources; in particular opening the door for using
-  a stock GAP from the OS distribution. However there always is a risk
-  of name conflict. And indeed, GAP's constants (actually cpp macros)
-  T_INT, T_FLOAT, ... conflict with Python's constants. This is
-  currently worked around by forcing the inclusion of Python's
-  `structmember.h` before the gap headers.
+- - **Possibly controversial:** The new libgap currently 'does not come' with symbol rewriting (`foobar` -> `libGAP_foobar`). This avoids messing around with GAP's sources; in particular opening the door for using a stock GAP from the OS distribution. However there always is a risk of name conflicts. And indeed, GAP's enums `T_INT`, `T_FLOAT`, ... conflict with Python's constants defined in `structmember.h`. This is hopefully not actually a problem in practice due to the way how Cython orders includes.
 
   Something similar was started by Volker at #19915.
 
``````




---

archive/issue_comments_423404.json:
```json
{
    "body": "<a id='comment:8'></a>\nThis is basically the issue that was reported in https://github.com/gap-system/gap/pull/2840/files, but it appears to still be broken in some way if I load an existing workspace.  The `--nointeract` and/or `--norepl` options get clobbered.",
    "created_at": "2018-11-14T14:00:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423404",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>
This is basically the issue that was reported in https://github.com/gap-system/gap/pull/2840/files, but it appears to still be broken in some way if I load an existing workspace.  The `--nointeract` and/or `--norepl` options get clobbered.



---

archive/issue_comments_423405.json:
```json
{
    "body": "<a id='comment:9'></a>\nSorry. Dangers of using an outdated platform.",
    "created_at": "2018-11-14T14:00:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423405",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>
Sorry. Dangers of using an outdated platform.



---

archive/issue_comments_423406.json:
```json
{
    "body": "<a id='comment:210'></a>\nReplying to [embray](#comment%3A208):\n> This is basically the issue that was reported in https://github.com/gap-system/gap/pull/2840/files, but it appears to still be broken in some way if I load an existing workspace.  The `--nointeract` and/or `--norepl` options get clobbered.\n\n\nI realized somewhat too late that although this PR was merged well before 4.10.0 was released, that fix was never included in the release.  So either we wait for 4.10.1 (and see if we can ensure that this fix is included) or we patch it, or work around it somehow.  I'm looking into maybe using a gaprc file to hack around it, but I don't have high hopes for that...",
    "created_at": "2018-11-14T14:48:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423406",
    "user": "https://github.com/embray"
}
```

<a id='comment:210'></a>
Replying to [embray](#comment%3A208):
> This is basically the issue that was reported in https://github.com/gap-system/gap/pull/2840/files, but it appears to still be broken in some way if I load an existing workspace.  The `--nointeract` and/or `--norepl` options get clobbered.


I realized somewhat too late that although this PR was merged well before 4.10.0 was released, that fix was never included in the release.  So either we wait for 4.10.1 (and see if we can ensure that this fix is included) or we patch it, or work around it somehow.  I'm looking into maybe using a gaprc file to hack around it, but I don't have high hopes for that...



---

archive/issue_comments_423407.json:
```json
{
    "body": "<a id='comment:1'></a>\nOk.  Putting the following `gaprc` in GAP_ROOT works around it:\n\n```\nif GAPInfo.CommandLineOptions.norepl then\n    # GAP 4.10.0 has a bug that an interactive session will be started\n    # even if --norepl was set; see https://github.com/gap-system/gap/pull/2840\n    # To work around this we redefine the SESSION function to a no-op\n    MAKE_READ_WRITE_GLOBAL(\"SESSION\");\n    UNBIND_GLOBAL(\"SESSION\");\n    BIND_GLOBAL(\"SESSION\", function() end);\nfi;\n```\n\nmy one concern is that if there is a gaprc in the `UserGapRoot` this will be ignored.  I'm not 100% sure if that's the way it works or not.  Need to double-check.",
    "created_at": "2018-11-14T14:57:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423407",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>
Ok.  Putting the following `gaprc` in GAP_ROOT works around it:

```
if GAPInfo.CommandLineOptions.norepl then
    # GAP 4.10.0 has a bug that an interactive session will be started
    # even if --norepl was set; see https://github.com/gap-system/gap/pull/2840
    # To work around this we redefine the SESSION function to a no-op
    MAKE_READ_WRITE_GLOBAL("SESSION");
    UNBIND_GLOBAL("SESSION");
    BIND_GLOBAL("SESSION", function() end);
fi;
```

my one concern is that if there is a gaprc in the `UserGapRoot` this will be ignored.  I'm not 100% sure if that's the way it works or not.  Need to double-check.



---

archive/issue_comments_423408.json:
```json
{
    "body": "<a id='comment:212'></a>\nReplying to [embray](#comment%3A211):\n> my one concern is that if there is a gaprc in the `UserGapRoot` this will be ignored.  I'm not 100% sure if that's the way it works or not.  Need to double-check.\n\n\nYes.  That does appear to be a problem...  Another option might be to install this via a gap.ini, but that would theoretically have the same problem I think.",
    "created_at": "2018-11-14T15:03:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423408",
    "user": "https://github.com/embray"
}
```

<a id='comment:212'></a>
Replying to [embray](#comment%3A211):
> my one concern is that if there is a gaprc in the `UserGapRoot` this will be ignored.  I'm not 100% sure if that's the way it works or not.  Need to double-check.


Yes.  That does appear to be a problem...  Another option might be to install this via a gap.ini, but that would theoretically have the same problem I think.



---

archive/issue_comments_423409.json:
```json
{
    "body": "<a id='comment:3'></a>\nA third possibility, which may be good enough for Sage's case, would be to install a pre-configured \"default workspace\" that includes this fix, and just always load that workspace if no other is found.",
    "created_at": "2018-11-14T15:06:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423409",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>
A third possibility, which may be good enough for Sage's case, would be to install a pre-configured "default workspace" that includes this fix, and just always load that workspace if no other is found.



---

archive/issue_comments_423410.json:
```json
{
    "body": "<a id='comment:4'></a>\nAh, best of all (I feel like I discovered this once a long time ago too): If we just pass a filename argument to libgap's init it will read that filename too, after everything else.  This happens during the `PostRestoreFuncs` processing so it's still early enough, before the session is initialized.\n\nTherefore for Sage's libgap initialization we can include a file with any number of patches to GAP.",
    "created_at": "2018-11-14T15:17:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423410",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>
Ah, best of all (I feel like I discovered this once a long time ago too): If we just pass a filename argument to libgap's init it will read that filename too, after everything else.  This happens during the `PostRestoreFuncs` processing so it's still early enough, before the session is initialized.

Therefore for Sage's libgap initialization we can include a file with any number of patches to GAP.



---

archive/issue_comments_423411.json:
```json
{
    "body": "<a id='comment:5'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/28535a52645850308cec4aa33eca7708ea2fb46d\">28535a5</a></td><td><code>remove (apparently?) superfluous gap_eval</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/97be615867eb9f806bae4b99a399f37568b14a62\">97be615</a></td><td><code>when a statement in libgap.eval returns NULL, just return Python's None instead; makes for empty output to the command prompt</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2b7bdcd08ff10c026263acba7b691f4e8baf5b99\">2b7bdcd</a></td><td><code>Use ELM_PLIST directly instead of ELM_LIST when processing GAP_EvalString</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ed8fc3058db547b2af7ab1e72e468a60aa92895c\">ed8fc30</a></td><td><code>install a special file called sage.gaprc that is read at the end of libgap</code></td></tr></table>\n",
    "created_at": "2018-11-14T15:40:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423411",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/28535a52645850308cec4aa33eca7708ea2fb46d">28535a5</a></td><td><code>remove (apparently?) superfluous gap_eval</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/97be615867eb9f806bae4b99a399f37568b14a62">97be615</a></td><td><code>when a statement in libgap.eval returns NULL, just return Python's None instead; makes for empty output to the command prompt</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2b7bdcd08ff10c026263acba7b691f4e8baf5b99">2b7bdcd</a></td><td><code>Use ELM_PLIST directly instead of ELM_LIST when processing GAP_EvalString</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ed8fc3058db547b2af7ab1e72e468a60aa92895c">ed8fc30</a></td><td><code>install a special file called sage.gaprc that is read at the end of libgap</code></td></tr></table>




---

archive/issue_comments_423412.json:
```json
{
    "body": "**Changing commit** from \"[30d1f7fa95fcc9855077c5ed6587748eed1a4cce](https://github.com/sagemath/sagetrac-mirror/commit/30d1f7fa95fcc9855077c5ed6587748eed1a4cce)\" to \"[ed8fc3058db547b2af7ab1e72e468a60aa92895c](https://github.com/sagemath/sagetrac-mirror/commit/ed8fc3058db547b2af7ab1e72e468a60aa92895c)\".",
    "created_at": "2018-11-14T15:40:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423412",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[30d1f7fa95fcc9855077c5ed6587748eed1a4cce](https://github.com/sagemath/sagetrac-mirror/commit/30d1f7fa95fcc9855077c5ed6587748eed1a4cce)" to "[ed8fc3058db547b2af7ab1e72e468a60aa92895c](https://github.com/sagemath/sagetrac-mirror/commit/ed8fc3058db547b2af7ab1e72e468a60aa92895c)".



---

archive/issue_comments_423413.json:
```json
{
    "body": "<a id='comment:6'></a>\n!^ An attempt at a fix.  Seems to work, and I'm pretty happy with the approach.",
    "created_at": "2018-11-14T15:40:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423413",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>
!^ An attempt at a fix.  Seems to work, and I'm pretty happy with the approach.



---

archive/issue_comments_423414.json:
```json
{
    "body": "<a id='comment:217'></a>\nReplying to [embray](#comment%3A214):\n> Ah, best of all (I feel like I discovered this once a long time ago too): If we just pass a filename argument to libgap's init it will read that filename too, after everything else.  This happens during the `PostRestoreFuncs` processing so it's still early enough, before the session is initialized.\n> \n> Therefore for Sage's libgap initialization we can include a file with any number of patches to GAP.\n\n\nI see now that the pexpect interface does something similar with `sage.g`.  It just lives in `SAGE_EXTCODE` rather than being installed in the package itself (I obviously prefer the latter).  For libgap we probably shouldn't need most of the stuff in `sage.g` but I'm not sure.",
    "created_at": "2018-11-14T16:39:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423414",
    "user": "https://github.com/embray"
}
```

<a id='comment:217'></a>
Replying to [embray](#comment%3A214):
> Ah, best of all (I feel like I discovered this once a long time ago too): If we just pass a filename argument to libgap's init it will read that filename too, after everything else.  This happens during the `PostRestoreFuncs` processing so it's still early enough, before the session is initialized.
> 
> Therefore for Sage's libgap initialization we can include a file with any number of patches to GAP.


I see now that the pexpect interface does something similar with `sage.g`.  It just lives in `SAGE_EXTCODE` rather than being installed in the package itself (I obviously prefer the latter).  For libgap we probably shouldn't need most of the stuff in `sage.g` but I'm not sure.



---

archive/issue_comments_423415.json:
```json
{
    "body": "**Changing commit** from \"[ed8fc3058db547b2af7ab1e72e468a60aa92895c](https://github.com/sagemath/sagetrac-mirror/commit/ed8fc3058db547b2af7ab1e72e468a60aa92895c)\" to \"[f3a909cdec30f70891b515fed05c53072fdfec09](https://github.com/sagemath/sagetrac-mirror/commit/f3a909cdec30f70891b515fed05c53072fdfec09)\".",
    "created_at": "2018-11-14T16:50:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423415",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[ed8fc3058db547b2af7ab1e72e468a60aa92895c](https://github.com/sagemath/sagetrac-mirror/commit/ed8fc3058db547b2af7ab1e72e468a60aa92895c)" to "[f3a909cdec30f70891b515fed05c53072fdfec09](https://github.com/sagemath/sagetrac-mirror/commit/f3a909cdec30f70891b515fed05c53072fdfec09)".



---

archive/issue_comments_423416.json:
```json
{
    "body": "<a id='comment:8'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f3a909cdec30f70891b515fed05c53072fdfec09\">f3a909c</a></td><td><code>different way of repr-ing a GAP element more consistent with the previous method</code></td></tr></table>\n",
    "created_at": "2018-11-14T16:50:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423416",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f3a909cdec30f70891b515fed05c53072fdfec09">f3a909c</a></td><td><code>different way of repr-ing a GAP element more consistent with the previous method</code></td></tr></table>




---

archive/issue_comments_423417.json:
```json
{
    "body": "<a id='comment:9'></a>\nIt appears that next we need to focus on the GAP pexpect interface, which is also broken.  It just hangs as soon as you try to do anything :(",
    "created_at": "2018-11-14T16:51:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423417",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>
It appears that next we need to focus on the GAP pexpect interface, which is also broken.  It just hangs as soon as you try to do anything :(



---

archive/issue_comments_423418.json:
```json
{
    "body": "<a id='comment:220'></a>\nReplying to [embray](#comment%3A219):\n> It appears that next we need to focus on the GAP pexpect interface, which is also broken.  It just hangs as soon as you try to do anything :(\n\n\nIt appears to get lost in `gap_reset_workspace` while loading the packages 'sonata' and 'guava'.  It doesn't run into problems with other packages.  So there are two problems:\n\n1) The fact that something is broken when loading those packages\n\n2) The fact that Sage's pexpect parser for GAP seems to go into an infinite loop upon those error conditions (it even prints \"Warning: this should never happen\"--so whatever \"this\" is apparently *can* happen, and the parser does not behave well when it does.",
    "created_at": "2018-11-14T17:10:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423418",
    "user": "https://github.com/embray"
}
```

<a id='comment:220'></a>
Replying to [embray](#comment%3A219):
> It appears that next we need to focus on the GAP pexpect interface, which is also broken.  It just hangs as soon as you try to do anything :(


It appears to get lost in `gap_reset_workspace` while loading the packages 'sonata' and 'guava'.  It doesn't run into problems with other packages.  So there are two problems:

1) The fact that something is broken when loading those packages

2) The fact that Sage's pexpect parser for GAP seems to go into an infinite loop upon those error conditions (it even prints "Warning: this should never happen"--so whatever "this" is apparently *can* happen, and the parser does not behave well when it does.



---

archive/issue_comments_423419.json:
```json
{
    "body": "<a id='comment:1'></a>\nLooking at this ticket. Of course it became very long and I can't get an overview of all thread, but some comments while scrolling through it:\n\n1) There is a smaller archive https://www.gap-system.org/pub/gap/gap4core/gap-4.10.0-core.zip of the core GAP system and four _required_ packages, if it helps to reduce the bandwidth. You can then get matching package archive from https://www.gap-system.org/pub/gap/gap4pkgs/ (ask me which). Also, may be helpful to reduce interaction with packages\n\n2) From doc/dev - `PostRestoreFunctions` are called after a workspace has been loaded to finish linking up the kernel and workspace. Some of those from `GAPInfo.PostRestoreFunctions` may be added by packages (GAPDoc, GRAPE).\n\n3) Did you get it to work without the workspace already?\n\n4) \"A lot of the test suites under tst/ seem to work, or mostly work\" - the word \"mostly\" sounds alarming. see e.g. https://travis-ci.org/gap-system/gap-docker-stable-4.10-testsuite - everything should work there.\n\n5) `doc` directory of GAP - of course, please include it. Allow the user to use it from GAP command line via `?<search_term>` mechanism. \n\nAll from me for now!",
    "created_at": "2018-11-14T18:50:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423419",
    "user": "https://trac.sagemath.org/admin/accounts/users/alexk"
}
```

<a id='comment:1'></a>
Looking at this ticket. Of course it became very long and I can't get an overview of all thread, but some comments while scrolling through it:

1) There is a smaller archive https://www.gap-system.org/pub/gap/gap4core/gap-4.10.0-core.zip of the core GAP system and four _required_ packages, if it helps to reduce the bandwidth. You can then get matching package archive from https://www.gap-system.org/pub/gap/gap4pkgs/ (ask me which). Also, may be helpful to reduce interaction with packages

2) From doc/dev - `PostRestoreFunctions` are called after a workspace has been loaded to finish linking up the kernel and workspace. Some of those from `GAPInfo.PostRestoreFunctions` may be added by packages (GAPDoc, GRAPE).

3) Did you get it to work without the workspace already?

4) "A lot of the test suites under tst/ seem to work, or mostly work" - the word "mostly" sounds alarming. see e.g. https://travis-ci.org/gap-system/gap-docker-stable-4.10-testsuite - everything should work there.

5) `doc` directory of GAP - of course, please include it. Allow the user to use it from GAP command line via `?<search_term>` mechanism. 

All from me for now!



---

archive/issue_comments_423420.json:
```json
{
    "body": "<a id='comment:2'></a>\nTry to load GUAVA and SONATA in GAP session and check their output:\n\n```\ngap> LoadPackage(\"sonata\");\n#I  You may wish to install the xgap package\n#I  and enjoy the graphic capabilities of SONATA.\n\n  ___________________________________________________________________________\n /        ___\n||       /   \\                 /\\    Version 2.9.1\n||      ||   ||  |\\    |      /  \\               /\\       Erhard Aichinger\n \\___   ||   ||  |\\\\   |     /____\\_____________/__\\      Franz Binder\n     \\  ||   ||  | \\\\  |    /      \\     ||    /    \\     Juergen Ecker\n     ||  \\___/   |  \\\\ |   /        \\    ||   /      \\    Peter Mayr\n     ||          |   \\\\|  /          \\   ||               Christof Noebauer\n \\___/           |    \\|                 ||\n\n System    Of   Nearrings     And      Their Applications\n Info: https://gap-packages.github.io/sonata/\n\ntrue\ngap> LoadPackage(\"guava\");\n\n   ____                          |\n  /            \\           /   --+--  Version 3.14\n /      |    | |\\\\        //|    |\n|    _  |    | | \\\\      // |     the GUAVA Group\n|     \\ |    | |--\\\\    //--|     \n \\     ||    | |   \\\\  //   |     \n  \\___/  \\___/ |    \\\\//    |      \n                                  \n\ntrue\ngap>\n```\nYou may want to use the 2nd argument to disable their banners:\n\n```\ngap> LoadPackage(\"sonata\",false);\n#I  You may wish to install the xgap package\n#I  and enjoy the graphic capabilities of SONATA.\ntrue\ngap> LoadPackage(\"guava\",false);\ntrue\ngap> \n```",
    "created_at": "2018-11-14T18:53:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423420",
    "user": "https://trac.sagemath.org/admin/accounts/users/alexk"
}
```

<a id='comment:2'></a>
Try to load GUAVA and SONATA in GAP session and check their output:

```
gap> LoadPackage("sonata");
#I  You may wish to install the xgap package
#I  and enjoy the graphic capabilities of SONATA.

  ___________________________________________________________________________
 /        ___
||       /   \                 /\    Version 2.9.1
||      ||   ||  |\    |      /  \               /\       Erhard Aichinger
 \___   ||   ||  |\\   |     /____\_____________/__\      Franz Binder
     \  ||   ||  | \\  |    /      \     ||    /    \     Juergen Ecker
     ||  \___/   |  \\ |   /        \    ||   /      \    Peter Mayr
     ||          |   \\|  /          \   ||               Christof Noebauer
 \___/           |    \|                 ||

 System    Of   Nearrings     And      Their Applications
 Info: https://gap-packages.github.io/sonata/

true
gap> LoadPackage("guava");

   ____                          |
  /            \           /   --+--  Version 3.14
 /      |    | |\\        //|    |
|    _  |    | | \\      // |     the GUAVA Group
|     \ |    | |--\\    //--|     
 \     ||    | |   \\  //   |     
  \___/  \___/ |    \\//    |      
                                  

true
gap>
```
You may want to use the 2nd argument to disable their banners:

```
gap> LoadPackage("sonata",false);
#I  You may wish to install the xgap package
#I  and enjoy the graphic capabilities of SONATA.
true
gap> LoadPackage("guava",false);
true
gap> 
```



---

archive/issue_comments_423421.json:
```json
{
    "body": "<a id='comment:223'></a>\nReplying to [alexk](#comment%3A221):\n> Looking at this ticket. Of course it became very long and I can't get an overview of all thread, but some comments while scrolling through it:\n\n\nYes, sorry for the length.  We are just taking notes here as we go I think.  Some point soon I will make a summary progress report and link to it in the description, perhaps giving some indication as to where to skip to in the comments.",
    "created_at": "2018-11-15T11:57:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423421",
    "user": "https://github.com/embray"
}
```

<a id='comment:223'></a>
Replying to [alexk](#comment%3A221):
> Looking at this ticket. Of course it became very long and I can't get an overview of all thread, but some comments while scrolling through it:


Yes, sorry for the length.  We are just taking notes here as we go I think.  Some point soon I will make a summary progress report and link to it in the description, perhaps giving some indication as to where to skip to in the comments.



---

archive/issue_comments_423422.json:
```json
{
    "body": "<a id='comment:224'></a>\nReplying to [alexk](#comment%3A222):\n> Try to load GUAVA and SONATA in GAP session and check their output:\n\n\nIt works normally, but when I run gap with the `-p` flag (\"enable/disable package output mode\") it hangs like:\n\n```\n@p1.@n \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510@n   GAP 4.10.0 of 01-Nov-2018@J@n \u2502  GAP  \u2502   https://www.gap-system.org@J@n \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518@n   Architecture: x86_64-pc-linux-gnu-default64@J@n Configuration:  gmp 6.0.0@n@J@n Loading the library @nand packages ...@J@!968002+@\"06191+@#378371+@$19131+@%13743+@&63556+@!90963+@\"6494+@#15447+@$0255+@%45192+@&63556+@!47803+@\"4843+@#72844+@$0625+@%03152+@&63556+@!63803+@\"1393+@#19753+@$8863+@%17602+@&63556+@!03712+@\"6513+@#27151+@$3431+@%03171+@&63556+@!75471+@\"1752+@#44851+@$1441+@%75241+@&63556+@!85661+@\"6242+@#31881+@$0691+@%54511+@&63556+@!52121+@\"3761+@#3368+@$687+@%1669+@&63556+@!48091+@\"5051+@#45203+@$7951+@%1287+@&63556+@!18252+@\"6241+@#42751+@$3632+@%6495+@&63556+@!5723+@\"464+@#77637+@$1581+@%2345+@&63556+@!365+@\"93+@#242821+@$4492+@%4735+@&63556+@n Packages:   GAPDoc 1.6.2@n, PrimGrp 3.3.2@n, SmallGrp 1.3@n, TransGrp 2.0.4@n@J@n Try '??help' for help. See also '?copyright', '?cite' and '?authors'@J@ngap> @iLoadPackage(\"sonata\");\nLoadPackage(\"sonata\");\n@rLoadPackage(\"sonata\");@J@w3+XCN\n```\n\nI don't fully understand what `-p` means or what all the output above is, though I know that Sage's pexect interface to GAP uses this debug output extensively to understand what's going on.  \n\nSame if I do `LoadPackage(\"sonata\", false)`, so at least it has nothing to do with the banner??\n\nIf I press enter a few times while it's hanging (or really any other input) it eventually outputs\n\n```\n@fError, @fwindow system: @fIllegal Answer@f at /home/embray/src/sagemath/sage/local/share/gap/pkg/xgap-4.28/lib/color.gi:160@f called from@f@J@f<function \"CreateColors\">( <arguments> )@J@f called from read-eval loop @fat /home/embray/src/sagemath/sage/local/share/gap/pkg/xgap-4.28/lib/color.gi:220@J@nyou can 'quit;' to quit to outer loop, or@J@nyou can 'return;' to continue@J@fbrk> @e\n\n@r@J@fbrk> @e\n```",
    "created_at": "2018-11-15T12:26:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423422",
    "user": "https://github.com/embray"
}
```

<a id='comment:224'></a>
Replying to [alexk](#comment%3A222):
> Try to load GUAVA and SONATA in GAP session and check their output:


It works normally, but when I run gap with the `-p` flag ("enable/disable package output mode") it hangs like:

```
@p1.@n ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê@n   GAP 4.10.0 of 01-Nov-2018@J@n ‚îÇ  GAP  ‚îÇ   https://www.gap-system.org@J@n ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò@n   Architecture: x86_64-pc-linux-gnu-default64@J@n Configuration:  gmp 6.0.0@n@J@n Loading the library @nand packages ...@J@!968002+@"06191+@#378371+@$19131+@%13743+@&63556+@!90963+@"6494+@#15447+@$0255+@%45192+@&63556+@!47803+@"4843+@#72844+@$0625+@%03152+@&63556+@!63803+@"1393+@#19753+@$8863+@%17602+@&63556+@!03712+@"6513+@#27151+@$3431+@%03171+@&63556+@!75471+@"1752+@#44851+@$1441+@%75241+@&63556+@!85661+@"6242+@#31881+@$0691+@%54511+@&63556+@!52121+@"3761+@#3368+@$687+@%1669+@&63556+@!48091+@"5051+@#45203+@$7951+@%1287+@&63556+@!18252+@"6241+@#42751+@$3632+@%6495+@&63556+@!5723+@"464+@#77637+@$1581+@%2345+@&63556+@!365+@"93+@#242821+@$4492+@%4735+@&63556+@n Packages:   GAPDoc 1.6.2@n, PrimGrp 3.3.2@n, SmallGrp 1.3@n, TransGrp 2.0.4@n@J@n Try '??help' for help. See also '?copyright', '?cite' and '?authors'@J@ngap> @iLoadPackage("sonata");
LoadPackage("sonata");
@rLoadPackage("sonata");@J@w3+XCN
```

I don't fully understand what `-p` means or what all the output above is, though I know that Sage's pexect interface to GAP uses this debug output extensively to understand what's going on.  

Same if I do `LoadPackage("sonata", false)`, so at least it has nothing to do with the banner??

If I press enter a few times while it's hanging (or really any other input) it eventually outputs

```
@fError, @fwindow system: @fIllegal Answer@f at /home/embray/src/sagemath/sage/local/share/gap/pkg/xgap-4.28/lib/color.gi:160@f called from@f@J@f<function "CreateColors">( <arguments> )@J@f called from read-eval loop @fat /home/embray/src/sagemath/sage/local/share/gap/pkg/xgap-4.28/lib/color.gi:220@J@nyou can 'quit;' to quit to outer loop, or@J@nyou can 'return;' to continue@J@fbrk> @e

@r@J@fbrk> @e
```



---

archive/issue_comments_423423.json:
```json
{
    "body": "<a id='comment:5'></a>\nI see now--`-p` is really intended for use by xgap and the like; it also just happens to be taken advantage of for Sage's pexpect interface as well (not unreasonably).  This makes me wonder though why a couple of packages would stall out in this case.  I hope it's not actually trying to talk to an X server...",
    "created_at": "2018-11-15T12:37:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423423",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>
I see now--`-p` is really intended for use by xgap and the like; it also just happens to be taken advantage of for Sage's pexpect interface as well (not unreasonably).  This makes me wonder though why a couple of packages would stall out in this case.  I hope it's not actually trying to talk to an X server...



---

archive/issue_comments_423424.json:
```json
{
    "body": "<a id='comment:6'></a>\nWe need some way, when starting GAP for Sage's pexpect interface, to force \"no, xgap is really not available\"",
    "created_at": "2018-11-15T13:03:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423424",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>
We need some way, when starting GAP for Sage's pexpect interface, to force "no, xgap is really not available"



---

archive/issue_comments_423425.json:
```json
{
    "body": "<a id='comment:7'></a>\nNote that we are installing GAP with the patch\n\n```\n--- a/lib/package.gi    2016-11-12 14:25:15.000000000 +0000\n+++ b/lib/package.gi    2017-01-23 22:45:39.737377900 +0000\n@@ -1743,9 +1743,7 @@\n For backwards compatibility, the default lists most of packages \\\n that were autoloaded in GAP 4.4 (add or remove packages as you like).\"\n     ],\n-  default:= [ \"autpgrp\", \"alnuth\", \"crisp\", \"ctbllib\", \"factint\", \"fga\", \n-              \"irredsol\", \"laguna\", \"polenta\", \"polycyclic\", \"resclasses\", \n-              \"sophus\", \"tomlib\" ],\n+  default:= [],\n   values:= function() return RecNames( GAPInfo.PackagesInfo ); end,\n   multi:= true,\n   ) );\n```\n\nPerhaps it has become somewhat outdated in GAP 4.10.",
    "created_at": "2018-11-15T13:09:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423425",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:7'></a>
Note that we are installing GAP with the patch

```
--- a/lib/package.gi    2016-11-12 14:25:15.000000000 +0000
+++ b/lib/package.gi    2017-01-23 22:45:39.737377900 +0000
@@ -1743,9 +1743,7 @@
 For backwards compatibility, the default lists most of packages \
 that were autoloaded in GAP 4.4 (add or remove packages as you like)."
     ],
-  default:= [ "autpgrp", "alnuth", "crisp", "ctbllib", "factint", "fga", 
-              "irredsol", "laguna", "polenta", "polycyclic", "resclasses", 
-              "sophus", "tomlib" ],
+  default:= [],
   values:= function() return RecNames( GAPInfo.PackagesInfo ); end,
   multi:= true,
   ) );
```

Perhaps it has become somewhat outdated in GAP 4.10.



---

archive/issue_comments_423426.json:
```json
{
    "body": "<a id='comment:228'></a>\nReplying to [embray](#comment%3A226):\n> We need some way, when starting GAP for Sage's pexpect interface, to force \"no, xgap is really not available\"\n\n\nFWIW we (Arch) faced a similar issue some time ago:\n\nhttps://bugs.archlinux.org/task/55174\n\nMy \"fix\" was to patch out loading xgap from sonata/PackageInfo.g",
    "created_at": "2018-11-15T13:13:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423426",
    "user": "https://github.com/antonio-rojas"
}
```

<a id='comment:228'></a>
Replying to [embray](#comment%3A226):
> We need some way, when starting GAP for Sage's pexpect interface, to force "no, xgap is really not available"


FWIW we (Arch) faced a similar issue some time ago:

https://bugs.archlinux.org/task/55174

My "fix" was to patch out loading xgap from sonata/PackageInfo.g



---

archive/issue_comments_423427.json:
```json
{
    "body": "<a id='comment:9'></a>\nI've noticed that after installing this branch I still have `gap` in `SAGE_LOCAL/bin` pointing at the wrong location of GAP executable.\n\nIn fact, I also get `gap-bin` in `SAGE_LOCAL/bin`, and by right, `gap` should be a link\nto the latter. \n\nCorrection - one should change the script to point to the right GAP_DIR too, it seems...\n\n```\n#!/bin/sh\nGAP_DIR=$SAGE_LOCAL/gap/latest\nGAP_EXE=$GAP_DIR\nexec \"$GAP_EXE/gap\" -l \"$GAP_DIR\" \"$@\"\n```\n\nIt seems that spkg-install should remove the whole `SAGE_LOCAL/gap/` to make sure to stale copies of GAP are used after the update.",
    "created_at": "2018-11-15T13:30:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423427",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:9'></a>
I've noticed that after installing this branch I still have `gap` in `SAGE_LOCAL/bin` pointing at the wrong location of GAP executable.

In fact, I also get `gap-bin` in `SAGE_LOCAL/bin`, and by right, `gap` should be a link
to the latter. 

Correction - one should change the script to point to the right GAP_DIR too, it seems...

```
#!/bin/sh
GAP_DIR=$SAGE_LOCAL/gap/latest
GAP_EXE=$GAP_DIR
exec "$GAP_EXE/gap" -l "$GAP_DIR" "$@"
```

It seems that spkg-install should remove the whole `SAGE_LOCAL/gap/` to make sure to stale copies of GAP are used after the update.



---

archive/issue_comments_423428.json:
```json
{
    "body": "<a id='comment:230'></a>\nReplying to [arojas](#comment%3A228):\n> Replying to [embray](#comment%3A226):\n> > We need some way, when starting GAP for Sage's pexpect interface, to force \"no, xgap is really not available\"\n\n> \n> FWIW we (Arch) faced a similar issue some time ago:\n> \n> https://bugs.archlinux.org/task/55174\n> \n> My \"fix\" was to patch out loading xgap from sonata/PackageInfo.g\n\n\nMy solution is to add the following to `sage.g`: \n\n```diff\ndiff --git a/src/ext/gap/sage.g b/src/ext/gap/sage.g\nindex 2a4ce13..dafb003 100644\n--- a/src/ext/gap/sage.g\n+++ b/src/ext/gap/sage.g\n@@ -1,7 +1,22 @@\n-\n #\n # SAGE support utilities to read into the GAP session.\n #\n+\n+# Prevent loading the xgap package; we use the -p flag to GAP in order to\n+# communicate with it via the pexpect interface; this is normally used by\n+# for an xgap window to communicate with GAP, so unfortunatelly setting this\n+# flag also allows the xgap package to be loaded and for some packages to\n+# attempt to communicate with a \"window handler\" that doesn't exist.\n+# Therefore we must explicitly disable loading of the xgap package.\n+\n+# Don't use SetUserPreference since that leads to reloading the workspace,\n+# which confusing the pexpect interface\n+if IsBound(GAPInfo.ExcludeFromAutoload) then\n+    Append(GAPInfo.ExcludeFromAutoload, \"xgap\");\n+else\n+    GAPInfo.ExcludeFromAutoload := [ \"xgap\" ];\n+fi;\n+\n \\$SAGE := rec();\n\n \\$SAGE.OldPager := Pager;\n```\n\nThis might be slightly fragile, as I don't think `GAPInfo.ExcludeFromAutoload` is meant to be manipulated directly (normally it should be set via `SetUserPreference`, but it's too late to do that in `sage.g`).  Seems to work though.\n\nThe patch Dima mentioned isn't relevant here because none of those default packages use xgap.  I don't think we should rely on that being patched out anyways.",
    "created_at": "2018-11-15T13:37:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423428",
    "user": "https://github.com/embray"
}
```

<a id='comment:230'></a>
Replying to [arojas](#comment%3A228):
> Replying to [embray](#comment%3A226):
> > We need some way, when starting GAP for Sage's pexpect interface, to force "no, xgap is really not available"

> 
> FWIW we (Arch) faced a similar issue some time ago:
> 
> https://bugs.archlinux.org/task/55174
> 
> My "fix" was to patch out loading xgap from sonata/PackageInfo.g


My solution is to add the following to `sage.g`: 

```diff
diff --git a/src/ext/gap/sage.g b/src/ext/gap/sage.g
index 2a4ce13..dafb003 100644
--- a/src/ext/gap/sage.g
+++ b/src/ext/gap/sage.g
@@ -1,7 +1,22 @@
-
 #
 # SAGE support utilities to read into the GAP session.
 #
+
+# Prevent loading the xgap package; we use the -p flag to GAP in order to
+# communicate with it via the pexpect interface; this is normally used by
+# for an xgap window to communicate with GAP, so unfortunatelly setting this
+# flag also allows the xgap package to be loaded and for some packages to
+# attempt to communicate with a "window handler" that doesn't exist.
+# Therefore we must explicitly disable loading of the xgap package.
+
+# Don't use SetUserPreference since that leads to reloading the workspace,
+# which confusing the pexpect interface
+if IsBound(GAPInfo.ExcludeFromAutoload) then
+    Append(GAPInfo.ExcludeFromAutoload, "xgap");
+else
+    GAPInfo.ExcludeFromAutoload := [ "xgap" ];
+fi;
+
 \$SAGE := rec();

 \$SAGE.OldPager := Pager;
```

This might be slightly fragile, as I don't think `GAPInfo.ExcludeFromAutoload` is meant to be manipulated directly (normally it should be set via `SetUserPreference`, but it's too late to do that in `sage.g`).  Seems to work though.

The patch Dima mentioned isn't relevant here because none of those default packages use xgap.  I don't think we should rely on that being patched out anyways.



---

archive/issue_comments_423429.json:
```json
{
    "body": "<a id='comment:1'></a>\nDima, can I ask you about this patch?\n\n```diff\ncommit 3d12d9c432e551c57241cf615d57e7cbd80fc23a\nAuthor: Dima Pasechnik <dimpase@gmail.com>\nDate:   Wed Sep 26 12:18:55 2018 +0100\n\n    fixing all but one doctests in interfaces/gap.py\n\ndiff --git a/src/sage/interfaces/gap.py b/src/sage/interfaces/gap.py\nindex 55d41aa..6cf740c 100644\n--- a/src/sage/interfaces/gap.py\n+++ b/src/sage/interfaces/gap.py\n@@ -1666,10 +1666,9 @@ class GapFunction(ExpectFunction):\n\n             sage: print(gap.SymmetricGroup.__doc__)\n             <BLANKLINE>\n-            50 Group Libraries\n+              50.1-12 SymmetricGroup\n             <BLANKLINE>\n-            When you start GAP, it already knows several groups. Currently GAP initially\n-            knows the following groups:\n+              \u2023 SymmetricGroup( [filt, ]deg ) \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 function\n             ...\n         \"\"\"\n         M = self._parent\n```\n\nThis test fails for me now.  It gives the full output of that documentation file starting with \"50 Group Libraries\"...\n\nThat is not great though.  If I ask for `gap.SymmetricGroup.__doc__` it should only display the relevant section of that document, not the whole document.  I wonder if there's some patch I removed, or some other reason to expect that asking for `? SymmetricGroup` should only start on the relevant line...",
    "created_at": "2018-11-15T14:08:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423429",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>
Dima, can I ask you about this patch?

```diff
commit 3d12d9c432e551c57241cf615d57e7cbd80fc23a
Author: Dima Pasechnik <dimpase@gmail.com>
Date:   Wed Sep 26 12:18:55 2018 +0100

    fixing all but one doctests in interfaces/gap.py

diff --git a/src/sage/interfaces/gap.py b/src/sage/interfaces/gap.py
index 55d41aa..6cf740c 100644
--- a/src/sage/interfaces/gap.py
+++ b/src/sage/interfaces/gap.py
@@ -1666,10 +1666,9 @@ class GapFunction(ExpectFunction):

             sage: print(gap.SymmetricGroup.__doc__)
             <BLANKLINE>
-            50 Group Libraries
+              50.1-12 SymmetricGroup
             <BLANKLINE>
-            When you start GAP, it already knows several groups. Currently GAP initially
-            knows the following groups:
+              ‚Ä£ SymmetricGroup( [filt, ]deg ) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ function
             ...
         """
         M = self._parent
```

This test fails for me now.  It gives the full output of that documentation file starting with "50 Group Libraries"...

That is not great though.  If I ask for `gap.SymmetricGroup.__doc__` it should only display the relevant section of that document, not the whole document.  I wonder if there's some patch I removed, or some other reason to expect that asking for `? SymmetricGroup` should only start on the relevant line...



---

archive/issue_comments_423430.json:
```json
{
    "body": "<a id='comment:2'></a>\nI think I see the problem.  This is a bit buggy in general (even before this ticket...)",
    "created_at": "2018-11-15T14:15:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423430",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>
I think I see the problem.  This is a bit buggy in general (even before this ticket...)



---

archive/issue_comments_423431.json:
```json
{
    "body": "<a id='comment:3'></a>\nWe have some other serious problems with error handling, in particular in the areas where we go outside of what is currently possible with the libgap API--particularly when we do things like call functions directly with `CALL_<N>ARGS`.  Unfortunately I don't see a great way around that right now.  The current, very limited API provided to us has a way to get a pointer to a global variable (e.g. with `GAP_ValueGlobalVariable`) but then no way to really do anything with it--in particular no way to pass it as an argument to a function--without going outside the API.\n\nThat means that before errors occur somewhere down in the GAP kernel resulting in a longjump to `STATE(ReadJmpError)`, we need to always ensure that it has somewhere to jump *to* that makes sense.\n\nCurrently when we wrap those calls in `sig_on()` and `sig_off()` we at least get a segfault handled by cysignals, but we can lose any useful error reporting from GAP if an error occurs somewhere that doesn't go through our error handling.  Further confusing matters, there's an internal function `ReadEvalError()` that's kind of like a `raise` which just jump to the last `TRY_IF_NO_ERROR`.  And unlike `JUMP_TO_CALL` it does not process our custom error handler.  It can also just jump off into the weeds if we're not careful.",
    "created_at": "2018-11-15T16:23:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423431",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>
We have some other serious problems with error handling, in particular in the areas where we go outside of what is currently possible with the libgap API--particularly when we do things like call functions directly with `CALL_<N>ARGS`.  Unfortunately I don't see a great way around that right now.  The current, very limited API provided to us has a way to get a pointer to a global variable (e.g. with `GAP_ValueGlobalVariable`) but then no way to really do anything with it--in particular no way to pass it as an argument to a function--without going outside the API.

That means that before errors occur somewhere down in the GAP kernel resulting in a longjump to `STATE(ReadJmpError)`, we need to always ensure that it has somewhere to jump *to* that makes sense.

Currently when we wrap those calls in `sig_on()` and `sig_off()` we at least get a segfault handled by cysignals, but we can lose any useful error reporting from GAP if an error occurs somewhere that doesn't go through our error handling.  Further confusing matters, there's an internal function `ReadEvalError()` that's kind of like a `raise` which just jump to the last `TRY_IF_NO_ERROR`.  And unlike `JUMP_TO_CALL` it does not process our custom error handler.  It can also just jump off into the weeds if we're not careful.



---

archive/issue_comments_423432.json:
```json
{
    "body": "<a id='comment:4'></a>\nI think it would mostly clear things up if we either did away with `sig_on()` (or left it there for last-resort error handling) and added a similar macro, based on GAP's `TRY_IF_NO_ERROR` macro, the effect of which is also to set a return point for longjmps.  If we don't do that then GAP can wind up jumping to some weird places, or even invalid longjmp buffers (resulting in segfaults).",
    "created_at": "2018-11-15T18:01:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423432",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>
I think it would mostly clear things up if we either did away with `sig_on()` (or left it there for last-resort error handling) and added a similar macro, based on GAP's `TRY_IF_NO_ERROR` macro, the effect of which is also to set a return point for longjmps.  If we don't do that then GAP can wind up jumping to some weird places, or even invalid longjmp buffers (resulting in segfaults).



---

archive/issue_comments_423433.json:
```json
{
    "body": "<a id='comment:5'></a>\nRe: 2b7bdcd. Don't replace ELM_LIST / LEN_LIST with ELM_PLIST / LEN_PLIST. You are going to get horrible crashes you will never fix.\n\nLEN_LIST should be fine, use ELM0_LIST if you want to get the 0 for unbound elements of the list.",
    "created_at": "2018-11-15T19:07:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423433",
    "user": "https://github.com/ChrisJefferson"
}
```

<a id='comment:5'></a>
Re: 2b7bdcd. Don't replace ELM_LIST / LEN_LIST with ELM_PLIST / LEN_PLIST. You are going to get horrible crashes you will never fix.

LEN_LIST should be fine, use ELM0_LIST if you want to get the 0 for unbound elements of the list.



---

archive/issue_comments_423434.json:
```json
{
    "body": "<a id='comment:236'></a>\nReplying to [embray](#comment%3A230):\n> Replying to [arojas](#comment%3A228):\n> > Replying to [embray](#comment%3A226):\n> > > We need some way, when starting GAP for Sage's pexpect interface, to force \"no, xgap is really not available\"\n\n> > \n> > FWIW we (Arch) faced a similar issue some time ago:\n> > \n> > https://bugs.archlinux.org/task/55174\n> > \n> > My \"fix\" was to patch out loading xgap from sonata/PackageInfo.g\n\n> \n> My solution is to add the following to `sage.g`: \n> [...]\n> This might be slightly fragile, as I don't think `GAPInfo.ExcludeFromAutoload` is meant to be manipulated directly (normally it should be set via `SetUserPreference`, but it's too late to do that in `sage.g`).  Seems to work though.\n\n\n`xgap` is a 20+ years old [X11 code](https://gap-packages.github.io/xgap/htm/chapters.htm). It's not working on many X11 setups (won't build, or builds, but the resulting package does not work), is tricky get working on OSX or Windows, and there is a Jupyter-based replacement being worked on.\nI don't think Sage can realistically support it.",
    "created_at": "2018-11-15T19:57:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423434",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:236'></a>
Replying to [embray](#comment%3A230):
> Replying to [arojas](#comment%3A228):
> > Replying to [embray](#comment%3A226):
> > > We need some way, when starting GAP for Sage's pexpect interface, to force "no, xgap is really not available"

> > 
> > FWIW we (Arch) faced a similar issue some time ago:
> > 
> > https://bugs.archlinux.org/task/55174
> > 
> > My "fix" was to patch out loading xgap from sonata/PackageInfo.g

> 
> My solution is to add the following to `sage.g`: 
> [...]
> This might be slightly fragile, as I don't think `GAPInfo.ExcludeFromAutoload` is meant to be manipulated directly (normally it should be set via `SetUserPreference`, but it's too late to do that in `sage.g`).  Seems to work though.


`xgap` is a 20+ years old [X11 code](https://gap-packages.github.io/xgap/htm/chapters.htm). It's not working on many X11 setups (won't build, or builds, but the resulting package does not work), is tricky get working on OSX or Windows, and there is a Jupyter-based replacement being worked on.
I don't think Sage can realistically support it.



---

archive/issue_comments_423435.json:
```json
{
    "body": "<a id='comment:237'></a>\nReplying to [embray](#comment%3A231):\n> Dima, can I ask you about this patch?\n> \n> ```diff\n> commit 3d12d9c432e551c57241cf615d57e7cbd80fc23a\n> Author: Dima Pasechnik <dimpase@gmail.com>\n> Date:   Wed Sep 26 12:18:55 2018 +0100\n> \n>     fixing all but one doctests in interfaces/gap.py\n> \n> diff --git a/src/sage/interfaces/gap.py b/src/sage/interfaces/gap.py\n> index 55d41aa..6cf740c 100644\n> --- a/src/sage/interfaces/gap.py\n> +++ b/src/sage/interfaces/gap.py\n> @@ -1666,10 +1666,9 @@ class GapFunction(ExpectFunction):\n> \n>              sage: print(gap.SymmetricGroup.__doc__)\n>              <BLANKLINE>\n> -            50 Group Libraries\n> +              50.1-12 SymmetricGroup\n>              <BLANKLINE>\n> -            When you start GAP, it already knows several groups. Currently GAP initially\n> -            knows the following groups:\n> +              \u2023 SymmetricGroup( [filt, ]deg ) \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 function\n>              ...\n>          \"\"\"\n>          M = self._parent\n> ```\n> \n> This test fails for me now.  It gives the full output of that documentation file starting with \"50 Group Libraries\"...\n> \n> That is not great though.  If I ask for `gap.SymmetricGroup.__doc__` it should only display the relevant section of that document, not the whole document.  I wonder if there's some patch I removed, or some other reason to expect that asking for ? \n\n\nNo, you get the same with the Sage's current GAP 4.8.6.\n\n> `SymmetricGroup` should only start on the relevant line...\n\nSure.\n\nI don't have an answer to this immediately - this particular change was a result of testing on a custom tarball I built from source; perhaps the upstream tarball packages docs in a bit different way. Let's postpone this until other things are done here.",
    "created_at": "2018-11-15T20:07:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423435",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:237'></a>
Replying to [embray](#comment%3A231):
> Dima, can I ask you about this patch?
> 
> ```diff
> commit 3d12d9c432e551c57241cf615d57e7cbd80fc23a
> Author: Dima Pasechnik <dimpase@gmail.com>
> Date:   Wed Sep 26 12:18:55 2018 +0100
> 
>     fixing all but one doctests in interfaces/gap.py
> 
> diff --git a/src/sage/interfaces/gap.py b/src/sage/interfaces/gap.py
> index 55d41aa..6cf740c 100644
> --- a/src/sage/interfaces/gap.py
> +++ b/src/sage/interfaces/gap.py
> @@ -1666,10 +1666,9 @@ class GapFunction(ExpectFunction):
> 
>              sage: print(gap.SymmetricGroup.__doc__)
>              <BLANKLINE>
> -            50 Group Libraries
> +              50.1-12 SymmetricGroup
>              <BLANKLINE>
> -            When you start GAP, it already knows several groups. Currently GAP initially
> -            knows the following groups:
> +              ‚Ä£ SymmetricGroup( [filt, ]deg ) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ function
>              ...
>          """
>          M = self._parent
> ```
> 
> This test fails for me now.  It gives the full output of that documentation file starting with "50 Group Libraries"...
> 
> That is not great though.  If I ask for `gap.SymmetricGroup.__doc__` it should only display the relevant section of that document, not the whole document.  I wonder if there's some patch I removed, or some other reason to expect that asking for ? 


No, you get the same with the Sage's current GAP 4.8.6.

> `SymmetricGroup` should only start on the relevant line...

Sure.

I don't have an answer to this immediately - this particular change was a result of testing on a custom tarball I built from source; perhaps the upstream tarball packages docs in a bit different way. Let's postpone this until other things are done here.



---

archive/issue_comments_423436.json:
```json
{
    "body": "<a id='comment:8'></a>\nWhat I see with my limited knowledge of [SageMath](SageMath) internals, you have `interfaces/gap.py` which mentions chapter 50 Group Libraries and in it 50.1-12 `SymmetricGroup`. If you check whether that section exists at http://www.gap-system.org/Manuals/doc/ref/chap50.html, you will see that it is now 50.1-10. GAP does not promise that the order and numbers of manual sections are the same, so for [SageMath](SageMath) the best way would be to avoid such references.",
    "created_at": "2018-11-16T00:34:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423436",
    "user": "https://trac.sagemath.org/admin/accounts/users/alexk"
}
```

<a id='comment:8'></a>
What I see with my limited knowledge of [SageMath](SageMath) internals, you have `interfaces/gap.py` which mentions chapter 50 Group Libraries and in it 50.1-12 `SymmetricGroup`. If you check whether that section exists at http://www.gap-system.org/Manuals/doc/ref/chap50.html, you will see that it is now 50.1-10. GAP does not promise that the order and numbers of manual sections are the same, so for [SageMath](SageMath) the best way would be to avoid such references.



---

archive/issue_comments_423437.json:
```json
{
    "body": "<a id='comment:9'></a>\nRegarding XGAP and other packages, I'd prefer using user preferences over patches to GAP and /or packages. Furthermore, this is what is going on in [SageMath](SageMath) with SONATA and XGAP. XGAP needs to be started from xgap.sh script - it can not be loaded via `LoadPackage`. The `-p` option to start GAP is reserved for XGAP. If you start GAP with `-p`, then you trick SONATA into assuming that XGAP is loaded. Can you do not call GAP with `-p` option, and in this case you do not to do anything with XGAP and SONATA at all.",
    "created_at": "2018-11-16T00:49:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423437",
    "user": "https://trac.sagemath.org/admin/accounts/users/alexk"
}
```

<a id='comment:9'></a>
Regarding XGAP and other packages, I'd prefer using user preferences over patches to GAP and /or packages. Furthermore, this is what is going on in [SageMath](SageMath) with SONATA and XGAP. XGAP needs to be started from xgap.sh script - it can not be loaded via `LoadPackage`. The `-p` option to start GAP is reserved for XGAP. If you start GAP with `-p`, then you trick SONATA into assuming that XGAP is loaded. Can you do not call GAP with `-p` option, and in this case you do not to do anything with XGAP and SONATA at all.



---

archive/issue_comments_423438.json:
```json
{
    "body": "<a id='comment:0'></a>\nP.S. rereading some earlier posts, it seems that you need `-p` for Sage's pexpect interface. Fine then. I suggest only that instead of tweaking `GAPInfo.ExcludeFromAutoload` in `gap/sage.g` you use another user preference:\n\n```\n##  These packages are not regarded as available. This doesn't work for\n##  packages which are needed by the GAP library, or which are already\n##  loaded in a workspace.\n# SetUserPreference( \"PackagesToIgnore\", [ ] );\n```\nThis way, you ignore this package if GAP is loaded for [SageMath](SageMath), but if it is compiled properly, it still can be used if one works with GAP directly.",
    "created_at": "2018-11-16T00:59:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423438",
    "user": "https://trac.sagemath.org/admin/accounts/users/alexk"
}
```

<a id='comment:0'></a>
P.S. rereading some earlier posts, it seems that you need `-p` for Sage's pexpect interface. Fine then. I suggest only that instead of tweaking `GAPInfo.ExcludeFromAutoload` in `gap/sage.g` you use another user preference:

```
##  These packages are not regarded as available. This doesn't work for
##  packages which are needed by the GAP library, or which are already
##  loaded in a workspace.
# SetUserPreference( "PackagesToIgnore", [ ] );
```
This way, you ignore this package if GAP is loaded for [SageMath](SageMath), but if it is compiled properly, it still can be used if one works with GAP directly.



---

archive/issue_comments_423439.json:
```json
{
    "body": "<a id='comment:241'></a>\nReplying to [alexk](#comment%3A240):\n> P.S. rereading some earlier posts, it seems that you need `-p` for Sage's pexpect interface. Fine then. I suggest only that instead of tweaking `GAPInfo.ExcludeFromAutoload` in `gap/sage.g` you use another user preference:\n> \n> ```\n> ##  These packages are not regarded as available. This doesn't work for\n> ##  packages which are needed by the GAP library, or which are already\n> ##  loaded in a workspace.\n> # SetUserPreference( \"PackagesToIgnore\", [ ] );\n> ```\n> This way, you ignore this package if GAP is loaded for [SageMath](SageMath), but if it is compiled properly, it still can be used if one works with GAP directly.\n\n\nThe problem with this is where to put the `SetUserPreference` call.  It should go somewhere like a `gap.ini` but the thing I don't like `gap.ini` and `gaprc` handling is that it will only read the first one it finds.  So even if I install a customized `gap.ini` to be read by Sage, if the user has a `UserGapRoot` containing their own `gap.ini` it will take full precedence, and there is no way, for example, to inherit also from a \"system\" gap.ini.\n\nTherefore the solution that Sage has apparently used for some time is to read a file, passed on the command line, containing additional customizations when starting GAP.  This ensures that it will always be read.  But I found that putting `SetUserPreference` in at such a late stage in the initialization didn't work, especially when loading an existing workspace.  I might be wrong about that but when I tried this it didn't work.",
    "created_at": "2018-11-16T11:11:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423439",
    "user": "https://github.com/embray"
}
```

<a id='comment:241'></a>
Replying to [alexk](#comment%3A240):
> P.S. rereading some earlier posts, it seems that you need `-p` for Sage's pexpect interface. Fine then. I suggest only that instead of tweaking `GAPInfo.ExcludeFromAutoload` in `gap/sage.g` you use another user preference:
> 
> ```
> ##  These packages are not regarded as available. This doesn't work for
> ##  packages which are needed by the GAP library, or which are already
> ##  loaded in a workspace.
> # SetUserPreference( "PackagesToIgnore", [ ] );
> ```
> This way, you ignore this package if GAP is loaded for [SageMath](SageMath), but if it is compiled properly, it still can be used if one works with GAP directly.


The problem with this is where to put the `SetUserPreference` call.  It should go somewhere like a `gap.ini` but the thing I don't like `gap.ini` and `gaprc` handling is that it will only read the first one it finds.  So even if I install a customized `gap.ini` to be read by Sage, if the user has a `UserGapRoot` containing their own `gap.ini` it will take full precedence, and there is no way, for example, to inherit also from a "system" gap.ini.

Therefore the solution that Sage has apparently used for some time is to read a file, passed on the command line, containing additional customizations when starting GAP.  This ensures that it will always be read.  But I found that putting `SetUserPreference` in at such a late stage in the initialization didn't work, especially when loading an existing workspace.  I might be wrong about that but when I tried this it didn't work.



---

archive/issue_comments_423440.json:
```json
{
    "body": "<a id='comment:2'></a>\nYes, I tried it again and calling `SetUserPreference` late, after GAP initialization has already mostly completed, appears to have no effect if I then start loading some packages.  I have to modify `GAPInfo.ExcludeFromAutoload` directly.\n\nThis would be avoidable if there were a sort of `gap.ini` that can be loaded early on in initialization that I could *guarantee* will be run, but unless I'm missing something that does not appear to be quite possible...",
    "created_at": "2018-11-16T11:23:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423440",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>
Yes, I tried it again and calling `SetUserPreference` late, after GAP initialization has already mostly completed, appears to have no effect if I then start loading some packages.  I have to modify `GAPInfo.ExcludeFromAutoload` directly.

This would be avoidable if there were a sort of `gap.ini` that can be loaded early on in initialization that I could *guarantee* will be run, but unless I'm missing something that does not appear to be quite possible...



---

archive/issue_comments_423441.json:
```json
{
    "body": "<a id='comment:3'></a>\nI agree that you need to tweak `GAPInfo` in `gap/sage.g` - but it does not make sense to tweak `ExcludeFromAutoload` there - you better change `PackagesToIgnore`. XGAP is not *autoloaded* at all, so adding it there is not semantically correct. \n\nBut perhaps a better way would be to make `gap.ini` working, by passing a directory that contains the `gap.ini` file as needed by Sage to GAP using the `-l` option. See `9.2 GAP Root Directories` to start with.",
    "created_at": "2018-11-16T12:28:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423441",
    "user": "https://trac.sagemath.org/admin/accounts/users/alexk"
}
```

<a id='comment:3'></a>
I agree that you need to tweak `GAPInfo` in `gap/sage.g` - but it does not make sense to tweak `ExcludeFromAutoload` there - you better change `PackagesToIgnore`. XGAP is not *autoloaded* at all, so adding it there is not semantically correct. 

But perhaps a better way would be to make `gap.ini` working, by passing a directory that contains the `gap.ini` file as needed by Sage to GAP using the `-l` option. See `9.2 GAP Root Directories` to start with.



---

archive/issue_comments_423442.json:
```json
{
    "body": "<a id='comment:4'></a>\nP.S. `-r` option will disable reading user's `.gap/gap.ini`",
    "created_at": "2018-11-16T12:33:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423442",
    "user": "https://trac.sagemath.org/admin/accounts/users/alexk"
}
```

<a id='comment:4'></a>
P.S. `-r` option will disable reading user's `.gap/gap.ini`



---

archive/issue_comments_423443.json:
```json
{
    "body": "<a id='comment:5'></a>\nproof of concept:\n\n```\n$ gap -b -r -l \"~/sage/;~/gap-4.10.0/\"\n\nReading sage/gap.ini\n```",
    "created_at": "2018-11-16T12:44:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423443",
    "user": "https://trac.sagemath.org/admin/accounts/users/alexk"
}
```

<a id='comment:5'></a>
proof of concept:

```
$ gap -b -r -l "~/sage/;~/gap-4.10.0/"

Reading sage/gap.ini
```



---

archive/issue_comments_423444.json:
```json
{
    "body": "<a id='comment:6'></a>\nI believe we do currently use `-r` actually, so maybe there's something to be said for that, though it's also unfortunate:  Perhaps the user has some things they *want* to set, and we're now crippling that capability.  Of course, that is the current case as well, and is not so good.\n\nI'm also not sure where the best place would be to put a Sage-specific `gap.ini`.  For Sage's own gap package we're setting up our own GAP root into which we could put such things, so that's straightforward.\n\nBut I really want Sage to be able to work better with a system version of GAP and in that case it's not so obvious.  If we do something like `-l /path/to/sage-specific-gap-root;/path/to/system/gap/root` would it still be able to access packages and libraries in the system GAP root?",
    "created_at": "2018-11-16T13:01:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423444",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>
I believe we do currently use `-r` actually, so maybe there's something to be said for that, though it's also unfortunate:  Perhaps the user has some things they *want* to set, and we're now crippling that capability.  Of course, that is the current case as well, and is not so good.

I'm also not sure where the best place would be to put a Sage-specific `gap.ini`.  For Sage's own gap package we're setting up our own GAP root into which we could put such things, so that's straightforward.

But I really want Sage to be able to work better with a system version of GAP and in that case it's not so obvious.  If we do something like `-l /path/to/sage-specific-gap-root;/path/to/system/gap/root` would it still be able to access packages and libraries in the system GAP root?



---

archive/issue_comments_423445.json:
```json
{
    "body": "<a id='comment:7'></a>\n1) If the user has own `~/.gap` that may be what they use to customise their own GAP installation - perhaps what they want to set for other GAP, not the one in Sage?\n\n2) If you have own GAP root already, putting it there seems natural to me\n\n3) yes, sure - it will access packages and libraries in the system GAP root. Just try my example without `-b` to the the full GAP banner.",
    "created_at": "2018-11-16T13:15:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423445",
    "user": "https://trac.sagemath.org/admin/accounts/users/alexk"
}
```

<a id='comment:7'></a>
1) If the user has own `~/.gap` that may be what they use to customise their own GAP installation - perhaps what they want to set for other GAP, not the one in Sage?

2) If you have own GAP root already, putting it there seems natural to me

3) yes, sure - it will access packages and libraries in the system GAP root. Just try my example without `-b` to the the full GAP banner.



---

archive/issue_comments_423446.json:
```json
{
    "body": "<a id='comment:248'></a>\nReplying to [alexk](#comment%3A247):\n> 1) If the user has own `~/.gap` that may be what they use to customise their own GAP installation - perhaps what they want to set for other GAP, not the one in Sage?\n\n\nPoint being, I want to do away with the notion of a \"GAP in Sage\" being necessary as opposed to an existing GAP installation.  Sage should work and integrate with an existing GAP and not provide its own GAP as its own remote universe separate from the GAP installation that a user might already be using.  Practically-speaking that isn't totally possible yet, but I am trying to move in that direction.\n\n> 3) yes, sure - it will access packages and libraries in the system GAP root. Just try my example without `-b` to the the full GAP banner. \n\n\nOkay, I'll give that a try then.  That said, I'm still not sure I *want* to rely on `-r` since that hinders a user from working in GAP directly and in Sage with the same configuration (to the extent possible).",
    "created_at": "2018-11-16T16:29:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423446",
    "user": "https://github.com/embray"
}
```

<a id='comment:248'></a>
Replying to [alexk](#comment%3A247):
> 1) If the user has own `~/.gap` that may be what they use to customise their own GAP installation - perhaps what they want to set for other GAP, not the one in Sage?


Point being, I want to do away with the notion of a "GAP in Sage" being necessary as opposed to an existing GAP installation.  Sage should work and integrate with an existing GAP and not provide its own GAP as its own remote universe separate from the GAP installation that a user might already be using.  Practically-speaking that isn't totally possible yet, but I am trying to move in that direction.

> 3) yes, sure - it will access packages and libraries in the system GAP root. Just try my example without `-b` to the the full GAP banner. 


Okay, I'll give that a try then.  That said, I'm still not sure I *want* to rely on `-r` since that hinders a user from working in GAP directly and in Sage with the same configuration (to the extent possible).



---

archive/issue_comments_423447.json:
```json
{
    "body": "<a id='comment:9'></a>\nSome progress: With a few mostly trivial exceptions I have all the tests in the following modules working\n\n* `sage.interfaces.gap`\n* `sage.libs.gap.element`\n* `sage.libs.gap.libgap`\n* `sage.libs.gap.util`\n\nSome of the others not so much.  For example `sage.libs.gap.all_documented_functions` times out.  In that case I have to wonder if it's just because I have too many packages available or something.  Will have to investigate that more later.\n\nThings are still something of a mess so I'll work next Monday or Tuesday on cleaning up some more before I push my work.  The biggest mess is still in the area of error handling, but I think I have something of a handle on it.  I'm also still concerned about memory leaks, though I don't have any immediate evidence that this is a problem.",
    "created_at": "2018-11-16T18:31:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423447",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>
Some progress: With a few mostly trivial exceptions I have all the tests in the following modules working

* `sage.interfaces.gap`
* `sage.libs.gap.element`
* `sage.libs.gap.libgap`
* `sage.libs.gap.util`

Some of the others not so much.  For example `sage.libs.gap.all_documented_functions` times out.  In that case I have to wonder if it's just because I have too many packages available or something.  Will have to investigate that more later.

Things are still something of a mess so I'll work next Monday or Tuesday on cleaning up some more before I push my work.  The biggest mess is still in the area of error handling, but I think I have something of a handle on it.  I'm also still concerned about memory leaks, though I don't have any immediate evidence that this is a problem.



---

archive/issue_comments_423448.json:
```json
{
    "body": "<a id='comment:0'></a>\nEven if I reduce the number of packages down to the minimum required for GAP to work, `sage.libs.gap.all_documented_functions` takes ages, and eventually times out.  On GAP 4.8.6 it's also quite slow for me--takes about two minutes.  But now it's even worse.  Is this really something we need/want, and is there a reason it's quite so slow...?",
    "created_at": "2018-11-19T09:01:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423448",
    "user": "https://github.com/embray"
}
```

<a id='comment:0'></a>
Even if I reduce the number of packages down to the minimum required for GAP to work, `sage.libs.gap.all_documented_functions` takes ages, and eventually times out.  On GAP 4.8.6 it's also quite slow for me--takes about two minutes.  But now it's even worse.  Is this really something we need/want, and is there a reason it's quite so slow...?



---

archive/issue_comments_423449.json:
```json
{
    "body": "<a id='comment:1'></a>\nLet's limit the scope of this ticket to concentrate on the core problems: error handling and interaction with GAP's GC, something that needs a lot of skills. We can iron out the kinks in e.g. `sage.libs.gap.all_documented_functions` and in GAP workspaces handling later.",
    "created_at": "2018-11-19T12:11:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423449",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:1'></a>
Let's limit the scope of this ticket to concentrate on the core problems: error handling and interaction with GAP's GC, something that needs a lot of skills. We can iron out the kinks in e.g. `sage.libs.gap.all_documented_functions` and in GAP workspaces handling later.



---

archive/issue_comments_423450.json:
```json
{
    "body": "<a id='comment:252'></a>\nReplying to [dimpase](#comment%3A251):\n> Let's limit the scope of this ticket to concentrate on the core problems: error handling and interaction with GAP's GC, something that needs a lot of skills. We can iron out the kinks in e.g. `sage.libs.gap.all_documented_functions` and in GAP workspaces handling later.\n\n\nI agree, you're right. And there's more work to be done on that.  I have something that mostly works, but I want to think a little more systematically about it and come up with something a bit cleaner.\n\nRelated to that, I think, alas, there is still a need for some kind of `libgap_enter/exit` functions like from Volker's libgap.  Obviously the idea of the official \"libgap API\" would be such that nothing like this is needed.  But right now there are still many areas where we are (more or less unavoidably) bypassing that and calling GAP kernel functions directly.\n\nGASMAN needs to know where the bottom of the execution stack is (at least as far as GAP objects are present) in order to properly mark bags that are initialized in global variables, and I believe we may have some cases like that. I think this might explain some weird segfaults and other errors. I'm getting from time to time.  The problem is that GAP assumes that everything stems from an initial `InitializeGap` call that's at the bottom of the stack.  But when using GAP as a library that is clearly not true.  \n\nI'm not sure what the GAP developers intend us to do in this case, as this is clearly a problem for anyone using GAP as a library.  Do we have to manage references ourselves even for local variables?  That would seem fragile, whereas the old `libgap_enter()` very clearly marks the \"bottom\" of the stack so far as GASMAN needs to be concerned.  I will ask.",
    "created_at": "2018-11-19T15:59:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423450",
    "user": "https://github.com/embray"
}
```

<a id='comment:252'></a>
Replying to [dimpase](#comment%3A251):
> Let's limit the scope of this ticket to concentrate on the core problems: error handling and interaction with GAP's GC, something that needs a lot of skills. We can iron out the kinks in e.g. `sage.libs.gap.all_documented_functions` and in GAP workspaces handling later.


I agree, you're right. And there's more work to be done on that.  I have something that mostly works, but I want to think a little more systematically about it and come up with something a bit cleaner.

Related to that, I think, alas, there is still a need for some kind of `libgap_enter/exit` functions like from Volker's libgap.  Obviously the idea of the official "libgap API" would be such that nothing like this is needed.  But right now there are still many areas where we are (more or less unavoidably) bypassing that and calling GAP kernel functions directly.

GASMAN needs to know where the bottom of the execution stack is (at least as far as GAP objects are present) in order to properly mark bags that are initialized in global variables, and I believe we may have some cases like that. I think this might explain some weird segfaults and other errors. I'm getting from time to time.  The problem is that GAP assumes that everything stems from an initial `InitializeGap` call that's at the bottom of the stack.  But when using GAP as a library that is clearly not true.  

I'm not sure what the GAP developers intend us to do in this case, as this is clearly a problem for anyone using GAP as a library.  Do we have to manage references ourselves even for local variables?  That would seem fragile, whereas the old `libgap_enter()` very clearly marks the "bottom" of the stack so far as GASMAN needs to be concerned.  I will ask.



---

archive/issue_comments_423451.json:
```json
{
    "body": "<a id='comment:3'></a>\nI received repeated assurances from GAP devs that these libgap_enter/libgap_exit funcs are not needed. \n\nMy understanding is that GASMAN searches the stack for pointers, and so the local vars are safe.",
    "created_at": "2018-11-19T16:09:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423451",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:3'></a>
I received repeated assurances from GAP devs that these libgap_enter/libgap_exit funcs are not needed. 

My understanding is that GASMAN searches the stack for pointers, and so the local vars are safe.



---

archive/issue_comments_423452.json:
```json
{
    "body": "<a id='comment:254'></a>\nReplying to [dimpase](#comment%3A253):\n> I received repeated assurances from GAP devs that these libgap_enter/libgap_exit funcs are not needed. \n> \n> My understanding is that GASMAN searches the stack for pointers, and so the local vars are safe.\n\n\nI'm not sure that's true.  I may be wrong, but the global variable `StackBottomBags` (which in official GAP, as opposed to the old libgap, is declared static so we can't easily do anything with it) is set once, when the `InitBags` function is called from `InitializeGap`. \n\nGarbage collections then either search up from this location if `StackBottomBags` is below the top of the stack.  Or if, for some reason, `StackBottomBags` is above, it will search down from there.  But not both. ISTM that this implementation detail is just meant to account for both architectures were the stack grows up or down, but it still bakes in an apparent assumption that `StackBottomBags` is initialized from some stack frame outside any where GAP objects are initialized.\n\nSince `InitializeGap` is called in some arbitrary stack frame that may be either above or below future stack frames that call GAP functions, this does not seem safe unless we ensure that all future calls to GAP functions happen to occur in a deeper stack frame than when `InitializeGap` is called, which means it needs to be called early in the Python interpreter startup, just for example.\n\nAgain, I'm probably missing something but I have my doubts about this...\n\nGarbage collection issue aside, I also believe some kind of `libgap_enter()` is necessary for error handling to work correctly, or else you can wind up in situations where if an error occurs you can wind up longjmp-ing to some weird place, like back into the `InitializeGap` call, for example.  The only other way around is to do as you originally did, and have our `error_handler` longjmp completely out of GAP to a location of our choosing, but that can cause GAP not to perform necessary error cleanup of its own (such as closing streams).",
    "created_at": "2018-11-19T16:20:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423452",
    "user": "https://github.com/embray"
}
```

<a id='comment:254'></a>
Replying to [dimpase](#comment%3A253):
> I received repeated assurances from GAP devs that these libgap_enter/libgap_exit funcs are not needed. 
> 
> My understanding is that GASMAN searches the stack for pointers, and so the local vars are safe.


I'm not sure that's true.  I may be wrong, but the global variable `StackBottomBags` (which in official GAP, as opposed to the old libgap, is declared static so we can't easily do anything with it) is set once, when the `InitBags` function is called from `InitializeGap`. 

Garbage collections then either search up from this location if `StackBottomBags` is below the top of the stack.  Or if, for some reason, `StackBottomBags` is above, it will search down from there.  But not both. ISTM that this implementation detail is just meant to account for both architectures were the stack grows up or down, but it still bakes in an apparent assumption that `StackBottomBags` is initialized from some stack frame outside any where GAP objects are initialized.

Since `InitializeGap` is called in some arbitrary stack frame that may be either above or below future stack frames that call GAP functions, this does not seem safe unless we ensure that all future calls to GAP functions happen to occur in a deeper stack frame than when `InitializeGap` is called, which means it needs to be called early in the Python interpreter startup, just for example.

Again, I'm probably missing something but I have my doubts about this...

Garbage collection issue aside, I also believe some kind of `libgap_enter()` is necessary for error handling to work correctly, or else you can wind up in situations where if an error occurs you can wind up longjmp-ing to some weird place, like back into the `InitializeGap` call, for example.  The only other way around is to do as you originally did, and have our `error_handler` longjmp completely out of GAP to a location of our choosing, but that can cause GAP not to perform necessary error cleanup of its own (such as closing streams).



---

archive/issue_comments_423453.json:
```json
{
    "body": "<a id='comment:5'></a>\nAnother relatively minor, but difficult to deal with issue I encountered last week but only just now looked into:\n\nSyntax errors are not handled \"correctly\" insofar as it ignores the custom `ERROR_OUTPUT` variable that has been provided, and just prints the error directly to the libc stderr.  No bueno.  It's a minor thing, but this alone has me thinking that the new libgap is not fully ready for prime-time.  But if we can get stuff like this fixed in a GAP 4.10.x and set that as the minimum required version, that might be good enough, both for Sage and for downstream packagers.  I'll open an issue about it.\n\nOn a broader note, I really wish GAP relied a lot less at the lower levels on printing to I/O streams for error reporting, and instead set an error message somewhere along with an error indicator (there is `STATE(NrError)` but no equivalent for storing error messages).  Something along the lines of having something similar to a `PyErr_Occurred()` would be more helpful for libraries to use, and would still integrate easily into the GAP REPL (where printing becomes appropriate).  I have a similar complaint about how `ViewObj` works.  I will open issues about these as well but I don't know if we can expect a fix anytime soon.  In the meantime it is okay (but not ideal) to work around by capturing the relevant I/O streams (but in the case of syntax errors even that workaround is broken :(",
    "created_at": "2018-11-19T18:18:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423453",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>
Another relatively minor, but difficult to deal with issue I encountered last week but only just now looked into:

Syntax errors are not handled "correctly" insofar as it ignores the custom `ERROR_OUTPUT` variable that has been provided, and just prints the error directly to the libc stderr.  No bueno.  It's a minor thing, but this alone has me thinking that the new libgap is not fully ready for prime-time.  But if we can get stuff like this fixed in a GAP 4.10.x and set that as the minimum required version, that might be good enough, both for Sage and for downstream packagers.  I'll open an issue about it.

On a broader note, I really wish GAP relied a lot less at the lower levels on printing to I/O streams for error reporting, and instead set an error message somewhere along with an error indicator (there is `STATE(NrError)` but no equivalent for storing error messages).  Something along the lines of having something similar to a `PyErr_Occurred()` would be more helpful for libraries to use, and would still integrate easily into the GAP REPL (where printing becomes appropriate).  I have a similar complaint about how `ViewObj` works.  I will open issues about these as well but I don't know if we can expect a fix anytime soon.  In the meantime it is okay (but not ideal) to work around by capturing the relevant I/O streams (but in the case of syntax errors even that workaround is broken :(



---

archive/issue_comments_423454.json:
```json
{
    "body": "<a id='comment:6'></a>\nSome general comments from a gap developer.\n\nWe know the libgap is far from complete -- we will accept PRs to add functionality and (if it doesn't require Ganges to other code) are happy to add new functions in minor 4.10 releases. \n\nFor GASMAN, yes it does support stacks going up and down -- GASMAN over the years has run on all kinds of systems, including Amigas and Ataris. For Sage's purpose, the best option would be to the stack base at he base of the stack -- is it possible to get that in Python? If not, a function which sets the pointer to some value above any stack values is sufficient.\n\nCould Sage try to run GAP in multiple threads? In that case we would have to track all the stacks. That is also possible, but would require a GAP core change.\n\nWe have had trouble in the past with error entering an infinite loop, and are happy to accept PRs to fix it. Any changes must not change functionality for existing GAP users, and break any packages (I realise that is a high bar). It is already possible (with care) to replace the break loop, and that replacement could store the error generated.\n\nChanges to ViewObj should be done with discussion. We are generally awarez and not entirely happy, with some printing functionality, but it's so fundamental it's very hard to change anything without breaking dozens of packages.",
    "created_at": "2018-11-19T20:59:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423454",
    "user": "https://github.com/ChrisJefferson"
}
```

<a id='comment:6'></a>
Some general comments from a gap developer.

We know the libgap is far from complete -- we will accept PRs to add functionality and (if it doesn't require Ganges to other code) are happy to add new functions in minor 4.10 releases. 

For GASMAN, yes it does support stacks going up and down -- GASMAN over the years has run on all kinds of systems, including Amigas and Ataris. For Sage's purpose, the best option would be to the stack base at he base of the stack -- is it possible to get that in Python? If not, a function which sets the pointer to some value above any stack values is sufficient.

Could Sage try to run GAP in multiple threads? In that case we would have to track all the stacks. That is also possible, but would require a GAP core change.

We have had trouble in the past with error entering an infinite loop, and are happy to accept PRs to fix it. Any changes must not change functionality for existing GAP users, and break any packages (I realise that is a high bar). It is already possible (with care) to replace the break loop, and that replacement could store the error generated.

Changes to ViewObj should be done with discussion. We are generally awarez and not entirely happy, with some printing functionality, but it's so fundamental it's very hard to change anything without breaking dozens of packages.



---

archive/issue_comments_423455.json:
```json
{
    "body": "<a id='comment:257'></a>\nReplying to [gh-ChrisJefferson](#comment%3A256):\n> For GASMAN, yes it does support stacks going up and down -- GASMAN over the years has run on all kinds of systems, including Amigas and Ataris. For Sage's purpose, the best option would be to the stack base at he base of the stack -- is it possible to get that in Python? If not, a function which sets the pointer to some value above any stack values is sufficient.\n\n\nWhat do you mean by \"a function which sets the pointer to some value above any stack values\"?  Right now nothing like that exists officially, although I could probably do it in some gnarly hack.  Otherwise we would need a patch to GAP.\n\nThe best I could do would be to call `GAP_Initialize` as early as possible in the Python interpreter start-up, but for Sage at least--and I think likely for other applications--this would not be acceptable.  Sage initializes GAP lazily only when it is first used.  Adding GAP initialization to Sage start-up would noticeably impact startup time, especially in cases when the workspace needs to be reinitialized.\n\nIn any case, IIUC, setting the stack base for GAP from `InitializeGap` is not good for GAP used as a library, since there's no way to guarantee that the `InitializeGap` call will remain a base of future stack frames.\n\nI'm not positive yet, but I think this is a reason for some problems I'm having with bag pointers being moved from under my feet once the number of GAP objects in memory grows large.  For heap objects it's not a problem--they remain valid because we track our references to them and use the kindly-provided `markBagsCallback` interface to mark them all.  But then when I attempt function calls (e.g. `Filter`) on large lists of GAP objects things start moving under my feet.\n \n> Could Sage try to run GAP in multiple threads? In that case we would have to track all the stacks. That is also possible, but would require a GAP core change.\n\n\nIn theory sure--anything could try to run GAP code multi-threaded.  But that's never been safe AFAIK so I'm not worried about that here.  In Python multi-threading is not very common anyways since limitations in the Python interpreter make it less useful for performance purposes, so multi-process parallelism is more common.",
    "created_at": "2018-11-20T09:09:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423455",
    "user": "https://github.com/embray"
}
```

<a id='comment:257'></a>
Replying to [gh-ChrisJefferson](#comment%3A256):
> For GASMAN, yes it does support stacks going up and down -- GASMAN over the years has run on all kinds of systems, including Amigas and Ataris. For Sage's purpose, the best option would be to the stack base at he base of the stack -- is it possible to get that in Python? If not, a function which sets the pointer to some value above any stack values is sufficient.


What do you mean by "a function which sets the pointer to some value above any stack values"?  Right now nothing like that exists officially, although I could probably do it in some gnarly hack.  Otherwise we would need a patch to GAP.

The best I could do would be to call `GAP_Initialize` as early as possible in the Python interpreter start-up, but for Sage at least--and I think likely for other applications--this would not be acceptable.  Sage initializes GAP lazily only when it is first used.  Adding GAP initialization to Sage start-up would noticeably impact startup time, especially in cases when the workspace needs to be reinitialized.

In any case, IIUC, setting the stack base for GAP from `InitializeGap` is not good for GAP used as a library, since there's no way to guarantee that the `InitializeGap` call will remain a base of future stack frames.

I'm not positive yet, but I think this is a reason for some problems I'm having with bag pointers being moved from under my feet once the number of GAP objects in memory grows large.  For heap objects it's not a problem--they remain valid because we track our references to them and use the kindly-provided `markBagsCallback` interface to mark them all.  But then when I attempt function calls (e.g. `Filter`) on large lists of GAP objects things start moving under my feet.
 
> Could Sage try to run GAP in multiple threads? In that case we would have to track all the stacks. That is also possible, but would require a GAP core change.


In theory sure--anything could try to run GAP code multi-threaded.  But that's never been safe AFAIK so I'm not worried about that here.  In Python multi-threading is not very common anyways since limitations in the Python interpreter make it less useful for performance purposes, so multi-process parallelism is more common.



---

archive/issue_comments_423456.json:
```json
{
    "body": "<a id='comment:8'></a>\nIs there any simple way to get a pointer to something early in the stack, before anything else that might call GAP? Does Sage run any early C function which doesn't return, where it could stash the stack pointer? Looking at Python itself, a _PyMain object is put on the stack very early on, which is they passed by pointer. Is it possible to get that pointer back?\n\nEDIT: _PyCoreConfig also looks like it is set up very early and stored on the stack.",
    "created_at": "2018-11-20T09:49:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423456",
    "user": "https://github.com/ChrisJefferson"
}
```

<a id='comment:8'></a>
Is there any simple way to get a pointer to something early in the stack, before anything else that might call GAP? Does Sage run any early C function which doesn't return, where it could stash the stack pointer? Looking at Python itself, a _PyMain object is put on the stack very early on, which is they passed by pointer. Is it possible to get that pointer back?

EDIT: _PyCoreConfig also looks like it is set up very early and stored on the stack.



---

archive/issue_comments_423457.json:
```json
{
    "body": "<a id='comment:259'></a>\nReplying to [gh-ChrisJefferson](#comment%3A258):\n> Is there any simple way to get a pointer to something early in the stack, before anything else that might call GAP? Does Sage run any early C function which doesn't return, where it could stash the stack pointer? Looking at Python itself, a _PyMain object is put on the stack very early on, which is they passed by pointer. Is it possible to get that pointer back?\n> \n> EDIT: _PyCoreConfig also looks like it is set up very early and stored on the stack.\n\n\nI was thinking about something like that, but in the end it still wouldn't help, at least not with `GAP_Initialize()` as it's currently defined:\n\n```c\nvoid GAP_Initialize(int              argc,\n                    char **          argv,\n                    char **          env,\n                    GAP_CallbackFunc markBagsCallback,\n                    GAP_CallbackFunc errorCallback)\n{\n    InitializeGap(&argc, argv, env);\n    SetExtraMarkFuncBags(markBagsCallback);\n    STATE(JumpToCatchCallback) = errorCallback;\n\n    GAP_True = True;\n    GAP_False = False;\n    GAP_Fail = Fail;\n}\n```\n\nHere it passes `&argc` to `IntializeGap`, where the compiler effectively makes `argc` a stack local variable and thus `&argc` is a pointer to the `GAP_Initialize` stack frame.\n\nI could, as you say, create (or abuse) some area earlier on the stack, and temporarily shove the value for `argc` in there.  Then I would have manually re-implement `GAP_Initialize` so that I can pass that pointer to `InitializeGap`.\n\nPoint being, of course, none of this should be necessary, and there ought to be a way to set the stack bottom for GASMAN any time to wherever is appropriate (this is what `libgap_enter` did, primarily).",
    "created_at": "2018-11-20T10:10:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423457",
    "user": "https://github.com/embray"
}
```

<a id='comment:259'></a>
Replying to [gh-ChrisJefferson](#comment%3A258):
> Is there any simple way to get a pointer to something early in the stack, before anything else that might call GAP? Does Sage run any early C function which doesn't return, where it could stash the stack pointer? Looking at Python itself, a _PyMain object is put on the stack very early on, which is they passed by pointer. Is it possible to get that pointer back?
> 
> EDIT: _PyCoreConfig also looks like it is set up very early and stored on the stack.


I was thinking about something like that, but in the end it still wouldn't help, at least not with `GAP_Initialize()` as it's currently defined:

```c
void GAP_Initialize(int              argc,
                    char **          argv,
                    char **          env,
                    GAP_CallbackFunc markBagsCallback,
                    GAP_CallbackFunc errorCallback)
{
    InitializeGap(&argc, argv, env);
    SetExtraMarkFuncBags(markBagsCallback);
    STATE(JumpToCatchCallback) = errorCallback;

    GAP_True = True;
    GAP_False = False;
    GAP_Fail = Fail;
}
```

Here it passes `&argc` to `IntializeGap`, where the compiler effectively makes `argc` a stack local variable and thus `&argc` is a pointer to the `GAP_Initialize` stack frame.

I could, as you say, create (or abuse) some area earlier on the stack, and temporarily shove the value for `argc` in there.  Then I would have manually re-implement `GAP_Initialize` so that I can pass that pointer to `InitializeGap`.

Point being, of course, none of this should be necessary, and there ought to be a way to set the stack bottom for GASMAN any time to wherever is appropriate (this is what `libgap_enter` did, primarily).



---

archive/issue_comments_423458.json:
```json
{
    "body": "<a id='comment:0'></a>\nThere are two seperate issues here:\n\n1) We need a way to set the stack bottom in GASMAN. Indeed there is no such function. As has been said multiple times, the libgap api was only introduced a short while ago as a well-defined place to put functionality needed by code outside GAP, and we can easily add a function to it to allow passing in a stack base.\n\n2) Do we need something more like the existing libgap_enter/leave, which kept updating this pointer all the time, and had to be called in pairs. I don't think we do, as long as we can get some pointer into the stack quite high up.",
    "created_at": "2018-11-20T10:23:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423458",
    "user": "https://github.com/ChrisJefferson"
}
```

<a id='comment:0'></a>
There are two seperate issues here:

1) We need a way to set the stack bottom in GASMAN. Indeed there is no such function. As has been said multiple times, the libgap api was only introduced a short while ago as a well-defined place to put functionality needed by code outside GAP, and we can easily add a function to it to allow passing in a stack base.

2) Do we need something more like the existing libgap_enter/leave, which kept updating this pointer all the time, and had to be called in pairs. I don't think we do, as long as we can get some pointer into the stack quite high up.



---

archive/issue_comments_423459.json:
```json
{
    "body": "<a id='comment:261'></a>\nReplying to [embray](#comment%3A254):\n> I also believe some kind of `libgap_enter()` is necessary for error handling to work correctly\n\n\nIsn't this exactly the `sig_on()`/`sig_error()` use case? Earlier, you said that longjmping using `sig_error()` was problematic.",
    "created_at": "2018-11-20T10:46:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423459",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:261'></a>
Replying to [embray](#comment%3A254):
> I also believe some kind of `libgap_enter()` is necessary for error handling to work correctly


Isn't this exactly the `sig_on()`/`sig_error()` use case? Earlier, you said that longjmping using `sig_error()` was problematic.



---

archive/issue_comments_423460.json:
```json
{
    "body": "<a id='comment:262'></a>\nReplying to [gh-ChrisJefferson](#comment%3A260):\n> There are two seperate issues here:\n> \n> 1) We need a way to set the stack bottom in GASMAN. Indeed there is no such function. As has been said multiple times, the libgap api was only introduced a short while ago as a well-defined place to put functionality needed by code outside GAP, and we can easily add a function to it to allow passing in a stack base.\n\n\nThat's fine. I know (now) that it's incomplete.  My fear is that it won't be \"ready\" enough to fully replace Sage's use of its custom GAP fork in time for the next release, and in particular in time for the upcoming Debian freeze.  Regardless, now we must work together to discover these kinds of issues and resolve them.\n\n> 2) Do we need something more like the existing libgap_enter/leave, which kept updating this pointer all the time, and had to be called in pairs. I don't think we do, as long as we can get some pointer into the stack quite high up.\n\n\nYes, that is possible.  But there are some problems with that:\n\n* It places the burden on libgap users to have to worry about issues like stack frames, and ensuring that this is set up early in their application and in such a way that all future function calls are children to some call in which this is set up, which may be not always be obvious or trivial, especially (for example) if trying to implement a generic pyGAP library or the like.  It could be done, but would require hacks.\n\n* It involves a kind of \"non-local\" behavior that is hard to debug.  Actual calls to GAP functionality may not occur in an application until far from where this \"stack bottom pointer\" is initialized.  It's also inefficient.  I could grab and abuse a pointer to a local variable in `Py_Main` for example, but from there a typical code eval may be 30-40 stack frames deep, if not much more, none of which have anything to do with GAP.  I haven't evaluated exactly how much that affects the efficiency of GAP's garbage collection, but it's certainly adding needless overhead.\n\n* Instead, having explicit `libgap_enter/exit` functions clearly demarcates where GAP-related code is expected to run.  It is both clearer to the developer (they don't even have to understand what it's for or why--just document \"all code that uses libgap must be demarcated with these functions/macros)\"; it's clearer for the reader of existing code (\"this is where the GAP stuff starts/ends\"); and it's more efficient for the garbage collector (\"this marks the end of stack frames I'm responsible for\").\n\nAn alternative might be to design an extensive libgap API such that this kind of memory management responsibility is completely taken away from the user, by never allowing them to allocate new Bags in their own local variables, but instead ensures that *all* GAP objects returned by the API are allocated from some pool that is entirely managed by GAP.  Then all GAP API calls could begin with the effective equivalent of \"libgap_enter\" while taking that responsibility entirely away from the user.  I would definitely prefer only using functions from GAP that are designated as part of some public API.  I know the API has already expanded *significantly* since the 4.10.0 release, but I don't think it has this feature in terms of memory management.",
    "created_at": "2018-11-20T10:56:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423460",
    "user": "https://github.com/embray"
}
```

<a id='comment:262'></a>
Replying to [gh-ChrisJefferson](#comment%3A260):
> There are two seperate issues here:
> 
> 1) We need a way to set the stack bottom in GASMAN. Indeed there is no such function. As has been said multiple times, the libgap api was only introduced a short while ago as a well-defined place to put functionality needed by code outside GAP, and we can easily add a function to it to allow passing in a stack base.


That's fine. I know (now) that it's incomplete.  My fear is that it won't be "ready" enough to fully replace Sage's use of its custom GAP fork in time for the next release, and in particular in time for the upcoming Debian freeze.  Regardless, now we must work together to discover these kinds of issues and resolve them.

> 2) Do we need something more like the existing libgap_enter/leave, which kept updating this pointer all the time, and had to be called in pairs. I don't think we do, as long as we can get some pointer into the stack quite high up.


Yes, that is possible.  But there are some problems with that:

* It places the burden on libgap users to have to worry about issues like stack frames, and ensuring that this is set up early in their application and in such a way that all future function calls are children to some call in which this is set up, which may be not always be obvious or trivial, especially (for example) if trying to implement a generic pyGAP library or the like.  It could be done, but would require hacks.

* It involves a kind of "non-local" behavior that is hard to debug.  Actual calls to GAP functionality may not occur in an application until far from where this "stack bottom pointer" is initialized.  It's also inefficient.  I could grab and abuse a pointer to a local variable in `Py_Main` for example, but from there a typical code eval may be 30-40 stack frames deep, if not much more, none of which have anything to do with GAP.  I haven't evaluated exactly how much that affects the efficiency of GAP's garbage collection, but it's certainly adding needless overhead.

* Instead, having explicit `libgap_enter/exit` functions clearly demarcates where GAP-related code is expected to run.  It is both clearer to the developer (they don't even have to understand what it's for or why--just document "all code that uses libgap must be demarcated with these functions/macros)"; it's clearer for the reader of existing code ("this is where the GAP stuff starts/ends"); and it's more efficient for the garbage collector ("this marks the end of stack frames I'm responsible for").

An alternative might be to design an extensive libgap API such that this kind of memory management responsibility is completely taken away from the user, by never allowing them to allocate new Bags in their own local variables, but instead ensures that *all* GAP objects returned by the API are allocated from some pool that is entirely managed by GAP.  Then all GAP API calls could begin with the effective equivalent of "libgap_enter" while taking that responsibility entirely away from the user.  I would definitely prefer only using functions from GAP that are designated as part of some public API.  I know the API has already expanded *significantly* since the 4.10.0 release, but I don't think it has this feature in terms of memory management.



---

archive/issue_comments_423461.json:
```json
{
    "body": "<a id='comment:263'></a>\nReplying to [jdemeyer](#comment%3A261):\n> Replying to [embray](#comment%3A254):\n> > I also believe some kind of `libgap_enter()` is necessary for error handling to work correctly\n\n> \n> Isn't this exactly the `sig_on()`/`sig_error()` use case? Earlier, you said that longjmping using `sig_error()` was problematic.\n\n\nlibgap_enter/exit() has nothing really to do with error handling.  The problem with calling our own `longjmp` from within a custom error handler is that it causes GAP's own internal error cleanup (in `CATCH_ERROR` blocks) blocks to be bypassed.",
    "created_at": "2018-11-20T10:58:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423461",
    "user": "https://github.com/embray"
}
```

<a id='comment:263'></a>
Replying to [jdemeyer](#comment%3A261):
> Replying to [embray](#comment%3A254):
> > I also believe some kind of `libgap_enter()` is necessary for error handling to work correctly

> 
> Isn't this exactly the `sig_on()`/`sig_error()` use case? Earlier, you said that longjmping using `sig_error()` was problematic.


libgap_enter/exit() has nothing really to do with error handling.  The problem with calling our own `longjmp` from within a custom error handler is that it causes GAP's own internal error cleanup (in `CATCH_ERROR` blocks) blocks to be bypassed.



---

archive/issue_comments_423462.json:
```json
{
    "body": "<a id='comment:264'></a>\nReplying to [embray](#comment%3A263):\n> Replying to [jdemeyer](#comment%3A261):\n> > Replying to [embray](#comment%3A254):\n> > > I also believe some kind of `libgap_enter()` is necessary for error handling to work correctly\n\n> > \n> > Isn't this exactly the `sig_on()`/`sig_error()` use case? Earlier, you said that longjmping using `sig_error()` was problematic.\n\n> \n> libgap_enter/exit() has nothing really to do with error handling.  The problem with calling our own `longjmp` from within a custom error handler is that it causes GAP's own internal error cleanup (in `CATCH_ERROR` blocks) blocks to be bypassed.\n\n\nSorry, I think I misread what you were responding to here, since I was apparently the one who mentioned `libgap_enter` in the context of error handling.  What I meant here was that in addition to setting the stack bottom, `libgap_enter` might also be needed to work as something *like* `sig_on()`, but that uses an alternative location for the jmp_buf (specifically GAP's internal `STATE(ReadErrorJump)` as opposed to cysignals' `cysigs.env`).  To that end I think an extension to cysignals might be useful for allowing it to work with an alternative location of the jmp_buf--for example as an alternative to `sig_on()`.",
    "created_at": "2018-11-20T11:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423462",
    "user": "https://github.com/embray"
}
```

<a id='comment:264'></a>
Replying to [embray](#comment%3A263):
> Replying to [jdemeyer](#comment%3A261):
> > Replying to [embray](#comment%3A254):
> > > I also believe some kind of `libgap_enter()` is necessary for error handling to work correctly

> > 
> > Isn't this exactly the `sig_on()`/`sig_error()` use case? Earlier, you said that longjmping using `sig_error()` was problematic.

> 
> libgap_enter/exit() has nothing really to do with error handling.  The problem with calling our own `longjmp` from within a custom error handler is that it causes GAP's own internal error cleanup (in `CATCH_ERROR` blocks) blocks to be bypassed.


Sorry, I think I misread what you were responding to here, since I was apparently the one who mentioned `libgap_enter` in the context of error handling.  What I meant here was that in addition to setting the stack bottom, `libgap_enter` might also be needed to work as something *like* `sig_on()`, but that uses an alternative location for the jmp_buf (specifically GAP's internal `STATE(ReadErrorJump)` as opposed to cysignals' `cysigs.env`).  To that end I think an extension to cysignals might be useful for allowing it to work with an alternative location of the jmp_buf--for example as an alternative to `sig_on()`.



---

archive/issue_comments_423463.json:
```json
{
    "body": "<a id='comment:5'></a>\nAlso I haven't pushed updates to my branch yet, but I already have a macro that sets `sigsetjmp(STATE(ReadErrorJump))` before calls to any GAP functions.  This is called *after* `sig_on()` so we get the best of both worlds.  But I also think it would be possible, and handy, to have a way to merge the two into a single `sig_on_altbuf` call or something.",
    "created_at": "2018-11-20T11:04:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423463",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>
Also I haven't pushed updates to my branch yet, but I already have a macro that sets `sigsetjmp(STATE(ReadErrorJump))` before calls to any GAP functions.  This is called *after* `sig_on()` so we get the best of both worlds.  But I also think it would be possible, and handy, to have a way to merge the two into a single `sig_on_altbuf` call or something.



---

archive/issue_comments_423464.json:
```json
{
    "body": "<a id='comment:6'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/478d554716f58275be53342819f3c8d927092fcb\">478d554</a></td><td><code>some error-handling 'improvement'</code></td></tr></table>\n",
    "created_at": "2018-11-20T11:10:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423464",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/478d554716f58275be53342819f3c8d927092fcb">478d554</a></td><td><code>some error-handling 'improvement'</code></td></tr></table>




---

archive/issue_comments_423465.json:
```json
{
    "body": "**Changing commit** from \"[f3a909cdec30f70891b515fed05c53072fdfec09](https://github.com/sagemath/sagetrac-mirror/commit/f3a909cdec30f70891b515fed05c53072fdfec09)\" to \"[478d554716f58275be53342819f3c8d927092fcb](https://github.com/sagemath/sagetrac-mirror/commit/478d554716f58275be53342819f3c8d927092fcb)\".",
    "created_at": "2018-11-20T11:10:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423465",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[f3a909cdec30f70891b515fed05c53072fdfec09](https://github.com/sagemath/sagetrac-mirror/commit/f3a909cdec30f70891b515fed05c53072fdfec09)" to "[478d554716f58275be53342819f3c8d927092fcb](https://github.com/sagemath/sagetrac-mirror/commit/478d554716f58275be53342819f3c8d927092fcb)".



---

archive/issue_comments_423466.json:
```json
{
    "body": "<a id='comment:267'></a>\nReplying to [embray](#comment%3A264):\n> What I meant here was that in addition to setting the stack bottom, `libgap_enter` might also be needed to work as something *like* `sig_on()`, but that uses an alternative location for the jmp_buf (specifically GAP's internal `STATE(ReadErrorJump)` as opposed to cysignals' `cysigs.env`).  To that end I think an extension to cysignals might be useful for allowing it to work with an alternative location of the jmp_buf--for example as an alternative to `sig_on()`.\n\n\nOne immediate problem: would that be a `jmp_buf` or a `sigjmp_buf`? What cysignals uses depends on the platform: on Linux and OS X, it's `sigjmp_buf`. On other platforms, it's `jmp_buf`.\n\nDoes GAP really have to perform a `longjmp()`? Couldn't we propose to change GAP to use a callback function instead? That would be much more user friendly and it's also how other libraries implement error handling.",
    "created_at": "2018-11-20T11:12:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423466",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:267'></a>
Replying to [embray](#comment%3A264):
> What I meant here was that in addition to setting the stack bottom, `libgap_enter` might also be needed to work as something *like* `sig_on()`, but that uses an alternative location for the jmp_buf (specifically GAP's internal `STATE(ReadErrorJump)` as opposed to cysignals' `cysigs.env`).  To that end I think an extension to cysignals might be useful for allowing it to work with an alternative location of the jmp_buf--for example as an alternative to `sig_on()`.


One immediate problem: would that be a `jmp_buf` or a `sigjmp_buf`? What cysignals uses depends on the platform: on Linux and OS X, it's `sigjmp_buf`. On other platforms, it's `jmp_buf`.

Does GAP really have to perform a `longjmp()`? Couldn't we propose to change GAP to use a callback function instead? That would be much more user friendly and it's also how other libraries implement error handling.



---

archive/issue_comments_423467.json:
```json
{
    "body": "<a id='comment:8'></a>\nThe current libGAP-4.8 uses a callback mechanism for error handling (see `libgap_set_error_handler`). IMHO, porting that to GAP-4.10 would be a much better solution than messing with `setjmp()`/`longjmp()` calls.",
    "created_at": "2018-11-20T11:16:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423467",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>
The current libGAP-4.8 uses a callback mechanism for error handling (see `libgap_set_error_handler`). IMHO, porting that to GAP-4.10 would be a much better solution than messing with `setjmp()`/`longjmp()` calls.



---

archive/issue_comments_423468.json:
```json
{
    "body": "<a id='comment:9'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/025740df47e6a3dd00929c0903e441d8584a1476\">025740d</a></td><td><code>a little bit of gap_includes cleanup</code></td></tr></table>\n",
    "created_at": "2018-11-20T11:17:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423468",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/025740df47e6a3dd00929c0903e441d8584a1476">025740d</a></td><td><code>a little bit of gap_includes cleanup</code></td></tr></table>




---

archive/issue_comments_423469.json:
```json
{
    "body": "**Changing commit** from \"[478d554716f58275be53342819f3c8d927092fcb](https://github.com/sagemath/sagetrac-mirror/commit/478d554716f58275be53342819f3c8d927092fcb)\" to \"[025740df47e6a3dd00929c0903e441d8584a1476](https://github.com/sagemath/sagetrac-mirror/commit/025740df47e6a3dd00929c0903e441d8584a1476)\".",
    "created_at": "2018-11-20T11:17:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423469",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[478d554716f58275be53342819f3c8d927092fcb](https://github.com/sagemath/sagetrac-mirror/commit/478d554716f58275be53342819f3c8d927092fcb)" to "[025740df47e6a3dd00929c0903e441d8584a1476](https://github.com/sagemath/sagetrac-mirror/commit/025740df47e6a3dd00929c0903e441d8584a1476)".



---

archive/issue_comments_423470.json:
```json
{
    "body": "<a id='comment:270'></a>\nReplying to [jdemeyer](#comment%3A267):\n> Replying to [embray](#comment%3A264):\n> > What I meant here was that in addition to setting the stack bottom, `libgap_enter` might also be needed to work as something *like* `sig_on()`, but that uses an alternative location for the jmp_buf (specifically GAP's internal `STATE(ReadErrorJump)` as opposed to cysignals' `cysigs.env`).  To that end I think an extension to cysignals might be useful for allowing it to work with an alternative location of the jmp_buf--for example as an alternative to `sig_on()`.\n\n> \n> One immediate problem: would that be a `jmp_buf` or a `sigjmp_buf`? What cysignals uses depends on the platform: on Linux and OS X, it's `sigjmp_buf`. On other platforms, it's `jmp_buf`.\n\n\nGAP also has macros for these that depend on platform availability (e.g. `syJmp_buf`, which is a `sigjmp_buf` where available).  As long as these macros are used it should be safe for a GAP and a cysignals that were configured and compiled for the same platform.\n\n> Does GAP really have to perform a `longjmp()`? Couldn't we propose to change GAP to use a callback function instead? That would be much more user friendly and it's also how other libraries implement error handling.\n\n\nI don't think it really does.  I wrote something a little like you're suggesting [here](https://trac.sagemath.org/ticket/22626?replyto=267#comment:255).  Internally it uses these longjmps to effectively raise/catch exceptions, and that's a design choice that it's not my place to question.  But I think for integration as a library it would be nicer and simpler for everyone if it never long-jumped out of the GAP library at all, and instead just set some \"error occurred\" indicator with a way to retrieve the most recent error message (a la `PyErr_Occurred` + `PyErr_Fetch`).",
    "created_at": "2018-11-20T11:27:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423470",
    "user": "https://github.com/embray"
}
```

<a id='comment:270'></a>
Replying to [jdemeyer](#comment%3A267):
> Replying to [embray](#comment%3A264):
> > What I meant here was that in addition to setting the stack bottom, `libgap_enter` might also be needed to work as something *like* `sig_on()`, but that uses an alternative location for the jmp_buf (specifically GAP's internal `STATE(ReadErrorJump)` as opposed to cysignals' `cysigs.env`).  To that end I think an extension to cysignals might be useful for allowing it to work with an alternative location of the jmp_buf--for example as an alternative to `sig_on()`.

> 
> One immediate problem: would that be a `jmp_buf` or a `sigjmp_buf`? What cysignals uses depends on the platform: on Linux and OS X, it's `sigjmp_buf`. On other platforms, it's `jmp_buf`.


GAP also has macros for these that depend on platform availability (e.g. `syJmp_buf`, which is a `sigjmp_buf` where available).  As long as these macros are used it should be safe for a GAP and a cysignals that were configured and compiled for the same platform.

> Does GAP really have to perform a `longjmp()`? Couldn't we propose to change GAP to use a callback function instead? That would be much more user friendly and it's also how other libraries implement error handling.


I don't think it really does.  I wrote something a little like you're suggesting [here](https://trac.sagemath.org/ticket/22626?replyto=267#comment:255).  Internally it uses these longjmps to effectively raise/catch exceptions, and that's a design choice that it's not my place to question.  But I think for integration as a library it would be nicer and simpler for everyone if it never long-jumped out of the GAP library at all, and instead just set some "error occurred" indicator with a way to retrieve the most recent error message (a la `PyErr_Occurred` + `PyErr_Fetch`).



---

archive/issue_comments_423471.json:
```json
{
    "body": "<a id='comment:1'></a>\nAlso, part of the problem is that as of 4.10.0, the official libGAP API does not offer as much functionality as needed, so we *have* to call some internal functions directly, and this means we have to provide some sensible return point for when errors occur.",
    "created_at": "2018-11-20T11:30:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423471",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>
Also, part of the problem is that as of 4.10.0, the official libGAP API does not offer as much functionality as needed, so we *have* to call some internal functions directly, and this means we have to provide some sensible return point for when errors occur.



---

archive/issue_comments_423472.json:
```json
{
    "body": "<a id='comment:272'></a>\nReplying to [embray](#comment%3A270):\n> Internally it uses these longjmps to effectively raise/catch exceptions, and that's a design choice that it's not my place to question.\n\n\nIf if turns out that this makes error handling difficult when using GAP as a library, then it is our place to question that design choice. I never said that we should drop the `ReadJmpError` thing, we could add the callback as additional error handling mechanism. That's what PARI does for example: it allows a `longjmp()`-based error handler which is mostly for internal use and it has an error callback function which is used by our Python bindings to PARI.",
    "created_at": "2018-11-20T11:39:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423472",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:272'></a>
Replying to [embray](#comment%3A270):
> Internally it uses these longjmps to effectively raise/catch exceptions, and that's a design choice that it's not my place to question.


If if turns out that this makes error handling difficult when using GAP as a library, then it is our place to question that design choice. I never said that we should drop the `ReadJmpError` thing, we could add the callback as additional error handling mechanism. That's what PARI does for example: it allows a `longjmp()`-based error handler which is mostly for internal use and it has an error callback function which is used by our Python bindings to PARI.



---

archive/issue_comments_423473.json:
```json
{
    "body": "<a id='comment:3'></a>\nI can't imagine what you would suggest we use instead of longjmp? If a GAP function raises an error, we need to return from multiple functions, back to some well-defined calling point (in practice, back to the user prompt). In a C system, you can really only do that with longjmp.\n\nOf course, we can stop those internal longjmps from escaping a well-defined libgap API, by adding a longjmp in each ABI function that could cause an Error.",
    "created_at": "2018-11-20T11:46:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423473",
    "user": "https://github.com/ChrisJefferson"
}
```

<a id='comment:3'></a>
I can't imagine what you would suggest we use instead of longjmp? If a GAP function raises an error, we need to return from multiple functions, back to some well-defined calling point (in practice, back to the user prompt). In a C system, you can really only do that with longjmp.

Of course, we can stop those internal longjmps from escaping a well-defined libgap API, by adding a longjmp in each ABI function that could cause an Error.



---

archive/issue_comments_423474.json:
```json
{
    "body": "<a id='comment:274'></a>\nReplying to [gh-ChrisJefferson](#comment%3A273):\n> I can't imagine what you would suggest we use instead of longjmp?\n\n\nVarious libraries (in particular, PARI, NTL, GLPK and Volker Braun's libGAP) call a callback function to handle errors. Of course, that callback function might also call some variant of `longjmp()`. In Sage, we use `sig_on()` to define a single `setjmp()` jump point that the various callback functions jump to.\n\nA callback function also has the advantage that it can take arguments: you could pass it some info about the error and it may store that or take different actions depending on the error.",
    "created_at": "2018-11-20T12:08:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423474",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:274'></a>
Replying to [gh-ChrisJefferson](#comment%3A273):
> I can't imagine what you would suggest we use instead of longjmp?


Various libraries (in particular, PARI, NTL, GLPK and Volker Braun's libGAP) call a callback function to handle errors. Of course, that callback function might also call some variant of `longjmp()`. In Sage, we use `sig_on()` to define a single `setjmp()` jump point that the various callback functions jump to.

A callback function also has the advantage that it can take arguments: you could pass it some info about the error and it may store that or take different actions depending on the error.



---

archive/issue_comments_423475.json:
```json
{
    "body": "<a id='comment:5'></a>\nI'm leaving this thread. It isn't being productive, and asking that GAP stops using longjmp shows a fundamental misunderstanding of.. well C. Or rewriting the entire of GAP basically from scratch.",
    "created_at": "2018-11-20T12:21:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423475",
    "user": "https://github.com/ChrisJefferson"
}
```

<a id='comment:5'></a>
I'm leaving this thread. It isn't being productive, and asking that GAP stops using longjmp shows a fundamental misunderstanding of.. well C. Or rewriting the entire of GAP basically from scratch.



---

archive/issue_comments_423476.json:
```json
{
    "body": "<a id='comment:6'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a407140ae046980369a23934b5e13e1892a19f18\">a407140</a></td><td><code>more gap_includes cleanup: just use IS_LIST and IS_REC</code></td></tr></table>\n",
    "created_at": "2018-11-20T12:31:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423476",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a407140ae046980369a23934b5e13e1892a19f18">a407140</a></td><td><code>more gap_includes cleanup: just use IS_LIST and IS_REC</code></td></tr></table>




---

archive/issue_comments_423477.json:
```json
{
    "body": "**Changing commit** from \"[025740df47e6a3dd00929c0903e441d8584a1476](https://github.com/sagemath/sagetrac-mirror/commit/025740df47e6a3dd00929c0903e441d8584a1476)\" to \"[a407140ae046980369a23934b5e13e1892a19f18](https://github.com/sagemath/sagetrac-mirror/commit/a407140ae046980369a23934b5e13e1892a19f18)\".",
    "created_at": "2018-11-20T12:31:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423477",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[025740df47e6a3dd00929c0903e441d8584a1476](https://github.com/sagemath/sagetrac-mirror/commit/025740df47e6a3dd00929c0903e441d8584a1476)" to "[a407140ae046980369a23934b5e13e1892a19f18](https://github.com/sagemath/sagetrac-mirror/commit/a407140ae046980369a23934b5e13e1892a19f18)".



---

archive/issue_comments_423478.json:
```json
{
    "body": "<a id='comment:277'></a>\nReplying to [gh-ChrisJefferson](#comment%3A275):\n> asking that GAP stops using longjmp\n\n\nNobody ever asked that. See [comment:272]",
    "created_at": "2018-11-20T12:55:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423478",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:277'></a>
Replying to [gh-ChrisJefferson](#comment%3A275):
> asking that GAP stops using longjmp


Nobody ever asked that. See [comment:272]



---

archive/issue_comments_423479.json:
```json
{
    "body": "<a id='comment:278'></a>\nReplying to [embray](#comment%3A270):\n> instead just set some \"error occurred\" indicator with a way to retrieve the most recent error message (a la `PyErr_Occurred` + `PyErr_Fetch`).\n\n\nBut that would require adding error propagation support to all (at least, a lot) GAP functions, no?\n\nIn Python for example, most C API functions return a `PyObject*` and a return value `NULL` means that an error occurred. This is a good convention, but it does require support for error propagation in virtually all Python/C API functions.",
    "created_at": "2018-11-20T13:30:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423479",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:278'></a>
Replying to [embray](#comment%3A270):
> instead just set some "error occurred" indicator with a way to retrieve the most recent error message (a la `PyErr_Occurred` + `PyErr_Fetch`).


But that would require adding error propagation support to all (at least, a lot) GAP functions, no?

In Python for example, most C API functions return a `PyObject*` and a return value `NULL` means that an error occurred. This is a good convention, but it does require support for error propagation in virtually all Python/C API functions.



---

archive/issue_comments_423480.json:
```json
{
    "body": "<a id='comment:279'></a>\nReplying to [jdemeyer](#comment%3A268):\n> The current libGAP-4.8 uses a callback mechanism for error handling (see `libgap_set_error_handler`). IMHO, porting that to GAP-4.10 would be a much better solution than messing with `setjmp()`/`longjmp()` calls.\n\n\nI should add, this has already been done.  It is the `errorCallback` function that is passed to `GAP_Initialize`. This serves the same purpose and sets a callback in the same place in the code.  It doesn't strictly help the problem because this callback is in a location right before GAP longjmps to its `CATCH_ERROR` handler (if any).  This is fine, but the problem is that sometimes this does not jump to a sensible place, but rather just to wherever the last `TRY_IF_NO_ERROR` macro was, which is not always in a sensible place (yet) for calls to the public API.",
    "created_at": "2018-11-20T13:42:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423480",
    "user": "https://github.com/embray"
}
```

<a id='comment:279'></a>
Replying to [jdemeyer](#comment%3A268):
> The current libGAP-4.8 uses a callback mechanism for error handling (see `libgap_set_error_handler`). IMHO, porting that to GAP-4.10 would be a much better solution than messing with `setjmp()`/`longjmp()` calls.


I should add, this has already been done.  It is the `errorCallback` function that is passed to `GAP_Initialize`. This serves the same purpose and sets a callback in the same place in the code.  It doesn't strictly help the problem because this callback is in a location right before GAP longjmps to its `CATCH_ERROR` handler (if any).  This is fine, but the problem is that sometimes this does not jump to a sensible place, but rather just to wherever the last `TRY_IF_NO_ERROR` macro was, which is not always in a sensible place (yet) for calls to the public API.



---

archive/issue_comments_423481.json:
```json
{
    "body": "<a id='comment:280'></a>\nReplying to [jdemeyer](#comment%3A272):\n> Replying to [embray](#comment%3A270):\n> > Internally it uses these longjmps to effectively raise/catch exceptions, and that's a design choice that it's not my place to question.\n\n> \n> If if turns out that this makes error handling difficult when using GAP as a library, then it is our place to question that design choice. I never said that we should drop the `ReadJmpError` thing, we could add the callback as additional error handling mechanism. That's what PARI does for example: it allows a `longjmp()`-based error handler which is mostly for internal use and it has an error callback function which is used by our Python bindings to PARI.\n\n\nThe use of that mechanism does not, on its own, cause any problems and is perfectly reasonable to use for error handling within the GAP kernel.  The only problem is that it's applied somewhat inconsistently at the moment, from the standpoint of third-party API consumers (who, ideally, should not be exposed to this implementation detail at all).  Many of the problems I'm encountering related to this are because we're still currently using internal implementation details like `CALL_<N>ARGS` without setting up the appropriate error handling that the GAP kernel itself otherwise might. \n\nFortunately in GAP's master branch there's now a `GAP_CallFuncArray`, for example, that gives an \"official\" implementation allowing us to avoid (eventually) using these internal details.  The API still doesn't get some of the error-handling details quite right (it does not fix the problem I describe above) but it does provide the appropriate area for making these improvements.",
    "created_at": "2018-11-20T13:52:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423481",
    "user": "https://github.com/embray"
}
```

<a id='comment:280'></a>
Replying to [jdemeyer](#comment%3A272):
> Replying to [embray](#comment%3A270):
> > Internally it uses these longjmps to effectively raise/catch exceptions, and that's a design choice that it's not my place to question.

> 
> If if turns out that this makes error handling difficult when using GAP as a library, then it is our place to question that design choice. I never said that we should drop the `ReadJmpError` thing, we could add the callback as additional error handling mechanism. That's what PARI does for example: it allows a `longjmp()`-based error handler which is mostly for internal use and it has an error callback function which is used by our Python bindings to PARI.


The use of that mechanism does not, on its own, cause any problems and is perfectly reasonable to use for error handling within the GAP kernel.  The only problem is that it's applied somewhat inconsistently at the moment, from the standpoint of third-party API consumers (who, ideally, should not be exposed to this implementation detail at all).  Many of the problems I'm encountering related to this are because we're still currently using internal implementation details like `CALL_<N>ARGS` without setting up the appropriate error handling that the GAP kernel itself otherwise might. 

Fortunately in GAP's master branch there's now a `GAP_CallFuncArray`, for example, that gives an "official" implementation allowing us to avoid (eventually) using these internal details.  The API still doesn't get some of the error-handling details quite right (it does not fix the problem I describe above) but it does provide the appropriate area for making these improvements.



---

archive/issue_comments_423482.json:
```json
{
    "body": "<a id='comment:281'></a>\nReplying to [embray](#comment%3A279):\n> It doesn't strictly help the problem because this callback is in a location right before GAP longjmps to its `CATCH_ERROR` handler (if any).  This is fine, but the problem is that sometimes this does not jump to a sensible place, but rather just to wherever the last `TRY_IF_NO_ERROR` macro was, which is not always in a sensible place (yet) for calls to the public API.\n\n\nI think I understand what you are saying: there is no way to detect whether the `TRY_IF_NO_ERROR` block has ended. I.e. you would want something like\n\n```\nTRY_IF_NO_ERROR\n{\n  enable_error_recovery = 1;\n  ....\n  enable_error_recovery = 0;\n}\n```\nand then check `enable_error_recovery` in the error handler to know whether one should `longjmp()` to the location set by `TRY_IF_NO_ERROR`?",
    "created_at": "2018-11-20T13:55:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423482",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:281'></a>
Replying to [embray](#comment%3A279):
> It doesn't strictly help the problem because this callback is in a location right before GAP longjmps to its `CATCH_ERROR` handler (if any).  This is fine, but the problem is that sometimes this does not jump to a sensible place, but rather just to wherever the last `TRY_IF_NO_ERROR` macro was, which is not always in a sensible place (yet) for calls to the public API.


I think I understand what you are saying: there is no way to detect whether the `TRY_IF_NO_ERROR` block has ended. I.e. you would want something like

```
TRY_IF_NO_ERROR
{
  enable_error_recovery = 1;
  ....
  enable_error_recovery = 0;
}
```
and then check `enable_error_recovery` in the error handler to know whether one should `longjmp()` to the location set by `TRY_IF_NO_ERROR`?



---

archive/issue_comments_423483.json:
```json
{
    "body": "<a id='comment:2'></a>\nYes, that's definitely part of it.  After a `TRY_IF_NO_ERROR` there's no resetting of the mechanism to disable future jumps to that point.\n\nI had some notes about this further up this already confusing ticket, but for example I had some cases where it was possible, if some error occurred very early on in Sage's libgap API, it could result in a longjmp back to `InitializeGap` (which just happened to be where the last actual `TRY_IF_NO_ERROR` was).  What the GAP API needs is some reasonable terminal location to jump to (preferably within the GAP kernel code itself, or possibly the public API code in libgap-api.c) that can set an error indicator and return.\n\nIncidentally, almost all (and there are some exception) of these jumps originate from calls to the function `JUMP_TO_CATCH` (this is where the error callback is called as well), and within GAP almost all calls to `JUMP_TO_CATCH` originate from the default error handler `ErrorInner`, which is implemented in GAP code in `error.g`.  Chris mentioned to me that the GAP test suite runner actually messes with this in some way (I haven't looked yet), and that the GAP Juypter kernel also replaces `ErrorInner`.  We might consider doing the same, which might simplify some issues.  That's still not ideal, and should not be necessary--some internal cleanup is still needed.  But replacing `ErrorInner` might be acceptable as a temporary workaround.",
    "created_at": "2018-11-20T14:16:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423483",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>
Yes, that's definitely part of it.  After a `TRY_IF_NO_ERROR` there's no resetting of the mechanism to disable future jumps to that point.

I had some notes about this further up this already confusing ticket, but for example I had some cases where it was possible, if some error occurred very early on in Sage's libgap API, it could result in a longjmp back to `InitializeGap` (which just happened to be where the last actual `TRY_IF_NO_ERROR` was).  What the GAP API needs is some reasonable terminal location to jump to (preferably within the GAP kernel code itself, or possibly the public API code in libgap-api.c) that can set an error indicator and return.

Incidentally, almost all (and there are some exception) of these jumps originate from calls to the function `JUMP_TO_CATCH` (this is where the error callback is called as well), and within GAP almost all calls to `JUMP_TO_CATCH` originate from the default error handler `ErrorInner`, which is implemented in GAP code in `error.g`.  Chris mentioned to me that the GAP test suite runner actually messes with this in some way (I haven't looked yet), and that the GAP Juypter kernel also replaces `ErrorInner`.  We might consider doing the same, which might simplify some issues.  That's still not ideal, and should not be necessary--some internal cleanup is still needed.  But replacing `ErrorInner` might be acceptable as a temporary workaround.



---

archive/issue_comments_423484.json:
```json
{
    "body": "<a id='comment:3'></a>\nI also can't speak to how `JUMP_TO_CATCH` may be used, if at all, by third-party libraries.  Really it shouldn't be used at all, but it might be somewhere.  It's worth doing a search on...",
    "created_at": "2018-11-20T14:17:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423484",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>
I also can't speak to how `JUMP_TO_CATCH` may be used, if at all, by third-party libraries.  Really it shouldn't be used at all, but it might be somewhere.  It's worth doing a search on...



---

archive/issue_comments_423485.json:
```json
{
    "body": "<a id='comment:4'></a>\nIt seems that, at least of the \"officially supported\" packages, the Browse and SCSCP packages mess around with `ErrorInner` as well, albeit in ways that I think at least aren't likely to come up when using GAP as a library (e.g. in the SCSCP package this only happens in running its included SCSCP server, which one generally would not do from library code...)",
    "created_at": "2018-11-20T14:36:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423485",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>
It seems that, at least of the "officially supported" packages, the Browse and SCSCP packages mess around with `ErrorInner` as well, albeit in ways that I think at least aren't likely to come up when using GAP as a library (e.g. in the SCSCP package this only happens in running its included SCSCP server, which one generally would not do from library code...)



---

archive/issue_comments_423486.json:
```json
{
    "body": "<a id='comment:285'></a>\nReplying to [embray](#comment%3A282):\n> Yes, that's definitely part of it.  After a `TRY_IF_NO_ERROR` there's no resetting of the mechanism to disable future jumps to that point.\n\n\nAnd it doesn't look easy to add such a mechanism now.\n\n> What the GAP API needs is some reasonable terminal location to jump to (preferably within the GAP kernel code itself, or possibly the public API code in libgap-api.c) that can set an error indicator and return.\n\n\nI would prefer not a \"terminal location to jump to\" but a callback function to be called.\n\nConcretely, I would suggest the following:\n\n- add a macro to reset `TRY_IF_NO_ERROR`. This could be implemented as `memset(STATE(ReadJmpError), 0, sizeof(syJmp_buf));`\n\n- use this macro in GAP in the relevant places, in particular in `InitializeGap`.\n\n- have a way to check whether we are inside a `TRY_IF_NO_ERROR` block or not. Implemented by checking whether `syJmp_buf` consists of all-zero bytes.\n\n- in the GAP error callback in Sage, do the following:\n  - if we are inside `TRY_IF_NO_ERROR`: return from the error callback\n  - otherwise: call `sig_error`",
    "created_at": "2018-11-20T14:43:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423486",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:285'></a>
Replying to [embray](#comment%3A282):
> Yes, that's definitely part of it.  After a `TRY_IF_NO_ERROR` there's no resetting of the mechanism to disable future jumps to that point.


And it doesn't look easy to add such a mechanism now.

> What the GAP API needs is some reasonable terminal location to jump to (preferably within the GAP kernel code itself, or possibly the public API code in libgap-api.c) that can set an error indicator and return.


I would prefer not a "terminal location to jump to" but a callback function to be called.

Concretely, I would suggest the following:

- add a macro to reset `TRY_IF_NO_ERROR`. This could be implemented as `memset(STATE(ReadJmpError), 0, sizeof(syJmp_buf));`

- use this macro in GAP in the relevant places, in particular in `InitializeGap`.

- have a way to check whether we are inside a `TRY_IF_NO_ERROR` block or not. Implemented by checking whether `syJmp_buf` consists of all-zero bytes.

- in the GAP error callback in Sage, do the following:
  - if we are inside `TRY_IF_NO_ERROR`: return from the error callback
  - otherwise: call `sig_error`



---

archive/issue_comments_423487.json:
```json
{
    "body": "<a id='comment:6'></a>\nI don't see why you would need/want `sig_error` at all.  I'm trying to think about ways this could be usefully implemented for all users of GAP as a library.  My thinking is that the `TRY_IF_NO_ERROR` stuff should never leak out of the GAP kernel code at all, which is what I meant by a \"terminal location to jump to\"--that is--within GAP's own code.  At this point it would check whether an error occurred, and should have a way of setting some indication of that fact that can be checked easily from third-party code, along with retrieving the error message.  Being able to get a stack trace might be nice too but less important.  I don't think a \"callback function\" is necessary at all, but could also be used I suppose.  Though it would be more useful if said callback function were passed the actual error message, rather than having to wade through `ErrorInner` as we currently do, and read the error message out of a stream object that we're then also responsible for resetting :(",
    "created_at": "2018-11-20T14:52:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423487",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>
I don't see why you would need/want `sig_error` at all.  I'm trying to think about ways this could be usefully implemented for all users of GAP as a library.  My thinking is that the `TRY_IF_NO_ERROR` stuff should never leak out of the GAP kernel code at all, which is what I meant by a "terminal location to jump to"--that is--within GAP's own code.  At this point it would check whether an error occurred, and should have a way of setting some indication of that fact that can be checked easily from third-party code, along with retrieving the error message.  Being able to get a stack trace might be nice too but less important.  I don't think a "callback function" is necessary at all, but could also be used I suppose.  Though it would be more useful if said callback function were passed the actual error message, rather than having to wade through `ErrorInner` as we currently do, and read the error message out of a stream object that we're then also responsible for resetting :(



---

archive/issue_comments_423488.json:
```json
{
    "body": "<a id='comment:287'></a>\nReplying to [embray](#comment%3A286):\n> Though it would be more useful if said callback function were passed the actual error message\n\n\nOf course. That's one of the advantages that a callback would give.\n\nA callback function can run arbitrary code. So whatever specific mechanism that you want to use, you could always implement that using a callback. A callback can call `longjmp()` for example. Or a callback could set some global variables that you would want to check later.\n\nIt's also pretty standard to have an error callback function: PARI, NTL, GLPK have it.",
    "created_at": "2018-11-20T15:01:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423488",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:287'></a>
Replying to [embray](#comment%3A286):
> Though it would be more useful if said callback function were passed the actual error message


Of course. That's one of the advantages that a callback would give.

A callback function can run arbitrary code. So whatever specific mechanism that you want to use, you could always implement that using a callback. A callback can call `longjmp()` for example. Or a callback could set some global variables that you would want to check later.

It's also pretty standard to have an error callback function: PARI, NTL, GLPK have it.



---

archive/issue_comments_423489.json:
```json
{
    "body": "<a id='comment:8'></a>\nMost `sage.libs.gap` doctests working, modulo some minor issues.  But still getting segfaults during fresh docbuild :(\n\nSuspect garbage collection problems regarding stack pointer issue, but that isn't confirmed.",
    "created_at": "2018-11-20T19:24:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423489",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>
Most `sage.libs.gap` doctests working, modulo some minor issues.  But still getting segfaults during fresh docbuild :(

Suspect garbage collection problems regarding stack pointer issue, but that isn't confirmed.



---

archive/issue_comments_423490.json:
```json
{
    "body": "<a id='comment:9'></a>\nAlso have some doubts regarding interrupt handing being screwed up by `InitializeGap`.",
    "created_at": "2018-11-20T19:26:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423490",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>
Also have some doubts regarding interrupt handing being screwed up by `InitializeGap`.



---

archive/issue_comments_423491.json:
```json
{
    "body": "<a id='comment:0'></a>\nfailures during fresh docbuild might indicate multithreading problems. Does \u201cmake  -j1 ...\u201d make a difference?",
    "created_at": "2018-11-20T19:31:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423491",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:0'></a>
failures during fresh docbuild might indicate multithreading problems. Does ‚Äúmake  -j1 ...‚Äù make a difference?



---

archive/issue_comments_423492.json:
```json
{
    "body": "**Changing commit** from \"[a407140ae046980369a23934b5e13e1892a19f18](https://github.com/sagemath/sagetrac-mirror/commit/a407140ae046980369a23934b5e13e1892a19f18)\" to \"[ec4c3a03e18d5789338b40e1e4fa22b56f8b0020](https://github.com/sagemath/sagetrac-mirror/commit/ec4c3a03e18d5789338b40e1e4fa22b56f8b0020)\".",
    "created_at": "2018-11-20T19:41:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423492",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[a407140ae046980369a23934b5e13e1892a19f18](https://github.com/sagemath/sagetrac-mirror/commit/a407140ae046980369a23934b5e13e1892a19f18)" to "[ec4c3a03e18d5789338b40e1e4fa22b56f8b0020](https://github.com/sagemath/sagetrac-mirror/commit/ec4c3a03e18d5789338b40e1e4fa22b56f8b0020)".



---

archive/issue_comments_423493.json:
```json
{
    "body": "<a id='comment:1'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ec4c3a03e18d5789338b40e1e4fa22b56f8b0020\">ec4c3a0</a></td><td><code>fixes soem goofy bugs with the spkg-install for gap</code></td></tr></table>\n",
    "created_at": "2018-11-20T19:41:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423493",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:1'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ec4c3a03e18d5789338b40e1e4fa22b56f8b0020">ec4c3a0</a></td><td><code>fixes soem goofy bugs with the spkg-install for gap</code></td></tr></table>




---

archive/issue_comments_423494.json:
```json
{
    "body": "**Changing commit** from \"[ec4c3a03e18d5789338b40e1e4fa22b56f8b0020](https://github.com/sagemath/sagetrac-mirror/commit/ec4c3a03e18d5789338b40e1e4fa22b56f8b0020)\" to \"[7ccc120e3a606e044bdd9ef6835930075fa70a31](https://github.com/sagemath/sagetrac-mirror/commit/7ccc120e3a606e044bdd9ef6835930075fa70a31)\".",
    "created_at": "2018-11-20T19:41:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423494",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[ec4c3a03e18d5789338b40e1e4fa22b56f8b0020](https://github.com/sagemath/sagetrac-mirror/commit/ec4c3a03e18d5789338b40e1e4fa22b56f8b0020)" to "[7ccc120e3a606e044bdd9ef6835930075fa70a31](https://github.com/sagemath/sagetrac-mirror/commit/7ccc120e3a606e044bdd9ef6835930075fa70a31)".



---

archive/issue_comments_423495.json:
```json
{
    "body": "<a id='comment:2'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7ccc120e3a606e044bdd9ef6835930075fa70a31\">7ccc120</a></td><td><code>fixes some goofy bugs with the spkg-install for gap</code></td></tr></table>\n",
    "created_at": "2018-11-20T19:41:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423495",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7ccc120e3a606e044bdd9ef6835930075fa70a31">7ccc120</a></td><td><code>fixes some goofy bugs with the spkg-install for gap</code></td></tr></table>




---

archive/issue_comments_423496.json:
```json
{
    "body": "<a id='comment:3'></a>\nI found a neat thing while digging around in the GAP code. It seems there is already basically a way to \"throw\" an \"exception\" with the `JUMP_TO_CATCH` calls.\n\n`JUMP_TO_CATCH` already accepts a `payload` argument which can be any GAP object. It stows this away in a thread-local state variable called `ThrownObject`.\n\nAt the moment there is no particular convention for what should go there, and it is not used at all, for *anything*. But it certainly could be.\n\nPerhaps it was once used for something else. Most existing `JUMP_TO_CATCH` pass some integer between 0 and 3,but the meaning of this is long lost and the GAP git repository doesn't go back far enough to find out what it might have once meant. I'd be curious to dig around on that a bit more.\n\nBut I could implement and document a convention for how this is intended to be used, for example, to make the last error message or something like that available. This would be useful as part of my larger vision for cleaning up GAP's error handling.",
    "created_at": "2018-11-21T14:33:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423496",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>
I found a neat thing while digging around in the GAP code. It seems there is already basically a way to "throw" an "exception" with the `JUMP_TO_CATCH` calls.

`JUMP_TO_CATCH` already accepts a `payload` argument which can be any GAP object. It stows this away in a thread-local state variable called `ThrownObject`.

At the moment there is no particular convention for what should go there, and it is not used at all, for *anything*. But it certainly could be.

Perhaps it was once used for something else. Most existing `JUMP_TO_CATCH` pass some integer between 0 and 3,but the meaning of this is long lost and the GAP git repository doesn't go back far enough to find out what it might have once meant. I'd be curious to dig around on that a bit more.

But I could implement and document a convention for how this is intended to be used, for example, to make the last error message or something like that available. This would be useful as part of my larger vision for cleaning up GAP's error handling.



---

archive/issue_comments_423497.json:
```json
{
    "body": "<a id='comment:4'></a>\nAdded some more current status updates.",
    "created_at": "2018-11-30T10:24:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423497",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>
Added some more current status updates.



---

archive/issue_comments_423498.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-GAP 4.9 comes with a completely rewritten build system that will simplify\n+GAP 4.10 comes with a completely rewritten build system that will simplify\n our packaging. In particular, libGAP no longer needs to be a separate package.\n \n What the branch does:\n@@ -15,6 +15,10 @@\n \n - Update a few doctests w.r.t. changes of output of some GAP functions\n \n+- Reworks how gap is installed in `$SAGE_LOCAL`: Rather than installing the entire source tree we just install the `gap` and `libgap` binaries to standard locations, and add a `$SAGE_LOCAL/share/gap` containing the `GAP_ROOT_DIR` which is stripped down to the minimum needed for GAP to work (standard libs and packages, docs, as well as the source code for introspection of kernel functions, but all build artifacts are carefully omitted).\n+\n+  - Some of how this is done is still broken w.r.t. building compiled packages; need to work on it a bit more.\n+\n - - **Possibly controversial:** The new libgap currently 'does not come' with symbol rewriting (`foobar` -> `libGAP_foobar`). This avoids messing around with GAP's sources; in particular opening the door for using a stock GAP from the OS distribution. However there always is a risk of name conflicts. And indeed, GAP's enums `T_INT`, `T_FLOAT`, ... conflict with Python's constants defined in `structmember.h`. This is hopefully not actually a problem in practice due to the way how Cython orders includes.\n \n   Something similar was started by Volker at #19915.\n@@ -24,9 +28,13 @@\n   with the new build system and use of --with-gmp. If it is, upstream\n   asked for it to be reported and they will fix it.\n \n+- Removes additional patches for now--we would like to focus on being\n+  able to work with a system GAP as much as possible.\n+\n - Revert #19726 (not needed anymore)\n \n-Status: currently broken  - crashes deep inside GAP error handling system after few simple commands. \n+### Status\n+Currently broken - crashes deep inside GAP error handling system after few simple commands. \n \n Basic tests on libgap:\n \n@@ -45,25 +53,30 @@\n ```\n Current status: lots of errors\n \n+- Still have some miscellaneous segfaults and other weird crashes\n+\n+- Still have work to do on improving error handling; replacing the built-in `ErrorInner` function might help here.\n+\n+- SIGINT handling by Python is broken by `GAP_Intialize`; need to work around this.\n+\n Testing packages with dynamic loading (e.g. IO):\n \n Install IO:\n \n ```\n-cd $SAGE/local/gap/latest/pkg\n-wget http://www.gap-system.org/pub/gap/gap4/tar.gz/packages/io-4.4.6.tar.gz\n-tar xvf /tmp/io-4.4.6.tar.gz\n-mv io-4.4.6 io\n-cd io\n-./configure\n+cd $SAGE_LOCAL/share/gap/pkg\n+wget https://www.gap-system.org/pub/gap/gap4/tar.gz/packages/io-4.5.4.tar.gz\n+tar xvf io-4.5.4.tar.gz\n+cd io-4.5.4\n+./configure --with-gaproot=../..\n make\n ```\n \n Test it locally:\n \n ```\n-cd ../..\n-./gap -l .\n+cd $SAGE_ROOT\n+gap\n gap> LoadPackage(\"IO\");\n true\n ```\n@@ -71,14 +84,35 @@\n This does not yet work:\n \n ```\n-sage: libgap.LoadPackage(\"IO\")\n-ValueError: libGAP: Error, module '/opt/sage-git/local/gap/latest/pkg/io/bin/x86_64-pc-linux-gnu-gcc-default64/io.so' not found\n+#W dlopen() error: /home/embray/src/sagemath/sage/local/share/gap/pkg/io-4.5.4/bin/x86_64-pc-linux-gnu-default64/io.so: undefine\\\n+d symbol: ChangedBags\n+Error, module '/home/embray/src/sagemath/sage/local/share/gap/pkg/io-4.5.4/bin/x86_64-pc-linux-gnu-default64/io.so' not found\n+Error, was not in any namespace\n+Syntax warning: Unbound global variable in /home/embray/src/sagemath/sage/local/share/gap/lib/init.g:803\n+    ColorPrompt( UserPreference( \"UseColorPrompt\" ) );\n+               ^\n+Error, SetGasmanMessageStatus: function is not yet defined\n+true\n ```\n-This should be fixed once GAP's gap binary is built on top of libgap.\n-See: https://github.com/markuspf/gap/issues/1.\n+~~This should be fixed once GAP's gap binary is built on top of libgap.\n+See: https://github.com/markuspf/gap/issues/1~~ I believe this is fixed, but there are still some problems with the way this ticket is \"installing\" GAP for `$SAGE_LOCAL`.\n \n Note:\n \n - Max Horn reviewed the list of GAP symbols we use in Sage; some have already changed in 4.9. See this [pad](https://hackmd.io/emNi76svSWCh1fBeLKqPdA?edit#) for notes.\n \n+\n+### Upstream PRs\n+\n+A few pull requests we made to improve use of GAP as a library:\n+\n+* https://github.com/gap-system/gap/pull/3043\n+* https://github.com/gap-system/gap/pull/3072\n+\n+Some other PRs useful to this effort:\n+\n+* https://github.com/gap-system/gap/pull/3065\n+* https://github.com/gap-system/gap/pull/2952\n+\n+\n **Tarball**: https://www.gap-system.org/pub/gap/gap-4.10/tar.gz/gap-4.10.0.tar.gz\n``````\n",
    "created_at": "2018-11-30T10:24:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423498",
    "user": "https://github.com/embray"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-GAP 4.9 comes with a completely rewritten build system that will simplify
+GAP 4.10 comes with a completely rewritten build system that will simplify
 our packaging. In particular, libGAP no longer needs to be a separate package.
 
 What the branch does:
@@ -15,6 +15,10 @@
 
 - Update a few doctests w.r.t. changes of output of some GAP functions
 
+- Reworks how gap is installed in `$SAGE_LOCAL`: Rather than installing the entire source tree we just install the `gap` and `libgap` binaries to standard locations, and add a `$SAGE_LOCAL/share/gap` containing the `GAP_ROOT_DIR` which is stripped down to the minimum needed for GAP to work (standard libs and packages, docs, as well as the source code for introspection of kernel functions, but all build artifacts are carefully omitted).
+
+  - Some of how this is done is still broken w.r.t. building compiled packages; need to work on it a bit more.
+
 - - **Possibly controversial:** The new libgap currently 'does not come' with symbol rewriting (`foobar` -> `libGAP_foobar`). This avoids messing around with GAP's sources; in particular opening the door for using a stock GAP from the OS distribution. However there always is a risk of name conflicts. And indeed, GAP's enums `T_INT`, `T_FLOAT`, ... conflict with Python's constants defined in `structmember.h`. This is hopefully not actually a problem in practice due to the way how Cython orders includes.
 
   Something similar was started by Volker at #19915.
@@ -24,9 +28,13 @@
   with the new build system and use of --with-gmp. If it is, upstream
   asked for it to be reported and they will fix it.
 
+- Removes additional patches for now--we would like to focus on being
+  able to work with a system GAP as much as possible.
+
 - Revert #19726 (not needed anymore)
 
-Status: currently broken  - crashes deep inside GAP error handling system after few simple commands. 
+### Status
+Currently broken - crashes deep inside GAP error handling system after few simple commands. 
 
 Basic tests on libgap:
 
@@ -45,25 +53,30 @@
 ```
 Current status: lots of errors
 
+- Still have some miscellaneous segfaults and other weird crashes
+
+- Still have work to do on improving error handling; replacing the built-in `ErrorInner` function might help here.
+
+- SIGINT handling by Python is broken by `GAP_Intialize`; need to work around this.
+
 Testing packages with dynamic loading (e.g. IO):
 
 Install IO:
 
 ```
-cd $SAGE/local/gap/latest/pkg
-wget http://www.gap-system.org/pub/gap/gap4/tar.gz/packages/io-4.4.6.tar.gz
-tar xvf /tmp/io-4.4.6.tar.gz
-mv io-4.4.6 io
-cd io
-./configure
+cd $SAGE_LOCAL/share/gap/pkg
+wget https://www.gap-system.org/pub/gap/gap4/tar.gz/packages/io-4.5.4.tar.gz
+tar xvf io-4.5.4.tar.gz
+cd io-4.5.4
+./configure --with-gaproot=../..
 make
 ```
 
 Test it locally:
 
 ```
-cd ../..
-./gap -l .
+cd $SAGE_ROOT
+gap
 gap> LoadPackage("IO");
 true
 ```
@@ -71,14 +84,35 @@
 This does not yet work:
 
 ```
-sage: libgap.LoadPackage("IO")
-ValueError: libGAP: Error, module '/opt/sage-git/local/gap/latest/pkg/io/bin/x86_64-pc-linux-gnu-gcc-default64/io.so' not found
+#W dlopen() error: /home/embray/src/sagemath/sage/local/share/gap/pkg/io-4.5.4/bin/x86_64-pc-linux-gnu-default64/io.so: undefine\
+d symbol: ChangedBags
+Error, module '/home/embray/src/sagemath/sage/local/share/gap/pkg/io-4.5.4/bin/x86_64-pc-linux-gnu-default64/io.so' not found
+Error, was not in any namespace
+Syntax warning: Unbound global variable in /home/embray/src/sagemath/sage/local/share/gap/lib/init.g:803
+    ColorPrompt( UserPreference( "UseColorPrompt" ) );
+               ^
+Error, SetGasmanMessageStatus: function is not yet defined
+true
 ```
-This should be fixed once GAP's gap binary is built on top of libgap.
-See: https://github.com/markuspf/gap/issues/1.
+~~This should be fixed once GAP's gap binary is built on top of libgap.
+See: https://github.com/markuspf/gap/issues/1~~ I believe this is fixed, but there are still some problems with the way this ticket is "installing" GAP for `$SAGE_LOCAL`.
 
 Note:
 
 - Max Horn reviewed the list of GAP symbols we use in Sage; some have already changed in 4.9. See this [pad](https://hackmd.io/emNi76svSWCh1fBeLKqPdA?edit#) for notes.
 
+
+### Upstream PRs
+
+A few pull requests we made to improve use of GAP as a library:
+
+* https://github.com/gap-system/gap/pull/3043
+* https://github.com/gap-system/gap/pull/3072
+
+Some other PRs useful to this effort:
+
+* https://github.com/gap-system/gap/pull/3065
+* https://github.com/gap-system/gap/pull/2952
+
+
 **Tarball**: https://www.gap-system.org/pub/gap/gap-4.10/tar.gz/gap-4.10.0.tar.gz
``````




---

archive/issue_comments_423499.json:
```json
{
    "body": "<a id='comment:5'></a>\nI think at least some of the problems I'm having now are related to the issue that the old [writeandcheck](https://trac.sagemath.org/ticket/13211#comment:163) patch was intended to fix.  I removed that patch just to see if it was still needed and it seems very much like it is.  That issue is also closely related to the issue I opened here: https://github.com/gap-system/gap/issues/3028\n\nI'm going to try re-applying the patch to see if it fixes any of the known problems I'm having, and then will work with the GAP team to find a fix that's acceptable to them.  It's definitely a bug in GAP regardless of interaction with Sage.",
    "created_at": "2018-11-30T13:39:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423499",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>
I think at least some of the problems I'm having now are related to the issue that the old [writeandcheck](https://trac.sagemath.org/ticket/13211#comment:163) patch was intended to fix.  I removed that patch just to see if it was still needed and it seems very much like it is.  That issue is also closely related to the issue I opened here: https://github.com/gap-system/gap/issues/3028

I'm going to try re-applying the patch to see if it fixes any of the known problems I'm having, and then will work with the GAP team to find a fix that's acceptable to them.  It's definitely a bug in GAP regardless of interaction with Sage.



---

archive/issue_comments_423500.json:
```json
{
    "body": "<a id='comment:6'></a>\nso that's something renamed to `echoandcheck()`, right?",
    "created_at": "2018-11-30T13:50:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423500",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:6'></a>
so that's something renamed to `echoandcheck()`, right?



---

archive/issue_comments_423501.json:
```json
{
    "body": "<a id='comment:7'></a>\nThere's now `echoandcheck` and `SyWriteandcheck` where are *nearly* exact duplicates of each other except for a minor difference.  The latter seems to be more directly affected but `echoandcheck` might be too.\n\nI cobbled together an updated version of Jeroen's original patch for this, though I'm not exactly sure if that version is gonna fly, since I think there is some deeper cleanup of error handling needed.\n\nThe updated patch seems to have helped with some issues, but not others that I was hoping it might fix... :/",
    "created_at": "2018-11-30T15:15:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423501",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>
There's now `echoandcheck` and `SyWriteandcheck` where are *nearly* exact duplicates of each other except for a minor difference.  The latter seems to be more directly affected but `echoandcheck` might be too.

I cobbled together an updated version of Jeroen's original patch for this, though I'm not exactly sure if that version is gonna fly, since I think there is some deeper cleanup of error handling needed.

The updated patch seems to have helped with some issues, but not others that I was hoping it might fix... :/



---

archive/issue_comments_423502.json:
```json
{
    "body": "<a id='comment:8'></a>\nDefinitely having some problems with gap + fork() and/or multiprocessing in general.  Not exactly sure what the deal is yet.",
    "created_at": "2018-11-30T15:51:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423502",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>
Definitely having some problems with gap + fork() and/or multiprocessing in general.  Not exactly sure what the deal is yet.



---

archive/issue_comments_423503.json:
```json
{
    "body": "<a id='comment:9'></a>\nWell, are you on Windows? This might be an extra weight to carry around...",
    "created_at": "2018-11-30T15:53:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423503",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:9'></a>
Well, are you on Windows? This might be an extra weight to carry around...



---

archive/issue_comments_423504.json:
```json
{
    "body": "<a id='comment:0'></a>\nNope.\n\nInteresting; I see now that there is some evil interaction between libgap and libecl (either the actual library or something to do with Sage's wrapper around it).  Will investigate more next week.",
    "created_at": "2018-11-30T16:11:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423504",
    "user": "https://github.com/embray"
}
```

<a id='comment:0'></a>
Nope.

Interesting; I see now that there is some evil interaction between libgap and libecl (either the actual library or something to do with Sage's wrapper around it).  Will investigate more next week.



---

archive/issue_comments_423505.json:
```json
{
    "body": "<a id='comment:1'></a>\nAh, if libgap happens to be initialized before libecl this is what happens:\n\n```\n/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/interfaces/maxima_lib.py in <module>()\n     91 from sage.symbolic.ring import SR\n     92\n---> 93 from sage.libs.ecl import EclObject, ecl_eval\n     94\n     95 from .maxima_abstract import (MaximaAbstract, MaximaAbstractFunction,\n\n/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/libs/ecl.pyx in init sage.libs.ecl (build/cythonized/sage/libs/ecl.c:13344)()\n   1342     return ecl_wrap(o)\n   1343\n-> 1344 init_ecl()\n\n/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/libs/ecl.pyx in sage.libs.ecl.init_ecl (build/cythonized/sage/libs/ecl.c:5603)()\n    271     cdef sigaction_t sig_test\n    272     sigaction(SIGCHLD, NULL, &sig_test)\n--> 273     assert sage_action[SIGCHLD].sa_handler == NULL  # Sage does not set SIGCHLD handler\n    274     assert sig_test.sa_handler == NULL              # And ECL bootup did not set one\n```\n\nHowever, under some circumstances (I reproduced this under pdb) the `AssertionError` is being caught and ignored, so libecl initialization is incomplete and broken.  Future ecl calls result in a segfault.  Neat!",
    "created_at": "2018-11-30T16:26:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423505",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>
Ah, if libgap happens to be initialized before libecl this is what happens:

```
/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/interfaces/maxima_lib.py in <module>()
     91 from sage.symbolic.ring import SR
     92
---> 93 from sage.libs.ecl import EclObject, ecl_eval
     94
     95 from .maxima_abstract import (MaximaAbstract, MaximaAbstractFunction,

/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/libs/ecl.pyx in init sage.libs.ecl (build/cythonized/sage/libs/ecl.c:13344)()
   1342     return ecl_wrap(o)
   1343
-> 1344 init_ecl()

/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/libs/ecl.pyx in sage.libs.ecl.init_ecl (build/cythonized/sage/libs/ecl.c:5603)()
    271     cdef sigaction_t sig_test
    272     sigaction(SIGCHLD, NULL, &sig_test)
--> 273     assert sage_action[SIGCHLD].sa_handler == NULL  # Sage does not set SIGCHLD handler
    274     assert sig_test.sa_handler == NULL              # And ECL bootup did not set one
```

However, under some circumstances (I reproduced this under pdb) the `AssertionError` is being caught and ignored, so libecl initialization is incomplete and broken.  Future ecl calls result in a segfault.  Neat!



---

archive/issue_comments_423506.json:
```json
{
    "body": "<a id='comment:2'></a>\nI didn't notice this before since it's set up by the `InitKernel` function in one of the GAP kernel modules (`src/iostream.c`), but GAP also installs its own special `SIGCHLD` handler, which it does even if it hasn't started any child processes.\n\nWe still want GAP to be able to clean up whatever I/O-related state it cleans up in this SIGCHLD handler.  This need was anticipated somewhat in a `CheckChildStatusChanged` function that is not used by GAP itself, but made available for wrapping by applications that set their own `SIGCHLD` handler.  This may need to be made available by the libgap API.   I still need to think more about how best to handle this in Sage though.  It would also be nice if Cysignals had a helper, in the form of a context manager perhaps, to save restore all registered signal handlers.\n\nIn any case, for now, just disabling GAP's `SIGCHLD` handler fixed most of the more severe problems I've been having.",
    "created_at": "2018-12-03T13:01:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423506",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>
I didn't notice this before since it's set up by the `InitKernel` function in one of the GAP kernel modules (`src/iostream.c`), but GAP also installs its own special `SIGCHLD` handler, which it does even if it hasn't started any child processes.

We still want GAP to be able to clean up whatever I/O-related state it cleans up in this SIGCHLD handler.  This need was anticipated somewhat in a `CheckChildStatusChanged` function that is not used by GAP itself, but made available for wrapping by applications that set their own `SIGCHLD` handler.  This may need to be made available by the libgap API.   I still need to think more about how best to handle this in Sage though.  It would also be nice if Cysignals had a helper, in the form of a context manager perhaps, to save restore all registered signal handlers.

In any case, for now, just disabling GAP's `SIGCHLD` handler fixed most of the more severe problems I've been having.



---

archive/issue_comments_423507.json:
```json
{
    "body": "<a id='comment:3'></a>\nStill have a number of doctests failing, but a lot more of them seem to have to do with changes to GAP itself, rather than with the interface to it.  I'm not completely positive about that though.  I need to go through the failing tests and classify the types of errors.  Still a few segfaults--I suspect mostly to do with the problems with garbage collection of stack local variables (see #22626#comment:252)",
    "created_at": "2018-12-03T13:04:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423507",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>
Still have a number of doctests failing, but a lot more of them seem to have to do with changes to GAP itself, rather than with the interface to it.  I'm not completely positive about that though.  I need to go through the failing tests and classify the types of errors.  Still a few segfaults--I suspect mostly to do with the problems with garbage collection of stack local variables (see #22626#comment:252)



---

archive/issue_comments_423508.json:
```json
{
    "body": "<a id='comment:4'></a>\nOK, this all sounds very promising! \n\nSorry for actually removing all these libgap_enter/exit pairs, it seems we need to put them back in now...",
    "created_at": "2018-12-03T16:45:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423508",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:4'></a>
OK, this all sounds very promising! 

Sorry for actually removing all these libgap_enter/exit pairs, it seems we need to put them back in now...



---

archive/issue_comments_423509.json:
```json
{
    "body": "<a id='comment:5'></a>\nI tried to describe the issue with premature garbage collection of stack local variables here: https://github.com/gap-system/gap/issues/3089  I'm still not 100% sure that this is the cause for some of the problems I'm seeing and need to try to perform a more careful analysis of a real-world case of this.  But I'm not sure what else would be causing some of the problems I'm seeing with objects being randomly replaced with other objects.",
    "created_at": "2018-12-05T12:04:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423509",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>
I tried to describe the issue with premature garbage collection of stack local variables here: https://github.com/gap-system/gap/issues/3089  I'm still not 100% sure that this is the cause for some of the problems I'm seeing and need to try to perform a more careful analysis of a real-world case of this.  But I'm not sure what else would be causing some of the problems I'm seeing with objects being randomly replaced with other objects.



---

archive/issue_comments_423510.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -109,6 +109,12 @@\n * https://github.com/gap-system/gap/pull/3043\n * https://github.com/gap-system/gap/pull/3072\n \n+Other open issues that don't have PRs yet:\n+\n+* https://github.com/gap-system/gap/issues/3089\n+* https://github.com/gap-system/gap/issues/3030\n+* https://github.com/gap-system/gap/issues/3028\n+\n Some other PRs useful to this effort:\n \n * https://github.com/gap-system/gap/pull/3065\n``````\n",
    "created_at": "2018-12-05T12:04:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423510",
    "user": "https://github.com/embray"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -109,6 +109,12 @@
 * https://github.com/gap-system/gap/pull/3043
 * https://github.com/gap-system/gap/pull/3072
 
+Other open issues that don't have PRs yet:
+
+* https://github.com/gap-system/gap/issues/3089
+* https://github.com/gap-system/gap/issues/3030
+* https://github.com/gap-system/gap/issues/3028
+
 Some other PRs useful to this effort:
 
 * https://github.com/gap-system/gap/pull/3065
``````




---

archive/issue_comments_423511.json:
```json
{
    "body": "<a id='comment:6'></a>\nAlright, I came up with some `GAP_Enter` and `GAP_Leave` macros--partially inspired by cysignals and partially by Volker's libgap--that handle both setting the stack bottom, and setting a `sigsetjmp` buffer for catching unhandled `ReadJmpError` errors from GAP.  \n\nI'm still running a `ptestlong` on Sage, and while there are still some failures these seem to have more to do with intentional changes to GAP, and for the most part are not severe errors (I'm not seeing any segfaults or other such oddities yet: I think we have the stack handling to thank for that).  \n\nThere are also still some problems with broken handling of syntax errors.  I think that will be fixed, at least partially, by https://github.com/gap-system/gap/pull/3043",
    "created_at": "2018-12-05T16:17:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423511",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>
Alright, I came up with some `GAP_Enter` and `GAP_Leave` macros--partially inspired by cysignals and partially by Volker's libgap--that handle both setting the stack bottom, and setting a `sigsetjmp` buffer for catching unhandled `ReadJmpError` errors from GAP.  

I'm still running a `ptestlong` on Sage, and while there are still some failures these seem to have more to do with intentional changes to GAP, and for the most part are not severe errors (I'm not seeing any segfaults or other such oddities yet: I think we have the stack handling to thank for that).  

There are also still some problems with broken handling of syntax errors.  I think that will be fixed, at least partially, by https://github.com/gap-system/gap/pull/3043



---

archive/issue_comments_423512.json:
```json
{
    "body": "<a id='comment:7'></a>\nI'd be happy fixing maths-related things in doctests, but I need your branch...",
    "created_at": "2018-12-05T16:30:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423512",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:7'></a>
I'd be happy fixing maths-related things in doctests, but I need your branch...



---

archive/issue_comments_423513.json:
```json
{
    "body": "<a id='comment:8'></a>\nI need to clean some things up; I'll work on that today.  It also needs some custom patches to GAP, unfortunately...  Fortunately they are patches that should be acceptable, in some form or other, upstream as well.\n\nLast night I ran a `make ptestlong` against my current branches and am down to the following failures:\n\n```\nsage -t --long src/sage/groups/matrix_gps/finitely_generated.py  # Bad exit: 1\nsage -t --long src/sage/combinat/tiling.py  # 1 doctest failed\nsage -t --long src/sage/graphs/strongly_regular_db.pyx  # 1 doctest failed\nsage -t --long src/sage/coding/linear_code.py  # 4 doctests failed\nsage -t --long src/sage/groups/perm_gps/permgroup.py  # 3 doctests failed\nsage -t --long src/sage/homology/examples.py  # 1 doctest failed\nsage -t --long src/sage/homology/simplicial_set.py  # 1 doctest failed\nsage -t --long src/doc/en/thematic_tutorials/group_theory.rst  # 3 doctests failed\nsage -t --long src/sage/combinat/symmetric_group_algebra.py  # 1 doctest failed\nsage -t --long src/sage/knots/link.py  # 1 doctest failed\nsage -t --long src/sage/coding/codecan/autgroup_can_label.pyx  # 1 doctest failed\nsage -t --long src/sage/groups/braid.py  # 1 doctest failed\nsage -t --long src/sage/tests/books/judson-abstract-algebra/sylow-sage.py  # 1 doctest failed\nsage -t --long src/sage/groups/finitely_presented.py  # 5 doctests failed\nsage -t --long src/sage/groups/finitely_presented_named.py  # 3 doctests failed\nsage -t --long src/sage/categories/modules_with_basis.py  # 1 doctest failed\nsage -t --long src/sage/combinat/root_system/root_system.py  # 2 doctests failed\nsage -t --long src/sage/combinat/root_system/hecke_algebra_representation.py  # 1 doctest failed\nsage -t --long src/doc/en/thematic_tutorials/lie/weyl_groups.rst  # 1 doctest failed\nsage -t --long src/sage/categories/simplicial_sets.py  # 1 doctest failed\nsage -t --long src/sage/groups/matrix_gps/coxeter_group.py  # 1 doctest failed\nsage -t --long src/sage/libs/gap/util.pyx  # 7 doctests failed\nsage -t --long src/sage/combinat/matrices/hadamard_matrix.py  # 1 doctest failed\nsage -t --long src/doc/en/constructions/groups.rst  # 4 doctests failed\nsage -t --long src/doc/ja/tutorial/tour_groups.rst  # 1 doctest failed\nsage -t --long src/sage/groups/matrix_gps/linear.py  # 1 doctest failed\nsage -t --long src/sage/groups/libgap_morphism.py  # 1 doctest failed\nsage -t --long src/sage/groups/matrix_gps/group_element.pyx  # 1 doctest failed\nsage -t --long src/sage/groups/abelian_gps/abelian_group_gap.py  # 1 doctest failed\nsage -t --long src/sage/libs/gap/operations.py  # 1 doctest failed\nsage -t --long src/sage/tests/gap_packages.py  # 4 doctests failed\nsage -t --long src/sage/misc/randstate.pyx  # 8 doctests failed\n```\n\nMost of these failures fall into a few different categories:\n\n1. Bugs caused by broken syntax error handling, which still needs some fixing.\n2. Minor bugs remaining in our GAP interface; in particular places where errors (besides syntax errors) seem to not be handled properly.  I think there are only a couple of these.\n3. Missing functionality that was removed from the branch but needs to be restored (particularly a couple test functions in `sage.libs.gap.util`).\n4. Tests that depend on some PRNG state that seem to be getting messed up by GAP somehow--I still need to investigate this.\n5. Tests that fail due to warnings from GAP that weren't present before.\n6. Tests that fail due to actually different mathematical results from GAP, which may still be valid, just different.",
    "created_at": "2018-12-06T10:20:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423513",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>
I need to clean some things up; I'll work on that today.  It also needs some custom patches to GAP, unfortunately...  Fortunately they are patches that should be acceptable, in some form or other, upstream as well.

Last night I ran a `make ptestlong` against my current branches and am down to the following failures:

```
sage -t --long src/sage/groups/matrix_gps/finitely_generated.py  # Bad exit: 1
sage -t --long src/sage/combinat/tiling.py  # 1 doctest failed
sage -t --long src/sage/graphs/strongly_regular_db.pyx  # 1 doctest failed
sage -t --long src/sage/coding/linear_code.py  # 4 doctests failed
sage -t --long src/sage/groups/perm_gps/permgroup.py  # 3 doctests failed
sage -t --long src/sage/homology/examples.py  # 1 doctest failed
sage -t --long src/sage/homology/simplicial_set.py  # 1 doctest failed
sage -t --long src/doc/en/thematic_tutorials/group_theory.rst  # 3 doctests failed
sage -t --long src/sage/combinat/symmetric_group_algebra.py  # 1 doctest failed
sage -t --long src/sage/knots/link.py  # 1 doctest failed
sage -t --long src/sage/coding/codecan/autgroup_can_label.pyx  # 1 doctest failed
sage -t --long src/sage/groups/braid.py  # 1 doctest failed
sage -t --long src/sage/tests/books/judson-abstract-algebra/sylow-sage.py  # 1 doctest failed
sage -t --long src/sage/groups/finitely_presented.py  # 5 doctests failed
sage -t --long src/sage/groups/finitely_presented_named.py  # 3 doctests failed
sage -t --long src/sage/categories/modules_with_basis.py  # 1 doctest failed
sage -t --long src/sage/combinat/root_system/root_system.py  # 2 doctests failed
sage -t --long src/sage/combinat/root_system/hecke_algebra_representation.py  # 1 doctest failed
sage -t --long src/doc/en/thematic_tutorials/lie/weyl_groups.rst  # 1 doctest failed
sage -t --long src/sage/categories/simplicial_sets.py  # 1 doctest failed
sage -t --long src/sage/groups/matrix_gps/coxeter_group.py  # 1 doctest failed
sage -t --long src/sage/libs/gap/util.pyx  # 7 doctests failed
sage -t --long src/sage/combinat/matrices/hadamard_matrix.py  # 1 doctest failed
sage -t --long src/doc/en/constructions/groups.rst  # 4 doctests failed
sage -t --long src/doc/ja/tutorial/tour_groups.rst  # 1 doctest failed
sage -t --long src/sage/groups/matrix_gps/linear.py  # 1 doctest failed
sage -t --long src/sage/groups/libgap_morphism.py  # 1 doctest failed
sage -t --long src/sage/groups/matrix_gps/group_element.pyx  # 1 doctest failed
sage -t --long src/sage/groups/abelian_gps/abelian_group_gap.py  # 1 doctest failed
sage -t --long src/sage/libs/gap/operations.py  # 1 doctest failed
sage -t --long src/sage/tests/gap_packages.py  # 4 doctests failed
sage -t --long src/sage/misc/randstate.pyx  # 8 doctests failed
```

Most of these failures fall into a few different categories:

1. Bugs caused by broken syntax error handling, which still needs some fixing.
2. Minor bugs remaining in our GAP interface; in particular places where errors (besides syntax errors) seem to not be handled properly.  I think there are only a couple of these.
3. Missing functionality that was removed from the branch but needs to be restored (particularly a couple test functions in `sage.libs.gap.util`).
4. Tests that depend on some PRNG state that seem to be getting messed up by GAP somehow--I still need to investigate this.
5. Tests that fail due to warnings from GAP that weren't present before.
6. Tests that fail due to actually different mathematical results from GAP, which may still be valid, just different.



---

archive/issue_comments_423514.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -108,6 +108,7 @@\n \n * https://github.com/gap-system/gap/pull/3043\n * https://github.com/gap-system/gap/pull/3072\n+* https://github.com/gap-system/gap/pull/3096\n \n Other open issues that don't have PRs yet:\n \n``````\n",
    "created_at": "2018-12-06T17:28:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423514",
    "user": "https://github.com/embray"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -108,6 +108,7 @@
 
 * https://github.com/gap-system/gap/pull/3043
 * https://github.com/gap-system/gap/pull/3072
+* https://github.com/gap-system/gap/pull/3096
 
 Other open issues that don't have PRs yet:
 
``````




---

archive/issue_comments_423515.json:
```json
{
    "body": "<a id='comment:9'></a>\nAdded a PR for my prototype `GAP_Enter/GAP_Leave` macros.   Still working on updating my branch here to something usable; I'll have to finish that tomorrow though.",
    "created_at": "2018-12-06T17:28:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423515",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>
Added a PR for my prototype `GAP_Enter/GAP_Leave` macros.   Still working on updating my branch here to something usable; I'll have to finish that tomorrow though.



---

archive/issue_comments_423516.json:
```json
{
    "body": "**Changing commit** from \"[7ccc120e3a606e044bdd9ef6835930075fa70a31](https://github.com/sagemath/sagetrac-mirror/commit/7ccc120e3a606e044bdd9ef6835930075fa70a31)\" to \"[18478b9e261e7f5a1c83de6c08916fdea9c9851a](https://github.com/sagemath/sagetrac-mirror/commit/18478b9e261e7f5a1c83de6c08916fdea9c9851a)\".",
    "created_at": "2018-12-06T17:28:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423516",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[7ccc120e3a606e044bdd9ef6835930075fa70a31](https://github.com/sagemath/sagetrac-mirror/commit/7ccc120e3a606e044bdd9ef6835930075fa70a31)" to "[18478b9e261e7f5a1c83de6c08916fdea9c9851a](https://github.com/sagemath/sagetrac-mirror/commit/18478b9e261e7f5a1c83de6c08916fdea9c9851a)".



---

archive/issue_comments_423517.json:
```json
{
    "body": "<a id='comment:0'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/14be074818514239ddff74bafc9b77d7f2c3f844\">14be074</a></td><td><code>this appears to be an expected difference in the results GAP gives for NormalSubgroups(SymmetricGroup(4))</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a2394d88e0b313567d9f6f3a6196adc61fc27405\">a2394d8</a></td><td><code>should include sysinfo.gap; fix small bug in chmod call</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/fc959ecbeffcb62f3c3352b3d39f46d9dd740401\">fc959ec</a></td><td><code>minor cleanup in sage.interfaces.gap</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6433be8d030ef3f719e9eb98beffc040c142f1ba\">6433be8</a></td><td><code>ensure readline is disabled</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8a0696ee688ab8003189a270c44c96ab4a7aaa5a\">8a0696e</a></td><td><code>some fixes to doc parsing</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8228bace651aa07f71baca218d89b8d83e72a9a0\">8228bac</a></td><td><code>ensure that the xgap package is not loaded</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/aa33f74b6da78f76b78b9dcca1ccab7b169027c9\">aa33f74</a></td><td><code>whitespace; trivial</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/18478b9e261e7f5a1c83de6c08916fdea9c9851a\">18478b9</a></td><td><code>significant cleanup of gap_includes.pxd</code></td></tr></table>\n",
    "created_at": "2018-12-06T17:28:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423517",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:0'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/14be074818514239ddff74bafc9b77d7f2c3f844">14be074</a></td><td><code>this appears to be an expected difference in the results GAP gives for NormalSubgroups(SymmetricGroup(4))</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a2394d88e0b313567d9f6f3a6196adc61fc27405">a2394d8</a></td><td><code>should include sysinfo.gap; fix small bug in chmod call</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/fc959ecbeffcb62f3c3352b3d39f46d9dd740401">fc959ec</a></td><td><code>minor cleanup in sage.interfaces.gap</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6433be8d030ef3f719e9eb98beffc040c142f1ba">6433be8</a></td><td><code>ensure readline is disabled</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8a0696ee688ab8003189a270c44c96ab4a7aaa5a">8a0696e</a></td><td><code>some fixes to doc parsing</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8228bace651aa07f71baca218d89b8d83e72a9a0">8228bac</a></td><td><code>ensure that the xgap package is not loaded</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/aa33f74b6da78f76b78b9dcca1ccab7b169027c9">aa33f74</a></td><td><code>whitespace; trivial</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/18478b9e261e7f5a1c83de6c08916fdea9c9851a">18478b9</a></td><td><code>significant cleanup of gap_includes.pxd</code></td></tr></table>




---

archive/issue_comments_423518.json:
```json
{
    "body": "<a id='comment:1'></a>\nSo what's the conclusion on the error/interrupt handling? That discussion seems to have ended abruptly.",
    "created_at": "2018-12-06T21:21:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423518",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:1'></a>
So what's the conclusion on the error/interrupt handling? That discussion seems to have ended abruptly.



---

archive/issue_comments_423519.json:
```json
{
    "body": "<a id='comment:2'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **Last 10 new commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/98baa3c94dd88e9ca4629338d555b81a806e9f42\">98baa3c</a></td><td><code>significant cleanup of gap_includes.pxd</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7239725e524a83540bdb98a53d2e164d4056f404\">7239725</a></td><td><code>this file is no longer needed since I'm patching GAP with this functionality instead</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1dc74b2d05dec90bd5f97001e1c8b80e6be705fe\">1dc74b2</a></td><td><code>speed up this code up a little bit</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/47968d3c6933215a276c32fde4d2ccd5356987d9\">47968d3</a></td><td><code>use ViewObj instead of ViewString</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9231e56be596ede9391286894ab30b841339907b\">9231e56</a></td><td><code>use more GAP_Enter() and GAP_Leave() where it seems appropriate</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/11f52b713492864409c8dd5b728d862ba21cfa02\">11f52b7</a></td><td><code>fix some tests whose output changed since</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f176451c9aceaff6cde7930624a7aba83ea710b3\">f176451</a></td><td><code>fix needed due to changes in record keys</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e7dc33d12a024dcde296b2af5a6f289e09a5930c\">e7dc33d</a></td><td><code>minor test fixes and cleanup</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/17371cbe0ce0a06cb5d3a87aaa25dff19620ba1c\">17371cb</a></td><td><code>use changesignal to restore SIGCHLD and SIGINT handling</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b7f6221a8590b0cc821e5dd8bce7abd0bea854ad\">b7f6221</a></td><td><code>remove this debug function for now</code></td></tr></table>\n",
    "created_at": "2018-12-07T14:48:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423519",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **Last 10 new commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/98baa3c94dd88e9ca4629338d555b81a806e9f42">98baa3c</a></td><td><code>significant cleanup of gap_includes.pxd</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7239725e524a83540bdb98a53d2e164d4056f404">7239725</a></td><td><code>this file is no longer needed since I'm patching GAP with this functionality instead</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1dc74b2d05dec90bd5f97001e1c8b80e6be705fe">1dc74b2</a></td><td><code>speed up this code up a little bit</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/47968d3c6933215a276c32fde4d2ccd5356987d9">47968d3</a></td><td><code>use ViewObj instead of ViewString</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9231e56be596ede9391286894ab30b841339907b">9231e56</a></td><td><code>use more GAP_Enter() and GAP_Leave() where it seems appropriate</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/11f52b713492864409c8dd5b728d862ba21cfa02">11f52b7</a></td><td><code>fix some tests whose output changed since</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f176451c9aceaff6cde7930624a7aba83ea710b3">f176451</a></td><td><code>fix needed due to changes in record keys</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e7dc33d12a024dcde296b2af5a6f289e09a5930c">e7dc33d</a></td><td><code>minor test fixes and cleanup</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/17371cbe0ce0a06cb5d3a87aaa25dff19620ba1c">17371cb</a></td><td><code>use changesignal to restore SIGCHLD and SIGINT handling</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b7f6221a8590b0cc821e5dd8bce7abd0bea854ad">b7f6221</a></td><td><code>remove this debug function for now</code></td></tr></table>




---

archive/issue_comments_423520.json:
```json
{
    "body": "**Changing commit** from \"[18478b9e261e7f5a1c83de6c08916fdea9c9851a](https://github.com/sagemath/sagetrac-mirror/commit/18478b9e261e7f5a1c83de6c08916fdea9c9851a)\" to \"[b7f6221a8590b0cc821e5dd8bce7abd0bea854ad](https://github.com/sagemath/sagetrac-mirror/commit/b7f6221a8590b0cc821e5dd8bce7abd0bea854ad)\".",
    "created_at": "2018-12-07T14:48:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423520",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[18478b9e261e7f5a1c83de6c08916fdea9c9851a](https://github.com/sagemath/sagetrac-mirror/commit/18478b9e261e7f5a1c83de6c08916fdea9c9851a)" to "[b7f6221a8590b0cc821e5dd8bce7abd0bea854ad](https://github.com/sagemath/sagetrac-mirror/commit/b7f6221a8590b0cc821e5dd8bce7abd0bea854ad)".



---

archive/issue_comments_423521.json:
```json
{
    "body": "<a id='comment:3'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **Last 10 new commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/20c62796333d3196871291f3df87662e67a9eb24\">20c6279</a></td><td><code>significant cleanup of gap_includes.pxd</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8b53d4f224bc523d7f821274fbb34deaf40f1786\">8b53d4f</a></td><td><code>this file is no longer needed since I'm patching GAP with this functionality instead</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/94f09a623d02d7b0313747e9a5b43f57fa04e27a\">94f09a6</a></td><td><code>speed up this code up a little bit</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f5713992e5af26255451b15c64dfd5d0043fd308\">f571399</a></td><td><code>use ViewObj instead of ViewString</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b106ff9d0386a00b56b2c7e54ee6ad898a08aa9b\">b106ff9</a></td><td><code>use more GAP_Enter() and GAP_Leave() where it seems appropriate</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/acc75fe53d371145a87a7e73449bc4c603de8340\">acc75fe</a></td><td><code>fix some tests whose output changed since</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e588e7a9a3dae7c90b7f88c5022ee8798c420928\">e588e7a</a></td><td><code>fix needed due to changes in record keys</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e11e4388648148a55026b46221fafe93e8c6e8a3\">e11e438</a></td><td><code>minor test fixes and cleanup</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b686acfe4f129d27e8e0bcf84f801bb166e4ed94\">b686acf</a></td><td><code>use changesignal to restore SIGCHLD and SIGINT handling</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/09d229f1db78ff96d6b46df9ffad22d03155c2c8\">09d229f</a></td><td><code>remove this debug function for now</code></td></tr></table>\n",
    "created_at": "2018-12-07T14:51:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423521",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **Last 10 new commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/20c62796333d3196871291f3df87662e67a9eb24">20c6279</a></td><td><code>significant cleanup of gap_includes.pxd</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8b53d4f224bc523d7f821274fbb34deaf40f1786">8b53d4f</a></td><td><code>this file is no longer needed since I'm patching GAP with this functionality instead</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/94f09a623d02d7b0313747e9a5b43f57fa04e27a">94f09a6</a></td><td><code>speed up this code up a little bit</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f5713992e5af26255451b15c64dfd5d0043fd308">f571399</a></td><td><code>use ViewObj instead of ViewString</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b106ff9d0386a00b56b2c7e54ee6ad898a08aa9b">b106ff9</a></td><td><code>use more GAP_Enter() and GAP_Leave() where it seems appropriate</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/acc75fe53d371145a87a7e73449bc4c603de8340">acc75fe</a></td><td><code>fix some tests whose output changed since</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e588e7a9a3dae7c90b7f88c5022ee8798c420928">e588e7a</a></td><td><code>fix needed due to changes in record keys</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e11e4388648148a55026b46221fafe93e8c6e8a3">e11e438</a></td><td><code>minor test fixes and cleanup</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b686acfe4f129d27e8e0bcf84f801bb166e4ed94">b686acf</a></td><td><code>use changesignal to restore SIGCHLD and SIGINT handling</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/09d229f1db78ff96d6b46df9ffad22d03155c2c8">09d229f</a></td><td><code>remove this debug function for now</code></td></tr></table>




---

archive/issue_comments_423522.json:
```json
{
    "body": "**Changing commit** from \"[b7f6221a8590b0cc821e5dd8bce7abd0bea854ad](https://github.com/sagemath/sagetrac-mirror/commit/b7f6221a8590b0cc821e5dd8bce7abd0bea854ad)\" to \"[09d229f1db78ff96d6b46df9ffad22d03155c2c8](https://github.com/sagemath/sagetrac-mirror/commit/09d229f1db78ff96d6b46df9ffad22d03155c2c8)\".",
    "created_at": "2018-12-07T14:51:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423522",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[b7f6221a8590b0cc821e5dd8bce7abd0bea854ad](https://github.com/sagemath/sagetrac-mirror/commit/b7f6221a8590b0cc821e5dd8bce7abd0bea854ad)" to "[09d229f1db78ff96d6b46df9ffad22d03155c2c8](https://github.com/sagemath/sagetrac-mirror/commit/09d229f1db78ff96d6b46df9ffad22d03155c2c8)".



---

archive/issue_comments_423523.json:
```json
{
    "body": "<a id='comment:4'></a>\nFinished committing all my changes so far, and rebased on 8.5.beta6, so this *should* be buildable and usable.  I included the absolutely necessary patches to GAP that are needed so far so that it will work; I will hope to get these, or some version of them, in GAP 4.10.1.  In case anyone wants to look at the remaining test failures.",
    "created_at": "2018-12-07T14:54:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423523",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>
Finished committing all my changes so far, and rebased on 8.5.beta6, so this *should* be buildable and usable.  I included the absolutely necessary patches to GAP that are needed so far so that it will work; I will hope to get these, or some version of them, in GAP 4.10.1.  In case anyone wants to look at the remaining test failures.



---

archive/issue_comments_423524.json:
```json
{
    "body": "<a id='comment:315'></a>\nReplying to [jdemeyer](#comment%3A311):\n> So what's the conclusion on the error/interrupt handling? That discussion seems to have ended abruptly.\n\n\nThere are multiple issues pertaining to error handling and interrupts, so I'm not sure at this point exactly to which you refer.  But to give a brief summary of some of the issues that have been addressed:\n\n1. Right now I'm using `changesignal` from cysignals to unset (and restore originals, if any) the `SIGINT` and `SIGCHLD` handlers installed by GAP during its initialization.  It would be nice to have [another way to do this](https://github.com/sagemath/cysignals/issues/101) but the current method works well-enough.  I would also like to [patch GAP](https://github.com/gap-system/gap/pull/3072) so that this isn't needed in the first place.\n   * Related: Since GAP is now not using its own `SIGINT` handler we still wrap all calls to the GAP API with `sig_on()/sig_off()` as this will handle async interrupts, as well as any other unhandled exceptions from GAP.  This is not completely ideal because it means it may be possible to interrupt GAP in critical sections possibly without giving GAP the opportunity to perform its normal interrupt handling.  But AFAICT maybe this isn't such a problem--this was true of the old libgap as well so nothing has really changed here.\n\n2. The `GAP_Enter()` and `GAP_Error_Setjmp()` macro ensures that if a \"read error\" occurs in GAP--any error that results in a longjmp--that is not already explicitly handled within GAP (e.g. with a `TRY_IF_NO_ERROR` macro), there is a sane place to jump to back in our code.  A Python exception is also set which can be checked by Cython code.  So in other words as long as any GAP code is surrounded by something like:\n\n    ```\n    try:\n        GAP_Error_Setjmp()  # Or GAP_Enter()\n        <libgap calls go here>\n    except RuntimeError:\n        ...\n    ```\n\n   The resulting `RuntimeError` will be handled.  As mentioned in the first point, I still also recommend wrapping all this in `sig_on()/sig_off()` too, as with most any C library code.\n\n   This also requires a [patch to GAP](https://github.com/gap-system/gap/pull/3096) that I hope to get some form of in 4.10.1.  I was also able to get this working (the error handling) without a patch, but the need for managing the \"stack bottom\" is great enough that we need *that* patch at the very least, and it might as well have the error handling combined into it.\n\nGAP still could use significant refactoring to its error handling and I have some vague plans for that.  Though the week before last I spent time investigating how much work that might take, and it's not insignificant, so I didn't want to go down a rabbit hole when there were practical solutions for dealing with what we have now.",
    "created_at": "2018-12-07T15:17:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423524",
    "user": "https://github.com/embray"
}
```

<a id='comment:315'></a>
Replying to [jdemeyer](#comment%3A311):
> So what's the conclusion on the error/interrupt handling? That discussion seems to have ended abruptly.


There are multiple issues pertaining to error handling and interrupts, so I'm not sure at this point exactly to which you refer.  But to give a brief summary of some of the issues that have been addressed:

1. Right now I'm using `changesignal` from cysignals to unset (and restore originals, if any) the `SIGINT` and `SIGCHLD` handlers installed by GAP during its initialization.  It would be nice to have [another way to do this](https://github.com/sagemath/cysignals/issues/101) but the current method works well-enough.  I would also like to [patch GAP](https://github.com/gap-system/gap/pull/3072) so that this isn't needed in the first place.
   * Related: Since GAP is now not using its own `SIGINT` handler we still wrap all calls to the GAP API with `sig_on()/sig_off()` as this will handle async interrupts, as well as any other unhandled exceptions from GAP.  This is not completely ideal because it means it may be possible to interrupt GAP in critical sections possibly without giving GAP the opportunity to perform its normal interrupt handling.  But AFAICT maybe this isn't such a problem--this was true of the old libgap as well so nothing has really changed here.

2. The `GAP_Enter()` and `GAP_Error_Setjmp()` macro ensures that if a "read error" occurs in GAP--any error that results in a longjmp--that is not already explicitly handled within GAP (e.g. with a `TRY_IF_NO_ERROR` macro), there is a sane place to jump to back in our code.  A Python exception is also set which can be checked by Cython code.  So in other words as long as any GAP code is surrounded by something like:

    ```
    try:
        GAP_Error_Setjmp()  # Or GAP_Enter()
        <libgap calls go here>
    except RuntimeError:
        ...
    ```

   The resulting `RuntimeError` will be handled.  As mentioned in the first point, I still also recommend wrapping all this in `sig_on()/sig_off()` too, as with most any C library code.

   This also requires a [patch to GAP](https://github.com/gap-system/gap/pull/3096) that I hope to get some form of in 4.10.1.  I was also able to get this working (the error handling) without a patch, but the need for managing the "stack bottom" is great enough that we need *that* patch at the very least, and it might as well have the error handling combined into it.

GAP still could use significant refactoring to its error handling and I have some vague plans for that.  Though the week before last I spent time investigating how much work that might take, and it's not insignificant, so I didn't want to go down a rabbit hole when there were practical solutions for dealing with what we have now.



---

archive/issue_comments_423525.json:
```json
{
    "body": "<a id='comment:316'></a>\nReplying to [embray](#comment%3A308):\n> 4. Tests that depend on some PRNG state that seem to be getting messed up by GAP somehow--I still need to investigate this.\n\n\nFor the tests that depend on pseudo-random results it seems GAP is actually not affecting results except for those that come from GAP itself.  It is no surprise that a new version of GAP might mean slightly different results from its own PRNGs and that's probably something we have no control over.  I just need to confirm that the different results are *only* due to changes internal to GAP (and are not affecting other PRNGs in Sage), and then update those tests.",
    "created_at": "2018-12-07T15:29:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423525",
    "user": "https://github.com/embray"
}
```

<a id='comment:316'></a>
Replying to [embray](#comment%3A308):
> 4. Tests that depend on some PRNG state that seem to be getting messed up by GAP somehow--I still need to investigate this.


For the tests that depend on pseudo-random results it seems GAP is actually not affecting results except for those that come from GAP itself.  It is no surprise that a new version of GAP might mean slightly different results from its own PRNGs and that's probably something we have no control over.  I just need to confirm that the different results are *only* due to changes internal to GAP (and are not affecting other PRNGs in Sage), and then update those tests.



---

archive/issue_comments_423526.json:
```json
{
    "body": "<a id='comment:7'></a>\nI'll look at the tests today/tomorrow",
    "created_at": "2018-12-07T15:32:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423526",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:7'></a>
I'll look at the tests today/tomorrow



---

archive/issue_comments_423527.json:
```json
{
    "body": "<a id='comment:8'></a>\nThanks for the update. I'm a bit bothered by the fact that we now need two `setjmp()` calls for GAP: one for cysignals and one for GAP itself. Of course, we should be happy that it works, it just doesn't feel right.",
    "created_at": "2018-12-07T15:41:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423527",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>
Thanks for the update. I'm a bit bothered by the fact that we now need two `setjmp()` calls for GAP: one for cysignals and one for GAP itself. Of course, we should be happy that it works, it just doesn't feel right.



---

archive/issue_comments_423528.json:
```json
{
    "body": "<a id='comment:9'></a>\nsagelib now does not build for me, the stuff with GAP's `T_INT`, `T_BOOL` etc has not made it into the patches it seems.\nI probably can edit headers in local/include/gap/ to work around this.\n\n```\n...\n[sagelib-8.5.beta6] [  3/373] gcc -fno-strict-aliasing -g -O2 -g -O0 -Wall -Wno-unused -fPIC -I./sage/groups/perm_gps/partn_ref2 -I./sage/cpython -I/mnt/opt/Sage/sage-dev/local/include -I/mnt/opt/Sage/sage-dev/local/include/python2.7 -I/mnt/opt/Sage/sage-dev/local/lib/python2.7/site-packages/numpy/core/include -I/mnt/opt/Sage/sage-dev/src -I/mnt/opt/Sage/sage-dev/src/sage/ext -Ibuild/cythonized -I/mnt/opt/Sage/sage-dev/local/include/python2.7 -c build/cythonized/sage/graphs/spanning_tree.c -o build/temp.linux-x86_64-2.7-pydebug/build/cythonized/sage/graphs/spanning_tree.o -fno-strict-aliasing -DCYTHON_CLINE_IN_TRACEBACK=1 -std=c99\n[sagelib-8.5.beta6] [  4/373] gcc -fno-strict-aliasing -g -O2 -g -O0 -Wall -Wno-unused -fPIC -I./sage/cpython -I./sage/libs/ntl -I/mnt/opt/Sage/sage-dev/local/lib/python2.7/site-packages/cysignals -I/mnt/opt/Sage/sage-dev/local/include -I/mnt/opt/Sage/sage-dev/local/include/python2.7 -I/mnt/opt/Sage/sage-dev/local/lib/python2.7/site-packages/numpy/core/include -I/mnt/opt/Sage/sage-dev/src -I/mnt/opt/Sage/sage-dev/src/sage/ext -Ibuild/cythonized -I/mnt/opt/Sage/sage-dev/local/include/python2.7 -c build/cythonized/sage/graphs/connectivity.c -o build/temp.linux-x86_64-2.7-pydebug/build/cythonized/sage/graphs/connectivity.o -fno-strict-aliasing -DCYTHON_CLINE_IN_TRACEBACK=1 -std=c99\n[sagelib-8.5.beta6] In file included from /mnt/opt/Sage/sage-dev/local/include/gap/system.h:27,\n[sagelib-8.5.beta6]                  from build/cythonized/sage/graphs/spanning_tree.c:660:\n[sagelib-8.5.beta6] /mnt/opt/Sage/sage-dev/local/include/gap/config.h:159: warning: \"HAVE_STAT\" redefined\n[sagelib-8.5.beta6]  #define HAVE_STAT 1\n[sagelib-8.5.beta6]  \n[sagelib-8.5.beta6] In file included from /mnt/opt/Sage/sage-dev/local/include/python2.7/Python.h:61,\n[sagelib-8.5.beta6]                  from build/cythonized/sage/graphs/spanning_tree.c:48:\n[sagelib-8.5.beta6] /mnt/opt/Sage/sage-dev/local/include/python2.7/pyport.h:374: note: this is the location of the previous definition\n[sagelib-8.5.beta6]  #define HAVE_STAT\n[sagelib-8.5.beta6]  \n[sagelib-8.5.beta6] In file included from build/cythonized/sage/graphs/spanning_tree.c:13041:\n[sagelib-8.5.beta6] /mnt/opt/Sage/sage-dev/local/include/python2.7/structmember.h:48:1: error: redeclaration of enumerator \u2018T_INT\u2019\n[sagelib-8.5.beta6]  T_INT   =       1,\n[sagelib-8.5.beta6]  ^~~~~\n[sagelib-8.5.beta6] In file included from /mnt/opt/Sage/sage-dev/local/include/gap/ariths.h:17,\n[sagelib-8.5.beta6]                  from build/cythonized/sage/graphs/spanning_tree.c:661:\n[sagelib-8.5.beta6] /mnt/opt/Sage/sage-dev/local/include/gap/objects.h:145:13: note: previous definition of \u2018T_INT\u2019 was here\n[sagelib-8.5.beta6]              T_INT,      // immediate\n[sagelib-8.5.beta6]              ^~~~~\n[sagelib-8.5.beta6] In file included from build/cythonized/sage/graphs/spanning_tree.c:13041:\n[sagelib-8.5.beta6] /mnt/opt/Sage/sage-dev/local/include/python2.7/structmember.h:52:1: error: redeclaration of enumerator \u2018T_STRING\u2019\n[sagelib-8.5.beta6]  T_STRING=       5,\n[sagelib-8.5.beta6]  ^~~~~~~~\n[sagelib-8.5.beta6] In file included from /mnt/opt/Sage/sage-dev/local/include/gap/ariths.h:17,\n[sagelib-8.5.beta6]                  from build/cythonized/sage/graphs/spanning_tree.c:661:\n[sagelib-8.5.beta6] /mnt/opt/Sage/sage-dev/local/include/gap/objects.h:211:28: note: previous definition of \u2018T_STRING\u2019 was here\n[sagelib-8.5.beta6]              NEXT_ENUM_EVEN(T_STRING),\n[sagelib-8.5.beta6]                             ^~~~~~~~\n[sagelib-8.5.beta6] /mnt/opt/Sage/sage-dev/local/include/gap/objects.h:84:5: note: in definition of macro \u2018NEXT_ENUM_EVEN\u2019\n[sagelib-8.5.beta6]      id = _##id##_pre + (_##id##_pre & 1)\n[sagelib-8.5.beta6]      ^~\n[sagelib-8.5.beta6] In file included from build/cythonized/sage/graphs/spanning_tree.c:13041:\n[sagelib-8.5.beta6] /mnt/opt/Sage/sage-dev/local/include/python2.7/structmember.h:55:1: error: redeclaration of enumerator \u2018T_CHAR\u2019\n[sagelib-8.5.beta6]  T_CHAR  =       7,       /* 1-character string */\n[sagelib-8.5.beta6]  ^~~~~~\n[sagelib-8.5.beta6] In file included from /mnt/opt/Sage/sage-dev/local/include/gap/ariths.h:17,\n[sagelib-8.5.beta6]                  from build/cythonized/sage/graphs/spanning_tree.c:661:\n[sagelib-8.5.beta6] /mnt/opt/Sage/sage-dev/local/include/gap/objects.h:161:9: note: previous definition of \u2018T_CHAR\u2019 was here\n[sagelib-8.5.beta6]          T_CHAR,\n[sagelib-8.5.beta6]          ^~~~~~\n[sagelib-8.5.beta6] In file included from build/cythonized/sage/graphs/spanning_tree.c:13041:\n[sagelib-8.5.beta6] /mnt/opt/Sage/sage-dev/local/include/python2.7/structmember.h:67:1: error: redeclaration of enumerator \u2018T_BOOL\u2019\n[sagelib-8.5.beta6]  T_BOOL   =      14,\n[sagelib-8.5.beta6]  ^~~~~~\n[sagelib-8.5.beta6] In file included from /mnt/opt/Sage/sage-dev/local/include/gap/ariths.h:17,\n[sagelib-8.5.beta6]                  from build/cythonized/sage/graphs/spanning_tree.c:661:\n[sagelib-8.5.beta6] /mnt/opt/Sage/sage-dev/local/include/gap/objects.h:160:9: note: previous definition of \u2018T_BOOL\u2019 was here\n[sagelib-8.5.beta6]          T_BOOL,\n[sagelib-8.5.beta6]          ^~~~~~\n...\n```",
    "created_at": "2018-12-07T16:09:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423528",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:9'></a>
sagelib now does not build for me, the stuff with GAP's `T_INT`, `T_BOOL` etc has not made it into the patches it seems.
I probably can edit headers in local/include/gap/ to work around this.

```
...
[sagelib-8.5.beta6] [  3/373] gcc -fno-strict-aliasing -g -O2 -g -O0 -Wall -Wno-unused -fPIC -I./sage/groups/perm_gps/partn_ref2 -I./sage/cpython -I/mnt/opt/Sage/sage-dev/local/include -I/mnt/opt/Sage/sage-dev/local/include/python2.7 -I/mnt/opt/Sage/sage-dev/local/lib/python2.7/site-packages/numpy/core/include -I/mnt/opt/Sage/sage-dev/src -I/mnt/opt/Sage/sage-dev/src/sage/ext -Ibuild/cythonized -I/mnt/opt/Sage/sage-dev/local/include/python2.7 -c build/cythonized/sage/graphs/spanning_tree.c -o build/temp.linux-x86_64-2.7-pydebug/build/cythonized/sage/graphs/spanning_tree.o -fno-strict-aliasing -DCYTHON_CLINE_IN_TRACEBACK=1 -std=c99
[sagelib-8.5.beta6] [  4/373] gcc -fno-strict-aliasing -g -O2 -g -O0 -Wall -Wno-unused -fPIC -I./sage/cpython -I./sage/libs/ntl -I/mnt/opt/Sage/sage-dev/local/lib/python2.7/site-packages/cysignals -I/mnt/opt/Sage/sage-dev/local/include -I/mnt/opt/Sage/sage-dev/local/include/python2.7 -I/mnt/opt/Sage/sage-dev/local/lib/python2.7/site-packages/numpy/core/include -I/mnt/opt/Sage/sage-dev/src -I/mnt/opt/Sage/sage-dev/src/sage/ext -Ibuild/cythonized -I/mnt/opt/Sage/sage-dev/local/include/python2.7 -c build/cythonized/sage/graphs/connectivity.c -o build/temp.linux-x86_64-2.7-pydebug/build/cythonized/sage/graphs/connectivity.o -fno-strict-aliasing -DCYTHON_CLINE_IN_TRACEBACK=1 -std=c99
[sagelib-8.5.beta6] In file included from /mnt/opt/Sage/sage-dev/local/include/gap/system.h:27,
[sagelib-8.5.beta6]                  from build/cythonized/sage/graphs/spanning_tree.c:660:
[sagelib-8.5.beta6] /mnt/opt/Sage/sage-dev/local/include/gap/config.h:159: warning: "HAVE_STAT" redefined
[sagelib-8.5.beta6]  #define HAVE_STAT 1
[sagelib-8.5.beta6]  
[sagelib-8.5.beta6] In file included from /mnt/opt/Sage/sage-dev/local/include/python2.7/Python.h:61,
[sagelib-8.5.beta6]                  from build/cythonized/sage/graphs/spanning_tree.c:48:
[sagelib-8.5.beta6] /mnt/opt/Sage/sage-dev/local/include/python2.7/pyport.h:374: note: this is the location of the previous definition
[sagelib-8.5.beta6]  #define HAVE_STAT
[sagelib-8.5.beta6]  
[sagelib-8.5.beta6] In file included from build/cythonized/sage/graphs/spanning_tree.c:13041:
[sagelib-8.5.beta6] /mnt/opt/Sage/sage-dev/local/include/python2.7/structmember.h:48:1: error: redeclaration of enumerator ‚ÄòT_INT‚Äô
[sagelib-8.5.beta6]  T_INT   =       1,
[sagelib-8.5.beta6]  ^~~~~
[sagelib-8.5.beta6] In file included from /mnt/opt/Sage/sage-dev/local/include/gap/ariths.h:17,
[sagelib-8.5.beta6]                  from build/cythonized/sage/graphs/spanning_tree.c:661:
[sagelib-8.5.beta6] /mnt/opt/Sage/sage-dev/local/include/gap/objects.h:145:13: note: previous definition of ‚ÄòT_INT‚Äô was here
[sagelib-8.5.beta6]              T_INT,      // immediate
[sagelib-8.5.beta6]              ^~~~~
[sagelib-8.5.beta6] In file included from build/cythonized/sage/graphs/spanning_tree.c:13041:
[sagelib-8.5.beta6] /mnt/opt/Sage/sage-dev/local/include/python2.7/structmember.h:52:1: error: redeclaration of enumerator ‚ÄòT_STRING‚Äô
[sagelib-8.5.beta6]  T_STRING=       5,
[sagelib-8.5.beta6]  ^~~~~~~~
[sagelib-8.5.beta6] In file included from /mnt/opt/Sage/sage-dev/local/include/gap/ariths.h:17,
[sagelib-8.5.beta6]                  from build/cythonized/sage/graphs/spanning_tree.c:661:
[sagelib-8.5.beta6] /mnt/opt/Sage/sage-dev/local/include/gap/objects.h:211:28: note: previous definition of ‚ÄòT_STRING‚Äô was here
[sagelib-8.5.beta6]              NEXT_ENUM_EVEN(T_STRING),
[sagelib-8.5.beta6]                             ^~~~~~~~
[sagelib-8.5.beta6] /mnt/opt/Sage/sage-dev/local/include/gap/objects.h:84:5: note: in definition of macro ‚ÄòNEXT_ENUM_EVEN‚Äô
[sagelib-8.5.beta6]      id = _##id##_pre + (_##id##_pre & 1)
[sagelib-8.5.beta6]      ^~
[sagelib-8.5.beta6] In file included from build/cythonized/sage/graphs/spanning_tree.c:13041:
[sagelib-8.5.beta6] /mnt/opt/Sage/sage-dev/local/include/python2.7/structmember.h:55:1: error: redeclaration of enumerator ‚ÄòT_CHAR‚Äô
[sagelib-8.5.beta6]  T_CHAR  =       7,       /* 1-character string */
[sagelib-8.5.beta6]  ^~~~~~
[sagelib-8.5.beta6] In file included from /mnt/opt/Sage/sage-dev/local/include/gap/ariths.h:17,
[sagelib-8.5.beta6]                  from build/cythonized/sage/graphs/spanning_tree.c:661:
[sagelib-8.5.beta6] /mnt/opt/Sage/sage-dev/local/include/gap/objects.h:161:9: note: previous definition of ‚ÄòT_CHAR‚Äô was here
[sagelib-8.5.beta6]          T_CHAR,
[sagelib-8.5.beta6]          ^~~~~~
[sagelib-8.5.beta6] In file included from build/cythonized/sage/graphs/spanning_tree.c:13041:
[sagelib-8.5.beta6] /mnt/opt/Sage/sage-dev/local/include/python2.7/structmember.h:67:1: error: redeclaration of enumerator ‚ÄòT_BOOL‚Äô
[sagelib-8.5.beta6]  T_BOOL   =      14,
[sagelib-8.5.beta6]  ^~~~~~
[sagelib-8.5.beta6] In file included from /mnt/opt/Sage/sage-dev/local/include/gap/ariths.h:17,
[sagelib-8.5.beta6]                  from build/cythonized/sage/graphs/spanning_tree.c:661:
[sagelib-8.5.beta6] /mnt/opt/Sage/sage-dev/local/include/gap/objects.h:160:9: note: previous definition of ‚ÄòT_BOOL‚Äô was here
[sagelib-8.5.beta6]          T_BOOL,
[sagelib-8.5.beta6]          ^~~~~~
...
```



---

archive/issue_comments_423529.json:
```json
{
    "body": "<a id='comment:0'></a>\nI thought that this shouldn't happen. I'll look into it.",
    "created_at": "2018-12-07T16:22:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423529",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:0'></a>
I thought that this shouldn't happen. I'll look into it.



---

archive/issue_comments_423530.json:
```json
{
    "body": "<a id='comment:1'></a>\nDima, you seem to have a different version of Python. My `structmember.h` looks different from yours. Any idea what is going on?",
    "created_at": "2018-12-07T16:24:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423530",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:1'></a>
Dima, you seem to have a different version of Python. My `structmember.h` looks different from yours. Any idea what is going on?



---

archive/issue_comments_423531.json:
```json
{
    "body": "<a id='comment:2'></a>\noops, sorry, my fault. On that tree I played around with headers to understand the problem better, and left in a header where I replaced #defines with enums...\n\nNow I reverted this, and it's back to normal, building, sorry for noise.",
    "created_at": "2018-12-07T16:34:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423531",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:2'></a>
oops, sorry, my fault. On that tree I played around with headers to understand the problem better, and left in a header where I replaced #defines with enums...

Now I reverted this, and it's back to normal, building, sorry for noise.



---

archive/issue_comments_423532.json:
```json
{
    "body": "<a id='comment:3'></a>\nAnother source of test failures I've found--possibly different from the PRNG differences--is that iteration order over a number of objects seems to be different; particularly iterating over some matrix groups.  I'm not sure why, or if it's expected.  But it seems mostly arbitrary--you get the same group elements just in a different order.  For example, in the case of:\n\n```\nsage: SGA = SymmetricGroupAlgebra(QQ, WeylGroup([\"A\",3], prefix='s'))\nsage: SGA.an_element()\n```\n\nI now get\n\n```\ns1*s2*s3 + 3*s3*s2 + 2*s3 + 1\n```\n\nwhere previously it returned\n\n```\n2*s1*s2*s3*s2*s1 + 3*s1*s2*s3*s1 + s1*s2*s3 + 1\n```\n\nThis is of course meant to be somewhat arbitrary, though it should be deterministic (and it *is*, the result just changed due to some change in GAP when iterating over the underlying matrix group).",
    "created_at": "2018-12-07T16:52:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423532",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>
Another source of test failures I've found--possibly different from the PRNG differences--is that iteration order over a number of objects seems to be different; particularly iterating over some matrix groups.  I'm not sure why, or if it's expected.  But it seems mostly arbitrary--you get the same group elements just in a different order.  For example, in the case of:

```
sage: SGA = SymmetricGroupAlgebra(QQ, WeylGroup(["A",3], prefix='s'))
sage: SGA.an_element()
```

I now get

```
s1*s2*s3 + 3*s3*s2 + 2*s3 + 1
```

where previously it returned

```
2*s1*s2*s3*s2*s1 + 3*s1*s2*s3*s1 + s1*s2*s3 + 1
```

This is of course meant to be somewhat arbitrary, though it should be deterministic (and it *is*, the result just changed due to some change in GAP when iterating over the underlying matrix group).



---

archive/issue_comments_423533.json:
```json
{
    "body": "<a id='comment:324'></a>\nReplying to [jdemeyer](#comment%3A318):\n> Thanks for the update. I'm a bit bothered by the fact that we now need two `setjmp()` calls for GAP: one for cysignals and one for GAP itself. Of course, we should be happy that it works, it just doesn't feel right.\n\n\nI don't like it either.  I *think* we could combine them into one, and I have some ideas for how to make that work via an enhancement to cysignals.  In the meantime it does work though.",
    "created_at": "2018-12-07T16:58:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423533",
    "user": "https://github.com/embray"
}
```

<a id='comment:324'></a>
Replying to [jdemeyer](#comment%3A318):
> Thanks for the update. I'm a bit bothered by the fact that we now need two `setjmp()` calls for GAP: one for cysignals and one for GAP itself. Of course, we should be happy that it works, it just doesn't feel right.


I don't like it either.  I *think* we could combine them into one, and I have some ideas for how to make that work via an enhancement to cysignals.  In the meantime it does work though.



---

archive/attachments_020893.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "groups.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket22626/groups.patch",
    "created_at": "2018-12-07T23:36:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/dimpase"
}
```



---

archive/issue_comments_423534.json:
```json
{
    "body": "patches for src/sage/groups/",
    "created_at": "2018-12-07T23:36:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423534",
    "user": "https://github.com/dimpase"
}
```

patches for src/sage/groups/



---

archive/issue_comments_423535.json:
```json
{
    "body": "<a id='comment:5'></a>\nattached fixes all the doctests in src/sage/groups/ (please apply them!)\nexcept one, which is trickier, and stems from broken support for sending to GAP matrices over inexact fields:\n\n```\nsage: m=matrix(CC, [[1,2],[3,4]])\nsage: libgap(m)\n---------------------------------------------------------------------------\nRuntimeError                              Traceback (most recent call last)\nRuntimeError: Error, Variable: 'Complex' must have a value\nException RuntimeError: \"Error, Variable: 'Complex' must have a value\" in 'sage.libs.gap.util.error_handler' ignored\nSyntax error: ; expected in stream:1\nComplex Field with 53 bits of precision;\n ^^^^^^^^^^^^^^^^^^^^\nError, Variable: 'bits' must have a value\nError, no method found! For debugging hints type ?Recovery from NoMethodFound\n...\nError, no 1st choice method found for `CloseStream' on 1 arguments\ngap: panic, could not open *errout*!\n```\n\n---\n**Edit:** it is just the broken error handling: the current Sage behaviour for this is\n\n```\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n...\nTypeError: base ring is not supported by GAP\n```",
    "created_at": "2018-12-07T23:41:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423535",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:5'></a>
attached fixes all the doctests in src/sage/groups/ (please apply them!)
except one, which is trickier, and stems from broken support for sending to GAP matrices over inexact fields:

```
sage: m=matrix(CC, [[1,2],[3,4]])
sage: libgap(m)
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
RuntimeError: Error, Variable: 'Complex' must have a value
Exception RuntimeError: "Error, Variable: 'Complex' must have a value" in 'sage.libs.gap.util.error_handler' ignored
Syntax error: ; expected in stream:1
Complex Field with 53 bits of precision;
 ^^^^^^^^^^^^^^^^^^^^
Error, Variable: 'bits' must have a value
Error, no method found! For debugging hints type ?Recovery from NoMethodFound
...
Error, no 1st choice method found for `CloseStream' on 1 arguments
gap: panic, could not open *errout*!
```

---
**Edit:** it is just the broken error handling: the current Sage behaviour for this is

```
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
...
TypeError: base ring is not supported by GAP
```



---

archive/issue_comments_423536.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -121,5 +121,6 @@\n * https://github.com/gap-system/gap/pull/3065\n * https://github.com/gap-system/gap/pull/2952\n \n+The update of gap_packages and database_gap is on #26856\n \n **Tarball**: https://www.gap-system.org/pub/gap/gap-4.10/tar.gz/gap-4.10.0.tar.gz\n``````\n",
    "created_at": "2018-12-08T08:07:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423536",
    "user": "https://github.com/dimpase"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -121,5 +121,6 @@
 * https://github.com/gap-system/gap/pull/3065
 * https://github.com/gap-system/gap/pull/2952
 
+The update of gap_packages and database_gap is on #26856
 
 **Tarball**: https://www.gap-system.org/pub/gap/gap-4.10/tar.gz/gap-4.10.0.tar.gz
``````




---

archive/issue_comments_423537.json:
```json
{
    "body": "<a id='comment:6'></a>\nI've opened #26856 to deal with update of gap_packages and database_gap.",
    "created_at": "2018-12-08T08:07:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423537",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:6'></a>
I've opened #26856 to deal with update of gap_packages and database_gap.



---

archive/issue_comments_423538.json:
```json
{
    "body": "<a id='comment:7'></a>\nmore doctest changes are on `u/dimpase/GQ`, actually, just this commit\n(which includes the diffs in the attachment above too)\nhttps://git.sagemath.org/sage.git/commit/?h=1ed2d00b452155e803c79040460edcd55c120320\n\nI think we are in a pretty good shape here - once the error handling in GAP is sorted out, what would remain are few things in `libs/gap/util`, which are strictly speaking not necessary for (lib)gap functionality.",
    "created_at": "2018-12-08T13:56:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423538",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:7'></a>
more doctest changes are on `u/dimpase/GQ`, actually, just this commit
(which includes the diffs in the attachment above too)
https://git.sagemath.org/sage.git/commit/?h=1ed2d00b452155e803c79040460edcd55c120320

I think we are in a pretty good shape here - once the error handling in GAP is sorted out, what would remain are few things in `libs/gap/util`, which are strictly speaking not necessary for (lib)gap functionality.



---

archive/issue_comments_423539.json:
```json
{
    "body": "**Changing commit** from \"[09d229f1db78ff96d6b46df9ffad22d03155c2c8](https://github.com/sagemath/sagetrac-mirror/commit/09d229f1db78ff96d6b46df9ffad22d03155c2c8)\" to \"[f48ca24b7df9c6e28fa2c1672fadff09e1c19b1e](https://github.com/sagemath/sagetrac-mirror/commit/f48ca24b7df9c6e28fa2c1672fadff09e1c19b1e)\".",
    "created_at": "2018-12-10T08:08:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423539",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[09d229f1db78ff96d6b46df9ffad22d03155c2c8](https://github.com/sagemath/sagetrac-mirror/commit/09d229f1db78ff96d6b46df9ffad22d03155c2c8)" to "[f48ca24b7df9c6e28fa2c1672fadff09e1c19b1e](https://github.com/sagemath/sagetrac-mirror/commit/f48ca24b7df9c6e28fa2c1672fadff09e1c19b1e)".



---

archive/issue_comments_423540.json:
```json
{
    "body": "<a id='comment:8'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f48ca24b7df9c6e28fa2c1672fadff09e1c19b1e\">f48ca24</a></td><td><code>fix some tests that depend on randomized results from GAP</code></td></tr></table>\n",
    "created_at": "2018-12-10T08:08:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423540",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f48ca24b7df9c6e28fa2c1672fadff09e1c19b1e">f48ca24</a></td><td><code>fix some tests that depend on randomized results from GAP</code></td></tr></table>




---

archive/issue_comments_423541.json:
```json
{
    "body": "<a id='comment:9'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/90838a1109d818c6dc5f4bcc36a4e5530cc90e53\">90838a1</a></td><td><code>GAP_ROOT_PATHS is obsolete and should be spelled GAPInfo.RootPaths</code></td></tr></table>\n",
    "created_at": "2018-12-10T08:19:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423541",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/90838a1109d818c6dc5f4bcc36a4e5530cc90e53">90838a1</a></td><td><code>GAP_ROOT_PATHS is obsolete and should be spelled GAPInfo.RootPaths</code></td></tr></table>




---

archive/issue_comments_423542.json:
```json
{
    "body": "**Changing commit** from \"[f48ca24b7df9c6e28fa2c1672fadff09e1c19b1e](https://github.com/sagemath/sagetrac-mirror/commit/f48ca24b7df9c6e28fa2c1672fadff09e1c19b1e)\" to \"[90838a1109d818c6dc5f4bcc36a4e5530cc90e53](https://github.com/sagemath/sagetrac-mirror/commit/90838a1109d818c6dc5f4bcc36a4e5530cc90e53)\".",
    "created_at": "2018-12-10T08:19:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423542",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[f48ca24b7df9c6e28fa2c1672fadff09e1c19b1e](https://github.com/sagemath/sagetrac-mirror/commit/f48ca24b7df9c6e28fa2c1672fadff09e1c19b1e)" to "[90838a1109d818c6dc5f4bcc36a4e5530cc90e53](https://github.com/sagemath/sagetrac-mirror/commit/90838a1109d818c6dc5f4bcc36a4e5530cc90e53)".



---

archive/issue_comments_423543.json:
```json
{
    "body": "<a id='comment:330'></a>\nReplying to [git](#comment%3A328):\n> Branch pushed to git repo; I updated commit sha1. **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f48ca24b7df9c6e28fa2c1672fadff09e1c19b1e\">f48ca24</a></td><td><code>fix some tests that depend on randomized results from GAP</code></td></tr></table>\n\n\nErik, these are a part of the commit I've invited you to apply to your branch...",
    "created_at": "2018-12-10T10:04:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423543",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:330'></a>
Replying to [git](#comment%3A328):
> Branch pushed to git repo; I updated commit sha1. **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f48ca24b7df9c6e28fa2c1672fadff09e1c19b1e">f48ca24</a></td><td><code>fix some tests that depend on randomized results from GAP</code></td></tr></table>


Erik, these are a part of the commit I've invited you to apply to your branch...



---

archive/issue_comments_423544.json:
```json
{
    "body": "**Changing commit** from \"[90838a1109d818c6dc5f4bcc36a4e5530cc90e53](https://github.com/sagemath/sagetrac-mirror/commit/90838a1109d818c6dc5f4bcc36a4e5530cc90e53)\" to \"[39e42a4259c0d208d1623fc5bc3f949453d805cb](https://github.com/sagemath/sagetrac-mirror/commit/39e42a4259c0d208d1623fc5bc3f949453d805cb)\".",
    "created_at": "2018-12-10T11:03:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423544",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[90838a1109d818c6dc5f4bcc36a4e5530cc90e53](https://github.com/sagemath/sagetrac-mirror/commit/90838a1109d818c6dc5f4bcc36a4e5530cc90e53)" to "[39e42a4259c0d208d1623fc5bc3f949453d805cb](https://github.com/sagemath/sagetrac-mirror/commit/39e42a4259c0d208d1623fc5bc3f949453d805cb)".



---

archive/issue_comments_423545.json:
```json
{
    "body": "<a id='comment:1'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f1d8cf7bc67f08fa7f1701badacd566ade4a7fcc\">f1d8cf7</a></td><td><code>improve handling of error results from GAP_EvalString, in particular syntax errors</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/39e42a4259c0d208d1623fc5bc3f949453d805cb\">39e42a4</a></td><td><code>Improved error handling, especially in the case where multiple errors are</code></td></tr></table>\n",
    "created_at": "2018-12-10T11:03:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423545",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:1'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f1d8cf7bc67f08fa7f1701badacd566ade4a7fcc">f1d8cf7</a></td><td><code>improve handling of error results from GAP_EvalString, in particular syntax errors</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/39e42a4259c0d208d1623fc5bc3f949453d805cb">39e42a4</a></td><td><code>Improved error handling, especially in the case where multiple errors are</code></td></tr></table>




---

archive/issue_comments_423546.json:
```json
{
    "body": "<a id='comment:332'></a>\nReplying to [dimpase](#comment%3A325):\n> attached fixes all the doctests in src/sage/groups/ (please apply them!)\n> except one, which is trickier, and stems from broken support for sending to GAP matrices over inexact fields:\n\n\nThanks, I fixed that error just now, and am applying your patches now.  One thing I noticed is that you are just adding some of these new warning messages from GAP to the expected output, like\n\n```\n#I  MakeReadWriteGlobal: CosetTableDefaultMaxLimit already read-write\n```\n\nPerhaps we should instead fix whatever is causing those messages, or make them silent somehow: It's confusing noise in the context of code that uses GAP somewhere deep down but not in any way that's obvious to users.",
    "created_at": "2018-12-10T11:09:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423546",
    "user": "https://github.com/embray"
}
```

<a id='comment:332'></a>
Replying to [dimpase](#comment%3A325):
> attached fixes all the doctests in src/sage/groups/ (please apply them!)
> except one, which is trickier, and stems from broken support for sending to GAP matrices over inexact fields:


Thanks, I fixed that error just now, and am applying your patches now.  One thing I noticed is that you are just adding some of these new warning messages from GAP to the expected output, like

```
#I  MakeReadWriteGlobal: CosetTableDefaultMaxLimit already read-write
```

Perhaps we should instead fix whatever is causing those messages, or make them silent somehow: It's confusing noise in the context of code that uses GAP somewhere deep down but not in any way that's obvious to users.



---

archive/issue_comments_423547.json:
```json
{
    "body": "<a id='comment:333'></a>\nReplying to [embray](#comment%3A332):\n> Replying to [dimpase](#comment%3A325):\n> > attached fixes all the doctests in src/sage/groups/ (please apply them!)\n> > except one, which is trickier, and stems from broken support for sending to GAP matrices over inexact fields:\n\n> \n> Thanks, I fixed that error just now, and am applying your patches now.  \n\n\nI hope you just cherry-pick the commit I posted, rather than using much less complete attachment to this ticket.\n\n>One thing I noticed is that you are just adding some of these new warning messages from GAP to the expected output, like\n> \n>\n> ```\n> #I  MakeReadWriteGlobal: CosetTableDefaultMaxLimit already read-write\n> ```\n> \n> Perhaps we should instead fix whatever is causing those messages, or make them silent somehow: It's confusing noise in the context of code that uses GAP somewhere deep down but not in any way that's obvious to users.\n\n\nthese messages are default in new GAP. I prefer to stay close to what GAP does, unless really necessary. I agree that these messages are ugly, but we'd work with upstream on this.",
    "created_at": "2018-12-10T11:16:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423547",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:333'></a>
Replying to [embray](#comment%3A332):
> Replying to [dimpase](#comment%3A325):
> > attached fixes all the doctests in src/sage/groups/ (please apply them!)
> > except one, which is trickier, and stems from broken support for sending to GAP matrices over inexact fields:

> 
> Thanks, I fixed that error just now, and am applying your patches now.  


I hope you just cherry-pick the commit I posted, rather than using much less complete attachment to this ticket.

>One thing I noticed is that you are just adding some of these new warning messages from GAP to the expected output, like
> 
>
> ```
> #I  MakeReadWriteGlobal: CosetTableDefaultMaxLimit already read-write
> ```
> 
> Perhaps we should instead fix whatever is causing those messages, or make them silent somehow: It's confusing noise in the context of code that uses GAP somewhere deep down but not in any way that's obvious to users.


these messages are default in new GAP. I prefer to stay close to what GAP does, unless really necessary. I agree that these messages are ugly, but we'd work with upstream on this.



---

archive/issue_comments_423548.json:
```json
{
    "body": "<a id='comment:334'></a>\nReplying to [dimpase](#comment%3A333):\n> Replying to [embray](#comment%3A332):\n> > Replying to [dimpase](#comment%3A325):\n> > > attached fixes all the doctests in src/sage/groups/ (please apply them!)\n> > > except one, which is trickier, and stems from broken support for sending to GAP matrices over inexact fields:\n\n> > \n> > Thanks, I fixed that error just now, and am applying your patches now.  \n\n> \n> I hope you just cherry-pick the commit I posted, rather than using much less complete attachment to this ticket.\n\n\nI did.\n\n> >One thing I noticed is that you are just adding some of these new warning messages from GAP to the expected output, like\n> > \n> >\n> > ```\n> > #I  MakeReadWriteGlobal: CosetTableDefaultMaxLimit already read-write\n> > ```\n> > \n> > Perhaps we should instead fix whatever is causing those messages, or make them silent somehow: It's confusing noise in the context of code that uses GAP somewhere deep down but not in any way that's obvious to users.\n\n> \n> these messages are default in new GAP. I prefer to stay close to what GAP does, unless really necessary. I agree that these messages are ugly, but we'd work with upstream on this.\n\n\nGAP shouldn't be printing *anything* we didn't explicitly ask it to print when used as a library (unless, maybe, the user is directly calling `libgap.eval(...)`).  So if nothing else there should be an option to disable these messages either before a `libgap.eval(...)` or as an optional argument to it.  I don't know exactly where they come from though.",
    "created_at": "2018-12-10T12:00:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423548",
    "user": "https://github.com/embray"
}
```

<a id='comment:334'></a>
Replying to [dimpase](#comment%3A333):
> Replying to [embray](#comment%3A332):
> > Replying to [dimpase](#comment%3A325):
> > > attached fixes all the doctests in src/sage/groups/ (please apply them!)
> > > except one, which is trickier, and stems from broken support for sending to GAP matrices over inexact fields:

> > 
> > Thanks, I fixed that error just now, and am applying your patches now.  

> 
> I hope you just cherry-pick the commit I posted, rather than using much less complete attachment to this ticket.


I did.

> >One thing I noticed is that you are just adding some of these new warning messages from GAP to the expected output, like
> > 
> >
> > ```
> > #I  MakeReadWriteGlobal: CosetTableDefaultMaxLimit already read-write
> > ```
> > 
> > Perhaps we should instead fix whatever is causing those messages, or make them silent somehow: It's confusing noise in the context of code that uses GAP somewhere deep down but not in any way that's obvious to users.

> 
> these messages are default in new GAP. I prefer to stay close to what GAP does, unless really necessary. I agree that these messages are ugly, but we'd work with upstream on this.


GAP shouldn't be printing *anything* we didn't explicitly ask it to print when used as a library (unless, maybe, the user is directly calling `libgap.eval(...)`).  So if nothing else there should be an option to disable these messages either before a `libgap.eval(...)` or as an optional argument to it.  I don't know exactly where they come from though.



---

archive/issue_comments_423549.json:
```json
{
    "body": "<a id='comment:5'></a>\nHere are some of the relevant docs on GAP Info messages: https://www.gap-system.org/Manuals/doc/ref/chap7.html#X864E4B6886E2697D\n\nI think it would be useful for the python module to register its own custom info handler to convert these to Python warnings that can then be filtered with the standard Python warnings facilities.",
    "created_at": "2018-12-10T12:08:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423549",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>
Here are some of the relevant docs on GAP Info messages: https://www.gap-system.org/Manuals/doc/ref/chap7.html#X864E4B6886E2697D

I think it would be useful for the python module to register its own custom info handler to convert these to Python warnings that can then be filtered with the standard Python warnings facilities.



---

archive/issue_comments_423550.json:
```json
{
    "body": "<a id='comment:6'></a>\nthe messages about [MakeReadWriteGlobal](https://www.gap-system.org/Manuals/doc/ref/chap4.html#X832AAF13861968BE) appear to indicate mini-bugs in GAP, I think. I'll dig this up and open a GAP issue about it.",
    "created_at": "2018-12-10T12:24:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423550",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:6'></a>
the messages about [MakeReadWriteGlobal](https://www.gap-system.org/Manuals/doc/ref/chap4.html#X832AAF13861968BE) appear to indicate mini-bugs in GAP, I think. I'll dig this up and open a GAP issue about it.



---

archive/issue_comments_423551.json:
```json
{
    "body": "<a id='comment:7'></a>\nThanks.  I agree that, in general, we do want to see these messages, as they could indicate real issues.  But if nothing else it should be possible to squelch them in those cases where the issues are known, or have otherwise been addressed.",
    "created_at": "2018-12-10T12:39:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423551",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>
Thanks.  I agree that, in general, we do want to see these messages, as they could indicate real issues.  But if nothing else it should be possible to squelch them in those cases where the issues are known, or have otherwise been addressed.



---

archive/issue_comments_423552.json:
```json
{
    "body": "<a id='comment:338'></a>\nReplying to [dimpase](#comment%3A336):\n> the messages about [MakeReadWriteGlobal](https://www.gap-system.org/Manuals/doc/ref/chap4.html#X832AAF13861968BE) appear to indicate mini-bugs in GAP, I think. I'll dig this up and open a GAP issue about it.\n\n\nin fact, it's entirely Sage's issue: we have 2 calls like:\n\n```\nwith libgap.global_context('CosetTableDefaultMaxLimit', limit):\n```\nin `src/sage/groups/finitely_presented.py` which trigger these, as they\ncall GAP's `MakeReadWriteGlobal` on already read/write `MakeReadWriteGlobal`.\n\nSo this is something for us to fix.",
    "created_at": "2018-12-10T13:11:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423552",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:338'></a>
Replying to [dimpase](#comment%3A336):
> the messages about [MakeReadWriteGlobal](https://www.gap-system.org/Manuals/doc/ref/chap4.html#X832AAF13861968BE) appear to indicate mini-bugs in GAP, I think. I'll dig this up and open a GAP issue about it.


in fact, it's entirely Sage's issue: we have 2 calls like:

```
with libgap.global_context('CosetTableDefaultMaxLimit', limit):
```
in `src/sage/groups/finitely_presented.py` which trigger these, as they
call GAP's `MakeReadWriteGlobal` on already read/write `MakeReadWriteGlobal`.

So this is something for us to fix.



---

archive/issue_comments_423553.json:
```json
{
    "body": "<a id='comment:9'></a>\nHowever, \n\n```\n#I  Forcing finiteness test\n```\nmessages seem to be really triggered by GAP alone.",
    "created_at": "2018-12-10T13:14:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423553",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:9'></a>
However, 

```
#I  Forcing finiteness test
```
messages seem to be really triggered by GAP alone.



---

archive/issue_comments_423554.json:
```json
{
    "body": "<a id='comment:0'></a>\nThere is (at least) one test that's proving vexing.  In `src/doc/en/constructions/groups.rst`:\n\n\n```\nsage: print(gap.eval(\"G := SymmetricGroup( 4 )\"))\nSym( [ 1 .. 4 ] )\nsage: print(gap.eval(\"normal := NormalSubgroups( G );\"))\n[ Sym( [ 1 .. 4 ] ), Alt( [ 1 .. 4 ] ), Group([ (1,4)(2,3), (1,2)(3,4) ]),\n  Group(()) ]\n```\n\nWhen I run those commands directly in GAP I seem to always get the above result.  However, sometimes this test (just in Sage...?) returns:\n\n```\n[ Sym( [ 1 .. 4 ] ), Alt( [ 1 .. 4 ] ), Group([ (1,4)(2,3), (1,3)(2,4) ]),\n  Group(()) ]\n```\n\n(note the only difference is the second element of the third subgroup).  An equally valid result, but I don't know why this is't entirely deterministic or where the randomness is coming from.",
    "created_at": "2018-12-10T13:59:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423554",
    "user": "https://github.com/embray"
}
```

<a id='comment:0'></a>
There is (at least) one test that's proving vexing.  In `src/doc/en/constructions/groups.rst`:


```
sage: print(gap.eval("G := SymmetricGroup( 4 )"))
Sym( [ 1 .. 4 ] )
sage: print(gap.eval("normal := NormalSubgroups( G );"))
[ Sym( [ 1 .. 4 ] ), Alt( [ 1 .. 4 ] ), Group([ (1,4)(2,3), (1,2)(3,4) ]),
  Group(()) ]
```

When I run those commands directly in GAP I seem to always get the above result.  However, sometimes this test (just in Sage...?) returns:

```
[ Sym( [ 1 .. 4 ] ), Alt( [ 1 .. 4 ] ), Group([ (1,4)(2,3), (1,3)(2,4) ]),
  Group(()) ]
```

(note the only difference is the second element of the third subgroup).  An equally valid result, but I don't know why this is't entirely deterministic or where the randomness is coming from.



---

archive/issue_comments_423555.json:
```json
{
    "body": "<a id='comment:341'></a>\nReplying to [embray](#comment%3A340):\n> There is (at least) one test that's proving vexing.  In `src/doc/en/constructions/groups.rst`:\n> \n> \n> ```\n> sage: print(gap.eval(\"G := SymmetricGroup( 4 )\"))\n> Sym( [ 1 .. 4 ] )\n> sage: print(gap.eval(\"normal := NormalSubgroups( G );\"))\n> [ Sym( [ 1 .. 4 ] ), Alt( [ 1 .. 4 ] ), Group([ (1,4)(2,3), (1,2)(3,4) ]),\n>   Group(()) ]\n> ```\n> \n> When I run those commands directly in GAP I seem to always get the above result.  However, sometimes this test (just in Sage...?) returns:\n> \n> ```\n> [ Sym( [ 1 .. 4 ] ), Alt( [ 1 .. 4 ] ), Group([ (1,4)(2,3), (1,3)(2,4) ]),\n>   Group(()) ]\n> ```\n> \n> (note the only difference is the second element of the third subgroup).  An equally valid result, but I don't know why this is't entirely deterministic or where the randomness is coming from.\n\n\nGAP is certainly using (pseudo)randomization in many places, sometimes by default.\nI would not be worried here, and change the test to compute orders (24,12,4,1) of these subgroups instead.",
    "created_at": "2018-12-10T14:06:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423555",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:341'></a>
Replying to [embray](#comment%3A340):
> There is (at least) one test that's proving vexing.  In `src/doc/en/constructions/groups.rst`:
> 
> 
> ```
> sage: print(gap.eval("G := SymmetricGroup( 4 )"))
> Sym( [ 1 .. 4 ] )
> sage: print(gap.eval("normal := NormalSubgroups( G );"))
> [ Sym( [ 1 .. 4 ] ), Alt( [ 1 .. 4 ] ), Group([ (1,4)(2,3), (1,2)(3,4) ]),
>   Group(()) ]
> ```
> 
> When I run those commands directly in GAP I seem to always get the above result.  However, sometimes this test (just in Sage...?) returns:
> 
> ```
> [ Sym( [ 1 .. 4 ] ), Alt( [ 1 .. 4 ] ), Group([ (1,4)(2,3), (1,3)(2,4) ]),
>   Group(()) ]
> ```
> 
> (note the only difference is the second element of the third subgroup).  An equally valid result, but I don't know why this is't entirely deterministic or where the randomness is coming from.


GAP is certainly using (pseudo)randomization in many places, sometimes by default.
I would not be worried here, and change the test to compute orders (24,12,4,1) of these subgroups instead.



---

archive/issue_comments_423556.json:
```json
{
    "body": "<a id='comment:2'></a>\nRight, it's using some random processes in searching for subgroups or something, and indeed the orders of the groups are consistent either way.  But I am still concerned here, because between test runs pseudo-random results *should* still be consistent, unless there is some RNG in GAP that we are now not seeding properly.",
    "created_at": "2018-12-10T14:22:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423556",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>
Right, it's using some random processes in searching for subgroups or something, and indeed the orders of the groups are consistent either way.  But I am still concerned here, because between test runs pseudo-random results *should* still be consistent, unless there is some RNG in GAP that we are now not seeding properly.



---

archive/issue_comments_423557.json:
```json
{
    "body": "<a id='comment:3'></a>\nAha, to my surprise `randstate.set_seed_gap` does not actually do anything for the libgap interface, just for the pexpect GAP interface.  So that will indeed be a problem in general.  I wonder how this was handled before...?\n\nThis also leads me to wonder if we're in a good place where we can start to deprecate/remove the pexpect interface entirely.  I'm not sure what advantages it might still have, if any...",
    "created_at": "2018-12-10T14:31:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423557",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>
Aha, to my surprise `randstate.set_seed_gap` does not actually do anything for the libgap interface, just for the pexpect GAP interface.  So that will indeed be a problem in general.  I wonder how this was handled before...?

This also leads me to wonder if we're in a good place where we can start to deprecate/remove the pexpect interface entirely.  I'm not sure what advantages it might still have, if any...



---

archive/issue_comments_423558.json:
```json
{
    "body": "<a id='comment:344'></a>\nReplying to [embray](#comment%3A343):\n> Aha, to my surprise `randstate.set_seed_gap` does not actually do anything for the libgap interface, just for the pexpect GAP interface.  So that will indeed be a problem in general.  I wonder how this was handled before...?\n\n\nI guess it was just broken, and tests didn't pick it up for some reason.\n(seems easy to fix though).\n\n> \n> This also leads me to wonder if we're in a good place where we can start to deprecate/remove the pexpect interface entirely.  I'm not sure what advantages it might still have, if any...\n\n\nIIRC there are few places in Sage that still use `gap` in place of `libgap`, but these should be easy. I think after this ticket and associated GAP packages are done, it's high time to pull GAP pexpect interface.",
    "created_at": "2018-12-10T15:04:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423558",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:344'></a>
Replying to [embray](#comment%3A343):
> Aha, to my surprise `randstate.set_seed_gap` does not actually do anything for the libgap interface, just for the pexpect GAP interface.  So that will indeed be a problem in general.  I wonder how this was handled before...?


I guess it was just broken, and tests didn't pick it up for some reason.
(seems easy to fix though).

> 
> This also leads me to wonder if we're in a good place where we can start to deprecate/remove the pexpect interface entirely.  I'm not sure what advantages it might still have, if any...


IIRC there are few places in Sage that still use `gap` in place of `libgap`, but these should be easy. I think after this ticket and associated GAP packages are done, it's high time to pull GAP pexpect interface.



---

archive/issue_comments_423559.json:
```json
{
    "body": "<a id='comment:345'></a>\nReplying to [dimpase](#comment%3A344):\n> Replying to [embray](#comment%3A343):\n> > Aha, to my surprise `randstate.set_seed_gap` does not actually do anything for the libgap interface, just for the pexpect GAP interface.  So that will indeed be a problem in general.  I wonder how this was handled before...?\n\n> \n> I guess it was just broken, and tests didn't pick it up for some reason.\n> (seems easy to fix though).\n\n\nI guess it must have been broken: I can't see any way that the libgap interface was otherwise being re-seeded.  I am working on a fix.\n\n> > \n> > This also leads me to wonder if we're in a good place where we can start to deprecate/remove the pexpect interface entirely.  I'm not sure what advantages it might still have, if any...\n\n> \n> IIRC there are few places in Sage that still use `gap` in place of `libgap`, but these should be easy. I think after this ticket and associated GAP packages are done, it's high time to pull GAP pexpect interface.\n\n\nYes, I hope so.  This should be done first though.",
    "created_at": "2018-12-10T16:01:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423559",
    "user": "https://github.com/embray"
}
```

<a id='comment:345'></a>
Replying to [dimpase](#comment%3A344):
> Replying to [embray](#comment%3A343):
> > Aha, to my surprise `randstate.set_seed_gap` does not actually do anything for the libgap interface, just for the pexpect GAP interface.  So that will indeed be a problem in general.  I wonder how this was handled before...?

> 
> I guess it was just broken, and tests didn't pick it up for some reason.
> (seems easy to fix though).


I guess it must have been broken: I can't see any way that the libgap interface was otherwise being re-seeded.  I am working on a fix.

> > 
> > This also leads me to wonder if we're in a good place where we can start to deprecate/remove the pexpect interface entirely.  I'm not sure what advantages it might still have, if any...

> 
> IIRC there are few places in Sage that still use `gap` in place of `libgap`, but these should be easy. I think after this ticket and associated GAP packages are done, it's high time to pull GAP pexpect interface.


Yes, I hope so.  This should be done first though.



---

archive/issue_comments_423560.json:
```json
{
    "body": "<a id='comment:346'></a>\nReplying to [embray](#comment%3A343):\n> Aha, to my surprise `randstate.set_seed_gap` does not actually do anything for the libgap interface, just for the pexpect GAP interface.  So that will indeed be a problem in general.  I wonder how this was handled before...?\n\n\nFor some reason I led myself astray by thinking the test that was randomly failing had anything to do with libgap, but it was actually using the pexpect interface in the first place, and it had nothing to do with libgap.\n\nI realized that many of the doctests manually call something like `current_randstate().set_seed_gap()` before calls that use GAP that might involve some random process.  I think that's rather unfortunate, especially for documentation (it raises a distracting question \"why do I have to do this first?\") so I'm also adding a patch that does this automatically when the GAP interface is used in doctests.\n\nOther than this random seed issue, we're very close to having 100% of the standard doctests passing.",
    "created_at": "2018-12-10T17:09:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423560",
    "user": "https://github.com/embray"
}
```

<a id='comment:346'></a>
Replying to [embray](#comment%3A343):
> Aha, to my surprise `randstate.set_seed_gap` does not actually do anything for the libgap interface, just for the pexpect GAP interface.  So that will indeed be a problem in general.  I wonder how this was handled before...?


For some reason I led myself astray by thinking the test that was randomly failing had anything to do with libgap, but it was actually using the pexpect interface in the first place, and it had nothing to do with libgap.

I realized that many of the doctests manually call something like `current_randstate().set_seed_gap()` before calls that use GAP that might involve some random process.  I think that's rather unfortunate, especially for documentation (it raises a distracting question "why do I have to do this first?") so I'm also adding a patch that does this automatically when the GAP interface is used in doctests.

Other than this random seed issue, we're very close to having 100% of the standard doctests passing.



---

archive/issue_comments_423561.json:
```json
{
    "body": "<a id='comment:347'></a>\nReplying to [dimpase](#comment%3A338):\n> in fact, it's entirely Sage's issue: we have 2 calls like:\n> \n> ```\n> with libgap.global_context('CosetTableDefaultMaxLimit', limit):\n> ```\n> in `src/sage/groups/finitely_presented.py` which trigger these, as they\n> call GAP's `MakeReadWriteGlobal` on already read/write `MakeReadWriteGlobal`.\n> \n> So this is something for us to fix.\n\n\nI've fixed this, it was easy. I've pushed  commit 5d3fce on `u/dimpase/GQ` for you to pick.\nBasically, the nontrivial part was\n\n```diff\n--- a/src/sage/libs/gap/libgap.pyx\n+++ b/src/sage/libs/gap/libgap.pyx\n@@ -485,9 +485,11 @@ class Gap(Parent):\n             ...\n             ValueError: libGAP: Error, VAL_GVAR: No value bound to FooBar\n         \"\"\"\n+        is_readonlyglobal = self.function_factory('IsReadOnlyGlobal')\n         make_readwrite = self.function_factory('MakeReadWriteGlobal')\n         unbind_global = self.function_factory('UnbindGlobal')\n-        make_readwrite(variable)\n+        if is_readonlyglobal(variable):\n+            make_readwrite(variable)\n         unbind_global(variable)\n \n     def get_global(self, variable):\n```",
    "created_at": "2018-12-10T17:24:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423561",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:347'></a>
Replying to [dimpase](#comment%3A338):
> in fact, it's entirely Sage's issue: we have 2 calls like:
> 
> ```
> with libgap.global_context('CosetTableDefaultMaxLimit', limit):
> ```
> in `src/sage/groups/finitely_presented.py` which trigger these, as they
> call GAP's `MakeReadWriteGlobal` on already read/write `MakeReadWriteGlobal`.
> 
> So this is something for us to fix.


I've fixed this, it was easy. I've pushed  commit 5d3fce on `u/dimpase/GQ` for you to pick.
Basically, the nontrivial part was

```diff
--- a/src/sage/libs/gap/libgap.pyx
+++ b/src/sage/libs/gap/libgap.pyx
@@ -485,9 +485,11 @@ class Gap(Parent):
             ...
             ValueError: libGAP: Error, VAL_GVAR: No value bound to FooBar
         """
+        is_readonlyglobal = self.function_factory('IsReadOnlyGlobal')
         make_readwrite = self.function_factory('MakeReadWriteGlobal')
         unbind_global = self.function_factory('UnbindGlobal')
-        make_readwrite(variable)
+        if is_readonlyglobal(variable):
+            make_readwrite(variable)
         unbind_global(variable)
 
     def get_global(self, variable):
```



---

archive/issue_comments_423562.json:
```json
{
    "body": "**Changing commit** from \"[39e42a4259c0d208d1623fc5bc3f949453d805cb](https://github.com/sagemath/sagetrac-mirror/commit/39e42a4259c0d208d1623fc5bc3f949453d805cb)\" to \"[5a2949d204bf6d7bf90e6254371b668f4522f019](https://github.com/sagemath/sagetrac-mirror/commit/5a2949d204bf6d7bf90e6254371b668f4522f019)\".",
    "created_at": "2018-12-11T08:02:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423562",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[39e42a4259c0d208d1623fc5bc3f949453d805cb](https://github.com/sagemath/sagetrac-mirror/commit/39e42a4259c0d208d1623fc5bc3f949453d805cb)" to "[5a2949d204bf6d7bf90e6254371b668f4522f019](https://github.com/sagemath/sagetrac-mirror/commit/5a2949d204bf6d7bf90e6254371b668f4522f019)".



---

archive/issue_comments_423563.json:
```json
{
    "body": "<a id='comment:8'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/36b305ff1501a8f78329c8162f4acb6a5f3aa4ca\">36b305f</a></td><td><code>fix doctests changed due to GAP formatting etc changes</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/52c002d21c9f11a04185d7b50ee25ccf19d243fb\">52c002d</a></td><td><code>fix a few more tests that changed due to minor output differences in GAP</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/34ed6e194e92e1aa5384a446e4e731872b622f1b\">34ed6e1</a></td><td><code>remove some obsolete debug functions</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5a2949d204bf6d7bf90e6254371b668f4522f019\">5a2949d</a></td><td><code>fixed noisy \"#I  MakeReadWriteGlobal\" things</code></td></tr></table>\n",
    "created_at": "2018-12-11T08:02:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423563",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/36b305ff1501a8f78329c8162f4acb6a5f3aa4ca">36b305f</a></td><td><code>fix doctests changed due to GAP formatting etc changes</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/52c002d21c9f11a04185d7b50ee25ccf19d243fb">52c002d</a></td><td><code>fix a few more tests that changed due to minor output differences in GAP</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/34ed6e194e92e1aa5384a446e4e731872b622f1b">34ed6e1</a></td><td><code>remove some obsolete debug functions</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5a2949d204bf6d7bf90e6254371b668f4522f019">5a2949d</a></td><td><code>fixed noisy "#I  MakeReadWriteGlobal" things</code></td></tr></table>




---

archive/issue_comments_423564.json:
```json
{
    "body": "<a id='comment:9'></a>\nExcellent, thank you",
    "created_at": "2018-12-11T08:02:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423564",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>
Excellent, thank you



---

archive/issue_comments_423565.json:
```json
{
    "body": "**Changing commit** from \"[5a2949d204bf6d7bf90e6254371b668f4522f019](https://github.com/sagemath/sagetrac-mirror/commit/5a2949d204bf6d7bf90e6254371b668f4522f019)\" to \"[0717586c0b2ea22c2e6a012ba23b3d9fd6f753cd](https://github.com/sagemath/sagetrac-mirror/commit/0717586c0b2ea22c2e6a012ba23b3d9fd6f753cd)\".",
    "created_at": "2018-12-11T09:07:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423565",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[5a2949d204bf6d7bf90e6254371b668f4522f019](https://github.com/sagemath/sagetrac-mirror/commit/5a2949d204bf6d7bf90e6254371b668f4522f019)" to "[0717586c0b2ea22c2e6a012ba23b3d9fd6f753cd](https://github.com/sagemath/sagetrac-mirror/commit/0717586c0b2ea22c2e6a012ba23b3d9fd6f753cd)".



---

archive/issue_comments_423566.json:
```json
{
    "body": "<a id='comment:0'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0717586c0b2ea22c2e6a012ba23b3d9fd6f753cd\">0717586</a></td><td><code>Deprecate Gap.mem and remove its functionality</code></td></tr></table>\n",
    "created_at": "2018-12-11T09:07:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423566",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:0'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0717586c0b2ea22c2e6a012ba23b3d9fd6f753cd">0717586</a></td><td><code>Deprecate Gap.mem and remove its functionality</code></td></tr></table>




---

archive/issue_comments_423567.json:
```json
{
    "body": "<a id='comment:1'></a>\nI removed some of the old, obsolete debugging code that wasn't used anywhere.  I also deprecated the `Gap.mem()` method since there's no way to implement this without digging into GASMAN internals, and even then it's very low-level data not likely of interest to any users--I can't find *any* reference to it being used anywhere online.  To make up for it I improved the (poorly named) `Gap.show()` a little bit.  Now, rather than printing, it returns a dict, and contains a little more information.",
    "created_at": "2018-12-11T09:10:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423567",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>
I removed some of the old, obsolete debugging code that wasn't used anywhere.  I also deprecated the `Gap.mem()` method since there's no way to implement this without digging into GASMAN internals, and even then it's very low-level data not likely of interest to any users--I can't find *any* reference to it being used anywhere online.  To make up for it I improved the (poorly named) `Gap.show()` a little bit.  Now, rather than printing, it returns a dict, and contains a little more information.



---

archive/issue_comments_423568.json:
```json
{
    "body": "**Changing commit** from \"[0717586c0b2ea22c2e6a012ba23b3d9fd6f753cd](https://github.com/sagemath/sagetrac-mirror/commit/0717586c0b2ea22c2e6a012ba23b3d9fd6f753cd)\" to \"[15b7c7855d9097143e2b582b4831d2fb50294f53](https://github.com/sagemath/sagetrac-mirror/commit/15b7c7855d9097143e2b582b4831d2fb50294f53)\".",
    "created_at": "2018-12-11T09:13:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423568",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[0717586c0b2ea22c2e6a012ba23b3d9fd6f753cd](https://github.com/sagemath/sagetrac-mirror/commit/0717586c0b2ea22c2e6a012ba23b3d9fd6f753cd)" to "[15b7c7855d9097143e2b582b4831d2fb50294f53](https://github.com/sagemath/sagetrac-mirror/commit/15b7c7855d9097143e2b582b4831d2fb50294f53)".



---

archive/issue_comments_423569.json:
```json
{
    "body": "<a id='comment:2'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/15b7c7855d9097143e2b582b4831d2fb50294f53\">15b7c78</a></td><td><code>Allow Gap.__getattr__ to return GAP objects other than just functions</code></td></tr></table>\n",
    "created_at": "2018-12-11T09:13:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423569",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/15b7c7855d9097143e2b582b4831d2fb50294f53">15b7c78</a></td><td><code>Allow Gap.__getattr__ to return GAP objects other than just functions</code></td></tr></table>




---

archive/issue_comments_423570.json:
```json
{
    "body": "**Dependencies:** #26874",
    "created_at": "2018-12-11T09:30:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423570",
    "user": "https://github.com/embray"
}
```

**Dependencies:** #26874



---

archive/issue_comments_423571.json:
```json
{
    "body": "<a id='comment:3'></a>\nI think it would be good to resolve #26874 for this ticket, since there are new ways, it seems, that results from GAP can be slightly random.  I think my solution in #26874 is fine, but any other solution that works is fine too.",
    "created_at": "2018-12-11T09:30:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423571",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>
I think it would be good to resolve #26874 for this ticket, since there are new ways, it seems, that results from GAP can be slightly random.  I think my solution in #26874 is fine, but any other solution that works is fine too.



---

archive/issue_comments_423572.json:
```json
{
    "body": "<a id='comment:4'></a>\nGot around to opening a PR for the writeandcheck issue: https://github.com/gap-system/gap/pull/3102\n\nAs I wrote there, I'm not entirely satisfied with the solution, but it's \"good enough for now\" for our purposes.",
    "created_at": "2018-12-11T12:19:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423572",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>
Got around to opening a PR for the writeandcheck issue: https://github.com/gap-system/gap/pull/3102

As I wrote there, I'm not entirely satisfied with the solution, but it's "good enough for now" for our purposes.



---

archive/issue_comments_423573.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -109,6 +109,7 @@\n * https://github.com/gap-system/gap/pull/3043\n * https://github.com/gap-system/gap/pull/3072\n * https://github.com/gap-system/gap/pull/3096\n+* https://github.com/gap-system/gap/pull/3102\n \n Other open issues that don't have PRs yet:\n \n``````\n",
    "created_at": "2018-12-11T12:19:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423573",
    "user": "https://github.com/embray"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -109,6 +109,7 @@
 * https://github.com/gap-system/gap/pull/3043
 * https://github.com/gap-system/gap/pull/3072
 * https://github.com/gap-system/gap/pull/3096
+* https://github.com/gap-system/gap/pull/3102
 
 Other open issues that don't have PRs yet:
 
``````




---

archive/issue_comments_423574.json:
```json
{
    "body": "<a id='comment:5'></a>\nOne of the most severe remaining issues is the problem with `all_documented_functions`.  Specifically this one snippet of code, which returns the list of documented global functions (here in plain GAP code):\n\n```\ndocumented_funcs := Filtered(NamesGVars(), IsDocumentedWord);\n```\n\nI profiled this by setting `ProfileGlobalFunctions(true);` and then `DisplayProfile();` afterwards.  On GAP 4.8.6 in Sage's devel branch I get:\n\n```\n  count  self/ms  chld/ms  stor/kb  chld/kb  package  function\n  43509       23        0     2514        0  GAP      LowercaseString\n  59996       29        3     1874        0  GAPDoc   IntListUnicodeString\n  14941       37        0     2228        0  GAPDoc   StripEscapeSequences\n  21356       85        0    12680        0  GAP      Union\n 194454      106        1    10578        0  GAP      Concatenation\n  10678       32       87     8718    13516  GAP      SIMPLE_STRING\n  89499      103       25     9089     2514  GAP      HELP_BOOK_INFO\n 113152      118      119     8575     7391  GAP      List\n132426*    33312       89  9047115        0  GAP      MATCH_BEGIN\n  43509    28045    33593    29768  9070369  GAP      HELP_GET_MATCHES\n  10679      152    61879    11525  9133134  GAP      Filtered\n              18              1865                    OTHER\n           62060           9146534                    TOTAL\n```\n\nwhereas in the GAP on this branch I get:\n\n```\n  count  self/ms  chld/ms  stor/kb  chld/kb  package  function\n  63144       79        3        0        0  GAPDoc   IntListUnicodeString\n  13737      178        0     1158        0  GAPDoc   StripEscapeSequences\n 132388      257        7     1551        0  GAP      Minimum\n  10876      315      458     8470     5143  GAP      SIMPLE_STRING\n 129752     1044        0    21506        0  GAP      Cartesian\n  21752     1741        1    34699        0  GAP      Union\n1096610     2733        0    35812        0  GAP      LowercaseString\n6238192    15599       21   111496        0  GAP      Concatenation\n3048782    13451     2776     1104    35812  GAP      HELP_BOOK_INFO\n2349706     9325    14996    48333    43036  GAP      List\n664468*  1493442        0  100189*        0  GAP      MATCH_BEGIN_COUNT\n1096610  1090807  1530461  1097484  102079*  GAP      HELP_GET_MATCHES\n  10877     3653  2628892    21606  113805*  GAP      Filtered\n         2632624           114021*                    TOTAL\n```\n\nwhich is a several order of magnitude regression.  It should be noted that `Size(NamesGVars())` is about the same in both cases; ~10000.",
    "created_at": "2018-12-11T12:33:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423574",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>
One of the most severe remaining issues is the problem with `all_documented_functions`.  Specifically this one snippet of code, which returns the list of documented global functions (here in plain GAP code):

```
documented_funcs := Filtered(NamesGVars(), IsDocumentedWord);
```

I profiled this by setting `ProfileGlobalFunctions(true);` and then `DisplayProfile();` afterwards.  On GAP 4.8.6 in Sage's devel branch I get:

```
  count  self/ms  chld/ms  stor/kb  chld/kb  package  function
  43509       23        0     2514        0  GAP      LowercaseString
  59996       29        3     1874        0  GAPDoc   IntListUnicodeString
  14941       37        0     2228        0  GAPDoc   StripEscapeSequences
  21356       85        0    12680        0  GAP      Union
 194454      106        1    10578        0  GAP      Concatenation
  10678       32       87     8718    13516  GAP      SIMPLE_STRING
  89499      103       25     9089     2514  GAP      HELP_BOOK_INFO
 113152      118      119     8575     7391  GAP      List
132426*    33312       89  9047115        0  GAP      MATCH_BEGIN
  43509    28045    33593    29768  9070369  GAP      HELP_GET_MATCHES
  10679      152    61879    11525  9133134  GAP      Filtered
              18              1865                    OTHER
           62060           9146534                    TOTAL
```

whereas in the GAP on this branch I get:

```
  count  self/ms  chld/ms  stor/kb  chld/kb  package  function
  63144       79        3        0        0  GAPDoc   IntListUnicodeString
  13737      178        0     1158        0  GAPDoc   StripEscapeSequences
 132388      257        7     1551        0  GAP      Minimum
  10876      315      458     8470     5143  GAP      SIMPLE_STRING
 129752     1044        0    21506        0  GAP      Cartesian
  21752     1741        1    34699        0  GAP      Union
1096610     2733        0    35812        0  GAP      LowercaseString
6238192    15599       21   111496        0  GAP      Concatenation
3048782    13451     2776     1104    35812  GAP      HELP_BOOK_INFO
2349706     9325    14996    48333    43036  GAP      List
664468*  1493442        0  100189*        0  GAP      MATCH_BEGIN_COUNT
1096610  1090807  1530461  1097484  102079*  GAP      HELP_GET_MATCHES
  10877     3653  2628892    21606  113805*  GAP      Filtered
         2632624           114021*                    TOTAL
```

which is a several order of magnitude regression.  It should be noted that `Size(NamesGVars())` is about the same in both cases; ~10000.



---

archive/issue_comments_423575.json:
```json
{
    "body": "<a id='comment:6'></a>\nI have a problem building this branch, with Sage 8.5.rc0, on Debian:\n(even tried `make distclean` first, to no avail). Any idea what's wrong?:\n\n```\n[sagelib-8.5.rc0] [  1/304] gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -fPIC -I./sage/cpython -Isage/cpython -I/home/dimpase/Sage/sagetrac-mirror/local/lib/python2.7/site-packages/cysignals -I/home/dimpase/Sage/sagetrac-mirror/local/include -I/home/dimpase/Sage/sagetrac-mirror/local/include/python2.7 -I/home/dimpase/Sage/sagetrac-mirror/local/lib/python2.7/site-packages/numpy/core/include -I/home/dimpase/Sage/sagetrac-mirror/src -I/home/dimpase/Sage/sagetrac-mirror/src/sage/ext -Ibuild/cythonized -I/home/dimpase/Sage/sagetrac-mirror/local/include/python2.7 -c build/cythonized/sage/libs/gap/element.c -o build/temp.linux-x86_64-2.7/build/cythonized/sage/libs/gap/element.o -fno-strict-aliasing -DCYTHON_CLINE_IN_TRACEBACK=1 -std=c99\n[sagelib-8.5.rc0] In file included from /home/dimpase/Sage/sagetrac-mirror/local/include/gap/system.h:27:0,\n[sagelib-8.5.rc0]                  from build/cythonized/sage/libs/gap/element.c:660:\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/config.h:159:0: warning: \"HAVE_STAT\" redefined\n[sagelib-8.5.rc0]  #define HAVE_STAT 1\n[sagelib-8.5.rc0]  \n[sagelib-8.5.rc0] In file included from /home/dimpase/Sage/sagetrac-mirror/local/include/python2.7/Python.h:61:0,\n[sagelib-8.5.rc0]                  from build/cythonized/sage/libs/gap/element.c:53:\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/python2.7/pyport.h:374:0: note: this is the location of the previous definition\n[sagelib-8.5.rc0]  #define HAVE_STAT\n[sagelib-8.5.rc0]  \n[sagelib-8.5.rc0] In file included from /home/dimpase/Sage/sagetrac-mirror/local/include/gap/system.h:32:0,\n[sagelib-8.5.rc0]                  from build/cythonized/sage/libs/gap/element.c:660:\n[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c: In function \u2018__pyx_f_4sage_4libs_3gap_7element_crepr\u2019:\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:37: warning: implicit declaration of function \u2018STATE\u2019 [-Wimplicit-function-declaration]\n[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))\n[sagelib-8.5.rc0]                                      ^\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:28: note: in expansion of macro \u2018sySetjmp\u2019\n[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))\n[sagelib-8.5.rc0]                             ^~~~~~~~\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:86:21: note: in expansion of macro \u2018GAP_Error_Setjmp\u2019\n[sagelib-8.5.rc0]  #define GAP_Enter() GAP_Error_Setjmp(); GAP_EnterStack()\n[sagelib-8.5.rc0]                      ^~~~~~~~~~~~~~~~\n[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c:4137:17: note: in expansion of macro \u2018GAP_Enter\u2019\n[sagelib-8.5.rc0]      __pyx_t_1 = GAP_Enter(); if (unlikely(__pyx_t_1 == ((int)0))) __PYX_ERR(0, 100, __pyx_L4_error)\n[sagelib-8.5.rc0]                  ^~~~~~~~~\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:43: error: \u2018ReadJmpError\u2019 undeclared (first use in this function)\n[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))\n[sagelib-8.5.rc0]                                            ^\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:28: note: in expansion of macro \u2018sySetjmp\u2019\n[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))\n[sagelib-8.5.rc0]                             ^~~~~~~~\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:86:21: note: in expansion of macro \u2018GAP_Error_Setjmp\u2019\n[sagelib-8.5.rc0]  #define GAP_Enter() GAP_Error_Setjmp(); GAP_EnterStack()\n[sagelib-8.5.rc0]                      ^~~~~~~~~~~~~~~~\n[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c:4137:17: note: in expansion of macro \u2018GAP_Enter\u2019\n[sagelib-8.5.rc0]      __pyx_t_1 = GAP_Enter(); if (unlikely(__pyx_t_1 == ((int)0))) __PYX_ERR(0, 100, __pyx_L4_error)\n[sagelib-8.5.rc0]                  ^~~~~~~~~\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:43: note: each undeclared identifier is reported only once for each function it appears in\n[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))\n[sagelib-8.5.rc0]                                            ^\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:28: note: in expansion of macro \u2018sySetjmp\u2019\n[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))\n[sagelib-8.5.rc0]                             ^~~~~~~~\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:86:21: note: in expansion of macro \u2018GAP_Error_Setjmp\u2019\n[sagelib-8.5.rc0]  #define GAP_Enter() GAP_Error_Setjmp(); GAP_EnterStack()\n[sagelib-8.5.rc0]                      ^~~~~~~~~~~~~~~~\n[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c:4137:17: note: in expansion of macro \u2018GAP_Enter\u2019\n[sagelib-8.5.rc0]      __pyx_t_1 = GAP_Enter(); if (unlikely(__pyx_t_1 == ((int)0))) __PYX_ERR(0, 100, __pyx_L4_error)\n[sagelib-8.5.rc0]                  ^~~~~~~~~\n[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c: In function \u2018__pyx_f_4sage_4libs_3gap_7element_make_gap_record\u2019:\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:43: error: \u2018ReadJmpError\u2019 undeclared (first use in this function)\n[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))\n[sagelib-8.5.rc0]                                            ^\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:28: note: in expansion of macro \u2018sySetjmp\u2019\n[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))\n[sagelib-8.5.rc0]                             ^~~~~~~~\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:86:21: note: in expansion of macro \u2018GAP_Error_Setjmp\u2019\n[sagelib-8.5.rc0]  #define GAP_Enter() GAP_Error_Setjmp(); GAP_EnterStack()\n[sagelib-8.5.rc0]                      ^~~~~~~~~~~~~~~~\n[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c:4443:17: note: in expansion of macro \u2018GAP_Enter\u2019\n[sagelib-8.5.rc0]      __pyx_t_5 = GAP_Enter(); if (unlikely(__pyx_t_5 == ((int)0))) __PYX_ERR(0, 142, __pyx_L6_error)\n[sagelib-8.5.rc0]                  ^~~~~~~~~\n[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c: In function \u2018__pyx_f_4sage_4libs_3gap_7element_make_gap_integer\u2019:\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:43: error: \u2018ReadJmpError\u2019 undeclared (first use in this function)\n[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))\n[sagelib-8.5.rc0]                                            ^\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:28: note: in expansion of macro \u2018sySetjmp\u2019\n[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))\n[sagelib-8.5.rc0]                             ^~~~~~~~\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:86:21: note: in expansion of macro \u2018GAP_Error_Setjmp\u2019\n[sagelib-8.5.rc0]  #define GAP_Enter() GAP_Error_Setjmp(); GAP_EnterStack()\n[sagelib-8.5.rc0]                      ^~~~~~~~~~~~~~~~\n[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c:4700:17: note: in expansion of macro \u2018GAP_Enter\u2019\n[sagelib-8.5.rc0]      __pyx_t_1 = GAP_Enter(); if (unlikely(__pyx_t_1 == ((int)0))) __PYX_ERR(0, 172, __pyx_L4_error)\n[sagelib-8.5.rc0]                  ^~~~~~~~~\n[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c: In function \u2018__pyx_f_4sage_4libs_3gap_7element_make_gap_string\u2019:\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:43: error: \u2018ReadJmpError\u2019 undeclared (first use in this function)\n[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))\n[sagelib-8.5.rc0]                                            ^\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:28: note: in expansion of macro \u2018sySetjmp\u2019\n[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))\n[sagelib-8.5.rc0]                             ^~~~~~~~\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:86:21: note: in expansion of macro \u2018GAP_Error_Setjmp\u2019\n[sagelib-8.5.rc0]  #define GAP_Enter() GAP_Error_Setjmp(); GAP_EnterStack()\n[sagelib-8.5.rc0]                      ^~~~~~~~~~~~~~~~\n[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c:4831:17: note: in expansion of macro \u2018GAP_Enter\u2019\n[sagelib-8.5.rc0]      __pyx_t_1 = GAP_Enter(); if (unlikely(__pyx_t_1 == ((int)0))) __PYX_ERR(0, 198, __pyx_L4_error)\n[sagelib-8.5.rc0]                  ^~~~~~~~~\n[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c: In function \u2018__pyx_f_4sage_4libs_3gap_7element_make_any_gap_element\u2019:\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:43: error: \u2018ReadJmpError\u2019 undeclared (first use in this function)\n[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))\n[sagelib-8.5.rc0]                                            ^\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:28: note: in expansion of macro \u2018sySetjmp\u2019\n[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))\n[sagelib-8.5.rc0]                             ^~~~~~~~\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:86:21: note: in expansion of macro \u2018GAP_Error_Setjmp\u2019\n[sagelib-8.5.rc0]  #define GAP_Enter() GAP_Error_Setjmp(); GAP_EnterStack()\n[sagelib-8.5.rc0]                      ^~~~~~~~~~~~~~~~\n[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c:4991:17: note: in expansion of macro \u2018GAP_Enter\u2019\n[sagelib-8.5.rc0]      __pyx_t_1 = GAP_Enter(); if (unlikely(__pyx_t_1 == ((int)0))) __PYX_ERR(0, 249, __pyx_L4_error)\n[sagelib-8.5.rc0]                  ^~~~~~~~~\n[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c: In function \u2018__pyx_f_4sage_4libs_3gap_7element_10GapElement__compare_equal\u2019:\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:43: error: \u2018ReadJmpError\u2019 undeclared (first use in this function)\n[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))\n[sagelib-8.5.rc0]                                            ^\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:28: note: in expansion of macro \u2018sySetjmp\u2019\n[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))\n[sagelib-8.5.rc0]                             ^~~~~~~~\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:86:21: note: in expansion of macro \u2018GAP_Error_Setjmp\u2019\n[sagelib-8.5.rc0]  #define GAP_Enter() GAP_Error_Setjmp(); GAP_EnterStack()\n[sagelib-8.5.rc0]                      ^~~~~~~~~~~~~~~~\n[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c:8510:21: note: in expansion of macro \u2018GAP_Enter\u2019\n[sagelib-8.5.rc0]          __pyx_t_5 = GAP_Enter(); if (unlikely(__pyx_t_5 == ((int)0))) __PYX_ERR(0, 821, __pyx_L7_error)\n[sagelib-8.5.rc0]                      ^~~~~~~~~\n[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c: In function \u2018__pyx_f_4sage_4libs_3gap_7element_10GapElement__compare_less\u2019:\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:43: error: \u2018ReadJmpError\u2019 undeclared (first use in this function)\n[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))\n[sagelib-8.5.rc0]                                            ^\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:28: note: in expansion of macro \u2018sySetjmp\u2019\n[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))\n[sagelib-8.5.rc0]                             ^~~~~~~~\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:86:21: note: in expansion of macro \u2018GAP_Error_Setjmp\u2019\n[sagelib-8.5.rc0]  #define GAP_Enter() GAP_Error_Setjmp(); GAP_EnterStack()\n[sagelib-8.5.rc0]                      ^~~~~~~~~~~~~~~~\n[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c:8810:21: note: in expansion of macro \u2018GAP_Enter\u2019\n[sagelib-8.5.rc0]          __pyx_t_5 = GAP_Enter(); if (unlikely(__pyx_t_5 == ((int)0))) __PYX_ERR(0, 845, __pyx_L7_error)\n[sagelib-8.5.rc0]                      ^~~~~~~~~\n[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c: In function \u2018__pyx_f_4sage_4libs_3gap_7element_10GapElement__add_\u2019:\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:43: error: \u2018ReadJmpError\u2019 undeclared (first use in this function)\n[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))\n[sagelib-8.5.rc0]                                            ^\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:28: note: in expansion of macro \u2018sySetjmp\u2019\n[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))\n[sagelib-8.5.rc0]                             ^~~~~~~~\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:86:21: note: in expansion of macro \u2018GAP_Error_Setjmp\u2019\n[sagelib-8.5.rc0]  #define GAP_Enter() GAP_Error_Setjmp(); GAP_EnterStack()\n[sagelib-8.5.rc0]                      ^~~~~~~~~~~~~~~~\n[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c:9107:21: note: in expansion of macro \u2018GAP_Enter\u2019\n[sagelib-8.5.rc0]          __pyx_t_5 = GAP_Enter(); if (unlikely(__pyx_t_5 == ((int)0))) __PYX_ERR(0, 875, __pyx_L6_error)\n[sagelib-8.5.rc0]                      ^~~~~~~~~\n[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c: In function \u2018__pyx_f_4sage_4libs_3gap_7element_10GapElement__sub_\u2019:\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:43: error: \u2018ReadJmpError\u2019 undeclared (first use in this function)\n[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))\n[sagelib-8.5.rc0]                                            ^\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:28: note: in expansion of macro \u2018sySetjmp\u2019\n[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))\n[sagelib-8.5.rc0]                             ^~~~~~~~\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:86:21: note: in expansion of macro \u2018GAP_Error_Setjmp\u2019\n[sagelib-8.5.rc0]  #define GAP_Enter() GAP_Error_Setjmp(); GAP_EnterStack()\n[sagelib-8.5.rc0]                      ^~~~~~~~~~~~~~~~\n[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c:9480:21: note: in expansion of macro \u2018GAP_Enter\u2019\n[sagelib-8.5.rc0]          __pyx_t_5 = GAP_Enter(); if (unlikely(__pyx_t_5 == ((int)0))) __PYX_ERR(0, 907, __pyx_L6_error)\n[sagelib-8.5.rc0]                      ^~~~~~~~~\n[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c: In function \u2018__pyx_f_4sage_4libs_3gap_7element_10GapElement__mul_\u2019:\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:43: error: \u2018ReadJmpError\u2019 undeclared (first use in this function)\n[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))\n[sagelib-8.5.rc0]                                            ^\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:28: note: in expansion of macro \u2018sySetjmp\u2019\n[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))\n[sagelib-8.5.rc0]                             ^~~~~~~~\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:86:21: note: in expansion of macro \u2018GAP_Error_Setjmp\u2019\n[sagelib-8.5.rc0]  #define GAP_Enter() GAP_Error_Setjmp(); GAP_EnterStack()\n[sagelib-8.5.rc0]                      ^~~~~~~~~~~~~~~~\n[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c:9867:21: note: in expansion of macro \u2018GAP_Enter\u2019\n[sagelib-8.5.rc0]          __pyx_t_5 = GAP_Enter(); if (unlikely(__pyx_t_5 == ((int)0))) __PYX_ERR(0, 939, __pyx_L6_error)\n[sagelib-8.5.rc0]                      ^~~~~~~~~\n[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c: In function \u2018__pyx_f_4sage_4libs_3gap_7element_10GapElement__div_\u2019:\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:43: error: \u2018ReadJmpError\u2019 undeclared (first use in this function)\n[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))\n[sagelib-8.5.rc0]                                            ^\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:28: note: in expansion of macro \u2018sySetjmp\u2019\n[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))\n[sagelib-8.5.rc0]                             ^~~~~~~~\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:86:21: note: in expansion of macro \u2018GAP_Error_Setjmp\u2019\n[sagelib-8.5.rc0]  #define GAP_Enter() GAP_Error_Setjmp(); GAP_EnterStack()\n[sagelib-8.5.rc0]                      ^~~~~~~~~~~~~~~~\n[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c:10253:21: note: in expansion of macro \u2018GAP_Enter\u2019\n[sagelib-8.5.rc0]          __pyx_t_5 = GAP_Enter(); if (unlikely(__pyx_t_5 == ((int)0))) __PYX_ERR(0, 976, __pyx_L6_error)\n[sagelib-8.5.rc0]                      ^~~~~~~~~\n[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c: In function \u2018__pyx_f_4sage_4libs_3gap_7element_10GapElement__mod_\u2019:\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:43: error: \u2018ReadJmpError\u2019 undeclared (first use in this function)\n[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))\n[sagelib-8.5.rc0]                                            ^\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:28: note: in expansion of macro \u2018sySetjmp\u2019\n[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))\n[sagelib-8.5.rc0]                             ^~~~~~~~\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:86:21: note: in expansion of macro \u2018GAP_Error_Setjmp\u2019\n[sagelib-8.5.rc0]  #define GAP_Enter() GAP_Error_Setjmp(); GAP_EnterStack()\n[sagelib-8.5.rc0]                      ^~~~~~~~~~~~~~~~\n[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c:10625:21: note: in expansion of macro \u2018GAP_Enter\u2019\n[sagelib-8.5.rc0]          __pyx_t_5 = GAP_Enter(); if (unlikely(__pyx_t_5 == ((int)0))) __PYX_ERR(0, 1005, __pyx_L6_error)\n[sagelib-8.5.rc0]                      ^~~~~~~~~\n[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c: In function \u2018__pyx_pf_4sage_4libs_3gap_7element_10GapElement_40__pow__\u2019:\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:43: error: \u2018ReadJmpError\u2019 undeclared (first use in this function)\n[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))\n[sagelib-8.5.rc0]                                            ^\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:28: note: in expansion of macro \u2018sySetjmp\u2019\n[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))\n[sagelib-8.5.rc0]                             ^~~~~~~~\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:86:21: note: in expansion of macro \u2018GAP_Error_Setjmp\u2019\n[sagelib-8.5.rc0]  #define GAP_Enter() GAP_Error_Setjmp(); GAP_EnterStack()\n[sagelib-8.5.rc0]                      ^~~~~~~~~~~~~~~~\n[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c:11048:21: note: in expansion of macro \u2018GAP_Enter\u2019\n[sagelib-8.5.rc0]          __pyx_t_6 = GAP_Enter(); if (unlikely(__pyx_t_6 == ((int)0))) __PYX_ERR(0, 1044, __pyx_L7_error)\n[sagelib-8.5.rc0]                      ^~~~~~~~~\n[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c: In function \u2018__pyx_pf_4sage_4libs_3gap_7element_19GapElement_Function_2__call__\u2019:\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:43: error: \u2018ReadJmpError\u2019 undeclared (first use in this function)\n[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))\n[sagelib-8.5.rc0]                                            ^\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:28: note: in expansion of macro \u2018sySetjmp\u2019\n[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))\n[sagelib-8.5.rc0]                             ^~~~~~~~\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:86:21: note: in expansion of macro \u2018GAP_Error_Setjmp\u2019\n[sagelib-8.5.rc0]  #define GAP_Enter() GAP_Error_Setjmp(); GAP_EnterStack()\n[sagelib-8.5.rc0]                      ^~~~~~~~~~~~~~~~\n[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c:17678:21: note: in expansion of macro \u2018GAP_Enter\u2019\n[sagelib-8.5.rc0]          __pyx_t_9 = GAP_Enter(); if (unlikely(__pyx_t_9 == ((int)0))) __PYX_ERR(0, 2310, __pyx_L9_error)\n[sagelib-8.5.rc0]                      ^~~~~~~~~\n[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c: In function \u2018__pyx_pf_4sage_4libs_3gap_7element_17GapElement_Record_6__getitem__\u2019:\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:43: error: \u2018ReadJmpError\u2019 undeclared (first use in this function)\n[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))\n[sagelib-8.5.rc0]                                            ^\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:28: note: in expansion of macro \u2018sySetjmp\u2019\n[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))\n[sagelib-8.5.rc0]                             ^~~~~~~~\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:86:21: note: in expansion of macro \u2018GAP_Error_Setjmp\u2019\n[sagelib-8.5.rc0]  #define GAP_Enter() GAP_Error_Setjmp(); GAP_EnterStack()\n[sagelib-8.5.rc0]                      ^~~~~~~~~~~~~~~~\n[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c:21586:21: note: in expansion of macro \u2018GAP_Enter\u2019\n[sagelib-8.5.rc0]          __pyx_t_1 = GAP_Enter(); if (unlikely(__pyx_t_1 == ((int)0))) __PYX_ERR(0, 2994, __pyx_L6_error)\n[sagelib-8.5.rc0]                      ^~~~~~~~~\n[sagelib-8.5.rc0] [  2/304] gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -fPIC -I./sage/cpython -I/home/dimpase/Sage/sagetrac-mirror/local/include -I/home/dimpase/Sage/sagetrac-mirror/local/include/python2.7 -I/home/dimpase/Sage/sagetrac-mirror/local/lib/python2.7/site-packages/numpy/core/include -I/home/dimpase/Sage/sagetrac-mirror/src -I/home/dimpase/Sage/sagetrac-mirror/src/sage/ext -Ibuild/cythonized -I/home/dimpase/Sage/sagetrac-mirror/local/include/python2.7 -c build/cythonized/sage/libs/gap/libgap.c -o build/temp.linux-x86_64-2.7/build/cythonized/sage/libs/gap/libgap.o -fno-strict-aliasing -DCYTHON_CLINE_IN_TRACEBACK=1 -std=c99\n[sagelib-8.5.rc0] error: command 'gcc' failed with exit status 1\n[sagelib-8.5.rc0] In file included from /home/dimpase/Sage/sagetrac-mirror/local/include/gap/system.h:27:0,\n[sagelib-8.5.rc0]                  from build/cythonized/sage/libs/gap/libgap.c:653:\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/config.h:159:0: warning: \"HAVE_STAT\" redefined\n[sagelib-8.5.rc0]  #define HAVE_STAT 1\n[sagelib-8.5.rc0]  \n[sagelib-8.5.rc0] In file included from /home/dimpase/Sage/sagetrac-mirror/local/include/python2.7/Python.h:61:0,\n[sagelib-8.5.rc0]                  from build/cythonized/sage/libs/gap/libgap.c:46:\n[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/python2.7/pyport.h:374:0: note: this is the location of the previous definition\n[sagelib-8.5.rc0]  #define HAVE_STAT\n[sagelib-8.5.rc0]  \n[sagelib-8.5.rc0] Makefile:33: recipe for target 'sage' failed\n[sagelib-8.5.rc0] make[4]: *** [sage] Error 1\n[sagelib-8.5.rc0] make[4]: Leaving directory '/home/dimpase/Sage/sagetrac-mirror/src'\n[sagelib-8.5.rc0] \n[sagelib-8.5.rc0] real\t0m5.070s\n[sagelib-8.5.rc0] user\t0m3.966s\n[sagelib-8.5.rc0] sys\t0m1.078s\nMakefile:1945: recipe for target 'sagelib' failed\nmake[3]: *** [sagelib] Error 2\n```",
    "created_at": "2018-12-11T12:50:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423575",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:6'></a>
I have a problem building this branch, with Sage 8.5.rc0, on Debian:
(even tried `make distclean` first, to no avail). Any idea what's wrong?:

```
[sagelib-8.5.rc0] [  1/304] gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -fPIC -I./sage/cpython -Isage/cpython -I/home/dimpase/Sage/sagetrac-mirror/local/lib/python2.7/site-packages/cysignals -I/home/dimpase/Sage/sagetrac-mirror/local/include -I/home/dimpase/Sage/sagetrac-mirror/local/include/python2.7 -I/home/dimpase/Sage/sagetrac-mirror/local/lib/python2.7/site-packages/numpy/core/include -I/home/dimpase/Sage/sagetrac-mirror/src -I/home/dimpase/Sage/sagetrac-mirror/src/sage/ext -Ibuild/cythonized -I/home/dimpase/Sage/sagetrac-mirror/local/include/python2.7 -c build/cythonized/sage/libs/gap/element.c -o build/temp.linux-x86_64-2.7/build/cythonized/sage/libs/gap/element.o -fno-strict-aliasing -DCYTHON_CLINE_IN_TRACEBACK=1 -std=c99
[sagelib-8.5.rc0] In file included from /home/dimpase/Sage/sagetrac-mirror/local/include/gap/system.h:27:0,
[sagelib-8.5.rc0]                  from build/cythonized/sage/libs/gap/element.c:660:
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/config.h:159:0: warning: "HAVE_STAT" redefined
[sagelib-8.5.rc0]  #define HAVE_STAT 1
[sagelib-8.5.rc0]  
[sagelib-8.5.rc0] In file included from /home/dimpase/Sage/sagetrac-mirror/local/include/python2.7/Python.h:61:0,
[sagelib-8.5.rc0]                  from build/cythonized/sage/libs/gap/element.c:53:
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/python2.7/pyport.h:374:0: note: this is the location of the previous definition
[sagelib-8.5.rc0]  #define HAVE_STAT
[sagelib-8.5.rc0]  
[sagelib-8.5.rc0] In file included from /home/dimpase/Sage/sagetrac-mirror/local/include/gap/system.h:32:0,
[sagelib-8.5.rc0]                  from build/cythonized/sage/libs/gap/element.c:660:
[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c: In function ‚Äò__pyx_f_4sage_4libs_3gap_7element_crepr‚Äô:
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:37: warning: implicit declaration of function ‚ÄòSTATE‚Äô [-Wimplicit-function-declaration]
[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))
[sagelib-8.5.rc0]                                      ^
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:28: note: in expansion of macro ‚ÄòsySetjmp‚Äô
[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))
[sagelib-8.5.rc0]                             ^~~~~~~~
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:86:21: note: in expansion of macro ‚ÄòGAP_Error_Setjmp‚Äô
[sagelib-8.5.rc0]  #define GAP_Enter() GAP_Error_Setjmp(); GAP_EnterStack()
[sagelib-8.5.rc0]                      ^~~~~~~~~~~~~~~~
[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c:4137:17: note: in expansion of macro ‚ÄòGAP_Enter‚Äô
[sagelib-8.5.rc0]      __pyx_t_1 = GAP_Enter(); if (unlikely(__pyx_t_1 == ((int)0))) __PYX_ERR(0, 100, __pyx_L4_error)
[sagelib-8.5.rc0]                  ^~~~~~~~~
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:43: error: ‚ÄòReadJmpError‚Äô undeclared (first use in this function)
[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))
[sagelib-8.5.rc0]                                            ^
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:28: note: in expansion of macro ‚ÄòsySetjmp‚Äô
[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))
[sagelib-8.5.rc0]                             ^~~~~~~~
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:86:21: note: in expansion of macro ‚ÄòGAP_Error_Setjmp‚Äô
[sagelib-8.5.rc0]  #define GAP_Enter() GAP_Error_Setjmp(); GAP_EnterStack()
[sagelib-8.5.rc0]                      ^~~~~~~~~~~~~~~~
[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c:4137:17: note: in expansion of macro ‚ÄòGAP_Enter‚Äô
[sagelib-8.5.rc0]      __pyx_t_1 = GAP_Enter(); if (unlikely(__pyx_t_1 == ((int)0))) __PYX_ERR(0, 100, __pyx_L4_error)
[sagelib-8.5.rc0]                  ^~~~~~~~~
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:43: note: each undeclared identifier is reported only once for each function it appears in
[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))
[sagelib-8.5.rc0]                                            ^
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:28: note: in expansion of macro ‚ÄòsySetjmp‚Äô
[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))
[sagelib-8.5.rc0]                             ^~~~~~~~
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:86:21: note: in expansion of macro ‚ÄòGAP_Error_Setjmp‚Äô
[sagelib-8.5.rc0]  #define GAP_Enter() GAP_Error_Setjmp(); GAP_EnterStack()
[sagelib-8.5.rc0]                      ^~~~~~~~~~~~~~~~
[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c:4137:17: note: in expansion of macro ‚ÄòGAP_Enter‚Äô
[sagelib-8.5.rc0]      __pyx_t_1 = GAP_Enter(); if (unlikely(__pyx_t_1 == ((int)0))) __PYX_ERR(0, 100, __pyx_L4_error)
[sagelib-8.5.rc0]                  ^~~~~~~~~
[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c: In function ‚Äò__pyx_f_4sage_4libs_3gap_7element_make_gap_record‚Äô:
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:43: error: ‚ÄòReadJmpError‚Äô undeclared (first use in this function)
[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))
[sagelib-8.5.rc0]                                            ^
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:28: note: in expansion of macro ‚ÄòsySetjmp‚Äô
[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))
[sagelib-8.5.rc0]                             ^~~~~~~~
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:86:21: note: in expansion of macro ‚ÄòGAP_Error_Setjmp‚Äô
[sagelib-8.5.rc0]  #define GAP_Enter() GAP_Error_Setjmp(); GAP_EnterStack()
[sagelib-8.5.rc0]                      ^~~~~~~~~~~~~~~~
[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c:4443:17: note: in expansion of macro ‚ÄòGAP_Enter‚Äô
[sagelib-8.5.rc0]      __pyx_t_5 = GAP_Enter(); if (unlikely(__pyx_t_5 == ((int)0))) __PYX_ERR(0, 142, __pyx_L6_error)
[sagelib-8.5.rc0]                  ^~~~~~~~~
[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c: In function ‚Äò__pyx_f_4sage_4libs_3gap_7element_make_gap_integer‚Äô:
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:43: error: ‚ÄòReadJmpError‚Äô undeclared (first use in this function)
[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))
[sagelib-8.5.rc0]                                            ^
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:28: note: in expansion of macro ‚ÄòsySetjmp‚Äô
[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))
[sagelib-8.5.rc0]                             ^~~~~~~~
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:86:21: note: in expansion of macro ‚ÄòGAP_Error_Setjmp‚Äô
[sagelib-8.5.rc0]  #define GAP_Enter() GAP_Error_Setjmp(); GAP_EnterStack()
[sagelib-8.5.rc0]                      ^~~~~~~~~~~~~~~~
[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c:4700:17: note: in expansion of macro ‚ÄòGAP_Enter‚Äô
[sagelib-8.5.rc0]      __pyx_t_1 = GAP_Enter(); if (unlikely(__pyx_t_1 == ((int)0))) __PYX_ERR(0, 172, __pyx_L4_error)
[sagelib-8.5.rc0]                  ^~~~~~~~~
[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c: In function ‚Äò__pyx_f_4sage_4libs_3gap_7element_make_gap_string‚Äô:
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:43: error: ‚ÄòReadJmpError‚Äô undeclared (first use in this function)
[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))
[sagelib-8.5.rc0]                                            ^
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:28: note: in expansion of macro ‚ÄòsySetjmp‚Äô
[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))
[sagelib-8.5.rc0]                             ^~~~~~~~
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:86:21: note: in expansion of macro ‚ÄòGAP_Error_Setjmp‚Äô
[sagelib-8.5.rc0]  #define GAP_Enter() GAP_Error_Setjmp(); GAP_EnterStack()
[sagelib-8.5.rc0]                      ^~~~~~~~~~~~~~~~
[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c:4831:17: note: in expansion of macro ‚ÄòGAP_Enter‚Äô
[sagelib-8.5.rc0]      __pyx_t_1 = GAP_Enter(); if (unlikely(__pyx_t_1 == ((int)0))) __PYX_ERR(0, 198, __pyx_L4_error)
[sagelib-8.5.rc0]                  ^~~~~~~~~
[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c: In function ‚Äò__pyx_f_4sage_4libs_3gap_7element_make_any_gap_element‚Äô:
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:43: error: ‚ÄòReadJmpError‚Äô undeclared (first use in this function)
[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))
[sagelib-8.5.rc0]                                            ^
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:28: note: in expansion of macro ‚ÄòsySetjmp‚Äô
[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))
[sagelib-8.5.rc0]                             ^~~~~~~~
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:86:21: note: in expansion of macro ‚ÄòGAP_Error_Setjmp‚Äô
[sagelib-8.5.rc0]  #define GAP_Enter() GAP_Error_Setjmp(); GAP_EnterStack()
[sagelib-8.5.rc0]                      ^~~~~~~~~~~~~~~~
[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c:4991:17: note: in expansion of macro ‚ÄòGAP_Enter‚Äô
[sagelib-8.5.rc0]      __pyx_t_1 = GAP_Enter(); if (unlikely(__pyx_t_1 == ((int)0))) __PYX_ERR(0, 249, __pyx_L4_error)
[sagelib-8.5.rc0]                  ^~~~~~~~~
[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c: In function ‚Äò__pyx_f_4sage_4libs_3gap_7element_10GapElement__compare_equal‚Äô:
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:43: error: ‚ÄòReadJmpError‚Äô undeclared (first use in this function)
[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))
[sagelib-8.5.rc0]                                            ^
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:28: note: in expansion of macro ‚ÄòsySetjmp‚Äô
[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))
[sagelib-8.5.rc0]                             ^~~~~~~~
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:86:21: note: in expansion of macro ‚ÄòGAP_Error_Setjmp‚Äô
[sagelib-8.5.rc0]  #define GAP_Enter() GAP_Error_Setjmp(); GAP_EnterStack()
[sagelib-8.5.rc0]                      ^~~~~~~~~~~~~~~~
[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c:8510:21: note: in expansion of macro ‚ÄòGAP_Enter‚Äô
[sagelib-8.5.rc0]          __pyx_t_5 = GAP_Enter(); if (unlikely(__pyx_t_5 == ((int)0))) __PYX_ERR(0, 821, __pyx_L7_error)
[sagelib-8.5.rc0]                      ^~~~~~~~~
[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c: In function ‚Äò__pyx_f_4sage_4libs_3gap_7element_10GapElement__compare_less‚Äô:
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:43: error: ‚ÄòReadJmpError‚Äô undeclared (first use in this function)
[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))
[sagelib-8.5.rc0]                                            ^
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:28: note: in expansion of macro ‚ÄòsySetjmp‚Äô
[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))
[sagelib-8.5.rc0]                             ^~~~~~~~
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:86:21: note: in expansion of macro ‚ÄòGAP_Error_Setjmp‚Äô
[sagelib-8.5.rc0]  #define GAP_Enter() GAP_Error_Setjmp(); GAP_EnterStack()
[sagelib-8.5.rc0]                      ^~~~~~~~~~~~~~~~
[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c:8810:21: note: in expansion of macro ‚ÄòGAP_Enter‚Äô
[sagelib-8.5.rc0]          __pyx_t_5 = GAP_Enter(); if (unlikely(__pyx_t_5 == ((int)0))) __PYX_ERR(0, 845, __pyx_L7_error)
[sagelib-8.5.rc0]                      ^~~~~~~~~
[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c: In function ‚Äò__pyx_f_4sage_4libs_3gap_7element_10GapElement__add_‚Äô:
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:43: error: ‚ÄòReadJmpError‚Äô undeclared (first use in this function)
[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))
[sagelib-8.5.rc0]                                            ^
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:28: note: in expansion of macro ‚ÄòsySetjmp‚Äô
[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))
[sagelib-8.5.rc0]                             ^~~~~~~~
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:86:21: note: in expansion of macro ‚ÄòGAP_Error_Setjmp‚Äô
[sagelib-8.5.rc0]  #define GAP_Enter() GAP_Error_Setjmp(); GAP_EnterStack()
[sagelib-8.5.rc0]                      ^~~~~~~~~~~~~~~~
[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c:9107:21: note: in expansion of macro ‚ÄòGAP_Enter‚Äô
[sagelib-8.5.rc0]          __pyx_t_5 = GAP_Enter(); if (unlikely(__pyx_t_5 == ((int)0))) __PYX_ERR(0, 875, __pyx_L6_error)
[sagelib-8.5.rc0]                      ^~~~~~~~~
[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c: In function ‚Äò__pyx_f_4sage_4libs_3gap_7element_10GapElement__sub_‚Äô:
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:43: error: ‚ÄòReadJmpError‚Äô undeclared (first use in this function)
[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))
[sagelib-8.5.rc0]                                            ^
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:28: note: in expansion of macro ‚ÄòsySetjmp‚Äô
[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))
[sagelib-8.5.rc0]                             ^~~~~~~~
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:86:21: note: in expansion of macro ‚ÄòGAP_Error_Setjmp‚Äô
[sagelib-8.5.rc0]  #define GAP_Enter() GAP_Error_Setjmp(); GAP_EnterStack()
[sagelib-8.5.rc0]                      ^~~~~~~~~~~~~~~~
[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c:9480:21: note: in expansion of macro ‚ÄòGAP_Enter‚Äô
[sagelib-8.5.rc0]          __pyx_t_5 = GAP_Enter(); if (unlikely(__pyx_t_5 == ((int)0))) __PYX_ERR(0, 907, __pyx_L6_error)
[sagelib-8.5.rc0]                      ^~~~~~~~~
[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c: In function ‚Äò__pyx_f_4sage_4libs_3gap_7element_10GapElement__mul_‚Äô:
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:43: error: ‚ÄòReadJmpError‚Äô undeclared (first use in this function)
[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))
[sagelib-8.5.rc0]                                            ^
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:28: note: in expansion of macro ‚ÄòsySetjmp‚Äô
[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))
[sagelib-8.5.rc0]                             ^~~~~~~~
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:86:21: note: in expansion of macro ‚ÄòGAP_Error_Setjmp‚Äô
[sagelib-8.5.rc0]  #define GAP_Enter() GAP_Error_Setjmp(); GAP_EnterStack()
[sagelib-8.5.rc0]                      ^~~~~~~~~~~~~~~~
[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c:9867:21: note: in expansion of macro ‚ÄòGAP_Enter‚Äô
[sagelib-8.5.rc0]          __pyx_t_5 = GAP_Enter(); if (unlikely(__pyx_t_5 == ((int)0))) __PYX_ERR(0, 939, __pyx_L6_error)
[sagelib-8.5.rc0]                      ^~~~~~~~~
[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c: In function ‚Äò__pyx_f_4sage_4libs_3gap_7element_10GapElement__div_‚Äô:
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:43: error: ‚ÄòReadJmpError‚Äô undeclared (first use in this function)
[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))
[sagelib-8.5.rc0]                                            ^
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:28: note: in expansion of macro ‚ÄòsySetjmp‚Äô
[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))
[sagelib-8.5.rc0]                             ^~~~~~~~
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:86:21: note: in expansion of macro ‚ÄòGAP_Error_Setjmp‚Äô
[sagelib-8.5.rc0]  #define GAP_Enter() GAP_Error_Setjmp(); GAP_EnterStack()
[sagelib-8.5.rc0]                      ^~~~~~~~~~~~~~~~
[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c:10253:21: note: in expansion of macro ‚ÄòGAP_Enter‚Äô
[sagelib-8.5.rc0]          __pyx_t_5 = GAP_Enter(); if (unlikely(__pyx_t_5 == ((int)0))) __PYX_ERR(0, 976, __pyx_L6_error)
[sagelib-8.5.rc0]                      ^~~~~~~~~
[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c: In function ‚Äò__pyx_f_4sage_4libs_3gap_7element_10GapElement__mod_‚Äô:
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:43: error: ‚ÄòReadJmpError‚Äô undeclared (first use in this function)
[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))
[sagelib-8.5.rc0]                                            ^
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:28: note: in expansion of macro ‚ÄòsySetjmp‚Äô
[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))
[sagelib-8.5.rc0]                             ^~~~~~~~
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:86:21: note: in expansion of macro ‚ÄòGAP_Error_Setjmp‚Äô
[sagelib-8.5.rc0]  #define GAP_Enter() GAP_Error_Setjmp(); GAP_EnterStack()
[sagelib-8.5.rc0]                      ^~~~~~~~~~~~~~~~
[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c:10625:21: note: in expansion of macro ‚ÄòGAP_Enter‚Äô
[sagelib-8.5.rc0]          __pyx_t_5 = GAP_Enter(); if (unlikely(__pyx_t_5 == ((int)0))) __PYX_ERR(0, 1005, __pyx_L6_error)
[sagelib-8.5.rc0]                      ^~~~~~~~~
[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c: In function ‚Äò__pyx_pf_4sage_4libs_3gap_7element_10GapElement_40__pow__‚Äô:
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:43: error: ‚ÄòReadJmpError‚Äô undeclared (first use in this function)
[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))
[sagelib-8.5.rc0]                                            ^
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:28: note: in expansion of macro ‚ÄòsySetjmp‚Äô
[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))
[sagelib-8.5.rc0]                             ^~~~~~~~
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:86:21: note: in expansion of macro ‚ÄòGAP_Error_Setjmp‚Äô
[sagelib-8.5.rc0]  #define GAP_Enter() GAP_Error_Setjmp(); GAP_EnterStack()
[sagelib-8.5.rc0]                      ^~~~~~~~~~~~~~~~
[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c:11048:21: note: in expansion of macro ‚ÄòGAP_Enter‚Äô
[sagelib-8.5.rc0]          __pyx_t_6 = GAP_Enter(); if (unlikely(__pyx_t_6 == ((int)0))) __PYX_ERR(0, 1044, __pyx_L7_error)
[sagelib-8.5.rc0]                      ^~~~~~~~~
[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c: In function ‚Äò__pyx_pf_4sage_4libs_3gap_7element_19GapElement_Function_2__call__‚Äô:
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:43: error: ‚ÄòReadJmpError‚Äô undeclared (first use in this function)
[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))
[sagelib-8.5.rc0]                                            ^
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:28: note: in expansion of macro ‚ÄòsySetjmp‚Äô
[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))
[sagelib-8.5.rc0]                             ^~~~~~~~
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:86:21: note: in expansion of macro ‚ÄòGAP_Error_Setjmp‚Äô
[sagelib-8.5.rc0]  #define GAP_Enter() GAP_Error_Setjmp(); GAP_EnterStack()
[sagelib-8.5.rc0]                      ^~~~~~~~~~~~~~~~
[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c:17678:21: note: in expansion of macro ‚ÄòGAP_Enter‚Äô
[sagelib-8.5.rc0]          __pyx_t_9 = GAP_Enter(); if (unlikely(__pyx_t_9 == ((int)0))) __PYX_ERR(0, 2310, __pyx_L9_error)
[sagelib-8.5.rc0]                      ^~~~~~~~~
[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c: In function ‚Äò__pyx_pf_4sage_4libs_3gap_7element_17GapElement_Record_6__getitem__‚Äô:
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:43: error: ‚ÄòReadJmpError‚Äô undeclared (first use in this function)
[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))
[sagelib-8.5.rc0]                                            ^
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:83:28: note: in expansion of macro ‚ÄòsySetjmp‚Äô
[sagelib-8.5.rc0]          _GAP_Error_Postjmp(sySetjmp(STATE(ReadJmpError))))
[sagelib-8.5.rc0]                             ^~~~~~~~
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/libgap-api.h:86:21: note: in expansion of macro ‚ÄòGAP_Error_Setjmp‚Äô
[sagelib-8.5.rc0]  #define GAP_Enter() GAP_Error_Setjmp(); GAP_EnterStack()
[sagelib-8.5.rc0]                      ^~~~~~~~~~~~~~~~
[sagelib-8.5.rc0] build/cythonized/sage/libs/gap/element.c:21586:21: note: in expansion of macro ‚ÄòGAP_Enter‚Äô
[sagelib-8.5.rc0]          __pyx_t_1 = GAP_Enter(); if (unlikely(__pyx_t_1 == ((int)0))) __PYX_ERR(0, 2994, __pyx_L6_error)
[sagelib-8.5.rc0]                      ^~~~~~~~~
[sagelib-8.5.rc0] [  2/304] gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -fPIC -I./sage/cpython -I/home/dimpase/Sage/sagetrac-mirror/local/include -I/home/dimpase/Sage/sagetrac-mirror/local/include/python2.7 -I/home/dimpase/Sage/sagetrac-mirror/local/lib/python2.7/site-packages/numpy/core/include -I/home/dimpase/Sage/sagetrac-mirror/src -I/home/dimpase/Sage/sagetrac-mirror/src/sage/ext -Ibuild/cythonized -I/home/dimpase/Sage/sagetrac-mirror/local/include/python2.7 -c build/cythonized/sage/libs/gap/libgap.c -o build/temp.linux-x86_64-2.7/build/cythonized/sage/libs/gap/libgap.o -fno-strict-aliasing -DCYTHON_CLINE_IN_TRACEBACK=1 -std=c99
[sagelib-8.5.rc0] error: command 'gcc' failed with exit status 1
[sagelib-8.5.rc0] In file included from /home/dimpase/Sage/sagetrac-mirror/local/include/gap/system.h:27:0,
[sagelib-8.5.rc0]                  from build/cythonized/sage/libs/gap/libgap.c:653:
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/gap/config.h:159:0: warning: "HAVE_STAT" redefined
[sagelib-8.5.rc0]  #define HAVE_STAT 1
[sagelib-8.5.rc0]  
[sagelib-8.5.rc0] In file included from /home/dimpase/Sage/sagetrac-mirror/local/include/python2.7/Python.h:61:0,
[sagelib-8.5.rc0]                  from build/cythonized/sage/libs/gap/libgap.c:46:
[sagelib-8.5.rc0] /home/dimpase/Sage/sagetrac-mirror/local/include/python2.7/pyport.h:374:0: note: this is the location of the previous definition
[sagelib-8.5.rc0]  #define HAVE_STAT
[sagelib-8.5.rc0]  
[sagelib-8.5.rc0] Makefile:33: recipe for target 'sage' failed
[sagelib-8.5.rc0] make[4]: *** [sage] Error 1
[sagelib-8.5.rc0] make[4]: Leaving directory '/home/dimpase/Sage/sagetrac-mirror/src'
[sagelib-8.5.rc0] 
[sagelib-8.5.rc0] real	0m5.070s
[sagelib-8.5.rc0] user	0m3.966s
[sagelib-8.5.rc0] sys	0m1.078s
Makefile:1945: recipe for target 'sagelib' failed
make[3]: *** [sagelib] Error 2
```



---

archive/issue_comments_423576.json:
```json
{
    "body": "<a id='comment:7'></a>\nI see the problem: The regression isn't in `IsDocumentedWord`, but rather the number of docs being searched.  Right now I'm installing all the officially supported GAP packages, which obviously we should *not* do for base gap SPGK in Sage.  This needs to be fixed.\n\nHowever, this code should also work on other distributions where any arbitrary number of GAP packages might be installed.  Therefore, it would be good to figure out a way to prevent this code from searching docs for packages, and just limit this to global functions built into GAP by default.",
    "created_at": "2018-12-11T12:51:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423576",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>
I see the problem: The regression isn't in `IsDocumentedWord`, but rather the number of docs being searched.  Right now I'm installing all the officially supported GAP packages, which obviously we should *not* do for base gap SPGK in Sage.  This needs to be fixed.

However, this code should also work on other distributions where any arbitrary number of GAP packages might be installed.  Therefore, it would be good to figure out a way to prevent this code from searching docs for packages, and just limit this to global functions built into GAP by default.



---

archive/issue_comments_423577.json:
```json
{
    "body": "<a id='comment:358'></a>\nReplying to [dimpase](#comment%3A356):\n> I have a problem building this branch, with Sage 8.5.rc0, on Debian:\n> (even tried `make distclean` first, to no avail). Any idea what's wrong?:\n\n\nYikes, sorry about that.  I fixed that locally but I didn't push the fix upstream yet.  It's just a missing include in my patch to libgap-api.h.",
    "created_at": "2018-12-11T12:52:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423577",
    "user": "https://github.com/embray"
}
```

<a id='comment:358'></a>
Replying to [dimpase](#comment%3A356):
> I have a problem building this branch, with Sage 8.5.rc0, on Debian:
> (even tried `make distclean` first, to no avail). Any idea what's wrong?:


Yikes, sorry about that.  I fixed that locally but I didn't push the fix upstream yet.  It's just a missing include in my patch to libgap-api.h.



---

archive/issue_comments_423578.json:
```json
{
    "body": "**Changing commit** from \"[15b7c7855d9097143e2b582b4831d2fb50294f53](https://github.com/sagemath/sagetrac-mirror/commit/15b7c7855d9097143e2b582b4831d2fb50294f53)\" to \"[16be3fc65e8fbac3efae68eebc98abe1aa503790](https://github.com/sagemath/sagetrac-mirror/commit/16be3fc65e8fbac3efae68eebc98abe1aa503790)\".",
    "created_at": "2018-12-11T13:35:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423578",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[15b7c7855d9097143e2b582b4831d2fb50294f53](https://github.com/sagemath/sagetrac-mirror/commit/15b7c7855d9097143e2b582b4831d2fb50294f53)" to "[16be3fc65e8fbac3efae68eebc98abe1aa503790](https://github.com/sagemath/sagetrac-mirror/commit/16be3fc65e8fbac3efae68eebc98abe1aa503790)".



---

archive/issue_comments_423579.json:
```json
{
    "body": "<a id='comment:9'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6d04a8a06105ba988f8268602d47142901a58e08\">6d04a8a</a></td><td><code>fix a typo in the new version of Gap.show</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/16be3fc65e8fbac3efae68eebc98abe1aa503790\">16be3fc</a></td><td><code>updated GAP_Enter patch that does not require gapstate.h in libgap-api.h</code></td></tr></table>\n",
    "created_at": "2018-12-11T13:35:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423579",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6d04a8a06105ba988f8268602d47142901a58e08">6d04a8a</a></td><td><code>fix a typo in the new version of Gap.show</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/16be3fc65e8fbac3efae68eebc98abe1aa503790">16be3fc</a></td><td><code>updated GAP_Enter patch that does not require gapstate.h in libgap-api.h</code></td></tr></table>




---

archive/issue_comments_423580.json:
```json
{
    "body": "<a id='comment:0'></a>\nShould work now.  Make sure after `./sage -f gap` that you also at the very least make sure that any modules in Sage that depend on libgap are rebuilt.  I ensure that this happens by running `touch src/sage/libs/gap/gap_includes.pxd` followed by `./sage -b`.",
    "created_at": "2018-12-11T14:20:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423580",
    "user": "https://github.com/embray"
}
```

<a id='comment:0'></a>
Should work now.  Make sure after `./sage -f gap` that you also at the very least make sure that any modules in Sage that depend on libgap are rebuilt.  I ensure that this happens by running `touch src/sage/libs/gap/gap_includes.pxd` followed by `./sage -b`.



---

archive/issue_comments_423581.json:
```json
{
    "body": "<a id='comment:1'></a>\nI get a segfault in libs/gap/util.so during docbuilding, and also\nerrors like \n\n```\nsage -t src/sage/libs/gap/test.py\n**********************************************************************\nFile \"src/sage/libs/gap/test.py\", line 18, in sage.libs.gap.test.test_write_to_file\nFailed example:\n    test_write_to_file()\nException raised:\n    Traceback (most recent call last):\n      File \"/home/dimpase/Sage/sagetrac-mirror/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 671, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/dimpase/Sage/sagetrac-mirror/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1086, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.libs.gap.test.test_write_to_file[1]>\", line 1, in <module>\n        test_write_to_file()\n      File \"/home/dimpase/Sage/sagetrac-mirror/local/lib/python2.7/site-packages/sage/libs/gap/test.py\", line 22, in test_write_to_file\n        libgap.PrintTo(fname, message)\n      File \"sage/misc/lazy_import.pyx\", line 322, in sage.misc.lazy_import.LazyImport.__getattr__ (build/cythonized/sage/misc/lazy_import.c:3536)\n        return getattr(self.get_object(), attr)\n      File \"sage/libs/gap/libgap.pyx\", line 663, in sage.libs.gap.libgap.Gap.__getattr__ (build/cythonized/sage/libs/gap/libgap.c:6079)\n        from sage.libs.gap.gap_globals import common_gap_globals\n    ImportError: No module named gap_globals\n```",
    "created_at": "2018-12-11T16:13:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423581",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:1'></a>
I get a segfault in libs/gap/util.so during docbuilding, and also
errors like 

```
sage -t src/sage/libs/gap/test.py
**********************************************************************
File "src/sage/libs/gap/test.py", line 18, in sage.libs.gap.test.test_write_to_file
Failed example:
    test_write_to_file()
Exception raised:
    Traceback (most recent call last):
      File "/home/dimpase/Sage/sagetrac-mirror/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/dimpase/Sage/sagetrac-mirror/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1086, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.libs.gap.test.test_write_to_file[1]>", line 1, in <module>
        test_write_to_file()
      File "/home/dimpase/Sage/sagetrac-mirror/local/lib/python2.7/site-packages/sage/libs/gap/test.py", line 22, in test_write_to_file
        libgap.PrintTo(fname, message)
      File "sage/misc/lazy_import.pyx", line 322, in sage.misc.lazy_import.LazyImport.__getattr__ (build/cythonized/sage/misc/lazy_import.c:3536)
        return getattr(self.get_object(), attr)
      File "sage/libs/gap/libgap.pyx", line 663, in sage.libs.gap.libgap.Gap.__getattr__ (build/cythonized/sage/libs/gap/libgap.c:6079)
        from sage.libs.gap.gap_globals import common_gap_globals
    ImportError: No module named gap_globals
```



---

archive/issue_comments_423582.json:
```json
{
    "body": "<a id='comment:2'></a>\nI am also getting a segfault during doc build.  I don't know what that's about--it seems to come straight from `GAP_Initialize`.  Obviously I'll look into it...\n\nThe other problem is because I forgot to add a new file to a commit.",
    "created_at": "2018-12-12T11:36:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423582",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>
I am also getting a segfault during doc build.  I don't know what that's about--it seems to come straight from `GAP_Initialize`.  Obviously I'll look into it...

The other problem is because I forgot to add a new file to a commit.



---

archive/issue_comments_423583.json:
```json
{
    "body": "**Changing commit** from \"[16be3fc65e8fbac3efae68eebc98abe1aa503790](https://github.com/sagemath/sagetrac-mirror/commit/16be3fc65e8fbac3efae68eebc98abe1aa503790)\" to \"[0cf204795df0a2406078d6ac47a5cc8c7173277d](https://github.com/sagemath/sagetrac-mirror/commit/0cf204795df0a2406078d6ac47a5cc8c7173277d)\".",
    "created_at": "2018-12-12T11:37:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423583",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[16be3fc65e8fbac3efae68eebc98abe1aa503790](https://github.com/sagemath/sagetrac-mirror/commit/16be3fc65e8fbac3efae68eebc98abe1aa503790)" to "[0cf204795df0a2406078d6ac47a5cc8c7173277d](https://github.com/sagemath/sagetrac-mirror/commit/0cf204795df0a2406078d6ac47a5cc8c7173277d)".



---

archive/issue_comments_423584.json:
```json
{
    "body": "<a id='comment:3'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2820d4dbc5898297af08284ff176faa7190d23b0\">2820d4d</a></td><td><code>Deprecate Gap.mem and remove its functionality</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/60d7eb69ffa7d402495717148879906639324244\">60d7eb6</a></td><td><code>Allow Gap.__getattr__ to return GAP objects other than just functions</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0cf204795df0a2406078d6ac47a5cc8c7173277d\">0cf2047</a></td><td><code>updated GAP_Enter patch that does not require gapstate.h in libgap-api.h</code></td></tr></table>\n",
    "created_at": "2018-12-12T11:37:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423584",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2820d4dbc5898297af08284ff176faa7190d23b0">2820d4d</a></td><td><code>Deprecate Gap.mem and remove its functionality</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/60d7eb69ffa7d402495717148879906639324244">60d7eb6</a></td><td><code>Allow Gap.__getattr__ to return GAP objects other than just functions</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0cf204795df0a2406078d6ac47a5cc8c7173277d">0cf2047</a></td><td><code>updated GAP_Enter patch that does not require gapstate.h in libgap-api.h</code></td></tr></table>




---

archive/issue_comments_423585.json:
```json
{
    "body": "<a id='comment:4'></a>\nDid a forced push with some updated commits that fixed trivial mistakes (like the missing file).  Going to look into the segfault during docbuild now.  That's pretty disconcerting.",
    "created_at": "2018-12-12T11:39:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423585",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>
Did a forced push with some updated commits that fixed trivial mistakes (like the missing file).  Going to look into the segfault during docbuild now.  That's pretty disconcerting.



---

archive/issue_comments_423586.json:
```json
{
    "body": "<a id='comment:5'></a>\nmultithreading seems to be involved. Something with thread-local things, maybe...\n\n```\n...\n[dochtml] /home/dimpase/Sage/sagetrac-mirror/local/lib/libgap.so.0(GAP_Initialize+0x1a)[0x7bdfa5a06fba]\n[dochtml] /home/dimpase/Sage/sagetrac-mirror/local/lib/python2.7/site-packages/sage/libs/gap/util.so(+0xf72a)[0x7bdfa54dd72a]\n...\n[dochtml] /home/dimpase/Sage/sagetrac-mirror/local/lib/libpython2.7.so.1.0(+0x14e772)[0x7be030f22772]\n[dochtml] /lib/x86_64-linux-gnu/libpthread.so.0(+0x7494)[0x7be030bbe494]\n[dochtml] /lib/x86_64-linux-gnu/libc.so.6(clone+0x3f)[0x7be0301f5acf]\n[dochtml] ------------------------------------------------------------------------\n[dochtml] Attaching gdb to process id 14080.\n...\n```",
    "created_at": "2018-12-12T12:47:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423586",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:5'></a>
multithreading seems to be involved. Something with thread-local things, maybe...

```
...
[dochtml] /home/dimpase/Sage/sagetrac-mirror/local/lib/libgap.so.0(GAP_Initialize+0x1a)[0x7bdfa5a06fba]
[dochtml] /home/dimpase/Sage/sagetrac-mirror/local/lib/python2.7/site-packages/sage/libs/gap/util.so(+0xf72a)[0x7bdfa54dd72a]
...
[dochtml] /home/dimpase/Sage/sagetrac-mirror/local/lib/libpython2.7.so.1.0(+0x14e772)[0x7be030f22772]
[dochtml] /lib/x86_64-linux-gnu/libpthread.so.0(+0x7494)[0x7be030bbe494]
[dochtml] /lib/x86_64-linux-gnu/libc.so.6(clone+0x3f)[0x7be0301f5acf]
[dochtml] ------------------------------------------------------------------------
[dochtml] Attaching gdb to process id 14080.
...
```



---

archive/issue_comments_423587.json:
```json
{
    "body": "<a id='comment:6'></a>\nCould be, but I don't suspect so at the moment, as I'm able to reproduce this without starting any threads.  But I'm still not sure exactly what the problem is, as this is proving to be a bit of a heisenbug.",
    "created_at": "2018-12-12T14:10:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423587",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>
Could be, but I don't suspect so at the moment, as I'm able to reproduce this without starting any threads.  But I'm still not sure exactly what the problem is, as this is proving to be a bit of a heisenbug.



---

archive/issue_comments_423588.json:
```json
{
    "body": "<a id='comment:367'></a>\nReplying to [embray](#comment%3A360):\n> I ensure that this happens by running `touch src/sage/libs/gap/gap_includes.pxd`\n\n\nIsn't Cython picking up that dependency automatically? It should...",
    "created_at": "2018-12-12T15:14:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423588",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:367'></a>
Replying to [embray](#comment%3A360):
> I ensure that this happens by running `touch src/sage/libs/gap/gap_includes.pxd`


Isn't Cython picking up that dependency automatically? It should...



---

archive/issue_comments_423589.json:
```json
{
    "body": "**Changing commit** from \"[0cf204795df0a2406078d6ac47a5cc8c7173277d](https://github.com/sagemath/sagetrac-mirror/commit/0cf204795df0a2406078d6ac47a5cc8c7173277d)\" to \"[132a7c303a8639c51eb92061ac7cb39106f5d316](https://github.com/sagemath/sagetrac-mirror/commit/132a7c303a8639c51eb92061ac7cb39106f5d316)\".",
    "created_at": "2018-12-12T17:42:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423589",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[0cf204795df0a2406078d6ac47a5cc8c7173277d](https://github.com/sagemath/sagetrac-mirror/commit/0cf204795df0a2406078d6ac47a5cc8c7173277d)" to "[132a7c303a8639c51eb92061ac7cb39106f5d316](https://github.com/sagemath/sagetrac-mirror/commit/132a7c303a8639c51eb92061ac7cb39106f5d316)".



---

archive/issue_comments_423590.json:
```json
{
    "body": "<a id='comment:8'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/eefc0fc2a18aeec5472b04ba6b55d029c6c1aab6\">eefc0fc</a></td><td><code>fix warning from cython</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9292d47a01b4ffe2e33898722845ace6ab18e186\">9292d47</a></td><td><code>add sig_on/off() around GAP_Initialize, just in case unhandled segfaults or the like occur</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/132a7c303a8639c51eb92061ac7cb39106f5d316\">132a7c3</a></td><td><code>copy the current environment before passing it to GAP</code></td></tr></table>\n",
    "created_at": "2018-12-12T17:42:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423590",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/eefc0fc2a18aeec5472b04ba6b55d029c6c1aab6">eefc0fc</a></td><td><code>fix warning from cython</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9292d47a01b4ffe2e33898722845ace6ab18e186">9292d47</a></td><td><code>add sig_on/off() around GAP_Initialize, just in case unhandled segfaults or the like occur</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/132a7c303a8639c51eb92061ac7cb39106f5d316">132a7c3</a></td><td><code>copy the current environment before passing it to GAP</code></td></tr></table>




---

archive/issue_comments_423591.json:
```json
{
    "body": "<a id='comment:9'></a>\nThis should fix it.  What a sneaky problem though.  I think I will complain about this upstream...\n\nA better solution, I think, would be to allow passing `NULL` as the environment argument to `GAP_Initialize`, in which case GAP can just use the correct `environ`.",
    "created_at": "2018-12-12T17:43:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423591",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>
This should fix it.  What a sneaky problem though.  I think I will complain about this upstream...

A better solution, I think, would be to allow passing `NULL` as the environment argument to `GAP_Initialize`, in which case GAP can just use the correct `environ`.



---

archive/issue_comments_423592.json:
```json
{
    "body": "<a id='comment:0'></a>\nYep, this seems to work, great! But why? Why does one have to pass a copy?",
    "created_at": "2018-12-12T19:09:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423592",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:0'></a>
Yep, this seems to work, great! But why? Why does one have to pass a copy?



---

archive/issue_comments_423593.json:
```json
{
    "body": "<a id='comment:1'></a>\nI tested this branch on Arch with system-wide GAP and it works almost flawlessly, great job. I only get one test failure, which doesn't look too serious:\n\n\n```\nFile \"/usr/lib/python2.7/site-packages/sage/libs/gap/operations.py\", line 96, in sage.libs.gap.operations.OperationInspector.operations\nFailed example:\n    Unknown in x.operations()\nExpected:\n    True\nGot:\n    False\n```\n\nOne further question: since packages would be installed to GAP_DIR/pkg and some of them are compiled binaries, wouldn't it make more sense to put GAP_DIR under SAGE_LOCAL/lib instead of SAGE_LOCAL/share?",
    "created_at": "2018-12-13T07:41:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423593",
    "user": "https://github.com/antonio-rojas"
}
```

<a id='comment:1'></a>
I tested this branch on Arch with system-wide GAP and it works almost flawlessly, great job. I only get one test failure, which doesn't look too serious:


```
File "/usr/lib/python2.7/site-packages/sage/libs/gap/operations.py", line 96, in sage.libs.gap.operations.OperationInspector.operations
Failed example:
    Unknown in x.operations()
Expected:
    True
Got:
    False
```

One further question: since packages would be installed to GAP_DIR/pkg and some of them are compiled binaries, wouldn't it make more sense to put GAP_DIR under SAGE_LOCAL/lib instead of SAGE_LOCAL/share?



---

archive/issue_comments_423594.json:
```json
{
    "body": "<a id='comment:2'></a>\nYeah, I know about that failure--I haven't looked into it yet but like you said it doesn't look serious.  Thank you for testing otherwise.\n\nI'm a bit torn about the best place to put the GAP stuff--as you said, under <prefix>/share might not be the best after all.  Hypothetically there could be multiple gap-dirs split up in a way that makes sense, but that's also more complicated.  I wonder how Debian installs GAP...",
    "created_at": "2018-12-13T11:37:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423594",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>
Yeah, I know about that failure--I haven't looked into it yet but like you said it doesn't look serious.  Thank you for testing otherwise.

I'm a bit torn about the best place to put the GAP stuff--as you said, under <prefix>/share might not be the best after all.  Hypothetically there could be multiple gap-dirs split up in a way that makes sense, but that's also more complicated.  I wonder how Debian installs GAP...



---

archive/issue_comments_423595.json:
```json
{
    "body": "**Changing commit** from \"[132a7c303a8639c51eb92061ac7cb39106f5d316](https://github.com/sagemath/sagetrac-mirror/commit/132a7c303a8639c51eb92061ac7cb39106f5d316)\" to \"[38e687b90bf9a411ac524273c3713f5db199824f](https://github.com/sagemath/sagetrac-mirror/commit/38e687b90bf9a411ac524273c3713f5db199824f)\".",
    "created_at": "2018-12-13T11:42:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423595",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[132a7c303a8639c51eb92061ac7cb39106f5d316](https://github.com/sagemath/sagetrac-mirror/commit/132a7c303a8639c51eb92061ac7cb39106f5d316)" to "[38e687b90bf9a411ac524273c3713f5db199824f](https://github.com/sagemath/sagetrac-mirror/commit/38e687b90bf9a411ac524273c3713f5db199824f)".



---

archive/issue_comments_423596.json:
```json
{
    "body": "<a id='comment:3'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/38e687b90bf9a411ac524273c3713f5db199824f\">38e687b</a></td><td><code>install only those packages that are required by GAP to run</code></td></tr></table>\n",
    "created_at": "2018-12-13T11:42:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423596",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/38e687b90bf9a411ac524273c3713f5db199824f">38e687b</a></td><td><code>install only those packages that are required by GAP to run</code></td></tr></table>




---

archive/issue_comments_423597.json:
```json
{
    "body": "<a id='comment:4'></a>\nYeah, it seems Debian uses multiple GAP_ROOT_DIRs.  Most of the GAP stdlib and other GAP packages go into `/usr/share/gap`, but there's also a `/usr/lib/x86_64-linux-gnu/gap/` where it puts binary modules like for the IO package.\n\nI think for now I don't want to worry about it, since the core gap SPKG does not install any binary packages.  But it's still worth considering, perhaps as part of #26856.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/38e687b90bf9a411ac524273c3713f5db199824f\">38e687b</a></td><td><code>install only those packages that are required by GAP to run</code></td></tr></table>\n",
    "created_at": "2018-12-13T11:45:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423597",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>
Yeah, it seems Debian uses multiple GAP_ROOT_DIRs.  Most of the GAP stdlib and other GAP packages go into `/usr/share/gap`, but there's also a `/usr/lib/x86_64-linux-gnu/gap/` where it puts binary modules like for the IO package.

I think for now I don't want to worry about it, since the core gap SPKG does not install any binary packages.  But it's still worth considering, perhaps as part of #26856.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/38e687b90bf9a411ac524273c3713f5db199824f">38e687b</a></td><td><code>install only those packages that are required by GAP to run</code></td></tr></table>




---

archive/issue_comments_423598.json:
```json
{
    "body": "<a id='comment:375'></a>\nReplying to [dimpase](#comment%3A370):\n> Yep, this seems to work, great! But why? Why does one have to pass a copy?\n\n\nI think it's kind of a bug in GAP--something a bit ill-considered and complicated.\n\nGAP's `main()` function is in the somewhat archaic (in that it is not standard, though many unices support it) three argument form:\n\n```\nint main ( int argc, char * argv[], char * environ[] )\n```\n\nThis is used to pass the program's environment variables to the program.  But POSIX-conforming systems don't need this because they have the `char** environ` global variable.  GAP then passes the environment passed via `main(...)` to `GAP_Initialize` which stores a copy of it off to GAP's own global variable `static char **sysenviron` (this all happens in [src/gap.c](https://github.com/gap-system/gap/blob/f759aa59ac48ca81035385da869f49a40df042c2/src/gap.c#L1747)).\n\nIt then accesses the environment through the `sysenviron` variable.  Actually the only place this is specifically used is `FuncKERNEL_INFO` in the same file which is called during startup (from `lib/system.g`) to set up some basic system info, including  GAP-level copy of the environment.\n\nThis is problematic because functions that modify the environment such as `putenv()` or `setenv()` may require the array of environment variable pointers to be resized (obviously, but I double-checked and while this behavior is implementation-defined it's straightforward: in libc it just effectively does `environ = realloc(new_size)`).  So the value of the global `environ` variable can be changed by the program if you're not careful.  If this happens between the start of the process, and when GAP loops over its `sysenviron` variable you're in trouble, because that's now pointing to some old location of the original `environ` which now points to arbitrary/uninitialized data.  To avoid this the program should always use `environ` directly, rather than saving off some possibly outdated pointer.\n\nIt so happened, in this case, that it *almost* worked--the old array that `sysenviron` was pointing to still contained the old environment variables, but its last (`NULL`) entry was already allocated to some other use and would contain some arbitrary value (in my testing it was typically either `0x300` or `0x310`--who knows) hence the segfault.\n\nI believe this is not a problem for GAP normally, as the pointer that's passed to `main()` is already to a copy and not to the actual `environ` array.  But in Sage we were passing the global `environ` to GAP and that's where the problems arise, so we have to make a copy :|\n\nThis was a heisenbug, because I had an example case that reliably reproduced the problem when run by itself, but that *worked* when run under gdb.  The reason for this was tricky: There's actually only one place during GAP's initialization that modifies the environment (and even then it only happens if `HAVE_LIBREADLINE` is defined): In the `rl_initialize()` call that initializes readline.  It sets the `COLUMNS` and `LINES` variables if they are not already defined.\n\nThe reason the bug didn't occur under gdb, then, is because gdb *itself* uses readline, so when running the program under gdb those variables are already set, and the environment does not get modified, hence no crash when `FuncKERNEL_INFO` tries to read it :(\n\nFor all that reason, I think `GAP_Initialize` should accept `NULL` for its environ argument, and if so use the libc `environ` global, and it should do this by default on those systems that support it (most) and not save a (possibly outdated) copy of it.",
    "created_at": "2018-12-13T12:10:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423598",
    "user": "https://github.com/embray"
}
```

<a id='comment:375'></a>
Replying to [dimpase](#comment%3A370):
> Yep, this seems to work, great! But why? Why does one have to pass a copy?


I think it's kind of a bug in GAP--something a bit ill-considered and complicated.

GAP's `main()` function is in the somewhat archaic (in that it is not standard, though many unices support it) three argument form:

```
int main ( int argc, char * argv[], char * environ[] )
```

This is used to pass the program's environment variables to the program.  But POSIX-conforming systems don't need this because they have the `char** environ` global variable.  GAP then passes the environment passed via `main(...)` to `GAP_Initialize` which stores a copy of it off to GAP's own global variable `static char **sysenviron` (this all happens in [src/gap.c](https://github.com/gap-system/gap/blob/f759aa59ac48ca81035385da869f49a40df042c2/src/gap.c#L1747)).

It then accesses the environment through the `sysenviron` variable.  Actually the only place this is specifically used is `FuncKERNEL_INFO` in the same file which is called during startup (from `lib/system.g`) to set up some basic system info, including  GAP-level copy of the environment.

This is problematic because functions that modify the environment such as `putenv()` or `setenv()` may require the array of environment variable pointers to be resized (obviously, but I double-checked and while this behavior is implementation-defined it's straightforward: in libc it just effectively does `environ = realloc(new_size)`).  So the value of the global `environ` variable can be changed by the program if you're not careful.  If this happens between the start of the process, and when GAP loops over its `sysenviron` variable you're in trouble, because that's now pointing to some old location of the original `environ` which now points to arbitrary/uninitialized data.  To avoid this the program should always use `environ` directly, rather than saving off some possibly outdated pointer.

It so happened, in this case, that it *almost* worked--the old array that `sysenviron` was pointing to still contained the old environment variables, but its last (`NULL`) entry was already allocated to some other use and would contain some arbitrary value (in my testing it was typically either `0x300` or `0x310`--who knows) hence the segfault.

I believe this is not a problem for GAP normally, as the pointer that's passed to `main()` is already to a copy and not to the actual `environ` array.  But in Sage we were passing the global `environ` to GAP and that's where the problems arise, so we have to make a copy :|

This was a heisenbug, because I had an example case that reliably reproduced the problem when run by itself, but that *worked* when run under gdb.  The reason for this was tricky: There's actually only one place during GAP's initialization that modifies the environment (and even then it only happens if `HAVE_LIBREADLINE` is defined): In the `rl_initialize()` call that initializes readline.  It sets the `COLUMNS` and `LINES` variables if they are not already defined.

The reason the bug didn't occur under gdb, then, is because gdb *itself* uses readline, so when running the program under gdb those variables are already set, and the environment does not get modified, hence no crash when `FuncKERNEL_INFO` tries to read it :(

For all that reason, I think `GAP_Initialize` should accept `NULL` for its environ argument, and if so use the libc `environ` global, and it should do this by default on those systems that support it (most) and not save a (possibly outdated) copy of it.



---

archive/issue_comments_423599.json:
```json
{
    "body": "<a id='comment:6'></a>\nDoes\n\n```\nsage: DihedralGroup(8).cardinality()\n```\nwork on your branch? It hangs on mine at #26856 \nafter I removed `build/pkgs/gap/patches/nodefaultpackages.patch` as well",
    "created_at": "2018-12-14T11:54:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423599",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:6'></a>
Does

```
sage: DihedralGroup(8).cardinality()
```
work on your branch? It hangs on mine at #26856 
after I removed `build/pkgs/gap/patches/nodefaultpackages.patch` as well



---

archive/issue_comments_423600.json:
```json
{
    "body": "<a id='comment:7'></a>\nWorks fine for me.",
    "created_at": "2018-12-14T11:58:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423600",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>
Works fine for me.



---

archive/issue_comments_423601.json:
```json
{
    "body": "<a id='comment:378'></a>\nReplying to [dimpase](#comment%3A376):\n> Does\n> \n> ```\n> sage: DihedralGroup(8).cardinality()\n> ```\n> work on your branch? It hangs on mine at #26856 \n> after I removed `build/pkgs/gap/patches/nodefaultpackages.patch` as well \n\n\nputting this patch back makes me able to compute `DihedralGroup(8).cardinality()`.\nHmm, this patch prevents autoloading packages. The hang is due to some sort of locking issue in pexpect. I don't like this, especially as it stalls #26856...",
    "created_at": "2018-12-14T12:24:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423601",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:378'></a>
Replying to [dimpase](#comment%3A376):
> Does
> 
> ```
> sage: DihedralGroup(8).cardinality()
> ```
> work on your branch? It hangs on mine at #26856 
> after I removed `build/pkgs/gap/patches/nodefaultpackages.patch` as well 


putting this patch back makes me able to compute `DihedralGroup(8).cardinality()`.
Hmm, this patch prevents autoloading packages. The hang is due to some sort of locking issue in pexpect. I don't like this, especially as it stalls #26856...



---

archive/issue_comments_423602.json:
```json
{
    "body": "**Changing work_issues** from \"fix libgap workspace loading, etc, and much more  work...\" to \"ironing out the last kinks\".",
    "created_at": "2018-12-15T15:15:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423602",
    "user": "https://github.com/dimpase"
}
```

**Changing work_issues** from "fix libgap workspace loading, etc, and much more  work..." to "ironing out the last kinks".



---

archive/issue_comments_423603.json:
```json
{
    "body": "<a id='comment:0'></a>\nCan the message \"The gap-4.5.5.spkg (or later) seems to be not installed!\" be dropped? It is not clear to me what the purpose of this message is: it is not declared an error, so sage will simply print the message and continue. If GAP_ROOT_DIR doesn't exist but GAP_ROOT is correctly declared in gap.sh, then everything will work fine but Sage will keep printing this message. IMO this should be replaced by a proper error if gap_root() doesn't return a valid path.",
    "created_at": "2018-12-16T13:54:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423603",
    "user": "https://github.com/antonio-rojas"
}
```

<a id='comment:0'></a>
Can the message "The gap-4.5.5.spkg (or later) seems to be not installed!" be dropped? It is not clear to me what the purpose of this message is: it is not declared an error, so sage will simply print the message and continue. If GAP_ROOT_DIR doesn't exist but GAP_ROOT is correctly declared in gap.sh, then everything will work fine but Sage will keep printing this message. IMO this should be replaced by a proper error if gap_root() doesn't return a valid path.



---

archive/issue_comments_423604.json:
```json
{
    "body": "**Changing commit** from \"[38e687b90bf9a411ac524273c3713f5db199824f](https://github.com/sagemath/sagetrac-mirror/commit/38e687b90bf9a411ac524273c3713f5db199824f)\" to \"[6a5d34a92ddb510cfb5944f8dd05c0947eb9d23c](https://github.com/sagemath/sagetrac-mirror/commit/6a5d34a92ddb510cfb5944f8dd05c0947eb9d23c)\".",
    "created_at": "2018-12-18T12:51:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423604",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[38e687b90bf9a411ac524273c3713f5db199824f](https://github.com/sagemath/sagetrac-mirror/commit/38e687b90bf9a411ac524273c3713f5db199824f)" to "[6a5d34a92ddb510cfb5944f8dd05c0947eb9d23c](https://github.com/sagemath/sagetrac-mirror/commit/6a5d34a92ddb510cfb5944f8dd05c0947eb9d23c)".



---

archive/issue_comments_423605.json:
```json
{
    "body": "<a id='comment:1'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8b0d0adf655ad6d7b0442b63ca5cfb38f1ca17df\">8b0d0ad</a></td><td><code>Implement GAPElement_List.__bool__ to work like a Python list</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6a5d34a92ddb510cfb5944f8dd05c0947eb9d23c\">6a5d34a</a></td><td><code>fix the test for available operations on an object</code></td></tr></table>\n",
    "created_at": "2018-12-18T12:51:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423605",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:1'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8b0d0adf655ad6d7b0442b63ca5cfb38f1ca17df">8b0d0ad</a></td><td><code>Implement GAPElement_List.__bool__ to work like a Python list</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6a5d34a92ddb510cfb5944f8dd05c0947eb9d23c">6a5d34a</a></td><td><code>fix the test for available operations on an object</code></td></tr></table>




---

archive/issue_comments_423606.json:
```json
{
    "body": "<a id='comment:382'></a>\nReplying to [arojas](#comment%3A380):\n> Can the message \"The gap-4.5.5.spkg (or later) seems to be not installed!\" be dropped? It is not clear to me what the purpose of this message is: it is not declared an error, so sage will simply print the message and continue. If GAP_ROOT_DIR doesn't exist but GAP_ROOT is correctly declared in gap.sh, then everything will work fine but Sage will keep printing this message. IMO this should be replaced by a proper error if gap_root() doesn't return a valid path. \n\n\nI hadn't noticed that before.  Indeed, it is just code rot and should be removed.",
    "created_at": "2018-12-18T12:59:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423606",
    "user": "https://github.com/embray"
}
```

<a id='comment:382'></a>
Replying to [arojas](#comment%3A380):
> Can the message "The gap-4.5.5.spkg (or later) seems to be not installed!" be dropped? It is not clear to me what the purpose of this message is: it is not declared an error, so sage will simply print the message and continue. If GAP_ROOT_DIR doesn't exist but GAP_ROOT is correctly declared in gap.sh, then everything will work fine but Sage will keep printing this message. IMO this should be replaced by a proper error if gap_root() doesn't return a valid path. 


I hadn't noticed that before.  Indeed, it is just code rot and should be removed.



---

archive/issue_comments_423607.json:
```json
{
    "body": "<a id='comment:3'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/72df280f83fbcbc85ab6df809b2c57fc2d652068\">72df280</a></td><td><code>clean up gap_root() a bit more; remove obsolete warning message</code></td></tr></table>\n",
    "created_at": "2018-12-18T13:03:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423607",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/72df280f83fbcbc85ab6df809b2c57fc2d652068">72df280</a></td><td><code>clean up gap_root() a bit more; remove obsolete warning message</code></td></tr></table>




---

archive/issue_comments_423608.json:
```json
{
    "body": "**Changing commit** from \"[6a5d34a92ddb510cfb5944f8dd05c0947eb9d23c](https://github.com/sagemath/sagetrac-mirror/commit/6a5d34a92ddb510cfb5944f8dd05c0947eb9d23c)\" to \"[72df280f83fbcbc85ab6df809b2c57fc2d652068](https://github.com/sagemath/sagetrac-mirror/commit/72df280f83fbcbc85ab6df809b2c57fc2d652068)\".",
    "created_at": "2018-12-18T13:03:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423608",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[6a5d34a92ddb510cfb5944f8dd05c0947eb9d23c](https://github.com/sagemath/sagetrac-mirror/commit/6a5d34a92ddb510cfb5944f8dd05c0947eb9d23c)" to "[72df280f83fbcbc85ab6df809b2c57fc2d652068](https://github.com/sagemath/sagetrac-mirror/commit/72df280f83fbcbc85ab6df809b2c57fc2d652068)".



---

archive/issue_comments_423609.json:
```json
{
    "body": "<a id='comment:4'></a>\nWhat is the current state of GAP kernel packages such as `io`? Do they work?\n(we can postpone them to a later ticket though)",
    "created_at": "2018-12-18T13:08:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423609",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:4'></a>
What is the current state of GAP kernel packages such as `io`? Do they work?
(we can postpone them to a later ticket though)



---

archive/issue_comments_423610.json:
```json
{
    "body": "<a id='comment:385'></a>\nReplying to [dimpase](#comment%3A378):\n> Replying to [dimpase](#comment%3A376):\n> > Does\n> > \n> > ```\n> > sage: DihedralGroup(8).cardinality()\n> > ```\n> > work on your branch? It hangs on mine at #26856 \n> > after I removed `build/pkgs/gap/patches/nodefaultpackages.patch` as well \n\n> \n> putting this patch back makes me able to compute `DihedralGroup(8).cardinality()`.\n> Hmm, this patch prevents autoloading packages. The hang is due to some sort of locking issue in pexpect. I don't like this, especially as it stalls #26856...\n\n\nFWIW the current version of my branch does still have this patch so I don't know what you mean by \"putting this patch back\".  It's unfortunate that that code path uses the pexpect interface at all.  We still intend to remove that.  I still can't reproduce the problem though.  Does it only happen if you have additional packages installed?  It might be just that the method lookup is too slow.\n\nI am going to continue looking into kernel packages next; I believe the only issue with that is minor but if not then I will postpone it.",
    "created_at": "2018-12-18T13:10:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423610",
    "user": "https://github.com/embray"
}
```

<a id='comment:385'></a>
Replying to [dimpase](#comment%3A378):
> Replying to [dimpase](#comment%3A376):
> > Does
> > 
> > ```
> > sage: DihedralGroup(8).cardinality()
> > ```
> > work on your branch? It hangs on mine at #26856 
> > after I removed `build/pkgs/gap/patches/nodefaultpackages.patch` as well 

> 
> putting this patch back makes me able to compute `DihedralGroup(8).cardinality()`.
> Hmm, this patch prevents autoloading packages. The hang is due to some sort of locking issue in pexpect. I don't like this, especially as it stalls #26856...


FWIW the current version of my branch does still have this patch so I don't know what you mean by "putting this patch back".  It's unfortunate that that code path uses the pexpect interface at all.  We still intend to remove that.  I still can't reproduce the problem though.  Does it only happen if you have additional packages installed?  It might be just that the method lookup is too slow.

I am going to continue looking into kernel packages next; I believe the only issue with that is minor but if not then I will postpone it.



---

archive/issue_comments_423611.json:
```json
{
    "body": "<a id='comment:386'></a>\nReplying to [embray](#comment%3A385):\n> Replying to [dimpase](#comment%3A378):\n> > Replying to [dimpase](#comment%3A376):\n> > > Does\n> > > \n> > > ```\n> > > sage: DihedralGroup(8).cardinality()\n> > > ```\n> > > work on your branch? It hangs on mine at #26856 \n> > > after I removed `build/pkgs/gap/patches/nodefaultpackages.patch` as well \n\n> > \n> > putting this patch back makes me able to compute `DihedralGroup(8).cardinality()`.\n> > Hmm, this patch prevents autoloading packages. The hang is due to some sort of locking issue in pexpect. I don't like this, especially as it stalls #26856...\n\n> \n> FWIW the current version of my branch does still have this patch so I don't know what you mean by \"putting this patch back\". \n\n\nI mean I, locally, removed the patch, and it broke Sage, by getting hanging\n`DihedralGroup(8).cardinality()`.\n\n\n> It's unfortunate that that code path uses the pexpect interface at all. \n\nwell, yes, but getting rid of GAP's pexpect is quite a big task, it certainly cannot be\ndone before this ticket is merged.\n \n\n> We still intend to remove that.  I still can't reproduce the problem though.  Does it only happen if you have additional packages installed?  It might be just that the method lookup is too slow.\n\n>\nMost additional packages are installed just by untarring the canonical GAP 4.10 tarball.\n(Some of them also need some compiling done, but these are in minority).\n\nI don't think it is related, it might be that pexpect GAP needs different options for startup, so that package autoloading is not conflicting with pexpect.\nThis would be an easy fix, otherwise I suppose we will need to keep the patch in question.\n\n\n\n \n> I am going to continue looking into kernel packages next; I believe the only issue with that is minor but if not then I will postpone it.\n",
    "created_at": "2018-12-18T13:22:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423611",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:386'></a>
Replying to [embray](#comment%3A385):
> Replying to [dimpase](#comment%3A378):
> > Replying to [dimpase](#comment%3A376):
> > > Does
> > > 
> > > ```
> > > sage: DihedralGroup(8).cardinality()
> > > ```
> > > work on your branch? It hangs on mine at #26856 
> > > after I removed `build/pkgs/gap/patches/nodefaultpackages.patch` as well 

> > 
> > putting this patch back makes me able to compute `DihedralGroup(8).cardinality()`.
> > Hmm, this patch prevents autoloading packages. The hang is due to some sort of locking issue in pexpect. I don't like this, especially as it stalls #26856...

> 
> FWIW the current version of my branch does still have this patch so I don't know what you mean by "putting this patch back". 


I mean I, locally, removed the patch, and it broke Sage, by getting hanging
`DihedralGroup(8).cardinality()`.


> It's unfortunate that that code path uses the pexpect interface at all. 

well, yes, but getting rid of GAP's pexpect is quite a big task, it certainly cannot be
done before this ticket is merged.
 

> We still intend to remove that.  I still can't reproduce the problem though.  Does it only happen if you have additional packages installed?  It might be just that the method lookup is too slow.

>
Most additional packages are installed just by untarring the canonical GAP 4.10 tarball.
(Some of them also need some compiling done, but these are in minority).

I don't think it is related, it might be that pexpect GAP needs different options for startup, so that package autoloading is not conflicting with pexpect.
This would be an easy fix, otherwise I suppose we will need to keep the patch in question.



 
> I am going to continue looking into kernel packages next; I believe the only issue with that is minor but if not then I will postpone it.




---

archive/issue_comments_423612.json:
```json
{
    "body": "<a id='comment:7'></a>\nOK, with 38e687b90bf (I tested on an older branch) in I can remove build/pkgs/gap/patches/nodefaultpackages.patch and\nhave  `DihedralGroup(8).cardinality()` running fine.\n\nOf course, now I need to adjust the GAP packages installed, to have at least everything\nmentioned in build/pkgs/gap/patches/nodefaultpackages.patch, namely\n\n```\n default:= [ \"autpgrp\", \"alnuth\", \"crisp\", \"ctbllib\", \"factint\", \"fga\", \n             \"irredsol\", \"laguna\", \"polenta\", \"polycyclic\", \"resclasses\",              \n             \"sophus\", \"tomlib\" ]\n```\nand try again.",
    "created_at": "2018-12-18T14:43:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423612",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:7'></a>
OK, with 38e687b90bf (I tested on an older branch) in I can remove build/pkgs/gap/patches/nodefaultpackages.patch and
have  `DihedralGroup(8).cardinality()` running fine.

Of course, now I need to adjust the GAP packages installed, to have at least everything
mentioned in build/pkgs/gap/patches/nodefaultpackages.patch, namely

```
 default:= [ "autpgrp", "alnuth", "crisp", "ctbllib", "factint", "fga", 
             "irredsol", "laguna", "polenta", "polycyclic", "resclasses",              
             "sophus", "tomlib" ]
```
and try again.



---

archive/issue_comments_423613.json:
```json
{
    "body": "<a id='comment:8'></a>\nOK, that `DihedralGroup(8).cardinality()` has been a red herring, it seems, sorry; probably a stale GAP workspace, or something like this. At the very least, I can add more GAP packages, and still everything works. On #26856 I added b63db23, removing `nodefaultpackages.patch`, \nand adding the packages needed to make GAP happy after this.\n\nLet me run tests and see if everything is still OK.",
    "created_at": "2018-12-18T15:32:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423613",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:8'></a>
OK, that `DihedralGroup(8).cardinality()` has been a red herring, it seems, sorry; probably a stale GAP workspace, or something like this. At the very least, I can add more GAP packages, and still everything works. On #26856 I added b63db23, removing `nodefaultpackages.patch`, 
and adding the packages needed to make GAP happy after this.

Let me run tests and see if everything is still OK.



---

archive/issue_comments_423614.json:
```json
{
    "body": "<a id='comment:9'></a>\nfew doctests need adjustments, as these GAP packages provide more methods, resulting in different output orders for some things, but otherwise all is fine. I've posted one more commit to #26856 to also install package altasrep, a missing (new) dependence to tomlib.\nMore to come.",
    "created_at": "2018-12-18T18:35:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423614",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:9'></a>
few doctests need adjustments, as these GAP packages provide more methods, resulting in different output orders for some things, but otherwise all is fine. I've posted one more commit to #26856 to also install package altasrep, a missing (new) dependence to tomlib.
More to come.



---

archive/issue_comments_423615.json:
```json
{
    "body": "<a id='comment:0'></a>\nI've tested the current branch (with the one of #26856, at commit 1b71099 to be precise) on MacOSX 10.13, everything works, with `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES`.\nWithout the latter, few segfaults, but this is to be expected.",
    "created_at": "2018-12-19T09:48:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423615",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:0'></a>
I've tested the current branch (with the one of #26856, at commit 1b71099 to be precise) on MacOSX 10.13, everything works, with `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES`.
Without the latter, few segfaults, but this is to be expected.



---

archive/issue_comments_423616.json:
```json
{
    "body": "<a id='comment:391'></a>\nReplying to [dimpase](#comment%3A388):\n> OK, that `DihedralGroup(8).cardinality()` has been a red herring, it seems, sorry; probably a stale GAP workspace, or something like this. At the very least, I can add more GAP packages, and still everything works. On #26856 I added b63db23, removing `nodefaultpackages.patch`, \n> and adding the packages needed to make GAP happy after this.\n\n\nThe xgap package is known to case the pexpect interface to hang.  This was discussed somewhere around[comment:225](#comment%3A225).  A few of the default packages (at least sonata and guava) will load the xgap package if the `-p` flag is set.  I fixed this (see[comment:230](#comment%3A230)) by modifying `sage.g` to prevent loading of the xgap package, but if you have an old workspace from before this patch it will still be loaded.\n\nThis won't affect most users of Sage since most users will not have existing workspaces with these packages loaded (if they did, they would be getting hit with this same bug).",
    "created_at": "2018-12-19T13:07:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423616",
    "user": "https://github.com/embray"
}
```

<a id='comment:391'></a>
Replying to [dimpase](#comment%3A388):
> OK, that `DihedralGroup(8).cardinality()` has been a red herring, it seems, sorry; probably a stale GAP workspace, or something like this. At the very least, I can add more GAP packages, and still everything works. On #26856 I added b63db23, removing `nodefaultpackages.patch`, 
> and adding the packages needed to make GAP happy after this.


The xgap package is known to case the pexpect interface to hang.  This was discussed somewhere around[comment:225](#comment%3A225).  A few of the default packages (at least sonata and guava) will load the xgap package if the `-p` flag is set.  I fixed this (see[comment:230](#comment%3A230)) by modifying `sage.g` to prevent loading of the xgap package, but if you have an old workspace from before this patch it will still be loaded.

This won't affect most users of Sage since most users will not have existing workspaces with these packages loaded (if they did, they would be getting hit with this same bug).



---

archive/issue_comments_423617.json:
```json
{
    "body": "<a id='comment:2'></a>\nAnyhow, should we try to wrap up what we have? \n\nI can use the old way to build/install GAP packages from gap_packages spkg that need it, and deal with \"right way\" to do this, as well as with more packages, and GAP kernel packages, on a follow-up ticket.",
    "created_at": "2018-12-19T13:14:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423617",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:2'></a>
Anyhow, should we try to wrap up what we have? 

I can use the old way to build/install GAP packages from gap_packages spkg that need it, and deal with "right way" to do this, as well as with more packages, and GAP kernel packages, on a follow-up ticket.



---

archive/issue_comments_423618.json:
```json
{
    "body": "<a id='comment:3'></a>\nHmm, when I remove the nodefaultpackages.patch, and if I don't have the additional packages installed, then when GAP starts up I get annoying info messages like:\n\n```\n    #I  autpgrp package is not available. Check that the name is correct\n    #I  and it is present in one of the GAP root directories (see '??RootPaths')\n```\n\neither we install these packages by default (not ideal), I can find some way to override the default packages when loading GAP with `sage.g` (probably best, if it can be done), or we figure out how best to just silence those warnings.",
    "created_at": "2018-12-19T13:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423618",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>
Hmm, when I remove the nodefaultpackages.patch, and if I don't have the additional packages installed, then when GAP starts up I get annoying info messages like:

```
    #I  autpgrp package is not available. Check that the name is correct
    #I  and it is present in one of the GAP root directories (see '??RootPaths')
```

either we install these packages by default (not ideal), I can find some way to override the default packages when loading GAP with `sage.g` (probably best, if it can be done), or we figure out how best to just silence those warnings.



---

archive/issue_comments_423619.json:
```json
{
    "body": "<a id='comment:4'></a>\nAh, apparently there's already an `-A` option for exactly this.  I think, at least for calling GAP from Sage, we should do this.\n\nSomewhat unfortunate in terms of principle of least astonishment (\"some thing that was available in my GAP is not automatically available when I use GAP from Sage\").  But in fairness this was already the case for most users of Sage.  Perhaps at a minimum it should be documented in the docs for the GAP interfaces that GAP in Sage is started with a minimal set of packages autoloaded, and packages that one needs should be explicitly loaded.",
    "created_at": "2018-12-19T13:22:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423619",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>
Ah, apparently there's already an `-A` option for exactly this.  I think, at least for calling GAP from Sage, we should do this.

Somewhat unfortunate in terms of principle of least astonishment ("some thing that was available in my GAP is not automatically available when I use GAP from Sage").  But in fairness this was already the case for most users of Sage.  Perhaps at a minimum it should be documented in the docs for the GAP interfaces that GAP in Sage is started with a minimal set of packages autoloaded, and packages that one needs should be explicitly loaded.



---

archive/issue_comments_423620.json:
```json
{
    "body": "<a id='comment:395'></a>\nReplying to [embray](#comment%3A393):\n> Hmm, when I remove the nodefaultpackages.patch, and if I don't have the additional packages installed, then when GAP starts up I get annoying info messages like:\n> \n> ```\n>     #I  autpgrp package is not available. Check that the name is correct\n>     #I  and it is present in one of the GAP root directories (see '??RootPaths')\n> ```\n> \n> either we install these packages by default (not ideal),\n\n\nWhy? This is what I have done on #26856,\nhaving the same default packages autoloaded as GAP does.\nI think this is the best, and you seem to have agreed...\n\n> I can find some way to override the default packages when loading GAP with `sage.g` (probably best, if it can be done), or we figure out how best to just silence those warnings.\n\n\nWhy should we diverge from the canonical GAP here? Default autoloaded packages load more efficient routines for a number of tasks, too.",
    "created_at": "2018-12-19T13:23:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423620",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:395'></a>
Replying to [embray](#comment%3A393):
> Hmm, when I remove the nodefaultpackages.patch, and if I don't have the additional packages installed, then when GAP starts up I get annoying info messages like:
> 
> ```
>     #I  autpgrp package is not available. Check that the name is correct
>     #I  and it is present in one of the GAP root directories (see '??RootPaths')
> ```
> 
> either we install these packages by default (not ideal),


Why? This is what I have done on #26856,
having the same default packages autoloaded as GAP does.
I think this is the best, and you seem to have agreed...

> I can find some way to override the default packages when loading GAP with `sage.g` (probably best, if it can be done), or we figure out how best to just silence those warnings.


Why should we diverge from the canonical GAP here? Default autoloaded packages load more efficient routines for a number of tasks, too.



---

archive/issue_comments_423621.json:
```json
{
    "body": "<a id='comment:6'></a>\nNot loading the default packages also lead to different formats of quite a few output results, or worse. I think we have had enough disagreement with GAP people on this, and I really do not want to keep annoying them.",
    "created_at": "2018-12-19T13:25:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423621",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:6'></a>
Not loading the default packages also lead to different formats of quite a few output results, or worse. I think we have had enough disagreement with GAP people on this, and I really do not want to keep annoying them.



---

archive/issue_comments_423622.json:
```json
{
    "body": "<a id='comment:7'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5e61d7b6a0da3aa53d8176fa1fb9353cc559b098\">5e61d7b</a></td><td><code>pass -A option to GAP to disable autoloading of default packages for both GAP interfaces</code></td></tr></table>\n",
    "created_at": "2018-12-19T13:31:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423622",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5e61d7b6a0da3aa53d8176fa1fb9353cc559b098">5e61d7b</a></td><td><code>pass -A option to GAP to disable autoloading of default packages for both GAP interfaces</code></td></tr></table>




---

archive/issue_comments_423623.json:
```json
{
    "body": "**Changing commit** from \"[72df280f83fbcbc85ab6df809b2c57fc2d652068](https://github.com/sagemath/sagetrac-mirror/commit/72df280f83fbcbc85ab6df809b2c57fc2d652068)\" to \"[5e61d7b6a0da3aa53d8176fa1fb9353cc559b098](https://github.com/sagemath/sagetrac-mirror/commit/5e61d7b6a0da3aa53d8176fa1fb9353cc559b098)\".",
    "created_at": "2018-12-19T13:31:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423623",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[72df280f83fbcbc85ab6df809b2c57fc2d652068](https://github.com/sagemath/sagetrac-mirror/commit/72df280f83fbcbc85ab6df809b2c57fc2d652068)" to "[5e61d7b6a0da3aa53d8176fa1fb9353cc559b098](https://github.com/sagemath/sagetrac-mirror/commit/5e61d7b6a0da3aa53d8176fa1fb9353cc559b098)".



---

archive/issue_comments_423624.json:
```json
{
    "body": "<a id='comment:8'></a>\nThis discussion may be relevant: https://github.com/NixOS/nixpkgs/pull/38754",
    "created_at": "2018-12-19T13:34:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423624",
    "user": "https://github.com/timokau"
}
```

<a id='comment:8'></a>
This discussion may be relevant: https://github.com/NixOS/nixpkgs/pull/38754



---

archive/issue_comments_423625.json:
```json
{
    "body": "<a id='comment:9'></a>\nConsidering that there's an option specifically to do this I have no qualms with doing so, at least for the default usage in Sage where not all users are going to care about what is being done with GAP anyways.\n\nIf there are specific routines used by Sage that are improved by specific pages I think we should explicitly load those packages anyways.\n\nPerhaps, if requested, there could also be an option in Sage to change this off or on.  Right now I'm trying to keep things as simple as possible.  This doesn't change any test results because we were previously patching this out anyways.  If there are some doctests in Sage whose results are impacted by what GAP packages are loaded, those specific tests should be rewritten to account for that, since otherwise they're sensitive to non-local environmental effects which is not desirable.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5e61d7b6a0da3aa53d8176fa1fb9353cc559b098\">5e61d7b</a></td><td><code>pass -A option to GAP to disable autoloading of default packages for both GAP interfaces</code></td></tr></table>\n",
    "created_at": "2018-12-19T13:41:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423625",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>
Considering that there's an option specifically to do this I have no qualms with doing so, at least for the default usage in Sage where not all users are going to care about what is being done with GAP anyways.

If there are specific routines used by Sage that are improved by specific pages I think we should explicitly load those packages anyways.

Perhaps, if requested, there could also be an option in Sage to change this off or on.  Right now I'm trying to keep things as simple as possible.  This doesn't change any test results because we were previously patching this out anyways.  If there are some doctests in Sage whose results are impacted by what GAP packages are loaded, those specific tests should be rewritten to account for that, since otherwise they're sensitive to non-local environmental effects which is not desirable.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5e61d7b6a0da3aa53d8176fa1fb9353cc559b098">5e61d7b</a></td><td><code>pass -A option to GAP to disable autoloading of default packages for both GAP interfaces</code></td></tr></table>




---

archive/issue_comments_423626.json:
```json
{
    "body": "<a id='comment:0'></a>\nIn other words, I'd be fine with revisiting this later, but for the purposes of wrapping up this ticket I think that's the path of least resistance (and explicitly supported, which makes it that much more attractive an option).",
    "created_at": "2018-12-19T13:44:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423626",
    "user": "https://github.com/embray"
}
```

<a id='comment:0'></a>
In other words, I'd be fine with revisiting this later, but for the purposes of wrapping up this ticket I think that's the path of least resistance (and explicitly supported, which makes it that much more attractive an option).



---

archive/issue_comments_423627.json:
```json
{
    "body": "<a id='comment:1'></a>\nOTOH, now when I run `./sage -gap` I also get those annoying warnings unless I explicitly pass `-A`, so this is not good.  Let me do a bit of analysis into what the impact is of adding those default packages for startup time and disk space...  We would also want them, then, to be included in the core GAP spkg.",
    "created_at": "2018-12-19T13:49:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423627",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>
OTOH, now when I run `./sage -gap` I also get those annoying warnings unless I explicitly pass `-A`, so this is not good.  Let me do a bit of analysis into what the impact is of adding those default packages for startup time and disk space...  We would also want them, then, to be included in the core GAP spkg.



---

archive/issue_comments_423628.json:
```json
{
    "body": "<a id='comment:2'></a>\nBTW building, installing, and loading the IO package works fine now, so I guess I fixed that somewhere along the line.",
    "created_at": "2018-12-19T13:52:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423628",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>
BTW building, installing, and loading the IO package works fine now, so I guess I fixed that somewhere along the line.



---

archive/issue_comments_423629.json:
```json
{
    "body": "<a id='comment:3'></a>\nUgh. Just that minimal set of packages adds 374MB.  tomlib alone is 229MB.  Not really sure what to do about that.  In this day and age it's not a huge imposition but it does certainly increase the download size.  Let me see how well it compresses.",
    "created_at": "2018-12-19T13:59:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423629",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>
Ugh. Just that minimal set of packages adds 374MB.  tomlib alone is 229MB.  Not really sure what to do about that.  In this day and age it's not a huge imposition but it does certainly increase the download size.  Let me see how well it compresses.



---

archive/issue_comments_423630.json:
```json
{
    "body": "<a id='comment:404'></a>\nReplying to [embray](#comment%3A401):\n> OTOH, now when I run `./sage -gap` I also get those annoying warnings unless I explicitly pass `-A`, so this is not good.  Let me do a bit of analysis into what the impact is of adding those default packages for startup time and disk space...  We would also want them, then, to be included in the core GAP spkg.\n\n\nI have already done this on #26856 - including fixing the needed doctests.\nThe disk space is small in this case, as all them are just GAP code. Apart from tomlib. \n\nTomlib was (as of #26856) part of database_gap. \n\nGAP people really consider these packages core GAP, and keep them packages for historical/authoriship etc reasons.",
    "created_at": "2018-12-19T14:02:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423630",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:404'></a>
Replying to [embray](#comment%3A401):
> OTOH, now when I run `./sage -gap` I also get those annoying warnings unless I explicitly pass `-A`, so this is not good.  Let me do a bit of analysis into what the impact is of adding those default packages for startup time and disk space...  We would also want them, then, to be included in the core GAP spkg.


I have already done this on #26856 - including fixing the needed doctests.
The disk space is small in this case, as all them are just GAP code. Apart from tomlib. 

Tomlib was (as of #26856) part of database_gap. 

GAP people really consider these packages core GAP, and keep them packages for historical/authoriship etc reasons.



---

archive/issue_comments_423631.json:
```json
{
    "body": "<a id='comment:5'></a>\nOnce we distribute the original GAP tarball, I would not worry about 250Mb more or less. It is almost 2019, terabytes of disk space are dirt-cheap.",
    "created_at": "2018-12-19T14:05:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423631",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:5'></a>
Once we distribute the original GAP tarball, I would not worry about 250Mb more or less. It is almost 2019, terabytes of disk space are dirt-cheap.



---

archive/issue_comments_423632.json:
```json
{
    "body": "<a id='comment:6'></a>\nBut terabytes of SSDs aren't. Also the download takes time.",
    "created_at": "2018-12-19T14:07:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423632",
    "user": "https://github.com/timokau"
}
```

<a id='comment:6'></a>
But terabytes of SSDs aren't. Also the download takes time.



---

archive/issue_comments_423633.json:
```json
{
    "body": "<a id='comment:407'></a>\nReplying to [dimpase](#comment%3A405):\n> Once we distribute the original GAP tarball, I would not worry about 250Mb more or less. It is almost 2019, terabytes of disk space are dirt-cheap.\n\n\nThat's not relevant here except for people building Sage from source, for whom I don't care how much disk space we use within reason.  I'm just concerned about download size for binary packages, and a third of a gigabyte is not trivial in that case.",
    "created_at": "2018-12-19T14:08:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423633",
    "user": "https://github.com/embray"
}
```

<a id='comment:407'></a>
Replying to [dimpase](#comment%3A405):
> Once we distribute the original GAP tarball, I would not worry about 250Mb more or less. It is almost 2019, terabytes of disk space are dirt-cheap.


That's not relevant here except for people building Sage from source, for whom I don't care how much disk space we use within reason.  I'm just concerned about download size for binary packages, and a third of a gigabyte is not trivial in that case.



---

archive/issue_comments_423634.json:
```json
{
    "body": "<a id='comment:408'></a>\nReplying to [embray](#comment%3A407):\n> Replying to [dimpase](#comment%3A405):\n> > Once we distribute the original GAP tarball, I would not worry about 250Mb more or less. It is almost 2019, terabytes of disk space are dirt-cheap.\n\n> \n> That's not relevant here except for people building Sage from source, for whom I don't care how much disk space we use within reason.  I'm just concerned about download size for binary packages, and a third of a gigabyte is not trivial in that case.\n\n\nbut that data are textfiles, after compression they will be much smaller.",
    "created_at": "2018-12-19T14:21:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423634",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:408'></a>
Replying to [embray](#comment%3A407):
> Replying to [dimpase](#comment%3A405):
> > Once we distribute the original GAP tarball, I would not worry about 250Mb more or less. It is almost 2019, terabytes of disk space are dirt-cheap.

> 
> That's not relevant here except for people building Sage from source, for whom I don't care how much disk space we use within reason.  I'm just concerned about download size for binary packages, and a third of a gigabyte is not trivial in that case.


but that data are textfiles, after compression they will be much smaller.



---

archive/issue_comments_423635.json:
```json
{
    "body": "<a id='comment:9'></a>\nOkay, first of all, to be precise, the default packages in question are:\n\n```\nautpgrp-1.10\nalnuth-3.1.0\ncrisp-1.4.4\nctbllib\nFactInt-1.6.2\nfga\nirredsol-1.4\nlaguna-3.9.0\npolenta-1.3.8\npolycyclic-2.14\nresclasses-4.7.1\nsophus-1.24\ntomlib-1.2.7\n```\n\nWith bz2 compression this squashes down to 66MB which, while not ideal, is somehow psychologically less troubling than 375MB, perhaps just being ~an order of magnitude smaller. \n\nWith LZMA compression (at the default compression level 6) it gets down to 58MB--this is what I use for the Windows installer.  This will probably make installation take that much longer (decompressing the files from the Windows installer takes quite a long time).  But I'm less concerned about that for now.",
    "created_at": "2018-12-19T14:22:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423635",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>
Okay, first of all, to be precise, the default packages in question are:

```
autpgrp-1.10
alnuth-3.1.0
crisp-1.4.4
ctbllib
FactInt-1.6.2
fga
irredsol-1.4
laguna-3.9.0
polenta-1.3.8
polycyclic-2.14
resclasses-4.7.1
sophus-1.24
tomlib-1.2.7
```

With bz2 compression this squashes down to 66MB which, while not ideal, is somehow psychologically less troubling than 375MB, perhaps just being ~an order of magnitude smaller. 

With LZMA compression (at the default compression level 6) it gets down to 58MB--this is what I use for the Windows installer.  This will probably make installation take that much longer (decompressing the files from the Windows installer takes quite a long time).  But I'm less concerned about that for now.



---

archive/issue_comments_423636.json:
```json
{
    "body": "<a id='comment:0'></a>\nRegarding the GAP startup time, this would hardly change, as loading a GAP workspace is blazing fast (I wish Python had this option...)",
    "created_at": "2018-12-19T14:33:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423636",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:0'></a>
Regarding the GAP startup time, this would hardly change, as loading a GAP workspace is blazing fast (I wish Python had this option...)



---

archive/issue_comments_423637.json:
```json
{
    "body": "<a id='comment:411'></a>\nReplying to [embray](#comment%3A402):\n> BTW building, installing, and loading the IO package works fine now, so I guess I fixed that somewhere along the line.\n\n\nYou mean, doing it in-place, like GAP does?",
    "created_at": "2018-12-19T14:36:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423637",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:411'></a>
Replying to [embray](#comment%3A402):
> BTW building, installing, and loading the IO package works fine now, so I guess I fixed that somewhere along the line.


You mean, doing it in-place, like GAP does?



---

archive/issue_comments_423638.json:
```json
{
    "body": "<a id='comment:412'></a>\nReplying to [dimpase](#comment%3A410):\n> I wish Python had this option...\n\n\nThe option of having an unreliable startup system which would crash whenever Python is upgraded or different packages are installed? :-)",
    "created_at": "2018-12-19T14:37:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423638",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:412'></a>
Replying to [dimpase](#comment%3A410):
> I wish Python had this option...


The option of having an unreliable startup system which would crash whenever Python is upgraded or different packages are installed? :-)



---

archive/issue_comments_423639.json:
```json
{
    "body": "<a id='comment:413'></a>\nReplying to [jdemeyer](#comment%3A412):\n> Replying to [dimpase](#comment%3A410):\n> > I wish Python had this option...\n\n> \n> The option of having an unreliable startup system which would crash whenever Python is upgraded or different packages are installed? :-)\n\n\nWell, how often an application programmer updates Python? And surely, a package installation can trigger a workspace rebuild, just as what code you wrote to handle GAP workspaces does...",
    "created_at": "2018-12-19T14:40:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423639",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:413'></a>
Replying to [jdemeyer](#comment%3A412):
> Replying to [dimpase](#comment%3A410):
> > I wish Python had this option...

> 
> The option of having an unreliable startup system which would crash whenever Python is upgraded or different packages are installed? :-)


Well, how often an application programmer updates Python? And surely, a package installation can trigger a workspace rebuild, just as what code you wrote to handle GAP workspaces does...



---

archive/issue_comments_423640.json:
```json
{
    "body": "<a id='comment:4'></a>\nIs it technically difficult to just make those gap packages an optional sage spkg?",
    "created_at": "2018-12-19T14:52:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423640",
    "user": "https://github.com/timokau"
}
```

<a id='comment:4'></a>
Is it technically difficult to just make those gap packages an optional sage spkg?



---

archive/issue_comments_423641.json:
```json
{
    "body": "<a id='comment:415'></a>\nReplying to [gh-timokau](#comment%3A414):\n> Is it technically difficult to just make those gap packages an optional sage spkg?\n\n\nNot really, but we've decided to get rid of these optional things, I think. \n[cf. sage-devel thread](https://groups.google.com/d/msg/sage-devel/JxgpPXjHPNs/wRuFhbyNBAAJ).\n\nIt's an extra complication resulting in chasing inconsistencies in GAP resulting from loading a different set of packages, textually different test results (and it annoys upstream).",
    "created_at": "2018-12-19T14:58:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423641",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:415'></a>
Replying to [gh-timokau](#comment%3A414):
> Is it technically difficult to just make those gap packages an optional sage spkg?


Not really, but we've decided to get rid of these optional things, I think. 
[cf. sage-devel thread](https://groups.google.com/d/msg/sage-devel/JxgpPXjHPNs/wRuFhbyNBAAJ).

It's an extra complication resulting in chasing inconsistencies in GAP resulting from loading a different set of packages, textually different test results (and it annoys upstream).



---

archive/issue_comments_423642.json:
```json
{
    "body": "<a id='comment:416'></a>\nReplying to [dimpase](#comment%3A413):\n> Replying to [jdemeyer](#comment%3A412):\n> > Replying to [dimpase](#comment%3A410):\n> > > I wish Python had this option...\n\n> > \n> > The option of having an unreliable startup system which would crash whenever Python is upgraded or different packages are installed? :-)\n\n> \n> Well, how often an application programmer updates Python? And surely, a package installation can trigger a workspace rebuild, just as what code you wrote to handle GAP workspaces does...\n\n\n+1 for a general Python install it would be annoying as the default behavior, but lots of Python apps are using a virtualenv or some other alternate PYTHONPATH with a fixed, unchanging set of packages, and for this case it would be nice to have some kind of \"frozen\" workspace that can load quicker.  One thing Python does have that GAP doesn't is pre-compiled bytecode modules, which does make a big difference, however.  But it would be nice if one could somehow mark module-level code as \"pure\", such that it could be stored as a pickle or something without having to re-execute it.  But that's getting off-topic...",
    "created_at": "2018-12-19T15:16:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423642",
    "user": "https://github.com/embray"
}
```

<a id='comment:416'></a>
Replying to [dimpase](#comment%3A413):
> Replying to [jdemeyer](#comment%3A412):
> > Replying to [dimpase](#comment%3A410):
> > > I wish Python had this option...

> > 
> > The option of having an unreliable startup system which would crash whenever Python is upgraded or different packages are installed? :-)

> 
> Well, how often an application programmer updates Python? And surely, a package installation can trigger a workspace rebuild, just as what code you wrote to handle GAP workspaces does...


+1 for a general Python install it would be annoying as the default behavior, but lots of Python apps are using a virtualenv or some other alternate PYTHONPATH with a fixed, unchanging set of packages, and for this case it would be nice to have some kind of "frozen" workspace that can load quicker.  One thing Python does have that GAP doesn't is pre-compiled bytecode modules, which does make a big difference, however.  But it would be nice if one could somehow mark module-level code as "pure", such that it could be stored as a pickle or something without having to re-execute it.  But that's getting off-topic...



---

archive/issue_comments_423643.json:
```json
{
    "body": "<a id='comment:417'></a>\nReplying to [embray](#comment%3A402):\n> BTW building, installing, and loading the IO package works fine now, so I guess I fixed that somewhere along the line.\n\n\nNevermind, this is still broken.  I *had* it working, apparently, but possibly only after some manual tinkering.  I need to figure out what I did previously to fix this.  Maybe I didn't even fix it at all:  `LoadPackage(\"IO\")` works from GAP, but not from `libgap.eval(...)` in Sage :(",
    "created_at": "2018-12-19T16:02:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423643",
    "user": "https://github.com/embray"
}
```

<a id='comment:417'></a>
Replying to [embray](#comment%3A402):
> BTW building, installing, and loading the IO package works fine now, so I guess I fixed that somewhere along the line.


Nevermind, this is still broken.  I *had* it working, apparently, but possibly only after some manual tinkering.  I need to figure out what I did previously to fix this.  Maybe I didn't even fix it at all:  `LoadPackage("IO")` works from GAP, but not from `libgap.eval(...)` in Sage :(



---

archive/issue_comments_423644.json:
```json
{
    "body": "**Changing commit** from \"[5e61d7b6a0da3aa53d8176fa1fb9353cc559b098](https://github.com/sagemath/sagetrac-mirror/commit/5e61d7b6a0da3aa53d8176fa1fb9353cc559b098)\" to \"[4d56e389afc507efc047ebb9a6308b0372f06fe0](https://github.com/sagemath/sagetrac-mirror/commit/4d56e389afc507efc047ebb9a6308b0372f06fe0)\".",
    "created_at": "2018-12-19T16:18:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423644",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[5e61d7b6a0da3aa53d8176fa1fb9353cc559b098](https://github.com/sagemath/sagetrac-mirror/commit/5e61d7b6a0da3aa53d8176fa1fb9353cc559b098)" to "[4d56e389afc507efc047ebb9a6308b0372f06fe0](https://github.com/sagemath/sagetrac-mirror/commit/4d56e389afc507efc047ebb9a6308b0372f06fe0)".



---

archive/issue_comments_423645.json:
```json
{
    "body": "<a id='comment:8'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8404d4df760f44878e3131654be1675ddd0461dd\">8404d4d</a></td><td><code>instead of disabling autoloading of default packages, just install all default packages as a standard part of the GAP SPKG</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4d56e389afc507efc047ebb9a6308b0372f06fe0\">4d56e38</a></td><td><code>more fixes to the GAP SPKG installation</code></td></tr></table>\n",
    "created_at": "2018-12-19T16:18:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423645",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8404d4df760f44878e3131654be1675ddd0461dd">8404d4d</a></td><td><code>instead of disabling autoloading of default packages, just install all default packages as a standard part of the GAP SPKG</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4d56e389afc507efc047ebb9a6308b0372f06fe0">4d56e38</a></td><td><code>more fixes to the GAP SPKG installation</code></td></tr></table>




---

archive/issue_comments_423646.json:
```json
{
    "body": "<a id='comment:9'></a>\nI understand the issue with compiled packages now, and it *is* still broken, as nthiery reported originally at https://github.com/markuspf/gap/issues/1 (why on Markus's fork I'm not sure).\n\nThis is really more a problem with the build system for the individual compiled packages though, and I'm not sure it's something really within the scope of this ticket (unless there are some generic build package tools in GAP itself that we need to fix, which might be possible; I haven't checked).  The shared libraries for compiled packages really need to be linked against libgap so that the loader can find GAP symbols from libgap.\n\nI'm still slightly surprised by this and would appreciate a detailed explanation if someone can give one.  I'd have assumed that if libgap.so had already been loaded, that the loader would still be able to resolve symbols from it when `dlopen()`-ing the GAP package.  But it seems that in this case a `DT_NEEDED` entry is still needed for some subtle reason that I'm not quite getting.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8404d4df760f44878e3131654be1675ddd0461dd\">8404d4d</a></td><td><code>instead of disabling autoloading of default packages, just install all default packages as a standard part of the GAP SPKG</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4d56e389afc507efc047ebb9a6308b0372f06fe0\">4d56e38</a></td><td><code>more fixes to the GAP SPKG installation</code></td></tr></table>\n",
    "created_at": "2018-12-19T16:32:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423646",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>
I understand the issue with compiled packages now, and it *is* still broken, as nthiery reported originally at https://github.com/markuspf/gap/issues/1 (why on Markus's fork I'm not sure).

This is really more a problem with the build system for the individual compiled packages though, and I'm not sure it's something really within the scope of this ticket (unless there are some generic build package tools in GAP itself that we need to fix, which might be possible; I haven't checked).  The shared libraries for compiled packages really need to be linked against libgap so that the loader can find GAP symbols from libgap.

I'm still slightly surprised by this and would appreciate a detailed explanation if someone can give one.  I'd have assumed that if libgap.so had already been loaded, that the loader would still be able to resolve symbols from it when `dlopen()`-ing the GAP package.  But it seems that in this case a `DT_NEEDED` entry is still needed for some subtle reason that I'm not quite getting.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8404d4df760f44878e3131654be1675ddd0461dd">8404d4d</a></td><td><code>instead of disabling autoloading of default packages, just install all default packages as a standard part of the GAP SPKG</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4d56e389afc507efc047ebb9a6308b0372f06fe0">4d56e38</a></td><td><code>more fixes to the GAP SPKG installation</code></td></tr></table>




---

archive/issue_comments_423647.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -94,8 +94,8 @@\n Error, SetGasmanMessageStatus: function is not yet defined\n true\n ```\n-~~This should be fixed once GAP's gap binary is built on top of libgap.\n-See: https://github.com/markuspf/gap/issues/1~~ I believe this is fixed, but there are still some problems with the way this ticket is \"installing\" GAP for `$SAGE_LOCAL`.\n+This should be fixed once GAP's gap binary is built on top of libgap.\n+See: https://github.com/markuspf/gap/issues/1 I believe this is fixed, but there are still some problems with the way this ticket is \"installing\" GAP for `$SAGE_LOCAL`.\n \n Note:\n \n``````\n",
    "created_at": "2018-12-19T16:32:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423647",
    "user": "https://github.com/embray"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -94,8 +94,8 @@
 Error, SetGasmanMessageStatus: function is not yet defined
 true
 ```
-~~This should be fixed once GAP's gap binary is built on top of libgap.
-See: https://github.com/markuspf/gap/issues/1~~ I believe this is fixed, but there are still some problems with the way this ticket is "installing" GAP for `$SAGE_LOCAL`.
+This should be fixed once GAP's gap binary is built on top of libgap.
+See: https://github.com/markuspf/gap/issues/1 I believe this is fixed, but there are still some problems with the way this ticket is "installing" GAP for `$SAGE_LOCAL`.
 
 Note:
 
``````




---

archive/issue_comments_423648.json:
```json
{
    "body": "<a id='comment:0'></a>\nDo I understand that having a GAP kernel module linked against libgap.so means that it would only work with libgap, but not with gap binary?\n\nIf so, this work should really wait for another ticket.",
    "created_at": "2018-12-19T16:44:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423648",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:0'></a>
Do I understand that having a GAP kernel module linked against libgap.so means that it would only work with libgap, but not with gap binary?

If so, this work should really wait for another ticket.



---

archive/issue_comments_423649.json:
```json
{
    "body": "<a id='comment:1'></a>\nFrom the `dlopen` docs\n\n> External references in the library are resolved using the libraries in that library's dependency list and any other libraries previously opened with the RTLD_GLOBAL flag. If the executable was linked with the flag \"-rdynamic\" (or, synonymously, \"--export-dynamic\"), then the global symbols in the executable will also be used to resolve references in a dynamically loaded library.\n\n\nOkay, so that means this depends on what binding mode libgap itself is opened with when it gets loaded (which likely only happens when one of the Python modules that depends on libgap is loaded).  I'm not sure exactly what that would be, but it appears [sys.setdlopenflags](https://docs.python.org/2/library/sys.html#sys.setdlopenflags) might be useful for this purpose.",
    "created_at": "2018-12-19T16:46:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423649",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>
From the `dlopen` docs

> External references in the library are resolved using the libraries in that library's dependency list and any other libraries previously opened with the RTLD_GLOBAL flag. If the executable was linked with the flag "-rdynamic" (or, synonymously, "--export-dynamic"), then the global symbols in the executable will also be used to resolve references in a dynamically loaded library.


Okay, so that means this depends on what binding mode libgap itself is opened with when it gets loaded (which likely only happens when one of the Python modules that depends on libgap is loaded).  I'm not sure exactly what that would be, but it appears [sys.setdlopenflags](https://docs.python.org/2/library/sys.html#sys.setdlopenflags) might be useful for this purpose.



---

archive/issue_comments_423650.json:
```json
{
    "body": "<a id='comment:2'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/18f2f4388b50b1b0b21535ca3f96db4b7ee03f71\">18f2f43</a></td><td><code>instead of disabling autoloading of default packages, just install all default packages as a standard part of the GAP SPKG</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/da909ef2a07cf361223dcbf552865201fff22167\">da909ef</a></td><td><code>more fixes to the GAP SPKG installation</code></td></tr></table>\n",
    "created_at": "2018-12-19T17:23:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423650",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/18f2f4388b50b1b0b21535ca3f96db4b7ee03f71">18f2f43</a></td><td><code>instead of disabling autoloading of default packages, just install all default packages as a standard part of the GAP SPKG</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/da909ef2a07cf361223dcbf552865201fff22167">da909ef</a></td><td><code>more fixes to the GAP SPKG installation</code></td></tr></table>




---

archive/issue_comments_423651.json:
```json
{
    "body": "**Changing commit** from \"[4d56e389afc507efc047ebb9a6308b0372f06fe0](https://github.com/sagemath/sagetrac-mirror/commit/4d56e389afc507efc047ebb9a6308b0372f06fe0)\" to \"[da909ef2a07cf361223dcbf552865201fff22167](https://github.com/sagemath/sagetrac-mirror/commit/da909ef2a07cf361223dcbf552865201fff22167)\".",
    "created_at": "2018-12-19T17:23:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423651",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[4d56e389afc507efc047ebb9a6308b0372f06fe0](https://github.com/sagemath/sagetrac-mirror/commit/4d56e389afc507efc047ebb9a6308b0372f06fe0)" to "[da909ef2a07cf361223dcbf552865201fff22167](https://github.com/sagemath/sagetrac-mirror/commit/da909ef2a07cf361223dcbf552865201fff22167)".



---

archive/issue_comments_423652.json:
```json
{
    "body": "<a id='comment:3'></a>\none also needs to install pkg/atlasrep, a dependency of pkg/tomlib\n\n(that's what I did, but you prefer to roll your own...\nhttps://github.com/sagemath/sagetrac-mirror/commit/d305273fcdd2c247a0c50b8432e2939bc9c6a0f6)",
    "created_at": "2018-12-19T17:32:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423652",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:3'></a>
one also needs to install pkg/atlasrep, a dependency of pkg/tomlib

(that's what I did, but you prefer to roll your own...
https://github.com/sagemath/sagetrac-mirror/commit/d305273fcdd2c247a0c50b8432e2939bc9c6a0f6)



---

archive/issue_comments_423653.json:
```json
{
    "body": "<a id='comment:424'></a>\nReplying to [dimpase](#comment%3A420):\n> Do I understand that having a GAP kernel module linked against libgap.so means that it would only work with libgap, but not with gap binary?\n> \n> If so, this work should really wait for another ticket.\n\n\nI'm inclined to agree it might be best to hold off on this.  However, this little hack fixed the issue for me:\n\n```diff\ndiff --git a/src/sage/libs/gap/util.pyx b/src/sage/libs/gap/util.pyx\nindex 5e2805d..ed33453 100644\n--- a/src/sage/libs/gap/util.pyx\n+++ b/src/sage/libs/gap/util.pyx\n@@ -18,6 +18,7 @@ import os\n import signal\n import warnings\n\n+from posix.dlfcn cimport dlopen, dlclose, RTLD_NOW, RTLD_GLOBAL\n from libc.string cimport strcpy, strlen\n\n from cpython.exc cimport PyErr_SetObject, PyErr_Occurred, PyErr_Fetch\n@@ -259,6 +260,18 @@ cdef initialize():\n     global _gap_is_initialized, environ\n     if _gap_is_initialized: return\n\n+    # Hack to ensure that all symbols provided by libgap are loaded into the\n+    # global symbol table\n+    # Note: we could use RTLD_NOLOAD and avoid the subsequent dlclose() but\n+    # this isn't portable\n+    cdef void* handle\n+    handle = dlopen(\"libgap.so\", RTLD_NOW | RTLD_GLOBAL)\n+    if handle == NULL:\n+        raise RuntimeError(\n+                \"Could not dlopen() libgap.so even though it should already \"\n+                \"be loaded!\")\n+    dlclose(handle)\n+\n     # Define argv and environ variables, which we will pass in to\n     # initialize GAP. Note that we must pass define the memory pool\n     # size!\n```\n\nat least on Linux.  In theory it should work on Cygwin and macOS as well but I think that should be tested.\n\nOtherwise, pending any other issues anyone wants to raise, I'm calling this \"done\".",
    "created_at": "2018-12-19T17:54:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423653",
    "user": "https://github.com/embray"
}
```

<a id='comment:424'></a>
Replying to [dimpase](#comment%3A420):
> Do I understand that having a GAP kernel module linked against libgap.so means that it would only work with libgap, but not with gap binary?
> 
> If so, this work should really wait for another ticket.


I'm inclined to agree it might be best to hold off on this.  However, this little hack fixed the issue for me:

```diff
diff --git a/src/sage/libs/gap/util.pyx b/src/sage/libs/gap/util.pyx
index 5e2805d..ed33453 100644
--- a/src/sage/libs/gap/util.pyx
+++ b/src/sage/libs/gap/util.pyx
@@ -18,6 +18,7 @@ import os
 import signal
 import warnings

+from posix.dlfcn cimport dlopen, dlclose, RTLD_NOW, RTLD_GLOBAL
 from libc.string cimport strcpy, strlen

 from cpython.exc cimport PyErr_SetObject, PyErr_Occurred, PyErr_Fetch
@@ -259,6 +260,18 @@ cdef initialize():
     global _gap_is_initialized, environ
     if _gap_is_initialized: return

+    # Hack to ensure that all symbols provided by libgap are loaded into the
+    # global symbol table
+    # Note: we could use RTLD_NOLOAD and avoid the subsequent dlclose() but
+    # this isn't portable
+    cdef void* handle
+    handle = dlopen("libgap.so", RTLD_NOW | RTLD_GLOBAL)
+    if handle == NULL:
+        raise RuntimeError(
+                "Could not dlopen() libgap.so even though it should already "
+                "be loaded!")
+    dlclose(handle)
+
     # Define argv and environ variables, which we will pass in to
     # initialize GAP. Note that we must pass define the memory pool
     # size!
```

at least on Linux.  In theory it should work on Cygwin and macOS as well but I think that should be tested.

Otherwise, pending any other issues anyone wants to raise, I'm calling this "done".



---

archive/issue_comments_423654.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2018-12-19T17:54:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423654",
    "user": "https://github.com/embray"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_423655.json:
```json
{
    "body": "<a id='comment:425'></a>\nReplying to [dimpase](#comment%3A423):\n> one also needs to install pkg/atlasrep, a dependency of pkg/tomlib\n\n\nI see...\n\nWhat's strange is that if one of the default packages doesn't exist GAP makes a big warning about it, but if it simply is \"unavailable\" due to some of its dependencies being missing it just quietly does not load that package.",
    "created_at": "2018-12-19T17:58:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423655",
    "user": "https://github.com/embray"
}
```

<a id='comment:425'></a>
Replying to [dimpase](#comment%3A423):
> one also needs to install pkg/atlasrep, a dependency of pkg/tomlib


I see...

What's strange is that if one of the default packages doesn't exist GAP makes a big warning about it, but if it simply is "unavailable" due to some of its dependencies being missing it just quietly does not load that package.



---

archive/issue_comments_423656.json:
```json
{
    "body": "**Changing commit** from \"[da909ef2a07cf361223dcbf552865201fff22167](https://github.com/sagemath/sagetrac-mirror/commit/da909ef2a07cf361223dcbf552865201fff22167)\" to \"[d1c98f33d429a110e38b9576676ae3f3ea9faaec](https://github.com/sagemath/sagetrac-mirror/commit/d1c98f33d429a110e38b9576676ae3f3ea9faaec)\".",
    "created_at": "2018-12-19T18:03:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423656",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[da909ef2a07cf361223dcbf552865201fff22167](https://github.com/sagemath/sagetrac-mirror/commit/da909ef2a07cf361223dcbf552865201fff22167)" to "[d1c98f33d429a110e38b9576676ae3f3ea9faaec](https://github.com/sagemath/sagetrac-mirror/commit/d1c98f33d429a110e38b9576676ae3f3ea9faaec)".



---

archive/issue_comments_423657.json:
```json
{
    "body": "<a id='comment:6'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d1c98f33d429a110e38b9576676ae3f3ea9faaec\">d1c98f3</a></td><td><code>also include the atlasrep package, which is a dependency of tomlib</code></td></tr></table>\n",
    "created_at": "2018-12-19T18:03:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423657",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d1c98f33d429a110e38b9576676ae3f3ea9faaec">d1c98f3</a></td><td><code>also include the atlasrep package, which is a dependency of tomlib</code></td></tr></table>




---

archive/issue_comments_423658.json:
```json
{
    "body": "<a id='comment:427'></a>\nReplying to [embray](#comment%3A424):\n> Replying to [dimpase](#comment%3A420):\n> > Do I understand that having a GAP kernel module linked against libgap.so means that it would only work with libgap, but not with gap binary?\n> > \n> > If so, this work should really wait for another ticket.\n\n> \n> I'm inclined to agree it might be best to hold off on this.  However, this little hack fixed the issue for me:\n\n\n> \n> Otherwise, pending any other issues anyone wants to raise, I'm calling this \"done\".\n\n\nI already asked about means to install the GAP packages that need compilation.\nWill we install and keep them in-place, at least for now, is this what you do with GAP's io?",
    "created_at": "2018-12-19T18:09:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423658",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:427'></a>
Replying to [embray](#comment%3A424):
> Replying to [dimpase](#comment%3A420):
> > Do I understand that having a GAP kernel module linked against libgap.so means that it would only work with libgap, but not with gap binary?
> > 
> > If so, this work should really wait for another ticket.

> 
> I'm inclined to agree it might be best to hold off on this.  However, this little hack fixed the issue for me:


> 
> Otherwise, pending any other issues anyone wants to raise, I'm calling this "done".


I already asked about means to install the GAP packages that need compilation.
Will we install and keep them in-place, at least for now, is this what you do with GAP's io?



---

archive/issue_comments_423659.json:
```json
{
    "body": "<a id='comment:428'></a>\nReplying to [dimpase](#comment%3A415):\n> Replying to [gh-timokau](#comment%3A414):\n> > Is it technically difficult to just make those gap packages an optional sage spkg?\n\n> \n> Not really, but we've decided to get rid of these optional things, I think. \n> [cf. sage-devel thread](https://groups.google.com/d/msg/sage-devel/JxgpPXjHPNs/wRuFhbyNBAAJ).\n> \n> It's an extra complication resulting in chasing inconsistencies in GAP resulting from loading a different set of packages, textually different test results (and it annoys upstream). \n\n\nAh makes sense. In general I'd prefer the sage core to be as lean as possible with everything that isn't essential being optional. But then again I also don't want to maintain the split packages myself, so I guess I don't feel strongly about it :)",
    "created_at": "2018-12-19T19:00:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423659",
    "user": "https://github.com/timokau"
}
```

<a id='comment:428'></a>
Replying to [dimpase](#comment%3A415):
> Replying to [gh-timokau](#comment%3A414):
> > Is it technically difficult to just make those gap packages an optional sage spkg?

> 
> Not really, but we've decided to get rid of these optional things, I think. 
> [cf. sage-devel thread](https://groups.google.com/d/msg/sage-devel/JxgpPXjHPNs/wRuFhbyNBAAJ).
> 
> It's an extra complication resulting in chasing inconsistencies in GAP resulting from loading a different set of packages, textually different test results (and it annoys upstream). 


Ah makes sense. In general I'd prefer the sage core to be as lean as possible with everything that isn't essential being optional. But then again I also don't want to maintain the split packages myself, so I guess I don't feel strongly about it :)



---

archive/issue_comments_423660.json:
```json
{
    "body": "**Reviewer:** Erik Bray, Dima Pasechnik,  Jeroen Demeyer",
    "created_at": "2018-12-19T23:05:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423660",
    "user": "https://github.com/dimpase"
}
```

**Reviewer:** Erik Bray, Dima Pasechnik,  Jeroen Demeyer



---

archive/issue_comments_423661.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2018-12-19T23:05:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423661",
    "user": "https://github.com/dimpase"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_423662.json:
```json
{
    "body": "**Changing work_issues** from \"ironing out the last kinks\" to \"\".",
    "created_at": "2018-12-19T23:05:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423662",
    "user": "https://github.com/dimpase"
}
```

**Changing work_issues** from "ironing out the last kinks" to "".



---

archive/issue_comments_423663.json:
```json
{
    "body": "<a id='comment:9'></a>\nGood to go, I think. I also think that Erik truly deserves an award for getting this very tricky ticket done!",
    "created_at": "2018-12-19T23:05:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423663",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:9'></a>
Good to go, I think. I also think that Erik truly deserves an award for getting this very tricky ticket done!



---

archive/issue_comments_423664.json:
```json
{
    "body": "<a id='comment:430'></a>\nReplying to [dimpase](#comment%3A429):\n> Erik truly deserves an award for getting this very tricky ticket done!\n\n\nAgreed. Thank you for working on this Erik!\n\n(Now if the ECL ticket finally gets resolved I think its possible to run sage with all system dependencies :))",
    "created_at": "2018-12-19T23:23:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423664",
    "user": "https://github.com/timokau"
}
```

<a id='comment:430'></a>
Replying to [dimpase](#comment%3A429):
> Erik truly deserves an award for getting this very tricky ticket done!


Agreed. Thank you for working on this Erik!

(Now if the ECL ticket finally gets resolved I think its possible to run sage with all system dependencies :))



---

archive/issue_comments_423665.json:
```json
{
    "body": "<a id='comment:431'></a>\nReplying to [gh-timokau](#comment%3A430):\n> Replying to [dimpase](#comment%3A429):\n> > Erik truly deserves an award for getting this very tricky ticket done!\n\n> \n> Agreed. Thank you for working on this Erik!\n> \n> (Now if the ECL ticket finally gets resolved I think its possible to run sage with all system dependencies :))\n\n\nWhich ECL ticket?  Can you CC me on that?  I've spent some time in the past working on the ECL integration with Sage.  I didn't know there were still problems with using the system ECL.",
    "created_at": "2018-12-20T09:01:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423665",
    "user": "https://github.com/embray"
}
```

<a id='comment:431'></a>
Replying to [gh-timokau](#comment%3A430):
> Replying to [dimpase](#comment%3A429):
> > Erik truly deserves an award for getting this very tricky ticket done!

> 
> Agreed. Thank you for working on this Erik!
> 
> (Now if the ECL ticket finally gets resolved I think its possible to run sage with all system dependencies :))


Which ECL ticket?  Can you CC me on that?  I've spent some time in the past working on the ECL integration with Sage.  I didn't know there were still problems with using the system ECL.



---

archive/issue_comments_423666.json:
```json
{
    "body": "**Changing status** from positive_review to needs_work.",
    "created_at": "2018-12-20T09:14:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423666",
    "user": "https://github.com/dimpase"
}
```

**Changing status** from positive_review to needs_work.



---

archive/issue_comments_423667.json:
```json
{
    "body": "<a id='comment:2'></a>\na small problem with permissions, only seen on OSX:\n\n```\n[gap-4.10.0] Copying package files from temporary location /Users/dima/sagetrac-mirror/local/var/tmp/sage/build/gap-4.10.0/inst to /Users/dima/sagetrac-mirror/local\n[gap-4.10.0] cp: /Users/dima/sagetrac-mirror/local/./share/gap/pkg/ctbllib/tst/docxpl.tst: Permission denied\n```\n\nfor some reason, the permissions of this file are `rrr` (probably in the tarball)",
    "created_at": "2018-12-20T09:14:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423667",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:2'></a>
a small problem with permissions, only seen on OSX:

```
[gap-4.10.0] Copying package files from temporary location /Users/dima/sagetrac-mirror/local/var/tmp/sage/build/gap-4.10.0/inst to /Users/dima/sagetrac-mirror/local
[gap-4.10.0] cp: /Users/dima/sagetrac-mirror/local/./share/gap/pkg/ctbllib/tst/docxpl.tst: Permission denied
```

for some reason, the permissions of this file are `rrr` (probably in the tarball)



---

archive/issue_comments_423668.json:
```json
{
    "body": "<a id='comment:3'></a>\ntrying again, and getting\n\n```\n[gap-4.10.0] Copying package files from temporary location /Users/dima/sagetrac-mirror/local/var/tmp/sage/build/gap-4.10.0/inst to /Users/dima/sagetrac-mirror/local\n[gap-4.10.0] cp: cannot overwrite directory /Users/dima/sagetrac-mirror/local/./share/gap/bin/x86_64-apple-darwin17.7.0-default64/src with non-directory /Users/dima/sagetrac-mirror/local/var/tmp/sage/build/gap-4.10.0/inst/Users/dima/sagetrac-mirror/local/./share/gap/bin/x86_64-apple-darwin17.7.0-default64/src\n[gap-4.10.0] cp: /Users/dima/sagetrac-mirror/local/./share/gap/pkg/ctbllib/tst/docxpl.tst: Permission denied\n[gap-4.10.0] ************************************************************************\n[gap-4.10.0] Error copying files for gap-4.10.0.\n```\n\nlooks like local/share/gap does not get wiped up completely, due to this read-only file. Indeed:\n\n```\n$ ls -l local/share/gap/pkg/ctbllib/tst/\ntotal 2272\n-rw-r--r--  1 dima  staff   57320 20 Dec 09:32 ambigfus.tst\n-rw-r--r--  1 dima  staff   18162 20 Dec 09:32 ctblcons.g\n-rw-r--r--  1 dima  staff  133327 20 Dec 09:32 ctblcons.tst\n-rw-r--r--  1 dima  staff   10762 20 Dec 09:32 ctbldeco.tst\n-rw-r--r--  1 dima  staff    7254 20 Dec 09:32 ctblj4.tst\n-rw-r--r--  1 dima  staff    3230 20 Dec 09:32 ctbllib.tst\n-rw-r--r--  1 dima  staff   58554 20 Dec 09:32 ctblpope.tst\n-rw-r--r--  1 dima  staff    8265 20 Dec 09:32 ctocenex.tst\n-rw-r--r--  1 dima  staff   17708 20 Dec 09:32 dntgap.tst\n-r--r--r--  1 dima  staff   35292 18 Dec 21:28 docxpl.tst\n-rw-r--r--  1 dima  staff   14865 20 Dec 09:32 hamilcyc.g\n-rw-r--r--  1 dima  staff   40835 20 Dec 09:32 hamilcyc.tst\n-rw-r--r--  1 dima  staff    4208 20 Dec 09:32 maintain.tst\n-rw-r--r--  1 dima  staff  328346 20 Dec 09:32 mferctbl.gap\n-rw-r--r--  1 dima  staff   64934 20 Dec 09:32 multfre2.tst\n-rw-r--r--  1 dima  staff   19893 20 Dec 09:32 multfree.dat\n-rw-r--r--  1 dima  staff   12505 20 Dec 09:32 multfree.g\n-rw-r--r--  1 dima  staff   25647 20 Dec 09:32 multfree.tst\n-rw-r--r--  1 dima  staff    8555 20 Dec 09:32 o8p2s3_o8p5s3.g\n-rw-r--r--  1 dima  staff    9870 20 Dec 09:32 o8p2s3_o8p5s3.tst\n-rw-r--r--  1 dima  staff   42530 20 Dec 09:32 probgen.g\n-rw-r--r--  1 dima  staff  163817 20 Dec 09:32 probgen.tst\n-rw-r--r--  1 dima  staff   19540 20 Dec 09:32 sporsolv.tst\n-rw-r--r--  1 dima  staff    1218 20 Dec 09:32 testall.g\n-rw-r--r--  1 dima  staff     639 20 Dec 09:32 testauto.g\n-rw-r--r--  1 dima  staff    2237 20 Dec 09:32 testinst.g\n```\nnotice the date of this file, it's 18th Dec, not 20th Dec!",
    "created_at": "2018-12-20T09:42:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423668",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:3'></a>
trying again, and getting

```
[gap-4.10.0] Copying package files from temporary location /Users/dima/sagetrac-mirror/local/var/tmp/sage/build/gap-4.10.0/inst to /Users/dima/sagetrac-mirror/local
[gap-4.10.0] cp: cannot overwrite directory /Users/dima/sagetrac-mirror/local/./share/gap/bin/x86_64-apple-darwin17.7.0-default64/src with non-directory /Users/dima/sagetrac-mirror/local/var/tmp/sage/build/gap-4.10.0/inst/Users/dima/sagetrac-mirror/local/./share/gap/bin/x86_64-apple-darwin17.7.0-default64/src
[gap-4.10.0] cp: /Users/dima/sagetrac-mirror/local/./share/gap/pkg/ctbllib/tst/docxpl.tst: Permission denied
[gap-4.10.0] ************************************************************************
[gap-4.10.0] Error copying files for gap-4.10.0.
```

looks like local/share/gap does not get wiped up completely, due to this read-only file. Indeed:

```
$ ls -l local/share/gap/pkg/ctbllib/tst/
total 2272
-rw-r--r--  1 dima  staff   57320 20 Dec 09:32 ambigfus.tst
-rw-r--r--  1 dima  staff   18162 20 Dec 09:32 ctblcons.g
-rw-r--r--  1 dima  staff  133327 20 Dec 09:32 ctblcons.tst
-rw-r--r--  1 dima  staff   10762 20 Dec 09:32 ctbldeco.tst
-rw-r--r--  1 dima  staff    7254 20 Dec 09:32 ctblj4.tst
-rw-r--r--  1 dima  staff    3230 20 Dec 09:32 ctbllib.tst
-rw-r--r--  1 dima  staff   58554 20 Dec 09:32 ctblpope.tst
-rw-r--r--  1 dima  staff    8265 20 Dec 09:32 ctocenex.tst
-rw-r--r--  1 dima  staff   17708 20 Dec 09:32 dntgap.tst
-r--r--r--  1 dima  staff   35292 18 Dec 21:28 docxpl.tst
-rw-r--r--  1 dima  staff   14865 20 Dec 09:32 hamilcyc.g
-rw-r--r--  1 dima  staff   40835 20 Dec 09:32 hamilcyc.tst
-rw-r--r--  1 dima  staff    4208 20 Dec 09:32 maintain.tst
-rw-r--r--  1 dima  staff  328346 20 Dec 09:32 mferctbl.gap
-rw-r--r--  1 dima  staff   64934 20 Dec 09:32 multfre2.tst
-rw-r--r--  1 dima  staff   19893 20 Dec 09:32 multfree.dat
-rw-r--r--  1 dima  staff   12505 20 Dec 09:32 multfree.g
-rw-r--r--  1 dima  staff   25647 20 Dec 09:32 multfree.tst
-rw-r--r--  1 dima  staff    8555 20 Dec 09:32 o8p2s3_o8p5s3.g
-rw-r--r--  1 dima  staff    9870 20 Dec 09:32 o8p2s3_o8p5s3.tst
-rw-r--r--  1 dima  staff   42530 20 Dec 09:32 probgen.g
-rw-r--r--  1 dima  staff  163817 20 Dec 09:32 probgen.tst
-rw-r--r--  1 dima  staff   19540 20 Dec 09:32 sporsolv.tst
-rw-r--r--  1 dima  staff    1218 20 Dec 09:32 testall.g
-rw-r--r--  1 dima  staff     639 20 Dec 09:32 testauto.g
-rw-r--r--  1 dima  staff    2237 20 Dec 09:32 testinst.g
```
notice the date of this file, it's 18th Dec, not 20th Dec!



---

archive/issue_comments_423669.json:
```json
{
    "body": "<a id='comment:4'></a>\nInstallation works if I just do `rm -rf local/share/gap/` before starting it. \nSo it looks like the cleaning of old files is not done with sufficient force, i.e. the clever uninstallation code fails to clean in such a case on OSX.\n\nCan we add that `rm -rf local/share/gap/` at the start?",
    "created_at": "2018-12-20T09:53:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423669",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:4'></a>
Installation works if I just do `rm -rf local/share/gap/` before starting it. 
So it looks like the cleaning of old files is not done with sufficient force, i.e. the clever uninstallation code fails to clean in such a case on OSX.

Can we add that `rm -rf local/share/gap/` at the start?



---

archive/issue_comments_423670.json:
```json
{
    "body": "<a id='comment:5'></a>\nThis looks more like a problem to be addressed in the build system.  I'll look into it.  If we do anything here at all it would be fixing permissions on those files.  I don't see why they would need to be like that.",
    "created_at": "2018-12-20T10:33:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423670",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>
This looks more like a problem to be addressed in the build system.  I'll look into it.  If we do anything here at all it would be fixing permissions on those files.  I don't see why they would need to be like that.



---

archive/issue_comments_423671.json:
```json
{
    "body": "<a id='comment:6'></a>\nThere of course no reason for GAP to distribute some read-only files. It'll chase it up with them.",
    "created_at": "2018-12-20T10:35:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423671",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:6'></a>
There of course no reason for GAP to distribute some read-only files. It'll chase it up with them.



---

archive/issue_comments_423672.json:
```json
{
    "body": "<a id='comment:7'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/53f07cc92ee670a7aa091eee1c056c488167ab13\">53f07cc</a></td><td><code>disable parallel make for gap</code></td></tr></table>\n",
    "created_at": "2018-12-20T10:40:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423672",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/53f07cc92ee670a7aa091eee1c056c488167ab13">53f07cc</a></td><td><code>disable parallel make for gap</code></td></tr></table>




---

archive/issue_comments_423673.json:
```json
{
    "body": "**Changing commit** from \"[d1c98f33d429a110e38b9576676ae3f3ea9faaec](https://github.com/sagemath/sagetrac-mirror/commit/d1c98f33d429a110e38b9576676ae3f3ea9faaec)\" to \"[53f07cc92ee670a7aa091eee1c056c488167ab13](https://github.com/sagemath/sagetrac-mirror/commit/53f07cc92ee670a7aa091eee1c056c488167ab13)\".",
    "created_at": "2018-12-20T10:40:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423673",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[d1c98f33d429a110e38b9576676ae3f3ea9faaec](https://github.com/sagemath/sagetrac-mirror/commit/d1c98f33d429a110e38b9576676ae3f3ea9faaec)" to "[53f07cc92ee670a7aa091eee1c056c488167ab13](https://github.com/sagemath/sagetrac-mirror/commit/53f07cc92ee670a7aa091eee1c056c488167ab13)".



---

archive/issue_comments_423674.json:
```json
{
    "body": "<a id='comment:8'></a>\nI see, just that one file has goofed permissions in the tarball.  I wonder why:\n\n```\n-r--r--r-- gap-jenkins/gap-jenkins   35292 2018-11-01 22:56 gap-4.10.0/pkg/ctbllib/tst/docxpl.tst\n```\n\nIt's the only one like that.",
    "created_at": "2018-12-20T10:43:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423674",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>
I see, just that one file has goofed permissions in the tarball.  I wonder why:

```
-r--r--r-- gap-jenkins/gap-jenkins   35292 2018-11-01 22:56 gap-4.10.0/pkg/ctbllib/tst/docxpl.tst
```

It's the only one like that.



---

archive/issue_comments_423675.json:
```json
{
    "body": "**Changing status** from needs_work to positive_review.",
    "created_at": "2018-12-20T10:50:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423675",
    "user": "https://github.com/embray"
}
```

**Changing status** from needs_work to positive_review.



---

archive/issue_comments_423676.json:
```json
{
    "body": "<a id='comment:9'></a>\nI don't think there's anything to do here for now.  The uninstaller removes that file fine so long as it was part of the installation in the first place.  As you and I have been monkeying around with the package, it's possible you manually put that file there, rather than it being placed there by the installer, in which case it would have been untracked, so the uninstaller would not have removed it.  The installer then failed to overwrite the existing file.  This wouldn't happen under normal usage.\n\nI consider it a feature that the installer will fail if it tries to overwrite an existing file and can't, as that's an indication of an issue we'd want to know about (which in this case it was!) but not one we really need to worry about in this case.",
    "created_at": "2018-12-20T10:50:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423676",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>
I don't think there's anything to do here for now.  The uninstaller removes that file fine so long as it was part of the installation in the first place.  As you and I have been monkeying around with the package, it's possible you manually put that file there, rather than it being placed there by the installer, in which case it would have been untracked, so the uninstaller would not have removed it.  The installer then failed to overwrite the existing file.  This wouldn't happen under normal usage.

I consider it a feature that the installer will fail if it tries to overwrite an existing file and can't, as that's an indication of an issue we'd want to know about (which in this case it was!) but not one we really need to worry about in this case.



---

archive/issue_comments_423677.json:
```json
{
    "body": "<a id='comment:0'></a>\nOK, fine with me then. I have not realised how advanced the (un)installation system is.\n\n\nBy the way, why \"disable parallel make for gap\"?\nI never saw any problems with this.",
    "created_at": "2018-12-20T10:54:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423677",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:0'></a>
OK, fine with me then. I have not realised how advanced the (un)installation system is.


By the way, why "disable parallel make for gap"?
I never saw any problems with this.



---

archive/issue_comments_423678.json:
```json
{
    "body": "<a id='comment:441'></a>\nReplying to [dimpase](#comment%3A436):\n> There of course no reason for GAP to distribute some read-only files. It'll chase it up with them.\n\n\nsee https://github.com/gap-system/gap/issues/3126",
    "created_at": "2018-12-20T11:05:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423678",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:441'></a>
Replying to [dimpase](#comment%3A436):
> There of course no reason for GAP to distribute some read-only files. It'll chase it up with them.


see https://github.com/gap-system/gap/issues/3126



---

archive/issue_comments_423679.json:
```json
{
    "body": "<a id='comment:2'></a>\nOn cygwin, and only on cygwin, I've started consistently getting the following failure:\n\n```\nsage -t --long src/sage/graphs/generators/families.py\n**********************************************************************\nFile \"src/sage/graphs/generators/families.py\", line 3179, in sage.graphs.generators.families.MathonPseudocyclicStronglyRegularGraph\nFailed example:\n    L = sum(i*(r[a]-r[b]) for i,(a,b) in zip(range(1,len(ff)+1), ff)); L\nExpected:\n    [ 0 -1  1 -2 -3 -4  2  4  3]\n    [ 1  0 -1 -4 -2 -3  3  2  4]\n    [-1  1  0 -3 -4 -2  4  3  2]\n    [ 2  4  3  0 -1  1 -2 -3 -4]\n    [ 3  2  4  1  0 -1 -4 -2 -3]\n    [ 4  3  2 -1  1  0 -3 -4 -2]\n    [-2 -3 -4  2  4  3  0 -1  1]\n    [-4 -2 -3  3  2  4  1  0 -1]\n    [-3 -4 -2  4  3  2 -1  1  0]\nGot:\n    [ 0  1 -1 -3 -2 -4  3  4  2]\n    [-1  0  1 -4 -3 -2  2  3  4]\n    [ 1 -1  0 -2 -4 -3  4  2  3]\n    [ 3  4  2  0  1 -1 -3 -2 -4]\n    [ 2  3  4 -1  0  1 -4 -3 -2]\n    [ 4  2  3  1 -1  0 -2 -4 -3]\n    [-3 -2 -4  3  4  2  0  1 -1]\n    [-4 -3 -2  2  3  4 -1  0  1]\n    [-2 -4 -3  4  2  3  1 -1  0]\n**********************************************************************\n1 item had failures:\n   1 of  17 in sage.graphs.generators.families.MathonPseudocyclicStronglyRegularGraph\n    [363 tests, 1 failure, 61.19 s]\n```\n\nThis didn't happen until recently.  It might be a change introduced by one of the packages we're installing that weren't installed before, but it's still unclear why the failure would only occur on cygwin.  It might be the sort of thing where the code is not strictly deterministic, but happens to work consistently between runs on the same platform.  I'll double-check.",
    "created_at": "2018-12-20T12:08:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423679",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>
On cygwin, and only on cygwin, I've started consistently getting the following failure:

```
sage -t --long src/sage/graphs/generators/families.py
**********************************************************************
File "src/sage/graphs/generators/families.py", line 3179, in sage.graphs.generators.families.MathonPseudocyclicStronglyRegularGraph
Failed example:
    L = sum(i*(r[a]-r[b]) for i,(a,b) in zip(range(1,len(ff)+1), ff)); L
Expected:
    [ 0 -1  1 -2 -3 -4  2  4  3]
    [ 1  0 -1 -4 -2 -3  3  2  4]
    [-1  1  0 -3 -4 -2  4  3  2]
    [ 2  4  3  0 -1  1 -2 -3 -4]
    [ 3  2  4  1  0 -1 -4 -2 -3]
    [ 4  3  2 -1  1  0 -3 -4 -2]
    [-2 -3 -4  2  4  3  0 -1  1]
    [-4 -2 -3  3  2  4  1  0 -1]
    [-3 -4 -2  4  3  2 -1  1  0]
Got:
    [ 0  1 -1 -3 -2 -4  3  4  2]
    [-1  0  1 -4 -3 -2  2  3  4]
    [ 1 -1  0 -2 -4 -3  4  2  3]
    [ 3  4  2  0  1 -1 -3 -2 -4]
    [ 2  3  4 -1  0  1 -4 -3 -2]
    [ 4  2  3  1 -1  0 -2 -4 -3]
    [-3 -2 -4  3  4  2  0  1 -1]
    [-4 -3 -2  2  3  4 -1  0  1]
    [-2 -4 -3  4  2  3  1 -1  0]
**********************************************************************
1 item had failures:
   1 of  17 in sage.graphs.generators.families.MathonPseudocyclicStronglyRegularGraph
    [363 tests, 1 failure, 61.19 s]
```

This didn't happen until recently.  It might be a change introduced by one of the packages we're installing that weren't installed before, but it's still unclear why the failure would only occur on cygwin.  It might be the sort of thing where the code is not strictly deterministic, but happens to work consistently between runs on the same platform.  I'll double-check.



---

archive/issue_comments_423680.json:
```json
{
    "body": "<a id='comment:3'></a>\nOh, are we on the right ticket? Isn't this\n[this change](https://git.sagemath.org/sage.git/diff/src/sage/graphs/generators/families.py?id=a7ef9e015984e48785b80d95ff422bcd3f6ae232&id2=9dde00f5835425953f42baa26c0eea04dbba765a) on #26856?\n\n```\n--- a/src/sage/graphs/generators/families.py\n+++ b/src/sage/graphs/generators/families.py\n@@ -3177,15 +3177,16 @@ def MathonPseudocyclicStronglyRegularGraph(t, G=None, L=None):\n         sage: ff = list(map(lambda y: (y[0]-1,y[1]-1),\n         ....:          Permutation(map(lambda x: 1+r.index(x^-1), r)).cycle_tuples()[1:]))\n         sage: L = sum(i*(r[a]-r[b]) for i,(a,b) in zip(range(1,len(ff)+1), ff)); L\n-        [ 0 -1  1 -2 -3 -4  2  4  3]\n-        [ 1  0 -1 -4 -2 -3  3  2  4]\n-        [-1  1  0 -3 -4 -2  4  3  2]\n-        [ 2  4  3  0 -1  1 -2 -3 -4]\n-        [ 3  2  4  1  0 -1 -4 -2 -3]\n-        [ 4  3  2 -1  1  0 -3 -4 -2]\n-        [-2 -3 -4  2  4  3  0 -1  1]\n-        [-4 -2 -3  3  2  4  1  0 -1]\n-        [-3 -4 -2  4  3  2 -1  1  0]\n+        [ 0  1 -1 -3 -2 -4  3  4  2]\n+        [-1  0  1 -4 -3 -2  2  3  4]\n+        [ 1 -1  0 -2 -4 -3  4  2  3]\n+        [ 3  4  2  0  1 -1 -3 -2 -4]\n+        [ 2  3  4 -1  0  1 -4 -3 -2]\n+        [ 4  2  3  1 -1  0 -2 -4 -3]\n+        [-3 -2 -4  3  4  2  0  1 -1]\n+        [-4 -3 -2  2  3  4 -1  0  1]\n+        [-2 -4 -3  4  2  3  1 -1  0]\n+\n         sage: G.relabel()\n         sage: G3x3=graphs.MathonPseudocyclicStronglyRegularGraph(2,G=G,L=L)\n         sage: G3x3.is_strongly_regular(parameters=True\n```\n\nYes, indeed, this is needed as more default packages are now loaded. Probably it makes sense to make #26856 dependence of this one.\n\nElse we should get the needed part of the branch of #26856 into here.\n\nI admit it's a workflow screwup on my side, primarily, as  #26856 does get rid of database_gap, everything related to it must be here now, by right...",
    "created_at": "2018-12-20T12:28:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423680",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:3'></a>
Oh, are we on the right ticket? Isn't this
[this change](https://git.sagemath.org/sage.git/diff/src/sage/graphs/generators/families.py?id=a7ef9e015984e48785b80d95ff422bcd3f6ae232&id2=9dde00f5835425953f42baa26c0eea04dbba765a) on #26856?

```
--- a/src/sage/graphs/generators/families.py
+++ b/src/sage/graphs/generators/families.py
@@ -3177,15 +3177,16 @@ def MathonPseudocyclicStronglyRegularGraph(t, G=None, L=None):
         sage: ff = list(map(lambda y: (y[0]-1,y[1]-1),
         ....:          Permutation(map(lambda x: 1+r.index(x^-1), r)).cycle_tuples()[1:]))
         sage: L = sum(i*(r[a]-r[b]) for i,(a,b) in zip(range(1,len(ff)+1), ff)); L
-        [ 0 -1  1 -2 -3 -4  2  4  3]
-        [ 1  0 -1 -4 -2 -3  3  2  4]
-        [-1  1  0 -3 -4 -2  4  3  2]
-        [ 2  4  3  0 -1  1 -2 -3 -4]
-        [ 3  2  4  1  0 -1 -4 -2 -3]
-        [ 4  3  2 -1  1  0 -3 -4 -2]
-        [-2 -3 -4  2  4  3  0 -1  1]
-        [-4 -2 -3  3  2  4  1  0 -1]
-        [-3 -4 -2  4  3  2 -1  1  0]
+        [ 0  1 -1 -3 -2 -4  3  4  2]
+        [-1  0  1 -4 -3 -2  2  3  4]
+        [ 1 -1  0 -2 -4 -3  4  2  3]
+        [ 3  4  2  0  1 -1 -3 -2 -4]
+        [ 2  3  4 -1  0  1 -4 -3 -2]
+        [ 4  2  3  1 -1  0 -2 -4 -3]
+        [-3 -2 -4  3  4  2  0  1 -1]
+        [-4 -3 -2  2  3  4 -1  0  1]
+        [-2 -4 -3  4  2  3  1 -1  0]
+
         sage: G.relabel()
         sage: G3x3=graphs.MathonPseudocyclicStronglyRegularGraph(2,G=G,L=L)
         sage: G3x3.is_strongly_regular(parameters=True
```

Yes, indeed, this is needed as more default packages are now loaded. Probably it makes sense to make #26856 dependence of this one.

Else we should get the needed part of the branch of #26856 into here.

I admit it's a workflow screwup on my side, primarily, as  #26856 does get rid of database_gap, everything related to it must be here now, by right...



---

archive/issue_comments_423681.json:
```json
{
    "body": "<a id='comment:4'></a>\nSpecifically, looking at the history of #26856, one would have to put here everything, except for changes in in `build/pkgs/gap_packages`",
    "created_at": "2018-12-20T12:38:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423681",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:4'></a>
Specifically, looking at the history of #26856, one would have to put here everything, except for changes in in `build/pkgs/gap_packages`



---

archive/issue_comments_423682.json:
```json
{
    "body": "<a id='comment:5'></a>\nOh, I think I see the problem then: On Linux I happened to be on a branch on to which I added your work from #26856.\n\nIf I switch back to the branch for this ticket, that test fails on Linux too.  Therefore I think that test fix should be moved to this ticket.",
    "created_at": "2018-12-20T12:39:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423682",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>
Oh, I think I see the problem then: On Linux I happened to be on a branch on to which I added your work from #26856.

If I switch back to the branch for this ticket, that test fails on Linux too.  Therefore I think that test fix should be moved to this ticket.



---

archive/issue_comments_423683.json:
```json
{
    "body": "**Changing status** from positive_review to needs_work.",
    "created_at": "2018-12-20T12:40:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423683",
    "user": "https://github.com/dimpase"
}
```

**Changing status** from positive_review to needs_work.



---

archive/issue_comments_423684.json:
```json
{
    "body": "<a id='comment:7'></a>\nIn #26856 you had already added the additional default packages.  I have now done that here, but didn't making the relevant adjustments for minor doctest failures.  I'll just cherry-pick the relevant commits from your branch over to here.",
    "created_at": "2018-12-20T12:44:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423684",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>
In #26856 you had already added the additional default packages.  I have now done that here, but didn't making the relevant adjustments for minor doctest failures.  I'll just cherry-pick the relevant commits from your branch over to here.



---

archive/issue_comments_423685.json:
```json
{
    "body": "<a id='comment:8'></a>\nI think you can just merge everything from #26856 and then rewrite everything in build/pkgs/gap_packages back to where is it was.\n\nMight be faster.",
    "created_at": "2018-12-20T12:50:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423685",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:8'></a>
I think you can just merge everything from #26856 and then rewrite everything in build/pkgs/gap_packages back to where is it was.

Might be faster.



---

archive/issue_comments_423686.json:
```json
{
    "body": "**Changing commit** from \"[53f07cc92ee670a7aa091eee1c056c488167ab13](https://github.com/sagemath/sagetrac-mirror/commit/53f07cc92ee670a7aa091eee1c056c488167ab13)\" to \"[b446ebb496d45c4408aa949f98f855f962d9388a](https://github.com/sagemath/sagetrac-mirror/commit/b446ebb496d45c4408aa949f98f855f962d9388a)\".",
    "created_at": "2018-12-20T13:02:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423686",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[53f07cc92ee670a7aa091eee1c056c488167ab13](https://github.com/sagemath/sagetrac-mirror/commit/53f07cc92ee670a7aa091eee1c056c488167ab13)" to "[b446ebb496d45c4408aa949f98f855f962d9388a](https://github.com/sagemath/sagetrac-mirror/commit/b446ebb496d45c4408aa949f98f855f962d9388a)".



---

archive/issue_comments_423687.json:
```json
{
    "body": "<a id='comment:9'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b446ebb496d45c4408aa949f98f855f962d9388a\">b446ebb</a></td><td><code>adjust doctests to accommodate more GAP methods</code></td></tr></table>\n",
    "created_at": "2018-12-20T13:02:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423687",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b446ebb496d45c4408aa949f98f855f962d9388a">b446ebb</a></td><td><code>adjust doctests to accommodate more GAP methods</code></td></tr></table>




---

archive/issue_comments_423688.json:
```json
{
    "body": "<a id='comment:0'></a>\nThis was the only commit from #26856 that I believe is truly necessary here.  With this, I confirmed that all the tests that were failing for me now pass on linux and cygwin.  Though I'm doing one last ptestlong just to double-check.\n\nDima, were there any other specific changes from the other ticket that you think would be appropriate to move here?  Otherwise you can set back to positive review, or double-check if you want.",
    "created_at": "2018-12-20T13:05:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423688",
    "user": "https://github.com/embray"
}
```

<a id='comment:0'></a>
This was the only commit from #26856 that I believe is truly necessary here.  With this, I confirmed that all the tests that were failing for me now pass on linux and cygwin.  Though I'm doing one last ptestlong just to double-check.

Dima, were there any other specific changes from the other ticket that you think would be appropriate to move here?  Otherwise you can set back to positive review, or double-check if you want.



---

archive/issue_comments_423689.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2018-12-20T13:05:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423689",
    "user": "https://github.com/embray"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_423690.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2018-12-20T13:20:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423690",
    "user": "https://github.com/dimpase"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_423691.json:
```json
{
    "body": "<a id='comment:1'></a>\nLooks good to me. As on this branch database_gap spkg and tags are still present, the latter make sure that lots of otherwise broken tests are skipped.",
    "created_at": "2018-12-20T13:20:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423691",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:1'></a>
Looks good to me. As on this branch database_gap spkg and tags are still present, the latter make sure that lots of otherwise broken tests are skipped.



---

archive/issue_comments_423692.json:
```json
{
    "body": "<a id='comment:452'></a>\nReplying to [embray](#comment%3A424):\n> Replying to [dimpase](#comment%3A420):\n> > Do I understand that having a GAP kernel module linked against libgap.so means that it would only work with libgap, but not with gap binary?\n> > \n> > If so, this work should really wait for another ticket.\n\n> \n> at least on Linux.  In theory it should work on Cygwin and macOS as well but I think that should be tested.\n> \n\nthis is continued on #26930 (OSX needs a bit more work)",
    "created_at": "2018-12-21T13:34:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423692",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:452'></a>
Replying to [embray](#comment%3A424):
> Replying to [dimpase](#comment%3A420):
> > Do I understand that having a GAP kernel module linked against libgap.so means that it would only work with libgap, but not with gap binary?
> > 
> > If so, this work should really wait for another ticket.

> 
> at least on Linux.  In theory it should work on Cygwin and macOS as well but I think that should be tested.
> 

this is continued on #26930 (OSX needs a bit more work)



---

archive/issue_comments_423693.json:
```json
{
    "body": "**Resolution:** fixed",
    "created_at": "2018-12-23T23:40:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423693",
    "user": "https://github.com/vbraun"
}
```

**Resolution:** fixed



---

archive/issue_comments_423694.json:
```json
{
    "body": "**Changing branch** from \"[u/embray/spkgs/gap-410](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/spkgs/gap-410)\" to \"[b446ebb496d45c4408aa949f98f855f962d9388a](https://github.com/sagemath/sagetrac-mirror/commit/b446ebb496d45c4408aa949f98f855f962d9388a)\".",
    "created_at": "2018-12-23T23:40:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423694",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/embray/spkgs/gap-410](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/spkgs/gap-410)" to "[b446ebb496d45c4408aa949f98f855f962d9388a](https://github.com/sagemath/sagetrac-mirror/commit/b446ebb496d45c4408aa949f98f855f962d9388a)".



---

archive/issue_events_067118.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-12-23T23:40:57Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22626#event-67118"
}
```



---

archive/issue_comments_423695.json:
```json
{
    "body": "**Changing commit** from \"[b446ebb496d45c4408aa949f98f855f962d9388a](https://github.com/sagemath/sagetrac-mirror/commit/b446ebb496d45c4408aa949f98f855f962d9388a)\" to \"\".",
    "created_at": "2018-12-28T11:13:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423695",
    "user": "https://github.com/embray"
}
```

**Changing commit** from "[b446ebb496d45c4408aa949f98f855f962d9388a](https://github.com/sagemath/sagetrac-mirror/commit/b446ebb496d45c4408aa949f98f855f962d9388a)" to "".



---

archive/issue_comments_423696.json:
```json
{
    "body": "<a id='comment:4'></a>\nSage-8.6 I guess.",
    "created_at": "2018-12-28T11:13:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423696",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>
Sage-8.6 I guess.



---

archive/issue_events_067119.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-12-28T11:13:32Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "milestone": "sage-8.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22626#event-67119"
}
```



---

archive/issue_events_067120.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-12-28T11:13:32Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "milestone": "sage-8.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22626#event-67120"
}
```



---

archive/issue_comments_423697.json:
```json
{
    "body": "<a id='comment:5'></a>\nI'm trying to package this and in the process updating gap to 4.10. I really wish gap had a workable `make install`.\n\ngap builds and tests fine. It works interactively. However when trying to use it through sage's pexepct interface, it hangs. Any idea what may be going wrong here?\n\n```\nsage: a = Gap(logfile = 'gap.log')\nsage: a.__dict__\n{'_Expect__command': 'gap -r -L /home/timo/.sage/gap/gap-workspace-0x25243fbcd256d4e0 -b -p -T -E -o 622m -s 622m -m 64m  /nix/store/gh48l47qc1irys2xpbwf56g2lwa96pcs-sage-src-8.6.beta0/src/ext/gap/sage.g',\n '_Expect__do_cleaner': True,\n '_Expect__init_code': [],\n '_Expect__initialized': False,\n '_Expect__is_remote': False,\n '_Expect__logfile': None,\n '_Expect__logfilename': 'gap.log',\n '_Expect__path': '/home/timo/repos/nixpkgs/sage-8.6',\n '_Expect__remote_cleaner': False,\n '_Expect__seq': -1,\n '_Expect__verbose_start': False,\n '_Gap__make_workspace': False,\n '_Gap__seq': 0,\n '_Gap__use_workspace_cache': True,\n '_Interface__coerce_name': '_gap_',\n '_Interface__name': 'gap',\n '_Interface__seq': -1,\n '_available_vars': [],\n '_env': {},\n '_eval_using_file_cutoff': 100,\n '_expect': None,\n '_prompt': 'gap> ',\n '_restart_on_ctrlc': True,\n '_seed': None,\n '_server': None,\n '_session_number': 0,\n '_terminal_echo': True}\nsage: a('42;') # hangs and doesn't produce a gap.log file\n```\n\nMeanwhile executing the `_Expect_command` manually (through `sage -gap`, without `-p` and without `-L`) works as expected.",
    "created_at": "2018-12-29T19:06:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423697",
    "user": "https://github.com/timokau"
}
```

<a id='comment:5'></a>
I'm trying to package this and in the process updating gap to 4.10. I really wish gap had a workable `make install`.

gap builds and tests fine. It works interactively. However when trying to use it through sage's pexepct interface, it hangs. Any idea what may be going wrong here?

```
sage: a = Gap(logfile = 'gap.log')
sage: a.__dict__
{'_Expect__command': 'gap -r -L /home/timo/.sage/gap/gap-workspace-0x25243fbcd256d4e0 -b -p -T -E -o 622m -s 622m -m 64m  /nix/store/gh48l47qc1irys2xpbwf56g2lwa96pcs-sage-src-8.6.beta0/src/ext/gap/sage.g',
 '_Expect__do_cleaner': True,
 '_Expect__init_code': [],
 '_Expect__initialized': False,
 '_Expect__is_remote': False,
 '_Expect__logfile': None,
 '_Expect__logfilename': 'gap.log',
 '_Expect__path': '/home/timo/repos/nixpkgs/sage-8.6',
 '_Expect__remote_cleaner': False,
 '_Expect__seq': -1,
 '_Expect__verbose_start': False,
 '_Gap__make_workspace': False,
 '_Gap__seq': 0,
 '_Gap__use_workspace_cache': True,
 '_Interface__coerce_name': '_gap_',
 '_Interface__name': 'gap',
 '_Interface__seq': -1,
 '_available_vars': [],
 '_env': {},
 '_eval_using_file_cutoff': 100,
 '_expect': None,
 '_prompt': 'gap> ',
 '_restart_on_ctrlc': True,
 '_seed': None,
 '_server': None,
 '_session_number': 0,
 '_terminal_echo': True}
sage: a('42;') # hangs and doesn't produce a gap.log file
```

Meanwhile executing the `_Expect_command` manually (through `sage -gap`, without `-p` and without `-L`) works as expected.



---

archive/issue_comments_423698.json:
```json
{
    "body": "<a id='comment:6'></a>\nthis works for me. Check out you don\u2019t have stale GAP workspaces lying around in ~/.sage/gap/",
    "created_at": "2018-12-30T01:46:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423698",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:6'></a>
this works for me. Check out you don‚Äôt have stale GAP workspaces lying around in ~/.sage/gap/



---

archive/issue_comments_423699.json:
```json
{
    "body": "<a id='comment:7'></a>\nYes its almost certainly not an error with this ticket but some packaging error or some assumption that isn't valid for NixOS. I'm just asking here because I thought you or Erik may have thoughts on possible causes.\n\nRemoving all files in `~/.sage/gap` (or just disabling workspaces) doesn't help unfortunately.",
    "created_at": "2018-12-30T08:36:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423699",
    "user": "https://github.com/timokau"
}
```

<a id='comment:7'></a>
Yes its almost certainly not an error with this ticket but some packaging error or some assumption that isn't valid for NixOS. I'm just asking here because I thought you or Erik may have thoughts on possible causes.

Removing all files in `~/.sage/gap` (or just disabling workspaces) doesn't help unfortunately.



---

archive/issue_comments_423700.json:
```json
{
    "body": "<a id='comment:8'></a>\nThe main reason I know the pexpect interface can hang is if the xgap package is loaded.  Search the discussion above for \"xgap\".  This is *supposed* to be fixed by [8228bace](https://github.com/sagemath/sagetrac-mirror/commit/8228bace651aa07f71baca218d89b8d83e72a9a0) to ensure that the xgap package is not autoloaded.  You'll want to check whether that fix is working as intended though.\n\nIt might also help to patch the pexpect interface to not hang in this case, but that's more complicated because it has to \"talk\" to the GAP interpreter as though it were correctly emulating a graphical interface.  Better to just make sure xgap isn't loaded.",
    "created_at": "2018-12-31T12:04:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423700",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>
The main reason I know the pexpect interface can hang is if the xgap package is loaded.  Search the discussion above for "xgap".  This is *supposed* to be fixed by [8228bace](https://github.com/sagemath/sagetrac-mirror/commit/8228bace651aa07f71baca218d89b8d83e72a9a0) to ensure that the xgap package is not autoloaded.  You'll want to check whether that fix is working as intended though.

It might also help to patch the pexpect interface to not hang in this case, but that's more complicated because it has to "talk" to the GAP interpreter as though it were correctly emulating a graphical interface.  Better to just make sure xgap isn't loaded.



---

archive/issue_comments_423701.json:
```json
{
    "body": "<a id='comment:9'></a>\nThat does seem to be the problem, thanks! If I add `rm -rf pkg/xgap*` to the gap build recipe, the pexpect interface works. So the fix in \u200b8228bace apparently does work as intended. Any idea why?",
    "created_at": "2018-12-31T12:50:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423701",
    "user": "https://github.com/timokau"
}
```

<a id='comment:9'></a>
That does seem to be the problem, thanks! If I add `rm -rf pkg/xgap*` to the gap build recipe, the pexpect interface works. So the fix in ‚Äã8228bace apparently does work as intended. Any idea why?



---

archive/issue_comments_423702.json:
```json
{
    "body": "<a id='comment:0'></a>\nI assume you mean does *not* work as intended.  As for why/why not you'll have to debug that yourself I suppose.  It works for me.  It could be that you have some other auto-loaded package that also loads the xgap package unconditionally.  Most packages that use the xgap package at least check to ensure that the `-p` flag was passed to GAP before attempting to load it.  It's possible something more forceful is needed to prevent ever loading the xgap package at all (perhaps, if there's some way to disable it completely).",
    "created_at": "2018-12-31T12:55:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423702",
    "user": "https://github.com/embray"
}
```

<a id='comment:0'></a>
I assume you mean does *not* work as intended.  As for why/why not you'll have to debug that yourself I suppose.  It works for me.  It could be that you have some other auto-loaded package that also loads the xgap package unconditionally.  Most packages that use the xgap package at least check to ensure that the `-p` flag was passed to GAP before attempting to load it.  It's possible something more forceful is needed to prevent ever loading the xgap package at all (perhaps, if there's some way to disable it completely).



---

archive/issue_comments_423703.json:
```json
{
    "body": "<a id='comment:1'></a>\nIt looke like `PackagesToIgnore`, which just pretends the package doesn't exist, is more robust than `ExcludeFromAutoload`.\n\nI am able to workaround the issue by creating a `~/.gap/gap.ini` file (which for some reason is not actually an ini file) with the contents\n\n```\nSetUserPreference( \"PackagesToIgnore\", [ \"xgap\" ] );\n```\n\nAnd monkey-patching away the `-r` flag passed to sage:\n\n```\nrm -rf ~/.sage/gap; result/bin/sage -c 'import sage.interfaces.gap as g; g.gap_cmd = \"gap\"; Gap()(42)'\n```\n\nThat terminates. I wasn't able to do the same with `sage.g` however -- maybe it is just loaded too late? I tried using `SetUserPreference` as well as `GAPInfo.PackagesToIgnore`.\n\nMaybe we could make use of the `--roots` argument to provide a `gap.ini` file?",
    "created_at": "2018-12-31T15:17:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423703",
    "user": "https://github.com/timokau"
}
```

<a id='comment:1'></a>
It looke like `PackagesToIgnore`, which just pretends the package doesn't exist, is more robust than `ExcludeFromAutoload`.

I am able to workaround the issue by creating a `~/.gap/gap.ini` file (which for some reason is not actually an ini file) with the contents

```
SetUserPreference( "PackagesToIgnore", [ "xgap" ] );
```

And monkey-patching away the `-r` flag passed to sage:

```
rm -rf ~/.sage/gap; result/bin/sage -c 'import sage.interfaces.gap as g; g.gap_cmd = "gap"; Gap()(42)'
```

That terminates. I wasn't able to do the same with `sage.g` however -- maybe it is just loaded too late? I tried using `SetUserPreference` as well as `GAPInfo.PackagesToIgnore`.

Maybe we could make use of the `--roots` argument to provide a `gap.ini` file?



---

archive/issue_comments_423704.json:
```json
{
    "body": "<a id='comment:2'></a>\nThe problem with `SetUserPreference` is that it's applied too early.  That's why I didn't use it in `sage.g`.  Instead you can do like I did and assign directly to the value that is set via the `SetUserPreference` call.  In this case I'm not sure exactly which that is; I'd have to check.  Please open a new ticket for this and CC me on it.",
    "created_at": "2018-12-31T16:23:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423704",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>
The problem with `SetUserPreference` is that it's applied too early.  That's why I didn't use it in `sage.g`.  Instead you can do like I did and assign directly to the value that is set via the `SetUserPreference` call.  In this case I'm not sure exactly which that is; I'd have to check.  Please open a new ticket for this and CC me on it.



---

archive/issue_comments_423705.json:
```json
{
    "body": "<a id='comment:3'></a>\n#26983\n\nI naively tried `GAPInfo.PackagesToIgnore`, but that didn't work. A quick grep through the gap source only shows it being accessed through `UserPreference(\"PackagesToIgnore\")`. I don't know enough about gap to do anything useful with that.",
    "created_at": "2018-12-31T16:36:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423705",
    "user": "https://github.com/timokau"
}
```

<a id='comment:3'></a>
#26983

I naively tried `GAPInfo.PackagesToIgnore`, but that didn't work. A quick grep through the gap source only shows it being accessed through `UserPreference("PackagesToIgnore")`. I don't know enough about gap to do anything useful with that.



---

archive/issue_comments_423706.json:
```json
{
    "body": "<a id='comment:4'></a>\nIt seems that the new libgap cause some doctests failure with some patchbots. \nSomehow the gap doc is not displayed using unicode characters..\n\nSee for example:\n\nhttps://patchbot.sagemath.org/log/26917/LinuxMint/18.2/x86_64/4.4.0-138-generic/rk02-math/2018-12-30%2007:36:36",
    "created_at": "2018-12-31T16:38:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423706",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:4'></a>
It seems that the new libgap cause some doctests failure with some patchbots. 
Somehow the gap doc is not displayed using unicode characters..

See for example:

https://patchbot.sagemath.org/log/26917/LinuxMint/18.2/x86_64/4.4.0-138-generic/rk02-math/2018-12-30%2007:36:36



---

archive/issue_comments_423707.json:
```json
{
    "body": "<a id='comment:465'></a>\nReplying to [chapoton](#comment%3A464):\n> It seems that the new libgap cause some doctests failure with some patchbots. \n> Somehow the gap doc is not displayed using unicode characters..\n> \n> See for example:\n> \n> https://patchbot.sagemath.org/log/26917/LinuxMint/18.2/x86_64/4.4.0-138-generic/rk02-math/2018-12-30%2007:36:36\n\n\nall these should be fixed by rc1 (out today).",
    "created_at": "2019-01-01T14:15:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423707",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:465'></a>
Replying to [chapoton](#comment%3A464):
> It seems that the new libgap cause some doctests failure with some patchbots. 
> Somehow the gap doc is not displayed using unicode characters..
> 
> See for example:
> 
> https://patchbot.sagemath.org/log/26917/LinuxMint/18.2/x86_64/4.4.0-138-generic/rk02-math/2018-12-30%2007:36:36


all these should be fixed by rc1 (out today).



---

archive/issue_comments_423708.json:
```json
{
    "body": "<a id='comment:6'></a>\nThis is not fixed in 8.6.beta1. See #26987",
    "created_at": "2019-01-01T17:05:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423708",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:6'></a>
This is not fixed in 8.6.beta1. See #26987



---

archive/issue_comments_423709.json:
```json
{
    "body": "<a id='comment:7'></a>\nI need to revert https://git.sagemath.org/sage.git/patch/?id=b446ebb496d45c4408aa949f98f855f962d9388a to pass the doctests, even though I'm using gap 4.10. Any idea why that output should have changed? Should we maybe just sort it?",
    "created_at": "2019-01-02T21:32:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423709",
    "user": "https://github.com/timokau"
}
```

<a id='comment:7'></a>
I need to revert https://git.sagemath.org/sage.git/patch/?id=b446ebb496d45c4408aa949f98f855f962d9388a to pass the doctests, even though I'm using gap 4.10. Any idea why that output should have changed? Should we maybe just sort it?



---

archive/issue_comments_423710.json:
```json
{
    "body": "<a id='comment:468'></a>\nReplying to [gh-timokau](#comment%3A467):\n> I need to revert https://git.sagemath.org/sage.git/patch/?id=b446ebb496d45c4408aa949f98f855f962d9388a to pass the doctests, even though I'm using gap 4.10. Any idea why that output should have changed? Should we maybe just sort it?\n\n\nI noticed this too (have to revert the commit) in Debian.",
    "created_at": "2019-01-02T21:34:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423710",
    "user": "https://github.com/tobihan"
}
```

<a id='comment:468'></a>
Replying to [gh-timokau](#comment%3A467):
> I need to revert https://git.sagemath.org/sage.git/patch/?id=b446ebb496d45c4408aa949f98f855f962d9388a to pass the doctests, even though I'm using gap 4.10. Any idea why that output should have changed? Should we maybe just sort it?


I noticed this too (have to revert the commit) in Debian.



---

archive/issue_comments_423711.json:
```json
{
    "body": "<a id='comment:9'></a>\nHm I still had a patch lying around that applied `-A` to gap. Without that and with the exact same package set the spkg uses I do get the behaviour introduced in the patch. So it is changed by one of the autoloaded packages. Still probably best to just sort the output.",
    "created_at": "2019-01-02T22:50:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423711",
    "user": "https://github.com/timokau"
}
```

<a id='comment:9'></a>
Hm I still had a patch lying around that applied `-A` to gap. Without that and with the exact same package set the spkg uses I do get the behaviour introduced in the patch. So it is changed by one of the autoloaded packages. Still probably best to just sort the output.



---

archive/issue_comments_423712.json:
```json
{
    "body": "<a id='comment:0'></a>\nAnother weird \"issue\" (with sage-on-nix with the package set from the spkg): I get one more blankline at the start of docs than sage expects. \n\n```\nFailed example:\n    print(gap.help('SymmetricGroup', pager=False))\nExpected:\n    <BLANKLINE>\n      50.1-... SymmetricGroup\n    <BLANKLINE>\n      \u2023 SymmetricGroup( [filt, ]deg ) \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 function\n    ...\n    <BLANKLINE>\nGot:\n    <BLANKLINE>\n    <BLANKLINE>\n      50.1-10 SymmetricGroup\n    <BLANKLINE>\n      > SymmetricGroup( [filt, ]deg ) ----------------------------------- function\n      > SymmetricGroup( [filt, ]dom ) ----------------------------------- function\n    <BLANKLINE>\n      constructs  the  symmetric  group of degree deg in the category given by the\n      filter  filt.  If filt is not given it defaults to IsPermGroup (43.1-1). For\n      more  information  on  possible  values  of  filt see section (50.1). In the\n      second  version,  the  function constructs the symmetric group on the points\n      given in the set dom which must be a set of positive integers.\n    <BLANKLINE>\n```",
    "created_at": "2019-01-03T15:12:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423712",
    "user": "https://github.com/timokau"
}
```

<a id='comment:0'></a>
Another weird "issue" (with sage-on-nix with the package set from the spkg): I get one more blankline at the start of docs than sage expects. 

```
Failed example:
    print(gap.help('SymmetricGroup', pager=False))
Expected:
    <BLANKLINE>
      50.1-... SymmetricGroup
    <BLANKLINE>
      ‚Ä£ SymmetricGroup( [filt, ]deg ) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ function
    ...
    <BLANKLINE>
Got:
    <BLANKLINE>
    <BLANKLINE>
      50.1-10 SymmetricGroup
    <BLANKLINE>
      > SymmetricGroup( [filt, ]deg ) ----------------------------------- function
      > SymmetricGroup( [filt, ]dom ) ----------------------------------- function
    <BLANKLINE>
      constructs  the  symmetric  group of degree deg in the category given by the
      filter  filt.  If filt is not given it defaults to IsPermGroup (43.1-1). For
      more  information  on  possible  values  of  filt see section (50.1). In the
      second  version,  the  function constructs the symmetric group on the points
      given in the set dom which must be a set of positive integers.
    <BLANKLINE>
```



---

archive/issue_comments_423713.json:
```json
{
    "body": "<a id='comment:1'></a>\nThis ticket is closed so please make new tickets for follow-up issues.",
    "created_at": "2019-01-03T17:44:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22626#issuecomment-423713",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>
This ticket is closed so please make new tickets for follow-up issues.
