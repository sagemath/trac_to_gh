# Issue 22441: Don't fail matplotlib related doctests if DISPLAY is unset

archive/issues_022204.json:
```json
{
    "body": "Debian (and I'm sure other distros)'s autobuilders run with unset DISPLAY, and the tests fail without this patch.\n\n\n**Branch:** [u/infinity0/don_t_fail_plot_py_doctest_if_display_is_unset](https://github.com/sagemath/sagetrac-mirror/tree/u/infinity0/don_t_fail_plot_py_doctest_if_display_is_unset)\n\n**Commit:** [a017372779acf8813c9814f9a051aca25b06391f](https://github.com/sagemath/sagetrac-mirror/commit/a017372779acf8813c9814f9a051aca25b06391f)\n\n**Reviewer:** Fran\u00e7ois Bissey\n\n**Author:** Ximin Luo\n\nIssue created by migration from https://trac.sagemath.org/ticket/22441\n\n",
    "closed_at": "2018-05-18T17:16:26Z",
    "created_at": "2017-02-25T15:24:29Z",
    "labels": [
        "component: interfaces",
        "bug",
        "wontfix"
    ],
    "title": "Don't fail matplotlib related doctests if DISPLAY is unset",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/22441",
    "user": "https://github.com/infinity0"
}
```
Debian (and I'm sure other distros)'s autobuilders run with unset DISPLAY, and the tests fail without this patch.


**Branch:** [u/infinity0/don_t_fail_plot_py_doctest_if_display_is_unset](https://github.com/sagemath/sagetrac-mirror/tree/u/infinity0/don_t_fail_plot_py_doctest_if_display_is_unset)

**Commit:** [a017372779acf8813c9814f9a051aca25b06391f](https://github.com/sagemath/sagetrac-mirror/commit/a017372779acf8813c9814f9a051aca25b06391f)

**Reviewer:** François Bissey

**Author:** Ximin Luo

Issue created by migration from https://trac.sagemath.org/ticket/22441





---

archive/issue_comments_334606.json:
```json
{
    "body": "**Branch:** [u/infinity0/don_t_fail_plot_py_doctest_if_display_is_unset](https://github.com/sagemath/sagetrac-mirror/tree/u/infinity0/don_t_fail_plot_py_doctest_if_display_is_unset)",
    "created_at": "2017-02-25T15:26:24Z",
    "issue": "https://github.com/sagemath/sage/issues/22441",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22441#issuecomment-334606",
    "user": "https://github.com/infinity0"
}
```

**Branch:** [u/infinity0/don_t_fail_plot_py_doctest_if_display_is_unset](https://github.com/sagemath/sagetrac-mirror/tree/u/infinity0/don_t_fail_plot_py_doctest_if_display_is_unset)



---

archive/issue_comments_334607.json:
```json
{
    "body": "**Commit:** [a017372779acf8813c9814f9a051aca25b06391f](https://github.com/sagemath/sagetrac-mirror/commit/a017372779acf8813c9814f9a051aca25b06391f)",
    "created_at": "2017-02-25T15:28:06Z",
    "issue": "https://github.com/sagemath/sage/issues/22441",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22441#issuecomment-334607",
    "user": "https://github.com/infinity0"
}
```

**Commit:** [a017372779acf8813c9814f9a051aca25b06391f](https://github.com/sagemath/sagetrac-mirror/commit/a017372779acf8813c9814f9a051aca25b06391f)



---

archive/issue_comments_334608.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1 +1,2 @@\n+Debian (and I'm sure other distros)'s autobuilders run with unset DISPLAY, and the tests fail without this patch.\n \n``````\n",
    "created_at": "2017-02-25T15:28:06Z",
    "issue": "https://github.com/sagemath/sage/issues/22441",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22441#issuecomment-334608",
    "user": "https://github.com/infinity0"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1 +1,2 @@
+Debian (and I'm sure other distros)'s autobuilders run with unset DISPLAY, and the tests fail without this patch.
 
``````




---

archive/issue_events_200319.json:
```json
{
    "actor": "https://github.com/infinity0",
    "created_at": "2017-02-25T15:28:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22441",
    "label": "bug",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22441#event-200319"
}
```



---

archive/issue_events_200320.json:
```json
{
    "actor": "https://github.com/infinity0",
    "created_at": "2017-02-25T15:28:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22441",
    "label": "component: interfaces",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22441#event-200320"
}
```



---

archive/issue_events_200321.json:
```json
{
    "actor": "https://github.com/infinity0",
    "created_at": "2017-02-25T15:28:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22441",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22441#event-200321"
}
```



---

archive/issue_comments_334609.json:
```json
{
    "body": "**Author:** Ximin Luo",
    "created_at": "2017-02-25T15:28:06Z",
    "issue": "https://github.com/sagemath/sage/issues/22441",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22441#issuecomment-334609",
    "user": "https://github.com/infinity0"
}
```

**Author:** Ximin Luo



---

archive/issue_comments_334610.json:
```json
{
    "body": "<a id='comment:2'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a017372779acf8813c9814f9a051aca25b06391f\">a017372</a></td><td><code>Don't fail matplotlib related doctests if DISPLAY is unset</code></td></tr></table>\n",
    "created_at": "2017-02-25T15:28:06Z",
    "issue": "https://github.com/sagemath/sage/issues/22441",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22441#issuecomment-334610",
    "user": "https://github.com/infinity0"
}
```

<a id='comment:2'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a017372779acf8813c9814f9a051aca25b06391f">a017372</a></td><td><code>Don't fail matplotlib related doctests if DISPLAY is unset</code></td></tr></table>




---

archive/issue_events_200322.json:
```json
{
    "actor": "https://github.com/infinity0",
    "created_at": "2017-02-25T15:28:23Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/22441",
    "rename": {
        "from": "Don't fail plot.py doctest if DISPLAY is unset",
        "to": "Don't fail matplotlib related doctests if DISPLAY is unset"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22441#event-200322"
}
```



---

archive/issue_comments_334611.json:
```json
{
    "body": "<a id='comment:4'></a>\nI found weird that this modification has to be done only in two places... there are plots everywhere in the doctests! Why is that? Wouldn't it be better to set it automatically by the doctest engine?",
    "created_at": "2017-02-25T17:40:26Z",
    "issue": "https://github.com/sagemath/sage/issues/22441",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22441#issuecomment-334611",
    "user": "https://github.com/videlec"
}
```

<a id='comment:4'></a>
I found weird that this modification has to be done only in two places... there are plots everywhere in the doctests! Why is that? Wouldn't it be better to set it automatically by the doctest engine?



---

archive/issue_comments_334612.json:
```json
{
    "body": "<a id='comment:5'></a>\nDebian is on matplotlib v2 and Sage is still using v1.5 (see [our status page](https://people.debian.org/~thansen/debian-sage-7.4-status.html)).\n\nI did initially also add it into other places, but only these two were needed in the end to fix the test failures. Perhaps it runs the other plots after running these tests, so the \"good\" settings have already been set by then?\n\nAgreed that this is best done in the main code itself; probably not even in the doctest engine, but the Sage-matplotlib interface. I'm not certain where would be the best place though, I'm not familiar with the code.",
    "created_at": "2017-02-25T18:22:56Z",
    "issue": "https://github.com/sagemath/sage/issues/22441",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22441#issuecomment-334612",
    "user": "https://github.com/infinity0"
}
```

<a id='comment:5'></a>
Debian is on matplotlib v2 and Sage is still using v1.5 (see [our status page](https://people.debian.org/~thansen/debian-sage-7.4-status.html)).

I did initially also add it into other places, but only these two were needed in the end to fix the test failures. Perhaps it runs the other plots after running these tests, so the "good" settings have already been set by then?

Agreed that this is best done in the main code itself; probably not even in the doctest engine, but the Sage-matplotlib interface. I'm not certain where would be the best place though, I'm not familiar with the code.



---

archive/issue_comments_334613.json:
```json
{
    "body": "<a id='comment:6'></a>\nIt might be cleaner to patch matplotlib itself, I've filed [a ticket](https://github.com/matplotlib/matplotlib/issues/8147) on their side too.",
    "created_at": "2017-02-25T19:14:26Z",
    "issue": "https://github.com/sagemath/sage/issues/22441",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22441#issuecomment-334613",
    "user": "https://github.com/infinity0"
}
```

<a id='comment:6'></a>
It might be cleaner to patch matplotlib itself, I've filed [a ticket](https://github.com/matplotlib/matplotlib/issues/8147) on their side too.



---

archive/issue_events_200323.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-02-25T19:54:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/22441",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22441#event-200323"
}
```



---

archive/issue_events_200324.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-02-25T19:54:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22441",
    "label": "needs info",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22441#event-200324"
}
```



---

archive/issue_comments_334614.json:
```json
{
    "body": "<a id='comment:7'></a>\nI cannot reproduce this problem. I'm sure that many bots run Sage with `DISPLAY` unset, so there must be something more going on...",
    "created_at": "2017-02-25T19:54:06Z",
    "issue": "https://github.com/sagemath/sage/issues/22441",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22441#issuecomment-334614",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>
I cannot reproduce this problem. I'm sure that many bots run Sage with `DISPLAY` unset, so there must be something more going on...



---

archive/issue_comments_334615.json:
```json
{
    "body": "<a id='comment:8'></a>\nLooks like upstream rejected my suggestion. I can't reproduce this now on my main computer either, but I'll try it again in Debian's build-in-a-chroot program later.\n\n`env -i PATH=/usr/bin:/bin HOME=$HOME sage -c 'plot(x^2, (x,0,5))'`\n\nThey did point me to the `MPLBACKEND` envvar so perhaps Sage's doctesting framework can set this envvar, assuming the \"real cause\" isn't something else.",
    "created_at": "2017-02-25T22:10:16Z",
    "issue": "https://github.com/sagemath/sage/issues/22441",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22441#issuecomment-334615",
    "user": "https://github.com/infinity0"
}
```

<a id='comment:8'></a>
Looks like upstream rejected my suggestion. I can't reproduce this now on my main computer either, but I'll try it again in Debian's build-in-a-chroot program later.

`env -i PATH=/usr/bin:/bin HOME=$HOME sage -c 'plot(x^2, (x,0,5))'`

They did point me to the `MPLBACKEND` envvar so perhaps Sage's doctesting framework can set this envvar, assuming the "real cause" isn't something else.



---

archive/issue_comments_334616.json:
```json
{
    "body": "<a id='comment:9'></a>\nAny further news? Can this be reproduced in vanilla Sage?",
    "created_at": "2017-06-26T11:39:41Z",
    "issue": "https://github.com/sagemath/sage/issues/22441",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22441#issuecomment-334616",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>
Any further news? Can this be reproduced in vanilla Sage?



---

archive/issue_comments_334617.json:
```json
{
    "body": "<a id='comment:10'></a>\nsee #23696 for matplotlib update",
    "created_at": "2017-08-26T19:27:09Z",
    "issue": "https://github.com/sagemath/sage/issues/22441",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22441#issuecomment-334617",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:10'></a>
see #23696 for matplotlib update



---

archive/issue_comments_334618.json:
```json
{
    "body": "<a id='comment:11'></a>\nIt appears that #23696 fixed this:\n\n```\n+# Make sure the agg backend is selected during doctesting\n+# This needs to be done before any other matplotlib calls.\n+import matplotlib\n+matplotlib.use('agg')\n```\nSo, can this be closed now?",
    "created_at": "2018-03-24T03:09:14Z",
    "issue": "https://github.com/sagemath/sage/issues/22441",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22441#issuecomment-334618",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:11'></a>
It appears that #23696 fixed this:

```
+# Make sure the agg backend is selected during doctesting
+# This needs to be done before any other matplotlib calls.
+import matplotlib
+matplotlib.use('agg')
```
So, can this be closed now?



---

archive/issue_events_200325.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-03-24T03:09:14Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/22441",
    "milestone": "sage-7.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22441#event-200325"
}
```



---

archive/issue_events_200326.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-03-24T03:09:14Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/22441",
    "label": "needs info",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22441#event-200326"
}
```



---

archive/issue_events_200327.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-03-24T03:09:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22441",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22441#event-200327"
}
```



---

archive/issue_events_200328.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2018-03-24T09:10:24Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/22441",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22441#event-200328"
}
```



---

archive/issue_events_200329.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2018-03-24T09:10:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22441",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22441#event-200329"
}
```



---

archive/issue_comments_334619.json:
```json
{
    "body": "<a id='comment:12'></a>\nYes, I didn't know there was a matching ticket to the debian patch. But this was definitely part of my target in #23696.",
    "created_at": "2018-03-24T09:10:24Z",
    "issue": "https://github.com/sagemath/sage/issues/22441",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22441#issuecomment-334619",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:12'></a>
Yes, I didn't know there was a matching ticket to the debian patch. But this was definitely part of my target in #23696.



---

archive/issue_comments_334620.json:
```json
{
    "body": "**Reviewer:** Fran\u00e7ois Bissey",
    "created_at": "2018-03-24T09:10:24Z",
    "issue": "https://github.com/sagemath/sage/issues/22441",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22441#issuecomment-334620",
    "user": "https://github.com/kiwifb"
}
```

**Reviewer:** François Bissey



---

archive/issue_events_200330.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-05-18T17:16:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22441",
    "label": "wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22441#event-200330"
}
```



---

archive/issue_events_200331.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-05-18T17:16:26Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/22441",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22441#event-200331"
}
```



---

archive/issue_events_200332.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-05-18T17:16:26Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/22441",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22441#event-200332"
}
```



---

archive/issue_comments_334621.json:
```json
{
    "body": "<a id='comment:13'></a>\nclosing positively reviewed duplicates",
    "created_at": "2018-05-18T17:16:26Z",
    "issue": "https://github.com/sagemath/sage/issues/22441",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22441#issuecomment-334621",
    "user": "https://github.com/videlec"
}
```

<a id='comment:13'></a>
closing positively reviewed duplicates
