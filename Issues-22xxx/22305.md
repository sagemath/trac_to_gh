# Issue 22305: weak_dict.pyx is not python3 compatible

archive/issues_022068.json:
```json
{
    "assignees": [],
    "body": "The structure of `PyDictObject` used by `weak_dict` changed from Python 2 to Python 3, e.g `PyDictEntry` has been removed\n\nREF:\n\n* https://docs.python.org/2/c-api/dict.html\n* https://docs.python.org/3/c-api/dict.html\n\nDepends on #22942\n\nCC:  @jdemeyer @fchapoton\n\nBranch: **[`54d8c2d`](https://github.com/sagemath/sagetrac-mirror/commit/54d8c2da8ad19e610fe9939b90bc23202c5b5525)**\n\nReviewer: **Fr\u00e9d\u00e9ric Chapoton**\n\nAuthor: **Nils Bruin**\n\nComponent: **python3**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/22305_\n\n",
    "closed_at": "2017-05-20T20:07:52Z",
    "created_at": "2017-02-05T11:16:35Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20python3",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.0",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "weak_dict.pyx is not python3 compatible",
    "type": "issue",
    "updated_at": "2017-09-22T16:12:20Z",
    "url": "https://github.com/sagemath/sage/issues/22305",
    "user": "https://github.com/a-andre"
}
```
The structure of `PyDictObject` used by `weak_dict` changed from Python 2 to Python 3, e.g `PyDictEntry` has been removed

REF:

* https://docs.python.org/2/c-api/dict.html
* https://docs.python.org/3/c-api/dict.html

Depends on #22942

CC:  @jdemeyer @fchapoton

Branch: **[`54d8c2d`](https://github.com/sagemath/sagetrac-mirror/commit/54d8c2da8ad19e610fe9939b90bc23202c5b5525)**

Reviewer: **Frédéric Chapoton**

Author: **Nils Bruin**

Component: **python3**

_Issue created by migration from https://trac.sagemath.org/ticket/22305_





---

archive/issue_events_313535.json:
```json
{
    "actor": "https://github.com/a-andre",
    "created_at": "2017-02-05T11:16:35Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "milestone_number": null,
    "milestone_title": "sage-7.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22305#event-313535"
}
```



---

archive/issue_events_313536.json:
```json
{
    "actor": "https://github.com/a-andre",
    "created_at": "2017-02-05T11:16:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20python3",
    "label_color": "000080",
    "label_name": "c: python3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22305#event-313536"
}
```



---

archive/issue_events_313537.json:
```json
{
    "actor": "https://github.com/a-andre",
    "created_at": "2017-02-05T11:16:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22305#event-313537"
}
```



---

archive/issue_comments_329630.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nThe change is significant. CPython3 still uses the same underlying logic, so that should still work, but it looks like it will be difficult to support both Py2 and Py3 with the same source. Do we have conditional compilation flags in cython for such cases? I imagine the transition is smoothest if we can ensure that we can support Py2 and Py3 from a single source, at least for a while.\n\nIf I recall correctly: `PyDict_GetItemWithError` is available in Py3.\n\nFor the rest, it should just be `del_dictitem_by_exact_value` that needs rewriting to account for the renaming of certain structures and, most importantly, dealing with split tables (which is new) as well as combined tables (which are basically the old dict lay-out).\n\nIt may be worth checking if the special trick used to participate in the Python Trashcan is still necessary with Py3.\n\nIteration protection has changed in Py3 as well a bit, so perhaps we don't quite need the protection we're enforcing in deletion anymore.\n\nI think presently the \"contains\" test also reaches into the internal structure. However, \"contains\" doesn't really produce verifiable results on a WeakValueDict anyway, because the member can always disappear between the containment test and retrieval, so we could not override that routine (in the same way that \"len\" is not overridden).\n\nFor me the main issues that prevent me from fixing this issue are that I don't have access to a platform where I can compile cython against python 3 and that I don't know how to make cython source compile conditionally wrt. Py2 vs. Py3. It's probably easier if someone who does know how to deal with those things makes the necessary adjustments. It's not rocket science, but you do have to carefully read dictobject.c\n\nIf we could somehow link to [delitem_common](https://github.com/python/cpython/blob/master/Objects/dictobject.c#L1587) the deletion would almost be taken care of. I'm afraid that's not an exported symbol, though, so we basically have to replicate it.\n\nAlso, perhaps we should always force the WeakValueDict to be \"combined\" (the old-style layout), because split tables don't allow deletion, and triggering reshaping of the dictionary in a weakref callback is probably not a good idea.",
    "created_at": "2017-02-05T17:57:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329630",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:1" align="right">comment:1</div>

The change is significant. CPython3 still uses the same underlying logic, so that should still work, but it looks like it will be difficult to support both Py2 and Py3 with the same source. Do we have conditional compilation flags in cython for such cases? I imagine the transition is smoothest if we can ensure that we can support Py2 and Py3 from a single source, at least for a while.

If I recall correctly: `PyDict_GetItemWithError` is available in Py3.

For the rest, it should just be `del_dictitem_by_exact_value` that needs rewriting to account for the renaming of certain structures and, most importantly, dealing with split tables (which is new) as well as combined tables (which are basically the old dict lay-out).

It may be worth checking if the special trick used to participate in the Python Trashcan is still necessary with Py3.

Iteration protection has changed in Py3 as well a bit, so perhaps we don't quite need the protection we're enforcing in deletion anymore.

I think presently the "contains" test also reaches into the internal structure. However, "contains" doesn't really produce verifiable results on a WeakValueDict anyway, because the member can always disappear between the containment test and retrieval, so we could not override that routine (in the same way that "len" is not overridden).

For me the main issues that prevent me from fixing this issue are that I don't have access to a platform where I can compile cython against python 3 and that I don't know how to make cython source compile conditionally wrt. Py2 vs. Py3. It's probably easier if someone who does know how to deal with those things makes the necessary adjustments. It's not rocket science, but you do have to carefully read dictobject.c

If we could somehow link to [delitem_common](https://github.com/python/cpython/blob/master/Objects/dictobject.c#L1587) the deletion would almost be taken care of. I'm afraid that's not an exported symbol, though, so we basically have to replicate it.

Also, perhaps we should always force the WeakValueDict to be "combined" (the old-style layout), because split tables don't allow deletion, and triggering reshaping of the dictionary in a weakref callback is probably not a good idea.



---

archive/issue_comments_329631.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nbuild failure looks like that:\n\n```\n[sagelib-7.6.beta4] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c: In function '__pyx_f_4sage_4misc_9weak_dict_PyDict_GetItemWithError':\n[sagelib-7.6.beta4] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1393:3: error: unknown type name 'PyDictEntry'\n[sagelib-7.6.beta4]    PyDictEntry *__pyx_v_ep;\n[sagelib-7.6.beta4]    ^\n[sagelib-7.6.beta4] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1398:3: error: unknown type name 'PyDictEntry'\n[sagelib-7.6.beta4]    PyDictEntry *__pyx_t_2;\n[sagelib-7.6.beta4]    ^\n[sagelib-7.6.beta4] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1419:25: error: 'PyDictObject {aka struct <anonymous>}' has no member named 'ma_lookup'\n```",
    "created_at": "2017-02-21T15:35:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329631",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:2" align="right">comment:2</div>

build failure looks like that:

```
[sagelib-7.6.beta4] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c: In function '__pyx_f_4sage_4misc_9weak_dict_PyDict_GetItemWithError':
[sagelib-7.6.beta4] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1393:3: error: unknown type name 'PyDictEntry'
[sagelib-7.6.beta4]    PyDictEntry *__pyx_v_ep;
[sagelib-7.6.beta4]    ^
[sagelib-7.6.beta4] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1398:3: error: unknown type name 'PyDictEntry'
[sagelib-7.6.beta4]    PyDictEntry *__pyx_t_2;
[sagelib-7.6.beta4]    ^
[sagelib-7.6.beta4] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1419:25: error: 'PyDictObject {aka struct <anonymous>}' has no member named 'ma_lookup'
```



---

archive/issue_comments_329632.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,6 @@\n The structure of `PyDictObject` used by `weak_dict` changed from Python 2 to Python 3, e.g `PyDictEntry` has been removed\n+\n+REF:\n+\n+* https://docs.python.org/2/c-api/dict.html\n+* https://docs.python.org/3/c-api/dict.html\n``````\n",
    "created_at": "2017-02-21T15:40:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329632",
    "user": "https://github.com/fchapoton"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,6 @@
 The structure of `PyDictObject` used by `weak_dict` changed from Python 2 to Python 3, e.g `PyDictEntry` has been removed
+
+REF:
+
+* https://docs.python.org/2/c-api/dict.html
+* https://docs.python.org/3/c-api/dict.html
``````




---

archive/issue_events_313538.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2017-02-23T11:10:42Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22305#event-313538"
}
```



---

archive/issue_comments_329633.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nThis is one of our cython+python3 compilation problems.",
    "created_at": "2017-03-01T20:24:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329633",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:5" align="right">comment:5</div>

This is one of our cython+python3 compilation problems.



---

archive/issue_events_313539.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2017-03-31T19:38:12Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "milestone_number": null,
    "milestone_title": "sage-7.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22305#event-313539"
}
```



---

archive/issue_events_313540.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2017-03-31T19:38:12Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "milestone_number": null,
    "milestone_title": "sage-8.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22305#event-313540"
}
```



---

archive/issue_comments_329634.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nCould somebody do some action on the problem here, please ?",
    "created_at": "2017-04-06T08:54:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329634",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:7" align="right">comment:7</div>

Could somebody do some action on the problem here, please ?



---

archive/issue_comments_329635.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nThis is probably the last cython file that does not compile with python3 !!",
    "created_at": "2017-04-07T12:15:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329635",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:8" align="right">comment:8</div>

This is probably the last cython file that does not compile with python3 !!



---

archive/issue_comments_329636.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nIs there an easy way to get a \"cython+python3\" setup on which I can try weak_dict? I do recall how I made it work on py2, so I might be in a reasonable position to adapt it to py3.\n\nDo we need a way to switch between the two? I don't think it will be so easy to make a version that works on both py2 and py3 (given that we reach into dicts beyond what's exposed by the API)",
    "created_at": "2017-04-07T21:33:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329636",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:9" align="right">comment:9</div>

Is there an easy way to get a "cython+python3" setup on which I can try weak_dict? I do recall how I made it work on py2, so I might be in a reasonable position to adapt it to py3.

Do we need a way to switch between the two? I don't think it will be so easy to make a version that works on both py2 and py3 (given that we reach into dicts beyond what's exposed by the API)



---

archive/issue_comments_329637.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nOK, I've made some headway here. The changes are quite manageable. However, we do need the content and memory layout of the `PyDictKeysObject`. That's not part of the API and the layout of the `PyDictKeysObject` struct isn't even exported in `Python.h` (it's in `dict-common.h`, which is an internal, non-exported header file in CPython.).\n\nAs before, this means that this module might need rewriting if CPython decides to change the memory layout (and/or its hash probing).\n\nThe bad news is that they have done exactly that from 3.5 to 3.6 (they added order-preserving properties to dictionaries). So: do we have a particular target we're aiming for with sage? 3.5 vs. 3.6 makes a significant difference (larger than 2.7 vs. 3.5 actually)\n\nOf course, reaching into CPython beyond the official CAPI is questionable. The alternative is to reimplement the entirety of dict in order to have `WeakValueDictionary`. Either that or try to get this thing accepted up-stream (after all, the `WeakValueDictionary` that ships with python (also the one with python 3) has demonstrable problems). Are we comfortable with the added maintenance burden of a module that depends on more than just the CAPI of CPython?",
    "created_at": "2017-04-08T03:01:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329637",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:10" align="right">comment:10</div>

OK, I've made some headway here. The changes are quite manageable. However, we do need the content and memory layout of the `PyDictKeysObject`. That's not part of the API and the layout of the `PyDictKeysObject` struct isn't even exported in `Python.h` (it's in `dict-common.h`, which is an internal, non-exported header file in CPython.).

As before, this means that this module might need rewriting if CPython decides to change the memory layout (and/or its hash probing).

The bad news is that they have done exactly that from 3.5 to 3.6 (they added order-preserving properties to dictionaries). So: do we have a particular target we're aiming for with sage? 3.5 vs. 3.6 makes a significant difference (larger than 2.7 vs. 3.5 actually)

Of course, reaching into CPython beyond the official CAPI is questionable. The alternative is to reimplement the entirety of dict in order to have `WeakValueDictionary`. Either that or try to get this thing accepted up-stream (after all, the `WeakValueDictionary` that ships with python (also the one with python 3) has demonstrable problems). Are we comfortable with the added maintenance burden of a module that depends on more than just the CAPI of CPython?



---

archive/issue_comments_329638.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nOK, I've attached a version of weak_dict.pyx that compiles on python 3.6 and that seems to work too. Some more testing should be done and someone should look into how we can merge this into sage without breaking it on python 2.7",
    "created_at": "2017-04-08T04:57:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329638",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:11" align="right">comment:11</div>

OK, I've attached a version of weak_dict.pyx that compiles on python 3.6 and that seems to work too. Some more testing should be done and someone should look into how we can merge this into sage without breaking it on python 2.7



---

archive/issue_comments_329639.json:
```json
{
    "body": "Attachment: **[weak_dict.pyx.gz](https://github.com/sagemath/sage/files/ticket22305/weak_dict.pyx.gz)**\n\nPython3.6 compatible version of weak_dict.pyx",
    "created_at": "2017-04-11T19:11:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329639",
    "user": "https://github.com/nbruin"
}
```

Attachment: **[weak_dict.pyx.gz](https://github.com/sagemath/sage/files/ticket22305/weak_dict.pyx.gz)**

Python3.6 compatible version of weak_dict.pyx



---

archive/issue_comments_329640.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nSome updates. Main thing is that the default lookup function doesn't expect deleted entries, so we should trigger the dict to use the more general lookup.\n\nThere is a dictionary variant that has \"split tables\" (for keys and values, so that it can share the keys between different instances). These should only occur as instance dictionaries of objects so they shouldn't occur for `WeakValueDictionaries`. These don't support deletions either.",
    "created_at": "2017-04-11T19:14:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329640",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:12" align="right">comment:12</div>

Some updates. Main thing is that the default lookup function doesn't expect deleted entries, so we should trigger the dict to use the more general lookup.

There is a dictionary variant that has "split tables" (for keys and values, so that it can share the keys between different instances). These should only occur as instance dictionaries of objects so they shouldn't occur for `WeakValueDictionaries`. These don't support deletions either.



---

archive/issue_comments_329641.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nPing to chapoton. Did you need a fix urgently? The file attached here does solve the compilation issue on Python3.6.",
    "created_at": "2017-04-13T18:53:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329641",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:13" align="right">comment:13</div>

Ping to chapoton. Did you need a fix urgently? The file attached here does solve the compilation issue on Python3.6.



---

archive/issue_comments_329642.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\ni have no available time this week",
    "created_at": "2017-04-13T19:35:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329642",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:14" align="right">comment:14</div>

i have no available time this week



---

archive/issue_comments_329643.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nI made a git branch with your latest patch.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/02a2b13df369e26bb463c6bf2429c7873a4f972c\"><code>02a2b13</code></a></td><td><code>py3.6 compatible weak dictionaries</code></td></tr></table>\n",
    "created_at": "2017-04-16T11:30:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329643",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:15" align="right">comment:15</div>

I made a git branch with your latest patch.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/02a2b13df369e26bb463c6bf2429c7873a4f972c"><code>02a2b13</code></a></td><td><code>py3.6 compatible weak dictionaries</code></td></tr></table>




---

archive/issue_comments_329644.json:
```json
{
    "body": "Branch: **[public/22305](https://github.com/sagemath/sagetrac-mirror/tree/public/22305)**",
    "created_at": "2017-04-16T11:30:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329644",
    "user": "https://github.com/fchapoton"
}
```

Branch: **[public/22305](https://github.com/sagemath/sagetrac-mirror/tree/public/22305)**



---

archive/issue_comments_329645.json:
```json
{
    "body": "Commit: **[`02a2b13`](https://github.com/sagemath/sagetrac-mirror/commit/02a2b13df369e26bb463c6bf2429c7873a4f972c)**",
    "created_at": "2017-04-16T11:30:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329645",
    "user": "https://github.com/fchapoton"
}
```

Commit: **[`02a2b13`](https://github.com/sagemath/sagetrac-mirror/commit/02a2b13df369e26bb463c6bf2429c7873a4f972c)**



---

archive/issue_comments_329646.json:
```json
{
    "body": "<div id=\"comment:16\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/787975ecdfe248586d6bafcfe407d566096e24bc\"><code>787975e</code></a></td><td><code>trac 22305 adding the new weak_dict.pyx</code></td></tr></table>\n",
    "created_at": "2017-04-16T11:31:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329646",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:16"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/787975ecdfe248586d6bafcfe407d566096e24bc"><code>787975e</code></a></td><td><code>trac 22305 adding the new weak_dict.pyx</code></td></tr></table>




---

archive/issue_comments_329647.json:
```json
{
    "body": "Changed commit from **[`02a2b13`](https://github.com/sagemath/sagetrac-mirror/commit/02a2b13df369e26bb463c6bf2429c7873a4f972c)** to **[`787975e`](https://github.com/sagemath/sagetrac-mirror/commit/787975ecdfe248586d6bafcfe407d566096e24bc)**",
    "created_at": "2017-04-16T11:31:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329647",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`02a2b13`](https://github.com/sagemath/sagetrac-mirror/commit/02a2b13df369e26bb463c6bf2429c7873a4f972c)** to **[`787975e`](https://github.com/sagemath/sagetrac-mirror/commit/787975ecdfe248586d6bafcfe407d566096e24bc)**



---

archive/issue_comments_329648.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nI made a git branch with your latest patch. \n\n**EDIT**: it was not cythonizing correctly because of a typo. Now corrected in latest commit.",
    "created_at": "2017-04-16T12:34:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329648",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:17" align="right">comment:17</div>

I made a git branch with your latest patch. 

**EDIT**: it was not cythonizing correctly because of a typo. Now corrected in latest commit.



---

archive/issue_comments_329649.json:
```json
{
    "body": "<div id=\"comment:18\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8722eb7a8fbbef4b6bdc94f19a7a69ea1e238cbd\"><code>8722eb7</code></a></td><td><code>trac 22305 typo</code></td></tr></table>\n",
    "created_at": "2017-04-16T12:40:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329649",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:18"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8722eb7a8fbbef4b6bdc94f19a7a69ea1e238cbd"><code>8722eb7</code></a></td><td><code>trac 22305 typo</code></td></tr></table>




---

archive/issue_comments_329650.json:
```json
{
    "body": "Changed commit from **[`787975e`](https://github.com/sagemath/sagetrac-mirror/commit/787975ecdfe248586d6bafcfe407d566096e24bc)** to **[`8722eb7`](https://github.com/sagemath/sagetrac-mirror/commit/8722eb7a8fbbef4b6bdc94f19a7a69ea1e238cbd)**",
    "created_at": "2017-04-16T12:40:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329650",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`787975e`](https://github.com/sagemath/sagetrac-mirror/commit/787975ecdfe248586d6bafcfe407d566096e24bc)** to **[`8722eb7`](https://github.com/sagemath/sagetrac-mirror/commit/8722eb7a8fbbef4b6bdc94f19a7a69ea1e238cbd)**



---

archive/issue_comments_329651.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nnext step here would be to have the old code for python2 and the new for python3. I have no idea how to do that.",
    "created_at": "2017-04-16T19:43:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329651",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:19" align="right">comment:19</div>

next step here would be to have the old code for python2 and the new for python3. I have no idea how to do that.



---

archive/issue_comments_329652.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [@fchapoton](#comment:19):\n> next step here would be to have the old code for python2 and the new for python3. I have no idea how to do that.\n\nYes, I looked into that and came up with nothing either. I got the impression that the `setup.py` file would be the place to set a flag depending on the target, and then use \"IF\" in cython to do a conditional compile. We could separate out the code for `delete_by_exact_value` into a separate file if that makes things a little cleaner. That's the only routine that depends on the implementation details of `dict`.\n\nIt looks like the Cython IF is a little more restricted that the C preprocessor one. I tried \n`IF PY_HEX_VERSION > 0x03060000:` but couldn't get it to work.",
    "created_at": "2017-04-16T21:57:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329652",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [@fchapoton](#comment:19):
> next step here would be to have the old code for python2 and the new for python3. I have no idea how to do that.

Yes, I looked into that and came up with nothing either. I got the impression that the `setup.py` file would be the place to set a flag depending on the target, and then use "IF" in cython to do a conditional compile. We could separate out the code for `delete_by_exact_value` into a separate file if that makes things a little cleaner. That's the only routine that depends on the implementation details of `dict`.

It looks like the Cython IF is a little more restricted that the C preprocessor one. I tried 
`IF PY_HEX_VERSION > 0x03060000:` but couldn't get it to work.



---

archive/issue_comments_329653.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\n@jdemeyer, do you know how to achieve properly this kind of py2/py3 switch in cython code ?",
    "created_at": "2017-04-20T07:42:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329653",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:21" align="right">comment:21</div>

@jdemeyer, do you know how to achieve properly this kind of py2/py3 switch in cython code ?



---

archive/issue_comments_329654.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nI'll have a look.",
    "created_at": "2017-04-20T07:54:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329654",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:22" align="right">comment:22</div>

I'll have a look.



---

archive/issue_comments_329655.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nBesides: copying all that stuff from Python's sources is really bad style. I would much prefer to patch Python to make whatever you need public.",
    "created_at": "2017-04-20T08:11:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329655",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:23" align="right">comment:23</div>

Besides: copying all that stuff from Python's sources is really bad style. I would much prefer to patch Python to make whatever you need public.



---

archive/issue_comments_329656.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nI am not convinced that we need completely separate files for Python 2 and Python 3. There would be a lot of code duplication and that is bad style.\n\nSome changes for Python 3 already make sense in Python 2 (just to give one example: replacing `long` by `Py_hash_t`).",
    "created_at": "2017-04-20T08:18:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329656",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:24" align="right">comment:24</div>

I am not convinced that we need completely separate files for Python 2 and Python 3. There would be a lot of code duplication and that is bad style.

Some changes for Python 3 already make sense in Python 2 (just to give one example: replacing `long` by `Py_hash_t`).



---

archive/issue_comments_329657.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nMy proposal would be:\n\n1. Make a *separate* ticket to deal with changes to `weak_dict.pyx` which are good to do anyway regardless of Python vesion.\n\n2. Patch Python 3 to make public whatever is needed for the Python 3 version of `weak_dict.pyx`.\n\n3. Finally, use conditional compilation to deal with Python 2/3 differences in `weak_dict.pyx`.",
    "created_at": "2017-04-20T08:21:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329657",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:25" align="right">comment:25</div>

My proposal would be:

1. Make a *separate* ticket to deal with changes to `weak_dict.pyx` which are good to do anyway regardless of Python vesion.

2. Patch Python 3 to make public whatever is needed for the Python 3 version of `weak_dict.pyx`.

3. Finally, use conditional compilation to deal with Python 2/3 differences in `weak_dict.pyx`.



---

archive/issue_comments_329658.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nNumber 2 is a useful exercise in trying to see if we can get a patch submitted upstream, but realistically I don't think it's very realistic that it will be accepted, given that \"deleting an item from a dict by hash and exact value\" isn't something that fits in the dict data abstraction very well, and might be hard to realize on other implementations than CPython.\n\nRequiring a patched python 3 for sage would really be a step backwards in terms of making sage available via other means than its own distribution packaging, so I don't think we should do that.\n\nI agree we can split out differences quite a bit. Basically, it's just the implementation of `delete_by_exact_value` that will depend on the python version, so we could park that in a separate file at least. We're going to need to differentiate *some* cython compilation on python version, though, and currently I don't know how to achieve that. (that's point 3). Can we clear that up? It shouldn't be necessary to program this stuff directly in C, just to have access to PY_HEX_VERSION ...",
    "created_at": "2017-04-20T17:08:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329658",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:26" align="right">comment:26</div>

Number 2 is a useful exercise in trying to see if we can get a patch submitted upstream, but realistically I don't think it's very realistic that it will be accepted, given that "deleting an item from a dict by hash and exact value" isn't something that fits in the dict data abstraction very well, and might be hard to realize on other implementations than CPython.

Requiring a patched python 3 for sage would really be a step backwards in terms of making sage available via other means than its own distribution packaging, so I don't think we should do that.

I agree we can split out differences quite a bit. Basically, it's just the implementation of `delete_by_exact_value` that will depend on the python version, so we could park that in a separate file at least. We're going to need to differentiate *some* cython compilation on python version, though, and currently I don't know how to achieve that. (that's point 3). Can we clear that up? It shouldn't be necessary to program this stuff directly in C, just to have access to PY_HEX_VERSION ...



---

archive/issue_comments_329659.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nping ? Jeroen, if you want to make a ticket for your point 1, please do so.",
    "created_at": "2017-04-28T11:40:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329659",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:27" align="right">comment:27</div>

ping ? Jeroen, if you want to make a ticket for your point 1, please do so.



---

archive/issue_comments_329660.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nThe mechanism to pass compile-time variables to cython (for use in IF ...) seems to be something along the lines of:\n\n```\nfrom distutils.core import setup\nfrom Cython.Build import cythonize\nfrom sys import version_info\n\nif version_info.major <= 2:\n    env = {'PYTHON_VERSION': 2}\nelif version_info.major == 3 and version_info.minor >= 6:\n    env = {'PYTHON_VERSION': 3}\nelse:\n    raise RuntimeError(\"Unsupported version\")\n\nsetup(\n    name = 'weak_dict',\n    ext_modules = cythonize(\"weak_dict.pyx\",compile_time_env=env),\n)\n```\nI have no idea where put this in sage, though. I haven't been able to find the \"setup\" command that is relevant for \"weak_dict\".",
    "created_at": "2017-04-30T08:14:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329660",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:28" align="right">comment:28</div>

The mechanism to pass compile-time variables to cython (for use in IF ...) seems to be something along the lines of:

```
from distutils.core import setup
from Cython.Build import cythonize
from sys import version_info

if version_info.major <= 2:
    env = {'PYTHON_VERSION': 2}
elif version_info.major == 3 and version_info.minor >= 6:
    env = {'PYTHON_VERSION': 3}
else:
    raise RuntimeError("Unsupported version")

setup(
    name = 'weak_dict',
    ext_modules = cythonize("weak_dict.pyx",compile_time_env=env),
)
```
I have no idea where put this in sage, though. I haven't been able to find the "setup" command that is relevant for "weak_dict".



---

archive/issue_comments_329661.json:
```json
{
    "body": "Changed commit from **[`8722eb7`](https://github.com/sagemath/sagetrac-mirror/commit/8722eb7a8fbbef4b6bdc94f19a7a69ea1e238cbd)** to **[`4c73dbe`](https://github.com/sagemath/sagetrac-mirror/commit/4c73dbec8a910509aa837233f878099e62a379ed)**",
    "created_at": "2017-05-01T22:01:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329661",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`8722eb7`](https://github.com/sagemath/sagetrac-mirror/commit/8722eb7a8fbbef4b6bdc94f19a7a69ea1e238cbd)** to **[`4c73dbe`](https://github.com/sagemath/sagetrac-mirror/commit/4c73dbec8a910509aa837233f878099e62a379ed)**



---

archive/issue_comments_329662.json:
```json
{
    "body": "<div id=\"comment:29\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7b4ec6cf444e2f89ae77ea6f6a8670743c47ff18\"><code>7b4ec6c</code></a></td><td><code>Add sys.version_info as \"PYTHON_VERSION\" to cython compile-time environment</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4c73dbec8a910509aa837233f878099e62a379ed\"><code>4c73dbe</code></a></td><td><code>tract #22305 -- split off del_dictitem_by_exact_value and comile conditionally based on Py2/Py3</code></td></tr></table>\n",
    "created_at": "2017-05-01T22:01:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329662",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:29"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7b4ec6cf444e2f89ae77ea6f6a8670743c47ff18"><code>7b4ec6c</code></a></td><td><code>Add sys.version_info as "PYTHON_VERSION" to cython compile-time environment</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4c73dbec8a910509aa837233f878099e62a379ed"><code>4c73dbe</code></a></td><td><code>tract #22305 -- split off del_dictitem_by_exact_value and comile conditionally based on Py2/Py3</code></td></tr></table>




---

archive/issue_comments_329663.json:
```json
{
    "body": "Changed commit from **[`4c73dbe`](https://github.com/sagemath/sagetrac-mirror/commit/4c73dbec8a910509aa837233f878099e62a379ed)** to **[`71b68d2`](https://github.com/sagemath/sagetrac-mirror/commit/71b68d22215182fa7700ddb73ecd1bf82fda84f4)**",
    "created_at": "2017-05-01T22:02:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329663",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`4c73dbe`](https://github.com/sagemath/sagetrac-mirror/commit/4c73dbec8a910509aa837233f878099e62a379ed)** to **[`71b68d2`](https://github.com/sagemath/sagetrac-mirror/commit/71b68d22215182fa7700ddb73ecd1bf82fda84f4)**



---

archive/issue_comments_329664.json:
```json
{
    "body": "<div id=\"comment:30\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/71b68d22215182fa7700ddb73ecd1bf82fda84f4\"><code>71b68d2</code></a></td><td><code>tract #22305 -- split off del_dictitem_by_exact_value and compile conditionally based on Py2/Py3</code></td></tr></table>\n",
    "created_at": "2017-05-01T22:02:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329664",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:30"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/71b68d22215182fa7700ddb73ecd1bf82fda84f4"><code>71b68d2</code></a></td><td><code>tract #22305 -- split off del_dictitem_by_exact_value and compile conditionally based on Py2/Py3</code></td></tr></table>




---

archive/issue_events_313541.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2017-05-01T22:15:28Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22305#event-313541"
}
```



---

archive/issue_comments_329665.json:
```json
{
    "body": "Author: **Nils Bruin**",
    "created_at": "2017-05-01T22:15:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329665",
    "user": "https://github.com/nbruin"
}
```

Author: **Nils Bruin**



---

archive/issue_comments_329666.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nIt seems we can simply add `sys.hexversion` as `PY_VERSION_HEX` (which is the CAPI name of the variable) to the compile-time environment for all sage cythonization. That should be fairly low-cost.\n\nI have split off the python-version-sensitive code into a separate file, which seems to work fine. Code replication is now a lot more limited. If someone sees an economic way of sharing the docstring, that would be great. On the other hand, these two implementations are so different that having different docs (and tests?) for them might make sense.\n\nI have tested compiling it within sage on Py2.7 and directly on Python3.6 via the following setup.py:\n\n```\nfrom distutils.core import setup\nfrom Cython.Build import cythonize\nimport sys\n\nsetup(\n    name = 'weak_dict',\n    ext_modules = cythonize([\"weak_dict.pyx\",\"dict_del_by_value.pyx\"],compile_time_env={'PY_VERSION_HEX':sys.hexversion}),\n)\n```\n\nSince this routine breaks the abstraction of \"PyDict\" I am pretty sure the code would not get accepted as an API change. The only thing that I could see happening is that python might accept the routine as an internal one and put `WeakValueDict` in C to use it.\n\nThe only option I see to do this \"cleanly\" outside of Python is to implement our own `WeakValueDict` from scratch, i.e., don't base it on `dict`. I don't think that is less maintenance burden than tracking python's dict, and certainly a larger change than the one on this ticket at this point in sage.",
    "created_at": "2017-05-01T22:15:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329666",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:31" align="right">comment:31</div>

It seems we can simply add `sys.hexversion` as `PY_VERSION_HEX` (which is the CAPI name of the variable) to the compile-time environment for all sage cythonization. That should be fairly low-cost.

I have split off the python-version-sensitive code into a separate file, which seems to work fine. Code replication is now a lot more limited. If someone sees an economic way of sharing the docstring, that would be great. On the other hand, these two implementations are so different that having different docs (and tests?) for them might make sense.

I have tested compiling it within sage on Py2.7 and directly on Python3.6 via the following setup.py:

```
from distutils.core import setup
from Cython.Build import cythonize
import sys

setup(
    name = 'weak_dict',
    ext_modules = cythonize(["weak_dict.pyx","dict_del_by_value.pyx"],compile_time_env={'PY_VERSION_HEX':sys.hexversion}),
)
```

Since this routine breaks the abstraction of "PyDict" I am pretty sure the code would not get accepted as an API change. The only thing that I could see happening is that python might accept the routine as an internal one and put `WeakValueDict` in C to use it.

The only option I see to do this "cleanly" outside of Python is to implement our own `WeakValueDict` from scratch, i.e., don't base it on `dict`. I don't think that is less maintenance burden than tracking python's dict, and certainly a larger change than the one on this ticket at this point in sage.



---

archive/issue_comments_329667.json:
```json
{
    "body": "Changed commit from **[`71b68d2`](https://github.com/sagemath/sagetrac-mirror/commit/71b68d22215182fa7700ddb73ecd1bf82fda84f4)** to **[`54d8c2d`](https://github.com/sagemath/sagetrac-mirror/commit/54d8c2da8ad19e610fe9939b90bc23202c5b5525)**",
    "created_at": "2017-05-01T22:28:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329667",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`71b68d2`](https://github.com/sagemath/sagetrac-mirror/commit/71b68d22215182fa7700ddb73ecd1bf82fda84f4)** to **[`54d8c2d`](https://github.com/sagemath/sagetrac-mirror/commit/54d8c2da8ad19e610fe9939b90bc23202c5b5525)**



---

archive/issue_comments_329668.json:
```json
{
    "body": "<div id=\"comment:32\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/54d8c2da8ad19e610fe9939b90bc23202c5b5525\"><code>54d8c2d</code></a></td><td><code>Correction: Py3 does provide PyDict_GetItemWithError but Cython doesn't provide it yet</code></td></tr></table>\n",
    "created_at": "2017-05-01T22:28:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329668",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:32"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/54d8c2da8ad19e610fe9939b90bc23202c5b5525"><code>54d8c2d</code></a></td><td><code>Correction: Py3 does provide PyDict_GetItemWithError but Cython doesn't provide it yet</code></td></tr></table>




---

archive/issue_comments_329669.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nseems to be ok on python2 sage, see patchbot report\n\nI will try with SAGE_PYTHON3=yes",
    "created_at": "2017-05-03T06:39:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329669",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:33" align="right">comment:33</div>

seems to be ok on python2 sage, see patchbot report

I will try with SAGE_PYTHON3=yes



---

archive/issue_comments_329670.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nhum, it seems that latest update to numpy broke the SAGE_PYTHON3 build..",
    "created_at": "2017-05-03T08:23:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329670",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:34" align="right">comment:34</div>

hum, it seems that latest update to numpy broke the SAGE_PYTHON3 build..



---

archive/issue_comments_329671.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nSee #22582 for a numpy upgrade which should fix the python 3 build.",
    "created_at": "2017-05-03T15:03:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329671",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:35" align="right">comment:35</div>

See #22582 for a numpy upgrade which should fix the python 3 build.



---

archive/issue_comments_329672.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\na tentative python3-compilation answers the following:\n\n```\ncdef del_dictitem_by_exact_value(PyDictObject *mp, PyObject *value, Py_hash_t ha\nsh)\n                                ^\n------------------------------------------------------------\n\nsage/misc/dict_del_by_value.pxd:5:33: Non-extern C function 'del_dictitem_by_exa\nct_value' declared but not defined\n```",
    "created_at": "2017-05-03T15:33:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329672",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:36" align="right">comment:36</div>

a tentative python3-compilation answers the following:

```
cdef del_dictitem_by_exact_value(PyDictObject *mp, PyObject *value, Py_hash_t ha
sh)
                                ^
------------------------------------------------------------

sage/misc/dict_del_by_value.pxd:5:33: Non-extern C function 'del_dictitem_by_exa
ct_value' declared but not defined
```



---

archive/issue_comments_329673.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nWas that on <=python3.5 ? Presently the implementation of dictionaries in CPython 3.0 -- 3.5 is not supported, and as a result dict_del_by_value.pyx dutifully refrains from defining a routine.",
    "created_at": "2017-05-03T16:28:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329673",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:37" align="right">comment:37</div>

Was that on <=python3.5 ? Presently the implementation of dictionaries in CPython 3.0 -- 3.5 is not supported, and as a result dict_del_by_value.pyx dutifully refrains from defining a routine.



---

archive/issue_comments_329674.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nYes, this is on the current python3 in sage, which is 3.5.1\n\nSo this means that we have to upgrade python3 package, right ?",
    "created_at": "2017-05-03T17:14:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329674",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:38" align="right">comment:38</div>

Yes, this is on the current python3 in sage, which is 3.5.1

So this means that we have to upgrade python3 package, right ?



---

archive/issue_comments_329675.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nReplying to [@fchapoton](#comment:38):\n> Yes, this is on the current python3 in sage, which is 3.5.1\n> \n> So this means that we have to upgrade python3 package, right ?\n\nYes. I am surprised your earlier experiments worked then. If the code that was here before even compiled against 3.5, it would certainly segfault.\n\n[https://docs.python.org/3/whatsnew/3.6.html#whatsnew36-compactdict](https://docs.python.org/3/whatsnew/3.6.html#whatsnew36-compactdict)",
    "created_at": "2017-05-03T17:24:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329675",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:39" align="right">comment:39</div>

Replying to [@fchapoton](#comment:38):
> Yes, this is on the current python3 in sage, which is 3.5.1
> 
> So this means that we have to upgrade python3 package, right ?

Yes. I am surprised your earlier experiments worked then. If the code that was here before even compiled against 3.5, it would certainly segfault.

[https://docs.python.org/3/whatsnew/3.6.html#whatsnew36-compactdict](https://docs.python.org/3/whatsnew/3.6.html#whatsnew36-compactdict)



---

archive/issue_comments_329676.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nI have created #22942",
    "created_at": "2017-05-03T19:55:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329676",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:40" align="right">comment:40</div>

I have created #22942



---

archive/issue_comments_329677.json:
```json
{
    "body": "Dependencies: **#22942**",
    "created_at": "2017-05-04T17:57:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329677",
    "user": "https://github.com/fchapoton"
}
```

Dependencies: **#22942**



---

archive/issue_events_313542.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2017-05-19T12:18:10Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22305#event-313542"
}
```



---

archive/issue_events_313543.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2017-05-19T12:18:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22305#event-313543"
}
```



---

archive/issue_comments_329678.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nok, green bot, I am setting to positive.",
    "created_at": "2017-05-19T12:18:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329678",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:42" align="right">comment:42</div>

ok, green bot, I am setting to positive.



---

archive/issue_comments_329679.json:
```json
{
    "body": "Reviewer: **Fr\u00e9d\u00e9ric Chapoton**",
    "created_at": "2017-05-19T12:18:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329679",
    "user": "https://github.com/fchapoton"
}
```

Reviewer: **Frédéric Chapoton**



---

archive/issue_events_313544.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2017-05-19T12:39:02Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22305#event-313544"
}
```



---

archive/issue_events_313545.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2017-05-19T12:39:02Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22305#event-313545"
}
```



---

archive/issue_comments_329680.json:
```json
{
    "body": "<div id=\"comment:43\" align=\"right\">comment:43</div>\n\nhmm, does not seem to compile with SAGE_PYTHON3=yes and python3.6.1",
    "created_at": "2017-05-19T12:39:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329680",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:43" align="right">comment:43</div>

hmm, does not seem to compile with SAGE_PYTHON3=yes and python3.6.1



---

archive/issue_comments_329681.json:
```json
{
    "body": "<div id=\"comment:44\" align=\"right\">comment:44</div>\n\nlog:\n\n```\n[sagelib-8.0.beta7] [1/1] gcc -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -fPIC -I/home/chapoton/sage3/local/include -I/home/chapoton/sage3/local/include/python3.6m -I/home/chapoton/sage3/local/lib/python3.6/site-packages/numpy/core/include -I/home/chapoton/sage3/src -I/home/chapoton/sage3/src/sage/ext -I/home/chapoton/sage3/src/build/cythonized -I/home/chapoton/sage3/src/build/cythonized/sage/ext -I/home/chapoton/sage3/local/include/python3.6m -c /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c -o build/temp.linux-x86_64-3.6/home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.o -fno-strict-aliasing\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c: In function '__pyx_f_4sage_4misc_9weak_dict_PyDict_GetItemWithError':\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1398:3: error: unknown type name 'PyDictEntry'\n[sagelib-8.0.beta7]    PyDictEntry *__pyx_v_ep;\n[sagelib-8.0.beta7]    ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1403:3: error: unknown type name 'PyDictEntry'\n[sagelib-8.0.beta7]    PyDictEntry *__pyx_t_2;\n[sagelib-8.0.beta7]    ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1424:25: error: 'PyDictObject {aka struct <anonymous>}' has no member named 'ma_lookup'\n[sagelib-8.0.beta7]    __pyx_t_2 = __pyx_v_mp->ma_lookup(__pyx_v_mp, ((PyObject *)((void *)__pyx_v_key)), __pyx_t_1); if (unlikely(__pyx_t_2 == NULL)) __PYX_ERR(0, 152, __pyx_L1_error)\n[sagelib-8.0.beta7]                          ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1444:25: error: request for member 'me_value' in something not a structure or union\n[sagelib-8.0.beta7]      __pyx_r = __pyx_v_ep->me_value;\n[sagelib-8.0.beta7]                          ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c: In function '__pyx_f_4sage_4misc_9weak_dict_init_dummy':\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1497:3: error: unknown type name 'PyDictEntry'\n[sagelib-8.0.beta7]    PyDictEntry *__pyx_v_ep0;\n[sagelib-8.0.beta7]    ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1498:3: error: unknown type name 'PyDictEntry'\n[sagelib-8.0.beta7]    PyDictEntry *__pyx_v_ep;\n[sagelib-8.0.beta7]    ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1503:3: error: unknown type name 'PyDictEntry'\n[sagelib-8.0.beta7]    PyDictEntry *__pyx_t_2;\n[sagelib-8.0.beta7]    ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1538:25: error: 'PyDictObject {aka struct <anonymous>}' has no member named 'ma_table'\n[sagelib-8.0.beta7]    __pyx_t_2 = __pyx_v_mp->ma_table;\n[sagelib-8.0.beta7]                          ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1558:25: error: 'PyDictObject {aka struct <anonymous>}' has no member named 'ma_mask'\n[sagelib-8.0.beta7]    __pyx_t_3 = __pyx_v_mp->ma_mask;\n[sagelib-8.0.beta7]                          ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1588:29: error: request for member 'me_key' in something not a structure or union\n[sagelib-8.0.beta7]      __pyx_t_6 = ((__pyx_v_ep->me_key != NULL) != 0);\n[sagelib-8.0.beta7]                              ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1598:27: error: request for member 'me_key' in something not a structure or union\n[sagelib-8.0.beta7]        __pyx_r = __pyx_v_ep->me_key;\n[sagelib-8.0.beta7]                            ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c: In function '__pyx_f_4sage_4misc_9weak_dict_del_dictitem_by_exact_value':\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1655:3: error: unknown type name 'PyDictEntry'\n[sagelib-8.0.beta7]    PyDictEntry *__pyx_v_ep0;\n[sagelib-8.0.beta7]    ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1656:3: error: unknown type name 'PyDictEntry'\n[sagelib-8.0.beta7]    PyDictEntry *__pyx_v_ep;\n[sagelib-8.0.beta7]    ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1660:3: error: unknown type name 'PyDictEntry'\n[sagelib-8.0.beta7]    PyDictEntry *__pyx_t_1;\n[sagelib-8.0.beta7]    ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1674:37: error: 'PyDictObject {aka struct <anonymous>}' has no member named 'ma_mask'\n[sagelib-8.0.beta7]    __pyx_v_mask = ((size_t)__pyx_v_mp->ma_mask);\n[sagelib-8.0.beta7]                                      ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1683:25: error: 'PyDictObject {aka struct <anonymous>}' has no member named 'ma_table'\n[sagelib-8.0.beta7]    __pyx_t_1 = __pyx_v_mp->ma_table;\n[sagelib-8.0.beta7]                          ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1711:27: error: request for member 'me_key' in something not a structure or union\n[sagelib-8.0.beta7]    __pyx_t_2 = ((__pyx_v_ep->me_key == NULL) != 0);\n[sagelib-8.0.beta7]                            ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1751:42: error: request for member 'me_value' in something not a structure or union\n[sagelib-8.0.beta7]      __pyx_t_3 = ((((PyObject *)__pyx_v_ep->me_value) != __pyx_v_value) != 0);\n[sagelib-8.0.beta7]                                           ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1757:29: error: request for member 'me_hash' in something not a structure or union\n[sagelib-8.0.beta7]      __pyx_t_3 = ((__pyx_v_ep->me_hash != __pyx_v_hash) != 0);\n[sagelib-8.0.beta7]                              ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1787:29: error: request for member 'me_key' in something not a structure or union\n[sagelib-8.0.beta7]      __pyx_t_2 = ((__pyx_v_ep->me_key == NULL) != 0);\n[sagelib-8.0.beta7]                              ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1839:54: error: request for member 'me_key' in something not a structure or union\n[sagelib-8.0.beta7]    __pyx_t_5 = PyList_SetItem(__pyx_v_T, 0, __pyx_v_ep->me_key); if (unlikely(__pyx_t_5 == -1)) __PYX_ERR(0, 258, __pyx_L1_error)\n[sagelib-8.0.beta7]                                                       ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1889:13: error: request for member 'me_key' in something not a structure or union\n[sagelib-8.0.beta7]    __pyx_v_ep->me_key = __pyx_v_4sage_4misc_9weak_dict_dummy;\n[sagelib-8.0.beta7]              ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1898:54: error: request for member 'me_value' in something not a structure or union\n[sagelib-8.0.beta7]    __pyx_t_5 = PyList_SetItem(__pyx_v_T, 1, __pyx_v_ep->me_value); if (unlikely(__pyx_t_5 == -1)) __PYX_ERR(0, 263, __pyx_L1_error)\n[sagelib-8.0.beta7]                                                       ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1907:13: error: request for member 'me_value' in something not a structure or union\n[sagelib-8.0.beta7]    __pyx_v_ep->me_value = NULL;\n[sagelib-8.0.beta7]              ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c: In function '__pyx_pf_4sage_4misc_9weak_dict_19WeakValueDictionary_22__contains__':\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:4290:3: error: unknown type name 'PyDictEntry'\n[sagelib-8.0.beta7]    PyDictEntry *__pyx_v_ep;\n[sagelib-8.0.beta7]    ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:4294:3: error: unknown type name 'PyDictEntry'\n[sagelib-8.0.beta7]    PyDictEntry *__pyx_t_2;\n[sagelib-8.0.beta7]    ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:4316:25: error: 'PyDictObject {aka struct <anonymous>}' has no member named 'ma_lookup'\n[sagelib-8.0.beta7]    __pyx_t_2 = __pyx_v_mp->ma_lookup(__pyx_v_mp, ((PyObject *)((void *)__pyx_v_k)), __pyx_t_1); if (unlikely(__pyx_t_2 == NULL)) __PYX_ERR(0, 928, __pyx_L1_error)\n[sagelib-8.0.beta7]                          ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:4326:26: error: request for member 'me_value' in something not a structure or union\n[sagelib-8.0.beta7]    __pyx_t_4 = (__pyx_v_ep->me_value != NULL);\n[sagelib-8.0.beta7]                           ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:4332:46: error: request for member 'me_value' in something not a structure or union\n[sagelib-8.0.beta7]    __pyx_t_4 = (PyWeakref_GetObject(__pyx_v_ep->me_value) != Py_None);\n[sagelib-8.0.beta7]                                               ^\n[sagelib-8.0.beta7] error: command 'gcc' failed with exit status 1\n```",
    "created_at": "2017-05-19T12:40:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329681",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:44" align="right">comment:44</div>

log:

```
[sagelib-8.0.beta7] [1/1] gcc -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -fPIC -I/home/chapoton/sage3/local/include -I/home/chapoton/sage3/local/include/python3.6m -I/home/chapoton/sage3/local/lib/python3.6/site-packages/numpy/core/include -I/home/chapoton/sage3/src -I/home/chapoton/sage3/src/sage/ext -I/home/chapoton/sage3/src/build/cythonized -I/home/chapoton/sage3/src/build/cythonized/sage/ext -I/home/chapoton/sage3/local/include/python3.6m -c /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c -o build/temp.linux-x86_64-3.6/home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.o -fno-strict-aliasing
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c: In function '__pyx_f_4sage_4misc_9weak_dict_PyDict_GetItemWithError':
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1398:3: error: unknown type name 'PyDictEntry'
[sagelib-8.0.beta7]    PyDictEntry *__pyx_v_ep;
[sagelib-8.0.beta7]    ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1403:3: error: unknown type name 'PyDictEntry'
[sagelib-8.0.beta7]    PyDictEntry *__pyx_t_2;
[sagelib-8.0.beta7]    ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1424:25: error: 'PyDictObject {aka struct <anonymous>}' has no member named 'ma_lookup'
[sagelib-8.0.beta7]    __pyx_t_2 = __pyx_v_mp->ma_lookup(__pyx_v_mp, ((PyObject *)((void *)__pyx_v_key)), __pyx_t_1); if (unlikely(__pyx_t_2 == NULL)) __PYX_ERR(0, 152, __pyx_L1_error)
[sagelib-8.0.beta7]                          ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1444:25: error: request for member 'me_value' in something not a structure or union
[sagelib-8.0.beta7]      __pyx_r = __pyx_v_ep->me_value;
[sagelib-8.0.beta7]                          ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c: In function '__pyx_f_4sage_4misc_9weak_dict_init_dummy':
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1497:3: error: unknown type name 'PyDictEntry'
[sagelib-8.0.beta7]    PyDictEntry *__pyx_v_ep0;
[sagelib-8.0.beta7]    ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1498:3: error: unknown type name 'PyDictEntry'
[sagelib-8.0.beta7]    PyDictEntry *__pyx_v_ep;
[sagelib-8.0.beta7]    ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1503:3: error: unknown type name 'PyDictEntry'
[sagelib-8.0.beta7]    PyDictEntry *__pyx_t_2;
[sagelib-8.0.beta7]    ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1538:25: error: 'PyDictObject {aka struct <anonymous>}' has no member named 'ma_table'
[sagelib-8.0.beta7]    __pyx_t_2 = __pyx_v_mp->ma_table;
[sagelib-8.0.beta7]                          ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1558:25: error: 'PyDictObject {aka struct <anonymous>}' has no member named 'ma_mask'
[sagelib-8.0.beta7]    __pyx_t_3 = __pyx_v_mp->ma_mask;
[sagelib-8.0.beta7]                          ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1588:29: error: request for member 'me_key' in something not a structure or union
[sagelib-8.0.beta7]      __pyx_t_6 = ((__pyx_v_ep->me_key != NULL) != 0);
[sagelib-8.0.beta7]                              ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1598:27: error: request for member 'me_key' in something not a structure or union
[sagelib-8.0.beta7]        __pyx_r = __pyx_v_ep->me_key;
[sagelib-8.0.beta7]                            ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c: In function '__pyx_f_4sage_4misc_9weak_dict_del_dictitem_by_exact_value':
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1655:3: error: unknown type name 'PyDictEntry'
[sagelib-8.0.beta7]    PyDictEntry *__pyx_v_ep0;
[sagelib-8.0.beta7]    ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1656:3: error: unknown type name 'PyDictEntry'
[sagelib-8.0.beta7]    PyDictEntry *__pyx_v_ep;
[sagelib-8.0.beta7]    ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1660:3: error: unknown type name 'PyDictEntry'
[sagelib-8.0.beta7]    PyDictEntry *__pyx_t_1;
[sagelib-8.0.beta7]    ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1674:37: error: 'PyDictObject {aka struct <anonymous>}' has no member named 'ma_mask'
[sagelib-8.0.beta7]    __pyx_v_mask = ((size_t)__pyx_v_mp->ma_mask);
[sagelib-8.0.beta7]                                      ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1683:25: error: 'PyDictObject {aka struct <anonymous>}' has no member named 'ma_table'
[sagelib-8.0.beta7]    __pyx_t_1 = __pyx_v_mp->ma_table;
[sagelib-8.0.beta7]                          ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1711:27: error: request for member 'me_key' in something not a structure or union
[sagelib-8.0.beta7]    __pyx_t_2 = ((__pyx_v_ep->me_key == NULL) != 0);
[sagelib-8.0.beta7]                            ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1751:42: error: request for member 'me_value' in something not a structure or union
[sagelib-8.0.beta7]      __pyx_t_3 = ((((PyObject *)__pyx_v_ep->me_value) != __pyx_v_value) != 0);
[sagelib-8.0.beta7]                                           ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1757:29: error: request for member 'me_hash' in something not a structure or union
[sagelib-8.0.beta7]      __pyx_t_3 = ((__pyx_v_ep->me_hash != __pyx_v_hash) != 0);
[sagelib-8.0.beta7]                              ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1787:29: error: request for member 'me_key' in something not a structure or union
[sagelib-8.0.beta7]      __pyx_t_2 = ((__pyx_v_ep->me_key == NULL) != 0);
[sagelib-8.0.beta7]                              ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1839:54: error: request for member 'me_key' in something not a structure or union
[sagelib-8.0.beta7]    __pyx_t_5 = PyList_SetItem(__pyx_v_T, 0, __pyx_v_ep->me_key); if (unlikely(__pyx_t_5 == -1)) __PYX_ERR(0, 258, __pyx_L1_error)
[sagelib-8.0.beta7]                                                       ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1889:13: error: request for member 'me_key' in something not a structure or union
[sagelib-8.0.beta7]    __pyx_v_ep->me_key = __pyx_v_4sage_4misc_9weak_dict_dummy;
[sagelib-8.0.beta7]              ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1898:54: error: request for member 'me_value' in something not a structure or union
[sagelib-8.0.beta7]    __pyx_t_5 = PyList_SetItem(__pyx_v_T, 1, __pyx_v_ep->me_value); if (unlikely(__pyx_t_5 == -1)) __PYX_ERR(0, 263, __pyx_L1_error)
[sagelib-8.0.beta7]                                                       ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1907:13: error: request for member 'me_value' in something not a structure or union
[sagelib-8.0.beta7]    __pyx_v_ep->me_value = NULL;
[sagelib-8.0.beta7]              ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c: In function '__pyx_pf_4sage_4misc_9weak_dict_19WeakValueDictionary_22__contains__':
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:4290:3: error: unknown type name 'PyDictEntry'
[sagelib-8.0.beta7]    PyDictEntry *__pyx_v_ep;
[sagelib-8.0.beta7]    ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:4294:3: error: unknown type name 'PyDictEntry'
[sagelib-8.0.beta7]    PyDictEntry *__pyx_t_2;
[sagelib-8.0.beta7]    ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:4316:25: error: 'PyDictObject {aka struct <anonymous>}' has no member named 'ma_lookup'
[sagelib-8.0.beta7]    __pyx_t_2 = __pyx_v_mp->ma_lookup(__pyx_v_mp, ((PyObject *)((void *)__pyx_v_k)), __pyx_t_1); if (unlikely(__pyx_t_2 == NULL)) __PYX_ERR(0, 928, __pyx_L1_error)
[sagelib-8.0.beta7]                          ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:4326:26: error: request for member 'me_value' in something not a structure or union
[sagelib-8.0.beta7]    __pyx_t_4 = (__pyx_v_ep->me_value != NULL);
[sagelib-8.0.beta7]                           ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:4332:46: error: request for member 'me_value' in something not a structure or union
[sagelib-8.0.beta7]    __pyx_t_4 = (PyWeakref_GetObject(__pyx_v_ep->me_value) != Py_None);
[sagelib-8.0.beta7]                                               ^
[sagelib-8.0.beta7] error: command 'gcc' failed with exit status 1
```



---

archive/issue_comments_329682.json:
```json
{
    "body": "<div id=\"comment:45\" align=\"right\">comment:45</div>\n\nAre you testing the right branch? `PyDictEntry` doesn't occur in `weak_dict.pyx`. The only references to it are in `dict_del_by_value.pyx` and they don't get exported.",
    "created_at": "2017-05-19T15:06:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329682",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:45" align="right">comment:45</div>

Are you testing the right branch? `PyDictEntry` doesn't occur in `weak_dict.pyx`. The only references to it are in `dict_del_by_value.pyx` and they don't get exported.



---

archive/issue_comments_329683.json:
```json
{
    "body": "<div id=\"comment:46\" align=\"right\">comment:46</div>\n\nhmm, indeed. I was trying the vanilla develop branch... sorry for the noise..",
    "created_at": "2017-05-19T15:10:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329683",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:46" align="right">comment:46</div>

hmm, indeed. I was trying the vanilla develop branch... sorry for the noise..



---

archive/issue_events_313546.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2017-05-19T15:27:26Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22305#event-313546"
}
```



---

archive/issue_events_313547.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2017-05-19T15:27:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22305#event-313547"
}
```



---

archive/issue_comments_329684.json:
```json
{
    "body": "<div id=\"comment:48\" align=\"right\">comment:48</div>\n\nIndeed, it works with SAGE_PYTHON3=yes, so I agree with the positive review.",
    "created_at": "2017-05-19T15:50:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329684",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:48" align="right">comment:48</div>

Indeed, it works with SAGE_PYTHON3=yes, so I agree with the positive review.



---

archive/issue_comments_329685.json:
```json
{
    "body": "<div id=\"comment:49\" align=\"right\">comment:49</div>\n\nAh, sorry, I didn't realize you were (re?)checking it. I saw [comment:46](#comment:46) and thought you just forgot to flip it back to positive review.",
    "created_at": "2017-05-19T15:52:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329685",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:49" align="right">comment:49</div>

Ah, sorry, I didn't realize you were (re?)checking it. I saw [comment:46](#comment:46) and thought you just forgot to flip it back to positive review.



---

archive/issue_comments_329686.json:
```json
{
    "body": "Changed branch from **[public/22305](https://github.com/sagemath/sagetrac-mirror/tree/public/22305)** to **[`54d8c2d`](https://github.com/sagemath/sagetrac-mirror/commit/54d8c2da8ad19e610fe9939b90bc23202c5b5525)**",
    "created_at": "2017-05-20T20:07:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329686",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[public/22305](https://github.com/sagemath/sagetrac-mirror/tree/public/22305)** to **[`54d8c2d`](https://github.com/sagemath/sagetrac-mirror/commit/54d8c2da8ad19e610fe9939b90bc23202c5b5525)**



---

archive/issue_events_313548.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-05-20T20:07:52Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22305#event-313548"
}
```



---

archive/issue_events_313549.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "d34101e8c4a28181a075db0bd8aea34c94154b54",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2017-05-20T20:07:52Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22305#event-313549"
}
```



---

archive/issue_comments_329687.json:
```json
{
    "body": "<div id=\"comment:51\" align=\"right\">comment:51</div>\n\ncould the changes made here possibly explain the issue arising there:\n\n```\nTraceback (most recent call last):\n  File \"/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/rings/polynomial/polynomial_ring_constructor.py\", line 604, in _get_from_cache\n    return _cache[key]\n  File \"sage/misc/weak_dict.pyx\", line 699, in sage.misc.weak_dict.WeakValueDictionary.__getitem__ (/home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:3507)\nTypeError: unhashable type: 'ComplexIntervalField_class_with_category'\n```\nduring an experimental python3-build of sage ?",
    "created_at": "2017-08-26T13:07:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329687",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:51" align="right">comment:51</div>

could the changes made here possibly explain the issue arising there:

```
Traceback (most recent call last):
  File "/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/rings/polynomial/polynomial_ring_constructor.py", line 604, in _get_from_cache
    return _cache[key]
  File "sage/misc/weak_dict.pyx", line 699, in sage.misc.weak_dict.WeakValueDictionary.__getitem__ (/home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:3507)
TypeError: unhashable type: 'ComplexIntervalField_class_with_category'
```
during an experimental python3-build of sage ?



---

archive/issue_comments_329688.json:
```json
{
    "body": "Changed commit from **[`54d8c2d`](https://github.com/sagemath/sagetrac-mirror/commit/54d8c2da8ad19e610fe9939b90bc23202c5b5525)** to none",
    "created_at": "2017-08-26T13:07:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329688",
    "user": "https://github.com/fchapoton"
}
```

Changed commit from **[`54d8c2d`](https://github.com/sagemath/sagetrac-mirror/commit/54d8c2da8ad19e610fe9939b90bc23202c5b5525)** to none



---

archive/issue_comments_329689.json:
```json
{
    "body": "<div id=\"comment:52\" align=\"right\">comment:52</div>\n\nReplying to [@fchapoton](#comment:51):\n> could the changes made here possibly explain the issue arising there:\n> \n> ```\n> Traceback (most recent call last):\n>   File \"/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/rings/polynomial/polynomial_ring_constructor.py\", line 604, in _get_from_cache\n>     return _cache[key]\n>   File \"sage/misc/weak_dict.pyx\", line 699, in sage.misc.weak_dict.WeakValueDictionary.__getitem__ (/home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:3507)\n> TypeError: unhashable type: 'ComplexIntervalField_class_with_category'\n> ```\n> during an experimental python3-build of sage ?\n\nNo.\n\nAlso, it's not such a good idea to ask questions on closed tickets. Probably no-one will read them, unless they happen to be looking at the ticket for reference for something else.",
    "created_at": "2017-09-22T16:12:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22305",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22305#issuecomment-329689",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:52" align="right">comment:52</div>

Replying to [@fchapoton](#comment:51):
> could the changes made here possibly explain the issue arising there:
> 
> ```
> Traceback (most recent call last):
>   File "/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/rings/polynomial/polynomial_ring_constructor.py", line 604, in _get_from_cache
>     return _cache[key]
>   File "sage/misc/weak_dict.pyx", line 699, in sage.misc.weak_dict.WeakValueDictionary.__getitem__ (/home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:3507)
> TypeError: unhashable type: 'ComplexIntervalField_class_with_category'
> ```
> during an experimental python3-build of sage ?

No.

Also, it's not such a good idea to ask questions on closed tickets. Probably no-one will read them, unless they happen to be looking at the ticket for reference for something else.
