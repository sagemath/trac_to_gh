# Issue 22768: Some Python modules fail to compile on Cygwin if the system headers are installed

archive/issues_022531.json:
```json
{
    "body": "If the sqlite3 development fails are installed system-wide (e.g. `sqlite3.h` is found in `/usr/include`) then the build can fail like:\n\n```\ngcc -shared -Wl,--enable-auto-image-base -L/home/embray/src/sagemath/sage-cygwin/local/lib -Wl,-rpath,/home/embray/src/sagemath/sage-cygwin/local/lib -L/home/embray/src/sagemath/sage-cygwin/local/lib -Wl,-rpath,/home/embray/src/sagemath/sage-cygwin/local/lib build/temp.cygwin-2.8.0-x86_64-2.7-pydebug/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/python2-2.7.13.p0/src/Modules/_sqlite/cache.o build/temp.cygwin-2.8.0-x86_64-2.7-pydebug/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/python2-2.7.13.p0/src/Modules/_sqlite/connection.o build/temp.cygwin-2.8.0-x86_64-2.7-pydebug/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/python2-2.7.13.p0/src/Modules/_sqlite/cursor.o build/temp.cygwin-2.8.0-x86_64-2.7-pydebug/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/python2-2.7.13.p0/src/Modules/_sqlite/microprotocols.o build/temp.cygwin-2.8.0-x86_64-2.7-pydebug/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/python2-2.7.13.p0/src/Modules/_sqlite/module.o build/temp.cygwin-2.8.0-x86_64-2.7-pydebug/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/python2-2.7.13.p0/src/Modules/_sqlite/prepare_protocol.o build/temp.cygwin-2.8.0-x86_64-2.7-pydebug/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/python2-2.7.13.p0/src/Modules/_sqlite/row.o build/temp.cygwin-2.8.0-x86_64-2.7-pydebug/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/python2-2.7.13.p0/src/Modules/_sqlite/statement.o build/temp.cygwin-2.8.0-x86_64-2.7-pydebug/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/python2-2.7.13.p0/src/Modules/_sqlite/util.o -L/usr/lib -L/home/embray/src/sagemath/sage-cygwin/local/lib -L/usr/local/lib -L. -L. -lsqlite3 -lpython2.7 -o build/lib.cygwin-2.8.0-x86_64-2.7-pydebug/_sqlite3.dll\nbuild/temp.cygwin-2.8.0-x86_64-2.7-pydebug/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/python2-2.7.13.p0/src/Modules/_sqlite/cache.o: In function `pysqlite_new_node':\n/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/python2-2.7.13.p0/src/Modules/_sqlite/cache.c:38: undefined reference to `__imp__Py_RefTotal'\n/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/python2-2.7.13.p0/src/Modules/_sqlite/cache.c:38:(.text+0x3d): relocation truncated to fit: R_X86_64_PC32 against undefined symbol `__imp__Py_RefTotal'\n/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/python2-2.7.13.p0/src/Modules/_sqlite/cache.c:38: undefined reference to `__imp__Py_RefTotal'\n/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/python2-2.7.13.p0/src/Modules/_sqlite/cache.c:38:(.text+0x4b): relocation truncated to fit: R_X86_64_PC32 against undefined symbol `__imp__Py_RefTotal'\n```\n\nfollowed by several hundred lines of similar symbol resolution failures.\n\nThe issue seems to be that if `/usr/include/sqlite.h` is found, it is inserting `-L/usr/lib` earlier than `-L.` in the link flags, and the result is that `/usr/lib/libpythonX.Y` is linked against, rather than the `libpythonX.Y` that was just built.\n\nThe same happens with ncurses *specifically* on Python 3 (but not Python 2, it seems).  An intermediate workaround is to simply not install the `-devel` packages for sqlite3 or libncurses in a Cygwin that Sage will be built in.\n\nI've only reproduced this issue on Cygwin, but I don't see anything Cygwin specific about it immediately.\n\nA related issue is the fact that the build is considered successful.  We should figure out how to make it fail if an \"optional\" extension module that we need fails to build; see #22776\n\nIssue created by migration from https://trac.sagemath.org/ticket/22768\n\n",
    "created_at": "2017-04-06T15:06:59Z",
    "labels": [
        "component: porting: cygwin",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Some Python modules fail to compile on Cygwin if the system headers are installed",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22768",
    "user": "https://github.com/embray"
}
```
If the sqlite3 development fails are installed system-wide (e.g. `sqlite3.h` is found in `/usr/include`) then the build can fail like:

```
gcc -shared -Wl,--enable-auto-image-base -L/home/embray/src/sagemath/sage-cygwin/local/lib -Wl,-rpath,/home/embray/src/sagemath/sage-cygwin/local/lib -L/home/embray/src/sagemath/sage-cygwin/local/lib -Wl,-rpath,/home/embray/src/sagemath/sage-cygwin/local/lib build/temp.cygwin-2.8.0-x86_64-2.7-pydebug/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/python2-2.7.13.p0/src/Modules/_sqlite/cache.o build/temp.cygwin-2.8.0-x86_64-2.7-pydebug/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/python2-2.7.13.p0/src/Modules/_sqlite/connection.o build/temp.cygwin-2.8.0-x86_64-2.7-pydebug/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/python2-2.7.13.p0/src/Modules/_sqlite/cursor.o build/temp.cygwin-2.8.0-x86_64-2.7-pydebug/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/python2-2.7.13.p0/src/Modules/_sqlite/microprotocols.o build/temp.cygwin-2.8.0-x86_64-2.7-pydebug/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/python2-2.7.13.p0/src/Modules/_sqlite/module.o build/temp.cygwin-2.8.0-x86_64-2.7-pydebug/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/python2-2.7.13.p0/src/Modules/_sqlite/prepare_protocol.o build/temp.cygwin-2.8.0-x86_64-2.7-pydebug/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/python2-2.7.13.p0/src/Modules/_sqlite/row.o build/temp.cygwin-2.8.0-x86_64-2.7-pydebug/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/python2-2.7.13.p0/src/Modules/_sqlite/statement.o build/temp.cygwin-2.8.0-x86_64-2.7-pydebug/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/python2-2.7.13.p0/src/Modules/_sqlite/util.o -L/usr/lib -L/home/embray/src/sagemath/sage-cygwin/local/lib -L/usr/local/lib -L. -L. -lsqlite3 -lpython2.7 -o build/lib.cygwin-2.8.0-x86_64-2.7-pydebug/_sqlite3.dll
build/temp.cygwin-2.8.0-x86_64-2.7-pydebug/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/python2-2.7.13.p0/src/Modules/_sqlite/cache.o: In function `pysqlite_new_node':
/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/python2-2.7.13.p0/src/Modules/_sqlite/cache.c:38: undefined reference to `__imp__Py_RefTotal'
/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/python2-2.7.13.p0/src/Modules/_sqlite/cache.c:38:(.text+0x3d): relocation truncated to fit: R_X86_64_PC32 against undefined symbol `__imp__Py_RefTotal'
/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/python2-2.7.13.p0/src/Modules/_sqlite/cache.c:38: undefined reference to `__imp__Py_RefTotal'
/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/python2-2.7.13.p0/src/Modules/_sqlite/cache.c:38:(.text+0x4b): relocation truncated to fit: R_X86_64_PC32 against undefined symbol `__imp__Py_RefTotal'
```

followed by several hundred lines of similar symbol resolution failures.

The issue seems to be that if `/usr/include/sqlite.h` is found, it is inserting `-L/usr/lib` earlier than `-L.` in the link flags, and the result is that `/usr/lib/libpythonX.Y` is linked against, rather than the `libpythonX.Y` that was just built.

The same happens with ncurses *specifically* on Python 3 (but not Python 2, it seems).  An intermediate workaround is to simply not install the `-devel` packages for sqlite3 or libncurses in a Cygwin that Sage will be built in.

I've only reproduced this issue on Cygwin, but I don't see anything Cygwin specific about it immediately.

A related issue is the fact that the build is considered successful.  We should figure out how to make it fail if an "optional" extension module that we need fails to build; see #22776

Issue created by migration from https://trac.sagemath.org/ticket/22768





---

archive/issue_comments_313692.json:
```json
{
    "body": "Changing priority from major to minor.",
    "created_at": "2017-04-10T15:59:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22768#issuecomment-313692",
    "user": "https://github.com/embray"
}
```

Changing priority from major to minor.



---

archive/issue_events_059259.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-04-11T12:41:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22768",
    "milestone": "sage-wishlist",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22768#event-59259"
}
```



---

archive/issue_comments_313693.json:
```json
{
    "body": "This would be good to fix but I don't think it needs to be in the current release mileston.",
    "created_at": "2017-04-11T12:41:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22768#issuecomment-313693",
    "user": "https://github.com/embray"
}
```

This would be good to fix but I don't think it needs to be in the current release mileston.



---

archive/issue_comments_313694.json:
```json
{
    "body": "outdated, should close",
    "created_at": "2021-09-07T08:52:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22768#issuecomment-313694",
    "user": "https://github.com/mkoeppe"
}
```

outdated, should close



---

archive/issue_events_059260.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-09-07T08:52:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22768",
    "milestone": "sage-wishlist",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22768#event-59260"
}
```



---

archive/issue_events_059261.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-09-07T08:52:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22768",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22768#event-59261"
}
```



---

archive/issue_comments_313695.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-09-07T08:52:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22768#issuecomment-313695",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.
