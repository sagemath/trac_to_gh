# Issue 22688: Three.js: no plot if 'nan' occurs in JSON representation

archive/issues_022451.json:
```json
{
    "body": "After the fix of #22553 (which was a much needed improvement over past kludges), I'm seeing `nan`s in the JSON representation of some surfaces that were not present previously. This manifests itself in a failure to render the scene, resulting in a black screen. You can test with this plot:\n\n```\nspherical_plot3d(real(spherical_harmonic(2,1,x,y)),(x,0,pi),(y,0,2*pi),viewer='threejs')\n```\n\nJMol gets the same `nan`s passed to it but still renders this plot, so it has some work around. We can't simply ignore vertices with `nan` because that will throw off the list of faces. Having the rendering fail is not an option.\n\n\nCC:  @novoselt @egourgoulhon @tscrim\n\nBranch/Commit: 35be918d0b17c76a8b08ddb9ea20e025bc24e75f\n\nReviewer: Travis Scrimshaw\n\nAuthor: Fr\u00e9d\u00e9ric Chapoton\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/22688\n\n",
    "closed_at": "2019-10-03T17:58:30Z",
    "created_at": "2017-03-27T01:36:36Z",
    "labels": [
        "component: graphics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.0",
    "title": "Three.js: no plot if 'nan' occurs in JSON representation",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22688",
    "user": "https://github.com/paulmasson"
}
```
After the fix of #22553 (which was a much needed improvement over past kludges), I'm seeing `nan`s in the JSON representation of some surfaces that were not present previously. This manifests itself in a failure to render the scene, resulting in a black screen. You can test with this plot:

```
spherical_plot3d(real(spherical_harmonic(2,1,x,y)),(x,0,pi),(y,0,2*pi),viewer='threejs')
```

JMol gets the same `nan`s passed to it but still renders this plot, so it has some work around. We can't simply ignore vertices with `nan` because that will throw off the list of faces. Having the rendering fail is not an option.


CC:  @novoselt @egourgoulhon @tscrim

Branch/Commit: 35be918d0b17c76a8b08ddb9ea20e025bc24e75f

Reviewer: Travis Scrimshaw

Author: Frédéric Chapoton

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/22688





---

archive/issue_comments_333068.json:
```json
{
    "body": "<a id='comment:1'></a>Possible solutions:\n\n1) set `nan` to zero by default, since the ones I'm seeing are coming from arctan(0/0) around the origin, but that might not be a good overall solution\n\n2) create a popup in the HTML asking the user to modify the input data slightly to avoid singular points\n\n3) implement some amount of randomness in 3D plots just like in 2D plots\n\nThe first is easiest to implement. The third would take appreciable time to get right. And I really don't like the second.",
    "created_at": "2017-03-27T01:42:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22688#issuecomment-333068",
    "user": "https://github.com/paulmasson"
}
```

<a id='comment:1'></a>Possible solutions:

1) set `nan` to zero by default, since the ones I'm seeing are coming from arctan(0/0) around the origin, but that might not be a good overall solution

2) create a popup in the HTML asking the user to modify the input data slightly to avoid singular points

3) implement some amount of randomness in 3D plots just like in 2D plots

The first is easiest to implement. The third would take appreciable time to get right. And I really don't like the second.



---

archive/issue_comments_333069.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -4,7 +4,8 @@\n spherical_plot3d(real(spherical_harmonic(2,1,x,y)),(x,0,pi),(y,0,2*pi),viewer='threejs')\n ```\n \n-JMol gets the same `nan`s passed to it but still renders this plot, so it must be doing something to  work around them. We can't simple ignore vertices with `nan` because that will throw off the list of faces.\n+JMol gets the same `nan`s passed to it but still renders this plot, so it has some work around. We can't simple ignore vertices with `nan` because that will throw off the list of faces. Having the rendering simply fail is not an option.\n+\n \n Comment: 1\n \n```\n",
    "created_at": "2017-03-27T01:42:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22688#issuecomment-333069",
    "user": "https://github.com/paulmasson"
}
```

Description changed:
```diff
--- 
+++ 
@@ -4,7 +4,8 @@
 spherical_plot3d(real(spherical_harmonic(2,1,x,y)),(x,0,pi),(y,0,2*pi),viewer='threejs')
 ```
 
-JMol gets the same `nan`s passed to it but still renders this plot, so it must be doing something to  work around them. We can't simple ignore vertices with `nan` because that will throw off the list of faces.
+JMol gets the same `nan`s passed to it but still renders this plot, so it has some work around. We can't simple ignore vertices with `nan` because that will throw off the list of faces. Having the rendering simply fail is not an option.
+
 
 Comment: 1
 
```




---

archive/issue_comments_333070.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,10 @@\n+After the fix of #22553 (which was a much needed improvement over past kludges), I'm seeing `nan`s in the JSON representation of some surfaces that where not present previously. This manifests itself in a failure to render the scene, resulting in a black screen. You can test with this plot:\n+\n+```\n+spherical_plot3d(real(spherical_harmonic(2,1,x,y)),(x,0,pi),(y,0,2*pi),viewer='threejs')\n+```\n+\n+JMol gets the same `nan`s passed to it but still renders this plot, so it has some work around. We can't simply ignore vertices with `nan` because that will throw off the list of faces. Having the rendering fail is not an option.\n \n \n Comment: 1\n```\n",
    "created_at": "2017-03-27T02:19:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22688#issuecomment-333070",
    "user": "https://github.com/paulmasson"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,10 @@
+After the fix of #22553 (which was a much needed improvement over past kludges), I'm seeing `nan`s in the JSON representation of some surfaces that where not present previously. This manifests itself in a failure to render the scene, resulting in a black screen. You can test with this plot:
+
+```
+spherical_plot3d(real(spherical_harmonic(2,1,x,y)),(x,0,pi),(y,0,2*pi),viewer='threejs')
+```
+
+JMol gets the same `nan`s passed to it but still renders this plot, so it has some work around. We can't simply ignore vertices with `nan` because that will throw off the list of faces. Having the rendering fail is not an option.
 
 
 Comment: 1
```




---

archive/issue_comments_333071.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,10 @@\n+After the fix of #22553 (which was a much needed improvement over past kludges), I'm seeing `nan`s in the JSON representation of some surfaces that were not present previously. This manifests itself in a failure to render the scene, resulting in a black screen. You can test with this plot:\n+\n+```\n+spherical_plot3d(real(spherical_harmonic(2,1,x,y)),(x,0,pi),(y,0,2*pi),viewer='threejs')\n+```\n+\n+JMol gets the same `nan`s passed to it but still renders this plot, so it has some work around. We can't simply ignore vertices with `nan` because that will throw off the list of faces. Having the rendering fail is not an option.\n \n \n Comment: 1\n```\n",
    "created_at": "2017-03-27T02:19:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22688#issuecomment-333071",
    "user": "https://github.com/paulmasson"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,10 @@
+After the fix of #22553 (which was a much needed improvement over past kludges), I'm seeing `nan`s in the JSON representation of some surfaces that were not present previously. This manifests itself in a failure to render the scene, resulting in a black screen. You can test with this plot:
+
+```
+spherical_plot3d(real(spherical_harmonic(2,1,x,y)),(x,0,pi),(y,0,2*pi),viewer='threejs')
+```
+
+JMol gets the same `nan`s passed to it but still renders this plot, so it has some work around. We can't simply ignore vertices with `nan` because that will throw off the list of faces. Having the rendering fail is not an option.
 
 
 Comment: 1
```




---

archive/issue_comments_333072.json:
```json
{
    "body": "<a id='comment:4'></a>Here's an obvious fourth option to replace the second:\n\n4) halt the plot generation upon detection of `nan` with a `RuntimeError` and warn the user of bad data points",
    "created_at": "2017-03-27T19:53:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22688#issuecomment-333072",
    "user": "https://github.com/paulmasson"
}
```

<a id='comment:4'></a>Here's an obvious fourth option to replace the second:

4) halt the plot generation upon detection of `nan` with a `RuntimeError` and warn the user of bad data points



---

archive/issue_comments_333073.json:
```json
{
    "body": "<a id='comment:5'></a>A couple more options are reading some of the JMol source code:\n\n5) detect `nan` before generating the Three.js plot and remove all bad vertices and any faces using them from the JSON representation\n\n6) detect `nan` further upstream where the `IndexFaceSet` is generated, either in the method to produce its JSON representation or before that, and prevent any bad vertices from being added to begin with\n\nThis last one probably makes the most sense from a structural point of view, unless there is a good reason to include bad vertices in an `IndexFaceSet`. Perhaps I should ask that question on sage-devel.",
    "created_at": "2017-03-29T01:36:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22688#issuecomment-333073",
    "user": "https://github.com/paulmasson"
}
```

<a id='comment:5'></a>A couple more options are reading some of the JMol source code:

5) detect `nan` before generating the Three.js plot and remove all bad vertices and any faces using them from the JSON representation

6) detect `nan` further upstream where the `IndexFaceSet` is generated, either in the method to produce its JSON representation or before that, and prevent any bad vertices from being added to begin with

This last one probably makes the most sense from a structural point of view, unless there is a good reason to include bad vertices in an `IndexFaceSet`. Perhaps I should ask that question on sage-devel.



---

archive/issue_events_059124.json:
```json
{
    "actor": "https://github.com/paulmasson",
    "created_at": "2018-11-27T23:17:57Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22688",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22688#event-59124"
}
```



---

archive/issue_comments_333074.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-03-31T23:10:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22688#issuecomment-333074",
    "user": "https://github.com/paulmasson"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_333075.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-03-31T23:10:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22688#issuecomment-333075",
    "user": "https://github.com/paulmasson"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_333076.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2019-03-31T23:28:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22688#issuecomment-333076",
    "user": "https://github.com/paulmasson"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_comments_333077.json:
```json
{
    "body": "<a id='comment:10'></a>works fine in sage 8.9.beta8",
    "created_at": "2019-09-01T16:46:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22688#issuecomment-333077",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:10'></a>works fine in sage 8.9.beta8



---

archive/issue_comments_333078.json:
```json
{
    "body": "Changing status from needs_info to positive_review.",
    "created_at": "2019-09-02T20:39:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22688#issuecomment-333078",
    "user": "https://github.com/paulmasson"
}
```

Changing status from needs_info to positive_review.



---

archive/issue_comments_333079.json:
```json
{
    "body": "<a id='comment:12'></a>Maybe a doctest, or not needed/possible in this case?",
    "created_at": "2019-09-05T01:19:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22688#issuecomment-333079",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:12'></a>Maybe a doctest, or not needed/possible in this case?



---

archive/issue_comments_333080.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-09-19T09:45:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22688#issuecomment-333080",
    "user": "https://github.com/fchapoton"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_events_059125.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2019-09-19T09:45:57Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22688",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22688#event-59125"
}
```



---

archive/issue_events_059126.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2019-09-19T09:45:57Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22688",
    "milestone": "sage-9.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22688#event-59126"
}
```



---

archive/issue_comments_333081.json:
```json
{
    "body": "<a id='comment:13'></a>I am proposing a doctest\n\n---\nNew commits:",
    "created_at": "2019-09-19T09:45:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22688#issuecomment-333081",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:13'></a>I am proposing a doctest

---
New commits:



---

archive/issue_comments_333082.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-09-19T09:46:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22688#issuecomment-333082",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_333083.json:
```json
{
    "body": "<a id='comment:15'></a>and the patchbot is green, please review.",
    "created_at": "2019-09-19T11:39:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22688#issuecomment-333083",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:15'></a>and the patchbot is green, please review.



---

archive/issue_comments_333084.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-09-19T12:17:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22688#issuecomment-333084",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_333085.json:
```json
{
    "body": "<a id='comment:16'></a>LGTM.",
    "created_at": "2019-09-19T12:17:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22688#issuecomment-333085",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:16'></a>LGTM.



---

archive/issue_comments_333086.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-10-03T17:58:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22688#issuecomment-333086",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_059127.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-10-03T17:58:30Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/22688",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22688#event-59127"
}
```
