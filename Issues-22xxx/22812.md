# Issue 22812: correct linking flags and options of gfan

archive/issues_022575.json:
```json
{
    "body": "sometimes LDFLAGS must come first, but in gfan's makefile LDFLAGS are put last. This makes it impossible to build on FreeBSD without extra hack, such as redefining CXX to include LDFLAGS.\n\nWe clean this mess up by making use of special variables (CDD-related) in its makefile, and remove LDFLAGS hack from spkg-install.\n\nCC:  @kiwifb @embray\n\nBranch/Commit: 613c825abc213c3138281fd1d7e94292af22690c\n\nReviewer: Fran\u00e7ois Bissey, Dima Pasechnik\n\nAuthor: Dima Pasechnik, Fran\u00e7ois Bissey\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/22812\n\n",
    "closed_at": "2017-04-23T12:57:33Z",
    "created_at": "2017-04-14T21:51:49Z",
    "labels": [
        "component: porting",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "correct linking flags and options of gfan",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22812",
    "user": "https://github.com/dimpase"
}
```
sometimes LDFLAGS must come first, but in gfan's makefile LDFLAGS are put last. This makes it impossible to build on FreeBSD without extra hack, such as redefining CXX to include LDFLAGS.

We clean this mess up by making use of special variables (CDD-related) in its makefile, and remove LDFLAGS hack from spkg-install.

CC:  @kiwifb @embray

Branch/Commit: 613c825abc213c3138281fd1d7e94292af22690c

Reviewer: François Bissey, Dima Pasechnik

Author: Dima Pasechnik, François Bissey

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/22812





---

archive/issue_comments_428491.json:
```json
{
    "body": "<a id='comment:1'></a>\nDoes this work OK on OSX and Cygwin?",
    "created_at": "2017-04-14T21:54:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22812#issuecomment-428491",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:1'></a>
Does this work OK on OSX and Cygwin?



---

archive/issue_comments_428492.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-04-14T21:54:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22812#issuecomment-428492",
    "user": "https://github.com/dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_events_067455.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/22812",
    "rename": {
        "from": "correct linking flags of gfan",
        "to": "correct linking flags and options of gfan"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22812#event-67455"
}
```



---

archive/issue_comments_428493.json:
```json
{
    "body": "<a id='comment:2'></a>\nI don't see why not. Your new patch is more invasive than the previous one for no visible reason (to me)\n\n```\n-ifeq ($(cddpath),)\n-CDD_LINKOPTIONS = -L/usr/local -lcddgmp\n+CDD_LINKOPTIONS = -L$SAGE_LOCAL/lib -lcddgmp -lgmp -lm\n CDD_INCLUDEOPTIONS =\n-else\n-CDD_LINKOPTIONS = $(cddpath)/lib/libcddgmp.a\n-CDD_INCLUDEOPTIONS = -I $(cddpath)/include\n-endif\n```\nWhy do you need the above? The malformed is not a big problem. I guess a bigger problem is if the variable `LIBRARY_PATH` is not used with clang on freeBSD. But then I would expect you to have trouble in other places.",
    "created_at": "2017-04-19T03:29:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22812#issuecomment-428493",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:2'></a>
I don't see why not. Your new patch is more invasive than the previous one for no visible reason (to me)

```
-ifeq ($(cddpath),)
-CDD_LINKOPTIONS = -L/usr/local -lcddgmp
+CDD_LINKOPTIONS = -L$SAGE_LOCAL/lib -lcddgmp -lgmp -lm
 CDD_INCLUDEOPTIONS =
-else
-CDD_LINKOPTIONS = $(cddpath)/lib/libcddgmp.a
-CDD_INCLUDEOPTIONS = -I $(cddpath)/include
-endif
```
Why do you need the above? The malformed is not a big problem. I guess a bigger problem is if the variable `LIBRARY_PATH` is not used with clang on freeBSD. But then I would expect you to have trouble in other places.



---

archive/issue_comments_428494.json:
```json
{
    "body": "<a id='comment:3'></a>\nReplying to [fbissey](#comment%3A2):\n> I don't see why not. Your new patch is more invasive than the previous one for no visible reason (to me)\n\n\nWell, if you mean to say that I should leave the `else` part, which is never triggered under Sage, intact, I certainly can do this. (Although I see no harm in removing things which are not used).\n\n> {{{\n> -ifeq ($(cddpath),)\n> -CDD_LINKOPTIONS = -L/usr/local -lcddgmp\n> +CDD_LINKOPTIONS = -L$SAGE_LOCAL/lib -lcddgmp -lgmp -lm\n>  CDD_INCLUDEOPTIONS =\n> -else\n> -CDD_LINKOPTIONS = $(cddpath)/lib/libcddgmp.a\n> -CDD_INCLUDEOPTIONS = -I $(cddpath)/include\n> -endif\n> }}}\n> Why do you need the above? The malformed is not a big problem. I guess a bigger problem is if the variable `LIBRARY_PATH` is not used with clang on freeBSD. But then I would expect you to have trouble in other places.\n\n\nApart from the `if/else` thing (as I said, I can leave it in), this is done to clean up the flags a bit; presently that\n`-L/usr/local -lcddgmp` is worked around in `spkg-install`, basically by appending the correct `-L$SAGE_LOCAL/lib -lcddgmp -lgmp -lm` to `LDFLAGS` (the latter are appended in the makefile). I cannot keep doing this, I really need `LDFLAGS` in front, for this to work.\n\nBesides, needless to say, if you really happen to have `libcddgmp` in `/usr/local/`, all the bets are off, you might end up with a linker error, or worse.\n\nI could have plugged `LDFLAGS` into the 1st position into the right line of of the makefile, and leave the rest as it is, but this is ugly IMHO.",
    "created_at": "2017-04-19T07:33:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22812#issuecomment-428494",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:3'></a>
Replying to [fbissey](#comment%3A2):
> I don't see why not. Your new patch is more invasive than the previous one for no visible reason (to me)


Well, if you mean to say that I should leave the `else` part, which is never triggered under Sage, intact, I certainly can do this. (Although I see no harm in removing things which are not used).

> {{{
> -ifeq ($(cddpath),)
> -CDD_LINKOPTIONS = -L/usr/local -lcddgmp
> +CDD_LINKOPTIONS = -L$SAGE_LOCAL/lib -lcddgmp -lgmp -lm
>  CDD_INCLUDEOPTIONS =
> -else
> -CDD_LINKOPTIONS = $(cddpath)/lib/libcddgmp.a
> -CDD_INCLUDEOPTIONS = -I $(cddpath)/include
> -endif
> }}}
> Why do you need the above? The malformed is not a big problem. I guess a bigger problem is if the variable `LIBRARY_PATH` is not used with clang on freeBSD. But then I would expect you to have trouble in other places.


Apart from the `if/else` thing (as I said, I can leave it in), this is done to clean up the flags a bit; presently that
`-L/usr/local -lcddgmp` is worked around in `spkg-install`, basically by appending the correct `-L$SAGE_LOCAL/lib -lcddgmp -lgmp -lm` to `LDFLAGS` (the latter are appended in the makefile). I cannot keep doing this, I really need `LDFLAGS` in front, for this to work.

Besides, needless to say, if you really happen to have `libcddgmp` in `/usr/local/`, all the bets are off, you might end up with a linker error, or worse.

I could have plugged `LDFLAGS` into the 1st position into the right line of of the makefile, and leave the rest as it is, but this is ugly IMHO.



---

archive/issue_comments_428495.json:
```json
{
    "body": "<a id='comment:4'></a>\nOK, but the only thing you really need to do is remove `-L/usr/local` the rest is under control. Adding `-lgmp` is not useful as it is already provided by `GMP_LINKOPTIONS`. If you really need to add `-lm` because of some system where dynamical linking is foobar, add it at the end of `GMP_LINKOPTIONS`.",
    "created_at": "2017-04-19T07:41:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22812#issuecomment-428495",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:4'></a>
OK, but the only thing you really need to do is remove `-L/usr/local` the rest is under control. Adding `-lgmp` is not useful as it is already provided by `GMP_LINKOPTIONS`. If you really need to add `-lm` because of some system where dynamical linking is foobar, add it at the end of `GMP_LINKOPTIONS`.



---

archive/issue_comments_428496.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [fbissey](#comment%3A4):\n> OK, but the only thing you really need to do is remove `-L/usr/local` the rest is under control. Adding `-lgmp` is not useful as it is already provided by `GMP_LINKOPTIONS`. If you really need to add `-lm` because of some system where dynamical linking is foobar, add it at the end of `GMP_LINKOPTIONS`.\n\n\nI merely move adding `-lm`, needed on other systems, not only FreeBSD, from `spkg-install` to the makefile directly. \n\n```\n-# set LDFLAGS with proper flags to link against gmp/mpir and cddlib\n-LDFLAGS=\"-L$SAGE_LOCAL/lib -lcddgmp -lgmp -lm $LDFLAGS\"\n```\n\nIf you think that all this can be done better, please do a branch...",
    "created_at": "2017-04-19T07:50:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22812#issuecomment-428496",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:5'></a>
Replying to [fbissey](#comment%3A4):
> OK, but the only thing you really need to do is remove `-L/usr/local` the rest is under control. Adding `-lgmp` is not useful as it is already provided by `GMP_LINKOPTIONS`. If you really need to add `-lm` because of some system where dynamical linking is foobar, add it at the end of `GMP_LINKOPTIONS`.


I merely move adding `-lm`, needed on other systems, not only FreeBSD, from `spkg-install` to the makefile directly. 

```
-# set LDFLAGS with proper flags to link against gmp/mpir and cddlib
-LDFLAGS="-L$SAGE_LOCAL/lib -lcddgmp -lgmp -lm $LDFLAGS"
```

If you think that all this can be done better, please do a branch...



---

archive/issue_comments_428497.json:
```json
{
    "body": "<a id='comment:6'></a>\nThere are several way to skin a cat as they say, I go for either minimal or complete revamp - which would feel nice here. Quite a number of things have moved since the original `spkg-install` making it easier to be minimalistic.\n\nI'll do a branch...",
    "created_at": "2017-04-19T07:53:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22812#issuecomment-428497",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:6'></a>
There are several way to skin a cat as they say, I go for either minimal or complete revamp - which would feel nice here. Quite a number of things have moved since the original `spkg-install` making it easier to be minimalistic.

I'll do a branch...



---

archive/issue_comments_428498.json:
```json
{
    "body": "Changing branch from \"u/dimpase/ldflagsord\" to \"u/fbissey/ldflagsord\"",
    "created_at": "2017-04-19T23:32:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22812#issuecomment-428498",
    "user": "https://github.com/kiwifb"
}
```

Changing branch from "u/dimpase/ldflagsord" to "u/fbissey/ldflagsord"



---

archive/issue_comments_428499.json:
```json
{
    "body": "<a id='comment:7'></a>\nI invite you to test my small changes on my branch. I kept 90% of your changes, I only changed the `Makefile` patch with what I think is necessary. \n\n---\nNew commits:\n|                                                                                                                                          |                            |\n|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------|\n|[1b21e86](https://github.com/sagemath/sagetrac-mirror/commit/1b21e8630fc92d114e830bd3cfefd9251acd568b)|`Minimal change to Makefile`|",
    "created_at": "2017-04-19T23:32:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22812#issuecomment-428499",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:7'></a>
I invite you to test my small changes on my branch. I kept 90% of your changes, I only changed the `Makefile` patch with what I think is necessary. 

---
New commits:
|                                                                                                                                          |                            |
|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------|
|[1b21e86](https://github.com/sagemath/sagetrac-mirror/commit/1b21e8630fc92d114e830bd3cfefd9251acd568b)|`Minimal change to Makefile`|



---

archive/issue_comments_428500.json:
```json
{
    "body": "Changing commit from \"2d30f4911305c6ab3f17bb4146671a5d93c6fe55\" to \"1b21e8630fc92d114e830bd3cfefd9251acd568b\"",
    "created_at": "2017-04-19T23:32:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22812#issuecomment-428500",
    "user": "https://github.com/kiwifb"
}
```

Changing commit from "2d30f4911305c6ab3f17bb4146671a5d93c6fe55" to "1b21e8630fc92d114e830bd3cfefd9251acd568b"



---

archive/issue_comments_428501.json:
```json
{
    "body": "Changing author from \"Dima Pasechnik\" to \"Dima Pasechnik, Fran\u00e7ois Bissey\"",
    "created_at": "2017-04-20T11:30:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22812#issuecomment-428501",
    "user": "https://github.com/dimpase"
}
```

Changing author from "Dima Pasechnik" to "Dima Pasechnik, François Bissey"



---

archive/issue_comments_428502.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Fran\u00e7ois Bissey, Dima Pasechnik\"",
    "created_at": "2017-04-20T11:30:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22812#issuecomment-428502",
    "user": "https://github.com/dimpase"
}
```

Changing reviewer from "" to "François Bissey, Dima Pasechnik"



---

archive/issue_comments_428503.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2017-04-20T11:30:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22812#issuecomment-428503",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_428504.json:
```json
{
    "body": "<a id='comment:8'></a>\nlooks good to me. Should we  bump the package version too?",
    "created_at": "2017-04-20T11:30:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22812#issuecomment-428504",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:8'></a>
looks good to me. Should we  bump the package version too?



---

archive/issue_comments_428505.json:
```json
{
    "body": "Changing status from needs_info to positive_review.",
    "created_at": "2017-04-20T11:42:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22812#issuecomment-428505",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_info to positive_review.



---

archive/issue_comments_428506.json:
```json
{
    "body": "Changing commit from \"1b21e8630fc92d114e830bd3cfefd9251acd568b\" to \"613c825abc213c3138281fd1d7e94292af22690c\"",
    "created_at": "2017-04-20T11:42:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22812#issuecomment-428506",
    "user": "https://github.com/dimpase"
}
```

Changing commit from "1b21e8630fc92d114e830bd3cfefd9251acd568b" to "613c825abc213c3138281fd1d7e94292af22690c"



---

archive/issue_comments_428507.json:
```json
{
    "body": "Changing branch from \"u/fbissey/ldflagsord\" to \"u/dimpase/ldflagsord\"",
    "created_at": "2017-04-20T11:42:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22812#issuecomment-428507",
    "user": "https://github.com/dimpase"
}
```

Changing branch from "u/fbissey/ldflagsord" to "u/dimpase/ldflagsord"



---

archive/issue_comments_428508.json:
```json
{
    "body": "<a id='comment:10'></a>\nJeroen always wants to bump. I am not always thrilled by it, but it certainly means more testing, which is his point.",
    "created_at": "2017-04-20T12:37:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22812#issuecomment-428508",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:10'></a>
Jeroen always wants to bump. I am not always thrilled by it, but it certainly means more testing, which is his point.



---

archive/issue_events_067456.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-04-23T12:57:33Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/22812",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22812#event-67456"
}
```



---

archive/issue_comments_428509.json:
```json
{
    "body": "Changing branch from \"u/dimpase/ldflagsord\" to \"613c825abc213c3138281fd1d7e94292af22690c\"",
    "created_at": "2017-04-23T12:57:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22812#issuecomment-428509",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/dimpase/ldflagsord" to "613c825abc213c3138281fd1d7e94292af22690c"



---

archive/issue_comments_428510.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-04-23T12:57:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22812#issuecomment-428510",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
