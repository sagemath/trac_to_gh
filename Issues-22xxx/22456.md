# Issue 22456: LatticePoset: Add subdirect decomposition

archive/issues_022219.json:
```json
{
    "body": "Add a function that computes the subdirect decomposition of a lattice.\n\nCC:  @mantepse @tscrim\n\nBranch/Commit: [3c8d86af00bd5ec2345059be0c1b7a29dafc3cc0](https://github.com/sagemath/sagetrac-mirror/commit/3c8d86af00bd5ec2345059be0c1b7a29dafc3cc0)\n\nReviewer: Travis Scrimshaw\n\nAuthor: Jori M\u00e4ntysalo\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/22456\n\n",
    "closed_at": "2017-03-27T20:42:21Z",
    "created_at": "2017-02-27T03:51:06Z",
    "labels": [
        "component: combinatorics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "LatticePoset: Add subdirect decomposition",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22456",
    "user": "https://github.com/jm58660"
}
```
Add a function that computes the subdirect decomposition of a lattice.

CC:  @mantepse @tscrim

Branch/Commit: [3c8d86af00bd5ec2345059be0c1b7a29dafc3cc0](https://github.com/sagemath/sagetrac-mirror/commit/3c8d86af00bd5ec2345059be0c1b7a29dafc3cc0)

Reviewer: Travis Scrimshaw

Author: Jori MÃ¤ntysalo

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/22456





---

archive/issue_comments_419649.json:
```json
{
    "body": "Changing branch from \"\" to \"u/jmantysalo/latticeposet__add_subdirect_decomposition\"",
    "created_at": "2017-02-27T08:12:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22456#issuecomment-419649",
    "user": "https://github.com/jm58660"
}
```

Changing branch from "" to "u/jmantysalo/latticeposet__add_subdirect_decomposition"



---

archive/issue_comments_419650.json:
```json
{
    "body": "Changing commit from \"\" to \"65f4c8c59d7a0f3ee84f55a6ad1ebe5aa020d97f\"",
    "created_at": "2017-02-27T08:14:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22456#issuecomment-419650",
    "user": "https://github.com/jm58660"
}
```

Changing commit from "" to "65f4c8c59d7a0f3ee84f55a6ad1ebe5aa020d97f"



---

archive/issue_comments_419651.json:
```json
{
    "body": "<a id='comment:2'></a>\nSome test code:\n\n```\nset_random_seed(321)\nN = 100\n\nfor i in range(N):\n    L = Posets.RandomLattice(randint(10, 20), 0.997)\n    Ld = L.subdirect_decomposition()\n\n    if not L.is_subdirectly_reducible():\n        if len(Ld) != 1:\n            print(\"Error 1\")\n            raise AssertionError\n\n    else:\n        for Lf in Ld:\n            if Lf.is_subdirectly_reducible():\n                print(\"Error 2\")\n                raise AssertionError\n\n        Lp = LatticePoset({0: []})\n        for Lf in Ld:\n            Lp = Lp.product(Lf)\n        try:\n            next(Lp.isomorphic_sublattices_iterator(L))\n        except StopIteration:\n            print(\"Error 3\")\n            raise AssertionError\n\nfor i in range(N):\n    Lp = LatticePoset({0: []})\n    for j in range(3):\n        L = Posets.ChainPoset(3)\n        while L.is_subdirectly_reducible():\n            L = Posets.RandomLattice(7, 0.98)\n        Lp = Lp.product(L)\n    if len(Lp.subdirect_decomposition()) != 3:\n        raise AssertionError\n\nprint(\"Seems to work\")\n```\n\n---\nNew commits:\n|                                                                                                                                          |                                |\n|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------|\n|[65f4c8c](https://github.com/sagemath/sagetrac-mirror/commit/65f4c8c59d7a0f3ee84f55a6ad1ebe5aa020d97f)|`Add subdirect_decomposition().`|",
    "created_at": "2017-02-27T08:14:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22456#issuecomment-419651",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:2'></a>
Some test code:

```
set_random_seed(321)
N = 100

for i in range(N):
    L = Posets.RandomLattice(randint(10, 20), 0.997)
    Ld = L.subdirect_decomposition()

    if not L.is_subdirectly_reducible():
        if len(Ld) != 1:
            print("Error 1")
            raise AssertionError

    else:
        for Lf in Ld:
            if Lf.is_subdirectly_reducible():
                print("Error 2")
                raise AssertionError

        Lp = LatticePoset({0: []})
        for Lf in Ld:
            Lp = Lp.product(Lf)
        try:
            next(Lp.isomorphic_sublattices_iterator(L))
        except StopIteration:
            print("Error 3")
            raise AssertionError

for i in range(N):
    Lp = LatticePoset({0: []})
    for j in range(3):
        L = Posets.ChainPoset(3)
        while L.is_subdirectly_reducible():
            L = Posets.RandomLattice(7, 0.98)
        Lp = Lp.product(L)
    if len(Lp.subdirect_decomposition()) != 3:
        raise AssertionError

print("Seems to work")
```

---
New commits:
|                                                                                                                                          |                                |
|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------|
|[65f4c8c](https://github.com/sagemath/sagetrac-mirror/commit/65f4c8c59d7a0f3ee84f55a6ad1ebe5aa020d97f)|`Add subdirect_decomposition().`|



---

archive/issue_comments_419652.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-02-27T08:14:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22456#issuecomment-419652",
    "user": "https://github.com/jm58660"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_419653.json:
```json
{
    "body": "Changing commit from \"65f4c8c59d7a0f3ee84f55a6ad1ebe5aa020d97f\" to \"a55cc6eeb125b37b7a4327a4943e986ad1bcfd49\"",
    "created_at": "2017-03-06T08:24:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22456#issuecomment-419653",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "65f4c8c59d7a0f3ee84f55a6ad1ebe5aa020d97f" to "a55cc6eeb125b37b7a4327a4943e986ad1bcfd49"



---

archive/issue_comments_419654.json:
```json
{
    "body": "<a id='comment:3'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                               |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------|\n|[a55cc6e](https://github.com/sagemath/sagetrac-mirror/commit/a55cc6eeb125b37b7a4327a4943e986ad1bcfd49)|`Merge branch 'develop' into t/22456/latticeposet__add_subdirect_decomposition`|",
    "created_at": "2017-03-06T08:24:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22456#issuecomment-419654",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                               |
|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------|
|[a55cc6e](https://github.com/sagemath/sagetrac-mirror/commit/a55cc6eeb125b37b7a4327a4943e986ad1bcfd49)|`Merge branch 'develop' into t/22456/latticeposet__add_subdirect_decomposition`|



---

archive/issue_comments_419655.json:
```json
{
    "body": "<a id='comment:4'></a>\nLGTM modulo this little change:\n\n```diff\n             low = L.lower_covers(e)\n             if len(low) == 1:  # a join-irreducible element\n-                C[e] = congs[max(e, key=lambda x: cong_ji._element_to_vertex(x))]\n-            if len(low) > 1:  # \"extending\" congruence to avoid re-computation\n+                C[e] = congs[max(e, key=cong_ji._element_to_vertex)]\n+            elif low:  # \"extending\" congruence to avoid re-computation\n                 low_0 = min(low, key=lambda x: C[x].number_of_subsets())\n                 for new_pair in e:\n```",
    "created_at": "2017-03-19T08:06:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22456#issuecomment-419655",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:4'></a>
LGTM modulo this little change:

```diff
             low = L.lower_covers(e)
             if len(low) == 1:  # a join-irreducible element
-                C[e] = congs[max(e, key=lambda x: cong_ji._element_to_vertex(x))]
-            if len(low) > 1:  # "extending" congruence to avoid re-computation
+                C[e] = congs[max(e, key=cong_ji._element_to_vertex)]
+            elif low:  # "extending" congruence to avoid re-computation
                 low_0 = min(low, key=lambda x: C[x].number_of_subsets())
                 for new_pair in e:
```



---

archive/issue_comments_419656.json:
```json
{
    "body": "Changing commit from \"a55cc6eeb125b37b7a4327a4943e986ad1bcfd49\" to \"680628695b486702af7f8136c14bc6f7ab7b600e\"",
    "created_at": "2017-03-19T08:20:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22456#issuecomment-419656",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "a55cc6eeb125b37b7a4327a4943e986ad1bcfd49" to "680628695b486702af7f8136c14bc6f7ab7b600e"



---

archive/issue_comments_419657.json:
```json
{
    "body": "<a id='comment:5'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                    |\n|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------|\n|[6806286](https://github.com/sagemath/sagetrac-mirror/commit/680628695b486702af7f8136c14bc6f7ab7b600e)|`Minor code change.`|",
    "created_at": "2017-03-19T08:20:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22456#issuecomment-419657",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                    |
|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------|
|[6806286](https://github.com/sagemath/sagetrac-mirror/commit/680628695b486702af7f8136c14bc6f7ab7b600e)|`Minor code change.`|



---

archive/issue_comments_419658.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-03-19T08:33:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22456#issuecomment-419658",
    "user": "https://github.com/jm58660"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_419659.json:
```json
{
    "body": "<a id='comment:6'></a>\nReplying to [tscrim](#comment%3A4):\n\n```\nC[e] = congs[max(e, key=cong_ji._element_to_vertex)]\n```\n\nGood point, I didn't notice this one.\n\n```\nelif low:  # \"extending\" congruence to avoid re-computation\n```\n\nWell, OK. Not sure if minimal speedup is worth slightly harder code to understand, `len(x) == 1` and `len(x) > 1` is cleaner solution.\n\nCompiling and testing, so not ready for review just now.",
    "created_at": "2017-03-19T08:33:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22456#issuecomment-419659",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:6'></a>
Replying to [tscrim](#comment%3A4):

```
C[e] = congs[max(e, key=cong_ji._element_to_vertex)]
```

Good point, I didn't notice this one.

```
elif low:  # "extending" congruence to avoid re-computation
```

Well, OK. Not sure if minimal speedup is worth slightly harder code to understand, `len(x) == 1` and `len(x) > 1` is cleaner solution.

Compiling and testing, so not ready for review just now.



---

archive/issue_comments_419660.json:
```json
{
    "body": "<a id='comment:7'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                 |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------|\n|[3c8d86a](https://github.com/sagemath/sagetrac-mirror/commit/3c8d86af00bd5ec2345059be0c1b7a29dafc3cc0)|`A typo in code.`|",
    "created_at": "2017-03-19T17:09:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22456#issuecomment-419660",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                 |
|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------|
|[3c8d86a](https://github.com/sagemath/sagetrac-mirror/commit/3c8d86af00bd5ec2345059be0c1b7a29dafc3cc0)|`A typo in code.`|



---

archive/issue_comments_419661.json:
```json
{
    "body": "Changing commit from \"680628695b486702af7f8136c14bc6f7ab7b600e\" to \"3c8d86af00bd5ec2345059be0c1b7a29dafc3cc0\"",
    "created_at": "2017-03-19T17:09:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22456#issuecomment-419661",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "680628695b486702af7f8136c14bc6f7ab7b600e" to "3c8d86af00bd5ec2345059be0c1b7a29dafc3cc0"



---

archive/issue_comments_419662.json:
```json
{
    "body": "<a id='comment:8'></a>\nNow ready.",
    "created_at": "2017-03-19T17:11:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22456#issuecomment-419662",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:8'></a>
Now ready.



---

archive/issue_comments_419663.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-03-19T17:11:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22456#issuecomment-419663",
    "user": "https://github.com/jm58660"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_events_066786.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2017-03-19T20:20:48Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22456",
    "milestone": "sage-8.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22456#event-66786"
}
```



---

archive/issue_comments_419664.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Travis Scrimshaw\"",
    "created_at": "2017-03-19T20:20:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22456#issuecomment-419664",
    "user": "https://github.com/tscrim"
}
```

Changing reviewer from "" to "Travis Scrimshaw"



---

archive/issue_comments_419665.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-03-19T20:20:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22456#issuecomment-419665",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_419666.json:
```json
{
    "body": "<a id='comment:9'></a>\nLooks good, thank you.",
    "created_at": "2017-03-19T20:20:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22456#issuecomment-419666",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:9'></a>
Looks good, thank you.



---

archive/issue_comments_419667.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-03-27T20:42:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22456#issuecomment-419667",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_419668.json:
```json
{
    "body": "Changing branch from \"u/jmantysalo/latticeposet__add_subdirect_decomposition\" to \"3c8d86af00bd5ec2345059be0c1b7a29dafc3cc0\"",
    "created_at": "2017-03-27T20:42:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22456#issuecomment-419668",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/jmantysalo/latticeposet__add_subdirect_decomposition" to "3c8d86af00bd5ec2345059be0c1b7a29dafc3cc0"



---

archive/issue_events_066787.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-03-27T20:42:21Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/22456",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22456#event-66787"
}
```
