# Issue 22957: Faster implementation for has_perfect_matching

archive/issues_022720.json:
```json
{
    "body": "This ticket is a quick follow-up of #22898.\n\nThe implementation of `has_perfect_matching` in #22898 is very inneficient, since it relies on a brute force search of all possible matchings until it finds one (can take an exponential time).\n\nTry with, e.g.:\n\n```\nsage: R = graphs.RandomBipartite(1000, 1000, 1/100)\nsage: R.has_perfect_matching()\n```\n\nEdmonds algorithm finds a maximal matching in polynomial time, then it suffices to check whether it has |V|/2 edges. LP solvers are pretty fast too.\n\n\n\nCC:  @dcoudert @dkrenn @mkoeppe\n\nBranch/Commit: 3bde4310febdd6bd3bb0b1d65b9056e40d14a306\n\nReviewer: David Coudert, Daniel Krenn\n\nAuthor: Thierry Monteil\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/22957\n\n",
    "closed_at": "2017-05-16T22:21:58Z",
    "created_at": "2017-05-07T16:43:54Z",
    "labels": [
        "component: graph theory"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "Faster implementation for has_perfect_matching",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22957",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```
This ticket is a quick follow-up of #22898.

The implementation of `has_perfect_matching` in #22898 is very inneficient, since it relies on a brute force search of all possible matchings until it finds one (can take an exponential time).

Try with, e.g.:

```
sage: R = graphs.RandomBipartite(1000, 1000, 1/100)
sage: R.has_perfect_matching()
```

Edmonds algorithm finds a maximal matching in polynomial time, then it suffices to check whether it has |V|/2 edges. LP solvers are pretty fast too.



CC:  @dcoudert @dkrenn @mkoeppe

Branch/Commit: 3bde4310febdd6bd3bb0b1d65b9056e40d14a306

Reviewer: David Coudert, Daniel Krenn

Author: Thierry Monteil

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/22957





---

archive/issue_comments_429446.json:
```json
{
    "body": "Changing branch from \"\" to \"u/tmonteil/faster_implementation_for_has_perfect_matching\"",
    "created_at": "2017-05-07T17:19:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429446",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Changing branch from "" to "u/tmonteil/faster_implementation_for_has_perfect_matching"



---

archive/issue_comments_429447.json:
```json
{
    "body": "<a id='comment:2'></a>Note that for the LP formulation, there is a simpler (perhaps faster) formulation for perfect matching which does not rely on maximal matching. However, this ticket is basically a quick fix for #22898 which hangs too often.\n\n---\nNew commits:",
    "created_at": "2017-05-07T17:32:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429447",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:2'></a>Note that for the LP formulation, there is a simpler (perhaps faster) formulation for perfect matching which does not rely on maximal matching. However, this ticket is basically a quick fix for #22898 which hangs too often.

---
New commits:



---

archive/issue_comments_429448.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -9,6 +9,6 @@\n sage: R.has_perfect_matching()\n ```\n \n-Edmonds algorithm finds a maximal matching in polynomial time, then it suffices to check whether it has n/2 edges.\n+Edmonds algorithm finds a maximal matching in polynomial time, then it suffices to check whether it has |V|/2 edges. LP solvers are pretty fast too.\n \n \n``````\n",
    "created_at": "2017-05-07T17:32:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429448",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -9,6 +9,6 @@
 sage: R.has_perfect_matching()
 ```
 
-Edmonds algorithm finds a maximal matching in polynomial time, then it suffices to check whether it has n/2 edges.
+Edmonds algorithm finds a maximal matching in polynomial time, then it suffices to check whether it has |V|/2 edges. LP solvers are pretty fast too.
 
 
``````




---

archive/issue_comments_429449.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-05-07T17:32:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429449",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_429450.json:
```json
{
    "body": "Changing commit from \"\" to \"e3ee8828ba86c70eacc30cae7ae2895f34bc3990\"",
    "created_at": "2017-05-07T17:32:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429450",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Changing commit from "" to "e3ee8828ba86c70eacc30cae7ae2895f34bc3990"



---

archive/issue_comments_429451.json:
```json
{
    "body": "<a id='comment:3'></a>Passes all tests and is effectively much faster. Good to go.\n\nWhich LP formulation have you in mind ?",
    "created_at": "2017-05-07T18:43:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429451",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:3'></a>Passes all tests and is effectively much faster. Good to go.

Which LP formulation have you in mind ?



---

archive/issue_comments_429452.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-05-07T18:43:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429452",
    "user": "https://github.com/dcoudert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_429453.json:
```json
{
    "body": "Changing reviewer from \"\" to \"David Coudert\"",
    "created_at": "2017-05-07T18:43:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429453",
    "user": "https://github.com/dcoudert"
}
```

Changing reviewer from "" to "David Coudert"



---

archive/issue_comments_429454.json:
```json
{
    "body": "<a id='comment:4'></a>Replying to [dcoudert](#comment%3A3):\n> Passes all tests and is effectively much faster. Good to go.\n> \n> Which LP formulation have you in mind ?\n\n\nThe straightforward one : put binary variables on the edges, and for each vertex, the sum of the edges incident to it is 1, no objective. I just implemented it, and it is significantly faster than the one using the `matching` method, let me add it to avoid a new ticket.",
    "created_at": "2017-05-07T20:10:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429454",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:4'></a>Replying to [dcoudert](#comment%3A3):
> Passes all tests and is effectively much faster. Good to go.
> 
> Which LP formulation have you in mind ?


The straightforward one : put binary variables on the edges, and for each vertex, the sum of the edges incident to it is 1, no objective. I just implemented it, and it is significantly faster than the one using the `matching` method, let me add it to avoid a new ticket.



---

archive/issue_comments_429455.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-05-07T20:10:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429455",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_429456.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-07T20:11:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429456",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_429457.json:
```json
{
    "body": "Changing commit from \"e3ee8828ba86c70eacc30cae7ae2895f34bc3990\" to \"841850bf34d64cf6721ce25a27f7c51aaa2864db\"",
    "created_at": "2017-05-07T20:11:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429457",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "e3ee8828ba86c70eacc30cae7ae2895f34bc3990" to "841850bf34d64cf6721ce25a27f7c51aaa2864db"



---

archive/issue_comments_429458.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-05-07T20:18:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429458",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_429459.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-05-07T20:27:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429459",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_429460.json:
```json
{
    "body": "<a id='comment:7'></a>OK, sorry again, actually, both formulations have good and bad instances, so let me allow both (but it requires some documentation to explain).",
    "created_at": "2017-05-07T20:27:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429460",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:7'></a>OK, sorry again, actually, both formulations have good and bad instances, so let me allow both (but it requires some documentation to explain).



---

archive/issue_comments_429461.json:
```json
{
    "body": "<a id='comment:8'></a>The proposed LP is roughly the same (no weight, no minimization, just feasibility), but its focused so interesting.\n\nCplex is usually very fast to say that the problem is unfeasible, but Cplex remains a mystery and it's not easy to say which instance is the best.\n\n```\nsage: G = graphs.CycleGraph(500)\nsage: %time L = G.matching(algorithm='LP')\nCPU times: user 30.7 ms, sys: 2.33 ms, total: 33 ms\nWall time: 28.1 ms\nsage: %time G.has_perfect_matching(algorithm='LP')\nCPU times: user 33.5 ms, sys: 2.18 ms, total: 35.7 ms\nWall time: 34.7 ms\nTrue\nsage: G = graphs.CycleGraph(501)\nsage: %time L = G.matching(algorithm='LP')\nCPU times: user 31.2 ms, sys: 2.35 ms, total: 33.6 ms\nWall time: 28.3 ms\nsage: %time G.has_perfect_matching(algorithm='LP')\nCPU times: user 34.6 ms, sys: 2.33 ms, total: 36.9 ms\nWall time: 35.8 ms\nFalse\nsage: G = graphs.RandomGNP(1000, .1)\nsage: %time L = G.matching(algorithm='LP')\nCPU times: user 4.02 s, sys: 440 ms, total: 4.46 s\nWall time: 3.02 s\nsage: %time G.has_perfect_matching(algorithm='LP')\nCPU times: user 1.95 s, sys: 97.5 ms, total: 2.05 s\nWall time: 2.02 s\nTrue\n```",
    "created_at": "2017-05-07T20:33:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429461",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:8'></a>The proposed LP is roughly the same (no weight, no minimization, just feasibility), but its focused so interesting.

Cplex is usually very fast to say that the problem is unfeasible, but Cplex remains a mystery and it's not easy to say which instance is the best.

```
sage: G = graphs.CycleGraph(500)
sage: %time L = G.matching(algorithm='LP')
CPU times: user 30.7 ms, sys: 2.33 ms, total: 33 ms
Wall time: 28.1 ms
sage: %time G.has_perfect_matching(algorithm='LP')
CPU times: user 33.5 ms, sys: 2.18 ms, total: 35.7 ms
Wall time: 34.7 ms
True
sage: G = graphs.CycleGraph(501)
sage: %time L = G.matching(algorithm='LP')
CPU times: user 31.2 ms, sys: 2.35 ms, total: 33.6 ms
Wall time: 28.3 ms
sage: %time G.has_perfect_matching(algorithm='LP')
CPU times: user 34.6 ms, sys: 2.33 ms, total: 36.9 ms
Wall time: 35.8 ms
False
sage: G = graphs.RandomGNP(1000, .1)
sage: %time L = G.matching(algorithm='LP')
CPU times: user 4.02 s, sys: 440 ms, total: 4.46 s
Wall time: 3.02 s
sage: %time G.has_perfect_matching(algorithm='LP')
CPU times: user 1.95 s, sys: 97.5 ms, total: 2.05 s
Wall time: 2.02 s
True
```



---

archive/issue_comments_429462.json:
```json
{
    "body": "Changing commit from \"841850bf34d64cf6721ce25a27f7c51aaa2864db\" to \"27f66e6b85f7cc5159be1524aa21064ef9fccddb\"",
    "created_at": "2017-05-07T21:43:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429462",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "841850bf34d64cf6721ce25a27f7c51aaa2864db" to "27f66e6b85f7cc5159be1524aa21064ef9fccddb"



---

archive/issue_comments_429463.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-07T21:43:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429463",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_429464.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-05-07T21:54:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429464",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_429465.json:
```json
{
    "body": "<a id='comment:10'></a>The LP formulations look similar, but the polytopes are very different (in particular, the LP_matching one is kind of \"relaxed\" and always has integer points). I am not specialist at all, but there might be some theoretical results on which shapes are better handled by which solver strategies (perhaps Matthias can tell more about this).\n\nHere, the best strategy seems to depend on the solver (i do not have Cplex installed):\n\n```\nsage: G = graphs.RandomBipartite(1000, 1000, 1/100)\nsage: %time G.has_perfect_matching(algorithm='LP_matching', solver='Glpk')\nCPU times: user 2.54 s, sys: 16 ms, total: 2.56 s\nWall time: 2.51 s\nTrue\nsage: %time G.has_perfect_matching(algorithm='LP', solver='Glpk')\nCPU times: user 2 s, sys: 8 ms, total: 2.01 s\nWall time: 1.97 s\nTrue\n\nsage: %time G.has_perfect_matching(algorithm='LP', solver='Coin')\nCPU times: user 5.27 s, sys: 48 ms, total: 5.32 s\nWall time: 5.26 s\nTrue\nsage: %time G.has_perfect_matching(algorithm='LP_matching', solver='Coin')\nCPU times: user 7.59 s, sys: 48 ms, total: 7.64 s\nWall time: 7.56 s\nTrue\n```",
    "created_at": "2017-05-07T21:54:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429465",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:10'></a>The LP formulations look similar, but the polytopes are very different (in particular, the LP_matching one is kind of "relaxed" and always has integer points). I am not specialist at all, but there might be some theoretical results on which shapes are better handled by which solver strategies (perhaps Matthias can tell more about this).

Here, the best strategy seems to depend on the solver (i do not have Cplex installed):

```
sage: G = graphs.RandomBipartite(1000, 1000, 1/100)
sage: %time G.has_perfect_matching(algorithm='LP_matching', solver='Glpk')
CPU times: user 2.54 s, sys: 16 ms, total: 2.56 s
Wall time: 2.51 s
True
sage: %time G.has_perfect_matching(algorithm='LP', solver='Glpk')
CPU times: user 2 s, sys: 8 ms, total: 2.01 s
Wall time: 1.97 s
True

sage: %time G.has_perfect_matching(algorithm='LP', solver='Coin')
CPU times: user 5.27 s, sys: 48 ms, total: 5.32 s
Wall time: 5.26 s
True
sage: %time G.has_perfect_matching(algorithm='LP_matching', solver='Coin')
CPU times: user 7.59 s, sys: 48 ms, total: 7.64 s
Wall time: 7.56 s
True
```



---

archive/issue_comments_429466.json:
```json
{
    "body": "<a id='comment:11'></a>Some corrections:\n1. add test for trivial case: `if self.order() % 2: return False`\n2. don't use `p.add_constraint(sum([b[e] for e in edges]) == 1)` but `p.add_constraint(p.sum(b[e] for e in edges) == 1)`, so `p.sum` instead of `sum` and no `[..]`\n3. after `sage: all(G.has_perfect_matching(algorithm=algo) for algo in ['Edmonds', 'LP_matching', 'LP'])` you must add `True`\n\nConcerning the default method, it seems that the \"LP\" method is in average slightly faster.\n\n```\ndef pm_time(n, p, nbr):\n    algorithms = [\"Edmonds\", \"LP_matching\", \"LP\"]\n    time = {algo:list() for algo in algorithms}\n    for i in range(nbr):\n        G = graphs.RandomGNP(n, p)\n        for algo in algorithms:\n            t = walltime()\n            _ = G.has_perfect_matching(algorithm=algo)\n            time[algo].append(walltime() -t)\n    return {algo:mean(time[algo]) for algo in algorithms}\n```\n\n```\nsage: for n in [10, 20, 50, 100, 200]:\n....:     for p in [0.01, 0.05, 0.1]:\n....:         print(\"{}\\t{}\\t{}\".format(n,round(p,2),pm_time(n, p, 100)))\n....:         \n10\t0.01\t{'LP_matching': 0.00059, 'LP': 0.00011, 'Edmonds': 8e-05}\n10\t0.05\t{'LP_matching': 0.00101, 'LP': 0.00019, 'Edmonds': 0.00021}\n10\t0.1\t{'LP_matching': 0.00114, 'LP': 0.00024, 'Edmonds': 0.00021}\n20\t0.01\t{'LP_matching': 0.00105, 'LP': 0.00011, 'Edmonds': 0.00014}\n20\t0.05\t{'LP_matching': 0.00149, 'LP': 0.00027, 'Edmonds': 0.00035}\n20\t0.1\t{'LP_matching': 0.00266, 'LP': 0.00066, 'Edmonds': 0.00062}\n50\t0.01\t{'LP_matching': 0.0018, 'LP': 0.00016, 'Edmonds': 0.00051}\n50\t0.05\t{'LP_matching': 0.0063, 'LP': 0.00107, 'Edmonds': 0.00216}\n50\t0.1\t{'LP_matching': 0.01115, 'LP': 0.0056, 'Edmonds': 0.00676}\n100\t0.01\t{'LP_matching': 0.00357, 'LP': 0.00028, 'Edmonds': 0.00254}\n100\t0.05\t{'LP_matching': 0.01831, 'LP': 0.00717, 'Edmonds': 0.03603}\n100\t0.1\t{'LP_matching': 0.03172, 'LP': 0.0172, 'Edmonds': 0.01836}\n200\t0.01\t{'LP_matching': 0.01729, 'LP': 0.00065, 'Edmonds': 0.01549}\n200\t0.05\t{'LP_matching': 0.05328, 'LP': 0.03297, 'Edmonds': 0.06735}\n200\t0.1\t{'LP_matching': 0.07782, 'LP': 0.05421, 'Edmonds': 0.06175}\n```",
    "created_at": "2017-05-08T10:19:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429466",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:11'></a>Some corrections:
1. add test for trivial case: `if self.order() % 2: return False`
2. don't use `p.add_constraint(sum([b[e] for e in edges]) == 1)` but `p.add_constraint(p.sum(b[e] for e in edges) == 1)`, so `p.sum` instead of `sum` and no `[..]`
3. after `sage: all(G.has_perfect_matching(algorithm=algo) for algo in ['Edmonds', 'LP_matching', 'LP'])` you must add `True`

Concerning the default method, it seems that the "LP" method is in average slightly faster.

```
def pm_time(n, p, nbr):
    algorithms = ["Edmonds", "LP_matching", "LP"]
    time = {algo:list() for algo in algorithms}
    for i in range(nbr):
        G = graphs.RandomGNP(n, p)
        for algo in algorithms:
            t = walltime()
            _ = G.has_perfect_matching(algorithm=algo)
            time[algo].append(walltime() -t)
    return {algo:mean(time[algo]) for algo in algorithms}
```

```
sage: for n in [10, 20, 50, 100, 200]:
....:     for p in [0.01, 0.05, 0.1]:
....:         print("{}\t{}\t{}".format(n,round(p,2),pm_time(n, p, 100)))
....:         
10	0.01	{'LP_matching': 0.00059, 'LP': 0.00011, 'Edmonds': 8e-05}
10	0.05	{'LP_matching': 0.00101, 'LP': 0.00019, 'Edmonds': 0.00021}
10	0.1	{'LP_matching': 0.00114, 'LP': 0.00024, 'Edmonds': 0.00021}
20	0.01	{'LP_matching': 0.00105, 'LP': 0.00011, 'Edmonds': 0.00014}
20	0.05	{'LP_matching': 0.00149, 'LP': 0.00027, 'Edmonds': 0.00035}
20	0.1	{'LP_matching': 0.00266, 'LP': 0.00066, 'Edmonds': 0.00062}
50	0.01	{'LP_matching': 0.0018, 'LP': 0.00016, 'Edmonds': 0.00051}
50	0.05	{'LP_matching': 0.0063, 'LP': 0.00107, 'Edmonds': 0.00216}
50	0.1	{'LP_matching': 0.01115, 'LP': 0.0056, 'Edmonds': 0.00676}
100	0.01	{'LP_matching': 0.00357, 'LP': 0.00028, 'Edmonds': 0.00254}
100	0.05	{'LP_matching': 0.01831, 'LP': 0.00717, 'Edmonds': 0.03603}
100	0.1	{'LP_matching': 0.03172, 'LP': 0.0172, 'Edmonds': 0.01836}
200	0.01	{'LP_matching': 0.01729, 'LP': 0.00065, 'Edmonds': 0.01549}
200	0.05	{'LP_matching': 0.05328, 'LP': 0.03297, 'Edmonds': 0.06735}
200	0.1	{'LP_matching': 0.07782, 'LP': 0.05421, 'Edmonds': 0.06175}
```



---

archive/issue_comments_429467.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-05-08T10:19:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429467",
    "user": "https://github.com/dcoudert"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_429468.json:
```json
{
    "body": "<a id='comment:12'></a>You can also try the following to handle non connected graphs.\n\n```\ndef has_perfect_matching(G, solver=None, verbose=False):\n    \"\"\"\n    \"\"\"\n    if G.order() % 2:\n        return False\n\n    from sage.numerical.mip import MixedIntegerLinearProgram, MIPSolverException\n    L = G.connected_components()\n    if any(len(cc) % 2 for cc in L):\n        return False\n    for cc in L:\n        p = MixedIntegerLinearProgram(solver=solver)\n        b = p.new_variable(binary=True)\n        for v in cc:\n            p.add_constraint(p.sum(b[e] for e in G.edges_incident(v, labels=False, sort=False)) == 1)\n        try:\n            p.solve(log=verbose)\n            continue\n        except MIPSolverException:\n            return False\n    return True\n```",
    "created_at": "2017-05-08T12:26:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429468",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:12'></a>You can also try the following to handle non connected graphs.

```
def has_perfect_matching(G, solver=None, verbose=False):
    """
    """
    if G.order() % 2:
        return False

    from sage.numerical.mip import MixedIntegerLinearProgram, MIPSolverException
    L = G.connected_components()
    if any(len(cc) % 2 for cc in L):
        return False
    for cc in L:
        p = MixedIntegerLinearProgram(solver=solver)
        b = p.new_variable(binary=True)
        for v in cc:
            p.add_constraint(p.sum(b[e] for e in G.edges_incident(v, labels=False, sort=False)) == 1)
        try:
            p.solve(log=verbose)
            continue
        except MIPSolverException:
            return False
    return True
```



---

archive/issue_comments_429469.json:
```json
{
    "body": "Changing commit from \"27f66e6b85f7cc5159be1524aa21064ef9fccddb\" to \"5bd034d5d2e25d35cc3896a7e51e0d0e6ab47a9a\"",
    "created_at": "2017-05-13T09:26:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429469",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "27f66e6b85f7cc5159be1524aa21064ef9fccddb" to "5bd034d5d2e25d35cc3896a7e51e0d0e6ab47a9a"



---

archive/issue_comments_429470.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-13T09:26:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429470",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_429471.json:
```json
{
    "body": "<a id='comment:14'></a>using `p.sum` is better than `sum` when adding constraints.",
    "created_at": "2017-05-13T09:31:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429471",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:14'></a>using `p.sum` is better than `sum` when adding constraints.



---

archive/issue_comments_429472.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [dcoudert](#comment%3A11):\n> Some corrections:\n> 1. add test for trivial case: `if self.order() % 2: return False`\n> 2. don't use `p.add_constraint(sum([b[e] for e in edges]) == 1)` but `p.add_constraint(p.sum(b[e] for e in edges) == 1)`, so `p.sum` instead of `sum` and no `[..]`\n> 3. after `sage: all(G.has_perfect_matching(algorithm=algo) for algo in ['Edmonds', 'LP_matching', 'LP'])` you must add `True`\n\n\nThanks for the corrections. Regarding the second one, i removed the `[..]`, so that this is more readeable than both other possibilities. I do not see the benefit in calling `p.sum` instead `sum` since MILP can handle that.\n\n> Concerning the default method, it seems that the \"LP\" method is in average slightly faster.\n\n\nWell, this is with the commercial software CPLEX, which we can not assume to be installed on the user's machine. With `cbc` (which is not installed by default), Edomonds is faster for the dense graphs:\n\n```\n10\t0.01\t{'LP_matching': 0.002830798625946045, 'LP': 0.0004676508903503418, 'Edmonds': 0.005202703475952149}\n10\t0.05\t{'LP_matching': 0.002872939109802246, 'LP': 0.0006479811668395996, 'Edmonds': 0.00037740230560302736}\n10\t0.1\t{'LP_matching': 0.0034116864204406737, 'LP': 0.0009398722648620606, 'Edmonds': 0.0005422520637512207}\n20\t0.01\t{'LP_matching': 0.0041153025627136235, 'LP': 0.00047693490982055666, 'Edmonds': 0.000349271297454834}\n20\t0.05\t{'LP_matching': 0.00487368106842041, 'LP': 0.0009178662300109863, 'Edmonds': 0.0009983134269714354}\n20\t0.1\t{'LP_matching': 0.0056728792190551755, 'LP': 0.0020548200607299807, 'Edmonds': 0.0017203617095947266}\n50\t0.01\t{'LP_matching': 0.0073078107833862305, 'LP': 0.0007153725624084472, 'Edmonds': 0.0014888262748718262}\n50\t0.05\t{'LP_matching': 0.01255603551864624, 'LP': 0.004998214244842529, 'Edmonds': 0.0067977094650268554}\n50\t0.1\t{'LP_matching': 0.027002482414245604, 'LP': 0.023311057090759278, 'Edmonds': 0.02096151351928711}\n100\t0.01\t{'LP_matching': 0.014859480857849121, 'LP': 0.0009170055389404296, 'Edmonds': 0.008162569999694825}\n100\t0.05\t{'LP_matching': 0.10298776865005493, 'LP': 0.038913648128509525, 'Edmonds': 0.07995342016220093}\n100\t0.1\t{'LP_matching': 0.11406001806259156, 'LP': 0.15457019090652466, 'Edmonds': 0.05536278963088989}\n200\t0.01\t{'LP_matching': 0.040724358558654784, 'LP': 0.002662522792816162, 'Edmonds': 0.050573115348815915}\n200\t0.05\t{'LP_matching': 0.35171021938323976, 'LP': 0.2127785062789917, 'Edmonds': 0.16411977291107177}\n200\t0.1\t{'LP_matching': 0.7039063048362731, 'LP': 0.39927724838256834, 'Edmonds': 0.1540844440460205}\n```",
    "created_at": "2017-05-13T09:34:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429472",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:15'></a>Replying to [dcoudert](#comment%3A11):
> Some corrections:
> 1. add test for trivial case: `if self.order() % 2: return False`
> 2. don't use `p.add_constraint(sum([b[e] for e in edges]) == 1)` but `p.add_constraint(p.sum(b[e] for e in edges) == 1)`, so `p.sum` instead of `sum` and no `[..]`
> 3. after `sage: all(G.has_perfect_matching(algorithm=algo) for algo in ['Edmonds', 'LP_matching', 'LP'])` you must add `True`


Thanks for the corrections. Regarding the second one, i removed the `[..]`, so that this is more readeable than both other possibilities. I do not see the benefit in calling `p.sum` instead `sum` since MILP can handle that.

> Concerning the default method, it seems that the "LP" method is in average slightly faster.


Well, this is with the commercial software CPLEX, which we can not assume to be installed on the user's machine. With `cbc` (which is not installed by default), Edomonds is faster for the dense graphs:

```
10	0.01	{'LP_matching': 0.002830798625946045, 'LP': 0.0004676508903503418, 'Edmonds': 0.005202703475952149}
10	0.05	{'LP_matching': 0.002872939109802246, 'LP': 0.0006479811668395996, 'Edmonds': 0.00037740230560302736}
10	0.1	{'LP_matching': 0.0034116864204406737, 'LP': 0.0009398722648620606, 'Edmonds': 0.0005422520637512207}
20	0.01	{'LP_matching': 0.0041153025627136235, 'LP': 0.00047693490982055666, 'Edmonds': 0.000349271297454834}
20	0.05	{'LP_matching': 0.00487368106842041, 'LP': 0.0009178662300109863, 'Edmonds': 0.0009983134269714354}
20	0.1	{'LP_matching': 0.0056728792190551755, 'LP': 0.0020548200607299807, 'Edmonds': 0.0017203617095947266}
50	0.01	{'LP_matching': 0.0073078107833862305, 'LP': 0.0007153725624084472, 'Edmonds': 0.0014888262748718262}
50	0.05	{'LP_matching': 0.01255603551864624, 'LP': 0.004998214244842529, 'Edmonds': 0.0067977094650268554}
50	0.1	{'LP_matching': 0.027002482414245604, 'LP': 0.023311057090759278, 'Edmonds': 0.02096151351928711}
100	0.01	{'LP_matching': 0.014859480857849121, 'LP': 0.0009170055389404296, 'Edmonds': 0.008162569999694825}
100	0.05	{'LP_matching': 0.10298776865005493, 'LP': 0.038913648128509525, 'Edmonds': 0.07995342016220093}
100	0.1	{'LP_matching': 0.11406001806259156, 'LP': 0.15457019090652466, 'Edmonds': 0.05536278963088989}
200	0.01	{'LP_matching': 0.040724358558654784, 'LP': 0.002662522792816162, 'Edmonds': 0.050573115348815915}
200	0.05	{'LP_matching': 0.35171021938323976, 'LP': 0.2127785062789917, 'Edmonds': 0.16411977291107177}
200	0.1	{'LP_matching': 0.7039063048362731, 'LP': 0.39927724838256834, 'Edmonds': 0.1540844440460205}
```



---

archive/issue_comments_429473.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [dcoudert](#comment%3A14):\n> using `p.sum` is better than `sum` when adding constraints.\n\n\nWhy ?",
    "created_at": "2017-05-13T09:34:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429473",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:16'></a>Replying to [dcoudert](#comment%3A14):
> using `p.sum` is better than `sum` when adding constraints.


Why ?



---

archive/issue_comments_429474.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [tmonteil](#comment%3A16):\n> Replying to [dcoudert](#comment%3A14):\n> > using `p.sum` is better than `sum` when adding constraints.\n\n> \n> Why ?\n\n\nOK i did some timings.",
    "created_at": "2017-05-13T09:43:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429474",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:17'></a>Replying to [tmonteil](#comment%3A16):
> Replying to [dcoudert](#comment%3A14):
> > using `p.sum` is better than `sum` when adding constraints.

> 
> Why ?


OK i did some timings.



---

archive/issue_comments_429475.json:
```json
{
    "body": "Changing commit from \"5bd034d5d2e25d35cc3896a7e51e0d0e6ab47a9a\" to \"0fc10392efa9bcf1213cf1da6078c930e930a675\"",
    "created_at": "2017-05-13T09:43:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429475",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "5bd034d5d2e25d35cc3896a7e51e0d0e6ab47a9a" to "0fc10392efa9bcf1213cf1da6078c930e930a675"



---

archive/issue_comments_429476.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-13T09:43:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429476",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_429477.json:
```json
{
    "body": "<a id='comment:19'></a>This is actually discussed in #9061 and #13646 (at least).",
    "created_at": "2017-05-13T09:45:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429477",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:19'></a>This is actually discussed in #9061 and #13646 (at least).



---

archive/issue_comments_429478.json:
```json
{
    "body": "<a id='comment:20'></a>Passes all tests on top of 8.0.beta6. For me this is good to go.",
    "created_at": "2017-05-13T09:48:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429478",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:20'></a>Passes all tests on top of 8.0.beta6. For me this is good to go.



---

archive/issue_comments_429479.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2017-05-13T09:48:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429479",
    "user": "https://github.com/dcoudert"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_429480.json:
```json
{
    "body": "<a id='comment:21'></a>OK great, thanks for the review.\n\nRegarding connected components, i guess this should be timed first, since i am pretty sure that Edmonds takes care of that already, and for the LP, the polytope will be a product of polytopes, and i guess that the solvers take advantage of that too. Let us see in a further iteration.",
    "created_at": "2017-05-13T09:53:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429480",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:21'></a>OK great, thanks for the review.

Regarding connected components, i guess this should be timed first, since i am pretty sure that Edmonds takes care of that already, and for the LP, the polytope will be a product of polytopes, and i guess that the solvers take advantage of that too. Let us see in a further iteration.



---

archive/issue_comments_429481.json:
```json
{
    "body": "<a id='comment:22'></a>I fully agree. My timing were not convincing, so it's not crucial to care about connected components so far.\n\nConcerning your timing with `Coin`, be aware that although the solver is generally faster than `GLPK`, the time needed to write the LP is way longer with `Coin` than with `GLPK` or `Cplex`. I don't know why. It is also quite long with `Gurobi`.",
    "created_at": "2017-05-13T10:01:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429481",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:22'></a>I fully agree. My timing were not convincing, so it's not crucial to care about connected components so far.

Concerning your timing with `Coin`, be aware that although the solver is generally faster than `GLPK`, the time needed to write the LP is way longer with `Coin` than with `GLPK` or `Cplex`. I don't know why. It is also quite long with `Gurobi`.



---

archive/issue_comments_429482.json:
```json
{
    "body": "Changing branch from \"u/tmonteil/faster_implementation_for_has_perfect_matching\" to \"u/dkrenn/faster_implementation_for_has_perfect_matching\"",
    "created_at": "2017-05-14T12:48:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429482",
    "user": "https://github.com/dkrenn"
}
```

Changing branch from "u/tmonteil/faster_implementation_for_has_perfect_matching" to "u/dkrenn/faster_implementation_for_has_perfect_matching"



---

archive/issue_comments_429483.json:
```json
{
    "body": "Changing reviewer from \"David Coudert\" to \"David Coudert, Daniel Krenn\"",
    "created_at": "2017-05-14T12:52:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429483",
    "user": "https://github.com/dkrenn"
}
```

Changing reviewer from "David Coudert" to "David Coudert, Daniel Krenn"



---

archive/issue_comments_429484.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2017-05-14T12:52:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429484",
    "user": "https://github.com/dkrenn"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_429485.json:
```json
{
    "body": "<a id='comment:24'></a>I've added a small PEP8 reviewer patch, please cross-review the changes.\nIn particular, I've rewritten the lambda expression to a function (PEP8) and have also rewritten the if-statement; if you're unhappy with the if-rewriting, then feel free to change it back.\n\nApart from PEP8, this patch looks good and clearly is a positive review from my side. Thank you for your work.\n\n---\nNew commits:",
    "created_at": "2017-05-14T12:52:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429485",
    "user": "https://github.com/dkrenn"
}
```

<a id='comment:24'></a>I've added a small PEP8 reviewer patch, please cross-review the changes.
In particular, I've rewritten the lambda expression to a function (PEP8) and have also rewritten the if-statement; if you're unhappy with the if-rewriting, then feel free to change it back.

Apart from PEP8, this patch looks good and clearly is a positive review from my side. Thank you for your work.

---
New commits:



---

archive/issue_comments_429486.json:
```json
{
    "body": "Changing commit from \"0fc10392efa9bcf1213cf1da6078c930e930a675\" to \"3bde4310febdd6bd3bb0b1d65b9056e40d14a306\"",
    "created_at": "2017-05-14T12:52:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429486",
    "user": "https://github.com/dkrenn"
}
```

Changing commit from "0fc10392efa9bcf1213cf1da6078c930e930a675" to "3bde4310febdd6bd3bb0b1d65b9056e40d14a306"



---

archive/issue_comments_429487.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-05-14T13:19:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429487",
    "user": "https://github.com/dcoudert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_429488.json:
```json
{
    "body": "<a id='comment:25'></a>Passes all tests and doc build properly.",
    "created_at": "2017-05-14T13:19:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429488",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:25'></a>Passes all tests and doc build properly.



---

archive/issue_events_059514.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-05-16T22:21:58Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22957#event-59514"
}
```



---

archive/issue_comments_429489.json:
```json
{
    "body": "Changing branch from \"u/dkrenn/faster_implementation_for_has_perfect_matching\" to \"3bde4310febdd6bd3bb0b1d65b9056e40d14a306\"",
    "created_at": "2017-05-16T22:21:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429489",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/dkrenn/faster_implementation_for_has_perfect_matching" to "3bde4310febdd6bd3bb0b1d65b9056e40d14a306"



---

archive/issue_comments_429490.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-05-16T22:21:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22957",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22957#issuecomment-429490",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
