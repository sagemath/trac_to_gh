# Issue 22634: Fix bug with pAutomorphicForms for weights larger than two

archive/issues_022397.json:
```json
{
    "body": "The following code illustrates the bug:\n\n```\nsage: X = BruhatTitsQuotient(7,2)\nsage: H = X.harmonic_cocycles(4,20)\nsage: A = X.padic_automorphic_forms(4,20,overconvergent=True)\nsage: f = A.lift(H.basis()[0]).modular_form(method='moments')\nsage: T.<x> = Qq(7^2,20)\nsage: a,b,c,d = X.embed_quaternion(X.get_units_of_order()[1]).change_ring(Qp(7,20)).list()\nsage: (c*x + d)^4 * f(x) == f((a*x + b)/(c*x + d)) # Should return True\nFalse\n```\n\nThe problem arose because of the way distributions work, which get normalized even when the user wishes they weren't. I propose a fix to this.\n\nCC:  @roed314\n\nKeywords: Bruhat Tits, Harmonic Cocycles, Overconvergent\n\nBranch/Commit: 66bf40077256b637f124b958b3276c229fc42160\n\nReviewer: Peter Graef\n\nAuthor: Marc Masdeu\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/22634\n\n",
    "closed_at": "2017-04-08T17:12:59Z",
    "created_at": "2017-03-17T17:21:48Z",
    "labels": [
        "component: modular forms",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "Fix bug with pAutomorphicForms for weights larger than two",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22634",
    "user": "https://github.com/mmasdeu"
}
```
The following code illustrates the bug:

```
sage: X = BruhatTitsQuotient(7,2)
sage: H = X.harmonic_cocycles(4,20)
sage: A = X.padic_automorphic_forms(4,20,overconvergent=True)
sage: f = A.lift(H.basis()[0]).modular_form(method='moments')
sage: T.<x> = Qq(7^2,20)
sage: a,b,c,d = X.embed_quaternion(X.get_units_of_order()[1]).change_ring(Qp(7,20)).list()
sage: (c*x + d)^4 * f(x) == f((a*x + b)/(c*x + d)) # Should return True
False
```

The problem arose because of the way distributions work, which get normalized even when the user wishes they weren't. I propose a fix to this.

CC:  @roed314

Keywords: Bruhat Tits, Harmonic Cocycles, Overconvergent

Branch/Commit: 66bf40077256b637f124b958b3276c229fc42160

Reviewer: Peter Graef

Author: Marc Masdeu

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/22634





---

archive/issue_comments_415895.json:
```json
{
    "body": "Changing branch from \"\" to \"u/mmasdeu/22634-fix-bug-pautomorphicform\"",
    "created_at": "2017-03-17T17:27:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22634#issuecomment-415895",
    "user": "https://github.com/mmasdeu"
}
```

Changing branch from "" to "u/mmasdeu/22634-fix-bug-pautomorphicform"



---

archive/issue_comments_415896.json:
```json
{
    "body": "<a id='comment:1'></a>\nNew commits:\n|                                                                                                                                          |                                                           |\n|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------|\n|[21e5565](https://github.com/sagemath/sagetrac-mirror/commit/21e556578a4a3d273ce1e14efa6578bb82093ecd)|`Fixed bug when lifting p-automorphic forms of weight > 2.`|\n|[ffcc45f](https://github.com/sagemath/sagetrac-mirror/commit/ffcc45fc85a9539496b36c603857775df8f1cf2a)|`Added doctest to show that bug is fixed.`|",
    "created_at": "2017-03-17T17:27:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22634#issuecomment-415896",
    "user": "https://github.com/mmasdeu"
}
```

<a id='comment:1'></a>
New commits:
|                                                                                                                                          |                                                           |
|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------|
|[21e5565](https://github.com/sagemath/sagetrac-mirror/commit/21e556578a4a3d273ce1e14efa6578bb82093ecd)|`Fixed bug when lifting p-automorphic forms of weight > 2.`|
|[ffcc45f](https://github.com/sagemath/sagetrac-mirror/commit/ffcc45fc85a9539496b36c603857775df8f1cf2a)|`Added doctest to show that bug is fixed.`|



---

archive/issue_comments_415897.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-03-17T17:27:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22634#issuecomment-415897",
    "user": "https://github.com/mmasdeu"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_415898.json:
```json
{
    "body": "Changing commit from \"\" to \"ffcc45fc85a9539496b36c603857775df8f1cf2a\"",
    "created_at": "2017-03-17T17:27:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22634#issuecomment-415898",
    "user": "https://github.com/mmasdeu"
}
```

Changing commit from "" to "ffcc45fc85a9539496b36c603857775df8f1cf2a"



---

archive/issue_comments_415899.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -5,7 +5,7 @@\n sage: H = X.harmonic_cocycles(4,20)\n sage: A = X.padic_automorphic_forms(4,20,overconvergent=True)\n sage: f = A.lift(H.basis()[0]).modular_form(method='moments')\n-sage: T.<g> = Qq(7^2,20)\n+sage: T.<x> = Qq(7^2,20)\n sage: a,b,c,d = X.embed_quaternion(X.get_units_of_order()[1]).change_ring(Qp(7,20)).list()\n sage: (c*x + d)^4 * f(x) == f((a*x + b)/(c*x + d)) # Should return True\n False\n``````\n",
    "created_at": "2017-03-17T17:27:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22634#issuecomment-415899",
    "user": "https://github.com/mmasdeu"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -5,7 +5,7 @@
 sage: H = X.harmonic_cocycles(4,20)
 sage: A = X.padic_automorphic_forms(4,20,overconvergent=True)
 sage: f = A.lift(H.basis()[0]).modular_form(method='moments')
-sage: T.<g> = Qq(7^2,20)
+sage: T.<x> = Qq(7^2,20)
 sage: a,b,c,d = X.embed_quaternion(X.get_units_of_order()[1]).change_ring(Qp(7,20)).list()
 sage: (c*x + d)^4 * f(x) == f((a*x + b)/(c*x + d)) # Should return True
 False
``````




---

archive/issue_comments_415900.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-03-23T10:15:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22634#issuecomment-415900",
    "user": "https://trac.sagemath.org/admin/accounts/users/pgraef"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_415901.json:
```json
{
    "body": "<a id='comment:2'></a>\nThe bug still seems to occur in other cases, for example here\n\n```\nsage: X = BruhatTitsQuotient(7,2)\nsage: H = X.harmonic_cocycles(4,20)\nsage: A = X.padic_automorphic_forms(4,20,overconvergent=True)\nsage: f = A.lift(H.basis()[1]).modular_form(method='moments')\nsage: T.<x> = Qq(7^2,20)\nsage: a,b,c,d = X.embed_quaternion(X.get_units_of_order()[1]).change_ring(Qp(7,20)).list()\nsage: (c*x + d)^4 * f(x) - f((a*x + b)/(c*x + d))\n(6*x + 3) + (6*x + 5)*7 + (x + 6)*7^2 + (2*x + 3)*7^3 + (3*x + 2)*7^4 + (6*x + 4)*7^5 + (x + 3)*7^6 + (4*x + 6)*7^7 + (5*x + 1)*7^8 + (6*x + 1)*7^9 + (3*x + 5)*7^10 + (x + 2)*7^11 + (5*x + 2)*7^12 + (5*x + 6)*7^13 + (4*x + 4)*7^14 + 5*7^15 + (4*x + 4)*7^16 + O(7^17)\n```\n\nor here\n\n```\nsage: X = BruhatTitsQuotient(3,5)\nsage: H = X.harmonic_cocycles(4,20)\nsage: A = X.padic_automorphic_forms(4,20,overconvergent=True)\nsage: f = A.lift(H.basis()[0]).modular_form(method='moments')\nsage: T.<x> = Qq(3^2,20)\nsage: a,b,c,d = X.embed_quaternion(X.get_units_of_order()[1]).change_ring(Qp(3,20)).list()\nsage: (c*x + d)^4 * f(x) - f((a*x + b)/(c*x + d))\n3^3 + (x + 2)*3^5 + 2*x*3^6 + (x + 1)*3^7 + 2*3^8 + (x + 2)*3^9 + (2*x + 1)*3^10 + (2*x + 2)*3^12 + (x + 2)*3^14 + 2*x*3^15 + x*3^16 + O(3^17)\n```\n\nI tried to track down the problem, but didn't suceed. When evaluating the lift of the harmonic cocycle on random matrices, I just noticed that the values for the higher moments seem to be wrong.",
    "created_at": "2017-03-23T10:15:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22634#issuecomment-415901",
    "user": "https://trac.sagemath.org/admin/accounts/users/pgraef"
}
```

<a id='comment:2'></a>
The bug still seems to occur in other cases, for example here

```
sage: X = BruhatTitsQuotient(7,2)
sage: H = X.harmonic_cocycles(4,20)
sage: A = X.padic_automorphic_forms(4,20,overconvergent=True)
sage: f = A.lift(H.basis()[1]).modular_form(method='moments')
sage: T.<x> = Qq(7^2,20)
sage: a,b,c,d = X.embed_quaternion(X.get_units_of_order()[1]).change_ring(Qp(7,20)).list()
sage: (c*x + d)^4 * f(x) - f((a*x + b)/(c*x + d))
(6*x + 3) + (6*x + 5)*7 + (x + 6)*7^2 + (2*x + 3)*7^3 + (3*x + 2)*7^4 + (6*x + 4)*7^5 + (x + 3)*7^6 + (4*x + 6)*7^7 + (5*x + 1)*7^8 + (6*x + 1)*7^9 + (3*x + 5)*7^10 + (x + 2)*7^11 + (5*x + 2)*7^12 + (5*x + 6)*7^13 + (4*x + 4)*7^14 + 5*7^15 + (4*x + 4)*7^16 + O(7^17)
```

or here

```
sage: X = BruhatTitsQuotient(3,5)
sage: H = X.harmonic_cocycles(4,20)
sage: A = X.padic_automorphic_forms(4,20,overconvergent=True)
sage: f = A.lift(H.basis()[0]).modular_form(method='moments')
sage: T.<x> = Qq(3^2,20)
sage: a,b,c,d = X.embed_quaternion(X.get_units_of_order()[1]).change_ring(Qp(3,20)).list()
sage: (c*x + d)^4 * f(x) - f((a*x + b)/(c*x + d))
3^3 + (x + 2)*3^5 + 2*x*3^6 + (x + 1)*3^7 + 2*3^8 + (x + 2)*3^9 + (2*x + 1)*3^10 + (2*x + 2)*3^12 + (x + 2)*3^14 + 2*x*3^15 + x*3^16 + O(3^17)
```

I tried to track down the problem, but didn't suceed. When evaluating the lift of the harmonic cocycle on random matrices, I just noticed that the values for the higher moments seem to be wrong.



---

archive/issue_comments_415902.json:
```json
{
    "body": "<a id='comment:3'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                 |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------|\n|[66bf400](https://github.com/sagemath/sagetrac-mirror/commit/66bf40077256b637f124b958b3276c229fc42160)|`Trac 22634: fixed one more bug.`|",
    "created_at": "2017-03-31T14:53:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22634#issuecomment-415902",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                 |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------|
|[66bf400](https://github.com/sagemath/sagetrac-mirror/commit/66bf40077256b637f124b958b3276c229fc42160)|`Trac 22634: fixed one more bug.`|



---

archive/issue_comments_415903.json:
```json
{
    "body": "Changing commit from \"ffcc45fc85a9539496b36c603857775df8f1cf2a\" to \"66bf40077256b637f124b958b3276c229fc42160\"",
    "created_at": "2017-03-31T14:53:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22634#issuecomment-415903",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "ffcc45fc85a9539496b36c603857775df8f1cf2a" to "66bf40077256b637f124b958b3276c229fc42160"



---

archive/issue_comments_415904.json:
```json
{
    "body": "<a id='comment:4'></a>\nI tracked the error. I was trying to be extra careful in the lifting step and it turns out that it's not needed. The old code did not have this \"functionality\" and that's why it worked!",
    "created_at": "2017-03-31T14:54:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22634#issuecomment-415904",
    "user": "https://github.com/mmasdeu"
}
```

<a id='comment:4'></a>
I tracked the error. I was trying to be extra careful in the lifting step and it turns out that it's not needed. The old code did not have this "functionality" and that's why it worked!



---

archive/issue_comments_415905.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-03-31T14:56:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22634#issuecomment-415905",
    "user": "https://github.com/mmasdeu"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_415906.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-04-07T12:13:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22634#issuecomment-415906",
    "user": "https://trac.sagemath.org/admin/accounts/users/pgraef"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_415907.json:
```json
{
    "body": "<a id='comment:6'></a>\nWorks exactly as it should, everything looks perfect!",
    "created_at": "2017-04-07T12:13:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22634#issuecomment-415907",
    "user": "https://trac.sagemath.org/admin/accounts/users/pgraef"
}
```

<a id='comment:6'></a>
Works exactly as it should, everything looks perfect!



---

archive/issue_comments_415908.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Peter Graef\"",
    "created_at": "2017-04-07T12:13:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22634#issuecomment-415908",
    "user": "https://trac.sagemath.org/admin/accounts/users/pgraef"
}
```

Changing reviewer from "" to "Peter Graef"



---

archive/issue_events_074941.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-04-08T17:12:59Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/22634",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22634#event-74941"
}
```



---

archive/issue_comments_415909.json:
```json
{
    "body": "Changing branch from \"u/mmasdeu/22634-fix-bug-pautomorphicform\" to \"66bf40077256b637f124b958b3276c229fc42160\"",
    "created_at": "2017-04-08T17:12:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22634#issuecomment-415909",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/mmasdeu/22634-fix-bug-pautomorphicform" to "66bf40077256b637f124b958b3276c229fc42160"



---

archive/issue_comments_415910.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-04-08T17:12:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22634",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22634#issuecomment-415910",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
