# Issue 22021: OpenBLAS randomly crashes / deadlocks

archive/issues_021784.json:
```json
{
    "assignees": [],
    "body": "<div id=\"comment:0\"></div>\n\nOpenblas occasionally crashes or deadlocks, most often in  `src/sage/matrix/matrix_integer_dense.pyx` but also other places. But its always some longish linear algebra computation. Examples in the comments.\n\nCC:  @kiwifb @jpflori @jdemeyer\n\nComponent: **linear algebra**\n\nKeywords: **random_fail**\n\nAuthor: **Volker Braun**\n\nBranch: **[`0266727`](https://github.com/sagemath/sagetrac-mirror/commit/026672777b73c63b58800135796caa3981faf924)**\n\nReviewer: **Fran\u00e7ois Bissey**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/22021_\n\n",
    "closed_at": "2016-12-25T20:08:08Z",
    "created_at": "2016-12-04T18:47:45Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20linear%20algebra",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-7.5",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "OpenBLAS randomly crashes / deadlocks",
    "type": "issue",
    "updated_at": "2018-08-24T14:32:05Z",
    "url": "https://github.com/sagemath/sage/issues/22021",
    "user": "https://github.com/vbraun"
}
```
<div id="comment:0"></div>

Openblas occasionally crashes or deadlocks, most often in  `src/sage/matrix/matrix_integer_dense.pyx` but also other places. But its always some longish linear algebra computation. Examples in the comments.

CC:  @kiwifb @jpflori @jdemeyer

Component: **linear algebra**

Keywords: **random_fail**

Author: **Volker Braun**

Branch: **[`0266727`](https://github.com/sagemath/sagetrac-mirror/commit/026672777b73c63b58800135796caa3981faf924)**

Reviewer: **Fran√ßois Bissey**

_Issue created by migration from https://trac.sagemath.org/ticket/22021_





---

archive/issue_events_305707.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-12-04T18:47:45Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "milestone_number": null,
    "milestone_title": "sage-7.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22021#event-305707"
}
```



---

archive/issue_events_305708.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-12-04T18:47:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20linear%20algebra",
    "label_color": "0000ff",
    "label_name": "c: linear algebra",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22021#event-305708"
}
```



---

archive/issue_events_305709.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-12-04T18:47:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22021#event-305709"
}
```



---

archive/issue_events_305710.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-12-04T18:47:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22021#event-305710"
}
```



---

archive/issue_comments_324315.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nExample 1:\n\n```\n4302sage -t --long src/sage/matrix/matrix_integer_dense.pyx\n4303    Killed due to segmentation fault\n4304**********************************************************************\n4305Tests run before process (pid=8896) failed:\n4306sage: a = matrix(ZZ, 3,3, range(9)); a ## line 20 ##\n4307[0 1 2]\n4308[3 4 5]\n4309[6 7 8]\n[...]\n5329sage: A._solve_iml(B, right=False) ## line 4108 ##\n5330sage: A._solve_iml(B, right=True) ## line 4112 ##\n5331sage: A = random_matrix(ZZ, 2000, 2000) ## line 4119 ##\n5332sage: B = random_matrix(ZZ, 2000, 2000) ## line 4120 ##\n5333sage: t0 = walltime() ## line 4121 ##\n5334sage: alarm(2); A._solve_iml(B)  # long time ## line 4122 ##\n5335------------------------------------------------------------------------\n5336/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/cysignals/signals.so(+0x3061)[0xf69ed061]\n5337/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/cysignals/signals.so(+0x30cc)[0xf69ed0cc]\n5338/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/cysignals/signals.so(+0x6ba3)[0xf69f0ba3]\n5339[0xf76e8cd0]\n5340/home/buildbot/slave/sage_git/build/local/lib/libopenblas.so.0(dgemm_kernel+0x7b)[0xf4dd55fb]\n5341------------------------------------------------------------------------\n5342sage: t = walltime(t0) ## line 4126 ##\n5343\n5344**********************************************************************\n```\nExample 2:\n\n```\n4319sage -t --long src/sage/matrix/matrix_integer_dense.pyx\n4320    Killed due to segmentation fault\n4321**********************************************************************\n4322Tests run before process (pid=13893) failed:\n4323sage: a = matrix(ZZ, 3,3, range(9)); a ## line 20 ##\n4324[0 1 2]\n4325[3 4 5]\n4326[6 7 8]\n[...]\n5384sage: A = random_matrix(ZZ, 2000, 2000) ## line 4285 ##\n5385sage: B = random_matrix(ZZ, 2000, 2000) ## line 4286 ##\n5386sage: t0 = walltime() ## line 4287 ##\n5387sage: alarm(2); A._solve_flint(B)  # long time ## line 4288 ##\n5388sage: t = walltime(t0) ## line 4292 ##\n5389sage: t < 10 or t ## line 4293 ##\n5390True\n5391sage: sig_on_count() # check sig_on/off pairings (virtual doctest) ## line 4299 ##\n53920\n5393sage: t = ModularSymbols(11,sign=1).hecke_matrix(2) ## line 4548 ##\n5394------------------------------------------------------------------------\n5395\n5396**********************************************************************\n```\nExample 3:\n\n```\n7007sage -t --long src/sage/schemes/elliptic_curves/ell_rational_field.py\n7008    Timed out\n7009**********************************************************************\n7010Tests run before process (pid=5657) timed out:\n7011sage: E = EllipticCurve([1,2,3,4,5]); E ## line 140 ##\n7012Elliptic Curve defined by y^2 + x*y + 3*y = x^3 + 2*x^2 + 4*x + 5 over Rational Field\n7013sage: EllipticCurve([4,5]).ainvs() ## line 146 ##\n[...]\n8048sage: factor(E.modular_degree()) ## line 3750 ##\n80492^7 * 2617\n8050sage: E = EllipticCurve('11a') ## line 3755 ##\n8051sage: for M in range(1,11): print(E.modular_degree(M=M)) # long time (20s on 2009 MBP) ## line 3756 ##\n80521\n80531\n80543\n80552\n80567\n805745\n8058\n8059**********************************************************************\n8060----------------------------------------------------------------------\n8062sage -t --long src/sage/schemes/elliptic_curves/ell_rational_field.py  # Timed out\n```",
    "created_at": "2016-12-04T18:52:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324315",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:1" align="right">comment:1</div>

Example 1:

```
4302sage -t --long src/sage/matrix/matrix_integer_dense.pyx
4303    Killed due to segmentation fault
4304**********************************************************************
4305Tests run before process (pid=8896) failed:
4306sage: a = matrix(ZZ, 3,3, range(9)); a ## line 20 ##
4307[0 1 2]
4308[3 4 5]
4309[6 7 8]
[...]
5329sage: A._solve_iml(B, right=False) ## line 4108 ##
5330sage: A._solve_iml(B, right=True) ## line 4112 ##
5331sage: A = random_matrix(ZZ, 2000, 2000) ## line 4119 ##
5332sage: B = random_matrix(ZZ, 2000, 2000) ## line 4120 ##
5333sage: t0 = walltime() ## line 4121 ##
5334sage: alarm(2); A._solve_iml(B)  # long time ## line 4122 ##
5335------------------------------------------------------------------------
5336/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/cysignals/signals.so(+0x3061)[0xf69ed061]
5337/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/cysignals/signals.so(+0x30cc)[0xf69ed0cc]
5338/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/cysignals/signals.so(+0x6ba3)[0xf69f0ba3]
5339[0xf76e8cd0]
5340/home/buildbot/slave/sage_git/build/local/lib/libopenblas.so.0(dgemm_kernel+0x7b)[0xf4dd55fb]
5341------------------------------------------------------------------------
5342sage: t = walltime(t0) ## line 4126 ##
5343
5344**********************************************************************
```
Example 2:

```
4319sage -t --long src/sage/matrix/matrix_integer_dense.pyx
4320    Killed due to segmentation fault
4321**********************************************************************
4322Tests run before process (pid=13893) failed:
4323sage: a = matrix(ZZ, 3,3, range(9)); a ## line 20 ##
4324[0 1 2]
4325[3 4 5]
4326[6 7 8]
[...]
5384sage: A = random_matrix(ZZ, 2000, 2000) ## line 4285 ##
5385sage: B = random_matrix(ZZ, 2000, 2000) ## line 4286 ##
5386sage: t0 = walltime() ## line 4287 ##
5387sage: alarm(2); A._solve_flint(B)  # long time ## line 4288 ##
5388sage: t = walltime(t0) ## line 4292 ##
5389sage: t < 10 or t ## line 4293 ##
5390True
5391sage: sig_on_count() # check sig_on/off pairings (virtual doctest) ## line 4299 ##
53920
5393sage: t = ModularSymbols(11,sign=1).hecke_matrix(2) ## line 4548 ##
5394------------------------------------------------------------------------
5395
5396**********************************************************************
```
Example 3:

```
7007sage -t --long src/sage/schemes/elliptic_curves/ell_rational_field.py
7008    Timed out
7009**********************************************************************
7010Tests run before process (pid=5657) timed out:
7011sage: E = EllipticCurve([1,2,3,4,5]); E ## line 140 ##
7012Elliptic Curve defined by y^2 + x*y + 3*y = x^3 + 2*x^2 + 4*x + 5 over Rational Field
7013sage: EllipticCurve([4,5]).ainvs() ## line 146 ##
[...]
8048sage: factor(E.modular_degree()) ## line 3750 ##
80492^7 * 2617
8050sage: E = EllipticCurve('11a') ## line 3755 ##
8051sage: for M in range(1,11): print(E.modular_degree(M=M)) # long time (20s on 2009 MBP) ## line 3756 ##
80521
80531
80543
80552
80567
805745
8058
8059**********************************************************************
8060----------------------------------------------------------------------
8062sage -t --long src/sage/schemes/elliptic_curves/ell_rational_field.py  # Timed out
```



---

archive/issue_comments_324316.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nHere is a stack trace on a deadlocked test on OSX:\n\n```\n(lldb) process attach --pid 30237\nProcess 30237 stopped\n* thread #1: tid = 0x1eea45e, 0x00007fff8c08d10a libsystem_kernel.dylib`__semwait_signal + 10, queue = 'com.apple.main-thread', stop reason = signal SIGSTOP\n    frame #0: 0x00007fff8c08d10a libsystem_kernel.dylib`__semwait_signal + 10\nlibsystem_kernel.dylib`__semwait_signal:\n->  0x7fff8c08d10a <+10>: jae    0x7fff8c08d114            ; <+20>\n    0x7fff8c08d10c <+12>: movq   %rax, %rdi\n    0x7fff8c08d10f <+15>: jmp    0x7fff8c0877f2            ; cerror\n    0x7fff8c08d114 <+20>: retq   \n\nExecutable module set to \"/Users/buildslave-sage/slave/sage_git/build/local/bin/python\".\nArchitecture set to: x86_64-apple-macosx.\n(lldb) bt\n* thread #1: tid = 0x1eea45e, 0x00007fff8c08d10a libsystem_kernel.dylib`__semwait_signal + 10, queue = 'com.apple.main-thread', stop reason = signal SIGSTOP\n  * frame #0: 0x00007fff8c08d10a libsystem_kernel.dylib`__semwait_signal + 10\n    frame #1: 0x00007fff90e8f787 libsystem_pthread.dylib`pthread_join + 444\n    frame #2: 0x000000010be46e9e libopenblas_sandybridgep-r0.2.19.dylib`blas_thread_shutdown_ + 238\n    frame #3: 0x00007fff90e8fda7 libsystem_pthread.dylib`_pthread_fork_prepare + 85\n    frame #4: 0x00007fff81da9a74 libSystem.B.dylib`libSystem_atfork_prepare + 24\n    frame #5: 0x00007fff8f2a7f7c libsystem_c.dylib`fork + 12\n    frame #6: 0x00007fff8f2a7310 libsystem_c.dylib`forkpty + 58\n    frame #7: 0x000000010999f493 libpython2.7.dylib`posix_forkpty + 35\n    frame #8: 0x00000001099514ef libpython2.7.dylib`PyEval_EvalFrameEx + 25631\n    frame #9: 0x000000010995126e libpython2.7.dylib`PyEval_EvalFrameEx + 24990\n    frame #10: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124\n    frame #11: 0x00000001098bc0dd libpython2.7.dylib`function_call + 349\n    frame #12: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67\n    frame #13: 0x00000001098989ec libpython2.7.dylib`instancemethod_call + 140\n    frame #14: 0x000000010b27f072 sagespawn.so`__pyx_pw_4sage_10interfaces_9sagespawn_9SageSpawn_3_spawnpty + 65 at sagespawn.c:4885\n    frame #15: 0x000000010b27f031 sagespawn.so`__pyx_pw_4sage_10interfaces_9sagespawn_9SageSpawn_3_spawnpty + 123\n    frame #16: 0x000000010b27efb6 sagespawn.so`__pyx_pw_4sage_10interfaces_9sagespawn_9SageSpawn_3_spawnpty(__pyx_self=<unavailable>, __pyx_args=<unavailable>, __pyx_kwds=<unavailable>) + 86\n    frame #17: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67\n    frame #18: 0x000000010994de87 libpython2.7.dylib`PyEval_EvalFrameEx + 11703\n    frame #19: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124\n    frame #20: 0x00000001099511cd libpython2.7.dylib`PyEval_EvalFrameEx + 24829\n    frame #21: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124\n    frame #22: 0x00000001098bc0dd libpython2.7.dylib`function_call + 349\n    frame #23: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67\n    frame #24: 0x00000001098989ec libpython2.7.dylib`instancemethod_call + 140\n    frame #25: 0x000000010b27bb80 sagespawn.so`__Pyx_PyObject_Call(func=0x00000002403d9b90, arg=<unavailable>, kw=<unavailable>) + 64 at sagespawn.c:4885\n    frame #26: 0x000000010b281fd0 sagespawn.so`__pyx_pw_4sage_10interfaces_9sagespawn_9SageSpawn_1__init__ + 1745 at sagespawn.c:1564\n    frame #27: 0x000000010b2818ff sagespawn.so`__pyx_pw_4sage_10interfaces_9sagespawn_9SageSpawn_1__init__(__pyx_self=<unavailable>, __pyx_args=<unavailable>, __pyx_kwds=<unavailable>) + 111\n    frame #28: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67\n    frame #29: 0x00000001098989ec libpython2.7.dylib`instancemethod_call + 140\n    frame #30: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67\n    frame #31: 0x00000001099033ed libpython2.7.dylib`slot_tp_init + 109\n    frame #32: 0x0000000109900d2a libpython2.7.dylib`type_call + 202\n    frame #33: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67\n    frame #34: 0x000000010994eecd libpython2.7.dylib`PyEval_EvalFrameEx + 15869\n    frame #35: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124\n    frame #36: 0x00000001098bbffc libpython2.7.dylib`function_call + 124\n    frame #37: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67\n    frame #38: 0x00000001098989ec libpython2.7.dylib`instancemethod_call + 140\n    frame #39: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67\n    frame #40: 0x000000010994eecd libpython2.7.dylib`PyEval_EvalFrameEx + 15869\n    frame #41: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124\n    frame #42: 0x00000001099511cd libpython2.7.dylib`PyEval_EvalFrameEx + 24829\n    frame #43: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124\n    frame #44: 0x00000001098bc0dd libpython2.7.dylib`function_call + 349\n    frame #45: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67\n    frame #46: 0x000000010994de87 libpython2.7.dylib`PyEval_EvalFrameEx + 11703\n    frame #47: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124\n    frame #48: 0x00000001098bc0dd libpython2.7.dylib`function_call + 349\n    frame #49: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67\n    frame #50: 0x00000001098989ec libpython2.7.dylib`instancemethod_call + 140\n    frame #51: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67\n    frame #52: 0x000000010994de87 libpython2.7.dylib`PyEval_EvalFrameEx + 11703\n    frame #53: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124\n    frame #54: 0x0000000237667191 matrix_integer_dense.so`__Pyx_PyFunction_FastCallDict(func=0x0000000114422488, args=<unavailable>, nargs=<unavailable>, kwargs=0x9000000000000000) + 113 at matrix_integer_dense.c:57331\n    frame #55: 0x00000002376affa6 matrix_integer_dense.so`__pyx_pw_4sage_6matrix_20matrix_integer_dense_20Matrix_integer_dense_157_singular_(__pyx_v_self=<unavailable>, __pyx_args=<unavailable>, __pyx_kwds=<unavailable>) + 6134 at matrix_integer_dense.c:48368\n    frame #56: 0x000000010995169b libpython2.7.dylib`PyEval_EvalFrameEx + 26059\n    frame #57: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124\n    frame #58: 0x00000001098bbffc libpython2.7.dylib`function_call + 124\n    frame #59: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67\n    frame #60: 0x00000001098989ec libpython2.7.dylib`instancemethod_call + 140\n    frame #61: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67\n    frame #62: 0x0000000109902f95 libpython2.7.dylib`slot_tp_call + 101\n    frame #63: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67\n    frame #64: 0x000000010994eecd libpython2.7.dylib`PyEval_EvalFrameEx + 15869\n    frame #65: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124\n    frame #66: 0x0000000109951373 libpython2.7.dylib`PyEval_EvalFrameEx + 25251\n    frame #67: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124\n    frame #68: 0x00000001099511cd libpython2.7.dylib`PyEval_EvalFrameEx + 24829\n    frame #69: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124\n    frame #70: 0x00000001099511cd libpython2.7.dylib`PyEval_EvalFrameEx + 24829\n    frame #71: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124\n    frame #72: 0x00000001099511cd libpython2.7.dylib`PyEval_EvalFrameEx + 24829\n    frame #73: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124\n    frame #74: 0x00000001098bbffc libpython2.7.dylib`function_call + 124\n    frame #75: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67\n    frame #76: 0x00000001098989ec libpython2.7.dylib`instancemethod_call + 140\n    frame #77: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67\n    frame #78: 0x0000000109902f95 libpython2.7.dylib`slot_tp_call + 101\n    frame #79: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67\n    frame #80: 0x000000010994eecd libpython2.7.dylib`PyEval_EvalFrameEx + 15869\n    frame #81: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124\n    frame #82: 0x00000001099511cd libpython2.7.dylib`PyEval_EvalFrameEx + 24829\n    frame #83: 0x000000010995126e libpython2.7.dylib`PyEval_EvalFrameEx + 24990\n    frame #84: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124\n    frame #85: 0x00000001098bbffc libpython2.7.dylib`function_call + 124\n    frame #86: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67\n    frame #87: 0x00000001098989ec libpython2.7.dylib`instancemethod_call + 140\n    frame #88: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67\n    frame #89: 0x00000001099033ed libpython2.7.dylib`slot_tp_init + 109\n    frame #90: 0x0000000109900d2a libpython2.7.dylib`type_call + 202\n    frame #91: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67\n    frame #92: 0x000000010994eecd libpython2.7.dylib`PyEval_EvalFrameEx + 15869\n    frame #93: 0x000000010995126e libpython2.7.dylib`PyEval_EvalFrameEx + 24990\n    frame #94: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124\n    frame #95: 0x00000001099511cd libpython2.7.dylib`PyEval_EvalFrameEx + 24829\n    frame #96: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124\n    frame #97: 0x00000001099511cd libpython2.7.dylib`PyEval_EvalFrameEx + 24829\n    frame #98: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124\n    frame #99: 0x00000001099511cd libpython2.7.dylib`PyEval_EvalFrameEx + 24829\n    frame #100: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124\n    frame #101: 0x00000001099511cd libpython2.7.dylib`PyEval_EvalFrameEx + 24829\n    frame #102: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124\n    frame #103: 0x00000001099511cd libpython2.7.dylib`PyEval_EvalFrameEx + 24829\n    frame #104: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124\n    frame #105: 0x00000001099522b9 libpython2.7.dylib`PyEval_EvalCode + 25\n    frame #106: 0x000000010997c2c3 libpython2.7.dylib`PyRun_FileExFlags + 291\n    frame #107: 0x000000010997dd67 libpython2.7.dylib`PyRun_SimpleFileExFlags + 215\n    frame #108: 0x0000000109997873 libpython2.7.dylib`Py_Main + 3443\n    frame #109: 0x00007fff8f9385ad libdyld.dylib`start + 1\n    frame #110: 0x00007fff8f9385ad libdyld.dylib`start + 1\n```",
    "created_at": "2016-12-04T18:59:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324316",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:3" align="right">comment:3</div>

Here is a stack trace on a deadlocked test on OSX:

```
(lldb) process attach --pid 30237
Process 30237 stopped
* thread #1: tid = 0x1eea45e, 0x00007fff8c08d10a libsystem_kernel.dylib`__semwait_signal + 10, queue = 'com.apple.main-thread', stop reason = signal SIGSTOP
    frame #0: 0x00007fff8c08d10a libsystem_kernel.dylib`__semwait_signal + 10
libsystem_kernel.dylib`__semwait_signal:
->  0x7fff8c08d10a <+10>: jae    0x7fff8c08d114            ; <+20>
    0x7fff8c08d10c <+12>: movq   %rax, %rdi
    0x7fff8c08d10f <+15>: jmp    0x7fff8c0877f2            ; cerror
    0x7fff8c08d114 <+20>: retq   

Executable module set to "/Users/buildslave-sage/slave/sage_git/build/local/bin/python".
Architecture set to: x86_64-apple-macosx.
(lldb) bt
* thread #1: tid = 0x1eea45e, 0x00007fff8c08d10a libsystem_kernel.dylib`__semwait_signal + 10, queue = 'com.apple.main-thread', stop reason = signal SIGSTOP
  * frame #0: 0x00007fff8c08d10a libsystem_kernel.dylib`__semwait_signal + 10
    frame #1: 0x00007fff90e8f787 libsystem_pthread.dylib`pthread_join + 444
    frame #2: 0x000000010be46e9e libopenblas_sandybridgep-r0.2.19.dylib`blas_thread_shutdown_ + 238
    frame #3: 0x00007fff90e8fda7 libsystem_pthread.dylib`_pthread_fork_prepare + 85
    frame #4: 0x00007fff81da9a74 libSystem.B.dylib`libSystem_atfork_prepare + 24
    frame #5: 0x00007fff8f2a7f7c libsystem_c.dylib`fork + 12
    frame #6: 0x00007fff8f2a7310 libsystem_c.dylib`forkpty + 58
    frame #7: 0x000000010999f493 libpython2.7.dylib`posix_forkpty + 35
    frame #8: 0x00000001099514ef libpython2.7.dylib`PyEval_EvalFrameEx + 25631
    frame #9: 0x000000010995126e libpython2.7.dylib`PyEval_EvalFrameEx + 24990
    frame #10: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124
    frame #11: 0x00000001098bc0dd libpython2.7.dylib`function_call + 349
    frame #12: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67
    frame #13: 0x00000001098989ec libpython2.7.dylib`instancemethod_call + 140
    frame #14: 0x000000010b27f072 sagespawn.so`__pyx_pw_4sage_10interfaces_9sagespawn_9SageSpawn_3_spawnpty + 65 at sagespawn.c:4885
    frame #15: 0x000000010b27f031 sagespawn.so`__pyx_pw_4sage_10interfaces_9sagespawn_9SageSpawn_3_spawnpty + 123
    frame #16: 0x000000010b27efb6 sagespawn.so`__pyx_pw_4sage_10interfaces_9sagespawn_9SageSpawn_3_spawnpty(__pyx_self=<unavailable>, __pyx_args=<unavailable>, __pyx_kwds=<unavailable>) + 86
    frame #17: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67
    frame #18: 0x000000010994de87 libpython2.7.dylib`PyEval_EvalFrameEx + 11703
    frame #19: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124
    frame #20: 0x00000001099511cd libpython2.7.dylib`PyEval_EvalFrameEx + 24829
    frame #21: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124
    frame #22: 0x00000001098bc0dd libpython2.7.dylib`function_call + 349
    frame #23: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67
    frame #24: 0x00000001098989ec libpython2.7.dylib`instancemethod_call + 140
    frame #25: 0x000000010b27bb80 sagespawn.so`__Pyx_PyObject_Call(func=0x00000002403d9b90, arg=<unavailable>, kw=<unavailable>) + 64 at sagespawn.c:4885
    frame #26: 0x000000010b281fd0 sagespawn.so`__pyx_pw_4sage_10interfaces_9sagespawn_9SageSpawn_1__init__ + 1745 at sagespawn.c:1564
    frame #27: 0x000000010b2818ff sagespawn.so`__pyx_pw_4sage_10interfaces_9sagespawn_9SageSpawn_1__init__(__pyx_self=<unavailable>, __pyx_args=<unavailable>, __pyx_kwds=<unavailable>) + 111
    frame #28: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67
    frame #29: 0x00000001098989ec libpython2.7.dylib`instancemethod_call + 140
    frame #30: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67
    frame #31: 0x00000001099033ed libpython2.7.dylib`slot_tp_init + 109
    frame #32: 0x0000000109900d2a libpython2.7.dylib`type_call + 202
    frame #33: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67
    frame #34: 0x000000010994eecd libpython2.7.dylib`PyEval_EvalFrameEx + 15869
    frame #35: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124
    frame #36: 0x00000001098bbffc libpython2.7.dylib`function_call + 124
    frame #37: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67
    frame #38: 0x00000001098989ec libpython2.7.dylib`instancemethod_call + 140
    frame #39: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67
    frame #40: 0x000000010994eecd libpython2.7.dylib`PyEval_EvalFrameEx + 15869
    frame #41: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124
    frame #42: 0x00000001099511cd libpython2.7.dylib`PyEval_EvalFrameEx + 24829
    frame #43: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124
    frame #44: 0x00000001098bc0dd libpython2.7.dylib`function_call + 349
    frame #45: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67
    frame #46: 0x000000010994de87 libpython2.7.dylib`PyEval_EvalFrameEx + 11703
    frame #47: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124
    frame #48: 0x00000001098bc0dd libpython2.7.dylib`function_call + 349
    frame #49: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67
    frame #50: 0x00000001098989ec libpython2.7.dylib`instancemethod_call + 140
    frame #51: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67
    frame #52: 0x000000010994de87 libpython2.7.dylib`PyEval_EvalFrameEx + 11703
    frame #53: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124
    frame #54: 0x0000000237667191 matrix_integer_dense.so`__Pyx_PyFunction_FastCallDict(func=0x0000000114422488, args=<unavailable>, nargs=<unavailable>, kwargs=0x9000000000000000) + 113 at matrix_integer_dense.c:57331
    frame #55: 0x00000002376affa6 matrix_integer_dense.so`__pyx_pw_4sage_6matrix_20matrix_integer_dense_20Matrix_integer_dense_157_singular_(__pyx_v_self=<unavailable>, __pyx_args=<unavailable>, __pyx_kwds=<unavailable>) + 6134 at matrix_integer_dense.c:48368
    frame #56: 0x000000010995169b libpython2.7.dylib`PyEval_EvalFrameEx + 26059
    frame #57: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124
    frame #58: 0x00000001098bbffc libpython2.7.dylib`function_call + 124
    frame #59: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67
    frame #60: 0x00000001098989ec libpython2.7.dylib`instancemethod_call + 140
    frame #61: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67
    frame #62: 0x0000000109902f95 libpython2.7.dylib`slot_tp_call + 101
    frame #63: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67
    frame #64: 0x000000010994eecd libpython2.7.dylib`PyEval_EvalFrameEx + 15869
    frame #65: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124
    frame #66: 0x0000000109951373 libpython2.7.dylib`PyEval_EvalFrameEx + 25251
    frame #67: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124
    frame #68: 0x00000001099511cd libpython2.7.dylib`PyEval_EvalFrameEx + 24829
    frame #69: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124
    frame #70: 0x00000001099511cd libpython2.7.dylib`PyEval_EvalFrameEx + 24829
    frame #71: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124
    frame #72: 0x00000001099511cd libpython2.7.dylib`PyEval_EvalFrameEx + 24829
    frame #73: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124
    frame #74: 0x00000001098bbffc libpython2.7.dylib`function_call + 124
    frame #75: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67
    frame #76: 0x00000001098989ec libpython2.7.dylib`instancemethod_call + 140
    frame #77: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67
    frame #78: 0x0000000109902f95 libpython2.7.dylib`slot_tp_call + 101
    frame #79: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67
    frame #80: 0x000000010994eecd libpython2.7.dylib`PyEval_EvalFrameEx + 15869
    frame #81: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124
    frame #82: 0x00000001099511cd libpython2.7.dylib`PyEval_EvalFrameEx + 24829
    frame #83: 0x000000010995126e libpython2.7.dylib`PyEval_EvalFrameEx + 24990
    frame #84: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124
    frame #85: 0x00000001098bbffc libpython2.7.dylib`function_call + 124
    frame #86: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67
    frame #87: 0x00000001098989ec libpython2.7.dylib`instancemethod_call + 140
    frame #88: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67
    frame #89: 0x00000001099033ed libpython2.7.dylib`slot_tp_init + 109
    frame #90: 0x0000000109900d2a libpython2.7.dylib`type_call + 202
    frame #91: 0x0000000109884403 libpython2.7.dylib`PyObject_Call + 67
    frame #92: 0x000000010994eecd libpython2.7.dylib`PyEval_EvalFrameEx + 15869
    frame #93: 0x000000010995126e libpython2.7.dylib`PyEval_EvalFrameEx + 24990
    frame #94: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124
    frame #95: 0x00000001099511cd libpython2.7.dylib`PyEval_EvalFrameEx + 24829
    frame #96: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124
    frame #97: 0x00000001099511cd libpython2.7.dylib`PyEval_EvalFrameEx + 24829
    frame #98: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124
    frame #99: 0x00000001099511cd libpython2.7.dylib`PyEval_EvalFrameEx + 24829
    frame #100: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124
    frame #101: 0x00000001099511cd libpython2.7.dylib`PyEval_EvalFrameEx + 24829
    frame #102: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124
    frame #103: 0x00000001099511cd libpython2.7.dylib`PyEval_EvalFrameEx + 24829
    frame #104: 0x000000010995219c libpython2.7.dylib`PyEval_EvalCodeEx + 2124
    frame #105: 0x00000001099522b9 libpython2.7.dylib`PyEval_EvalCode + 25
    frame #106: 0x000000010997c2c3 libpython2.7.dylib`PyRun_FileExFlags + 291
    frame #107: 0x000000010997dd67 libpython2.7.dylib`PyRun_SimpleFileExFlags + 215
    frame #108: 0x0000000109997873 libpython2.7.dylib`Py_Main + 3443
    frame #109: 0x00007fff8f9385ad libdyld.dylib`start + 1
    frame #110: 0x00007fff8f9385ad libdyld.dylib`start + 1
```



---

archive/issue_comments_324317.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nRunning\n`while true ; do ./sage -t --long src/sage/matrix/matrix_integer_dense.pyx ; done`\nusually hangs/crashes in about 10 - 100 tries.",
    "created_at": "2016-12-04T19:42:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324317",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:4" align="right">comment:4</div>

Running
`while true ; do ./sage -t --long src/sage/matrix/matrix_integer_dense.pyx ; done`
usually hangs/crashes in about 10 - 100 tries.



---

archive/issue_comments_324318.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nAnother possibility: The alarm() could mess up OpenBLAS's internal thread pool...",
    "created_at": "2016-12-04T20:02:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324318",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:5" align="right">comment:5</div>

Another possibility: The alarm() could mess up OpenBLAS's internal thread pool...



---

archive/issue_comments_324319.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nHere is a similar backtrace from Linux 64-bit Haswell-E (libopenblas_haswellp-r0.2.19.so)\n\n```\n#0  0x00007fa6cf0756bd in pthread_join () from /lib64/libpthread.so.0\n#1  0x00007fa6b9dcb51e in blas_thread_shutdown_ () from /home/vbraun/Code/sage.git/local/lib/libopenblas.so.0\n#2  0x00007fa6ce663aa5 in fork () from /lib64/libc.so.6\n#3  0x00007fa6cec67840 in forkpty () from /lib64/libutil.so.1\n#4  0x00007fa6cf3d6583 in posix_forkpty (self=<optimized out>, noargs=<optimized out>) at ./Modules/posixmodule.c:4012\n#5  0x00007fa6cf391cca in call_function (oparg=<optimized out>, pp_stack=0x7ffcbbf7d5d0) at Python/ceval.c:4019\n#6  PyEval_EvalFrameEx (f=f@entry=0x7f9e6fa8b830, throwflag=throwflag@entry=0) at Python/ceval.c:2681\n#7  0x00007fa6cf391ca0 in fast_function (nk=<optimized out>, na=0, n=0, pp_stack=0x7ffcbbf7d6f0, func=<optimized out>) at Python/ceval.c:4121\n#8  call_function (oparg=<optimized out>, pp_stack=0x7ffcbbf7d6f0) at Python/ceval.c:4056\n#9  PyEval_EvalFrameEx (f=f@entry=0x7f9e72d799c0, throwflag=throwflag@entry=0) at Python/ceval.c:2681\n#10 0x00007fa6cf392b2c in PyEval_EvalCodeEx (co=<optimized out>, globals=<optimized out>, locals=locals@entry=0x0, args=args@entry=0x7f9e740b9c80, \n    argcount=2, kws=kws@entry=0x7f9e6f4b5e78, kwcount=4, defs=0x7fa6bedf0cc8, defcount=5, closure=0x0) at Python/ceval.c:3267\n#11 0x00007fa6cf30c8ed in function_call (func=0x7fa6be8d8320, arg=0x7f9e740b9c68, kw=0x7f9e6fa5a910) at Objects/funcobject.c:526\n#12 0x00007fa6cf2dbe33 in PyObject_Call (func=func@entry=0x7fa6be8d8320, arg=arg@entry=0x7f9e740b9c68, kw=kw@entry=0x7f9e6fa5a910)\n    at Objects/abstract.c:2529\n#13 0x00007fa6cf2ed01c in instancemethod_call (func=0x7fa6be8d8320, arg=0x7f9e740b9c68, kw=0x7f9e6fa5a910) at Objects/classobject.c:2602\n#14 0x00007fa6be661ab9 in __Pyx_PyObject_Call (kw=0x7f9e6fa5a910, arg=0x7f9e6fb68990, func=0x7f9e6f8e73c0)\n    at /home/vbraun/Sage/git/src/build/cythonized/sage/interfaces/sagespawn.c:4885\n#15 __pyx_pf_4sage_10interfaces_9sagespawn_9SageSpawn_2_spawnpty (__pyx_self=<optimized out>, __pyx_v_kwds=0x7f9e6fa5a910, \n    __pyx_v_args=<optimized out>, __pyx_v_self=<optimized out>) at /home/vbraun/Sage/git/src/build/cythonized/sage/interfaces/sagespawn.c:1797\n#16 __pyx_pw_4sage_10interfaces_9sagespawn_9SageSpawn_3_spawnpty (__pyx_self=<optimized out>, __pyx_args=<optimized out>, __pyx_kwds=<optimized out>)\n    at /home/vbraun/Sage/git/src/build/cythonized/sage/interfaces/sagespawn.c:1763\n#17 0x00007fa6cf2dbe33 in PyObject_Call (func=func@entry=0x7fa6beb1aad0, arg=arg@entry=0x7f9e74261560, kw=kw@entry=0x7f9e6f4e0398)\n    at Objects/abstract.c:2529\n#18 0x00007fa6cf38cede in ext_do_call (nk=<optimized out>, na=2, flags=<optimized out>, pp_stack=0x7ffcbbf7dc30, func=0x7fa6beb1aad0)\n    at Python/ceval.c:4348\n#19 PyEval_EvalFrameEx (f=f@entry=0x7f9e72d79580, throwflag=throwflag@entry=0) at Python/ceval.c:2720\n#20 0x00007fa6cf392b2c in PyEval_EvalCodeEx (co=<optimized out>, globals=<optimized out>, locals=locals@entry=0x0, args=<optimized out>, \n    argcount=argcount@entry=5, kws=0x7f9e72d2c6c8, kwcount=0, defs=0x7fa6bed85068, defcount=3, closure=0x0) at Python/ceval.c:3267\n```",
    "created_at": "2016-12-05T22:26:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324319",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:6" align="right">comment:6</div>

Here is a similar backtrace from Linux 64-bit Haswell-E (libopenblas_haswellp-r0.2.19.so)

```
#0  0x00007fa6cf0756bd in pthread_join () from /lib64/libpthread.so.0
#1  0x00007fa6b9dcb51e in blas_thread_shutdown_ () from /home/vbraun/Code/sage.git/local/lib/libopenblas.so.0
#2  0x00007fa6ce663aa5 in fork () from /lib64/libc.so.6
#3  0x00007fa6cec67840 in forkpty () from /lib64/libutil.so.1
#4  0x00007fa6cf3d6583 in posix_forkpty (self=<optimized out>, noargs=<optimized out>) at ./Modules/posixmodule.c:4012
#5  0x00007fa6cf391cca in call_function (oparg=<optimized out>, pp_stack=0x7ffcbbf7d5d0) at Python/ceval.c:4019
#6  PyEval_EvalFrameEx (f=f@entry=0x7f9e6fa8b830, throwflag=throwflag@entry=0) at Python/ceval.c:2681
#7  0x00007fa6cf391ca0 in fast_function (nk=<optimized out>, na=0, n=0, pp_stack=0x7ffcbbf7d6f0, func=<optimized out>) at Python/ceval.c:4121
#8  call_function (oparg=<optimized out>, pp_stack=0x7ffcbbf7d6f0) at Python/ceval.c:4056
#9  PyEval_EvalFrameEx (f=f@entry=0x7f9e72d799c0, throwflag=throwflag@entry=0) at Python/ceval.c:2681
#10 0x00007fa6cf392b2c in PyEval_EvalCodeEx (co=<optimized out>, globals=<optimized out>, locals=locals@entry=0x0, args=args@entry=0x7f9e740b9c80, 
    argcount=2, kws=kws@entry=0x7f9e6f4b5e78, kwcount=4, defs=0x7fa6bedf0cc8, defcount=5, closure=0x0) at Python/ceval.c:3267
#11 0x00007fa6cf30c8ed in function_call (func=0x7fa6be8d8320, arg=0x7f9e740b9c68, kw=0x7f9e6fa5a910) at Objects/funcobject.c:526
#12 0x00007fa6cf2dbe33 in PyObject_Call (func=func@entry=0x7fa6be8d8320, arg=arg@entry=0x7f9e740b9c68, kw=kw@entry=0x7f9e6fa5a910)
    at Objects/abstract.c:2529
#13 0x00007fa6cf2ed01c in instancemethod_call (func=0x7fa6be8d8320, arg=0x7f9e740b9c68, kw=0x7f9e6fa5a910) at Objects/classobject.c:2602
#14 0x00007fa6be661ab9 in __Pyx_PyObject_Call (kw=0x7f9e6fa5a910, arg=0x7f9e6fb68990, func=0x7f9e6f8e73c0)
    at /home/vbraun/Sage/git/src/build/cythonized/sage/interfaces/sagespawn.c:4885
#15 __pyx_pf_4sage_10interfaces_9sagespawn_9SageSpawn_2_spawnpty (__pyx_self=<optimized out>, __pyx_v_kwds=0x7f9e6fa5a910, 
    __pyx_v_args=<optimized out>, __pyx_v_self=<optimized out>) at /home/vbraun/Sage/git/src/build/cythonized/sage/interfaces/sagespawn.c:1797
#16 __pyx_pw_4sage_10interfaces_9sagespawn_9SageSpawn_3_spawnpty (__pyx_self=<optimized out>, __pyx_args=<optimized out>, __pyx_kwds=<optimized out>)
    at /home/vbraun/Sage/git/src/build/cythonized/sage/interfaces/sagespawn.c:1763
#17 0x00007fa6cf2dbe33 in PyObject_Call (func=func@entry=0x7fa6beb1aad0, arg=arg@entry=0x7f9e74261560, kw=kw@entry=0x7f9e6f4e0398)
    at Objects/abstract.c:2529
#18 0x00007fa6cf38cede in ext_do_call (nk=<optimized out>, na=2, flags=<optimized out>, pp_stack=0x7ffcbbf7dc30, func=0x7fa6beb1aad0)
    at Python/ceval.c:4348
#19 PyEval_EvalFrameEx (f=f@entry=0x7f9e72d79580, throwflag=throwflag@entry=0) at Python/ceval.c:2720
#20 0x00007fa6cf392b2c in PyEval_EvalCodeEx (co=<optimized out>, globals=<optimized out>, locals=locals@entry=0x0, args=<optimized out>, 
    argcount=argcount@entry=5, kws=0x7f9e72d2c6c8, kwcount=0, defs=0x7fa6bed85068, defcount=3, closure=0x0) at Python/ceval.c:3267
```



---

archive/issue_comments_324320.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nProbably relevant: http://savannah.gnu.org/bugs/?47400",
    "created_at": "2016-12-05T22:46:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324320",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:7" align="right">comment:7</div>

Probably relevant: http://savannah.gnu.org/bugs/?47400



---

archive/issue_comments_324321.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nI am testing the `OMP_NUM_THREADS=1` thing. It seems to apply even if you haven't compiled openblas with openmp. Have done quite a few loops without incident so far.",
    "created_at": "2016-12-05T22:59:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324321",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:8" align="right">comment:8</div>

I am testing the `OMP_NUM_THREADS=1` thing. It seems to apply even if you haven't compiled openblas with openmp. Have done quite a few loops without incident so far.



---

archive/issue_comments_324322.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\n`OMP_NUM_THREADS=1` seems effective in suppressing the problem so it is probably a related issue. The test also runs quicker and uses less resources.",
    "created_at": "2016-12-05T23:24:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324322",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:9" align="right">comment:9</div>

`OMP_NUM_THREADS=1` seems effective in suppressing the problem so it is probably a related issue. The test also runs quicker and uses less resources.



---

archive/issue_comments_324323.json:
```json
{
    "body": "Branch: **[u/vbraun/openblas_randomly_crashes](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/openblas_randomly_crashes)**",
    "created_at": "2016-12-05T23:30:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324323",
    "user": "https://github.com/vbraun"
}
```

Branch: **[u/vbraun/openblas_randomly_crashes](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/openblas_randomly_crashes)**



---

archive/issue_comments_324324.json:
```json
{
    "body": "Commit: **[`27f412b`](https://github.com/sagemath/sagetrac-mirror/commit/27f412b65b7b13ec908eebec9f26d7036a374174)**",
    "created_at": "2016-12-06T00:04:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324324",
    "user": "https://github.com/kiwifb"
}
```

Commit: **[`27f412b`](https://github.com/sagemath/sagetrac-mirror/commit/27f412b65b7b13ec908eebec9f26d7036a374174)**



---

archive/issue_comments_324325.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nThat's brutal.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/27f412b65b7b13ec908eebec9f26d7036a374174\"><code>27f412b</code></a></td><td><code>Disable multi-threading in OpenBLAS</code></td></tr></table>\n",
    "created_at": "2016-12-06T00:04:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324325",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:11" align="right">comment:11</div>

That's brutal.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/27f412b65b7b13ec908eebec9f26d7036a374174"><code>27f412b</code></a></td><td><code>Disable multi-threading in OpenBLAS</code></td></tr></table>




---

archive/issue_comments_324326.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nBut acceptable as long as we don't properly use OpenBLAS threading in Sage, if that ever happens.\nIIRC even Linbox supposes (or supposed and now enforces it at runtime) that OpenBLAS is single threaded to get optimal performance.",
    "created_at": "2016-12-06T09:03:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324326",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:12" align="right">comment:12</div>

But acceptable as long as we don't properly use OpenBLAS threading in Sage, if that ever happens.
IIRC even Linbox supposes (or supposed and now enforces it at runtime) that OpenBLAS is single threaded to get optimal performance.



---

archive/issue_comments_324327.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nMaybe setting OMP_NUM_THREADS by default to 1 at runtime would be less brutal?",
    "created_at": "2016-12-06T09:03:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324327",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:13" align="right">comment:13</div>

Maybe setting OMP_NUM_THREADS by default to 1 at runtime would be less brutal?



---

archive/issue_comments_324328.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nSee #21323 where a related discussion happened..",
    "created_at": "2016-12-06T09:07:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324328",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:14" align="right">comment:14</div>

See #21323 where a related discussion happened..



---

archive/issue_comments_324329.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nReplying to [@jpflori](#comment%3A13):\n> Maybe setting OMP_NUM_THREADS by default to 1 at runtime would be less brutal?\n\nMore complicated and error prone - by that I mean someone will mess up.",
    "created_at": "2016-12-06T09:08:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324329",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:15" align="right">comment:15</div>

Replying to [@jpflori](#comment%3A13):
> Maybe setting OMP_NUM_THREADS by default to 1 at runtime would be less brutal?

More complicated and error prone - by that I mean someone will mess up.



---

archive/issue_comments_324330.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nDoing it for each call from the code doesn't scale very well. You'll have to find all the code and fix the non-sage code, like cvxopt and scipy, as well. Good luck.",
    "created_at": "2016-12-06T09:10:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324330",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:16" align="right">comment:16</div>

Doing it for each call from the code doesn't scale very well. You'll have to find all the code and fix the non-sage code, like cvxopt and scipy, as well. Good luck.



---

archive/issue_comments_324331.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nI mean setting it globally in sage-env...",
    "created_at": "2016-12-06T09:15:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324331",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:17" align="right">comment:17</div>

I mean setting it globally in sage-env...



---

archive/issue_comments_324332.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@jpflori](#comment%3A17):\n> I mean setting it globally in sage-env...\n\nThat's what I understood before you mentioned #21323. Someone is bound to toy with stuff in `sage-env`. I am half surprised we don't have more incident report because of it. I'll admit that little monster (sage-env) is intimidating.",
    "created_at": "2016-12-06T09:23:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324332",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@jpflori](#comment%3A17):
> I mean setting it globally in sage-env...

That's what I understood before you mentioned #21323. Someone is bound to toy with stuff in `sage-env`. I am half surprised we don't have more incident report because of it. I'll admit that little monster (sage-env) is intimidating.



---

archive/issue_comments_324333.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nSo any conclusion? We are currently in a pretty bad shape as far as running doctests is concerned, about 50% of the time the testsuite fails for me.",
    "created_at": "2016-12-09T22:20:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324333",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:19" align="right">comment:19</div>

So any conclusion? We are currently in a pretty bad shape as far as running doctests is concerned, about 50% of the time the testsuite fails for me.



---

archive/issue_comments_324334.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [@vbraun](#comment%3A19):\n> So any conclusion? We are currently in a pretty bad shape as far as running doctests is concerned, about 50% of the time the testsuite fails for me.\n\nNo bullet proof way I guess. It can always be tempered with, one way or the other. Putting it in `sage-env` has the advantage that it can be picked up by distro while they may not be willing to pack their blas/lapack (whichever it is) single threaded. From my sage-on-distro point of view the only difficulty is when someone import sage from python rather than by starting the sage script (yes you can do that, `env.py` make that possible, `_I_` made sure of that).\n\nSo after bashing it, I will say that `sage-env` offer the most flexibility - and flexibility always cuts both ways.",
    "created_at": "2016-12-10T20:29:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324334",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [@vbraun](#comment%3A19):
> So any conclusion? We are currently in a pretty bad shape as far as running doctests is concerned, about 50% of the time the testsuite fails for me.

No bullet proof way I guess. It can always be tempered with, one way or the other. Putting it in `sage-env` has the advantage that it can be picked up by distro while they may not be willing to pack their blas/lapack (whichever it is) single threaded. From my sage-on-distro point of view the only difficulty is when someone import sage from python rather than by starting the sage script (yes you can do that, `env.py` make that possible, `_I_` made sure of that).

So after bashing it, I will say that `sage-env` offer the most flexibility - and flexibility always cuts both ways.



---

archive/issue_comments_324335.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nGlobally setting `OMP_NUM_THREADS=1` will affect all OpenMP programs, not just OpenBLAS. If thats what you really want then I'm fine with it, just pointing out the obvious.",
    "created_at": "2016-12-11T12:34:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324335",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:21" align="right">comment:21</div>

Globally setting `OMP_NUM_THREADS=1` will affect all OpenMP programs, not just OpenBLAS. If thats what you really want then I'm fine with it, just pointing out the obvious.



---

archive/issue_comments_324336.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nReplying to [@vbraun](#comment%3A21):\n> Globally setting `OMP_NUM_THREADS=1` will affect all OpenMP programs, not just OpenBLAS. If thats what you really want then I'm fine with it, just pointing out the obvious.\n\nThanks for pointing the obvious. I guess your branch has the least side effects on sage as a whole.",
    "created_at": "2016-12-11T20:14:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324336",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:22" align="right">comment:22</div>

Replying to [@vbraun](#comment%3A21):
> Globally setting `OMP_NUM_THREADS=1` will affect all OpenMP programs, not just OpenBLAS. If thats what you really want then I'm fine with it, just pointing out the obvious.

Thanks for pointing the obvious. I guess your branch has the least side effects on sage as a whole.



---

archive/issue_comments_324337.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nIs that a positive review? ;-)",
    "created_at": "2016-12-11T23:05:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324337",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:23" align="right">comment:23</div>

Is that a positive review? ;-)



---

archive/issue_comments_324338.json:
```json
{
    "body": "Reviewer: **Fran\u00e7ois Bissey**",
    "created_at": "2016-12-11T23:15:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324338",
    "user": "https://github.com/kiwifb"
}
```

Reviewer: **Fran√ßois Bissey**



---

archive/issue_comments_324339.json:
```json
{
    "body": "Author: **Volker Braun**",
    "created_at": "2016-12-11T23:15:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324339",
    "user": "https://github.com/kiwifb"
}
```

Author: **Volker Braun**



---

archive/issue_comments_324340.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nI was waiting for you to fill everything in and put it in \"needs_review\" but what the heck. Done!",
    "created_at": "2016-12-11T23:15:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324340",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:24" align="right">comment:24</div>

I was waiting for you to fill everything in and put it in "needs_review" but what the heck. Done!



---

archive/issue_events_305711.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2016-12-11T23:15:28Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22021#event-305711"
}
```



---

archive/issue_comments_324341.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nThanks!",
    "created_at": "2016-12-11T23:26:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324341",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:25" align="right">comment:25</div>

Thanks!



---

archive/issue_events_305712.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-12-11T23:26:46Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22021#event-305712"
}
```



---

archive/issue_events_305713.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-12-11T23:26:46Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22021#event-305713"
}
```



---

archive/issue_events_305714.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-12-12T23:48:50Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22021#event-305714"
}
```



---

archive/issue_events_305715.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-12-12T23:48:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22021#event-305715"
}
```



---

archive/issue_comments_324342.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nHmm fails on OSX\n\n```\n16387[openblas-0.2.19.p0] gfortran -m128bit-long-double -Wall -m64  -L/Users/buildslave-sage/slave/sage_git/build/local/lib -Wl,-rpath,/Users/buildslave-sage/slave/sage_git/build/local/lib  -o sblat3 sblat3.o ../libopenblas_sandybridgep-r0.2.19.a -lpthread -lgfortran -lpthread -lgfortran \n16388[openblas-0.2.19.p0] ld: file too small (length=0) file '../libopenblas_sandybridgep-r0.2.19.a' for architecture x86_64\n16389[openblas-0.2.19.p0] collect2: error: ld returned 1 exit status\n16390[openblas-0.2.19.p0] make[4]: *** [cblat1] Error 1\n```",
    "created_at": "2016-12-12T23:48:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324342",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:26" align="right">comment:26</div>

Hmm fails on OSX

```
16387[openblas-0.2.19.p0] gfortran -m128bit-long-double -Wall -m64  -L/Users/buildslave-sage/slave/sage_git/build/local/lib -Wl,-rpath,/Users/buildslave-sage/slave/sage_git/build/local/lib  -o sblat3 sblat3.o ../libopenblas_sandybridgep-r0.2.19.a -lpthread -lgfortran -lpthread -lgfortran 
16388[openblas-0.2.19.p0] ld: file too small (length=0) file '../libopenblas_sandybridgep-r0.2.19.a' for architecture x86_64
16389[openblas-0.2.19.p0] collect2: error: ld returned 1 exit status
16390[openblas-0.2.19.p0] make[4]: *** [cblat1] Error 1
```



---

archive/issue_comments_324343.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nLooks like a test program problem again. I will investigate ASAP.",
    "created_at": "2016-12-13T07:02:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324343",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:27" align="right">comment:27</div>

Looks like a test program problem again. I will investigate ASAP.



---

archive/issue_comments_324344.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nHum I cannot reproduce it locally, my line is slightly different\n\n```\ngfortran -m128bit-long-double -Wall -m64  -L/Users/fbissey/build/sage/local/lib -Wl,-rpath,/Users/fbissey/build/sage/local/lib  -o sblat3 sblat3.o ../libopenblas_haswell-r0.2.19.a -lgfortran -lgfortran\n```\nNotably I don't have `-lpthread` which is suspicious. Was this a \"binary\" build?",
    "created_at": "2016-12-13T07:54:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324344",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:28" align="right">comment:28</div>

Hum I cannot reproduce it locally, my line is slightly different

```
gfortran -m128bit-long-double -Wall -m64  -L/Users/fbissey/build/sage/local/lib -Wl,-rpath,/Users/fbissey/build/sage/local/lib  -o sblat3 sblat3.o ../libopenblas_haswell-r0.2.19.a -lgfortran -lgfortran
```
Notably I don't have `-lpthread` which is suspicious. Was this a "binary" build?



---

archive/issue_comments_324345.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nNo, just a normal (incremental) build",
    "created_at": "2016-12-13T09:00:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324345",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:29" align="right">comment:29</div>

No, just a normal (incremental) build



---

archive/issue_comments_324346.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nThere are other suspicious bits in the build log,\n\n```\ngcc -O2 -DMAX_STACK_ALLOC=2048 -DEXPRECISION -m128bit-long-double -Wall -m64 -DF_INTERFACE_GFORT -fPIC -DNO_WARMUP -DMAX_CPU_NUMBER=4 -DASMNAME=_ -DASMFNAME=__ -DNAME=_ -DCNAME= -DCHAR_NAME=\\\"_\\\" -DCHAR_CNAME=\\\"\\\" -DNO_AFFINITY -I.. -all_load -headerpad_max_install_names -install_name \"/Users/fbissey/build/sage/local/var/tmp/sage/build/openblas-0.2.19/src/exports/../libopenblas_haswell-r0.2.19.dylib\" -dynamiclib -o ../libopenblas_haswell-r0.2.19.dylib ../libopenblas_haswell-r0.2.19.a -Wl,-exported_symbols_list,osx.def  -L/Users/fbissey/build/sage/local/lib -L/Users/fbissey/build/sage/local/lib/gcc/x86_64-apple-darwin16.1.0/5.4.0 -L/Users/fbissey/build/sage/local/lib/gcc/x86_64-apple-darwin16.1.0/5.4.0/../../.. -L/Users/fbissey/build/sage/local/lib -L/Users/fbissey/build/sage/local/lib/gcc/x86_64-apple-darwin16.1.0/5.4.0 -L/Users/fbissey/build/sage/local/lib/gcc/x86_64-apple-darwin16.1.0/5.4.0/../../..  -lgfortran -lSystem -lquadmath -lm -lSystem -lgfortran -lSystem -lquadmath -lm -lSystem  \nld: warning: object file (/Users/fbissey/build/sage/local/lib/gcc/x86_64-apple-darwin16.1.0/5.4.0/libgcc.a(_muldi3.o)) was built for newer OSX version (10.9) than being linked (10.6)\nld: warning: object file (/Users/fbissey/build/sage/local/lib/gcc/x86_64-apple-darwin16.1.0/5.4.0/libgcc.a(_negdi2.o)) was built for newer OSX version (10.9) than being linked (10.6)\n....\n```\nI get those after the tests are run and before the install (so it happens after your error), I wonder if the problem they are alluding too is fatal in your build. It certainly merit investigation. Also what is the exact version of OS X involved?",
    "created_at": "2016-12-13T09:11:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324346",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:30" align="right">comment:30</div>

There are other suspicious bits in the build log,

```
gcc -O2 -DMAX_STACK_ALLOC=2048 -DEXPRECISION -m128bit-long-double -Wall -m64 -DF_INTERFACE_GFORT -fPIC -DNO_WARMUP -DMAX_CPU_NUMBER=4 -DASMNAME=_ -DASMFNAME=__ -DNAME=_ -DCNAME= -DCHAR_NAME=\"_\" -DCHAR_CNAME=\"\" -DNO_AFFINITY -I.. -all_load -headerpad_max_install_names -install_name "/Users/fbissey/build/sage/local/var/tmp/sage/build/openblas-0.2.19/src/exports/../libopenblas_haswell-r0.2.19.dylib" -dynamiclib -o ../libopenblas_haswell-r0.2.19.dylib ../libopenblas_haswell-r0.2.19.a -Wl,-exported_symbols_list,osx.def  -L/Users/fbissey/build/sage/local/lib -L/Users/fbissey/build/sage/local/lib/gcc/x86_64-apple-darwin16.1.0/5.4.0 -L/Users/fbissey/build/sage/local/lib/gcc/x86_64-apple-darwin16.1.0/5.4.0/../../.. -L/Users/fbissey/build/sage/local/lib -L/Users/fbissey/build/sage/local/lib/gcc/x86_64-apple-darwin16.1.0/5.4.0 -L/Users/fbissey/build/sage/local/lib/gcc/x86_64-apple-darwin16.1.0/5.4.0/../../..  -lgfortran -lSystem -lquadmath -lm -lSystem -lgfortran -lSystem -lquadmath -lm -lSystem  
ld: warning: object file (/Users/fbissey/build/sage/local/lib/gcc/x86_64-apple-darwin16.1.0/5.4.0/libgcc.a(_muldi3.o)) was built for newer OSX version (10.9) than being linked (10.6)
ld: warning: object file (/Users/fbissey/build/sage/local/lib/gcc/x86_64-apple-darwin16.1.0/5.4.0/libgcc.a(_negdi2.o)) was built for newer OSX version (10.9) than being linked (10.6)
....
```
I get those after the tests are run and before the install (so it happens after your error), I wonder if the problem they are alluding too is fatal in your build. It certainly merit investigation. Also what is the exact version of OS X involved?



---

archive/issue_comments_324347.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nIt looks like Openblas wants to build compatible to 10.6. From `Makefile.system`\n\n```\nifeq ($(OSNAME), Darwin)\nexport MACOSX_DEPLOYMENT_TARGET=10.6\nMD5SUM = md5 -r\nendif\n```\nWe currently set `MACOSX_DEPLOYMENT_TARGET` to the system value or 10.9, whichever is lowest. I don't think openblas should over-ride an external setting of that kind.",
    "created_at": "2016-12-13T09:20:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324347",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:31" align="right">comment:31</div>

It looks like Openblas wants to build compatible to 10.6. From `Makefile.system`

```
ifeq ($(OSNAME), Darwin)
export MACOSX_DEPLOYMENT_TARGET=10.6
MD5SUM = md5 -r
endif
```
We currently set `MACOSX_DEPLOYMENT_TARGET` to the system value or 10.9, whichever is lowest. I don't think openblas should over-ride an external setting of that kind.



---

archive/issue_comments_324348.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nSorry, I don't have much sage time these days.\nThe correct env variable is `OPENBLAS_NUM_THREADS`.\nSee:\n* https://github.com/xianyi/OpenBLAS/wiki/faq#multi-threaded",
    "created_at": "2016-12-13T16:11:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324348",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:32" align="right">comment:32</div>

Sorry, I don't have much sage time these days.
The correct env variable is `OPENBLAS_NUM_THREADS`.
See:
* https://github.com/xianyi/OpenBLAS/wiki/faq#multi-threaded



---

archive/issue_comments_324349.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nReplying to [@jpflori](#comment%3A32):\n> Sorry, I don't have much sage time these days.\n> The correct env variable is `OPENBLAS_NUM_THREADS`.\n> See:\n> * https://github.com/xianyi/OpenBLAS/wiki/faq#multi-threaded\n\nIs the right variable for runtime, not build time. Volker got it right according to the same link. However for some reason I think threads were not completely disabled in his build.",
    "created_at": "2016-12-13T19:58:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324349",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:33" align="right">comment:33</div>

Replying to [@jpflori](#comment%3A32):
> Sorry, I don't have much sage time these days.
> The correct env variable is `OPENBLAS_NUM_THREADS`.
> See:
> * https://github.com/xianyi/OpenBLAS/wiki/faq#multi-threaded

Is the right variable for runtime, not build time. Volker got it right according to the same link. However for some reason I think threads were not completely disabled in his build.



---

archive/issue_comments_324350.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nI cannot figure out where the `-lpthread` originate in your build Volker.",
    "created_at": "2016-12-14T03:55:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324350",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:34" align="right">comment:34</div>

I cannot figure out where the `-lpthread` originate in your build Volker.



---

archive/issue_comments_324351.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nI think I found where you get `pthread` from and that may be the root cause. We may have a \"shell\" accident depending on version. It is still rather strange that I cannot reproduce it.",
    "created_at": "2016-12-14T21:12:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324351",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:35" align="right">comment:35</div>

I think I found where you get `pthread` from and that may be the root cause. We may have a "shell" accident depending on version. It is still rather strange that I cannot reproduce it.



---

archive/issue_comments_324352.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nLet's try with these bits of QA.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/026672777b73c63b58800135796caa3981faf924\"><code>0266727</code></a></td><td><code>Fix a few QA in Openblas</code></td></tr></table>\n",
    "created_at": "2016-12-15T07:44:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324352",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:36" align="right">comment:36</div>

Let's try with these bits of QA.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/026672777b73c63b58800135796caa3981faf924"><code>0266727</code></a></td><td><code>Fix a few QA in Openblas</code></td></tr></table>




---

archive/issue_comments_324353.json:
```json
{
    "body": "Changed commit from **[`27f412b`](https://github.com/sagemath/sagetrac-mirror/commit/27f412b65b7b13ec908eebec9f26d7036a374174)** to **[`0266727`](https://github.com/sagemath/sagetrac-mirror/commit/026672777b73c63b58800135796caa3981faf924)**",
    "created_at": "2016-12-15T07:44:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324353",
    "user": "https://github.com/kiwifb"
}
```

Changed commit from **[`27f412b`](https://github.com/sagemath/sagetrac-mirror/commit/27f412b65b7b13ec908eebec9f26d7036a374174)** to **[`0266727`](https://github.com/sagemath/sagetrac-mirror/commit/026672777b73c63b58800135796caa3981faf924)**



---

archive/issue_comments_324354.json:
```json
{
    "body": "Changed branch from **[u/vbraun/openblas_randomly_crashes](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/openblas_randomly_crashes)** to **[u/fbissey/openblas_randomly_crashes](https://github.com/sagemath/sagetrac-mirror/tree/u/fbissey/openblas_randomly_crashes)**",
    "created_at": "2016-12-15T07:44:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324354",
    "user": "https://github.com/kiwifb"
}
```

Changed branch from **[u/vbraun/openblas_randomly_crashes](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/openblas_randomly_crashes)** to **[u/fbissey/openblas_randomly_crashes](https://github.com/sagemath/sagetrac-mirror/tree/u/fbissey/openblas_randomly_crashes)**



---

archive/issue_events_305716.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2016-12-18T07:19:41Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22021#event-305716"
}
```



---

archive/issue_events_305717.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2016-12-18T07:19:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22021#event-305717"
}
```



---

archive/issue_comments_324355.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nTwo of the patches I have added to this branch have now been upstreamed. Only the last one about the `SMP` variable use in `ifdef` has not been submitted yet. This one cure the fact you have `-lpthread` when you shouldn't. It fells like something other than a recent `bash` is used on that machine.",
    "created_at": "2016-12-18T07:19:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324355",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:37" align="right">comment:37</div>

Two of the patches I have added to this branch have now been upstreamed. Only the last one about the `SMP` variable use in `ifdef` has not been submitted yet. This one cure the fact you have `-lpthread` when you shouldn't. It fells like something other than a recent `bash` is used on that machine.



---

archive/issue_events_305718.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-12-24T19:35:48Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22021#event-305718"
}
```



---

archive/issue_events_305719.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-12-24T19:35:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22021#event-305719"
}
```



---

archive/issue_comments_324356.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nFollowup at #22100",
    "created_at": "2016-12-25T15:55:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324356",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:39" align="right">comment:39</div>

Followup at #22100



---

archive/issue_events_305720.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-12-25T20:08:08Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22021#event-305720"
}
```



---

archive/issue_events_305721.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "eda96f33267984aaf82f96f759c654a185439c72",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2016-12-25T20:08:08Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/22021#event-305721"
}
```



---

archive/issue_comments_324357.json:
```json
{
    "body": "Changed branch from **[u/fbissey/openblas_randomly_crashes](https://github.com/sagemath/sagetrac-mirror/tree/u/fbissey/openblas_randomly_crashes)** to **[`0266727`](https://github.com/sagemath/sagetrac-mirror/commit/026672777b73c63b58800135796caa3981faf924)**",
    "created_at": "2016-12-25T20:08:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324357",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/fbissey/openblas_randomly_crashes](https://github.com/sagemath/sagetrac-mirror/tree/u/fbissey/openblas_randomly_crashes)** to **[`0266727`](https://github.com/sagemath/sagetrac-mirror/commit/026672777b73c63b58800135796caa3981faf924)**



---

archive/issue_comments_324358.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\nApparently this still happens sometimes in sage 8.1.beta6, I created #23933 for this.",
    "created_at": "2017-09-26T14:44:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324358",
    "user": "https://github.com/koffie"
}
```

<div id="comment:41" align="right">comment:41</div>

Apparently this still happens sometimes in sage 8.1.beta6, I created #23933 for this.



---

archive/issue_comments_324359.json:
```json
{
    "body": "Changed commit from **[`0266727`](https://github.com/sagemath/sagetrac-mirror/commit/026672777b73c63b58800135796caa3981faf924)** to none",
    "created_at": "2017-09-26T14:44:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324359",
    "user": "https://github.com/koffie"
}
```

Changed commit from **[`0266727`](https://github.com/sagemath/sagetrac-mirror/commit/026672777b73c63b58800135796caa3981faf924)** to none



---

archive/issue_comments_324360.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nYou discarded the option to set `OMP_NUM_THREADS=1`. What about `OPENBLAS_NUM_THREADS=1`? This came up in #26118 (`sage -tp` does not scale to many cores.)",
    "created_at": "2018-08-24T14:32:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/22021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/22021#issuecomment-324360",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:42" align="right">comment:42</div>

You discarded the option to set `OMP_NUM_THREADS=1`. What about `OPENBLAS_NUM_THREADS=1`? This came up in #26118 (`sage -tp` does not scale to many cores.)
