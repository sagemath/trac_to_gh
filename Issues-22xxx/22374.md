# Issue 22374: Replace _sage_doc_ by a __doc__ descriptor

archive/issues_022374.json:
```json
{
    "body": "CC:  @hivert @nthiery\n\nKeywords: days85\n\nCurrently, the method `_sage_doc_` is used to implement custom documentation for instances of a class. Such a use case makes sense, but it should be implemented as the `__doc__` attribute instead of the Sage-specific `_sage_doc_`.\n\nI tried various ways of implementing this and I found several Cython bugs along the way. The current solution is not the cleanest, but it works in all cases (Cython and Python, extension types and normal classes).\n\nIn the cases where `_sage_doc_` was implemented for a base class, this patch requires adding ``@`instancedoc` to every subclass. This is because Python never inherits the `__doc__` attribute. There is a way around this using a metaclass, but I avoided that because metaclasses have their own problems (see #21681).\n\nIssue created by migration from https://trac.sagemath.org/ticket/22611\n\n",
    "closed_at": "2017-03-29T16:51:16Z",
    "created_at": "2017-03-15T20:20:27Z",
    "labels": [
        "component: documentation"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.6",
    "title": "Replace _sage_doc_ by a __doc__ descriptor",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22374",
    "user": "https://github.com/jdemeyer"
}
```
CC:  @hivert @nthiery

Keywords: days85

Currently, the method `_sage_doc_` is used to implement custom documentation for instances of a class. Such a use case makes sense, but it should be implemented as the `__doc__` attribute instead of the Sage-specific `_sage_doc_`.

I tried various ways of implementing this and I found several Cython bugs along the way. The current solution is not the cleanest, but it works in all cases (Cython and Python, extension types and normal classes).

In the cases where `_sage_doc_` was implemented for a base class, this patch requires adding ``@`instancedoc` to every subclass. This is because Python never inherits the `__doc__` attribute. There is a way around this using a metaclass, but I avoided that because metaclasses have their own problems (see #21681).

Issue created by migration from https://trac.sagemath.org/ticket/22611





---

archive/issue_comments_310709.json:
```json
{
    "body": "Changing keywords from \"\" to \"days85\".",
    "created_at": "2017-03-17T09:06:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22374#issuecomment-310709",
    "user": "https://github.com/jdemeyer"
}
```

Changing keywords from "" to "days85".



---

archive/issue_comments_310710.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-03-17T21:46:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22374#issuecomment-310710",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_310711.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-03-17T21:46:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22374#issuecomment-310711",
    "user": "https://github.com/jdemeyer"
}
```

New commits:



---

archive/issue_comments_310712.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-03-17T23:08:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22374#issuecomment-310712",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_310713.json:
```json
{
    "body": "There was an issue building the docs due to `src/sage/parallel/decorate.py`. I did not understand the problem but I fixed it anyway with\n\n```diff\ndiff --git a/src/sage/parallel/decorate.py b/src/sage/parallel/decorate.py\nindex ebc06e2..3305724 100644\n--- a/src/sage/parallel/decorate.py\n+++ b/src/sage/parallel/decorate.py\n@@ -284,8 +287,7 @@ for a in args[0]))\n             sage: sage_getdoc(p(f))\n             'Test docstring\\n'\n         \"\"\"\n-        from sage.misc.sageinspect import sage_getdoc\n-        return sage_getdoc(self.func)\n+        return self.func.__doc__\n \n \n def parallel(p_iter='fork', ncpus=None, **kwds):\n```",
    "created_at": "2017-03-18T06:35:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22374#issuecomment-310713",
    "user": "https://github.com/jdemeyer"
}
```

There was an issue building the docs due to `src/sage/parallel/decorate.py`. I did not understand the problem but I fixed it anyway with

```diff
diff --git a/src/sage/parallel/decorate.py b/src/sage/parallel/decorate.py
index ebc06e2..3305724 100644
--- a/src/sage/parallel/decorate.py
+++ b/src/sage/parallel/decorate.py
@@ -284,8 +287,7 @@ for a in args[0]))
             sage: sage_getdoc(p(f))
             'Test docstring\n'
         """
-        from sage.misc.sageinspect import sage_getdoc
-        return sage_getdoc(self.func)
+        return self.func.__doc__
 
 
 def parallel(p_iter='fork', ncpus=None, **kwds):
```



---

archive/issue_comments_310714.json:
```json
{
    "body": "In ticket description: `and I was various Cython bugs along the way`!?",
    "created_at": "2017-03-18T09:46:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22374#issuecomment-310714",
    "user": "https://github.com/videlec"
}
```

In ticket description: `and I was various Cython bugs along the way`!?



---

archive/issue_comments_310715.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-03-21T09:52:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22374#issuecomment-310715",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_310716.json:
```json
{
    "body": "This is just a stupid comment, but I'm curious about the naming--why ``@`InstanceDoc` and not ``@`instance_doc`?  For whatever reason it's more common to name decorators with underscores instead of camel case (so much so that people will even go against the camel case convention for classes in cases where a decorator is implemented as a class).\n\nThen again, maybe the existing naming nicely calls attention to the fact that this is intended as a class decorator.",
    "created_at": "2017-03-22T13:27:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22374#issuecomment-310716",
    "user": "https://github.com/embray"
}
```

This is just a stupid comment, but I'm curious about the naming--why ``@`InstanceDoc` and not ``@`instance_doc`?  For whatever reason it's more common to name decorators with underscores instead of camel case (so much so that people will even go against the camel case convention for classes in cases where a decorator is implemented as a class).

Then again, maybe the existing naming nicely calls attention to the fact that this is intended as a class decorator.



---

archive/issue_comments_310717.json:
```json
{
    "body": "What happens if `_instancedoc_` is not defined?  Will Cython make sure an `AttributeError` is raised in this case?\n\nI think at the very least there should be a clear error message that `_instancedoc_` must be defined (including on base classes that may not have a sensible `_instancedoc_`, in which case it might be good if the descriptor also handled `NotImplemented` errors).",
    "created_at": "2017-03-22T13:36:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22374#issuecomment-310717",
    "user": "https://github.com/embray"
}
```

What happens if `_instancedoc_` is not defined?  Will Cython make sure an `AttributeError` is raised in this case?

I think at the very least there should be a clear error message that `_instancedoc_` must be defined (including on base classes that may not have a sensible `_instancedoc_`, in which case it might be good if the descriptor also handled `NotImplemented` errors).



---

archive/issue_comments_310718.json:
```json
{
    "body": "LGTM otherwise. Clever way to abuse the Python internals a bit, though I can't see anything inherently wrong with it, since tp_doc is suppose to be able to be NULL.",
    "created_at": "2017-03-22T13:48:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22374#issuecomment-310718",
    "user": "https://github.com/embray"
}
```

LGTM otherwise. Clever way to abuse the Python internals a bit, though I can't see anything inherently wrong with it, since tp_doc is suppose to be able to be NULL.



---

archive/issue_comments_310719.json:
```json
{
    "body": "Replying to [comment:12 embray]:\n> LGTM otherwise. Clever way to abuse the Python internals a bit\n\n\nLike I say on the ticket description, this is the only way to make it work for all classes. Any pure Python implementation wouldn't work for extension types.",
    "created_at": "2017-03-22T15:11:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22374#issuecomment-310719",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:12 embray]:
> LGTM otherwise. Clever way to abuse the Python internals a bit


Like I say on the ticket description, this is the only way to make it work for all classes. Any pure Python implementation wouldn't work for extension types.



---

archive/issue_comments_310720.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-03-22T15:12:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22374#issuecomment-310720",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_310721.json:
```json
{
    "body": "Replying to [comment:11 embray]:\n> What happens if `_instancedoc_` is not defined?  Will Cython make sure an `AttributeError` is raised in this case?\n\n\nYes, `AttributeError` works the same way in Cython.",
    "created_at": "2017-03-22T15:12:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22374#issuecomment-310721",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:11 embray]:
> What happens if `_instancedoc_` is not defined?  Will Cython make sure an `AttributeError` is raised in this case?


Yes, `AttributeError` works the same way in Cython.



---

archive/issue_comments_310722.json:
```json
{
    "body": "Replying to [comment:11 embray]:\n> What happens if `_instancedoc_` is not defined?  Will Cython make sure an `AttributeError` is raised in this case?\n> \n> I think at the very least there should be a clear error message that `_instancedoc_` must be defined\n\n\nYou mean an error which is not just `AttributeError: 'foo' object has no attribute '_instancedoc_'`?",
    "created_at": "2017-03-22T15:15:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22374#issuecomment-310722",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:11 embray]:
> What happens if `_instancedoc_` is not defined?  Will Cython make sure an `AttributeError` is raised in this case?
> 
> I think at the very least there should be a clear error message that `_instancedoc_` must be defined


You mean an error which is not just `AttributeError: 'foo' object has no attribute '_instancedoc_'`?



---

archive/issue_comments_310723.json:
```json
{
    "body": "Right.  For example, in classes with the `ABCMeta` metaclass, if there are any unimplemented `abstractproperty` or `abstractmethod`, trying to instantiate the class results in:\n\n```\nTypeError: Can't instantiate abstract class A with abstract methods foo\n```\n\nThis is a slightly different case of course, since it's an error that would occur at class definition time.  I was just using this as an example of a clearer error message.",
    "created_at": "2017-03-22T16:04:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22374#issuecomment-310723",
    "user": "https://github.com/embray"
}
```

Right.  For example, in classes with the `ABCMeta` metaclass, if there are any unimplemented `abstractproperty` or `abstractmethod`, trying to instantiate the class results in:

```
TypeError: Can't instantiate abstract class A with abstract methods foo
```

This is a slightly different case of course, since it's an error that would occur at class definition time.  I was just using this as an example of a clearer error message.



---

archive/issue_comments_310724.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-03-22T16:12:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22374#issuecomment-310724",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_310725.json:
```json
{
    "body": "I replaced `InstanceDoc` with `instancedoc` (I didn't use `instance_doc` just because the method name `_instancedoc_` doesn't have an underscore either. And anyway, Python uses `staticmethod` and not `static_method`.)",
    "created_at": "2017-03-22T16:14:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22374#issuecomment-310725",
    "user": "https://github.com/jdemeyer"
}
```

I replaced `InstanceDoc` with `instancedoc` (I didn't use `instance_doc` just because the method name `_instancedoc_` doesn't have an underscore either. And anyway, Python uses `staticmethod` and not `static_method`.)



---

archive/issue_comments_310726.json:
```json
{
    "body": "I still don't think the `AttributeError` is very useful, especially considering that you're getting an exception from a builtin module and can't see in the traceback what's actually causing it.  Of course, if one is implementing a class using ``@`instancedoc` this should be expected, but it still might seem mysterious, I think, compared to a slightly customized message (it could still be an `AttributeError`, though `TypeError` is used more commonly for cases where an expected interface is not found--e.g. `len()` on an object with no `__len__`.).",
    "created_at": "2017-03-22T16:21:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22374#issuecomment-310726",
    "user": "https://github.com/embray"
}
```

I still don't think the `AttributeError` is very useful, especially considering that you're getting an exception from a builtin module and can't see in the traceback what's actually causing it.  Of course, if one is implementing a class using ``@`instancedoc` this should be expected, but it still might seem mysterious, I think, compared to a slightly customized message (it could still be an `AttributeError`, though `TypeError` is used more commonly for cases where an expected interface is not found--e.g. `len()` on an object with no `__len__`.).



---

archive/issue_comments_310727.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-03-23T10:17:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22374#issuecomment-310727",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_310728.json:
```json
{
    "body": "Here you go...",
    "created_at": "2017-03-23T10:21:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22374#issuecomment-310728",
    "user": "https://github.com/jdemeyer"
}
```

Here you go...



---

archive/issue_comments_310729.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-03-23T10:21:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22374#issuecomment-310729",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_310730.json:
```json
{
    "body": "Great, I think that's a lot nicer!  Thanks for this--honestly this is so useful I think some form of this should be implemented in Python.  I might suggest that, actually, since I see the question of per-instance docstrings come up from time to time, with no good solution.  If some kind of `__instancedoc__` special method were built into Python it would obviate the need for the special descriptor or the decorator.",
    "created_at": "2017-03-23T11:05:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22374#issuecomment-310730",
    "user": "https://github.com/embray"
}
```

Great, I think that's a lot nicer!  Thanks for this--honestly this is so useful I think some form of this should be implemented in Python.  I might suggest that, actually, since I see the question of per-instance docstrings come up from time to time, with no good solution.  If some kind of `__instancedoc__` special method were built into Python it would obviate the need for the special descriptor or the decorator.



---

archive/issue_comments_310731.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-03-23T11:05:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22374#issuecomment-310731",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_310732.json:
```json
{
    "body": "Thanks!",
    "created_at": "2017-03-23T20:36:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22374#issuecomment-310732",
    "user": "https://github.com/jdemeyer"
}
```

Thanks!



---

archive/issue_events_058989.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-03-29T16:51:16Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/22374",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22374#event-58989"
}
```



---

archive/issue_comments_310733.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-03-29T16:51:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22374",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22374#issuecomment-310733",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
