# Issue 22471: Gen: clean up "new_ref" mechanism

archive/issues_022234.json:
```json
{
    "body": "I have always found it hard to understand the `new_ref` mechanism of `Gen` and what the related attributes `b` and `refers_to` mean. I propose:\n\n1. Rename `b` to `chunck`.\n\n2. Split `refers_to` in two because it is used in two independent ways: instead add `parent` and `itemcache` attributes.\n\n3. Turn `new_ref` into a method of `Gen`.\n\n4. Document this a lot better.\n\nCC:  @defeo @videlec\n\nKeywords: days85\n\nBranch/Commit: f7bc5b7ea8205e31ef4d98928d289c79c0f9e893\n\nReviewer: Luca De Feo\n\nAuthor: Jeroen Demeyer\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/22471\n\n",
    "closed_at": "2017-03-27T20:42:14Z",
    "created_at": "2017-02-28T13:51:19Z",
    "labels": [
        "component: misc"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.6",
    "title": "Gen: clean up \"new_ref\" mechanism",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22471",
    "user": "https://github.com/jdemeyer"
}
```
I have always found it hard to understand the `new_ref` mechanism of `Gen` and what the related attributes `b` and `refers_to` mean. I propose:

1. Rename `b` to `chunck`.

2. Split `refers_to` in two because it is used in two independent ways: instead add `parent` and `itemcache` attributes.

3. Turn `new_ref` into a method of `Gen`.

4. Document this a lot better.

CC:  @defeo @videlec

Keywords: days85

Branch/Commit: f7bc5b7ea8205e31ef4d98928d289c79c0f9e893

Reviewer: Luca De Feo

Author: Jeroen Demeyer

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/22471





---

archive/issue_comments_328977.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -2,7 +2,7 @@\n \n 1. Rename \\`b\\` to \\`chunck\\`.\n \n-2. Split \\`refers_to\\` in two because it is used in two independent ways: instead add \\`parent\\` and \\`index_cache\\` attributes.\n+2. Split \\`refers_to\\` in two because it is used in two independent ways: instead add \\`parent\\` and \\`itemcache\\` attributes.\n \n 3. Document this a lot better.\n \n```\n",
    "created_at": "2017-02-28T14:01:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22471",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22471#issuecomment-328977",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -2,7 +2,7 @@
 
 1. Rename \`b\` to \`chunck\`.
 
-2. Split \`refers_to\` in two because it is used in two independent ways: instead add \`parent\` and \`index_cache\` attributes.
+2. Split \`refers_to\` in two because it is used in two independent ways: instead add \`parent\` and \`itemcache\` attributes.
 
 3. Document this a lot better.
 
```




---

archive/issue_comments_328978.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,12 @@\n+I have always found it hard to understand what the attributes \\`b\\` and \\`refers_to\\` mean. I propose:\n \n+1. Rename \\`b\\` to \\`chunck\\`.\n+\n+2. Split \\`refers_to\\` in two because it is used in two independent ways: instead add \\`parent\\` and \\`itemcache\\` attributes.\n+\n+3. Turn \\`new_ref\\` into a method of \\`Gen_auto\\`.\n+\n+4. Document this a lot better.\n \n Author: Jeroen Demeyer\n \n```\n",
    "created_at": "2017-02-28T14:34:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22471",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22471#issuecomment-328978",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,12 @@
+I have always found it hard to understand what the attributes \`b\` and \`refers_to\` mean. I propose:
 
+1. Rename \`b\` to \`chunck\`.
+
+2. Split \`refers_to\` in two because it is used in two independent ways: instead add \`parent\` and \`itemcache\` attributes.
+
+3. Turn \`new_ref\` into a method of \`Gen_auto\`.
+
+4. Document this a lot better.
 
 Author: Jeroen Demeyer
 
```




---

archive/issue_comments_328979.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,12 @@\n+I have always found it hard to understand what the attributes \\`b\\` and \\`refers_to\\` mean. I propose:\n \n+1. Rename \\`b\\` to \\`chunck\\`.\n+\n+2. Split \\`refers_to\\` in two because it is used in two independent ways: instead add \\`parent\\` and \\`itemcache\\` attributes.\n+\n+3. Turn \\`new_ref\\` into a method of \\`Gen\\`.\n+\n+4. Document this a lot better.\n \n Author: Jeroen Demeyer\n \n```\n",
    "created_at": "2017-02-28T14:47:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22471",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22471#issuecomment-328979",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,12 @@
+I have always found it hard to understand what the attributes \`b\` and \`refers_to\` mean. I propose:
 
+1. Rename \`b\` to \`chunck\`.
+
+2. Split \`refers_to\` in two because it is used in two independent ways: instead add \`parent\` and \`itemcache\` attributes.
+
+3. Turn \`new_ref\` into a method of \`Gen\`.
+
+4. Document this a lot better.
 
 Author: Jeroen Demeyer
 
```




---

archive/issue_comments_328980.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,12 @@\n+I have always found it hard to understand the \\`new_ref\\` mechanism of \\`Gen\\` and what the related attributes \\`b\\` and \\`refers_to\\` mean. I propose:\n \n+1. Rename \\`b\\` to \\`chunck\\`.\n+\n+2. Split \\`refers_to\\` in two because it is used in two independent ways: instead add \\`parent\\` and \\`itemcache\\` attributes.\n+\n+3. Turn \\`new_ref\\` into a method of \\`Gen\\`.\n+\n+4. Document this a lot better.\n \n Author: Jeroen Demeyer\n \n```\n",
    "created_at": "2017-02-28T16:33:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22471",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22471#issuecomment-328980",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,12 @@
+I have always found it hard to understand the \`new_ref\` mechanism of \`Gen\` and what the related attributes \`b\` and \`refers_to\` mean. I propose:
 
+1. Rename \`b\` to \`chunck\`.
+
+2. Split \`refers_to\` in two because it is used in two independent ways: instead add \`parent\` and \`itemcache\` attributes.
+
+3. Turn \`new_ref\` into a method of \`Gen\`.
+
+4. Document this a lot better.
 
 Author: Jeroen Demeyer
 
```




---

archive/issue_comments_328981.json:
```json
{
    "body": "<a id='comment:6'></a>New commits:",
    "created_at": "2017-02-28T18:46:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22471",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22471#issuecomment-328981",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>New commits:



---

archive/issue_comments_328982.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-02-28T18:46:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22471",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22471#issuecomment-328982",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_328983.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-03-01T08:26:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22471",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22471#issuecomment-328983",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_328984.json:
```json
{
    "body": "<a id='comment:8'></a>Since this is moving `new_ref`, I'll take the occasion to ask whether `_new_ref` wouldn't be a better name. Isn't it the case that this is exclusively for internal purposes?",
    "created_at": "2017-03-03T15:50:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22471",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22471#issuecomment-328984",
    "user": "https://github.com/defeo"
}
```

<a id='comment:8'></a>Since this is moving `new_ref`, I'll take the occasion to ask whether `_new_ref` wouldn't be a better name. Isn't it the case that this is exclusively for internal purposes?



---

archive/issue_comments_328985.json:
```json
{
    "body": "<a id='comment:9'></a>The Python3 plugin is failing (one doctest uses `cmp`)",
    "created_at": "2017-03-03T15:51:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22471",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22471#issuecomment-328985",
    "user": "https://github.com/defeo"
}
```

<a id='comment:9'></a>The Python3 plugin is failing (one doctest uses `cmp`)



---

archive/issue_comments_328986.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:8 defeo]:\n> Since this is moving `new_ref`, I'll take the occasion to ask whether `_new_ref` wouldn't be a better name. Isn't it the case that this is exclusively for internal purposes?\n\n\nI would argue that it's part of the public Cython API (for example, it's used in the new `power_series_pari.pyx`), so it doesn't need to be private. Note that it's a `cdef` method, so it will not bother TAB-completion.",
    "created_at": "2017-03-03T21:05:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22471",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22471#issuecomment-328986",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>Replying to [comment:8 defeo]:
> Since this is moving `new_ref`, I'll take the occasion to ask whether `_new_ref` wouldn't be a better name. Isn't it the case that this is exclusively for internal purposes?


I would argue that it's part of the public Cython API (for example, it's used in the new `power_series_pari.pyx`), so it doesn't need to be private. Note that it's a `cdef` method, so it will not bother TAB-completion.



---

archive/issue_comments_328987.json:
```json
{
    "body": "<a id='comment:11'></a>That being said, I want my choose my battles wisely and focus on method name bikeshedding in #22470 :-)\n\nSo if you insist on `_new_ref`, I will gladly make the change.",
    "created_at": "2017-03-03T21:13:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22471",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22471#issuecomment-328987",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>That being said, I want my choose my battles wisely and focus on method name bikeshedding in #22470 :-)

So if you insist on `_new_ref`, I will gladly make the change.



---

archive/issue_comments_328988.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:11 jdemeyer]:\n> That being said, I want my choose my battles wisely and focus on method name bikeshedding in #22470 :-)\n> \n> So if you insist on `_new_ref`, I will gladly make the change.\n\n\nNo, no. The argument on `new_ref` being used by power series is a good one. I hadn't read the diff that far.\n\nThe Py3 failure must be dealt with, however.",
    "created_at": "2017-03-03T21:17:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22471",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22471#issuecomment-328988",
    "user": "https://github.com/defeo"
}
```

<a id='comment:12'></a>Replying to [comment:11 jdemeyer]:
> That being said, I want my choose my battles wisely and focus on method name bikeshedding in #22470 :-)
> 
> So if you insist on `_new_ref`, I will gladly make the change.


No, no. The argument on `new_ref` being used by power series is a good one. I hadn't read the diff that far.

The Py3 failure must be dealt with, however.



---

archive/issue_comments_328989.json:
```json
{
    "body": "<a id='comment:13'></a>About the py3 failure:\n\nThis is OK since Cython understands `xrange`:\n\n```\n            inds = xrange(*n.indices(l))\n```\n\nThis comes from the dependency which is merged now (there is no `cmp` in the current diff):\n\n```\n            sage: cmp(pari('2/3'), pari('2/5'))\n```\n\nSo there is nothing to be done here...",
    "created_at": "2017-03-04T10:29:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22471",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22471#issuecomment-328989",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>About the py3 failure:

This is OK since Cython understands `xrange`:

```
            inds = xrange(*n.indices(l))
```

This comes from the dependency which is merged now (there is no `cmp` in the current diff):

```
            sage: cmp(pari('2/3'), pari('2/5'))
```

So there is nothing to be done here...



---

archive/issue_comments_328990.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:13 jdemeyer]:\n> About the py3 failure:\n> \n> This is OK since Cython understands `xrange`:\n> \n> ```\n>             inds = xrange(*n.indices(l))\n> ```\n\n\nMmm... right. But is it going to support it in the long run? I cannot find much info on what Cython plans are. What's the most future proof way of using iterators in Cython?\n\n> This comes from the dependency which is merged now (there is no `cmp` in the current diff):\n> \n> ```\n>             sage: cmp(pari('2/3'), pari('2/5'))\n> ```\n> \n> So there is nothing to be done here...\n\n\nRight. That'll be for another ticket.",
    "created_at": "2017-03-04T14:04:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22471",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22471#issuecomment-328990",
    "user": "https://github.com/defeo"
}
```

<a id='comment:15'></a>Replying to [comment:13 jdemeyer]:
> About the py3 failure:
> 
> This is OK since Cython understands `xrange`:
> 
> ```
>             inds = xrange(*n.indices(l))
> ```


Mmm... right. But is it going to support it in the long run? I cannot find much info on what Cython plans are. What's the most future proof way of using iterators in Cython?

> This comes from the dependency which is merged now (there is no `cmp` in the current diff):
> 
> ```
>             sage: cmp(pari('2/3'), pari('2/5'))
> ```
> 
> So there is nothing to be done here...


Right. That'll be for another ticket.



---

archive/issue_comments_328991.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:15 defeo]:\n> Replying to [comment:13 jdemeyer]:\n> > About the py3 failure:\n> > \n> > This is OK since Cython understands `xrange`:\n> > \n> > ```\n> >             inds = xrange(*n.indices(l))\n> > ```\n\n> \n> Mmm... right. But is it going to support it in the long run?\n\n\nWhy should they not? It's not deprecated or anything...",
    "created_at": "2017-03-04T21:32:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22471",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22471#issuecomment-328991",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'></a>Replying to [comment:15 defeo]:
> Replying to [comment:13 jdemeyer]:
> > About the py3 failure:
> > 
> > This is OK since Cython understands `xrange`:
> > 
> > ```
> >             inds = xrange(*n.indices(l))
> > ```

> 
> Mmm... right. But is it going to support it in the long run?


Why should they not? It's not deprecated or anything...



---

archive/issue_comments_328992.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-03-14T19:18:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22471",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22471#issuecomment-328992",
    "user": "https://github.com/defeo"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_328993.json:
```json
{
    "body": "<a id='comment:17'></a>Nice cleanup. Good to go!",
    "created_at": "2017-03-14T19:18:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22471",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22471#issuecomment-328993",
    "user": "https://github.com/defeo"
}
```

<a id='comment:17'></a>Nice cleanup. Good to go!



---

archive/issue_comments_328994.json:
```json
{
    "body": "Changing keywords from \"\" to \"days85\".",
    "created_at": "2017-03-14T19:55:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22471",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22471#issuecomment-328994",
    "user": "https://github.com/defeo"
}
```

Changing keywords from "" to "days85".



---

archive/issue_comments_328995.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-03-27T20:42:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22471",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22471#issuecomment-328995",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_058756.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-03-27T20:42:14Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/22471",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22471#event-58756"
}
```
