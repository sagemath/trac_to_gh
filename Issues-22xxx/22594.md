# Issue 22594: bug in cartesian product ?

archive/issues_022357.json:
```json
{
    "body": "Something goes very wrong here:\n\n```\nsage: bring=ZZ\nsage: for a in cartesian_product([[bring.one()]]):\n....:     print a[0].parent()\n....:     \nInteger Ring\nsage: bring=QQ\nsage: for a in cartesian_product([[bring.one()]]):\n....:     print a[0].parent()\n....:     \nInteger Ring\n```\n\nCC:  @tscrim @nthiery\n\nKeywords: days85\n\nStatus: new\n\nIssue created by migration from https://trac.sagemath.org/ticket/22594\n\n",
    "created_at": "2017-03-13T15:01:41Z",
    "labels": [
        "component: combinatorics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.6",
    "title": "bug in cartesian product ?",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22594",
    "user": "https://github.com/fchapoton"
}
```
Something goes very wrong here:

```
sage: bring=ZZ
sage: for a in cartesian_product([[bring.one()]]):
....:     print a[0].parent()
....:     
Integer Ring
sage: bring=QQ
sage: for a in cartesian_product([[bring.one()]]):
....:     print a[0].parent()
....:     
Integer Ring
```

CC:  @tscrim @nthiery

Keywords: days85

Status: new

Issue created by migration from https://trac.sagemath.org/ticket/22594





---

archive/issue_comments_414531.json:
```json
{
    "body": "Hi Frederic,\n\nReplying to [ticket:22594 chapoton]:\nActually what goes very wrong is that:\n\n```\ncartesian_product([[ZZ.one()]]) is cartesian_product([[QQ.one()]])\n```\nNote that if you relaunch a new sage, and ask the computation in the reverse order, you'll get:\n\n```\nsage: bring=QQ\nsage: for a in cartesian_product([[bring.one()]]):\n....:     print a[0].parent()\n....:     \nRational Field\nsage: bring=ZZ\nsage: for a in cartesian_product([[bring.one()]]):\n....:     print a[0].parent()\n....:     \nRational Field\n```\nThe main problem is that the construction of the `CartesianProduct` parent object is cached and Sage made the choice that `ZZ.one()` and `QQ.one()` are indistinguishable when put in a hash table. Its the same as \n\n```\nsage: set([ZZ.one(), QQ.one()])\n{1}\n```\nAs a workaround, if you only needs the list, don't build the parent. I would then, suggest to use\n\n```\nsage: for a in cartesian_product_iterator([[ZZ.one()]]):\n....:     print a[0].parent()\n....:\nInteger Ring\nsage: for a in cartesian_product_iterator([[QQ.one()]]):\n....:     print a[0].parent()\n....:     \nRational Field\n```\n\nCheers,\n\nFlorent",
    "created_at": "2017-03-13T22:21:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22594#issuecomment-414531",
    "user": "https://github.com/hivert"
}
```

Hi Frederic,

Replying to [ticket:22594 chapoton]:
Actually what goes very wrong is that:

```
cartesian_product([[ZZ.one()]]) is cartesian_product([[QQ.one()]])
```
Note that if you relaunch a new sage, and ask the computation in the reverse order, you'll get:

```
sage: bring=QQ
sage: for a in cartesian_product([[bring.one()]]):
....:     print a[0].parent()
....:     
Rational Field
sage: bring=ZZ
sage: for a in cartesian_product([[bring.one()]]):
....:     print a[0].parent()
....:     
Rational Field
```
The main problem is that the construction of the `CartesianProduct` parent object is cached and Sage made the choice that `ZZ.one()` and `QQ.one()` are indistinguishable when put in a hash table. Its the same as 

```
sage: set([ZZ.one(), QQ.one()])
{1}
```
As a workaround, if you only needs the list, don't build the parent. I would then, suggest to use

```
sage: for a in cartesian_product_iterator([[ZZ.one()]]):
....:     print a[0].parent()
....:
Integer Ring
sage: for a in cartesian_product_iterator([[QQ.one()]]):
....:     print a[0].parent()
....:     
Rational Field
```

Cheers,

Florent



---

archive/issue_comments_414532.json:
```json
{
    "body": "<a id='comment:2'></a>\nThis is a very simplified example. My use case is right in the middle of somthing more complicated. This breaks my program because it triggers the coercion failure in #22591.",
    "created_at": "2017-03-14T09:17:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22594#issuecomment-414532",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:2'></a>
This is a very simplified example. My use case is right in the middle of somthing more complicated. This breaks my program because it triggers the coercion failure in #22591.



---

archive/issue_comments_414533.json:
```json
{
    "body": "Changing keywords from \"\" to \"days85\".",
    "created_at": "2017-03-14T09:27:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22594#issuecomment-414533",
    "user": "https://github.com/tscrim"
}
```

Changing keywords from "" to "days85".



---

archive/issue_comments_414534.json:
```json
{
    "body": "<a id='comment:3'></a>\nSo what I'm thinking of doing is removing `UniqueRepresentation` from `FiniteEnumeratedSet`, which is the precise place where the caching problem is coming from. We might have to have a subclass that does have the `UniqueRepresentation` behavior for places where it is used, but at least the problem stems from instances of `FiniteEnumeratedSet` being used closer to elements than to parents. Florent or I will probably work on this today.",
    "created_at": "2017-03-14T09:27:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22594#issuecomment-414534",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:3'></a>
So what I'm thinking of doing is removing `UniqueRepresentation` from `FiniteEnumeratedSet`, which is the precise place where the caching problem is coming from. We might have to have a subclass that does have the `UniqueRepresentation` behavior for places where it is used, but at least the problem stems from instances of `FiniteEnumeratedSet` being used closer to elements than to parents. Florent or I will probably work on this today.
