# Issue 22970: use flint fmpq_mat for rational dense matrices

archive/issues_022733.json:
```json
{
    "body": "The flint library has a builtin type for rational matrices: `fmpq_mat_t`. This ticket proposes to replace the current array of `mpq_t` wrapped by `Matrix_rational_dense` in favor of `fmpq_mat_t`.\n\n(See also the related #22924 and #22872)\n\nCC:  @ClementPernet @mmasdeu\n\nKeywords: thursdaysbdx\n\nBranch/Commit: cb0dae187cbbf8e8b594a64ef5c87553459b7f71\n\nReviewer: Marc Masdeu\n\nAuthor: Vincent Delecroix\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/22970\n\n",
    "closed_at": "2017-05-31T22:25:35Z",
    "created_at": "2017-05-10T10:03:42Z",
    "labels": [
        "component: linear algebra"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "use flint fmpq_mat for rational dense matrices",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22970",
    "user": "https://github.com/videlec"
}
```
The flint library has a builtin type for rational matrices: `fmpq_mat_t`. This ticket proposes to replace the current array of `mpq_t` wrapped by `Matrix_rational_dense` in favor of `fmpq_mat_t`.

(See also the related #22924 and #22872)

CC:  @ClementPernet @mmasdeu

Keywords: thursdaysbdx

Branch/Commit: cb0dae187cbbf8e8b594a64ef5c87553459b7f71

Reviewer: Marc Masdeu

Author: Vincent Delecroix

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/22970





---

archive/issue_comments_337974.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to linear algebra.",
    "created_at": "2017-05-11T09:43:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-337974",
    "user": "https://github.com/videlec"
}
```

Changing component from PLEASE CHANGE to linear algebra.



---

archive/issue_comments_337975.json:
```json
{
    "body": "<a id='comment:1'></a>New commits:",
    "created_at": "2017-05-11T09:43:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-337975",
    "user": "https://github.com/videlec"
}
```

<a id='comment:1'></a>New commits:



---

archive/issue_comments_337976.json:
```json
{
    "body": "<a id='comment:2'></a>For a discussion about an annoying segfault related to this ticket, see [this thread](https://groups.google.com/forum/#!topic/sage-devel/Vk3gAZiBfQ8).",
    "created_at": "2017-05-11T09:53:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-337976",
    "user": "https://github.com/videlec"
}
```

<a id='comment:2'></a>For a discussion about an annoying segfault related to this ticket, see [this thread](https://groups.google.com/forum/#!topic/sage-devel/Vk3gAZiBfQ8).



---

archive/issue_comments_337977.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-05-11T14:54:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-337977",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_337978.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-05-11T14:55:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-337978",
    "user": "https://github.com/videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_337979.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-The flint library has a builtin type for rational matrices. This ticket proposes to replace the current array of `mpq_t` for the data to the `fmpq_mat_t` type of flint.\n+The flint library has a builtin type for rational matrices: `fmpq_mat_t`. This ticket proposes to replace the current array of `mpq_t` wrapped by `Matrix_rational_dense` in favor of `fmpq_mat_t`.\n \n (See also the related #22924 and #22872)\n \n```\n",
    "created_at": "2017-05-11T15:16:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-337979",
    "user": "https://github.com/videlec"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,4 @@
-The flint library has a builtin type for rational matrices. This ticket proposes to replace the current array of `mpq_t` for the data to the `fmpq_mat_t` type of flint.
+The flint library has a builtin type for rational matrices: `fmpq_mat_t`. This ticket proposes to replace the current array of `mpq_t` wrapped by `Matrix_rational_dense` in favor of `fmpq_mat_t`.
 
 (See also the related #22924 and #22872)
 
```




---

archive/issue_comments_337980.json:
```json
{
    "body": "Changing keywords from \"\" to \"thursdaysbdx\".",
    "created_at": "2017-05-11T15:30:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-337980",
    "user": "https://github.com/videlec"
}
```

Changing keywords from "" to "thursdaysbdx".



---

archive/issue_comments_337981.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-12T07:29:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-337981",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_337982.json:
```json
{
    "body": "<a id='comment:8'></a>New commits:",
    "created_at": "2017-05-12T11:42:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-337982",
    "user": "https://github.com/videlec"
}
```

<a id='comment:8'></a>New commits:



---

archive/issue_comments_337983.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-12T11:42:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-337983",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_337984.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-05-12T13:48:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-337984",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_337985.json:
```json
{
    "body": "<a id='comment:11'></a>Thanks for the work Vincent! I think that it's my duty to review this one :-).\n\nWhile I update my develop branch and check the ticket out, could you check that that the docstring in the determinant method is correct? In ``algorithm``, I see ``None`` missing.\n\nAlso, do you happen to have timings? that compare with the previous implementation? Otherwise I can produce some...",
    "created_at": "2017-05-15T11:02:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-337985",
    "user": "https://github.com/mmasdeu"
}
```

<a id='comment:11'></a>Thanks for the work Vincent! I think that it's my duty to review this one :-).

While I update my develop branch and check the ticket out, could you check that that the docstring in the determinant method is correct? In ``algorithm``, I see ``None`` missing.

Also, do you happen to have timings? that compare with the previous implementation? Otherwise I can produce some...



---

archive/issue_comments_337986.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-05-15T11:20:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-337986",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_337987.json:
```json
{
    "body": "<a id='comment:12'></a>Hi Marc,\n\nThanks for proposing the review! I need some more work on my branch as I have strange failing doctests in `sage/modular` that I don't understand right now.\n\nI will provide proper timings for the following methods (tell me if you have more in mind):\n- `determinant`\n- `multiplication`\n- `echelonize`\n- `charpoly` (not yet in flint, but can go through integer matrices)\n- `minpoly` (not yet in flint, but can go through integer matrices)",
    "created_at": "2017-05-15T11:20:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-337987",
    "user": "https://github.com/videlec"
}
```

<a id='comment:12'></a>Hi Marc,

Thanks for proposing the review! I need some more work on my branch as I have strange failing doctests in `sage/modular` that I don't understand right now.

I will provide proper timings for the following methods (tell me if you have more in mind):
- `determinant`
- `multiplication`
- `echelonize`
- `charpoly` (not yet in flint, but can go through integer matrices)
- `minpoly` (not yet in flint, but can go through integer matrices)



---

archive/issue_comments_337988.json:
```json
{
    "body": "Attachment [test_file.sage](tarball://root/attachments/some-uuid/ticket22970/test_file.sage) by @videlec created at 2017-05-15 13:47:47",
    "created_at": "2017-05-15T13:47:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-337988",
    "user": "https://github.com/videlec"
}
```

Attachment [test_file.sage](tarball://root/attachments/some-uuid/ticket22970/test_file.sage) by @videlec created at 2017-05-15 13:47:47



---

archive/issue_comments_337989.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-05-15T13:51:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-337989",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_337990.json:
```json
{
    "body": "<a id='comment:14'></a>At commit `edfa6f46b5` using [attachment:test_file.sage] I obtain (within different session because of caching)\n\n```\nsage: %runfile test_file.sage\nsage: test(seed=0)\nf = q + 1/2*a1*q^3 + (4*a1 - 26)*q^5 + O(q^6)\nK = Number Field in a1 with defining polynomial x^2 + 32*x - 9984\na = 1/2*a1\nTrue\nFalse\n```\nand\n\n```\nsage: %runfile test_file.sage\nsage: test(seed=1)\nf = q + 1/2*a1*q^3 + (4*a1 - 26)*q^5 + O(q^6)\nK = Number Field in a1 with defining polynomial x^2 + 32*x - 9984\na = 1/2*a1\nFalse\nTrue\n```\nAnd it looks like a bug to me that this result depends on the seed of the random generator...",
    "created_at": "2017-05-15T13:52:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-337990",
    "user": "https://github.com/videlec"
}
```

<a id='comment:14'></a>At commit `edfa6f46b5` using [attachment:test_file.sage] I obtain (within different session because of caching)

```
sage: %runfile test_file.sage
sage: test(seed=0)
f = q + 1/2*a1*q^3 + (4*a1 - 26)*q^5 + O(q^6)
K = Number Field in a1 with defining polynomial x^2 + 32*x - 9984
a = 1/2*a1
True
False
```
and

```
sage: %runfile test_file.sage
sage: test(seed=1)
f = q + 1/2*a1*q^3 + (4*a1 - 26)*q^5 + O(q^6)
K = Number Field in a1 with defining polynomial x^2 + 32*x - 9984
a = 1/2*a1
False
True
```
And it looks like a bug to me that this result depends on the seed of the random generator...



---

archive/issue_comments_337991.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:14 comment:14]: Discussed at \n[this sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/7VpAxhycBe0).",
    "created_at": "2017-05-15T14:05:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-337991",
    "user": "https://github.com/videlec"
}
```

<a id='comment:15'></a>Replying to [comment:14 comment:14]: Discussed at 
[this sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/7VpAxhycBe0).



---

archive/issue_comments_337992.json:
```json
{
    "body": "<a id='comment:16'></a>Attachment [benchmark_matrices.py](tarball://root/attachments/some-uuid/ticket22970/benchmark_matrices.py) by @videlec created at 2017-05-16 08:20:12\n\nFrom [attachment:benchmark_matrices.py]\n\n- echelonize: flint is better except when coefficients are huge in which case multimodular is best\n\n```\nnrows=5  ncols=5  rank=5, density=1.0000 nbits(height)=100\nflint        0.0565\nmultimodular 0.3284\npadic        0.5626\n\nnrows=10  ncols=10  rank=5, density=1.0000 nbits(height)=37\nflint        0.1063\nmultimodular 2.6420\npadic        7.6511\n\nnrows=100  ncols=100  rank=20, density=0.1799 nbits(height)=12\nflint        9.1834\nmultimodular 12.2192\npadic        74.8152\n\nnrows=10  ncols=10  rank=10, density=1.0000 nbits(height)=200\nflint        10.1606\nmultimodular 1.5586\npadic        2.1540\n```\n- determinant\n\n```\ndim=3 density=0.7778 nbits(height)=3\nflint        0.0092\ninteger      0.1334\npari         0.0017\n\ndim=3 density=1.0000 nbits(height)=100\nflint        0.0113\ninteger      0.1188\npari         0.0269\n\ndim=30 density=1.0000 nbits(height)=5\nflint        0.9006\ninteger      1.0754\npari         34.5452\n\ndim=30 density=0.2544 nbits(height)=5\nflint        0.4389\ninteger      0.9986\npari         179.9622\n```\n- charpoly\n\n```\ndim=3 density=0.7778 nbits(height)=2\nflint        0.3875\nlinbox       1.3019\ngeneric      0.0431\n\ndim=4 density=0.5625 nbits(height)=2\nflint        0.1776\nlinbox       1.2013\ngeneric      0.0450\n\ndim=5 density=0.6400 nbits(height)=2\nflint        0.1737\nlinbox       1.2952\ngeneric      0.0532\n\ndim=6 density=0.6111 nbits(height)=2\nflint        0.1850\nlinbox       1.2773\ngeneric      0.0651\n\ndim=10 density=0.4100 nbits(height)=2\nflint        0.2343\nlinbox       1.4250\ngeneric      0.1818\n\ndim=10 density=1.0000 nbits(height)=2\nflint        0.2521\nlinbox       1.4264\ngeneric      0.4842\n\ndim=30 density=1.0000 nbits(height)=2\nflint        4.8531\nlinbox       3.4320\ngeneric      50.0362\n```",
    "created_at": "2017-05-16T08:20:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-337992",
    "user": "https://github.com/videlec"
}
```

<a id='comment:16'></a>Attachment [benchmark_matrices.py](tarball://root/attachments/some-uuid/ticket22970/benchmark_matrices.py) by @videlec created at 2017-05-16 08:20:12

From [attachment:benchmark_matrices.py]

- echelonize: flint is better except when coefficients are huge in which case multimodular is best

```
nrows=5  ncols=5  rank=5, density=1.0000 nbits(height)=100
flint        0.0565
multimodular 0.3284
padic        0.5626

nrows=10  ncols=10  rank=5, density=1.0000 nbits(height)=37
flint        0.1063
multimodular 2.6420
padic        7.6511

nrows=100  ncols=100  rank=20, density=0.1799 nbits(height)=12
flint        9.1834
multimodular 12.2192
padic        74.8152

nrows=10  ncols=10  rank=10, density=1.0000 nbits(height)=200
flint        10.1606
multimodular 1.5586
padic        2.1540
```
- determinant

```
dim=3 density=0.7778 nbits(height)=3
flint        0.0092
integer      0.1334
pari         0.0017

dim=3 density=1.0000 nbits(height)=100
flint        0.0113
integer      0.1188
pari         0.0269

dim=30 density=1.0000 nbits(height)=5
flint        0.9006
integer      1.0754
pari         34.5452

dim=30 density=0.2544 nbits(height)=5
flint        0.4389
integer      0.9986
pari         179.9622
```
- charpoly

```
dim=3 density=0.7778 nbits(height)=2
flint        0.3875
linbox       1.3019
generic      0.0431

dim=4 density=0.5625 nbits(height)=2
flint        0.1776
linbox       1.2013
generic      0.0450

dim=5 density=0.6400 nbits(height)=2
flint        0.1737
linbox       1.2952
generic      0.0532

dim=6 density=0.6111 nbits(height)=2
flint        0.1850
linbox       1.2773
generic      0.0651

dim=10 density=0.4100 nbits(height)=2
flint        0.2343
linbox       1.4250
generic      0.1818

dim=10 density=1.0000 nbits(height)=2
flint        0.2521
linbox       1.4264
generic      0.4842

dim=30 density=1.0000 nbits(height)=2
flint        4.8531
linbox       3.4320
generic      50.0362
```



---

archive/issue_comments_337993.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-05-16T09:58:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-337993",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_337994.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-05-16T09:59:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-337994",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_337995.json:
```json
{
    "body": "<a id='comment:18'></a>Needs review again. I tried to make independent of the random seed the annoying doctests in sage/modular...",
    "created_at": "2017-05-16T09:59:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-337995",
    "user": "https://github.com/videlec"
}
```

<a id='comment:18'></a>Needs review again. I tried to make independent of the random seed the annoying doctests in sage/modular...



---

archive/issue_comments_337996.json:
```json
{
    "body": "<a id='comment:19'></a>patchbot is green!! (with a weird ascii complaints)",
    "created_at": "2017-05-16T12:59:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-337996",
    "user": "https://github.com/videlec"
}
```

<a id='comment:19'></a>patchbot is green!! (with a weird ascii complaints)



---

archive/issue_comments_337997.json:
```json
{
    "body": "<a id='comment:20'></a>On my computer, a call to\n\n```\nsage: CuspForms(101,12).hecke_matrix(3)\n```\n\ntakes 765 seconds with the current develop branch, and 1157 seconds with the proposed patch. I think that most of it is explained by the fact that the method echelon_form is called 1394 times on quite large matrices (dense, over QQ). I was actually looking for speed-ups in existing high-level functionality (like this one), so this is a bit disappointing.\n\nMaybe the default algorithm should be changed if the entries are large?",
    "created_at": "2017-05-16T14:41:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-337997",
    "user": "https://github.com/mmasdeu"
}
```

<a id='comment:20'></a>On my computer, a call to

```
sage: CuspForms(101,12).hecke_matrix(3)
```

takes 765 seconds with the current develop branch, and 1157 seconds with the proposed patch. I think that most of it is explained by the fact that the method echelon_form is called 1394 times on quite large matrices (dense, over QQ). I was actually looking for speed-ups in existing high-level functionality (like this one), so this is a bit disappointing.

Maybe the default algorithm should be changed if the entries are large?



---

archive/issue_comments_337998.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [comment:20 mmasdeu]:\n> On my computer, a call to\n> \n> ```\n> sage: CuspForms(101,12).hecke_matrix(3)\n> ```\n> \n> takes 765 seconds with the current develop branch, and 1157 seconds with the proposed patch. I think that most of it is explained by the fact that the method echelon_form is called 1394 times on quite large matrices (dense, over QQ). I was actually looking for speed-ups in existing high-level functionality (like this one), so this is a bit disappointing.\n> \n> Maybe the default algorithm should be changed if the entries are large?\n\n\nI did not do proper tunings (since I will redo it after #22924 anyway). However, I can try to do something better for `echelon_form/echelonize`. Do you have other relevant examples in mind?",
    "created_at": "2017-05-16T14:49:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-337998",
    "user": "https://github.com/videlec"
}
```

<a id='comment:21'></a>Replying to [comment:20 mmasdeu]:
> On my computer, a call to
> 
> ```
> sage: CuspForms(101,12).hecke_matrix(3)
> ```
> 
> takes 765 seconds with the current develop branch, and 1157 seconds with the proposed patch. I think that most of it is explained by the fact that the method echelon_form is called 1394 times on quite large matrices (dense, over QQ). I was actually looking for speed-ups in existing high-level functionality (like this one), so this is a bit disappointing.
> 
> Maybe the default algorithm should be changed if the entries are large?


I did not do proper tunings (since I will redo it after #22924 anyway). However, I can try to do something better for `echelon_form/echelonize`. Do you have other relevant examples in mind?



---

archive/issue_comments_337999.json:
```json
{
    "body": "<a id='comment:22'></a>Not at the moment. I haven't done exhaustive tests either, but it seems that in many cases the performance is similar.\n\nAs for other examples, many operations with subquotients involve doing this kind of linear algebra.",
    "created_at": "2017-05-16T15:12:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-337999",
    "user": "https://github.com/mmasdeu"
}
```

<a id='comment:22'></a>Not at the moment. I haven't done exhaustive tests either, but it seems that in many cases the performance is similar.

As for other examples, many operations with subquotients involve doing this kind of linear algebra.



---

archive/issue_comments_338000.json:
```json
{
    "body": "<a id='comment:23'></a>Some remarks\n- flint has several algorithms for echelon form and this is not finely tuned.\n- On very specific instances, multimodular can be much faster (up to x100). This is the reason why your example `CuspForms(101,12).hecke_matrix(3)` gets slower. I have no idea how to detect such instances.\n- for `random_matrix(QQ, ...)` (ie independent entries) flint looks like to be the best option excepted in the range `10 <= nrows=ncols <= 20` where flint tuning (over Z) is very bad\n\nOne way to go might be to have a global option that controls the default behavior of the echelon form. I am thinking of something that can be used like\n\n```python\ndef my_modular_form_algorithm():\n    with rational_echelon_form('multimodular'):\n        # some relevant code here\n        ....\n```\nWhat do you think?",
    "created_at": "2017-05-17T08:49:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-338000",
    "user": "https://github.com/videlec"
}
```

<a id='comment:23'></a>Some remarks
- flint has several algorithms for echelon form and this is not finely tuned.
- On very specific instances, multimodular can be much faster (up to x100). This is the reason why your example `CuspForms(101,12).hecke_matrix(3)` gets slower. I have no idea how to detect such instances.
- for `random_matrix(QQ, ...)` (ie independent entries) flint looks like to be the best option excepted in the range `10 <= nrows=ncols <= 20` where flint tuning (over Z) is very bad

One way to go might be to have a global option that controls the default behavior of the echelon form. I am thinking of something that can be used like

```python
def my_modular_form_algorithm():
    with rational_echelon_form('multimodular'):
        # some relevant code here
        ....
```
What do you think?



---

archive/issue_comments_338001.json:
```json
{
    "body": "<a id='comment:24'></a>Second option, allow the option `algorithm=my_function` where `my_function` takes a matrix as input and returns a valid algorithm for echelon form. (I do prefer this one better)\n\nEDIT: this will not work since `echelon_form` is **indirectly** called in modular function algorithms...",
    "created_at": "2017-05-17T08:56:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-338001",
    "user": "https://github.com/videlec"
}
```

<a id='comment:24'></a>Second option, allow the option `algorithm=my_function` where `my_function` takes a matrix as input and returns a valid algorithm for echelon form. (I do prefer this one better)

EDIT: this will not work since `echelon_form` is **indirectly** called in modular function algorithms...



---

archive/issue_comments_338002.json:
```json
{
    "body": "<a id='comment:25'></a>Implementing the idea from [comment:23 comment:23] I got\n\n```\nsage: %time m = CuspForms(31, 12).hecke_matrix(3)\nCPU times: user 7.52 s, sys: 63.3 ms, total: 7.59 s\nWall time: 7.55 s\n\nsage: %time c = CuspForms(51, 12).hecke_matrix(3)\nCPU times: user 2min 13s, sys: 203 ms, total: 2min 13s\nWall time: 2min 13s\n\nsage: %time c = CuspForms(101, 12).hecke_matrix(3)\nCPU times: user 5min 10s, sys: 663 ms, total: 5min 10s\nWall time: 5min 10s\n```\nagainst the following in develop\n\n```\nsage: %time m = CuspForms(31, 12).hecke_matrix(3)\nCPU times: user 13.5 s, sys: 43.3 ms, total: 13.6 s\nWall time: 13.5 s\n\nsage: %time c = CuspForms(51, 12).hecke_matrix(3)\nCPU times: user 3min 8s, sys: 250 ms, total: 3min 9s\nWall time: 3min 9s\n\n%time c = CuspForms(101, 12).hecke_matrix(3)\nCPU times: user 8min 7s, sys: 527 ms, total: 8min 8s\nWall time: 8min 8s\n```\n(so close to x2 improvement)\n\nI propose to postpone this improvement to another ticket since this one is already a big change. If you agree I will open a new one and work on it as soon as this one is closed.",
    "created_at": "2017-05-17T09:58:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-338002",
    "user": "https://github.com/videlec"
}
```

<a id='comment:25'></a>Implementing the idea from [comment:23 comment:23] I got

```
sage: %time m = CuspForms(31, 12).hecke_matrix(3)
CPU times: user 7.52 s, sys: 63.3 ms, total: 7.59 s
Wall time: 7.55 s

sage: %time c = CuspForms(51, 12).hecke_matrix(3)
CPU times: user 2min 13s, sys: 203 ms, total: 2min 13s
Wall time: 2min 13s

sage: %time c = CuspForms(101, 12).hecke_matrix(3)
CPU times: user 5min 10s, sys: 663 ms, total: 5min 10s
Wall time: 5min 10s
```
against the following in develop

```
sage: %time m = CuspForms(31, 12).hecke_matrix(3)
CPU times: user 13.5 s, sys: 43.3 ms, total: 13.6 s
Wall time: 13.5 s

sage: %time c = CuspForms(51, 12).hecke_matrix(3)
CPU times: user 3min 8s, sys: 250 ms, total: 3min 9s
Wall time: 3min 9s

%time c = CuspForms(101, 12).hecke_matrix(3)
CPU times: user 8min 7s, sys: 527 ms, total: 8min 8s
Wall time: 8min 8s
```
(so close to x2 improvement)

I propose to postpone this improvement to another ticket since this one is already a big change. If you agree I will open a new one and work on it as soon as this one is closed.



---

archive/issue_comments_338003.json:
```json
{
    "body": "<a id='comment:26'></a>1) I agree that this can be dealt with in another ticket, but it is moderately urgent. ModularSymbols / ModularForms becoming twice slower than currently is not good news...\n\nAnother example of a reasonable calculation: with the Sage 7.5.1 the following calculation takes 22 seconds on my laptop. It takes 1min22s (!) with the proposed patch.\n\n```\nsage: %time A = ModularSymbols(11,60).hecke_matrix(3)\n```\n\n2) While reviewing, in `sage/modular/hecke/module.py` there is a doctest that changed in a suspicious way. It seems that a number field was created with a different generator and that causes the output to look different. I propose that the line that causes trouble gets changed into\n\n```\nsage: [o.minpoly() for o in A.system_of_eigenvalues(3)]\n[x - 1, x + 1, x^2 - 2*x - 2]\n```\n\nThe output that appears should not depend on the implementation.\n\n3) There seems to be quite a mess on what are the acceptable values to the 'algorithm' parameter. Maybe it's a good time to change that! My suggestion would be that the default would always be None, and then the docstring would specify what is done in this case.",
    "created_at": "2017-05-18T11:07:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-338003",
    "user": "https://github.com/mmasdeu"
}
```

<a id='comment:26'></a>1) I agree that this can be dealt with in another ticket, but it is moderately urgent. ModularSymbols / ModularForms becoming twice slower than currently is not good news...

Another example of a reasonable calculation: with the Sage 7.5.1 the following calculation takes 22 seconds on my laptop. It takes 1min22s (!) with the proposed patch.

```
sage: %time A = ModularSymbols(11,60).hecke_matrix(3)
```

2) While reviewing, in `sage/modular/hecke/module.py` there is a doctest that changed in a suspicious way. It seems that a number field was created with a different generator and that causes the output to look different. I propose that the line that causes trouble gets changed into

```
sage: [o.minpoly() for o in A.system_of_eigenvalues(3)]
[x - 1, x + 1, x^2 - 2*x - 2]
```

The output that appears should not depend on the implementation.

3) There seems to be quite a mess on what are the acceptable values to the 'algorithm' parameter. Maybe it's a good time to change that! My suggestion would be that the default would always be None, and then the docstring would specify what is done in this case.



---

archive/issue_comments_338004.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-05-18T11:07:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-338004",
    "user": "https://github.com/mmasdeu"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_338005.json:
```json
{
    "body": "<a id='comment:27'></a>I might have an explanation for why Flint is slow for these modular symbol matrices. See:\n\nhttps://github.com/wbhart/flint2/issues/335\n\nIt can be fixed in Flint (if my analysis is correct), but this requires some amount of coding.",
    "created_at": "2017-05-18T16:03:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-338005",
    "user": "https://github.com/fredrik-johansson"
}
```

<a id='comment:27'></a>I might have an explanation for why Flint is slow for these modular symbol matrices. See:

https://github.com/wbhart/flint2/issues/335

It can be fixed in Flint (if my analysis is correct), but this requires some amount of coding.



---

archive/issue_comments_338006.json:
```json
{
    "body": "<a id='comment:28'></a>Replying to [comment:27 fredrik.johansson]:\n> I might have an explanation for why Flint is slow for these modular symbol matrices. See:\n> \n> https://github.com/wbhart/flint2/issues/335\n> \n> It can be fixed in Flint (if my analysis is correct), but this requires some amount of coding.\n\n\nWould be tremendous!",
    "created_at": "2017-05-18T16:17:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-338006",
    "user": "https://github.com/videlec"
}
```

<a id='comment:28'></a>Replying to [comment:27 fredrik.johansson]:
> I might have an explanation for why Flint is slow for these modular symbol matrices. See:
> 
> https://github.com/wbhart/flint2/issues/335
> 
> It can be fixed in Flint (if my analysis is correct), but this requires some amount of coding.


Would be tremendous!



---

archive/issue_comments_338007.json:
```json
{
    "body": "<a id='comment:29'></a>`@`mmasdeu: for the sake of this ticket I will set the default to `multimodular` that should actually speed up all modular symbol computations. Then #23026 will deal with making flint the default (that is much faster on random instances).",
    "created_at": "2017-05-18T16:22:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-338007",
    "user": "https://github.com/videlec"
}
```

<a id='comment:29'></a>`@`mmasdeu: for the sake of this ticket I will set the default to `multimodular` that should actually speed up all modular symbol computations. Then #23026 will deal with making flint the default (that is much faster on random instances).



---

archive/issue_comments_338008.json:
```json
{
    "body": "<a id='comment:30'></a>That sounds reasonable...at least there is no regression in speed (hopefully!).",
    "created_at": "2017-05-18T16:32:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-338008",
    "user": "https://github.com/mmasdeu"
}
```

<a id='comment:30'></a>That sounds reasonable...at least there is no regression in speed (hopefully!).



---

archive/issue_comments_338009.json:
```json
{
    "body": "<a id='comment:31'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-18T17:40:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-338009",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:31'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_338010.json:
```json
{
    "body": "<a id='comment:32'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-05-18T18:32:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-338010",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:32'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_338011.json:
```json
{
    "body": "<a id='comment:33'></a>at commit b5f5600 I got\n\n```\nsage: %time m = CuspForms(31, 12).hecke_matrix(3)\nCPU times: user 11.7 s, sys: 40 ms, total: 11.7 s\nWall time: 11.7 s\n\nsage: %time c = CuspForms(51, 12).hecke_matrix(3)\nCPU times: user 2min 52s, sys: 283 ms, total: 2min 52s\nWall time: 2min 52s\n\nsage: %time c = CuspForms(101, 12).hecke_matrix(3)\nCPU times: user 7min 17s, sys: 620 ms, total: 7min 18s\nWall time: 7min 18s\n```\n\nand at 5f2e1ba the even better\n\n```\nsage: %time m = CuspForms(31, 12).hecke_matrix(3)\nCPU times: user 7.5 s, sys: 36.7 ms, total: 7.53 s\nWall time: 7.51 s\n\nsage: %time c = CuspForms(51, 12).hecke_matrix(3)\nCPU times: user 2min 10s, sys: 223 ms, total: 2min 10s\nWall time: 2min 10s\n\nsage: %time c = CuspForms(101, 12).hecke_matrix(3)\nCPU times: user 5min 9s, sys: 603 ms, total: 5min 10s\nWall time: 5min 10s\n```",
    "created_at": "2017-05-18T18:32:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-338011",
    "user": "https://github.com/videlec"
}
```

<a id='comment:33'></a>at commit b5f5600 I got

```
sage: %time m = CuspForms(31, 12).hecke_matrix(3)
CPU times: user 11.7 s, sys: 40 ms, total: 11.7 s
Wall time: 11.7 s

sage: %time c = CuspForms(51, 12).hecke_matrix(3)
CPU times: user 2min 52s, sys: 283 ms, total: 2min 52s
Wall time: 2min 52s

sage: %time c = CuspForms(101, 12).hecke_matrix(3)
CPU times: user 7min 17s, sys: 620 ms, total: 7min 18s
Wall time: 7min 18s
```

and at 5f2e1ba the even better

```
sage: %time m = CuspForms(31, 12).hecke_matrix(3)
CPU times: user 7.5 s, sys: 36.7 ms, total: 7.53 s
Wall time: 7.51 s

sage: %time c = CuspForms(51, 12).hecke_matrix(3)
CPU times: user 2min 10s, sys: 223 ms, total: 2min 10s
Wall time: 2min 10s

sage: %time c = CuspForms(101, 12).hecke_matrix(3)
CPU times: user 5min 9s, sys: 603 ms, total: 5min 10s
Wall time: 5min 10s
```



---

archive/issue_comments_338012.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-05-18T18:33:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-338012",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_338013.json:
```json
{
    "body": "<a id='comment:35'></a>And tests also pass on beta7!",
    "created_at": "2017-05-19T12:32:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-338013",
    "user": "https://github.com/videlec"
}
```

<a id='comment:35'></a>And tests also pass on beta7!



---

archive/issue_comments_338014.json:
```json
{
    "body": "<a id='comment:36'></a>This is definitely more than satisfying. The code looks very clean, and all tests pass. Thanks for the great work!",
    "created_at": "2017-05-21T16:32:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-338014",
    "user": "https://github.com/mmasdeu"
}
```

<a id='comment:36'></a>This is definitely more than satisfying. The code looks very clean, and all tests pass. Thanks for the great work!



---

archive/issue_comments_338015.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-05-21T16:32:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-338015",
    "user": "https://github.com/mmasdeu"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_338016.json:
```json
{
    "body": "<a id='comment:37'></a>Merge conflict",
    "created_at": "2017-05-22T22:35:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-338016",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:37'></a>Merge conflict



---

archive/issue_comments_338017.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-05-22T22:35:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-338017",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_338018.json:
```json
{
    "body": "<a id='comment:38'></a>Too bad. The code is fine on beta7. Can I try to fix it by merging another ticket?",
    "created_at": "2017-05-23T06:45:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-338018",
    "user": "https://github.com/videlec"
}
```

<a id='comment:38'></a>Too bad. The code is fine on beta7. Can I try to fix it by merging another ticket?



---

archive/issue_comments_338019.json:
```json
{
    "body": "<a id='comment:39'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2017-05-29T13:06:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-338019",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:39'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_338020.json:
```json
{
    "body": "<a id='comment:40'></a>rebased (I launched the patchbot)",
    "created_at": "2017-05-29T13:07:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-338020",
    "user": "https://github.com/videlec"
}
```

<a id='comment:40'></a>rebased (I launched the patchbot)



---

archive/issue_comments_338021.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-05-29T13:07:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-338021",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_338022.json:
```json
{
    "body": "<a id='comment:41'></a>patchbot still happy!",
    "created_at": "2017-05-29T22:01:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-338022",
    "user": "https://github.com/videlec"
}
```

<a id='comment:41'></a>patchbot still happy!



---

archive/issue_comments_338023.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-05-29T22:01:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-338023",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_338024.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-05-31T22:25:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22970#issuecomment-338024",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_059520.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-05-31T22:25:35Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/22970",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22970#event-59520"
}
```
