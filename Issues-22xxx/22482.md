# Issue 22482: Non-deterministic test failure in cluster_algebra_quiver

archive/issues_022245.json:
```json
{
    "body": "When running `sage -t -a -p 0` in the develop Docker container (off a current version of the develop branch) I'm getting:\n\n```\nsage -t /opt/sage/src/sage/combinat/cluster_algebra_quiver/mutation_class.py\n    [54 tests, 0.34 s]\nsage -t /opt/sage/src/sage/combinat/cluster_algebra_quiver/mutation_type.py\n    [71 tests, 0.88 s]\nsage -t /opt/sage/src/sage/combinat/cluster_algebra_quiver/quiver.py\n**********************************************************************\nFile \"/opt/sage/src/sage/combinat/cluster_algebra_quiver/quiver.py\", line 880, in sage.combinat.cluster_algebra_quiver.quiver.ClusterQuiver.mutation_type\nFailed example:\n    Q.mutation_type()\nExpected:\n    ['G', 2]\nGot:\n    'undetermined finite mutation type'\n**********************************************************************\n1 item had failures:\n   1 of  37 in sage.combinat.cluster_algebra_quiver.quiver.ClusterQuiver.mutation_type\n    [272 tests, 1 failure, 5.57 s]\n```\n\nbut only sometimes.  Seems like maybe a test ordering issue.\n\nCC:  @tscrim stumpc5 @etn40ff gmoose05\n\nKeywords: cluster\n\nAuthor: Fr\u00e9d\u00e9ric Chapoton\n\nStatus: needs_info\n\nIssue created by migration from https://trac.sagemath.org/ticket/22482\n\n",
    "created_at": "2017-03-01T13:15:13Z",
    "labels": [
        "component: combinatorics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "Non-deterministic test failure in cluster_algebra_quiver",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22482",
    "user": "https://github.com/embray"
}
```
When running `sage -t -a -p 0` in the develop Docker container (off a current version of the develop branch) I'm getting:

```
sage -t /opt/sage/src/sage/combinat/cluster_algebra_quiver/mutation_class.py
    [54 tests, 0.34 s]
sage -t /opt/sage/src/sage/combinat/cluster_algebra_quiver/mutation_type.py
    [71 tests, 0.88 s]
sage -t /opt/sage/src/sage/combinat/cluster_algebra_quiver/quiver.py
**********************************************************************
File "/opt/sage/src/sage/combinat/cluster_algebra_quiver/quiver.py", line 880, in sage.combinat.cluster_algebra_quiver.quiver.ClusterQuiver.mutation_type
Failed example:
    Q.mutation_type()
Expected:
    ['G', 2]
Got:
    'undetermined finite mutation type'
**********************************************************************
1 item had failures:
   1 of  37 in sage.combinat.cluster_algebra_quiver.quiver.ClusterQuiver.mutation_type
    [272 tests, 1 failure, 5.57 s]
```

but only sometimes.  Seems like maybe a test ordering issue.

CC:  @tscrim stumpc5 @etn40ff gmoose05

Keywords: cluster

Author: Frédéric Chapoton

Status: needs_info

Issue created by migration from https://trac.sagemath.org/ticket/22482





---

archive/issue_comments_417398.json:
```json
{
    "body": "Description changed:\n``````diff\n\n``````\n",
    "created_at": "2017-03-01T13:15:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22482#issuecomment-417398",
    "user": "https://github.com/embray"
}
```

Description changed:
``````diff

``````




---

archive/issue_comments_417399.json:
```json
{
    "body": "<a id='comment:2'></a>Freudian slip?",
    "created_at": "2017-03-01T13:24:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22482#issuecomment-417399",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>Freudian slip?



---

archive/issue_comments_417400.json:
```json
{
    "body": "<a id='comment:3'></a>I noticed that these mutation_class files get written to the user's actual `DOT_SAGE` directory while running the tests.  Do the tests not use a temp dir for `DOT_SAGE`?",
    "created_at": "2017-03-01T13:40:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22482#issuecomment-417400",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>I noticed that these mutation_class files get written to the user's actual `DOT_SAGE` directory while running the tests.  Do the tests not use a temp dir for `DOT_SAGE`?



---

archive/issue_comments_417401.json:
```json
{
    "body": "<a id='comment:4'></a>It seems this probably happens if `sage/combinat/cluster_algebra_quiver/quiver_mutation_type.py` is not finished before `sage/combinat/cluster_algebra_quiver/quiver.py` starts.  Having a hard time getting it to do that reliably but am working on a patch nonetheless.",
    "created_at": "2017-03-01T13:49:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22482#issuecomment-417401",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>It seems this probably happens if `sage/combinat/cluster_algebra_quiver/quiver_mutation_type.py` is not finished before `sage/combinat/cluster_algebra_quiver/quiver.py` starts.  Having a hard time getting it to do that reliably but am working on a patch nonetheless.



---

archive/issue_comments_417402.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [embray](#comment%3A4):\n> It seems this probably happens if `sage/combinat/cluster_algebra_quiver/quiver_mutation_type.py` is not finished before `sage/combinat/cluster_algebra_quiver/quiver.py` starts.  Having a hard time getting it to do that reliably but am working on a patch nonetheless.\n\n\nNo, that's not quite it either because testing just`sage/combinat/cluster_algebra_quiver/quiver.py` with a clean `.sage` would fail reliably otherwise.",
    "created_at": "2017-03-01T13:51:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22482#issuecomment-417402",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>Replying to [embray](#comment%3A4):
> It seems this probably happens if `sage/combinat/cluster_algebra_quiver/quiver_mutation_type.py` is not finished before `sage/combinat/cluster_algebra_quiver/quiver.py` starts.  Having a hard time getting it to do that reliably but am working on a patch nonetheless.


No, that's not quite it either because testing just`sage/combinat/cluster_algebra_quiver/quiver.py` with a clean `.sage` would fail reliably otherwise.



---

archive/issue_comments_417403.json:
```json
{
    "body": "<a id='comment:6'></a>For what it's worth, from knowledge of the mathematical context and code:\n\nI would say that a priori this result cannot happen unless Q is something else that the value given in the previous line. How this can happen is unknown to me.\n\nThere is caching of the result in `Q._mutation_type`. So the problem may come from a cache confusion (objets sharing their hash ?) ?",
    "created_at": "2017-03-01T21:11:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22482#issuecomment-417403",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:6'></a>For what it's worth, from knowledge of the mathematical context and code:

I would say that a priori this result cannot happen unless Q is something else that the value given in the previous line. How this can happen is unknown to me.

There is caching of the result in `Q._mutation_type`. So the problem may come from a cache confusion (objets sharing their hash ?) ?



---

archive/issue_comments_417404.json:
```json
{
    "body": "<a id='comment:8'></a>I think I know the issue.  To avoid infinite loops when trying to figure out what the mutation type is, the first step in the command Q.mutation_type() for quivers is to run \"Q.is_mutation_finite()\" (unless the type of Q is already known from the start).\n\nHowever, as is documented, this command \"Uses a non-deterministic method by random mutations in various directions. Can result in a wrong answer.\"\n\nI'm surprised that so many wrong answers are arising from this non-deterministic process, but it seems like the pseudo-random seeds are being consistently poorly chosen for this example.  \n\nAnyway, I agree that this is leading to potentially wrong answers but unless we change the \"is_mutation_finite\" command, this is not an entirely unexpected bug, but part of the way the code was written for computational efficiency sake.",
    "created_at": "2017-03-01T21:28:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22482#issuecomment-417404",
    "user": "https://trac.sagemath.org/admin/accounts/users/gmoose05"
}
```

<a id='comment:8'></a>I think I know the issue.  To avoid infinite loops when trying to figure out what the mutation type is, the first step in the command Q.mutation_type() for quivers is to run "Q.is_mutation_finite()" (unless the type of Q is already known from the start).

However, as is documented, this command "Uses a non-deterministic method by random mutations in various directions. Can result in a wrong answer."

I'm surprised that so many wrong answers are arising from this non-deterministic process, but it seems like the pseudo-random seeds are being consistently poorly chosen for this example.  

Anyway, I agree that this is leading to potentially wrong answers but unless we change the "is_mutation_finite" command, this is not an entirely unexpected bug, but part of the way the code was written for computational efficiency sake.



---

archive/issue_comments_417405.json:
```json
{
    "body": "<a id='comment:9'></a>I agree with Gregg: this is, in general, an artifact that comes from the non\ndeterministic nature of `mutation_type`. Probably this method, and anything else calling `is_mutation_finite`, should mention\nexplicitly how it works in its documentation and have `# random` doctests.\n\nOn the other hand the specific error in the description of the ticket is yet\nanother instance of #22381. The quiver has only two non frozen vertices so it\nshould be recognized immediately. Coefficients mess things up.",
    "created_at": "2017-03-01T22:48:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22482#issuecomment-417405",
    "user": "https://github.com/etn40ff"
}
```

<a id='comment:9'></a>I agree with Gregg: this is, in general, an artifact that comes from the non
deterministic nature of `mutation_type`. Probably this method, and anything else calling `is_mutation_finite`, should mention
explicitly how it works in its documentation and have `# random` doctests.

On the other hand the specific error in the description of the ticket is yet
another instance of #22381. The quiver has only two non frozen vertices so it
should be recognized immediately. Coefficients mess things up.



---

archive/issue_comments_417406.json:
```json
{
    "body": "Changing branch from \"\" to \"u/chapoton/22482\"",
    "created_at": "2017-03-02T16:12:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22482#issuecomment-417406",
    "user": "https://github.com/fchapoton"
}
```

Changing branch from "" to "u/chapoton/22482"



---

archive/issue_comments_417407.json:
```json
{
    "body": "Changing commit from \"\" to \"0f0b3c22651611dd0aa0cbb4ee6075e724128a53\"",
    "created_at": "2017-03-02T16:12:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22482#issuecomment-417407",
    "user": "https://github.com/fchapoton"
}
```

Changing commit from "" to "0f0b3c22651611dd0aa0cbb4ee6075e724128a53"



---

archive/issue_comments_417408.json:
```json
{
    "body": "<a id='comment:10'></a>I have made some micro-enhancements to the is_mutation_finite code.\n\nThis could help prevent the sporadic doctest failure, maybe.\n\n---\nNew commits:",
    "created_at": "2017-03-02T16:12:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22482#issuecomment-417408",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:10'></a>I have made some micro-enhancements to the is_mutation_finite code.

This could help prevent the sporadic doctest failure, maybe.

---
New commits:



---

archive/issue_comments_417409.json:
```json
{
    "body": "Changing author from \"\" to \"Fr\u00e9d\u00e9ric Chapoton\"",
    "created_at": "2017-03-02T16:12:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22482#issuecomment-417409",
    "user": "https://github.com/fchapoton"
}
```

Changing author from "" to "Frédéric Chapoton"



---

archive/issue_comments_417410.json:
```json
{
    "body": "<a id='comment:11'></a>Thanks for looking into this!  For the tests, would it make sense to just run them with a hard-coded random seed?  There should even be a context manager for that somewhere...",
    "created_at": "2017-03-03T13:56:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22482#issuecomment-417410",
    "user": "https://github.com/embray"
}
```

<a id='comment:11'></a>Thanks for looking into this!  For the tests, would it make sense to just run them with a hard-coded random seed?  There should even be a context manager for that somewhere...



---

archive/issue_comments_417411.json:
```json
{
    "body": "<a id='comment:12'></a>review, somebody ?",
    "created_at": "2017-05-11T17:07:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22482#issuecomment-417411",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:12'></a>review, somebody ?



---

archive/issue_events_058785.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2017-05-11T17:08:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22482",
    "milestone": "sage-8.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22482#event-58785"
}
```



---

archive/issue_comments_417412.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-05-11T17:08:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22482#issuecomment-417412",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_417413.json:
```json
{
    "body": "<a id='comment:14'></a>For some reason the merge preview seems to have broken--trying to view it returns an internal server error.\n\nMaybe try rebasing it, just for the heck of it?",
    "created_at": "2017-05-12T09:08:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22482#issuecomment-417413",
    "user": "https://github.com/embray"
}
```

<a id='comment:14'></a>For some reason the merge preview seems to have broken--trying to view it returns an internal server error.

Maybe try rebasing it, just for the heck of it?



---

archive/issue_comments_417414.json:
```json
{
    "body": "<a id='comment:15'></a>same here, but you can by hand navigate to https://git.sagemath.org/sage.git/commit/?h=u/chapoton/22482&id=0f0b3c22651611dd0aa0cbb4ee6075e724128a53 .\n\n`@`Frederic: I don't see how your new choice of the new direction is at all different from before... \n\nAlso, I did millions of automated tests when I wrote the code some years ago, and this non-deterministic way really *always* produced the correct answer. I cannot believe this can be the problem! The reason that it should work is very simple: a finite type is usually very finite (in the sense that one usually does not consider finite types with `>> 10^6` many clusters), so by 1000 mutations in random directions, you either stay in a very finite set of clusters (than it's is finite), or you have hit a witness that this type is not finite by 100% - \\epsilon.",
    "created_at": "2017-05-12T09:26:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22482#issuecomment-417414",
    "user": "https://trac.sagemath.org/admin/accounts/users/stumpc5"
}
```

<a id='comment:15'></a>same here, but you can by hand navigate to https://git.sagemath.org/sage.git/commit/?h=u/chapoton/22482&id=0f0b3c22651611dd0aa0cbb4ee6075e724128a53 .

`@`Frederic: I don't see how your new choice of the new direction is at all different from before... 

Also, I did millions of automated tests when I wrote the code some years ago, and this non-deterministic way really *always* produced the correct answer. I cannot believe this can be the problem! The reason that it should work is very simple: a finite type is usually very finite (in the sense that one usually does not consider finite types with `>> 10^6` many clusters), so by 1000 mutations in random directions, you either stay in a very finite set of clusters (than it's is finite), or you have hit a witness that this type is not finite by 100% - \epsilon.



---

archive/issue_comments_417415.json:
```json
{
    "body": "<a id='comment:16'></a>*Always* is a strong word though.  To be clear, this was a very hard to reproduce issue, and when I run the tests for this code under normal circumstances it always passes.  It just happens that if the tests are run under certain conditions there must be *some* state of the RNG under which it ends up failing.\n\nI could try to add some further diagnostics and try to reproduce the failure again, if you point me in the right direction as to what to add.",
    "created_at": "2017-05-12T09:45:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22482#issuecomment-417415",
    "user": "https://github.com/embray"
}
```

<a id='comment:16'></a>*Always* is a strong word though.  To be clear, this was a very hard to reproduce issue, and when I run the tests for this code under normal circumstances it always passes.  It just happens that if the tests are run under certain conditions there must be *some* state of the RNG under which it ends up failing.

I could try to add some further diagnostics and try to reproduce the failure again, if you point me in the right direction as to what to add.



---

archive/issue_comments_417416.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [embray](#comment%3A16):\n\nOkay, let's go through the problem step by step (and if below is correct, than this has nothing to do with this non-deterministic test, which I still ensure to be correctly working):\n\n1. you call `Q.mutation_type()`.\n2. you call `is_mutation_finite` which correctly determines its finiteness, resulting in following the `else` clause in l912.\n3. your quiver is connected, so you call `_mutation_type_from_data` with optional argument `compute_if_necessary=False` on its unique component.\n4. (I expect that you have not built the data, so this does not result in any hit.) This results in `mut_type_part == 'unknown'`.\n5. you call `_connected_mutation_type` which can determine all finite mutation types from the infinite families (but not the exceptional types, including G2).\n6. `--> I BET THIS CAUSES THE ISSUE <--` you again call `_mutation_type_from_data` with optional argument `compute_if_necessary=True`. This brute force computes all clusters of exceptional types (of correct rank) and writes the output into external files. These external files in `relative_filename = 'cluster_algebra_quiver/mutation_classes_%s.dig6'%n` are then finally checked.\n7. As the final result, we obtain the mutation type as in your above output `mut_type_part = 'undetermined finite mutation type'`.\n\nI am not to all depth into the context of your issue. But if I must place a bet, your doctest environment has a problem with writing these external files in (6) correctly and this causes the buggy behaviour.\n\nCheers, Christian",
    "created_at": "2017-05-12T10:48:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22482#issuecomment-417416",
    "user": "https://trac.sagemath.org/admin/accounts/users/stumpc5"
}
```

<a id='comment:17'></a>Replying to [embray](#comment%3A16):

Okay, let's go through the problem step by step (and if below is correct, than this has nothing to do with this non-deterministic test, which I still ensure to be correctly working):

1. you call `Q.mutation_type()`.
2. you call `is_mutation_finite` which correctly determines its finiteness, resulting in following the `else` clause in l912.
3. your quiver is connected, so you call `_mutation_type_from_data` with optional argument `compute_if_necessary=False` on its unique component.
4. (I expect that you have not built the data, so this does not result in any hit.) This results in `mut_type_part == 'unknown'`.
5. you call `_connected_mutation_type` which can determine all finite mutation types from the infinite families (but not the exceptional types, including G2).
6. `--> I BET THIS CAUSES THE ISSUE <--` you again call `_mutation_type_from_data` with optional argument `compute_if_necessary=True`. This brute force computes all clusters of exceptional types (of correct rank) and writes the output into external files. These external files in `relative_filename = 'cluster_algebra_quiver/mutation_classes_%s.dig6'%n` are then finally checked.
7. As the final result, we obtain the mutation type as in your above output `mut_type_part = 'undetermined finite mutation type'`.

I am not to all depth into the context of your issue. But if I must place a bet, your doctest environment has a problem with writing these external files in (6) correctly and this causes the buggy behaviour.

Cheers, Christian



---

archive/issue_comments_417417.json:
```json
{
    "body": "<a id='comment:18'></a>What would you mean by \"has a problem writing these external files correctly\" (or for that matter, by \"external\")?  I can see that the files *are* being written.  One thing I noticed is that they're written to my actual `DOT_SAGE` when it seems to me the test suite should not be writing there.\n\nOther than that there's nothing \"special\" about the environment or with Docker with regard to writing files.",
    "created_at": "2017-05-12T10:59:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22482#issuecomment-417417",
    "user": "https://github.com/embray"
}
```

<a id='comment:18'></a>What would you mean by "has a problem writing these external files correctly" (or for that matter, by "external")?  I can see that the files *are* being written.  One thing I noticed is that they're written to my actual `DOT_SAGE` when it seems to me the test suite should not be writing there.

Other than that there's nothing "special" about the environment or with Docker with regard to writing files.



---

archive/issue_comments_417418.json:
```json
{
    "body": "<a id='comment:19'></a>One possible problem could be that multiple tests do `.mutation_type` in parallel. Both find the file to not exist at the beginning, and start writing and reading from the same file which results in bad results.\n\nIs it correct that you don't have a way to trigger the bug? How often did it happen? Once the file is there, the correct answer should come out of (3) above directly. Have you seen the bug after the file was correctly computed and placed?",
    "created_at": "2017-05-12T11:09:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22482#issuecomment-417418",
    "user": "https://trac.sagemath.org/admin/accounts/users/stumpc5"
}
```

<a id='comment:19'></a>One possible problem could be that multiple tests do `.mutation_type` in parallel. Both find the file to not exist at the beginning, and start writing and reading from the same file which results in bad results.

Is it correct that you don't have a way to trigger the bug? How often did it happen? Once the file is there, the correct answer should come out of (3) above directly. Have you seen the bug after the file was correctly computed and placed?



---

archive/issue_comments_417419.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [stumpc5](#comment%3A19):\n> One possible problem could be that multiple tests do `.mutation_type` in parallel. Both find the file to not exist at the beginning, and start writing and reading from the same file which results in bad results.\n\n\nIf I'm reading the code correctly, the files are written using `atomic_write` which should be free of race conditions while writing the file (fixed in #15534).\n\nTo debug further, it would be very interesting to know if the problem occurs when testing just a single file or only when testing in parallel.",
    "created_at": "2017-05-12T11:43:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22482#issuecomment-417419",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>Replying to [stumpc5](#comment%3A19):
> One possible problem could be that multiple tests do `.mutation_type` in parallel. Both find the file to not exist at the beginning, and start writing and reading from the same file which results in bad results.


If I'm reading the code correctly, the files are written using `atomic_write` which should be free of race conditions while writing the file (fixed in #15534).

To debug further, it would be very interesting to know if the problem occurs when testing just a single file or only when testing in parallel.



---

archive/issue_comments_417420.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [embray](#comment%3A18):\n> Other than that there's nothing \"special\" about the environment or with Docker with regard to writing files.\n\n\nAssuming of course that there are no bugs in Docker or the OS.",
    "created_at": "2017-05-12T11:45:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22482#issuecomment-417420",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>Replying to [embray](#comment%3A18):
> Other than that there's nothing "special" about the environment or with Docker with regard to writing files.


Assuming of course that there are no bugs in Docker or the OS.



---

archive/issue_comments_417421.json:
```json
{
    "body": "<a id='comment:22'></a>Note: there has been a bug in Sage involving the pexpect interface (don't ask me the number, I think it was reported by Erik) which was only reproducible on Docker. The underlying bug was a genuine race condition involving a `fork()`. However, for some reason, the timing outside of Docker was always such that the bug wouldn't be triggered. In Docker, things ran in a different order, causing trouble.\n\nSo: if anything in this code path involves multiple processes or threads, that's certainly a place to look for bugs.",
    "created_at": "2017-05-12T11:51:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22482#issuecomment-417421",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>Note: there has been a bug in Sage involving the pexpect interface (don't ask me the number, I think it was reported by Erik) which was only reproducible on Docker. The underlying bug was a genuine race condition involving a `fork()`. However, for some reason, the timing outside of Docker was always such that the bug wouldn't be triggered. In Docker, things ran in a different order, causing trouble.

So: if anything in this code path involves multiple processes or threads, that's certainly a place to look for bugs.



---

archive/issue_comments_417422.json:
```json
{
    "body": "<a id='comment:23'></a>I don't think there's a bug here in Docker or the OS beyond that fact that it might cause the tests to run in a slightly different order than usual.  As I stated in the description this happens when running the tests in parallel, and only sometimes.  It can't be reproduced normally.",
    "created_at": "2017-05-12T15:21:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22482#issuecomment-417422",
    "user": "https://github.com/embray"
}
```

<a id='comment:23'></a>I don't think there's a bug here in Docker or the OS beyond that fact that it might cause the tests to run in a slightly different order than usual.  As I stated in the description this happens when running the tests in parallel, and only sometimes.  It can't be reproduced normally.



---

archive/issue_comments_417423.json:
```json
{
    "body": "<a id='comment:24'></a>> `@`Frederic: I don't see how your new choice of the new direction is at all different from before... \n\n\nMy choice of direction never makes a useless choice, instead of rejecting backward moves.",
    "created_at": "2017-05-12T18:27:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22482#issuecomment-417423",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:24'></a>> `@`Frederic: I don't see how your new choice of the new direction is at all different from before... 


My choice of direction never makes a useless choice, instead of rejecting backward moves.



---

archive/issue_comments_417424.json:
```json
{
    "body": "<a id='comment:25'></a>Note that my branch also changes the behaviour for rank n=2, where we know that everybody is of finite-mutation-type. So G2 should be handled more gracefully.\n\n**EDIT**:\nMaybe my branch should be used in another independant ticket, as it does not claim to solve the issue raised here completely.",
    "created_at": "2017-05-13T06:41:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22482#issuecomment-417424",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:25'></a>Note that my branch also changes the behaviour for rank n=2, where we know that everybody is of finite-mutation-type. So G2 should be handled more gracefully.

**EDIT**:
Maybe my branch should be used in another independant ticket, as it does not claim to solve the issue raised here completely.



---

archive/issue_comments_417425.json:
```json
{
    "body": "<a id='comment:26'></a>I have moved my branch to ticket #23082, that does not pretend to solve fully the present issue of the random failing doctest. Please review #23082, this should be easy !",
    "created_at": "2017-05-26T06:57:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22482#issuecomment-417425",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:26'></a>I have moved my branch to ticket #23082, that does not pretend to solve fully the present issue of the random failing doctest. Please review #23082, this should be easy !



---

archive/issue_comments_417426.json:
```json
{
    "body": "Changing branch from \"u/chapoton/22482\" to \"\"",
    "created_at": "2017-05-26T08:22:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22482#issuecomment-417426",
    "user": "https://github.com/fchapoton"
}
```

Changing branch from "u/chapoton/22482" to ""



---

archive/issue_comments_417427.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2017-05-26T08:22:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22482#issuecomment-417427",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_417428.json:
```json
{
    "body": "Changing commit from \"0f0b3c22651611dd0aa0cbb4ee6075e724128a53\" to \"\"",
    "created_at": "2017-05-26T08:22:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22482#issuecomment-417428",
    "user": "https://github.com/fchapoton"
}
```

Changing commit from "0f0b3c22651611dd0aa0cbb4ee6075e724128a53" to ""



---

archive/issue_comments_417429.json:
```json
{
    "body": "Changing keywords from \"\" to \"cluster\".",
    "created_at": "2017-05-28T20:24:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22482#issuecomment-417429",
    "user": "https://github.com/fchapoton"
}
```

Changing keywords from "" to "cluster".
