# Issue 22754: Graph.add_edge(i,i) should not silently do nothing

archive/issues_022754.json:
```json
{
    "body": "\n```\nsage: G = Graph(3)\nsage: G.add_edge(0,0)\nsage: G.edges()\n[]\n```\n\n\nThis should be an error instead of silently being ignored.\n\nIssue created by migration from https://trac.sagemath.org/ticket/22991\n\n",
    "created_at": "2017-05-13T17:59:31Z",
    "labels": [
        "graph theory",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "Graph.add_edge(i,i) should not silently do nothing",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22754",
    "user": "jdemeyer"
}
```

```
sage: G = Graph(3)
sage: G.add_edge(0,0)
sage: G.edges()
[]
```


This should be an error instead of silently being ignored.

Issue created by migration from https://trac.sagemath.org/ticket/22991





---

archive/issue_comments_317922.json:
```json
{
    "body": "That would be a big change and I'm not sure it's a good one. We also silently ignore repeated addition of the same edge which is extremely convenient for many operations on graphs (e.g., adding sets of edges, merging vertices, etc.).\n\n```\nsage: G = Graph()\nsage: G.add_edge(0, 1)\nsage: G.add_edge(0, 1)\nsage: G.edges()\n[(0, 1, None)]\nsage: G.add_cycle([0, 1, 2])\nsage: G.edges()\n[(0, 1, None), (0, 2, None), (1, 2, None)]\nsage: G.merge_vertices([1, 2])\nsage: G.edges()\n[(0, 1, None)]\n```\n",
    "created_at": "2017-05-14T09:40:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22754#issuecomment-317922",
    "user": "dcoudert"
}
```

That would be a big change and I'm not sure it's a good one. We also silently ignore repeated addition of the same edge which is extremely convenient for many operations on graphs (e.g., adding sets of edges, merging vertices, etc.).

```
sage: G = Graph()
sage: G.add_edge(0, 1)
sage: G.add_edge(0, 1)
sage: G.edges()
[(0, 1, None)]
sage: G.add_cycle([0, 1, 2])
sage: G.edges()
[(0, 1, None), (0, 2, None), (1, 2, None)]
sage: G.merge_vertices([1, 2])
sage: G.edges()
[(0, 1, None)]
```




---

archive/issue_comments_317923.json:
```json
{
    "body": "Replying to [comment:1 dcoudert]:\n> That would be a big change and I'm not sure it's a good one.\n\nWhy not? I think that there are only two reasonable behaviours:\n\n1. `G.add_edge(v,v)` should be an error.\n\n2. `G.add_edge(v,v)` should force the graph to allow loops and then add the loop at `v`.\n\nSilently doing nothing is just going to mask bugs.\n\n> We also silently ignore repeated addition of the same edge which is extremely convenient for many operations on graphs\n\nThat's a different issue where the current behaviour makes sense. `G.add_edge(v, w)` ensures that there is an edge between `v` and `w`, regardless of whether an edge existed before.",
    "created_at": "2017-05-14T11:05:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22754#issuecomment-317923",
    "user": "jdemeyer"
}
```

Replying to [comment:1 dcoudert]:
> That would be a big change and I'm not sure it's a good one.

Why not? I think that there are only two reasonable behaviours:

1. `G.add_edge(v,v)` should be an error.

2. `G.add_edge(v,v)` should force the graph to allow loops and then add the loop at `v`.

Silently doing nothing is just going to mask bugs.

> We also silently ignore repeated addition of the same edge which is extremely convenient for many operations on graphs

That's a different issue where the current behaviour makes sense. `G.add_edge(v, w)` ensures that there is an edge between `v` and `w`, regardless of whether an edge existed before.



---

archive/issue_comments_317924.json:
```json
{
    "body": "Replying to [comment:2 jdemeyer]:\n> Replying to [comment:1 dcoudert]:\n> > That would be a big change and I'm not sure it's a good one.\n> \n> Why not? I think that there are only two reasonable behaviours:\n> \n> 1. `G.add_edge(v,v)` should be an error.\n\nIt has been proposed with #15706 to choose the behavior at the creation of the graph, and that in the future graphs will by default be simple (without loops nor multiple edges).\n\n```\nsage: Graph([(0,0)])\n/Users/dcoudert/sage/src/bin/sage-ipython:1: DeprecationWarning: You created a graph with loops from a list. Please set 'loops' to 'True' when you do so, as in the future the default behaviour will be to ignore those edges\nSee http://trac.sagemath.org/15706 for details.\n  #!/usr/bin/env python\nLooped graph on 1 vertex\nsage: Graph([(0,1), (0,1)])\n/Users/dcoudert/sage/src/bin/sage-ipython:1: DeprecationWarning: You created a graph with multiple edges from a list. Please set 'multiedges' to 'True' when you do so, as in the future the default behaviour will be to ignore those edges\nSee http://trac.sagemath.org/15706 for details.\n  #!/usr/bin/env python\nMulti-graph on 2 vertices\n```\n\n\n\n> 2. `G.add_edge(v,v)` should force the graph to allow loops and then add the loop at `v`.\nFor me this is even more dangerous than silently ignoring loops.",
    "created_at": "2017-05-14T12:21:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22754#issuecomment-317924",
    "user": "dcoudert"
}
```

Replying to [comment:2 jdemeyer]:
> Replying to [comment:1 dcoudert]:
> > That would be a big change and I'm not sure it's a good one.
> 
> Why not? I think that there are only two reasonable behaviours:
> 
> 1. `G.add_edge(v,v)` should be an error.

It has been proposed with #15706 to choose the behavior at the creation of the graph, and that in the future graphs will by default be simple (without loops nor multiple edges).

```
sage: Graph([(0,0)])
/Users/dcoudert/sage/src/bin/sage-ipython:1: DeprecationWarning: You created a graph with loops from a list. Please set 'loops' to 'True' when you do so, as in the future the default behaviour will be to ignore those edges
See http://trac.sagemath.org/15706 for details.
  #!/usr/bin/env python
Looped graph on 1 vertex
sage: Graph([(0,1), (0,1)])
/Users/dcoudert/sage/src/bin/sage-ipython:1: DeprecationWarning: You created a graph with multiple edges from a list. Please set 'multiedges' to 'True' when you do so, as in the future the default behaviour will be to ignore those edges
See http://trac.sagemath.org/15706 for details.
  #!/usr/bin/env python
Multi-graph on 2 vertices
```



> 2. `G.add_edge(v,v)` should force the graph to allow loops and then add the loop at `v`.
For me this is even more dangerous than silently ignoring loops.



---

archive/issue_comments_317925.json:
```json
{
    "body": "Replying to [comment:3 dcoudert]:\n> > 2. `G.add_edge(v,v)` should force the graph to allow loops and then add the loop at `v`.\n> For me this is even more dangerous than silently ignoring loops.\n\nTo be clear, I am not in favour or this. I just said that this was \"reasonable\", not that it was the right thing to do. But silently ignoring invalid input is never the right thing to do.",
    "created_at": "2017-05-14T13:32:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22754#issuecomment-317925",
    "user": "jdemeyer"
}
```

Replying to [comment:3 dcoudert]:
> > 2. `G.add_edge(v,v)` should force the graph to allow loops and then add the loop at `v`.
> For me this is even more dangerous than silently ignoring loops.

To be clear, I am not in favour or this. I just said that this was "reasonable", not that it was the right thing to do. But silently ignoring invalid input is never the right thing to do.



---

archive/issue_comments_317926.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-05-15T16:27:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22754#issuecomment-317926",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_317927.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-05-15T16:27:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22754#issuecomment-317927",
    "user": "jdemeyer"
}
```

New commits:



---

archive/issue_comments_317928.json:
```json
{
    "body": "Replying to [comment:2 jdemeyer]:\n> Replying to [comment:1 dcoudert]:\n> > We also silently ignore repeated addition of the same edge which is extremely convenient for many operations on graphs\n> \n> That's a different issue where the current behaviour makes sense. `G.add_edge(v, w)` ensures that there is an edge between `v` and `w`, regardless of whether an edge existed before.\n\nI don't think it is so different: if I want two objects that are modeled by my graph to be connected, I give `G.add_edge(v, w)` command. Who knows how I have obtained `v` and `w`? Maybe the algorithm I am using can result in equal ones. So if I cannot silently \"add\" a loop to a loopless graph, it seems that I should not be able to silently \"multiply\" edges on graphs without multiple edges.\n\nThere is also a possibility of giving a user warning rather than raising exceptions...",
    "created_at": "2017-05-16T04:47:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22754#issuecomment-317928",
    "user": "novoselt"
}
```

Replying to [comment:2 jdemeyer]:
> Replying to [comment:1 dcoudert]:
> > We also silently ignore repeated addition of the same edge which is extremely convenient for many operations on graphs
> 
> That's a different issue where the current behaviour makes sense. `G.add_edge(v, w)` ensures that there is an edge between `v` and `w`, regardless of whether an edge existed before.

I don't think it is so different: if I want two objects that are modeled by my graph to be connected, I give `G.add_edge(v, w)` command. Who knows how I have obtained `v` and `w`? Maybe the algorithm I am using can result in equal ones. So if I cannot silently "add" a loop to a loopless graph, it seems that I should not be able to silently "multiply" edges on graphs without multiple edges.

There is also a possibility of giving a user warning rather than raising exceptions...



---

archive/issue_comments_317929.json:
```json
{
    "body": "Replying to [comment:7 novoselt]:\n> I don't think it is so different: if I want two objects that are modeled by my graph to be connected, I give `G.add_edge(v, w)` command. Who knows how I have obtained `v` and `w`? Maybe the algorithm I am using can result in equal ones. So if I cannot silently \"add\" a loop to a loopless graph, it seems that I should not be able to silently \"multiply\" edges on graphs without multiple edges.\n\nThe way I see it, the edges of a graph form a set. And Python handles `set.add(x)` if `x` is already in the set. It's not an error because it conforms with the mathematics of a set.\n\nFor loops, the situation is different because a loop simply cannot occur on a loopless graph.",
    "created_at": "2017-05-16T09:54:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22754#issuecomment-317929",
    "user": "jdemeyer"
}
```

Replying to [comment:7 novoselt]:
> I don't think it is so different: if I want two objects that are modeled by my graph to be connected, I give `G.add_edge(v, w)` command. Who knows how I have obtained `v` and `w`? Maybe the algorithm I am using can result in equal ones. So if I cannot silently "add" a loop to a loopless graph, it seems that I should not be able to silently "multiply" edges on graphs without multiple edges.

The way I see it, the edges of a graph form a set. And Python handles `set.add(x)` if `x` is already in the set. It's not an error because it conforms with the mathematics of a set.

For loops, the situation is different because a loop simply cannot occur on a loopless graph.



---

archive/issue_comments_317930.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-05-16T12:46:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22754#issuecomment-317930",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_317931.json:
```json
{
    "body": "To see things in a different way: after doing `G.add_edge(u,v)`, then `G.has_edge(u,v)` should be `True`. This currently isn't the case.",
    "created_at": "2017-05-16T13:00:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22754#issuecomment-317931",
    "user": "jdemeyer"
}
```

To see things in a different way: after doing `G.add_edge(u,v)`, then `G.has_edge(u,v)` should be `True`. This currently isn't the case.



---

archive/issue_comments_317932.json:
```json
{
    "body": "Let me also add that it's completely undocumented that `Graph.add_edge(v, v)` does nothing. I found it very strange that it was silently ignored and cannot understand why you don't see this.",
    "created_at": "2017-05-22T08:36:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22754#issuecomment-317932",
    "user": "jdemeyer"
}
```

Let me also add that it's completely undocumented that `Graph.add_edge(v, v)` does nothing. I found it very strange that it was silently ignored and cannot understand why you don't see this.



---

archive/issue_comments_317933.json:
```json
{
    "body": "Replying to [comment:10 jdemeyer]:\n> To see things in a different way: after doing `G.add_edge(u,v)`, then `G.has_edge(u,v)` should be `True`. This currently isn't the case.\n\nThis is quite convincing, so I remove my prior objections!",
    "created_at": "2017-05-22T15:39:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22754#issuecomment-317933",
    "user": "novoselt"
}
```

Replying to [comment:10 jdemeyer]:
> To see things in a different way: after doing `G.add_edge(u,v)`, then `G.has_edge(u,v)` should be `True`. This currently isn't the case.

This is quite convincing, so I remove my prior objections!



---

archive/issue_comments_317934.json:
```json
{
    "body": "Ok, let's go for this new behavior. The writing style will become heavier, but I agree it is more consistent.\n\n\nComments on the code:\n\nIn `src/sage/graphs/generators/intersection.py`, you modified the method `IntersectionGraph`. I don't understand the benefit of using `set(clique)` instead of `clique`. In fact you could use `G.add_clique(clique)`.\n\nIn `src/sage/knots/link.py`, I sugget the following to avoid multiple calls to `set(V[i])`\n\n```\n        V = G.vertices()\n        for i in range(G.order() - 1):\n            Vi = set(V[i])\n            for j in range(i+1, G.order()):\n                if Vi.intersection(V[j]):\n                    G.add_edge(V[i], V[j])\n        return [[list(i) for i in cc] for cc in G.connected_components()]\n```\n",
    "created_at": "2017-05-23T08:21:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22754#issuecomment-317934",
    "user": "dcoudert"
}
```

Ok, let's go for this new behavior. The writing style will become heavier, but I agree it is more consistent.


Comments on the code:

In `src/sage/graphs/generators/intersection.py`, you modified the method `IntersectionGraph`. I don't understand the benefit of using `set(clique)` instead of `clique`. In fact you could use `G.add_clique(clique)`.

In `src/sage/knots/link.py`, I sugget the following to avoid multiple calls to `set(V[i])`

```
        V = G.vertices()
        for i in range(G.order() - 1):
            Vi = set(V[i])
            for j in range(i+1, G.order()):
                if Vi.intersection(V[j]):
                    G.add_edge(V[i], V[j])
        return [[list(i) for i in cc] for cc in G.connected_components()]
```




---

archive/issue_comments_317935.json:
```json
{
    "body": "Replying to [comment:13 dcoudert]:\n> I don't understand the benefit of using `set(clique)` instead of `clique`.\n\nThat change was actually needed because `clique` contains repeated elements. If `clique = [v, v]`, then `G.add_edge(v, v)` would be called, which breaks now.\n\n> In fact you could use `G.add_clique(clique)`.\n\nI didn't know about that method.",
    "created_at": "2017-05-23T09:26:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22754#issuecomment-317935",
    "user": "jdemeyer"
}
```

Replying to [comment:13 dcoudert]:
> I don't understand the benefit of using `set(clique)` instead of `clique`.

That change was actually needed because `clique` contains repeated elements. If `clique = [v, v]`, then `G.add_edge(v, v)` would be called, which breaks now.

> In fact you could use `G.add_clique(clique)`.

I didn't know about that method.



---

archive/issue_comments_317936.json:
```json
{
    "body": "> > In fact you could use `G.add_clique(clique)`.\n> \n> I didn't know about that method.\nadded recently in #22586.\nHowever, this ticket breaks it.\n\n```\nsage: G = graphs.PetersenGraph()\nsage: G.add_clique([1,1])\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n...\n   1487         if u_int == v_int and not self._loops:\n-> 1488             raise ValueError(f\"cannot add edge from {u!r} to {v!r} in graph without loops\")\n   1489 \n   1490         if not self.multiple_edges(None):\n\nValueError: cannot add edge from 1 to 1 in graph without loops\n```\n\nSo either the `set` operation should be added to `add_clique`, or use `loops=False` in the `add_edges`, or...",
    "created_at": "2017-05-23T09:33:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22754#issuecomment-317936",
    "user": "dcoudert"
}
```

> > In fact you could use `G.add_clique(clique)`.
> 
> I didn't know about that method.
added recently in #22586.
However, this ticket breaks it.

```
sage: G = graphs.PetersenGraph()
sage: G.add_clique([1,1])
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
...
   1487         if u_int == v_int and not self._loops:
-> 1488             raise ValueError(f"cannot add edge from {u!r} to {v!r} in graph without loops")
   1489 
   1490         if not self.multiple_edges(None):

ValueError: cannot add edge from 1 to 1 in graph without loops
```

So either the `set` operation should be added to `add_clique`, or use `loops=False` in the `add_edges`, or...



---

archive/issue_comments_317937.json:
```json
{
    "body": "Replying to [comment:15 dcoudert]:\n> {{{\n> sage: G = graphs.PetersenGraph()\n> sage: G.add_clique([1,1])\n> }}}\n\nI would argue that this is user error. It's really analogous to `G.add_edge([1,1])`.",
    "created_at": "2017-05-23T09:53:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22754#issuecomment-317937",
    "user": "jdemeyer"
}
```

Replying to [comment:15 dcoudert]:
> {{{
> sage: G = graphs.PetersenGraph()
> sage: G.add_clique([1,1])
> }}}

I would argue that this is user error. It's really analogous to `G.add_edge([1,1])`.



---

archive/issue_comments_317938.json:
```json
{
    "body": "ok.",
    "created_at": "2017-05-23T10:01:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22754#issuecomment-317938",
    "user": "dcoudert"
}
```

ok.



---

archive/issue_comments_317939.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-05-23T11:28:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22754#issuecomment-317939",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_317940.json:
```json
{
    "body": "Rebased to 8.0.beta7 and fixed a few more issues.",
    "created_at": "2017-05-23T11:29:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22754#issuecomment-317940",
    "user": "jdemeyer"
}
```

Rebased to 8.0.beta7 and fixed a few more issues.



---

archive/issue_comments_317941.json:
```json
{
    "body": "For me the patch is good to go.\n\nIt will take me a while to get used to it, in particular the True/False/None behavior.",
    "created_at": "2017-05-24T06:57:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22754#issuecomment-317941",
    "user": "dcoudert"
}
```

For me the patch is good to go.

It will take me a while to get used to it, in particular the True/False/None behavior.



---

archive/issue_comments_317942.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-05-24T06:57:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22754#issuecomment-317942",
    "user": "dcoudert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_317943.json:
```json
{
    "body": "Thanks!",
    "created_at": "2017-05-24T11:36:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22754#issuecomment-317943",
    "user": "jdemeyer"
}
```

Thanks!



---

archive/issue_comments_317944.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-05-27T23:42:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22754#issuecomment-317944",
    "user": "vbraun"
}
```

Resolution: fixed
