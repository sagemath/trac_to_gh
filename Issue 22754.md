# Issue 22754: Graph.add_edge(i,i) should not silently do nothing

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2017-05-13 17:59:31


```
sage: G = Graph(3)
sage: G.add_edge(0,0)
sage: G.edges()
[]
```


This should be an error instead of silently being ignored.


---

Comment by dcoudert created at 2017-05-14 09:40:22

That would be a big change and I'm not sure it's a good one. We also silently ignore repeated addition of the same edge which is extremely convenient for many operations on graphs (e.g., adding sets of edges, merging vertices, etc.).

```
sage: G = Graph()
sage: G.add_edge(0, 1)
sage: G.add_edge(0, 1)
sage: G.edges()
[(0, 1, None)]
sage: G.add_cycle([0, 1, 2])
sage: G.edges()
[(0, 1, None), (0, 2, None), (1, 2, None)]
sage: G.merge_vertices([1, 2])
sage: G.edges()
[(0, 1, None)]
```



---

Comment by jdemeyer created at 2017-05-14 11:05:03

Replying to [comment:1 dcoudert]:
> That would be a big change and I'm not sure it's a good one.

Why not? I think that there are only two reasonable behaviours:

1. `G.add_edge(v,v)` should be an error.

2. `G.add_edge(v,v)` should force the graph to allow loops and then add the loop at `v`.

Silently doing nothing is just going to mask bugs.

> We also silently ignore repeated addition of the same edge which is extremely convenient for many operations on graphs

That's a different issue where the current behaviour makes sense. `G.add_edge(v, w)` ensures that there is an edge between `v` and `w`, regardless of whether an edge existed before.


---

Comment by dcoudert created at 2017-05-14 12:21:31

Replying to [comment:2 jdemeyer]:
> Replying to [comment:1 dcoudert]:
> > That would be a big change and I'm not sure it's a good one.
> 
> Why not? I think that there are only two reasonable behaviours:
> 
> 1. `G.add_edge(v,v)` should be an error.

It has been proposed with #15706 to choose the behavior at the creation of the graph, and that in the future graphs will by default be simple (without loops nor multiple edges).

```
sage: Graph([(0,0)])
/Users/dcoudert/sage/src/bin/sage-ipython:1: DeprecationWarning: You created a graph with loops from a list. Please set 'loops' to 'True' when you do so, as in the future the default behaviour will be to ignore those edges
See http://trac.sagemath.org/15706 for details.
  #!/usr/bin/env python
Looped graph on 1 vertex
sage: Graph([(0,1), (0,1)])
/Users/dcoudert/sage/src/bin/sage-ipython:1: DeprecationWarning: You created a graph with multiple edges from a list. Please set 'multiedges' to 'True' when you do so, as in the future the default behaviour will be to ignore those edges
See http://trac.sagemath.org/15706 for details.
  #!/usr/bin/env python
Multi-graph on 2 vertices
```



> 2. `G.add_edge(v,v)` should force the graph to allow loops and then add the loop at `v`.
For me this is even more dangerous than silently ignoring loops.


---

Comment by jdemeyer created at 2017-05-14 13:32:08

Replying to [comment:3 dcoudert]:
> > 2. `G.add_edge(v,v)` should force the graph to allow loops and then add the loop at `v`.
> For me this is even more dangerous than silently ignoring loops.

To be clear, I am not in favour or this. I just said that this was "reasonable", not that it was the right thing to do. But silently ignoring invalid input is never the right thing to do.


---

Comment by jdemeyer created at 2017-05-15 16:27:54

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2017-05-15 16:27:54

New commits:


---

Comment by novoselt created at 2017-05-16 04:47:03

Replying to [comment:2 jdemeyer]:
> Replying to [comment:1 dcoudert]:
> > We also silently ignore repeated addition of the same edge which is extremely convenient for many operations on graphs
> 
> That's a different issue where the current behaviour makes sense. `G.add_edge(v, w)` ensures that there is an edge between `v` and `w`, regardless of whether an edge existed before.

I don't think it is so different: if I want two objects that are modeled by my graph to be connected, I give `G.add_edge(v, w)` command. Who knows how I have obtained `v` and `w`? Maybe the algorithm I am using can result in equal ones. So if I cannot silently "add" a loop to a loopless graph, it seems that I should not be able to silently "multiply" edges on graphs without multiple edges.

There is also a possibility of giving a user warning rather than raising exceptions...


---

Comment by jdemeyer created at 2017-05-16 09:54:02

Replying to [comment:7 novoselt]:
> I don't think it is so different: if I want two objects that are modeled by my graph to be connected, I give `G.add_edge(v, w)` command. Who knows how I have obtained `v` and `w`? Maybe the algorithm I am using can result in equal ones. So if I cannot silently "add" a loop to a loopless graph, it seems that I should not be able to silently "multiply" edges on graphs without multiple edges.

The way I see it, the edges of a graph form a set. And Python handles `set.add(x)` if `x` is already in the set. It's not an error because it conforms with the mathematics of a set.

For loops, the situation is different because a loop simply cannot occur on a loopless graph.


---

Comment by git created at 2017-05-16 12:46:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-05-16 13:00:20

To see things in a different way: after doing `G.add_edge(u,v)`, then `G.has_edge(u,v)` should be `True`. This currently isn't the case.


---

Comment by jdemeyer created at 2017-05-22 08:36:42

Let me also add that it's completely undocumented that `Graph.add_edge(v, v)` does nothing. I found it very strange that it was silently ignored and cannot understand why you don't see this.


---

Comment by novoselt created at 2017-05-22 15:39:25

Replying to [comment:10 jdemeyer]:
> To see things in a different way: after doing `G.add_edge(u,v)`, then `G.has_edge(u,v)` should be `True`. This currently isn't the case.

This is quite convincing, so I remove my prior objections!


---

Comment by dcoudert created at 2017-05-23 08:21:15

Ok, let's go for this new behavior. The writing style will become heavier, but I agree it is more consistent.


Comments on the code:

In `src/sage/graphs/generators/intersection.py`, you modified the method `IntersectionGraph`. I don't understand the benefit of using `set(clique)` instead of `clique`. In fact you could use `G.add_clique(clique)`.

In `src/sage/knots/link.py`, I sugget the following to avoid multiple calls to `set(V[i])`

```
        V = G.vertices()
        for i in range(G.order() - 1):
            Vi = set(V[i])
            for j in range(i+1, G.order()):
                if Vi.intersection(V[j]):
                    G.add_edge(V[i], V[j])
        return [[list(i) for i in cc] for cc in G.connected_components()]
```



---

Comment by jdemeyer created at 2017-05-23 09:26:45

Replying to [comment:13 dcoudert]:
> I don't understand the benefit of using `set(clique)` instead of `clique`.

That change was actually needed because `clique` contains repeated elements. If `clique = [v, v]`, then `G.add_edge(v, v)` would be called, which breaks now.

> In fact you could use `G.add_clique(clique)`.

I didn't know about that method.


---

Comment by dcoudert created at 2017-05-23 09:33:44

> > In fact you could use `G.add_clique(clique)`.
> 
> I didn't know about that method.
added recently in #22586.
However, this ticket breaks it.

```
sage: G = graphs.PetersenGraph()
sage: G.add_clique([1,1])
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
...
   1487         if u_int == v_int and not self._loops:
-> 1488             raise ValueError(f"cannot add edge from {u!r} to {v!r} in graph without loops")
   1489 
   1490         if not self.multiple_edges(None):

ValueError: cannot add edge from 1 to 1 in graph without loops
```

So either the `set` operation should be added to `add_clique`, or use `loops=False` in the `add_edges`, or...


---

Comment by jdemeyer created at 2017-05-23 09:53:17

Replying to [comment:15 dcoudert]:
> {{{
> sage: G = graphs.PetersenGraph()
> sage: G.add_clique([1,1])
> }}}

I would argue that this is user error. It's really analogous to `G.add_edge([1,1])`.


---

Comment by dcoudert created at 2017-05-23 10:01:10

ok.


---

Comment by git created at 2017-05-23 11:28:57

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-05-23 11:29:54

Rebased to 8.0.beta7 and fixed a few more issues.


---

Comment by dcoudert created at 2017-05-24 06:57:31

For me the patch is good to go.

It will take me a while to get used to it, in particular the True/False/None behavior.


---

Comment by dcoudert created at 2017-05-24 06:57:31

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2017-05-24 11:36:02

Thanks!


---

Comment by vbraun created at 2017-05-27 23:42:42

Resolution: fixed
