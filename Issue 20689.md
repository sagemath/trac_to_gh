# Issue 20689: C++11 workarounds

Issue created by migration from https://trac.sagemath.org/ticket/20926

Original creator: vbraun

Original creation time: 2016-07-03 10:45:58




---

Comment by vbraun created at 2016-07-03 10:48:29

Changing type from PLEASE CHANGE to defect.


---

Comment by vbraun created at 2016-07-03 10:48:29

Changing component from PLEASE CHANGE to packages: standard.


---

Comment by vbraun created at 2016-07-03 10:49:24

Proper fix for gfan shall go to #20925
----
New commits:


---

Comment by vbraun created at 2016-07-03 10:52:19

Changing keywords from "" to "gcc6 c++11".


---

Comment by git created at 2016-07-03 10:59:53

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vbraun created at 2016-07-03 11:16:08

Proper fix for eclib shall go to #20928


---

Comment by git created at 2016-07-03 11:17:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by leif created at 2016-07-03 11:40:51

I've posted a patch for the Sage library on sage-release.

While Singular builds, the executable and libsingular (hence Sage) crash for me and others (cf. #20738 and sage-release).


---

Comment by leif created at 2016-07-03 11:43:51

Replying to [comment:13 leif]:
> I've posted a patch for the Sage library on sage-release.


```patch
diff --git a/src/sage/libs/linbox/linbox.pxd b/src/sage/libs/linbox/linbox.pxd
index 0afd7bf..87a5e79 100644
--- a/src/sage/libs/linbox/linbox.pxd
+++ b/src/sage/libs/linbox/linbox.pxd
@@ -1,3 +1,6 @@
+# distutils: language = c++
+# distutils: extra_compile_args = -std=c++98
+
 from sage.libs.gmp.types cimport mpz_t
 
 include 'sage/modules/vector_modn_sparse_h.pxi'
diff --git a/src/sage/matrix/matrix_modn_sparse.pxd b/src/sage/matrix/matrix_modn_sparse.pxd
index 5273ec3..14a98e7 100644
--- a/src/sage/matrix/matrix_modn_sparse.pxd
+++ b/src/sage/matrix/matrix_modn_sparse.pxd
@@ -1,3 +1,5 @@
+# distutils: language = c
+
 cimport matrix_sparse
 
 include 'sage/modules/vector_modn_sparse_h.pxi'
```



---

Comment by leif created at 2016-07-03 11:46:09

Forgot the hunk for `module_list`:

```patch
diff --git a/src/module_list.py b/src/module_list.py
index a49ed36..8441106 100644
--- a/src/module_list.py
+++ b/src/module_list.py
@@ -926,7 +926,7 @@ ext_modules = [
               libraries = ['ntl', 'linbox', 'givaro', 'mpfr', 'gmpxx', 'gmp'] + cblas_libs,
               library_dirs = cblas_library_dirs,
               include_dirs = cblas_include_dirs,
-              extra_compile_args = ['-DDISABLE_COMMENTATOR'] + givaro_extra_compile_args),
+              extra_compile_args = ['-std=c++98', '-DDISABLE_COMMENTATOR'] + givaro_extra_compile_args),
 
     Extension('sage.matrix.matrix_modn_dense_double',
               sources = ['sage/matrix/matrix_modn_dense_double.pyx'],
@@ -934,7 +934,7 @@ ext_modules = [
               libraries = ['ntl', 'linbox', 'givaro', 'mpfr', 'gmpxx', 'gmp'] + cblas_libs,
               library_dirs = cblas_library_dirs,
               include_dirs = cblas_include_dirs,
-              extra_compile_args = ["-D_XPG6", "-DDISABLE_COMMENTATOR"]
+              extra_compile_args = ['-std=c++98', "-D_XPG6", "-DDISABLE_COMMENTATOR"]
                     + m4ri_extra_compile_args + givaro_extra_compile_args),
 
     Extension('sage.matrix.matrix_modn_sparse',
```



---

Comment by leif created at 2016-07-03 12:05:21

Changing keywords from "gcc6 c++11" to "gcc6 c++11 c++14".


---

Comment by git created at 2016-07-03 12:14:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by leif created at 2016-07-03 12:19:38

I don't like adding `-std=gnu++98` when `-std=c++98` is sufficient.


---

Comment by git created at 2016-07-03 15:26:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by leif created at 2016-07-03 16:57:37

I'd prefer if we only add `-fno-delete-null-pointer-checks` when necessary, as neither GCC 4.9.x nor 5.x are broken w.r.t. this:


```sh
case `$CXX -dumpversion` in
    6|6.*)
        CXXFLAGS="$CXXFLAGS -fno-delete-null-pointer-checks"
        ;;
esac
```


(The `6` is necessary for OpenSuSE's GCC IIRC.  `CXXFLAGS` already get exported earlier in Singular's `spkg-install`.)


---

Comment by vbraun created at 2016-07-03 19:48:37

For singular, `-fno-strict-overflow` seems to be an even better flag. This does not surprise too much as there are numerous warnings about conversions between pointers and signed integers.


---

Comment by leif created at 2016-07-03 21:12:00

Replying to [comment:22 vbraun]:
> For singular, `-fno-strict-overflow` seems to be an even better flag.

You mean _instead of_ `-fno-delete-null-pointer-checks`?

(In contrast to the latter, it's disabled with `-O1`, which worked for me, but only in conjunction with the latter, i.e. `-O1 -fno-delete-null-pointer-checks`, IIRC, cf. #20738 comment 6.)

\\

> This does not surprise too much as there are numerous warnings about conversions between pointers and signed integers.

Besides a lot of other suspicious warnings...


---

Comment by leif created at 2016-07-03 21:26:52

Or did you add some `extra_compile_args` in `src/sage/libs/singular/*.pxd` as well?


---

Comment by git created at 2016-07-03 21:55:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by leif created at 2016-07-03 21:56:00

Replying to [comment:23 leif]:
> Replying to [comment:22 vbraun]:
> > For singular, `-fno-strict-overflow` seems to be an even better flag.
> 
> You mean _instead of_ `-fno-delete-null-pointer-checks`?
> 
> (In contrast to the latter, it's disabled with `-O1`, which worked for me, but only in conjunction with the latter, i.e. `-O1 -fno-delete-null-pointer-checks`, IIRC, cf. #20738 comment 6.)

With just `-fno-strict-overflow` added to (just) `CXXFLAGS`, `./sage --singular` immediately segfaults for me.


---

Comment by vbraun created at 2016-07-03 21:57:08

The remaining three failures seem to be due to brial/polybori

```
sage -t --long src/sage/rings/polynomial/multi_polynomial_sequence.py  # Killed due to segmentation fault
sage -t --long src/sage/crypto/mq/sr.py  # Killed due to segmentation fault
sage -t --long src/sage/rings/polynomial/pbori.pyx  # Killed due to abort
```



---

Comment by git created at 2016-07-04 18:48:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-07-04 19:02:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2016-07-04 21:43:40

Replying to [comment:29 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[86e6a4b](http://git.sagemath.org/sage.git/commit/?id=86e6a4b21cb4a51c2aa9ed8d01b62239b8fdbd13)||`Build brial with c++98`||

As I remember I advocated for something like that initially. Actually I said I should do something about the configure script and I forgot.


---

Comment by vbraun created at 2016-07-06 07:26:33

Replying to [comment:30 fbissey]:
> As I remember I advocated for something like that initially. Actually I said I should do something about the configure script and I forgot.

There is probably a bug in the Brial code path, this should be fixed on the C++ level. But in another ticket.


---

Comment by vbraun created at 2016-07-06 07:26:56

All tests pass for me, we should merge this asap...


---

Comment by vbraun created at 2016-07-06 07:26:56

Changing priority from major to blocker.


---

Comment by vbraun created at 2016-07-06 07:26:56

Changing status from new to needs_review.


---

Comment by leif created at 2016-07-09 13:47:38

I see _"trac's automerging failed"_ (branch is colored red)...

----

Going to test on top of beta7...


---

Comment by leif created at 2016-07-09 18:29:33

Replying to [comment:31 vbraun]:
> There is probably a bug in the Brial code path, this should be fixed on the C++ level. But in another ticket.

Does this refer to the three segfaults / aborts in ptestlong you reported [comment:27 above]?  How did you get these?

\\

With Sage 7.3.beta7 (plus the branch here) and vanilla FSF GCC 6.1.0, GCC configured to produce native code by default, but otherwise no `*FLAGS` set, ptestlong passes for me (modulo the usual failure in one test due to numeric noise and another GAP-related which nearly always fails in the first place, but passes when rerun) on Linux x86_64 (Haswell-E).


---

Comment by leif created at 2016-07-09 18:48:32

[comment:21 As mentioned], I'd prefer if we only mess with optimization flags when necessary (i.e., only disable some in Singular's `spkg-install` if `$CXX` is really GCC 6.x).

Otherwise I'm ok with your changes, and mine as well... ;-)


---

Comment by leif created at 2016-07-09 19:09:56

Replying to [comment:35 leif]:
> [comment:21 As mentioned], I'd prefer if we only mess with optimization flags when necessary (i.e., only disable some in Singular's `spkg-install` if `$CXX` is really GCC 6.x).

P.S.:  There should be a `2>/dev/null` in ``$CXX -dumpversion``, and while I don't mind re-exporting CXXFLAGS, I'd move their modification a bit up (to not mix it with changes to`MAKE`):


```diff
diff --git a/build/pkgs/singular/spkg-install b/build/pkgs/singular/spkg-install
index 0b21be7..024b1e1 100755
--- a/build/pkgs/singular/spkg-install
+++ b/build/pkgs/singular/spkg-install
@@ -73,10 +73,18 @@ export CPPFLAGS="-I$SAGE_LOCAL/include $CPPFLAGS"
 export CXXFLAGS="$CXXFLAGS -fPIC"
 export CFLAGS="$CFLAGS -fPIC"
 
+# Workaround for GCC6: https://trac.sagemath.org/ticket/20926
+case `$CXX -dumpversion 2>/dev/null` in
+    6|6.*)
+        export CXXFLAGS="$CXXFLAGS -fno-delete-null-pointer-checks -fno-strict-overflow"
+        ;;
+esac
+
 # Singular does not respect LDFLAGS; Ugly hack:
 # Used on Linux and Darwin (see singular-3.1.7-use_cxx_for_linking.patch)
 export CXX="$CXX $LDFLAGS"
 
+
 # The Sun assembler has problems with -pipe, so disable it.
 # This only affects compile time, not the compiled programs/libraries.
 if [ "$UNAME" = "SunOS" ]; then
@@ -88,8 +96,6 @@ fi
 # parallel sometimes fails (Trac #17774)
 export MAKE="$MAKE -j1"
 
-# Workaround for GCC6: https://trac.sagemath.org/ticket/20926
-export CXXFLAGS="$CXXFLAGS -fno-delete-null-pointer-checks -fno-strict-overflow"
 
 choose_patches()
 {
```



---

Comment by vbraun created at 2016-07-09 19:23:12

Imho it depends on whether the compiler or the source is at fault. In the case of Singular I don't think its a compiler bug. So it most likely won't go away with gcc 7...


---

Comment by leif created at 2016-07-09 19:52:55

Replying to [comment:37 vbraun]:
> Imho it depends on whether the compiler or the source is at fault. In the case of Singular I don't think its a compiler bug. So it most likely won't go away with gcc 7...

Well, it goes away with GCC < 6.x, and we shouldn't throw arbitrary options at `$CXX`, which might -- for example -- be `clang`.  (Most parts of Sage did build with the latter, at least a while ago.  `clang` accepts a couple of GCC options, but spits out warnings for others it doesn't, and I wouldn't rely on the latter, i.e. wouldn't risk breaking something which previously worked, for no reason.)


---

Comment by vbraun created at 2016-07-09 20:03:25

Presumably, the fact that Singular ever built with gcc < 6 just was a bug in gcc (insufficient checking). This is a fugly workaround that hopefully can be removed with the Singular update. I'm against putting too much lipstick on a pig; If anything work on the Singular update.


---

Comment by jsrn created at 2016-07-13 20:21:27

I'll just confirm that this patch makes Sage compile on my machine (Arch up-to-date, gcc 6.1.1, 64 bits).


---

Comment by leif created at 2016-07-13 21:44:50

Replying to [comment:40 jsrn]:
> I'll just confirm that this patch makes Sage compile on my machine (Arch up-to-date, gcc 6.1.1, 64 bits).

Thanks for testing.  Did you also run `make [p]testlong`?


---

Comment by jsrn created at 2016-07-14 00:59:12

I'm still having another issue -- many default packages do not get installed during make, after make distclaen -- so there's tons of doctests failing. It seems to me that this issue isn't related to the new gcc, but I don't know where to start looking for a solution.


---

Comment by leif created at 2016-07-14 01:18:27

Replying to [comment:42 jsrn]:
> I'm still having another issue -- many default packages do not get installed during make, after make distclaen -- so there's tons of doctests failing. It seems to me that this issue isn't related to the new gcc, but I don't know where to start looking for a solution.

OT (I think), but did you try downgrading `make` (to 4.1, say)?

(Or debug the Sage build process with your version as suggested on sage-devel, e.g. by starting with `make -n pkg_which_didnt_get_built`, then perhaps successively adding some debug options until you see why the package doesn't get built.)


---

Comment by jsrn created at 2016-07-15 02:22:45

> OT (I think), but did you try downgrading `make` (to 4.1, say)?
> 
> (Or debug the Sage build process with your version as suggested on sage-devel, e.g. by starting with `make -n pkg_which_didnt_get_built`, then perhaps successively adding some debug options until you see why the package doesn't get built.)

Sorry, I missed your reply on sage-devel! I've downgraded make and tried another run, this time with --trace -bvjm. I'll report the results on sage-devel.


---

Comment by dimpase created at 2016-07-16 08:36:58

People report [errors with gcc 6.1.1](https://groups.google.com/d/msg/sage-support/YQL8Do2lItI/qFYHYYDqCgAJ), but it's not even an official release, but some RH-only hack. How does one deal with this?


---

Comment by vbraun created at 2016-07-16 09:17:18

Replying to [comment:45 dimpase]:
> How does one deal with this?

I'd say by merging this ticket asap; I checked that it allows Sage to build on Fedora 24.


---

Comment by dimpase created at 2016-07-16 09:23:47

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2016-07-16 09:23:47

here you go


---

Comment by dimpase created at 2016-07-16 09:24:33

well, except that there is something funny with the branch...


---

Comment by vbraun created at 2016-07-16 09:50:30

Its just the libgit (in the trac plugin) not managing the merge, but the command-line git does it just fine.


---

Comment by leif created at 2016-07-16 10:23:17

Replying to [comment:48 dimpase]:
> well, except that there is something funny with the branch...

Pull the trigger, ask later... ;-)

Nasty people might think you didn't take a look at the patch, nor read the comments.


---

Comment by dimpase created at 2016-07-16 10:25:07

Replying to [comment:51 leif]:
> Replying to [comment:48 dimpase]:
> > well, except that there is something funny with the branch...
> 
> Pull the trigger, ask later... ;-)
> Nasty people might think you didn't take a look at the patch, nor read the comments.

I read individual commits, and did not find any surprises there...


---

Comment by leif created at 2016-07-16 10:35:12

I would have been more happy if someone confirmed also the documentation now builds (and tests pass) on Arch (where the first reports originated from), since segfaults do not happen during the build, but when running Sage (or e.g. Singular).


---

Comment by vbraun created at 2016-07-16 10:58:11

I'll also be more than happy to have this tested on Arch, but since nobody did it in a timely manner our chances are better by releasing it first. Open a followup if there is still an issue.


---

Comment by leif created at 2016-07-16 12:18:02

Replying to [comment:54 vbraun]:
> I'll also be more than happy to have this tested on Arch, but since nobody did it in a timely manner our chances are better by releasing it first.

Well, you asked for further reviewers, but didn't rebase the branch here, nor anser [comment:34 my question regarding the segfaults in BRiAl] [comment:27 you reported yourself], within a week.

(I don't see a related commit here or a follow-up ticket _"fixing a bug in the BRiAl code path on the C++ level"_ either.)


---

Comment by jsrn created at 2016-07-16 12:36:02

After running `./sage -i jmol` and `./sage pip install sympy`, I can build the documentation. It's running now, so far no problems. Assuming that the package problem is orthogonal to the gcc-issue, then it's looking good.


---

Comment by vbraun created at 2016-07-16 12:40:53

Followups to https://github.com/BRiAl/BRiAl/issues/11


---

Comment by vbraun created at 2016-07-16 20:06:30

Resolution: fixed


---

Comment by leif created at 2016-07-24 16:30:56

Replying to [comment:57 vbraun]:
> Followups to https://github.com/BRiAl/BRiAl/issues/11

To not lose this on trac, I've opened #21083 which refers to the issue on github (_"Fix compilation with c++11 (default for gcc>=6)"_).


---

Comment by leif created at 2016-07-30 04:55:01

For the record:  Givaro's testsuite also fails to build; builds with `-std=c++98`.


---

Comment by leif created at 2016-08-22 14:55:02

Replying to [comment:60 leif]:
> For the record:  Givaro's testsuite also fails to build; builds with `-std=c++98`.

This is now #21169.


---

Comment by jdemeyer created at 2016-10-20 20:14:28

Why was the line

```
# distutils: language = c
```

added to `src/sage/matrix/matrix_modn_sparse.pxd`?

Does that even do something, given that `c` is the default?
