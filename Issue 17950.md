# Issue 17950: Move the planarity files to a spkg

Issue created by migration from https://trac.sagemath.org/ticket/18187

Original creator: ncohen

Original creation time: 2015-04-14 11:59:04

CC:  mmezzarobba vdelecroix tmonteil dcoudert jdemeyer

The contents of sage/graphs/planarity_c is not Sage source but a copy of John Boyer's planarity code [1]. This branch turns it into a (standard) spkg.

Nathann


[1] https://code.google.com/p/planarity/


---

Comment by ncohen created at 2015-04-14 12:01:16

Changing status from new to needs_review.


---

Comment by ncohen created at 2015-04-14 12:01:16

Changing type from PLEASE CHANGE to enhancement.


---

Comment by ncohen created at 2015-04-14 12:01:16

New commits:


---

Comment by ncohen created at 2015-04-14 12:01:16

Changing component from PLEASE CHANGE to packages: standard.


---

Comment by jdemeyer created at 2015-04-14 12:30:59

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-04-14 12:30:59

Is this meant to be a standard or optional package? In any case, the current branch obviously doesn't work if `planarity` is not installed:


```
$ make
...
building 'sage.graphs.planarity' extension
Executing 1 command (using 1 thread)
gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -fPIC -I/usr/local/src/sage-config/local/include -I/usr/local/src/sage-config/src -I/usr/local/src/sage-config/src/c_lib/include -I/usr/local/src/sage-config/src/sage/ext -I/usr/local/src/sage-config/local/include/python2.7 -c build/cythonized/sage/graphs/planarity.c -o build/temp.linux-x86_64-2.7/build/cythonized/sage/graphs/planarity.o -fno-strict-aliasing -w -fno-tree-dominator-opts
build/cythonized/sage/graphs/planarity.c:276:29: fatal error: planarity/graph.h: No such file or directory
 #include "planarity/graph.h"
                             ^
compilation terminated.
error: command 'gcc' failed with exit status 1
Makefile:19: recipe for target 'build' failed
make: *** [build] Error 1
```


Also: to be safe, you might want to rebase on top of #18145, especially if you make further changes to the build system.


---

Comment by ncohen created at 2015-04-14 12:42:10

> Is this meant to be a standard or optional package?

A standard package. This code is already part of Sage.

> Also: to be safe, you might want to rebase on top of #18145, especially if you make further changes to the build system.

Second time I have to rebase on top of that one `:-P`

Nathann


---

Comment by ncohen created at 2015-04-14 12:44:37

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2015-04-14 12:44:37

I just checked, and there are no conflicts with #18145 (trivial merge).

Nathann


---

Comment by jdemeyer created at 2015-04-14 12:52:30

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-04-14 12:55:18

Replying to [comment:4 ncohen]:
> I just checked, and there are no conflicts with #18145 (trivial merge).

I know, that ticket is just prone to conflicts. But it's also an important ticket. I hope you like the new syntax for optional packages in #18145.


---

Comment by ncohen created at 2015-04-14 13:00:23

> I know, that ticket is just prone to conflicts. But it's also an important ticket. I hope you like the new syntax for optional packages in #18145.

Yepyep, it's indeed much much cleaner!!

Nathann


---

Comment by jdemeyer created at 2015-04-22 11:47:03

When building a library in a portable way, you must use some program like `libtool`.


---

Comment by jdemeyer created at 2015-04-22 11:47:49

I wonder if you could not use install the `.c` and `.h` sources somewhere instead of building a library.


---

Comment by jdemeyer created at 2015-04-22 12:47:05

Or move `planarity` not to a spkg but to `src/ext/planarity`.


---

Comment by ncohen created at 2015-04-22 13:34:17

> Or move `planarity` not to a spkg but to `src/ext/planarity`.

Hmmmm... I prefer the libtool way out. These files haven't been reviewed, so I do not think that they should be in our code directly.


---

Comment by jdemeyer created at 2015-04-22 13:50:19

Replying to [comment:11 ncohen]:
> These files haven't been reviewed, so I do not think that they should be in our code directly.
Well, `src/ext` is not considered "our code", so that's not a problem.


---

Comment by ncohen created at 2015-04-22 14:05:15

What exactly is it meant to contain? There is also a src/sage/ext/ directory `O_o`


---

Comment by jdemeyer created at 2015-04-22 14:31:42

Replying to [comment:13 ncohen]:
> What exactly is it meant to contain?
Well, that's not so clear :-)

At least, it contains certain non-Sage code for PARI and GAP.


---

Comment by ncohen created at 2015-04-25 22:07:27

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2015-04-25 22:07:27

Now with an autotooled package `;-)`

So ? So ? So ? `:-P`

Nathann


---

Comment by git created at 2015-04-25 22:08:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-04-26 08:08:14

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-04-26 08:08:14

Well, the spkg is still not built by default (see `build/deps` and `build/install`).

Did you report your changes upstream?


---

Comment by git created at 2015-04-26 08:18:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-04-26 08:22:47

Helloooooo,

> Well, the spkg is still not built by default (see `build/deps` and `build/install`).

Right! Fixed.

> Did you report your changes upstream?

No I didn't, and for two reasons:
1) What we have in Sage is apparently an old version of the files. When building the first version of this package (without autotools) I tried to use the new ones, but did not figure out how they should be compiled.

2) The makefiles this archive contains are only made to build everything as a shared library, while upstream also builds an independent executable and maybe some other things. They probably wouldn't like what I wrote.

I plan to do both, however, and I will start by sending them an email to ask whether they would accept such a pull request. Then I will try to figure out how to make it all work properly, and we will update our version of this package.

Nathann


---

Comment by ncohen created at 2015-04-26 08:22:47

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-05-05 12:24:30

Nathann, I will make a new package using your autotools tarball.


---

Comment by jdemeyer created at 2015-05-05 12:24:30

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-05-05 12:34:11

The version of planarity in Sage seems to be version 2.2.0 (but not completely vanilla). So I would try checking out version 2.2.0 from the svn repo and add your autotools system and use that here.


---

Comment by ncohen created at 2015-05-05 12:54:11

Oh... You do this because you want us to make sure that we ship the original version of the files ?


---

Comment by jdemeyer created at 2015-05-05 13:27:14

Replying to [comment:23 ncohen]:
> Oh... You do this because you want us to make sure that we ship the original version of the files ?
Yes. Also I do it because it's a test of your updated autotools files.


---

Comment by ncohen created at 2015-05-05 14:32:22

`needs_review` ?


---

Comment by git created at 2015-05-05 14:42:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-05-05 14:42:50

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-05-05 14:45:11

I took vanilla upstream version 2.2.0 and your autotools files (with a few modifications in the list of source files) and made the new package with `make dist`. The files are not exactly equal as what was in Sage before, but all `--long` tests in `sage/graphs` pass.


---

Comment by ncohen created at 2015-05-05 14:53:37

Okay, for me it's good to go. Why did you add those lines to apply patches, given that we don't have any in there?


---

Comment by jdemeyer created at 2015-05-05 14:55:43

Replying to [comment:30 ncohen]:
> Why did you add those lines to apply patches, given that we don't have any in there?
Just in case a future ticket wants to add patches.


---

Comment by jdemeyer created at 2015-05-05 14:55:43

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-05-06 11:39:07

Fails on OSX. Also, appears to compile nauty which isn't free (definitely not BSD)

```
libtool: compile:  gcc -DPACKAGE_NAME=\"planarity\" -DPACKAGE_TARNAME=\"planarity\" -DPACKAGE_VERSION=\"2.2.0\" "-DPACKAGE_STRING=\"planarity 2.2.0\"" -DPACKAGE_BUGREPORT=\"John.Boyer.PhD@gmail.com\" -DPACKAGE_URL=\"\" -DPACKAGE=\"planarity\" -DVERSION=\"2.2.0\" -DSTDC_HEADERS=1 -DHAVE_SYS_TYPES_H=1 -DHAVE_SYS_STAT_H=1 -DHAVE_STDLIB_H=1 -DHAVE_STRING_H=1 -DHAVE_MEMORY_H=1 -DHAVE_STRINGS_H=1 -DHAVE_INTTYPES_H=1 -DHAVE_STDINT_H=1 -DHAVE_UNISTD_H=1 -DHAVE_DLFCN_H=1 -DLT_OBJDIR=\".libs/\" -I. -O3 -MT nauty/nauty.lo -MD -MP -MF nauty/.deps/nauty.Tpo -c nauty/nauty.c  -fno-common -DPIC -o nauty/.libs/nauty.o
In file included from nauty/nautil.c:37:0:
nauty/nauty.h:570:20: fatal error: malloc.h: No such file or directory
 #include <malloc.h>
                    ^
compilation terminated.
make[4]: *** [nauty/nautil.lo] Error 1
libtool: compile:  gcc -DPACKAGE_NAME=\"planarity\" -DPACKAGE_TARNAME=\"planarity\" -DPACKAGE_VERSION=\"2.2.0\" "-DPACKAGE_STRING=\"planarity 2.2.0\"" -DPACKAGE_BUGREPORT=\"John.Boyer.PhD@gmail.com\" -DPACKAGE_URL=\"\" -DPACKAGE=\"planarity\" -DVERSION=\"2.2.0\" -DSTDC_HEADERS=1 -DHAVE_SYS_TYPES_H=1 -DHAVE_SYS_STAT_H=1 -DHAVE_STDLIB_H=1 -DHAVE_STRING_H=1 -DHAVE_MEMORY_H=1 -DHAVE_STRINGS_H=1 -DHAVE_INTTYPES_H=1 -DHAVE_STDINT_H=1 -DHAVE_UNISTD_H=1 -DHAVE_DLFCN_H=1 -DLT_OBJDIR=\".libs/\" -I. -O3 -MT nauty/outproc.lo -MD -MP -MF nauty/.deps/outproc.Tpo -c nauty/outproc.c  -fno-common -DPIC -o nauty/.libs/outproc.o
In file included from nauty/nauty.c:38:0:
nauty/nauty.h:570:20: fatal error: malloc.h: No such file or directory
 #include <malloc.h>
                    ^
compilation terminated.
make[4]: *** [nauty/nauty.lo] Error 1
In file included from nauty/naututil.h:56:0,
                 from nauty/outproc.c:11:
nauty/nauty.h:570:20: fatal error: malloc.h: No such file or directory
 #include <malloc.h>
                    ^
compilation terminated.
make[4]: *** [nauty/outproc.lo] Error 1
```



---

Comment by vbraun created at 2015-05-06 11:39:32

Changing status from positive_review to needs_work.


---

Comment by ncohen created at 2015-05-06 11:56:02

`>_<`

Okay, I thought that this was only a *part* of Nauty and that the author has negociated specific bits with Brendan McKay to have this license, but it seems that there is indeed a non-GPL compatible usage restriction (against military applications) in `nauty.h`.

That's twice in two days that I learn that a massive amount of work was done for naught.

Sorry for that. I will write to the author. And I guess we should go back to the initial sources (which do not include Nauty). And there is this malloc problem to solve.

`>_<`

Nathann


---

Comment by ncohen created at 2015-05-06 13:00:31

Turns out that the 'malloc' problem is just that the POSIX location for `malloc` is `stdlib.h`. That was probably one of the things that were changed in Sage's copy of the planarity files.


---

Comment by jdemeyer created at 2015-05-06 13:02:12

> Turns out that the 'malloc' problem is just that the POSIX
> location for malloc is stdlib.h. That was probably one of the
> things that were changed in Sage's copy of the planarity files.

In any case, that's the least of our problem..


---

Comment by ncohen created at 2015-05-06 13:09:08

> In any case, that's the least of our problem...

Well, why do you say so? We just have to use the first package I
built, don't we? This one does not contain any nauty files. And
we must patch this malloc.h thing of course.

Nathann


---

Comment by git created at 2015-05-07 09:21:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-05-07 09:34:15

Hello Jeroen !

Could you explain what exactly you did to the original sources? Did you checkout some specific commit on upstream's svn repository (can you give the commit hash?) and removed the nauty directory?


---

Comment by jdemeyer created at 2015-05-07 09:43:07

Replying to [comment:40 ncohen]:
> Did you checkout some specific commit on upstream's svn repository
I checked out version tag 2.2.0

> and removed the nauty directory?
Yes, exactly.

And then I added your autotools project, adjusting the list of source files accordingly.


---

Comment by jdemeyer created at 2015-05-07 09:43:13

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2015-05-07 11:12:30

> I checked out version tag 2.2.0

Can you tell me how? I have been checking all versions from 300 to 340 and none of them seems to matche the code in your archive `O_o`

Nathann


---

Comment by ncohen created at 2015-05-07 11:32:23


```
/tmp/b/planarity-read-only$ svn ls -v ^/tags
    424 John.Boy              Oct 30  2012 ./
    319 boyerj@c              Sep 19  2010 Version 2.0.0/
    318 boyerj@c              Sep 19  2010 Version 2.1.0/
    320 boyerj@c              Sep 19  2010 Version 2.2.0/
    322 boyerj@c              Sep 19  2010 Version 2.2.1/
    402 John.Boy              Dec 20  2010 Version 3.0.0/
    424 John.Boy              Oct 30  2012 Version 3.0.0.1/
```



---

Comment by ncohen created at 2015-05-07 11:36:20

By dichotomy, it seems that the first revision containing 'version 2.2' is number 193. But that does not match the one that you packages either.


---

Comment by ncohen created at 2015-05-07 11:36:28

Changing status from needs_review to needs_info.


---

Comment by ncohen created at 2015-05-07 11:40:21

Okay, I got it with `svn checkout http://planarity.googlecode.com/svn/tags/ planarity-read-only`.

The correspondance that command above gave me between revisions and tags is quite a wonder.


---

Comment by ncohen created at 2015-05-07 11:46:26

Okay okay, good to go ! (again) `:-P`

Thank you Jeroen, by the way.

Nathann


---

Comment by ncohen created at 2015-05-07 11:46:26

Changing status from needs_info to positive_review.


---

Comment by vbraun created at 2015-05-08 10:41:37

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2015-05-08 10:41:37

Still fails on OSX, this time with:

```
libtool: compile:  gcc -DHAVE_CONFIG_H -I. -I.. -I.. -I/Users/buildslave-sage/slave/sage_git/build/local/include -I/Users/buildslave-sage/slave/sage_git/build/local/include -O2 -g -fPIC -MT set_ui.lo -MD -MP -MF .deps/set_ui.Tpo -c set_ui.c  -fno-common -DPIC -o .libs/set_ui.o
duplicate symbol _Line in:
    .libs/planarity.o
    .libs/planarityCommandLine.o
duplicate symbol _quietMode in:
    .libs/planarity.o
    .libs/planarityCommandLine.o
duplicate symbol _AdjListsForEmbeddingsOut in:
    .libs/planarity.o
    .libs/planarityCommandLine.o
duplicate symbol _ObstructedOut in:
    .libs/planarity.o
    .libs/planarityCommandLine.o
duplicate symbol _EmbeddableOut in:
    .libs/planarity.o
    .libs/planarityCommandLine.o
duplicate symbol _OrigOut in:
    .libs/planarity.o
    .libs/planarityCommandLine.o
duplicate symbol _Mode in:
    .libs/planarity.o
    .libs/planarityCommandLine.o
duplicate symbol _Line in:
    .libs/planarity.o
    .libs/planarityRandomGraphs.o
duplicate symbol _quietMode in:
    .libs/planarity.o
    .libs/planarityRandomGraphs.o
duplicate symbol _OrigOut in:
    .libs/planarity.o
    .libs/planarityRandomGraphs.o
duplicate symbol _ObstructedOut in:
    .libs/planarity.o
    .libs/planarityRandomGraphs.o
duplicate symbol _EmbeddableOut in:
    .libs/planarity.o
    .libs/planarityRandomGraphs.o
duplicate symbol _AdjListsForEmbeddingsOut in:
    .libs/planarity.o
    .libs/planarityRandomGraphs.o
duplicate symbol _Mode in:
    .libs/planarity.o
    .libs/planarityRandomGraphs.o
duplicate symbol _Line in:
    .libs/planarity.o
    .libs/planaritySpecificGraph.o
duplicate symbol _quietMode in:
    .libs/planarity.o
    .libs/planaritySpecificGraph.o
duplicate symbol _AdjListsForEmbeddingsOut in:
    .libs/planarity.o
    .libs/planaritySpecificGraph.o
duplicate symbol _ObstructedOut in:
    .libs/planarity.o
    .libs/planaritySpecificGraph.o
duplicate symbol _EmbeddableOut in:
    .libs/planarity.o
    .libs/planaritySpecificGraph.o
duplicate symbol _OrigOut in:
    .libs/planarity.o
    .libs/planaritySpecificGraph.o
duplicate symbol _Mode in:
    .libs/planarity.o
    .libs/planaritySpecificGraph.o
duplicate symbol _quietMode in:
    .libs/planarity.o
    .libs/planarityUtils.o
duplicate symbol _Mode in:
    .libs/planarity.o
    .libs/planarityUtils.o
duplicate symbol _OrigOut in:
    .libs/planarity.o
    .libs/planarityUtils.o
duplicate symbol _EmbeddableOut in:
    .libs/planarity.o
    .libs/planarityUtils.o
duplicate symbol _ObstructedOut in:
    .libs/planarity.o
    .libs/planarityUtils.o
duplicate symbol _AdjListsForEmbeddingsOut in:
    .libs/planarity.o
    .libs/planarityUtils.o
duplicate symbol _Line in:
    .libs/planarity.o
    .libs/planarityUtils.o
ld: 28 duplicate symbols for architecture x86_64
collect2: error: ld returned 1 exit status
make[4]: *** [libplanarity.la] Error 1
make[4]: Target `install' not remade because of errors.
gcc -O2 --param max-inline-insns-single=1200  -o insdelln ../obj_s/insdelln.o -Wl,-search_paths_first -I. -I../../test -I../test -DHAVE_CONFIG_H -I. -I../include -I../../test/../include -I/Users/buildslave-sage/slave/sage_git/build/local/include   -D_DARWIN_C_SOURCE -DNDEBUG -O2 --param max-inline-insns-single=1200  -dynamic  `echo "-L../lib -lform -lmenu -lpanel -lncurses -ltinfo  " | sed -e 's/-lform.*-lpanel[^ ]*//'` -lutil  
```

Jeroen: I can make an account on the OSX buildbot if you need one...


---

Comment by jdemeyer created at 2015-05-09 09:55:17

Sure, you can make me an account.


---

Comment by git created at 2015-05-09 10:18:31

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-05-09 10:19:53

I updated the autotools project inside the tarball. I guess it should work but I haven't tested on OS X.


---

Comment by jdemeyer created at 2015-05-09 10:19:53

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-05-09 10:44:17

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-05-09 10:55:39

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-05-12 10:15:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-05-12 11:49:11

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2015-05-12 11:49:11

This now works on OS X.


---

Comment by vbraun created at 2015-05-12 23:05:08


```
>>> Trying to download http://www.sagemath.org/packages/upstream/planarity/planarity-2.2.0.tar.bz2
[...............................................]
Checksum: 3ef0985a2b8476123969cef5c1273d11286605f2 vs 90ff1db146aeffcc330cc9117a72e72aaf4a4fec
Invalid checksum for planarity-2.2.0.tar.bz2.tmp
```

You need to change the version number when changing the tarball. The buildbots have the old tarball cached now.


---

Comment by vbraun created at 2015-05-12 23:05:08

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2015-05-13 05:30:18

Replying to [comment:59 vbraun]:
> You need to change the version number when changing the tarball. The buildbots have the old tarball cached now.

Sorry Volker, but I don't get it. Just because the buildbots have _tested_ an earlier version, I have to change the tarball name? Can't you change the buildbot script such that it re-downloads the tarball every time (using `wget -N` if you use `wget`) or at least whenever the checksum check failed?


---

Comment by vbraun created at 2015-05-13 08:16:30

The buildbot just relies on Sage to download tarballs.


---

Comment by vbraun created at 2015-05-13 08:19:55

PS: #15642 will re-download tarballs whose checksum does not match


---

Comment by jdemeyer created at 2015-05-13 15:17:00

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2015-05-13 15:17:00

So, since you added the #15642 as dependency, there is no problem, right?


---

Comment by vbraun created at 2015-05-14 09:10:07

Turns out sage-spkg doesn't even call sage-download-files if the checksum doesn't match, this is now #18417


---

Comment by vbraun created at 2015-05-16 08:25:47

Fixing the downloading is now #18428


---

Comment by jdemeyer created at 2015-05-20 07:26:24

Needs work because of #18431


---

Comment by jdemeyer created at 2015-05-20 07:26:24

Changing status from positive_review to needs_work.


---

Comment by git created at 2015-06-03 08:59:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-06-03 09:08:06

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2015-06-04 08:15:40

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-06-04 22:46:31

Resolution: fixed
