# Issue 31163: Serious errors in heights of projective points over number fields

Issue created by migration from https://trac.sagemath.org/ticket/31400

Original creator: cremona

Original creation time: 2021-02-15 11:31:38

CC:  slelievre @enderwannabe

Keywords: projective height

This was raised at https://ask.sagemath.org/question/55698/height-of-rational-points/ .

Number fields have an iterator to yield all elements of bounded global height.  This is used in an incorrect way to enumerate points of bounded height on projective space: in schemes.projective.projective_space the iterator `points_of_bounded_height` appears to iterate over all points whose projective coordinates all have height less than the given bound -- this is not just wrong, it is not well-defined.  Similarly, in schemes.projective.projective_point the global height of a point is incorrectly implemented as the max of the heights of its coordinates -- again, not well defined.


---

Comment by @8d1h created at 2021-02-26 13:42:01

Hi, I updated my code and added some docs (see the `.py` file here https://github.com/8d1h/RationalPoints/)

The global height is implemented without log, since this gives the precise value for rational numbers.

The rational point enumeration method uses elimination and is a lot faster than the current available algorithms (see the documented examples).


---

Comment by mkoeppe created at 2021-05-10 17:42:09

Moving to 9.4, as 9.3 has been released.


---

Comment by chapoton created at 2021-09-12 09:58:13

Changing status from new to needs_review.


---

Comment by chapoton created at 2021-09-12 09:58:13

I have ported the code for global_height from "gh-8d1h" git repo. No idea if this is correct and better than before.
----
New commits:


---

Comment by chapoton created at 2021-09-17 07:33:19

would someone please provide a doctest where the value was wrong before ?


---

Comment by @8d1h created at 2021-09-17 09:33:24

Hi! Sorry I was going to fix this but I didn't quite figure out how the whole trac thing works.

For doctests, I put two of them in my file.


```
sage: P = ProjectiveSpace(QQ, 2)
sage: P(1/1,2/3,5/8).global_height()
2.77258872223978
sage: F.<u> = NumberField(x^3-5)
sage: P = ProjectiveSpace(F, 2)
sage: P(u,u^2/5,1).global_height()
0.536479304144700
```


These are the current wrong results: they should be log(24) and 1.07295860828940 respectively.


---

Comment by git created at 2021-09-17 12:36:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-09-17 12:37:44

Thanks. I have added these doctests.


---

Comment by chapoton created at 2021-09-17 12:38:44

Is there any other program that can be used to check these values ?


---

Comment by @8d1h created at 2021-09-17 12:59:37

I guess you could try Magma at http://magma.maths.usyd.edu.au/calc/

```
P := ProjectiveSpace(Rationals(),2);
p := P ! [1/1,2/3,5/8];
Log(HeightOnAmbient(p:Absolute));

R<x> := PolynomialRing(Integers());
F<u> := NumberField(x^3-5);
P := ProjectiveSpace(F,2);
p := P ! [u,u^2/5,1];
Log(HeightOnAmbient(p:Absolute));
```

although there are some differences in conventions, hence the `Log` and `:Absolute`.

(BTW I was trying to use Sage to check these values for my computation in Macaulay2 in the first place, and it turned out that the function is not correctly implemented...)


---

Comment by chapoton created at 2021-09-17 13:06:48

ok, looks good, same results in magma. I would propose to keep the other problem about the iterator for another ticket. 

`@`cremona, `@`roed, would you please review ?


---

Comment by @EnderWannabe created at 2021-09-17 17:04:46

The functionality looks good to me.

We have an issue with return types.


```
sage: P.<x,y,z> = ProjectiveSpace(QQ,2)
sage: Q = P.point([4, 4, 1/30])
sage: type(Q.global_height())
<class 'sage.symbolic.expression.Expression'>
```


While sometimes we return a real number. Since the function previously returned a real number, we shouldn't change the return type.


---

Comment by @EnderWannabe created at 2021-09-17 17:04:46

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2021-09-17 17:59:05

so you prefer the inexact answer to the exact answer ?


---

Comment by @EnderWannabe created at 2021-09-17 18:04:49

Since this a function already included in Sage, we can't change it's return type without somehow deprecating the function.

Additionally, it seems we can't return the exact answer in all cases - some answers are still inexact. Having different types returned from the same function with the same parameters is bad practice.

So here I do prefer the inexact answer. It would be nice to return an exact answer, but I don't think it's possible here.


---

Comment by @8d1h created at 2021-09-17 19:35:13

Actually, it is possible to return the exact answer even for general number fields, ~~by implementing an exact version of `complex_embedding` using `QQbar`, which would also be useful in general.~~ by using `K.embeddings(QQbar)`.

But I agree that one should be consistent with the return type. Since `2.global_height()` returns an inexact value instead of `log(2)`, I think here it should also return the inexact value.


---

Comment by git created at 2021-09-18 09:50:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-09-18 09:51:12

ok, here it goes


---

Comment by chapoton created at 2021-09-18 17:48:46

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-09-19 15:46:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @EnderWannabe created at 2021-09-20 01:51:42

LGTM


---

Comment by @EnderWannabe created at 2021-09-20 01:51:42

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2021-09-20 06:07:11

the author should probably be gh-8d1h ? I just copied and adapted the code

We need an "Author full name"..


---

Comment by vbraun created at 2021-10-09 11:10:23

Resolution: fixed


---

Comment by bhutz created at 2021-10-12 21:37:00

I recently came across this bug in the height functions as well as a couple other height bugs. This ticket did fix the the incorrect values I was seeing in global_height().

I'm trying to see if the other issues already have tickets opened too. Was there a ticket opened for the projective points of bounded height iterator? I couldn't find one when I searched trac.

Thanks.


---

Comment by bhutz created at 2021-10-13 23:48:06

I've created the iterator ticket as #32686
