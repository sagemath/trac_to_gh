# Issue 31163: Serious errors in heights of projective points over number fields

archive/issues_031163.json:
```json
{
    "body": "CC:  @slel @enderwannabe\n\nKeywords: projective height\n\nThis was raised at https://ask.sagemath.org/question/55698/height-of-rational-points/ .\n\nNumber fields have an iterator to yield all elements of bounded global height.  This is used in an incorrect way to enumerate points of bounded height on projective space: in schemes.projective.projective_space the iterator `points_of_bounded_height` appears to iterate over all points whose projective coordinates all have height less than the given bound -- this is not just wrong, it is not well-defined.  Similarly, in schemes.projective.projective_point the global height of a point is incorrectly implemented as the max of the heights of its coordinates -- again, not well defined.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31400\n\n",
    "created_at": "2021-02-15T11:31:38Z",
    "labels": [
        "number theory",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Serious errors in heights of projective points over number fields",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31163",
    "user": "@JohnCremona"
}
```
CC:  @slel @enderwannabe

Keywords: projective height

This was raised at https://ask.sagemath.org/question/55698/height-of-rational-points/ .

Number fields have an iterator to yield all elements of bounded global height.  This is used in an incorrect way to enumerate points of bounded height on projective space: in schemes.projective.projective_space the iterator `points_of_bounded_height` appears to iterate over all points whose projective coordinates all have height less than the given bound -- this is not just wrong, it is not well-defined.  Similarly, in schemes.projective.projective_point the global height of a point is incorrectly implemented as the max of the heights of its coordinates -- again, not well defined.

Issue created by migration from https://trac.sagemath.org/ticket/31400





---

archive/issue_comments_445419.json:
```json
{
    "body": "Hi, I updated my code and added some docs (see the `.py` file here https://github.com/8d1h/RationalPoints/)\n\nThe global height is implemented without log, since this gives the precise value for rational numbers.\n\nThe rational point enumeration method uses elimination and is a lot faster than the current available algorithms (see the documented examples).",
    "created_at": "2021-02-26T13:42:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31163#issuecomment-445419",
    "user": "@8d1h"
}
```

Hi, I updated my code and added some docs (see the `.py` file here https://github.com/8d1h/RationalPoints/)

The global height is implemented without log, since this gives the precise value for rational numbers.

The rational point enumeration method uses elimination and is a lot faster than the current available algorithms (see the documented examples).



---

archive/issue_comments_445420.json:
```json
{
    "body": "Moving to 9.4, as 9.3 has been released.",
    "created_at": "2021-05-10T17:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31163#issuecomment-445420",
    "user": "@mkoeppe"
}
```

Moving to 9.4, as 9.3 has been released.



---

archive/issue_comments_445421.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-09-12T09:58:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31163#issuecomment-445421",
    "user": "@fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_445422.json:
```json
{
    "body": "I have ported the code for global_height from \"gh-8d1h\" git repo. No idea if this is correct and better than before.\n----\nNew commits:",
    "created_at": "2021-09-12T09:58:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31163#issuecomment-445422",
    "user": "@fchapoton"
}
```

I have ported the code for global_height from "gh-8d1h" git repo. No idea if this is correct and better than before.
----
New commits:



---

archive/issue_comments_445423.json:
```json
{
    "body": "would someone please provide a doctest where the value was wrong before ?",
    "created_at": "2021-09-17T07:33:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31163#issuecomment-445423",
    "user": "@fchapoton"
}
```

would someone please provide a doctest where the value was wrong before ?



---

archive/issue_comments_445424.json:
```json
{
    "body": "Hi! Sorry I was going to fix this but I didn't quite figure out how the whole trac thing works.\n\nFor doctests, I put two of them in my file.\n\n\n```\nsage: P = ProjectiveSpace(QQ, 2)\nsage: P(1/1,2/3,5/8).global_height()\n2.77258872223978\nsage: F.<u> = NumberField(x^3-5)\nsage: P = ProjectiveSpace(F, 2)\nsage: P(u,u^2/5,1).global_height()\n0.536479304144700\n```\n\n\nThese are the current wrong results: they should be log(24) and 1.07295860828940 respectively.",
    "created_at": "2021-09-17T09:33:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31163#issuecomment-445424",
    "user": "@8d1h"
}
```

Hi! Sorry I was going to fix this but I didn't quite figure out how the whole trac thing works.

For doctests, I put two of them in my file.


```
sage: P = ProjectiveSpace(QQ, 2)
sage: P(1/1,2/3,5/8).global_height()
2.77258872223978
sage: F.<u> = NumberField(x^3-5)
sage: P = ProjectiveSpace(F, 2)
sage: P(u,u^2/5,1).global_height()
0.536479304144700
```


These are the current wrong results: they should be log(24) and 1.07295860828940 respectively.



---

archive/issue_comments_445425.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-17T12:36:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31163#issuecomment-445425",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_445426.json:
```json
{
    "body": "Thanks. I have added these doctests.",
    "created_at": "2021-09-17T12:37:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31163#issuecomment-445426",
    "user": "@fchapoton"
}
```

Thanks. I have added these doctests.



---

archive/issue_comments_445427.json:
```json
{
    "body": "Is there any other program that can be used to check these values ?",
    "created_at": "2021-09-17T12:38:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31163#issuecomment-445427",
    "user": "@fchapoton"
}
```

Is there any other program that can be used to check these values ?



---

archive/issue_comments_445428.json:
```json
{
    "body": "I guess you could try Magma at http://magma.maths.usyd.edu.au/calc/\n\n```\nP := ProjectiveSpace(Rationals(),2);\np := P ! [1/1,2/3,5/8];\nLog(HeightOnAmbient(p:Absolute));\n\nR<x> := PolynomialRing(Integers());\nF<u> := NumberField(x^3-5);\nP := ProjectiveSpace(F,2);\np := P ! [u,u^2/5,1];\nLog(HeightOnAmbient(p:Absolute));\n```\n\nalthough there are some differences in conventions, hence the `Log` and `:Absolute`.\n\n(BTW I was trying to use Sage to check these values for my computation in Macaulay2 in the first place, and it turned out that the function is not correctly implemented...)",
    "created_at": "2021-09-17T12:59:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31163#issuecomment-445428",
    "user": "@8d1h"
}
```

I guess you could try Magma at http://magma.maths.usyd.edu.au/calc/

```
P := ProjectiveSpace(Rationals(),2);
p := P ! [1/1,2/3,5/8];
Log(HeightOnAmbient(p:Absolute));

R<x> := PolynomialRing(Integers());
F<u> := NumberField(x^3-5);
P := ProjectiveSpace(F,2);
p := P ! [u,u^2/5,1];
Log(HeightOnAmbient(p:Absolute));
```

although there are some differences in conventions, hence the `Log` and `:Absolute`.

(BTW I was trying to use Sage to check these values for my computation in Macaulay2 in the first place, and it turned out that the function is not correctly implemented...)



---

archive/issue_comments_445429.json:
```json
{
    "body": "ok, looks good, same results in magma. I would propose to keep the other problem about the iterator for another ticket. \n\n`@`cremona, `@`roed, would you please review ?",
    "created_at": "2021-09-17T13:06:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31163#issuecomment-445429",
    "user": "@fchapoton"
}
```

ok, looks good, same results in magma. I would propose to keep the other problem about the iterator for another ticket. 

`@`cremona, `@`roed, would you please review ?



---

archive/issue_comments_445430.json:
```json
{
    "body": "The functionality looks good to me.\n\nWe have an issue with return types.\n\n\n```\nsage: P.<x,y,z> = ProjectiveSpace(QQ,2)\nsage: Q = P.point([4, 4, 1/30])\nsage: type(Q.global_height())\n<class 'sage.symbolic.expression.Expression'>\n```\n\n\nWhile sometimes we return a real number. Since the function previously returned a real number, we shouldn't change the return type.",
    "created_at": "2021-09-17T17:04:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31163#issuecomment-445430",
    "user": "@EnderWannabe"
}
```

The functionality looks good to me.

We have an issue with return types.


```
sage: P.<x,y,z> = ProjectiveSpace(QQ,2)
sage: Q = P.point([4, 4, 1/30])
sage: type(Q.global_height())
<class 'sage.symbolic.expression.Expression'>
```


While sometimes we return a real number. Since the function previously returned a real number, we shouldn't change the return type.



---

archive/issue_comments_445431.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-09-17T17:04:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31163#issuecomment-445431",
    "user": "@EnderWannabe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_445432.json:
```json
{
    "body": "so you prefer the inexact answer to the exact answer ?",
    "created_at": "2021-09-17T17:59:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31163#issuecomment-445432",
    "user": "@fchapoton"
}
```

so you prefer the inexact answer to the exact answer ?



---

archive/issue_comments_445433.json:
```json
{
    "body": "Since this a function already included in Sage, we can't change it's return type without somehow deprecating the function.\n\nAdditionally, it seems we can't return the exact answer in all cases - some answers are still inexact. Having different types returned from the same function with the same parameters is bad practice.\n\nSo here I do prefer the inexact answer. It would be nice to return an exact answer, but I don't think it's possible here.",
    "created_at": "2021-09-17T18:04:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31163#issuecomment-445433",
    "user": "@EnderWannabe"
}
```

Since this a function already included in Sage, we can't change it's return type without somehow deprecating the function.

Additionally, it seems we can't return the exact answer in all cases - some answers are still inexact. Having different types returned from the same function with the same parameters is bad practice.

So here I do prefer the inexact answer. It would be nice to return an exact answer, but I don't think it's possible here.



---

archive/issue_comments_445434.json:
```json
{
    "body": "Actually, it is possible to return the exact answer even for general number fields, ~~by implementing an exact version of `complex_embedding` using `QQbar`, which would also be useful in general.~~ by using `K.embeddings(QQbar)`.\n\nBut I agree that one should be consistent with the return type. Since `2.global_height()` returns an inexact value instead of `log(2)`, I think here it should also return the inexact value.",
    "created_at": "2021-09-17T19:35:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31163#issuecomment-445434",
    "user": "@8d1h"
}
```

Actually, it is possible to return the exact answer even for general number fields, ~~by implementing an exact version of `complex_embedding` using `QQbar`, which would also be useful in general.~~ by using `K.embeddings(QQbar)`.

But I agree that one should be consistent with the return type. Since `2.global_height()` returns an inexact value instead of `log(2)`, I think here it should also return the inexact value.



---

archive/issue_comments_445435.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-18T09:50:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31163#issuecomment-445435",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_445436.json:
```json
{
    "body": "ok, here it goes",
    "created_at": "2021-09-18T09:51:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31163#issuecomment-445436",
    "user": "@fchapoton"
}
```

ok, here it goes



---

archive/issue_comments_445437.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-09-18T17:48:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31163#issuecomment-445437",
    "user": "@fchapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_445438.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-19T15:46:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31163#issuecomment-445438",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_445439.json:
```json
{
    "body": "LGTM",
    "created_at": "2021-09-20T01:51:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31163#issuecomment-445439",
    "user": "@EnderWannabe"
}
```

LGTM



---

archive/issue_comments_445440.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-09-20T01:51:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31163#issuecomment-445440",
    "user": "@EnderWannabe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_445441.json:
```json
{
    "body": "the author should probably be gh-8d1h ? I just copied and adapted the code\n\nWe need an \"Author full name\"..",
    "created_at": "2021-09-20T06:07:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31163#issuecomment-445441",
    "user": "@fchapoton"
}
```

the author should probably be gh-8d1h ? I just copied and adapted the code

We need an "Author full name"..



---

archive/issue_comments_445442.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-10-09T11:10:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31163#issuecomment-445442",
    "user": "@vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_445443.json:
```json
{
    "body": "I recently came across this bug in the height functions as well as a couple other height bugs. This ticket did fix the the incorrect values I was seeing in global_height().\n\nI'm trying to see if the other issues already have tickets opened too. Was there a ticket opened for the projective points of bounded height iterator? I couldn't find one when I searched trac.\n\nThanks.",
    "created_at": "2021-10-12T21:37:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31163#issuecomment-445443",
    "user": "@bhutz"
}
```

I recently came across this bug in the height functions as well as a couple other height bugs. This ticket did fix the the incorrect values I was seeing in global_height().

I'm trying to see if the other issues already have tickets opened too. Was there a ticket opened for the projective points of bounded height iterator? I couldn't find one when I searched trac.

Thanks.



---

archive/issue_comments_445444.json:
```json
{
    "body": "I've created the iterator ticket as #32686",
    "created_at": "2021-10-13T23:48:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31163#issuecomment-445444",
    "user": "@bhutz"
}
```

I've created the iterator ticket as #32686
