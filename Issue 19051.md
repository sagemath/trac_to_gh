# Issue 19051: Method logabs() for number field elements

Issue created by migration from Trac.

Original creator: pbruin

Original creation time: 2015-09-24 21:03:17

CC:  cremona jdemeyer

It would be useful to have a method `NumberFieldElement.logabs(emb)`, where `emb` is a real or complex embedding, such that `x.logabs(emb)` returns log |emb(x)|, increasing the precision of emb as needed, and raises an error if x = 0.


---

Comment by jdemeyer created at 2015-09-25 08:28:21

I don't see the point of adding a method to compute `log |emb(x)|` in a special way. Why not just fix `emb(x)` itself?


---

Comment by jdemeyer created at 2015-09-25 18:55:30

This is independent of #19276.


---

Comment by jdemeyer created at 2015-09-25 19:11:02

Here is a concrete proposal:

subclass `NumberFieldHomomorphism_im_gens` with a new class `NumberFieldRealComplexEmbedding` for embeddings of number fields into `RR` or `CC`. The implementation can be close to [comment:12:ticket:19276] but more efficient.


---

Comment by pbruin created at 2015-10-01 13:26:02

I don't completely agree with re-purposing this ticket.  In my opinion a method `logabs()` would still be useful.  It should implement _x_ â†¦ log |_x_|<sub>v</sub> for any place _v_: either an Archimedean place defined by a real or complex embedding, or a non-Archimedean place defined by a prime ideal of the ring of integers.  For Archimedean places it would do this by simply computing the embedding to sufficient precision and then taking the logarithm of the absolute value.  For non-Archimedean places it should return `-x.valuation(p) * RR(p.norm()).log()`, which would presumably be more efficient than `RR(p.norm()^-x.valuation(p)).log()`.

Anyway, I'm not going to do that now, so I don't mind too much if this becomes the ticket for fixing the accuracy of real/complex embeddings.  Still, I would be in favour of having a `logabs()` method at some point (on a different ticket).


---

Comment by jdemeyer created at 2015-10-01 13:33:01

Replying to [comment:7 pbruin]:
> In my opinion a method `logabs()` would still be useful.

OK, fine. However, since I thought the motivation for this was to fix #19276, I decided to re-purpose this ticket with a different fix for #19276.


---

Comment by jdemeyer created at 2015-10-02 13:17:48

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2015-10-02 13:17:48

New commits:


---

Comment by git created at 2015-10-02 13:34:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-10-04 10:48:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cremona created at 2015-10-04 15:18:42

Thanks for all the great work on this which I have not been able to follow as I was at a workshop last week.
I think there will be other places where this functionality will be useful -- for examples, computation of periods and elliptic logs, where the result depends on an embedding and what is stored is an embedding into AA or QQbar, only converted to a RealField or ComplexField with some precision when needed.


---

Comment by git created at 2015-10-05 06:11:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-10-05 15:28:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-10-05 15:28:57

I moved part of this branch to #19351 and squashed the commits.


---

Comment by jdemeyer created at 2015-10-06 11:27:43

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-10-06 11:49:50

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-10-06 11:50:42

Again simplified by moving some changes to #19356.


---

Comment by jdemeyer created at 2015-10-06 12:04:23

Changing status from needs_work to needs_review.


---

Comment by ehlen created at 2016-06-22 18:37:55

Does this really depend on #19362, which needs work?
I would be really interested in having this improved functionality and would be willing to review the ticket (but #19362 seems a bit tricky as jdemeyer wrote that he does not remember what exactly needs to be done...).


---

Comment by cremona created at 2016-06-22 22:23:34

At least some of the commits on this ticket come from #19362 (in the sense that they are there too), but I don't see why that necessarily means that this ticket needs to wait for that one.  As long as all the changes in all the commits here are ok!
I started all this with #19276, which thankfully was fixed and merged independently.  This and #19362 is one of those cases where well-meaning people wanted to make something perfect and not just good enough.


---

Comment by cheuberg created at 2017-01-08 06:38:04

Changing status from needs_review to needs_work.


---

Comment by cheuberg created at 2017-01-08 06:38:04

does not merge with 7.5.rc2


---

Comment by cremona created at 2020-05-11 11:17:58

It is a pity that this ticket and the related #19362 have been abandoned, since the issues they are trying to solve still cause problems: see #29666 which I have fixed using a different approach.  Perhaps the approach used there is more generally applicable, so for the record I'll say something about it here.

Right now if you define an embedding (real, say) of a number field with some precision using K.embeddings(RealField(prec)) and then use the embedding to map individual number field elements, the images you get are in RealField(prec)  but can be very far from the correct values.  Instead you can get an accurate value by using refine_embedding (as it is in Sage 9.1.rc anyway) to refine the embedding to precision Infinity, which embedds into AA (or Qbar for a complex embedding), use that to map individual elements and then push them into RealField(prec) afterwards.  This seems to work pretty well and is robust, though of course it will be slower, thgough as long as the only operations you do on AA elements are +,-,* and not division, so testing for 0 is not required, that should not be a problem.
