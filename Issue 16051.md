# Issue 16051: Optimize sage.sets.cartesian_product.CartesianProduct._cartesian_product_of_elements

Issue created by migration from Trac.

Original creator: nthiery

Original creation time: 2014-05-04 21:20:59

CC:  sage-combinat ncohen

This fixed `_cartesian_product_of_elements` to bypass `_element_constructor` and other checks, and documented it; this is particularly relevant after #16269 which introduces more checks and coercion in `_element_constructor`. Timing difference:

```
sage: S1 = Sets().example()
sage: S2 = InfiniteEnumeratedSets().example()
sage: C = cartesian_product([S2, S1, S2])
sage: l = tuple([S2.an_element(), S1.an_element(), S2.an_element()])
```

Without the optimization:

```
sage: %timeit C._cartesian_product_of_elements(l)
10000 loops, best of 3: 22 Âµs per loop
```

With the optimization:

```
sage: %timeit C._cartesian_product_of_elements(lt)
1000000 loops, best of 3: 922 ns per loop
```




---

Comment by nthiery created at 2014-05-04 21:21:41

Last 10 new commits:


---

Comment by nthiery created at 2014-05-04 21:21:41

Changing status from new to needs_review.


---

Comment by nthiery created at 2014-05-04 21:24:25

For the record: all long tests passed.


---

Comment by git created at 2014-05-04 23:44:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2014-05-05 07:47:41

The top commit of the branch here is "#16289: Fix ZZ.cartesian_product(...)", and this ticket's number never appears in the branch's commits `O_o`

Nathann


---

Comment by ncohen created at 2014-05-05 07:47:59

(by the way we are on rc2 now)


---

Comment by nthiery created at 2014-05-05 09:25:17

Replying to [comment:4 ncohen]:
> The top commit of the branch here is "#16289: Fix ZZ.cartesian_product(...)".

Fixed. Damned reference effect :-)

>  and this ticket's number never appears in the branch's commits `O_o`.

Well, yes, at the time I wrote the commit, I did not know whether you wanted a new ticket or not.
----
Last 10 new commits:


---

Comment by ncohen created at 2014-05-05 09:30:13

Hello !

Two questions :

1) Does this file belong to the reference manual ? `sage -docbuild reference/sets html` says that "sets" does not exist.

   a) If it does not, should it be added (in another patch) ?

   b) If it does not, could this `_cartesian_product_of_elements` function be made to appear in the doc, even though it is private ?

2) You change the meaning of an existing function. Is there any way to check that it is currently well used in other places and should not be replaced by "self" where it is  used ?

3) Shouldn't this method be removed and the two lines

```
          elements = tuple(elements)
          assert len(elements) == len(self._sets)
```

moved to `element_class` (I do not know where `element_class` is defined) ?

Nathann

Nathann


---

Comment by ncohen created at 2014-05-05 09:30:13

Changing status from needs_review to needs_info.


---

Comment by ncohen created at 2014-05-05 09:32:06

> Two questions :
> 1) 
> 2) 
> 3) 

I know ....


---

Comment by nthiery created at 2014-05-05 10:06:24

Hi Nathann,

Thanks for looking at this!

Replying to [comment:10 ncohen]:
> 1) Does this file belong to the reference manual ? `sage -docbuild reference/sets html` says that "sets" does not exist.

Oh, right. Well from grepping around, it's referenced from
`src/doc/en/reference/structure/index.rst`, so that's alright. Maybe `sage.sets` would deserve a
document of its own at some point.

>    b) If it does not, could this `_cartesian_product_of_elements` function be made to appear in the doc, even though it is private ?

That you ask the question raises another one: should this method be
private in the first place? When I created it, I did not know how much
I wanted it to be exposed, hence I started with a private method as
it's easier to change this way than the other. I added a note about
this in #15425.

In the mean time, if you remember from the top of your head how to add
a private method do the doc, and cares, go ahead!

> 2) You change the meaning of an existing function. Is there any way to check that it is currently well used in other places and should not be replaced by "self" where it is  used ?

Pre #16269, there was no coercion involved. So this is just reverting
back to the old behavior, isn't it?

> 3) Shouldn't this method be removed and the two lines
> {{{
>           elements = tuple(elements)
>           assert len(elements) == len(self._sets)
> }}}
> moved to `element_class`?

Yes, the two lines could possibly be moved down to the constructor of
element_class. However the method can't be removed. Its purpose is to
encapsulate how one can construct quickly an element of the cartesian
product from its components (which is different for naive cartesian
products and for cartesian product of modules), so that we can write
generic code on top of it (typically in the categories).

> I do not know where `element_class` is defined?


```
sage: C = Sets().CartesianProducts().example()
sage: C
The cartesian product of (Set of prime numbers (basic implementation), An example of an infinite enumerated set: the non negative integers, An example of a finite enumerated set: {1,2,3})
sage: C.element_class
<class 'sage.sets.cartesian_product.CartesianProduct_with_category.element_class'>
sage: C.element_class.__base__
<class 'sage.sets.cartesian_product.CartesianProduct.Element'>
```


Cheers,


---

Comment by ncohen created at 2014-05-05 10:16:01

Yoooooooo !

> Oh, right. Well from grepping around, it's referenced from
> `src/doc/en/reference/structure/index.rst`, so that's alright. Maybe `sage.sets` would deserve a
> document of its own at some point.

Hmmmmm... Probably. To be honest I always hated the "structure" folder, because for me "structure" means "data structure". By the way the index of the "structure" document could also be reorganized.

> That you ask the question raises another one: should this method be
> private in the first place? When I created it, I did not know how much
> I wanted it to be exposed, hence I started with a private method as
> it's easier to change this way than the other. I added a note about
> this in #15425.
> 
> In the mean time, if you remember from the top of your head how to add
> a private method do the doc, and cares, go ahead!

I think that I will if I can find its entry in the structure document !

> Pre #16269, there was no coercion involved. So this is just reverting
> back to the old behavior, isn't it?

True... God, I really can't remember which functions call which others... `element_class`, `_element_constructor_`, `self()`... How many ways to do (almost) the same thing ? `T_T`

> {{{
> sage: C = Sets().CartesianProducts().example()
> sage: C
> The cartesian product of (Set of prime numbers (basic implementation), An example of an infinite enumerated set: the non negative integers, An example of a finite enumerated set: {1,2,3})
> sage: C.element_class
> <class 'sage.sets.cartesian_product.CartesianProduct_with_category.element_class'>
> sage: C.element_class.__base__
> <class 'sage.sets.cartesian_product.CartesianProduct.Element'>
> }}}


```
~/sage/sets$ grep element_class cartesian_product.py 
        return self.element_class(self, x)
        return self.element_class(self, elements)
```


So I guess it must be in structure/ somewhere ?... Okay I give up, I'm tired of tracking definitions of functions.

Nathann


---

Comment by ncohen created at 2014-05-05 10:27:31

I just added a commit in public/16288 in order to see that function in the doc. By the way, almost all links of this doc page are broken and I do not know how to fix them.

If you know how then it would be cool to fix it, and otherwise I have nothing to add to this patch, it can go ! You can it to positive review according to what you do about these broken links.

Nathann


---

Comment by nthiery created at 2014-05-05 10:37:24

Replying to [comment:13 ncohen]:
> Hmmmmm... Probably. To be honest I always hated the "structure" folder, because for me "structure" means "data structure".

Which it is up to some point: it's also about basic data structures
for parents, elements, ...

> By the way the index of the "structure" document could also be reorganized.

+1

> > Pre #16269, there was no coercion involved. So this is just reverting
> > back to the old behavior, isn't it?
> 
> How many ways to do (almost) the same thing ? `T_T`

I know ...

> > {{{
> > sage: C.element_class
> > <class 'sage.sets.cartesian_product.CartesianProduct_with_category.element_class'>
> > sage: C.element_class.__base__
> > <class 'sage.sets.cartesian_product.CartesianProduct.Element'>
> > }}}
> 
> {{{
> ~/sage/sets$ grep element_class cartesian_product.py 
>         return self.element_class(self, x)
>         return self.element_class(self, elements)
> }}}
> 
> So I guess it must be in structure/ somewhere ?... Okay I give up, I'm tired of tracking definitions of functions.

As shown above, it is
`sage.sets.cartesian_product.CartesianProduct.Element`, with just the
abstract class from categories plugged in.

Which by the way it does not have an `__init__` of its own, so we
could not really move the `tuple/len` checks down there.

Cheers,
                            Nicolas


---

Comment by nthiery created at 2014-05-05 10:37:50

Replying to [comment:14 ncohen]:
> I just added a commit in public/16288 in order to see that function in the doc. By the way, almost all links of this doc page are broken and I do not know how to fix them.
> 
> If you know how then it would be cool to fix it, and otherwise I have nothing to add to this patch, it can go ! You can it to positive review according to what you do about these broken links.

Ok. I'll have a look after lunch.


---

Comment by ncohen created at 2014-05-05 10:41:16

> Which it is up to some point: it's also about basic data structures
> for parents, elements, ...

Hmmmm... Well, it would help if we moved misc/bitset* misc/binary_* in structure/ then.

> As shown above, it is
> `sage.sets.cartesian_product.CartesianProduct.Element`, with just the
> abstract class from categories plugged in.
> 
> Which by the way it does not have an `__init__` of its own, so we
> could not really move the `tuple/len` checks down there.

You lost me `:-P`

Nathann


---

Comment by git created at 2014-05-05 13:16:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nthiery created at 2014-05-05 13:20:32

Replying to [comment:16 nthiery]:
> Replying to [comment:14 ncohen]:
> > I just added a commit in public/16288 in order to see that function in the doc. By the way, almost all links of this doc page are broken and I do not know how to fix them.
> > 
> > If you know how then it would be cool to fix it, and otherwise I have nothing to add to this patch, it can go ! You can it to positive review according to what you do about these broken links.
> 
> Ok. I'll have a look after lunch.

I fixed one link. The other links like `Sets.CartesianProducts.ParentMethods._cartesian_product_of_elements` should start working once #9107 will be merged.

The doc could take some tidying, but that will be for later; enough conflicts with #10963! I'll just leave a note about this in #15425.

For me this is a positive review if you are fine with my last commit.


---

Comment by ncohen created at 2014-05-05 13:22:06

Okay okay, good to go then. Thanks !

Nathann


---

Comment by ncohen created at 2014-05-05 13:22:06

Changing status from needs_info to positive_review.


---

Comment by nthiery created at 2014-05-05 13:32:50

Thanks for the review!


---

Comment by nthiery created at 2014-05-05 13:37:56

Replying to [comment:17 ncohen]:
> Hmmmm... Well, it would help if we moved misc/bitset* misc/binary_* in structure/ then.

This would make sense indeed! And to start with add a ref from there.

> > As shown above, it is
> > `sage.sets.cartesian_product.CartesianProduct.Element`, with just the
> > abstract class from categories plugged in.
> > 
> > Which by the way it does not have an `__init__` of its own, so we
> > could not really move the `tuple/len` checks down there.
> 
> You lost me `:-P`

Sorry :-)

I meant: we thought about moving the convertion to tuple and length checks from `CartesianProduct._cartesian_product_of_elements` to the `__init__` method of the element class, that is `CartesianProduct.Element`. But this class does not have an `__init__` of its own; instead it just inherits that of its base `ElementWrapper`.

No big deal anyway.


---

Comment by vbraun created at 2014-05-06 18:03:41

Resolution: fixed
