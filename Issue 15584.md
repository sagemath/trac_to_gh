# Issue 15584: Change coercion to not use parent().an_element()

Issue created by migration from Trac.

Original creator: virmaux

Original creation time: 2014-02-14 19:03:42

Assignee: virmaux

CC:  simonking tscrim

See sage-devel discussion https://groups.google.com/forum/#!topic/sage-devel/gH8YQLmyRcs


---

Comment by SimonKing created at 2014-02-14 20:08:24

Could you please post code (namely a class definition of parents and elements), showcasing what the sage-devel discussion is about (namely `x in X` requiring that `x.parent()` and/or `X` implement `_an_element_()`)?


---

Comment by virmaux created at 2014-02-14 20:34:19

Here is the typical case:

sage: W = Words(4)
sage: W([1,2,3,4]) in ZZ
---------------------------------------------------------------------------
 NotImplementedError                       Traceback (most recent call last)
<ipython-input-2-8d7b846244dc> in <module>()
[...]
 NotImplementedError: please implement _an_element_ for Words over {1, 2, 3, 4}


---

Comment by SimonKing created at 2014-02-14 20:54:40

The error traceback points to this code in `sage.structure.parent.Parent._generic_convert_map`:

```python
   cpdef _generic_convert_map(self, S):
        import coerce_maps
        if self._convert_method_name is not None:
            # handle methods like _integer_
            if PY_TYPE_CHECK(S, type):
                element_constructor = S
            elif PY_TYPE_CHECK(S, Parent):
                element_constructor = (<Parent>S)._element_constructor
                if not PY_TYPE_CHECK(element_constructor, type):
                    # if element_constructor is not an actual class, get the element class
                    element_constructor = type(S.an_element())
            else:
                element_constructor = None
            if element_constructor is not None and hasattr(element_constructor, self._convert_method_name):
                return coerce_maps.NamedConvertMap(S, self, self._convert_method_name)
...
```

So, this old code expects that `self._element_constructor` is a type, or otherwise it tries to determine the type of an element.

Today, `_element_constructor_` rather than `_element_constructor` is used, but it is not a type (it is a method).

And looking further down into the code, we find that the element constructor actually is not really used: All what we do with it is to ask

```
hasattr(element_constructor, self._convert_method_name)
```


The point is: `self._convert_method_name` is None in our case! But if there is no `_convert_method_name` then we really don't need the element constructor (as a type) in the code.

Hence, my first guess is that we should first test whether `self._convert_method_name` is None, and immediately skip that code block if it is.


---

Comment by SimonKing created at 2014-02-14 20:55:42

Blimy, it already *is* tested whether self._convert_method_name is None!

So, why is this code executed???


---

Comment by SimonKing created at 2014-02-14 20:58:07

Me stupid: The _convert_method_name of the codomain is requested, which is not None for ZZ.

So, forget what I suggested above.


---

Comment by SimonKing created at 2015-07-23 14:55:38

Meanwhile we have

```
sage: W = Words(4)
sage: W([1,2,3,4]) in ZZ
False
```


So, can this be closed? Actually I think I authored another ticket that used a given element when considering coercions, so that `an_element()` is only called when no element is provided. I can't find the ticket, though.


---

Comment by SimonKing created at 2015-07-23 14:55:38

Changing status from new to needs_review.


---

Comment by virmaux created at 2015-07-24 17:16:32

Hello Simon,

indeed the bug seems to be fixed. Do I just need to "review" the empty ticket in order to close it ?

Aladin


---

Comment by SimonKing created at 2015-07-24 18:53:53

Replying to [comment:9 virmaux]:
> indeed the bug seems to be fixed. Do I just need to "review" the empty ticket in order to close it ?

Done.

You can not close a ticket, since you are not release manager. But each ticket needs a positive review before the release manager will close it---even if the ticket is "empty" and the milestone is "duplicate/invalid/wontfix".


---

Comment by SimonKing created at 2015-07-24 18:53:53

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-07-26 12:41:15

Resolution: fixed
