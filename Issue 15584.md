# Issue 15584: Change coercion to not use parent().an_element()

archive/issues_015584.json:
```json
{
    "body": "Assignee: @avirmaux\n\nCC:  simonking @tscrim\n\nSee sage-devel discussion https://groups.google.com/forum/#!topic/sage-devel/gH8YQLmyRcs\n\nIssue created by migration from https://trac.sagemath.org/ticket/15821\n\n",
    "created_at": "2014-02-14T19:03:42Z",
    "labels": [
        "coercion",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Change coercion to not use parent().an_element()",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15584",
    "user": "@avirmaux"
}
```
Assignee: @avirmaux

CC:  simonking @tscrim

See sage-devel discussion https://groups.google.com/forum/#!topic/sage-devel/gH8YQLmyRcs

Issue created by migration from https://trac.sagemath.org/ticket/15821





---

archive/issue_comments_201822.json:
```json
{
    "body": "Could you please post code (namely a class definition of parents and elements), showcasing what the sage-devel discussion is about (namely `x in X` requiring that `x.parent()` and/or `X` implement `_an_element_()`)?",
    "created_at": "2014-02-14T20:08:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15584",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15584#issuecomment-201822",
    "user": "@simon-king-jena"
}
```

Could you please post code (namely a class definition of parents and elements), showcasing what the sage-devel discussion is about (namely `x in X` requiring that `x.parent()` and/or `X` implement `_an_element_()`)?



---

archive/issue_comments_201823.json:
```json
{
    "body": "Here is the typical case:\n\nsage: W = Words(4)\nsage: W([1,2,3,4]) in ZZ\n---------------------------------------------------------------------------\n NotImplementedError                       Traceback (most recent call last)\n<ipython-input-2-8d7b846244dc> in <module>()\n[...]\n NotImplementedError: please implement _an_element_ for Words over {1, 2, 3, 4}",
    "created_at": "2014-02-14T20:34:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15584",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15584#issuecomment-201823",
    "user": "@avirmaux"
}
```

Here is the typical case:

sage: W = Words(4)
sage: W([1,2,3,4]) in ZZ
---------------------------------------------------------------------------
 NotImplementedError                       Traceback (most recent call last)
<ipython-input-2-8d7b846244dc> in <module>()
[...]
 NotImplementedError: please implement _an_element_ for Words over {1, 2, 3, 4}



---

archive/issue_comments_201824.json:
```json
{
    "body": "The error traceback points to this code in `sage.structure.parent.Parent._generic_convert_map`:\n\n```python\n   cpdef _generic_convert_map(self, S):\n        import coerce_maps\n        if self._convert_method_name is not None:\n            # handle methods like _integer_\n            if PY_TYPE_CHECK(S, type):\n                element_constructor = S\n            elif PY_TYPE_CHECK(S, Parent):\n                element_constructor = (<Parent>S)._element_constructor\n                if not PY_TYPE_CHECK(element_constructor, type):\n                    # if element_constructor is not an actual class, get the element class\n                    element_constructor = type(S.an_element())\n            else:\n                element_constructor = None\n            if element_constructor is not None and hasattr(element_constructor, self._convert_method_name):\n                return coerce_maps.NamedConvertMap(S, self, self._convert_method_name)\n...\n```\n\nSo, this old code expects that `self._element_constructor` is a type, or otherwise it tries to determine the type of an element.\n\nToday, `_element_constructor_` rather than `_element_constructor` is used, but it is not a type (it is a method).\n\nAnd looking further down into the code, we find that the element constructor actually is not really used: All what we do with it is to ask\n\n```\nhasattr(element_constructor, self._convert_method_name)\n```\n\n\nThe point is: `self._convert_method_name` is None in our case! But if there is no `_convert_method_name` then we really don't need the element constructor (as a type) in the code.\n\nHence, my first guess is that we should first test whether `self._convert_method_name` is None, and immediately skip that code block if it is.",
    "created_at": "2014-02-14T20:54:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15584",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15584#issuecomment-201824",
    "user": "@simon-king-jena"
}
```

The error traceback points to this code in `sage.structure.parent.Parent._generic_convert_map`:

```python
   cpdef _generic_convert_map(self, S):
        import coerce_maps
        if self._convert_method_name is not None:
            # handle methods like _integer_
            if PY_TYPE_CHECK(S, type):
                element_constructor = S
            elif PY_TYPE_CHECK(S, Parent):
                element_constructor = (<Parent>S)._element_constructor
                if not PY_TYPE_CHECK(element_constructor, type):
                    # if element_constructor is not an actual class, get the element class
                    element_constructor = type(S.an_element())
            else:
                element_constructor = None
            if element_constructor is not None and hasattr(element_constructor, self._convert_method_name):
                return coerce_maps.NamedConvertMap(S, self, self._convert_method_name)
...
```

So, this old code expects that `self._element_constructor` is a type, or otherwise it tries to determine the type of an element.

Today, `_element_constructor_` rather than `_element_constructor` is used, but it is not a type (it is a method).

And looking further down into the code, we find that the element constructor actually is not really used: All what we do with it is to ask

```
hasattr(element_constructor, self._convert_method_name)
```


The point is: `self._convert_method_name` is None in our case! But if there is no `_convert_method_name` then we really don't need the element constructor (as a type) in the code.

Hence, my first guess is that we should first test whether `self._convert_method_name` is None, and immediately skip that code block if it is.



---

archive/issue_comments_201825.json:
```json
{
    "body": "Blimy, it already **is** tested whether self._convert_method_name is None!\n\nSo, why is this code executed???",
    "created_at": "2014-02-14T20:55:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15584",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15584#issuecomment-201825",
    "user": "@simon-king-jena"
}
```

Blimy, it already **is** tested whether self._convert_method_name is None!

So, why is this code executed???



---

archive/issue_comments_201826.json:
```json
{
    "body": "Me stupid: The _convert_method_name of the codomain is requested, which is not None for ZZ.\n\nSo, forget what I suggested above.",
    "created_at": "2014-02-14T20:58:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15584",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15584#issuecomment-201826",
    "user": "@simon-king-jena"
}
```

Me stupid: The _convert_method_name of the codomain is requested, which is not None for ZZ.

So, forget what I suggested above.



---

archive/issue_comments_201827.json:
```json
{
    "body": "Meanwhile we have\n\n```\nsage: W = Words(4)\nsage: W([1,2,3,4]) in ZZ\nFalse\n```\n\n\nSo, can this be closed? Actually I think I authored another ticket that used a given element when considering coercions, so that `an_element()` is only called when no element is provided. I can't find the ticket, though.",
    "created_at": "2015-07-23T14:55:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15584",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15584#issuecomment-201827",
    "user": "@simon-king-jena"
}
```

Meanwhile we have

```
sage: W = Words(4)
sage: W([1,2,3,4]) in ZZ
False
```


So, can this be closed? Actually I think I authored another ticket that used a given element when considering coercions, so that `an_element()` is only called when no element is provided. I can't find the ticket, though.



---

archive/issue_comments_201828.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-07-23T14:55:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15584",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15584#issuecomment-201828",
    "user": "@simon-king-jena"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_201829.json:
```json
{
    "body": "Hello Simon,\n\nindeed the bug seems to be fixed. Do I just need to \"review\" the empty ticket in order to close it ?\n\nAladin",
    "created_at": "2015-07-24T17:16:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15584",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15584#issuecomment-201829",
    "user": "@avirmaux"
}
```

Hello Simon,

indeed the bug seems to be fixed. Do I just need to "review" the empty ticket in order to close it ?

Aladin



---

archive/issue_comments_201830.json:
```json
{
    "body": "Replying to [comment:9 virmaux]:\n> indeed the bug seems to be fixed. Do I just need to \"review\" the empty ticket in order to close it ?\n\nDone.\n\nYou can not close a ticket, since you are not release manager. But each ticket needs a positive review before the release manager will close it---even if the ticket is \"empty\" and the milestone is \"duplicate/invalid/wontfix\".",
    "created_at": "2015-07-24T18:53:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15584",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15584#issuecomment-201830",
    "user": "@simon-king-jena"
}
```

Replying to [comment:9 virmaux]:
> indeed the bug seems to be fixed. Do I just need to "review" the empty ticket in order to close it ?

Done.

You can not close a ticket, since you are not release manager. But each ticket needs a positive review before the release manager will close it---even if the ticket is "empty" and the milestone is "duplicate/invalid/wontfix".



---

archive/issue_comments_201831.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-07-24T18:53:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15584",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15584#issuecomment-201831",
    "user": "@simon-king-jena"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_201832.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-07-26T12:41:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15584",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15584#issuecomment-201832",
    "user": "@vbraun"
}
```

Resolution: fixed
