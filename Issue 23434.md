# Issue 23434: hypergeometric motives

Issue created by migration from Trac.

Original creator: chapoton

Original creation time: 2017-08-22 08:16:18

CC:  kedlaya jvoight tornaria

For the moment, a first sketch.

The computation of traces of Frobenius is still buggy. Expert opinion and advices are welcome.


---

Comment by chapoton created at 2017-08-22 08:17:11

New commits:


---

Comment by chapoton created at 2017-08-22 08:17:11

Changing status from new to needs_info.


---

Comment by git created at 2017-08-22 08:25:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-08-23 18:54:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-08-23 18:56:43

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-08-23 19:00:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cremona created at 2017-08-23 19:38:00

I'm alerting the LMFDB people who work on hypergeometric motives to the existence of this code.


---

Comment by chapoton created at 2017-08-23 19:49:15

Thanks. Maybe they can help me to fix the lurking bug.


---

Comment by git created at 2017-08-23 19:56:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-08-24 07:45:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-08-24 07:56:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-08-24 09:03:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-08-24 09:38:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-08-24 09:51:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-08-24 10:25:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-08-24 10:33:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2017-08-24 15:19:25

Is `Hyp` a temporary name? Magma's analogue is `HypergeometricData`, which would be reasonable to use here also.


---

Comment by chapoton created at 2017-08-24 15:21:00

yes, indeed. But as long as the `euler_factor` method is not working correctly, all this has little value..


---

Comment by kedlaya created at 2017-08-24 15:38:48

Is this a correct illustration of the issue with Gauss sums?

```
sage: H = Hyp(gamma_list=[-6,-1,4,3])
sage: t = 189/125
sage: H.H_value(19,1,t)
0
sage: H.padic_H_value(19,1,t) # should give the same answer?
-3
```



---

Comment by chapoton created at 2017-08-24 15:40:48

Yes, this is typical. Either our p-adic Gauss sum has a problem, or my code has a problem. I wrote very parallel code for H_value and padic_H_value, but this does not prove that they are both correct. The H_value method seems to be working rather well, compared to the literature.


---

Comment by kedlaya created at 2017-08-24 19:57:58

I don't see any problem with the p-adic Gauss sums. Here is a test:

```
sage: def f(z,p):
....:    return z - (z^p-1)/(p*z^(p-1))

sage: from sage.arith.misc import gauss_sum
sage: from sage.rings.padics.misc import gauss_sum as padic_gauss_sum

sage: p = 19
sage: R = padic_gauss_sum(1, p, 1, 10).parent()
sage: z = 1 - R.gen()
sage: for i in range(10): z = f(z,p)
sage: z *= R.teichmuller(GF(p).multiplicative_generator())
sage: S.<a> = CyclotomicField(p*(p-1))

sage: for i in range(p-1):
....:    t = gauss_sum(S.zeta(p-1)^i, GF(p)).polynomial()(z)
....:    u = padic_gauss_sum(-i, p, 1, 10)
....:    print (t - u).is_zero()
```

returns all `True`.

I'm guessing the issue is the normalization of the comparison between abstract and p-adic roots of unity, which is critical to the Gauss-Koblitz formula. I haven't traced this fully, but it looks like in the lines:

```
                    prod(padic_gauss_sum(-xp * r, p, f, prec)
                         for xp in gamma_pos) /
                    prod(padic_gauss_sum(-xq * r, p, f, prec)
                         for xq in gamma_neg) *
```

if one changes `-xp * r` to `xp * r` and `-xq * r` to `xq * r`, then the most egregious doctest failures in `euler_factor` go away. (There remain cases where there is an unresolved sign ambiguity, which I need to stare at some more.)


---

Comment by kedlaya created at 2017-08-24 20:09:57

Regarding the sign ambiguity: according to the Magma documentation, they are using the local functional equation to expedite the computation. That suggests that they have a formula for the sign of the functional equation, but I'm not sure where that is writen down.

In other news, I think the statement of the Gross-Koblitz formula in the docstring of the p-adic Gauss sum is missing an overall minus sign, which is in Robert's paper and also in the code.


---

Comment by kedlaya created at 2017-08-24 21:35:28

Replying to [comment:22 kedlaya]:
> Regarding the sign ambiguity: according to the Magma documentation, they are using the local functional equation to expedite the computation. That suggests that they have a formula for the sign of the functional equation, but I'm not sure where that is writen down.
> 
According to Mark Watkins, Magma uses the formulas given in 11.1.1 of http://magma.maths.usyd.edu.au/~watkins/papers/known.pdf for the sign of the local functional equation at good primes. (This is for even weight; for odd weight the sign is always +1.)


---

Comment by chapoton created at 2017-08-25 05:41:35

Great ! Thank you for investigating. I will now correct that.


---

Comment by git created at 2017-08-25 05:56:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-08-25 05:59:08

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2017-08-25 06:01:12

Humm, it seems that this does not fix all the doctests of `padic_H_value`. Some of the doctests for (p,2,t) for the first HGM example are still wrong (by a factor of p).


---

Comment by git created at 2017-08-25 06:02:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-08-25 15:17:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2017-08-25 22:29:57

Suggestion: rather than defining `Hyp` as as alias for `HypergeometricMotive`, it might be safer to just change `import Hyp` to `import HypergeometricMotive as Hyp` in the doctests. (The abbreviation `Hyp` could be misinterpreted in various ways, so I'm not sold on the wisdom of putting it into the global namespace.)


---

Comment by chapoton created at 2017-08-26 06:13:22

yes, for sure. But much more importantly we need to (1) fix the computation of padic_H_value and (2) resolve the ambiguity of Euler factors. I have no idea for (1) and plan to work on (2).

EDIT: And so far, nothing is added to the global namespace..


---

Comment by git created at 2017-08-26 06:31:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-08-26 10:28:18

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-08-26 20:08:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2017-08-26 20:42:09

I am going to take a look at the Magma code sometime soon to see if it sheds some light on the remaining doctest failures...


---

Comment by git created at 2017-08-27 07:22:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-08-27 07:43:45

My only reference for the formula used in `padic_H_value` is page 4 of http://magma.maths.usyd.edu.au/~watkins/papers/HGM-chapter.pdf


---

Comment by git created at 2017-08-27 08:28:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-08-27 08:37:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-08-27 09:36:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2017-08-27 14:58:35

In `padic_H_value`, you might want to change 

```
        p_ring = Zp(p)
```

to

```
        p_ring = Zp(p,prec=prec)
```

as otherwise the value of prec doesn't really make a difference in the internal computation. (This shouldn't matter to any of the current doctests, though.)


---

Comment by git created at 2017-08-27 18:04:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2017-08-28 02:03:11

I think I found the remaining issue with `padic_H_value`. The problem is actually in `convert_to_Z`:

```
    p_ring = x.parent().base_ring()
    p = p_ring.prime()
    L = x.list()
    print(p_ring, p, L)
    return ZZ.sum(L[(p - 1) * i] * (-p) ** i
                  for i in range(1 + len(L) // (p - 1)))
```

The trouble is that `x.list()` behaves differently for an element of a p-adic ring (in which case it starts from 0) and an element of a p-adic field (in which case it starts from the valuation).

There are various ways to fix this. One would be to replace `L = x.list()` with:

```
    # Pass from field to ring so that list() starts from p^0.
    y = x.parent().integer_ring()(x)
    L = y.list()
```

to force the ring behavior.


---

Comment by kedlaya created at 2017-08-28 02:06:54

In other news, there are some mathematical errors in the docstring for the p-adic Gauss sum. Maybe we should go ahead and fix them on this ticket:

```
    Let `p` be a prime, `f` a positive integer, `q=p^f`, and `\pi` be
    the unique root of `f(x) = x^{p-1}+p` congruent to `\zeta_p-1` modulo
    `(\zeta_p-1)^2`. Let `0\leq a < q-1`. Then the Gross-Koblitz formula 
    gives us the value of the Gauss sum `g_q(a)` as a product of p-adic 
    Gamma functions as follows:

    .. MATH::

        g_q(a) = -\pi^s \prod_{0\leq i < f} \Gamma_p(a^{(i)}/(q-1)),

    where `s` is the sum of the digits of `a` in base `p` and the
    `a^{(i)}` have `p`-adic expansions obtained from cyclic
    permutations of that of `a`.
```



---

Comment by git created at 2017-08-28 07:48:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-08-28 09:59:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-08-28 12:54:02

Great ! Thanks a lot for finding that ! Now we can at last compute Euler factors for good primes. All tests pass.

Then we have 2 options. Trying to get his in sage in its present state, and enhance later. Or trying to go further before put this inside sage. I am not really planning to spend a lot more time on that, so I would prefer the first option.

Replying to [comment:43 kedlaya]:
> I think I found the remaining issue with `padic_H_value`. The problem is actually in `convert_to_Z`:
> {{{
>     p_ring = x.parent().base_ring()
>     p = p_ring.prime()
>     L = x.list()
>     print(p_ring, p, L)
>     return ZZ.sum(L[(p - 1) * i] * (-p) ** i
>                   for i in range(1 + len(L) // (p - 1)))
> }}}
> The trouble is that `x.list()` behaves differently for an element of a p-adic ring (in which case it starts from 0) and an element of a p-adic field (in which case it starts from the valuation).
> 
> There are various ways to fix this. One would be to replace `L = x.list()` with:
> {{{
>     # Pass from field to ring so that list() starts from p^0.
>     y = x.parent().integer_ring()(x)
>     L = y.list()
> }}}
> to force the ring behavior.


---

Comment by kedlaya created at 2017-08-28 14:52:15

Definitely get this feature set into Sage first, then create separate tickets for additional features (like the Euler factors at bad reduction primes). This progress might serve as the basis for organizing a Sage Days on HGM sooner or later.

As soon as this is ready to go to `needs_review` I will start looking more critically (particularly at the documentation, which so far I have mostly ignored).


---

Comment by git created at 2017-08-30 14:51:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-08-30 14:57:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2017-09-04 16:35:27

Replying to [comment:44 kedlaya]:
> In other news, there are some mathematical errors in the docstring for the p-adic Gauss sum. Maybe we should go ahead and fix them on this ticket:

That change has been made on #23780. The primary purpose of that ticket is to modify the p-adic Gauss sum computation to allow the caller to avoid instantiating the ramified extension of Q_p. With that, one can modify `padic_H_value` to also avoid constructing the ramified extension, which in principle saves a factor of `p` in complexity.


---

Comment by kedlaya created at 2017-09-05 16:05:01

Changing keywords from "" to "hypergeometric motives, Euler factors".


---

Comment by kedlaya created at 2017-09-05 16:05:01

This commit implements my suggestion to do the computation entirely in Z_p by using the Gauss-Koblitz formula in factored form. Even saving a factor of p, it still seems to be much slower than Magma; not sure whether there is a single reason for that.
----
Last 10 new commits:


---

Comment by kedlaya created at 2017-09-06 13:45:32

Fernando Rodriguez Villegas points out that Magma has built in a "wrong" (i.e., not consistent with standard references in the literature) sign convention, with the effect that the parameter values t and 1/t should be swapped. It's probably too late for Magma to change this, but it's not too late for Sage...


---

Comment by git created at 2017-09-06 17:20:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-09-07 15:12:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2017-09-07 15:13:46

I changed the class name from `HypergeometricMotive` to `HypergeometricData` to match Magma. This is also conceptually better: this class represents a collection of combinatorial data corresponding to not a single motive, but a one-parameter family of motives indexed by `t`.


---

Comment by chapoton created at 2017-09-07 15:17:58

Just to say that I agree with the name change. We could also have another class for objects where t has been chosen.

And I also agree with the switch t <-> 1/t.

Thanks for working on all that !


---

Comment by git created at 2017-09-07 19:04:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2017-09-07 19:12:14

I implemented the explicit formula for the sign of the functional equation which I learned from Mark Watkins; this means that for degree `d`, no more than `d//2` traces are ever needed. (In particular, for `d` odd this always saves one trace over the old method.)

In order to confirm that I did this correctly, I put in some more doctests. In particular, the doctests for `euler_factor` cover all three cases of the functional equation (odd weight; even weight and odd degree; even weight and even degree).

I agree that later, we may want to add a class `HypergeometricMotive` which includes the choice of `t`, and which would have the L-series as an attribute. Magma has a class for L-series themselves, which has attributes like checking the functional equation and computing special values. However, that is an issue for a later ticket (as is adding the Euler factors for tame and wild primes).

This is actually looking pretty good now, to the extent that I'm planning to do a demonstration of this in a talk I'm giving at ICTP (Trieste) tomorrow (which was my motivation for making all these changes at this particular moment). Is it time for a review?


---

Comment by kedlaya created at 2017-09-08 11:37:26

To answer my own question: no, this is not yet ready for review because I can still produce cases where it fails to agree with Magma (with some help from David Roberts). I'm guessing this has to do with the handling of the values 0 and 1 in the parameter lists; let me see if I can track it down.


---

Comment by git created at 2017-09-08 14:29:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-09-08 14:35:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2017-09-08 14:37:33

The formulas transcribed by Watkins apparently presume that 0 does not occur in `alpha`. Since `alpha` and `beta` must be disjoint, this case is most easily handled as Magma does it, by swapping `alpha` with `beta` and `t` with `1/t`.

This resolves the issue I raised at comment 62, so now I am back to wondering whether this is ready for review.


---

Comment by tornaria created at 2017-09-10 12:03:01

There are some errors in the documentation that have already been fixed in #23780.

Can you rebase this on top of it?


---

Comment by git created at 2017-09-10 19:43:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-09-11 15:13:20

I have made a cosmetic cleanup of the code, to conform to the pep8 standard.

Maybe we whould still add more documentation everywhere ?
----
New commits:


---

Comment by git created at 2017-09-13 12:31:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-09-13 12:34:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-09-14 22:29:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-09-18 12:45:18

I fixed the wrong syntax in the new raise statement (it was not py3 compatible).
----
New commits:


---

Comment by kedlaya created at 2017-09-23 00:47:43

Are we ready for review at this point?


---

Comment by chapoton created at 2017-09-23 19:45:07

I have some small concerns :

1) we should move the references to the master-reference-file,

2) I would prefer to have more explanations in the doc everywhere.

But I think it can be set to "needs_review" once 1) is done.

I am going to do 1) right now.


---

Comment by git created at 2017-09-23 20:00:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2017-09-26 04:01:41

Changing keywords from "hypergeometric motives, Euler factors" to "hypergeometric motives, Euler factors, sd91".


---

Comment by kedlaya created at 2017-09-26 21:38:35

While more documentation would be nice, there is overall a big lack of documentation in this whole area of mathematics; anyway I would propose to get some reviewer feedback on that front.

I don't see any causal doctest failures in the patchbot logs.


---

Comment by kedlaya created at 2017-09-26 21:38:35

Changing status from needs_info to needs_review.


---

Comment by git created at 2017-09-28 08:32:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2017-10-01 05:21:17

Positive review if you're happy with my reviewer patch.
----
New commits:


---

Comment by chapoton created at 2017-10-01 10:08:11

It seems that you introduced a TAB somewhere.

Otherwise, I agree with the changes.


---

Comment by chapoton created at 2017-10-01 10:42:50

I removed the tab
----
New commits:


---

Comment by roed created at 2017-10-01 14:42:58

Oops.  I guess my emacs doesn't kill tabs in `.rst` files.


---

Comment by roed created at 2017-10-01 14:42:58

Changing status from needs_review to positive_review.


---

Comment by kedlaya created at 2017-10-01 16:37:43

roed just added a ``@`cached_method` decorator to `padic_H_value`, `H_value`, and `euler_factor`.

I just went over roed's changes (most of which he made while sitting next to me) and they all look fine to me.
----
New commits:


---

Comment by chapoton created at 2017-10-02 09:03:55

You re-introduced the TAB, please take care of it yourself


---

Comment by chapoton created at 2017-10-02 09:04:22

Changing status from positive_review to needs_work.


---

Comment by chapoton created at 2017-10-02 12:14:47

ok.. I have removed the TAB again..
----
New commits:


---

Comment by chapoton created at 2017-10-02 12:14:47

Changing status from needs_work to positive_review.


---

Comment by git created at 2017-10-02 16:09:36

Changing status from positive_review to needs_review.


---

Comment by git created at 2017-10-02 16:09:36

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:


---

Comment by chapoton created at 2017-10-02 16:10:59

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-10-03 18:44:52

Merge conflict...


---

Comment by vbraun created at 2017-10-03 18:44:52

Changing status from positive_review to needs_work.


---

Comment by git created at 2017-10-03 19:07:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-10-03 19:08:47

trivial rebase done (damn main reference file, I have not ordered that)


---

Comment by chapoton created at 2017-10-03 19:08:47

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2017-10-04 21:17:15

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2017-10-04 21:17:15

PDF docs don't build


---

Comment by git created at 2017-10-05 07:05:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2017-10-06 22:38:25

Is there more to be done on the pdf docs, or should this be set back to positive review?


---

Comment by chapoton created at 2017-10-07 07:53:59

Well, somebody needs to check that it works, and I have not got time yet to do that.


---

Comment by chapoton created at 2017-10-07 14:02:23

Changing status from needs_work to positive_review.


---

Comment by chapoton created at 2017-10-07 14:02:23

pdf ok


---

Comment by vbraun created at 2017-10-16 22:44:44

Resolution: fixed
