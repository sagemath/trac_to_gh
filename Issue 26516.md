# Issue 26516: Incremental docker build fails when removing SPKGs

Issue created by migration from https://trac.sagemath.org/ticket/26753

Original creator: saraedum

Original creation time: 2018-11-23 23:46:45

CC:  embray

Keywords: docker, CI

The incremental build seems to fail (on its second run) when an SPKG is removed.

https://trac.sagemath.org/ticket/26732#comment:6


---

Comment by saraedum created at 2018-11-23 23:48:16

It could be that our patching of the incremental images does not handle deletions correctly.

Or maybe it's just a general bug in incremental builds and nothing specific about the docker setup.


---

Comment by embray created at 2018-11-26 09:46:23

Replying to [comment:1 saraedum]:
> It could be that our patching of the incremental images does not handle deletions correctly.
> 
> Or maybe it's just a general bug in incremental builds and nothing specific about the docker setup.

Perhaps a little of both.  In general there should be no problem with removing packages in incremental builds.  But there might also still be some bugs in the uninstall system, and perhaps it only impacts the docker image builds even if it is in some way a more generic bug.


---

Comment by embray created at 2018-11-26 09:51:26

The code causing this particular error is from `m4/sage_spkg_collect.m4`:


```
for DIR in $SAGE_ROOT/build/pkgs/*; do
    test -d "$DIR" || continue

    PKG_TYPE_FILE="$DIR/type"
    if test -f "$PKG_TYPE_FILE"; then
        PKG_TYPE=`cat $PKG_TYPE_FILE`
    else
        AC_MSG_ERROR(["$PKG_TYPE_FILE" is missing.])
    fi
```


I think this code could be made more robust.  I don't think there's a reason to return an error if a directory under `build/pkgs/*` does not actually contain an SPKG.  It should probably check a few other things to determine if a directory is an SPKG, and at worst issue a warning.  Maybe only error here if for all intents and purposes it still looks like an SPKG but is missing some required file.

On the Docker build end of things the issue probably has something to do with empty directories not being deleted properly.


---

Comment by embray created at 2018-11-26 09:53:35

I think maybe what I'll do fornow is require there to be an `SPKG.txt`, at a minimum, for the directory to be considered an SPKG, and ignore any directory that doesn't have it.

I would still like to redo the proliferation of file that make up an "SPKG" but that's something I can tackle another time.


---

Comment by saraedum created at 2020-01-21 16:04:30

Changing keywords from "docker, CI" to "docker, ContinuousIntegration".


---

Comment by saraedum created at 2020-02-06 22:39:02

Some of the packages actually do not have an SPKG.txt (python3 e.g.)

So let's test for `type`.


---

Comment by saraedum created at 2020-02-06 22:45:57

New commits:


---

Comment by saraedum created at 2020-02-06 22:45:57

Changing component from PLEASE CHANGE to build: configure.


---

Comment by saraedum created at 2020-02-06 22:45:57

Changing status from new to needs_review.


---

Comment by dimpase created at 2021-10-19 15:01:28

is this outdated?
