# Issue 26516: Incremental docker build fails when removing SPKGs

archive/issues_026516.json:
```json
{
    "body": "CC:  @embray\n\nKeywords: docker, CI\n\nThe incremental build seems to fail (on its second run) when an SPKG is removed.\n\nhttps://trac.sagemath.org/ticket/26732#comment:6\n\nIssue created by migration from https://trac.sagemath.org/ticket/26753\n\n",
    "created_at": "2018-11-23T23:46:45Z",
    "labels": [
        "component: please change",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.5",
    "title": "Incremental docker build fails when removing SPKGs",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26516",
    "user": "https://github.com/saraedum"
}
```
CC:  @embray

Keywords: docker, CI

The incremental build seems to fail (on its second run) when an SPKG is removed.

https://trac.sagemath.org/ticket/26732#comment:6

Issue created by migration from https://trac.sagemath.org/ticket/26753





---

archive/issue_comments_372462.json:
```json
{
    "body": "It could be that our patching of the incremental images does not handle deletions correctly.\n\nOr maybe it's just a general bug in incremental builds and nothing specific about the docker setup.",
    "created_at": "2018-11-23T23:48:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26516",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26516#issuecomment-372462",
    "user": "https://github.com/saraedum"
}
```

It could be that our patching of the incremental images does not handle deletions correctly.

Or maybe it's just a general bug in incremental builds and nothing specific about the docker setup.



---

archive/issue_comments_372463.json:
```json
{
    "body": "Replying to [comment:1 saraedum]:\n> It could be that our patching of the incremental images does not handle deletions correctly.\n> \n> Or maybe it's just a general bug in incremental builds and nothing specific about the docker setup.\n\nPerhaps a little of both.  In general there should be no problem with removing packages in incremental builds.  But there might also still be some bugs in the uninstall system, and perhaps it only impacts the docker image builds even if it is in some way a more generic bug.",
    "created_at": "2018-11-26T09:46:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26516",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26516#issuecomment-372463",
    "user": "https://github.com/embray"
}
```

Replying to [comment:1 saraedum]:
> It could be that our patching of the incremental images does not handle deletions correctly.
> 
> Or maybe it's just a general bug in incremental builds and nothing specific about the docker setup.

Perhaps a little of both.  In general there should be no problem with removing packages in incremental builds.  But there might also still be some bugs in the uninstall system, and perhaps it only impacts the docker image builds even if it is in some way a more generic bug.



---

archive/issue_comments_372464.json:
```json
{
    "body": "The code causing this particular error is from `m4/sage_spkg_collect.m4`:\n\n\n```\nfor DIR in $SAGE_ROOT/build/pkgs/*; do\n    test -d \"$DIR\" || continue\n\n    PKG_TYPE_FILE=\"$DIR/type\"\n    if test -f \"$PKG_TYPE_FILE\"; then\n        PKG_TYPE=`cat $PKG_TYPE_FILE`\n    else\n        AC_MSG_ERROR([\"$PKG_TYPE_FILE\" is missing.])\n    fi\n```\n\n\nI think this code could be made more robust.  I don't think there's a reason to return an error if a directory under `build/pkgs/*` does not actually contain an SPKG.  It should probably check a few other things to determine if a directory is an SPKG, and at worst issue a warning.  Maybe only error here if for all intents and purposes it still looks like an SPKG but is missing some required file.\n\nOn the Docker build end of things the issue probably has something to do with empty directories not being deleted properly.",
    "created_at": "2018-11-26T09:51:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26516",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26516#issuecomment-372464",
    "user": "https://github.com/embray"
}
```

The code causing this particular error is from `m4/sage_spkg_collect.m4`:


```
for DIR in $SAGE_ROOT/build/pkgs/*; do
    test -d "$DIR" || continue

    PKG_TYPE_FILE="$DIR/type"
    if test -f "$PKG_TYPE_FILE"; then
        PKG_TYPE=`cat $PKG_TYPE_FILE`
    else
        AC_MSG_ERROR(["$PKG_TYPE_FILE" is missing.])
    fi
```


I think this code could be made more robust.  I don't think there's a reason to return an error if a directory under `build/pkgs/*` does not actually contain an SPKG.  It should probably check a few other things to determine if a directory is an SPKG, and at worst issue a warning.  Maybe only error here if for all intents and purposes it still looks like an SPKG but is missing some required file.

On the Docker build end of things the issue probably has something to do with empty directories not being deleted properly.



---

archive/issue_comments_372465.json:
```json
{
    "body": "I think maybe what I'll do fornow is require there to be an `SPKG.txt`, at a minimum, for the directory to be considered an SPKG, and ignore any directory that doesn't have it.\n\nI would still like to redo the proliferation of file that make up an \"SPKG\" but that's something I can tackle another time.",
    "created_at": "2018-11-26T09:53:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26516",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26516#issuecomment-372465",
    "user": "https://github.com/embray"
}
```

I think maybe what I'll do fornow is require there to be an `SPKG.txt`, at a minimum, for the directory to be considered an SPKG, and ignore any directory that doesn't have it.

I would still like to redo the proliferation of file that make up an "SPKG" but that's something I can tackle another time.



---

archive/issue_comments_372466.json:
```json
{
    "body": "Changing keywords from \"docker, CI\" to \"docker, ContinuousIntegration\".",
    "created_at": "2020-01-21T16:04:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26516",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26516#issuecomment-372466",
    "user": "https://github.com/saraedum"
}
```

Changing keywords from "docker, CI" to "docker, ContinuousIntegration".



---

archive/issue_comments_372467.json:
```json
{
    "body": "Some of the packages actually do not have an SPKG.txt (python3 e.g.)\n\nSo let's test for `type`.",
    "created_at": "2020-02-06T22:39:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26516",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26516#issuecomment-372467",
    "user": "https://github.com/saraedum"
}
```

Some of the packages actually do not have an SPKG.txt (python3 e.g.)

So let's test for `type`.



---

archive/issue_comments_372468.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-02-06T22:45:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26516",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26516#issuecomment-372468",
    "user": "https://github.com/saraedum"
}
```

New commits:



---

archive/issue_comments_372469.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to build: configure.",
    "created_at": "2020-02-06T22:45:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26516",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26516#issuecomment-372469",
    "user": "https://github.com/saraedum"
}
```

Changing component from PLEASE CHANGE to build: configure.



---

archive/issue_comments_372470.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-02-06T22:45:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26516",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26516#issuecomment-372470",
    "user": "https://github.com/saraedum"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_372471.json:
```json
{
    "body": "is this outdated?",
    "created_at": "2021-10-19T15:01:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26516",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26516#issuecomment-372471",
    "user": "https://github.com/dimpase"
}
```

is this outdated?
