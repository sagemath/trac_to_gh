# Issue 14103: The new doctesting framework doesn't like being run with nohup

Issue created by migration from Trac.

Original creator: fbissey

Original creation time: 2013-03-19 09:32:26

Assignee: mvngu

CC:  jdemeyer

When run inside nohup test are failing to run with the new doctesting framework in 5.9.beta0. An example

```
fbissey`@`QCD-nzi3 /home/work/fbissey/sandbox/sage-5.9.beta0 $ ./sage -t --long "devel/sage-main/sage/misc/inline_fortran.py"
Running doctests with ID 2013-03-19-22-26-09-85e3b5eb.
Doctesting 1 file.
sage -t --long devel/sage-main/sage/misc/inline_fortran.py
    [10 tests, 1.1 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 1.1 seconds
    cpu time: 0.1 seconds
    cumulative wall time: 1.1 seconds
```

But when the same thing is run with nohup 

```
nohup ./sage -t --long "devel/sage-main/sage/misc/inline_fortran.py" &
```

The output is

```
Running doctests with ID 2013-03-19-22-26-21-d52d31ab.
Doctesting 1 file.
sage -t --long devel/sage-main/sage/misc/inline_fortran.py
Process DocTestWorker-1:
Traceback (most recent call last):
  File "/home/work/fbissey/sandbox/sage-5.9.beta0/local/lib/python/multiprocessing/process.py", l
ine 258, in _bootstrap
    self.run()
  File "/home/work/fbissey/sandbox/sage-5.9.beta0/local/lib/python2.7/site-packages/sage/doctest/
forker.py", line 1655, in run
    sys.stdin = os.fdopen(0, "r")
OSError: [Errno 22] Invalid argument
    Bad exit: 1
**********************************************************************
Tests run before process failed:

**********************************************************************
----------------------------------------------------------------------
sage -t --long devel/sage-main/sage/misc/inline_fortran.py  # Bad exit: 1
----------------------------------------------------------------------
Total time for all tests: 0.0 seconds
    cpu time: 0.0 seconds
    cumulative wall time: 0.0 seconds
```



---

Comment by jdemeyer created at 2013-03-19 09:51:06

Please add the output of

```
nohup --version
```



---

Comment by jdemeyer created at 2013-03-19 09:55:33

`nohup` is crazy. It opens the standard *input* for *writing* and claims it's a feature. From `nohup` sources:

```
  /* If standard input is a tty, replace it with /dev/null if possible.
     Note that it is deliberately opened for *writing*,
     to ensure any read evokes an error.  */
  if (ignoring_input)
    {
      if (fd_reopen (STDIN_FILENO, "/dev/null", O_WRONLY, 0) < 0)
        {
          error (0, errno, _("failed to render standard input unusable"));
          exit (exit_internal_failure);
        }
      if (!redirecting_stdout && !redirecting_stderr)
        error (0, 0, _("ignoring input"));
    }
```



---

Comment by fbissey created at 2013-03-19 09:58:30

Updated the summary with nohup version as asked. Sounds crazy all right.


---

Comment by fbissey created at 2013-03-19 10:02:14

From the info page this is a GNU extension

```
   If standard input is a terminal, it is redirected from `/dev/null'
so that terminal sessions do not mistakenly consider the terminal to be
used by the command.  This is a GNU extension; programs intended to be
portable to non-GNU hosts should use `nohup COMMAND [ARG]... </dev/null'
instead.
```

I guess I will try the last bit.


---

Comment by fbissey created at 2013-03-19 10:06:01

Yes that's a cure

```
nohup ./sage -t --long "devel/sage-main/sage/misc/inline_fortran.py" </dev/null &
```

Does work as intended. I guess we can close this as invalid. I have just learnt about a GNU extension that has interesting side effects.


---

Attachment


---

Comment by jdemeyer created at 2013-03-19 10:14:38

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2013-03-19 10:14:38

It's also good anyway to fix the doctester to handle this case, needs review.


---

Comment by jdemeyer created at 2013-03-19 10:18:46

`nohup` essentially does the equivalent of

```
./sage -t --long "devel/sage-main/sage/misc/inline_fortran.py" 0>/dev/null
```

which indeed fails without the patch and works with the patch.


---

Comment by fbissey created at 2013-03-19 10:21:10

ok, will review in the morning in my time zone.


---

Comment by fbissey created at 2013-03-19 21:23:52

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2013-03-19 21:23:52

Works for me now with the patch. Thanks for the fix Jeroen!


---

Comment by jdemeyer created at 2013-03-20 14:45:03

Resolution: fixed


---

Comment by roed created at 2013-03-28 22:46:35

Changing component from doctest to doctest framework.
