# Issue 23984: py3: ZZ for large int

archive/issues_023984.json:
```json
{
    "body": "CC:  @jdemeyer @embray\n\nin a python3-build-sage:\n\n```\nsage: ZZ(int(2**62))\n4611686018427387904\nsage: ZZ(int(2**63))\n---------------------------------------------------------------------------\nOverflowError                             Traceback (most recent call last)\nOverflowError: Python int too large to convert to C long\n\nThe above exception was the direct cause of the following exception:\n\nSystemError                               Traceback (most recent call last)\n<ipython-input-41-47ff15a43d5f> in <module>()\n----> 1 ZZ(int(Integer(2)**Integer(64)))\n\nSystemError: Integer Ring returned a result with an error set\nsage: int(2**63)\n18446744073709551616\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/24221\n\n",
    "created_at": "2017-11-16T10:44:05Z",
    "labels": [
        "python3",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "py3: ZZ for large int",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23984",
    "user": "@fchapoton"
}
```
CC:  @jdemeyer @embray

in a python3-build-sage:

```
sage: ZZ(int(2**62))
4611686018427387904
sage: ZZ(int(2**63))
---------------------------------------------------------------------------
OverflowError                             Traceback (most recent call last)
OverflowError: Python int too large to convert to C long

The above exception was the direct cause of the following exception:

SystemError                               Traceback (most recent call last)
<ipython-input-41-47ff15a43d5f> in <module>()
----> 1 ZZ(int(Integer(2)**Integer(64)))

SystemError: Integer Ring returned a result with an error set
sage: int(2**63)
18446744073709551616
```


Issue created by migration from https://trac.sagemath.org/ticket/24221





---

archive/issue_comments_336034.json:
```json
{
    "body": "Is the text that you quoted above the **literal** text that you see on your screen? Just wondering why there is no traceback shown...",
    "created_at": "2017-11-16T10:50:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23984#issuecomment-336034",
    "user": "@jdemeyer"
}
```

Is the text that you quoted above the **literal** text that you see on your screen? Just wondering why there is no traceback shown...



---

archive/issue_comments_336035.json:
```json
{
    "body": "yes, this the **literal** text that I see in my terminal. No better traceback.\n\nBy the way, maybe you should try by yourself to use the branch public/python3-experiment-8.1.rc1 ?",
    "created_at": "2017-11-16T10:53:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23984#issuecomment-336035",
    "user": "@fchapoton"
}
```

yes, this the **literal** text that I see in my terminal. No better traceback.

By the way, maybe you should try by yourself to use the branch public/python3-experiment-8.1.rc1 ?



---

archive/issue_comments_336036.json:
```json
{
    "body": "There is a general pattern here:\n\nIn Cython code in Sage, when checking for an `int`-like object, this is often done like\n\n```\nif isinstance(x, int):\n    # Handle int\nelif isinstance(x, long):\n    # Handle long\n```\n\n\nThis works fine in Python 2 because `int` and `long` are distinct types. In Python 3, there is only one type, which is the `long` type from Python 2 but which is called `int` in Python 3 (similar to how the `unicode` type from Python 2 is called `str` in Python 3).\n\nNow Cython understands the name `long` to refer to the type which is called `long` in Python 2 and `int` in Python 3. It also understands `int` to refer to the type which is called `int` in Python 2 and the *different* type which is called `int` in Python 3.\n\nSo, in Cython code for Python 3, the checks `isinstance(x, int)` and `isinstance(x, long)` are equivalent. However, the code which needs to be executed is the code for the `long` type, so we should do that check first.\n----\nNew commits:",
    "created_at": "2017-11-16T11:03:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23984#issuecomment-336036",
    "user": "@jdemeyer"
}
```

There is a general pattern here:

In Cython code in Sage, when checking for an `int`-like object, this is often done like

```
if isinstance(x, int):
    # Handle int
elif isinstance(x, long):
    # Handle long
```


This works fine in Python 2 because `int` and `long` are distinct types. In Python 3, there is only one type, which is the `long` type from Python 2 but which is called `int` in Python 3 (similar to how the `unicode` type from Python 2 is called `str` in Python 3).

Now Cython understands the name `long` to refer to the type which is called `long` in Python 2 and `int` in Python 3. It also understands `int` to refer to the type which is called `int` in Python 2 and the *different* type which is called `int` in Python 3.

So, in Cython code for Python 3, the checks `isinstance(x, int)` and `isinstance(x, long)` are equivalent. However, the code which needs to be executed is the code for the `long` type, so we should do that check first.
----
New commits:



---

archive/issue_comments_336037.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-11-16T11:03:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23984#issuecomment-336037",
    "user": "@jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_336038.json:
```json
{
    "body": "This does not fix the issue:\n\n```\nsage: ZZ(int(2**63))\n---------------------------------------------------------------------------\nOverflowError                             Traceback (most recent call last)\nOverflowError: Python int too large to convert to C long\n\nThe above exception was the direct cause of the following exception:\n\nSystemError                               Traceback (most recent call last)\n<ipython-input-3-9949e9fafd8e> in <module>()\n----> 1 ZZ(int(Integer(2)**Integer(63)))\n\nSystemError: Integer Ring returned a result with an error set\n```\n",
    "created_at": "2017-11-16T12:23:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23984#issuecomment-336038",
    "user": "@fchapoton"
}
```

This does not fix the issue:

```
sage: ZZ(int(2**63))
---------------------------------------------------------------------------
OverflowError                             Traceback (most recent call last)
OverflowError: Python int too large to convert to C long

The above exception was the direct cause of the following exception:

SystemError                               Traceback (most recent call last)
<ipython-input-3-9949e9fafd8e> in <module>()
----> 1 ZZ(int(Integer(2)**Integer(63)))

SystemError: Integer Ring returned a result with an error set
```




---

archive/issue_comments_336039.json:
```json
{
    "body": "Sorry, I can't help further without a traceback.",
    "created_at": "2017-11-16T12:32:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23984#issuecomment-336039",
    "user": "@jdemeyer"
}
```

Sorry, I can't help further without a traceback.



---

archive/issue_comments_336040.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-16T12:36:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23984#issuecomment-336040",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_336041.json:
```json
{
    "body": "Never mind, I just realized that the example uses coercion, not direct initialization of an `Integer`.",
    "created_at": "2017-11-16T12:36:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23984#issuecomment-336041",
    "user": "@jdemeyer"
}
```

Never mind, I just realized that the example uses coercion, not direct initialization of an `Integer`.



---

archive/issue_comments_336042.json:
```json
{
    "body": "Indeed\n\n```\nsage: ZZ(2**63)\n9223372036854775808\n```\n\ndoes work (at least with you change)",
    "created_at": "2017-11-16T12:38:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23984#issuecomment-336042",
    "user": "@fchapoton"
}
```

Indeed

```
sage: ZZ(2**63)
9223372036854775808
```

does work (at least with you change)



---

archive/issue_comments_336043.json:
```json
{
    "body": "That fixes the issue ! Thanks !",
    "created_at": "2017-11-16T12:40:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23984#issuecomment-336043",
    "user": "@fchapoton"
}
```

That fixes the issue ! Thanks !



---

archive/issue_comments_336044.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-11-16T13:03:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23984#issuecomment-336044",
    "user": "@fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_336045.json:
```json
{
    "body": "There will certainly be more places in Sage with the same bug. But the solution should be the same: whenever you want to check `int` and `long`, check `long` first.",
    "created_at": "2017-11-16T13:05:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23984#issuecomment-336045",
    "user": "@jdemeyer"
}
```

There will certainly be more places in Sage with the same bug. But the solution should be the same: whenever you want to check `int` and `long`, check `long` first.



---

archive/issue_comments_336046.json:
```json
{
    "body": "See also #23792",
    "created_at": "2017-11-16T13:10:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23984#issuecomment-336046",
    "user": "@jdemeyer"
}
```

See also #23792



---

archive/issue_comments_336047.json:
```json
{
    "body": "follow up in #24225",
    "created_at": "2017-11-16T13:18:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23984#issuecomment-336047",
    "user": "@fchapoton"
}
```

follow up in #24225



---

archive/issue_comments_336048.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-11-16T16:07:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23984#issuecomment-336048",
    "user": "@fchapoton"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_336049.json:
```json
{
    "body": "ok, let us use the opportuniy here to make some similar changes in the same file",
    "created_at": "2017-11-16T16:07:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23984#issuecomment-336049",
    "user": "@fchapoton"
}
```

ok, let us use the opportuniy here to make some similar changes in the same file



---

archive/issue_comments_336050.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-11-16T16:11:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23984#issuecomment-336050",
    "user": "@fchapoton"
}
```

New commits:



---

archive/issue_comments_336051.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-11-16T16:11:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23984#issuecomment-336051",
    "user": "@fchapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_336052.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-11-16T16:39:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23984#issuecomment-336052",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_336053.json:
```json
{
    "body": "Moving the follow-up changes to #24227.",
    "created_at": "2017-11-16T16:39:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23984#issuecomment-336053",
    "user": "@jdemeyer"
}
```

Moving the follow-up changes to #24227.



---

archive/issue_comments_336054.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-12-11T01:02:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23984#issuecomment-336054",
    "user": "@vbraun"
}
```

Resolution: fixed
