# Issue 23984: py3: ZZ for large int

Issue created by migration from Trac.

Original creator: chapoton

Original creation time: 2017-11-16 10:44:05

CC:  jdemeyer embray

in a python3-build-sage:

```
sage: ZZ(int(2**62))
4611686018427387904
sage: ZZ(int(2**63))
---------------------------------------------------------------------------
OverflowError                             Traceback (most recent call last)
OverflowError: Python int too large to convert to C long

The above exception was the direct cause of the following exception:

SystemError                               Traceback (most recent call last)
<ipython-input-41-47ff15a43d5f> in <module>()
----> 1 ZZ(int(Integer(2)**Integer(64)))

SystemError: Integer Ring returned a result with an error set
sage: int(2**63)
18446744073709551616
```



---

Comment by jdemeyer created at 2017-11-16 10:50:39

Is the text that you quoted above the *literal* text that you see on your screen? Just wondering why there is no traceback shown...


---

Comment by chapoton created at 2017-11-16 10:53:44

yes, this the **literal** text that I see in my terminal. No better traceback.

By the way, maybe you should try by yourself to use the branch public/python3-experiment-8.1.rc1 ?


---

Comment by jdemeyer created at 2017-11-16 11:03:16

There is a general pattern here:

In Cython code in Sage, when checking for an `int`-like object, this is often done like

```
if isinstance(x, int):
    # Handle int
elif isinstance(x, long):
    # Handle long
```


This works fine in Python 2 because `int` and `long` are distinct types. In Python 3, there is only one type, which is the `long` type from Python 2 but which is called `int` in Python 3 (similar to how the `unicode` type from Python 2 is called `str` in Python 3).

Now Cython understands the name `long` to refer to the type which is called `long` in Python 2 and `int` in Python 3. It also understands `int` to refer to the type which is called `int` in Python 2 and the _different_ type which is called `int` in Python 3.

So, in Cython code for Python 3, the checks `isinstance(x, int)` and `isinstance(x, long)` are equivalent. However, the code which needs to be executed is the code for the `long` type, so we should do that check first.
----
New commits:


---

Comment by jdemeyer created at 2017-11-16 11:03:16

Changing status from new to needs_review.


---

Comment by chapoton created at 2017-11-16 12:23:48

This does not fix the issue:

```
sage: ZZ(int(2**63))
---------------------------------------------------------------------------
OverflowError                             Traceback (most recent call last)
OverflowError: Python int too large to convert to C long

The above exception was the direct cause of the following exception:

SystemError                               Traceback (most recent call last)
<ipython-input-3-9949e9fafd8e> in <module>()
----> 1 ZZ(int(Integer(2)**Integer(63)))

SystemError: Integer Ring returned a result with an error set
```



---

Comment by jdemeyer created at 2017-11-16 12:32:12

Sorry, I can't help further without a traceback.


---

Comment by git created at 2017-11-16 12:36:05

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-11-16 12:36:42

Never mind, I just realized that the example uses coercion, not direct initialization of an `Integer`.


---

Comment by chapoton created at 2017-11-16 12:38:23

Indeed

```
sage: ZZ(2**63)
9223372036854775808
```

does work (at least with you change)


---

Comment by chapoton created at 2017-11-16 12:40:58

That fixes the issue ! Thanks !


---

Comment by chapoton created at 2017-11-16 13:03:00

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2017-11-16 13:05:39

There will certainly be more places in Sage with the same bug. But the solution should be the same: whenever you want to check `int` and `long`, check `long` first.


---

Comment by jdemeyer created at 2017-11-16 13:10:07

See also #23792


---

Comment by chapoton created at 2017-11-16 13:18:50

follow up in #24225


---

Comment by chapoton created at 2017-11-16 16:07:34

Changing status from positive_review to needs_work.


---

Comment by chapoton created at 2017-11-16 16:07:34

ok, let us use the opportuniy here to make some similar changes in the same file


---

Comment by chapoton created at 2017-11-16 16:11:32

New commits:


---

Comment by chapoton created at 2017-11-16 16:11:32

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-11-16 16:39:26

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2017-11-16 16:39:26

Moving the follow-up changes to #24227.


---

Comment by vbraun created at 2017-12-11 01:02:19

Resolution: fixed
