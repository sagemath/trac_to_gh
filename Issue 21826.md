# Issue 21826: precision problem in elliptic curve integral points

archive/issues_021826.json:
```json
{
    "body": "Keywords: integral points\n\nAs reported on sage-support, sometimes the integral_points() method for elliptic curves over Q misses solutions because of a precision problem in the final stage.  This can be fixed with a minor change which will be posted to this ticket.\n\nNote that there is a larger related ticket #10973 which will fix other integral points issues.  This ticket should *not* wait until that one is finished.\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/22063\n\n",
    "created_at": "2016-12-15T17:10:27Z",
    "labels": [
        "elliptic curves",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.5",
    "title": "precision problem in elliptic curve integral points",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21826",
    "user": "cremona"
}
```
Keywords: integral points

As reported on sage-support, sometimes the integral_points() method for elliptic curves over Q misses solutions because of a precision problem in the final stage.  This can be fixed with a minor change which will be posted to this ticket.

Note that there is a larger related ticket #10973 which will fix other integral points issues.  This ticket should *not* wait until that one is finished.



Issue created by migration from https://trac.sagemath.org/ticket/22063





---

archive/issue_comments_302813.json:
```json
{
    "body": "The function integral_points_with_bounded_mw_coefficients() is now more robust.  A doctest has been added to show that all the examples in Zagier's paper are now found, including the two in the original report on sage-support.\n----\nNew commits:",
    "created_at": "2016-12-15T17:18:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21826#issuecomment-302813",
    "user": "cremona"
}
```

The function integral_points_with_bounded_mw_coefficients() is now more robust.  A doctest has been added to show that all the examples in Zagier's paper are now found, including the two in the original report on sage-support.
----
New commits:



---

archive/issue_comments_302814.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-12-15T17:18:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21826#issuecomment-302814",
    "user": "cremona"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_302815.json:
```json
{
    "body": "you need to add 4 spaces before the added doctests",
    "created_at": "2016-12-15T18:20:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21826#issuecomment-302815",
    "user": "chapoton"
}
```

you need to add 4 spaces before the added doctests



---

archive/issue_comments_302816.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-12-15T20:17:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21826#issuecomment-302816",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_302817.json:
```json
{
    "body": "Replying to [comment:2 chapoton]:\n> you need to add 4 spaces before the added doctests\nSorry about that.  Clearly it has been a while since I did this...I have uploaded a new version, but have not yet rebuilt the docs as I had to do \"make doc-clean\".\n----\nNew commits:",
    "created_at": "2016-12-15T20:19:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21826#issuecomment-302817",
    "user": "cremona"
}
```

Replying to [comment:2 chapoton]:
> you need to add 4 spaces before the added doctests
Sorry about that.  Clearly it has been a while since I did this...I have uploaded a new version, but have not yet rebuilt the docs as I had to do "make doc-clean".
----
New commits:



---

archive/issue_comments_302818.json:
```json
{
    "body": "also you should use new-style doctest continuation `....:` instead of `...`\n\nand do not use \\ in the doc, but also `....:` to break your long line",
    "created_at": "2016-12-15T20:23:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21826#issuecomment-302818",
    "user": "chapoton"
}
```

also you should use new-style doctest continuation `....:` instead of `...`

and do not use \ in the doc, but also `....:` to break your long line



---

archive/issue_comments_302819.json:
```json
{
    "body": "Is that really four dots before : ?\n\nIs this written down somewhere?  Is tere an automatic test which I can run before making yet another commit with trivial typographical errors?  Why can't we have a script which goes through any of our files and fixes these issues for us?!  Isn't that what machines are for??!!",
    "created_at": "2016-12-15T20:30:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21826#issuecomment-302819",
    "user": "cremona"
}
```

Is that really four dots before : ?

Is this written down somewhere?  Is tere an automatic test which I can run before making yet another commit with trivial typographical errors?  Why can't we have a script which goes through any of our files and fixes these issues for us?!  Isn't that what machines are for??!!



---

archive/issue_comments_302820.json:
```json
{
    "body": "Anyway, \"make doc\" takes so long that I will not wait but will upload yet another version just in case by some fluke I have the right number of dots and spaces correct this time.  How stupid.  I will not be spending any more time on this.",
    "created_at": "2016-12-15T20:34:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21826#issuecomment-302820",
    "user": "cremona"
}
```

Anyway, "make doc" takes so long that I will not wait but will upload yet another version just in case by some fluke I have the right number of dots and spaces correct this time.  How stupid.  I will not be spending any more time on this.



---

archive/issue_comments_302821.json:
```json
{
    "body": "This is explained in http://doc.sagemath.org/html/en/developer/coding_basics.html\n(see Multiline doctests).\n\nAnd the patchbot will build the doc for you, and check some points, including this one.\n\nSorry, I did not mean to be unpleasant, only to try and help you to advance this ticket.",
    "created_at": "2016-12-15T20:34:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21826#issuecomment-302821",
    "user": "chapoton"
}
```

This is explained in http://doc.sagemath.org/html/en/developer/coding_basics.html
(see Multiline doctests).

And the patchbot will build the doc for you, and check some points, including this one.

Sorry, I did not mean to be unpleasant, only to try and help you to advance this ticket.



---

archive/issue_comments_302822.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-12-15T20:34:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21826#issuecomment-302822",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_302823.json:
```json
{
    "body": "I hope the doscstring is OK now.  No offence taken!  I just wish there were more automatic tools for this.",
    "created_at": "2016-12-16T16:20:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21826#issuecomment-302823",
    "user": "cremona"
}
```

I hope the doscstring is OK now.  No offence taken!  I just wish there were more automatic tools for this.



---

archive/issue_comments_302824.json:
```json
{
    "body": "looks good.\n\nnote that you can shorten `all([something(x) for x in y])`\nby writing `all(something(x) for x in y)`\n\napart from that, I can set a positive review if you want.",
    "created_at": "2016-12-16T17:55:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21826#issuecomment-302824",
    "user": "chapoton"
}
```

looks good.

note that you can shorten `all([something(x) for x in y])`
by writing `all(something(x) for x in y)`

apart from that, I can set a positive review if you want.



---

archive/issue_comments_302825.json:
```json
{
    "body": "Thanks (and yes please)",
    "created_at": "2016-12-16T18:00:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21826#issuecomment-302825",
    "user": "cremona"
}
```

Thanks (and yes please)



---

archive/issue_comments_302826.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-12-16T18:02:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21826#issuecomment-302826",
    "user": "chapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_302827.json:
```json
{
    "body": "ok, let's go",
    "created_at": "2016-12-16T18:02:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21826#issuecomment-302827",
    "user": "chapoton"
}
```

ok, let's go



---

archive/issue_comments_302828.json:
```json
{
    "body": "checking the patch, for the following curve\n\n\n```\nsage:n=67\nsage:E1=EllipticCurve([0,0,0,2,n^2]);E1;S=E1.integral_points();S;4*n^6+4*n^2\nElliptic Curve defined by y^2 = x^3 + 2*x + 4489 over Rational Field\n[(-16 : 19 : 1),\n (-11 : 56 : 1),\n (0 : 67 : 1),\n (5 : 68 : 1),\n (12 : 79 : 1),\n (25 : 142 : 1),\n (252 : 4001 : 1),\n (424 : 8731 : 1),\n (724 : 19481 : 1),\n (940544 : 912155069 : 1)]\n361833546632\n```\n\nmisses the point \n\n```\n(361833546632,217652291371861061).\n```\n\n\nSame for n=71,74 again one point is missing, \nBut for n=91, two points are missing \n\n```\n(299128 : 163600867 : 1),(2271477041288 : 3423438475922164973:1)\n```\n\n\nIf we take prec=150, then we shall find all the points (in the previous examples).\nMaybe it is better to set as default prec , say 200, instead of 100, to the function\n*integral_points_with_bounded_mw_coeffs(E, mw_base, N, prec=100).*\nSetting a constant prec, is very likely not to cover all the cases. For instance, \nthe curve \n\n```\nn=1400,E1=EllipticCurve([0,0,0,-2,n^2])\n```\n\nneeds prec=220 to find all the points.\n\nMaybe it is a good idea to pass the prec also in the original function\n*integral_points().*\n\nA *weird example* is the following,\n\n\n```\nn=201\nE1=EllipticCurve([0,0,0,-2,n^2]);E1;\nS=E1.integral_points(verbose=True);S;4*n^6-4*n^2\n```\n\nprovides\n\n\n```\nUsing mw_basis  [(0 : 201 : 1), (-5286719/1134225 :\n242521441696/1207949625 : 1)]\ne1,e2,e3:  17.1664256413477 - 29.6994698252302*I 17.1664256413477 +\n29.6994698252302*I -34.3328512826954\nMinimal eigenvalue of height pairing matrix:  3.51647868931990\nx-coords of points on non-compact component with  -34 <=x<= 68\n[0]\nstarting search of remaining points using coefficient bound  2\nx-coords of extra integral points:\n[0]\nTotal number of integral points: 1\n[(0 : 201 : 1)]\n263776642243200\n\n```\n\nI used the following code to check the relation with the precision,\n\n\n```\ndef int_points(E,N,prec):\n    from sage.schemes.elliptic_curves.ell_rational_field import integral_points_with_bounded_mw_coeffs\n    mw_base = E.gens()\n    I = integral_points_with_bounded_mw_coeffs(E, mw_base, N, prec=prec)\n    I=list(I)\n    for i in range(len(I)):\n        print E.lift_x(I[i])\n```\n\n\n\n\n```\nsage:int_points(E1,2,200)\n(0 : 201 : 1)\nsage:int_points(E1,3,100)\n(263776642243200 : 4284049728241222722999 : 1)\n(0 : 201 : 1)\n```\n\nSeems that, this is not a precision problem but the bound N does not take the right value 3.",
    "created_at": "2016-12-18T02:01:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21826#issuecomment-302828",
    "user": "drazioti"
}
```

checking the patch, for the following curve


```
sage:n=67
sage:E1=EllipticCurve([0,0,0,2,n^2]);E1;S=E1.integral_points();S;4*n^6+4*n^2
Elliptic Curve defined by y^2 = x^3 + 2*x + 4489 over Rational Field
[(-16 : 19 : 1),
 (-11 : 56 : 1),
 (0 : 67 : 1),
 (5 : 68 : 1),
 (12 : 79 : 1),
 (25 : 142 : 1),
 (252 : 4001 : 1),
 (424 : 8731 : 1),
 (724 : 19481 : 1),
 (940544 : 912155069 : 1)]
361833546632
```

misses the point 

```
(361833546632,217652291371861061).
```


Same for n=71,74 again one point is missing, 
But for n=91, two points are missing 

```
(299128 : 163600867 : 1),(2271477041288 : 3423438475922164973:1)
```


If we take prec=150, then we shall find all the points (in the previous examples).
Maybe it is better to set as default prec , say 200, instead of 100, to the function
*integral_points_with_bounded_mw_coeffs(E, mw_base, N, prec=100).*
Setting a constant prec, is very likely not to cover all the cases. For instance, 
the curve 

```
n=1400,E1=EllipticCurve([0,0,0,-2,n^2])
```

needs prec=220 to find all the points.

Maybe it is a good idea to pass the prec also in the original function
*integral_points().*

A *weird example* is the following,


```
n=201
E1=EllipticCurve([0,0,0,-2,n^2]);E1;
S=E1.integral_points(verbose=True);S;4*n^6-4*n^2
```

provides


```
Using mw_basis  [(0 : 201 : 1), (-5286719/1134225 :
242521441696/1207949625 : 1)]
e1,e2,e3:  17.1664256413477 - 29.6994698252302*I 17.1664256413477 +
29.6994698252302*I -34.3328512826954
Minimal eigenvalue of height pairing matrix:  3.51647868931990
x-coords of points on non-compact component with  -34 <=x<= 68
[0]
starting search of remaining points using coefficient bound  2
x-coords of extra integral points:
[0]
Total number of integral points: 1
[(0 : 201 : 1)]
263776642243200

```

I used the following code to check the relation with the precision,


```
def int_points(E,N,prec):
    from sage.schemes.elliptic_curves.ell_rational_field import integral_points_with_bounded_mw_coeffs
    mw_base = E.gens()
    I = integral_points_with_bounded_mw_coeffs(E, mw_base, N, prec=prec)
    I=list(I)
    for i in range(len(I)):
        print E.lift_x(I[i])
```




```
sage:int_points(E1,2,200)
(0 : 201 : 1)
sage:int_points(E1,3,100)
(263776642243200 : 4284049728241222722999 : 1)
(0 : 201 : 1)
```

Seems that, this is not a precision problem but the bound N does not take the right value 3.



---

archive/issue_comments_302829.json:
```json
{
    "body": "Perhaps a better idea, which I will now try:  it would be easy for the calling function (i.e. E.integral_points()) to provide an upper bound for |x| for (x,y) any integral point, in terms of the MW coefficient bound, the rank and maximum eigenvalue of the height-pairing matrix (whose minimal eigenvalue is already used) together with a bound on the difference between naive and canonical heights.  Then the function we have been improving can use this to decide how many bits of precision are needed.\n\nI think this would be better than just increasing the precision to be used arbitrarily, or leaving it to the user to do.",
    "created_at": "2016-12-18T14:03:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21826#issuecomment-302829",
    "user": "cremona"
}
```

Perhaps a better idea, which I will now try:  it would be easy for the calling function (i.e. E.integral_points()) to provide an upper bound for |x| for (x,y) any integral point, in terms of the MW coefficient bound, the rank and maximum eigenvalue of the height-pairing matrix (whose minimal eigenvalue is already used) together with a bound on the difference between naive and canonical heights.  Then the function we have been improving can use this to decide how many bits of precision are needed.

I think this would be better than just increasing the precision to be used arbitrarily, or leaving it to the user to do.



---

archive/issue_comments_302830.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-12-18T16:11:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21826#issuecomment-302830",
    "user": "cremona"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_302831.json:
```json
{
    "body": "The idea sketched above seems to work, though without doing more numerical analysis it is hard to say how much precision is needed even with a bound on the size of the integral x-coordinates.  I am using 2* the number of bits in the upper bound (which is itself usually much larger than the actual largest value, for example in the n=1400 example my upper bound on x is about `6*10^66` or 222 bits and I use 444 bits but the actual large x-value is only 65 bits).\n\nI agree with the last example above, where one of the integral points has a coefficient of 3 and is not found because the bound is wrongly computed as 2.   This is caused by a quite different bug, as I mentioned before, and I would prefer to get this precision question fixed first.\n\nI will add some more tests and upload a new patch soon.",
    "created_at": "2016-12-18T16:36:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21826#issuecomment-302831",
    "user": "cremona"
}
```

The idea sketched above seems to work, though without doing more numerical analysis it is hard to say how much precision is needed even with a bound on the size of the integral x-coordinates.  I am using 2* the number of bits in the upper bound (which is itself usually much larger than the actual largest value, for example in the n=1400 example my upper bound on x is about `6*10^66` or 222 bits and I use 444 bits but the actual large x-value is only 65 bits).

I agree with the last example above, where one of the integral points has a coefficient of 3 and is not found because the bound is wrongly computed as 2.   This is caused by a quite different bug, as I mentioned before, and I would prefer to get this precision question fixed first.

I will add some more tests and upload a new patch soon.



---

archive/issue_comments_302832.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-12-18T17:29:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21826#issuecomment-302832",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_302833.json:
```json
{
    "body": "The latest version adds more doctests (most of the examples mentioned above), and implements the method of computing the required real precision from a bound on the x-coordinates.  I also changed the function which processes real points to just round x and try to lift, rather then rounding both x and y and testing whether the rounded values satisfy the equation, since this is slightly slower but will be more robust since y is approximately `x^(3/2)` so would require 1.5 times the precision to get right.\n\nI could avoid the issue of the coefficient bound being smaller than it should be (in some cases) by just adding one to the computed value, but I think that would be dishonest (and would slow down all the cases which currently work).\n\nBack to \"needs review\".",
    "created_at": "2016-12-18T17:34:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21826#issuecomment-302833",
    "user": "cremona"
}
```

The latest version adds more doctests (most of the examples mentioned above), and implements the method of computing the required real precision from a bound on the x-coordinates.  I also changed the function which processes real points to just round x and try to lift, rather then rounding both x and y and testing whether the rounded values satisfy the equation, since this is slightly slower but will be more robust since y is approximately `x^(3/2)` so would require 1.5 times the precision to get right.

I could avoid the issue of the coefficient bound being smaller than it should be (in some cases) by just adding one to the computed value, but I think that would be dishonest (and would slow down all the cases which currently work).

Back to "needs review".



---

archive/issue_comments_302834.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-12-18T17:34:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21826#issuecomment-302834",
    "user": "cremona"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_302835.json:
```json
{
    "body": "ok, the patch indeed fixes the problems with precision. \nThe last example n=201, does not belong in this specific case.\nAlso, I found the following curves \n\n```\ny^2=x^3+2*x+n^2, for n\\in{190,204,208,215,224},\n```\n\n that this last patch fails to find all the integer points. But as you already point out this concerns the ticket 10973. So I think, at least the original problem (concerning precision) was fixed.\n\nBack to positive review! \n\n-----\nAlso, as fas as the previous examples that the patch fails, I am not sure that, this is (always) a problem concerning the bound N. I checked for various large values of N (for n=215,224) using the function *integral_points_with_bounded_mw_coeffs* and I didn't manage to find the missed large integral point.",
    "created_at": "2016-12-18T18:52:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21826#issuecomment-302835",
    "user": "drazioti"
}
```

ok, the patch indeed fixes the problems with precision. 
The last example n=201, does not belong in this specific case.
Also, I found the following curves 

```
y^2=x^3+2*x+n^2, for n\in{190,204,208,215,224},
```

 that this last patch fails to find all the integer points. But as you already point out this concerns the ticket 10973. So I think, at least the original problem (concerning precision) was fixed.

Back to positive review! 

-----
Also, as fas as the previous examples that the patch fails, I am not sure that, this is (always) a problem concerning the bound N. I checked for various large values of N (for n=215,224) using the function *integral_points_with_bounded_mw_coeffs* and I didn't manage to find the missed large integral point.



---

archive/issue_comments_302836.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-12-18T18:52:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21826#issuecomment-302836",
    "user": "drazioti"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_302837.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-12-27T16:32:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21826#issuecomment-302837",
    "user": "vbraun"
}
```

Resolution: fixed
