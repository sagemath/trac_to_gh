# Issue 20898: newer octave launch GUI by default

Issue created by migration from https://trac.sagemath.org/ticket/21135

Original creator: vdelecroix

Original creation time: 2016-07-31 00:16:57

CC:  chapoton charpent

On recent octave versions (at least 4.0.3) the command `octave` launch the GUI interface. Hence on my computer

```
sage: octave('1')  # launch octave GUI and hangs forever
```

With the option `--no-gui` everything is fine.


---

Comment by vdelecroix created at 2016-08-01 20:31:46

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2016-08-01 20:31:46

New commits:


---

Comment by dimpase created at 2016-08-01 23:21:31

Did you see this: https://github.com/sagemathinc/smc-sage/commit/f524d58c3db07856140f5557aa57cfa21a5895b3 ?

(an update to octave interface used on SMC)


---

Comment by vdelecroix created at 2016-08-01 23:27:40

Or more precisely, `https://github.com/billpage/sage-octave`. But I do not see your point. Either we stick to `sage/interfaces/octave.py` or we use some external `octave.py` but only one at a time. If you want to port the enhancement from `sage-octave` into Sage I will be glad to review it.


---

Comment by dimpase created at 2016-08-02 07:53:50

Replying to [comment:7 vdelecroix]:
> Or more precisely, `https://github.com/billpage/sage-octave`. But I do not see your point. Either we stick to `sage/interfaces/octave.py` or we use some external `octave.py` but only one at a time. If you want to port the enhancement from `sage-octave` into Sage I will be glad to review it.

my point was that it looks like a reasonable improvement for `src/sage/interfaces/octave.py`

I'll try to merge it with the branch on this ticket.


---

Comment by dimpase created at 2016-08-02 14:19:21

for the record, your branch tests fine with Octave 3.8.1.


---

Comment by dimpase created at 2016-08-02 19:54:37

by the way, do you understand the need to create Sage matrices in `_matrix` as elements of `MatrixSpace` rather than just `matrix` ?


---

Comment by vdelecroix created at 2016-08-02 19:57:34

Why not? And please do not try to touch to everything as otherwise it will be impossible to review.


---

Comment by dimpase created at 2016-08-02 20:32:47

The difference is not big, but there is one place I don't understand, and moreover it does not work with complex matrices. Namely, in `_matrix` there is the following change:


```
         from sage.matrix.all import MatrixSpace
-        return MatrixSpace(R, nrows, ncols)(w)
+        s = str(self).strip()
+        v = s.split('\n ')
+        nrows = len(v)
+        if nrows == 0:
+            return MatrixSpace(R,0,0)(0)
+        ncols = len(v[0].split())
+        M = MatrixSpace(R, nrows, ncols)
+        v = sum([[x for x in w.split()] for w in v], [])
+        return M(v)
```

moreover it doesn't work on SMC either, so I'd just skip it, unless I understand when one should return 0.


---

Comment by vdelecroix created at 2016-08-02 20:36:50

Anyway, this whole `octave` interface is very broken. Namely floating point are passed through strings which is wrong from the begining. The approach taken in [Oct2Py](https://pypi.python.org/pypi/oct2py) (that is writing files with _complete_ information and building numpy matrices from them) is _much_ better! Though a bit slow.


---

Comment by dimpase created at 2016-08-02 21:18:45

This is the mix of your changes and Bill Page's changes that seems to make sense to me.
----
New commits:


---

Comment by vdelecroix created at 2016-08-02 21:22:41

Let me have a look. (however, I discussed the approach taken here using the version of octave in #20382. Julian claims that it was not a reasonable strategy)


---

Comment by vdelecroix created at 2016-08-02 21:23:26

Why did you reintroduce `sage-native-execute`? This is useless.


---

Comment by vdelecroix created at 2016-08-02 21:24:04

Why did you remove the `--no-gui` that is *exactly* the point of this ticket!?


---

Comment by dimpase created at 2016-08-02 21:25:44

Replying to [comment:17 vdelecroix]:
> Why did you remove the `--no-gui` that is *exactly* the point of this ticket!?

Oops, sorry, I tested on 4.0.0, and it worked... :-)
OK, let me put it back in.


---

Comment by vdelecroix created at 2016-08-02 21:28:32

BTW could you check what gives `$ octave --no-gui` with your 3.X.Y version? (I would expect a return code `1`)


---

Comment by vdelecroix created at 2016-08-02 21:29:13

Replying to [comment:18 dimpase]:
> Replying to [comment:17 vdelecroix]:
> > Why did you remove the `--no-gui` that is *exactly* the point of this ticket!?
> 
> Oops, sorry, I tested on 4.0.0, and it worked... :-)
> OK, let me put it back in.

I don't mind if it works but you should document what you did and remove the --no-gui stuff that is now ignored.


---

Comment by vdelecroix created at 2016-08-02 21:32:52

Note that for me the following line

```
$ octave --no-line-editing --silent --eval 'PS2(PS1());more off' --persist
```

does launch the GUI.


---

Comment by vdelecroix created at 2016-08-02 21:35:20

You should add a linebreak before `_eval_line`


---

Comment by vdelecroix created at 2016-08-02 21:35:39

What is the point of `print("CntrlC: Interrupting %s..."%self)` in `_keyboard_interrupt`?


---

Comment by vdelecroix created at 2016-08-02 21:36:16

This

```
raise pexpect.ExceptionPexpect( "THIS IS A BUG -- PLEASE REPORT. This should never happen.\n" + msg)
```

would better be a `RuntimeError`.


---

Comment by vdelecroix created at 2016-08-02 21:36:55

Why

```
            #self._expect.expect(self._prompt)
            #self._expect.expect(self._prompt)
```

in `_keyboard_interrupt`?


---

Comment by dimpase created at 2016-08-02 21:40:38

Replying to [comment:19 vdelecroix]:
> BTW could you check what gives `$ octave --no-gui` with your 3.X.Y version? (I would expect a return code `1`)

looks as if it just works:

```
$ octave --no-gui
GNU Octave, version 3.8.1
Copyright (C) 2014 John W. Eaton and others.
This is free software; see the source code for copying conditions.
There is ABSOLUTELY NO WARRANTY; not even for MERCHANTABILITY or
FITNESS FOR A PARTICULAR PURPOSE.  For details, type 'warranty'.

Octave was configured for "x86_64-pc-linux-gnu".

Additional information about Octave is available at http://www.octave.org.

Please contribute if you find this software useful.
For more information, visit http://www.octave.org/get-involved.html

Read http://www.octave.org/bugs.html to learn how to submit bug reports.
For information about changes from previous versions, type 'news'.

octave:1> 
```



---

Comment by dimpase created at 2016-08-02 21:41:36

Replying to [comment:25 vdelecroix]:
> Why
> {{{
>             #self._expect.expect(self._prompt)
>             #self._expect.expect(self._prompt)
> }}}
> in `_keyboard_interrupt`?

that's not me... OK, sure, it'd be removed.


---

Comment by dimpase created at 2016-08-02 21:44:12

Replying to [comment:20 vdelecroix]:
> Replying to [comment:18 dimpase]:
> > Replying to [comment:17 vdelecroix]:
> > > Why did you remove the `--no-gui` that is *exactly* the point of this ticket!?
> > 
> > Oops, sorry, I tested on 4.0.0, and it worked... :-)
> > OK, let me put it back in.
> 
> I don't mind if it works but you should document what you did and remove the --no-gui stuff that is now ignored.

there is also an issue with `DISPLAY` --- if it is unset, then `--no-gui` comes into force implicitly...


---

Comment by dimpase created at 2016-08-02 21:45:27

Replying to [comment:23 vdelecroix]:
> What is the point of `print("CntrlC: Interrupting %s..."%self)` in `_keyboard_interrupt`?

I presume this is meant to show this message, as interrupting might take a while...


---

Comment by git created at 2016-08-02 23:03:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2016-08-02 23:04:16

`octave-cli` is the more local thing to call...


---

Comment by git created at 2016-08-03 07:23:46

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2016-08-03 07:30:09

My proposal (in the current ticket branch) is to call `octave-cli` instead of `octave`, which always launches `octave-gui` (according to my tests on Fedora 23 with octave 4.0.1). `octave-cli` is available for octave versions 3 and 4, so this is a simplification too.


---

Comment by vdelecroix created at 2016-08-09 18:34:02

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2016-08-09 18:34:02

If you use `octave-cli` then you can get rid of `--no-gui`.

As you do not use the `prompt` variable you would better remove it.

Since your code does not depend on octave version you would better get rid of my `get_octave_version`.


---

Comment by charpent created at 2016-08-19 14:19:55

This bug forbids full checking (by make ptestlong) of a proposed patch, since such a test currently fails when octave>4.0.0 is installed : octave starts a GUI, doesn't return and the doctest times out.

FYI, the following diff (a four-letters patch...) against the current (7.4beta1) sage is **sufficient** to have sage passing the tests for external interfaces :


```
diff --git a/src/sage/interfaces/octave.py b/src/sage/interfaces/octave.py
index cfbbceb..5b2ce36 100644
--- a/src/sage/interfaces/octave.py
+++ b/src/sage/interfaces/octave.py
@@ -184,7 +184,7 @@ class Octave(Expect):
         Expect.__init__(self,
                         name = 'octave',
                         prompt = '>',
-                        command = "sage-native-execute octave --no-line-editing --silent",
+                        command = "sage-native-execute octave-cli --no-line-editing --silent",
                         server = server,
                         server_tmpdir = server_tmpdir,
                         script_subdirectory = script_subdirectory,
```


Proof (I wanted to check fricas 1.2.7 before reviewing #21231) :


```
charpent@SAP5057241:/usr/local/sage-7$ sage -t --optional=sage,octave,fricas $(sage -root)/src/sage/doctest/external.py 
Running doctests with ID 2016-08-19-16-01-10-87c81a5b.
Git branch: quickoctavefix
Using --optional=fricas,octave,sage
Doctesting 1 file.
sage -t --warn-long 70.0 src/sage/doctest/external.py
    [38 tests, 38.24 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 38.3 seconds
    cpu time: 0.6 seconds
    cumulative wall time: 38.2 seconds
```


Could we please have something reviewable, useable (= allowing for `make ptestlong` to succeed when checking something else...) and dispatch aesthetic //disputationes// to another ticket ?


---

Comment by dimpase created at 2016-08-19 14:38:47

Replying to [comment:36 charpent]:
> This bug forbids full checking (by make ptestlong) of a proposed patch, since such a test currently fails when octave>4.0.0 is installed : octave starts a GUI, doesn't return and the doctest times out.

where in the branch do you see octave called?
octave-cli is called, yes.
Unless you have SAGE_OCTAVE_COMMAND set.
Certainly if you have it set to octave it will do not what you want.
Unset it, then the tests should pass, I think.


> Could we please have something reviewable, useable (= allowing for `make ptestlong` to succeed when checking something else...) and dispatch aesthetic //disputationes// to another ticket ?

Well, does this branch actually work for you? If not, I would like to know which  test it fails, and the version of octave.


---

Comment by charpent created at 2016-08-19 15:12:48

My mail answer to the Trac server didn't make it, it seems...

Replying to [comment:37 dimpase]:
> Comment (by dimpase):
>
>  Replying to [comment:36 charpent]:

[ Snip ]

>  > This bug forbids full checking (by make ptestlong) of a proposed patch,
>  since such a test currently fails when octave>4.0.0 is installed : octave
>  starts a GUI, doesn't return and the doctest times out.
>
>  where in the branch do you see octave called?
>  octave-cli is called, yes.
>  Unless you have SAGE_OCTAVE_COMMAND set.
>  Certainly if you have it set to octave it will do not what you want.
>  Unset it, then the tests should pass, I think.

Think again :


```
charpent@SAP5057241:~$ sage -sh

Starting subshell with Sage environment variables set.  Don't forget
to exit when you are done.  Beware:
 * Do not do anything with other copies of Sage on your system.
 * Do not use this for installing Sage packages using "sage -i" or for
   running "make" at Sage's root directory.  These should be done
   outside the Sage shell.

Bypassing shell configuration files...

Note: SAGE_ROOT=/usr/local/sage-7
(sage-sh) charpent@SAP5057241:~$ echo $SAGE_OCTAVE_COMMAND

(sage-sh) charpent@SAP5057241:~$ which octave
/usr/bin/octave
(sage-sh) charpent@SAP5057241:~$ octave

[ Octave starts its GUI. I exit from it]

(sage-sh) charpent@SAP5057241:~$ exit
exit
Exited Sage subshell.
charpent@SAP5057241:~$ echo $SAGE_OCTAVE_COMMAND

charpent@SAP5057241:~$
```


Ergo SAGE_OCTAVE_COMMAND is not set neither in the Sage shell neither out of it.

A "make ptestlong" on this machine FAILS with a timeout on ...doctest/external.py", leaving an unclosable octave gui (you have to kill -TERM it...). From my check of 7.4beta0 :


```
...
sage -t --long --warn-long 50.8 src/sage/doctest/external.py
    Timed out
**********************************************************************
...
**********************************************************************
----------------------------------------------------------------------
sage -t --long --warn-long 50.8 src/sage/doctest/external.py  # Timed out
----------------------------------------------------------------------
Total time for all tests: 8702.9 seconds
    cpu time: 11743.1 seconds
    cumulative wall time: 14507.8 seconds
```


The octave documentation does not hint at any way of making the CLI interface the default (all it does provide is the --no-gui option and the octave-cli binary). Therefore, this fix is somewhat urgent for people having octave>4.0.0 installed...

[ Snip again... ]

>  > Could we please have something reviewable, useable (= allowing for
>  > `make ptestlong` to succeed when checking something else...) and
>  > dispatch aesthetic //disputationes// to another ticket ?

I am devasted to have to insist...

                    Emmanuel Charpentier


---

Comment by dimpase created at 2016-08-19 15:21:01

Replying to [comment:38 charpent]:

I can only conjecture that you have not pulled the right branch, `public/21135` before running your tests.

Could you please re-check? The change you proposed is equivalent to the branch in the sense that no octave is called, only octave-cli.

As well, could you please check that octave-cli does not launch GUI for you.


---

Comment by git created at 2016-08-19 15:28:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by charpent created at 2016-08-19 15:31:44

Replying to [comment:39 dimpase]:
> Replying to [comment:38 charpent]:
> 
> I can only conjecture that you have not pulled the right branch, `public/21135` before running your tests.

I have //**NOT**// pulled #21135 : my diff was against the current (pristine (unmodified)) 7.4beta1. My point was that a four-letters patch was enough to solve my current difficulty (i. e. breaking something that used to work), and that the other proposed modificatins (which aim at //enhancing// something that used to work) are a //**separate**// issue...

> Could you please re-check? The change you proposed is equivalent to the branch in the sense that no octave is called, only octave-cli.

No point. See above.

> As well, could you please check that octave-cli does not launch GUI for you.


It does not.

HTH...
----
New commits:


---

Comment by dimpase created at 2016-08-19 15:39:49

well, let's go with the review then!
I left the new version function in, just in case. It does no harm.


---

Comment by dimpase created at 2016-08-19 15:39:49

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2016-08-19 15:54:22

Replying to [comment:41 charpent]:
> Replying to [comment:39 dimpase]:
> > Replying to [comment:38 charpent]:
> > 
> > I can only conjecture that you have not pulled the right branch, `public/21135` before running your tests.
> 
> I have //**NOT**// pulled #21135 : my diff was against the current (pristine (unmodified)) 7.4beta1. My point was that a four-letters patch was enough to solve my current difficulty (i. e. breaking something that used to work), and that the other proposed modificatins (which aim at //enhancing// something that used to work) are a //**separate**// issue... 

My apologies, I thought you were saying that you tried this branch and it didn't work. I'm very stressed today, in a bad way...


---

Comment by vdelecroix created at 2016-08-19 16:56:58

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2016-08-19 16:56:58

You did not address [comment:35 comment:35]. And there is no need to check for the version in `__init__`.


---

Comment by git created at 2016-08-19 19:48:13

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2016-08-19 19:50:34

OK, sorry for being unable to see that in 

```
if A:
   foo
if B:
   xfoo
```

one has `foo==foo`... Duh. Fixed.


---

Comment by dimpase created at 2016-08-19 19:50:34

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2016-08-19 19:53:47

Could you remove the function `get_octave_version` that was introduced in my first commit completely?


---

Comment by vdelecroix created at 2016-08-19 19:54:09

(it is fine to keep `octave_version` with the deprecation introduced in the same commit)


---

Comment by git created at 2016-08-19 20:02:31

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2016-08-19 20:03:11

done.


---

Comment by vdelecroix created at 2016-08-19 20:06:27

all right. I am testing it.


---

Comment by vdelecroix created at 2016-08-19 20:10:12

to make it cleaner, I would remove

```
options = " --no-line-editing --silent"
```

and change

```
command = command + options + " --eval 'PS2(PS1());more off' --persist",
```

to

```
command = command + " --no-line-editing --silent--eval 'PS2(PS1());more off' --persist",
```



---

Comment by git created at 2016-08-19 20:21:40

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2016-08-19 20:22:13

ok.


---

Comment by vdelecroix created at 2016-08-19 20:27:59

octave process leave some annoying "octave-workspace" file. Would be cool to get rid of that when exiting octave. (Though not for this ticket)


---

Comment by vdelecroix created at 2016-08-19 20:30:07

Thanks!


---

Comment by vdelecroix created at 2016-08-19 20:30:07

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-08-21 13:13:52

Resolution: fixed
