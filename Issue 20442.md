# Issue 20442: matrix vector product for generic sparse matrices

archive/issues_020442.json:
```json
{
    "body": "Keywords: sparse, product\n\nIt seems like this simple cython code is faster 30% faster than the implemented matrix vector product for generic sparse matrices.\nI run some tests with matrices with RIF coefficients and all seem to point in this direction.\n\n%cython file\nimport cython\n\nfrom sage.matrix.matrix_generic_sparse cimport *\nfrom sage.modules.free_module_element cimport *\n\n# this is a generic sparse_mat_vec, hoping to get some speedup from the fact that it is compiled\ndef cython_sparse_matvec(Matrix_generic_sparse P, FreeModuleElement_generic_dense v, FreeModuleElement_generic_dense w):\n\n  for (ij, val) in P.dict().iteritems():\n    w[ij[0]] += val*v[ij[1]]\n\ndef cython_sparse_vecmat(Matrix_generic_sparse P, FreeModuleElement_generic_dense v, FreeModuleElement_generic_dense w):\n\n  for (ij, val) in P.dict().iteritems():\n    w[ij[1]] += val*v[ij[0]]\n\n%python module\ndef sparse_matvec(P,v):\n\n  \"\"\"Compute Sage sparse matrix * vector product.\n\n  Apparently, M*v fills the matrix in Sage, so this should be quicker\"\"\"\n\n  w = VectorSpace(P.base_ring(),P.nrows())(0)\n  cython_sparse_matvec(P,v,w)\n  return w\n\n\ndef sparse_vecmat(v,P):\n\n  \"\"\"Compute Sage sparse vector * matrix product.\n\n  Apparently, v*M fills the matrix in Sage, so this should be quicker\"\"\"\n  w = VectorSpace(P.base_ring(),P.ncols())(0)\n  cython_sparse_vecmat(P,v,w)\n  return w\n\nIssue created by migration from https://trac.sagemath.org/ticket/20679\n\n",
    "created_at": "2016-05-25T14:00:45Z",
    "labels": [
        "component: linear algebra"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "matrix vector product for generic sparse matrices",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20442",
    "user": "https://trac.sagemath.org/admin/accounts/users/orkolorko"
}
```
Keywords: sparse, product

It seems like this simple cython code is faster 30% faster than the implemented matrix vector product for generic sparse matrices.
I run some tests with matrices with RIF coefficients and all seem to point in this direction.

%cython file
import cython

from sage.matrix.matrix_generic_sparse cimport *
from sage.modules.free_module_element cimport *

# this is a generic sparse_mat_vec, hoping to get some speedup from the fact that it is compiled
def cython_sparse_matvec(Matrix_generic_sparse P, FreeModuleElement_generic_dense v, FreeModuleElement_generic_dense w):

  for (ij, val) in P.dict().iteritems():
    w[ij[0]] += val*v[ij[1]]

def cython_sparse_vecmat(Matrix_generic_sparse P, FreeModuleElement_generic_dense v, FreeModuleElement_generic_dense w):

  for (ij, val) in P.dict().iteritems():
    w[ij[1]] += val*v[ij[0]]

%python module
def sparse_matvec(P,v):

  """Compute Sage sparse matrix * vector product.

  Apparently, M*v fills the matrix in Sage, so this should be quicker"""

  w = VectorSpace(P.base_ring(),P.nrows())(0)
  cython_sparse_matvec(P,v,w)
  return w


def sparse_vecmat(v,P):

  """Compute Sage sparse vector * matrix product.

  Apparently, v*M fills the matrix in Sage, so this should be quicker"""
  w = VectorSpace(P.base_ring(),P.ncols())(0)
  cython_sparse_vecmat(P,v,w)
  return w

Issue created by migration from https://trac.sagemath.org/ticket/20679





---

archive/issue_comments_281363.json:
```json
{
    "body": "This is how the matrix action on vectors is currently (8.1.beta9) implemented. So either this ticket description is out of date or the speedup is due to skipping safety checks. Without timings and an example, it is hard to determine. I propose to close since the proposal is functionally no change.",
    "created_at": "2017-10-24T02:34:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20442#issuecomment-281363",
    "user": "https://github.com/tscrim"
}
```

This is how the matrix action on vectors is currently (8.1.beta9) implemented. So either this ticket description is out of date or the speedup is due to skipping safety checks. Without timings and an example, it is hard to determine. I propose to close since the proposal is functionally no change.



---

archive/issue_comments_281364.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-10-24T02:34:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20442#issuecomment-281364",
    "user": "https://github.com/tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_281365.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-12-21T16:58:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20442#issuecomment-281365",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_281366.json:
```json
{
    "body": "Resolution: wontfix",
    "created_at": "2018-05-18T17:16:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20442#issuecomment-281366",
    "user": "https://github.com/videlec"
}
```

Resolution: wontfix



---

archive/issue_comments_281367.json:
```json
{
    "body": "closing positively reviewed duplicates",
    "created_at": "2018-05-18T17:16:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20442",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20442#issuecomment-281367",
    "user": "https://github.com/videlec"
}
```

closing positively reviewed duplicates



---

archive/issue_events_019406.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-05-18T17:16:26Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20442",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20442#event-19406"
}
```
