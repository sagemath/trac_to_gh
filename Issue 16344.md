# Issue 16344: Added tides based desolvers

Issue created by migration from Trac.

Original creator: mmarco

Original creation time: 2014-06-28 07:10:05

CC:  vbraun vdelecroix

This patch adds two solvers for differential equations (desolve_mintides and desove_tides_mpfr) based on the TIDES library.


---

Comment by mmarco created at 2014-06-28 07:11:43

New commits:


---

Comment by mmarco created at 2014-06-28 07:11:43

Changing status from new to needs_review.


---

Comment by mmarco created at 2014-06-28 07:42:19

Changing keywords from "" to "sd59".


---

Comment by vdelecroix created at 2014-06-28 10:38:34

Hi Miguel,

Why did you include tides in source instead of making a spkg? The sources of packages are not under git management. You would better follow the instructions at [http://www.sagemath.org/doc/developer/packaging.html](http://www.sagemath.org/doc/developer/packaging.html).

EDIT: I see it is at #16578... sorry for the noise

COMMENT: in the list of commit above it is *very* hard to see which are the one associated to that ticket!!

Vincent


---

Comment by mmarco created at 2014-06-28 18:35:02

Yeah, sorry for the long list of commits, i made a lot of trial-and-error and refactoring before having this ready.... i guess there could be a way to tell git to merge all those commits into one.


---

Comment by vdelecroix created at 2014-06-28 18:39:16

Yes!!! I just learn it today: `git rebase -i` see: [rewriting history](http://git-scm.com/book/en/Git-Tools-Rewriting-History)


---

Comment by vdelecroix created at 2014-06-28 18:39:55

But be careful: keep distinct commits for distinct tickets!


---

Comment by git created at 2014-06-28 21:41:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2014-07-08 22:00:56

You should use the CC / CFLAGS / LDFLAGS environment variables (CXX for C++).

IMHO the integration is a bit underwhelming. Its ok for an optional package, I guess. But better solutions would be
* Use the `cython()` command to dynamically generate a function that is callable from Python, without parsing strings anywhere. Leaks a bit of memory from the imports.
* Use `fast_callable(..., domain=RealField(prec))` to dynamically construct the expression tree and only have a single Cython class that can call tides as appropriate.
Do you have any plans in that direction?


---

Comment by mmarco created at 2014-07-09 03:27:46

I am not sure if i understand your second suggestion. About the first one, it could be a good idea for this part (the desolvers). But it should be substitute the .c files generators in #16579, since those .c files are useful by themselves (one of the use cases of TIDES is to generate those files qith Mathematica and then tweak them by hand to get slightly different solutions, or extra information from them).

If i understand correctly, you are suggesting to substitute the call to gcc by some small cython object. Is that correct?


---

Comment by vbraun created at 2014-07-09 03:48:16

About the first, you can use the `cython()` command in Sage to compile a new cython extension module at run-time. With the magic comment `#cfile foo.c` (see `cython?`) you can even include C sources. So it should be rather easy to implement.

The second suggestion is to not compile stuff whenever you solve a differential equation (really, nobody else does that). You can just compile it once and evaluate the function/derivatives dynamically.


---

Comment by mmarco created at 2014-07-09 06:53:41

I am not sure if the tides design allows that kind of workflow. I will ask the developers about it. Apparently, in the world of specialized de solvers, compiling write and compile a program for each particular de is the usual (which was very surprising for me when I found out)


---

Comment by iMark created at 2014-08-05 13:07:02

Hi. I'm Marcos Rodriguez, a developer of TIDES.

Thank you very much for the reviewing effort.

In the numerical computation of a differential equation, the bottleneck is at the computation of the taylor series coefficients (code generated by the parser). Therefore, this scheme should be as much optimized as possible via compiler. So, a dynamical function call for this part would slow down the computation significantly.

Besides, the original goal of MathTIDES (the parser written in Mathematica) was the generation of C of Fortran code which compilation and execution is independent of the symbolic preprocessor (Mathematica in this case) so that it can be tweaked or integrated in other C or Fortran codes for different purposes.

We think that the natural extension is to compile, execute and display this code in a free symbolic preprocessor.


---

Comment by vbraun created at 2014-08-05 14:23:28

Thanks for posting here! 

Its of course faster to do anything numerical in compiled code. But there is a reason why we don't always do that (e.g. when plotting functions). At the end of the day it is just a trade-off between speed in a single example vs. preprocessing time and ease of use. Imagine you want to solve a million ODEs, each only a short bit into the future. In any case, this need not be done on this ticket.

Miguel:
* use subprocess.check_call instead of os.system to catch potential errors
* "which" is not posix, use "command -v"
* Use sage's tmp_dir instead of mkdtmp
* os.path.join instead of hard-coding "/" as directory separator
* less blank lines (see pep8). Double blanks only to separate class definitons and top-level functions.
* You should link to Sage's mpir/mpfr instead of the system default. Use `gcc -I$SAGE_ROOT/local/include -L$SAGE_ROOT/local/lib` for header and library search paths.


---

Comment by git created at 2014-08-15 12:19:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmarco created at 2014-08-15 12:19:54

Made the suggested changes.


---

Comment by iMark created at 2014-10-06 11:45:03

Hello.

Do you think that after the changes, a possitive revision can be given (with possible minor changes), or it would need a complete rewrite.
The reason for me to ask is that we are writing a paper about TIDES and integration using Taylor Method and we would like to include comparisons using Sage-tides and anounce the Sage version of the package as a completely free version of the software.

Thank you very much.


---

Comment by vbraun created at 2014-10-06 12:19:57

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-10-06 12:28:06

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2014-10-06 12:28:06

You want `# abs tol`

```
File "src/sage/calculus/desolvers.py", line 1617, in sage.calculus.desolvers.desolve_mintides
Failed example:
    sol # optional -tides # abs rel 1e-5
Expected:
    [[0.000000000000000,
    0.800000000000000,
    0.000000000000000,
    0.000000000000000,
    1.22474487139159],
    [314.159265358979,
    0.800000000028622,
    -5.91973525754241e-9,
    7.56887091890590e-9,
    1.22474487136329]]
Got:
    [[0.000000000000000,
      0.800000000000000,
      0.000000000000000,
      0.000000000000000,
      1.22474487139159],
     [314.159265358979,
      0.800000000028628,
      -5.92006829669423e-9,
      7.56929363632253e-9,
      1.22474487136328]]
**********************************************************************
```



---

Comment by git created at 2014-10-06 15:38:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmarco created at 2014-10-06 15:40:38

Fixed


---

Comment by mmarco created at 2014-10-06 15:40:38

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2014-10-07 14:23:09

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-10-08 12:59:56

Resolution: fixed
