# Issue 16344: Added tides based desolvers

archive/issues_016344.json:
```json
{
    "body": "CC:  @vbraun @videlec\n\nKeywords: sd59\n\nThis patch adds two solvers for differential equations (desolve_mintides and desove_tides_mpfr) based on the TIDES library.\n\nIssue created by migration from https://trac.sagemath.org/ticket/16581\n\n",
    "closed_at": "2014-10-08T12:59:56Z",
    "created_at": "2014-06-28T07:10:05Z",
    "labels": [
        "component: numerical"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "Added tides based desolvers",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16344",
    "user": "https://github.com/miguelmarco"
}
```
CC:  @vbraun @videlec

Keywords: sd59

This patch adds two solvers for differential equations (desolve_mintides and desove_tides_mpfr) based on the TIDES library.

Issue created by migration from https://trac.sagemath.org/ticket/16581





---

archive/issue_comments_214094.json:
```json
{
    "body": "New commits:",
    "created_at": "2014-06-28T07:11:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-214094",
    "user": "https://github.com/miguelmarco"
}
```

New commits:



---

archive/issue_comments_214095.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-06-28T07:11:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-214095",
    "user": "https://github.com/miguelmarco"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_214096.json:
```json
{
    "body": "Changing keywords from \"\" to \"sd59\".",
    "created_at": "2014-06-28T07:42:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-214096",
    "user": "https://github.com/miguelmarco"
}
```

Changing keywords from "" to "sd59".



---

archive/issue_comments_214097.json:
```json
{
    "body": "Hi Miguel,\n\nWhy did you include tides in source instead of making a spkg? The sources of packages are not under git management. You would better follow the instructions at [http://www.sagemath.org/doc/developer/packaging.html](http://www.sagemath.org/doc/developer/packaging.html).\n\nEDIT: I see it is at #16578... sorry for the noise\n\nCOMMENT: in the list of commit above it is **very** hard to see which are the one associated to that ticket!!\n\nVincent",
    "created_at": "2014-06-28T10:38:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-214097",
    "user": "https://github.com/videlec"
}
```

Hi Miguel,

Why did you include tides in source instead of making a spkg? The sources of packages are not under git management. You would better follow the instructions at [http://www.sagemath.org/doc/developer/packaging.html](http://www.sagemath.org/doc/developer/packaging.html).

EDIT: I see it is at #16578... sorry for the noise

COMMENT: in the list of commit above it is **very** hard to see which are the one associated to that ticket!!

Vincent



---

archive/issue_comments_214098.json:
```json
{
    "body": "Yeah, sorry for the long list of commits, i made a lot of trial-and-error and refactoring before having this ready.... i guess there could be a way to tell git to merge all those commits into one.",
    "created_at": "2014-06-28T18:35:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-214098",
    "user": "https://github.com/miguelmarco"
}
```

Yeah, sorry for the long list of commits, i made a lot of trial-and-error and refactoring before having this ready.... i guess there could be a way to tell git to merge all those commits into one.



---

archive/issue_comments_214099.json:
```json
{
    "body": "Yes!!! I just learn it today: `git rebase -i` see: [rewriting history](http://git-scm.com/book/en/Git-Tools-Rewriting-History)",
    "created_at": "2014-06-28T18:39:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-214099",
    "user": "https://github.com/videlec"
}
```

Yes!!! I just learn it today: `git rebase -i` see: [rewriting history](http://git-scm.com/book/en/Git-Tools-Rewriting-History)



---

archive/issue_comments_214100.json:
```json
{
    "body": "But be careful: keep distinct commits for distinct tickets!",
    "created_at": "2014-06-28T18:39:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-214100",
    "user": "https://github.com/videlec"
}
```

But be careful: keep distinct commits for distinct tickets!



---

archive/issue_comments_214101.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-06-28T21:41:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-214101",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_214102.json:
```json
{
    "body": "You should use the CC / CFLAGS / LDFLAGS environment variables (CXX for C++).\n\nIMHO the integration is a bit underwhelming. Its ok for an optional package, I guess. But better solutions would be\n* Use the `cython()` command to dynamically generate a function that is callable from Python, without parsing strings anywhere. Leaks a bit of memory from the imports.\n* Use `fast_callable(..., domain=RealField(prec))` to dynamically construct the expression tree and only have a single Cython class that can call tides as appropriate.\nDo you have any plans in that direction?",
    "created_at": "2014-07-08T22:00:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-214102",
    "user": "https://github.com/vbraun"
}
```

You should use the CC / CFLAGS / LDFLAGS environment variables (CXX for C++).

IMHO the integration is a bit underwhelming. Its ok for an optional package, I guess. But better solutions would be
* Use the `cython()` command to dynamically generate a function that is callable from Python, without parsing strings anywhere. Leaks a bit of memory from the imports.
* Use `fast_callable(..., domain=RealField(prec))` to dynamically construct the expression tree and only have a single Cython class that can call tides as appropriate.
Do you have any plans in that direction?



---

archive/issue_comments_214103.json:
```json
{
    "body": "I am not sure if i understand your second suggestion. About the first one, it could be a good idea for this part (the desolvers). But it should be substitute the .c files generators in #16579, since those .c files are useful by themselves (one of the use cases of TIDES is to generate those files qith Mathematica and then tweak them by hand to get slightly different solutions, or extra information from them).\n\nIf i understand correctly, you are suggesting to substitute the call to gcc by some small cython object. Is that correct?",
    "created_at": "2014-07-09T03:27:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-214103",
    "user": "https://github.com/miguelmarco"
}
```

I am not sure if i understand your second suggestion. About the first one, it could be a good idea for this part (the desolvers). But it should be substitute the .c files generators in #16579, since those .c files are useful by themselves (one of the use cases of TIDES is to generate those files qith Mathematica and then tweak them by hand to get slightly different solutions, or extra information from them).

If i understand correctly, you are suggesting to substitute the call to gcc by some small cython object. Is that correct?



---

archive/issue_comments_214104.json:
```json
{
    "body": "About the first, you can use the `cython()` command in Sage to compile a new cython extension module at run-time. With the magic comment `#cfile foo.c` (see `cython?`) you can even include C sources. So it should be rather easy to implement.\n\nThe second suggestion is to not compile stuff whenever you solve a differential equation (really, nobody else does that). You can just compile it once and evaluate the function/derivatives dynamically.",
    "created_at": "2014-07-09T03:48:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-214104",
    "user": "https://github.com/vbraun"
}
```

About the first, you can use the `cython()` command in Sage to compile a new cython extension module at run-time. With the magic comment `#cfile foo.c` (see `cython?`) you can even include C sources. So it should be rather easy to implement.

The second suggestion is to not compile stuff whenever you solve a differential equation (really, nobody else does that). You can just compile it once and evaluate the function/derivatives dynamically.



---

archive/issue_comments_214105.json:
```json
{
    "body": "I am not sure if the tides design allows that kind of workflow. I will ask the developers about it. Apparently, in the world of specialized de solvers, compiling write and compile a program for each particular de is the usual (which was very surprising for me when I found out)",
    "created_at": "2014-07-09T06:53:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-214105",
    "user": "https://github.com/miguelmarco"
}
```

I am not sure if the tides design allows that kind of workflow. I will ask the developers about it. Apparently, in the world of specialized de solvers, compiling write and compile a program for each particular de is the usual (which was very surprising for me when I found out)



---

archive/issue_comments_214106.json:
```json
{
    "body": "Hi. I'm Marcos Rodriguez, a developer of TIDES.\n\nThank you very much for the reviewing effort.\n\nIn the numerical computation of a differential equation, the bottleneck is at the computation of the taylor series coefficients (code generated by the parser). Therefore, this scheme should be as much optimized as possible via compiler. So, a dynamical function call for this part would slow down the computation significantly.\n\nBesides, the original goal of MathTIDES (the parser written in Mathematica) was the generation of C of Fortran code which compilation and execution is independent of the symbolic preprocessor (Mathematica in this case) so that it can be tweaked or integrated in other C or Fortran codes for different purposes.\n\nWe think that the natural extension is to compile, execute and display this code in a free symbolic preprocessor.",
    "created_at": "2014-08-05T13:07:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-214106",
    "user": "https://trac.sagemath.org/admin/accounts/users/iMark"
}
```

Hi. I'm Marcos Rodriguez, a developer of TIDES.

Thank you very much for the reviewing effort.

In the numerical computation of a differential equation, the bottleneck is at the computation of the taylor series coefficients (code generated by the parser). Therefore, this scheme should be as much optimized as possible via compiler. So, a dynamical function call for this part would slow down the computation significantly.

Besides, the original goal of MathTIDES (the parser written in Mathematica) was the generation of C of Fortran code which compilation and execution is independent of the symbolic preprocessor (Mathematica in this case) so that it can be tweaked or integrated in other C or Fortran codes for different purposes.

We think that the natural extension is to compile, execute and display this code in a free symbolic preprocessor.



---

archive/issue_comments_214107.json:
```json
{
    "body": "Thanks for posting here! \n\nIts of course faster to do anything numerical in compiled code. But there is a reason why we don't always do that (e.g. when plotting functions). At the end of the day it is just a trade-off between speed in a single example vs. preprocessing time and ease of use. Imagine you want to solve a million ODEs, each only a short bit into the future. In any case, this need not be done on this ticket.\n\nMiguel:\n* use subprocess.check_call instead of os.system to catch potential errors\n* \"which\" is not posix, use \"command -v\"\n* Use sage's tmp_dir instead of mkdtmp\n* os.path.join instead of hard-coding \"/\" as directory separator\n* less blank lines (see pep8). Double blanks only to separate class definitons and top-level functions.\n* You should link to Sage's mpir/mpfr instead of the system default. Use `gcc -I$SAGE_ROOT/local/include -L$SAGE_ROOT/local/lib` for header and library search paths.",
    "created_at": "2014-08-05T14:23:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-214107",
    "user": "https://github.com/vbraun"
}
```

Thanks for posting here! 

Its of course faster to do anything numerical in compiled code. But there is a reason why we don't always do that (e.g. when plotting functions). At the end of the day it is just a trade-off between speed in a single example vs. preprocessing time and ease of use. Imagine you want to solve a million ODEs, each only a short bit into the future. In any case, this need not be done on this ticket.

Miguel:
* use subprocess.check_call instead of os.system to catch potential errors
* "which" is not posix, use "command -v"
* Use sage's tmp_dir instead of mkdtmp
* os.path.join instead of hard-coding "/" as directory separator
* less blank lines (see pep8). Double blanks only to separate class definitons and top-level functions.
* You should link to Sage's mpir/mpfr instead of the system default. Use `gcc -I$SAGE_ROOT/local/include -L$SAGE_ROOT/local/lib` for header and library search paths.



---

archive/issue_events_048654.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16344#event-48654"
}
```



---

archive/issue_comments_214108.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-08-15T12:19:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-214108",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_214109.json:
```json
{
    "body": "Made the suggested changes.",
    "created_at": "2014-08-15T12:19:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-214109",
    "user": "https://github.com/miguelmarco"
}
```

Made the suggested changes.



---

archive/issue_comments_214110.json:
```json
{
    "body": "Hello.\n\nDo you think that after the changes, a possitive revision can be given (with possible minor changes), or it would need a complete rewrite.\nThe reason for me to ask is that we are writing a paper about TIDES and integration using Taylor Method and we would like to include comparisons using Sage-tides and anounce the Sage version of the package as a completely free version of the software.\n\nThank you very much.",
    "created_at": "2014-10-06T11:45:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-214110",
    "user": "https://trac.sagemath.org/admin/accounts/users/iMark"
}
```

Hello.

Do you think that after the changes, a possitive revision can be given (with possible minor changes), or it would need a complete rewrite.
The reason for me to ask is that we are writing a paper about TIDES and integration using Taylor Method and we would like to include comparisons using Sage-tides and anounce the Sage version of the package as a completely free version of the software.

Thank you very much.



---

archive/issue_comments_214111.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-10-06T12:19:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-214111",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_214112.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2014-10-06T12:28:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-214112",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_214113.json:
```json
{
    "body": "You want `# abs tol`\n\n```\nFile \"src/sage/calculus/desolvers.py\", line 1617, in sage.calculus.desolvers.desolve_mintides\nFailed example:\n    sol # optional -tides # abs rel 1e-5\nExpected:\n    [[0.000000000000000,\n    0.800000000000000,\n    0.000000000000000,\n    0.000000000000000,\n    1.22474487139159],\n    [314.159265358979,\n    0.800000000028622,\n    -5.91973525754241e-9,\n    7.56887091890590e-9,\n    1.22474487136329]]\nGot:\n    [[0.000000000000000,\n      0.800000000000000,\n      0.000000000000000,\n      0.000000000000000,\n      1.22474487139159],\n     [314.159265358979,\n      0.800000000028628,\n      -5.92006829669423e-9,\n      7.56929363632253e-9,\n      1.22474487136328]]\n**********************************************************************\n```",
    "created_at": "2014-10-06T12:28:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-214113",
    "user": "https://github.com/vbraun"
}
```

You want `# abs tol`

```
File "src/sage/calculus/desolvers.py", line 1617, in sage.calculus.desolvers.desolve_mintides
Failed example:
    sol # optional -tides # abs rel 1e-5
Expected:
    [[0.000000000000000,
    0.800000000000000,
    0.000000000000000,
    0.000000000000000,
    1.22474487139159],
    [314.159265358979,
    0.800000000028622,
    -5.91973525754241e-9,
    7.56887091890590e-9,
    1.22474487136329]]
Got:
    [[0.000000000000000,
      0.800000000000000,
      0.000000000000000,
      0.000000000000000,
      1.22474487139159],
     [314.159265358979,
      0.800000000028628,
      -5.92006829669423e-9,
      7.56929363632253e-9,
      1.22474487136328]]
**********************************************************************
```



---

archive/issue_comments_214114.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-10-06T15:38:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-214114",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_214115.json:
```json
{
    "body": "Fixed",
    "created_at": "2014-10-06T15:40:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-214115",
    "user": "https://github.com/miguelmarco"
}
```

Fixed



---

archive/issue_comments_214116.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-10-06T15:40:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-214116",
    "user": "https://github.com/miguelmarco"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_214117.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-10-07T14:23:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-214117",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_214118.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-10-08T12:59:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16344#issuecomment-214118",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_048655.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-10-08T12:59:56Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16344",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16344#event-48655"
}
```
