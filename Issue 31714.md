# Issue 31714: Fix `..` ellipsis interference with REPL multiline input

Issue created by migration from https://trac.sagemath.org/ticket/31951

Original creator: slelievre

Original creation time: 2021-06-10 12:19:05

CC:  cremona @jcamp0x2a @kliem slelievre

Keywords: ellipsis, multiline, repl

Using ellipsis syntax `[a .. b]` or `(a .. b)`
interferes with multiline block continuation
in Sage REPL input.

For reference, after entering the first two lines
below and hitting enter, the prompt is extended
with an (auto-indented) third line, as expected:

```
sage: for n in range(4):
....:     m = 2*n
....:
```

and the input is evaluated only once the user
either manually unindents (e.g. with ctrl-A ctrl-K)
and hits enter, or hits enter twice.

By contrast, in all cases below, hitting enter
at the end of the second line evaluates the code
typed so far, preventing to type a third line:

```
sage: for n in (1 .. 3):
....:     m = 2*n
sage: for n in [0 .. 3]:
....:     m = 2*n
sage: for n in range(4):
....:     m = (2*n .. 3*n)
sage: for n in range(4):
....:     m = [2*n .. 3*n]
```


From an initial report by John Cremona on sage-support:

- [sage-support, 2021-03-22, having trouble entering multiline code](https://groups.google.com/g/sage-support/c/yOeV7UE5Djg)


---

Comment by @kliem created at 2021-09-16 08:41:32

Possibly related: `<>` creates the same problem, as in


```
sage: foo(L):
....:     K.<a> = L
sage
```


See #32523.


---

Comment by @kliem created at 2021-09-16 09:35:30

I guess all of our preparse customizations that are a syntax error in normal python have the same problem:


```
sage: implicit_multiplication(True)
sage: def foo():
....:     b = 2a
```



---

Comment by @kliem created at 2021-09-16 10:01:29

Further problems, not really serious, but it shows problems that one can run into:


```
sage: a = """
....: sage: Sagemath.
....: """
sage: a
'\nSagemath.\n'
```


The problem is that one needs to cleanup the syntax in `input_transformers_cleanup` instead of 
`input_transformers_post`.


---

Comment by @kliem created at 2021-09-16 14:16:56

New commits:


---

Comment by @kliem created at 2021-09-16 14:16:56

Changing status from new to needs_review.


---

Comment by git created at 2021-09-17 00:50:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2021-09-17 00:58:53

I made a few stylistic fixes. Feel free to revert any part if you think irrelevant.

The patch works well, looks good. 
One comment on the `syntax_only` argument: It is not clear what *Sage's special syntax* the argument is for. What is the criterion? Isn't this `R.0 -> R.gen(0)` Sage's special syntax?


---

Comment by @kliem created at 2021-09-17 06:30:28

`R.0` is fixed as well.

There is correct python syntax. Then ipython has some special syntax, like `%time`.
Then sage has some special syntax.

I would say that special syntax is anything, that gives a `SyntaxError` without modification. So replacing `2` by `Integer(2)` is not special syntax.
Replacing `2^3` by `2**3` is also not special syntax (and we need really to avoid doing it twice).

I don't know what is a better name for it, but this is really what the bug boils down to:

`IPython.input_transformer_manager.check_complete` checks the syntax as well, which means it must have access to all our special syntax rules.


---

Comment by klee created at 2021-09-17 09:30:33

Replying to [comment:8 gh-kliem]:
> I don't know what is a better name for it, but this is really what the bug boils down to:
> 
> `IPython.input_transformer_manager.check_complete` checks the syntax as well, which means it must have access to all our special syntax rules.

As I understands it, your code does (added) Sage syntax preparsing down in "token level"(`input_transformer_manager` level) keeping out problematic transforms indicated by `syntax_only`, and then does Sage syntax preparing second time after "token level". Am I right? 

Then wouldn't it be more safe and efficient to do the transforms (ellipsis and generators) that are necessary to kill the bug in the token level and leave the other transforms after that?


---

Comment by @kliem created at 2021-09-17 14:36:31

You are right. It would be better to cleanly seperate those two steps.

However, I can't figure it out. It's such a mess...


---

Comment by @kliem created at 2021-09-17 15:34:24

We could also clean this all up and do it more ipython style instead of string replacment.

This would simplify a lot of things. E.g. the tokens treat multiline strings as one line, without further interaction. They also treat implicit and explicit line continuation almost the same.

In this case I would try to replace the `preparse` function in the interactive shell and then as a last step replace preparse by the appropriate steps in ipython, so that loading a file `*.sage` is really the same thing as parsing it all in sage.


---

Comment by git created at 2021-09-20 07:27:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-09-23 10:59:01

I'm reworking the preparses to fix this.


---

Comment by @kliem created at 2021-09-23 10:59:01

Changing status from needs_review to needs_work.


---

Comment by @kliem created at 2021-09-24 06:41:41

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2021-09-24 06:41:41

The major changes are the following:

- Instead of worrying about `quote_state`, we require that all the lines are given at once into `preparse_multiple_lines`.
- We add `preparse_multiple_lines` to `cleanup_transformers`.
- We remove `preparse` from `input_transformers_post`.
- The following are now handled via token transformers instead:
  - Backslash division `B \ C`.
  - Generator construction `K.<a> = QuadraticField(2)`.
  - Calculus like function assigment `f(x) = (x + 1)`.

We add a couple of deprecations.
----
New commits:


---

Comment by git created at 2021-09-24 14:59:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-09-24 20:17:51

Replying to [comment:9 klee]:
> Replying to [comment:8 gh-kliem]:
> > I don't know what is a better name for it, but this is really what the bug boils down to:
> > 
> > `IPython.input_transformer_manager.check_complete` checks the syntax as well, which means it must have access to all our special syntax rules.
> 
> As I understands it, your code does (added) Sage syntax preparsing down in "token level"(`input_transformer_manager` level) keeping out problematic transforms indicated by `syntax_only`, and then does Sage syntax preparing second time after "token level". Am I right? 
> 
> Then wouldn't it be more safe and efficient to do the transforms (ellipsis and generators) that are necessary to kill the bug in the token level and leave the other transforms after that?

Thing is that almost all our changes affect the syntax and need to be done before `input_transformers_post`. We could do all of them just in `cleanup_transformers`, but that makes it difficult resolving things like #30953.


---

Comment by klee created at 2021-09-27 04:07:58

New commits:


---

Comment by klee created at 2021-09-27 04:28:26

I made some commits based on your latest work.

My main concern with your work was that it introduced some nontrivial regressions regarding `.sage` files (not working `time` and `load/attach` in file, for instance) by deprecating old `preparse` stuffs. My commits recover regressions.

It works well for me. I am positive on your work. But I think the patch still needs extensive tests.


---

Comment by git created at 2021-09-27 04:34:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2021-09-27 06:21:37

Question:

You deprecated `InterfaceShellTransformer` and `interface_shell_embed`. I don't understand these stuffs well, and have concerns whether deprecating them is safe. Would you explain?


---

Comment by @kliem created at 2021-09-27 10:42:47

Replying to [comment:21 klee]:
> Question:
> 
> You deprecated `InterfaceShellTransformer` and `interface_shell_embed`. I don't understand these stuffs well, and have concerns whether deprecating them is safe. Would you explain?

I have no idea what this is used for or who uses it. It should definitely undergo questions in sage-devel, whether this can be deprecated or whether this needs to be adapted.


---

Comment by @kliem created at 2021-09-27 10:48:56

Replying to [comment:18 klee]:
> I made some commits based on your latest work.
> 
> My main concern with your work was that it introduced some nontrivial regressions regarding `.sage` files (not working `time` and `load/attach` in file, for instance) by deprecating old `preparse` stuffs. My commits recover regressions.
> 
> It works well for me. I am positive on your work. But I think the patch still needs extensive tests.

Instead of doing the token now, we could also leave them for #30953. This should make this ticket here easier.

`time` is working in `.sage`. What isn't working anymore is automagic. But automagic isn't meant for multiline things and thus is really a strange concept for files. Line- and cell-magic should be working just fine. (Cell-magic is also a bit strange, as it cannot be exited.) Line-magic wasn't working before in `.sage`-files.

But yes, this is a regression.


---

Comment by klee created at 2021-09-27 12:38:10

Replying to [comment:22 gh-kliem]:
> Replying to [comment:21 klee]:
> > Question:
> > 
> > You deprecated `InterfaceShellTransformer` and `interface_shell_embed`. I don't understand these stuffs well, and have concerns whether deprecating them is safe. Would you explain?
> 
> I have no idea what this is used for or who uses it. 

If so and if they do not do any harm, I think it is safe to leave them intact.


---

Comment by klee created at 2021-09-27 12:52:13

Replying to [comment:23 gh-kliem]:
 
> `time` is working in `.sage`. 

Yes, now. It stopped working with your patch.

> What isn't working anymore is automagic. But automagic isn't meant for multiline things and thus is really a strange concept for files. Line- and cell-magic should be working just fine. (Cell-magic is also a bit strange, as it cannot be exited.) Line-magic wasn't working before in `.sage`-files.

I think any of those magic things is not for `.sage` files. Even though any one works by accident, we don't need to support it.


---

Comment by klee created at 2021-09-27 12:56:56

Replying to [comment:23 gh-kliem]:

> Instead of doing the token now, we could also leave them for #30953. This should make this ticket here easier.

#30953 is fixed by the patch here both on command line and in `.sage` file. We can just close #30953 after the present ticket.


---

Comment by klee created at 2021-09-27 13:10:23

Replying to [comment:23 gh-kliem]:
> > My main concern with your work was that it introduced some nontrivial regressions regarding `.sage` files (not working `time` and `load/attach` in file, for instance) by deprecating old `preparse` stuffs. My commits recover regressions.

`time` and `load/attach` are Sage things for `.sage` files. They are not ipython magics.


---

Comment by klee created at 2021-09-27 13:20:11

Replying to [comment:11 gh-kliem]:
> ... so that loading a file `*.sage` is really the same thing as parsing it all in sage.

We should not pursue this. Loading a `.sage` file needs not be the same thing as typing them in Sage command line. Indeed, code for loading a `.sage` file does some clever things to speed up running the code in the file, which are not done on command line.


---

Comment by @kliem created at 2021-09-27 13:45:39

Sorry for taking your time. I didn't realize until now, that I didn't change the branch yet to the new approach. Hence my comments didn't make a lot of sense to you.


---

Comment by git created at 2021-09-27 13:50:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-09-27 14:21:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-09-27 14:33:05

Fixing #30953 seperate from this ticket, will not work without extra work, as the following doctest already assumes that ipythons preparse detected the implicit line continuation:


```
        sage: preparse("a \\ b \\") # There is really only one backslash here, it is just being escaped.
        'a  * BackslashOperator() * b \\'
```


```
        sage: preparse('''
        ....: f(a,
        ....:   b,
        ....:   c,
        ....:   d) = a + b*2 + c*3 + d*4
        ....: ''')
        '__tmp__ = var("a,b,c,d"); __tmpf__ = a + b*Integer(2) + c*Integer(3) + d*Integer(4); f = symbolic_expression(__tmpf__).function(a,b,c,d)\n'
```


So, I would argue that it makes sense to introduce the following classes during this ticket:
- `SageBackslashTransformer`,
- `SageGenConstructionTransformer`,
- `SageCalculusTransformer`.


---

Comment by @kliem created at 2021-09-27 14:39:07

Automagic could be fixed by a replacement as follows:

Replace `time -2` by
`sage_eval("%time -2", globals()) if 'time' not in globals() else sage_eval("time -2", globals())`

Does this sound plausible? Do this for every magic keyword.


---

Comment by @kliem created at 2021-09-27 19:44:32

Sorry about the mess.

This is a much simpler fix. It just creates a second input manager that does Sage's preparsing to check correctness of Sage's syntax. It does not behave as desired with magics, e.g.

```
sage: ip = get_ipython()
sage: ip._check_complete_transformer.transform_cell("%time 8^^1")
"get_ipython().run_line_magic('time', 'Integer(8)^Integer(1)')\n"
```

which means it would preparse things after `%time` twice, but it's sole purpose is to check the correctness of syntax, for which it works just fine.

With the new approach I would like the following follow ups:
- close #4545 with a doctest
- have preparse and preparse_file call `ip.transform_cell`, which means the code will behave exactly as if parsed into the interactive shell (move the code from preparse to a helper function then)
- #30953: do generator construction and calculus like assignment with token transformation
----
New commits:


---

Comment by klee created at 2021-09-27 19:52:31

Replying to [comment:30 gh-kliem]:
> Sorry for taking your time. I didn't realize until now, that I didn't change the branch yet to the new approach. Hence my comments didn't make a lot of sense to you.

What is a mess seems our miscommunication :-)

Yes, you did push your new approach! It fixed a lot of things, and I was happy with that.


---

Comment by klee created at 2021-09-27 19:58:21

Replying to [comment:33 gh-kliem]:
> Fixing #30953 seperate from this ticket, will not work without extra work, as the following doctest already assumes that ipythons preparse detected the implicit line continuation:
> 
> {{{
>         sage: preparse("a \\ b \\") # There is really only one backslash here, it is just being escaped.
>         'a  * BackslashOperator() * b \\'
> }}}
> {{{
>         sage: preparse('''
>         ....: f(a,
>         ....:   b,
>         ....:   c,
>         ....:   d) = a + b*2 + c*3 + d*4
>         ....: ''')
>         '__tmp__ = var("a,b,c,d"); __tmpf__ = a + b*Integer(2) + c*Integer(3) + d*Integer(4); f = symbolic_expression(__tmpf__).function(a,b,c,d)\n'
> }}}
> 
> So, I would argue that it makes sense to introduce the following classes during this ticket:
> - `SageBackslashTransformer`,
> - `SageGenConstructionTransformer`,
> - `SageCalculusTransformer`.

You did introduce these classes in the branch of new approach. Your branch fixed the things above. Then I started working on your branch (with those new classes) because there were regressions in loading `.sage` files.


---

Comment by klee created at 2021-09-27 20:07:58

Then let's straight out our communication first.

(1) You pushed `public/31951-new` with the new approach.
(2) Then I worked on your branch to fix regressions in loading `.sage` files, and then pushed my branch to `public/31951`. I think this is a mistake. I should have named it `public/31951-new-new` or something.

So now the branch (`public/31951-new2) uploaded to this ticket wiped out both of our works!

Could I upload my branch again with name `public/31951-new3`? Then we can start discussing with the magics, in which there is a miscommunication as well...


---

Comment by klee created at 2021-09-27 20:16:44

My branch refactored your new approach and fixed every bugs and regressions (as far as I am concerned) both on command line and in `.sage` files.


---

Comment by @kliem created at 2021-09-27 21:05:45

Changing the branch, does not wipe out the work. Indeed I got confused with your branch name. I only saw you last commit and thought I never changed the branch name.


---

Comment by @kliem created at 2021-09-27 21:06:19

Your branch `public/31951` is still intact.


---

Comment by @kliem created at 2021-09-27 21:40:37

It all depends on what we want. The branch `public/31951-new2` is a minimalistic fix to the reported bug. As far as I see, it does not have regressions. So I would propose closing the current ticket with this fix and provide a quick fix to users.

We can move the previous work to a new ticket (or new tickets). However, I realized that our approach does not work well with automagic, e.g.

`time 8^1` and `time 8^^1` should be equivalent to `%time 8^1` resp. `%time 8^^1`, but I did not accomplish this. Did you?

There are a number of phases that the transformation undergoes:

1. `get_ipython().input_transformer_manager.cleanup_transforms`: Things like cleaning the prompt as I suggested.
2. `get_ipython().input_transformer_manager.token_transformers`: Things like IPythons line magic.
3. `get_ipython().prefilter_manager`: Things like IPythons automagic.
4. `get_ipython().input_transformers_post`: Currently Sage's `preparse`.
5. `ip.ast_transformers` (Optional additional changes).

Anything that you enter undergoes all 5 steps. However, when checking whether multi-line input is complete, only the first two steps are checked. It makes sense to execute our preparser at step 4, so it works nicely with automagic. It should be executed at step 2 or later to work nicely with (non-auto) magic.

My latest solution to this ticket is to leave Sage's preparser at step 4, but overwrite `check_complete` with the method from a different input manager that applies Sage's preparser at step 1. Things will be modified before checking whether this is magic, but this should not bother us.

I quickly scanned your fixes and I think they make sense. When executing a file, it should behave exactly as when typed into the shell, so this could be done via `ipython_preparse` or similar (which calls `get_ipython().transform_cell()` (steps 1 and 2) and not `get_ipython().input_transformer_manager().transform()` (steps 1 to 4).

If you agree, you could put your branch on #30953 and we leave the minimalistic fix here. Because of the problems with automagic, I think sage's preparsing should stay at step 4 however (except for checking completeness).


---

Comment by klee created at 2021-09-28 02:27:34

Replying to [comment:42 gh-kliem]:

Thanks for the detailed explanation. I only guessed the process.

> It all depends on what we want. The branch `public/31951-new2` is a minimalistic fix to the reported bug. As far as I see, it does not have regressions. So I would propose closing the current ticket with this fix and provide a quick fix to users.

Anyway we are too late to provide a "quick fix".
 
> We can move the previous work to a new ticket (or new tickets). However, I realized that our approach does not work well with automagic, e.g.
> 
> `time 8^1` and `time 8^^1` should be equivalent to `%time 8^1` resp. `%time 8^^1`, but I did not accomplish this. Did you?

No. I didn't know that. There is no other problem with our approach except this one.

I investigated this. The reason is that ipython applies `cleanup_transforms` **several** times to the input string for automagic. Hence `time 8^^1` becomes `time 8^1` and again `time 8**1`.

So the solution is to make this code

```
    # Use ^ for exponentiation and ^^ for xor
    # (A side effect is that **** becomes xor as well.)
    L = L.replace('^', '**').replace('****', '^')  
```

also to a token transformer(named perhaps `SageCaretTransformer` or `SageExponentiationTransformer`?).

With another token transformer, our approach(my branch containing your work) fixes all problems.

> If you agree, you could put your branch on #30953 and we leave the minimalistic fix here. Because of the problems with automagic, I think sage's preparsing should stay at step 4 however (except for checking completeness).

As I said above, we can provide one branch solving this ticket and #30953 (and #4545?). All these tickets are just different manifestations of a single problem. Then why separate the solution?


---

Comment by klee created at 2021-09-28 02:32:25

> So the solution is to make this code
> {{{
>     # Use ^ for exponentiation and ^^ for xor
>     # (A side effect is that **** becomes xor as well.)
>     L = L.replace('^', '**').replace('****', '^')  
> }}}
> also to a token transformer(named perhaps `SageCaretTransformer` or `SageExponentiationTransformer`?).

Or we can replace the code with another *idempotent* code with some regex juggling.

I can try to code the necessary token transformer, but I think you can do it quicker than me.


---

Comment by @kliem created at 2021-09-28 06:22:33

No, just making it idempotent is not enough.


```
sage: runfile /tmp/2.sage
Traceback (most recent call last)
...
OSError: did not find file '/tmp/Integer(2).sage' to load or attach
```


Instead of trying to find a workaround for all these problems, we could just leave our preparsing at step 4 and just modify `check_complete`. Even the backslash transformation is probably best left for step 4.

Now there is a different idea I just had: The current ticket works well with everything except for automagic, which only applies for single-line inputs. In contrast, all our problems only apply for multi-line input. So we could do our replacements at step 1 and 2 for multi-line input and leave it for step 4 for single-line input. This should also work.


---

Comment by klee created at 2021-09-28 07:16:58

Replying to [comment:45 gh-kliem]:
> No, just making it idempotent is not enough.
> 
> {{{
> sage: runfile /tmp/2.sage
> Traceback (most recent call last)
> ...
> OSError: did not find file '/tmp/Integer(2).sage' to load or attach
> }}}
> 
> Instead of trying to find a workaround for all these problems, we could just leave our preparsing at step 4 and just modify `check_complete`. Even the backslash transformation is probably best left for step 4.

Okay. Now I am persuaded. 
 
> Now there is a different idea I just had: The current ticket works well with everything except for automagic, which only applies for single-line inputs. In contrast, all our problems only apply for multi-line input. So we could do our replacements at step 1 and 2 for multi-line input and leave it for step 4 for single-line input. This should also work.

Your current patch works really well. What about automagic is not working? Your previous example `time 8^^1` works well.


---

Comment by klee created at 2021-09-28 07:20:13

Ah. Your current patch does not fix #30953...


---

Comment by @kliem created at 2021-09-28 07:28:46


```
sage: %time 8^^1
CPU times: user 17 µs, sys: 2 µs, total: 19 µs
Wall time: 25.3 µs
9
sage: time 8^^1
CPU times: user 33 µs, sys: 3 µs, total: 36 µs
Wall time: 49.8 µs
8
sage: 8^^1
9
```


Not working. The problem is that `8^^1` is preparsed twice. Automagic is hard to detect and depends in fact on whether a variable of a specific name is defined.

At the moment I really see two ways of doing it:
- Have an artificial input manager for `check_complete`.
- Do the preparsing in steps 1 and 2 except for single-lines, when we keep doing the preparsing at step 4.


---

Comment by klee created at 2021-09-28 09:11:43

By combining your current branch (that use artificial input manager for `check_complete`) with my branch, I think I managed to fix automagic problem. The code is still a mess with lots of doctest errors, but all of them seem fixable.

A question: It seems that `ip.input_transformer_manager.transform_cell(...)` does not apply `input_transformers_post`. Am I right? Because of this, now I have lots of doctest errors like 

```
File "src/sage/repl/interpreter.py", line 635, in sage.repl.interpreter.SageBackslashTransformer
Failed example:
    ip.input_transformer_manager.transform_cell(r'''
    a = (2, 3, \
         4)''')
Expected:
    'a = (Integer(2), Integer(3), \\\n     Integer(4))\n'
Got:
    'a = (2, 3, \\\n     4)\n'
```


Otherwise all seems work well. Let me have some time to tidy up the code.


---

Comment by klee created at 2021-09-28 11:47:28

I am ready to upload the combined branch, which works well for all problems which we discussed.

I think it is okay to upload the branch here as it combines the current branch.


---

Comment by klee created at 2021-09-28 11:48:58

The branch name is again "public/31951".
----
New commits:


---

Comment by git created at 2021-09-28 12:01:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-09-28 12:35:15

`quote_state` needs not to be a global in `interpreter.py`.

The problem here is that automagic will still have the 3 token replacement. I'm not on your new branch, but you will see a failure similar to

```
sage: ls | grep \f
/bin/bash: -c: line 0: syntax error near unexpected token `('
/bin/bash: -c: line 0: `ls -F --color | grep * BackslashOperator() * f'
```


On develop this works just fine.

So the token replacements should not be applied in case of single lines, but then need to be added to `SagePreparseTransformer` again (to be applied to single lines). We could also remove the backslash token and put it back into `SagePreparseTransformer`, but this wouldn't fix the following:

Now:

```
sage: del maxima
sage: maxima f(x)=2
__tmp__=var("x")
```


Before:

```
sage: del maxima
sage: maxima f(x)=2
f(x)=2
```



---

Comment by klee created at 2021-09-28 13:06:50

Replying to [comment:53 gh-kliem]:

> The problem here is that automagic will still have the 3 token replacement. I'm not on your new branch, but you will see a failure similar to
> {{{
> sage: ls | grep \f
> /bin/bash: -c: line 0: syntax error near unexpected token `('
> /bin/bash: -c: line 0: `ls -F --color | grep * BackslashOperator() * f'
> }}}
> 
> On develop this works just fine.
> 
> So the token replacements should not be applied in case of single lines, but then need to be added to `SagePreparseTransformer` again (to be applied to single lines). We could also remove the backslash token and put it back into `SagePreparseTransformer`, but this wouldn't fix the following:
> 
> Now:
> {{{
> sage: del maxima
> sage: maxima f(x)=2
> __tmp__=var("x")
> }}}
> 
> Before:
> {{{
> sage: del maxima
> sage: maxima f(x)=2
> f(x)=2
> }}}

These works fine with the branch, fortunately.

> `quote_state` needs not to be a global in `interpreter.py`.

Would you fix this while you examine the new branch?


---

Comment by klee created at 2021-09-28 13:12:10

Let me remind you that the new branch is based on sage beta 9.5.beta2.


---

Comment by @kliem created at 2021-09-28 13:33:46

Replying to [comment:54 klee]:
> Replying to [comment:53 gh-kliem]:
> 
> > The problem here is that automagic will still have the 3 token replacement. I'm not on your new branch, but you will see a failure similar to
> > {{{
> > sage: ls | grep \f
> > /bin/bash: -c: line 0: syntax error near unexpected token `('
> > /bin/bash: -c: line 0: `ls -F --color | grep * BackslashOperator() * f'
> > }}}
> > 
> > On develop this works just fine.
> > 
> > So the token replacements should not be applied in case of single lines, but then need to be added to `SagePreparseTransformer` again (to be applied to single lines). We could also remove the backslash token and put it back into `SagePreparseTransformer`, but this wouldn't fix the following:
> > 
> > Now:
> > {{{
> > sage: del maxima
> > sage: maxima f(x)=2
> > __tmp__=var("x")
> > }}}
> > 
> > Before:
> > {{{
> > sage: del maxima
> > sage: maxima f(x)=2
> > f(x)=2
> > }}}
> 
> These works fine with the branch, fortunately.
Well, because `SageTokenTransformers` are never added to the token transformers. So they don't do anything.
> 
> > `quote_state` needs not to be a global in `interpreter.py`.
> 
> Would you fix this while you examine the new branch?

Yes.


---

Comment by git created at 2021-09-28 14:23:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-09-28 14:31:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-09-28 14:49:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-09-28 14:55:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-09-28 15:01:21

Let me know, what you think about the changes.

If we do it like this then `preparse_calculus` and `preparse_generators` should be deprecated.

As a follow up ticket we could try to have magics in `preparse_file`, when it is preparsed within ipython.


---

Comment by @kliem created at 2021-09-28 15:01:59

Also closing #4545 could really happen in #4545, as it has nothing to do with our changes. Apparently the problem just went away.


---

Comment by git created at 2021-09-28 16:01:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2021-09-28 16:07:55

Replying to [comment:61 gh-kliem]:
> Let me know, what you think about the changes.

Looks good.One thing: I am not sure about ``@`parallel`. Is it already deprecated?

> If we do it like this then `preparse_calculus` and `preparse_generators` should be deprecated.

Then let them be deprecated. I made a commit for this.

> As a follow up ticket we could try to have magics in `preparse_file`, when it is preparsed within ipython.

I have no passion for magics in `.sage` files. But of course you can go ahead.


---

Comment by klee created at 2021-09-28 16:12:22

Replying to [comment:62 gh-kliem]:
> Also closing #4545 could really happen in #4545, as it has nothing to do with our changes. Apparently the problem just went away.

Okay with ``@`parallel`.


---

Comment by klee created at 2021-09-28 16:17:07

I am positive on the patch.

You can set it positive if you are okay too.


---

Comment by git created at 2021-09-29 09:00:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-09-29 09:56:43

From my side this is ok, I would probably wait for a patchbot.


---

Comment by git created at 2021-09-30 03:27:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-09-30 07:26:23

This approach has a serious problem though:

https://patchbot.sagemath.org/log/31951/Linux/1_SMP_Debian_5.10.46-5_(2021-09-23)/x86_64/5.10.0-8-amd64/tmonteil-lxc1/2021-09-30%2006:22:01?plugin=startup_modules&diff=/log/0/Linux/1_SMP_Debian_5.10.46-5_%282021-09-23%29/x86_64/5.10.0-8-amd64/tmonteil-lxc1/2021-09-29%2014%3A23%3A05&ticket=31951&base=9.5.beta2

What I understand from this is that now `IPython` is being loaded, even when just running sage from command line, which is new. I have no idea if this is acceptable.


---

Comment by klee created at 2021-09-30 08:02:15

Replying to [comment:70 gh-kliem]:
> This approach has a serious problem though:
> 
> https://patchbot.sagemath.org/log/31951/Linux/1_SMP_Debian_5.10.46-5_(2021-09-23)/x86_64/5.10.0-8-amd64/tmonteil-lxc1/2021-09-30%2006:22:01?plugin=startup_modules&diff=/log/0/Linux/1_SMP_Debian_5.10.46-5_%282021-09-23%29/x86_64/5.10.0-8-amd64/tmonteil-lxc1/2021-09-29%2014%3A23%3A05&ticket=31951&base=9.5.beta2
> 
> What I understand from this is that now `IPython` is being loaded, even when just running sage from command line, which is new. I have no idea if this is acceptable.

It is serious and not acceptable. Let's see if there's an escape.


---

Comment by @kliem created at 2021-09-30 08:34:04

Yes, I think so. The solution to #30953 is apparently super easy:


```
-    L = ';%s;' % L.replace('\n', ';\n;')
+    replacements = []
+    counta = 0
+    countb = 0
+    for i in range(len(L)):
+        if L[i] == '[':
+            counta += 1
+        elif L[i] == '(':
+            countb += 1
+        elif L[i] == ']':
+            counta -= 1
+        elif L[i] == ')':
+            countb -= 1
+        elif L[i] == '\n':
+            if counta == countb == 0:
+                replacements.append(i)
+    while replacements:
+        i = replacements.pop()
+        L = L[:i] + ';\n;' + L[i+1:]
+    L = ';' + L
+    if not L[-1:] == ';':
+        L += ';'
```


I'll push changes, once I tested it (and we can always reset, if we don't like it).


---

Comment by git created at 2021-09-30 09:28:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-09-30 09:31:08

Sorry about the mess. This apparently works just with some slight changes in comparison to develop.


---

Comment by klee created at 2021-09-30 09:57:16

Why don't we try just to fix the last branch? 

It seems that `IPython` is imported only with 9.5.beta2 + last branch (I mean not with 9.5.beta1). Do you understand how this happen? Is it not surmountable with the approach of the last branch?


---

Comment by @kliem created at 2021-09-30 11:12:03

`IPython` is surely imported whenever you parse something. Because the token transformer needs IPython.

Whenevern you run

`sage -c "print('hello')` or similar, this will call `preparse`, which imports whatever it needs to run. In our case we added the dependency to `IPython`.

Now the new fix just slightly modified the develop branch to obtain the same output, so I don't know why to use tokens, if a slight modification works just as well.


---

Comment by git created at 2021-09-30 12:21:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2021-09-30 12:28:20

Replying to [comment:76 gh-kliem]:
> `IPython` is surely imported whenever you parse something. Because the token transformer needs IPython.
> 
> Whenevern you run
> 
> `sage -c "print('hello')` or similar, this will call `preparse`, which imports whatever it needs to run. In our case we added the dependency to `IPython`.

I see.

> Now the new fix just slightly modified the develop branch to obtain the same output, so I don't know why to use tokens, if a slight modification works just as well.

Okay. I agree that the simpler, the better.

All seem work well with me. Let's wait for a green bot.


---

Comment by klee created at 2021-10-01 02:39:48

I think the slight increase of the startup time is acceptable. I cannot clearly explain the increase, but I guess this is caused by increasing time of parsing Sage startup scripts.

Otherwise I am positive with the new simpler fix.


---

Comment by @kliem created at 2021-10-01 06:32:38

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2021-10-01 06:32:38

Ok, let's move on.


---

Comment by vbraun created at 2021-10-09 11:10:08

Resolution: fixed
