# Issue 31714: Fix `..` ellipsis interference with REPL multiline input

archive/issues_031714.json:
```json
{
    "body": "CC:  @JohnCremona @jcamp0x2a @kliem @slel\n\nKeywords: ellipsis, multiline, repl\n\nUsing ellipsis syntax `[a .. b]` or `(a .. b)`\ninterferes with multiline block continuation\nin Sage REPL input.\n\nFor reference, after entering the first two lines\nbelow and hitting enter, the prompt is extended\nwith an (auto-indented) third line, as expected:\n\n```\nsage: for n in range(4):\n....:     m = 2*n\n....:\n```\n\nand the input is evaluated only once the user\neither manually unindents (e.g. with ctrl-A ctrl-K)\nand hits enter, or hits enter twice.\n\nBy contrast, in all cases below, hitting enter\nat the end of the second line evaluates the code\ntyped so far, preventing to type a third line:\n\n```\nsage: for n in (1 .. 3):\n....:     m = 2*n\nsage: for n in [0 .. 3]:\n....:     m = 2*n\nsage: for n in range(4):\n....:     m = (2*n .. 3*n)\nsage: for n in range(4):\n....:     m = [2*n .. 3*n]\n```\n\n\nFrom an initial report by John Cremona on sage-support:\n\n- [sage-support, 2021-03-22, having trouble entering multiline code](https://groups.google.com/g/sage-support/c/yOeV7UE5Djg)\n\nIssue created by migration from https://trac.sagemath.org/ticket/31951\n\n",
    "created_at": "2021-06-10T12:19:05Z",
    "labels": [
        "component: user interface",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Fix `..` ellipsis interference with REPL multiline input",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31714",
    "user": "https://github.com/slel"
}
```
CC:  @JohnCremona @jcamp0x2a @kliem @slel

Keywords: ellipsis, multiline, repl

Using ellipsis syntax `[a .. b]` or `(a .. b)`
interferes with multiline block continuation
in Sage REPL input.

For reference, after entering the first two lines
below and hitting enter, the prompt is extended
with an (auto-indented) third line, as expected:

```
sage: for n in range(4):
....:     m = 2*n
....:
```

and the input is evaluated only once the user
either manually unindents (e.g. with ctrl-A ctrl-K)
and hits enter, or hits enter twice.

By contrast, in all cases below, hitting enter
at the end of the second line evaluates the code
typed so far, preventing to type a third line:

```
sage: for n in (1 .. 3):
....:     m = 2*n
sage: for n in [0 .. 3]:
....:     m = 2*n
sage: for n in range(4):
....:     m = (2*n .. 3*n)
sage: for n in range(4):
....:     m = [2*n .. 3*n]
```


From an initial report by John Cremona on sage-support:

- [sage-support, 2021-03-22, having trouble entering multiline code](https://groups.google.com/g/sage-support/c/yOeV7UE5Djg)

Issue created by migration from https://trac.sagemath.org/ticket/31951





---

archive/issue_comments_452623.json:
```json
{
    "body": "Possibly related: `<>` creates the same problem, as in\n\n\n```\nsage: foo(L):\n....:     K.<a> = L\nsage\n```\n\n\nSee #32523.",
    "created_at": "2021-09-16T08:41:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452623",
    "user": "https://github.com/kliem"
}
```

Possibly related: `<>` creates the same problem, as in


```
sage: foo(L):
....:     K.<a> = L
sage
```


See #32523.



---

archive/issue_comments_452624.json:
```json
{
    "body": "I guess all of our preparse customizations that are a syntax error in normal python have the same problem:\n\n\n```\nsage: implicit_multiplication(True)\nsage: def foo():\n....:     b = 2a\n```\n",
    "created_at": "2021-09-16T09:35:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452624",
    "user": "https://github.com/kliem"
}
```

I guess all of our preparse customizations that are a syntax error in normal python have the same problem:


```
sage: implicit_multiplication(True)
sage: def foo():
....:     b = 2a
```




---

archive/issue_comments_452625.json:
```json
{
    "body": "Further problems, not really serious, but it shows problems that one can run into:\n\n\n```\nsage: a = \"\"\"\n....: sage: Sagemath.\n....: \"\"\"\nsage: a\n'\\nSagemath.\\n'\n```\n\n\nThe problem is that one needs to cleanup the syntax in `input_transformers_cleanup` instead of \n`input_transformers_post`.",
    "created_at": "2021-09-16T10:01:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452625",
    "user": "https://github.com/kliem"
}
```

Further problems, not really serious, but it shows problems that one can run into:


```
sage: a = """
....: sage: Sagemath.
....: """
sage: a
'\nSagemath.\n'
```


The problem is that one needs to cleanup the syntax in `input_transformers_cleanup` instead of 
`input_transformers_post`.



---

archive/issue_comments_452626.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-09-16T14:16:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452626",
    "user": "https://github.com/kliem"
}
```

New commits:



---

archive/issue_comments_452627.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-09-16T14:16:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452627",
    "user": "https://github.com/kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_452628.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-17T00:50:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452628",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452629.json:
```json
{
    "body": "I made a few stylistic fixes. Feel free to revert any part if you think irrelevant.\n\nThe patch works well, looks good. \nOne comment on the `syntax_only` argument: It is not clear what *Sage's special syntax* the argument is for. What is the criterion? Isn't this `R.0 -> R.gen(0)` Sage's special syntax?",
    "created_at": "2021-09-17T00:58:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452629",
    "user": "https://github.com/kwankyu"
}
```

I made a few stylistic fixes. Feel free to revert any part if you think irrelevant.

The patch works well, looks good. 
One comment on the `syntax_only` argument: It is not clear what *Sage's special syntax* the argument is for. What is the criterion? Isn't this `R.0 -> R.gen(0)` Sage's special syntax?



---

archive/issue_comments_452630.json:
```json
{
    "body": "`R.0` is fixed as well.\n\nThere is correct python syntax. Then ipython has some special syntax, like `%time`.\nThen sage has some special syntax.\n\nI would say that special syntax is anything, that gives a `SyntaxError` without modification. So replacing `2` by `Integer(2)` is not special syntax.\nReplacing `2^3` by `2**3` is also not special syntax (and we need really to avoid doing it twice).\n\nI don't know what is a better name for it, but this is really what the bug boils down to:\n\n`IPython.input_transformer_manager.check_complete` checks the syntax as well, which means it must have access to all our special syntax rules.",
    "created_at": "2021-09-17T06:30:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452630",
    "user": "https://github.com/kliem"
}
```

`R.0` is fixed as well.

There is correct python syntax. Then ipython has some special syntax, like `%time`.
Then sage has some special syntax.

I would say that special syntax is anything, that gives a `SyntaxError` without modification. So replacing `2` by `Integer(2)` is not special syntax.
Replacing `2^3` by `2**3` is also not special syntax (and we need really to avoid doing it twice).

I don't know what is a better name for it, but this is really what the bug boils down to:

`IPython.input_transformer_manager.check_complete` checks the syntax as well, which means it must have access to all our special syntax rules.



---

archive/issue_comments_452631.json:
```json
{
    "body": "Replying to [comment:8 gh-kliem]:\n> I don't know what is a better name for it, but this is really what the bug boils down to:\n> \n> `IPython.input_transformer_manager.check_complete` checks the syntax as well, which means it must have access to all our special syntax rules.\n\nAs I understands it, your code does (added) Sage syntax preparsing down in \"token level\"(`input_transformer_manager` level) keeping out problematic transforms indicated by `syntax_only`, and then does Sage syntax preparing second time after \"token level\". Am I right? \n\nThen wouldn't it be more safe and efficient to do the transforms (ellipsis and generators) that are necessary to kill the bug in the token level and leave the other transforms after that?",
    "created_at": "2021-09-17T09:30:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452631",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:8 gh-kliem]:
> I don't know what is a better name for it, but this is really what the bug boils down to:
> 
> `IPython.input_transformer_manager.check_complete` checks the syntax as well, which means it must have access to all our special syntax rules.

As I understands it, your code does (added) Sage syntax preparsing down in "token level"(`input_transformer_manager` level) keeping out problematic transforms indicated by `syntax_only`, and then does Sage syntax preparing second time after "token level". Am I right? 

Then wouldn't it be more safe and efficient to do the transforms (ellipsis and generators) that are necessary to kill the bug in the token level and leave the other transforms after that?



---

archive/issue_comments_452632.json:
```json
{
    "body": "You are right. It would be better to cleanly seperate those two steps.\n\nHowever, I can't figure it out. It's such a mess...",
    "created_at": "2021-09-17T14:36:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452632",
    "user": "https://github.com/kliem"
}
```

You are right. It would be better to cleanly seperate those two steps.

However, I can't figure it out. It's such a mess...



---

archive/issue_comments_452633.json:
```json
{
    "body": "We could also clean this all up and do it more ipython style instead of string replacment.\n\nThis would simplify a lot of things. E.g. the tokens treat multiline strings as one line, without further interaction. They also treat implicit and explicit line continuation almost the same.\n\nIn this case I would try to replace the `preparse` function in the interactive shell and then as a last step replace preparse by the appropriate steps in ipython, so that loading a file `*.sage` is really the same thing as parsing it all in sage.",
    "created_at": "2021-09-17T15:34:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452633",
    "user": "https://github.com/kliem"
}
```

We could also clean this all up and do it more ipython style instead of string replacment.

This would simplify a lot of things. E.g. the tokens treat multiline strings as one line, without further interaction. They also treat implicit and explicit line continuation almost the same.

In this case I would try to replace the `preparse` function in the interactive shell and then as a last step replace preparse by the appropriate steps in ipython, so that loading a file `*.sage` is really the same thing as parsing it all in sage.



---

archive/issue_comments_452634.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-20T07:27:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452634",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452635.json:
```json
{
    "body": "I'm reworking the preparses to fix this.",
    "created_at": "2021-09-23T10:59:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452635",
    "user": "https://github.com/kliem"
}
```

I'm reworking the preparses to fix this.



---

archive/issue_comments_452636.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-09-23T10:59:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452636",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_452637.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-09-24T06:41:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452637",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_452638.json:
```json
{
    "body": "The major changes are the following:\n\n- Instead of worrying about `quote_state`, we require that all the lines are given at once into `preparse_multiple_lines`.\n- We add `preparse_multiple_lines` to `cleanup_transformers`.\n- We remove `preparse` from `input_transformers_post`.\n- The following are now handled via token transformers instead:\n  - Backslash division `B \\ C`.\n  - Generator construction `K.<a> = QuadraticField(2)`.\n  - Calculus like function assigment `f(x) = (x + 1)`.\n\nWe add a couple of deprecations.\n----\nNew commits:",
    "created_at": "2021-09-24T06:41:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452638",
    "user": "https://github.com/kliem"
}
```

The major changes are the following:

- Instead of worrying about `quote_state`, we require that all the lines are given at once into `preparse_multiple_lines`.
- We add `preparse_multiple_lines` to `cleanup_transformers`.
- We remove `preparse` from `input_transformers_post`.
- The following are now handled via token transformers instead:
  - Backslash division `B \ C`.
  - Generator construction `K.<a> = QuadraticField(2)`.
  - Calculus like function assigment `f(x) = (x + 1)`.

We add a couple of deprecations.
----
New commits:



---

archive/issue_comments_452639.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-24T14:59:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452639",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452640.json:
```json
{
    "body": "Replying to [comment:9 klee]:\n> Replying to [comment:8 gh-kliem]:\n> > I don't know what is a better name for it, but this is really what the bug boils down to:\n> > \n> > `IPython.input_transformer_manager.check_complete` checks the syntax as well, which means it must have access to all our special syntax rules.\n> \n> As I understands it, your code does (added) Sage syntax preparsing down in \"token level\"(`input_transformer_manager` level) keeping out problematic transforms indicated by `syntax_only`, and then does Sage syntax preparing second time after \"token level\". Am I right? \n> \n> Then wouldn't it be more safe and efficient to do the transforms (ellipsis and generators) that are necessary to kill the bug in the token level and leave the other transforms after that?\n\nThing is that almost all our changes affect the syntax and need to be done before `input_transformers_post`. We could do all of them just in `cleanup_transformers`, but that makes it difficult resolving things like #30953.",
    "created_at": "2021-09-24T20:17:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452640",
    "user": "https://github.com/kliem"
}
```

Replying to [comment:9 klee]:
> Replying to [comment:8 gh-kliem]:
> > I don't know what is a better name for it, but this is really what the bug boils down to:
> > 
> > `IPython.input_transformer_manager.check_complete` checks the syntax as well, which means it must have access to all our special syntax rules.
> 
> As I understands it, your code does (added) Sage syntax preparsing down in "token level"(`input_transformer_manager` level) keeping out problematic transforms indicated by `syntax_only`, and then does Sage syntax preparing second time after "token level". Am I right? 
> 
> Then wouldn't it be more safe and efficient to do the transforms (ellipsis and generators) that are necessary to kill the bug in the token level and leave the other transforms after that?

Thing is that almost all our changes affect the syntax and need to be done before `input_transformers_post`. We could do all of them just in `cleanup_transformers`, but that makes it difficult resolving things like #30953.



---

archive/issue_comments_452641.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-09-27T04:07:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452641",
    "user": "https://github.com/kwankyu"
}
```

New commits:



---

archive/issue_comments_452642.json:
```json
{
    "body": "I made some commits based on your latest work.\n\nMy main concern with your work was that it introduced some nontrivial regressions regarding `.sage` files (not working `time` and `load/attach` in file, for instance) by deprecating old `preparse` stuffs. My commits recover regressions.\n\nIt works well for me. I am positive on your work. But I think the patch still needs extensive tests.",
    "created_at": "2021-09-27T04:28:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452642",
    "user": "https://github.com/kwankyu"
}
```

I made some commits based on your latest work.

My main concern with your work was that it introduced some nontrivial regressions regarding `.sage` files (not working `time` and `load/attach` in file, for instance) by deprecating old `preparse` stuffs. My commits recover regressions.

It works well for me. I am positive on your work. But I think the patch still needs extensive tests.



---

archive/issue_comments_452643.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-27T04:34:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452643",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452644.json:
```json
{
    "body": "Question:\n\nYou deprecated `InterfaceShellTransformer` and `interface_shell_embed`. I don't understand these stuffs well, and have concerns whether deprecating them is safe. Would you explain?",
    "created_at": "2021-09-27T06:21:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452644",
    "user": "https://github.com/kwankyu"
}
```

Question:

You deprecated `InterfaceShellTransformer` and `interface_shell_embed`. I don't understand these stuffs well, and have concerns whether deprecating them is safe. Would you explain?



---

archive/issue_comments_452645.json:
```json
{
    "body": "Replying to [comment:21 klee]:\n> Question:\n> \n> You deprecated `InterfaceShellTransformer` and `interface_shell_embed`. I don't understand these stuffs well, and have concerns whether deprecating them is safe. Would you explain?\n\nI have no idea what this is used for or who uses it. It should definitely undergo questions in sage-devel, whether this can be deprecated or whether this needs to be adapted.",
    "created_at": "2021-09-27T10:42:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452645",
    "user": "https://github.com/kliem"
}
```

Replying to [comment:21 klee]:
> Question:
> 
> You deprecated `InterfaceShellTransformer` and `interface_shell_embed`. I don't understand these stuffs well, and have concerns whether deprecating them is safe. Would you explain?

I have no idea what this is used for or who uses it. It should definitely undergo questions in sage-devel, whether this can be deprecated or whether this needs to be adapted.



---

archive/issue_comments_452646.json:
```json
{
    "body": "Replying to [comment:18 klee]:\n> I made some commits based on your latest work.\n> \n> My main concern with your work was that it introduced some nontrivial regressions regarding `.sage` files (not working `time` and `load/attach` in file, for instance) by deprecating old `preparse` stuffs. My commits recover regressions.\n> \n> It works well for me. I am positive on your work. But I think the patch still needs extensive tests.\n\nInstead of doing the token now, we could also leave them for #30953. This should make this ticket here easier.\n\n`time` is working in `.sage`. What isn't working anymore is automagic. But automagic isn't meant for multiline things and thus is really a strange concept for files. Line- and cell-magic should be working just fine. (Cell-magic is also a bit strange, as it cannot be exited.) Line-magic wasn't working before in `.sage`-files.\n\nBut yes, this is a regression.",
    "created_at": "2021-09-27T10:48:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452646",
    "user": "https://github.com/kliem"
}
```

Replying to [comment:18 klee]:
> I made some commits based on your latest work.
> 
> My main concern with your work was that it introduced some nontrivial regressions regarding `.sage` files (not working `time` and `load/attach` in file, for instance) by deprecating old `preparse` stuffs. My commits recover regressions.
> 
> It works well for me. I am positive on your work. But I think the patch still needs extensive tests.

Instead of doing the token now, we could also leave them for #30953. This should make this ticket here easier.

`time` is working in `.sage`. What isn't working anymore is automagic. But automagic isn't meant for multiline things and thus is really a strange concept for files. Line- and cell-magic should be working just fine. (Cell-magic is also a bit strange, as it cannot be exited.) Line-magic wasn't working before in `.sage`-files.

But yes, this is a regression.



---

archive/issue_comments_452647.json:
```json
{
    "body": "Replying to [comment:22 gh-kliem]:\n> Replying to [comment:21 klee]:\n> > Question:\n> > \n> > You deprecated `InterfaceShellTransformer` and `interface_shell_embed`. I don't understand these stuffs well, and have concerns whether deprecating them is safe. Would you explain?\n> \n> I have no idea what this is used for or who uses it. \n\nIf so and if they do not do any harm, I think it is safe to leave them intact.",
    "created_at": "2021-09-27T12:38:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452647",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:22 gh-kliem]:
> Replying to [comment:21 klee]:
> > Question:
> > 
> > You deprecated `InterfaceShellTransformer` and `interface_shell_embed`. I don't understand these stuffs well, and have concerns whether deprecating them is safe. Would you explain?
> 
> I have no idea what this is used for or who uses it. 

If so and if they do not do any harm, I think it is safe to leave them intact.



---

archive/issue_comments_452648.json:
```json
{
    "body": "Replying to [comment:23 gh-kliem]:\n \n> `time` is working in `.sage`. \n\nYes, now. It stopped working with your patch.\n\n> What isn't working anymore is automagic. But automagic isn't meant for multiline things and thus is really a strange concept for files. Line- and cell-magic should be working just fine. (Cell-magic is also a bit strange, as it cannot be exited.) Line-magic wasn't working before in `.sage`-files.\n\nI think any of those magic things is not for `.sage` files. Even though any one works by accident, we don't need to support it.",
    "created_at": "2021-09-27T12:52:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452648",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:23 gh-kliem]:
 
> `time` is working in `.sage`. 

Yes, now. It stopped working with your patch.

> What isn't working anymore is automagic. But automagic isn't meant for multiline things and thus is really a strange concept for files. Line- and cell-magic should be working just fine. (Cell-magic is also a bit strange, as it cannot be exited.) Line-magic wasn't working before in `.sage`-files.

I think any of those magic things is not for `.sage` files. Even though any one works by accident, we don't need to support it.



---

archive/issue_comments_452649.json:
```json
{
    "body": "Replying to [comment:23 gh-kliem]:\n\n> Instead of doing the token now, we could also leave them for #30953. This should make this ticket here easier.\n\n#30953 is fixed by the patch here both on command line and in `.sage` file. We can just close #30953 after the present ticket.",
    "created_at": "2021-09-27T12:56:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452649",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:23 gh-kliem]:

> Instead of doing the token now, we could also leave them for #30953. This should make this ticket here easier.

#30953 is fixed by the patch here both on command line and in `.sage` file. We can just close #30953 after the present ticket.



---

archive/issue_comments_452650.json:
```json
{
    "body": "Replying to [comment:23 gh-kliem]:\n> > My main concern with your work was that it introduced some nontrivial regressions regarding `.sage` files (not working `time` and `load/attach` in file, for instance) by deprecating old `preparse` stuffs. My commits recover regressions.\n\n`time` and `load/attach` are Sage things for `.sage` files. They are not ipython magics.",
    "created_at": "2021-09-27T13:10:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452650",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:23 gh-kliem]:
> > My main concern with your work was that it introduced some nontrivial regressions regarding `.sage` files (not working `time` and `load/attach` in file, for instance) by deprecating old `preparse` stuffs. My commits recover regressions.

`time` and `load/attach` are Sage things for `.sage` files. They are not ipython magics.



---

archive/issue_comments_452651.json:
```json
{
    "body": "Replying to [comment:11 gh-kliem]:\n> ... so that loading a file `*.sage` is really the same thing as parsing it all in sage.\n\nWe should not pursue this. Loading a `.sage` file needs not be the same thing as typing them in Sage command line. Indeed, code for loading a `.sage` file does some clever things to speed up running the code in the file, which are not done on command line.",
    "created_at": "2021-09-27T13:20:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452651",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:11 gh-kliem]:
> ... so that loading a file `*.sage` is really the same thing as parsing it all in sage.

We should not pursue this. Loading a `.sage` file needs not be the same thing as typing them in Sage command line. Indeed, code for loading a `.sage` file does some clever things to speed up running the code in the file, which are not done on command line.



---

archive/issue_comments_452652.json:
```json
{
    "body": "Sorry for taking your time. I didn't realize until now, that I didn't change the branch yet to the new approach. Hence my comments didn't make a lot of sense to you.",
    "created_at": "2021-09-27T13:45:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452652",
    "user": "https://github.com/kliem"
}
```

Sorry for taking your time. I didn't realize until now, that I didn't change the branch yet to the new approach. Hence my comments didn't make a lot of sense to you.



---

archive/issue_comments_452653.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-27T13:50:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452653",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452654.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-27T14:21:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452654",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452655.json:
```json
{
    "body": "Fixing #30953 seperate from this ticket, will not work without extra work, as the following doctest already assumes that ipythons preparse detected the implicit line continuation:\n\n\n```\n        sage: preparse(\"a \\\\ b \\\\\") # There is really only one backslash here, it is just being escaped.\n        'a  * BackslashOperator() * b \\\\'\n```\n\n\n```\n        sage: preparse('''\n        ....: f(a,\n        ....:   b,\n        ....:   c,\n        ....:   d) = a + b*2 + c*3 + d*4\n        ....: ''')\n        '__tmp__ = var(\"a,b,c,d\"); __tmpf__ = a + b*Integer(2) + c*Integer(3) + d*Integer(4); f = symbolic_expression(__tmpf__).function(a,b,c,d)\\n'\n```\n\n\nSo, I would argue that it makes sense to introduce the following classes during this ticket:\n- `SageBackslashTransformer`,\n- `SageGenConstructionTransformer`,\n- `SageCalculusTransformer`.",
    "created_at": "2021-09-27T14:33:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452655",
    "user": "https://github.com/kliem"
}
```

Fixing #30953 seperate from this ticket, will not work without extra work, as the following doctest already assumes that ipythons preparse detected the implicit line continuation:


```
        sage: preparse("a \\ b \\") # There is really only one backslash here, it is just being escaped.
        'a  * BackslashOperator() * b \\'
```


```
        sage: preparse('''
        ....: f(a,
        ....:   b,
        ....:   c,
        ....:   d) = a + b*2 + c*3 + d*4
        ....: ''')
        '__tmp__ = var("a,b,c,d"); __tmpf__ = a + b*Integer(2) + c*Integer(3) + d*Integer(4); f = symbolic_expression(__tmpf__).function(a,b,c,d)\n'
```


So, I would argue that it makes sense to introduce the following classes during this ticket:
- `SageBackslashTransformer`,
- `SageGenConstructionTransformer`,
- `SageCalculusTransformer`.



---

archive/issue_comments_452656.json:
```json
{
    "body": "Automagic could be fixed by a replacement as follows:\n\nReplace `time -2` by\n`sage_eval(\"%time -2\", globals()) if 'time' not in globals() else sage_eval(\"time -2\", globals())`\n\nDoes this sound plausible? Do this for every magic keyword.",
    "created_at": "2021-09-27T14:39:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452656",
    "user": "https://github.com/kliem"
}
```

Automagic could be fixed by a replacement as follows:

Replace `time -2` by
`sage_eval("%time -2", globals()) if 'time' not in globals() else sage_eval("time -2", globals())`

Does this sound plausible? Do this for every magic keyword.



---

archive/issue_comments_452657.json:
```json
{
    "body": "Sorry about the mess.\n\nThis is a much simpler fix. It just creates a second input manager that does Sage's preparsing to check correctness of Sage's syntax. It does not behave as desired with magics, e.g.\n\n```\nsage: ip = get_ipython()\nsage: ip._check_complete_transformer.transform_cell(\"%time 8^^1\")\n\"get_ipython().run_line_magic('time', 'Integer(8)^Integer(1)')\\n\"\n```\n\nwhich means it would preparse things after `%time` twice, but it's sole purpose is to check the correctness of syntax, for which it works just fine.\n\nWith the new approach I would like the following follow ups:\n- close #4545 with a doctest\n- have preparse and preparse_file call `ip.transform_cell`, which means the code will behave exactly as if parsed into the interactive shell (move the code from preparse to a helper function then)\n- #30953: do generator construction and calculus like assignment with token transformation\n----\nNew commits:",
    "created_at": "2021-09-27T19:44:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452657",
    "user": "https://github.com/kliem"
}
```

Sorry about the mess.

This is a much simpler fix. It just creates a second input manager that does Sage's preparsing to check correctness of Sage's syntax. It does not behave as desired with magics, e.g.

```
sage: ip = get_ipython()
sage: ip._check_complete_transformer.transform_cell("%time 8^^1")
"get_ipython().run_line_magic('time', 'Integer(8)^Integer(1)')\n"
```

which means it would preparse things after `%time` twice, but it's sole purpose is to check the correctness of syntax, for which it works just fine.

With the new approach I would like the following follow ups:
- close #4545 with a doctest
- have preparse and preparse_file call `ip.transform_cell`, which means the code will behave exactly as if parsed into the interactive shell (move the code from preparse to a helper function then)
- #30953: do generator construction and calculus like assignment with token transformation
----
New commits:



---

archive/issue_comments_452658.json:
```json
{
    "body": "Replying to [comment:30 gh-kliem]:\n> Sorry for taking your time. I didn't realize until now, that I didn't change the branch yet to the new approach. Hence my comments didn't make a lot of sense to you.\n\nWhat is a mess seems our miscommunication :-)\n\nYes, you did push your new approach! It fixed a lot of things, and I was happy with that.",
    "created_at": "2021-09-27T19:52:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452658",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:30 gh-kliem]:
> Sorry for taking your time. I didn't realize until now, that I didn't change the branch yet to the new approach. Hence my comments didn't make a lot of sense to you.

What is a mess seems our miscommunication :-)

Yes, you did push your new approach! It fixed a lot of things, and I was happy with that.



---

archive/issue_comments_452659.json:
```json
{
    "body": "Replying to [comment:33 gh-kliem]:\n> Fixing #30953 seperate from this ticket, will not work without extra work, as the following doctest already assumes that ipythons preparse detected the implicit line continuation:\n> \n> {{{\n>         sage: preparse(\"a \\\\ b \\\\\") # There is really only one backslash here, it is just being escaped.\n>         'a  * BackslashOperator() * b \\\\'\n> }}}\n> {{{\n>         sage: preparse('''\n>         ....: f(a,\n>         ....:   b,\n>         ....:   c,\n>         ....:   d) = a + b*2 + c*3 + d*4\n>         ....: ''')\n>         '__tmp__ = var(\"a,b,c,d\"); __tmpf__ = a + b*Integer(2) + c*Integer(3) + d*Integer(4); f = symbolic_expression(__tmpf__).function(a,b,c,d)\\n'\n> }}}\n> \n> So, I would argue that it makes sense to introduce the following classes during this ticket:\n> - `SageBackslashTransformer`,\n> - `SageGenConstructionTransformer`,\n> - `SageCalculusTransformer`.\n\nYou did introduce these classes in the branch of new approach. Your branch fixed the things above. Then I started working on your branch (with those new classes) because there were regressions in loading `.sage` files.",
    "created_at": "2021-09-27T19:58:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452659",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:33 gh-kliem]:
> Fixing #30953 seperate from this ticket, will not work without extra work, as the following doctest already assumes that ipythons preparse detected the implicit line continuation:
> 
> {{{
>         sage: preparse("a \\ b \\") # There is really only one backslash here, it is just being escaped.
>         'a  * BackslashOperator() * b \\'
> }}}
> {{{
>         sage: preparse('''
>         ....: f(a,
>         ....:   b,
>         ....:   c,
>         ....:   d) = a + b*2 + c*3 + d*4
>         ....: ''')
>         '__tmp__ = var("a,b,c,d"); __tmpf__ = a + b*Integer(2) + c*Integer(3) + d*Integer(4); f = symbolic_expression(__tmpf__).function(a,b,c,d)\n'
> }}}
> 
> So, I would argue that it makes sense to introduce the following classes during this ticket:
> - `SageBackslashTransformer`,
> - `SageGenConstructionTransformer`,
> - `SageCalculusTransformer`.

You did introduce these classes in the branch of new approach. Your branch fixed the things above. Then I started working on your branch (with those new classes) because there were regressions in loading `.sage` files.



---

archive/issue_comments_452660.json:
```json
{
    "body": "Then let's straight out our communication first.\n\n(1) You pushed `public/31951-new` with the new approach.\n(2) Then I worked on your branch to fix regressions in loading `.sage` files, and then pushed my branch to `public/31951`. I think this is a mistake. I should have named it `public/31951-new-new` or something.\n\nSo now the branch (`public/31951-new2) uploaded to this ticket wiped out both of our works!\n\nCould I upload my branch again with name `public/31951-new3`? Then we can start discussing with the magics, in which there is a miscommunication as well...",
    "created_at": "2021-09-27T20:07:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452660",
    "user": "https://github.com/kwankyu"
}
```

Then let's straight out our communication first.

(1) You pushed `public/31951-new` with the new approach.
(2) Then I worked on your branch to fix regressions in loading `.sage` files, and then pushed my branch to `public/31951`. I think this is a mistake. I should have named it `public/31951-new-new` or something.

So now the branch (`public/31951-new2) uploaded to this ticket wiped out both of our works!

Could I upload my branch again with name `public/31951-new3`? Then we can start discussing with the magics, in which there is a miscommunication as well...



---

archive/issue_comments_452661.json:
```json
{
    "body": "My branch refactored your new approach and fixed every bugs and regressions (as far as I am concerned) both on command line and in `.sage` files.",
    "created_at": "2021-09-27T20:16:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452661",
    "user": "https://github.com/kwankyu"
}
```

My branch refactored your new approach and fixed every bugs and regressions (as far as I am concerned) both on command line and in `.sage` files.



---

archive/issue_comments_452662.json:
```json
{
    "body": "Changing the branch, does not wipe out the work. Indeed I got confused with your branch name. I only saw you last commit and thought I never changed the branch name.",
    "created_at": "2021-09-27T21:05:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452662",
    "user": "https://github.com/kliem"
}
```

Changing the branch, does not wipe out the work. Indeed I got confused with your branch name. I only saw you last commit and thought I never changed the branch name.



---

archive/issue_comments_452663.json:
```json
{
    "body": "Your branch `public/31951` is still intact.",
    "created_at": "2021-09-27T21:06:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452663",
    "user": "https://github.com/kliem"
}
```

Your branch `public/31951` is still intact.



---

archive/issue_comments_452664.json:
```json
{
    "body": "It all depends on what we want. The branch `public/31951-new2` is a minimalistic fix to the reported bug. As far as I see, it does not have regressions. So I would propose closing the current ticket with this fix and provide a quick fix to users.\n\nWe can move the previous work to a new ticket (or new tickets). However, I realized that our approach does not work well with automagic, e.g.\n\n`time 8^1` and `time 8^^1` should be equivalent to `%time 8^1` resp. `%time 8^^1`, but I did not accomplish this. Did you?\n\nThere are a number of phases that the transformation undergoes:\n\n1. `get_ipython().input_transformer_manager.cleanup_transforms`: Things like cleaning the prompt as I suggested.\n2. `get_ipython().input_transformer_manager.token_transformers`: Things like IPythons line magic.\n3. `get_ipython().prefilter_manager`: Things like IPythons automagic.\n4. `get_ipython().input_transformers_post`: Currently Sage's `preparse`.\n5. `ip.ast_transformers` (Optional additional changes).\n\nAnything that you enter undergoes all 5 steps. However, when checking whether multi-line input is complete, only the first two steps are checked. It makes sense to execute our preparser at step 4, so it works nicely with automagic. It should be executed at step 2 or later to work nicely with (non-auto) magic.\n\nMy latest solution to this ticket is to leave Sage's preparser at step 4, but overwrite `check_complete` with the method from a different input manager that applies Sage's preparser at step 1. Things will be modified before checking whether this is magic, but this should not bother us.\n\nI quickly scanned your fixes and I think they make sense. When executing a file, it should behave exactly as when typed into the shell, so this could be done via `ipython_preparse` or similar (which calls `get_ipython().transform_cell()` (steps 1 and 2) and not `get_ipython().input_transformer_manager().transform()` (steps 1 to 4).\n\nIf you agree, you could put your branch on #30953 and we leave the minimalistic fix here. Because of the problems with automagic, I think sage's preparsing should stay at step 4 however (except for checking completeness).",
    "created_at": "2021-09-27T21:40:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452664",
    "user": "https://github.com/kliem"
}
```

It all depends on what we want. The branch `public/31951-new2` is a minimalistic fix to the reported bug. As far as I see, it does not have regressions. So I would propose closing the current ticket with this fix and provide a quick fix to users.

We can move the previous work to a new ticket (or new tickets). However, I realized that our approach does not work well with automagic, e.g.

`time 8^1` and `time 8^^1` should be equivalent to `%time 8^1` resp. `%time 8^^1`, but I did not accomplish this. Did you?

There are a number of phases that the transformation undergoes:

1. `get_ipython().input_transformer_manager.cleanup_transforms`: Things like cleaning the prompt as I suggested.
2. `get_ipython().input_transformer_manager.token_transformers`: Things like IPythons line magic.
3. `get_ipython().prefilter_manager`: Things like IPythons automagic.
4. `get_ipython().input_transformers_post`: Currently Sage's `preparse`.
5. `ip.ast_transformers` (Optional additional changes).

Anything that you enter undergoes all 5 steps. However, when checking whether multi-line input is complete, only the first two steps are checked. It makes sense to execute our preparser at step 4, so it works nicely with automagic. It should be executed at step 2 or later to work nicely with (non-auto) magic.

My latest solution to this ticket is to leave Sage's preparser at step 4, but overwrite `check_complete` with the method from a different input manager that applies Sage's preparser at step 1. Things will be modified before checking whether this is magic, but this should not bother us.

I quickly scanned your fixes and I think they make sense. When executing a file, it should behave exactly as when typed into the shell, so this could be done via `ipython_preparse` or similar (which calls `get_ipython().transform_cell()` (steps 1 and 2) and not `get_ipython().input_transformer_manager().transform()` (steps 1 to 4).

If you agree, you could put your branch on #30953 and we leave the minimalistic fix here. Because of the problems with automagic, I think sage's preparsing should stay at step 4 however (except for checking completeness).



---

archive/issue_comments_452665.json:
```json
{
    "body": "Replying to [comment:42 gh-kliem]:\n\nThanks for the detailed explanation. I only guessed the process.\n\n> It all depends on what we want. The branch `public/31951-new2` is a minimalistic fix to the reported bug. As far as I see, it does not have regressions. So I would propose closing the current ticket with this fix and provide a quick fix to users.\n\nAnyway we are too late to provide a \"quick fix\".\n \n> We can move the previous work to a new ticket (or new tickets). However, I realized that our approach does not work well with automagic, e.g.\n> \n> `time 8^1` and `time 8^^1` should be equivalent to `%time 8^1` resp. `%time 8^^1`, but I did not accomplish this. Did you?\n\nNo. I didn't know that. There is no other problem with our approach except this one.\n\nI investigated this. The reason is that ipython applies `cleanup_transforms` **several** times to the input string for automagic. Hence `time 8^^1` becomes `time 8^1` and again `time 8**1`.\n\nSo the solution is to make this code\n\n```\n    # Use ^ for exponentiation and ^^ for xor\n    # (A side effect is that **** becomes xor as well.)\n    L = L.replace('^', '**').replace('****', '^')  \n```\n\nalso to a token transformer(named perhaps `SageCaretTransformer` or `SageExponentiationTransformer`?).\n\nWith another token transformer, our approach(my branch containing your work) fixes all problems.\n\n> If you agree, you could put your branch on #30953 and we leave the minimalistic fix here. Because of the problems with automagic, I think sage's preparsing should stay at step 4 however (except for checking completeness).\n\nAs I said above, we can provide one branch solving this ticket and #30953 (and #4545?). All these tickets are just different manifestations of a single problem. Then why separate the solution?",
    "created_at": "2021-09-28T02:27:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452665",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:42 gh-kliem]:

Thanks for the detailed explanation. I only guessed the process.

> It all depends on what we want. The branch `public/31951-new2` is a minimalistic fix to the reported bug. As far as I see, it does not have regressions. So I would propose closing the current ticket with this fix and provide a quick fix to users.

Anyway we are too late to provide a "quick fix".
 
> We can move the previous work to a new ticket (or new tickets). However, I realized that our approach does not work well with automagic, e.g.
> 
> `time 8^1` and `time 8^^1` should be equivalent to `%time 8^1` resp. `%time 8^^1`, but I did not accomplish this. Did you?

No. I didn't know that. There is no other problem with our approach except this one.

I investigated this. The reason is that ipython applies `cleanup_transforms` **several** times to the input string for automagic. Hence `time 8^^1` becomes `time 8^1` and again `time 8**1`.

So the solution is to make this code

```
    # Use ^ for exponentiation and ^^ for xor
    # (A side effect is that **** becomes xor as well.)
    L = L.replace('^', '**').replace('****', '^')  
```

also to a token transformer(named perhaps `SageCaretTransformer` or `SageExponentiationTransformer`?).

With another token transformer, our approach(my branch containing your work) fixes all problems.

> If you agree, you could put your branch on #30953 and we leave the minimalistic fix here. Because of the problems with automagic, I think sage's preparsing should stay at step 4 however (except for checking completeness).

As I said above, we can provide one branch solving this ticket and #30953 (and #4545?). All these tickets are just different manifestations of a single problem. Then why separate the solution?



---

archive/issue_comments_452666.json:
```json
{
    "body": "> So the solution is to make this code\n> {{{\n>     # Use ^ for exponentiation and ^^ for xor\n>     # (A side effect is that **** becomes xor as well.)\n>     L = L.replace('^', '**').replace('****', '^')  \n> }}}\n> also to a token transformer(named perhaps `SageCaretTransformer` or `SageExponentiationTransformer`?).\n\nOr we can replace the code with another *idempotent* code with some regex juggling.\n\nI can try to code the necessary token transformer, but I think you can do it quicker than me.",
    "created_at": "2021-09-28T02:32:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452666",
    "user": "https://github.com/kwankyu"
}
```

> So the solution is to make this code
> {{{
>     # Use ^ for exponentiation and ^^ for xor
>     # (A side effect is that **** becomes xor as well.)
>     L = L.replace('^', '**').replace('****', '^')  
> }}}
> also to a token transformer(named perhaps `SageCaretTransformer` or `SageExponentiationTransformer`?).

Or we can replace the code with another *idempotent* code with some regex juggling.

I can try to code the necessary token transformer, but I think you can do it quicker than me.



---

archive/issue_comments_452667.json:
```json
{
    "body": "No, just making it idempotent is not enough.\n\n\n```\nsage: runfile /tmp/2.sage\nTraceback (most recent call last)\n...\nOSError: did not find file '/tmp/Integer(2).sage' to load or attach\n```\n\n\nInstead of trying to find a workaround for all these problems, we could just leave our preparsing at step 4 and just modify `check_complete`. Even the backslash transformation is probably best left for step 4.\n\nNow there is a different idea I just had: The current ticket works well with everything except for automagic, which only applies for single-line inputs. In contrast, all our problems only apply for multi-line input. So we could do our replacements at step 1 and 2 for multi-line input and leave it for step 4 for single-line input. This should also work.",
    "created_at": "2021-09-28T06:22:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452667",
    "user": "https://github.com/kliem"
}
```

No, just making it idempotent is not enough.


```
sage: runfile /tmp/2.sage
Traceback (most recent call last)
...
OSError: did not find file '/tmp/Integer(2).sage' to load or attach
```


Instead of trying to find a workaround for all these problems, we could just leave our preparsing at step 4 and just modify `check_complete`. Even the backslash transformation is probably best left for step 4.

Now there is a different idea I just had: The current ticket works well with everything except for automagic, which only applies for single-line inputs. In contrast, all our problems only apply for multi-line input. So we could do our replacements at step 1 and 2 for multi-line input and leave it for step 4 for single-line input. This should also work.



---

archive/issue_comments_452668.json:
```json
{
    "body": "Replying to [comment:45 gh-kliem]:\n> No, just making it idempotent is not enough.\n> \n> {{{\n> sage: runfile /tmp/2.sage\n> Traceback (most recent call last)\n> ...\n> OSError: did not find file '/tmp/Integer(2).sage' to load or attach\n> }}}\n> \n> Instead of trying to find a workaround for all these problems, we could just leave our preparsing at step 4 and just modify `check_complete`. Even the backslash transformation is probably best left for step 4.\n\nOkay. Now I am persuaded. \n \n> Now there is a different idea I just had: The current ticket works well with everything except for automagic, which only applies for single-line inputs. In contrast, all our problems only apply for multi-line input. So we could do our replacements at step 1 and 2 for multi-line input and leave it for step 4 for single-line input. This should also work.\n\nYour current patch works really well. What about automagic is not working? Your previous example `time 8^^1` works well.",
    "created_at": "2021-09-28T07:16:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452668",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:45 gh-kliem]:
> No, just making it idempotent is not enough.
> 
> {{{
> sage: runfile /tmp/2.sage
> Traceback (most recent call last)
> ...
> OSError: did not find file '/tmp/Integer(2).sage' to load or attach
> }}}
> 
> Instead of trying to find a workaround for all these problems, we could just leave our preparsing at step 4 and just modify `check_complete`. Even the backslash transformation is probably best left for step 4.

Okay. Now I am persuaded. 
 
> Now there is a different idea I just had: The current ticket works well with everything except for automagic, which only applies for single-line inputs. In contrast, all our problems only apply for multi-line input. So we could do our replacements at step 1 and 2 for multi-line input and leave it for step 4 for single-line input. This should also work.

Your current patch works really well. What about automagic is not working? Your previous example `time 8^^1` works well.



---

archive/issue_comments_452669.json:
```json
{
    "body": "Ah. Your current patch does not fix #30953...",
    "created_at": "2021-09-28T07:20:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452669",
    "user": "https://github.com/kwankyu"
}
```

Ah. Your current patch does not fix #30953...



---

archive/issue_comments_452670.json:
```json
{
    "body": "\n```\nsage: %time 8^^1\nCPU times: user 17 \u00b5s, sys: 2 \u00b5s, total: 19 \u00b5s\nWall time: 25.3 \u00b5s\n9\nsage: time 8^^1\nCPU times: user 33 \u00b5s, sys: 3 \u00b5s, total: 36 \u00b5s\nWall time: 49.8 \u00b5s\n8\nsage: 8^^1\n9\n```\n\n\nNot working. The problem is that `8^^1` is preparsed twice. Automagic is hard to detect and depends in fact on whether a variable of a specific name is defined.\n\nAt the moment I really see two ways of doing it:\n- Have an artificial input manager for `check_complete`.\n- Do the preparsing in steps 1 and 2 except for single-lines, when we keep doing the preparsing at step 4.",
    "created_at": "2021-09-28T07:28:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452670",
    "user": "https://github.com/kliem"
}
```


```
sage: %time 8^^1
CPU times: user 17 s, sys: 2 s, total: 19 s
Wall time: 25.3 s
9
sage: time 8^^1
CPU times: user 33 s, sys: 3 s, total: 36 s
Wall time: 49.8 s
8
sage: 8^^1
9
```


Not working. The problem is that `8^^1` is preparsed twice. Automagic is hard to detect and depends in fact on whether a variable of a specific name is defined.

At the moment I really see two ways of doing it:
- Have an artificial input manager for `check_complete`.
- Do the preparsing in steps 1 and 2 except for single-lines, when we keep doing the preparsing at step 4.



---

archive/issue_comments_452671.json:
```json
{
    "body": "By combining your current branch (that use artificial input manager for `check_complete`) with my branch, I think I managed to fix automagic problem. The code is still a mess with lots of doctest errors, but all of them seem fixable.\n\nA question: It seems that `ip.input_transformer_manager.transform_cell(...)` does not apply `input_transformers_post`. Am I right? Because of this, now I have lots of doctest errors like \n\n```\nFile \"src/sage/repl/interpreter.py\", line 635, in sage.repl.interpreter.SageBackslashTransformer\nFailed example:\n    ip.input_transformer_manager.transform_cell(r'''\n    a = (2, 3, \\\n         4)''')\nExpected:\n    'a = (Integer(2), Integer(3), \\\\\\n     Integer(4))\\n'\nGot:\n    'a = (2, 3, \\\\\\n     4)\\n'\n```\n\n\nOtherwise all seems work well. Let me have some time to tidy up the code.",
    "created_at": "2021-09-28T09:11:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452671",
    "user": "https://github.com/kwankyu"
}
```

By combining your current branch (that use artificial input manager for `check_complete`) with my branch, I think I managed to fix automagic problem. The code is still a mess with lots of doctest errors, but all of them seem fixable.

A question: It seems that `ip.input_transformer_manager.transform_cell(...)` does not apply `input_transformers_post`. Am I right? Because of this, now I have lots of doctest errors like 

```
File "src/sage/repl/interpreter.py", line 635, in sage.repl.interpreter.SageBackslashTransformer
Failed example:
    ip.input_transformer_manager.transform_cell(r'''
    a = (2, 3, \
         4)''')
Expected:
    'a = (Integer(2), Integer(3), \\\n     Integer(4))\n'
Got:
    'a = (2, 3, \\\n     4)\n'
```


Otherwise all seems work well. Let me have some time to tidy up the code.



---

archive/issue_comments_452672.json:
```json
{
    "body": "I am ready to upload the combined branch, which works well for all problems which we discussed.\n\nI think it is okay to upload the branch here as it combines the current branch.",
    "created_at": "2021-09-28T11:47:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452672",
    "user": "https://github.com/kwankyu"
}
```

I am ready to upload the combined branch, which works well for all problems which we discussed.

I think it is okay to upload the branch here as it combines the current branch.



---

archive/issue_comments_452673.json:
```json
{
    "body": "The branch name is again \"public/31951\".\n----\nNew commits:",
    "created_at": "2021-09-28T11:48:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452673",
    "user": "https://github.com/kwankyu"
}
```

The branch name is again "public/31951".
----
New commits:



---

archive/issue_comments_452674.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-28T12:01:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452674",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452675.json:
```json
{
    "body": "`quote_state` needs not to be a global in `interpreter.py`.\n\nThe problem here is that automagic will still have the 3 token replacement. I'm not on your new branch, but you will see a failure similar to\n\n```\nsage: ls | grep \\f\n/bin/bash: -c: line 0: syntax error near unexpected token `('\n/bin/bash: -c: line 0: `ls -F --color | grep * BackslashOperator() * f'\n```\n\n\nOn develop this works just fine.\n\nSo the token replacements should not be applied in case of single lines, but then need to be added to `SagePreparseTransformer` again (to be applied to single lines). We could also remove the backslash token and put it back into `SagePreparseTransformer`, but this wouldn't fix the following:\n\nNow:\n\n```\nsage: del maxima\nsage: maxima f(x)=2\n__tmp__=var(\"x\")\n```\n\n\nBefore:\n\n```\nsage: del maxima\nsage: maxima f(x)=2\nf(x)=2\n```\n",
    "created_at": "2021-09-28T12:35:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452675",
    "user": "https://github.com/kliem"
}
```

`quote_state` needs not to be a global in `interpreter.py`.

The problem here is that automagic will still have the 3 token replacement. I'm not on your new branch, but you will see a failure similar to

```
sage: ls | grep \f
/bin/bash: -c: line 0: syntax error near unexpected token `('
/bin/bash: -c: line 0: `ls -F --color | grep * BackslashOperator() * f'
```


On develop this works just fine.

So the token replacements should not be applied in case of single lines, but then need to be added to `SagePreparseTransformer` again (to be applied to single lines). We could also remove the backslash token and put it back into `SagePreparseTransformer`, but this wouldn't fix the following:

Now:

```
sage: del maxima
sage: maxima f(x)=2
__tmp__=var("x")
```


Before:

```
sage: del maxima
sage: maxima f(x)=2
f(x)=2
```




---

archive/issue_comments_452676.json:
```json
{
    "body": "Replying to [comment:53 gh-kliem]:\n\n> The problem here is that automagic will still have the 3 token replacement. I'm not on your new branch, but you will see a failure similar to\n> {{{\n> sage: ls | grep \\f\n> /bin/bash: -c: line 0: syntax error near unexpected token `('\n> /bin/bash: -c: line 0: `ls -F --color | grep * BackslashOperator() * f'\n> }}}\n> \n> On develop this works just fine.\n> \n> So the token replacements should not be applied in case of single lines, but then need to be added to `SagePreparseTransformer` again (to be applied to single lines). We could also remove the backslash token and put it back into `SagePreparseTransformer`, but this wouldn't fix the following:\n> \n> Now:\n> {{{\n> sage: del maxima\n> sage: maxima f(x)=2\n> __tmp__=var(\"x\")\n> }}}\n> \n> Before:\n> {{{\n> sage: del maxima\n> sage: maxima f(x)=2\n> f(x)=2\n> }}}\n\nThese works fine with the branch, fortunately.\n\n> `quote_state` needs not to be a global in `interpreter.py`.\n\nWould you fix this while you examine the new branch?",
    "created_at": "2021-09-28T13:06:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452676",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:53 gh-kliem]:

> The problem here is that automagic will still have the 3 token replacement. I'm not on your new branch, but you will see a failure similar to
> {{{
> sage: ls | grep \f
> /bin/bash: -c: line 0: syntax error near unexpected token `('
> /bin/bash: -c: line 0: `ls -F --color | grep * BackslashOperator() * f'
> }}}
> 
> On develop this works just fine.
> 
> So the token replacements should not be applied in case of single lines, but then need to be added to `SagePreparseTransformer` again (to be applied to single lines). We could also remove the backslash token and put it back into `SagePreparseTransformer`, but this wouldn't fix the following:
> 
> Now:
> {{{
> sage: del maxima
> sage: maxima f(x)=2
> __tmp__=var("x")
> }}}
> 
> Before:
> {{{
> sage: del maxima
> sage: maxima f(x)=2
> f(x)=2
> }}}

These works fine with the branch, fortunately.

> `quote_state` needs not to be a global in `interpreter.py`.

Would you fix this while you examine the new branch?



---

archive/issue_comments_452677.json:
```json
{
    "body": "Let me remind you that the new branch is based on sage beta 9.5.beta2.",
    "created_at": "2021-09-28T13:12:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452677",
    "user": "https://github.com/kwankyu"
}
```

Let me remind you that the new branch is based on sage beta 9.5.beta2.



---

archive/issue_comments_452678.json:
```json
{
    "body": "Replying to [comment:54 klee]:\n> Replying to [comment:53 gh-kliem]:\n> \n> > The problem here is that automagic will still have the 3 token replacement. I'm not on your new branch, but you will see a failure similar to\n> > {{{\n> > sage: ls | grep \\f\n> > /bin/bash: -c: line 0: syntax error near unexpected token `('\n> > /bin/bash: -c: line 0: `ls -F --color | grep * BackslashOperator() * f'\n> > }}}\n> > \n> > On develop this works just fine.\n> > \n> > So the token replacements should not be applied in case of single lines, but then need to be added to `SagePreparseTransformer` again (to be applied to single lines). We could also remove the backslash token and put it back into `SagePreparseTransformer`, but this wouldn't fix the following:\n> > \n> > Now:\n> > {{{\n> > sage: del maxima\n> > sage: maxima f(x)=2\n> > __tmp__=var(\"x\")\n> > }}}\n> > \n> > Before:\n> > {{{\n> > sage: del maxima\n> > sage: maxima f(x)=2\n> > f(x)=2\n> > }}}\n> \n> These works fine with the branch, fortunately.\nWell, because `SageTokenTransformers` are never added to the token transformers. So they don't do anything.\n> \n> > `quote_state` needs not to be a global in `interpreter.py`.\n> \n> Would you fix this while you examine the new branch?\n\nYes.",
    "created_at": "2021-09-28T13:33:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452678",
    "user": "https://github.com/kliem"
}
```

Replying to [comment:54 klee]:
> Replying to [comment:53 gh-kliem]:
> 
> > The problem here is that automagic will still have the 3 token replacement. I'm not on your new branch, but you will see a failure similar to
> > {{{
> > sage: ls | grep \f
> > /bin/bash: -c: line 0: syntax error near unexpected token `('
> > /bin/bash: -c: line 0: `ls -F --color | grep * BackslashOperator() * f'
> > }}}
> > 
> > On develop this works just fine.
> > 
> > So the token replacements should not be applied in case of single lines, but then need to be added to `SagePreparseTransformer` again (to be applied to single lines). We could also remove the backslash token and put it back into `SagePreparseTransformer`, but this wouldn't fix the following:
> > 
> > Now:
> > {{{
> > sage: del maxima
> > sage: maxima f(x)=2
> > __tmp__=var("x")
> > }}}
> > 
> > Before:
> > {{{
> > sage: del maxima
> > sage: maxima f(x)=2
> > f(x)=2
> > }}}
> 
> These works fine with the branch, fortunately.
Well, because `SageTokenTransformers` are never added to the token transformers. So they don't do anything.
> 
> > `quote_state` needs not to be a global in `interpreter.py`.
> 
> Would you fix this while you examine the new branch?

Yes.



---

archive/issue_comments_452679.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-28T14:23:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452679",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452680.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-28T14:31:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452680",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452681.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-28T14:49:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452681",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452682.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-28T14:55:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452682",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452683.json:
```json
{
    "body": "Let me know, what you think about the changes.\n\nIf we do it like this then `preparse_calculus` and `preparse_generators` should be deprecated.\n\nAs a follow up ticket we could try to have magics in `preparse_file`, when it is preparsed within ipython.",
    "created_at": "2021-09-28T15:01:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452683",
    "user": "https://github.com/kliem"
}
```

Let me know, what you think about the changes.

If we do it like this then `preparse_calculus` and `preparse_generators` should be deprecated.

As a follow up ticket we could try to have magics in `preparse_file`, when it is preparsed within ipython.



---

archive/issue_comments_452684.json:
```json
{
    "body": "Also closing #4545 could really happen in #4545, as it has nothing to do with our changes. Apparently the problem just went away.",
    "created_at": "2021-09-28T15:01:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452684",
    "user": "https://github.com/kliem"
}
```

Also closing #4545 could really happen in #4545, as it has nothing to do with our changes. Apparently the problem just went away.



---

archive/issue_comments_452685.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-28T16:01:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452685",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452686.json:
```json
{
    "body": "Replying to [comment:61 gh-kliem]:\n> Let me know, what you think about the changes.\n\nLooks good.One thing: I am not sure about ``@`parallel`. Is it already deprecated?\n\n> If we do it like this then `preparse_calculus` and `preparse_generators` should be deprecated.\n\nThen let them be deprecated. I made a commit for this.\n\n> As a follow up ticket we could try to have magics in `preparse_file`, when it is preparsed within ipython.\n\nI have no passion for magics in `.sage` files. But of course you can go ahead.",
    "created_at": "2021-09-28T16:07:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452686",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:61 gh-kliem]:
> Let me know, what you think about the changes.

Looks good.One thing: I am not sure about ``@`parallel`. Is it already deprecated?

> If we do it like this then `preparse_calculus` and `preparse_generators` should be deprecated.

Then let them be deprecated. I made a commit for this.

> As a follow up ticket we could try to have magics in `preparse_file`, when it is preparsed within ipython.

I have no passion for magics in `.sage` files. But of course you can go ahead.



---

archive/issue_comments_452687.json:
```json
{
    "body": "Replying to [comment:62 gh-kliem]:\n> Also closing #4545 could really happen in #4545, as it has nothing to do with our changes. Apparently the problem just went away.\n\nOkay with ``@`parallel`.",
    "created_at": "2021-09-28T16:12:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452687",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:62 gh-kliem]:
> Also closing #4545 could really happen in #4545, as it has nothing to do with our changes. Apparently the problem just went away.

Okay with ``@`parallel`.



---

archive/issue_comments_452688.json:
```json
{
    "body": "I am positive on the patch.\n\nYou can set it positive if you are okay too.",
    "created_at": "2021-09-28T16:17:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452688",
    "user": "https://github.com/kwankyu"
}
```

I am positive on the patch.

You can set it positive if you are okay too.



---

archive/issue_comments_452689.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-29T09:00:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452689",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452690.json:
```json
{
    "body": "From my side this is ok, I would probably wait for a patchbot.",
    "created_at": "2021-09-29T09:56:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452690",
    "user": "https://github.com/kliem"
}
```

From my side this is ok, I would probably wait for a patchbot.



---

archive/issue_comments_452691.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-30T03:27:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452691",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452692.json:
```json
{
    "body": "This approach has a serious problem though:\n\nhttps://patchbot.sagemath.org/log/31951/Linux/1_SMP_Debian_5.10.46-5_(2021-09-23)/x86_64/5.10.0-8-amd64/tmonteil-lxc1/2021-09-30%2006:22:01?plugin=startup_modules&diff=/log/0/Linux/1_SMP_Debian_5.10.46-5_%282021-09-23%29/x86_64/5.10.0-8-amd64/tmonteil-lxc1/2021-09-29%2014%3A23%3A05&ticket=31951&base=9.5.beta2\n\nWhat I understand from this is that now `IPython` is being loaded, even when just running sage from command line, which is new. I have no idea if this is acceptable.",
    "created_at": "2021-09-30T07:26:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452692",
    "user": "https://github.com/kliem"
}
```

This approach has a serious problem though:

https://patchbot.sagemath.org/log/31951/Linux/1_SMP_Debian_5.10.46-5_(2021-09-23)/x86_64/5.10.0-8-amd64/tmonteil-lxc1/2021-09-30%2006:22:01?plugin=startup_modules&diff=/log/0/Linux/1_SMP_Debian_5.10.46-5_%282021-09-23%29/x86_64/5.10.0-8-amd64/tmonteil-lxc1/2021-09-29%2014%3A23%3A05&ticket=31951&base=9.5.beta2

What I understand from this is that now `IPython` is being loaded, even when just running sage from command line, which is new. I have no idea if this is acceptable.



---

archive/issue_comments_452693.json:
```json
{
    "body": "Replying to [comment:70 gh-kliem]:\n> This approach has a serious problem though:\n> \n> https://patchbot.sagemath.org/log/31951/Linux/1_SMP_Debian_5.10.46-5_(2021-09-23)/x86_64/5.10.0-8-amd64/tmonteil-lxc1/2021-09-30%2006:22:01?plugin=startup_modules&diff=/log/0/Linux/1_SMP_Debian_5.10.46-5_%282021-09-23%29/x86_64/5.10.0-8-amd64/tmonteil-lxc1/2021-09-29%2014%3A23%3A05&ticket=31951&base=9.5.beta2\n> \n> What I understand from this is that now `IPython` is being loaded, even when just running sage from command line, which is new. I have no idea if this is acceptable.\n\nIt is serious and not acceptable. Let's see if there's an escape.",
    "created_at": "2021-09-30T08:02:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452693",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:70 gh-kliem]:
> This approach has a serious problem though:
> 
> https://patchbot.sagemath.org/log/31951/Linux/1_SMP_Debian_5.10.46-5_(2021-09-23)/x86_64/5.10.0-8-amd64/tmonteil-lxc1/2021-09-30%2006:22:01?plugin=startup_modules&diff=/log/0/Linux/1_SMP_Debian_5.10.46-5_%282021-09-23%29/x86_64/5.10.0-8-amd64/tmonteil-lxc1/2021-09-29%2014%3A23%3A05&ticket=31951&base=9.5.beta2
> 
> What I understand from this is that now `IPython` is being loaded, even when just running sage from command line, which is new. I have no idea if this is acceptable.

It is serious and not acceptable. Let's see if there's an escape.



---

archive/issue_comments_452694.json:
```json
{
    "body": "Yes, I think so. The solution to #30953 is apparently super easy:\n\n\n```\n-    L = ';%s;' % L.replace('\\n', ';\\n;')\n+    replacements = []\n+    counta = 0\n+    countb = 0\n+    for i in range(len(L)):\n+        if L[i] == '[':\n+            counta += 1\n+        elif L[i] == '(':\n+            countb += 1\n+        elif L[i] == ']':\n+            counta -= 1\n+        elif L[i] == ')':\n+            countb -= 1\n+        elif L[i] == '\\n':\n+            if counta == countb == 0:\n+                replacements.append(i)\n+    while replacements:\n+        i = replacements.pop()\n+        L = L[:i] + ';\\n;' + L[i+1:]\n+    L = ';' + L\n+    if not L[-1:] == ';':\n+        L += ';'\n```\n\n\nI'll push changes, once I tested it (and we can always reset, if we don't like it).",
    "created_at": "2021-09-30T08:34:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452694",
    "user": "https://github.com/kliem"
}
```

Yes, I think so. The solution to #30953 is apparently super easy:


```
-    L = ';%s;' % L.replace('\n', ';\n;')
+    replacements = []
+    counta = 0
+    countb = 0
+    for i in range(len(L)):
+        if L[i] == '[':
+            counta += 1
+        elif L[i] == '(':
+            countb += 1
+        elif L[i] == ']':
+            counta -= 1
+        elif L[i] == ')':
+            countb -= 1
+        elif L[i] == '\n':
+            if counta == countb == 0:
+                replacements.append(i)
+    while replacements:
+        i = replacements.pop()
+        L = L[:i] + ';\n;' + L[i+1:]
+    L = ';' + L
+    if not L[-1:] == ';':
+        L += ';'
```


I'll push changes, once I tested it (and we can always reset, if we don't like it).



---

archive/issue_comments_452695.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-30T09:28:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452695",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452696.json:
```json
{
    "body": "Sorry about the mess. This apparently works just with some slight changes in comparison to develop.",
    "created_at": "2021-09-30T09:31:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452696",
    "user": "https://github.com/kliem"
}
```

Sorry about the mess. This apparently works just with some slight changes in comparison to develop.



---

archive/issue_comments_452697.json:
```json
{
    "body": "Why don't we try just to fix the last branch? \n\nIt seems that `IPython` is imported only with 9.5.beta2 + last branch (I mean not with 9.5.beta1). Do you understand how this happen? Is it not surmountable with the approach of the last branch?",
    "created_at": "2021-09-30T09:57:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452697",
    "user": "https://github.com/kwankyu"
}
```

Why don't we try just to fix the last branch? 

It seems that `IPython` is imported only with 9.5.beta2 + last branch (I mean not with 9.5.beta1). Do you understand how this happen? Is it not surmountable with the approach of the last branch?



---

archive/issue_comments_452698.json:
```json
{
    "body": "`IPython` is surely imported whenever you parse something. Because the token transformer needs IPython.\n\nWhenevern you run\n\n`sage -c \"print('hello')` or similar, this will call `preparse`, which imports whatever it needs to run. In our case we added the dependency to `IPython`.\n\nNow the new fix just slightly modified the develop branch to obtain the same output, so I don't know why to use tokens, if a slight modification works just as well.",
    "created_at": "2021-09-30T11:12:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452698",
    "user": "https://github.com/kliem"
}
```

`IPython` is surely imported whenever you parse something. Because the token transformer needs IPython.

Whenevern you run

`sage -c "print('hello')` or similar, this will call `preparse`, which imports whatever it needs to run. In our case we added the dependency to `IPython`.

Now the new fix just slightly modified the develop branch to obtain the same output, so I don't know why to use tokens, if a slight modification works just as well.



---

archive/issue_comments_452699.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-30T12:21:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452699",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452700.json:
```json
{
    "body": "Replying to [comment:76 gh-kliem]:\n> `IPython` is surely imported whenever you parse something. Because the token transformer needs IPython.\n> \n> Whenevern you run\n> \n> `sage -c \"print('hello')` or similar, this will call `preparse`, which imports whatever it needs to run. In our case we added the dependency to `IPython`.\n\nI see.\n\n> Now the new fix just slightly modified the develop branch to obtain the same output, so I don't know why to use tokens, if a slight modification works just as well.\n\nOkay. I agree that the simpler, the better.\n\nAll seem work well with me. Let's wait for a green bot.",
    "created_at": "2021-09-30T12:28:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452700",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:76 gh-kliem]:
> `IPython` is surely imported whenever you parse something. Because the token transformer needs IPython.
> 
> Whenevern you run
> 
> `sage -c "print('hello')` or similar, this will call `preparse`, which imports whatever it needs to run. In our case we added the dependency to `IPython`.

I see.

> Now the new fix just slightly modified the develop branch to obtain the same output, so I don't know why to use tokens, if a slight modification works just as well.

Okay. I agree that the simpler, the better.

All seem work well with me. Let's wait for a green bot.



---

archive/issue_comments_452701.json:
```json
{
    "body": "I think the slight increase of the startup time is acceptable. I cannot clearly explain the increase, but I guess this is caused by increasing time of parsing Sage startup scripts.\n\nOtherwise I am positive with the new simpler fix.",
    "created_at": "2021-10-01T02:39:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452701",
    "user": "https://github.com/kwankyu"
}
```

I think the slight increase of the startup time is acceptable. I cannot clearly explain the increase, but I guess this is caused by increasing time of parsing Sage startup scripts.

Otherwise I am positive with the new simpler fix.



---

archive/issue_comments_452702.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-10-01T06:32:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452702",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_452703.json:
```json
{
    "body": "Ok, let's move on.",
    "created_at": "2021-10-01T06:32:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452703",
    "user": "https://github.com/kliem"
}
```

Ok, let's move on.



---

archive/issue_comments_452704.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-10-09T11:10:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31714#issuecomment-452704",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_028894.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-10-09T11:10:08Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31714",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31714#event-28894"
}
```
