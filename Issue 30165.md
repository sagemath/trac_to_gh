# Issue 30165: Cannot load an object containing a matrix if it was saved from Python 2 Sage

Issue created by migration from https://trac.sagemath.org/ticket/30402

Original creator: @penguian

Original creation time: 2020-08-20 04:04:55

CC:  nbruin jhpalmieri chapoton slelievre

Keywords: load, save, matrix

Paul Leopardiâ€™s profile photo
Paul Leopardi
unread,
19 Aug 2020, 22:17:40 (yesterday) 
to sage-s...`@`googlegroups.com
Hello,
I am currently trying to convert my Boolean-Cayley-graphs project from Python 2 to Python 3 Sage. https://github.com/penguian/Boolean-Cayley-graphs/tree/23-port-to-python-3

I have succeeded in converting the code, but cannot load objects that were saved by my previous Python 2-based code. These objects contain matrices as members. 

As far as I can tell, load(...,encoding='latin-1') fails to load a dict containing a matrix but load(...,encoding='bytes') loads but does not restore the original object. See the attachments, showing a script run on Cocalc, and its results.


---

Attachment

Test script to run on Cocalc


---

Attachment

Results of running test script with different versions of Sage


---

Comment by @penguian created at 2020-08-20 04:08:38

See also https://groups.google.com/g/sage-support/c/3WKui-LojKs/m/DgEPBGF3AQAJ and #28444


---

Comment by @penguian created at 2020-08-23 07:41:18

I applied the [change suggested by Nils Bruin](https://groups.google.com/g/sage-devel/c/jUlvgvg1Ims/m/OceEoQdeAwAJ) to Sage 9.1 installed from source on Kubuntu 20.04, and it works for me.


---

Comment by mkoeppe created at 2020-08-30 03:03:21

Changing priority from major to critical.


---

Comment by mkoeppe created at 2020-08-30 03:03:21

Could someone please prepare a branch for this ticket?


---

Comment by mkoeppe created at 2020-10-08 17:28:35

It would be really nice to get this fix in.


---

Comment by jhpalmieri created at 2020-10-09 03:55:51

I have a branch, but I am having problems pushing it to trac. If someone else wants to prepare it, go ahead.

```diff
diff --git a/src/sage/matrix/matrix_integer_dense.pyx b/src/sage/matrix/matrix_integer_dense.pyx
index fa6971504b..98aee236eb 100644
--- a/src/sage/matrix/matrix_integer_dense.pyx
+++ b/src/sage/matrix/matrix_integer_dense.pyx
@@ -550,7 +550,23 @@ cdef class Matrix_integer_dense(Matrix_dense):
         return data
 
     def _unpickle(self, data, int version):
+        """
+        TESTS::
+
+            sage: b = matrix(ZZ,2,3, [0,0,0, 0, 0, 0])
+            sage: s = b'1 61 f -2 3 0'
+            sage: t = s.decode()
+            sage: b._unpickle(s, 0) == b._unpickle(t, 0)
+            True
+            sage: b
+            [  1 193  15]
+            [ -2   3   0]
+        """
         if version == 0:
+            if isinstance(data, str):
+                # old Py2 pickle: old "bytes" object reaches us as a
+                # latin1-encoded string.
+                data = data.encode('latin1')
             if isinstance(data, bytes):
                 self._unpickle_version0(data)
             elif isinstance(data, list):
```

Needs testing.


---

Comment by @kliem created at 2020-10-09 10:57:20

I prepared it and I have the same problem, it seems:


```
kliem@cofio:~/localhome/sage/src/sage/matrix$ git push --set-upstream trac public/30402

perl: warning: Setting locale failed.
perl: warning: Please check that your locale settings:
	LANGUAGE = (unset),
	LC_ALL = (unset),
	LC_PAPER = "de_DE.UTF-8",
	LC_ADDRESS = "de_DE.UTF-8",
	LC_MONETARY = "de_DE.UTF-8",
	LC_NUMERIC = "de_DE.UTF-8",
	LC_TELEPHONE = "de_DE.UTF-8",
	LC_IDENTIFICATION = "de_DE.UTF-8",
	LC_MEASUREMENT = "de_DE.UTF-8",
	LC_TIME = "de_DE.UTF-8",
	LC_NAME = "de_DE.UTF-8",
	LANG = "en_US.UTF-8"
    are supported and installed on your system.
perl: warning: Falling back to the standard locale ("C").
Enumerating objects: 35, done.
Counting objects: 100% (35/35), done.
Delta compression using up to 8 threads
Compressing objects: 100% (30/30), done.
Writing objects: 100% (30/30), 3.57 KiB | 3.57 MiB/s, done.
Total 30 (delta 25), reused 0 (delta 0)
remote: error: insufficient permission for adding an object to repository database ./objects
remote: fatal: failed to write object
error: remote unpack failed: unpack-objects abnormal exit
To trac.sagemath.org:sage.git
 ! [remote rejected]       public/30402 -> public/30402 (unpacker error)
error: failed to push some refs to 'git@trac.sagemath.org:sage.git'
```



---

Comment by dimpase created at 2020-10-09 11:24:01

please try again now. I've been doing some maintainance/repairing of the git repo.


---

Comment by @kliem created at 2020-10-09 11:34:04

same error


---

Comment by dimpase created at 2020-10-09 11:37:58

OK, let me see.


---

Comment by dimpase created at 2020-10-09 11:43:07

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-10-09 11:43:07

I've fixed the permissions on `...repository database ./objects` and was able to push the branch.

There seems to be some problem there caused by gitolite - the thing that enables viewing branches here in the browser, which also uses the repo on the server. Weird.  
----
New commits:


---

Comment by dimpase created at 2020-10-09 12:08:10

ok, the test passes. Good to go.


---

Comment by dimpase created at 2020-10-09 12:08:10

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2020-10-09 12:13:15

I fixed some codestyle and stuff. Should I push it or put it on a new ticket.


---

Comment by dimpase created at 2020-10-09 12:28:53

push it here if you like, why not.


---

Comment by git created at 2020-10-09 12:36:36

Changing status from positive_review to needs_review.


---

Comment by git created at 2020-10-09 12:36:36

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by @kliem created at 2020-10-09 12:40:54

Ok.

Maybe one day `sage -tox` for all of sage :-)

It doesn't even pass this file yet due to coverage and it not liking the variable name `ans`.


---

Comment by dimpase created at 2020-10-09 22:19:24

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-10-09 22:19:24

OK, great, thanks. Please add yourself to reviewers/authors, if you like.


---

Comment by mkoeppe created at 2020-10-13 00:51:07

Changing priority from critical to blocker.


---

Comment by vbraun created at 2020-10-18 08:38:25

Resolution: fixed
