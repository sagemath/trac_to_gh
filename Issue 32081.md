# Issue 32081: Performace improvements in generating non-redundant indices of tensors with indices

Issue created by migration from https://trac.sagemath.org/ticket/32318

Original creator: @spaghettisalat

Original creation time: 2021-07-31 14:38:24

CC:  slelievre @mjungmath egourgoulhon tscrim

In `sage.tensor.modules.comp.CompWithSym`, the method generating non-redundant indices is implemented very inefficiently by going through all indices and throwing away the redundant ones. In the worst case scenario of a rank n tensor in n dimensions, we have to iterate through n<sup>n</sup> indices only to find the single non-redundant one.

This ticket fixes this by changing the implementation to directly generate only non-redundant indices. This gives for example the following improvement for 7 dimensions:


```
sage: import timeit
sage: from sage.tensor.modules.comp import Components, CompWithSym, CompFullySym, CompFullyAntiSym
sage: V = VectorSpace(QQ, 7)
sage: c = CompFullyAntiSym(QQ, V.basis(), 7)
sage: timeit.timeit(lambda:list(c.non_redundant_index_generator()),number=1)

new implementation:
4.3510999603313394e-05

old implementation:
2.4149506480007403
```


I also simplified the method generating redundant indices a bit.


---

Comment by @spaghettisalat created at 2021-07-31 14:38:31

Changing status from new to needs_review.


---

Comment by git created at 2021-08-01 12:39:05

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @mjungmath created at 2021-08-05 12:28:57

Haven't checked the algorithm yet, but here are already some minor comments:

- Why is `self._sym` copied but `self._antisym` not? From the first glimpse, a copy doesn't seem to be necessary anyway.
- Very minor (PEP norm):

```diff
- for k in range(1,len(isym)):
+ for k in range(1, len(isym)):
```



---

Comment by @mjungmath created at 2021-08-05 12:32:06

Very nice by the way. This could make a significant difference in sophisticated computations (especially since this generator is not cached). I am very curious about the timings of the SageManifolds example notebooks!


---

Comment by egourgoulhon created at 2021-08-05 12:42:01

Thanks for improving significantly the generator of non-redundant indices! 
There is an issue with the ordering of the output though, which affects the display of Christoffel symbols: the output shall respect the ordering of the coordinates, i.e. the doctests should not be modified.


---

Comment by egourgoulhon created at 2021-08-05 12:42:01

Changing status from needs_review to needs_work.


---

Comment by @spaghettisalat created at 2021-08-05 13:05:49

Replying to [comment:8 egourgoulhon]:
> Thanks for improving significantly the generator of non-redundant indices! 
> There is an issue with the ordering of the output though, which affects the display of Christoffel symbols: the output shall respect the ordering of the coordinates, i.e. the doctests should not be modified.

Is that really important? The order in which the components of tensors are displayed is a matter of personal taste, the mathematical results are the same anyway. Generating the indices in exactly the same order as we did previously would make the algorithm significantly more complicated.


---

Comment by egourgoulhon created at 2021-08-05 14:05:23

Replying to [comment:9 gh-spaghettisalat]:
> Replying to [comment:8 egourgoulhon]:
> > Thanks for improving significantly the generator of non-redundant indices! 
> > There is an issue with the ordering of the output though, which affects the display of Christoffel symbols: the output shall respect the ordering of the coordinates, i.e. the doctests should not be modified.
> 
> Is that really important? 

Yes I think so. Christoffel symbols are usually lengthy objects and displaying them in random order is not very useful. Ordered display is required for publishing or comparing with previously known results (e.g. textbook, wikipedia). 

>The order in which the components of tensors are displayed is a matter of personal taste, the mathematical results are the same anyway. Generating the indices in exactly the same order as we did previously would make the algorithm significantly more complicated.

Can one devise another method, just for display purposes, which would reorder the output of `non_redundant_index_generator`?


---

Comment by @spaghettisalat created at 2021-08-05 15:06:12

Replying to [comment:10 egourgoulhon]:
> Replying to [comment:9 gh-spaghettisalat]:
> > Replying to [comment:8 egourgoulhon]:
> > > Thanks for improving significantly the generator of non-redundant indices! 
> > > There is an issue with the ordering of the output though, which affects the display of Christoffel symbols: the output shall respect the ordering of the coordinates, i.e. the doctests should not be modified.
> > 
> > Is that really important? 
> 
> Yes I think so. Christoffel symbols are usually lengthy objects and displaying them in random order is not very useful. Ordered display is required for publishing or comparing with previously known results (e.g. textbook, wikipedia). 
> 

The order is not random, it is just slightly different than before. For the christoffel symbols, previously the indices would increase from right to left, now the first index increases before the last two ones. In general, the new algorithm first increases unsymmetrized indices, then symmetrized and finally antisymmetrized ones. One could also do this in a different order (for instance first increase the antisymmetrized indices), which would restore the old order at least for christoffel symbols. But I don't really see the point of that, since there is no universally agreed standard for in which order one should display the indices.

> >The order in which the components of tensors are displayed is a matter of personal taste, the mathematical results are the same anyway. Generating the indices in exactly the same order as we did previously would make the algorithm significantly more complicated.
> 
> Can one devise another method, just for display purposes, which would reorder the output of `non_redundant_index_generator`?

You could of course just convert all of the indices into a list and sort that one via `list(tensor.non_redundant_index_generator()).sort()`. This is a bit inefficient but for display purposes, this should be fine.


---

Comment by @mjungmath created at 2021-08-05 15:26:47

I agree with Eric. Ordering the indices by coordinates is extremely convenient, at least for the output.

Since this seems only affect the Christoffel symbols, I can live with sorting them afterwards, even for the price of a small slow down in that case (which, I suspect, is still faster than the current implementation).

On the other hand, please keep in mind that there is a refactoring of the components's module going on in #30307. To that end, we will cache results related to symmetry such as this iterator.


---

Comment by git created at 2021-08-05 18:36:43

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @spaghettisalat created at 2021-08-05 18:44:01

I have implemented sorting of the indices for display. All outputs should now appear the same way as before.

> Changed 6 hours ago by gh-mjungmath:

> Haven't checked the algorithm yet, but here are already some minor comments:

>  * Why is self._sym copied but self._antisym not? From the first glimpse, a copy doesn't seem to be necessary anyway.

Because this is modified later on. The new algorithm treats non-symmetrized indices as a symmetrization of a single index and adds those to the `sym` list.

> * Very minor (PEP norm):
>{{{
>    - for k in range(1,len(isym)):
>    + for k in range(1, len(isym)):
> }}}

This has been fixed.

> Very nice by the way. This could make a significant difference in sophisticated computations (especially since this generator is not cached). I am very curious about the timings of the SageManifolds example notebooks! 

As long as these examples are in dimensions below 6, I doubt that this will make a significant impact.


---

Comment by @spaghettisalat created at 2021-08-05 18:44:43

Changing status from needs_work to needs_review.


---

Comment by egourgoulhon created at 2021-08-07 09:30:37

Thanks for the changes! 
Michael, do you agree with the positive review?


---

Comment by egourgoulhon created at 2021-08-07 09:30:37

Changing status from needs_review to positive_review.


---

Comment by @mjungmath created at 2021-08-07 15:51:05

I really dislike the usage of flags within loops, in this case `step_finished`. My intuition tells me, it should be possible to simplify the code much further. But I immediately don't see how.

But this is personal taste, and for now this should be fine.


---

Comment by @mjungmath created at 2021-08-07 16:01:17

This is a huge improvement though. Thank you Marius!


---

Comment by @spaghettisalat created at 2021-08-07 17:10:38

Replying to [comment:17 gh-mjungmath]:
> I really dislike the usage of flags within loops, in this case `step_finished`. My intuition tells me, it should be possible to simplify the code much further. But I immediately don't see how.

If only python had a goto statement...


---

Comment by slelievre created at 2021-08-07 18:10:28

Minor comments, feel free to ignore any or all of them.

Possible simplification for getting a sorted list:

```diff
-            generator = list(self.non_redundant_index_generator())
-            generator.sort()
+            generator = sorted(self.non_redundant_index_generator())
```


PEP8 recommends 2 spaces before inline comments
(and some suggested rephrasings):


```diff
-                    return # end point reached
+                    return  # end point reached
```



```diff
-        sym = self._sym.copy() # we may modify this in the following
+        sym = self._sym.copy()  # make a copy we can modify
```



```diff
-            step_finished = False # each step generates a new index
+            step_finished = False  # each step generates a new index
```



```diff
+                    return # end point reach
+                    return  # end point reached
```


Longer comments can go on their own line(s)
(and sometimes be made a bit shorter):


```diff
-                sym.append([pos]) # treat non-symmetrized indices as being symmetrized with themselves
+                # treat non-symmetrized indices as symmetrized with themselves
+                sym.append([pos])
```



```diff
-                    return # we went through all indices and didn't
-                           # find one which we can increase, thus we
-                           # have generated all indices
+                    # we went through all indices and none could be
+                    # increased, so we have generated all indices
+                    return
```


The following give the same boolean:

- `not any([a in b for b in c]) and not any([a in b for b in d])`
- `all(a not in b for e in (c, d) for b in e)`

so one could rewrite:


```diff
-            if not any([pos in isym for isym in sym]) and not any([pos in isym for isym in antisym]):
+            if all(pos not in isym for xsym in (sym, antisym) for isym in xsym):
```


Calling the flag `done` rather than `step_finished`,
one would read: `if not done: ...`.

Possible rewriting given how Python
turns numbers and lists to booleans:


```diff
-                if not step_finished and i == 0 and len(antisym) == 0:
+                if not step_finished and not i and not antisym:
```


Maybe shorten this comment:

```diff
-                            # this index is at the maximum and we have
-                            # to reset it
+                            # this index is at the maximum; reset it
```


Maybe add spaces around + and -, and after commas,
in several instances of:

```diff
- range(len(sym)-1,-1,-1)
+ range(len(sym) - 1, -1, -1)
```



---

Comment by @mjungmath created at 2021-08-07 18:36:59

I ponder, is the outer while-loop even necessary? Couldn't you just split this whole thing into two separated loops and `yield` within those? Then the code gets much simpler and the flag becomes obsolete.


---

Comment by @mjungmath created at 2021-08-07 19:46:31

Replying to [comment:19 gh-spaghettisalat]:
> Replying to [comment:17 gh-mjungmath]:
> > I really dislike the usage of flags within loops, in this case `step_finished`. My intuition tells me, it should be possible to simplify the code much further. But I immediately don't see how.
> 
> If only python had a goto statement...

http://entrian.com/goto/ :P


---

Comment by egourgoulhon created at 2021-08-09 07:50:13

Replying to [comment:20 slelievre]:
> 
> Possible rewriting given how Python
> turns numbers and lists to booleans:
> 
> {{{#!diff
> -                if not step_finished and i == 0 and len(antisym) == 0:
> +                if not step_finished and not i and not antisym:
> }}}
> 
Personally, I don't agree with that one. Of course, `not i` is more pythonic, but I find it less readable than `i == 0`, especially in the current context, where `i` is an integer.


---

Comment by vbraun created at 2021-09-05 21:38:36

Resolution: fixed
