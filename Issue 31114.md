# Issue 31114: Instance where Maxima's integrator fails to return when called with numerical constants instead of literal ones.

Issue created by migration from https://trac.sagemath.org/ticket/31351

Original creator: charpent

Original creation time: 2021-02-06 19:44:48

Found in this `ask.sagemath`[question](https://ask.sagemath.org/question/55601/problem-with-integration/) :


```
var('z,w,x,om')
E1=200
nu=0.33
rho1=7850
Pi=pi.n()
ah=5
e0=0.25
h=1/ah
em=1-sqrt(1-e0)
aa=Pi*z/(2*h)+Pi/(4); 
Ez=E1*(1-e0*(cos(aa)));
rhoz=rho1*(1-em*(cos(aa)));
Q11=Ez;
## This works
A11=integral(Q11,z,-h/2,h/2);
## This fails to  return
B11=integral(Q11*z,z,-h/2,h/2);
D11=integral(Q11*z^2,z,-h/2,h/2);
```


However, `sympy`'s `integrate` works on those numerical expression,as do numerical substitution on literal explicit integration via `Maxima`'s `integrate`:


```
var("a,b,c,d,e")
D1={a:-50.0000000000000,b:7.85398163397448,c:0.785398163397448,d:200,e:1/5}
Q=a*cos(b*z+c)+d
```



```
## This works with Maxima's integrate
sage: integrate(Q11,z,-h/2,h/2,algorithm="sympy")
33.6338022763242
## Explicit literal solution
sage: integrate(Q,z,-e/2,e/2)
(b*d*e + a*sin(1/2*b*e + c) + a*sin(1/2*b*e - c))/b
## Numerical substitution
sage: integrate(Q,z,-e/2,e/2).subs(D1)
33.6338022763242
## This fails in the default(Maxima's) integrator, but works with sympy's :
sage: integrate(Q11*z,z,-h/2,h/2,algorithm="sympy")
0.173949696771121
## Lirteral solution
sage: integrate(Q*z,z,-e/2,e/2)
1/8*(b^2*d*e^2 + 4*a*b*e*sin(1/2*b*e + c) - 4*c^2*d + 8*a*cos(1/2*b*e + c))/b^2 - 1/8*(b^2*d*e^2 + 4*a*b*e*sin(1/2*b*e - c) - 4*c^2*d + 8*a*cos(1/2*b*e - c))/b^2
## Numerical substitution
sage: integrate(Q*z,z,-e/2,e/2).subs(D1)
0.173949696771121
## This also fails in Maxima :
sage: integrate(Q11*z^2,z,-h/2,h/2,algorithm="sympy")
0.113967282641312
## Literal solution
sage: integrate(Q*z^2,z,-e/2,e/2)
1/24*(b^3*d*e^3 + 8*c^3*d + 24*a*b*e*cos(1/2*b*e + c) + 6*(a*b^2*e^2 - 8*a)*sin(1/2*b*e + c))/b^3 + 1/24*(b^3*d*e^3 - 8*c^3*d + 24*a*b*e*cos(1/2*b*e - c) + 6*(a*b^2*e^2 - 8*a)*sin(1/2*b*e - c))/b^3
## Numerical substitution
sage: integrate(Q*z^2,z,-e/2,e/2).subs(D1)
0.113967282641312
```


Priority left at "major", since workarounds aren't //that// hard to come by...


---

Comment by charpent created at 2021-02-06 20:45:22

The problem is in `Maxima`

Maxima'ized source :


```
E1:200;
nu:0.33;
rho1:7850;
Pi:%pi,numer;
ah:5;
e0:0.25;
h:1/ah;
em:1-sqrt(1-e0);
aa:Pi*z/(2*h)+Pi/(4); 
Ez:E1*(1-e0*(cos(aa)));
rhoz:rho1*(1-em*(cos(aa)));
Q11:Ez;
A11:integrate(Q11,z,-h/2,h/2),numer;
B11:integrate(Q11*z,z,-h/2,h/2),numer;
```


Execution :


```
(%i45) E1:200;
(%o45)                                200
(%i46) nu:0.33;
(%o46)                               0.33
(%i47) rho1:7850;
(%o47)                               7850
(%i48) Pi:%pi,numer;
(%o48)                         3.141592653589793
(%i49) ah:5;
(%o49)                                 5
(%i50) e0:0.25;
(%o50)                               0.25
(%i51) h:1/ah;
                                       1
(%o51)                                 -
                                       5
(%i52) em:1-sqrt(1-e0);
(%o52)                        0.1339745962155614
(%i53) aa:Pi*z/(2*h)+Pi/(4);
(%o53)             7.853981633974483 z + 0.7853981633974483
(%i54) Ez:E1*(1-e0*(cos(aa)));
(%o54)   200 (1 - 0.25 cos(7.853981633974483 z + 0.7853981633974483))
(%i55) rhoz:rho1*(1-em*(cos(aa)));
(%o55) 7850 (1 - 0.1339745962155614 cos(7.853981633974483 z
                                                         + 0.7853981633974483))
(%i56) Q11:Ez;
(%o56)   200 (1 - 0.25 cos(7.853981633974483 z + 0.7853981633974483))
(%i57) A11:integrate(Q11,z,-h/2,h/2),numer;

rat: replaced 0.2 by 1/5 = 0.2

rat: replaced -0.1 by -1/10 = -0.1

rat: replaced 0.1 by 1/10 = 0.1

rat: replaced 0.2 by 1/5 = 0.2

rat: replaced 0.7853981633974483 by 15971451/20335483 = 0.7853981633974467

rat: replaced 7.853981633974483 by 42781604/5447123 = 7.853981633974485

rat: replaced -0.25 by -1/4 = -0.25

rat: replaced 0.7853981633974483 by 15971451/20335483 = 0.7853981633974467

rat: replaced 7.853981633974483 by 42781604/5447123 = 7.853981633974485

rat: replaced -0.7853981633974483 by -15971451/20335483 = -0.7853981633974467

rat: replaced 7.853981633974483 by 42781604/5447123 = 7.853981633974485

rat: replaced -0.25 by -1/4 = -0.25

rat: replaced -0.25 by -1/4 = -0.25

rat: replaced 0.2 by 1/5 = 0.2

rat: replaced -0.1 by -1/10 = -0.1

rat: replaced 0.1 by 1/10 = 0.1

rat: replaced 0.2 by 1/5 = 0.2

rat: replaced 0.2 by 1/5 = 0.2

rat: replaced -0.1 by -1/10 = -0.1

rat: replaced 0.1 by 1/10 = 0.1

rat: replaced 0.2 by 1/5 = 0.2

rat: replaced 0.7853981633974483 by 15971451/20335483 = 0.7853981633974467

rat: replaced 7.853981633974483 by 42781604/5447123 = 7.853981633974485

rat: replaced -0.7853981633974483 by -15971451/20335483 = -0.7853981633974467

rat: replaced 7.853981633974483 by 42781604/5447123 = 7.853981633974485

rat: replaced 0.2 by 1/5 = 0.2

rat: replaced -0.1 by -1/10 = -0.1

rat: replaced 0.1 by 1/10 = 0.1

rat: replaced 0.2 by 1/5 = 0.2

rat: replaced 0.7853981633974483 by 15971451/20335483 = 0.7853981633974467

rat: replaced 1.0 by 1/1 = 1.0

rat: replaced -0.7853981633974483 by -15971451/20335483 = -0.7853981633974467

rat: replaced 0.1273239544735163 by 5447123/42781604 = 0.1273239544735162

rat: replaced 0.7853981633974483 by 15971451/20335483 = 0.7853981633974467

rat: replaced 1.0 by 1/1 = 1.0

rat: replaced -0.7853981633974483 by -15971451/20335483 = -0.7853981633974467

rat: replaced 0.1273239544735163 by 5447123/42781604 = 0.1273239544735162

rat: replaced 0.7853981633974483 by 15971451/20335483 = 0.7853981633974467

rat: replaced 7.853981633974483 by 42781604/5447123 = 7.853981633974485

rat: replaced 0.7853981633974483 by 15971451/20335483 = 0.7853981633974467

rat: replaced 7.853981633974483 by 42781604/5447123 = 7.853981633974485

rat: replaced 0.1273239544735163 by 5447123/42781604 = 0.1273239544735162

rat: replaced 0.0 by 0/1 = 0.0

rat: replaced 0.1273239544735163 by 5447123/42781604 = 0.1273239544735162

rat: replaced 0.1681690113816209 by 6186778/36789049 = 0.1681690113816207
(%o57)                         33.63380227632413
(%i58) B11:integrate(Q11*z,z,-h/2,h/2),numer;

rat: replaced 0.2 by 1/5 = 0.2

rat: replaced -0.1 by -1/10 = -0.1

rat: replaced 0.1 by 1/10 = 0.1

rat: replaced 0.2 by 1/5 = 0.2

rat: replaced 0.7853981633974483 by 15971451/20335483 = 0.7853981633974467

rat: replaced 7.853981633974483 by 42781604/5447123 = 7.853981633974485

rat: replaced -0.7853981633974483 by -15971451/20335483 = -0.7853981633974467

rat: replaced 7.853981633974483 by 42781604/5447123 = 7.853981633974485

rat: replaced -0.25 by -1/4 = -0.25

rat: replaced -0.25 by -1/4 = -0.25

rat: replaced 0.2 by 1/5 = 0.2

rat: replaced -0.1 by -1/10 = -0.1

rat: replaced 0.1 by 1/10 = 0.1

rat: replaced 0.2 by 1/5 = 0.2

rat: replaced 0.7853981633974483 by 15971451/20335483 = 0.7853981633974467

rat: replaced 1.0 by 1/1 = 1.0

rat: replaced -0.7853981633974483 by -15971451/20335483 = -0.7853981633974467

rat: replaced 0.01621138938277404 by 1190069/73409439 = 0.01621138938277406

rat: replaced -0.25 by -1/4 = -0.25

rat: replaced -0.7853981633974483 by -15971451/20335483 = -0.7853981633974467

rat: replaced 0.7853981633974483 by 15971451/20335483 = 0.7853981633974467

rat: replaced 1.0 by 1/1 = 1.0

rat: replaced -0.7853981633974483 by -15971451/20335483 = -0.7853981633974467

rat: replaced 0.01621138938277404 by 1190069/73409439 = 0.01621138938277406

rat: replaced -0.7853981633974483 by -15971451/20335483 = -0.7853981633974467

rat: replaced -0.25 by -1/4 = -0.25

rat: replaced 0.7853981633974483 by 15971451/20335483 = 0.7853981633974467

rat: replaced 7.853981633974483 by 42781604/5447123 = 7.853981633974485

rat: replaced -0.25 by -1/4 = -0.25

rat: replaced 0.7853981633974483 by 15971451/20335483 = 0.7853981633974467

rat: replaced 7.853981633974483 by 42781604/5447123 = 7.853981633974485
  C-c C-c
;;;
;;; Frame stack overflow.
;;; Jumping to the outermost toplevel prompt
;;;
```



---

Comment by charpent created at 2021-02-06 20:48:10

Help about how to report the problem to Maxima's developers welcome...


---

Comment by @DaveWitteMorris created at 2021-02-06 21:15:06

The maxima bug tracker is at https://sourceforge.net/p/maxima/bugs/ but the "Create Ticket" button has a popup that says "To create a new ticket, you must be authorized by the project admin."  The mailing list seems to be another option: "Any Maxima related issues can be discussed in this list, from very simple beginner's questions, to specific development ideas. To post a message in this list, send email to maxima-discuss[at]lists.sourceforge.net."


---

Comment by charpent created at 2021-02-07 16:51:15

This is now bug [#3712](https://sourceforge.net/p/maxima/bugs/3712/) on Maxima's bug report system.


---

Comment by slelievre created at 2021-02-07 17:08:42

Discussion on maxima-discuss:

- https://sourceforge.net/p/maxima/mailman/message/37214604/
- https://sourceforge.net/p/maxima/mailman/message/37214636/


---

Comment by @macrakis created at 2021-02-07 17:53:36

This is actually both a Sage bug and a Maxima bug.

Sage should not be using integrate(...),numer or even simply integrate(...) to mean "perform a numerical integration".

Maxima's integrate is not really designed for floating-point coefficients. It works "by accident" for them. Curiously, in this particular case, all it takes is converting the coefficients to rationals to make it work (which surprised me, but...):

```
B11:'integrate(z*(1-0.25*cos(7.853981633974483*z+0.7853981633974483)),z,0,1)$
ev(B11,nouns) << carry out integration as is -- blows up
B11r: scanmap('ratsimp,B11)$    <<< converts all floats to rats
B11rn: ev(B11r,nouns)  <<< carries out integration
B11num: float(B11rn)  => 0.48...
```

Though this is still a Maxima bug, it is only being seen by Sage because Sage is mis-using the integrate command.

By the way, the 14-line example isn't needed. A much simpler case that tickles the bug is:

```
integrate(z*cos(7.853981633974483*z),z,0,1)$
```

Interestingly, neither of these tickles the bug:

```
integrate(z*cos(7.85*z),z,0,1)$
integrate(z*cos(rat(7.853981633974483)*z),z,0,1);
```



---

Comment by @robert-dodier created at 2021-02-07 18:25:13

Hi, thanks to everybody for working on this. I agree w/ Stavros that there is a minor bug in Sage here, namely that "get a numerical result for an integral" isn't `integrate(...), numer` in Maxima, but rather most nearly equivalent would be a call to a quadpack function (`quad_qag` and friends). 

The difficulties that Maxima has with floats and rationalized floats in `integrate` is/are one or more bugs and I agree they are important and need to be fixed. Thanks for the bug reports, it does help.


---

Comment by charpent created at 2021-02-16 09:00:49

Robert Dodier just mailed/posted a fix and marked the Maxima bug as solved.

Possibly in a later version of Maxima ?


---

Comment by mkoeppe created at 2021-05-10 17:42:09

Moving to 9.4, as 9.3 has been released.
