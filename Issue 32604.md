# Issue 32604: zn_poly removal

archive/issues_032604.json:
```json
{
    "body": "CC:  @alexjbest\n\nThe zn_poly SPKG is used by sage in only one place. In hypellfrob.cpp's `interval_products_wrapper()`, there is a case...\n\n\n```C++\nif (!force_ntl  &&  modulus <= (1UL << (ULONG_BITS - 1)) - 1)\n{\n   // Small modulus; let's try using zn_poly if we're allowed.\n   ...\n```\n\n\nBut sometimes that fails, and the fallback is to use NTL anyway. The zn_poly project was abandoned upstream in 2008:\n\n  https://web.maths.unsw.edu.au/~davidharvey/code/zn_poly/index.html\n\nWe've forked it to keep it building on modern systems,\n\n  https://gitlab.com/sagemath/zn_poly\n\nbut the build system is still a mess. Erik started an autotools branch (https://gitlab.com/sagemath/zn_poly/-/tree/autotooling), but it never got finished, because the source layout is a bit weird for autotools and it should most likely be redone from scratch.\n\nAnd zn_poly is not packaged in Gentoo because of how many hacks it still requires to build on a distro with stronger user experience expectations:\n\n  https://github.com/cschwan/sage-on-gentoo/blob/master/sci-libs/zn_poly/zn_poly-0.9.2.ebuild\n\nIn short, we're not getting a lot of benefit out of zn_poly these days, and nothing breaks if we remove it, because the one function that uses it falls back to the more-reliable NTL anyway.\n\nIn this ticket we remove the zn_poly SPKG, to avoid having to rewrite its build system some day.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/32841\n\n",
    "created_at": "2021-11-09T12:53:28Z",
    "labels": [
        "packages: standard",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "zn_poly removal",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32604",
    "user": "@orlitzky"
}
```
CC:  @alexjbest

The zn_poly SPKG is used by sage in only one place. In hypellfrob.cpp's `interval_products_wrapper()`, there is a case...


```C++
if (!force_ntl  &&  modulus <= (1UL << (ULONG_BITS - 1)) - 1)
{
   // Small modulus; let's try using zn_poly if we're allowed.
   ...
```


But sometimes that fails, and the fallback is to use NTL anyway. The zn_poly project was abandoned upstream in 2008:

  https://web.maths.unsw.edu.au/~davidharvey/code/zn_poly/index.html

We've forked it to keep it building on modern systems,

  https://gitlab.com/sagemath/zn_poly

but the build system is still a mess. Erik started an autotools branch (https://gitlab.com/sagemath/zn_poly/-/tree/autotooling), but it never got finished, because the source layout is a bit weird for autotools and it should most likely be redone from scratch.

And zn_poly is not packaged in Gentoo because of how many hacks it still requires to build on a distro with stronger user experience expectations:

  https://github.com/cschwan/sage-on-gentoo/blob/master/sci-libs/zn_poly/zn_poly-0.9.2.ebuild

In short, we're not getting a lot of benefit out of zn_poly these days, and nothing breaks if we remove it, because the one function that uses it falls back to the more-reliable NTL anyway.

In this ticket we remove the zn_poly SPKG, to avoid having to rewrite its build system some day.


Issue created by migration from https://trac.sagemath.org/ticket/32841





---

archive/issue_comments_465020.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-11-09T13:11:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32604#issuecomment-465020",
    "user": "@orlitzky"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_465021.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2021-11-09T13:11:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32604#issuecomment-465021",
    "user": "@orlitzky"
}
```

Last 10 new commits:



---

archive/issue_comments_465022.json:
```json
{
    "body": "There's a discussion on sage-devel about how much/whether we're giving up speed by switching from zn_poly to NTL.  I'd like to do some benchmarking before removing this package.",
    "created_at": "2021-11-09T23:37:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32604#issuecomment-465022",
    "user": "@roed314"
}
```

There's a discussion on sage-devel about how much/whether we're giving up speed by switching from zn_poly to NTL.  I'd like to do some benchmarking before removing this package.



---

archive/issue_comments_465023.json:
```json
{
    "body": "No problem, I'm not in a hurry.\n\nIs it even possible to hit the zn_poly branch from within the normal sage user interface? The only call to `interval_products_wrapper()` I see (before or after this branch) passes `force_ntl=1`. You could still conceivably call it directly from within your own library, though.",
    "created_at": "2021-11-10T00:15:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32604#issuecomment-465023",
    "user": "@orlitzky"
}
```

No problem, I'm not in a hurry.

Is it even possible to hit the zn_poly branch from within the normal sage user interface? The only call to `interval_products_wrapper()` I see (before or after this branch) passes `force_ntl=1`. You could still conceivably call it directly from within your own library, though.



---

archive/issue_comments_465024.json:
```json
{
    "body": "Yes.  Line 257 of [hypellfrob.pyx](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/schemes/hyperelliptic_curves/hypellfrob.pyx#n257) calls `hypellfrob_matrix`, which has `force_ntl=0` [by default](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/schemes/hyperelliptic_curves/hypellfrob/hypellfrob.h#n86).  This function is called various places: `matrix_of_frobenius` in `sage.schemes.elliptic_curves.padics`, `frobenius_matrix` and `count_points` in `sage.schemes.hyperelliptic_curves.hyperelliptic_finite_field.py`.",
    "created_at": "2021-11-10T00:33:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32604#issuecomment-465024",
    "user": "@roed314"
}
```

Yes.  Line 257 of [hypellfrob.pyx](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/schemes/hyperelliptic_curves/hypellfrob.pyx#n257) calls `hypellfrob_matrix`, which has `force_ntl=0` [by default](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/schemes/hyperelliptic_curves/hypellfrob/hypellfrob.h#n86).  This function is called various places: `matrix_of_frobenius` in `sage.schemes.elliptic_curves.padics`, `frobenius_matrix` and `count_points` in `sage.schemes.hyperelliptic_curves.hyperelliptic_finite_field.py`.



---

archive/issue_comments_465025.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-11-10T00:46:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32604#issuecomment-465025",
    "user": "@orlitzky"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_465026.json:
```json
{
    "body": "Replying to [comment:4 roed]:\n> Yes...\n\nAh, I didn't see `matrix()` at the bottom of `hypellfrob.h`. Ok. Do you have a plan for benchmarking? I can throw random inputs at it but I don't want to unfairly bias the results with poor choices for test cases.",
    "created_at": "2021-11-10T00:46:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32604#issuecomment-465026",
    "user": "@orlitzky"
}
```

Replying to [comment:4 roed]:
> Yes...

Ah, I didn't see `matrix()` at the bottom of `hypellfrob.h`. Ok. Do you have a plan for benchmarking? I can throw random inputs at it but I don't want to unfairly bias the results with poor choices for test cases.



---

archive/issue_comments_465027.json:
```json
{
    "body": "Has anyone asked David Harvey about this?",
    "created_at": "2021-11-11T12:17:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32604#issuecomment-465027",
    "user": "@JohnCremona"
}
```

Has anyone asked David Harvey about this?



---

archive/issue_comments_465028.json:
```json
{
    "body": "Replying to [comment:6 cremona]:\n> Has anyone asked David Harvey about this?\n\nNo, but his webpage is pretty clear:\n\n> **Current status**\n>\n> zn_poly is no longer maintained.\n\nIt's maintained by the sage team and essentially has been (via patches) for over a decade. With all due respect, if he's not going to help maintain the code, what can his opinion change?\n\nIf there's a huge performance regression (I'll need help with realistic test cases that don't make zn_poly fail and fall back to NTL unusually often), then we'll have to keep it around until NTL gets faster. But otherwise, the decision whether to keep it for nostalgia's sake alone should rest with the people who are going to have to maintain it.",
    "created_at": "2021-11-11T13:54:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32604#issuecomment-465028",
    "user": "@orlitzky"
}
```

Replying to [comment:6 cremona]:
> Has anyone asked David Harvey about this?

No, but his webpage is pretty clear:

> **Current status**
>
> zn_poly is no longer maintained.

It's maintained by the sage team and essentially has been (via patches) for over a decade. With all due respect, if he's not going to help maintain the code, what can his opinion change?

If there's a huge performance regression (I'll need help with realistic test cases that don't make zn_poly fail and fall back to NTL unusually often), then we'll have to keep it around until NTL gets faster. But otherwise, the decision whether to keep it for nostalgia's sake alone should rest with the people who are going to have to maintain it.



---

archive/issue_comments_465029.json:
```json
{
    "body": "I've been throwing examples at this for an hour or so. I've hacked my local tree to make `hypellfrob` take a `force_ntl` parameter, and to alert me when zn_poly fails and falls back to NTL. I've been picking my `p,Q,N` by hand for lack of a better approach.\n\nI'll cut to the chase: the biggest difference between the two in favor of zn_poly is on the order of...\n\n\n```\nsage: %timeit hypellfrob(p, 3, f, force_ntl=False)\n864 ms \u00b1 5.09 ms per loop (mean \u00b1 std. dev. of 7 runs, 1 loop each)\nsage: %timeit hypellfrob(p, 3, f, force_ntl=True)\n1.2 s \u00b1 5.06 ms per loop (mean \u00b1 std. dev. of 7 runs, 1 loop each)\n```\n\n\nTypically, they're a bit closer together, with zn_poly having a slight edge. And when zn_poly fails, of course, the NTL-only strategy wins by a huge margin (however long it takes zn_poly to fail).\n\nSo the question is, is a slowdown like this (for the cases that zn_poly can handle) a deal-breaker, considering the improvement in the cases it cannot?",
    "created_at": "2021-12-02T18:59:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32604#issuecomment-465029",
    "user": "@orlitzky"
}
```

I've been throwing examples at this for an hour or so. I've hacked my local tree to make `hypellfrob` take a `force_ntl` parameter, and to alert me when zn_poly fails and falls back to NTL. I've been picking my `p,Q,N` by hand for lack of a better approach.

I'll cut to the chase: the biggest difference between the two in favor of zn_poly is on the order of...


```
sage: %timeit hypellfrob(p, 3, f, force_ntl=False)
864 ms ± 5.09 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
sage: %timeit hypellfrob(p, 3, f, force_ntl=True)
1.2 s ± 5.06 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
```


Typically, they're a bit closer together, with zn_poly having a slight edge. And when zn_poly fails, of course, the NTL-only strategy wins by a huge margin (however long it takes zn_poly to fail).

So the question is, is a slowdown like this (for the cases that zn_poly can handle) a deal-breaker, considering the improvement in the cases it cannot?



---

archive/issue_comments_465030.json:
```json
{
    "body": "Changing status from needs_work to needs_info.",
    "created_at": "2021-12-02T18:59:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32604#issuecomment-465030",
    "user": "@orlitzky"
}
```

Changing status from needs_work to needs_info.



---

archive/issue_comments_465031.json:
```json
{
    "body": "My suggestion would be to downgrade `zn_poly` to \"experimental\" and to change the defaults to the code path that does not use it, but to still keep the code that calls `zn_poly` for a little while as an option. Instead of `force_ntl`, how about an `algorithm` parameter, similar to what many other functions accept.",
    "created_at": "2021-12-02T19:14:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32604#issuecomment-465031",
    "user": "@mkoeppe"
}
```

My suggestion would be to downgrade `zn_poly` to "experimental" and to change the defaults to the code path that does not use it, but to still keep the code that calls `zn_poly` for a little while as an option. Instead of `force_ntl`, how about an `algorithm` parameter, similar to what many other functions accept.



---

archive/issue_comments_465032.json:
```json
{
    "body": "Replying to [comment:9 mkoeppe]:\n> My suggestion would be to downgrade `zn_poly` to \"experimental\" and to change the defaults to the code path that does not use it, but to still keep the code that calls `zn_poly` for a little while as an option. Instead of `force_ntl`, how about an `algorithm` parameter, similar to what many other functions accept.\n\nI'm willing to do this, but first, can I selfishly request at least one user come forward who would actually use it?",
    "created_at": "2021-12-03T00:58:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32604#issuecomment-465032",
    "user": "@orlitzky"
}
```

Replying to [comment:9 mkoeppe]:
> My suggestion would be to downgrade `zn_poly` to "experimental" and to change the defaults to the code path that does not use it, but to still keep the code that calls `zn_poly` for a little while as an option. Instead of `force_ntl`, how about an `algorithm` parameter, similar to what many other functions accept.

I'm willing to do this, but first, can I selfishly request at least one user come forward who would actually use it?



---

archive/issue_comments_465033.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2021-12-15T00:48:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32604#issuecomment-465033",
    "user": "@orlitzky"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_465034.json:
```json
{
    "body": "As one of the people who initially requested a speed comparison, I'm content with the removal of `zn_poly` rather than making mjo put the work into making it experimental.  I think that the speed difference is not worth the maintenance burden.\n\nI'll check with Alex to see if he agrees, and then am happy to review this.",
    "created_at": "2021-12-20T08:53:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32604#issuecomment-465034",
    "user": "@roed314"
}
```

As one of the people who initially requested a speed comparison, I'm content with the removal of `zn_poly` rather than making mjo put the work into making it experimental.  I think that the speed difference is not worth the maintenance burden.

I'll check with Alex to see if he agrees, and then am happy to review this.



---

archive/issue_comments_465035.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2022-01-13T22:53:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32604#issuecomment-465035",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_465036.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2022-04-23T21:06:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32604#issuecomment-465036",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_465037.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2022-05-13T22:43:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32604#issuecomment-465037",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_465038.json:
```json
{
    "body": "needs a rebase",
    "created_at": "2022-12-07T20:28:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32604#issuecomment-465038",
    "user": "@dimpase"
}
```

needs a rebase



---

archive/issue_comments_465039.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2022-12-07T21:07:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32604#issuecomment-465039",
    "user": "@dimpase"
}
```

Last 10 new commits:



---

archive/issue_comments_465040.json:
```json
{
    "body": "Thanks, I don't have sage built anywhere at the moment so it would have taken me a lot longer to do that.",
    "created_at": "2022-12-07T21:14:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32604#issuecomment-465040",
    "user": "@orlitzky"
}
```

Thanks, I don't have sage built anywhere at the moment so it would have taken me a lot longer to do that.



---

archive/issue_comments_465041.json:
```json
{
    "body": "I'll hit \"positive review\" as soon as tests are run and OK",
    "created_at": "2022-12-07T21:23:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32604#issuecomment-465041",
    "user": "@dimpase"
}
```

I'll hit "positive review" as soon as tests are run and OK



---

archive/issue_comments_465042.json:
```json
{
    "body": "it works, and so let Sage have one obsolete dependency less.",
    "created_at": "2022-12-07T23:30:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32604#issuecomment-465042",
    "user": "@dimpase"
}
```

it works, and so let Sage have one obsolete dependency less.



---

archive/issue_comments_465043.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-12-07T23:30:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32604#issuecomment-465043",
    "user": "@dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_465044.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-12-14T22:12:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32604#issuecomment-465044",
    "user": "@vbraun"
}
```

Resolution: fixed
