# Issue 32604: zn_poly removal

Issue created by migration from https://trac.sagemath.org/ticket/32841

Original creator: mjo

Original creation time: 2021-11-09 12:53:28

CC:  alexjbest

The zn_poly SPKG is used by sage in only one place. In hypellfrob.cpp's `interval_products_wrapper()`, there is a case...


```C++
if (!force_ntl  &&  modulus <= (1UL << (ULONG_BITS - 1)) - 1)
{
   // Small modulus; let's try using zn_poly if we're allowed.
   ...
```


But sometimes that fails, and the fallback is to use NTL anyway. The zn_poly project was abandoned upstream in 2008:

  https://web.maths.unsw.edu.au/~davidharvey/code/zn_poly/index.html

We've forked it to keep it building on modern systems,

  https://gitlab.com/sagemath/zn_poly

but the build system is still a mess. Erik started an autotools branch (https://gitlab.com/sagemath/zn_poly/-/tree/autotooling), but it never got finished, because the source layout is a bit weird for autotools and it should most likely be redone from scratch.

And zn_poly is not packaged in Gentoo because of how many hacks it still requires to build on a distro with stronger user experience expectations:

  https://github.com/cschwan/sage-on-gentoo/blob/master/sci-libs/zn_poly/zn_poly-0.9.2.ebuild

In short, we're not getting a lot of benefit out of zn_poly these days, and nothing breaks if we remove it, because the one function that uses it falls back to the more-reliable NTL anyway.

In this ticket we remove the zn_poly SPKG, to avoid having to rewrite its build system some day.



---

Comment by mjo created at 2021-11-09 13:11:56

Changing status from new to needs_review.


---

Comment by mjo created at 2021-11-09 13:11:56

Last 10 new commits:


---

Comment by roed created at 2021-11-09 23:37:43

There's a discussion on sage-devel about how much/whether we're giving up speed by switching from zn_poly to NTL.  I'd like to do some benchmarking before removing this package.


---

Comment by mjo created at 2021-11-10 00:15:44

No problem, I'm not in a hurry.

Is it even possible to hit the zn_poly branch from within the normal sage user interface? The only call to `interval_products_wrapper()` I see (before or after this branch) passes `force_ntl=1`. You could still conceivably call it directly from within your own library, though.


---

Comment by roed created at 2021-11-10 00:33:35

Yes.  Line 257 of [hypellfrob.pyx](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/schemes/hyperelliptic_curves/hypellfrob.pyx#n257) calls `hypellfrob_matrix`, which has `force_ntl=0` [by default](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/schemes/hyperelliptic_curves/hypellfrob/hypellfrob.h#n86).  This function is called various places: `matrix_of_frobenius` in `sage.schemes.elliptic_curves.padics`, `frobenius_matrix` and `count_points` in `sage.schemes.hyperelliptic_curves.hyperelliptic_finite_field.py`.


---

Comment by mjo created at 2021-11-10 00:46:13

Changing status from needs_review to needs_work.


---

Comment by mjo created at 2021-11-10 00:46:13

Replying to [comment:4 roed]:
> Yes...

Ah, I didn't see `matrix()` at the bottom of `hypellfrob.h`. Ok. Do you have a plan for benchmarking? I can throw random inputs at it but I don't want to unfairly bias the results with poor choices for test cases.


---

Comment by cremona created at 2021-11-11 12:17:51

Has anyone asked David Harvey about this?


---

Comment by mjo created at 2021-11-11 13:54:48

Replying to [comment:6 cremona]:
> Has anyone asked David Harvey about this?

No, but his webpage is pretty clear:

> **Current status**
>
> zn_poly is no longer maintained.

It's maintained by the sage team and essentially has been (via patches) for over a decade. With all due respect, if he's not going to help maintain the code, what can his opinion change?

If there's a huge performance regression (I'll need help with realistic test cases that don't make zn_poly fail and fall back to NTL unusually often), then we'll have to keep it around until NTL gets faster. But otherwise, the decision whether to keep it for nostalgia's sake alone should rest with the people who are going to have to maintain it.


---

Comment by mjo created at 2021-12-02 18:59:29

I've been throwing examples at this for an hour or so. I've hacked my local tree to make `hypellfrob` take a `force_ntl` parameter, and to alert me when zn_poly fails and falls back to NTL. I've been picking my `p,Q,N` by hand for lack of a better approach.

I'll cut to the chase: the biggest difference between the two in favor of zn_poly is on the order of...


```
sage: %timeit hypellfrob(p, 3, f, force_ntl=False)
864 ms ± 5.09 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
sage: %timeit hypellfrob(p, 3, f, force_ntl=True)
1.2 s ± 5.06 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
```


Typically, they're a bit closer together, with zn_poly having a slight edge. And when zn_poly fails, of course, the NTL-only strategy wins by a huge margin (however long it takes zn_poly to fail).

So the question is, is a slowdown like this (for the cases that zn_poly can handle) a deal-breaker, considering the improvement in the cases it cannot?


---

Comment by mjo created at 2021-12-02 18:59:29

Changing status from needs_work to needs_info.


---

Comment by mkoeppe created at 2021-12-02 19:14:11

My suggestion would be to downgrade `zn_poly` to "experimental" and to change the defaults to the code path that does not use it, but to still keep the code that calls `zn_poly` for a little while as an option. Instead of `force_ntl`, how about an `algorithm` parameter, similar to what many other functions accept.


---

Comment by mjo created at 2021-12-03 00:58:54

Replying to [comment:9 mkoeppe]:
> My suggestion would be to downgrade `zn_poly` to "experimental" and to change the defaults to the code path that does not use it, but to still keep the code that calls `zn_poly` for a little while as an option. Instead of `force_ntl`, how about an `algorithm` parameter, similar to what many other functions accept.

I'm willing to do this, but first, can I selfishly request at least one user come forward who would actually use it?


---

Comment by mjo created at 2021-12-15 00:48:22

Changing status from needs_info to needs_review.


---

Comment by roed created at 2021-12-20 08:53:35

As one of the people who initially requested a speed comparison, I'm content with the removal of `zn_poly` rather than making mjo put the work into making it experimental.  I think that the speed difference is not worth the maintenance burden.

I'll check with Alex to see if he agrees, and then am happy to review this.


---

Comment by git created at 2022-01-13 22:53:38

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2022-04-23 21:06:26

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2022-05-13 22:43:46

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by dimpase created at 2022-12-07 20:28:49

needs a rebase


---

Comment by dimpase created at 2022-12-07 21:07:02

Last 10 new commits:


---

Comment by mjo created at 2022-12-07 21:14:39

Thanks, I don't have sage built anywhere at the moment so it would have taken me a lot longer to do that.


---

Comment by dimpase created at 2022-12-07 21:23:07

I'll hit "positive review" as soon as tests are run and OK


---

Comment by dimpase created at 2022-12-07 23:30:42

it works, and so let Sage have one obsolete dependency less.


---

Comment by dimpase created at 2022-12-07 23:30:42

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-12-14 22:12:32

Resolution: fixed
