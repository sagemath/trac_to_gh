# Issue 23147: py3: little cleanup of six and unicode

archive/issues_022910.json:
```json
{
    "body": "various small changes, split off from #23044\n\nCC:  @jdemeyer @tscrim @jhpalmieri\n\nReviewer: John Palmieri\n\nAuthor: Fr\u00e9d\u00e9ric Chapoton\n\nBranch: d3f012d5001ffd879e08cfb5a382f6587d672f1e\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/23147\n\n",
    "closed_at": "2017-06-11T09:13:19Z",
    "created_at": "2017-06-06T09:53:49Z",
    "labels": [
        "component: python3"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "py3: little cleanup of six and unicode",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23147",
    "user": "https://github.com/fchapoton"
}
```
various small changes, split off from #23044

CC:  @jdemeyer @tscrim @jhpalmieri

Reviewer: John Palmieri

Author: Frédéric Chapoton

Branch: d3f012d5001ffd879e08cfb5a382f6587d672f1e

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/23147





---

archive/issue_comments_434384.json:
```json
{
    "body": "Changing branch from \"\" to \"u/chapoton/23147\"",
    "created_at": "2017-06-06T09:54:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23147#issuecomment-434384",
    "user": "https://github.com/fchapoton"
}
```

Changing branch from "" to "u/chapoton/23147"



---

archive/issue_comments_434385.json:
```json
{
    "body": "Changing commit from \"\" to \"d3f012d5001ffd879e08cfb5a382f6587d672f1e\"",
    "created_at": "2017-06-06T09:54:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23147#issuecomment-434385",
    "user": "https://github.com/fchapoton"
}
```

Changing commit from "" to "d3f012d5001ffd879e08cfb5a382f6587d672f1e"



---

archive/issue_comments_434386.json:
```json
{
    "body": "<a id='comment:1'></a>\nNew commits:\n|                                                                                                                                          |                                 |\n|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------|\n|[d3f012d](https://git.sagemath.org/sage.git/commit?id=d3f012d5001ffd879e08cfb5a382f6587d672f1e)|`some cleanup of unicode and six`|",
    "created_at": "2017-06-06T09:54:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23147#issuecomment-434386",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:1'></a>
New commits:
|                                                                                                                                          |                                 |
|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------|
|[d3f012d](https://git.sagemath.org/sage.git/commit?id=d3f012d5001ffd879e08cfb5a382f6587d672f1e)|`some cleanup of unicode and six`|



---

archive/issue_comments_434387.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-06-06T18:05:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23147#issuecomment-434387",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_434388.json:
```json
{
    "body": "Changing reviewer from \"\" to \"John Palmieri\"",
    "created_at": "2017-06-06T21:18:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23147#issuecomment-434388",
    "user": "https://github.com/jhpalmieri"
}
```

Changing reviewer from "" to "John Palmieri"



---

archive/issue_comments_434389.json:
```json
{
    "body": "<a id='comment:3'></a>\nMake this change and I'll be happy with it:\n\n```diff\ndiff --git a/src/sage/algebras/commutative_dga.py b/src/sage/algebras/commutative_dga.py\nindex e571a51c30..a5071198f1 100644\n--- a/src/sage/algebras/commutative_dga.py\n+++ b/src/sage/algebras/commutative_dga.py\n@@ -71,7 +71,7 @@ AUTHORS:\n # (at your option) any later version.\n #                  http://www.gnu.org/licenses/\n #*****************************************************************************\n-from __future__ import print_function, absolute_import\n+from __future__ import print_function\n from six import string_types\n \n from sage.misc.six import with_metaclass\n```",
    "created_at": "2017-06-06T21:18:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23147#issuecomment-434389",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:3'></a>
Make this change and I'll be happy with it:

```diff
diff --git a/src/sage/algebras/commutative_dga.py b/src/sage/algebras/commutative_dga.py
index e571a51c30..a5071198f1 100644
--- a/src/sage/algebras/commutative_dga.py
+++ b/src/sage/algebras/commutative_dga.py
@@ -71,7 +71,7 @@ AUTHORS:
 # (at your option) any later version.
 #                  http://www.gnu.org/licenses/
 #*****************************************************************************
-from __future__ import print_function, absolute_import
+from __future__ import print_function
 from six import string_types
 
 from sage.misc.six import with_metaclass
```



---

archive/issue_comments_434390.json:
```json
{
    "body": "<a id='comment:4'></a>\nThanks for the review.\n\nConcerning your suggestion, sorry, but why ?\n\nIdeally, we should have this \"absolute_import\" in all of our .py files, to help for the transition for python3 and prevent possible regressions. Adding this should do no harm at all, once the file has been checked.",
    "created_at": "2017-06-07T05:56:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23147#issuecomment-434390",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:4'></a>
Thanks for the review.

Concerning your suggestion, sorry, but why ?

Ideally, we should have this "absolute_import" in all of our .py files, to help for the transition for python3 and prevent possible regressions. Adding this should do no harm at all, once the file has been checked.



---

archive/issue_comments_434391.json:
```json
{
    "body": "<a id='comment:5'></a>\nI didn't see the point to it. It is not necessary for `from six import ...` since we're not in the `sage.misc` directory. So why add extra lines that are not needed? But I don't care that much.",
    "created_at": "2017-06-07T14:46:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23147#issuecomment-434391",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:5'></a>
I didn't see the point to it. It is not necessary for `from six import ...` since we're not in the `sage.misc` directory. So why add extra lines that are not needed? But I don't care that much.



---

archive/issue_comments_434392.json:
```json
{
    "body": "<a id='comment:6'></a>\nYou are right. So maybe we should rather move on to work on something else, no ?",
    "created_at": "2017-06-07T14:48:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23147#issuecomment-434392",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:6'></a>
You are right. So maybe we should rather move on to work on something else, no ?



---

archive/issue_comments_434393.json:
```json
{
    "body": "<a id='comment:7'></a>\nSo ? positive review ?",
    "created_at": "2017-06-08T19:03:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23147#issuecomment-434393",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:7'></a>
So ? positive review ?



---

archive/issue_comments_434394.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-06-08T20:23:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23147#issuecomment-434394",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_434395.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-06-11T09:13:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23147#issuecomment-434395",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_434396.json:
```json
{
    "body": "Changing branch from \"u/chapoton/23147\" to \"d3f012d5001ffd879e08cfb5a382f6587d672f1e\"",
    "created_at": "2017-06-11T09:13:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23147#issuecomment-434396",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/chapoton/23147" to "d3f012d5001ffd879e08cfb5a382f6587d672f1e"



---

archive/issue_events_059827.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-06-11T09:13:19Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23147",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23147#event-59827"
}
```



---

archive/issue_comments_434397.json:
```json
{
    "body": "Changing commit from \"d3f012d5001ffd879e08cfb5a382f6587d672f1e\" to \"\"",
    "created_at": "2017-09-05T14:19:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23147#issuecomment-434397",
    "user": "https://github.com/embray"
}
```

Changing commit from "d3f012d5001ffd879e08cfb5a382f6587d672f1e" to ""



---

archive/issue_comments_434398.json:
```json
{
    "body": "<a id='comment:10'></a>\nThis part doesn't make a lot of sense to me:\n\n```diff\n@@ -1635,7 +1636,7 @@ def _sage_getdoc_unformatted(obj):\n     # not a 'getset_descriptor' or similar.\n     if not isinstance(r, string_types):\n         return ''\n-    elif isinstance(r, unicode):\n+    elif isinstance(r, text_type):  # unicode (py2) = str (py3)\n         return r.encode('utf-8', 'ignore')\n     else:\n         return r\n```\n\nnot your patch specifically--replacing `unicode` with `text_type` makes sense.  But the `r.encode` that was there in the first place isn't right.  It actually causes a crash for me at startup, because the return value from this function is later consumed by code that's expected text, not bytes.  In other words, this code might have made slight sense from a Python 2 perspective, but for Python 3 it only makes sense here to leave `str` as `str`.",
    "created_at": "2017-09-05T14:19:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23147#issuecomment-434398",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'></a>
This part doesn't make a lot of sense to me:

```diff
@@ -1635,7 +1636,7 @@ def _sage_getdoc_unformatted(obj):
     # not a 'getset_descriptor' or similar.
     if not isinstance(r, string_types):
         return ''
-    elif isinstance(r, unicode):
+    elif isinstance(r, text_type):  # unicode (py2) = str (py3)
         return r.encode('utf-8', 'ignore')
     else:
         return r
```

not your patch specifically--replacing `unicode` with `text_type` makes sense.  But the `r.encode` that was there in the first place isn't right.  It actually causes a crash for me at startup, because the return value from this function is later consumed by code that's expected text, not bytes.  In other words, this code might have made slight sense from a Python 2 perspective, but for Python 3 it only makes sense here to leave `str` as `str`.



---

archive/issue_comments_434399.json:
```json
{
    "body": "<a id='comment:11'></a>\nindeed, one should do the contrary (add decode in the other part, but this causes doctests failures..)",
    "created_at": "2017-09-05T14:21:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23147#issuecomment-434399",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:11'></a>
indeed, one should do the contrary (add decode in the other part, but this causes doctests failures..)



---

archive/issue_comments_434400.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [chapoton](#comment%3A11):\n> indeed, one should do the contrary (add decode in the other part, but this causes doctests failures..)\n\n\nRight. I see now that you did this in your branch.",
    "created_at": "2017-09-05T15:44:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23147",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23147#issuecomment-434400",
    "user": "https://github.com/embray"
}
```

<a id='comment:12'></a>
Replying to [chapoton](#comment%3A11):
> indeed, one should do the contrary (add decode in the other part, but this causes doctests failures..)


Right. I see now that you did this in your branch.
