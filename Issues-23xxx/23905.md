# Issue 23905: Avoid _element_constructor in Homset

archive/issues_023668.json:
```json
{
    "body": "`Homset._generic_convert_map` uses `self._element_constructor`.\n\nIdeally, we would get rid of `_generic_convert_map` completely.\n\nBranch/Commit: f684cb0e4834a0041da29ef7a1f8f0b01cf84994\n\nReviewer: Travis Scrimshaw\n\nAuthor: Jeroen Demeyer\n\nDependencies: #23912\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/23905\n\n",
    "closed_at": "2017-10-15T09:22:43Z",
    "created_at": "2017-09-20T09:52:27Z",
    "labels": [
        "component: coercion"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Avoid _element_constructor in Homset",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23905",
    "user": "https://github.com/jdemeyer"
}
```
`Homset._generic_convert_map` uses `self._element_constructor`.

Ideally, we would get rid of `_generic_convert_map` completely.

Branch/Commit: f684cb0e4834a0041da29ef7a1f8f0b01cf84994

Reviewer: Travis Scrimshaw

Author: Jeroen Demeyer

Dependencies: #23912

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/23905





---

archive/issue_comments_451237.json:
```json
{
    "body": "Changing branch from \"\" to \"u/jdemeyer/avoid__element_constructor_in_homset\"",
    "created_at": "2017-09-20T10:16:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23905",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23905#issuecomment-451237",
    "user": "https://github.com/jdemeyer"
}
```

Changing branch from "" to "u/jdemeyer/avoid__element_constructor_in_homset"



---

archive/issue_comments_451238.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-09-20T10:33:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23905",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23905#issuecomment-451238",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_451239.json:
```json
{
    "body": "Changing commit from \"\" to \"bc7eefc1879154b1015ada08d28944792a6ccc77\"",
    "created_at": "2017-09-20T10:33:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23905",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23905#issuecomment-451239",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "" to "bc7eefc1879154b1015ada08d28944792a6ccc77"



---

archive/issue_comments_451240.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-09-20T10:34:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23905",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23905#issuecomment-451240",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_451241.json:
```json
{
    "body": "Changing author from \"\" to \"Jeroen Demeyer\"",
    "created_at": "2017-09-20T10:34:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23905",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23905#issuecomment-451241",
    "user": "https://github.com/jdemeyer"
}
```

Changing author from "" to "Jeroen Demeyer"



---

archive/issue_comments_451242.json:
```json
{
    "body": "Changing commit from \"bc7eefc1879154b1015ada08d28944792a6ccc77\" to \"d68795ecb57a4bb5cb987330d09c34c613869451\"",
    "created_at": "2017-09-20T14:27:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23905",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23905#issuecomment-451242",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "bc7eefc1879154b1015ada08d28944792a6ccc77" to "d68795ecb57a4bb5cb987330d09c34c613869451"



---

archive/issue_comments_451243.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-09-20T14:27:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23905",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23905#issuecomment-451243",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_451244.json:
```json
{
    "body": "<a id='comment:5'></a>I'm not sure about changing `__call__` to `_element_constructor_` here as it could cause a speed regression because of having to go through the coercion framework. Have you run any timings? Homsets often do not follow the usual rule of having a `Element` attribute, which may have misbehaviors because of that.\n\nAlso, because it would now pass through the coercion framework, some things are unnecessary, such as `if x.parent() is self:`. I'm also not sure how much the input may have changed by the time it reaches `_element_constructor_`. I can do some investigation.",
    "created_at": "2017-09-20T17:47:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23905",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23905#issuecomment-451244",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:5'></a>I'm not sure about changing `__call__` to `_element_constructor_` here as it could cause a speed regression because of having to go through the coercion framework. Have you run any timings? Homsets often do not follow the usual rule of having a `Element` attribute, which may have misbehaviors because of that.

Also, because it would now pass through the coercion framework, some things are unnecessary, such as `if x.parent() is self:`. I'm also not sure how much the input may have changed by the time it reaches `_element_constructor_`. I can do some investigation.



---

archive/issue_comments_451245.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [tscrim](#comment%3A5):\n> Have you run any timings?\n\n\nNo, but I guess I should...",
    "created_at": "2017-09-20T21:24:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23905",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23905#issuecomment-451245",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>Replying to [tscrim](#comment%3A5):
> Have you run any timings?


No, but I guess I should...



---

archive/issue_comments_451246.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [jdemeyer](#comment%3A6):\n> Replying to [tscrim](#comment%3A5):\n> > Have you run any timings?\n\n> \n> No, but I guess I should...\n\n\nI will also run some timings, but I won't be able to get to that until tomorrow.",
    "created_at": "2017-09-21T04:46:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23905",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23905#issuecomment-451246",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:7'></a>Replying to [jdemeyer](#comment%3A6):
> Replying to [tscrim](#comment%3A5):
> > Have you run any timings?

> 
> No, but I guess I should...


I will also run some timings, but I won't be able to get to that until tomorrow.



---

archive/issue_comments_451247.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-09-21T10:21:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23905",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23905#issuecomment-451247",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_451248.json:
```json
{
    "body": "Changing commit from \"d68795ecb57a4bb5cb987330d09c34c613869451\" to \"f684cb0e4834a0041da29ef7a1f8f0b01cf84994\"",
    "created_at": "2017-09-21T10:21:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23905",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23905#issuecomment-451248",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "d68795ecb57a4bb5cb987330d09c34c613869451" to "f684cb0e4834a0041da29ef7a1f8f0b01cf84994"



---

archive/issue_comments_451249.json:
```json
{
    "body": "<a id='comment:9'></a>**Trivial conversion**:\n\n*Before*:\n\n```\nsage: H = End(FreeGroup('x,y')); f = H.identity(); timeit('H(f)', number=20, repeat=100000)\n20 loops, best of 100000: 489 ns per loop\n```\n\n*After*:\n\n```\nsage: H = End(FreeGroup('x,y')); f = H.identity(); timeit('H(f)', number=20, repeat=100000)\n20 loops, best of 100000: 95.4 ns per loop\n```\n\n**Non-trivial conversion**:\n\n*Before*:\n\n```\nsage: H = End(FreeGroup('x,y')); f = lambda x:x; timeit('H(f)', number=20, repeat=10000)\n20 loops, best of 10000: 2.55 \u00b5s per loop\n```\n\n*After*:\n\n```\nsage: H = End(FreeGroup('x,y')); f = lambda x:x; timeit('H(f)', number=20, repeat=10000)\n20 loops, best of 10000: 3.4 \u00b5s per loop\n```",
    "created_at": "2017-09-21T10:34:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23905",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23905#issuecomment-451249",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>**Trivial conversion**:

*Before*:

```
sage: H = End(FreeGroup('x,y')); f = H.identity(); timeit('H(f)', number=20, repeat=100000)
20 loops, best of 100000: 489 ns per loop
```

*After*:

```
sage: H = End(FreeGroup('x,y')); f = H.identity(); timeit('H(f)', number=20, repeat=100000)
20 loops, best of 100000: 95.4 ns per loop
```

**Non-trivial conversion**:

*Before*:

```
sage: H = End(FreeGroup('x,y')); f = lambda x:x; timeit('H(f)', number=20, repeat=10000)
20 loops, best of 10000: 2.55 µs per loop
```

*After*:

```
sage: H = End(FreeGroup('x,y')); f = lambda x:x; timeit('H(f)', number=20, repeat=10000)
20 loops, best of 10000: 3.4 µs per loop
```



---

archive/issue_comments_451250.json:
```json
{
    "body": "<a id='comment:10'></a>Interestingly, I traced the speed difference of the \"non-trivial conversion\" above to the call\n\n```\nR = parent(x)\n```\n\nApparently, asking for the parent of non-numeric types is very slow.",
    "created_at": "2017-09-21T11:42:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23905",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23905#issuecomment-451250",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>Interestingly, I traced the speed difference of the "non-trivial conversion" above to the call

```
R = parent(x)
```

Apparently, asking for the parent of non-numeric types is very slow.



---

archive/issue_comments_451251.json:
```json
{
    "body": "<a id='comment:11'></a>See #23912 for the slowness of `parent()`.",
    "created_at": "2017-09-21T12:16:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23905",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23905#issuecomment-451251",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>See #23912 for the slowness of `parent()`.



---

archive/issue_comments_451252.json:
```json
{
    "body": "<a id='comment:12'></a>My timings.\n\nBefore\n\n```\nsage: H = End(FreeGroup('x,y')); f = H.identity(); timeit('H(f)', number=20, repeat=100000)\n20 loops, best of 100000: 393 ns per loop\nsage: H = End(FreeGroup('x,y')); f = lambda x:x; timeit('H(f)', number=20, repeat=10000)\n20 loops, best of 10000: 1.85 \u00b5s per loop\n```\nJust #23905\n\n```\nsage: H = End(FreeGroup('x,y')); f = H.identity(); timeit('H(f)', number=20, repeat=100000)\n20 loops, best of 100000: 47.7 ns per loop\nsage: H = End(FreeGroup('x,y')); f = lambda x:x; timeit('H(f)', number=20, repeat=10000)\n20 loops, best of 10000: 2.35 \u00b5s per loop\n```\nBoth #23905 and #23912:\n\n```\nsage: H = End(FreeGroup('x,y')); f = H.identity(); timeit('H(f)', number=20, repeat=100000)\n20 loops, best of 100000: 47.7 ns per loop\nsage: H = End(FreeGroup('x,y')); f = lambda x:x; timeit('H(f)', number=20, repeat=10000)\n20 loops, best of 10000: 1.65 \u00b5s per loop\n```\n\nSo LGTM. I'm putting #23912 as a dependency just because I feel we should not merge this without #23912 to avoid the speed regression.",
    "created_at": "2017-09-21T17:40:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23905",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23905#issuecomment-451252",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:12'></a>My timings.

Before

```
sage: H = End(FreeGroup('x,y')); f = H.identity(); timeit('H(f)', number=20, repeat=100000)
20 loops, best of 100000: 393 ns per loop
sage: H = End(FreeGroup('x,y')); f = lambda x:x; timeit('H(f)', number=20, repeat=10000)
20 loops, best of 10000: 1.85 µs per loop
```
Just #23905

```
sage: H = End(FreeGroup('x,y')); f = H.identity(); timeit('H(f)', number=20, repeat=100000)
20 loops, best of 100000: 47.7 ns per loop
sage: H = End(FreeGroup('x,y')); f = lambda x:x; timeit('H(f)', number=20, repeat=10000)
20 loops, best of 10000: 2.35 µs per loop
```
Both #23905 and #23912:

```
sage: H = End(FreeGroup('x,y')); f = H.identity(); timeit('H(f)', number=20, repeat=100000)
20 loops, best of 100000: 47.7 ns per loop
sage: H = End(FreeGroup('x,y')); f = lambda x:x; timeit('H(f)', number=20, repeat=10000)
20 loops, best of 10000: 1.65 µs per loop
```

So LGTM. I'm putting #23912 as a dependency just because I feel we should not merge this without #23912 to avoid the speed regression.



---

archive/issue_comments_451253.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-09-21T17:40:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23905",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23905#issuecomment-451253",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_451254.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Travis Scrimshaw\"",
    "created_at": "2017-09-21T17:40:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23905",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23905#issuecomment-451254",
    "user": "https://github.com/tscrim"
}
```

Changing reviewer from "" to "Travis Scrimshaw"



---

archive/issue_comments_451255.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#23912\"",
    "created_at": "2017-09-21T17:40:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23905",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23905#issuecomment-451255",
    "user": "https://github.com/tscrim"
}
```

Changing dependencies from "" to "#23912"



---

archive/issue_comments_451256.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-10-15T09:22:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23905",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23905#issuecomment-451256",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_451257.json:
```json
{
    "body": "Changing branch from \"u/jdemeyer/avoid__element_constructor_in_homset\" to \"f684cb0e4834a0041da29ef7a1f8f0b01cf84994\"",
    "created_at": "2017-10-15T09:22:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23905",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23905#issuecomment-451257",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/jdemeyer/avoid__element_constructor_in_homset" to "f684cb0e4834a0041da29ef7a1f8f0b01cf84994"



---

archive/issue_events_060857.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-10-15T09:22:43Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23905",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23905#event-60857"
}
```
