# Issue 23846: Fix containing_block

archive/issues_023609.json:
```json
{
    "body": "First of all, the documentation `sage.repl.preparse.containing_block` function is unclear. Second, it seems to return wrong results.\n\nI suppose that `containing_block(s, idx)` is supposed to contain `a,b` such that `s[a:b]` is the smallest substring with matching parentheses containing `idx`.\n\nActually the role of `idx` is not stated in the documentation. From some tests, it seems that we will have `a<idx`. The following seems wrong to me:\n\n1. `s[a:b]` actually is not always balanced:\n\n```\nsage: from sage.repl.preparse import containing_block\nsage: containing_block('((a))',1)\n(0, 4)\nsage: '((a))'[0:4]\n'((a)'\nsage: containing_block('([a)',1)\n(0, 4)\nsage: '([a)'[0:4]\n'([a)'\nsage: containing_block('(a])',1)\n(0, 4)\nsage: '(a])'[0:4]\n'(a])'\n```\n\n2. Some corner cases:\n\n```\nsage: containing_block('()',1)\n  File \"<string>\", line unknown\nSyntaxError: Unbalanced or missing ()'s\nsage: containing_block('()',0)\n  File \"<string>\", line unknown\nSyntaxError: Unbalanced or missing ()'s\n```\n\nSuggested fix:\n1. The specification should be:\n   - `s[a:b]` is minimal balanced (in particular we have `s[a]` and opening and `s[b-1]` a closing bracket)\n   - `a<=idx<b` (in particular, the char at position `idx` is part of `s[a:b]`)\n2. The specification should be documented.\n\nKeywords: balanced parentheses, containing_block\n\nBranch/Commit: 3c01d712a8e763bb1e922a515307d853d6deb22b\n\nReviewer: Travis Scrimshaw\n\nAuthor: Simon King\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/23846\n\n",
    "closed_at": "2017-09-18T22:15:11Z",
    "created_at": "2017-09-13T11:15:48Z",
    "labels": [
        "component: combinatorics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Fix containing_block",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23846",
    "user": "https://github.com/simon-king-jena"
}
```
First of all, the documentation `sage.repl.preparse.containing_block` function is unclear. Second, it seems to return wrong results.

I suppose that `containing_block(s, idx)` is supposed to contain `a,b` such that `s[a:b]` is the smallest substring with matching parentheses containing `idx`.

Actually the role of `idx` is not stated in the documentation. From some tests, it seems that we will have `a<idx`. The following seems wrong to me:

1. `s[a:b]` actually is not always balanced:

```
sage: from sage.repl.preparse import containing_block
sage: containing_block('((a))',1)
(0, 4)
sage: '((a))'[0:4]
'((a)'
sage: containing_block('([a)',1)
(0, 4)
sage: '([a)'[0:4]
'([a)'
sage: containing_block('(a])',1)
(0, 4)
sage: '(a])'[0:4]
'(a])'
```

2. Some corner cases:

```
sage: containing_block('()',1)
  File "<string>", line unknown
SyntaxError: Unbalanced or missing ()'s
sage: containing_block('()',0)
  File "<string>", line unknown
SyntaxError: Unbalanced or missing ()'s
```

Suggested fix:
1. The specification should be:
   - `s[a:b]` is minimal balanced (in particular we have `s[a]` and opening and `s[b-1]` a closing bracket)
   - `a<=idx<b` (in particular, the char at position `idx` is part of `s[a:b]`)
2. The specification should be documented.

Keywords: balanced parentheses, containing_block

Branch/Commit: 3c01d712a8e763bb1e922a515307d853d6deb22b

Reviewer: Travis Scrimshaw

Author: Simon King

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/23846





---

archive/issue_comments_351968.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-First of all, the documentation `sage.repr.preparse.containing_block` function is unclear. Second, it seems to return wrong results.\n+First of all, the documentation `sage.repl.preparse.containing_block` function is unclear. Second, it seems to return wrong results.\n \n I suppose that `containing_block(s, idx)` is supposed to contain `a,b` such that `s[a:b]` is the smallest substring with matching parentheses containing `idx`.\n \n```\n",
    "created_at": "2017-09-13T11:16:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23846",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23846#issuecomment-351968",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,4 @@
-First of all, the documentation `sage.repr.preparse.containing_block` function is unclear. Second, it seems to return wrong results.
+First of all, the documentation `sage.repl.preparse.containing_block` function is unclear. Second, it seems to return wrong results.
 
 I suppose that `containing_block(s, idx)` is supposed to contain `a,b` such that `s[a:b]` is the smallest substring with matching parentheses containing `idx`.
 
```




---

archive/issue_comments_351969.json:
```json
{
    "body": "<a id='comment:2'></a>By the way: Why is there no proper traceback when `containing_block` raises a SyntaxError?",
    "created_at": "2017-09-13T11:19:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23846",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23846#issuecomment-351969",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:2'></a>By the way: Why is there no proper traceback when `containing_block` raises a SyntaxError?



---

archive/issue_comments_351970.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,39 @@\n+First of all, the documentation `sage.repl.preparse.containing_block` function is unclear. Second, it seems to return wrong results.\n \n+I suppose that `containing_block(s, idx)` is supposed to contain `a,b` such that `s[a:b]` is the smallest substring with matching parentheses containing `idx`.\n+\n+Actually the role of `idx` is not stated in the documentation. From some tests, it seems that we will have `a<idx`. The following seems wrong to me:\n+\n+1. `s[a:b]` actually is not always balanced:\n+\n+```\n+sage: from sage.repl.preparse import containing_block\n+sage: containing_block('((a))',1)\n+(0, 4)\n+sage: '((a))'[0:4]\n+'((a)'\n+sage: containing_block('([a)',1)\n+(0, 4)\n+sage: '([a)'[0:4]\n+'([a)'\n+```\n+\n+2. Some corner cases:\n+\n+```\n+sage: containing_block('()',1)\n+  File \"<string>\", line unknown\n+SyntaxError: Unbalanced or missing ()'s\n+sage: containing_block('()',0)\n+  File \"<string>\", line unknown\n+SyntaxError: Unbalanced or missing ()'s\n+```\n+\n+Suggested fix:\n+1. The specification should be:\n+   - `s[a:b]` is minimal balanced (in particular we have `s[a]` and opening and `s[b-1]` a closing bracket)\n+   - `a<=idx<b` (in particular, the char at position `idx` is part of `s[a:b]`)\n+2. The specification should be documented.\n \n Comment: 1\n \n```\n",
    "created_at": "2017-09-13T11:46:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23846",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23846#issuecomment-351970",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,39 @@
+First of all, the documentation `sage.repl.preparse.containing_block` function is unclear. Second, it seems to return wrong results.
 
+I suppose that `containing_block(s, idx)` is supposed to contain `a,b` such that `s[a:b]` is the smallest substring with matching parentheses containing `idx`.
+
+Actually the role of `idx` is not stated in the documentation. From some tests, it seems that we will have `a<idx`. The following seems wrong to me:
+
+1. `s[a:b]` actually is not always balanced:
+
+```
+sage: from sage.repl.preparse import containing_block
+sage: containing_block('((a))',1)
+(0, 4)
+sage: '((a))'[0:4]
+'((a)'
+sage: containing_block('([a)',1)
+(0, 4)
+sage: '([a)'[0:4]
+'([a)'
+```
+
+2. Some corner cases:
+
+```
+sage: containing_block('()',1)
+  File "<string>", line unknown
+SyntaxError: Unbalanced or missing ()'s
+sage: containing_block('()',0)
+  File "<string>", line unknown
+SyntaxError: Unbalanced or missing ()'s
+```
+
+Suggested fix:
+1. The specification should be:
+   - `s[a:b]` is minimal balanced (in particular we have `s[a]` and opening and `s[b-1]` a closing bracket)
+   - `a<=idx<b` (in particular, the char at position `idx` is part of `s[a:b]`)
+2. The specification should be documented.
 
 Comment: 1
 
```




---

archive/issue_comments_351971.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,43 @@\n+First of all, the documentation `sage.repl.preparse.containing_block` function is unclear. Second, it seems to return wrong results.\n \n+I suppose that `containing_block(s, idx)` is supposed to contain `a,b` such that `s[a:b]` is the smallest substring with matching parentheses containing `idx`.\n+\n+Actually the role of `idx` is not stated in the documentation. From some tests, it seems that we will have `a<idx`. The following seems wrong to me:\n+\n+1. `s[a:b]` actually is not always balanced:\n+\n+```\n+sage: from sage.repl.preparse import containing_block\n+sage: containing_block('((a))',1)\n+(0, 4)\n+sage: '((a))'[0:4]\n+'((a)'\n+sage: containing_block('([a)',1)\n+(0, 4)\n+sage: '([a)'[0:4]\n+'([a)'\n+sage: containing_block('(a])',1)\n+(0, 4)\n+sage: '(a])'[0:4]\n+'(a])'\n+```\n+\n+2. Some corner cases:\n+\n+```\n+sage: containing_block('()',1)\n+  File \"<string>\", line unknown\n+SyntaxError: Unbalanced or missing ()'s\n+sage: containing_block('()',0)\n+  File \"<string>\", line unknown\n+SyntaxError: Unbalanced or missing ()'s\n+```\n+\n+Suggested fix:\n+1. The specification should be:\n+   - `s[a:b]` is minimal balanced (in particular we have `s[a]` and opening and `s[b-1]` a closing bracket)\n+   - `a<=idx<b` (in particular, the char at position `idx` is part of `s[a:b]`)\n+2. The specification should be documented.\n \n Comment: 1\n \n```\n",
    "created_at": "2017-09-13T11:48:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23846",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23846#issuecomment-351971",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,43 @@
+First of all, the documentation `sage.repl.preparse.containing_block` function is unclear. Second, it seems to return wrong results.
 
+I suppose that `containing_block(s, idx)` is supposed to contain `a,b` such that `s[a:b]` is the smallest substring with matching parentheses containing `idx`.
+
+Actually the role of `idx` is not stated in the documentation. From some tests, it seems that we will have `a<idx`. The following seems wrong to me:
+
+1. `s[a:b]` actually is not always balanced:
+
+```
+sage: from sage.repl.preparse import containing_block
+sage: containing_block('((a))',1)
+(0, 4)
+sage: '((a))'[0:4]
+'((a)'
+sage: containing_block('([a)',1)
+(0, 4)
+sage: '([a)'[0:4]
+'([a)'
+sage: containing_block('(a])',1)
+(0, 4)
+sage: '(a])'[0:4]
+'(a])'
+```
+
+2. Some corner cases:
+
+```
+sage: containing_block('()',1)
+  File "<string>", line unknown
+SyntaxError: Unbalanced or missing ()'s
+sage: containing_block('()',0)
+  File "<string>", line unknown
+SyntaxError: Unbalanced or missing ()'s
+```
+
+Suggested fix:
+1. The specification should be:
+   - `s[a:b]` is minimal balanced (in particular we have `s[a]` and opening and `s[b-1]` a closing bracket)
+   - `a<=idx<b` (in particular, the char at position `idx` is part of `s[a:b]`)
+2. The specification should be documented.
 
 Comment: 1
 
```




---

archive/issue_comments_351972.json:
```json
{
    "body": "<a id='comment:6'></a>New commits:",
    "created_at": "2017-09-14T09:03:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23846",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23846#issuecomment-351972",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:6'></a>New commits:



---

archive/issue_comments_351973.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-09-14T09:03:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23846",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23846#issuecomment-351973",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_351974.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-09-14T11:19:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23846",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23846#issuecomment-351974",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_351975.json:
```json
{
    "body": "<a id='comment:8'></a>Apparently a SyntaxError does result in a traceback in doctest, although it doesn't in an interactive session. The new commit deals with it...",
    "created_at": "2017-09-14T11:20:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23846",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23846#issuecomment-351975",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'></a>Apparently a SyntaxError does result in a traceback in doctest, although it doesn't in an interactive session. The new commit deals with it...



---

archive/issue_comments_351976.json:
```json
{
    "body": "<a id='comment:9'></a>LGTM.",
    "created_at": "2017-09-15T20:44:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23846",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23846#issuecomment-351976",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:9'></a>LGTM.



---

archive/issue_comments_351977.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-09-15T20:44:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23846",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23846#issuecomment-351977",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_060757.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-09-18T22:15:11Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23846",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23846#event-60757"
}
```



---

archive/issue_comments_351978.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-09-18T22:15:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23846",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23846#issuecomment-351978",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
