# Issue 23074: Allow Python functions in minimize with NCG method

archive/issues_022837.json:
```json
{
    "body": "If `algorithm=\"ncg\"` is used in the top-level `minimize` function, one should be able to work with Python functions, as with the other algorithms.\n\nCC:  @dimpase\n\nKeywords: minimize\n\nReviewer: Dima Pasechnik\n\nAuthor: Marcelo Forets, Vincent Delecroix\n\nBranch: public/23074\n\nStatus: needs_work\n\nCommit: 36d0f319d27f38a692e82102c8adb3040ed55029\n\nIssue created by migration from https://trac.sagemath.org/ticket/23074\n\n",
    "created_at": "2017-05-25T09:17:19Z",
    "labels": [
        "component: numerical"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Allow Python functions in minimize with NCG method",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23074",
    "user": "https://github.com/mforets"
}
```
If `algorithm="ncg"` is used in the top-level `minimize` function, one should be able to work with Python functions, as with the other algorithms.

CC:  @dimpase

Keywords: minimize

Reviewer: Dima Pasechnik

Author: Marcelo Forets, Vincent Delecroix

Branch: public/23074

Status: needs_work

Commit: 36d0f319d27f38a692e82102c8adb3040ed55029

Issue created by migration from https://trac.sagemath.org/ticket/23074





---

archive/issue_comments_318985.json:
```json
{
    "body": "<a id='comment:1'></a>For instance, this use case is currently broken:\n\n```\nsage: f = lambda x : 100*(x[1]-x[0]^2)^2+(1-x[0])^2+100*(x[2]-x[1]^2)^2+(1-x[1])^2\nsage: gradient = lambda x : scipy.array([400*(x[0]**2 - x[1])*x[0] + 2*x[0] - 2, \\\n                                    -200*x[0]**2 + 400*(x[1]**2 - x[2])*x[1] + 202*x[1] - 2, \\\n                                     -200*x[1]**2 + 200*x[2]])\nsage: x0 = [.1,.3,.4]\nsage: minimize(f, x0, gradient, algorithm=\"ncg\")\nTraceback (most recent call last)\n...\nUnboundLocalError: local variable 'min' referenced before assignment\n```\n\nbut it shouldn't, since this works:\n\n```\nsage: import scipy\nsage: from scipy import optimize\nsage: optimize.fmin_ncg(f, [float(_) for _ in x0], fprime=gradient, disp=True)\nOptimization terminated successfully.\n...\narray([ 0.99999732,  0.99999463,  0.99998926])\n```\n\nMoreover, the Hessian can also be passed to ncg (but it's optional => docstring is inaccurate)\n\n```\nsage: hessian = lambda x : [[1200*x[0]^2 - 400*x[1] + 2, -400*x[0], 0], \\\n                    [-400*x[0], 1200*x[1]^2 - 400*x[2] + 202, -400*x[1]], \\\n                    [0, -400*x[1], 200]]\nsage: optimize.fmin_ncg(f, [float(_) for _ in x0], fprime=gradient, fhess=hessian, disp=True)\nOptimization terminated successfully.\n...\narray([ 1.,  1.,  1.])\n```",
    "created_at": "2017-05-25T09:20:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23074#issuecomment-318985",
    "user": "https://github.com/mforets"
}
```

<a id='comment:1'></a>For instance, this use case is currently broken:

```
sage: f = lambda x : 100*(x[1]-x[0]^2)^2+(1-x[0])^2+100*(x[2]-x[1]^2)^2+(1-x[1])^2
sage: gradient = lambda x : scipy.array([400*(x[0]**2 - x[1])*x[0] + 2*x[0] - 2, \
                                    -200*x[0]**2 + 400*(x[1]**2 - x[2])*x[1] + 202*x[1] - 2, \
                                     -200*x[1]**2 + 200*x[2]])
sage: x0 = [.1,.3,.4]
sage: minimize(f, x0, gradient, algorithm="ncg")
Traceback (most recent call last)
...
UnboundLocalError: local variable 'min' referenced before assignment
```

but it shouldn't, since this works:

```
sage: import scipy
sage: from scipy import optimize
sage: optimize.fmin_ncg(f, [float(_) for _ in x0], fprime=gradient, disp=True)
Optimization terminated successfully.
...
array([ 0.99999732,  0.99999463,  0.99998926])
```

Moreover, the Hessian can also be passed to ncg (but it's optional => docstring is inaccurate)

```
sage: hessian = lambda x : [[1200*x[0]^2 - 400*x[1] + 2, -400*x[0], 0], \
                    [-400*x[0], 1200*x[1]^2 - 400*x[2] + 202, -400*x[1]], \
                    [0, -400*x[1], 200]]
sage: optimize.fmin_ncg(f, [float(_) for _ in x0], fprime=gradient, fhess=hessian, disp=True)
Optimization terminated successfully.
...
array([ 1.,  1.,  1.])
```



---

archive/issue_comments_318986.json:
```json
{
    "body": "<a id='comment:2'></a>on a separate line, [in the doc](https://docs.scipy.org/doc/scipy-0.19.0/reference/generated/scipy.optimize.minimize.html#scipy.optimize.minimize) it says that \n\n> Only one of hessp or hess needs to be given.\n\n\nHence, in the current if clause of `algorithm==\"ncg\"` one does not need to compute & pass both `hessian` and `hessian_p`, but just one of them, i think.",
    "created_at": "2017-05-25T09:22:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23074#issuecomment-318986",
    "user": "https://github.com/mforets"
}
```

<a id='comment:2'></a>on a separate line, [in the doc](https://docs.scipy.org/doc/scipy-0.19.0/reference/generated/scipy.optimize.minimize.html#scipy.optimize.minimize) it says that 

> Only one of hessp or hess needs to be given.


Hence, in the current if clause of `algorithm=="ncg"` one does not need to compute & pass both `hessian` and `hessian_p`, but just one of them, i think.



---

archive/issue_comments_318987.json:
```json
{
    "body": "<a id='comment:6'></a>Last 10 new commits:",
    "created_at": "2017-05-27T17:34:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23074#issuecomment-318987",
    "user": "https://github.com/mforets"
}
```

<a id='comment:6'></a>Last 10 new commits:



---

archive/issue_comments_318988.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-27T18:13:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23074#issuecomment-318988",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_318989.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-05-27T18:14:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23074#issuecomment-318989",
    "user": "https://github.com/mforets"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_318990.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-27T18:15:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23074#issuecomment-318990",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_318991.json:
```json
{
    "body": "<a id='comment:10'></a>rebased\n\n---\nNew commits:",
    "created_at": "2020-02-23T10:10:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23074#issuecomment-318991",
    "user": "https://github.com/videlec"
}
```

<a id='comment:10'></a>rebased

---
New commits:



---

archive/issue_events_059703.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2020-02-23T10:10:37Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23074",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23074#event-59703"
}
```



---

archive/issue_comments_318992.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-02-23T10:27:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23074#issuecomment-318992",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_318993.json:
```json
{
    "body": "<a id='comment:12'></a>Some refactorization in progress..",
    "created_at": "2020-02-23T10:41:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23074#issuecomment-318993",
    "user": "https://github.com/videlec"
}
```

<a id='comment:12'></a>Some refactorization in progress..



---

archive/issue_comments_318994.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-02-23T10:41:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23074#issuecomment-318994",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_318995.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-23T10:48:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23074#issuecomment-318995",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_318996.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-02-23T10:49:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23074#issuecomment-318996",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_318997.json:
```json
{
    "body": "<a id='comment:15'></a>Thanks, looks good.",
    "created_at": "2020-02-23T15:05:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23074#issuecomment-318997",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:15'></a>Thanks, looks good.



---

archive/issue_comments_318998.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-02-23T15:05:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23074#issuecomment-318998",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_318999.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-02-24T23:46:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23074#issuecomment-318999",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_319000.json:
```json
{
    "body": "<a id='comment:16'></a>On 32-bit:\n\n```\n**********************************************************************\nFile \"src/sage/numerical/optimize.py\", line 352, in sage.numerical.optimize.?\nFailed example:\n    minimize(f, [.1, .3, .4], algorithm=\"ncg\") # abs tol 1e-6\nExpected:\n    (1.0, 1.0, 1.0)\nGot:\n    (1.0000003254615812, 1.000000652320023, 1.0000013080122123)\nTolerance exceeded in 1 of 3:\n    1.0 vs 1.0000013080122123, tolerance 2e-6 > 1e-6\n**********************************************************************\n1 item had failures:\n   1 of  20 in sage.numerical.optimize.?\n    [104 tests, 1 failure, 1.15 s]\n----------------------------------------------------------------------\nsage -t --long src/sage/numerical/optimize.py  # 1 doctest failed\n----------------------------------------------------------------------\n```",
    "created_at": "2020-02-24T23:46:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23074#issuecomment-319000",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:16'></a>On 32-bit:

```
**********************************************************************
File "src/sage/numerical/optimize.py", line 352, in sage.numerical.optimize.?
Failed example:
    minimize(f, [.1, .3, .4], algorithm="ncg") # abs tol 1e-6
Expected:
    (1.0, 1.0, 1.0)
Got:
    (1.0000003254615812, 1.000000652320023, 1.0000013080122123)
Tolerance exceeded in 1 of 3:
    1.0 vs 1.0000013080122123, tolerance 2e-6 > 1e-6
**********************************************************************
1 item had failures:
   1 of  20 in sage.numerical.optimize.?
    [104 tests, 1 failure, 1.15 s]
----------------------------------------------------------------------
sage -t --long src/sage/numerical/optimize.py  # 1 doctest failed
----------------------------------------------------------------------
```



---

archive/issue_comments_319001.json:
```json
{
    "body": "<a id='comment:17'></a>Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.",
    "created_at": "2020-05-01T04:28:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23074#issuecomment-319001",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'></a>Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.



---

archive/issue_events_059704.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-05-01T04:28:42Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23074",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23074#event-59704"
}
```



---

archive/issue_events_059705.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-05-01T04:28:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23074",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23074#event-59705"
}
```



---

archive/issue_events_059706.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-05T19:21:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23074",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23074#event-59706"
}
```



---

archive/issue_events_059707.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-05T19:21:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23074",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23074#event-59707"
}
```



---

archive/issue_comments_319002.json:
```json
{
    "body": "<a id='comment:19'></a>Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23074#issuecomment-319002",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:19'></a>Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_events_059708.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23074",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23074#event-59708"
}
```



---

archive/issue_events_059709.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23074",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23074#event-59709"
}
```



---

archive/issue_comments_319003.json:
```json
{
    "body": "<a id='comment:20'></a>Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23074#issuecomment-319003",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'></a>Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_events_059710.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23074",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23074#event-59710"
}
```



---

archive/issue_events_059711.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23074",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23074#event-59711"
}
```



---

archive/issue_events_059712.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:24:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23074",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23074#event-59712"
}
```



---

archive/issue_events_059713.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:24:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23074",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23074#event-59713"
}
```



---

archive/issue_events_059714.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-07T00:07:21Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23074",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23074#event-59714"
}
```



---

archive/issue_events_059715.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-07T00:07:21Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23074",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23074#event-59715"
}
```



---

archive/issue_events_059716.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23074",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23074#event-59716"
}
```



---

archive/issue_events_059717.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23074",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23074#event-59717"
}
```
