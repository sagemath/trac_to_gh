# Issue 23326: Polyhedron from inexact MIP is broken

archive/issues_023089.json:
```json
{
    "body": "CC:  @dimpase @mkoeppe\n\nKeywords: optimization, polyhedron\n\nCreating a `polyhedron` defined by a `MixedIntegerLinearProgram` seems to be broken if the MIP's base ring is real double field; it raises `AttributeError: type object 'float' has no attribute 'is_exact'`.\n\nReported in [ask.sage](https://ask.sagemath.org/question/33782/computing-polyhedron-from-mip/).\n\nIssue created by migration from https://trac.sagemath.org/ticket/23326\n\n",
    "closed_at": "2017-09-10T11:57:36Z",
    "created_at": "2017-06-26T10:37:54Z",
    "labels": [
        "component: numerical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Polyhedron from inexact MIP is broken",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23326",
    "user": "https://github.com/mforets"
}
```
CC:  @dimpase @mkoeppe

Keywords: optimization, polyhedron

Creating a `polyhedron` defined by a `MixedIntegerLinearProgram` seems to be broken if the MIP's base ring is real double field; it raises `AttributeError: type object 'float' has no attribute 'is_exact'`.

Reported in [ask.sage](https://ask.sagemath.org/question/33782/computing-polyhedron-from-mip/).

Issue created by migration from https://trac.sagemath.org/ticket/23326





---

archive/issue_comments_322479.json:
```json
{
    "body": "two obvious ways would be: \n\n- in MIP's `def polyhedron`, cast the floats to RDF before passing to `Polyhedron` constructor\n\n- in `def Polyhedra` at `parent.py`, add checks like `.. is RDF or float`\n\ni tried the second one; it works with this ticket but it triggers other things :\n\n```\nFile \"src/sage/numerical/mip.pyx\", line 669, in sage.numerical.mip.MixedIntegerLinearProgram.base_ring\nFailed example:\n    d = polytopes.dodecahedron()\n```\n\nso it doesn't seem to be a good idea.\n\n---\nNew commits:",
    "created_at": "2017-06-26T10:49:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23326#issuecomment-322479",
    "user": "https://github.com/mforets"
}
```

two obvious ways would be: 

- in MIP's `def polyhedron`, cast the floats to RDF before passing to `Polyhedron` constructor

- in `def Polyhedra` at `parent.py`, add checks like `.. is RDF or float`

i tried the second one; it works with this ticket but it triggers other things :

```
File "src/sage/numerical/mip.pyx", line 669, in sage.numerical.mip.MixedIntegerLinearProgram.base_ring
Failed example:
    d = polytopes.dodecahedron()
```

so it doesn't seem to be a good idea.

---
New commits:



---

archive/issue_comments_322480.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to numerical.",
    "created_at": "2017-06-26T10:49:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23326#issuecomment-322480",
    "user": "https://github.com/mforets"
}
```

Changing component from PLEASE CHANGE to numerical.



---

archive/issue_comments_322481.json:
```json
{
    "body": "I think one of the bugs is here, line 707 of `sage/rings/real_double.pyx`.\n\n```\nself._value = float(x)\n```\nIndeed, `float()` is Python float, it's not `RDF`.\n\nMore bugs(?) like this are in `MixedIntegerLinearProgram`, where `float` is used for no good reason, IMHO.",
    "created_at": "2017-06-26T11:35:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23326#issuecomment-322481",
    "user": "https://github.com/dimpase"
}
```

I think one of the bugs is here, line 707 of `sage/rings/real_double.pyx`.

```
self._value = float(x)
```
Indeed, `float()` is Python float, it's not `RDF`.

More bugs(?) like this are in `MixedIntegerLinearProgram`, where `float` is used for no good reason, IMHO.



---

archive/issue_comments_322482.json:
```json
{
    "body": "I just suggested a fix to be discussed (based upon Marcelo's branch), i guess it is consistent with the current logic of both the `Polyhedron` constructor and `MILP` behaviour.\n\nThat said, there are two things i do not like with those logics:\n\nRegarding the `Polyhedron` constructor, (part of) the current logic is: if the ring of all the entries is one of `ZZ`, `QQ`, `RDF`, then make it the base ring, otherwise, try to turn the entries into integers (if it succeeds, then the base ring is `ZZ` or `QQ`), otherwise the base ring is `RDF`. In particular, if the entries are Python floats corresponding to integers, then the base ring will be `ZZ` or `QQ`. But if the entries are `RDF` elements corresponding to integers, then the base ring will be `RDF`. It also makes something non-predictive: imagine that the user wants to construct tons of float polytopes, but one of them has integer entries for no good reason, its base ring will be different than the others polytopes.\n\nRegarding `MILP`, constraints are considered as floats, whatever the type of constraints defined by the user. I do understand that solvers might require that, but if `MILP` is built from integer or rational entries, it should remind about that and postprocess the output of the solvers to be consistent with the user input.\n\nAlso, both \"features\" are linked so that the current mixture works (i.e. if the MILP is made of integer entries, then it will lead to a rational polytope), but i do not find it very secure: the MILP outputs floats even if it knows that the polytope is rational, then the polyhedron constructor guesses that the polytope has to be rational. Again, what happens when the user defines a float MILP, and that by some rounding coincidence, it turns out that the constraints are integers ?\n\n---\nNew commits:",
    "created_at": "2017-06-26T20:43:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23326#issuecomment-322482",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

I just suggested a fix to be discussed (based upon Marcelo's branch), i guess it is consistent with the current logic of both the `Polyhedron` constructor and `MILP` behaviour.

That said, there are two things i do not like with those logics:

Regarding the `Polyhedron` constructor, (part of) the current logic is: if the ring of all the entries is one of `ZZ`, `QQ`, `RDF`, then make it the base ring, otherwise, try to turn the entries into integers (if it succeeds, then the base ring is `ZZ` or `QQ`), otherwise the base ring is `RDF`. In particular, if the entries are Python floats corresponding to integers, then the base ring will be `ZZ` or `QQ`. But if the entries are `RDF` elements corresponding to integers, then the base ring will be `RDF`. It also makes something non-predictive: imagine that the user wants to construct tons of float polytopes, but one of them has integer entries for no good reason, its base ring will be different than the others polytopes.

Regarding `MILP`, constraints are considered as floats, whatever the type of constraints defined by the user. I do understand that solvers might require that, but if `MILP` is built from integer or rational entries, it should remind about that and postprocess the output of the solvers to be consistent with the user input.

Also, both "features" are linked so that the current mixture works (i.e. if the MILP is made of integer entries, then it will lead to a rational polytope), but i do not find it very secure: the MILP outputs floats even if it knows that the polytope is rational, then the polyhedron constructor guesses that the polytope has to be rational. Again, what happens when the user defines a float MILP, and that by some rounding coincidence, it turns out that the constraints are integers ?

---
New commits:



---

archive/issue_comments_322483.json:
```json
{
    "body": "Practically speaking, if one wants to study the polyhedron of an (MI)LP, then an appropriate (MI)LP backend should should be used: e.g. for rational inequalities one should use `ppl` backend, which does exact computations over `QQ`, and so the polyhedron constructed will be over `QQ`; there is also a backend that understands exact algebraic numbers, etc.\n\nConstructing an LP over floats/RDF and then investigating the underlying polyhedron is obviously not a very safe undertaking.",
    "created_at": "2017-06-26T21:00:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23326#issuecomment-322483",
    "user": "https://github.com/dimpase"
}
```

Practically speaking, if one wants to study the polyhedron of an (MI)LP, then an appropriate (MI)LP backend should should be used: e.g. for rational inequalities one should use `ppl` backend, which does exact computations over `QQ`, and so the polyhedron constructed will be over `QQ`; there is also a backend that understands exact algebraic numbers, etc.

Constructing an LP over floats/RDF and then investigating the underlying polyhedron is obviously not a very safe undertaking.



---

archive/issue_comments_322484.json:
```json
{
    "body": "Hi Marcelo, Thierry,\n\nDid you have a look at #22605? Of course it breaks some doctests in MIP but the polyhedron constructor gets much better.\n\nVincent",
    "created_at": "2017-06-27T10:35:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23326#issuecomment-322484",
    "user": "https://github.com/videlec"
}
```

Hi Marcelo, Thierry,

Did you have a look at #22605? Of course it breaks some doctests in MIP but the polyhedron constructor gets much better.

Vincent



---

archive/issue_comments_322485.json:
```json
{
    "body": "Replying to [comment:7 vdelecroix]:\n> Hi Marcelo, Thierry,\n> \n> Did you have a look at #22605? Of course it breaks some doctests in MIP but the polyhedron constructor gets much better.\n> \n> Vincent\n\n\nThanks for pointing it out. I've pulled and tried #22605. Indeed, that fixes this ticket but MIP's `polyhedra` existent doctests now fail because it always returns RDF polyhedra. \n\nSo I understand that the thing to be fixed here is some processing at MIP's `polyhedron` as suggested in Thierry's comment:5",
    "created_at": "2017-06-28T08:37:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23326#issuecomment-322485",
    "user": "https://github.com/mforets"
}
```

Replying to [comment:7 vdelecroix]:
> Hi Marcelo, Thierry,
> 
> Did you have a look at #22605? Of course it breaks some doctests in MIP but the polyhedron constructor gets much better.
> 
> Vincent


Thanks for pointing it out. I've pulled and tried #22605. Indeed, that fixes this ticket but MIP's `polyhedra` existent doctests now fail because it always returns RDF polyhedra. 

So I understand that the thing to be fixed here is some processing at MIP's `polyhedron` as suggested in Thierry's comment:5



---

archive/issue_comments_322486.json:
```json
{
    "body": "Then\u00a0if #22605 gets in, here we can just adapt the backend, `p = MixedIntegerLinearProgram(solver='ppl')`, in the doctests that involve rationals, while keeping the one i added with `solver='GLPK'`. Does it make sense?",
    "created_at": "2017-06-28T13:45:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23326#issuecomment-322486",
    "user": "https://github.com/mforets"
}
```

Then if #22605 gets in, here we can just adapt the backend, `p = MixedIntegerLinearProgram(solver='ppl')`, in the doctests that involve rationals, while keeping the one i added with `solver='GLPK'`. Does it make sense?



---

archive/issue_comments_322487.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-07-27T15:10:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23326#issuecomment-322487",
    "user": "https://github.com/mforets"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_322488.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2017-07-27T15:10:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23326#issuecomment-322488",
    "user": "https://github.com/mforets"
}
```

Last 10 new commits:



---

archive/issue_comments_322489.json:
```json
{
    "body": ".. filling the authors field",
    "created_at": "2017-07-27T19:53:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23326#issuecomment-322489",
    "user": "https://github.com/mforets"
}
```

.. filling the authors field



---

archive/issue_events_060060.json:
```json
{
    "actor": "https://github.com/mforets",
    "created_at": "2017-09-03T13:53:43Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23326",
    "milestone": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23326#event-60060"
}
```



---

archive/issue_comments_322490.json:
```json
{
    "body": "Would be simpler and cleaner to just rebase your 5 lines commit on the latest beta (8.1.beta3) which contains #22605.",
    "created_at": "2017-09-04T05:59:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23326#issuecomment-322490",
    "user": "https://github.com/videlec"
}
```

Would be simpler and cleaner to just rebase your 5 lines commit on the latest beta (8.1.beta3) which contains #22605.



---

archive/issue_comments_322491.json:
```json
{
    "body": "is it the same as `git checkout t/mforets/23326` followed by a `git merge develop`?",
    "created_at": "2017-09-04T13:05:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23326#issuecomment-322491",
    "user": "https://github.com/mforets"
}
```

is it the same as `git checkout t/mforets/23326` followed by a `git merge develop`?



---

archive/issue_comments_322492.json:
```json
{
    "body": "No. Just do\n\n```bash\n$ git checkout t/mforets/23326\n$ git reset --hard develop      # reset the branch on top of develop\n$ git cherry-pick `9dc381e`     # just pick the one commit needed\n```\nAn additional merge introduces plenty of complications.\n\nAfter that you will need to force push on the trac server. That is provide the option `-f`\n\n```bash\n$ git push trac -f HEAD:u/mforets/23326\n```",
    "created_at": "2017-09-04T16:31:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23326#issuecomment-322492",
    "user": "https://github.com/videlec"
}
```

No. Just do

```bash
$ git checkout t/mforets/23326
$ git reset --hard develop      # reset the branch on top of develop
$ git cherry-pick `9dc381e`     # just pick the one commit needed
```
An additional merge introduces plenty of complications.

After that you will need to force push on the trac server. That is provide the option `-f`

```bash
$ git push trac -f HEAD:u/mforets/23326
```



---

archive/issue_comments_322493.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-09-04T18:44:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23326#issuecomment-322493",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_322494.json:
```json
{
    "body": "great! that worked, thanks.",
    "created_at": "2017-09-04T18:53:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23326#issuecomment-322494",
    "user": "https://github.com/mforets"
}
```

great! that worked, thanks.



---

archive/issue_comments_322495.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-09-05T12:50:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23326#issuecomment-322495",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_322496.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-09-10T11:57:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23326",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23326#issuecomment-322496",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_060061.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-09-10T11:57:36Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23326",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23326#event-60061"
}
```
