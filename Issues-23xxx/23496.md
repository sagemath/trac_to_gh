# Issue 23496: sympy patch for abstract function

archive/issues_023259.json:
```json
{
    "body": "Assignee: @man74cio\n\nCC:  @tscrim @egourgoulhon @rwst\n\nGeneric function are not transformed from sympy to sage. \nthis patch implement the PR https://github.com/sympy/sympy/pull/12826\n\nIssue created by migration from https://trac.sagemath.org/ticket/23496\n\n",
    "closed_at": "2017-09-10T11:57:33Z",
    "created_at": "2017-07-20T19:14:12Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "sympy patch for abstract function",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23496",
    "user": "https://github.com/man74cio"
}
```
Assignee: @man74cio

CC:  @tscrim @egourgoulhon @rwst

Generic function are not transformed from sympy to sage. 
this patch implement the PR https://github.com/sympy/sympy/pull/12826

Issue created by migration from https://trac.sagemath.org/ticket/23496





---

archive/issue_comments_325055.json:
```json
{
    "body": "Set assignee to @man74cio.",
    "created_at": "2017-07-20T19:17:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325055",
    "user": "https://github.com/man74cio"
}
```

Set assignee to @man74cio.



---

archive/issue_comments_325056.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to symbolics.",
    "created_at": "2017-07-20T19:17:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325056",
    "user": "https://github.com/man74cio"
}
```

Changing component from PLEASE CHANGE to symbolics.



---

archive/issue_comments_325057.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-20T19:57:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325057",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_325058.json:
```json
{
    "body": "Is this ready for review?",
    "created_at": "2017-07-20T23:04:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325058",
    "user": "https://github.com/tscrim"
}
```

Is this ready for review?



---

archive/issue_comments_325059.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-07-21T02:35:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325059",
    "user": "https://github.com/man74cio"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_325060.json:
```json
{
    "body": "Yes, pleiade",
    "created_at": "2017-07-21T02:35:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325060",
    "user": "https://github.com/man74cio"
}
```

Yes, pleiade



---

archive/issue_comments_325061.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-07-21T02:35:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325061",
    "user": "https://github.com/man74cio"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_325062.json:
```json
{
    "body": "Yes, please",
    "created_at": "2017-07-21T02:35:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325062",
    "user": "https://github.com/man74cio"
}
```

Yes, please



---

archive/issue_comments_325063.json:
```json
{
    "body": "Is the setting this to needs_work a double-post-type error or is there an actual issue?\n\nAlso, could you ping upstream again? It would be good to know that they accepted the patch as-is.",
    "created_at": "2017-07-21T23:32:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325063",
    "user": "https://github.com/tscrim"
}
```

Is the setting this to needs_work a double-post-type error or is there an actual issue?

Also, could you ping upstream again? It would be good to know that they accepted the patch as-is.



---

archive/issue_comments_325064.json:
```json
{
    "body": "Double error, sorry",
    "created_at": "2017-07-22T02:10:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325064",
    "user": "https://github.com/man74cio"
}
```

Double error, sorry



---

archive/issue_comments_325065.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-07-22T02:10:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325065",
    "user": "https://github.com/man74cio"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_325066.json:
```json
{
    "body": "You need to also bump the patch level in `package-version.txt` so that it rebuilds sympy.\n\nDid you send another message to upstream asking about the status of the patch?",
    "created_at": "2017-07-24T00:04:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325066",
    "user": "https://github.com/tscrim"
}
```

You need to also bump the patch level in `package-version.txt` so that it rebuilds sympy.

Did you send another message to upstream asking about the status of the patch?



---

archive/issue_comments_325067.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-24T07:53:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325067",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_325068.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-24T08:12:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325068",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_325069.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-24T11:57:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325069",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_325070.json:
```json
{
    "body": "Replying to [comment:11 tscrim]:\n> You need to also bump the patch level in `package-version.txt` so that it rebuilds sympy.\n> \n> Did you send another message to upstream asking about the status of the patch?\n\n\nThe referee said me that tests are still falling on travis. I asked to see the report (I have not access to travis).",
    "created_at": "2017-07-25T08:06:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325070",
    "user": "https://github.com/man74cio"
}
```

Replying to [comment:11 tscrim]:
> You need to also bump the patch level in `package-version.txt` so that it rebuilds sympy.
> 
> Did you send another message to upstream asking about the status of the patch?


The referee said me that tests are still falling on travis. I asked to see the report (I have not access to travis).



---

archive/issue_comments_325071.json:
```json
{
    "body": "I have submitted the correction to the sympy ticket, \nIf it passes the tests then I will change it also in the current branch",
    "created_at": "2017-07-25T13:39:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325071",
    "user": "https://github.com/man74cio"
}
```

I have submitted the correction to the sympy ticket, 
If it passes the tests then I will change it also in the current branch



---

archive/issue_comments_325072.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-26T11:49:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325072",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_325073.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-26T11:56:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325073",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_325074.json:
```json
{
    "body": "The sympy patch was merged 12826",
    "created_at": "2017-07-29T06:25:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325074",
    "user": "https://github.com/man74cio"
}
```

The sympy patch was merged 12826



---

archive/issue_comments_325075.json:
```json
{
    "body": "Just put your real names in the author field, bump the patch level in sympy, and remove the trivial whitespace change in `function.pyx`. Once done, you can set a positive review on my behalf.",
    "created_at": "2017-07-29T06:40:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325075",
    "user": "https://github.com/tscrim"
}
```

Just put your real names in the author field, bump the patch level in sympy, and remove the trivial whitespace change in `function.pyx`. Once done, you can set a positive review on my behalf.



---

archive/issue_comments_325076.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-29T18:53:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325076",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_325077.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-07-29T18:54:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325077",
    "user": "https://github.com/man74cio"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_325078.json:
```json
{
    "body": "I hope it is ok :\nthe function.pyx is now at the old state, i reversed it to before my modifications.",
    "created_at": "2017-07-29T18:57:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325078",
    "user": "https://github.com/man74cio"
}
```

I hope it is ok :
the function.pyx is now at the old state, i reversed it to before my modifications.



---

archive/issue_comments_325079.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-07-30T17:07:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325079",
    "user": "https://github.com/tscrim"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_325080.json:
```json
{
    "body": "You still need to bump the patch level:\n\n```diff\n-1.0.p2\n+1.0.p3\n```\nin `$SAGE_ROOT/build/pkgs/sympy/package-version.txt`.",
    "created_at": "2017-07-30T17:07:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325080",
    "user": "https://github.com/tscrim"
}
```

You still need to bump the patch level:

```diff
-1.0.p2
+1.0.p3
```
in `$SAGE_ROOT/build/pkgs/sympy/package-version.txt`.



---

archive/issue_events_060276.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2017-07-30T17:07:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "milestone": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23496#event-60276"
}
```



---

archive/issue_comments_325081.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-30T18:18:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325081",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_325082.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-31T02:54:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325082",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_325083.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2017-07-31T02:56:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325083",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_325084.json:
```json
{
    "body": "Trivial rebase with `8.1beta0`. Thanks, LGTM.",
    "created_at": "2017-07-31T02:56:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325084",
    "user": "https://github.com/tscrim"
}
```

Trivial rebase with `8.1beta0`. Thanks, LGTM.



---

archive/issue_comments_325085.json:
```json
{
    "body": "See patchbot",
    "created_at": "2017-07-31T22:10:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325085",
    "user": "https://github.com/vbraun"
}
```

See patchbot



---

archive/issue_comments_325086.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-07-31T22:10:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325086",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_325087.json:
```json
{
    "body": "This is quite interesting as failure\n\n```\nsage -t --long /usr/lib64/python2.7/site-packages/sage/tests/french_book/recequadiff.py\ntoo many failed tests, not using stored timings\nRunning doctests with ID 2017-08-01-11-17-21-10bca036.\nUsing --optional=optional,sage\nDoctesting 1 file.\nsage -t --long /usr/lib64/python2.7/site-packages/sage/tests/french_book/recequadiff.py\n**********************************************************************\nFile \"/usr/lib64/python2.7/site-packages/sage/tests/french_book/recequadiff.py\", line 383, in sage.tests.french_book.recequadiff\nFailed example:\n    f = u(n+2)-(3/2)*u(n+1)+(1/2)*u(n)\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib64/python2.7/site-packages/sage/doctest/forker.py\", line 512, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib64/python2.7/site-packages/sage/doctest/forker.py\", line 875, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.tests.french_book.recequadiff[108]>\", line 1, in <module>\n        f = u(n+Integer(2))-(Integer(3)/Integer(2))*u(n+Integer(1))+(Integer(1)/Integer(2))*u(n)\n      File \"/usr/lib64/python2.7/site-packages/sympy/core/decorators.py\", line 76, in __sympifyit_wrapper\n        b = sympify(b, strict=True)\n      File \"/usr/lib64/python2.7/site-packages/sympy/core/sympify.py\", line 265, in sympify\n        return a._sympy_()\n      File \"sage/symbolic/expression.pyx\", line 1445, in sage.symbolic.expression.Expression._sympy_ (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/symbolic/expression.cpp:11783)\n        return sympy(self)\n      File \"/usr/lib64/python2.7/site-packages/sage/symbolic/expression_conversions.py\", line 218, in __call__\n        return self.arithmetic(ex, operator)\n      File \"/usr/lib64/python2.7/site-packages/sage/symbolic/expression_conversions.py\", line 716, in arithmetic\n        ops = [sympy.sympify(self(a), evaluate=False) for a in ex.operands()]\n      File \"/usr/lib64/python2.7/site-packages/sage/symbolic/expression_conversions.py\", line 226, in __call__\n        return self.composition(ex, operator)\n      File \"/usr/lib64/python2.7/site-packages/sage/symbolic/expression_conversions.py\", line 767, in composition\n        raise NotImplementedError(\"SymPy function '%s' doesn't exist\" % f)\n    NotImplementedError: SymPy function 'u' doesn't exist\n**********************************************************************\nFile \"/usr/lib64/python2.7/site-packages/sage/tests/french_book/recequadiff.py\", line 388, in sage.tests.french_book.recequadiff\nFailed example:\n    rsolve(f, u(n), {u(0):-1,u(1):1})\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib64/python2.7/site-packages/sage/doctest/forker.py\", line 512, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib64/python2.7/site-packages/sage/doctest/forker.py\", line 875, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.tests.french_book.recequadiff[110]>\", line 1, in <module>\n        rsolve(f, u(n), {u(Integer(0)):-Integer(1),u(Integer(1)):Integer(1)})\n      File \"/usr/lib64/python2.7/site-packages/sympy/solvers/recurr.py\", line 722, in rsolve\n        f = f.expand().collect(y.func(Wild('m', integer=True)))\n      File \"sage/symbolic/expression.pyx\", line 7163, in sage.symbolic.expression.Expression.collect (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/symbolic/expression.cpp:42956)\n        cdef Expression s0 = self.coerce_in(s)\n      File \"sage/symbolic/expression.pyx\", line 2956, in sage.symbolic.expression.Expression.coerce_in (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/symbolic/expression.cpp:22665)\n        return self._parent._coerce_(z)\n      File \"sage/structure/parent_old.pyx\", line 230, in sage.structure.parent_old.Parent._coerce_ (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/structure/parent_old.c:4888)\n        return self.coerce(x)\n      File \"sage/structure/parent.pyx\", line 1168, in sage.structure.parent.Parent.coerce (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/structure/parent.c:11000)\n        mor = self._internal_coerce_map_from(parent(x))\n      File \"sage/structure/parent.pyx\", line 2107, in sage.structure.parent.Parent._internal_coerce_map_from (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/structure/parent.c:18735)\n        mor = self.discover_coerce_map_from(S)\n      File \"sage/structure/parent.pyx\", line 2246, in sage.structure.parent.Parent.discover_coerce_map_from (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/structure/parent.c:19211)\n        user_provided_mor = self._coerce_map_from_(S)\n      File \"sage/symbolic/ring.pyx\", line 91, in sage.symbolic.ring.SymbolicRing._coerce_map_from_ (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/symbolic/ring.cpp:4056)\n        cpdef _coerce_map_from_(self, R):\n      File \"/usr/lib64/python2.7/site-packages/sage/symbolic/callable.py\", line 310, in _coerce_map_from_\n        return SymbolicRing._coerce_map_from_(self, R)\n      File \"sage/symbolic/ring.pyx\", line 91, in sage.symbolic.ring.SymbolicRing._coerce_map_from_ (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/symbolic/ring.cpp:5643)\n        cpdef _coerce_map_from_(self, R):\n      File \"sage/symbolic/ring.pyx\", line 167, in sage.symbolic.ring.SymbolicRing._coerce_map_from_ (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/symbolic/ring.cpp:4315)\n        if 'sympy' in R.__module__:\n    TypeError: argument of type 'NoneType' is not iterable\n**********************************************************************\n1 item had failures:\n   2 of 115 in sage.tests.french_book.recequadiff\n    [114 tests, 2 failures, 4.43 s]\n----------------------------------------------------------------------\nsage -t --long /usr/lib64/python2.7/site-packages/sage/tests/french_book/recequadiff.py  # 2 doctests failed\n```\nThe first doctest goes\n\n```\nPython 2.7.12 (default, Feb 16 2017, 16:28:54) \n[GCC 4.9.4] on linux2\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> from sympy import Function, Symbol\n>>> u = Function('u'); n = Symbol('n', integer=True)\n>>> f = u(n+2)-(3/2)*u(n+1)+(1/2)*u(n)\n>>>\n```\nand is no problem in python. But in sage \"boom\". But there is more\n\n```\nsage: from sympy import Function, Symbol\nsage: u = Function('u'); n = Symbol('n', integer=True)\nsage: f = u(n+2)-(3/2)*u(n+1)+(1/2)*u(n)\n---------------------------------------------------------------------------\nNotImplementedError                       Traceback (most recent call last)\n<ipython-input-3-a0e08a1755b9> in <module>()\n----> 1 f = u(n+Integer(2))-(Integer(3)/Integer(2))*u(n+Integer(1))+(Integer(1)/Integer(2))*u(n)\n\n/usr/lib64/python2.7/site-packages/sympy/core/decorators.pyc in __sympifyit_wrapper(a, b)\n     74                 # with sympy objects. Otherwise, it must be converted.\n     75                 if not hasattr(b, '_op_priority'):\n---> 76                     b = sympify(b, strict=True)\n     77                 return func(a, b)\n     78             except SympifyError:\n\n/usr/lib64/python2.7/site-packages/sympy/core/sympify.pyc in sympify(a, locals, convert_xor, strict, rational, evaluate)\n    263 \n    264     try:\n--> 265         return a._sympy_()\n    266     except AttributeError:\n    267         pass\n\n/usr/lib64/python2.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._sympy_ (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/symbolic/expression.cpp:11783)()\n   1443         \"\"\"\n   1444         from sage.symbolic.expression_conversions import sympy\n-> 1445         return sympy(self)\n   1446 \n   1447     def _algebraic_(self, field):\n\n/usr/lib64/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in __call__(self, ex)\n    216                 div = self.get_fake_div(ex)\n    217                 return self.arithmetic(div, div.operator())\n--> 218             return self.arithmetic(ex, operator)\n    219         elif operator in relation_operators:\n    220             return self.relation(ex, operator)\n\n/usr/lib64/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in arithmetic(self, ex, operator)\n    714         import sympy\n    715         operator = arithmetic_operators[operator]\n--> 716         ops = [sympy.sympify(self(a), evaluate=False) for a in ex.operands()]\n    717         if operator == \"+\":\n    718             return sympy.Add(*ops)\n\n/usr/lib64/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in __call__(self, ex)\n    224             return self.tuple(ex)\n    225         else:\n--> 226             return self.composition(ex, operator)\n    227 \n    228     def get_fake_div(self, ex):\n\n/usr/lib64/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in composition(self, ex, operator)\n    765             return f_sympy(*sympy.sympify(g, evaluate=False))\n    766         else:\n--> 767             raise NotImplementedError(\"SymPy function '%s' doesn't exist\" % f)\n    768 \n    769 sympy = SympyConverter()\n\nNotImplementedError: SymPy function 'u' doesn't exist\nsage: f = 1*u(n+2)-(3/2)*u(n+1)+(1/2)*u(n)\nsage: \n```\nThat's right, multiply the first term by `1` the problem disappear.",
    "created_at": "2017-07-31T23:23:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325087",
    "user": "https://github.com/kiwifb"
}
```

This is quite interesting as failure

```
sage -t --long /usr/lib64/python2.7/site-packages/sage/tests/french_book/recequadiff.py
too many failed tests, not using stored timings
Running doctests with ID 2017-08-01-11-17-21-10bca036.
Using --optional=optional,sage
Doctesting 1 file.
sage -t --long /usr/lib64/python2.7/site-packages/sage/tests/french_book/recequadiff.py
**********************************************************************
File "/usr/lib64/python2.7/site-packages/sage/tests/french_book/recequadiff.py", line 383, in sage.tests.french_book.recequadiff
Failed example:
    f = u(n+2)-(3/2)*u(n+1)+(1/2)*u(n)
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 512, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 875, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.tests.french_book.recequadiff[108]>", line 1, in <module>
        f = u(n+Integer(2))-(Integer(3)/Integer(2))*u(n+Integer(1))+(Integer(1)/Integer(2))*u(n)
      File "/usr/lib64/python2.7/site-packages/sympy/core/decorators.py", line 76, in __sympifyit_wrapper
        b = sympify(b, strict=True)
      File "/usr/lib64/python2.7/site-packages/sympy/core/sympify.py", line 265, in sympify
        return a._sympy_()
      File "sage/symbolic/expression.pyx", line 1445, in sage.symbolic.expression.Expression._sympy_ (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/symbolic/expression.cpp:11783)
        return sympy(self)
      File "/usr/lib64/python2.7/site-packages/sage/symbolic/expression_conversions.py", line 218, in __call__
        return self.arithmetic(ex, operator)
      File "/usr/lib64/python2.7/site-packages/sage/symbolic/expression_conversions.py", line 716, in arithmetic
        ops = [sympy.sympify(self(a), evaluate=False) for a in ex.operands()]
      File "/usr/lib64/python2.7/site-packages/sage/symbolic/expression_conversions.py", line 226, in __call__
        return self.composition(ex, operator)
      File "/usr/lib64/python2.7/site-packages/sage/symbolic/expression_conversions.py", line 767, in composition
        raise NotImplementedError("SymPy function '%s' doesn't exist" % f)
    NotImplementedError: SymPy function 'u' doesn't exist
**********************************************************************
File "/usr/lib64/python2.7/site-packages/sage/tests/french_book/recequadiff.py", line 388, in sage.tests.french_book.recequadiff
Failed example:
    rsolve(f, u(n), {u(0):-1,u(1):1})
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 512, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 875, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.tests.french_book.recequadiff[110]>", line 1, in <module>
        rsolve(f, u(n), {u(Integer(0)):-Integer(1),u(Integer(1)):Integer(1)})
      File "/usr/lib64/python2.7/site-packages/sympy/solvers/recurr.py", line 722, in rsolve
        f = f.expand().collect(y.func(Wild('m', integer=True)))
      File "sage/symbolic/expression.pyx", line 7163, in sage.symbolic.expression.Expression.collect (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/symbolic/expression.cpp:42956)
        cdef Expression s0 = self.coerce_in(s)
      File "sage/symbolic/expression.pyx", line 2956, in sage.symbolic.expression.Expression.coerce_in (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/symbolic/expression.cpp:22665)
        return self._parent._coerce_(z)
      File "sage/structure/parent_old.pyx", line 230, in sage.structure.parent_old.Parent._coerce_ (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/structure/parent_old.c:4888)
        return self.coerce(x)
      File "sage/structure/parent.pyx", line 1168, in sage.structure.parent.Parent.coerce (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/structure/parent.c:11000)
        mor = self._internal_coerce_map_from(parent(x))
      File "sage/structure/parent.pyx", line 2107, in sage.structure.parent.Parent._internal_coerce_map_from (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/structure/parent.c:18735)
        mor = self.discover_coerce_map_from(S)
      File "sage/structure/parent.pyx", line 2246, in sage.structure.parent.Parent.discover_coerce_map_from (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/structure/parent.c:19211)
        user_provided_mor = self._coerce_map_from_(S)
      File "sage/symbolic/ring.pyx", line 91, in sage.symbolic.ring.SymbolicRing._coerce_map_from_ (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/symbolic/ring.cpp:4056)
        cpdef _coerce_map_from_(self, R):
      File "/usr/lib64/python2.7/site-packages/sage/symbolic/callable.py", line 310, in _coerce_map_from_
        return SymbolicRing._coerce_map_from_(self, R)
      File "sage/symbolic/ring.pyx", line 91, in sage.symbolic.ring.SymbolicRing._coerce_map_from_ (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/symbolic/ring.cpp:5643)
        cpdef _coerce_map_from_(self, R):
      File "sage/symbolic/ring.pyx", line 167, in sage.symbolic.ring.SymbolicRing._coerce_map_from_ (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/symbolic/ring.cpp:4315)
        if 'sympy' in R.__module__:
    TypeError: argument of type 'NoneType' is not iterable
**********************************************************************
1 item had failures:
   2 of 115 in sage.tests.french_book.recequadiff
    [114 tests, 2 failures, 4.43 s]
----------------------------------------------------------------------
sage -t --long /usr/lib64/python2.7/site-packages/sage/tests/french_book/recequadiff.py  # 2 doctests failed
```
The first doctest goes

```
Python 2.7.12 (default, Feb 16 2017, 16:28:54) 
[GCC 4.9.4] on linux2
Type "help", "copyright", "credits" or "license" for more information.
>>> from sympy import Function, Symbol
>>> u = Function('u'); n = Symbol('n', integer=True)
>>> f = u(n+2)-(3/2)*u(n+1)+(1/2)*u(n)
>>>
```
and is no problem in python. But in sage "boom". But there is more

```
sage: from sympy import Function, Symbol
sage: u = Function('u'); n = Symbol('n', integer=True)
sage: f = u(n+2)-(3/2)*u(n+1)+(1/2)*u(n)
---------------------------------------------------------------------------
NotImplementedError                       Traceback (most recent call last)
<ipython-input-3-a0e08a1755b9> in <module>()
----> 1 f = u(n+Integer(2))-(Integer(3)/Integer(2))*u(n+Integer(1))+(Integer(1)/Integer(2))*u(n)

/usr/lib64/python2.7/site-packages/sympy/core/decorators.pyc in __sympifyit_wrapper(a, b)
     74                 # with sympy objects. Otherwise, it must be converted.
     75                 if not hasattr(b, '_op_priority'):
---> 76                     b = sympify(b, strict=True)
     77                 return func(a, b)
     78             except SympifyError:

/usr/lib64/python2.7/site-packages/sympy/core/sympify.pyc in sympify(a, locals, convert_xor, strict, rational, evaluate)
    263 
    264     try:
--> 265         return a._sympy_()
    266     except AttributeError:
    267         pass

/usr/lib64/python2.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._sympy_ (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/symbolic/expression.cpp:11783)()
   1443         """
   1444         from sage.symbolic.expression_conversions import sympy
-> 1445         return sympy(self)
   1446 
   1447     def _algebraic_(self, field):

/usr/lib64/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in __call__(self, ex)
    216                 div = self.get_fake_div(ex)
    217                 return self.arithmetic(div, div.operator())
--> 218             return self.arithmetic(ex, operator)
    219         elif operator in relation_operators:
    220             return self.relation(ex, operator)

/usr/lib64/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in arithmetic(self, ex, operator)
    714         import sympy
    715         operator = arithmetic_operators[operator]
--> 716         ops = [sympy.sympify(self(a), evaluate=False) for a in ex.operands()]
    717         if operator == "+":
    718             return sympy.Add(*ops)

/usr/lib64/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in __call__(self, ex)
    224             return self.tuple(ex)
    225         else:
--> 226             return self.composition(ex, operator)
    227 
    228     def get_fake_div(self, ex):

/usr/lib64/python2.7/site-packages/sage/symbolic/expression_conversions.pyc in composition(self, ex, operator)
    765             return f_sympy(*sympy.sympify(g, evaluate=False))
    766         else:
--> 767             raise NotImplementedError("SymPy function '%s' doesn't exist" % f)
    768 
    769 sympy = SympyConverter()

NotImplementedError: SymPy function 'u' doesn't exist
sage: f = 1*u(n+2)-(3/2)*u(n+1)+(1/2)*u(n)
sage: 
```
That's right, multiply the first term by `1` the problem disappear.



---

archive/issue_comments_325088.json:
```json
{
    "body": "What is sage \"boom\" ?\nthe problem was not present before the rebase with `8.1beta0`, is it true?",
    "created_at": "2017-08-01T08:22:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325088",
    "user": "https://github.com/man74cio"
}
```

What is sage "boom" ?
the problem was not present before the rebase with `8.1beta0`, is it true?



---

archive/issue_comments_325089.json:
```json
{
    "body": "Pardon me my antics. \"boom\" as in sage breaks down. Just a minor explosion since it doesn't crash, just tells you off. I don't know if it was present before `8.1beta0`. My only suggestion on a possible cause is #23413 but that's just a stab in the dark.",
    "created_at": "2017-08-01T09:13:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325089",
    "user": "https://github.com/kiwifb"
}
```

Pardon me my antics. "boom" as in sage breaks down. Just a minor explosion since it doesn't crash, just tells you off. I don't know if it was present before `8.1beta0`. My only suggestion on a possible cause is #23413 but that's just a stab in the dark.



---

archive/issue_comments_325090.json:
```json
{
    "body": "Effectively the error disappear when I revert the changes in sympy.\nbut it before the `8.1beta0` it was ok.",
    "created_at": "2017-08-01T12:33:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325090",
    "user": "https://github.com/man74cio"
}
```

Effectively the error disappear when I revert the changes in sympy.
but it before the `8.1beta0` it was ok.



---

archive/issue_comments_325091.json:
```json
{
    "body": "the missing conversion is the composition of functions in the sympy converter, which was done here: #20204.",
    "created_at": "2017-08-28T06:35:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325091",
    "user": "https://github.com/mforets"
}
```

the missing conversion is the composition of functions in the sympy converter, which was done here: #20204.



---

archive/issue_comments_325092.json:
```json
{
    "body": "Replying to [comment:34 mforets]:\n> the missing conversion is the composition of functions in the sympy converter, which was done here: #20204. \n\n\nShall the patch be added here, or you prefer to create a dependency for this one?\n\n\n(FYI: the problem with #20204 is that i couldn't patch sympy such that `f._sage_()` works, so that we have conversions in both ways, as commented [in the sympy PR](https://github.com/sympy/sympy/pull/12826).)",
    "created_at": "2017-08-28T16:11:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325092",
    "user": "https://github.com/mforets"
}
```

Replying to [comment:34 mforets]:
> the missing conversion is the composition of functions in the sympy converter, which was done here: #20204. 


Shall the patch be added here, or you prefer to create a dependency for this one?


(FYI: the problem with #20204 is that i couldn't patch sympy such that `f._sage_()` works, so that we have conversions in both ways, as commented [in the sympy PR](https://github.com/sympy/sympy/pull/12826).)



---

archive/issue_comments_325093.json:
```json
{
    "body": "I think that you should create a dependency on this ticket in your (#20204).\nThis ticket was created to separate the sympy patch from the modifications done in Sage.\nThis ticket is yet a dependency of #22802\n\n\nReplying to [comment:35 mforets]:\n> Replying to [comment:34 mforets]:\n> > the missing conversion is the composition of functions in the sympy converter, which was done here: #20204. \n\n> \n> Shall the patch be added here, or you prefer to create a dependency for this one?\n> \n> \n> (FYI: the problem with #20204 is that i couldn't patch sympy such that `f._sage_()` works, so that we have conversions in both ways, as commented [in the sympy PR](https://github.com/sympy/sympy/pull/12826).)",
    "created_at": "2017-08-29T11:37:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325093",
    "user": "https://github.com/man74cio"
}
```

I think that you should create a dependency on this ticket in your (#20204).
This ticket was created to separate the sympy patch from the modifications done in Sage.
This ticket is yet a dependency of #22802


Replying to [comment:35 mforets]:
> Replying to [comment:34 mforets]:
> > the missing conversion is the composition of functions in the sympy converter, which was done here: #20204. 

> 
> Shall the patch be added here, or you prefer to create a dependency for this one?
> 
> 
> (FYI: the problem with #20204 is that i couldn't patch sympy such that `f._sage_()` works, so that we have conversions in both ways, as commented [in the sympy PR](https://github.com/sympy/sympy/pull/12826).)



---

archive/issue_comments_325094.json:
```json
{
    "body": "Changing status from needs_work to needs_info.",
    "created_at": "2017-08-30T08:52:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325094",
    "user": "https://github.com/mforets"
}
```

Changing status from needs_work to needs_info.



---

archive/issue_comments_325095.json:
```json
{
    "body": "OK, done. if you pull #20204 which has been merged with this one, there is no \"boom\".\n\nbut we haven't changed anything in this one, so how is it possible that this ticket gets in? \n\nOTOH, I'm afraid there will be conflicts with #22802.",
    "created_at": "2017-08-30T08:52:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325095",
    "user": "https://github.com/mforets"
}
```

OK, done. if you pull #20204 which has been merged with this one, there is no "boom".

but we haven't changed anything in this one, so how is it possible that this ticket gets in? 

OTOH, I'm afraid there will be conflicts with #22802.



---

archive/issue_comments_325096.json:
```json
{
    "body": "The boom was caused by the rebase with `8.10beta0`. has your branch done this operation? I think no. Before the rebase there was not error in the tests.",
    "created_at": "2017-08-30T08:59:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325096",
    "user": "https://github.com/man74cio"
}
```

The boom was caused by the rebase with `8.10beta0`. has your branch done this operation? I think no. Before the rebase there was not error in the tests.



---

archive/issue_comments_325097.json:
```json
{
    "body": "Replying to [comment:39 mmancini]:\n> The boom was caused by the rebase with `8.10beta0`. has your branch done this operation? \n\n\nthe branch `t/mforets/20204` has been merged with 8.1.beta3.",
    "created_at": "2017-08-30T09:10:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325097",
    "user": "https://github.com/mforets"
}
```

Replying to [comment:39 mmancini]:
> The boom was caused by the rebase with `8.10beta0`. has your branch done this operation? 


the branch `t/mforets/20204` has been merged with 8.1.beta3.



---

archive/issue_comments_325098.json:
```json
{
    "body": "If you merged your stuff with #20204 and it cannot work without the rest of #20204 we have two solutions:\n* make the tickets depend on each other. Feels circular but it is an indication that the tickets need to be merged together.\n* mark this ticket as a duplicate and close it, leaving only the branch at #20204.\n\nBonus question: Will we be able to upgrade sympy to 1.1.1 easily once everything is in? Currently it leads to failures, again because of missing converter if I am not mistaken (this is a report from sage-on-gentoo don't look for an upgrade ticket at this stage).",
    "created_at": "2017-08-30T09:34:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325098",
    "user": "https://github.com/kiwifb"
}
```

If you merged your stuff with #20204 and it cannot work without the rest of #20204 we have two solutions:
* make the tickets depend on each other. Feels circular but it is an indication that the tickets need to be merged together.
* mark this ticket as a duplicate and close it, leaving only the branch at #20204.

Bonus question: Will we be able to upgrade sympy to 1.1.1 easily once everything is in? Currently it leads to failures, again because of missing converter if I am not mistaken (this is a report from sage-on-gentoo don't look for an upgrade ticket at this stage).



---

archive/issue_comments_325099.json:
```json
{
    "body": "This ticket was part of the #22802 (now #22802 ticket depends on this ticket).\nThe referee asked to separate it in 2 tickets : #22802 containing the converter ._sympy_() and the #23496 containing only the sympy patch (._sage())",
    "created_at": "2017-08-30T11:48:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325099",
    "user": "https://github.com/man74cio"
}
```

This ticket was part of the #22802 (now #22802 ticket depends on this ticket).
The referee asked to separate it in 2 tickets : #22802 containing the converter ._sympy_() and the #23496 containing only the sympy patch (._sage())



---

archive/issue_comments_325100.json:
```json
{
    "body": "Ok, then i upvote for making this and #20204 depending on each other. afterwards, merge with #22802.",
    "created_at": "2017-08-30T20:11:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325100",
    "user": "https://github.com/mforets"
}
```

Ok, then i upvote for making this and #20204 depending on each other. afterwards, merge with #22802.



---

archive/issue_comments_325101.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-09-01T14:17:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325101",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_325102.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-09-01T14:39:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325102",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_325103.json:
```json
{
    "body": "`@`mmancini : i don't understand the last two commits. those changes are changing the purpose of this ticket. what do you think about comment:43?",
    "created_at": "2017-09-01T18:30:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325103",
    "user": "https://github.com/mforets"
}
```

`@`mmancini : i don't understand the last two commits. those changes are changing the purpose of this ticket. what do you think about comment:43?



---

archive/issue_comments_325104.json:
```json
{
    "body": "Replying to [comment:46 mforets]:\n> `@`mmancini : i don't understand the last two commits. those changes are changing the purpose of this ticket. what do you think about comment:43?\n\n\n\nAfter a week of debugging I think that this is the unique to pass the tests in french_book.recequadiff :\nin test : \n383   sage: f = u(n+2)-(3/2)*u(n+1)+(1/2)*u(n)\nthe integer 3/2  (Sage Integer) makes necessary the modifications (you suggested) to composition function:\nu(n+2) is sympy\n(3/2)*u(n+1) is sage \n...\n...\n\n\n\nthe error in\n388 sage: rsolve(f, u(n), {u(0):-1,u(1):1})\nis caused by the fact that Sympy integer are not imported.\n\nBefore the sympy patch there was not error but for me it was not correct:\nbecause the expressions mixed sympy (u,n) and sage quantities (1/2).",
    "created_at": "2017-09-01T21:06:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325104",
    "user": "https://github.com/man74cio"
}
```

Replying to [comment:46 mforets]:
> `@`mmancini : i don't understand the last two commits. those changes are changing the purpose of this ticket. what do you think about comment:43?



After a week of debugging I think that this is the unique to pass the tests in french_book.recequadiff :
in test : 
383   sage: f = u(n+2)-(3/2)*u(n+1)+(1/2)*u(n)
the integer 3/2  (Sage Integer) makes necessary the modifications (you suggested) to composition function:
u(n+2) is sympy
(3/2)*u(n+1) is sage 
...
...



the error in
388 sage: rsolve(f, u(n), {u(0):-1,u(1):1})
is caused by the fact that Sympy integer are not imported.

Before the sympy patch there was not error but for me it was not correct:
because the expressions mixed sympy (u,n) and sage quantities (1/2).



---

archive/issue_comments_325105.json:
```json
{
    "body": "That is quite a piece of debugging. However, there should be some natural place to put in this import statement within the code, either in Sage or Sympy. Do you have an idea about where it should go?",
    "created_at": "2017-09-02T05:44:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325105",
    "user": "https://github.com/tscrim"
}
```

That is quite a piece of debugging. However, there should be some natural place to put in this import statement within the code, either in Sage or Sympy. Do you have an idea about where it should go?



---

archive/issue_comments_325106.json:
```json
{
    "body": "I have no idea. For me the expression is not well written: if I am using sage and I want resolve it with a sympy method: before I write the expression than I covert it before to use sympy method and finally I convert back the result. But a strange mixing for me is not sane.",
    "created_at": "2017-09-02T06:14:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325106",
    "user": "https://github.com/man74cio"
}
```

I have no idea. For me the expression is not well written: if I am using sage and I want resolve it with a sympy method: before I write the expression than I covert it before to use sympy method and finally I convert back the result. But a strange mixing for me is not sane.



---

archive/issue_comments_325107.json:
```json
{
    "body": "what i find odd is that:\n\n- using `n = Symbol('n')` in the `rsolve` test it works,\n- similarly but using `from sympy.abc import n`.\n\nto move on, i propose to modify the test as below, and report the failing use case in a new ticket.\n\n```\nsage: n = var('n', domain='integer'); u = function('u')\nsage: f = u(n+2)-(3/2)*u(n+1)+(1/2)*u(n)\nsage: us = u._sympy_() ; fs = f._sympy_();\nsage: from sympy import rsolve; rsolve(fs, us(n), {us(0):-1,us(1):1})\n3 - 4*2**(-n)\n```\n\nwhat do you think?",
    "created_at": "2017-09-02T08:43:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325107",
    "user": "https://github.com/mforets"
}
```

what i find odd is that:

- using `n = Symbol('n')` in the `rsolve` test it works,
- similarly but using `from sympy.abc import n`.

to move on, i propose to modify the test as below, and report the failing use case in a new ticket.

```
sage: n = var('n', domain='integer'); u = function('u')
sage: f = u(n+2)-(3/2)*u(n+1)+(1/2)*u(n)
sage: us = u._sympy_() ; fs = f._sympy_();
sage: from sympy import rsolve; rsolve(fs, us(n), {us(0):-1,us(1):1})
3 - 4*2**(-n)
```

what do you think?



---

archive/issue_comments_325108.json:
```json
{
    "body": "- also works if you cast the sage integers to symbolic expressions, the rest of the test unchanged: `f = u(n+2)-SR(3/2)*u(n+1)+SR(1/2)*u(n)`",
    "created_at": "2017-09-02T09:06:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325108",
    "user": "https://github.com/mforets"
}
```

- also works if you cast the sage integers to symbolic expressions, the rest of the test unchanged: `f = u(n+2)-SR(3/2)*u(n+1)+SR(1/2)*u(n)`



---

archive/issue_comments_325109.json:
```json
{
    "body": "I agree,It is a coherent way to do things.\nWe need to do another ticket?\n\nReplying to [comment:50 mforets]:\n> what i find odd is that:\n> \n> - using `n = Symbol('n')` in the `rsolve` test it works,\n> - similarly but using `from sympy.abc import n`.\n> \n> to move on, i propose to modify the test as below, and report the failing use case in a new ticket.\n> \n> \n> ```\n> sage: n = var('n', domain='integer'); u = function('u')\n> sage: f = u(n+2)-(3/2)*u(n+1)+(1/2)*u(n)\n> sage: us = u._sympy_() ; fs = f._sympy_();\n> sage: from sympy import rsolve; rsolve(fs, us(n), {us(0):-1,us(1):1})\n> 3 - 4*2**(-n)\n> ```\n> \n> what do you think?",
    "created_at": "2017-09-02T10:06:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325109",
    "user": "https://github.com/man74cio"
}
```

I agree,It is a coherent way to do things.
We need to do another ticket?

Replying to [comment:50 mforets]:
> what i find odd is that:
> 
> - using `n = Symbol('n')` in the `rsolve` test it works,
> - similarly but using `from sympy.abc import n`.
> 
> to move on, i propose to modify the test as below, and report the failing use case in a new ticket.
> 
> 
> ```
> sage: n = var('n', domain='integer'); u = function('u')
> sage: f = u(n+2)-(3/2)*u(n+1)+(1/2)*u(n)
> sage: us = u._sympy_() ; fs = f._sympy_();
> sage: from sympy import rsolve; rsolve(fs, us(n), {us(0):-1,us(1):1})
> 3 - 4*2**(-n)
> ```
> 
> what do you think?



---

archive/issue_comments_325110.json:
```json
{
    "body": "Replying to [comment:51 mforets]:\n> - also works if you cast the sage integers to symbolic expressions, the rest of the test unchanged: `f = u(n+2)-SR(3/2)*u(n+1)+SR(1/2)*u(n)`\n\n\nIt is also possible to postpone rational numbers to prevent sympy-two-day intermediate conversion :`f = u(n+2)-u(n+1)*3/2+u(n)*1/2`",
    "created_at": "2017-09-02T10:12:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325110",
    "user": "https://github.com/man74cio"
}
```

Replying to [comment:51 mforets]:
> - also works if you cast the sage integers to symbolic expressions, the rest of the test unchanged: `f = u(n+2)-SR(3/2)*u(n+1)+SR(1/2)*u(n)`


It is also possible to postpone rational numbers to prevent sympy-two-day intermediate conversion :`f = u(n+2)-u(n+1)*3/2+u(n)*1/2`



---

archive/issue_comments_325111.json:
```json
{
    "body": "Replying to [comment:52 mmancini]:\n> I agree,It is a coherent way to do things.\n\n\n+1\n\n> We need to do another ticket?\n\n\nIMHO yes, because this is a different issue; the new ticket could be about implementing `rsolve` in Sage, as an interface to sympy's `rsolve`. \n\nThe doctest discussed here is used as an example on page 17 of this document:\nhttps://members.loria.fr/PZimmermann/sagebook/recequadiff.pdf ,\nwhich is a chapter of the English translation of the so-called \"French book\" (*Calcul math\u00e9matique avec Sage*). The latter is currently in its final preparatory stage, cf. https://groups.google.com/forum/#!topic/sage-devel/MalKzTyvrys .\nOne should probably ask the authors to update this example (the book is not likely to be out before Sage 8.1, where the current ticket could be effective).",
    "created_at": "2017-09-02T13:20:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325111",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:52 mmancini]:
> I agree,It is a coherent way to do things.


+1

> We need to do another ticket?


IMHO yes, because this is a different issue; the new ticket could be about implementing `rsolve` in Sage, as an interface to sympy's `rsolve`. 

The doctest discussed here is used as an example on page 17 of this document:
https://members.loria.fr/PZimmermann/sagebook/recequadiff.pdf ,
which is a chapter of the English translation of the so-called "French book" (*Calcul mathématique avec Sage*). The latter is currently in its final preparatory stage, cf. https://groups.google.com/forum/#!topic/sage-devel/MalKzTyvrys .
One should probably ask the authors to update this example (the book is not likely to be out before Sage 8.1, where the current ticket could be effective).



---

archive/issue_comments_325112.json:
```json
{
    "body": "I understand what changes with that import statement, every Integer becomes a Sympy Integer because the preparser replaces things like `1` with `Integer(1)`. I strongly believe we should be testing behavior that mixes Sage and Sympy, as this is a very natural thing to do (in Sage), so I disagree with changing the test and also [1b5227d](https://git.sagemath.org/sage.git/commit/?id=1b5227d6a85a540663aa138e8304a9055ba110fd).",
    "created_at": "2017-09-02T15:18:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325112",
    "user": "https://github.com/tscrim"
}
```

I understand what changes with that import statement, every Integer becomes a Sympy Integer because the preparser replaces things like `1` with `Integer(1)`. I strongly believe we should be testing behavior that mixes Sage and Sympy, as this is a very natural thing to do (in Sage), so I disagree with changing the test and also [1b5227d](https://git.sagemath.org/sage.git/commit/?id=1b5227d6a85a540663aa138e8304a9055ba110fd).



---

archive/issue_comments_325113.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2017-09-02T15:18:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325113",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_325114.json:
```json
{
    "body": "Interesting, this works on my machine:\n\n```\nf = u(n+2)-u(n+1)*(3/2)+u(n)/2\n```\nDoing more debugging currently.",
    "created_at": "2017-09-02T15:46:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325114",
    "user": "https://github.com/tscrim"
}
```

Interesting, this works on my machine:

```
f = u(n+2)-u(n+1)*(3/2)+u(n)/2
```
Doing more debugging currently.



---

archive/issue_comments_325115.json:
```json
{
    "body": "It seems to boil back down to this:\n\n```\nsage: type((3/2) * u(n+1))\n<type 'sage.symbolic.expression.Expression'>\nsage: type(u(n+1) * (3/2))\n<class 'sympy.core.mul.Mul'>\n```",
    "created_at": "2017-09-02T15:47:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325115",
    "user": "https://github.com/tscrim"
}
```

It seems to boil back down to this:

```
sage: type((3/2) * u(n+1))
<type 'sage.symbolic.expression.Expression'>
sage: type(u(n+1) * (3/2))
<class 'sympy.core.mul.Mul'>
```



---

archive/issue_comments_325116.json:
```json
{
    "body": "Actually, that might just be a symptom rather than the cause. I'm wondering if there is something wrong with doing the conversion to Sympy:\n\n```\nsage: f = u(n+2)-sympy.sympify(3/2)*u(n+1)+sympy.sympify(1/2)*u(n)  # This works\nsage: f = u(n+2)-sympy.sympify((3/2)*u(n+1))+sympy.sympify((1/2)*u(n))  # This fails\n```",
    "created_at": "2017-09-02T16:11:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325116",
    "user": "https://github.com/tscrim"
}
```

Actually, that might just be a symptom rather than the cause. I'm wondering if there is something wrong with doing the conversion to Sympy:

```
sage: f = u(n+2)-sympy.sympify(3/2)*u(n+1)+sympy.sympify(1/2)*u(n)  # This works
sage: f = u(n+2)-sympy.sympify((3/2)*u(n+1))+sympy.sympify((1/2)*u(n))  # This fails
```



---

archive/issue_comments_325117.json:
```json
{
    "body": "I think this is the real problem with all of this:\n\n```\nsage: from sympy import Symbol\nsage: n = Symbol('n', integer=True)\nsage: sympy.sympify(1+n).args[1] == n\nFalse\n```\nThe roundtrip of a sympy symbol through Sage results in a different symbol:\n\n```\nsage: m = Symbol('n', integer=True)\nsage: m == n\nTrue\nsage: p = Symbol('n')\nsage: p == n\nFalse\n\nsage: sympy.simplify(SR(n)).assumptions0\n{'commutative': True}\nsage: n.assumptions0\n{'algebraic': True,\n 'commutative': True,\n 'complex': True,\n 'hermitian': True,\n 'imaginary': False,\n 'integer': True,\n 'irrational': False,\n 'noninteger': False,\n 'rational': True,\n 'real': True,\n 'transcendental': False}\nsage: p is sympy.sympify(SR(n))\nTrue\n```\nSo I think we need to translate assumptions over to truly fix the problem.",
    "created_at": "2017-09-02T16:34:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325117",
    "user": "https://github.com/tscrim"
}
```

I think this is the real problem with all of this:

```
sage: from sympy import Symbol
sage: n = Symbol('n', integer=True)
sage: sympy.sympify(1+n).args[1] == n
False
```
The roundtrip of a sympy symbol through Sage results in a different symbol:

```
sage: m = Symbol('n', integer=True)
sage: m == n
True
sage: p = Symbol('n')
sage: p == n
False

sage: sympy.simplify(SR(n)).assumptions0
{'commutative': True}
sage: n.assumptions0
{'algebraic': True,
 'commutative': True,
 'complex': True,
 'hermitian': True,
 'imaginary': False,
 'integer': True,
 'irrational': False,
 'noninteger': False,
 'rational': True,
 'real': True,
 'transcendental': False}
sage: p is sympy.sympify(SR(n))
True
```
So I think we need to translate assumptions over to truly fix the problem.



---

archive/issue_comments_325118.json:
```json
{
    "body": "I'm also a little more open to just fixing the test (but making sure everything says in Sympy with a big warning message in the doctest).",
    "created_at": "2017-09-02T16:36:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325118",
    "user": "https://github.com/tscrim"
}
```

I'm also a little more open to just fixing the test (but making sure everything says in Sympy with a big warning message in the doctest).



---

archive/issue_comments_325119.json:
```json
{
    "body": "Changing status from needs_work to needs_info.",
    "created_at": "2017-09-02T16:49:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325119",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_work to needs_info.



---

archive/issue_comments_325120.json:
```json
{
    "body": "I guess what I am asking is do we want to fix the problem of comment:59 here or just push it to a later ticket?",
    "created_at": "2017-09-02T16:49:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325120",
    "user": "https://github.com/tscrim"
}
```

I guess what I am asking is do we want to fix the problem of comment:59 here or just push it to a later ticket?



---

archive/issue_comments_325121.json:
```json
{
    "body": "Replying to [comment:60 tscrim]:\n> I'm also a little more open to just fixing the test \n\nIndeed, the test, as it is, is quite unnatural from a Sage's user point of view: the import of specific Sympy objects (in the line `from sympy import Function, Symbol`) and their mixing with some Sage objects (in the line `f = u(n+2)-(3/2)*u(n+1)+(1/2)*u(n)`), with *implicit* conversions Sage <--> Sympy involved, without any user control on them, is not something desirable. The change proposed in comment:50 seems much more reasonable: one defines first `f` entirely as a Sage object and then *explicitely* convert it to a Sympy object before passing it to Sympy's `rsolve`, because there is no Sage's `rsolve` yet.",
    "created_at": "2017-09-02T16:58:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325121",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:60 tscrim]:
> I'm also a little more open to just fixing the test 

Indeed, the test, as it is, is quite unnatural from a Sage's user point of view: the import of specific Sympy objects (in the line `from sympy import Function, Symbol`) and their mixing with some Sage objects (in the line `f = u(n+2)-(3/2)*u(n+1)+(1/2)*u(n)`), with *implicit* conversions Sage <--> Sympy involved, without any user control on them, is not something desirable. The change proposed in comment:50 seems much more reasonable: one defines first `f` entirely as a Sage object and then *explicitely* convert it to a Sympy object before passing it to Sympy's `rsolve`, because there is no Sage's `rsolve` yet.



---

archive/issue_comments_325122.json:
```json
{
    "body": "Replying to [comment:61 tscrim]:\n> I guess what I am asking is do we want to fix the problem of comment:59 here or just push it to a later ticket?\n\n\n+1 for a later ticket.",
    "created_at": "2017-09-02T17:00:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325122",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:61 tscrim]:
> I guess what I am asking is do we want to fix the problem of comment:59 here or just push it to a later ticket?


+1 for a later ticket.



---

archive/issue_comments_325123.json:
```json
{
    "body": "Replying to [comment:62 egourgoulhon]:\n> Replying to [comment:60 tscrim]:\n> > I'm also a little more open to just fixing the test \n\n> Indeed, the test, as it is, is quite unnatural from a Sage's user point of view: the import of specific Sympy objects (in the line `from sympy import Function, Symbol`) and their mixing with some Sage objects (in the line `f = u(n+2)-(3/2)*u(n+1)+(1/2)*u(n)`), with *implicit* conversions Sage <--> Sympy involved, without any user control on them, is not something desirable. The change proposed in comment:50 seems much more reasonable: one defines first `f` entirely as a Sage object and then *explicitely* convert it to a Sympy object before passing it to Sympy's `rsolve`, because there is no Sage's `rsolve` yet.\n\nI don't think it is that unnatural as someone who wants to use sympy, something that we do suggest to people, would construct something in that fashion. One of the benefits of Sage are those implicit conversions so that users should not have to worry about them.\n\nHowever, that discussion aside, I think that we should keep as close to the original doctest because it is in Calcul Math\u00e9matique avec Sage (even if it is out of date). So I believe we should just change the order of multiplication of the coefficients as in comment:56 and add a warning about it.",
    "created_at": "2017-09-02T17:30:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325123",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:62 egourgoulhon]:
> Replying to [comment:60 tscrim]:
> > I'm also a little more open to just fixing the test 

> Indeed, the test, as it is, is quite unnatural from a Sage's user point of view: the import of specific Sympy objects (in the line `from sympy import Function, Symbol`) and their mixing with some Sage objects (in the line `f = u(n+2)-(3/2)*u(n+1)+(1/2)*u(n)`), with *implicit* conversions Sage <--> Sympy involved, without any user control on them, is not something desirable. The change proposed in comment:50 seems much more reasonable: one defines first `f` entirely as a Sage object and then *explicitely* convert it to a Sympy object before passing it to Sympy's `rsolve`, because there is no Sage's `rsolve` yet.

I don't think it is that unnatural as someone who wants to use sympy, something that we do suggest to people, would construct something in that fashion. One of the benefits of Sage are those implicit conversions so that users should not have to worry about them.

However, that discussion aside, I think that we should keep as close to the original doctest because it is in Calcul Mathématique avec Sage (even if it is out of date). So I believe we should just change the order of multiplication of the coefficients as in comment:56 and add a warning about it.



---

archive/issue_comments_325124.json:
```json
{
    "body": "hi, thank you all for the help debugging. with this sympy patch (at sympy/core/function.py and on top of #20204), it works for me:\n\n```\nclass AppliedUndef(Function):\n    \"\"\"\n    Base class for expressions resulting from the application of an undefined\n    function.\n    \"\"\"\n    .\n    .\n    .\n    def _sage_(self):\n        import sage.all as sage\n        fname = self.func.__name__\n        func = getattr(sage, fname)\n        args = [arg._sage_() for arg in self.args]\n        return func\n```\n\ndo you already have the same `_sage_` there?",
    "created_at": "2017-09-02T19:31:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325124",
    "user": "https://github.com/mforets"
}
```

hi, thank you all for the help debugging. with this sympy patch (at sympy/core/function.py and on top of #20204), it works for me:

```
class AppliedUndef(Function):
    """
    Base class for expressions resulting from the application of an undefined
    function.
    """
    .
    .
    .
    def _sage_(self):
        import sage.all as sage
        fname = self.func.__name__
        func = getattr(sage, fname)
        args = [arg._sage_() for arg in self.args]
        return func
```

do you already have the same `_sage_` there?



---

archive/issue_comments_325125.json:
```json
{
    "body": "Replying to [comment:64 tscrim]:\n> I don't think it is that unnatural as someone who wants to use sympy, something that we do suggest to people, would construct something in that fashion. One of the benefits of Sage are those implicit conversions so that users should not have to worry about them.\n\n>\n\nWell, there is some degree of arbitrariness in these implicit conversions: if `a` is a Sage object and `b` a Sympy object, what `a*b` shall be? For the example of the French textbook as it is now, with `a`=`3/2` and `b`=`u(n+1)`, we want `a*b` to be a Sympy object, so that the final `f` is a Sympy object. But in other cases?",
    "created_at": "2017-09-02T19:33:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325125",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:64 tscrim]:
> I don't think it is that unnatural as someone who wants to use sympy, something that we do suggest to people, would construct something in that fashion. One of the benefits of Sage are those implicit conversions so that users should not have to worry about them.

>

Well, there is some degree of arbitrariness in these implicit conversions: if `a` is a Sage object and `b` a Sympy object, what `a*b` shall be? For the example of the French textbook as it is now, with `a`=`3/2` and `b`=`u(n+1)`, we want `a*b` to be a Sympy object, so that the final `f` is a Sympy object. But in other cases?



---

archive/issue_comments_325126.json:
```json
{
    "body": "> So I believe we should just change the order of multiplication of the coefficients as in comment:56 and add a warning about it. \n\n\nit seems that game was played before:\n\n```\n$ git show 12cdb58d7a02391224477d0d99312be8fc03f678\n@@ -379,7 +379,7 @@ Sage example in ./recequadiff.tex, line 1197::\n\n Sage example in ./recequadiff.tex, line 1208::\n\n\n-  sage: f = u(n+2)-u(n+1)*(3/2)+u(n)*(1/2)\n+  sage: f = u(n+2)-(3/2)*u(n+1)+(1/2)*u(n)\n```\n\nthis is a commit by Ralph.",
    "created_at": "2017-09-02T19:45:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325126",
    "user": "https://github.com/mforets"
}
```

> So I believe we should just change the order of multiplication of the coefficients as in comment:56 and add a warning about it. 


it seems that game was played before:

```
$ git show 12cdb58d7a02391224477d0d99312be8fc03f678
@@ -379,7 +379,7 @@ Sage example in ./recequadiff.tex, line 1197::

 Sage example in ./recequadiff.tex, line 1208::


-  sage: f = u(n+2)-u(n+1)*(3/2)+u(n)*(1/2)
+  sage: f = u(n+2)-(3/2)*u(n+1)+(1/2)*u(n)
```

this is a commit by Ralph.



---

archive/issue_comments_325127.json:
```json
{
    "body": "`@`mforets comment:67 - All the more reason to just do the minimal change. IIRC, we needed to do that in order for the construction of `f` to not fail, but with this patch, it is okay.\n\n`@`egourgoulhon comment:66 - Yes, there is currently some ambiguity because of things are done, but ultimately it shouldn't matter. Although if I really had to decide, I would say everything should go to Sympy objects because we cannot expect Sympy objects to work with our coercion system.",
    "created_at": "2017-09-02T20:43:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325127",
    "user": "https://github.com/tscrim"
}
```

`@`mforets comment:67 - All the more reason to just do the minimal change. IIRC, we needed to do that in order for the construction of `f` to not fail, but with this patch, it is okay.

`@`egourgoulhon comment:66 - Yes, there is currently some ambiguity because of things are done, but ultimately it shouldn't matter. Although if I really had to decide, I would say everything should go to Sympy objects because we cannot expect Sympy objects to work with our coercion system.



---

archive/issue_comments_325128.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2017-09-03T12:28:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325128",
    "user": "https://github.com/mforets"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_325129.json:
```json
{
    "body": "ok, let's do it => needs review\n\nnote: this does not depend on #20204.\n\n(`@`Marco : sorry, i did not intend to create a new branch, just after pushing i realized the current says \"abstact\" instead of \"abstract\")\n\n---\nNew commits:",
    "created_at": "2017-09-03T12:28:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325129",
    "user": "https://github.com/mforets"
}
```

ok, let's do it => needs review

note: this does not depend on #20204.

(`@`Marco : sorry, i did not intend to create a new branch, just after pushing i realized the current says "abstact" instead of "abstract")

---
New commits:



---

archive/issue_comments_325130.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-09-03T13:00:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325130",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_325131.json:
```json
{
    "body": "> > We need to do another ticket?\n\n> \n> IMHO yes, because this is a different issue; the new ticket could be about implementing `rsolve` in Sage, as an interface to sympy's `rsolve`. \n> \n\n\nyes, that would be a nice feature. we can use ticket #1291. also open is the sage interface to sympy's `solve` (#22322).",
    "created_at": "2017-09-03T13:33:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325131",
    "user": "https://github.com/mforets"
}
```

> > We need to do another ticket?

> 
> IMHO yes, because this is a different issue; the new ticket could be about implementing `rsolve` in Sage, as an interface to sympy's `rsolve`. 
> 


yes, that would be a nice feature. we can use ticket #1291. also open is the sage interface to sympy's `solve` (#22322).



---

archive/issue_comments_325132.json:
```json
{
    "body": "Replying to [comment:69 mforets]:\n> ok, let's do it => needs review\n> \n> note: this does not depend on #20204.\n> \n> (`@`Marco : sorry, i did not intend to create a new branch, just after pushing i realized the current says \"abstact\" instead of \"abstract\")\n\n\nNo problem, thanks.",
    "created_at": "2017-09-03T14:11:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325132",
    "user": "https://github.com/man74cio"
}
```

Replying to [comment:69 mforets]:
> ok, let's do it => needs review
> 
> note: this does not depend on #20204.
> 
> (`@`Marco : sorry, i did not intend to create a new branch, just after pushing i realized the current says "abstact" instead of "abstract")


No problem, thanks.



---

archive/issue_comments_325133.json:
```json
{
    "body": "the patchbot errrors seem to be unrelated to our patch, but on a GLPK update.",
    "created_at": "2017-09-04T09:23:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325133",
    "user": "https://github.com/mforets"
}
```

the patchbot errrors seem to be unrelated to our patch, but on a GLPK update.



---

archive/issue_comments_325134.json:
```json
{
    "body": "Positive review. Thanks for your work on this.",
    "created_at": "2017-09-04T14:28:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325134",
    "user": "https://github.com/tscrim"
}
```

Positive review. Thanks for your work on this.



---

archive/issue_comments_325135.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-09-04T14:28:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325135",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_325136.json:
```json
{
    "body": "Thanks from me as well.",
    "created_at": "2017-09-04T14:33:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325136",
    "user": "https://github.com/rwst"
}
```

Thanks from me as well.



---

archive/issue_comments_325137.json:
```json
{
    "body": "Thank you for the review",
    "created_at": "2017-09-05T08:59:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325137",
    "user": "https://github.com/man74cio"
}
```

Thank you for the review



---

archive/issue_comments_325138.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-09-10T11:57:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23496#issuecomment-325138",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_060277.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-09-10T11:57:33Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23496",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23496#event-60277"
}
```
