# Issue 23762: sage.env._add_variable_or_fallback: Get rid of $variable substitution feature

archive/issues_023525.json:
```json
{
    "body": "As discussed in #23758, the feature of `_add_variable_or_fallback` to do variable substitution seems unnecessarily complex.\n\nAll uses later in that module such as \n\n```\n_add_variable_or_fallback('SAGE_ETC',        opj('$SAGE_LOCAL', 'etc'))\n```\ncan be replaced by simple use of Python variables (which all exist in the `sage.env` module)\n\n```\n_add_variable_or_fallback('SAGE_ETC',        opj(SAGE_LOCAL, 'etc'))\n```\nThis also will have a clearer failure mode -- instead of leaving an unsubstituted $SAGE_LOCAL in a string if that variable is not set for some reason, an error will be raised.\n\n\nCC:  @jhpalmieri\n\nBranch: [u/jhpalmieri/env](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/env)\n\nDependencies: #23758, #21535\n\nCommit: c7cff80c2eb7c62e09917ac95f44305d3884ebd2\n\nResolution: duplicate\n\nIssue created by migration from https://trac.sagemath.org/ticket/23762\n\n",
    "closed_at": "2019-01-18T12:34:38Z",
    "created_at": "2017-08-31T05:01:29Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "sage.env._add_variable_or_fallback: Get rid of $variable substitution feature",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23762",
    "user": "https://github.com/mkoeppe"
}
```
As discussed in #23758, the feature of `_add_variable_or_fallback` to do variable substitution seems unnecessarily complex.

All uses later in that module such as 

```
_add_variable_or_fallback('SAGE_ETC',        opj('$SAGE_LOCAL', 'etc'))
```
can be replaced by simple use of Python variables (which all exist in the `sage.env` module)

```
_add_variable_or_fallback('SAGE_ETC',        opj(SAGE_LOCAL, 'etc'))
```
This also will have a clearer failure mode -- instead of leaving an unsubstituted $SAGE_LOCAL in a string if that variable is not set for some reason, an error will be raised.


CC:  @jhpalmieri

Branch: [u/jhpalmieri/env](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/env)

Dependencies: #23758, #21535

Commit: c7cff80c2eb7c62e09917ac95f44305d3884ebd2

Resolution: duplicate

Issue created by migration from https://trac.sagemath.org/ticket/23762





---

archive/issue_comments_450707.json:
```json
{
    "body": "<a id='comment:1'></a>\nI think the variable substitution scheme was introduced in #13432. I've asked there about its rationale: I don't want to remove this without trying to understand why it was introduced in the first place.\n\nIn the mean time, I have a branch which makes the change from strings to variables: `'$VAR' --> VAR`.",
    "created_at": "2017-08-31T22:22:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23762#issuecomment-450707",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:1'></a>
I think the variable substitution scheme was introduced in #13432. I've asked there about its rationale: I don't want to remove this without trying to understand why it was introduced in the first place.

In the mean time, I have a branch which makes the change from strings to variables: `'$VAR' --> VAR`.



---

archive/issue_comments_450708.json:
```json
{
    "body": "Changing branch from \"\" to \"u/jhpalmieri/env\"",
    "created_at": "2017-08-31T22:32:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23762#issuecomment-450708",
    "user": "https://github.com/jhpalmieri"
}
```

Changing branch from "" to "u/jhpalmieri/env"



---

archive/issue_comments_450709.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#23758\"",
    "created_at": "2017-08-31T22:33:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23762#issuecomment-450709",
    "user": "https://github.com/jhpalmieri"
}
```

Changing dependencies from "" to "#23758"



---

archive/issue_comments_450710.json:
```json
{
    "body": "Changing commit from \"\" to \"c7cff80c2eb7c62e09917ac95f44305d3884ebd2\"",
    "created_at": "2017-08-31T22:33:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23762#issuecomment-450710",
    "user": "https://github.com/jhpalmieri"
}
```

Changing commit from "" to "c7cff80c2eb7c62e09917ac95f44305d3884ebd2"



---

archive/issue_comments_450711.json:
```json
{
    "body": "<a id='comment:3'></a>\nNew commits:\n|                                                                                                                                          |                                                                  |\n|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------|\n|[eb4137b](https://github.com/sagemath/sagetrac-mirror/commit/eb4137b1883ffd014a6b5a8fb0be1517898afc1b)|`trac 23762: in sage/env.py, get rid of the variable substitution`|\n|[60927e5](https://github.com/sagemath/sagetrac-mirror/commit/60927e52bd991cce1467ce0488ad29a4915b1986)|`trac 23758: in env.py, _add_variable_or_fallback should depend less`|\n|[c23cc1c](https://github.com/sagemath/sagetrac-mirror/commit/c23cc1cb041c57d364edd3b39389af7e1945ff44)|`trac 23758: restore \"import os\"`|\n|[343d685](https://github.com/sagemath/sagetrac-mirror/commit/343d685800f3c4018724cbea795e79d64c9adeca)|`trac 23758: add a doctest`|\n|[c7cff80](https://github.com/sagemath/sagetrac-mirror/commit/c7cff80c2eb7c62e09917ac95f44305d3884ebd2)|`Merge branch 't/23758/variable_replacement' into env`|",
    "created_at": "2017-08-31T22:33:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23762#issuecomment-450711",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:3'></a>
New commits:
|                                                                                                                                          |                                                                  |
|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------|
|[eb4137b](https://github.com/sagemath/sagetrac-mirror/commit/eb4137b1883ffd014a6b5a8fb0be1517898afc1b)|`trac 23762: in sage/env.py, get rid of the variable substitution`|
|[60927e5](https://github.com/sagemath/sagetrac-mirror/commit/60927e52bd991cce1467ce0488ad29a4915b1986)|`trac 23758: in env.py, _add_variable_or_fallback should depend less`|
|[c23cc1c](https://github.com/sagemath/sagetrac-mirror/commit/c23cc1cb041c57d364edd3b39389af7e1945ff44)|`trac 23758: restore "import os"`|
|[343d685](https://github.com/sagemath/sagetrac-mirror/commit/343d685800f3c4018724cbea795e79d64c9adeca)|`trac 23758: add a doctest`|
|[c7cff80](https://github.com/sagemath/sagetrac-mirror/commit/c7cff80c2eb7c62e09917ac95f44305d3884ebd2)|`Merge branch 't/23758/variable_replacement' into env`|



---

archive/issue_comments_450712.json:
```json
{
    "body": "<a id='comment:4'></a>\nThis branch passes doctests for me, but I want to wait to set it to \"needs_review\" for some feedback from the participants at #13432.",
    "created_at": "2017-09-01T00:38:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23762#issuecomment-450712",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:4'></a>
This branch passes doctests for me, but I want to wait to set it to "needs_review" for some feedback from the participants at #13432.



---

archive/issue_comments_450713.json:
```json
{
    "body": "<a id='comment:5'></a>\nPotential conflict with #21535.",
    "created_at": "2017-09-01T12:31:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23762#issuecomment-450713",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>
Potential conflict with #21535.



---

archive/issue_comments_450714.json:
```json
{
    "body": "Changing dependencies from \"#23758\" to \"#23758, #21535\"",
    "created_at": "2017-09-01T12:31:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23762#issuecomment-450714",
    "user": "https://github.com/jdemeyer"
}
```

Changing dependencies from "#23758" to "#23758, #21535"



---

archive/issue_comments_450715.json:
```json
{
    "body": "<a id='comment:6'></a>\nReplying to [jdemeyer](#comment%3A5):\n> Potential conflict with #21535.\n\n\nOkay, it should be easy to rebase. I will wait until #21535 has settled into a stable state (and also to see if there are objections to this ticket as a whole).",
    "created_at": "2017-09-01T14:40:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23762#issuecomment-450715",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:6'></a>
Replying to [jdemeyer](#comment%3A5):
> Potential conflict with #21535.


Okay, it should be easy to rebase. I will wait until #21535 has settled into a stable state (and also to see if there are objections to this ticket as a whole).



---

archive/issue_events_068959.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-01-18T12:34:38Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23762",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23762#event-68959"
}
```



---

archive/issue_comments_450716.json:
```json
{
    "body": "<a id='comment:7'></a>\nI don't think I ever saw the original version of this, but it would be superseded now by #27040 (which accomplishes the same goal).",
    "created_at": "2019-01-18T12:34:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23762#issuecomment-450716",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>
I don't think I ever saw the original version of this, but it would be superseded now by #27040 (which accomplishes the same goal).



---

archive/issue_events_068960.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-01-18T12:34:38Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23762",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23762#event-68960"
}
```



---

archive/issue_comments_450717.json:
```json
{
    "body": "Resolution: duplicate",
    "created_at": "2019-01-18T12:34:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23762#issuecomment-450717",
    "user": "https://github.com/embray"
}
```

Resolution: duplicate
