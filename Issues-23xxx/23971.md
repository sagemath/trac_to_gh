# Issue 23971: Euclidean division in quadratic imaginary orders

archive/issues_023734.json:
```json
{
    "body": "The result of a `//` should remain in the same ring, but it currently does not:\n\n```\nsage: (GaussianIntegers()(1)//1).parent()\nNumber Field in I with defining polynomial x^2 + 1\n```\n\nThis is caused by order elements inheriting from `FieldElement` which makes the assumption that `_floordiv_` and `_div_` are the same.\n\nReviewer: David Roe, Julian R\u00fcth\n\nAuthor: Jeroen Demeyer\n\nBranch: u/jdemeyer/floordiv_in_orders_returns_a_number_field_element\n\nStatus: needs_info\n\nCommit: 1ccb1ba157361a7b70fe7cf2d22163666f3bd838\n\nIssue created by migration from https://trac.sagemath.org/ticket/23971\n\n",
    "created_at": "2017-10-06T00:59:40Z",
    "labels": [
        "component: number fields",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Euclidean division in quadratic imaginary orders",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23971",
    "user": "https://github.com/saraedum"
}
```
The result of a `//` should remain in the same ring, but it currently does not:

```
sage: (GaussianIntegers()(1)//1).parent()
Number Field in I with defining polynomial x^2 + 1
```

This is caused by order elements inheriting from `FieldElement` which makes the assumption that `_floordiv_` and `_div_` are the same.

Reviewer: David Roe, Julian Rüth

Author: Jeroen Demeyer

Branch: u/jdemeyer/floordiv_in_orders_returns_a_number_field_element

Status: needs_info

Commit: 1ccb1ba157361a7b70fe7cf2d22163666f3bd838

Issue created by migration from https://trac.sagemath.org/ticket/23971





---

archive/issue_comments_353893.json:
```json
{
    "body": "<a id='comment:1'></a>This is tricky, since most orders in number fields are not Euclidean, so quotient with remainder doesn't make sense.",
    "created_at": "2017-10-06T02:32:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23971#issuecomment-353893",
    "user": "https://github.com/roed314"
}
```

<a id='comment:1'></a>This is tricky, since most orders in number fields are not Euclidean, so quotient with remainder doesn't make sense.



---

archive/issue_comments_353894.json:
```json
{
    "body": "<a id='comment:2'></a>Well, the correct behaviour would be to do the right thing in the imaginary quadratic orders which are naturally Euclidean and raise an exception otherwise.",
    "created_at": "2017-10-06T07:56:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23971#issuecomment-353894",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>Well, the correct behaviour would be to do the right thing in the imaginary quadratic orders which are naturally Euclidean and raise an exception otherwise.



---

archive/issue_comments_353895.json:
```json
{
    "body": "<a id='comment:3'></a>For me it would be sufficient for `a//b` to be `parent(a/b)` and raise an exception (NotImplemented?) if that is not in the same ring.",
    "created_at": "2017-10-07T15:53:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23971#issuecomment-353895",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:3'></a>For me it would be sufficient for `a//b` to be `parent(a/b)` and raise an exception (NotImplemented?) if that is not in the same ring.



---

archive/issue_comments_353896.json:
```json
{
    "body": "<a id='comment:4'></a>Replying to [comment:2 jdemeyer]:\n> Well, the correct behaviour would be to do the right thing in the imaginary quadratic orders which are naturally Euclidean and raise an exception otherwise.\n\n\nThere are other orders which are norm Euclidean (some real quadratic orders for example).  See http://www.fen.bilkent.edu.tr/~franz/publ/survey.pdf\n\nOf course, it's computationally more difficult to find a remainder when the unit group is nontrivial.",
    "created_at": "2017-10-18T21:47:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23971#issuecomment-353896",
    "user": "https://github.com/roed314"
}
```

<a id='comment:4'></a>Replying to [comment:2 jdemeyer]:
> Well, the correct behaviour would be to do the right thing in the imaginary quadratic orders which are naturally Euclidean and raise an exception otherwise.


There are other orders which are norm Euclidean (some real quadratic orders for example).  See http://www.fen.bilkent.edu.tr/~franz/publ/survey.pdf

Of course, it's computationally more difficult to find a remainder when the unit group is nontrivial.



---

archive/issue_comments_353897.json:
```json
{
    "body": "<a id='comment:7'></a>New commits:",
    "created_at": "2017-10-20T13:40:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23971#issuecomment-353897",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>New commits:



---

archive/issue_comments_353898.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-10-20T13:44:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23971#issuecomment-353898",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_353899.json:
```json
{
    "body": "<a id='comment:9'></a>First, the patchbot is unhappy: there's a strange merge failure on Cygwin, complaining about `CONFLICT (content): Merge conflict in src/sage/parallel/map_reduce.py` (which I don't understand, since other merges into `8.1.beta8` succeeded), and a test failure in `sage/structure/element.pyx`.\n\nSome thoughts on the code:\n\n* Julian suggested having `a//b` return `parent(a/b)` when b divides `a` and raise an error otherwise.  This makes sense for any integral domain, and I think it's a good idea: so often this is what we want for floor division.  It's a bit strange to have different behavior for different `b`, but we already do this to some extent: `b=0` will always raise an error.\n\n* Why did you choose to round to even?  It would be more consistent with `QQ` to round down.\n\n* I think we should also implement `__mod__` and `quo_rem` to match this implementation of floor division.  This doesn't have to be on this ticket.",
    "created_at": "2017-10-20T16:59:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23971#issuecomment-353899",
    "user": "https://github.com/roed314"
}
```

<a id='comment:9'></a>First, the patchbot is unhappy: there's a strange merge failure on Cygwin, complaining about `CONFLICT (content): Merge conflict in src/sage/parallel/map_reduce.py` (which I don't understand, since other merges into `8.1.beta8` succeeded), and a test failure in `sage/structure/element.pyx`.

Some thoughts on the code:

* Julian suggested having `a//b` return `parent(a/b)` when b divides `a` and raise an error otherwise.  This makes sense for any integral domain, and I think it's a good idea: so often this is what we want for floor division.  It's a bit strange to have different behavior for different `b`, but we already do this to some extent: `b=0` will always raise an error.

* Why did you choose to round to even?  It would be more consistent with `QQ` to round down.

* I think we should also implement `__mod__` and `quo_rem` to match this implementation of floor division.  This doesn't have to be on this ticket.



---

archive/issue_comments_353900.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-10-20T16:59:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23971#issuecomment-353900",
    "user": "https://github.com/roed314"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_353901.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:9 roed]:\n> First, the patchbot is unhappy: there's a strange merge failure on Cygwin, complaining about `CONFLICT (content): Merge conflict in src/sage/parallel/map_reduce.py`\n\n\nThat happens on every ticket, it must be a problem with that bot.",
    "created_at": "2017-10-20T17:51:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23971#issuecomment-353901",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>Replying to [comment:9 roed]:
> First, the patchbot is unhappy: there's a strange merge failure on Cygwin, complaining about `CONFLICT (content): Merge conflict in src/sage/parallel/map_reduce.py`


That happens on every ticket, it must be a problem with that bot.



---

archive/issue_comments_353902.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:9 roed]:\n> Julian suggested having `a//b` return `parent(a/b)` when b divides `a` and raise an error otherwise.\n\n\nSurely, you made a mistake somewhere in this sentence (`a//b` should not return a ring!). And I can't guess what you meant.",
    "created_at": "2017-10-20T17:53:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23971#issuecomment-353902",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>Replying to [comment:9 roed]:
> Julian suggested having `a//b` return `parent(a/b)` when b divides `a` and raise an error otherwise.


Surely, you made a mistake somewhere in this sentence (`a//b` should not return a ring!). And I can't guess what you meant.



---

archive/issue_comments_353903.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:9 roed]:\n> * Why did you choose to round to even?  It would be more consistent with `QQ` to round down.\n\n\nConsistency with `QQ` was not a goal here. I guess it could be done but then it becomes less obvious to generalize to all number field elements. You cannot just round down the first component (the `x` in `x + y sqrt(D)`) in all cases. So either we would need to round down `x` only when `y` is zero or an integer, but that seems like needless complication to me.\n\nBesides, I like the idea that `x // y` gives the closest possible order element to `x / y`.",
    "created_at": "2017-10-20T18:09:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23971#issuecomment-353903",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>Replying to [comment:9 roed]:
> * Why did you choose to round to even?  It would be more consistent with `QQ` to round down.


Consistency with `QQ` was not a goal here. I guess it could be done but then it becomes less obvious to generalize to all number field elements. You cannot just round down the first component (the `x` in `x + y sqrt(D)`) in all cases. So either we would need to round down `x` only when `y` is zero or an integer, but that seems like needless complication to me.

Besides, I like the idea that `x // y` gives the closest possible order element to `x / y`.



---

archive/issue_comments_353904.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [comment:12 jdemeyer]:\n> Replying to [comment:9 roed]:\n> > Julian suggested having `a//b` return `parent(a/b)` when b divides `a` and raise an error otherwise.\n\n> \n> Surely, you made a mistake somewhere in this sentence (`a//b` should not return a ring!). And I can't guess what you meant.\n\n\nSay `a` and `b` both have an order `R` as their parent.  I meant that `a//b` should return `R(a/b)`.",
    "created_at": "2017-10-20T20:39:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23971#issuecomment-353904",
    "user": "https://github.com/roed314"
}
```

<a id='comment:14'></a>Replying to [comment:12 jdemeyer]:
> Replying to [comment:9 roed]:
> > Julian suggested having `a//b` return `parent(a/b)` when b divides `a` and raise an error otherwise.

> 
> Surely, you made a mistake somewhere in this sentence (`a//b` should not return a ring!). And I can't guess what you meant.


Say `a` and `b` both have an order `R` as their parent.  I meant that `a//b` should return `R(a/b)`.



---

archive/issue_comments_353905.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:14 roed]:\n> Say `a` and `b` both have an order `R` as their parent.  I meant that `a//b` should return `R(a/b)`.\n\n\nOK, I see what you mean now. I guess a better approach would be: `a//b` returns either an order element `t` such that `N(a/b - t) < 1` or it raises `ArithmeticError`. That would generalize both the Euclidean division and the exact division.",
    "created_at": "2017-10-20T21:18:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23971#issuecomment-353905",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:15'></a>Replying to [comment:14 roed]:
> Say `a` and `b` both have an order `R` as their parent.  I meant that `a//b` should return `R(a/b)`.


OK, I see what you mean now. I guess a better approach would be: `a//b` returns either an order element `t` such that `N(a/b - t) < 1` or it raises `ArithmeticError`. That would generalize both the Euclidean division and the exact division.



---

archive/issue_comments_353906.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:15 jdemeyer]:\n> Replying to [comment:14 roed]:\n> > Say `a` and `b` both have an order `R` as their parent.  I meant that `a//b` should return `R(a/b)`.\n\n> \n> OK, I see what you mean now. I guess a better approach would be: `a//b` returns either an order element `t` such that `N(a/b - t) < 1` or it raises `ArithmeticError`. That would generalize both the Euclidean division and the exact division.\n\n\nAgreed: I think that's the optimal solution.  Figuring out what that `t` is in the non-imaginary quadratic case is probably beyond the scope of this ticket.",
    "created_at": "2017-10-20T21:32:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23971#issuecomment-353906",
    "user": "https://github.com/roed314"
}
```

<a id='comment:16'></a>Replying to [comment:15 jdemeyer]:
> Replying to [comment:14 roed]:
> > Say `a` and `b` both have an order `R` as their parent.  I meant that `a//b` should return `R(a/b)`.

> 
> OK, I see what you mean now. I guess a better approach would be: `a//b` returns either an order element `t` such that `N(a/b - t) < 1` or it raises `ArithmeticError`. That would generalize both the Euclidean division and the exact division.


Agreed: I think that's the optimal solution.  Figuring out what that `t` is in the non-imaginary quadratic case is probably beyond the scope of this ticket.



---

archive/issue_comments_353907.json:
```json
{
    "body": "<a id='comment:17'></a>Unfortunately, this introduces an additional complication that the order is no longer guaranteed to be maximal...",
    "created_at": "2017-10-23T09:28:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23971#issuecomment-353907",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>Unfortunately, this introduces an additional complication that the order is no longer guaranteed to be maximal...



---

archive/issue_comments_353908.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-10-23T14:00:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23971#issuecomment-353908",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_353909.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-10-23T14:06:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23971#issuecomment-353909",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_353910.json:
```json
{
    "body": "<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-10-27T07:55:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23971#issuecomment-353910",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_353911.json:
```json
{
    "body": "<a id='comment:22'></a>Sorry, I had somehow forgotten about this ticket. Some comments:\n\n* `intentially` should read `intentionally`\n* The patchbot (coverage) is unhappy about the removal of the floordiv example\n* There are some failing doctests it seems\n* Why don't we implement my original proposal as well? I.e., `a//b==R(a/b)` if `a/b in R`?",
    "created_at": "2018-05-21T17:04:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23971#issuecomment-353911",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:22'></a>Sorry, I had somehow forgotten about this ticket. Some comments:

* `intentially` should read `intentionally`
* The patchbot (coverage) is unhappy about the removal of the floordiv example
* There are some failing doctests it seems
* Why don't we implement my original proposal as well? I.e., `a//b==R(a/b)` if `a/b in R`?



---

archive/issue_comments_353912.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-05-21T17:04:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23971#issuecomment-353912",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_353913.json:
```json
{
    "body": "<a id='comment:23'></a>Replying to [comment:22 saraedum]:\n> * Why don't we implement my original proposal as well? I.e., `a//b==R(a/b)` if `a/b in R`?\n\n\nWhat do you mean **exactly**? I thought I did implement that, but it seems that you don't agree.",
    "created_at": "2018-06-12T09:41:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23971#issuecomment-353913",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:23'></a>Replying to [comment:22 saraedum]:
> * Why don't we implement my original proposal as well? I.e., `a//b==R(a/b)` if `a/b in R`?


What do you mean **exactly**? I thought I did implement that, but it seems that you don't agree.



---

archive/issue_comments_353914.json:
```json
{
    "body": "<a id='comment:24'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-06-12T12:02:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23971#issuecomment-353914",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:24'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_353915.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-06-12T12:08:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23971#issuecomment-353915",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_353916.json:
```json
{
    "body": "<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-06-19T09:17:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23971#issuecomment-353916",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_353917.json:
```json
{
    "body": "<a id='comment:27'></a>Replying to [comment:23 jdemeyer]:\n> Replying to [comment:22 saraedum]:\n> > * Why don't we implement my original proposal as well? I.e., `a//b==R(a/b)` if `a/b in R`?\n \n> \n> What do you mean **exactly**? I thought I did implement that, but it seems that you don't agree.\n\n\nThis ticket was originally not only about quadratic imaginary orders (I think you changed the scope at some point.) I think that `a//b` should always return `a/b` if that is in the original ring\u2026I really just want `a//1` not to fail.",
    "created_at": "2018-06-19T13:04:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23971#issuecomment-353917",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:27'></a>Replying to [comment:23 jdemeyer]:
> Replying to [comment:22 saraedum]:
> > * Why don't we implement my original proposal as well? I.e., `a//b==R(a/b)` if `a/b in R`?
 
> 
> What do you mean **exactly**? I thought I did implement that, but it seems that you don't agree.


This ticket was originally not only about quadratic imaginary orders (I think you changed the scope at some point.) I think that `a//b` should always return `a/b` if that is in the original ring…I really just want `a//1` not to fail.



---

archive/issue_comments_353918.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2018-07-04T16:08:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23971#issuecomment-353918",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_review to needs_info.
