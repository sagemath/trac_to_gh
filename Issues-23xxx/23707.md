# Issue 23707: More competitive and comprehensive finite dimensional algebras

archive/issues_023470.json:
```json
{
    "assignees": [],
    "body": "__Issues__\n\n- Currently, sage.algebras.finite_dimensional_algebras.finite_dimensional_algebra_element is Python.\n\n- Multiplication is implemented by\n\n```\nself.__class__(self.parent(), self._vector * other._matrix)\n```\n  which for *some* matrix implementations is not the fastest way:\n\n```\nsage: v = random_vector(GF(2),2000)\nsage: M = random_matrix(GF(2),2000,2000)\nsage: %timeit v*M\nThe slowest run took 8.27 times longer than the fastest. This could mean that an intermediate result is being cached.\n100 loops, best of 3: 4.96 ms per loop\nsage: %timeit M*v\n1000 loops, best of 3: 172 \u00b5s per loop\nsage: v = random_vector(GF(3),2000)\nsage: M = random_matrix(GF(3),2000,2000)\nsage: %timeit v*M\nThe slowest run took 37.59 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000 loops, best of 3: 1.11 ms per loop\nsage: %timeit M*v\n1000 loops, best of 3: 974 \u00b5s per loop\nsage: v = random_vector(QQ,2000)\nsage: M = random_matrix(QQ,2000,2000)\nsage: %timeit v*M\n1 loop, best of 3: 1.51 s per loop\nsage: %timeit M*v\n1 loop, best of 3: 3.32 s per loop\nsage: v = random_vector(GF(9,'x'),2000)\nsage: M = random_matrix(GF(9,'x'),2000,2000)\nsage: %timeit v*M\n1 loop, best of 3: 163 ms per loop\nsage: %timeit M*v\n1 loop, best of 3: 166 ms per loop\n```\n  (**Remark**: The timings for `GF(9,'x')` are with MeatAxe)\n\n- vector*matrix respectively matrix*vector may be a lot slower than matrix*matrix:\n\n```\nsage: M = random_matrix(GF(9,'x'),2000,2000)\nsage: v = random_matrix(GF(9,'x'),2000,1)\nsage: %timeit M*v\n10 loops, best of 3: 52.4 ms per loop\nsage: v1 = v.transpose()\nsage: %timeit v1*M\nThe slowest run took 37.36 times longer than the fastest. This could mean that an intermediate result is being cached.\n10000 loops, best of 3: 14.6 \u00b5s per loop\n```\n  The last example is 163 ms vs. 14.6 \u00b5s!!!\n\n- In my applications, I need finite dimensional path algebra quotients. The current implementation corresponds to a finite dimensional path algebra quotient where the underlying quiver has a single vertex.\n\n- Creation of an element also involves construction of its multiplication matrix. From my experience, it can be faster (in some applications) to not construct the matrix of it right away, but be lazy. E.g., when one computes Gr\u00f6bner bases, only multiplication by power products of the algebra generators are needed, and then it is faster to map the defining vector of the element repeatedly by multiplying with the matrices of the generators, instead of doing matrix by matrix multiplications.\n\n__Suggestion__\n\n1. Re-implement it in Cython\n2. Replace vector*matrix by either row*matrix or matrix*column, being flexible enough that *both* implementations are supported (because it depends on the field whether row*matrix or matrix*column is fastest).\n3. Allow using a quiver with more than one vertices.\n4. Be more lazy, i.e. do costly computations such as the construction of the multiplication matrix only when needed.\n\nCC:  @tscrim @fchapoton @videlec\n\nKeywords: **finite dimensional, algebra, quiver**\n\nBranch/Commit: **[`3cc3a27`](https://github.com/sagemath/sagetrac-mirror/commit/3cc3a2793ec3954d4b99ea234219358c7b666419)**\n\nReviewer: **Travis Scrimshaw**\n\nAuthor: **Simon King**\n\nComponent: **algebra**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/23707_\n\n",
    "closed_at": "2017-10-29T10:32:06Z",
    "created_at": "2017-08-25T07:48:37Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20algebra",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.1",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "More competitive and comprehensive finite dimensional algebras",
    "type": "issue",
    "updated_at": "2017-10-29T10:32:06Z",
    "url": "https://github.com/sagemath/sage/issues/23707",
    "user": "https://github.com/simon-king-jena"
}
```
__Issues__

- Currently, sage.algebras.finite_dimensional_algebras.finite_dimensional_algebra_element is Python.

- Multiplication is implemented by

```
self.__class__(self.parent(), self._vector * other._matrix)
```
  which for *some* matrix implementations is not the fastest way:

```
sage: v = random_vector(GF(2),2000)
sage: M = random_matrix(GF(2),2000,2000)
sage: %timeit v*M
The slowest run took 8.27 times longer than the fastest. This could mean that an intermediate result is being cached.
100 loops, best of 3: 4.96 ms per loop
sage: %timeit M*v
1000 loops, best of 3: 172 µs per loop
sage: v = random_vector(GF(3),2000)
sage: M = random_matrix(GF(3),2000,2000)
sage: %timeit v*M
The slowest run took 37.59 times longer than the fastest. This could mean that an intermediate result is being cached.
1000 loops, best of 3: 1.11 ms per loop
sage: %timeit M*v
1000 loops, best of 3: 974 µs per loop
sage: v = random_vector(QQ,2000)
sage: M = random_matrix(QQ,2000,2000)
sage: %timeit v*M
1 loop, best of 3: 1.51 s per loop
sage: %timeit M*v
1 loop, best of 3: 3.32 s per loop
sage: v = random_vector(GF(9,'x'),2000)
sage: M = random_matrix(GF(9,'x'),2000,2000)
sage: %timeit v*M
1 loop, best of 3: 163 ms per loop
sage: %timeit M*v
1 loop, best of 3: 166 ms per loop
```
  (**Remark**: The timings for `GF(9,'x')` are with MeatAxe)

- vector*matrix respectively matrix*vector may be a lot slower than matrix*matrix:

```
sage: M = random_matrix(GF(9,'x'),2000,2000)
sage: v = random_matrix(GF(9,'x'),2000,1)
sage: %timeit M*v
10 loops, best of 3: 52.4 ms per loop
sage: v1 = v.transpose()
sage: %timeit v1*M
The slowest run took 37.36 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 3: 14.6 µs per loop
```
  The last example is 163 ms vs. 14.6 µs!!!

- In my applications, I need finite dimensional path algebra quotients. The current implementation corresponds to a finite dimensional path algebra quotient where the underlying quiver has a single vertex.

- Creation of an element also involves construction of its multiplication matrix. From my experience, it can be faster (in some applications) to not construct the matrix of it right away, but be lazy. E.g., when one computes Gröbner bases, only multiplication by power products of the algebra generators are needed, and then it is faster to map the defining vector of the element repeatedly by multiplying with the matrices of the generators, instead of doing matrix by matrix multiplications.

__Suggestion__

1. Re-implement it in Cython
2. Replace vector*matrix by either row*matrix or matrix*column, being flexible enough that *both* implementations are supported (because it depends on the field whether row*matrix or matrix*column is fastest).
3. Allow using a quiver with more than one vertices.
4. Be more lazy, i.e. do costly computations such as the construction of the multiplication matrix only when needed.

CC:  @tscrim @fchapoton @videlec

Keywords: **finite dimensional, algebra, quiver**

Branch/Commit: **[`3cc3a27`](https://github.com/sagemath/sagetrac-mirror/commit/3cc3a2793ec3954d4b99ea234219358c7b666419)**

Reviewer: **Travis Scrimshaw**

Author: **Simon King**

Component: **algebra**

_Issue created by migration from https://trac.sagemath.org/ticket/23707_





---

archive/issue_events_331156.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2017-08-25T07:48:37Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "milestone_number": null,
    "milestone_title": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23707#event-331156"
}
```



---

archive/issue_events_331157.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2017-08-25T07:48:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20algebra",
    "label_color": "0000ff",
    "label_name": "c: algebra",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23707#event-331157"
}
```



---

archive/issue_events_331158.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2017-08-25T07:48:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23707#event-331158"
}
```



---

archive/issue_events_331159.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2017-08-25T07:48:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23707#event-331159"
}
```



---

archive/issue_comments_357386.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -55,8 +55,11 @@\n \n - In my applications, I need finite dimensional path algebra quotients. The current implementation corresponds to a finite dimensional path algebra quotient where the underlying quiver has a single vertex.\n \n+- Creation of an element also involves construction of its multiplication matrix. From my experience, it can be faster (in some applications) to not construct the matrix of it right away, but be lazy. E.g., when one computes Gr\u00f6bner bases, only multiplication by power products of the algebra generators are needed, and then it is faster to map the defining vector of the element repeatedly by multiplying with the matrices of the generators, instead of doing matrix by matrix multiplications.\n+\n __Suggestion__\n \n 1. Re-implement it in Cython\n 2. Replace vector*matrix by either row*matrix or matrix*column, being flexible enough that *both* implementations are supported (because it depends on the field whether row*matrix or matrix*column is fastest).\n 3. Allow using a quiver with more than one vertices.\n+4. Be more lazy, i.e. do costly computations such as the construction of the multiplication matrix only when needed.\n``````\n",
    "created_at": "2017-08-25T08:06:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357386",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -55,8 +55,11 @@
 
 - In my applications, I need finite dimensional path algebra quotients. The current implementation corresponds to a finite dimensional path algebra quotient where the underlying quiver has a single vertex.
 
+- Creation of an element also involves construction of its multiplication matrix. From my experience, it can be faster (in some applications) to not construct the matrix of it right away, but be lazy. E.g., when one computes Gröbner bases, only multiplication by power products of the algebra generators are needed, and then it is faster to map the defining vector of the element repeatedly by multiplying with the matrices of the generators, instead of doing matrix by matrix multiplications.
+
 __Suggestion__
 
 1. Re-implement it in Cython
 2. Replace vector*matrix by either row*matrix or matrix*column, being flexible enough that *both* implementations are supported (because it depends on the field whether row*matrix or matrix*column is fastest).
 3. Allow using a quiver with more than one vertices.
+4. Be more lazy, i.e. do costly computations such as the construction of the multiplication matrix only when needed.
``````




---

archive/issue_comments_357387.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nFYI: PARI/GP has recently gained functionality to deal with general finite dimensional algebras. But it seems that this ticket is mostly about basic arithmetic, so I'm not sure that it's relevant.",
    "created_at": "2017-08-25T10:32:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357387",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:2" align="right">comment:2</div>

FYI: PARI/GP has recently gained functionality to deal with general finite dimensional algebras. But it seems that this ticket is mostly about basic arithmetic, so I'm not sure that it's relevant.



---

archive/issue_comments_357388.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nReplying to [@jdemeyer](#comment:2):\n> FYI: PARI/GP has recently gained functionality to deal with general finite dimensional algebras. But it seems that this ticket is mostly about basic arithmetic, so I'm not sure that it's relevant.\n\nThis ticket is not necessarily about basic arithmetic. Eventually, I finally want to implement my F5 algorithm for modules over path algebra quotients (after being distracted by other things for several years), starting with finite dimensional quotients.\n\nSo, having an implementation of finite dimensional algebras over any field (but for me most importantly over finite not necessarily prime fields!) that is *really* competitive would be nice.\n\nCan you give me a pointer for the PARI/GP implementation? Would it be difficult to wrap in cython?",
    "created_at": "2017-08-25T10:37:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357388",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:3" align="right">comment:3</div>

Replying to [@jdemeyer](#comment:2):
> FYI: PARI/GP has recently gained functionality to deal with general finite dimensional algebras. But it seems that this ticket is mostly about basic arithmetic, so I'm not sure that it's relevant.

This ticket is not necessarily about basic arithmetic. Eventually, I finally want to implement my F5 algorithm for modules over path algebra quotients (after being distracted by other things for several years), starting with finite dimensional quotients.

So, having an implementation of finite dimensional algebras over any field (but for me most importantly over finite not necessarily prime fields!) that is *really* competitive would be nice.

Can you give me a pointer for the PARI/GP implementation? Would it be difficult to wrap in cython?



---

archive/issue_comments_357389.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nReplying to [@simon-king-jena](#comment:3):\n> So, having an implementation of finite dimensional algebras over any field (but for me most importantly over finite not necessarily prime fields!) that is *really* competitive would be nice.\n\nAn algebra over F<sub>q</sub> is just a special case of an algebra over F<sub>p</sub>. PARI/GP supports algebras over Q and over F<sub>p</sub>.\n\n> Can you give me a pointer for the PARI/GP implementation?\n\nSee https://pari.math.u-bordeaux.fr/dochtml/html-stable/ section \"Associative and central simple algebras\".\n\n> Would it be difficult to wrap in cython?\n\nI don't think so. Depending on your needs, you could also use `cypari2`.",
    "created_at": "2017-08-25T11:07:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357389",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:4" align="right">comment:4</div>

Replying to [@simon-king-jena](#comment:3):
> So, having an implementation of finite dimensional algebras over any field (but for me most importantly over finite not necessarily prime fields!) that is *really* competitive would be nice.

An algebra over F<sub>q</sub> is just a special case of an algebra over F<sub>p</sub>. PARI/GP supports algebras over Q and over F<sub>p</sub>.

> Can you give me a pointer for the PARI/GP implementation?

See https://pari.math.u-bordeaux.fr/dochtml/html-stable/ section "Associative and central simple algebras".

> Would it be difficult to wrap in cython?

I don't think so. Depending on your needs, you could also use `cypari2`.



---

archive/issue_comments_357390.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nReplying to [@jdemeyer](#comment:4):\n> Replying to [@simon-king-jena](#comment:3):\n> > So, having an implementation of finite dimensional algebras over any field (but for me most importantly over finite not necessarily prime fields!) that is *really* competitive would be nice.\n\n> \n> An algebra over F<sub>q</sub> is just a special case of an algebra over F<sub>p</sub>.\n\nI don't buy that. A matrix over F<sub>p</sub> should be the same as an algebra over F<sub>q</sub>, but the current default in sage differs totally in performance.\n\nAnyway, if you wanted to say that PARI/GP is good in *both* cases then it's fine.\n\n> See https://pari.math.u-bordeaux.fr/dochtml/html-stable/ section \"Associative and central simple algebras\".\n\nThank you!\n\n> > Would it be difficult to wrap in cython?\n\n> \n> I don't think so. Depending on your needs, you could also use `cypari2`.\n\nWhat's that?",
    "created_at": "2017-08-25T11:11:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357390",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:5" align="right">comment:5</div>

Replying to [@jdemeyer](#comment:4):
> Replying to [@simon-king-jena](#comment:3):
> > So, having an implementation of finite dimensional algebras over any field (but for me most importantly over finite not necessarily prime fields!) that is *really* competitive would be nice.

> 
> An algebra over F<sub>q</sub> is just a special case of an algebra over F<sub>p</sub>.

I don't buy that. A matrix over F<sub>p</sub> should be the same as an algebra over F<sub>q</sub>, but the current default in sage differs totally in performance.

Anyway, if you wanted to say that PARI/GP is good in *both* cases then it's fine.

> See https://pari.math.u-bordeaux.fr/dochtml/html-stable/ section "Associative and central simple algebras".

Thank you!

> > Would it be difficult to wrap in cython?

> 
> I don't think so. Depending on your needs, you could also use `cypari2`.

What's that?



---

archive/issue_comments_357391.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\n`cypari2` is a new package with what used to be `sage.libs.pari`. It is a Cython interface to PARI. It wraps PARI objects in Python objects. Using this is slower than directly calling the PARI library. On the other hand, if your computations spend most of the time in the PARI library, it wouldn't matter for performance.",
    "created_at": "2017-08-25T11:18:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357391",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:6" align="right">comment:6</div>

`cypari2` is a new package with what used to be `sage.libs.pari`. It is a Cython interface to PARI. It wraps PARI objects in Python objects. Using this is slower than directly calling the PARI library. On the other hand, if your computations spend most of the time in the PARI library, it wouldn't matter for performance.



---

archive/issue_comments_357392.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nReplying to [@jdemeyer](#comment:6):\n> `cypari2` is a new package with what used to be `sage.libs.pari`. It is a Cython interface to PARI. It wraps PARI objects in Python objects. Using this is slower than directly calling the PARI library. On the other hand, if your computations spend most of the time in the PARI library, it wouldn't matter for performance.\n\nThanks. Are algebras wrapped? If found cypari2 by googling, but a quick look seems to indicate that the conversions are about numbers, not algebras.",
    "created_at": "2017-08-25T11:20:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357392",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:7" align="right">comment:7</div>

Replying to [@jdemeyer](#comment:6):
> `cypari2` is a new package with what used to be `sage.libs.pari`. It is a Cython interface to PARI. It wraps PARI objects in Python objects. Using this is slower than directly calling the PARI library. On the other hand, if your computations spend most of the time in the PARI library, it wouldn't matter for performance.

Thanks. Are algebras wrapped? If found cypari2 by googling, but a quick look seems to indicate that the conversions are about numbers, not algebras.



---

archive/issue_comments_357393.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nHow can I do the following pari code in Sage?\n\n```\n  { m_i = [0,-1,0, 0;\n           1, 0,0, 0;\n           0, 0,0,-1;\n           0, 0,1, 0];\n    m_j = [0, 0,-1,0;\n           0, 0, 0,1;\n           1, 0, 0,0;\n           0,-1, 0,0];\n    m_k = [0, 0, 0, 0;\n           0, 0,-1, 0;\n           0, 1, 0, 0;\n           1, 0, 0,-1];\n    A = alginit(nfinit(y), [matid(4), m_i,m_j,m_k],  0); }\n```\nDefining the matrices works:\n\n```\nsage: Mi = pari(\"\"\"\n....: [0,-1,0, 0;\n....:            1, 0,0, 0;\n....:            0, 0,0,-1;\n....:            0, 0,1, 0]\"\"\")\nsage: Mj = pari(\"\"\"\n....: [0, 0,-1,0;\n....:            0, 0, 0,1;\n....:            1, 0, 0,0;\n....:            0,-1, 0,0];\"\"\")\nsage: Mk = pari(\"\"\"\n....: [0, 0, 0, 0;\n....:            0, 0,-1, 0;\n....:            0, 1, 0, 0;\n....:            1, 0, 0,-1];\"\"\")\nsage: Mj\n[0, 0, -1, 0; 0, 0, 0, 1; 1, 0, 0, 0; 0, -1, 0, 0]\nsage: Mi*Mk\n[0, 0, 1, 0; 0, 0, 0, 0; -1, 0, 0, 1; 0, 1, 0, 0]\n```\nHowever, my attempts to define the algebra failed:\n\n```\nsage: pari(\"nfinit(y)\").alginit([pari(\"matid(4)\"), Mi,Mj,Mk], 0)\n...\nPariError: incorrect priority in nffactor: variable 0 >= y\nsage: pari.alginit(pari(\"nfinit(y)\"), [pari(\"matid(4)\"), Mi,Mj,Mk], 0)\n...\nAttributeError: 'cypari2.pari_instance.Pari' object has no attribute 'alginit'\n```",
    "created_at": "2017-08-25T11:29:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357393",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:8" align="right">comment:8</div>

How can I do the following pari code in Sage?

```
  { m_i = [0,-1,0, 0;
           1, 0,0, 0;
           0, 0,0,-1;
           0, 0,1, 0];
    m_j = [0, 0,-1,0;
           0, 0, 0,1;
           1, 0, 0,0;
           0,-1, 0,0];
    m_k = [0, 0, 0, 0;
           0, 0,-1, 0;
           0, 1, 0, 0;
           1, 0, 0,-1];
    A = alginit(nfinit(y), [matid(4), m_i,m_j,m_k],  0); }
```
Defining the matrices works:

```
sage: Mi = pari("""
....: [0,-1,0, 0;
....:            1, 0,0, 0;
....:            0, 0,0,-1;
....:            0, 0,1, 0]""")
sage: Mj = pari("""
....: [0, 0,-1,0;
....:            0, 0, 0,1;
....:            1, 0, 0,0;
....:            0,-1, 0,0];""")
sage: Mk = pari("""
....: [0, 0, 0, 0;
....:            0, 0,-1, 0;
....:            0, 1, 0, 0;
....:            1, 0, 0,-1];""")
sage: Mj
[0, 0, -1, 0; 0, 0, 0, 1; 1, 0, 0, 0; 0, -1, 0, 0]
sage: Mi*Mk
[0, 0, 1, 0; 0, 0, 0, 0; -1, 0, 0, 1; 0, 1, 0, 0]
```
However, my attempts to define the algebra failed:

```
sage: pari("nfinit(y)").alginit([pari("matid(4)"), Mi,Mj,Mk], 0)
...
PariError: incorrect priority in nffactor: variable 0 >= y
sage: pari.alginit(pari("nfinit(y)"), [pari("matid(4)"), Mi,Mj,Mk], 0)
...
AttributeError: 'cypari2.pari_instance.Pari' object has no attribute 'alginit'
```



---

archive/issue_comments_357394.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nReplying to [@simon-king-jena](#comment:7):\n> Are algebras wrapped?\n\n**Everything** is wrapped. That's the nice thing about `cypari2`: it automagically wraps all GP functions (assuming that the argument types are understood; PARI functions taking functions as input are not supported for example).\n\nIt's probably not so relevant, but it's best to use #23518.\n\n> a quick look seems to indicate that the conversions are about numbers, not algebras.\n\nWell yes, it's a Python package so it only supports a limited set of conversions for standard Python types. Sage does support more conversions though. In any case, don't be blinded by the conversions, that's really just a detail. If PARI supports your algorithms, surely the conversion between Sage and PARI should be possible to implement.",
    "created_at": "2017-08-25T11:31:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357394",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:9" align="right">comment:9</div>

Replying to [@simon-king-jena](#comment:7):
> Are algebras wrapped?

**Everything** is wrapped. That's the nice thing about `cypari2`: it automagically wraps all GP functions (assuming that the argument types are understood; PARI functions taking functions as input are not supported for example).

It's probably not so relevant, but it's best to use #23518.

> a quick look seems to indicate that the conversions are about numbers, not algebras.

Well yes, it's a Python package so it only supports a limited set of conversions for standard Python types. Sage does support more conversions though. In any case, don't be blinded by the conversions, that's really just a detail. If PARI supports your algorithms, surely the conversion between Sage and PARI should be possible to implement.



---

archive/issue_comments_357395.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nUse a different variable name :-)\n\n```\nsage: pari(\"nfinit(t)\").alginit([\"matid(4)\", Mi, Mj, Mk], 0)\n```\nNote that you don't need `pari()` in the arguments of the method: the inputs are automatically converted to PARI. This means that strings are evaluated.\n\nWith #23518, you should be able to write this as\n\n```\nsage: pari.alginit(\"nfinit(t)\", [\"matid(4)\", Mi, Mj, Mk], 0)\n```\nor\n\n```\nsage: pari.alginit(pari.nfinit(\"t\"), [pari.matid(4), Mi, Mj, Mk], 0)\n```",
    "created_at": "2017-08-25T11:44:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357395",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:10" align="right">comment:10</div>

Use a different variable name :-)

```
sage: pari("nfinit(t)").alginit(["matid(4)", Mi, Mj, Mk], 0)
```
Note that you don't need `pari()` in the arguments of the method: the inputs are automatically converted to PARI. This means that strings are evaluated.

With #23518, you should be able to write this as

```
sage: pari.alginit("nfinit(t)", ["matid(4)", Mi, Mj, Mk], 0)
```
or

```
sage: pari.alginit(pari.nfinit("t"), [pari.matid(4), Mi, Mj, Mk], 0)
```



---

archive/issue_comments_357396.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nReplying to [@jdemeyer](#comment:10):\n> Use a different variable name :-)\n> \n> ```\n> sage: pari(\"nfinit(t)\").alginit([\"matid(4)\", Mi, Mj, Mk], 0)\n> ```\n\nWhy is that? `pari(\"nfinit(y)\")` by itself does work.",
    "created_at": "2017-08-25T11:46:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357396",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:11" align="right">comment:11</div>

Replying to [@jdemeyer](#comment:10):
> Use a different variable name :-)
> 
> ```
> sage: pari("nfinit(t)").alginit(["matid(4)", Mi, Mj, Mk], 0)
> ```

Why is that? `pari("nfinit(y)")` by itself does work.



---

archive/issue_comments_357397.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nWhat's wrong with this?\n\n```\nsage: M1 = random_matrix(GF(2),1024,1024)\nsage: M2 = random_matrix(GF(2),1024,1024)\nsage: A = pari(GF(2)).alginit([\"matid(1024)\", M1, M2],0)\n...\nPariError: incorrect type in alginit (t_POL)\n```\nSo, does the first argument of alginit really needs to be a number field, not a finite field?",
    "created_at": "2017-08-25T11:54:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357397",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:12" align="right">comment:12</div>

What's wrong with this?

```
sage: M1 = random_matrix(GF(2),1024,1024)
sage: M2 = random_matrix(GF(2),1024,1024)
sage: A = pari(GF(2)).alginit(["matid(1024)", M1, M2],0)
...
PariError: incorrect type in alginit (t_POL)
```
So, does the first argument of alginit really needs to be a number field, not a finite field?



---

archive/issue_comments_357398.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReading that over finite fields one uses `algtableinit`, I tried\n\n```\nsage: MT = pari([\"matid(1024)\", M1,M2])\nsage: A = MT.algtableinit(2)\n...\nPariError: incorrect type in algtableinit (t_VEC)\n```\nwhich didn't work either. Why?",
    "created_at": "2017-08-25T12:03:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357398",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:13" align="right">comment:13</div>

Reading that over finite fields one uses `algtableinit`, I tried

```
sage: MT = pari(["matid(1024)", M1,M2])
sage: A = MT.algtableinit(2)
...
PariError: incorrect type in algtableinit (t_VEC)
```
which didn't work either. Why?



---

archive/issue_comments_357399.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nThe following doesn't look promising:\n\n```\nsage: pM1 = pari(M1)\nsage: pM2 = pari(M2)\nsage: %timeit M1*M2\n1000 loops, best of 3: 1.08 ms per loop\nsage: %timeit pM1*pM2\n1 loop, best of 3: 201 ms per loop\n```",
    "created_at": "2017-08-25T12:06:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357399",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:14" align="right">comment:14</div>

The following doesn't look promising:

```
sage: pM1 = pari(M1)
sage: pM2 = pari(M2)
sage: %timeit M1*M2
1000 loops, best of 3: 1.08 ms per loop
sage: %timeit pM1*pM2
1 loop, best of 3: 201 ms per loop
```



---

archive/issue_comments_357400.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nReplying to [@simon-king-jena](#comment:13):\n> Reading that over finite fields one uses `algtableinit`, I tried\n> \n> ```\n> sage: MT = pari([\"matid(1024)\", M1,M2])\n> sage: A = MT.algtableinit(2)\n> ...\n> PariError: incorrect type in algtableinit (t_VEC)\n> ```\n> which didn't work either. Why?\n\nDon't you need a list of 1024 matrices in dimension 1024?",
    "created_at": "2017-08-25T13:55:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357400",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:15" align="right">comment:15</div>

Replying to [@simon-king-jena](#comment:13):
> Reading that over finite fields one uses `algtableinit`, I tried
> 
> ```
> sage: MT = pari(["matid(1024)", M1,M2])
> sage: A = MT.algtableinit(2)
> ...
> PariError: incorrect type in algtableinit (t_VEC)
> ```
> which didn't work either. Why?

Don't you need a list of 1024 matrices in dimension 1024?



---

archive/issue_comments_357401.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@jdemeyer](#comment:15):\n> Don't you need a list of 1024 matrices in dimension 1024?\n\nOuch, yes! Apparently I thought of constructing the algebra that is *generated* by these matrices (which I guess has dimension much larger than 1024).",
    "created_at": "2017-08-25T15:12:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357401",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@jdemeyer](#comment:15):
> Don't you need a list of 1024 matrices in dimension 1024?

Ouch, yes! Apparently I thought of constructing the algebra that is *generated* by these matrices (which I guess has dimension much larger than 1024).



---

archive/issue_comments_357402.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@jdemeyer](#comment:15):\n> Replying to [@simon-king-jena](#comment:13):\n> > Reading that over finite fields one uses `algtableinit`, I tried\n> > \n> > ```\n> > sage: MT = pari([\"matid(1024)\", M1,M2])\n> > sage: A = MT.algtableinit(2)\n> > ...\n> > PariError: incorrect type in algtableinit (t_VEC)\n> > ```\n> > which didn't work either. Why?\n\n> \n> Don't you need a list of 1024 matrices in dimension 1024?\n\nBut in any case, Pari complains about type (t_VEC), not about value. So, the number of matrices isn't the only problem.",
    "created_at": "2017-08-25T15:32:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357402",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@jdemeyer](#comment:15):
> Replying to [@simon-king-jena](#comment:13):
> > Reading that over finite fields one uses `algtableinit`, I tried
> > 
> > ```
> > sage: MT = pari(["matid(1024)", M1,M2])
> > sage: A = MT.algtableinit(2)
> > ...
> > PariError: incorrect type in algtableinit (t_VEC)
> > ```
> > which didn't work either. Why?

> 
> Don't you need a list of 1024 matrices in dimension 1024?

But in any case, Pari complains about type (t_VEC), not about value. So, the number of matrices isn't the only problem.



---

archive/issue_comments_357403.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@simon-king-jena](#comment:17):\n> But in any case, Pari complains about type (t_VEC)\n\nDon't take the PARI error messages too literally...",
    "created_at": "2017-08-25T15:39:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357403",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@simon-king-jena](#comment:17):
> But in any case, Pari complains about type (t_VEC)

Don't take the PARI error messages too literally...



---

archive/issue_comments_357404.json:
```json
{
    "body": "Branch: **[u/SimonKing/more_competitive_and_comprehensive_finite_dimensional_algebras](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/more_competitive_and_comprehensive_finite_dimensional_algebras)**",
    "created_at": "2017-08-26T16:03:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357404",
    "user": "https://github.com/simon-king-jena"
}
```

Branch: **[u/SimonKing/more_competitive_and_comprehensive_finite_dimensional_algebras](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/more_competitive_and_comprehensive_finite_dimensional_algebras)**



---

archive/issue_events_331160.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2017-08-26T16:11:27Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23707#event-331160"
}
```



---

archive/issue_comments_357405.json:
```json
{
    "body": "Commit: **[`a34ee26`](https://github.com/sagemath/sagetrac-mirror/commit/a34ee26f637a27fe561dd4e650f46b8f3db19b64)**",
    "created_at": "2017-08-26T16:11:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357405",
    "user": "https://github.com/simon-king-jena"
}
```

Commit: **[`a34ee26`](https://github.com/sagemath/sagetrac-mirror/commit/a34ee26f637a27fe561dd4e650f46b8f3db19b64)**



---

archive/issue_comments_357406.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nI think I shouldn't be overambitious in this ticket: The finite-dimensional path algebra quotient stuff should be for a later ticket, where I will probably sub-class the now cythonised finite dimensional algebra elements.\n\nChanges:\n- The element class is now in Cython.\n- The multiplication matrix of an element is now lazy, which means that initialisation of an element will be substantially faster.\n- An element is encoded by a matrix with a single row, not by a vector. As I have demonstrated, multiplying a single row matrix by a square matrix is always faster than multiplying a vector by a square matrix.\n\nCaveat: It seems to me that **OVER QQ** multiplying a square matrix with a single-column matrix is faster than multiplying a single-row matrix with a square matrix. But that's the only case where I found that behaviour. Since I am not interested in the rational case anyway, I don't plan to provide a special implementation over QQ where elements are encoded as single-column matrices rather than single-row matrices.\n\nPS: For me, tests pass...\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a34ee26f637a27fe561dd4e650f46b8f3db19b64\"><code>a34ee26</code></a></td><td><code>Faster implementation of finite dimensional algebras</code></td></tr></table>\n",
    "created_at": "2017-08-26T16:11:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357406",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:20" align="right">comment:20</div>

I think I shouldn't be overambitious in this ticket: The finite-dimensional path algebra quotient stuff should be for a later ticket, where I will probably sub-class the now cythonised finite dimensional algebra elements.

Changes:
- The element class is now in Cython.
- The multiplication matrix of an element is now lazy, which means that initialisation of an element will be substantially faster.
- An element is encoded by a matrix with a single row, not by a vector. As I have demonstrated, multiplying a single row matrix by a square matrix is always faster than multiplying a vector by a square matrix.

Caveat: It seems to me that **OVER QQ** multiplying a square matrix with a single-column matrix is faster than multiplying a single-row matrix with a square matrix. But that's the only case where I found that behaviour. Since I am not interested in the rational case anyway, I don't plan to provide a special implementation over QQ where elements are encoded as single-column matrices rather than single-row matrices.

PS: For me, tests pass...

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a34ee26f637a27fe561dd4e650f46b8f3db19b64"><code>a34ee26</code></a></td><td><code>Faster implementation of finite dimensional algebras</code></td></tr></table>




---

archive/issue_comments_357407.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nBack to pari:\n\n```\nsage: A = FiniteDimensionalAlgebra(GF(3), [Matrix([[1, 0], [0, 1]]), Matrix([[0, 1], [0, 0]])])\nsage: pari([x.matrix() for x in A.gens()]).algtabaleinit()\nTraceback (most recent call last):\n...\nPariError: incorrect type in algtableinit (t_VEC)\n```\nWhat's wrong?",
    "created_at": "2017-08-26T16:41:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357407",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:21" align="right">comment:21</div>

Back to pari:

```
sage: A = FiniteDimensionalAlgebra(GF(3), [Matrix([[1, 0], [0, 1]]), Matrix([[0, 1], [0, 0]])])
sage: pari([x.matrix() for x in A.gens()]).algtabaleinit()
Traceback (most recent call last):
...
PariError: incorrect type in algtableinit (t_VEC)
```
What's wrong?



---

archive/issue_comments_357408.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nReplying to [@simon-king-jena](#comment:21):\n> What's wrong?\n\nI don't know why, but apparently Pari doesn't accept some associative algebras that are perfectly fine in Sage, while it accept others:\n\n```\nsage: B = FiniteDimensionalAlgebra(QQ, [Matrix([[1,0,0], [0,1,0], [0,0,1]]), Matrix([[0,0,0], [1,0,1], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [1,0,1]])])\nsage: pari([x.matrix() for x in B.gens()]).algtableinit()\n[0, 0, 0, 0, 0, 0, [1, 0, 0; 0, 1, 0; 0, 0, 1], [1, 0, 0; 0, 1, 0; 0, 0, 1], [[1, 0, 0; 0, 1, 0; 0, 0, 1], [0, 0, 0; 1, 0, 1; 0, 0, 0], [0, 0, 0; 0, 0, 0; 1, 0, 1]], 0, [3, 0, 1]]\nsage: A = FiniteDimensionalAlgebra(QQ, [Matrix([[1,0,0], [0,1,0], [0,0,0]]), Matrix([[0,1,0], [0,0,0], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [0,0,1]])])\nsage: pari([x.matrix() for x in A.gens()]).algtableinit()\n---------------------------------------------------------------------------\nPariError                                 Traceback (most recent call last)\n<ipython-input-31-0e66e23e7476> in <module>()\n----> 1 pari([x.matrix() for x in A.gens()]).algtableinit()\n\ncypari2/auto_gen.pxi in cypari2.gen.Gen_auto.algtableinit()\n\ncypari2/handle_error.pyx in cypari2.handle_error._pari_err_handle()\n\nPariError: incorrect type in algtableinit (t_VEC)\n```\n\nIs there a clear reason or are associative algebras in Pari just broken?",
    "created_at": "2017-08-26T19:43:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357408",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:22" align="right">comment:22</div>

Replying to [@simon-king-jena](#comment:21):
> What's wrong?

I don't know why, but apparently Pari doesn't accept some associative algebras that are perfectly fine in Sage, while it accept others:

```
sage: B = FiniteDimensionalAlgebra(QQ, [Matrix([[1,0,0], [0,1,0], [0,0,1]]), Matrix([[0,0,0], [1,0,1], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [1,0,1]])])
sage: pari([x.matrix() for x in B.gens()]).algtableinit()
[0, 0, 0, 0, 0, 0, [1, 0, 0; 0, 1, 0; 0, 0, 1], [1, 0, 0; 0, 1, 0; 0, 0, 1], [[1, 0, 0; 0, 1, 0; 0, 0, 1], [0, 0, 0; 1, 0, 1; 0, 0, 0], [0, 0, 0; 0, 0, 0; 1, 0, 1]], 0, [3, 0, 1]]
sage: A = FiniteDimensionalAlgebra(QQ, [Matrix([[1,0,0], [0,1,0], [0,0,0]]), Matrix([[0,1,0], [0,0,0], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [0,0,1]])])
sage: pari([x.matrix() for x in A.gens()]).algtableinit()
---------------------------------------------------------------------------
PariError                                 Traceback (most recent call last)
<ipython-input-31-0e66e23e7476> in <module>()
----> 1 pari([x.matrix() for x in A.gens()]).algtableinit()

cypari2/auto_gen.pxi in cypari2.gen.Gen_auto.algtableinit()

cypari2/handle_error.pyx in cypari2.handle_error._pari_err_handle()

PariError: incorrect type in algtableinit (t_VEC)
```

Is there a clear reason or are associative algebras in Pari just broken?



---

archive/issue_comments_357409.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nStrangely, the patchbot doesn't test it (although it needs review). I'm trying to `?kick` it (I don't know if that's still needed nowadays, I learned about `?kick` a couple of years ago).",
    "created_at": "2017-08-27T11:13:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357409",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:23" align="right">comment:23</div>

Strangely, the patchbot doesn't test it (although it needs review). I'm trying to `?kick` it (I don't know if that's still needed nowadays, I learned about `?kick` a couple of years ago).



---

archive/issue_comments_357410.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nyou need to fill the Author field, otherwise it is deemed unsafe",
    "created_at": "2017-08-27T11:24:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357410",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:24" align="right">comment:24</div>

you need to fill the Author field, otherwise it is deemed unsafe



---

archive/issue_comments_357411.json:
```json
{
    "body": "Author: **Simon King**",
    "created_at": "2017-08-27T11:24:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357411",
    "user": "https://github.com/fchapoton"
}
```

Author: **Simon King**



---

archive/issue_comments_357412.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nReplying to [@fchapoton](#comment:24):\n> you need to fill the Author field, otherwise it is deemed unsafe\n\nOops, sorry! And thank you for filling it.",
    "created_at": "2017-08-27T12:22:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357412",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:25" align="right">comment:25</div>

Replying to [@fchapoton](#comment:24):
> you need to fill the Author field, otherwise it is deemed unsafe

Oops, sorry! And thank you for filling it.



---

archive/issue_comments_357413.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nThe patchbot reports a failure in `sage.geometry.polyhedron.backend_normaliz.Polyhedron_normaliz.integral_hull`. Is that related? In any case, it seems that it just changes because of a different sorting of the result (and if it does involve finite dimensional algebras, the sorting of the output would change, because sorting is now defined and is compatible with sorting of matrices).",
    "created_at": "2017-08-27T13:40:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357413",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:26" align="right">comment:26</div>

The patchbot reports a failure in `sage.geometry.polyhedron.backend_normaliz.Polyhedron_normaliz.integral_hull`. Is that related? In any case, it seems that it just changes because of a different sorting of the result (and if it does involve finite dimensional algebras, the sorting of the output would change, because sorting is now defined and is compatible with sorting of matrices).



---

archive/issue_comments_357414.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\n#23586",
    "created_at": "2017-08-27T14:46:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357414",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:27" align="right">comment:27</div>

#23586



---

archive/issue_events_331161.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2017-08-27T15:15:56Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23707#event-331161"
}
```



---

archive/issue_events_331162.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2017-08-27T15:15:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23707#event-331162"
}
```



---

archive/issue_comments_357415.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nI notice a problem: Old pickles won't unpickle.\n\nWhen I save a finite dimensional algebra element in the old version, and load it in the new version, I get\n\n```\nsage: x = load('backup.sobj')\nsage: x\n<repr(<sage.algebras.finite_dimensional_algebras.finite_dimensional_algebra_element.FiniteDimensionalAlgebra_with_category.element_class at 0x7f836819c0b8>) failed: AttributeError: 'NoneType' object has no attribute 'list'>\nsage: x._vector is None\nTrue\nsage: x.__dict__\n\n{'_default_filename': '/home/king/Sage/git/sage/backup.sobj',\n '_matrix': [0 1 0]\n [0 0 0]\n [0 0 0],\n '_vector': (0, 1, 0)}\nsage: type(x)\n<class 'sage.algebras.finite_dimensional_algebras.finite_dimensional_algebra_element.FiniteDimensionalAlgebra_with_category.element_class'>\nsage: type(x) is A.element_class\nFalse\nsage: A = FiniteDimensionalAlgebra(QQ, [Matrix([[1,0,0], [0,1,0], [0,0,0]]), Matrix([[0,1,0], [0,0,0], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [0,0,1]])])\nsage: x = A.1\nsage: type(x)\n<type 'sage.algebras.finite_dimensional_algebras.finite_dimensional_algebra_element.FiniteDimensionalAlgebraElement'>\n```\n\nSo, the old pickle gives the a python class that is derived from the new cython class and is not the same as the new element_class.\n\nHow can this be cured? There is unpickle_override, but I don't know if this helps in the current situation.",
    "created_at": "2017-08-27T15:15:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357415",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:28" align="right">comment:28</div>

I notice a problem: Old pickles won't unpickle.

When I save a finite dimensional algebra element in the old version, and load it in the new version, I get

```
sage: x = load('backup.sobj')
sage: x
<repr(<sage.algebras.finite_dimensional_algebras.finite_dimensional_algebra_element.FiniteDimensionalAlgebra_with_category.element_class at 0x7f836819c0b8>) failed: AttributeError: 'NoneType' object has no attribute 'list'>
sage: x._vector is None
True
sage: x.__dict__

{'_default_filename': '/home/king/Sage/git/sage/backup.sobj',
 '_matrix': [0 1 0]
 [0 0 0]
 [0 0 0],
 '_vector': (0, 1, 0)}
sage: type(x)
<class 'sage.algebras.finite_dimensional_algebras.finite_dimensional_algebra_element.FiniteDimensionalAlgebra_with_category.element_class'>
sage: type(x) is A.element_class
False
sage: A = FiniteDimensionalAlgebra(QQ, [Matrix([[1,0,0], [0,1,0], [0,0,0]]), Matrix([[0,1,0], [0,0,0], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [0,0,1]])])
sage: x = A.1
sage: type(x)
<type 'sage.algebras.finite_dimensional_algebras.finite_dimensional_algebra_element.FiniteDimensionalAlgebraElement'>
```

So, the old pickle gives the a python class that is derived from the new cython class and is not the same as the new element_class.

How can this be cured? There is unpickle_override, but I don't know if this helps in the current situation.



---

archive/issue_comments_357416.json:
```json
{
    "body": "Work Issues: **Old pickles**",
    "created_at": "2017-08-27T15:15:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357416",
    "user": "https://github.com/simon-king-jena"
}
```

Work Issues: **Old pickles**



---

archive/issue_comments_357417.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nWould it help to implement a `__setstate__` method that handles assignment of the old data to the new cdef public slots?",
    "created_at": "2017-08-27T15:17:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357417",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:29" align="right">comment:29</div>

Would it help to implement a `__setstate__` method that handles assignment of the old data to the new cdef public slots?



---

archive/issue_comments_357418.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nIIRC, what I've done in the past when changing a Python class to a `cdef` class is to use `register_unpickle_override`. I think something else you can do is just create an essentially dummy Python class that does nothing other than be a subclass of the Cython class.\n\nAlso, something else to be aware of is checking you are inheriting things from the category. IIRC, when Cythonizing `CombinatorialFreeModuleElement`, Nicolas did some special workup to get category inheritance to work properly (my solution was the dummy Python class).",
    "created_at": "2017-08-27T16:12:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357418",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:30" align="right">comment:30</div>

IIRC, what I've done in the past when changing a Python class to a `cdef` class is to use `register_unpickle_override`. I think something else you can do is just create an essentially dummy Python class that does nothing other than be a subclass of the Cython class.

Also, something else to be aware of is checking you are inheriting things from the category. IIRC, when Cythonizing `CombinatorialFreeModuleElement`, Nicolas did some special workup to get category inheritance to work properly (my solution was the dummy Python class).



---

archive/issue_comments_357419.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nAlso, I get similar behavior as mentioned in the ticket description for **Z** and **Q**:\n\n```\nsage: v = random_vector(R, 2000)\nsage: M = random_matrix(R, 2000)\nsage: %timeit M * v\nsage: %timeit v * M\nsage: %timeit matrix(v) * M\nsage: %timeit M * matrix(v).transpose()\nsage: vp = matrix(v)\nsage: %timeit vp * M\nsage: vp = vp.transpose()\nsage: %timeit M * vp\n```\nyields for `R = QQ`:\n\n```\n1 loop, best of 3: 3.09 s per loop\n1 loop, best of 3: 1.49 s per loop\n1 loop, best of 3: 331 ms per loop\n1 loop, best of 3: 210 ms per loop\n1 loop, best of 3: 330 ms per loop\n1 loop, best of 3: 211 ms per loop\n```\nand `R = ZZ`:\n\n```\n1 loop, best of 3: 657 ms per loop\n10 loops, best of 3: 116 ms per loop\n10 loops, best of 3: 60.1 ms per loop\n10 loops, best of 3: 32.8 ms per loop\n10 loops, best of 3: 59.6 ms per loop\n10 loops, best of 3: 32.3 ms per loop\n```\nInterestingly for `R = ZZ['x']` (with averaging 10 trials of 700x700 matrices):\n\n```\n1 loop, best of 3: 252 ms per loop\n1 loop, best of 3: 197 ms per loop\n1 loop, best of 3: 257 ms per loop\n1 loop, best of 3: 210 ms per loop\n1 loop, best of 3: 255 ms per loop\n1 loop, best of 3: 212 ms per loop\n```\n\nBasically the multiplication of (dense) `matrix * vector` (and vice versa) is using the na\u00efve algorithm and does not take advantage of specialized implementations:\n\n```python\n        cdef Py_ssize_t i\n        return sum([self.column(i, from_list=True) * v[i]\n                    for i in xrange(self._ncols)], M(0))\n```\nWhile `_matrix_times_vector_` clearly deserves specialized implementations (same for `_vector_times_matrix_`), it will take some more specialized code to improve it. The amazing thing is **Q** has a specialized implementation for `_vector_times_matrix_`, but it is not as fast as going back and forth with a matrix (flint is doing something really good)! O_o That would be a project for a separate ticket.",
    "created_at": "2017-08-27T16:58:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357419",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:31" align="right">comment:31</div>

Also, I get similar behavior as mentioned in the ticket description for **Z** and **Q**:

```
sage: v = random_vector(R, 2000)
sage: M = random_matrix(R, 2000)
sage: %timeit M * v
sage: %timeit v * M
sage: %timeit matrix(v) * M
sage: %timeit M * matrix(v).transpose()
sage: vp = matrix(v)
sage: %timeit vp * M
sage: vp = vp.transpose()
sage: %timeit M * vp
```
yields for `R = QQ`:

```
1 loop, best of 3: 3.09 s per loop
1 loop, best of 3: 1.49 s per loop
1 loop, best of 3: 331 ms per loop
1 loop, best of 3: 210 ms per loop
1 loop, best of 3: 330 ms per loop
1 loop, best of 3: 211 ms per loop
```
and `R = ZZ`:

```
1 loop, best of 3: 657 ms per loop
10 loops, best of 3: 116 ms per loop
10 loops, best of 3: 60.1 ms per loop
10 loops, best of 3: 32.8 ms per loop
10 loops, best of 3: 59.6 ms per loop
10 loops, best of 3: 32.3 ms per loop
```
Interestingly for `R = ZZ['x']` (with averaging 10 trials of 700x700 matrices):

```
1 loop, best of 3: 252 ms per loop
1 loop, best of 3: 197 ms per loop
1 loop, best of 3: 257 ms per loop
1 loop, best of 3: 210 ms per loop
1 loop, best of 3: 255 ms per loop
1 loop, best of 3: 212 ms per loop
```

Basically the multiplication of (dense) `matrix * vector` (and vice versa) is using the naïve algorithm and does not take advantage of specialized implementations:

```python
        cdef Py_ssize_t i
        return sum([self.column(i, from_list=True) * v[i]
                    for i in xrange(self._ncols)], M(0))
```
While `_matrix_times_vector_` clearly deserves specialized implementations (same for `_vector_times_matrix_`), it will take some more specialized code to improve it. The amazing thing is **Q** has a specialized implementation for `_vector_times_matrix_`, but it is not as fast as going back and forth with a matrix (flint is doing something really good)! O_o That would be a project for a separate ticket.



---

archive/issue_comments_357420.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\n`__setstate__` will work.\n\nQuestion: When unpickling, the dictionary contains an item `_default_filename`, which provides the file name of the pickle. Should I simply ignore it? I think so...\n\nI agree that the vector vs. matrix problem should be treated separately. I think currently it is best to do \"single row matrix\" times \"square matrix\".",
    "created_at": "2017-08-27T17:33:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357420",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:32" align="right">comment:32</div>

`__setstate__` will work.

Question: When unpickling, the dictionary contains an item `_default_filename`, which provides the file name of the pickle. Should I simply ignore it? I think so...

I agree that the vector vs. matrix problem should be treated separately. I think currently it is best to do "single row matrix" times "square matrix".



---

archive/issue_comments_357421.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nPS: Apart from _default_filename, should other unknown items simply be ignored? Or better raise a TypeError when an unexpected property occurs at unpickling?",
    "created_at": "2017-08-27T17:36:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357421",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:33" align="right">comment:33</div>

PS: Apart from _default_filename, should other unknown items simply be ignored? Or better raise a TypeError when an unexpected property occurs at unpickling?



---

archive/issue_comments_357422.json:
```json
{
    "body": "<div id=\"comment:34\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3c39dacc366b86533d5a555aedff73990d6a5ca4\"><code>3c39dac</code></a></td><td><code>Unpickling old f.d. algebra elements</code></td></tr></table>\n",
    "created_at": "2017-08-27T18:08:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357422",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:34"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3c39dacc366b86533d5a555aedff73990d6a5ca4"><code>3c39dac</code></a></td><td><code>Unpickling old f.d. algebra elements</code></td></tr></table>




---

archive/issue_comments_357423.json:
```json
{
    "body": "Changed commit from **[`a34ee26`](https://github.com/sagemath/sagetrac-mirror/commit/a34ee26f637a27fe561dd4e650f46b8f3db19b64)** to **[`3c39dac`](https://github.com/sagemath/sagetrac-mirror/commit/3c39dacc366b86533d5a555aedff73990d6a5ca4)**",
    "created_at": "2017-08-27T18:08:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357423",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`a34ee26`](https://github.com/sagemath/sagetrac-mirror/commit/a34ee26f637a27fe561dd4e650f46b8f3db19b64)** to **[`3c39dac`](https://github.com/sagemath/sagetrac-mirror/commit/3c39dacc366b86533d5a555aedff73990d6a5ca4)**



---

archive/issue_comments_357424.json:
```json
{
    "body": "Changed work issues from **Old pickles** to none",
    "created_at": "2017-08-27T18:12:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357424",
    "user": "https://github.com/simon-king-jena"
}
```

Changed work issues from **Old pickles** to none



---

archive/issue_events_331163.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2017-08-27T18:12:37Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23707#event-331163"
}
```



---

archive/issue_events_331164.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2017-08-27T18:12:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23707#event-331164"
}
```



---

archive/issue_comments_357425.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nThe test for the new `__setstate__` method is indirect, but I tested that indeed a pickle created with the old version correctly unpickles in the new version (but: It results in a python class derived from `FiniteDimensionalAlgebraElement`, rather than in the cython class `FiniteDimensionalAlgebraElement` itself).\n\nWhile I was at it, I introduced an unpickle function. Reasons: It is slightly faster than the previous way, and if the multiplication matrix has previously been computed then the matrix will be taken into account in the pickle (thus, avoiding a re-computation).",
    "created_at": "2017-08-27T18:12:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357425",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:35" align="right">comment:35</div>

The test for the new `__setstate__` method is indirect, but I tested that indeed a pickle created with the old version correctly unpickles in the new version (but: It results in a python class derived from `FiniteDimensionalAlgebraElement`, rather than in the cython class `FiniteDimensionalAlgebraElement` itself).

While I was at it, I introduced an unpickle function. Reasons: It is slightly faster than the previous way, and if the multiplication matrix has previously been computed then the matrix will be taken into account in the pickle (thus, avoiding a re-computation).



---

archive/issue_comments_357426.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nPS: `__setstate__` should in real applications only be invoked when unpickling old pickles. In that case, the resulting element will be a python class, thus, will have a `__dict__`. Then, the special cdef slots are filled and all remaining attributes will be put into `__dict__`.",
    "created_at": "2017-08-27T18:14:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357426",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:36" align="right">comment:36</div>

PS: `__setstate__` should in real applications only be invoked when unpickling old pickles. In that case, the resulting element will be a python class, thus, will have a `__dict__`. Then, the special cdef slots are filled and all remaining attributes will be put into `__dict__`.



---

archive/issue_comments_357427.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nAccording to the title, this ticket is about \"more competitive\" implementation. So, here are some timings. Old implementation:\n\n```\nsage: A = FiniteDimensionalAlgebra(QQ, [Matrix([[1,0,0], [0,1,0], [0,0,0]]), Matrix([[0,1,0], [0,0,0], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [0,0,1]])])\nsage: x,y,z = A.gens()\nsage: %timeit x*y\nThe slowest run took 172.77 times longer than the fastest. This could mean that an intermediate result is being cached.\n10000 loops, best of 3: 81.9 \u00b5s per loop\nsage: %timeit y+z\nThe slowest run took 8.10 times longer than the fastest. This could mean that an intermediate result is being cached.\n10000 loops, best of 3: 66.4 \u00b5s per loop\nsage: %timeit loads(dumps(x))\nThe slowest run took 15.88 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000 loops, best of 3: 348 \u00b5s per loop\n```\nNew implementation:\n\n```\nsage: A = FiniteDimensionalAlgebra(QQ, [Matrix([[1,0,0], [0,1,0], [0,0,0]]), Matrix([[0,1,0], [0,0,0], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [0,0,1]])])\nsage: x,y,z = A.gens()\nsage: %timeit x*y\nThe slowest run took 380.33 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 9.52 \u00b5s per loop\nsage: %timeit y+z\nThe slowest run took 17.05 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 5.64 \u00b5s per loop\nsage: %timeit loads(dumps(x))\nThe slowest run took 30.65 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000 loops, best of 3: 261 \u00b5s per loop\n```\nSo, I kept my promise...",
    "created_at": "2017-08-27T18:49:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357427",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:37" align="right">comment:37</div>

According to the title, this ticket is about "more competitive" implementation. So, here are some timings. Old implementation:

```
sage: A = FiniteDimensionalAlgebra(QQ, [Matrix([[1,0,0], [0,1,0], [0,0,0]]), Matrix([[0,1,0], [0,0,0], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [0,0,1]])])
sage: x,y,z = A.gens()
sage: %timeit x*y
The slowest run took 172.77 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 3: 81.9 µs per loop
sage: %timeit y+z
The slowest run took 8.10 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 3: 66.4 µs per loop
sage: %timeit loads(dumps(x))
The slowest run took 15.88 times longer than the fastest. This could mean that an intermediate result is being cached.
1000 loops, best of 3: 348 µs per loop
```
New implementation:

```
sage: A = FiniteDimensionalAlgebra(QQ, [Matrix([[1,0,0], [0,1,0], [0,0,0]]), Matrix([[0,1,0], [0,0,0], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [0,0,1]])])
sage: x,y,z = A.gens()
sage: %timeit x*y
The slowest run took 380.33 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 9.52 µs per loop
sage: %timeit y+z
The slowest run took 17.05 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 5.64 µs per loop
sage: %timeit loads(dumps(x))
The slowest run took 30.65 times longer than the fastest. This could mean that an intermediate result is being cached.
1000 loops, best of 3: 261 µs per loop
```
So, I kept my promise...



---

archive/issue_comments_357428.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nLet's consider different fields (note that I am using meataxe, for `GF(9,'x')`).\n\nOld:\n\n```\nsage: A = FiniteDimensionalAlgebra(GF(2), [Matrix([[1,0,0], [0,1,0], [0,0,0]]), Matrix([[0,1,0], [0,0,0], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [0,0,1]])])\nsage: x,y,z = A.gens()\nsage: %timeit x*y\nThe slowest run took 95.24 times longer than the fastest. This could mean that an intermediate result is being cached.\n10000 loops, best of 3: 96.3 \u00b5s per loop\nsage: %timeit y+z\n10000 loops, best of 3: 84.7 \u00b5s per loop\nsage: %timeit loads(dumps(x))\nThe slowest run took 10.92 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000 loops, best of 3: 637 \u00b5s per loop\nsage: A = FiniteDimensionalAlgebra(GF(3), [Matrix([[1,0,0], [0,1,0], [0,0,0]]), Matrix([[0,1,0], [0,0,0], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [0,0,1]])])\nsage: x,y,z = A.gens()\nsage: %timeit x*y\nThe slowest run took 153.07 times longer than the fastest. This could mean that an intermediate result is being cached.\n10000 loops, best of 3: 77 \u00b5s per loop\nsage: %timeit y+z\nThe slowest run took 5.54 times longer than the fastest. This could mean that an intermediate result is being cached.\n10000 loops, best of 3: 64.2 \u00b5s per loop\nsage: %timeit loads(dumps(x))\nThe slowest run took 26.46 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000 loops, best of 3: 375 \u00b5s per loop\nsage: A = FiniteDimensionalAlgebra(GF(9,'x'), [Matrix([[1,0,0], [0,1,0], [0,0,0]]), Matrix([[0,1,0], [0,0,0], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [0,0,1]])])\nsage: x,y,z = A.gens()\nsage: %timeit x*y\nThe slowest run took 201.31 times longer than the fastest. This could mean that an intermediate result is being cached.\n10000 loops, best of 3: 82.8 \u00b5s per loop\nsage: %timeit y+z\nThe slowest run took 6.70 times longer than the fastest. This could mean that an intermediate result is being cached.\n10000 loops, best of 3: 65.2 \u00b5s per loop\nsage: %timeit loads(dumps(x))\nThe slowest run took 13.58 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000 loops, best of 3: 513 \u00b5s per loop\n```\nNew:\n\n```\nsage: A = FiniteDimensionalAlgebra(GF(2), [Matrix([[1,0,0], [0,1,0], [0,0,0]]), Matrix([[0,1,0], [0,0,0], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [0,0,1]])])\nsage: x,y,z = A.gens()\nsage: %timeit x*y\nThe slowest run took 162.81 times longer than the fastest. This could mean that an intermediate result is being cached.\n10000 loops, best of 3: 17.9 \u00b5s per loop\nsage: %timeit y+z\nThe slowest run took 19.10 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 6.13 \u00b5s per loop\nsage: %timeit loads(dumps(x))\nThe slowest run took 21.34 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000 loops, best of 3: 553 \u00b5s per loop\nsage: A = FiniteDimensionalAlgebra(GF(3), [Matrix([[1,0,0], [0,1,0], [0,0,0]]), Matrix([[0,1,0], [0,0,0], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [0,0,1]])])\nsage: x,y,z = A.gens()\nsage: %timeit x*y\nThe slowest run took 183.38 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 13 \u00b5s per loop\nsage: %timeit y+z\nThe slowest run took 17.76 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 7.99 \u00b5s per loop\nsage: %timeit loads(dumps(x))\nThe slowest run took 7.77 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000 loops, best of 3: 270 \u00b5s per loop\nsage: A = FiniteDimensionalAlgebra(GF(9,'x'), [Matrix([[1,0,0], [0,1,0], [0,0,0]]), Matrix([[0,1,0], [0,0,0], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [0,0,1]])])\nsage: x,y,z = A.gens()\nsage: %timeit x*y\nThe slowest run took 150.55 times longer than the fastest. This could mean that an intermediate result is being cached.\n10000 loops, best of 3: 19.3 \u00b5s per loop\nsage: %timeit y+z\nThe slowest run took 16.32 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 6.92 \u00b5s per loop\nsage: %timeit loads(dumps(x))\nThe slowest run took 25.80 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000 loops, best of 3: 434 \u00b5s per loop\n```\nSo, it is consistently faster, apparently for all fields.",
    "created_at": "2017-08-27T19:30:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357428",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:38" align="right">comment:38</div>

Let's consider different fields (note that I am using meataxe, for `GF(9,'x')`).

Old:

```
sage: A = FiniteDimensionalAlgebra(GF(2), [Matrix([[1,0,0], [0,1,0], [0,0,0]]), Matrix([[0,1,0], [0,0,0], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [0,0,1]])])
sage: x,y,z = A.gens()
sage: %timeit x*y
The slowest run took 95.24 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 3: 96.3 µs per loop
sage: %timeit y+z
10000 loops, best of 3: 84.7 µs per loop
sage: %timeit loads(dumps(x))
The slowest run took 10.92 times longer than the fastest. This could mean that an intermediate result is being cached.
1000 loops, best of 3: 637 µs per loop
sage: A = FiniteDimensionalAlgebra(GF(3), [Matrix([[1,0,0], [0,1,0], [0,0,0]]), Matrix([[0,1,0], [0,0,0], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [0,0,1]])])
sage: x,y,z = A.gens()
sage: %timeit x*y
The slowest run took 153.07 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 3: 77 µs per loop
sage: %timeit y+z
The slowest run took 5.54 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 3: 64.2 µs per loop
sage: %timeit loads(dumps(x))
The slowest run took 26.46 times longer than the fastest. This could mean that an intermediate result is being cached.
1000 loops, best of 3: 375 µs per loop
sage: A = FiniteDimensionalAlgebra(GF(9,'x'), [Matrix([[1,0,0], [0,1,0], [0,0,0]]), Matrix([[0,1,0], [0,0,0], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [0,0,1]])])
sage: x,y,z = A.gens()
sage: %timeit x*y
The slowest run took 201.31 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 3: 82.8 µs per loop
sage: %timeit y+z
The slowest run took 6.70 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 3: 65.2 µs per loop
sage: %timeit loads(dumps(x))
The slowest run took 13.58 times longer than the fastest. This could mean that an intermediate result is being cached.
1000 loops, best of 3: 513 µs per loop
```
New:

```
sage: A = FiniteDimensionalAlgebra(GF(2), [Matrix([[1,0,0], [0,1,0], [0,0,0]]), Matrix([[0,1,0], [0,0,0], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [0,0,1]])])
sage: x,y,z = A.gens()
sage: %timeit x*y
The slowest run took 162.81 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 3: 17.9 µs per loop
sage: %timeit y+z
The slowest run took 19.10 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 6.13 µs per loop
sage: %timeit loads(dumps(x))
The slowest run took 21.34 times longer than the fastest. This could mean that an intermediate result is being cached.
1000 loops, best of 3: 553 µs per loop
sage: A = FiniteDimensionalAlgebra(GF(3), [Matrix([[1,0,0], [0,1,0], [0,0,0]]), Matrix([[0,1,0], [0,0,0], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [0,0,1]])])
sage: x,y,z = A.gens()
sage: %timeit x*y
The slowest run took 183.38 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 13 µs per loop
sage: %timeit y+z
The slowest run took 17.76 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 7.99 µs per loop
sage: %timeit loads(dumps(x))
The slowest run took 7.77 times longer than the fastest. This could mean that an intermediate result is being cached.
1000 loops, best of 3: 270 µs per loop
sage: A = FiniteDimensionalAlgebra(GF(9,'x'), [Matrix([[1,0,0], [0,1,0], [0,0,0]]), Matrix([[0,1,0], [0,0,0], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [0,0,1]])])
sage: x,y,z = A.gens()
sage: %timeit x*y
The slowest run took 150.55 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 3: 19.3 µs per loop
sage: %timeit y+z
The slowest run took 16.32 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 6.92 µs per loop
sage: %timeit loads(dumps(x))
The slowest run took 25.80 times longer than the fastest. This could mean that an intermediate result is being cached.
1000 loops, best of 3: 434 µs per loop
```
So, it is consistently faster, apparently for all fields.



---

archive/issue_comments_357429.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nGreat, thank you for the timings.\n\nSome things that will need to be done before positive review:\n\n- You should have a pxd file with the appropriate declarations.\n- I would get rid of the `is_vector` and just replace it with the appropriate `isinstance` test for clarity (and the compiler does not always inline `inline` functions).\n- I would not mark `unpickle_FiniteDimensionalAlgebraElement` as `inline` as it probably never will be inlined.\n- In this part of the initialization\n\n  ```diff\n  if A == elt.parent():\n      self._vector = elt._vector.base_extend(k)\n      self.__matrix = elt._matrix.base_extend(k)\n  ```\n  I think you should not compute the matrix for `elt`, but instead keep it lazy:\n\n  ```python\n  if A == elt.parent():\n     mat = (<FiniteDimensionalAlgebraElement> elt).__matrix\n     if mat is None:\n         self.__matrix = None\n     else:\n         self.__matrix = mat.base_extend(k)\n  ```\n- You should generally avoid the `matrix()` constructor as it is slower than creating the corresponding `MatrixSpace` and directly constructing the element from that (at least last time I checked). This way avoids a lot of the logic for parsing arguments that is there in `matrix()`. So you could do changes like:\n\n  ```diff\n  -self._vector = matrix(self._parent.base_ring(), 1,len(v), list(v))\n  +self._vector = MatrixSpace(self._parent.base_ring(), len(v)).one()\n  ```\n- You should add a typecast here for speed:\n\n  ```diff\n  -cdef FiniteDimensionalAlgebraElement a = ~self\n  +cdef FiniteDimensionalAlgebraElement a = <FiniteDimensionalAlgebraElement> (~self)\n  ```\n  Also, on the line below you know that `a.__matrix` is set (if invertible), so you can avoid the extra Python call.\n- Add a typecase for `other` in `_mul_`.\n- In `_matrix`, you should add a `cdef int i` (Cython makes better code with this). Actually, better to do\n\n  ```python\n  cdef int i\n  cdef tuple table = <tuple> A.table()\n  ret = sum(self._vector[0,i] * table[i] for i in xrange(A.degree()))\n  self.__matrix = matrix(A.base_ring(), ret)\n  ```\n- As Jeroen said on sage-devel, by having a `__dict__`, the class is slower than without it. I suspect there are probably better ways to deal with the unpickling than to have a `__dict__`. I can look into this if you want.",
    "created_at": "2017-08-27T21:40:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357429",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:39" align="right">comment:39</div>

Great, thank you for the timings.

Some things that will need to be done before positive review:

- You should have a pxd file with the appropriate declarations.
- I would get rid of the `is_vector` and just replace it with the appropriate `isinstance` test for clarity (and the compiler does not always inline `inline` functions).
- I would not mark `unpickle_FiniteDimensionalAlgebraElement` as `inline` as it probably never will be inlined.
- In this part of the initialization

  ```diff
  if A == elt.parent():
      self._vector = elt._vector.base_extend(k)
      self.__matrix = elt._matrix.base_extend(k)
  ```
  I think you should not compute the matrix for `elt`, but instead keep it lazy:

  ```python
  if A == elt.parent():
     mat = (<FiniteDimensionalAlgebraElement> elt).__matrix
     if mat is None:
         self.__matrix = None
     else:
         self.__matrix = mat.base_extend(k)
  ```
- You should generally avoid the `matrix()` constructor as it is slower than creating the corresponding `MatrixSpace` and directly constructing the element from that (at least last time I checked). This way avoids a lot of the logic for parsing arguments that is there in `matrix()`. So you could do changes like:

  ```diff
  -self._vector = matrix(self._parent.base_ring(), 1,len(v), list(v))
  +self._vector = MatrixSpace(self._parent.base_ring(), len(v)).one()
  ```
- You should add a typecast here for speed:

  ```diff
  -cdef FiniteDimensionalAlgebraElement a = ~self
  +cdef FiniteDimensionalAlgebraElement a = <FiniteDimensionalAlgebraElement> (~self)
  ```
  Also, on the line below you know that `a.__matrix` is set (if invertible), so you can avoid the extra Python call.
- Add a typecase for `other` in `_mul_`.
- In `_matrix`, you should add a `cdef int i` (Cython makes better code with this). Actually, better to do

  ```python
  cdef int i
  cdef tuple table = <tuple> A.table()
  ret = sum(self._vector[0,i] * table[i] for i in xrange(A.degree()))
  self.__matrix = matrix(A.base_ring(), ret)
  ```
- As Jeroen said on sage-devel, by having a `__dict__`, the class is slower than without it. I suspect there are probably better ways to deal with the unpickling than to have a `__dict__`. I can look into this if you want.



---

archive/issue_comments_357430.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nReplying to [@tscrim](#comment:39):\n> - As Jeroen said on sage-devel, by having a `__dict__`, the class is slower than without it. I suspect there are probably better ways to deal with the unpickling than to have a `__dict__`. I can look into this if you want.\n\nYou misunderstand what I was doing.\n\nWe are talking here about the `__setstate__` method, that will *only* be called when someone unpickles an old pickle of finite-dimensional algebra elements. Pickling of the new implementation relies on `__reduce__` and an unpickle function that has nothing to do with `__setstate__`.\n\nIn the old implementation, an element was an instance of an `element_class` derived from a Python class. In other words, it is a dynamic class whose base is the former Python class FiniteDimensionalAlgebraElement. Hence, when unpickling it, the class will still be a dynamic (Python) class whose base is the (now!) Cython class FiniteDimensionalAlgebraElement.\n\nTherefore, when unpickling an old pickle, we can be sure that the class *has* a `__dict__`, simply because it is a Python class! Nonetheless, just to be on the safe side, I check whether it really has a `__dict__`, and only if it has, I use it to store additional attributes that the user might have assigned to the element before pickling it.\n\nIn other words, FiniteDimensionalAlgebraElement has no `__dict__`, and we are merely talking about an attempt to recover as gracefully as possible in the unlikely event that the user has an old pickle containing additional attributes. But if that situation occurs, the class will be a derived Python class that *has* a `__dict__` -- I am not adding it.",
    "created_at": "2017-08-27T22:11:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357430",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:40" align="right">comment:40</div>

Replying to [@tscrim](#comment:39):
> - As Jeroen said on sage-devel, by having a `__dict__`, the class is slower than without it. I suspect there are probably better ways to deal with the unpickling than to have a `__dict__`. I can look into this if you want.

You misunderstand what I was doing.

We are talking here about the `__setstate__` method, that will *only* be called when someone unpickles an old pickle of finite-dimensional algebra elements. Pickling of the new implementation relies on `__reduce__` and an unpickle function that has nothing to do with `__setstate__`.

In the old implementation, an element was an instance of an `element_class` derived from a Python class. In other words, it is a dynamic class whose base is the former Python class FiniteDimensionalAlgebraElement. Hence, when unpickling it, the class will still be a dynamic (Python) class whose base is the (now!) Cython class FiniteDimensionalAlgebraElement.

Therefore, when unpickling an old pickle, we can be sure that the class *has* a `__dict__`, simply because it is a Python class! Nonetheless, just to be on the safe side, I check whether it really has a `__dict__`, and only if it has, I use it to store additional attributes that the user might have assigned to the element before pickling it.

In other words, FiniteDimensionalAlgebraElement has no `__dict__`, and we are merely talking about an attempt to recover as gracefully as possible in the unlikely event that the user has an old pickle containing additional attributes. But if that situation occurs, the class will be a derived Python class that *has* a `__dict__` -- I am not adding it.



---

archive/issue_comments_357431.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\nReplying to [@tscrim](#comment:39):\n> - You should generally avoid the `matrix()` constructor as it is slower than creating the corresponding `MatrixSpace` and directly constructing the element from that (at least last time I checked).\n\nI can confirm, although the difference isn't huge. Non-square matrix is faster with MatrixSpace:\n\n```\nsage: %timeit M = matrix(GF(7), 1,1000, range(1000))\nThe slowest run took 5.83 times longer than the fastest. This could mean that an intermediate result is being cached.\n10000 loops, best of 3: 66.3 \u00b5s per loop\nsage: %timeit M = MatrixSpace(GF(7), 1,1000)(range(1000))\nThe slowest run took 5.47 times longer than the fastest. This could mean that an intermediate result is being cached.\n10000 loops, best of 3: 56.4 \u00b5s per loop\n```\nSquare unit matrix (mind that we can not take `.one()`, as we want a mutable copy):\n\n```\nsage: %timeit M = matrix(GF(7), 1000,1000, 1)\n1000 loops, best of 3: 738 \u00b5s per loop\nsage: %timeit M = MatrixSpace(GF(7), 1000)(1)\nThe slowest run took 5.07 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000 loops, best of 3: 712 \u00b5s per loop\n```",
    "created_at": "2017-08-27T22:20:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357431",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:41" align="right">comment:41</div>

Replying to [@tscrim](#comment:39):
> - You should generally avoid the `matrix()` constructor as it is slower than creating the corresponding `MatrixSpace` and directly constructing the element from that (at least last time I checked).

I can confirm, although the difference isn't huge. Non-square matrix is faster with MatrixSpace:

```
sage: %timeit M = matrix(GF(7), 1,1000, range(1000))
The slowest run took 5.83 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 3: 66.3 µs per loop
sage: %timeit M = MatrixSpace(GF(7), 1,1000)(range(1000))
The slowest run took 5.47 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 3: 56.4 µs per loop
```
Square unit matrix (mind that we can not take `.one()`, as we want a mutable copy):

```
sage: %timeit M = matrix(GF(7), 1000,1000, 1)
1000 loops, best of 3: 738 µs per loop
sage: %timeit M = MatrixSpace(GF(7), 1000)(1)
The slowest run took 5.07 times longer than the fastest. This could mean that an intermediate result is being cached.
1000 loops, best of 3: 712 µs per loop
```



---

archive/issue_events_331165.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2017-08-28T00:50:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23707#event-331165"
}
```



---

archive/issue_events_331166.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2017-08-28T00:50:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23707#event-331166"
}
```



---

archive/issue_comments_357432.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nReplying to [@simon-king-jena](#comment:40):\n\nI see. I am not completely convinced that you want to rebuild the old class rather than the new class. The reason you may unpickle to a different parent is because of the `UniqueFactory` of `GF(p)` having the Sage version as part of the key. If you do it over, e.g., **Z**, then it ends up being two \"different\" element classes of the same parent. Now as soon as you do an operation, it goes to the new class. However, I am still willing to set a positive review since this is close enough to a pathological example and everything seems to work.\n\nI am encountering a difference because of extension classes versus regular classes:\n\n```\nsage: A = FiniteDimensionalAlgebra(ZZ, [Matrix([[1,0], [0,1]]), Matrix([[0,1], [0,0]])])\nsage: A.an_element()[0]  # TypeError - defined in the category and not inherited\n```\nSo no matter what, you currently need a Python class for the `element_class`.\n\nOne way you can add a test is take an old pickle string and then load that (which is how I am testing things).",
    "created_at": "2017-08-28T00:50:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357432",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:42" align="right">comment:42</div>

Replying to [@simon-king-jena](#comment:40):

I see. I am not completely convinced that you want to rebuild the old class rather than the new class. The reason you may unpickle to a different parent is because of the `UniqueFactory` of `GF(p)` having the Sage version as part of the key. If you do it over, e.g., **Z**, then it ends up being two "different" element classes of the same parent. Now as soon as you do an operation, it goes to the new class. However, I am still willing to set a positive review since this is close enough to a pathological example and everything seems to work.

I am encountering a difference because of extension classes versus regular classes:

```
sage: A = FiniteDimensionalAlgebra(ZZ, [Matrix([[1,0], [0,1]]), Matrix([[0,1], [0,0]])])
sage: A.an_element()[0]  # TypeError - defined in the category and not inherited
```
So no matter what, you currently need a Python class for the `element_class`.

One way you can add a test is take an old pickle string and then load that (which is how I am testing things).



---

archive/issue_comments_357433.json:
```json
{
    "body": "Reviewer: **Travis Scrimshaw**",
    "created_at": "2017-08-28T00:50:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357433",
    "user": "https://github.com/tscrim"
}
```

Reviewer: **Travis Scrimshaw**



---

archive/issue_comments_357434.json:
```json
{
    "body": "<div id=\"comment:43\" align=\"right\">comment:43</div>\n\nReplying to [@simon-king-jena](#comment:41):\n> Replying to [@tscrim](#comment:39):\n> > - You should generally avoid the `matrix()` constructor as it is slower than creating the corresponding `MatrixSpace` and directly constructing the element from that (at least last time I checked).\n\n> Square unit matrix (mind that we can not take `.one()`, as we want a mutable copy):\n\nI don't see where you need a mutable copy. Can you show me where that is? Also, `one()` does some extra checks, but the fastest way is `identity_matrix()` (all `MS(1)` does is call `MS.identity_matrix().__copy__()`).",
    "created_at": "2017-08-28T00:51:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357434",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:43" align="right">comment:43</div>

Replying to [@simon-king-jena](#comment:41):
> Replying to [@tscrim](#comment:39):
> > - You should generally avoid the `matrix()` constructor as it is slower than creating the corresponding `MatrixSpace` and directly constructing the element from that (at least last time I checked).

> Square unit matrix (mind that we can not take `.one()`, as we want a mutable copy):

I don't see where you need a mutable copy. Can you show me where that is? Also, `one()` does some extra checks, but the fastest way is `identity_matrix()` (all `MS(1)` does is call `MS.identity_matrix().__copy__()`).



---

archive/issue_comments_357435.json:
```json
{
    "body": "<div id=\"comment:44\" align=\"right\">comment:44</div>\n\nReplying to [@tscrim](#comment:43):\n> I don't see where you need a mutable copy.\n\nI thought at some point of the code matrix entries are assigned to after creation, but it seems that it is in fact not the case. In that case, one should `.zero()` and `.one()`, as it is cached.",
    "created_at": "2017-08-28T06:04:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357435",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:44" align="right">comment:44</div>

Replying to [@tscrim](#comment:43):
> I don't see where you need a mutable copy.

I thought at some point of the code matrix entries are assigned to after creation, but it seems that it is in fact not the case. In that case, one should `.zero()` and `.one()`, as it is cached.



---

archive/issue_comments_357436.json:
```json
{
    "body": "<div id=\"comment:45\" align=\"right\">comment:45</div>\n\nReplying to [@tscrim](#comment:42):\n> Replying to [@simon-king-jena](#comment:40):\n> \n> I see. I am not completely convinced that you want to rebuild the old class rather than the new class.\n\nAnd I don't see how I could change that. I'd be happy to unpickle the old dynamic class that is derived from the old Python class `FiniteDimensionalAlgebraElement` just as plain `FiniteDimensionalAlgebraElement`. There would be no problem if the old pickle would state that the class is the element class of the algebra (because that in fact *'is* `FiniteDimensionalAlgebraELement`, not just a derived class).\n\nHowever, the old pickle apparently states that the class is a dynamic class obtained from a certain class, and does not state that it is the element class of a specific parent (as it should!). Indeed, in the old version:\n\n```\nsage: A = FiniteDimensionalAlgebra(QQ, [Matrix([[1,0,0], [0,1,0], [0,0,0]]), Matrix([[0,1,0], [0,0,0], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [0,0,1]])])\nsage: x = A.1\nsage: type(A.1)._reduction\n\n(<function dynamic_class at 0x7f6a647bbc08>,\n ('FiniteDimensionalAlgebra_with_category.element_class',\n  (<class 'sage.algebras.finite_dimensional_algebras.finite_dimensional_algebra_element.FiniteDimensionalAlgebraElement'>,\n   <class 'sage.categories.category.JoinCategory.element_class'>),\n  None,\n  None,\n  None))\n```\n\nSo, how could I change that without changing the old pickle?\n\n> The reason you may unpickle to a different parent...\n\nAm I?\n \n> I am encountering a difference because of extension classes versus regular classes:\n> \n> ```\n> sage: A = FiniteDimensionalAlgebra(ZZ, [Matrix([[1,0], [0,1]]), Matrix([[0,1], [0,0]])])\n> sage: A.an_element()[0]  # TypeError - defined in the category and not inherited\n> ```\n\nThat's totally odd. By how the category framework works, all methods defined in the category should still be available for an element class that is a cython class.\n\nIs it not the case that the element class of a parent P coincides with `P.Element` if `P.Element` is a cython class (which is no the case for finite dimensional algebras, but used not to be the case in the old implementation).\n\n> So no matter what, you currently need a Python class for the `element_class`.\n\nNo. It is perfectly normal for an element class to be Cython.",
    "created_at": "2017-08-28T07:09:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357436",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:45" align="right">comment:45</div>

Replying to [@tscrim](#comment:42):
> Replying to [@simon-king-jena](#comment:40):
> 
> I see. I am not completely convinced that you want to rebuild the old class rather than the new class.

And I don't see how I could change that. I'd be happy to unpickle the old dynamic class that is derived from the old Python class `FiniteDimensionalAlgebraElement` just as plain `FiniteDimensionalAlgebraElement`. There would be no problem if the old pickle would state that the class is the element class of the algebra (because that in fact *'is* `FiniteDimensionalAlgebraELement`, not just a derived class).

However, the old pickle apparently states that the class is a dynamic class obtained from a certain class, and does not state that it is the element class of a specific parent (as it should!). Indeed, in the old version:

```
sage: A = FiniteDimensionalAlgebra(QQ, [Matrix([[1,0,0], [0,1,0], [0,0,0]]), Matrix([[0,1,0], [0,0,0], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [0,0,1]])])
sage: x = A.1
sage: type(A.1)._reduction

(<function dynamic_class at 0x7f6a647bbc08>,
 ('FiniteDimensionalAlgebra_with_category.element_class',
  (<class 'sage.algebras.finite_dimensional_algebras.finite_dimensional_algebra_element.FiniteDimensionalAlgebraElement'>,
   <class 'sage.categories.category.JoinCategory.element_class'>),
  None,
  None,
  None))
```

So, how could I change that without changing the old pickle?

> The reason you may unpickle to a different parent...

Am I?
 
> I am encountering a difference because of extension classes versus regular classes:
> 
> ```
> sage: A = FiniteDimensionalAlgebra(ZZ, [Matrix([[1,0], [0,1]]), Matrix([[0,1], [0,0]])])
> sage: A.an_element()[0]  # TypeError - defined in the category and not inherited
> ```

That's totally odd. By how the category framework works, all methods defined in the category should still be available for an element class that is a cython class.

Is it not the case that the element class of a parent P coincides with `P.Element` if `P.Element` is a cython class (which is no the case for finite dimensional algebras, but used not to be the case in the old implementation).

> So no matter what, you currently need a Python class for the `element_class`.

No. It is perfectly normal for an element class to be Cython.



---

archive/issue_comments_357437.json:
```json
{
    "body": "<div id=\"comment:46\" align=\"right\">comment:46</div>\n\nReplying to [@tscrim](#comment:39):\n> - You should generally avoid the `matrix()` constructor as it is slower than creating the corresponding `MatrixSpace` and directly constructing the element from that (at least last time I checked).\n\nFor reference:\n\n```\nsage: %timeit M = MatrixSpace(QQ,1,5)()\nThe slowest run took 15.03 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 5.06 \u00b5s per loop\nsage: %timeit M = matrix.zero(QQ,1,5)\nThe slowest run took 13.26 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 7.55 \u00b5s per loop\nsage: %timeit M = MatrixSpace(QQ,1,5).zero()\nThe slowest run took 10.71 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 12.3 \u00b5s per loop\nsage: %timeit M = matrix(QQ,1,5,0)\nThe slowest run took 15.02 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 13.2 \u00b5s per loop\nsage: %timeit M = MatrixSpace(QQ,5)(1)\nThe slowest run took 191.83 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 6.88 \u00b5s per loop\nsage: %timeit M = matrix.identity(QQ,5)\nThe slowest run took 15.86 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 7.5 \u00b5s per loop\nsage: %timeit M = MatrixSpace(QQ,5).one()\nThe slowest run took 9.16 times longer than the fastest. This could mean that an intermediate result is being cached.\n10000 loops, best of 3: 18.8 \u00b5s per loop\nsage: %timeit M = matrix(QQ,5,5,1)\nThe slowest run took 9.29 times longer than the fastest. This could mean that an intermediate result is being cached.\n10000 loops, best of 3: 14.8 \u00b5s per loop\n```\nThat's odd. `.zero()` and `.one()` are cached methods. Why are they SLOWER than constructing a matrix from scratch?",
    "created_at": "2017-08-28T13:18:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357437",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:46" align="right">comment:46</div>

Replying to [@tscrim](#comment:39):
> - You should generally avoid the `matrix()` constructor as it is slower than creating the corresponding `MatrixSpace` and directly constructing the element from that (at least last time I checked).

For reference:

```
sage: %timeit M = MatrixSpace(QQ,1,5)()
The slowest run took 15.03 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 5.06 µs per loop
sage: %timeit M = matrix.zero(QQ,1,5)
The slowest run took 13.26 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 7.55 µs per loop
sage: %timeit M = MatrixSpace(QQ,1,5).zero()
The slowest run took 10.71 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 12.3 µs per loop
sage: %timeit M = matrix(QQ,1,5,0)
The slowest run took 15.02 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 13.2 µs per loop
sage: %timeit M = MatrixSpace(QQ,5)(1)
The slowest run took 191.83 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 6.88 µs per loop
sage: %timeit M = matrix.identity(QQ,5)
The slowest run took 15.86 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 7.5 µs per loop
sage: %timeit M = MatrixSpace(QQ,5).one()
The slowest run took 9.16 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 3: 18.8 µs per loop
sage: %timeit M = matrix(QQ,5,5,1)
The slowest run took 9.29 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 3: 14.8 µs per loop
```
That's odd. `.zero()` and `.one()` are cached methods. Why are they SLOWER than constructing a matrix from scratch?



---

archive/issue_comments_357438.json:
```json
{
    "body": "Changed commit from **[`3c39dac`](https://github.com/sagemath/sagetrac-mirror/commit/3c39dacc366b86533d5a555aedff73990d6a5ca4)** to **[`b5d4357`](https://github.com/sagemath/sagetrac-mirror/commit/b5d4357f44255bcc7bd7b51d427658901f632459)**",
    "created_at": "2017-08-28T13:51:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357438",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`3c39dac`](https://github.com/sagemath/sagetrac-mirror/commit/3c39dacc366b86533d5a555aedff73990d6a5ca4)** to **[`b5d4357`](https://github.com/sagemath/sagetrac-mirror/commit/b5d4357f44255bcc7bd7b51d427658901f632459)**



---

archive/issue_comments_357439.json:
```json
{
    "body": "<div id=\"comment:47\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b5d4357f44255bcc7bd7b51d427658901f632459\"><code>b5d4357</code></a></td><td><code>Further performance tweaks in f.d. algebras</code></td></tr></table>\n",
    "created_at": "2017-08-28T13:51:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357439",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:47"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b5d4357f44255bcc7bd7b51d427658901f632459"><code>b5d4357</code></a></td><td><code>Further performance tweaks in f.d. algebras</code></td></tr></table>




---

archive/issue_comments_357440.json:
```json
{
    "body": "<div id=\"comment:48\" align=\"right\">comment:48</div>\n\nIn the new (final?) commit, I am addressing your objections as follows.\n\nReplying to [@tscrim](#comment:39):\n> Great, thank you for the timings.\n\nNew timings:\n\n```\nsage: A = FiniteDimensionalAlgebra(GF(2), [Matrix([[1,0,0], [0,1,0], [0,0,0]]), Matrix([[0,1,0], [0,0,0], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [0,0,1]])])\nsage: x,y,z = A.gens()\nsage: %timeit x*y\nThe slowest run took 138.54 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 16.6 \u00b5s per loop\nsage: %timeit y+z\nThe slowest run took 16.78 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 5.97 \u00b5s per loop\nsage: %timeit loads(dumps(x))\nThe slowest run took 9.31 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000 loops, best of 3: 509 \u00b5s per loop\nsage: A = FiniteDimensionalAlgebra(GF(3), [Matrix([[1,0,0], [0,1,0], [0,0,0]]), Matrix([[0,1,0], [0,0,0], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [0,0,1]])])\nsage: x,y,z = A.gens()\nsage: %timeit x*y\nThe slowest run took 2667.19 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 12 \u00b5s per loop\nsage: %timeit y+z\nThe slowest run took 18.26 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 6.51 \u00b5s per loop\nsage: %timeit loads(dumps(x))\nThe slowest run took 6.92 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000 loops, best of 3: 252 \u00b5s per loop\nsage: A = FiniteDimensionalAlgebra(GF(9,'x'), [Matrix([[1,0,0], [0,1,0], [0,0,0]]), Matrix([[0,1,0], [0,0,0], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [0,0,1]])])\nsage: x,y,z = A.gens()\nsage: %timeit x*y\nThe slowest run took 165.25 times longer than the fastest. This could mean that an intermediate result is being cached.\n10000 loops, best of 3: 19 \u00b5s per loop\nsage: %timeit y+z\nThe slowest run took 8.29 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 6.15 \u00b5s per loop\nsage: %timeit loads(dumps(x))\nThe slowest run took 8.84 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000 loops, best of 3: 402 \u00b5s per loop\nsage: A = FiniteDimensionalAlgebra(QQ, [Matrix([[1,0,0], [0,1,0], [0,0,0]]), Matrix([[0,1,0], [0,0,0], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [0,0,1]])])\nsage: x,y,z = A.gens()\nsage: %timeit x*y\nThe slowest run took 165.79 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 8.2 \u00b5s per loop\nsage: %timeit y+z\nThe slowest run took 15.54 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 6 \u00b5s per loop\nsage: %timeit loads(dumps(x))\nThe slowest run took 26.51 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000 loops, best of 3: 251 \u00b5s per loop                                                                                                                                                          \n```\n=> Thank you for your hints on performance! It resulted in a noticeable improvement.\n\n> - You should have a pxd file with the appropriate declarations.\n\nDone.\n\n> - I would get rid of the `is_vector` and just replace it with the appropriate `isinstance` test for clarity (and the compiler does not always inline `inline` functions).\n\nDone.\n\n> - I would not mark `unpickle_FiniteDimensionalAlgebraElement` as `inline` as it probably never will be inlined.\n\nDone.\n\n> - In this part of the initialization\n> \n>   ```diff\n>   if A == elt.parent():\n>       self._vector = elt._vector.base_extend(k)\n>       self.__matrix = elt._matrix.base_extend(k)\n>   ```\n>   I think you should not compute the matrix for `elt`, but instead keep it lazy:\n\nDone.\n\n> - You should generally avoid the `matrix()` constructor as it is slower than creating the corresponding `MatrixSpace` and directly constructing the element from that (at least last time I checked).\n\nDone.\n\n>   Also, on the line below you know that `a.__matrix` is set (if invertible), so you can avoid the extra Python call.\n\nDone.\n\n> - Add a typecase for `other` in `_mul_`.\n\nDone.\n\n> - In `_matrix`, you should add a `cdef int i` (Cython makes better code with this). Actually, better to do\n> \n>   ```python\n>   cdef int i\n>   cdef tuple table = <tuple> A.table()\n>   ret = sum(self._vector[0,i] * table[i] for i in xrange(A.degree()))\n>   self.__matrix = matrix(A.base_ring(), ret)\n>   ```\n\nDone.\n\n> - As Jeroen said on sage-devel, by having a `__dict__`, the class is slower than without it. I suspect there are probably better ways to deal with the unpickling than to have a `__dict__`.\n\nI didn't, see discussion above.\n\nAs pointed out on sage-devel, `P.element_class` should be pickled by construction and not by constituents. That's a bug in the category framework that will generally be a problem when a former python element class becomes a cython element class. So, that's for a different ticket.\n\nSomething else: All tests pass `:-)`",
    "created_at": "2017-08-28T13:59:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357440",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:48" align="right">comment:48</div>

In the new (final?) commit, I am addressing your objections as follows.

Replying to [@tscrim](#comment:39):
> Great, thank you for the timings.

New timings:

```
sage: A = FiniteDimensionalAlgebra(GF(2), [Matrix([[1,0,0], [0,1,0], [0,0,0]]), Matrix([[0,1,0], [0,0,0], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [0,0,1]])])
sage: x,y,z = A.gens()
sage: %timeit x*y
The slowest run took 138.54 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 16.6 µs per loop
sage: %timeit y+z
The slowest run took 16.78 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 5.97 µs per loop
sage: %timeit loads(dumps(x))
The slowest run took 9.31 times longer than the fastest. This could mean that an intermediate result is being cached.
1000 loops, best of 3: 509 µs per loop
sage: A = FiniteDimensionalAlgebra(GF(3), [Matrix([[1,0,0], [0,1,0], [0,0,0]]), Matrix([[0,1,0], [0,0,0], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [0,0,1]])])
sage: x,y,z = A.gens()
sage: %timeit x*y
The slowest run took 2667.19 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 12 µs per loop
sage: %timeit y+z
The slowest run took 18.26 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 6.51 µs per loop
sage: %timeit loads(dumps(x))
The slowest run took 6.92 times longer than the fastest. This could mean that an intermediate result is being cached.
1000 loops, best of 3: 252 µs per loop
sage: A = FiniteDimensionalAlgebra(GF(9,'x'), [Matrix([[1,0,0], [0,1,0], [0,0,0]]), Matrix([[0,1,0], [0,0,0], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [0,0,1]])])
sage: x,y,z = A.gens()
sage: %timeit x*y
The slowest run took 165.25 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 3: 19 µs per loop
sage: %timeit y+z
The slowest run took 8.29 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 6.15 µs per loop
sage: %timeit loads(dumps(x))
The slowest run took 8.84 times longer than the fastest. This could mean that an intermediate result is being cached.
1000 loops, best of 3: 402 µs per loop
sage: A = FiniteDimensionalAlgebra(QQ, [Matrix([[1,0,0], [0,1,0], [0,0,0]]), Matrix([[0,1,0], [0,0,0], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [0,0,1]])])
sage: x,y,z = A.gens()
sage: %timeit x*y
The slowest run took 165.79 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 8.2 µs per loop
sage: %timeit y+z
The slowest run took 15.54 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 6 µs per loop
sage: %timeit loads(dumps(x))
The slowest run took 26.51 times longer than the fastest. This could mean that an intermediate result is being cached.
1000 loops, best of 3: 251 µs per loop                                                                                                                                                          
```
=> Thank you for your hints on performance! It resulted in a noticeable improvement.

> - You should have a pxd file with the appropriate declarations.

Done.

> - I would get rid of the `is_vector` and just replace it with the appropriate `isinstance` test for clarity (and the compiler does not always inline `inline` functions).

Done.

> - I would not mark `unpickle_FiniteDimensionalAlgebraElement` as `inline` as it probably never will be inlined.

Done.

> - In this part of the initialization
> 
>   ```diff
>   if A == elt.parent():
>       self._vector = elt._vector.base_extend(k)
>       self.__matrix = elt._matrix.base_extend(k)
>   ```
>   I think you should not compute the matrix for `elt`, but instead keep it lazy:

Done.

> - You should generally avoid the `matrix()` constructor as it is slower than creating the corresponding `MatrixSpace` and directly constructing the element from that (at least last time I checked).

Done.

>   Also, on the line below you know that `a.__matrix` is set (if invertible), so you can avoid the extra Python call.

Done.

> - Add a typecase for `other` in `_mul_`.

Done.

> - In `_matrix`, you should add a `cdef int i` (Cython makes better code with this). Actually, better to do
> 
>   ```python
>   cdef int i
>   cdef tuple table = <tuple> A.table()
>   ret = sum(self._vector[0,i] * table[i] for i in xrange(A.degree()))
>   self.__matrix = matrix(A.base_ring(), ret)
>   ```

Done.

> - As Jeroen said on sage-devel, by having a `__dict__`, the class is slower than without it. I suspect there are probably better ways to deal with the unpickling than to have a `__dict__`.

I didn't, see discussion above.

As pointed out on sage-devel, `P.element_class` should be pickled by construction and not by constituents. That's a bug in the category framework that will generally be a problem when a former python element class becomes a cython element class. So, that's for a different ticket.

Something else: All tests pass `:-)`



---

archive/issue_events_331167.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2017-08-28T13:59:47Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23707#event-331167"
}
```



---

archive/issue_events_331168.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2017-08-28T13:59:47Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23707#event-331168"
}
```



---

archive/issue_comments_357441.json:
```json
{
    "body": "<div id=\"comment:50\" align=\"right\">comment:50</div>\n\nReplying to [@simon-king-jena](#comment:45):\n> Replying to [@tscrim](#comment:42):\n> > Replying to [@simon-king-jena](#comment:40):\n> > \n> > I see. I am not completely convinced that you want to rebuild the old class rather than the new class.\n\n> \n> And I don't see how I could change that. I'd be happy to unpickle the old dynamic class that is derived from the old Python class `FiniteDimensionalAlgebraElement` just as plain `FiniteDimensionalAlgebraElement`. There would be no problem if the old pickle would state that the class is the element class of the algebra (because that in fact **is** `FiniteDimensionalAlgebraELement`, not just a derived class).\n\nUgg...the pickle is much more fugly than I was thinking. So it will be what it will be. At least, I don't see a way we can get around it either.\n\n> So, how could I change that without changing the old pickle?\n> \n> > The reason you may unpickle to a different parent...\n\n> \n> Am I?\n\nYou specifically, no. IMO, it is a shortcoming of `UniqueFactory` (which is used for the `GF(p)` constructor).\n\n> > I am encountering a difference because of extension classes versus regular classes:\n> > \n> > ```\n> > sage: A = FiniteDimensionalAlgebra(ZZ, [Matrix([[1,0], [0,1]]), Matrix([[0,1], [0,0]])])\n> > sage: A.an_element()[0]  # TypeError - defined in the category and not inherited\n> > ```\n\n> \n> That's totally odd. By how the category framework works, all methods defined in the category should still be available for an element class that is a cython class.\n\nHowever, these are special Python methods and behave different than normal methods. I ran into this same problem on #22632 (I say `_mul_`, but it really comes from the lack of the `__mul__` IIRC), and this was the only way I could work around it. I'm not sure if #23435 would actually be a proper fix for this or not.\n \n> Is it not the case that the element class of a parent P coincides with `P.Element` if `P.Element` is a cython class (which is no the case for finite dimensional algebras, but used not to be the case in the old implementation).\n\n>\n> > So no matter what, you currently need a Python class for the `element_class`.\n> \n>No. It is perfectly normal for an element class to be Cython.\n\nHowever, it is the most straightforward way to get special methods implemented in the category to work while still retaining the Cythonization.",
    "created_at": "2017-08-28T15:00:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357441",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:50" align="right">comment:50</div>

Replying to [@simon-king-jena](#comment:45):
> Replying to [@tscrim](#comment:42):
> > Replying to [@simon-king-jena](#comment:40):
> > 
> > I see. I am not completely convinced that you want to rebuild the old class rather than the new class.

> 
> And I don't see how I could change that. I'd be happy to unpickle the old dynamic class that is derived from the old Python class `FiniteDimensionalAlgebraElement` just as plain `FiniteDimensionalAlgebraElement`. There would be no problem if the old pickle would state that the class is the element class of the algebra (because that in fact **is** `FiniteDimensionalAlgebraELement`, not just a derived class).

Ugg...the pickle is much more fugly than I was thinking. So it will be what it will be. At least, I don't see a way we can get around it either.

> So, how could I change that without changing the old pickle?
> 
> > The reason you may unpickle to a different parent...

> 
> Am I?

You specifically, no. IMO, it is a shortcoming of `UniqueFactory` (which is used for the `GF(p)` constructor).

> > I am encountering a difference because of extension classes versus regular classes:
> > 
> > ```
> > sage: A = FiniteDimensionalAlgebra(ZZ, [Matrix([[1,0], [0,1]]), Matrix([[0,1], [0,0]])])
> > sage: A.an_element()[0]  # TypeError - defined in the category and not inherited
> > ```

> 
> That's totally odd. By how the category framework works, all methods defined in the category should still be available for an element class that is a cython class.

However, these are special Python methods and behave different than normal methods. I ran into this same problem on #22632 (I say `_mul_`, but it really comes from the lack of the `__mul__` IIRC), and this was the only way I could work around it. I'm not sure if #23435 would actually be a proper fix for this or not.
 
> Is it not the case that the element class of a parent P coincides with `P.Element` if `P.Element` is a cython class (which is no the case for finite dimensional algebras, but used not to be the case in the old implementation).

>
> > So no matter what, you currently need a Python class for the `element_class`.
> 
>No. It is perfectly normal for an element class to be Cython.

However, it is the most straightforward way to get special methods implemented in the category to work while still retaining the Cythonization.



---

archive/issue_comments_357442.json:
```json
{
    "body": "<div id=\"comment:51\" align=\"right\">comment:51</div>\n\nIt is a backwards incompatible change in output of `vector()` returning a matrix instead of a vector. You should change `vector()` to return `self._vector[0]` (and maybe add a quick comment there to say `self._vector` is now a `1xn` matrix).",
    "created_at": "2017-08-28T15:04:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357442",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:51" align="right">comment:51</div>

It is a backwards incompatible change in output of `vector()` returning a matrix instead of a vector. You should change `vector()` to return `self._vector[0]` (and maybe add a quick comment there to say `self._vector` is now a `1xn` matrix).



---

archive/issue_comments_357443.json:
```json
{
    "body": "<div id=\"comment:52\" align=\"right\">comment:52</div>\n\nReplying to [@simon-king-jena](#comment:46):\n> That's odd. `.zero()` and `.one()` are cached methods. Why are they SLOWER than constructing a matrix from scratch?\n\nYou are not really constructing a matrix from scratch but instead doing a copy. However, what is really strange is this:\n\n```\nsage: MS = MatrixSpace(QQ, 2)\nsage: %timeit MS.one()\nThe slowest run took 9.92 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 5.36 \u00b5s per loop\nsage: %timeit MS.identity_matrix()\nThe slowest run took 47.13 times longer than the fastest. This could mean that an intermediate result is being cached.\n10000000 loops, best of 3: 60.7 ns per loop\nsage: MS.one == MS.identity_matrix\nTrue\nsage: MS.one is MS.identity_matrix\nTrue\n```\nI guess that is coming from the alias and `@cached_method` not as well-behaved with aliases. However, that is a huge difference (and something I will need to remember).",
    "created_at": "2017-08-28T15:23:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357443",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:52" align="right">comment:52</div>

Replying to [@simon-king-jena](#comment:46):
> That's odd. `.zero()` and `.one()` are cached methods. Why are they SLOWER than constructing a matrix from scratch?

You are not really constructing a matrix from scratch but instead doing a copy. However, what is really strange is this:

```
sage: MS = MatrixSpace(QQ, 2)
sage: %timeit MS.one()
The slowest run took 9.92 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 5.36 µs per loop
sage: %timeit MS.identity_matrix()
The slowest run took 47.13 times longer than the fastest. This could mean that an intermediate result is being cached.
10000000 loops, best of 3: 60.7 ns per loop
sage: MS.one == MS.identity_matrix
True
sage: MS.one is MS.identity_matrix
True
```
I guess that is coming from the alias and `@cached_method` not as well-behaved with aliases. However, that is a huge difference (and something I will need to remember).



---

archive/issue_comments_357444.json:
```json
{
    "body": "<div id=\"comment:53\" align=\"right\">comment:53</div>\n\nReplying to [@tscrim](#comment:42):\n> I am encountering a difference because of extension classes versus regular classes:\n> \n> ```\n> sage: A = FiniteDimensionalAlgebra(ZZ, [Matrix([[1,0], [0,1]]), Matrix([[0,1], [0,0]])])\n> sage: A.an_element()[0]  # TypeError - defined in the category and not inherited\n> ```\n\nGeneral request: when posting this kind of stuff on Trac, **please do include the tracebacks**. Right now, in order to follow this discussion, I would have to compile this branch just to see what kind of error you are talking about. Not fun!",
    "created_at": "2017-08-28T15:25:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357444",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:53" align="right">comment:53</div>

Replying to [@tscrim](#comment:42):
> I am encountering a difference because of extension classes versus regular classes:
> 
> ```
> sage: A = FiniteDimensionalAlgebra(ZZ, [Matrix([[1,0], [0,1]]), Matrix([[0,1], [0,0]])])
> sage: A.an_element()[0]  # TypeError - defined in the category and not inherited
> ```

General request: when posting this kind of stuff on Trac, **please do include the tracebacks**. Right now, in order to follow this discussion, I would have to compile this branch just to see what kind of error you are talking about. Not fun!



---

archive/issue_comments_357445.json:
```json
{
    "body": "<div id=\"comment:54\" align=\"right\">comment:54</div>\n\nReplying to [@tscrim](#comment:50):\n> I'm not sure if #23435 would actually be a proper fix for this or not.\n\nI don't think that #23435 would really fix anything regarding this.",
    "created_at": "2017-08-28T15:28:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357445",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:54" align="right">comment:54</div>

Replying to [@tscrim](#comment:50):
> I'm not sure if #23435 would actually be a proper fix for this or not.

I don't think that #23435 would really fix anything regarding this.



---

archive/issue_comments_357446.json:
```json
{
    "body": "<div id=\"comment:55\" align=\"right\">comment:55</div>\n\nReplying to [@jdemeyer](#comment:53):\n> Replying to [@tscrim](#comment:42):\n> > I am encountering a difference because of extension classes versus regular classes:\n> > \n> > ```\n> > sage: A = FiniteDimensionalAlgebra(ZZ, [Matrix([[1,0], [0,1]]), Matrix([[0,1], [0,0]])])\n> > sage: A.an_element()[0]  # TypeError - defined in the category and not inherited\n> > ```\n\n> \n> General request: when posting this kind of stuff on Trac, **please do include the tracebacks**. Right now, in order to follow this discussion, I would have to compile this branch just to see what kind of error you are talking about. Not fun!\n\nThere is no (functional) traceback:\n\n```\nsage: A.an_element()[0]\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-11-26af788a2600> in <module>()\n----> 1 A.an_element()[Integer(0)]\n\nTypeError: 'sage.algebras.finite_dimensional_algebras.finite_dimensional_algebra_element.FiniteDimensionalAlgebraElement' object has no attribute '__getitem__'\n```",
    "created_at": "2017-08-28T15:32:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357446",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:55" align="right">comment:55</div>

Replying to [@jdemeyer](#comment:53):
> Replying to [@tscrim](#comment:42):
> > I am encountering a difference because of extension classes versus regular classes:
> > 
> > ```
> > sage: A = FiniteDimensionalAlgebra(ZZ, [Matrix([[1,0], [0,1]]), Matrix([[0,1], [0,0]])])
> > sage: A.an_element()[0]  # TypeError - defined in the category and not inherited
> > ```

> 
> General request: when posting this kind of stuff on Trac, **please do include the tracebacks**. Right now, in order to follow this discussion, I would have to compile this branch just to see what kind of error you are talking about. Not fun!

There is no (functional) traceback:

```
sage: A.an_element()[0]
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-11-26af788a2600> in <module>()
----> 1 A.an_element()[Integer(0)]

TypeError: 'sage.algebras.finite_dimensional_algebras.finite_dimensional_algebra_element.FiniteDimensionalAlgebraElement' object has no attribute '__getitem__'
```



---

archive/issue_comments_357447.json:
```json
{
    "body": "Changed commit from **[`b5d4357`](https://github.com/sagemath/sagetrac-mirror/commit/b5d4357f44255bcc7bd7b51d427658901f632459)** to **[`0a88fb4`](https://github.com/sagemath/sagetrac-mirror/commit/0a88fb45c917f6523f8fe4bff2ca75a81261a68a)**",
    "created_at": "2017-08-28T15:35:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357447",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`b5d4357`](https://github.com/sagemath/sagetrac-mirror/commit/b5d4357f44255bcc7bd7b51d427658901f632459)** to **[`0a88fb4`](https://github.com/sagemath/sagetrac-mirror/commit/0a88fb45c917f6523f8fe4bff2ca75a81261a68a)**



---

archive/issue_comments_357448.json:
```json
{
    "body": "<div id=\"comment:56\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0a88fb45c917f6523f8fe4bff2ca75a81261a68a\"><code>0a88fb4</code></a></td><td><code>Avoid incompatible change in FiniteDimensionalAlgebraElement.vector()</code></td></tr></table>\n",
    "created_at": "2017-08-28T15:35:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357448",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:56"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0a88fb45c917f6523f8fe4bff2ca75a81261a68a"><code>0a88fb4</code></a></td><td><code>Avoid incompatible change in FiniteDimensionalAlgebraElement.vector()</code></td></tr></table>




---

archive/issue_comments_357449.json:
```json
{
    "body": "<div id=\"comment:57\" align=\"right\">comment:57</div>\n\nReplying to [@tscrim](#comment:55):\n> There is no (functional) traceback:\n\nWell, the error message makes sense. Now I know that it's about `__getitem__`.",
    "created_at": "2017-08-28T15:36:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357449",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:57" align="right">comment:57</div>

Replying to [@tscrim](#comment:55):
> There is no (functional) traceback:

Well, the error message makes sense. Now I know that it's about `__getitem__`.



---

archive/issue_comments_357450.json:
```json
{
    "body": "<div id=\"comment:58\" align=\"right\">comment:58</div>\n\nThe latest commit reverts the backwards incompatible change in `.vector()`.",
    "created_at": "2017-08-28T15:36:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357450",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:58" align="right">comment:58</div>

The latest commit reverts the backwards incompatible change in `.vector()`.



---

archive/issue_comments_357451.json:
```json
{
    "body": "<div id=\"comment:59\" align=\"right\">comment:59</div>\n\nReplying to [@tscrim](#comment:52):\n> You are not really constructing a matrix from scratch but instead doing a copy. However, what is really strange is this:\n\nThe difference is this:\n\n```\nsage: MS = MatrixSpace(QQ, 2)\nsage: MS.__dict__\n\n{'_MatrixSpace__is_sparse': False,\n '_MatrixSpace__matrix_class': <type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense'>,\n '_MatrixSpace__ncols': 2,\n '_MatrixSpace__nrows': 2,\n '_implementation': 'flint',\n '_reduction': (<class 'sage.matrix.matrix_space.MatrixSpace'>,\n  (Rational Field, 2, 2, False, 'flint'),\n  {}),\n 'identity_matrix': Cached version of <function identity_matrix at 0x7f1014913b90>}\n```\n\n`identity_matrix` is an attribute on the object `MS`, while `one` is an attribute on `type(MS)`.\n\nI recently created `getattr_debug` which is really useful in situations like this:\n\n```\nsage: MS = MatrixSpace(QQ, 2)\nsage: getattr_debug(MS, \"one\")\ngetattr_debug(obj=Full MatrixSpace of 2 by 2 dense matrices over ~~~, name='one'):\n  type(obj) = <class 'sage.matrix.matrix_space.MatrixSpace_with_category'>\n  object has __dict__ slot (<type 'dict'>)\n  found 'one' in dict of <class 'sage.matrix.matrix_space.MatrixSpace'>\n  got <sage.misc.cachefunc.CachedMethod object at 0x7~~~ (<type 'sage.misc.cachefunc.CachedMethod'>)\n  attribute is ordinary descriptor (has __get__)\n  object __dict__ does not have 'one'\n  calling __get__()\n  returning Cached version of <function identity_matrix at ~~~ (<type 'sage.misc.cachefunc.CachedMethodCallerNoArgs'>)\nCached version of <function identity_matrix at 0x7f1014913b90>\nsage: getattr_debug(MS, \"identity_matrix\")\ngetattr_debug(obj=Full MatrixSpace of 2 by 2 dense matrices over ~~~, name='identity_matrix'):\n  type(obj) = <class 'sage.matrix.matrix_space.MatrixSpace_with_category'>\n  object has __dict__ slot (<type 'dict'>)\n  found 'identity_matrix' in dict of <class 'sage.matrix.matrix_space.MatrixSpace'>\n  got <sage.misc.cachefunc.CachedMethod object at 0x7~~~ (<type 'sage.misc.cachefunc.CachedMethod'>)\n  attribute is ordinary descriptor (has __get__)\n  found 'identity_matrix' in object __dict__\n  returning Cached version of <function identity_matrix at ~~~ (<type 'sage.misc.cachefunc.CachedMethodCallerNoArgs'>)\nCached version of <function identity_matrix at 0x7f1014913b90>\n```",
    "created_at": "2017-08-28T15:40:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357451",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:59" align="right">comment:59</div>

Replying to [@tscrim](#comment:52):
> You are not really constructing a matrix from scratch but instead doing a copy. However, what is really strange is this:

The difference is this:

```
sage: MS = MatrixSpace(QQ, 2)
sage: MS.__dict__

{'_MatrixSpace__is_sparse': False,
 '_MatrixSpace__matrix_class': <type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense'>,
 '_MatrixSpace__ncols': 2,
 '_MatrixSpace__nrows': 2,
 '_implementation': 'flint',
 '_reduction': (<class 'sage.matrix.matrix_space.MatrixSpace'>,
  (Rational Field, 2, 2, False, 'flint'),
  {}),
 'identity_matrix': Cached version of <function identity_matrix at 0x7f1014913b90>}
```

`identity_matrix` is an attribute on the object `MS`, while `one` is an attribute on `type(MS)`.

I recently created `getattr_debug` which is really useful in situations like this:

```
sage: MS = MatrixSpace(QQ, 2)
sage: getattr_debug(MS, "one")
getattr_debug(obj=Full MatrixSpace of 2 by 2 dense matrices over ~~~, name='one'):
  type(obj) = <class 'sage.matrix.matrix_space.MatrixSpace_with_category'>
  object has __dict__ slot (<type 'dict'>)
  found 'one' in dict of <class 'sage.matrix.matrix_space.MatrixSpace'>
  got <sage.misc.cachefunc.CachedMethod object at 0x7~~~ (<type 'sage.misc.cachefunc.CachedMethod'>)
  attribute is ordinary descriptor (has __get__)
  object __dict__ does not have 'one'
  calling __get__()
  returning Cached version of <function identity_matrix at ~~~ (<type 'sage.misc.cachefunc.CachedMethodCallerNoArgs'>)
Cached version of <function identity_matrix at 0x7f1014913b90>
sage: getattr_debug(MS, "identity_matrix")
getattr_debug(obj=Full MatrixSpace of 2 by 2 dense matrices over ~~~, name='identity_matrix'):
  type(obj) = <class 'sage.matrix.matrix_space.MatrixSpace_with_category'>
  object has __dict__ slot (<type 'dict'>)
  found 'identity_matrix' in dict of <class 'sage.matrix.matrix_space.MatrixSpace'>
  got <sage.misc.cachefunc.CachedMethod object at 0x7~~~ (<type 'sage.misc.cachefunc.CachedMethod'>)
  attribute is ordinary descriptor (has __get__)
  found 'identity_matrix' in object __dict__
  returning Cached version of <function identity_matrix at ~~~ (<type 'sage.misc.cachefunc.CachedMethodCallerNoArgs'>)
Cached version of <function identity_matrix at 0x7f1014913b90>
```



---

archive/issue_comments_357452.json:
```json
{
    "body": "<div id=\"comment:60\" align=\"right\">comment:60</div>\n\nReplying to [@simon-king-jena](#comment:58):\n> The latest commit reverts the backwards incompatible change in `.vector()`.\n\nThanks. I think because it is an implementation detail, it should be a proper code comment rather than a docstring note.\n\nThe only issue now is the `__getitem__`.",
    "created_at": "2017-08-28T15:47:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357452",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:60" align="right">comment:60</div>

Replying to [@simon-king-jena](#comment:58):
> The latest commit reverts the backwards incompatible change in `.vector()`.

Thanks. I think because it is an implementation detail, it should be a proper code comment rather than a docstring note.

The only issue now is the `__getitem__`.



---

archive/issue_comments_357453.json:
```json
{
    "body": "<div id=\"comment:61\" align=\"right\">comment:61</div>\n\nReplying to [@tscrim](#comment:60):\n> Replying to [@simon-king-jena](#comment:58):\n> > The latest commit reverts the backwards incompatible change in `.vector()`.\n\n> \n> Thanks. I think because it is an implementation detail, it should be a proper code comment rather than a docstring note.\n\nShall I change it?\n\n> The only issue now is the `__getitem__`.\n\nOK, I'll provide a `__getitem__` that mimics what used to be inherited from the category.",
    "created_at": "2017-08-28T15:49:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357453",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:61" align="right">comment:61</div>

Replying to [@tscrim](#comment:60):
> Replying to [@simon-king-jena](#comment:58):
> > The latest commit reverts the backwards incompatible change in `.vector()`.

> 
> Thanks. I think because it is an implementation detail, it should be a proper code comment rather than a docstring note.

Shall I change it?

> The only issue now is the `__getitem__`.

OK, I'll provide a `__getitem__` that mimics what used to be inherited from the category.



---

archive/issue_comments_357454.json:
```json
{
    "body": "Changed commit from **[`0a88fb4`](https://github.com/sagemath/sagetrac-mirror/commit/0a88fb45c917f6523f8fe4bff2ca75a81261a68a)** to **[`8afaa05`](https://github.com/sagemath/sagetrac-mirror/commit/8afaa0578da760358f799943e497eb2163b01a12)**",
    "created_at": "2017-08-28T15:56:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357454",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`0a88fb4`](https://github.com/sagemath/sagetrac-mirror/commit/0a88fb45c917f6523f8fe4bff2ca75a81261a68a)** to **[`8afaa05`](https://github.com/sagemath/sagetrac-mirror/commit/8afaa0578da760358f799943e497eb2163b01a12)**



---

archive/issue_comments_357455.json:
```json
{
    "body": "<div id=\"comment:62\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8afaa0578da760358f799943e497eb2163b01a12\"><code>8afaa05</code></a></td><td><code>FiniteDimensionalAlgebraElement.__getitem__ replacing the category inherited method</code></td></tr></table>\n",
    "created_at": "2017-08-28T15:56:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357455",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:62"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8afaa0578da760358f799943e497eb2163b01a12"><code>8afaa05</code></a></td><td><code>FiniteDimensionalAlgebraElement.__getitem__ replacing the category inherited method</code></td></tr></table>




---

archive/issue_comments_357456.json:
```json
{
    "body": "<div id=\"comment:63\" align=\"right\">comment:63</div>\n\nReplying to [@simon-king-jena](#comment:61):\n> Replying to [@tscrim](#comment:60):\n> > Thanks. I think because it is an implementation detail, it should be a proper code comment rather than a docstring note.\n\n> \n> Shall I change it?\n\nDone anyway...\n \n> > The only issue now is the `__getitem__`.\n\n> \n> OK, I'll provide a `__getitem__` that mimics what used to be inherited from the category. \n\nDone.",
    "created_at": "2017-08-28T15:57:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357456",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:63" align="right">comment:63</div>

Replying to [@simon-king-jena](#comment:61):
> Replying to [@tscrim](#comment:60):
> > Thanks. I think because it is an implementation detail, it should be a proper code comment rather than a docstring note.

> 
> Shall I change it?

Done anyway...
 
> > The only issue now is the `__getitem__`.

> 
> OK, I'll provide a `__getitem__` that mimics what used to be inherited from the category. 

Done.



---

archive/issue_comments_357457.json:
```json
{
    "body": "<div id=\"comment:64\" align=\"right\">comment:64</div>\n\nReplying to [@simon-king-jena](#comment:63):\n> Replying to [@simon-king-jena](#comment:61):\n> > Replying to [@tscrim](#comment:60):\n> > > Thanks. I think because it is an implementation detail, it should be a proper code comment rather than a docstring note.\n\n> > \n> > Shall I change it?\n\n> \n> Done anyway...\n\nThanks. I think it is better to hide such details from the front-end user, but it might be useful for someone reading the code.\n\n> > > The only issue now is the `__getitem__`.\n\n> > \n> > OK, I'll provide a `__getitem__` that mimics what used to be inherited from the category. \n\n> \n> Done.\n\nIt is a more systemic problem:\n\n```\nsage: A = FiniteDimensionalAlgebra(ZZ, [Matrix([[1,0], [0,1]]), Matrix([[0,1], [0,0]])])\nsage: len(A.an_element())\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-2-3f0d37d36d4e> in <module>()\n----> 1 len(A.an_element())\n\nTypeError: object of type 'sage.algebras.finite_dimensional_algebras.finite_dimensional_algebra_element.FiniteDimensionalAlgebraElement' has no len()\n```\nGranted, I think this might be the only other special method defined in the category.",
    "created_at": "2017-08-28T16:06:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357457",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:64" align="right">comment:64</div>

Replying to [@simon-king-jena](#comment:63):
> Replying to [@simon-king-jena](#comment:61):
> > Replying to [@tscrim](#comment:60):
> > > Thanks. I think because it is an implementation detail, it should be a proper code comment rather than a docstring note.

> > 
> > Shall I change it?

> 
> Done anyway...

Thanks. I think it is better to hide such details from the front-end user, but it might be useful for someone reading the code.

> > > The only issue now is the `__getitem__`.

> > 
> > OK, I'll provide a `__getitem__` that mimics what used to be inherited from the category. 

> 
> Done.

It is a more systemic problem:

```
sage: A = FiniteDimensionalAlgebra(ZZ, [Matrix([[1,0], [0,1]]), Matrix([[0,1], [0,0]])])
sage: len(A.an_element())
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-2-3f0d37d36d4e> in <module>()
----> 1 len(A.an_element())

TypeError: object of type 'sage.algebras.finite_dimensional_algebras.finite_dimensional_algebra_element.FiniteDimensionalAlgebraElement' has no len()
```
Granted, I think this might be the only other special method defined in the category.



---

archive/issue_comments_357458.json:
```json
{
    "body": "Changed commit from **[`8afaa05`](https://github.com/sagemath/sagetrac-mirror/commit/8afaa0578da760358f799943e497eb2163b01a12)** to **[`2fd7595`](https://github.com/sagemath/sagetrac-mirror/commit/2fd759541a66426e5f075115979afb1cfcc58a21)**",
    "created_at": "2017-08-28T16:13:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357458",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`8afaa05`](https://github.com/sagemath/sagetrac-mirror/commit/8afaa0578da760358f799943e497eb2163b01a12)** to **[`2fd7595`](https://github.com/sagemath/sagetrac-mirror/commit/2fd759541a66426e5f075115979afb1cfcc58a21)**



---

archive/issue_comments_357459.json:
```json
{
    "body": "<div id=\"comment:65\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2fd759541a66426e5f075115979afb1cfcc58a21\"><code>2fd7595</code></a></td><td><code>Add FiniteDimensionalAlgebraElement.__len__</code></td></tr></table>\n",
    "created_at": "2017-08-28T16:13:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357459",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:65"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2fd759541a66426e5f075115979afb1cfcc58a21"><code>2fd7595</code></a></td><td><code>Add FiniteDimensionalAlgebraElement.__len__</code></td></tr></table>




---

archive/issue_comments_357460.json:
```json
{
    "body": "<div id=\"comment:66\" align=\"right\">comment:66</div>\n\nReplying to [@tscrim](#comment:64):\n> It is a more systemic problem:\n> \n> ```\n> sage: A = FiniteDimensionalAlgebra(ZZ, [Matrix([[1,0], [0,1]]), Matrix([[0,1], [0,0]])])\n> sage: len(A.an_element())\n> ---------------------------------------------------------------------------\n> TypeError                                 Traceback (most recent call last)\n> <ipython-input-2-3f0d37d36d4e> in <module>()\n> ----> 1 len(A.an_element())\n> \n> TypeError: object of type 'sage.algebras.finite_dimensional_algebras.finite_dimensional_algebra_element.FiniteDimensionalAlgebraElement' has no len()\n> ```\n> Granted, I think this might be the only other special method defined in the category.\n\nYes, I forgot. These are in fact the only two magical methods provided by ModulesWithBasis.ElementMethods.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2fd759541a66426e5f075115979afb1cfcc58a21\"><code>2fd7595</code></a></td><td><code>Add FiniteDimensionalAlgebraElement.__len__</code></td></tr></table>\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2fd759541a66426e5f075115979afb1cfcc58a21\"><code>2fd7595</code></a></td><td><code>Add FiniteDimensionalAlgebraElement.__len__</code></td></tr></table>\n",
    "created_at": "2017-08-28T16:14:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357460",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:66" align="right">comment:66</div>

Replying to [@tscrim](#comment:64):
> It is a more systemic problem:
> 
> ```
> sage: A = FiniteDimensionalAlgebra(ZZ, [Matrix([[1,0], [0,1]]), Matrix([[0,1], [0,0]])])
> sage: len(A.an_element())
> ---------------------------------------------------------------------------
> TypeError                                 Traceback (most recent call last)
> <ipython-input-2-3f0d37d36d4e> in <module>()
> ----> 1 len(A.an_element())
> 
> TypeError: object of type 'sage.algebras.finite_dimensional_algebras.finite_dimensional_algebra_element.FiniteDimensionalAlgebraElement' has no len()
> ```
> Granted, I think this might be the only other special method defined in the category.

Yes, I forgot. These are in fact the only two magical methods provided by ModulesWithBasis.ElementMethods.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2fd759541a66426e5f075115979afb1cfcc58a21"><code>2fd7595</code></a></td><td><code>Add FiniteDimensionalAlgebraElement.__len__</code></td></tr></table>

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2fd759541a66426e5f075115979afb1cfcc58a21"><code>2fd7595</code></a></td><td><code>Add FiniteDimensionalAlgebraElement.__len__</code></td></tr></table>




---

archive/issue_comments_357461.json:
```json
{
    "body": "<div id=\"comment:67\" align=\"right\">comment:67</div>\n\nWe definitely should override `__getitem__` as that will be a lot faster than the generic implementation. However, there is a change in behavior:\n\n```\nsage: A.an_element()[5]\nIndexError: matrix index out of range\n```\nBefore this would return `0`. It is arguable that it is the wrong behavior, and you don't have to change it, but I am just pointing it out. However, the different behavior does make the iterator work, but that is a matter of a lack of implementation. Really, there should be an implementation at the category level, but this would create an inconsistency with free module elements (i.e., created by `vector()`) and subclasses of `IndexedFreeModuleElement`.\n\nI think it would be good to decide on and implement the behavior for `__iter__` here:\n\n1 - Iterate over the vector and yield the coefficients.\n2 - Iterate over pairs `(k, v)`, where `k` is the index/key and `v` is a non-zero coefficient.\n\nMy vote would be for 2 to be consistent with many (all?) the other algebras in Sage.\n\nSubsequently, your `__len__` is a change in behavior, but it needs to be consistent with the `__iter__`. So we will need to choose.",
    "created_at": "2017-08-28T16:57:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357461",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:67" align="right">comment:67</div>

We definitely should override `__getitem__` as that will be a lot faster than the generic implementation. However, there is a change in behavior:

```
sage: A.an_element()[5]
IndexError: matrix index out of range
```
Before this would return `0`. It is arguable that it is the wrong behavior, and you don't have to change it, but I am just pointing it out. However, the different behavior does make the iterator work, but that is a matter of a lack of implementation. Really, there should be an implementation at the category level, but this would create an inconsistency with free module elements (i.e., created by `vector()`) and subclasses of `IndexedFreeModuleElement`.

I think it would be good to decide on and implement the behavior for `__iter__` here:

1 - Iterate over the vector and yield the coefficients.
2 - Iterate over pairs `(k, v)`, where `k` is the index/key and `v` is a non-zero coefficient.

My vote would be for 2 to be consistent with many (all?) the other algebras in Sage.

Subsequently, your `__len__` is a change in behavior, but it needs to be consistent with the `__iter__`. So we will need to choose.



---

archive/issue_comments_357462.json:
```json
{
    "body": "<div id=\"comment:68\" align=\"right\">comment:68</div>\n\nOh, one other thing that extension classes without a `__dict__` cannot do is add arbitrary attributes. So this no longer works:\n\n```\nsage: A.an_element().rename(\"foo\")\n---------------------------------------------------------------------------\nNotImplementedError                       Traceback (most recent call last)\n<ipython-input-6-996df49490f5> in <module>()\n----> 1 _.rename(\"foo\")\n\n/home/travis/sage/src/sage/structure/sage_object.pyx in sage.structure.sage_object.SageObject.rename (/home/travis/sage/src/build/cythonized/sage/structure/sage_object.c:2354)()\n    171                 self.__custom_name = str(x)\n    172             except AttributeError:\n--> 173                 raise NotImplementedError(\"object does not support renaming: %s\" % self)\n    174 \n    175     def reset_name(self):\n\nNotImplementedError: object does not support renaming: e0\n```\nHowever, I am okay with that not working as that is merely a convenience feature and most likely never used on these elements.",
    "created_at": "2017-08-28T17:15:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357462",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:68" align="right">comment:68</div>

Oh, one other thing that extension classes without a `__dict__` cannot do is add arbitrary attributes. So this no longer works:

```
sage: A.an_element().rename("foo")
---------------------------------------------------------------------------
NotImplementedError                       Traceback (most recent call last)
<ipython-input-6-996df49490f5> in <module>()
----> 1 _.rename("foo")

/home/travis/sage/src/sage/structure/sage_object.pyx in sage.structure.sage_object.SageObject.rename (/home/travis/sage/src/build/cythonized/sage/structure/sage_object.c:2354)()
    171                 self.__custom_name = str(x)
    172             except AttributeError:
--> 173                 raise NotImplementedError("object does not support renaming: %s" % self)
    174 
    175     def reset_name(self):

NotImplementedError: object does not support renaming: e0
```
However, I am okay with that not working as that is merely a convenience feature and most likely never used on these elements.



---

archive/issue_comments_357463.json:
```json
{
    "body": "<div id=\"comment:69\" align=\"right\">comment:69</div>\n\nReplying to [@tscrim](#comment:68):\n> Oh, one other thing that extension classes without a `__dict__` cannot do is add arbitrary attributes. So this no longer works:\n> \n> ```\n> sage: A.an_element().rename(\"foo\")\n> ```\n\nSeriously? Strange. I thought that renaming is supported on the level of `SageObject`. Aha, I just read:\n\n```\n           To support them for a specific class, add a\n           ``cdef public __custom_name`` attribute.\n```\nI find it strange that it has not been added on the level of SageObject.",
    "created_at": "2017-08-28T17:26:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357463",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:69" align="right">comment:69</div>

Replying to [@tscrim](#comment:68):
> Oh, one other thing that extension classes without a `__dict__` cannot do is add arbitrary attributes. So this no longer works:
> 
> ```
> sage: A.an_element().rename("foo")
> ```

Seriously? Strange. I thought that renaming is supported on the level of `SageObject`. Aha, I just read:

```
           To support them for a specific class, add a
           ``cdef public __custom_name`` attribute.
```
I find it strange that it has not been added on the level of SageObject.



---

archive/issue_comments_357464.json:
```json
{
    "body": "<div id=\"comment:70\" align=\"right\">comment:70</div>\n\nReplying to [@tscrim](#comment:67):\n> We definitely should override `__getitem__` as that will be a lot faster than the generic implementation. However, there is a change in behavior:\n> \n> ```\n> sage: A.an_element()[5]\n> IndexError: matrix index out of range\n> ```\n> Before this would return `0`. It is arguable that it is the wrong behavior,\n\nI do believe not raising an IndexError is wrong in that case.\n\n> However, the different behavior does make the iterator work, but that is a matter of a lack of implementation. \n\nHere I am unsure what you are referring to by \"different behaviour\". As a matter of fact, iterator works now:\n\n```\nsage: A = FiniteDimensionalAlgebra(QQ, [Matrix([[1,0,0], [0,1,0], [0,0,0]]), Matrix([[0,1,0], [0,0,0], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [0,0,1]])])\nsage: x = A.1\nsage: list(x)\n[0, 1, 0]\n```\n\n> I think it would be good to decide on and implement the behavior for `__iter__` here:\n> \n> 1 - Iterate over the vector and yield the coefficients.\n> 2 - Iterate over pairs `(k, v)`, where `k` is the index/key and `v` is a non-zero coefficient.\n> \n> My vote would be for 2 to be consistent with many (all?) the other algebras in Sage.\n\nI don't think it is possible to be consistent, as even multi- and univariate polynomials aren't:\n\n```\nsage: R.<x,y> = QQ[]\nsage: list(x^2+2*y)\n[(1, x^2), (2, y)]\nsage: R.<x> = QQ[]\nsage: list(x^8)\n[0, 0, 0, 0, 0, 0, 0, 0, 1]\n```\n\n> Subsequently, your `__len__` is a change in behavior, but it needs to be consistent with the `__iter__`. So we will need to choose.\n\nA finite dimensional algebra is a finite dimensional vector space, and thus I believe one should be consistent with vectors, not with multivariate polynomials. And that is the case with the current implementation.",
    "created_at": "2017-08-28T17:59:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357464",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:70" align="right">comment:70</div>

Replying to [@tscrim](#comment:67):
> We definitely should override `__getitem__` as that will be a lot faster than the generic implementation. However, there is a change in behavior:
> 
> ```
> sage: A.an_element()[5]
> IndexError: matrix index out of range
> ```
> Before this would return `0`. It is arguable that it is the wrong behavior,

I do believe not raising an IndexError is wrong in that case.

> However, the different behavior does make the iterator work, but that is a matter of a lack of implementation. 

Here I am unsure what you are referring to by "different behaviour". As a matter of fact, iterator works now:

```
sage: A = FiniteDimensionalAlgebra(QQ, [Matrix([[1,0,0], [0,1,0], [0,0,0]]), Matrix([[0,1,0], [0,0,0], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [0,0,1]])])
sage: x = A.1
sage: list(x)
[0, 1, 0]
```

> I think it would be good to decide on and implement the behavior for `__iter__` here:
> 
> 1 - Iterate over the vector and yield the coefficients.
> 2 - Iterate over pairs `(k, v)`, where `k` is the index/key and `v` is a non-zero coefficient.
> 
> My vote would be for 2 to be consistent with many (all?) the other algebras in Sage.

I don't think it is possible to be consistent, as even multi- and univariate polynomials aren't:

```
sage: R.<x,y> = QQ[]
sage: list(x^2+2*y)
[(1, x^2), (2, y)]
sage: R.<x> = QQ[]
sage: list(x^8)
[0, 0, 0, 0, 0, 0, 0, 0, 1]
```

> Subsequently, your `__len__` is a change in behavior, but it needs to be consistent with the `__iter__`. So we will need to choose.

A finite dimensional algebra is a finite dimensional vector space, and thus I believe one should be consistent with vectors, not with multivariate polynomials. And that is the case with the current implementation.



---

archive/issue_comments_357465.json:
```json
{
    "body": "<div id=\"comment:71\" align=\"right\">comment:71</div>\n\nReplying to [@simon-king-jena](#comment:70):\n> Replying to [@tscrim](#comment:67):\n> > My vote would be for 2 to be consistent with many (all?) the other algebras in Sage.\n\n> \n> I don't think it is possible to be consistent, as even multi- and univariate polynomials aren't:\n> \n> ```\n> sage: R.<x,y> = QQ[]\n> sage: list(x^2+2*y)\n> [(1, x^2), (2, y)]\n> sage: R.<x> = QQ[]\n> sage: list(x^8)\n> [0, 0, 0, 0, 0, 0, 0, 0, 1]\n> ```\n\nAlso note that it is `(v, k)` not `(k, v)`.",
    "created_at": "2017-08-28T18:07:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357465",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:71" align="right">comment:71</div>

Replying to [@simon-king-jena](#comment:70):
> Replying to [@tscrim](#comment:67):
> > My vote would be for 2 to be consistent with many (all?) the other algebras in Sage.

> 
> I don't think it is possible to be consistent, as even multi- and univariate polynomials aren't:
> 
> ```
> sage: R.<x,y> = QQ[]
> sage: list(x^2+2*y)
> [(1, x^2), (2, y)]
> sage: R.<x> = QQ[]
> sage: list(x^8)
> [0, 0, 0, 0, 0, 0, 0, 0, 1]
> ```

Also note that it is `(v, k)` not `(k, v)`.



---

archive/issue_comments_357466.json:
```json
{
    "body": "<div id=\"comment:72\" align=\"right\">comment:72</div>\n\nI wasn't thinking of polynomial rings (which are not [currently] in the category of `ModulesWithBasis`), but of subclasses of `CombinatorialFreeModule`:\n\n```\nsage: E = algebras.Exterior(QQ, 2)\nsage: E.an_element()\n2*e0 + 4*e1 + 1\nsage: list(E.an_element())\n[((), 1), ((1,), 4), ((0,), 2)]\n\nsage: F = algebras.Free(QQ, 3, 'x')\nsage: list(F.an_element())\n[(x1, 3), (x0, 2), (1, 2)]\nsage: F.an_element()\n2 + 2*x0 + 3*x1\n```",
    "created_at": "2017-08-28T19:29:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357466",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:72" align="right">comment:72</div>

I wasn't thinking of polynomial rings (which are not [currently] in the category of `ModulesWithBasis`), but of subclasses of `CombinatorialFreeModule`:

```
sage: E = algebras.Exterior(QQ, 2)
sage: E.an_element()
2*e0 + 4*e1 + 1
sage: list(E.an_element())
[((), 1), ((1,), 4), ((0,), 2)]

sage: F = algebras.Free(QQ, 3, 'x')
sage: list(F.an_element())
[(x1, 3), (x0, 2), (1, 2)]
sage: F.an_element()
2 + 2*x0 + 3*x1
```



---

archive/issue_comments_357467.json:
```json
{
    "body": "<div id=\"comment:73\" align=\"right\">comment:73</div>\n\nReplying to [@simon-king-jena](#comment:70):\n> Replying to [@tscrim](#comment:67):\n> > We definitely should override `__getitem__` as that will be a lot faster than the generic implementation. However, there is a change in behavior:\n> > \n> > ```\n> > sage: A.an_element()[5]\n> > IndexError: matrix index out of range\n> > ```\n> > Before this would return `0`. It is arguable that it is the wrong behavior,\n\n> \n> I do believe not raising an IndexError is wrong in that case.\n\nIt probably is a side-effect of a generic implementation of `_coefficient_fast`, which is called from `__getitem__`, that doesn't do any safety checks (because it needs to support infinite bases). So, yes, I agree that raising an error is the right thing.\n\n> > However, the different behavior does make the iterator work, but that is a matter of a lack of implementation. \n\n> \n> Here I am unsure what you are referring to by \"different behaviour\". As a matter of fact, iterator works now:\n> \n> ```\n> sage: A = FiniteDimensionalAlgebra(QQ, [Matrix([[1,0,0], [0,1,0], [0,0,0]]), Matrix([[0,1,0], [0,0,0], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [0,0,1]])])\n> sage: x = A.1\n> sage: list(x)\n> [0, 1, 0]\n> ```\n\nThe old behavior for `__getitem__` returned `0`, where there seems to be a default `__iter__` by Python that uses `__getitem__` with `int`s until it raises an `IndexError`.\n\n> > I think it would be good to decide on and implement the behavior for `__iter__` here:\n> > \n> > 1 - Iterate over the vector and yield the coefficients.\n> > 2 - Iterate over pairs `(k, v)`, where `k` is the index/key and `v` is a non-zero coefficient.\n> > \n> > My vote would be for 2 to be consistent with many (all?) the other algebras in Sage.\n\n> \n> I don't think it is possible to be consistent, as even multi- and univariate polynomials aren't:\n> \n> ```\n> sage: R.<x,y> = QQ[]\n> sage: list(x^2+2*y)\n> [(1, x^2), (2, y)]\n> sage: R.<x> = QQ[]\n> sage: list(x^8)\n> [0, 0, 0, 0, 0, 0, 0, 0, 1]\n> ```\n\nGood point. Always fun the differences between uni- and multivariate polynomials.\n\n> > Subsequently, your `__len__` is a change in behavior, but it needs to be consistent with the `__iter__`. So we will need to choose.\n\n> \n> A finite dimensional algebra is a finite dimensional vector space, and thus I believe one should be consistent with vectors, not with multivariate polynomials. And that is the case with the current implementation.\n\nSee [comment:72](#comment:72) for other algebras. Polynomials error out when trying to do, e.g., `len(x^2+x)` and sidestep the issue. It comes down to `len` meaning length as a column vector or length of the support.\n\n---\n\nI am okay with the current behavior, even if I would prefer it to agree with `ModulesWithBasis` objects/`CombinatorialFreeModule` subclasses, but I just wanted to bring up that it is a change. Since you prefer the current implementation and there is a green patchbot, I am setting a positive review.",
    "created_at": "2017-08-28T19:44:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357467",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:73" align="right">comment:73</div>

Replying to [@simon-king-jena](#comment:70):
> Replying to [@tscrim](#comment:67):
> > We definitely should override `__getitem__` as that will be a lot faster than the generic implementation. However, there is a change in behavior:
> > 
> > ```
> > sage: A.an_element()[5]
> > IndexError: matrix index out of range
> > ```
> > Before this would return `0`. It is arguable that it is the wrong behavior,

> 
> I do believe not raising an IndexError is wrong in that case.

It probably is a side-effect of a generic implementation of `_coefficient_fast`, which is called from `__getitem__`, that doesn't do any safety checks (because it needs to support infinite bases). So, yes, I agree that raising an error is the right thing.

> > However, the different behavior does make the iterator work, but that is a matter of a lack of implementation. 

> 
> Here I am unsure what you are referring to by "different behaviour". As a matter of fact, iterator works now:
> 
> ```
> sage: A = FiniteDimensionalAlgebra(QQ, [Matrix([[1,0,0], [0,1,0], [0,0,0]]), Matrix([[0,1,0], [0,0,0], [0,0,0]]), Matrix([[0,0,0], [0,0,0], [0,0,1]])])
> sage: x = A.1
> sage: list(x)
> [0, 1, 0]
> ```

The old behavior for `__getitem__` returned `0`, where there seems to be a default `__iter__` by Python that uses `__getitem__` with `int`s until it raises an `IndexError`.

> > I think it would be good to decide on and implement the behavior for `__iter__` here:
> > 
> > 1 - Iterate over the vector and yield the coefficients.
> > 2 - Iterate over pairs `(k, v)`, where `k` is the index/key and `v` is a non-zero coefficient.
> > 
> > My vote would be for 2 to be consistent with many (all?) the other algebras in Sage.

> 
> I don't think it is possible to be consistent, as even multi- and univariate polynomials aren't:
> 
> ```
> sage: R.<x,y> = QQ[]
> sage: list(x^2+2*y)
> [(1, x^2), (2, y)]
> sage: R.<x> = QQ[]
> sage: list(x^8)
> [0, 0, 0, 0, 0, 0, 0, 0, 1]
> ```

Good point. Always fun the differences between uni- and multivariate polynomials.

> > Subsequently, your `__len__` is a change in behavior, but it needs to be consistent with the `__iter__`. So we will need to choose.

> 
> A finite dimensional algebra is a finite dimensional vector space, and thus I believe one should be consistent with vectors, not with multivariate polynomials. And that is the case with the current implementation.

See [comment:72](#comment:72) for other algebras. Polynomials error out when trying to do, e.g., `len(x^2+x)` and sidestep the issue. It comes down to `len` meaning length as a column vector or length of the support.

---

I am okay with the current behavior, even if I would prefer it to agree with `ModulesWithBasis` objects/`CombinatorialFreeModule` subclasses, but I just wanted to bring up that it is a change. Since you prefer the current implementation and there is a green patchbot, I am setting a positive review.



---

archive/issue_events_331169.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2017-08-28T19:44:26Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23707#event-331169"
}
```



---

archive/issue_events_331170.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2017-08-28T19:44:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23707#event-331170"
}
```



---

archive/issue_comments_357468.json:
```json
{
    "body": "<div id=\"comment:74\" align=\"right\">comment:74</div>\n\nThank you!",
    "created_at": "2017-08-28T19:52:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357468",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:74" align="right">comment:74</div>

Thank you!



---

archive/issue_comments_357469.json:
```json
{
    "body": "<div id=\"comment:75\" align=\"right\">comment:75</div>\n\nThank you for your work on this. I look forward to having the quotients as well.",
    "created_at": "2017-08-28T20:20:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357469",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:75" align="right">comment:75</div>

Thank you for your work on this. I look forward to having the quotients as well.



---

archive/issue_comments_357470.json:
```json
{
    "body": "<div id=\"comment:76\" align=\"right\">comment:76</div>\n\nYou are using `cdef int` in a few places where you might want `cdef Py_ssize_t`. Otherwise you are restricting to a size of 2<sup>31</sup> for no good reason.",
    "created_at": "2017-08-28T21:11:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357470",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:76" align="right">comment:76</div>

You are using `cdef int` in a few places where you might want `cdef Py_ssize_t`. Otherwise you are restricting to a size of 2<sup>31</sup> for no good reason.



---

archive/issue_events_331171.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-08-28T21:11:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23707#event-331171"
}
```



---

archive/issue_events_331172.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-08-28T21:11:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23707#event-331172"
}
```



---

archive/issue_comments_357471.json:
```json
{
    "body": "<div id=\"comment:77\" align=\"right\">comment:77</div>\n\nReplying to [@jdemeyer](#comment:76):\n> You are using `cdef int` in a few places where you might want `cdef Py_ssize_t`. Otherwise you are restricting to a size of 2<sup>31</sup> for no good reason.\n\nThe restriction has already been there before:\n\n```\nsage: M = MatrixSpace(GF(2),1,2^32)()\nsage: M[0,2^32-1]\n---------------------------------------------------------------------------\nOverflowError                             Traceback (most recent call last)\n<ipython-input-2-0b1808df77ca> in <module>()\n----> 1 M[Integer(0),Integer(2)**Integer(32)-Integer(1)]\n\n/home/king/Sage/git/sage/src/sage/matrix/matrix0.pyx in sage.matrix.matrix0.Matrix.__getitem__ (build/cythonized/sage/matrix/matrix0.c:7018)()\n    946                 if not PyIndex_Check(col_index):\n    947                     raise TypeError(\"index must be an integer\")\n--> 948                 col = col_index\n    949                 if col < 0:\n    950                     col += ncols\n\nOverflowError: value too large to convert to int\n```",
    "created_at": "2017-08-29T06:22:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357471",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:77" align="right">comment:77</div>

Replying to [@jdemeyer](#comment:76):
> You are using `cdef int` in a few places where you might want `cdef Py_ssize_t`. Otherwise you are restricting to a size of 2<sup>31</sup> for no good reason.

The restriction has already been there before:

```
sage: M = MatrixSpace(GF(2),1,2^32)()
sage: M[0,2^32-1]
---------------------------------------------------------------------------
OverflowError                             Traceback (most recent call last)
<ipython-input-2-0b1808df77ca> in <module>()
----> 1 M[Integer(0),Integer(2)**Integer(32)-Integer(1)]

/home/king/Sage/git/sage/src/sage/matrix/matrix0.pyx in sage.matrix.matrix0.Matrix.__getitem__ (build/cythonized/sage/matrix/matrix0.c:7018)()
    946                 if not PyIndex_Check(col_index):
    947                     raise TypeError("index must be an integer")
--> 948                 col = col_index
    949                 if col < 0:
    950                     col += ncols

OverflowError: value too large to convert to int
```



---

archive/issue_comments_357472.json:
```json
{
    "body": "<div id=\"comment:78\" align=\"right\">comment:78</div>\n\nReplying to [@jdemeyer](#comment:76):\n> You are using `cdef int` in a few places where you might want `cdef Py_ssize_t`. Otherwise you are restricting to a size of 2<sup>31</sup> for no good reason.\n\nAnd doesn't `Py_ssize_t` denote some sort of *signed* integer? I guess I need an unsigned one. `Py_size_t`?",
    "created_at": "2017-08-29T06:24:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357472",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:78" align="right">comment:78</div>

Replying to [@jdemeyer](#comment:76):
> You are using `cdef int` in a few places where you might want `cdef Py_ssize_t`. Otherwise you are restricting to a size of 2<sup>31</sup> for no good reason.

And doesn't `Py_ssize_t` denote some sort of *signed* integer? I guess I need an unsigned one. `Py_size_t`?



---

archive/issue_comments_357473.json:
```json
{
    "body": "<div id=\"comment:79\" align=\"right\">comment:79</div>\n\nOne could even argue that using `cdef int` prevents one from crashing:\n\n```\nsage: M = MatrixSpace(GF(2),2^32)\nsage: M(1)\n------------------------------------------------------------------------\n/home/king/Sage/git/sage/local/lib/python2.7/site-packages/cysignals/signals.so(+0x5e75)[0x7fb34704ee75]\n/home/king/Sage/git/sage/local/lib/python2.7/site-packages/cysignals/signals.so(+0x5ec5)[0x7fb34704eec5]\n/home/king/Sage/git/sage/local/lib/python2.7/site-packages/cysignals/signals.so(+0x8e97)[0x7fb347051e97]\n/lib/x86_64-linux-gnu/libpthread.so.0(+0x11390)[0x7fb35378d390]\n/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_mod2_dense.so(+0xb102)[0x7fb1b8d71102]\n/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix0.so(+0x407ee)[0x7fb1bc5a67ee]\n/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x48bd)[0x7fb353aa18ad]\n/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x81c)[0x7fb353aa688c]\n/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/misc/cachefunc.so(+0x16433)[0x7fb34572a433]\n/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/misc/cachefunc.so(+0x166c7)[0x7fb34572a6c7]\n/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/misc/cachefunc.so(+0x1698c)[0x7fb34572a98c]\n/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyObject_Call+0x43)[0x7fb3539ed483]\n/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x56da)[0x7fb353aa26ca]\n/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x81c)[0x7fb353aa688c]\n/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x8020)[0x7fb353aa5010]\n/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x81c)[0x7fb353aa688c]\n/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(+0x8567c)[0x7fb353a1e67c]\n/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyObject_Call+0x43)[0x7fb3539ed483]\n/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(+0x657ec)[0x7fb3539fe7ec]\n/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyObject_Call+0x43)[0x7fb3539ed483]\n/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(+0xc1985)[0x7fb353a5a985]\n/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyObject_Call+0x43)[0x7fb3539ed483]\n/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x56da)[0x7fb353aa26ca]\n/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x81c)[0x7fb353aa688c]\n/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCode+0x19)[0x7fb353aa69a9]\n/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x7428)[0x7fb353aa4418]\n/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x81c)[0x7fb353aa688c]\n/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x8020)[0x7fb353aa5010]\n/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x81c)[0x7fb353aa688c]\n/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x8020)[0x7fb353aa5010]\n/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x81c)[0x7fb353aa688c]\n/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x8020)[0x7fb353aa5010]\n/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x81c)[0x7fb353aa688c]\n/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x8020)[0x7fb353aa5010]\n/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x81c)[0x7fb353aa688c]\n/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x8020)[0x7fb353aa5010]\n/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x81c)[0x7fb353aa688c]\n/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x8020)[0x7fb353aa5010]\n/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x81c)[0x7fb353aa688c]\n/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCode+0x19)[0x7fb353aa69a9]\n/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyRun_FileExFlags+0x8a)[0x7fb353acaa4a]\n/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyRun_SimpleFileExFlags+0xd7)[0x7fb353acbdf7]\n/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(Py_Main+0xc3e)[0x7fb353ae24be]\n/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xf0)[0x7fb352cc2830]\npython(_start+0x29)[0x400719]\n------------------------------------------------------------------------\nAttaching gdb to process id 6413.\n\nFailed to run gdb.\nFailed to run gdb.\nInstall gdb for enhanced tracebacks.\n------------------------------------------------------------------------\nUnhandled SIGSEGV: A segmentation fault occurred.\nThis probably occurred because a *compiled* module has a bug\nin it and is not properly wrapped with sig_on(), sig_off().\nPython will now terminate.\n------------------------------------------------------------------------\nSegmentation fault (core dumped)\n```",
    "created_at": "2017-08-29T06:29:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357473",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:79" align="right">comment:79</div>

One could even argue that using `cdef int` prevents one from crashing:

```
sage: M = MatrixSpace(GF(2),2^32)
sage: M(1)
------------------------------------------------------------------------
/home/king/Sage/git/sage/local/lib/python2.7/site-packages/cysignals/signals.so(+0x5e75)[0x7fb34704ee75]
/home/king/Sage/git/sage/local/lib/python2.7/site-packages/cysignals/signals.so(+0x5ec5)[0x7fb34704eec5]
/home/king/Sage/git/sage/local/lib/python2.7/site-packages/cysignals/signals.so(+0x8e97)[0x7fb347051e97]
/lib/x86_64-linux-gnu/libpthread.so.0(+0x11390)[0x7fb35378d390]
/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_mod2_dense.so(+0xb102)[0x7fb1b8d71102]
/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix0.so(+0x407ee)[0x7fb1bc5a67ee]
/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x48bd)[0x7fb353aa18ad]
/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x81c)[0x7fb353aa688c]
/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/misc/cachefunc.so(+0x16433)[0x7fb34572a433]
/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/misc/cachefunc.so(+0x166c7)[0x7fb34572a6c7]
/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/misc/cachefunc.so(+0x1698c)[0x7fb34572a98c]
/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyObject_Call+0x43)[0x7fb3539ed483]
/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x56da)[0x7fb353aa26ca]
/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x81c)[0x7fb353aa688c]
/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x8020)[0x7fb353aa5010]
/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x81c)[0x7fb353aa688c]
/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(+0x8567c)[0x7fb353a1e67c]
/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyObject_Call+0x43)[0x7fb3539ed483]
/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(+0x657ec)[0x7fb3539fe7ec]
/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyObject_Call+0x43)[0x7fb3539ed483]
/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(+0xc1985)[0x7fb353a5a985]
/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyObject_Call+0x43)[0x7fb3539ed483]
/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x56da)[0x7fb353aa26ca]
/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x81c)[0x7fb353aa688c]
/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCode+0x19)[0x7fb353aa69a9]
/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x7428)[0x7fb353aa4418]
/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x81c)[0x7fb353aa688c]
/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x8020)[0x7fb353aa5010]
/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x81c)[0x7fb353aa688c]
/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x8020)[0x7fb353aa5010]
/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x81c)[0x7fb353aa688c]
/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x8020)[0x7fb353aa5010]
/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x81c)[0x7fb353aa688c]
/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x8020)[0x7fb353aa5010]
/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x81c)[0x7fb353aa688c]
/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x8020)[0x7fb353aa5010]
/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x81c)[0x7fb353aa688c]
/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x8020)[0x7fb353aa5010]
/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x81c)[0x7fb353aa688c]
/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyEval_EvalCode+0x19)[0x7fb353aa69a9]
/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyRun_FileExFlags+0x8a)[0x7fb353acaa4a]
/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(PyRun_SimpleFileExFlags+0xd7)[0x7fb353acbdf7]
/home/king/Sage/git/sage/local/lib/libpython2.7.so.1.0(Py_Main+0xc3e)[0x7fb353ae24be]
/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xf0)[0x7fb352cc2830]
python(_start+0x29)[0x400719]
------------------------------------------------------------------------
Attaching gdb to process id 6413.

Failed to run gdb.
Failed to run gdb.
Install gdb for enhanced tracebacks.
------------------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------
Segmentation fault (core dumped)
```



---

archive/issue_comments_357474.json:
```json
{
    "body": "<div id=\"comment:80\" align=\"right\">comment:80</div>\n\nReplying to [@simon-king-jena](#comment:77):\n> The restriction has already been there before:\n\nThe fact that a certain bug exists already is not a good reason to add more bugs of a similar nature.",
    "created_at": "2017-08-29T08:31:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357474",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:80" align="right">comment:80</div>

Replying to [@simon-king-jena](#comment:77):
> The restriction has already been there before:

The fact that a certain bug exists already is not a good reason to add more bugs of a similar nature.



---

archive/issue_comments_357475.json:
```json
{
    "body": "<div id=\"comment:81\" align=\"right\">comment:81</div>\n\nReplying to [@simon-king-jena](#comment:78):\n> And doesn't `Py_ssize_t` denote some sort of *signed* integer?\n\nYes, it does. However, Python generally uses `Py_ssize_t` for sizes (say, of lists or tuples). Also, in Sage, the number of rows/columns of a matrix is already stored as `Py_ssize_t`:\n\n```\ncdef class Matrix(ModuleElement):\n    # All matrix classes must be written in Cython\n    cdef Py_ssize_t _nrows\n    cdef Py_ssize_t _ncols\n```",
    "created_at": "2017-08-29T08:34:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357475",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:81" align="right">comment:81</div>

Replying to [@simon-king-jena](#comment:78):
> And doesn't `Py_ssize_t` denote some sort of *signed* integer?

Yes, it does. However, Python generally uses `Py_ssize_t` for sizes (say, of lists or tuples). Also, in Sage, the number of rows/columns of a matrix is already stored as `Py_ssize_t`:

```
cdef class Matrix(ModuleElement):
    # All matrix classes must be written in Cython
    cdef Py_ssize_t _nrows
    cdef Py_ssize_t _ncols
```



---

archive/issue_comments_357476.json:
```json
{
    "body": "<div id=\"comment:82\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3cc3a2793ec3954d4b99ea234219358c7b666419\"><code>3cc3a27</code></a></td><td><code>Use Py_ssize_t to iterate over matrix indices</code></td></tr></table>\n",
    "created_at": "2017-08-29T09:01:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357476",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:82"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3cc3a2793ec3954d4b99ea234219358c7b666419"><code>3cc3a27</code></a></td><td><code>Use Py_ssize_t to iterate over matrix indices</code></td></tr></table>




---

archive/issue_comments_357477.json:
```json
{
    "body": "Changed commit from **[`2fd7595`](https://github.com/sagemath/sagetrac-mirror/commit/2fd759541a66426e5f075115979afb1cfcc58a21)** to **[`3cc3a27`](https://github.com/sagemath/sagetrac-mirror/commit/3cc3a2793ec3954d4b99ea234219358c7b666419)**",
    "created_at": "2017-08-29T09:01:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357477",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`2fd7595`](https://github.com/sagemath/sagetrac-mirror/commit/2fd759541a66426e5f075115979afb1cfcc58a21)** to **[`3cc3a27`](https://github.com/sagemath/sagetrac-mirror/commit/3cc3a2793ec3954d4b99ea234219358c7b666419)**



---

archive/issue_events_331173.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2017-08-29T09:02:29Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23707#event-331173"
}
```



---

archive/issue_events_331174.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2017-08-29T09:02:29Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23707#event-331174"
}
```



---

archive/issue_comments_357478.json:
```json
{
    "body": "<div id=\"comment:83\" align=\"right\">comment:83</div>\n\nReplying to [@jdemeyer](#comment:81):\nAlso, in Sage, the number of rows/columns of a matrix is already stored as `Py_ssize_t`:\n> \n> ```\n> cdef class Matrix(ModuleElement):\n>     # All matrix classes must be written in Cython\n>     cdef Py_ssize_t _nrows\n>     cdef Py_ssize_t _ncols\n> ```\n\nOK, that's a good reason. I changed to `Py_ssize_t`.",
    "created_at": "2017-08-29T09:02:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357478",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:83" align="right">comment:83</div>

Replying to [@jdemeyer](#comment:81):
Also, in Sage, the number of rows/columns of a matrix is already stored as `Py_ssize_t`:
> 
> ```
> cdef class Matrix(ModuleElement):
>     # All matrix classes must be written in Cython
>     cdef Py_ssize_t _nrows
>     cdef Py_ssize_t _ncols
> ```

OK, that's a good reason. I changed to `Py_ssize_t`.



---

archive/issue_comments_357479.json:
```json
{
    "body": "<div id=\"comment:84\" align=\"right\">comment:84</div>\n\nJeroen, any more comments (or things not addressed)?",
    "created_at": "2017-09-17T14:55:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357479",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:84" align="right">comment:84</div>

Jeroen, any more comments (or things not addressed)?



---

archive/issue_comments_357480.json:
```json
{
    "body": "<div id=\"comment:85\" align=\"right\">comment:85</div>\n\nNot really. Anyway, I have not looked deeply into this ticket, I was just pointing a few random things.",
    "created_at": "2017-09-18T07:46:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357480",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:85" align="right">comment:85</div>

Not really. Anyway, I have not looked deeply into this ticket, I was just pointing a few random things.



---

archive/issue_comments_357481.json:
```json
{
    "body": "<div id=\"comment:86\" align=\"right\">comment:86</div>\n\nI let this drop off. Whoops. Back to positive review.",
    "created_at": "2017-10-26T00:15:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357481",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:86" align="right">comment:86</div>

I let this drop off. Whoops. Back to positive review.



---

archive/issue_events_331175.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2017-10-26T00:15:09Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23707#event-331175"
}
```



---

archive/issue_events_331176.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2017-10-26T00:15:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23707#event-331176"
}
```



---

archive/issue_comments_357482.json:
```json
{
    "body": "Changed branch from **[u/SimonKing/more_competitive_and_comprehensive_finite_dimensional_algebras](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/more_competitive_and_comprehensive_finite_dimensional_algebras)** to **[`3cc3a27`](https://github.com/sagemath/sagetrac-mirror/commit/3cc3a2793ec3954d4b99ea234219358c7b666419)**",
    "created_at": "2017-10-29T10:32:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23707#issuecomment-357482",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/SimonKing/more_competitive_and_comprehensive_finite_dimensional_algebras](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/more_competitive_and_comprehensive_finite_dimensional_algebras)** to **[`3cc3a27`](https://github.com/sagemath/sagetrac-mirror/commit/3cc3a2793ec3954d4b99ea234219358c7b666419)**



---

archive/issue_events_331177.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-10-29T10:32:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23707#event-331177"
}
```



---

archive/issue_events_331178.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "14d3ce496987ce085b1cc159b7f595601599aceb",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2017-10-29T10:32:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/23707",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23707#event-331178"
}
```
