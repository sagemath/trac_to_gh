# Issue 23352: Fix random matrix_gfpn_dense

archive/issues_023115.json:
```json
{
    "body": "I just noticed that, when meataxe is installed and its Sage wrapper is used for matrices over `GF(p^n)` with `p` odd and `p^n<255`, then at least in some cases the random matrices aren't sufficiently random:\n\n```\nsage: random_matrix(GF(9,'x'), 5)\n[      x 2*x + 1   x + 2   x + 2       0]\n[  x + 1       x   x + 2   x + 1       0]\n[  x + 1       2   x + 1       2       0]\n[      x     2*x       x   x + 1       0]\n[2*x + 1       0 2*x + 1 2*x + 2       0]\nsage: random_matrix(GF(9,'x'), 5)\n[      2   x + 1   x + 1 2*x + 2       0]\n[      x 2*x + 2   x + 2     2*x       0]\n[  x + 2     2*x       0 2*x + 2       0]\n[    2*x       2       2       1       0]\n[  x + 2       2     2*x       1       0]\nsage: random_matrix(GF(9,'x'), 5)\n[      2 2*x + 1       x 2*x + 1       0]\n[2*x + 2       0 2*x + 2       x       0]\n[      2       x 2*x + 1   x + 2       0]\n[      0 2*x + 1       x       x       0]\n[      1       1       2   x + 1       0]\nsage: random_matrix(GF(9,'x'), 5)\n[      x   x + 1       0       0       0]\n[      1   x + 1       0 2*x + 1       0]\n[      2       0       x   x + 2       0]\n[      2       0   x + 1   x + 2       0]\n[      x   x + 1     2*x       1       0]\n```\nSo, the last column always is zero, which shouldn't be the case.\n\nKeywords: meataxe random, days88, IMA coding sprints\n\nBranch/Commit: 39431d7e98a19de1c3b4f0af97440922eed10f44\n\nReviewer: Jeroen Demeyer, Travis Scrimshaw\n\nAuthor: Simon King\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/23352\n\n",
    "closed_at": "2017-08-29T19:51:06Z",
    "created_at": "2017-07-02T13:43:44Z",
    "labels": [
        "component: packages: optional",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Fix random matrix_gfpn_dense",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23352",
    "user": "https://github.com/simon-king-jena"
}
```
I just noticed that, when meataxe is installed and its Sage wrapper is used for matrices over `GF(p^n)` with `p` odd and `p^n<255`, then at least in some cases the random matrices aren't sufficiently random:

```
sage: random_matrix(GF(9,'x'), 5)
[      x 2*x + 1   x + 2   x + 2       0]
[  x + 1       x   x + 2   x + 1       0]
[  x + 1       2   x + 1       2       0]
[      x     2*x       x   x + 1       0]
[2*x + 1       0 2*x + 1 2*x + 2       0]
sage: random_matrix(GF(9,'x'), 5)
[      2   x + 1   x + 1 2*x + 2       0]
[      x 2*x + 2   x + 2     2*x       0]
[  x + 2     2*x       0 2*x + 2       0]
[    2*x       2       2       1       0]
[  x + 2       2     2*x       1       0]
sage: random_matrix(GF(9,'x'), 5)
[      2 2*x + 1       x 2*x + 1       0]
[2*x + 2       0 2*x + 2       x       0]
[      2       x 2*x + 1   x + 2       0]
[      0 2*x + 1       x       x       0]
[      1       1       2   x + 1       0]
sage: random_matrix(GF(9,'x'), 5)
[      x   x + 1       0       0       0]
[      1   x + 1       0 2*x + 1       0]
[      2       0       x   x + 2       0]
[      2       0   x + 1   x + 2       0]
[      x   x + 1     2*x       1       0]
```
So, the last column always is zero, which shouldn't be the case.

Keywords: meataxe random, days88, IMA coding sprints

Branch/Commit: 39431d7e98a19de1c3b4f0af97440922eed10f44

Reviewer: Jeroen Demeyer, Travis Scrimshaw

Author: Simon King

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/23352





---

archive/issue_comments_344226.json:
```json
{
    "body": "<a id='comment:2'></a>The matrix entries are densely packed in meataxe. Hence, in some situations, the last byte of a row in memory is only partly filled with data. And in fact the HIGHEST bits of the last byte have to be filled.\n\nThe problem was: In the old code, the LOWEST bits of the last byte have been filled.\n\nI fixed it by explicitly assigning random numbers to the last few entries (instead of trying to fill a whole block of entries).\n\n---\nNew commits:",
    "created_at": "2017-07-07T13:24:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344226",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:2'></a>The matrix entries are densely packed in meataxe. Hence, in some situations, the last byte of a row in memory is only partly filled with data. And in fact the HIGHEST bits of the last byte have to be filled.

The problem was: In the old code, the LOWEST bits of the last byte have been filled.

I fixed it by explicitly assigning random numbers to the last few entries (instead of trying to fill a whole block of entries).

---
New commits:



---

archive/issue_comments_344227.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-07-07T13:24:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344227",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_344228.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-07-08T16:18:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344228",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_344229.json:
```json
{
    "body": "<a id='comment:3'></a>Sooner or later this ticket needs to be merged with #21437. There is a merge conflict, and `git mergetool` doesn't work reasonably (namely: It shows me numerous conflicts, although the diff from this ticket is very small).\n\nTherefore I will *rebase* this ticket on top of #21437 and force-push it.",
    "created_at": "2017-07-08T16:18:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344229",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:3'></a>Sooner or later this ticket needs to be merged with #21437. There is a merge conflict, and `git mergetool` doesn't work reasonably (namely: It shows me numerous conflicts, although the diff from this ticket is very small).

Therefore I will *rebase* this ticket on top of #21437 and force-push it.



---

archive/issue_comments_344230.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2017-07-08T16:26:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344230",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_344231.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-07-08T16:28:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344231",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_344232.json:
```json
{
    "body": "<a id='comment:5'></a>Don't be scared. All but the last commit belong to #21437. Yes, I still believe that git commits *belong* to a ticket...\n\nAnyway, I think it is logical to put a ticket that fixes random meataxe matrices on top of a ticket that fixes other aspects of meataxe matrices.",
    "created_at": "2017-07-08T16:28:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344232",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:5'></a>Don't be scared. All but the last commit belong to #21437. Yes, I still believe that git commits *belong* to a ticket...

Anyway, I think it is logical to put a ticket that fixes random meataxe matrices on top of a ticket that fixes other aspects of meataxe matrices.



---

archive/issue_comments_344233.json:
```json
{
    "body": "<a id='comment:6'></a>Jeroen suggested on #21437 to distribute different aspects of the work in a new way. I think this ticket fits best for the topic \"bug fixes\". So, I'll rename the ticket a couple of commits. The tests should pass with the branch that I'll force-push in a minute.",
    "created_at": "2017-07-10T16:35:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344233",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:6'></a>Jeroen suggested on #21437 to distribute different aspects of the work in a new way. I think this ticket fits best for the topic "bug fixes". So, I'll rename the ticket a couple of commits. The tests should pass with the branch that I'll force-push in a minute.



---

archive/issue_comments_344234.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -28,7 +28,9 @@\n ```\n So, the last column always is zero, which shouldn't be the case.\n \n-Keywords: meataxe random\n+In addition, reading a meataxe matrix from a non-existing file would currently crash.\n+\n+And finally, the current way of pickling would be machine dependent. That should be fixed as well.\n \n Comment: 1\n \n```\n",
    "created_at": "2017-07-10T16:35:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344234",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
```diff
--- 
+++ 
@@ -28,7 +28,9 @@
 ```
 So, the last column always is zero, which shouldn't be the case.
 
-Keywords: meataxe random
+In addition, reading a meataxe matrix from a non-existing file would currently crash.
+
+And finally, the current way of pickling would be machine dependent. That should be fixed as well.
 
 Comment: 1
 
```




---

archive/issue_comments_344235.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-07-10T16:36:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344235",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_344236.json:
```json
{
    "body": "<a id='comment:8'></a>Needs review...",
    "created_at": "2017-07-10T16:36:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344236",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'></a>Needs review...



---

archive/issue_comments_344237.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-10T21:14:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344237",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_344238.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:6 SimonKing]:\n> Jeroen suggested on #21437 to distribute different aspects of the work in a new way.\n\n\nThat's not quite what I said. I proposed to split up #21437. Adding more stuff to existing tickets (like this one) is actually the opposite of what I intented.",
    "created_at": "2017-07-12T12:41:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344238",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>Replying to [comment:6 SimonKing]:
> Jeroen suggested on #21437 to distribute different aspects of the work in a new way.


That's not quite what I said. I proposed to split up #21437. Adding more stuff to existing tickets (like this one) is actually the opposite of what I intented.



---

archive/issue_comments_344239.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:11 jdemeyer]:\n> Replying to [comment:6 SimonKing]:\n> > Jeroen suggested on #21437 to distribute different aspects of the work in a new way.\n\n> \n> That's not quite what I said. I proposed to split up #21437. Adding more stuff to existing tickets (like this one) is actually the opposite of what I intented.\n\n\nDo you prefer that I rebase again and split this ticket into three: One for the new MeatAxe patch (that avoids frequent calls to a C function and thus gives a speedup), one for the pickling and one for random matrices?",
    "created_at": "2017-07-12T13:39:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344239",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:12'></a>Replying to [comment:11 jdemeyer]:
> Replying to [comment:6 SimonKing]:
> > Jeroen suggested on #21437 to distribute different aspects of the work in a new way.

> 
> That's not quite what I said. I proposed to split up #21437. Adding more stuff to existing tickets (like this one) is actually the opposite of what I intented.


Do you prefer that I rebase again and split this ticket into three: One for the new MeatAxe patch (that avoids frequent calls to a C function and thus gives a speedup), one for the pickling and one for random matrices?



---

archive/issue_comments_344240.json:
```json
{
    "body": "<a id='comment:13'></a>Yes, that would be a good idea.",
    "created_at": "2017-07-12T13:41:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344240",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>Yes, that would be a good idea.



---

archive/issue_comments_344241.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [comment:13 jdemeyer]:\n> Yes, that would be a good idea.\n\n\nThe first one is #23410.\n\nThe patches to be distributed are, as much as I see, independent. Would it be better to let the new tickets build upon each other (i.e., the git history of one ticket is included in the git history of the other tickets), or should they stay separate (i.e., each ticket provides a patch, and then they are merged only when needed)?",
    "created_at": "2017-07-12T14:10:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344241",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:14'></a>Replying to [comment:13 jdemeyer]:
> Yes, that would be a good idea.


The first one is #23410.

The patches to be distributed are, as much as I see, independent. Would it be better to let the new tickets build upon each other (i.e., the git history of one ticket is included in the git history of the other tickets), or should they stay separate (i.e., each ticket provides a patch, and then they are merged only when needed)?



---

archive/issue_comments_344242.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-07-12T14:57:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344242",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_344243.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,32 @@\n+I just noticed that, when meataxe is installed and its Sage wrapper is used for matrices over `GF(p^n)` with `p` odd and `p^n<255`, then at least in some cases the random matrices aren't sufficiently random:\n \n+```\n+sage: random_matrix(GF(9,'x'), 5)\n+[      x 2*x + 1   x + 2   x + 2       0]\n+[  x + 1       x   x + 2   x + 1       0]\n+[  x + 1       2   x + 1       2       0]\n+[      x     2*x       x   x + 1       0]\n+[2*x + 1       0 2*x + 1 2*x + 2       0]\n+sage: random_matrix(GF(9,'x'), 5)\n+[      2   x + 1   x + 1 2*x + 2       0]\n+[      x 2*x + 2   x + 2     2*x       0]\n+[  x + 2     2*x       0 2*x + 2       0]\n+[    2*x       2       2       1       0]\n+[  x + 2       2     2*x       1       0]\n+sage: random_matrix(GF(9,'x'), 5)\n+[      2 2*x + 1       x 2*x + 1       0]\n+[2*x + 2       0 2*x + 2       x       0]\n+[      2       x 2*x + 1   x + 2       0]\n+[      0 2*x + 1       x       x       0]\n+[      1       1       2   x + 1       0]\n+sage: random_matrix(GF(9,'x'), 5)\n+[      x   x + 1       0       0       0]\n+[      1   x + 1       0 2*x + 1       0]\n+[      2       0       x   x + 2       0]\n+[      2       0   x + 1   x + 2       0]\n+[      x   x + 1     2*x       1       0]\n+```\n+So, the last column always is zero, which shouldn't be the case.\n \n Comment: 1\n \n```\n",
    "created_at": "2017-07-12T14:57:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344243",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,32 @@
+I just noticed that, when meataxe is installed and its Sage wrapper is used for matrices over `GF(p^n)` with `p` odd and `p^n<255`, then at least in some cases the random matrices aren't sufficiently random:
 
+```
+sage: random_matrix(GF(9,'x'), 5)
+[      x 2*x + 1   x + 2   x + 2       0]
+[  x + 1       x   x + 2   x + 1       0]
+[  x + 1       2   x + 1       2       0]
+[      x     2*x       x   x + 1       0]
+[2*x + 1       0 2*x + 1 2*x + 2       0]
+sage: random_matrix(GF(9,'x'), 5)
+[      2   x + 1   x + 1 2*x + 2       0]
+[      x 2*x + 2   x + 2     2*x       0]
+[  x + 2     2*x       0 2*x + 2       0]
+[    2*x       2       2       1       0]
+[  x + 2       2     2*x       1       0]
+sage: random_matrix(GF(9,'x'), 5)
+[      2 2*x + 1       x 2*x + 1       0]
+[2*x + 2       0 2*x + 2       x       0]
+[      2       x 2*x + 1   x + 2       0]
+[      0 2*x + 1       x       x       0]
+[      1       1       2   x + 1       0]
+sage: random_matrix(GF(9,'x'), 5)
+[      x   x + 1       0       0       0]
+[      1   x + 1       0 2*x + 1       0]
+[      2       0       x   x + 2       0]
+[      2       0   x + 1   x + 2       0]
+[      x   x + 1     2*x       1       0]
+```
+So, the last column always is zero, which shouldn't be the case.
 
 Comment: 1
 
```




---

archive/issue_comments_344244.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:14 SimonKing]:\n> The patches to be distributed are, as much as I see, independent. Would it be better to let the new tickets build upon each other (i.e., the git history of one ticket is included in the git history of the other tickets), or should they stay separate (i.e., each ticket provides a patch, and then they are merged only when needed)?\n\n\nThe ticket that is about sanitizing sig_on/off/check and about proper Cython code style has to depend on the other tickets. But I suggest to keep the other tickets separate as much as possible, and will soon push branches accordingly.",
    "created_at": "2017-07-12T15:01:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344244",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:16'></a>Replying to [comment:14 SimonKing]:
> The patches to be distributed are, as much as I see, independent. Would it be better to let the new tickets build upon each other (i.e., the git history of one ticket is included in the git history of the other tickets), or should they stay separate (i.e., each ticket provides a patch, and then they are merged only when needed)?


The ticket that is about sanitizing sig_on/off/check and about proper Cython code style has to depend on the other tickets. But I suggest to keep the other tickets separate as much as possible, and will soon push branches accordingly.



---

archive/issue_comments_344245.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-07-12T15:07:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344245",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_344246.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-07-12T15:10:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344246",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_344247.json:
```json
{
    "body": "<a id='comment:19'></a>In the splitup process, I have already updated #23410, #23411 and #23352, making them small and independent.\n\nAbout the other parts, I plan this:\n\n- We have #21437 for proper initialisation. I plan to try to make this stand-alone as well, but only if it cleanly merges with the afore-mentioned tickets. If it doesn't merge, I'll put it on top of the other tickets.\n- We have #23400 for code cleanup. The cleanup will also concern parts of code that are touched by the other tickets. So, it will use them as dependency.\n- We have #23399 for some additions (new methods). I very much doubt that it can stay separate, but I'll try. Very likely #23399 will be on top of all other tickets.\n\nJeroen, do you support my plan?",
    "created_at": "2017-07-12T16:05:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344247",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:19'></a>In the splitup process, I have already updated #23410, #23411 and #23352, making them small and independent.

About the other parts, I plan this:

- We have #21437 for proper initialisation. I plan to try to make this stand-alone as well, but only if it cleanly merges with the afore-mentioned tickets. If it doesn't merge, I'll put it on top of the other tickets.
- We have #23400 for code cleanup. The cleanup will also concern parts of code that are touched by the other tickets. So, it will use them as dependency.
- We have #23399 for some additions (new methods). I very much doubt that it can stay separate, but I'll try. Very likely #23399 will be on top of all other tickets.

Jeroen, do you support my plan?



---

archive/issue_comments_344248.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [comment:2 SimonKing]:\n> The matrix entries are densely packed in meataxe. Hence, in some situations, the last byte of a row in memory is only partly filled with data. And in fact the HIGHEST bits of the last byte have to be filled.\n> \n> The problem was: In the old code, the LOWEST bits of the last byte have been filled.\n\n\nIf I'm reading the documentation at http://www.math.rwth-aachen.de/~MTX/doc24/group__ff.html correctly, it should be the LOWEST bytes:\n\n> Packing of field elements is used for field orders less than 17. Let q be the field order and m the largest natural number with q<sup>m</sup>\u2264256. Then, m elements k<sub>0</sub>,...k<sub>n-1</sub> are packed into one byte as k<sub>0</sub>+k<sub>1</sub>q+k<sub>2</sub>q<sup>2</sup>+...",
    "created_at": "2017-07-13T14:47:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344248",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>Replying to [comment:2 SimonKing]:
> The matrix entries are densely packed in meataxe. Hence, in some situations, the last byte of a row in memory is only partly filled with data. And in fact the HIGHEST bits of the last byte have to be filled.
> 
> The problem was: In the old code, the LOWEST bits of the last byte have been filled.


If I'm reading the documentation at http://www.math.rwth-aachen.de/~MTX/doc24/group__ff.html correctly, it should be the LOWEST bytes:

> Packing of field elements is used for field orders less than 17. Let q be the field order and m the largest natural number with q<sup>m</sup>≤256. Then, m elements k<sub>0</sub>,...k<sub>n-1</sub> are packed into one byte as k<sub>0</sub>+k<sub>1</sub>q+k<sub>2</sub>q<sup>2</sup>+...



---

archive/issue_comments_344249.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [comment:20 jdemeyer]:\n> If I'm reading the documentation at http://www.math.rwth-aachen.de/~MTX/doc24/group__ff.html correctly, it should be the LOWEST bytes:\n> \n> > Packing of field elements is used for field orders less than 17. Let q be the field order and m the largest natural number with q<sup>m</sup>\u2264256. Then, m elements k<sub>0</sub>,...k<sub>n-1</sub> are packed into one byte as k<sub>0</sub>+k<sub>1</sub>q+k<sub>2</sub>q<sup>2</sup>+...\n\n\nYes, that's what I had in mind, too, and is why I wrote the old code in the way I did. Anyway, I am now using meataxe's `FfInsert`, which should do the right thing.\n\nLet's test: If I would set the last byte inconsistent with meataxe's conventions, then multiplying a matrix with the transposed matrix (these are all using meataxe functions) would give a wrong result. \n\n```\nsage: MS = MatrixSpace(GF(9,'x'),1,5)\nsage: def sanity_check(M):\n....:     assert (M*M.transpose())[0,0] == add(e*e for e in M.list())\n....:     \nsage: while(1):\n....:     sanity_check(MS.random_element())\n....:     \n```\nworks without error. Note that in the setting above, the new code is called. Thus, I believe my code is correct and indeed the meataxe documentation provides a wrong statement.",
    "created_at": "2017-07-13T15:13:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344249",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:21'></a>Replying to [comment:20 jdemeyer]:
> If I'm reading the documentation at http://www.math.rwth-aachen.de/~MTX/doc24/group__ff.html correctly, it should be the LOWEST bytes:
> 
> > Packing of field elements is used for field orders less than 17. Let q be the field order and m the largest natural number with q<sup>m</sup>≤256. Then, m elements k<sub>0</sub>,...k<sub>n-1</sub> are packed into one byte as k<sub>0</sub>+k<sub>1</sub>q+k<sub>2</sub>q<sup>2</sup>+...


Yes, that's what I had in mind, too, and is why I wrote the old code in the way I did. Anyway, I am now using meataxe's `FfInsert`, which should do the right thing.

Let's test: If I would set the last byte inconsistent with meataxe's conventions, then multiplying a matrix with the transposed matrix (these are all using meataxe functions) would give a wrong result. 

```
sage: MS = MatrixSpace(GF(9,'x'),1,5)
sage: def sanity_check(M):
....:     assert (M*M.transpose())[0,0] == add(e*e for e in M.list())
....:     
sage: while(1):
....:     sanity_check(MS.random_element())
....:     
```
works without error. Note that in the setting above, the new code is called. Thus, I believe my code is correct and indeed the meataxe documentation provides a wrong statement.



---

archive/issue_comments_344250.json:
```json
{
    "body": "<a id='comment:22'></a>While fixing the `randomize` method, I'd like to speed it up, by cdefining the randint function.",
    "created_at": "2017-07-14T12:03:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344250",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:22'></a>While fixing the `randomize` method, I'd like to speed it up, by cdefining the randint function.



---

archive/issue_comments_344251.json:
```json
{
    "body": "<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-14T12:33:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344251",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_344252.json:
```json
{
    "body": "<a id='comment:24'></a>Before the latest commit I got\n\n```\nsage: MS = MatrixSpace(GF(9,'x'),5,17)\nsage: %timeit MS.random_element()\nThe slowest run took 96.98 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 5.37 \u00b5s per loop\n```\n\nWith the latest commit, I get\n\n```\nsage: MS = MatrixSpace(GF(9,'x'),5,17)\nsage: %timeit MS.random_element()\nThe slowest run took 142.72 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 3.4 \u00b5s per loop\n```\n\nI think 35% gain is worth it. Also, since I'm touching the code anyway, I change to using range() in Cython.",
    "created_at": "2017-07-14T12:34:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344252",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:24'></a>Before the latest commit I got

```
sage: MS = MatrixSpace(GF(9,'x'),5,17)
sage: %timeit MS.random_element()
The slowest run took 96.98 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 5.37 µs per loop
```

With the latest commit, I get

```
sage: MS = MatrixSpace(GF(9,'x'),5,17)
sage: %timeit MS.random_element()
The slowest run took 142.72 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 3.4 µs per loop
```

I think 35% gain is worth it. Also, since I'm touching the code anyway, I change to using range() in Cython.



---

archive/issue_comments_344253.json:
```json
{
    "body": "<a id='comment:25'></a>PS: Since I am changing the code anyway, I guess I could also change the use of sig_on/off in that part of the code...",
    "created_at": "2017-07-14T12:52:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344253",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:25'></a>PS: Since I am changing the code anyway, I guess I could also change the use of sig_on/off in that part of the code...



---

archive/issue_comments_344254.json:
```json
{
    "body": "<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-14T12:56:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344254",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_344255.json:
```json
{
    "body": "<a id='comment:27'></a>After replacing sig_on/off by sig_check, I get\n\n```\nsage: MS = MatrixSpace(GF(9,'x'),5,17)\nsage: %timeit MS.random_element()\nThe slowest run took 146.35 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 3.05 \u00b5s per loop\n```\nThat's further 10% on top of the previous 35%.\n\nThat's slightly surprising to me. Is sig_on/off really resulting in a massive slow-down? Then why is it used? After all, another disadvantage is that it doesn't play well with Python code.",
    "created_at": "2017-07-14T12:59:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344255",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:27'></a>After replacing sig_on/off by sig_check, I get

```
sage: MS = MatrixSpace(GF(9,'x'),5,17)
sage: %timeit MS.random_element()
The slowest run took 146.35 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 3.05 µs per loop
```
That's further 10% on top of the previous 35%.

That's slightly surprising to me. Is sig_on/off really resulting in a massive slow-down? Then why is it used? After all, another disadvantage is that it doesn't play well with Python code.



---

archive/issue_comments_344256.json:
```json
{
    "body": "<a id='comment:28'></a>Replying to [comment:27 SimonKing]:\n> Is sig_on/off really resulting in a massive slow-down?\n\n\nIt shouldn't result in a *massive* slowdown. However, if you are using it in a very tight loop, the time taken by `sig_on()` is noticable.",
    "created_at": "2017-07-17T09:35:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344256",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:28'></a>Replying to [comment:27 SimonKing]:
> Is sig_on/off really resulting in a massive slow-down?


It shouldn't result in a *massive* slowdown. However, if you are using it in a very tight loop, the time taken by `sig_on()` is noticable.



---

archive/issue_comments_344257.json:
```json
{
    "body": "<a id='comment:29'></a>I should also mention that `sig_on()` is essentially just a call to `sigsetjmp()`. This is a function implemented by `libc` from the OS. So the time taken by `sig_on()` could depend significantly on the system.",
    "created_at": "2017-07-17T09:38:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344257",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:29'></a>I should also mention that `sig_on()` is essentially just a call to `sigsetjmp()`. This is a function implemented by `libc` from the OS. So the time taken by `sig_on()` could depend significantly on the system.



---

archive/issue_comments_344258.json:
```json
{
    "body": "<a id='comment:30'></a>Can the review please be finished?",
    "created_at": "2017-08-18T14:23:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344258",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:30'></a>Can the review please be finished?



---

archive/issue_comments_344259.json:
```json
{
    "body": "<a id='comment:31'></a>The branch does not apply on latest beta.",
    "created_at": "2017-08-21T08:02:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344259",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:31'></a>The branch does not apply on latest beta.



---

archive/issue_comments_344260.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-08-21T08:02:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344260",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_344261.json:
```json
{
    "body": "<a id='comment:32'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-08-21T10:40:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344261",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:32'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_344262.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-08-21T10:41:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344262",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_344263.json:
```json
{
    "body": "<a id='comment:33'></a>Replying to [comment:31 chapoton]:\n> The branch does not apply on latest beta.\n\n\nThanks. Fixed now...",
    "created_at": "2017-08-21T10:41:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344263",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:33'></a>Replying to [comment:31 chapoton]:
> The branch does not apply on latest beta.


Thanks. Fixed now...



---

archive/issue_comments_344264.json:
```json
{
    "body": "Changing keywords from \"meataxe random\" to \"meataxe random, days88, IMA coding sprints\".",
    "created_at": "2017-08-25T22:39:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344264",
    "user": "https://github.com/tscrim"
}
```

Changing keywords from "meataxe random" to "meataxe random, days88, IMA coding sprints".



---

archive/issue_events_060101.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2017-08-25T22:39:38Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "milestone": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23352#event-60101"
}
```



---

archive/issue_comments_344265.json:
```json
{
    "body": "<a id='comment:34'></a>Let it be so.",
    "created_at": "2017-08-25T22:39:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344265",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:34'></a>Let it be so.



---

archive/issue_comments_344266.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-08-25T22:39:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344266",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_344267.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-08-29T19:51:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23352#issuecomment-344267",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_060102.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-08-29T19:51:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23352",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23352#event-60102"
}
```
