# Issue 23807: different affine patches are the same object in memory

archive/issues_023570.json:
```json
{
    "assignees": [],
    "body": "<div id=\"comment:0\"></div>\n\nCurrently\n\n```\nsage: PP = ProjectiveSpace(QQ,1)\nsage: AA = PP.affine_patch(0)\nsage: BB = PP.affine_patch(1)\nsage: AA is BB\nTrue\n```\nThese patches are isomorphic, but should not be the same object.\n\nFinally, since this ticket is discovering modification of global immutable objects, I think it deserves status \"major\" at the very least.\n\nCC:  @pfili @sagetrac-atowsley @pjbruin @tscrim\n\nComponent: **algebraic geometry**\n\nKeywords: **sagedays@icerm, gsoc2018**\n\nAuthor: **Ben Hutz, Peter Bruin, Raghukul Raman**\n\nBranch/Commit: **[`e67687d`](https://github.com/sagemath/sagetrac-mirror/commit/e67687d5ddfa5a3338209859981b915d6545494a)**\n\nReviewer: **Ben Hutz, Travis Scrimshaw**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/23807_\n\n",
    "closed_at": "2018-12-01T13:43:36Z",
    "created_at": "2017-09-08T15:53:33Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20algebraic%20geometry",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.5",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "different affine patches are the same object in memory",
    "type": "issue",
    "updated_at": "2018-12-01T13:43:36Z",
    "url": "https://github.com/sagemath/sage/issues/23807",
    "user": "https://github.com/bhutz"
}
```
<div id="comment:0"></div>

Currently

```
sage: PP = ProjectiveSpace(QQ,1)
sage: AA = PP.affine_patch(0)
sage: BB = PP.affine_patch(1)
sage: AA is BB
True
```
These patches are isomorphic, but should not be the same object.

Finally, since this ticket is discovering modification of global immutable objects, I think it deserves status "major" at the very least.

CC:  @pfili @sagetrac-atowsley @pjbruin @tscrim

Component: **algebraic geometry**

Keywords: **sagedays@icerm, gsoc2018**

Author: **Ben Hutz, Peter Bruin, Raghukul Raman**

Branch/Commit: **[`e67687d`](https://github.com/sagemath/sagetrac-mirror/commit/e67687d5ddfa5a3338209859981b915d6545494a)**

Reviewer: **Ben Hutz, Travis Scrimshaw**

_Issue created by migration from https://trac.sagemath.org/ticket/23807_





---

archive/issue_events_327881.json:
```json
{
    "actor": "https://github.com/bhutz",
    "created_at": "2017-09-08T15:53:33Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "milestone_number": null,
    "milestone_title": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23807#event-327881"
}
```



---

archive/issue_events_327882.json:
```json
{
    "actor": "https://github.com/bhutz",
    "created_at": "2017-09-08T15:53:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20algebraic%20geometry",
    "label_color": "0000ff",
    "label_name": "c: algebraic geometry",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23807#event-327882"
}
```



---

archive/issue_events_327883.json:
```json
{
    "actor": "https://github.com/bhutz",
    "created_at": "2017-09-08T15:53:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20minor%20/%204",
    "label_color": "ffe799",
    "label_name": "p: minor / 4",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23807#event-327883"
}
```



---

archive/issue_events_327884.json:
```json
{
    "actor": "https://github.com/bhutz",
    "created_at": "2017-09-08T15:53:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23807#event-327884"
}
```



---

archive/issue_comments_359007.json:
```json
{
    "body": "Author: **paulfili, atowsley**",
    "created_at": "2017-09-08T17:34:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359007",
    "user": "https://github.com/bhutz"
}
```

Author: **paulfili, atowsley**



---

archive/issue_comments_359008.json:
```json
{
    "body": "Commit: **[`f143fb8`](https://github.com/sagemath/sagetrac-mirror/commit/f143fb8c49a9d5ecc19d858fec501e3452ebfae6)**",
    "created_at": "2017-09-08T17:34:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359008",
    "user": "https://github.com/bhutz"
}
```

Commit: **[`f143fb8`](https://github.com/sagemath/sagetrac-mirror/commit/f143fb8c49a9d5ecc19d858fec501e3452ebfae6)**



---

archive/issue_events_327885.json:
```json
{
    "actor": "https://github.com/bhutz",
    "created_at": "2017-09-08T17:34:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23807#event-327885"
}
```



---

archive/issue_comments_359009.json:
```json
{
    "body": "Branch: **[u/bhutz/affine_patch_23807](https://github.com/sagemath/sagetrac-mirror/tree/u/bhutz/affine_patch_23807)**",
    "created_at": "2017-09-08T17:34:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359009",
    "user": "https://github.com/bhutz"
}
```

Branch: **[u/bhutz/affine_patch_23807](https://github.com/sagemath/sagetrac-mirror/tree/u/bhutz/affine_patch_23807)**



---

archive/issue_comments_359010.json:
```json
{
    "body": "<div id=\"comment:1\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f143fb8c49a9d5ecc19d858fec501e3452ebfae6\"><code>f143fb8</code></a></td><td><code>23807: make affine patches distinct objects</code></td></tr></table>\n",
    "created_at": "2017-09-08T17:34:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359010",
    "user": "https://github.com/bhutz"
}
```

<div id="comment:1"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f143fb8c49a9d5ecc19d858fec501e3452ebfae6"><code>f143fb8</code></a></td><td><code>23807: make affine patches distinct objects</code></td></tr></table>




---

archive/issue_comments_359011.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nI'm not sure that your solution is the best fix for the underlying problem.  This discrepency seems strange:\n\n```\nsage: AffineSpace(QQ,2) is AffineSpace(QQ,2)\nTrue\nsage: ProjectiveSpace(QQ,2) is ProjectiveSpace(QQ,2)\nFalse\n```\nMaybe `AffineSpace` shouldn't be unique, for the same reasons `ProjectiveSpace` isn't?",
    "created_at": "2017-09-08T17:41:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359011",
    "user": "https://github.com/roed314"
}
```

<div id="comment:2" align="right">comment:2</div>

I'm not sure that your solution is the best fix for the underlying problem.  This discrepency seems strange:

```
sage: AffineSpace(QQ,2) is AffineSpace(QQ,2)
True
sage: ProjectiveSpace(QQ,2) is ProjectiveSpace(QQ,2)
False
```
Maybe `AffineSpace` shouldn't be unique, for the same reasons `ProjectiveSpace` isn't?



---

archive/issue_events_327886.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2017-09-08T22:13:22Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20minor%20/%204",
    "label_color": "ffe799",
    "label_name": "p: minor / 4",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23807#event-327886"
}
```



---

archive/issue_events_327887.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2017-09-08T22:13:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23807#event-327887"
}
```



---

archive/issue_comments_359012.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nChanging `AffineScheme` (yes, it's that high up) to `UniqueRepresentation` happened on:\nhttps://github.com/sagemath/sage/issues/17008\n\nIt was already predicted we'd be having unintended consequences from this and indeed here we are.\n\nIf we're keeping UniqueRepresentation, then we must make AfffineSpace immutable. In `affine_patch` we have this line:\n\n```\n        AA._default_embedding_index = i\n```\n(where AA is either a freshly constructed affine space or an affine space that was passed in). We can't make that change, so\n* AA as an optional parameter to `affine_patch` must be removed\n* `_default_embedding_index` must be a construction parameter to `AffineSpace` (if the default is \"None\" and the projective closure of the space is asked, a projective space should be created and the right affine patch should be forced into the projective space -- clearly projective spaces are caching their affine patches, not the other way around)\n* If affine space is going to be `UniqueRep` then it should probably cache projective space rather than the other way around. We already have a problem there now:\n\n```\nsage: P2.<x,y,z>=ProjectiveSpace(QQ,2);\nsage: A=P2.affine_patch(2)\nsage: A.projective_embedding() == P2\nFalse\n```\n(the variable names get lost)\n* I would recommend using something along the lines of\n\n```\n    names=[repr(a) for a in self.gens()]\n    names.pop(i)\n    AA = AffineSpace(n, self.base_ring(), names = names, default_embedding_index = i)\n```\nto get generator names. Given that we cannot make assumptions on what the variable names of the projective space are, I don't think we can do much else than just dropping the variable name whose hyperplane we're removing. If you do want to have a modification, perhaps something like\n\n```\n[repr(a)+\"_aff\" for a in self.gens()]\n```\nor so.\n\n**EDIT:** I think we're forced to choose between the following:\n* Ditch `UniqueRepresentation` on `AffineSpace`\n* Ditch `default_embedding` entirely and accept that one cannot get back projective closures from affine patches (in fact that's already not really possible anyway).\n* make `ProjectiveSpace` also into `UniqueRepresentation`.\nThe reason is that with unique rep affine spaces, we're always going to have an issue with\n\n```\nP2a.<x,y,z>=ProjectiveSpace(QQ,2)\nAa=P2a.affine_patch(0)\nP2b.<x,y,z>=ProjectiveSpace(QQ,2)\nAb=P2b.affine_patch(0)\n```\nWith `UniqueRepresentation`, we're going to have that Aa is identical to Ab, because there's no info to distinguish the two, so there's no room for `Aa` and `Ab` to lead back to `P2a` and `P2b` respectively.",
    "created_at": "2017-09-08T22:13:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359012",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:3" align="right">comment:3</div>

Changing `AffineScheme` (yes, it's that high up) to `UniqueRepresentation` happened on:
https://github.com/sagemath/sage/issues/17008

It was already predicted we'd be having unintended consequences from this and indeed here we are.

If we're keeping UniqueRepresentation, then we must make AfffineSpace immutable. In `affine_patch` we have this line:

```
        AA._default_embedding_index = i
```
(where AA is either a freshly constructed affine space or an affine space that was passed in). We can't make that change, so
* AA as an optional parameter to `affine_patch` must be removed
* `_default_embedding_index` must be a construction parameter to `AffineSpace` (if the default is "None" and the projective closure of the space is asked, a projective space should be created and the right affine patch should be forced into the projective space -- clearly projective spaces are caching their affine patches, not the other way around)
* If affine space is going to be `UniqueRep` then it should probably cache projective space rather than the other way around. We already have a problem there now:

```
sage: P2.<x,y,z>=ProjectiveSpace(QQ,2);
sage: A=P2.affine_patch(2)
sage: A.projective_embedding() == P2
False
```
(the variable names get lost)
* I would recommend using something along the lines of

```
    names=[repr(a) for a in self.gens()]
    names.pop(i)
    AA = AffineSpace(n, self.base_ring(), names = names, default_embedding_index = i)
```
to get generator names. Given that we cannot make assumptions on what the variable names of the projective space are, I don't think we can do much else than just dropping the variable name whose hyperplane we're removing. If you do want to have a modification, perhaps something like

```
[repr(a)+"_aff" for a in self.gens()]
```
or so.

**EDIT:** I think we're forced to choose between the following:
* Ditch `UniqueRepresentation` on `AffineSpace`
* Ditch `default_embedding` entirely and accept that one cannot get back projective closures from affine patches (in fact that's already not really possible anyway).
* make `ProjectiveSpace` also into `UniqueRepresentation`.
The reason is that with unique rep affine spaces, we're always going to have an issue with

```
P2a.<x,y,z>=ProjectiveSpace(QQ,2)
Aa=P2a.affine_patch(0)
P2b.<x,y,z>=ProjectiveSpace(QQ,2)
Ab=P2b.affine_patch(0)
```
With `UniqueRepresentation`, we're going to have that Aa is identical to Ab, because there's no info to distinguish the two, so there's no room for `Aa` and `Ab` to lead back to `P2a` and `P2b` respectively.



---

archive/issue_events_327888.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2017-09-08T22:13:22Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23807#event-327888"
}
```



---

archive/issue_events_327889.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2017-09-08T22:13:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23807#event-327889"
}
```



---

archive/issue_comments_359013.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -8,3 +8,5 @@\n True\n ```\n These patches are isomorphic, but should not be the same object.\n+\n+Finally, since this ticket is discovering modification of global immutable objects, I think it deserves status \"major\" at the very least.\n``````\n",
    "created_at": "2017-09-08T22:13:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359013",
    "user": "https://github.com/nbruin"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -8,3 +8,5 @@
 True
 ```
 These patches are isomorphic, but should not be the same object.
+
+Finally, since this ticket is discovering modification of global immutable objects, I think it deserves status "major" at the very least.
``````




---

archive/issue_comments_359014.json:
```json
{
    "body": "Changed author from **paulfili, atowsley** to **Ben Hutz**",
    "created_at": "2017-09-08T22:39:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359014",
    "user": "https://github.com/bhutz"
}
```

Changed author from **paulfili, atowsley** to **Ben Hutz**



---

archive/issue_comments_359015.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nOne correction as it affects choice (2): .projective_embedding is just the map, you are trying to compare to the codomain, and that works.\n\n```\nsage: P2.<x,y,z>=ProjectiveSpace(QQ,2);\nsage: A=P2.affine_patch(2)\nsage: A.projective_embedding().codomain() == P2\nTrue\n}}\n```",
    "created_at": "2017-09-08T22:39:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359015",
    "user": "https://github.com/bhutz"
}
```

<div id="comment:4" align="right">comment:4</div>

One correction as it affects choice (2): .projective_embedding is just the map, you are trying to compare to the codomain, and that works.

```
sage: P2.<x,y,z>=ProjectiveSpace(QQ,2);
sage: A=P2.affine_patch(2)
sage: A.projective_embedding().codomain() == P2
True
}}
```



---

archive/issue_comments_359016.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nReplying to [@bhutz](#comment%3A4):\n> One correction as it affects choice (2): .projective_embedding is just the map, you are trying to compare to the codomain, and that works.\n> \n> ```\n> sage: P2.<x,y,z>=ProjectiveSpace(QQ,2);\n> sage: A=P2.affine_patch(2)\n> sage: A.projective_embedding().codomain() == P2\n> True\n> }}\n> \n> ```\n\nThanks! In fact:\n\n```\nsage: A.projective_embedding().codomain() is P2\nTrue\n```\nThat's what I originally expected to hold. It shows that A caches P2 somewhere, which makes the global modification stuff even worse.",
    "created_at": "2017-09-08T23:05:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359016",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:5" align="right">comment:5</div>

Replying to [@bhutz](#comment%3A4):
> One correction as it affects choice (2): .projective_embedding is just the map, you are trying to compare to the codomain, and that works.
> 
> ```
> sage: P2.<x,y,z>=ProjectiveSpace(QQ,2);
> sage: A=P2.affine_patch(2)
> sage: A.projective_embedding().codomain() == P2
> True
> }}
> 
> ```

Thanks! In fact:

```
sage: A.projective_embedding().codomain() is P2
True
```
That's what I originally expected to hold. It shows that A caches P2 somewhere, which makes the global modification stuff even worse.



---

archive/issue_comments_359017.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nThe affine_patch function and the projective_embedding function update a dictionary object associated to the affine or projective space for caching of these associations.  So making those spaces immutable would totally break that functionality.\n\nI personally don't like using unique representation here, but was not involved in the changes you cited that added that. Is it even reasonable to consider undoing that?\n\nAlternatively, it seems perhaps going unique everywhere is the next alternative. But I'm not sure how hard it would be to preserve the connections between embeddings and patches.",
    "created_at": "2017-09-08T23:15:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359017",
    "user": "https://github.com/bhutz"
}
```

<div id="comment:6" align="right">comment:6</div>

The affine_patch function and the projective_embedding function update a dictionary object associated to the affine or projective space for caching of these associations.  So making those spaces immutable would totally break that functionality.

I personally don't like using unique representation here, but was not involved in the changes you cited that added that. Is it even reasonable to consider undoing that?

Alternatively, it seems perhaps going unique everywhere is the next alternative. But I'm not sure how hard it would be to preserve the connections between embeddings and patches.



---

archive/issue_comments_359018.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nReplying to [@bhutz](#comment%3A6):\n> I personally don't like using unique representation here, but was not involved in the changes you cited that added that. Is it even reasonable to consider undoing that?\n> \n> Alternatively, it seems perhaps going unique everywhere is the next alternative. But I'm not sure how hard it would be to preserve the connections between embeddings and patches.\n\nI think both are reasonable solutions. I don't like `UniqueRepresentation` either, so I'd have a slight preference for the former.",
    "created_at": "2017-09-09T06:32:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359018",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:7" align="right">comment:7</div>

Replying to [@bhutz](#comment%3A6):
> I personally don't like using unique representation here, but was not involved in the changes you cited that added that. Is it even reasonable to consider undoing that?
> 
> Alternatively, it seems perhaps going unique everywhere is the next alternative. But I'm not sure how hard it would be to preserve the connections between embeddings and patches.

I think both are reasonable solutions. I don't like `UniqueRepresentation` either, so I'd have a slight preference for the former.



---

archive/issue_comments_359019.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nHere is another unfortunate current behavior\n\n```\nsage: A.<x,y>=AffineSpace(QQ,2)\nsage: B.<x,y>=AffineSpace(QQ,2)\nsage: A is B\nTrue\nsage: X = A.subscheme(x-y)\nsage: Y = B.subscheme(x-y)\nsage: X is Y\nFalse\n```\n\nSimilar example, but more complicated in construction\n\n```\nsage: P.<x,y,z>=ProjectiveSpace(QQ,2)\nsage: P2.<x,y,z> = ProjectiveSpace(QQ,2)\nsage: X = P.subscheme(x-y)\nsage: Y = P2.subscheme(x-y)\nsage: X == Y, X is Y\nTrue, False\nsage: A = X.affine_patch(0)\nsage: B = Y.affine_patch(0)\nsage: A == B, A is B, A.ambient_space() is B.ambient_space()\n(True, False, True)\nsage: B.projective_embedding().codomain() == Y\nTrue\nsage: B.projective_embedding().codomain() is Y\nFalse\nsage: B.projective_embedding().codomain().ambient_space() is P2\nTrue\n```",
    "created_at": "2017-09-09T12:48:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359019",
    "user": "https://github.com/bhutz"
}
```

<div id="comment:8" align="right">comment:8</div>

Here is another unfortunate current behavior

```
sage: A.<x,y>=AffineSpace(QQ,2)
sage: B.<x,y>=AffineSpace(QQ,2)
sage: A is B
True
sage: X = A.subscheme(x-y)
sage: Y = B.subscheme(x-y)
sage: X is Y
False
```

Similar example, but more complicated in construction

```
sage: P.<x,y,z>=ProjectiveSpace(QQ,2)
sage: P2.<x,y,z> = ProjectiveSpace(QQ,2)
sage: X = P.subscheme(x-y)
sage: Y = P2.subscheme(x-y)
sage: X == Y, X is Y
True, False
sage: A = X.affine_patch(0)
sage: B = Y.affine_patch(0)
sage: A == B, A is B, A.ambient_space() is B.ambient_space()
(True, False, True)
sage: B.projective_embedding().codomain() == Y
True
sage: B.projective_embedding().codomain() is Y
False
sage: B.projective_embedding().codomain().ambient_space() is P2
True
```



---

archive/issue_comments_359020.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nAdding Peter Bruin, since the effects seen here are a direct result of his modifications on #17008. He might have an idea on how to fix this.\n\nOptions I see:\n\n* Undo `UniqueRepresentation` on (some) schemes and deal with ensuing problems in another way\n\n* Go all-the-way on making schemes `UniqueRepresentation`, which is going to take a lot of design consideration because it means they *really* need to be immutable)\n\nI'd expect that anything in between is going to be very hard to reason about (as it turns out: anything involving `UniqueRepresentation` is hard to reason/program with in practice, because of Python's imperative streak: people get used to modifying objects)\n\n**EDIT:** The real problem I see on #17008 is that consistent production of point sets relies on the fact that `schemes.generic.scheme.point_homset` is cached. So, in `SchemeHomset_generic.__reduce__` we need to do something along the lines of:\n\n```\nif <self> is the result of self.codomain().pointset(...):\n  return PointSet,(self.codomain(),self.domain().ring_this_is_spec_of())\nelse:\n  return what we did before\n```\nin order to give the cache a shot at kicking in. Once we do that, the `UniqueRepresentation` from #17008 shouldn't be necessary for the problem encountered there.\n\nNote that this applies to *all* cached routines: once you cache something, you should rewrite the pickler to allow a chance for the cache to do the lookup for you.",
    "created_at": "2017-09-10T21:54:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359020",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:9" align="right">comment:9</div>

Adding Peter Bruin, since the effects seen here are a direct result of his modifications on #17008. He might have an idea on how to fix this.

Options I see:

* Undo `UniqueRepresentation` on (some) schemes and deal with ensuing problems in another way

* Go all-the-way on making schemes `UniqueRepresentation`, which is going to take a lot of design consideration because it means they *really* need to be immutable)

I'd expect that anything in between is going to be very hard to reason about (as it turns out: anything involving `UniqueRepresentation` is hard to reason/program with in practice, because of Python's imperative streak: people get used to modifying objects)

**EDIT:** The real problem I see on #17008 is that consistent production of point sets relies on the fact that `schemes.generic.scheme.point_homset` is cached. So, in `SchemeHomset_generic.__reduce__` we need to do something along the lines of:

```
if <self> is the result of self.codomain().pointset(...):
  return PointSet,(self.codomain(),self.domain().ring_this_is_spec_of())
else:
  return what we did before
```
in order to give the cache a shot at kicking in. Once we do that, the `UniqueRepresentation` from #17008 shouldn't be necessary for the problem encountered there.

Note that this applies to *all* cached routines: once you cache something, you should rewrite the pickler to allow a chance for the cache to do the lookup for you.



---

archive/issue_comments_359021.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nAn argument FOR some `UniqueRepresentation`: the construct `AffineScheme` is really just `Spec`. Every ring HAS a spec associated with it, so it would be defendable to make sure that the `Spec` of a ring can be obtained from the ring reliably. This could be done by caching the thing on the ring and obtaining it from there, but since it's possible to have a ring without a spec but not its spec without the ring, the spec should probably be allowed to be GCed even when the ring is still around. A `UniqueRepresentation` construction does that.\n\nIf we go this route, then obviously we need a unique polynomial ring for each affine patch for each projective space that we construct. I doubt we can key polynomial rings with projective spaces ... (that's a memory leak waiting to happen). The possibility for registering a new default embedding on a spec would need to go away.",
    "created_at": "2017-09-11T17:25:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359021",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:10" align="right">comment:10</div>

An argument FOR some `UniqueRepresentation`: the construct `AffineScheme` is really just `Spec`. Every ring HAS a spec associated with it, so it would be defendable to make sure that the `Spec` of a ring can be obtained from the ring reliably. This could be done by caching the thing on the ring and obtaining it from there, but since it's possible to have a ring without a spec but not its spec without the ring, the spec should probably be allowed to be GCed even when the ring is still around. A `UniqueRepresentation` construction does that.

If we go this route, then obviously we need a unique polynomial ring for each affine patch for each projective space that we construct. I doubt we can key polynomial rings with projective spaces ... (that's a memory leak waiting to happen). The possibility for registering a new default embedding on a spec would need to go away.



---

archive/issue_comments_359022.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nSure, I see that line of reasoning, and that is essentially what the branch on this ticket is doing (fixing the naming of the affine patches).\n\nBut if we go this route (which I'm not yet convinced of) then we'd still need to think about what things should be immutable and how that affects the connection between patches and embeddings. Not to mention fixing some of those examples involving subschemes which should also be unique by the same argument.\n\nI'd still like to see peter's response concerning adding uniquerepresentation before making a plan.",
    "created_at": "2017-09-11T19:09:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359022",
    "user": "https://github.com/bhutz"
}
```

<div id="comment:11" align="right">comment:11</div>

Sure, I see that line of reasoning, and that is essentially what the branch on this ticket is doing (fixing the naming of the affine patches).

But if we go this route (which I'm not yet convinced of) then we'd still need to think about what things should be immutable and how that affects the connection between patches and embeddings. Not to mention fixing some of those examples involving subschemes which should also be unique by the same argument.

I'd still like to see peter's response concerning adding uniquerepresentation before making a plan.



---

archive/issue_comments_359023.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@bhutz](#comment%3A11):\n> Sure, I see that line of reasoning, and that is essentially what the branch on this ticket is doing (fixing the naming of the affine patches).\n\nYes, but see the example in [comment:3](#comment%3A3). Just keying on variable names makes things slightly better, but not sufficient. Even putting the ProjectiveSpace as part of the construction keys for the affine patches wouldn't save us because\n\n```\nsage: ProjectiveSpace(QQ,1)==ProjectiveSpace(QQ,1)\nTrue\n```\n\n`UniqueRepresentation` is like a virus ...\n\n> But if we go this route (which I'm not yet convinced of) then we'd still need to think about what things should be immutable and how that affects the connection between patches and embeddings. Not to mention fixing some of those examples involving subschemes which should also be unique by the same argument.\n\nI'm not so sure that the same argument applies: While subschemes of affine schemes may be affine again (and hence a spec of something), that's not how they are constructed in your examples. Since they are not primarily \"the spec\" of a ring to begin with, I don't think there's the same urgency. Obviously, spec of the coordinate ring would hopefully give the subscheme back, but I'm not sure we're supporting that, and I think we could live without that (for now).\n\nThat being said, it seems that having some schemes `UR` and other not is going to be incredibly painful.",
    "created_at": "2017-09-11T20:00:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359023",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@bhutz](#comment%3A11):
> Sure, I see that line of reasoning, and that is essentially what the branch on this ticket is doing (fixing the naming of the affine patches).

Yes, but see the example in [comment:3](#comment%3A3). Just keying on variable names makes things slightly better, but not sufficient. Even putting the ProjectiveSpace as part of the construction keys for the affine patches wouldn't save us because

```
sage: ProjectiveSpace(QQ,1)==ProjectiveSpace(QQ,1)
True
```

`UniqueRepresentation` is like a virus ...

> But if we go this route (which I'm not yet convinced of) then we'd still need to think about what things should be immutable and how that affects the connection between patches and embeddings. Not to mention fixing some of those examples involving subschemes which should also be unique by the same argument.

I'm not so sure that the same argument applies: While subschemes of affine schemes may be affine again (and hence a spec of something), that's not how they are constructed in your examples. Since they are not primarily "the spec" of a ring to begin with, I don't think there's the same urgency. Obviously, spec of the coordinate ring would hopefully give the subscheme back, but I'm not sure we're supporting that, and I think we could live without that (for now).

That being said, it seems that having some schemes `UR` and other not is going to be incredibly painful.



---

archive/issue_comments_359024.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nA useful way to store the patches/embeddings, which allows us to keep `UniqueRepresentation` for affine schemes (I am strongly in favour of keeping unique representation for the reason Nils mentioned in comment;10) would be the \"structure\" construction that is currently used for number fields (introduced by Julian R\u00fcth in #11670).\n\nThe idea of \"structure\" is the following: number fields have unique representation, but the defining data of a number field includes an optional description of how it relates to another number field.  In this way, you can create a number field either on its own or (for example) as a subfield of a different number field.  See `sage/rings/number_field/structure.py` for details.\n\nAnalogously, we could use this construction to create, say, both an affine space on its own and a different affine space that is abstractly the same as the first one but is equipped with the extra structure of being an affine patch of a given projective space, or a closed subscheme of another scheme.\n\nOne advantage is that this would make it easier to reason about our objects, as well as to pickle them, because it is specified exactly what the defining data of a given scheme is.  We do probably have to think about where/how to store the \"structure\" in such a way that we avoid memory leaks.",
    "created_at": "2017-09-12T08:36:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359024",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:13" align="right">comment:13</div>

A useful way to store the patches/embeddings, which allows us to keep `UniqueRepresentation` for affine schemes (I am strongly in favour of keeping unique representation for the reason Nils mentioned in comment;10) would be the "structure" construction that is currently used for number fields (introduced by Julian Rüth in #11670).

The idea of "structure" is the following: number fields have unique representation, but the defining data of a number field includes an optional description of how it relates to another number field.  In this way, you can create a number field either on its own or (for example) as a subfield of a different number field.  See `sage/rings/number_field/structure.py` for details.

Analogously, we could use this construction to create, say, both an affine space on its own and a different affine space that is abstractly the same as the first one but is equipped with the extra structure of being an affine patch of a given projective space, or a closed subscheme of another scheme.

One advantage is that this would make it easier to reason about our objects, as well as to pickle them, because it is specified exactly what the defining data of a given scheme is.  We do probably have to think about where/how to store the "structure" in such a way that we avoid memory leaks.



---

archive/issue_comments_359025.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@pjbruin](#comment%3A13):\n> A useful way to store the patches/embeddings, which allows us to keep `UniqueRepresentation` for affine schemes (I am strongly in favour of keeping unique representation for the reason Nils mentioned in comment;10) would be the \"structure\" construction that is currently used for number fields (introduced by Julian R\u00fcth in #11670).\n\nThat construction is a complete memory leak. For instance:\n\n```\nsage: u=id(NumberField(x^2+1,name=\"a\").absolute_field('b'))\nsage: import gc\nsage: gc.collect()\n65\nsage: [type(v) for v in gc.get_objects() if id(v)==u]\n[<class 'sage.rings.number_field.number_field.NumberField_quadratic_with_category'>]\n```\n\nThis leaks for the following reason. If we do:\n\n```\nsage: K.<a>=NumberField(x^2+1)\nsage: L.<b>=K.absolute_field()\nsage: L._structure._reduction[1][0] is K\nTrue\n```\nWe see that `L` has a strong link to `K`. So `L` will now keep `K` alive. What's more, via `sage.rings.number_field.number_field.NumberField_version2._cache` there's now a strong global link to `K` as a key in a `WeakValueDictionary` with value `L`, so as long as `L` is alive, `K` will be reachable (and not just part of a cycle).\n\nSo, if `K` somehow references `L` then `K` and `L` will not be collected. And here it is:\n\n```\nsage: K._cache__absolute_field.values()[0] is L\nTrue\n```\n\nNote that in principle it's fine for `L` and `K` to reference each other: the cyclic garbage collector will find those dead cycles just fine. The problem is that by using any of `L` and `K` as part of a key in a `UniqueFactory` or similar, you're getting a strong reference to the cycle. So the key now keeps the value in the `WeakValueDictionary` alive.\n\nAn important part of the problem is a double caching strategy: `UniqueFactory` already provides caching. `absolute_field` implements its own cache. With the introduction of `structure` the first caching has been made a little better. But that now clashes with the second caching.\n\nThe situation might be slightly better if `absolute_field` were non-caching, but it could well be that the required computations to arrive at the key under which the other cache operates are now too expensive. One of the reasons why `UniqueRepresentation` etc. is so insidious is because it forces a caching strategy in one place, which precludes caching from being used elsewhere.\n\nIn this case a solution could be to implement `absolute_field` as:\n\n```\n@cached_method\ndef compute_absolute_field_data(...):\n...\n\ndef absolute_field(...):\n   data = self.compute_absolute_field_data(...)\n   L = NumberField(data,...)\n   return L\n```\nso that the expensive data gets stored without creating or referencing the field that can be constructed with it.",
    "created_at": "2017-09-13T00:08:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359025",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@pjbruin](#comment%3A13):
> A useful way to store the patches/embeddings, which allows us to keep `UniqueRepresentation` for affine schemes (I am strongly in favour of keeping unique representation for the reason Nils mentioned in comment;10) would be the "structure" construction that is currently used for number fields (introduced by Julian Rüth in #11670).

That construction is a complete memory leak. For instance:

```
sage: u=id(NumberField(x^2+1,name="a").absolute_field('b'))
sage: import gc
sage: gc.collect()
65
sage: [type(v) for v in gc.get_objects() if id(v)==u]
[<class 'sage.rings.number_field.number_field.NumberField_quadratic_with_category'>]
```

This leaks for the following reason. If we do:

```
sage: K.<a>=NumberField(x^2+1)
sage: L.<b>=K.absolute_field()
sage: L._structure._reduction[1][0] is K
True
```
We see that `L` has a strong link to `K`. So `L` will now keep `K` alive. What's more, via `sage.rings.number_field.number_field.NumberField_version2._cache` there's now a strong global link to `K` as a key in a `WeakValueDictionary` with value `L`, so as long as `L` is alive, `K` will be reachable (and not just part of a cycle).

So, if `K` somehow references `L` then `K` and `L` will not be collected. And here it is:

```
sage: K._cache__absolute_field.values()[0] is L
True
```

Note that in principle it's fine for `L` and `K` to reference each other: the cyclic garbage collector will find those dead cycles just fine. The problem is that by using any of `L` and `K` as part of a key in a `UniqueFactory` or similar, you're getting a strong reference to the cycle. So the key now keeps the value in the `WeakValueDictionary` alive.

An important part of the problem is a double caching strategy: `UniqueFactory` already provides caching. `absolute_field` implements its own cache. With the introduction of `structure` the first caching has been made a little better. But that now clashes with the second caching.

The situation might be slightly better if `absolute_field` were non-caching, but it could well be that the required computations to arrive at the key under which the other cache operates are now too expensive. One of the reasons why `UniqueRepresentation` etc. is so insidious is because it forces a caching strategy in one place, which precludes caching from being used elsewhere.

In this case a solution could be to implement `absolute_field` as:

```
@cached_method
def compute_absolute_field_data(...):
...

def absolute_field(...):
   data = self.compute_absolute_field_data(...)
   L = NumberField(data,...)
   return L
```
so that the expensive data gets stored without creating or referencing the field that can be constructed with it.



---

archive/issue_comments_359026.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nReplying to [@nbruin](#comment%3A14):\n> Replying to [@pjbruin](#comment%3A13):\n> > A useful way to store the patches/embeddings, which allows us to keep `UniqueRepresentation` for affine schemes (I am strongly in favour of keeping unique representation for the reason Nils mentioned in comment;10) would be the \"structure\" construction that is currently used for number fields (introduced by Julian R\u00fcth in #11670).\n> \n> \n> That construction is a complete memory leak.\n\nOuch.  It seems that neither the author nor the reviewers of #11670 (including me) paid attention to memory leaks.\n\n> In this case a solution could be to implement `absolute_field` as:\n> \n> ```\n> @cached_method\n> def compute_absolute_field_data(...):\n> ...\n> \n> def absolute_field(...):\n>    data = self.compute_absolute_field_data(...)\n>    L = NumberField(data,...)\n>    return L\n> ```\n> so that the expensive data gets stored without creating or referencing the field that can be constructed with it.\n\nThis is already how `absolute_field()` is implemented; `data` is the absolute defining polynomial, which is computed and cached by the method `absolute_polynomial()`.  Removing the `@cached_method` decorator from `NumberField_{generic,relative}.absolute_field()` solves the memory leak in your example:\n\n```\nsage: u=id(NumberField(x^2+1,name=\"a\").absolute_field('b'))\nsage: import gc\nsage: gc.collect()\n53\nsage: [type(v) for v in gc.get_objects() if id(v)==u]\n[]\n```",
    "created_at": "2017-09-13T12:54:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359026",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:15" align="right">comment:15</div>

Replying to [@nbruin](#comment%3A14):
> Replying to [@pjbruin](#comment%3A13):
> > A useful way to store the patches/embeddings, which allows us to keep `UniqueRepresentation` for affine schemes (I am strongly in favour of keeping unique representation for the reason Nils mentioned in comment;10) would be the "structure" construction that is currently used for number fields (introduced by Julian Rüth in #11670).
> 
> 
> That construction is a complete memory leak.

Ouch.  It seems that neither the author nor the reviewers of #11670 (including me) paid attention to memory leaks.

> In this case a solution could be to implement `absolute_field` as:
> 
> ```
> @cached_method
> def compute_absolute_field_data(...):
> ...
> 
> def absolute_field(...):
>    data = self.compute_absolute_field_data(...)
>    L = NumberField(data,...)
>    return L
> ```
> so that the expensive data gets stored without creating or referencing the field that can be constructed with it.

This is already how `absolute_field()` is implemented; `data` is the absolute defining polynomial, which is computed and cached by the method `absolute_polynomial()`.  Removing the `@cached_method` decorator from `NumberField_{generic,relative}.absolute_field()` solves the memory leak in your example:

```
sage: u=id(NumberField(x^2+1,name="a").absolute_field('b'))
sage: import gc
sage: gc.collect()
53
sage: [type(v) for v in gc.get_objects() if id(v)==u]
[]
```



---

archive/issue_comments_359027.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@pjbruin](#comment%3A15):\n> Replying to [@nbruin](#comment%3A14):\n> > Replying to [@pjbruin](#comment%3A13):\n> > > A useful way to store the patches/embeddings, which allows us to keep `UniqueRepresentation` for affine schemes (I am strongly in favour of keeping unique representation for the reason Nils mentioned in comment;10) would be the \"structure\" construction that is currently used for number fields (introduced by Julian R\u00fcth in #11670).\n> > \n> > \n> > That construction is a complete memory leak.\n> \n> Ouch.  It seems that neither the author nor the reviewers of #11670 (including me) paid attention to memory leaks.\n\nWhenever you see a `CachedRepresentation` or a `UniqueFactory` that has included in its input parameters objects that are similar to what is returned, you can expect memory leaks (and I really mean, you should expect to be able to easily create an example as above). That is one of my main reasons to not like it. It's very difficult to use it in non-trivial examples and *not* create memory leaks. Basically, input to these constructors should consist of just strings and integers. If you can't do that, it's a good sign you should perhaps not use it, because someone will create a memory leak with it in the near future.\n\nFix suggested above now at #23851.",
    "created_at": "2017-09-13T16:11:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359027",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@pjbruin](#comment%3A15):
> Replying to [@nbruin](#comment%3A14):
> > Replying to [@pjbruin](#comment%3A13):
> > > A useful way to store the patches/embeddings, which allows us to keep `UniqueRepresentation` for affine schemes (I am strongly in favour of keeping unique representation for the reason Nils mentioned in comment;10) would be the "structure" construction that is currently used for number fields (introduced by Julian Rüth in #11670).
> > 
> > 
> > That construction is a complete memory leak.
> 
> Ouch.  It seems that neither the author nor the reviewers of #11670 (including me) paid attention to memory leaks.

Whenever you see a `CachedRepresentation` or a `UniqueFactory` that has included in its input parameters objects that are similar to what is returned, you can expect memory leaks (and I really mean, you should expect to be able to easily create an example as above). That is one of my main reasons to not like it. It's very difficult to use it in non-trivial examples and *not* create memory leaks. Basically, input to these constructors should consist of just strings and integers. If you can't do that, it's a good sign you should perhaps not use it, because someone will create a memory leak with it in the near future.

Fix suggested above now at #23851.



---

archive/issue_events_327890.json:
```json
{
    "actor": "https://github.com/raghukul01",
    "created_at": "2018-06-27T11:23:13Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23807#event-327890"
}
```



---

archive/issue_events_327891.json:
```json
{
    "actor": "https://github.com/raghukul01",
    "created_at": "2018-06-27T11:23:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23807#event-327891"
}
```



---

archive/issue_comments_359028.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nHi, I am working on this ticket as a part of Google Summer of Code'18. Can we start the discussion again? I needs some details to get started. I suggest using `sage-devel` in parallel to `trac` for the discussion.",
    "created_at": "2018-06-27T11:23:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359028",
    "user": "https://github.com/raghukul01"
}
```

<div id="comment:17" align="right">comment:17</div>

Hi, I am working on this ticket as a part of Google Summer of Code'18. Can we start the discussion again? I needs some details to get started. I suggest using `sage-devel` in parallel to `trac` for the discussion.



---

archive/issue_comments_359029.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nIdeally, I'd still like to see UniqueRepresentation removed from affine schemes. Nils sketched a possible alternative to the issue in #17008 in comment 9. Peter, does that seem like the details might be workable for the #17008 issue eliminating the need for UR for affine space?",
    "created_at": "2018-06-29T01:43:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359029",
    "user": "https://github.com/bhutz"
}
```

<div id="comment:19" align="right">comment:19</div>

Ideally, I'd still like to see UniqueRepresentation removed from affine schemes. Nils sketched a possible alternative to the issue in #17008 in comment 9. Peter, does that seem like the details might be workable for the #17008 issue eliminating the need for UR for affine space?



---

archive/issue_comments_359030.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [@bhutz](#comment%3A19):\n> Ideally, I'd still like to see UniqueRepresentation removed from affine schemes. Nils sketched a possible alternative to the issue in #17008 in comment 9. Peter, does that seem like the details might be workable for the #17008 issue eliminating the need for UR for affine space?\n\nI find that hard to predict; the only way to find that out is by trying.  Personally I don't trust the idea of modifying mathematical objects after construction (except for caching purposes), since this is very likely to introduce bugs.  An example I just found:\n\n```\nsage: X.<x,y> = toric_varieties.A2_Z2()\nsage: Y = X.subscheme([x*y, x^2])\nsage: Y.is_smooth([0, 0])\nTrue\nsage: Y.embedding_center()\n[0 : 0]\nsage: Y.is_smooth([0, 1])  # this test changes properties of Y!\nTrue\nsage: Y.embedding_center()\n[0 : 1]\n```\nMy ideal world would be one where it is made completely explicit what the defining data of a mathematical object are, where all properties of an object can be determined from these defining data, and where these defining data are immutable.  From that perspective, using `UniqueRepresentation` or `UniqueFactory` is a way to force oneself to be careful and consistent about these defining data, and undoing it would be a step backwards.",
    "created_at": "2018-06-30T07:53:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359030",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [@bhutz](#comment%3A19):
> Ideally, I'd still like to see UniqueRepresentation removed from affine schemes. Nils sketched a possible alternative to the issue in #17008 in comment 9. Peter, does that seem like the details might be workable for the #17008 issue eliminating the need for UR for affine space?

I find that hard to predict; the only way to find that out is by trying.  Personally I don't trust the idea of modifying mathematical objects after construction (except for caching purposes), since this is very likely to introduce bugs.  An example I just found:

```
sage: X.<x,y> = toric_varieties.A2_Z2()
sage: Y = X.subscheme([x*y, x^2])
sage: Y.is_smooth([0, 0])
True
sage: Y.embedding_center()
[0 : 0]
sage: Y.is_smooth([0, 1])  # this test changes properties of Y!
True
sage: Y.embedding_center()
[0 : 1]
```
My ideal world would be one where it is made completely explicit what the defining data of a mathematical object are, where all properties of an object can be determined from these defining data, and where these defining data are immutable.  From that perspective, using `UniqueRepresentation` or `UniqueFactory` is a way to force oneself to be careful and consistent about these defining data, and undoing it would be a step backwards.



---

archive/issue_comments_359031.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nAs a more constructive contribution, I made a branch [u/pbruin/23807-proposal](https://github.com/sagemath/sagetrac-mirror/commits/u/pbruin/23807-proposal) to sketch the kind of solution that I have in mind.",
    "created_at": "2018-06-30T09:10:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359031",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:21" align="right">comment:21</div>

As a more constructive contribution, I made a branch [u/pbruin/23807-proposal](https://github.com/sagemath/sagetrac-mirror/commits/u/pbruin/23807-proposal) to sketch the kind of solution that I have in mind.



---

archive/issue_comments_359032.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nThanks Peter. I agree that it is possible to get the patching/embedding to work (maybe even without memory leaks) while keeping UR. I'm just not familiar enough with the kind of issue in #17008 to know if that fix is reasonable. From your response it sounds like for this ticket perhaps both fixes should be attempted and see what issues crop up and proceed from there.",
    "created_at": "2018-06-30T13:56:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359032",
    "user": "https://github.com/bhutz"
}
```

<div id="comment:22" align="right">comment:22</div>

Thanks Peter. I agree that it is possible to get the patching/embedding to work (maybe even without memory leaks) while keeping UR. I'm just not familiar enough with the kind of issue in #17008 to know if that fix is reasonable. From your response it sounds like for this ticket perhaps both fixes should be attempted and see what issues crop up and proceed from there.



---

archive/issue_comments_359033.json:
```json
{
    "body": "Changed branch from **[u/bhutz/affine_patch_23807](https://github.com/sagemath/sagetrac-mirror/tree/u/bhutz/affine_patch_23807)** to **[u/raghukul01/affine_patch_23807](https://github.com/sagemath/sagetrac-mirror/tree/u/raghukul01/affine_patch_23807)**",
    "created_at": "2018-07-23T22:43:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359033",
    "user": "https://github.com/raghukul01"
}
```

Changed branch from **[u/bhutz/affine_patch_23807](https://github.com/sagemath/sagetrac-mirror/tree/u/bhutz/affine_patch_23807)** to **[u/raghukul01/affine_patch_23807](https://github.com/sagemath/sagetrac-mirror/tree/u/raghukul01/affine_patch_23807)**



---

archive/issue_comments_359034.json:
```json
{
    "body": "<div id=\"comment:24\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/88f82ca42103898362b2620ab3ab76dc08072d5b\"><code>88f82ca</code></a></td><td><code>Upgrade cysignals to 1.7.2</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/885f1f918967b6f6a1c4666404486c9ff8f2d805\"><code>885f1f9</code></a></td><td><code>adjust for minor system-dependent floating point variation on this test; #25815</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/208364acb6c2e252d7326452bde14aa3cab6ba9e\"><code>208364a</code></a></td><td><code>Updated [SageMath](../wiki/SageMath) version to 8.3.rc2</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c6cfd94cc2274cc5bc9ab5f72ee68f470b624167\"><code>c6cfd94</code></a></td><td><code>Trac 23807: proposal for making projective embedding part of defining data</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b08f802caa664628451b0b5fc55edcd0b46c1b2d\"><code>b08f802</code></a></td><td><code>Trac 23807: get projective embedding of affine subscheme from ambient affine scheme</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/812722b1db6ad408a8250a8f91a3596df39da070\"><code>812722b</code></a></td><td><code>23807: Some modifications</code></td></tr></table>\n",
    "created_at": "2018-07-26T22:12:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359034",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:24"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/88f82ca42103898362b2620ab3ab76dc08072d5b"><code>88f82ca</code></a></td><td><code>Upgrade cysignals to 1.7.2</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/885f1f918967b6f6a1c4666404486c9ff8f2d805"><code>885f1f9</code></a></td><td><code>adjust for minor system-dependent floating point variation on this test; #25815</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/208364acb6c2e252d7326452bde14aa3cab6ba9e"><code>208364a</code></a></td><td><code>Updated [SageMath](../wiki/SageMath) version to 8.3.rc2</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c6cfd94cc2274cc5bc9ab5f72ee68f470b624167"><code>c6cfd94</code></a></td><td><code>Trac 23807: proposal for making projective embedding part of defining data</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b08f802caa664628451b0b5fc55edcd0b46c1b2d"><code>b08f802</code></a></td><td><code>Trac 23807: get projective embedding of affine subscheme from ambient affine scheme</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/812722b1db6ad408a8250a8f91a3596df39da070"><code>812722b</code></a></td><td><code>23807: Some modifications</code></td></tr></table>




---

archive/issue_events_327892.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2018-07-26T22:12:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "milestone_number": null,
    "milestone_title": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23807#event-327892"
}
```



---

archive/issue_events_327893.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2018-07-26T22:12:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "milestone_number": null,
    "milestone_title": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23807#event-327893"
}
```



---

archive/issue_comments_359035.json:
```json
{
    "body": "Changed commit from **[`f143fb8`](https://github.com/sagemath/sagetrac-mirror/commit/f143fb8c49a9d5ecc19d858fec501e3452ebfae6)** to **[`812722b`](https://github.com/sagemath/sagetrac-mirror/commit/812722b1db6ad408a8250a8f91a3596df39da070)**",
    "created_at": "2018-07-26T22:12:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359035",
    "user": "https://github.com/tscrim"
}
```

Changed commit from **[`f143fb8`](https://github.com/sagemath/sagetrac-mirror/commit/f143fb8c49a9d5ecc19d858fec501e3452ebfae6)** to **[`812722b`](https://github.com/sagemath/sagetrac-mirror/commit/812722b1db6ad408a8250a8f91a3596df39da070)**



---

archive/issue_comments_359036.json:
```json
{
    "body": "Changed keywords from none to **sagedays@icerm**",
    "created_at": "2018-07-26T22:12:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359036",
    "user": "https://github.com/tscrim"
}
```

Changed keywords from none to **sagedays@icerm**



---

archive/issue_comments_359037.json:
```json
{
    "body": "<div id=\"comment:25\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/91862d6adfb1ab81f24ace6543b5b62ee6b0e0a8\"><code>91862d6</code></a></td><td><code>23807: UniqueRepresentation added for ProjectiveSpaces</code></td></tr></table>\n",
    "created_at": "2018-07-27T04:56:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359037",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:25"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/91862d6adfb1ab81f24ace6543b5b62ee6b0e0a8"><code>91862d6</code></a></td><td><code>23807: UniqueRepresentation added for ProjectiveSpaces</code></td></tr></table>




---

archive/issue_comments_359038.json:
```json
{
    "body": "Changed commit from **[`812722b`](https://github.com/sagemath/sagetrac-mirror/commit/812722b1db6ad408a8250a8f91a3596df39da070)** to **[`91862d6`](https://github.com/sagemath/sagetrac-mirror/commit/91862d6adfb1ab81f24ace6543b5b62ee6b0e0a8)**",
    "created_at": "2018-07-27T04:56:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359038",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`812722b`](https://github.com/sagemath/sagetrac-mirror/commit/812722b1db6ad408a8250a8f91a3596df39da070)** to **[`91862d6`](https://github.com/sagemath/sagetrac-mirror/commit/91862d6adfb1ab81f24ace6543b5b62ee6b0e0a8)**



---

archive/issue_comments_359039.json:
```json
{
    "body": "Changed commit from **[`91862d6`](https://github.com/sagemath/sagetrac-mirror/commit/91862d6adfb1ab81f24ace6543b5b62ee6b0e0a8)** to **[`5e70658`](https://github.com/sagemath/sagetrac-mirror/commit/5e706587f55a6de48e68f088bad7952f92fe70bf)**",
    "created_at": "2018-07-27T06:47:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359039",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`91862d6`](https://github.com/sagemath/sagetrac-mirror/commit/91862d6adfb1ab81f24ace6543b5b62ee6b0e0a8)** to **[`5e70658`](https://github.com/sagemath/sagetrac-mirror/commit/5e706587f55a6de48e68f088bad7952f92fe70bf)**



---

archive/issue_comments_359040.json:
```json
{
    "body": "<div id=\"comment:26\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5e706587f55a6de48e68f088bad7952f92fe70bf\"><code>5e70658</code></a></td><td><code>23807: Modified generator names for affine_patch</code></td></tr></table>\n",
    "created_at": "2018-07-27T06:47:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359040",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:26"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5e706587f55a6de48e68f088bad7952f92fe70bf"><code>5e70658</code></a></td><td><code>23807: Modified generator names for affine_patch</code></td></tr></table>




---

archive/issue_events_327894.json:
```json
{
    "actor": "https://github.com/raghukul01",
    "created_at": "2018-07-27T06:49:10Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23807#event-327894"
}
```



---

archive/issue_events_327895.json:
```json
{
    "actor": "https://github.com/raghukul01",
    "created_at": "2018-07-27T06:49:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23807#event-327895"
}
```



---

archive/issue_comments_359041.json:
```json
{
    "body": "Changed keywords from **sagedays@icerm** to **sagedays@icerm, gsoc2018**",
    "created_at": "2018-07-27T06:49:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359041",
    "user": "https://github.com/raghukul01"
}
```

Changed keywords from **sagedays@icerm** to **sagedays@icerm, gsoc2018**



---

archive/issue_comments_359042.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nApart from documentation updates this branch is ready for testing.",
    "created_at": "2018-07-27T06:49:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359042",
    "user": "https://github.com/raghukul01"
}
```

<div id="comment:27" align="right">comment:27</div>

Apart from documentation updates this branch is ready for testing.



---

archive/issue_comments_359043.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nDoctest failures \n\n```\nsage -t --long src/sage/dynamics/arithmetic_dynamics/projective_ds.py  # 5 doctests failed\nsage -t --long src/sage/categories/homset.py  # 2 doctests failed\n```\nSee also the patchbot.",
    "created_at": "2018-07-27T12:59:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359043",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:28" align="right">comment:28</div>

Doctest failures 

```
sage -t --long src/sage/dynamics/arithmetic_dynamics/projective_ds.py  # 5 doctests failed
sage -t --long src/sage/categories/homset.py  # 2 doctests failed
```
See also the patchbot.



---

archive/issue_events_327896.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2018-07-27T13:59:52Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23807#event-327896"
}
```



---

archive/issue_events_327897.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2018-07-27T13:59:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23807#event-327897"
}
```



---

archive/issue_comments_359044.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nA couple other comments\n\n\n- I don't understand why the parameters were added to the subsheme init. It seems like these cannot be different than the ambient space\n\n```\nalgebraic subscheme:\ndef __init__(self, A, polynomials, ambient_projective_space=None,\n                 default_embedding_index=None):\n```\n\n- Do we want to set-up a ProjectiveScheme class like the AffineScheme class?\n\n- The default should be immutable\n\n```\nP.<x,y,z>=ProjectiveSpace(QQ,2)\nA.<u,v> = AffineSpace(2,QQ,ambient_projective_space=P,default_embedding_index=0)\nA._default_embedding_index=4\nA.projective_embedding()\n```",
    "created_at": "2018-07-27T14:43:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359044",
    "user": "https://github.com/bhutz"
}
```

<div id="comment:30" align="right">comment:30</div>

A couple other comments


- I don't understand why the parameters were added to the subsheme init. It seems like these cannot be different than the ambient space

```
algebraic subscheme:
def __init__(self, A, polynomials, ambient_projective_space=None,
                 default_embedding_index=None):
```

- Do we want to set-up a ProjectiveScheme class like the AffineScheme class?

- The default should be immutable

```
P.<x,y,z>=ProjectiveSpace(QQ,2)
A.<u,v> = AffineSpace(2,QQ,ambient_projective_space=P,default_embedding_index=0)
A._default_embedding_index=4
A.projective_embedding()
```



---

archive/issue_comments_359045.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\n- Yes exactly, why do we only have `AffineScheme` class?\n \n- As of immutable objects, I think that issue is in most of the classes as well, consider\n\n```\nsage: P = ProjectiveSpace(QQ,3)\nsage: P.coordinate_ring()\nsage: P._coordinate_ring = QQ\nsage: P.coordinate_ring()\n```\n\n I dont really know how to make variables immutable in sage, there is a `set_immutable()` function for Sequences, but dont think it would work here.\n\n- And yes, I agree we dont need to pass `ambient_projective_space=None, default_embedding_index=None` in Subscheme.\n\nThere is one issue with change in generator names, consider:\n\n```\nsage: P.<x,y> = ProjectiveSpace(QQ, 1)\nsage: f = DynamicalSystem_projective([y^2, x^2])\nsage: f.dehomogenize(tuple([0,1]))\n```",
    "created_at": "2018-07-29T15:29:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359045",
    "user": "https://github.com/raghukul01"
}
```

<div id="comment:31" align="right">comment:31</div>

- Yes exactly, why do we only have `AffineScheme` class?
 
- As of immutable objects, I think that issue is in most of the classes as well, consider

```
sage: P = ProjectiveSpace(QQ,3)
sage: P.coordinate_ring()
sage: P._coordinate_ring = QQ
sage: P.coordinate_ring()
```

 I dont really know how to make variables immutable in sage, there is a `set_immutable()` function for Sequences, but dont think it would work here.

- And yes, I agree we dont need to pass `ambient_projective_space=None, default_embedding_index=None` in Subscheme.

There is one issue with change in generator names, consider:

```
sage: P.<x,y> = ProjectiveSpace(QQ, 1)
sage: f = DynamicalSystem_projective([y^2, x^2])
sage: f.dehomogenize(tuple([0,1]))
```



---

archive/issue_comments_359046.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nReplying to [@raghukul01](#comment%3A31):\n> - As of immutable objects, I think that issue is in most of the classes as well, consider\n> \n> ```\n> sage: P = ProjectiveSpace(QQ,3)\n> sage: P.coordinate_ring()\n> sage: P._coordinate_ring = QQ\n> sage: P.coordinate_ring()\n> ```\n\nMost objects are semantically immutable, not syntactically (i.e., it does not raise an error when you do mutate it). The user is not suppose to access `_coordinate_ring` because it starts with a leading underscore. So as far as the user is concerned, the object is immutable. So you should not be changing these things in code (which is part of the problem here).\n\n>  I dont really know how to make variables immutable in sage, there is a `set_immutable()` function for Sequences, but dont think it would work here.\n\nAs mentioned above, this is basically a red herring and irrelevant.",
    "created_at": "2018-07-30T01:57:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359046",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:32" align="right">comment:32</div>

Replying to [@raghukul01](#comment%3A31):
> - As of immutable objects, I think that issue is in most of the classes as well, consider
> 
> ```
> sage: P = ProjectiveSpace(QQ,3)
> sage: P.coordinate_ring()
> sage: P._coordinate_ring = QQ
> sage: P.coordinate_ring()
> ```

Most objects are semantically immutable, not syntactically (i.e., it does not raise an error when you do mutate it). The user is not suppose to access `_coordinate_ring` because it starts with a leading underscore. So as far as the user is concerned, the object is immutable. So you should not be changing these things in code (which is part of the problem here).

>  I dont really know how to make variables immutable in sage, there is a `set_immutable()` function for Sequences, but dont think it would work here.

As mentioned above, this is basically a red herring and irrelevant.



---

archive/issue_comments_359047.json:
```json
{
    "body": "<div id=\"comment:33\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/da9465f6d988a6cb94dbe9859010a4a1a412161d\"><code>da9465f</code></a></td><td><code>Merge branch 'u/raghukul01/affine_patch_23807' of git://trac.sagemath.org/sage into affine_patch_23807</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b94b7b7f95e466368327a97d806f3f8f73136260\"><code>b94b7b7</code></a></td><td><code>23807: Corrected some doctests</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/da804ce757c7e7734a177f214464215da581e463\"><code>da804ce</code></a></td><td><code>Merge branch 'affine_patch_23807' into affine_patch_23807_rc3</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/34ed3e3c9da29ce0de0a837c43da29eb277a6620\"><code>34ed3e3</code></a></td><td><code>23807: Corrected dehomogenize in projective dynamics</code></td></tr></table>\n",
    "created_at": "2018-07-31T19:49:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359047",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:33"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/da9465f6d988a6cb94dbe9859010a4a1a412161d"><code>da9465f</code></a></td><td><code>Merge branch 'u/raghukul01/affine_patch_23807' of git://trac.sagemath.org/sage into affine_patch_23807</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b94b7b7f95e466368327a97d806f3f8f73136260"><code>b94b7b7</code></a></td><td><code>23807: Corrected some doctests</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/da804ce757c7e7734a177f214464215da581e463"><code>da804ce</code></a></td><td><code>Merge branch 'affine_patch_23807' into affine_patch_23807_rc3</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/34ed3e3c9da29ce0de0a837c43da29eb277a6620"><code>34ed3e3</code></a></td><td><code>23807: Corrected dehomogenize in projective dynamics</code></td></tr></table>




---

archive/issue_comments_359048.json:
```json
{
    "body": "Changed commit from **[`5e70658`](https://github.com/sagemath/sagetrac-mirror/commit/5e706587f55a6de48e68f088bad7952f92fe70bf)** to **[`34ed3e3`](https://github.com/sagemath/sagetrac-mirror/commit/34ed3e3c9da29ce0de0a837c43da29eb277a6620)**",
    "created_at": "2018-07-31T19:49:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359048",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`5e70658`](https://github.com/sagemath/sagetrac-mirror/commit/5e706587f55a6de48e68f088bad7952f92fe70bf)** to **[`34ed3e3`](https://github.com/sagemath/sagetrac-mirror/commit/34ed3e3c9da29ce0de0a837c43da29eb277a6620)**



---

archive/issue_comments_359049.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nCorrected doctests",
    "created_at": "2018-07-31T19:51:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359049",
    "user": "https://github.com/raghukul01"
}
```

<div id="comment:34" align="right">comment:34</div>

Corrected doctests



---

archive/issue_events_327898.json:
```json
{
    "actor": "https://github.com/raghukul01",
    "created_at": "2018-07-31T19:51:58Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23807#event-327898"
}
```



---

archive/issue_events_327899.json:
```json
{
    "actor": "https://github.com/raghukul01",
    "created_at": "2018-07-31T19:51:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23807#event-327899"
}
```



---

archive/issue_comments_359050.json:
```json
{
    "body": "Reviewer: **Ben Hutz, Travis Scrimshaw**",
    "created_at": "2018-07-31T20:03:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359050",
    "user": "https://github.com/raghukul01"
}
```

Reviewer: **Ben Hutz, Travis Scrimshaw**



---

archive/issue_comments_359051.json:
```json
{
    "body": "Changed author from **Ben Hutz** to **Ben Hutz, Peter Bruin, Raghukul Raman**",
    "created_at": "2018-07-31T20:03:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359051",
    "user": "https://github.com/raghukul01"
}
```

Changed author from **Ben Hutz** to **Ben Hutz, Peter Bruin, Raghukul Raman**



---

archive/issue_comments_359052.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nI did a look through the code as well as some notebook testing. I didn't come up with anything significant from a usage perspective. Here are a couple minor comments. Someone more familiar with the memory management issues of UR should take a look at this as well.\n\n---\nThe doc string\n\n```\n         If the dehomogenized morphism is an endomorphism then a\n         :class:`DynamicalSystem_affine` given by dehomogenizing the\n         source and target of `self` with respect to the given indices.\n         If it is not an endomorphism then the morphism is returned.\n```\ncould be simpler. It is totally dependent on the indicies, so something more like\nIf the dehomogenizing indices are the same for the domain and codomain, then\na dynamical system is returned. If the dehomogenizing indicies for the domain and codomain are different then the resulting affine patches are different and a scheme morphism is returned\n\nAlso \nI'd rather have a specific check than a blanket try/except\n\n```\n        try:\n            return F.as_dynamical_system()\n        except:\n            return F\n```\n\n---\nAffineSpace(n, R=None, names='x', ambient_projective_space=None,\n                default_embedding_index=None)\n\nso now UR is keyed off of not just the base ring and the variable names, but also the embedding index and the embedding codomain. Does this now violate the discussion above where UR was justified by each coordinate ring giving a unique space? I can essentially now make as many different Spec(QQ[x,y]) as I'd like all different.\n\n---\n\nsomething is wrong here ~line 710 affine_space.py\n\n```\n        if PP is None:\n            PP = self._ambient_projective_space\n        if PP is None:\n```",
    "created_at": "2018-08-03T15:45:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359052",
    "user": "https://github.com/bhutz"
}
```

<div id="comment:36" align="right">comment:36</div>

I did a look through the code as well as some notebook testing. I didn't come up with anything significant from a usage perspective. Here are a couple minor comments. Someone more familiar with the memory management issues of UR should take a look at this as well.

---
The doc string

```
         If the dehomogenized morphism is an endomorphism then a
         :class:`DynamicalSystem_affine` given by dehomogenizing the
         source and target of `self` with respect to the given indices.
         If it is not an endomorphism then the morphism is returned.
```
could be simpler. It is totally dependent on the indicies, so something more like
If the dehomogenizing indices are the same for the domain and codomain, then
a dynamical system is returned. If the dehomogenizing indicies for the domain and codomain are different then the resulting affine patches are different and a scheme morphism is returned

Also 
I'd rather have a specific check than a blanket try/except

```
        try:
            return F.as_dynamical_system()
        except:
            return F
```

---
AffineSpace(n, R=None, names='x', ambient_projective_space=None,
                default_embedding_index=None)

so now UR is keyed off of not just the base ring and the variable names, but also the embedding index and the embedding codomain. Does this now violate the discussion above where UR was justified by each coordinate ring giving a unique space? I can essentially now make as many different Spec(QQ[x,y]) as I'd like all different.

---

something is wrong here ~line 710 affine_space.py

```
        if PP is None:
            PP = self._ambient_projective_space
        if PP is None:
```



---

archive/issue_comments_359053.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nQuick comment: Do not have a bare `except:` statement as it can also catch things like keyboard interrupts. You should instead do `except Exception:`.",
    "created_at": "2018-08-03T23:26:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359053",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:37" align="right">comment:37</div>

Quick comment: Do not have a bare `except:` statement as it can also catch things like keyboard interrupts. You should instead do `except Exception:`.



---

archive/issue_comments_359054.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nI don't see anything outright that would cause a memory leak. Is there some infinite sequence that would be reasonable test?\n\nI agree with Ben's [comment:36](#comment%3A36) overall.\n\n> so now UR is keyed off of not just the base ring and the variable names, but also the embedding index and the embedding codomain. Does this now violate the discussion above where UR was justified by each coordinate ring giving a unique space? I can essentially now make as many different Spec(QQ[x,y]) as I'd like all different. \n\nIn principle, I don't think you can create different Specs from the construction parameters (unless you did something evil, probably involving some monkey-patching too). This is because the two extra parameters default to `None` and do not change. Now you will get unequal (because they are non-identical) affine patches if they have different embeddings/projective spaces, but from the ticket description, I am inferring they are only isomorphic, which is okay. However, I don't know the math, so I might need a little more detail about what sort of behavior you expect.\n\nI do have some other comments on the branch:\n\nYou should not change what the test in `homset.py` is actually testing. So you need to find a new parent that is not unique and construct its `End`. This is something I might be able to do, but hopefully someone following this ticket knows a good example.\n\nIn `affine_subscheme.py`, your added `__init__` is missing doctests.\n\nA while-we-are-at-it, can you change the doc of specialization in `generic/morphism.py` to be properly formatted (by de-indenting the `::`)?\n\nYour `__classcall__` is missing doctests (create two objects with not-identical but equivalent entries and show they are the same by using `is`).\n\nThis change is suspicious to me:\n\n```diff\n@@ -276,11 +276,8 @@ class AlgebraicScheme_subscheme_projective(AlgebraicScheme_subscheme):\n         phi = AA.projective_embedding(i, PP)\n         polys = self.defining_polynomials()\n         xi = phi.defining_polynomials()\n-        U = AA.subscheme([ f(xi) for f in polys ])\n-        U._default_embedding_index = i\n-        phi = U.projective_embedding(i, PP)\n+        U = AA.subscheme([f(xi) for f in polys])\n         self.__affine_patches[i] = U\n-        U._embedding_morphism = phi\n         return U\n \n     def _best_affine_patch(self, point):\n```\nIs the default embedding index and morphism of `U` set automatically? Before it didn't seem like it did, and I am not sure you're changes make it so.\n\nYou can simplify this:\n\n```diff\n-gens = [g[j] for j in range(i)] + [g[j] for j in range(i+1, n+1)]\n+gens = g[:i] + g[i+1:]\n```\n\nWith passing in `AA` to `affine_patch`, what if `AA._default_embedding_index` is not equal to `i`? This feels like it will put things into an inconsistent state as that corresponding `AA` is stored and used again. (Side note: this lazily construct `__affine_patches = {}` makes the code way more complicated than it needs to be for no gain IMO.)\n\nDon't you need to do some changes in `affine_space.py` for `projective_embedding` to take into account the `_default_embedding_index` and `_ambient_projective_space`?\n\nI don't understand why you added this:\n\n```\n+    i = default_embedding_index\n+    if i is not None:\n+        i = int(i)\n```\nSuch a check should be done in the `AffineSpace_generic.__init__` method because that is where is it \"used\" (basically a code-locality reason).\n\nInstead of having a check like this:\n\n```diff\n@@ -185,7 +190,7 @@ class AlgebraicScheme_subscheme_affine(AlgebraicScheme_subscheme):\n         n = AA.dimension_relative()\n         if i is None:\n             try:\n-                i = self._default_embedding_index\n+                return self._embedding_morphism\n             except AttributeError:\n                 i = int(n)\n         else:\n```\nIt would be better to set `self._embedding_morphism = None` in the `__init__` and then check\n\n```python\nif self._embedding_morphism is not None:\n    return self._embedding_morphism\nelse:\n    i = int(n)\n```\nIt is easier to understand the program flow and makes it easier to debug (mainly, when people do typos).",
    "created_at": "2018-08-04T10:06:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359054",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:38" align="right">comment:38</div>

I don't see anything outright that would cause a memory leak. Is there some infinite sequence that would be reasonable test?

I agree with Ben's [comment:36](#comment%3A36) overall.

> so now UR is keyed off of not just the base ring and the variable names, but also the embedding index and the embedding codomain. Does this now violate the discussion above where UR was justified by each coordinate ring giving a unique space? I can essentially now make as many different Spec(QQ[x,y]) as I'd like all different. 

In principle, I don't think you can create different Specs from the construction parameters (unless you did something evil, probably involving some monkey-patching too). This is because the two extra parameters default to `None` and do not change. Now you will get unequal (because they are non-identical) affine patches if they have different embeddings/projective spaces, but from the ticket description, I am inferring they are only isomorphic, which is okay. However, I don't know the math, so I might need a little more detail about what sort of behavior you expect.

I do have some other comments on the branch:

You should not change what the test in `homset.py` is actually testing. So you need to find a new parent that is not unique and construct its `End`. This is something I might be able to do, but hopefully someone following this ticket knows a good example.

In `affine_subscheme.py`, your added `__init__` is missing doctests.

A while-we-are-at-it, can you change the doc of specialization in `generic/morphism.py` to be properly formatted (by de-indenting the `::`)?

Your `__classcall__` is missing doctests (create two objects with not-identical but equivalent entries and show they are the same by using `is`).

This change is suspicious to me:

```diff
@@ -276,11 +276,8 @@ class AlgebraicScheme_subscheme_projective(AlgebraicScheme_subscheme):
         phi = AA.projective_embedding(i, PP)
         polys = self.defining_polynomials()
         xi = phi.defining_polynomials()
-        U = AA.subscheme([ f(xi) for f in polys ])
-        U._default_embedding_index = i
-        phi = U.projective_embedding(i, PP)
+        U = AA.subscheme([f(xi) for f in polys])
         self.__affine_patches[i] = U
-        U._embedding_morphism = phi
         return U
 
     def _best_affine_patch(self, point):
```
Is the default embedding index and morphism of `U` set automatically? Before it didn't seem like it did, and I am not sure you're changes make it so.

You can simplify this:

```diff
-gens = [g[j] for j in range(i)] + [g[j] for j in range(i+1, n+1)]
+gens = g[:i] + g[i+1:]
```

With passing in `AA` to `affine_patch`, what if `AA._default_embedding_index` is not equal to `i`? This feels like it will put things into an inconsistent state as that corresponding `AA` is stored and used again. (Side note: this lazily construct `__affine_patches = {}` makes the code way more complicated than it needs to be for no gain IMO.)

Don't you need to do some changes in `affine_space.py` for `projective_embedding` to take into account the `_default_embedding_index` and `_ambient_projective_space`?

I don't understand why you added this:

```
+    i = default_embedding_index
+    if i is not None:
+        i = int(i)
```
Such a check should be done in the `AffineSpace_generic.__init__` method because that is where is it "used" (basically a code-locality reason).

Instead of having a check like this:

```diff
@@ -185,7 +190,7 @@ class AlgebraicScheme_subscheme_affine(AlgebraicScheme_subscheme):
         n = AA.dimension_relative()
         if i is None:
             try:
-                i = self._default_embedding_index
+                return self._embedding_morphism
             except AttributeError:
                 i = int(n)
         else:
```
It would be better to set `self._embedding_morphism = None` in the `__init__` and then check

```python
if self._embedding_morphism is not None:
    return self._embedding_morphism
else:
    i = int(n)
```
It is easier to understand the program flow and makes it easier to debug (mainly, when people do typos).



---

archive/issue_comments_359055.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nReplying to [@tscrim](#comment%3A38):\n\n> This change is suspicious to me:\n> \n> ```diff\n> @@ -276,11 +276,8 @@ class AlgebraicScheme_subscheme_projective(AlgebraicScheme_subscheme):\n>          phi = AA.projective_embedding(i, PP)\n>          polys = self.defining_polynomials()\n>          xi = phi.defining_polynomials()\n> -        U = AA.subscheme([ f(xi) for f in polys ])\n> -        U._default_embedding_index = i\n> -        phi = U.projective_embedding(i, PP)\n> +        U = AA.subscheme([f(xi) for f in polys])\n>          self.__affine_patches[i] = U\n> -        U._embedding_morphism = phi\n>          return U\n>  \n>      def _best_affine_patch(self, point):\n> ```\n> Is the default embedding index and morphism of `U` set automatically? Before it didn't seem like it did, and I am not sure you're changes make it so.\n\n\naffine_patch function takes the embedding index as input, unlike `Affine_Space`,in `Affine_Subschemes` this embedding index is a necessary input. ie it cannot be None, so there is no need for `_default_embedding_index`.\n\n> With passing in AA to affine_patch, what if AA._default_embedding_index is not equal to i? This feels like it will put things into an inconsistent state as that  corresponding AA is stored and used again.\n\nI don't really know how to deal with that, someone on top of the ticket suggested that `AA` as a parameter should be remove, to which I agree.\n\n> (Side note: this lazily construct `__affine_patches = {}` makes the code way more complicated than it needs to be for no gain IMO.)\n\nconstruction of most of these variable is done in similar way, any better method?\n\n\n> Don't you need to do some changes in affine_space.py for projective_embedding to take into account the _default_embedding_index and _ambient_projective_space?\n\nI have taken then into account, any specific change, which I am missing?",
    "created_at": "2018-08-07T11:13:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359055",
    "user": "https://github.com/raghukul01"
}
```

<div id="comment:39" align="right">comment:39</div>

Replying to [@tscrim](#comment%3A38):

> This change is suspicious to me:
> 
> ```diff
> @@ -276,11 +276,8 @@ class AlgebraicScheme_subscheme_projective(AlgebraicScheme_subscheme):
>          phi = AA.projective_embedding(i, PP)
>          polys = self.defining_polynomials()
>          xi = phi.defining_polynomials()
> -        U = AA.subscheme([ f(xi) for f in polys ])
> -        U._default_embedding_index = i
> -        phi = U.projective_embedding(i, PP)
> +        U = AA.subscheme([f(xi) for f in polys])
>          self.__affine_patches[i] = U
> -        U._embedding_morphism = phi
>          return U
>  
>      def _best_affine_patch(self, point):
> ```
> Is the default embedding index and morphism of `U` set automatically? Before it didn't seem like it did, and I am not sure you're changes make it so.


affine_patch function takes the embedding index as input, unlike `Affine_Space`,in `Affine_Subschemes` this embedding index is a necessary input. ie it cannot be None, so there is no need for `_default_embedding_index`.

> With passing in AA to affine_patch, what if AA._default_embedding_index is not equal to i? This feels like it will put things into an inconsistent state as that  corresponding AA is stored and used again.

I don't really know how to deal with that, someone on top of the ticket suggested that `AA` as a parameter should be remove, to which I agree.

> (Side note: this lazily construct `__affine_patches = {}` makes the code way more complicated than it needs to be for no gain IMO.)

construction of most of these variable is done in similar way, any better method?


> Don't you need to do some changes in affine_space.py for projective_embedding to take into account the _default_embedding_index and _ambient_projective_space?

I have taken then into account, any specific change, which I am missing?



---

archive/issue_comments_359056.json:
```json
{
    "body": "<div id=\"comment:40\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/cf69a4df87b779257f4b0046d45ab0411d1ae893\"><code>cf69a4d</code></a></td><td><code>Merge branch 'u/raghukul01/affine_patch_23807' of git://trac.sagemath.org/sage into affine_patch_23807</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/820be598eae1c1556a89bf473f1f9719465fd9d5\"><code>820be59</code></a></td><td><code>23807: Added some changes</code></td></tr></table>\n",
    "created_at": "2018-08-07T11:15:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359056",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:40"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/cf69a4df87b779257f4b0046d45ab0411d1ae893"><code>cf69a4d</code></a></td><td><code>Merge branch 'u/raghukul01/affine_patch_23807' of git://trac.sagemath.org/sage into affine_patch_23807</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/820be598eae1c1556a89bf473f1f9719465fd9d5"><code>820be59</code></a></td><td><code>23807: Added some changes</code></td></tr></table>




---

archive/issue_comments_359057.json:
```json
{
    "body": "Changed commit from **[`34ed3e3`](https://github.com/sagemath/sagetrac-mirror/commit/34ed3e3c9da29ce0de0a837c43da29eb277a6620)** to **[`820be59`](https://github.com/sagemath/sagetrac-mirror/commit/820be598eae1c1556a89bf473f1f9719465fd9d5)**",
    "created_at": "2018-08-07T11:15:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359057",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`34ed3e3`](https://github.com/sagemath/sagetrac-mirror/commit/34ed3e3c9da29ce0de0a837c43da29eb277a6620)** to **[`820be59`](https://github.com/sagemath/sagetrac-mirror/commit/820be598eae1c1556a89bf473f1f9719465fd9d5)**



---

archive/issue_comments_359058.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\nReplying to [@raghukul01](#comment%3A39):\n> Replying to [@tscrim](#comment%3A38):\n> \n> > This change is suspicious to me:\n> > \n> > ```diff\n> > @@ -276,11 +276,8 @@ class AlgebraicScheme_subscheme_projective(AlgebraicScheme_subscheme):\n> >          phi = AA.projective_embedding(i, PP)\n> >          polys = self.defining_polynomials()\n> >          xi = phi.defining_polynomials()\n> > -        U = AA.subscheme([ f(xi) for f in polys ])\n> > -        U._default_embedding_index = i\n> > -        phi = U.projective_embedding(i, PP)\n> > +        U = AA.subscheme([f(xi) for f in polys])\n> >          self.__affine_patches[i] = U\n> > -        U._embedding_morphism = phi\n> >          return U\n> >  \n> >      def _best_affine_patch(self, point):\n> > ```\n> > Is the default embedding index and morphism of `U` set automatically? Before it didn't seem like it did, and I am not sure you're changes make it so.\n> \n> \n> affine_patch function takes the embedding index as input, unlike `Affine_Space`,in `Affine_Subschemes` this embedding index is a necessary input. ie it cannot be None, so there is no need for `_default_embedding_index`.\n\nYes, but does the `subscheme` your are constructing have the correct embedding index/morphism? I didn't necessarily see a mechanism to set these things. It is possible I missed something, but it might be a problem if not.\n\n> > With passing in AA to affine_patch, what if AA._default_embedding_index is not equal to i? This feels like it will put things into an inconsistent state as that  corresponding AA is stored and used again.\n> \n> \n> I don't really know how to deal with that, someone on top of the ticket suggested that `AA` as a parameter should be remove, to which I agree.\n\nThen you probably should remove it (well, deprecate it). Another option would be to raise an error if such an `AA` was going to take it into an inconsistent state.\n\n> > (Side note: this lazily construct `__affine_patches = {}` makes the code way more complicated than it needs to be for no gain IMO.)\n> \n> \n> construction of most of these variable is done in similar way, any better method?\n\nYes (IMO), initialize these during the `__init__`. Actually, there is a very small speed gain once it is constructed to having it the way it is now. Although I wonder if these methods would be better served by making them `@cached_method` or putting those attributes as an `@lazy_attribute`.\n\n> > Don't you need to do some changes in affine_space.py for projective_embedding to take into account the _default_embedding_index and _ambient_projective_space?\n> \n> \n> I have taken then into account, any specific change, which I am missing?\n\nI don't think so.\n\nI guess there is also a bit of a question of \"Should you be able to construct an `AffineSpace` without an (default) `_ambient_projective_space`?\"",
    "created_at": "2018-08-08T02:39:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359058",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:41" align="right">comment:41</div>

Replying to [@raghukul01](#comment%3A39):
> Replying to [@tscrim](#comment%3A38):
> 
> > This change is suspicious to me:
> > 
> > ```diff
> > @@ -276,11 +276,8 @@ class AlgebraicScheme_subscheme_projective(AlgebraicScheme_subscheme):
> >          phi = AA.projective_embedding(i, PP)
> >          polys = self.defining_polynomials()
> >          xi = phi.defining_polynomials()
> > -        U = AA.subscheme([ f(xi) for f in polys ])
> > -        U._default_embedding_index = i
> > -        phi = U.projective_embedding(i, PP)
> > +        U = AA.subscheme([f(xi) for f in polys])
> >          self.__affine_patches[i] = U
> > -        U._embedding_morphism = phi
> >          return U
> >  
> >      def _best_affine_patch(self, point):
> > ```
> > Is the default embedding index and morphism of `U` set automatically? Before it didn't seem like it did, and I am not sure you're changes make it so.
> 
> 
> affine_patch function takes the embedding index as input, unlike `Affine_Space`,in `Affine_Subschemes` this embedding index is a necessary input. ie it cannot be None, so there is no need for `_default_embedding_index`.

Yes, but does the `subscheme` your are constructing have the correct embedding index/morphism? I didn't necessarily see a mechanism to set these things. It is possible I missed something, but it might be a problem if not.

> > With passing in AA to affine_patch, what if AA._default_embedding_index is not equal to i? This feels like it will put things into an inconsistent state as that  corresponding AA is stored and used again.
> 
> 
> I don't really know how to deal with that, someone on top of the ticket suggested that `AA` as a parameter should be remove, to which I agree.

Then you probably should remove it (well, deprecate it). Another option would be to raise an error if such an `AA` was going to take it into an inconsistent state.

> > (Side note: this lazily construct `__affine_patches = {}` makes the code way more complicated than it needs to be for no gain IMO.)
> 
> 
> construction of most of these variable is done in similar way, any better method?

Yes (IMO), initialize these during the `__init__`. Actually, there is a very small speed gain once it is constructed to having it the way it is now. Although I wonder if these methods would be better served by making them `@cached_method` or putting those attributes as an `@lazy_attribute`.

> > Don't you need to do some changes in affine_space.py for projective_embedding to take into account the _default_embedding_index and _ambient_projective_space?
> 
> 
> I have taken then into account, any specific change, which I am missing?

I don't think so.

I guess there is also a bit of a question of "Should you be able to construct an `AffineSpace` without an (default) `_ambient_projective_space`?"



---

archive/issue_comments_359059.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nJust commenting on two points here\n\n- Doesn't this code in `__init__` for subscheme set the correct default index. I thought I tested this in the notebook and the subschemes were getting the correct default embeddings.\n\n```\nAlgebraicScheme_subscheme.__init__(self, A, polynomials)\nif A._ambient_projective_space is not None:\n    self._embedding_morphism = self.projective_embedding \\\n       (A._default_embedding_index, A._ambient_projective_space)\nelse:\n    self._embedding_morphism = None\n```\n\n- in regards to: \"Should you be able to construct an AffineSpace without an (default) _ambient_projective_space?\"\n\nIf the answer here should be \"no\", there isn't a canonical way to choose a default embedding so you'd need to require the user to specify. The current code takes the answer as yes and has default embedding optional. From a mathematical perspective, an affine space is certainly an independent object and does not need to be attached to a projective space. Each of the possible embeddings is in some sense equally good.\n\nTo me this is very similar to the number field question. When you create a number field in Sage you have the option of specifying how it is embedded in CC (or QQBar etc). There are a number of choices for this embedding which are all in some sense equally good, and without user input, there is no \"canonical\" choice for this.",
    "created_at": "2018-08-08T14:34:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359059",
    "user": "https://github.com/bhutz"
}
```

<div id="comment:42" align="right">comment:42</div>

Just commenting on two points here

- Doesn't this code in `__init__` for subscheme set the correct default index. I thought I tested this in the notebook and the subschemes were getting the correct default embeddings.

```
AlgebraicScheme_subscheme.__init__(self, A, polynomials)
if A._ambient_projective_space is not None:
    self._embedding_morphism = self.projective_embedding \
       (A._default_embedding_index, A._ambient_projective_space)
else:
    self._embedding_morphism = None
```

- in regards to: "Should you be able to construct an AffineSpace without an (default) _ambient_projective_space?"

If the answer here should be "no", there isn't a canonical way to choose a default embedding so you'd need to require the user to specify. The current code takes the answer as yes and has default embedding optional. From a mathematical perspective, an affine space is certainly an independent object and does not need to be attached to a projective space. Each of the possible embeddings is in some sense equally good.

To me this is very similar to the number field question. When you create a number field in Sage you have the option of specifying how it is embedded in CC (or QQBar etc). There are a number of choices for this embedding which are all in some sense equally good, and without user input, there is no "canonical" choice for this.



---

archive/issue_comments_359060.json:
```json
{
    "body": "<div id=\"comment:43\" align=\"right\">comment:43</div>\n\nBe aware of possible conflicts with #26091 (but only once #26091 gets positively reviewed do we have to worry).",
    "created_at": "2018-08-20T00:48:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359060",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:43" align="right">comment:43</div>

Be aware of possible conflicts with #26091 (but only once #26091 gets positively reviewed do we have to worry).



---

archive/issue_events_327900.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2018-10-02T07:33:55Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23807#event-327900"
}
```



---

archive/issue_events_327901.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2018-10-02T07:33:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23807#event-327901"
}
```



---

archive/issue_comments_359061.json:
```json
{
    "body": "<div id=\"comment:44\" align=\"right\">comment:44</div>\n\nmerge conflict",
    "created_at": "2018-10-02T07:33:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359061",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:44" align="right">comment:44</div>

merge conflict



---

archive/issue_comments_359062.json:
```json
{
    "body": "<div id=\"comment:45\" align=\"right\">comment:45</div>\n\nTwo new commits to solve the merge conflict and the remaining TODO item.",
    "created_at": "2018-11-08T21:41:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359062",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:45" align="right">comment:45</div>

Two new commits to solve the merge conflict and the remaining TODO item.



---

archive/issue_events_327902.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2018-11-08T21:41:49Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23807#event-327902"
}
```



---

archive/issue_events_327903.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2018-11-08T21:41:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23807#event-327903"
}
```



---

archive/issue_comments_359063.json:
```json
{
    "body": "Changed branch from **[u/raghukul01/affine_patch_23807](https://github.com/sagemath/sagetrac-mirror/tree/u/raghukul01/affine_patch_23807)** to **[u/pbruin/23807-affine_patch](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/23807-affine_patch)**",
    "created_at": "2018-11-08T21:41:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359063",
    "user": "https://github.com/pjbruin"
}
```

Changed branch from **[u/raghukul01/affine_patch_23807](https://github.com/sagemath/sagetrac-mirror/tree/u/raghukul01/affine_patch_23807)** to **[u/pbruin/23807-affine_patch](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/23807-affine_patch)**



---

archive/issue_comments_359064.json:
```json
{
    "body": "Changed commit from **[`820be59`](https://github.com/sagemath/sagetrac-mirror/commit/820be598eae1c1556a89bf473f1f9719465fd9d5)** to **[`5d53278`](https://github.com/sagemath/sagetrac-mirror/commit/5d5327886dbce8f4daa8d220ac6bea3453c8cdd4)**",
    "created_at": "2018-11-08T21:41:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359064",
    "user": "https://github.com/pjbruin"
}
```

Changed commit from **[`820be59`](https://github.com/sagemath/sagetrac-mirror/commit/820be598eae1c1556a89bf473f1f9719465fd9d5)** to **[`5d53278`](https://github.com/sagemath/sagetrac-mirror/commit/5d5327886dbce8f4daa8d220ac6bea3453c8cdd4)**



---

archive/issue_comments_359065.json:
```json
{
    "body": "<div id=\"comment:46\" align=\"right\">comment:46</div>\n\nI looked through the changes a couple days ago and it looked fine. I've been waiting for a long running computation to finish on my Sage machine so that I can run some tests. However it is still running. Not sure when it will finish, but when it does, I'll run through some testing on this ticket.",
    "created_at": "2018-11-12T02:35:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359065",
    "user": "https://github.com/bhutz"
}
```

<div id="comment:46" align="right">comment:46</div>

I looked through the changes a couple days ago and it looked fine. I've been waiting for a long running computation to finish on my Sage machine so that I can run some tests. However it is still running. Not sure when it will finish, but when it does, I'll run through some testing on this ticket.



---

archive/issue_comments_359066.json:
```json
{
    "body": "<div id=\"comment:47\" align=\"right\">comment:47</div>\n\nThe pyflakes plugin found a number of unused imports and variables in the files touched by this ticket, see #26687.",
    "created_at": "2018-11-12T20:18:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359066",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:47" align="right">comment:47</div>

The pyflakes plugin found a number of unused imports and variables in the files touched by this ticket, see #26687.



---

archive/issue_events_327904.json:
```json
{
    "actor": "https://github.com/bhutz",
    "created_at": "2018-11-13T18:34:46Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23807#event-327904"
}
```



---

archive/issue_events_327905.json:
```json
{
    "actor": "https://github.com/bhutz",
    "created_at": "2018-11-13T18:34:46Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23807#event-327905"
}
```



---

archive/issue_comments_359067.json:
```json
{
    "body": "<div id=\"comment:48\" align=\"right\">comment:48</div>\n\nRan through some tests today. Just one example that seems a little weird to me\n\n```\nsage: A.<u,v> = AffineSpace(2,QQ,default_embedding_index=1)\nsage: X=A.subscheme([u-v])\nsage: X.projective_embedding(), A._default_embedding_index\n(Scheme morphism:\n   From: Closed subscheme of Affine Space of dimension 2 over Rational\nField defined by:\n   u - v\n   To:   Closed subscheme of Projective Space of dimension 2 over\nRational Field defined by:\n   x0 - x1\n   Defn: Defined on coordinates by sending (u, v) to\n         (u : v : 1), 1)\n```\nThe subscheme is not inheriting the default embedding. So you get weird things like\n\n```\nsage: phi=X.projective_embedding()\nsage: psi=A1.projective_embedding()\nsage: phi(X(2,2))== psi(A1(X(2,2)))\nFalse\n```",
    "created_at": "2018-11-13T18:34:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359067",
    "user": "https://github.com/bhutz"
}
```

<div id="comment:48" align="right">comment:48</div>

Ran through some tests today. Just one example that seems a little weird to me

```
sage: A.<u,v> = AffineSpace(2,QQ,default_embedding_index=1)
sage: X=A.subscheme([u-v])
sage: X.projective_embedding(), A._default_embedding_index
(Scheme morphism:
   From: Closed subscheme of Affine Space of dimension 2 over Rational
Field defined by:
   u - v
   To:   Closed subscheme of Projective Space of dimension 2 over
Rational Field defined by:
   x0 - x1
   Defn: Defined on coordinates by sending (u, v) to
         (u : v : 1), 1)
```
The subscheme is not inheriting the default embedding. So you get weird things like

```
sage: phi=X.projective_embedding()
sage: psi=A1.projective_embedding()
sage: phi(X(2,2))== psi(A1(X(2,2)))
False
```



---

archive/issue_events_327906.json:
```json
{
    "actor": "https://github.com/bhutz",
    "created_at": "2018-11-13T18:34:46Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "milestone_number": null,
    "milestone_title": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23807#event-327906"
}
```



---

archive/issue_events_327907.json:
```json
{
    "actor": "https://github.com/bhutz",
    "created_at": "2018-11-13T18:34:46Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "milestone_number": null,
    "milestone_title": "sage-8.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23807#event-327907"
}
```



---

archive/issue_comments_359068.json:
```json
{
    "body": "<div id=\"comment:49\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e67687d5ddfa5a3338209859981b915d6545494a\"><code>e67687d</code></a></td><td><code>Trac 23807: subschemes of affine spaces should respect projective embeddings</code></td></tr></table>\n",
    "created_at": "2018-11-28T16:28:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359068",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:49"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e67687d5ddfa5a3338209859981b915d6545494a"><code>e67687d</code></a></td><td><code>Trac 23807: subschemes of affine spaces should respect projective embeddings</code></td></tr></table>




---

archive/issue_comments_359069.json:
```json
{
    "body": "Changed commit from **[`5d53278`](https://github.com/sagemath/sagetrac-mirror/commit/5d5327886dbce8f4daa8d220ac6bea3453c8cdd4)** to **[`e67687d`](https://github.com/sagemath/sagetrac-mirror/commit/e67687d5ddfa5a3338209859981b915d6545494a)**",
    "created_at": "2018-11-28T16:28:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359069",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`5d53278`](https://github.com/sagemath/sagetrac-mirror/commit/5d5327886dbce8f4daa8d220ac6bea3453c8cdd4)** to **[`e67687d`](https://github.com/sagemath/sagetrac-mirror/commit/e67687d5ddfa5a3338209859981b915d6545494a)**



---

archive/issue_events_327908.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2018-11-28T16:30:04Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23807#event-327908"
}
```



---

archive/issue_events_327909.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2018-11-28T16:30:04Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23807#event-327909"
}
```



---

archive/issue_comments_359070.json:
```json
{
    "body": "<div id=\"comment:50\" align=\"right\">comment:50</div>\n\nReplying to [@bhutz](#comment%3A48):\n\n> The subscheme is not inheriting the default embedding.\n\nThe new commit should fix this.",
    "created_at": "2018-11-28T16:30:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359070",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:50" align="right">comment:50</div>

Replying to [@bhutz](#comment%3A48):

> The subscheme is not inheriting the default embedding.

The new commit should fix this.



---

archive/issue_comments_359071.json:
```json
{
    "body": "<div id=\"comment:51\" align=\"right\">comment:51</div>\n\nThis looks good to me. Since the patch bot failed, let me run the long tests as a final check.",
    "created_at": "2018-11-30T02:16:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359071",
    "user": "https://github.com/bhutz"
}
```

<div id="comment:51" align="right">comment:51</div>

This looks good to me. Since the patch bot failed, let me run the long tests as a final check.



---

archive/issue_comments_359072.json:
```json
{
    "body": "<div id=\"comment:52\" align=\"right\">comment:52</div>\n\nall tests pass.",
    "created_at": "2018-11-30T15:04:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359072",
    "user": "https://github.com/bhutz"
}
```

<div id="comment:52" align="right">comment:52</div>

all tests pass.



---

archive/issue_events_327910.json:
```json
{
    "actor": "https://github.com/bhutz",
    "created_at": "2018-11-30T15:04:55Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23807#event-327910"
}
```



---

archive/issue_events_327911.json:
```json
{
    "actor": "https://github.com/bhutz",
    "created_at": "2018-11-30T15:04:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23807#event-327911"
}
```



---

archive/issue_events_327912.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-12-01T13:43:36Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23807#event-327912"
}
```



---

archive/issue_events_327913.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "9c7df6a0e1dc71cc9e4a117bcc5538a550c6e5f6",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2018-12-01T13:43:36Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23807#event-327913"
}
```



---

archive/issue_comments_359073.json:
```json
{
    "body": "Changed branch from **[u/pbruin/23807-affine_patch](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/23807-affine_patch)** to **[`e67687d`](https://github.com/sagemath/sagetrac-mirror/commit/e67687d5ddfa5a3338209859981b915d6545494a)**",
    "created_at": "2018-12-01T13:43:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23807#issuecomment-359073",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/pbruin/23807-affine_patch](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/23807-affine_patch)** to **[`e67687d`](https://github.com/sagemath/sagetrac-mirror/commit/e67687d5ddfa5a3338209859981b915d6545494a)**
