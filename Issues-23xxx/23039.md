# Issue 23039: make_scripts_relative in sage-location breaks ipython3

archive/issues_022802.json:
```json
{
    "body": "If `SAGE_PYTHON3=yes`, then when IPython is build, it adds a script `ipython3` to `local/bin`. This script carefully writes the path to Sage's python3 to its first line: `#!/path/to/.../python3`. Then the function `make_scripts_relative` in `sage-location` replaces this with `#!/usr/bin/env python`, which breaks it.\n\n\nKeywords: python3\n\nReviewer: John Palmieri\n\nAuthor: Nils Bruin\n\nBranch: u/nbruin/trac23039\n\nCommit: 1ed6c43db07dc7a874cbd6a9525d5541565f4dbf\n\nResolution: wontfix\n\nIssue created by migration from https://trac.sagemath.org/ticket/23039\n\n",
    "closed_at": "2017-12-12T08:23:33Z",
    "created_at": "2017-05-20T22:07:40Z",
    "labels": [
        "component: build",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "make_scripts_relative in sage-location breaks ipython3",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23039",
    "user": "https://github.com/jhpalmieri"
}
```
If `SAGE_PYTHON3=yes`, then when IPython is build, it adds a script `ipython3` to `local/bin`. This script carefully writes the path to Sage's python3 to its first line: `#!/path/to/.../python3`. Then the function `make_scripts_relative` in `sage-location` replaces this with `#!/usr/bin/env python`, which breaks it.


Keywords: python3

Reviewer: John Palmieri

Author: Nils Bruin

Branch: u/nbruin/trac23039

Commit: 1ed6c43db07dc7a874cbd6a9525d5541565f4dbf

Resolution: wontfix

Issue created by migration from https://trac.sagemath.org/ticket/23039





---

archive/issue_comments_339496.json:
```json
{
    "body": "<a id='comment:2'></a>Hm, it really seems wrong to me that a routine that is supposed to make scripts relative also changes the kind of interpreter that's used. A reasonable default seems to me to stick with whatever was specified (including maintaining the options that are selected!!!)\n\nIf we need further tweaking of the \"#!\" line, I would think this needs to be tuned to the script in question, and thus not just be done for all files with a first line matching \"#!.*/python\".\n\n---\nNew commits:",
    "created_at": "2017-05-29T05:26:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23039#issuecomment-339496",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:2'></a>Hm, it really seems wrong to me that a routine that is supposed to make scripts relative also changes the kind of interpreter that's used. A reasonable default seems to me to stick with whatever was specified (including maintaining the options that are selected!!!)

If we need further tweaking of the "#!" line, I would think this needs to be tuned to the script in question, and thus not just be done for all files with a first line matching "#!.*/python".

---
New commits:



---

archive/issue_comments_339497.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-05-29T12:59:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23039#issuecomment-339497",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_339498.json:
```json
{
    "body": "<a id='comment:4'></a>This gets back to the question of what influence `SAGE_PYTHON3` should have at runtime. Would it be best if the `ipython` script used `python` and `ipython3` used `python3` in its `#!` line? Since they are essentially identical when written by IPython's installer, they end up being identical after running `make_scripts_relative`.\n\nI guess the right fix is to trust the individual packages to do the right thing (write `python2` or `python3` to the `#!` line) and to patch them if they don't. So this branch makes sense to me.\n\nThere is also an issue about the scripts in `src/bin`, but that's probably for another ticket. Some of those import the Sage library, so it is important that they run the version of Python into which Sage has been imported. Back to the runtime issue for `SAGE_PYTHON3`.",
    "created_at": "2017-05-29T15:06:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23039#issuecomment-339498",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:4'></a>This gets back to the question of what influence `SAGE_PYTHON3` should have at runtime. Would it be best if the `ipython` script used `python` and `ipython3` used `python3` in its `#!` line? Since they are essentially identical when written by IPython's installer, they end up being identical after running `make_scripts_relative`.

I guess the right fix is to trust the individual packages to do the right thing (write `python2` or `python3` to the `#!` line) and to patch them if they don't. So this branch makes sense to me.

There is also an issue about the scripts in `src/bin`, but that's probably for another ticket. Some of those import the Sage library, so it is important that they run the version of Python into which Sage has been imported. Back to the runtime issue for `SAGE_PYTHON3`.



---

archive/issue_comments_339499.json:
```json
{
    "body": "<a id='comment:5'></a>One doctest failure:\n\n```\nsage -t --long --warn-long 80.4 src/sage/tests/cmdline.py\n**********************************************************************\nFile \"src/sage/tests/cmdline.py\", line 576, in sage.tests.cmdline.test_executable\nFailed example:\n    open(os.path.join(SAGE_LOCAL, \"bin\", \"ipython\")).readline()\nExpected:\n    '#!/usr/bin/env python\\n'\nGot:\n    '#!/usr/bin/env python2\\n'\n**********************************************************************\n```\nProbably should be \"python...\" if we want the test to work for any version of Python.",
    "created_at": "2017-05-29T23:53:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23039#issuecomment-339499",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:5'></a>One doctest failure:

```
sage -t --long --warn-long 80.4 src/sage/tests/cmdline.py
**********************************************************************
File "src/sage/tests/cmdline.py", line 576, in sage.tests.cmdline.test_executable
Failed example:
    open(os.path.join(SAGE_LOCAL, "bin", "ipython")).readline()
Expected:
    '#!/usr/bin/env python\n'
Got:
    '#!/usr/bin/env python2\n'
**********************************************************************
```
Probably should be "python..." if we want the test to work for any version of Python.



---

archive/issue_comments_339500.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-05-30T02:43:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23039#issuecomment-339500",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_339501.json:
```json
{
    "body": "<a id='comment:7'></a>Good point.",
    "created_at": "2017-05-30T02:45:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23039#issuecomment-339501",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:7'></a>Good point.



---

archive/issue_comments_339502.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-05-30T02:45:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23039#issuecomment-339502",
    "user": "https://github.com/nbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_339503.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:4 jhpalmieri]:\n> There is also an issue about the scripts in `src/bin`, but that's probably for another ticket. Some of those import the Sage library, so it is important that they run the version of Python into which Sage has been imported. Back to the runtime issue for `SAGE_PYTHON3`.\n\n\nSee #23106.",
    "created_at": "2017-05-30T21:01:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23039#issuecomment-339503",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:8'></a>Replying to [comment:4 jhpalmieri]:
> There is also an issue about the scripts in `src/bin`, but that's probably for another ticket. Some of those import the Sage library, so it is important that they run the version of Python into which Sage has been imported. Back to the runtime issue for `SAGE_PYTHON3`.


See #23106.



---

archive/issue_comments_339504.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-05-31T14:19:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23039#issuecomment-339504",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_339505.json:
```json
{
    "body": "<a id='comment:9'></a>Okay, this passes all tests.",
    "created_at": "2017-05-31T14:19:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23039#issuecomment-339505",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:9'></a>Okay, this passes all tests.



---

archive/issue_comments_339506.json:
```json
{
    "body": "<a id='comment:10'></a>And fixes some old bugs, too. For example, `pip3` now runs with `python3` rather than `python` (= `python2`).",
    "created_at": "2017-05-31T14:24:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23039#issuecomment-339506",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:10'></a>And fixes some old bugs, too. For example, `pip3` now runs with `python3` rather than `python` (= `python2`).



---

archive/issue_comments_339507.json:
```json
{
    "body": "<a id='comment:12'></a>The whole \"making scripts relative\" and most of sage-location can be deleted fwiw; A normal build isn't relocatable and the binaries will rewrite the hardcoded paths on installation.",
    "created_at": "2017-05-31T22:58:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23039#issuecomment-339507",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:12'></a>The whole "making scripts relative" and most of sage-location can be deleted fwiw; A normal build isn't relocatable and the binaries will rewrite the hardcoded paths on installation.



---

archive/issue_comments_339508.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:12 vbraun]:\n> The whole \"making scripts relative\" and most of sage-location can be deleted fwiw; A normal build isn't relocatable and the binaries will rewrite the hardcoded paths on installation.\n\n\nDoes this rewriting preserve python2 vs. python3?",
    "created_at": "2017-05-31T23:24:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23039#issuecomment-339508",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:13'></a>Replying to [comment:12 vbraun]:
> The whole "making scripts relative" and most of sage-location can be deleted fwiw; A normal build isn't relocatable and the binaries will rewrite the hardcoded paths on installation.


Does this rewriting preserve python2 vs. python3?



---

archive/issue_comments_339509.json:
```json
{
    "body": "<a id='comment:14'></a>Yes, the parent directory is rewritten but the part within `SAGE_ROOT` is kept.",
    "created_at": "2017-06-01T06:52:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23039#issuecomment-339509",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:14'></a>Yes, the parent directory is rewritten but the part within `SAGE_ROOT` is kept.



---

archive/issue_comments_339510.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:12 vbraun]:\n> The whole \"making scripts relative\" and most of sage-location can be deleted fwiw.\n\n\nWhich parts of sage-location actually need to be kept? Just the parts dealing with the location file, to make sure the Sage installation hasn't been moved?",
    "created_at": "2017-06-01T17:50:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23039#issuecomment-339510",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:15'></a>Replying to [comment:12 vbraun]:
> The whole "making scripts relative" and most of sage-location can be deleted fwiw.


Which parts of sage-location actually need to be kept? Just the parts dealing with the location file, to make sure the Sage installation hasn't been moved?



---

archive/issue_comments_339511.json:
```json
{
    "body": "<a id='comment:16'></a>Yeah, the diagnostics is possibly worth keeping. Apart from that we don't need anything, I think.",
    "created_at": "2017-06-01T20:33:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23039#issuecomment-339511",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:16'></a>Yeah, the diagnostics is possibly worth keeping. Apart from that we don't need anything, I think.



---

archive/issue_comments_339512.json:
```json
{
    "body": "<a id='comment:17'></a>See #23129 for a clean-up of sage-location. We can merge that instead of this if it makes more sense. I'm going to mark this as \"needs info\" until we figure out which approach is better.",
    "created_at": "2017-06-02T17:52:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23039#issuecomment-339512",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:17'></a>See #23129 for a clean-up of sage-location. We can merge that instead of this if it makes more sense. I'm going to mark this as "needs info" until we figure out which approach is better.



---

archive/issue_comments_339513.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2017-06-02T17:52:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23039#issuecomment-339513",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_events_059657.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2017-08-06T09:07:34Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23039",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23039#event-59657"
}
```



---

archive/issue_comments_339514.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2017-08-06T09:07:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23039#issuecomment-339514",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_339515.json:
```json
{
    "body": "<a id='comment:18'></a>So can we now close this as duplicate ?",
    "created_at": "2017-08-06T09:07:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23039#issuecomment-339515",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:18'></a>So can we now close this as duplicate ?



---

archive/issue_comments_339516.json:
```json
{
    "body": "<a id='comment:19'></a>Yes, I think so. If #23129 has to be reverted, we can return to this.",
    "created_at": "2017-08-06T15:32:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23039#issuecomment-339516",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:19'></a>Yes, I think so. If #23129 has to be reverted, we can return to this.



---

archive/issue_comments_339517.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-08-06T15:32:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23039#issuecomment-339517",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_059658.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-12-12T08:23:33Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23039",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23039#event-59658"
}
```



---

archive/issue_comments_339518.json:
```json
{
    "body": "Resolution: wontfix",
    "created_at": "2017-12-12T08:23:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23039#issuecomment-339518",
    "user": "https://github.com/embray"
}
```

Resolution: wontfix
