# Issue 23397: Replace pip2/3-lock with a generic sage-flock command

archive/issues_023160.json:
```json
{
    "body": "I suggested something like this on #21672 but didn't have immediate need to follow up on it.\n\nSomething like this will be useful for making Windows builds more reliable, however, as there are some operations that can fail if they are run simultaneously during parallel builds.\n\nIn particular I'm trying to trace down failures with DLL rebasing, and at least part of the problem is that rebase can fail if it's being multiple times simultaneously as can happen during a parallel build (especially toward the end of the build when lots of Python packages are being installed--these are fast and often results in multiple rebases being run simultaneously).\n\nWith tickets like #22509 it will also be possible to make further restrictions, such as not running rebase while a package is being uninstalled.\n\nCC:  @jdemeyer\n\nBranch/Commit: b6e4a62d7d304dd714c0c63ff35c53dc6484d0c5\n\nReviewer: Jeroen Demeyer\n\nAuthor: Erik Bray\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/23397\n\n",
    "closed_at": "2017-12-11T01:04:13Z",
    "created_at": "2017-07-10T14:36:14Z",
    "labels": [
        "component: build",
        "critical"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Replace pip2/3-lock with a generic sage-flock command",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23397",
    "user": "https://github.com/embray"
}
```
I suggested something like this on #21672 but didn't have immediate need to follow up on it.

Something like this will be useful for making Windows builds more reliable, however, as there are some operations that can fail if they are run simultaneously during parallel builds.

In particular I'm trying to trace down failures with DLL rebasing, and at least part of the problem is that rebase can fail if it's being multiple times simultaneously as can happen during a parallel build (especially toward the end of the build when lots of Python packages are being installed--these are fast and often results in multiple rebases being run simultaneously).

With tickets like #22509 it will also be possible to make further restrictions, such as not running rebase while a package is being uninstalled.

CC:  @jdemeyer

Branch/Commit: b6e4a62d7d304dd714c0c63ff35c53dc6484d0c5

Reviewer: Jeroen Demeyer

Author: Erik Bray

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/23397





---

archive/issue_comments_439628.json:
```json
{
    "body": "Changing author from \"\" to \"Erik Bray\"",
    "created_at": "2017-07-10T14:36:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439628",
    "user": "https://github.com/embray"
}
```

Changing author from "" to "Erik Bray"



---

archive/issue_comments_439629.json:
```json
{
    "body": "Changing commit from \"\" to \"63f4b2ddae472cc1cf28701486e196d3fe7e1eee\"",
    "created_at": "2017-07-10T14:36:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439629",
    "user": "https://github.com/embray"
}
```

Changing commit from "" to "63f4b2ddae472cc1cf28701486e196d3fe7e1eee"



---

archive/issue_comments_439630.json:
```json
{
    "body": "Changing branch from \"\" to \"u/embray/build/lockfile\"",
    "created_at": "2017-07-10T14:36:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439630",
    "user": "https://github.com/embray"
}
```

Changing branch from "" to "u/embray/build/lockfile"



---

archive/issue_comments_439631.json:
```json
{
    "body": "<a id='comment:1'></a>\n(CC: jdemeyer, original author of the script)\n\n---\nNew commits:\n|                                                                                                                                          |                                                                                           |\n|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------|\n|[63f4b2d](https://git.sagemath.org/sage.git/commit?id=63f4b2ddae472cc1cf28701486e196d3fe7e1eee)|`Adds a new sage-flock command based on the original pip2-lock command, but generalized to`|",
    "created_at": "2017-07-10T14:36:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439631",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>
(CC: jdemeyer, original author of the script)

---
New commits:
|                                                                                                                                          |                                                                                           |
|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------|
|[63f4b2d](https://git.sagemath.org/sage.git/commit?id=63f4b2ddae472cc1cf28701486e196d3fe7e1eee)|`Adds a new sage-flock command based on the original pip2-lock command, but generalized to`|



---

archive/issue_comments_439632.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-07-10T14:36:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439632",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_439633.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-09-06T08:53:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439633",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_439634.json:
```json
{
    "body": "<a id='comment:2'></a>\nApparently this has a bug...",
    "created_at": "2017-09-06T08:53:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439634",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>
Apparently this has a bug...



---

archive/issue_comments_439635.json:
```json
{
    "body": "<a id='comment:3'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                    |\n|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------|\n|[5e89b68](https://git.sagemath.org/sage.git/commit/?id=5e89b68a1590856bb4eab77f5e479fd9ac72a17f)|`argparse.FileType can be handy, but it doesn't create directories.`|",
    "created_at": "2017-09-06T09:15:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439635",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                    |
|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------|
|[5e89b68](https://git.sagemath.org/sage.git/commit/?id=5e89b68a1590856bb4eab77f5e479fd9ac72a17f)|`argparse.FileType can be handy, but it doesn't create directories.`|



---

archive/issue_comments_439636.json:
```json
{
    "body": "Changing commit from \"63f4b2ddae472cc1cf28701486e196d3fe7e1eee\" to \"5e89b68a1590856bb4eab77f5e479fd9ac72a17f\"",
    "created_at": "2017-09-06T09:15:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439636",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "63f4b2ddae472cc1cf28701486e196d3fe7e1eee" to "5e89b68a1590856bb4eab77f5e479fd9ac72a17f"



---

archive/issue_comments_439637.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-09-06T09:16:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439637",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_439638.json:
```json
{
    "body": "<a id='comment:5'></a>\n*ping*\n\nI actually increasingly need this as it's difficult to get through a parallel build on Cygwin now without it failing a few times due to the lack of locking around rebase.",
    "created_at": "2017-10-19T10:51:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439638",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>
*ping*

I actually increasingly need this as it's difficult to get through a parallel build on Cygwin now without it failing a few times due to the lack of locking around rebase.



---

archive/issue_comments_439639.json:
```json
{
    "body": "<a id='comment:6'></a>\nWhy did you remove `sys.stderr.flush()`?",
    "created_at": "2017-10-25T09:51:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439639",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>
Why did you remove `sys.stderr.flush()`?



---

archive/issue_comments_439640.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Jeroen Demeyer\"",
    "created_at": "2017-10-25T09:56:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439640",
    "user": "https://github.com/jdemeyer"
}
```

Changing reviewer from "" to "Jeroen Demeyer"



---

archive/issue_comments_439641.json:
```json
{
    "body": "<a id='comment:7'></a>\nI think it would be good to mention somewhere in a comment that this may be used in build scripts, but only for packages depending on Python.\n\nThe help mentions\n\n```\nThe command may also be a Python module in which case it is run in the same\nPython interpreter as this script (a small optimization to avoid restarting the\nPython interpreter).\n```\nbut I don't see that in the implementation.",
    "created_at": "2017-10-25T09:56:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439641",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>
I think it would be good to mention somewhere in a comment that this may be used in build scripts, but only for packages depending on Python.

The help mentions

```
The command may also be a Python module in which case it is run in the same
Python interpreter as this script (a small optimization to avoid restarting the
Python interpreter).
```
but I don't see that in the implementation.



---

archive/issue_comments_439642.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-10-25T09:56:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439642",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_439643.json:
```json
{
    "body": "<a id='comment:8'></a>\nReplying to [jdemeyer](#comment%3A6):\n> Why did you remove `sys.stderr.flush()`?\n\n\nSee also https://mail.python.org/pipermail/python-list/2015-November/698421.html\n\nIt seems that Python 2 has unbuffered `sys.stderr` by default, which means that the flushing is not needed.\n\nBut this was changed in Python 3, so the flushing would be required there.",
    "created_at": "2017-10-25T10:06:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439643",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>
Replying to [jdemeyer](#comment%3A6):
> Why did you remove `sys.stderr.flush()`?


See also https://mail.python.org/pipermail/python-list/2015-November/698421.html

It seems that Python 2 has unbuffered `sys.stderr` by default, which means that the flushing is not needed.

But this was changed in Python 3, so the flushing would be required there.



---

archive/issue_comments_439644.json:
```json
{
    "body": "<a id='comment:9'></a>\nAh, good catch.  I had mistakenly assume that the `print()` function would automatically flush by default.\n\nAs for being \"only for packages depending on Python\" that has me wondering now what the best thing would be to do with this.  Maybe it should be moved to `build/bin`.  I need to use it for basically all packages, and the fact that it uses Python is not an impediment to that, since build tools are allowed to use the system Python (and in fact require it).  But this script is also used at runtime (just for pip install, currently), in which case it should use Sage's Python.  Any ideas?",
    "created_at": "2017-10-25T11:27:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439644",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>
Ah, good catch.  I had mistakenly assume that the `print()` function would automatically flush by default.

As for being "only for packages depending on Python" that has me wondering now what the best thing would be to do with this.  Maybe it should be moved to `build/bin`.  I need to use it for basically all packages, and the fact that it uses Python is not an impediment to that, since build tools are allowed to use the system Python (and in fact require it).  But this script is also used at runtime (just for pip install, currently), in which case it should use Sage's Python.  Any ideas?



---

archive/issue_comments_439645.json:
```json
{
    "body": "<a id='comment:10'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                            |\n|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------|\n|[60c7670](https://git.sagemath.org/sage.git/commit/?id=60c7670202ce210b437c940f52af26e0b0d391e0)|`removed false statement from the docstring`|\n|[e960c8a](https://git.sagemath.org/sage.git/commit/?id=e960c8aad05190eda6f4f836ce4c15dd663d82ff)|`Turns out print() does not flush I/O by default`|",
    "created_at": "2017-10-25T11:33:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439645",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                            |
|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------|
|[60c7670](https://git.sagemath.org/sage.git/commit/?id=60c7670202ce210b437c940f52af26e0b0d391e0)|`removed false statement from the docstring`|
|[e960c8a](https://git.sagemath.org/sage.git/commit/?id=e960c8aad05190eda6f4f836ce4c15dd663d82ff)|`Turns out print() does not flush I/O by default`|



---

archive/issue_comments_439646.json:
```json
{
    "body": "Changing commit from \"5e89b68a1590856bb4eab77f5e479fd9ac72a17f\" to \"e960c8aad05190eda6f4f836ce4c15dd663d82ff\"",
    "created_at": "2017-10-25T11:33:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439646",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "5e89b68a1590856bb4eab77f5e479fd9ac72a17f" to "e960c8aad05190eda6f4f836ce4c15dd663d82ff"



---

archive/issue_comments_439647.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [embray](#comment%3A9):\n> the fact that it uses Python is not an impediment to that, since build tools are allowed to use the system Python (and in fact require it).\n\n\nIf I recall correctly, we require system Python 2.6 or later, which means that you can't use `argparse`.",
    "created_at": "2017-10-25T11:37:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439647",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>
Replying to [embray](#comment%3A9):
> the fact that it uses Python is not an impediment to that, since build tools are allowed to use the system Python (and in fact require it).


If I recall correctly, we require system Python 2.6 or later, which means that you can't use `argparse`.



---

archive/issue_comments_439648.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [git](#comment%3A10):\n> |                                                                                                                                           |                                                 |\n> |-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------|\n> |[e960c8a](https://git.sagemath.org/sage.git/commit/?id=e960c8aad05190eda6f4f836ce4c15dd663d82ff)|`Turns out print() does not flush I/O by default`|\n\n\nThe `flush` keyword is Python 3 only.",
    "created_at": "2017-10-25T11:39:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439648",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>
Replying to [git](#comment%3A10):
> |                                                                                                                                           |                                                 |
> |-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------|
> |[e960c8a](https://git.sagemath.org/sage.git/commit/?id=e960c8aad05190eda6f4f836ce4c15dd663d82ff)|`Turns out print() does not flush I/O by default`|


The `flush` keyword is Python 3 only.



---

archive/issue_comments_439649.json:
```json
{
    "body": "<a id='comment:13'></a>\nD'oh, how annoying.  In that case I'll just switch it back to `sys.stderr.write...`.",
    "created_at": "2017-10-25T12:20:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439649",
    "user": "https://github.com/embray"
}
```

<a id='comment:13'></a>
D'oh, how annoying.  In that case I'll just switch it back to `sys.stderr.write...`.



---

archive/issue_comments_439650.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [jdemeyer](#comment%3A11):\n> Replying to [embray](#comment%3A9):\n> > the fact that it uses Python is not an impediment to that, since build tools are allowed to use the system Python (and in fact require it).\n\n> \n> If I recall correctly, we require system Python 2.6 or later, which means that you can't use `argparse`.\n\n\nThat's not an issue.  We already addressed this some time ago... https://git.sagemath.org/sage.git/tree/build/sage_bootstrap/compat?id=3faf8d0519918feb308b3bb56fbe36e0a0c2a290\n\nThe question is, should the script live in `build/bin` or `src/bin`, and what should go in the shebang line?  This is unclear for Python scripts that we want to work at build time and run time...",
    "created_at": "2017-10-25T12:22:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439650",
    "user": "https://github.com/embray"
}
```

<a id='comment:14'></a>
Replying to [jdemeyer](#comment%3A11):
> Replying to [embray](#comment%3A9):
> > the fact that it uses Python is not an impediment to that, since build tools are allowed to use the system Python (and in fact require it).

> 
> If I recall correctly, we require system Python 2.6 or later, which means that you can't use `argparse`.


That's not an issue.  We already addressed this some time ago... https://git.sagemath.org/sage.git/tree/build/sage_bootstrap/compat?id=3faf8d0519918feb308b3bb56fbe36e0a0c2a290

The question is, should the script live in `build/bin` or `src/bin`, and what should go in the shebang line?  This is unclear for Python scripts that we want to work at build time and run time...



---

archive/issue_comments_439651.json:
```json
{
    "body": "Changing commit from \"e960c8aad05190eda6f4f836ce4c15dd663d82ff\" to \"6e3333d66f82e35d671a99bd5ebde41e60656982\"",
    "created_at": "2017-10-25T12:25:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439651",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "e960c8aad05190eda6f4f836ce4c15dd663d82ff" to "6e3333d66f82e35d671a99bd5ebde41e60656982"



---

archive/issue_comments_439652.json:
```json
{
    "body": "<a id='comment:15'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                                  |\n|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------|\n|[6e3333d](https://git.sagemath.org/sage.git/commit/?id=6e3333d66f82e35d671a99bd5ebde41e60656982)|`Annoyingly, the flush kwarg for the print_function does not exist in Python 2...`|",
    "created_at": "2017-10-25T12:25:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439652",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                                  |
|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------|
|[6e3333d](https://git.sagemath.org/sage.git/commit/?id=6e3333d66f82e35d671a99bd5ebde41e60656982)|`Annoyingly, the flush kwarg for the print_function does not exist in Python 2...`|



---

archive/issue_comments_439653.json:
```json
{
    "body": "<a id='comment:16'></a>\nReplying to [embray](#comment%3A9):\n> I need to use it for basically all packages\n\n\nWhat is your use case?",
    "created_at": "2017-10-25T12:25:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439653",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'></a>
Replying to [embray](#comment%3A9):
> I need to use it for basically all packages


What is your use case?



---

archive/issue_comments_439654.json:
```json
{
    "body": "<a id='comment:17'></a>\nSee description.",
    "created_at": "2017-10-25T12:31:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439654",
    "user": "https://github.com/embray"
}
```

<a id='comment:17'></a>
See description.



---

archive/issue_comments_439655.json:
```json
{
    "body": "<a id='comment:18'></a>\nTo clarify, the `sage-rebase` command opens, and often writes to, every DLL installed in `$SAGE_LOCAL`.  It is run at the end of every package build.  If two packages complete build/installation at the same time, then there is a race to run `sage-rebase`, and the second one can fail, causing the build to halt.  This especially happens while installing the Python packages because there are a large number of packages being installed quickly one after the other.  But it can happen (and has happened) in principle any other time.  So I need to put a lock around `sage-rebase` to prevent it from being run simultaneously for multiple packages.",
    "created_at": "2017-10-25T12:34:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439655",
    "user": "https://github.com/embray"
}
```

<a id='comment:18'></a>
To clarify, the `sage-rebase` command opens, and often writes to, every DLL installed in `$SAGE_LOCAL`.  It is run at the end of every package build.  If two packages complete build/installation at the same time, then there is a race to run `sage-rebase`, and the second one can fail, causing the build to halt.  This especially happens while installing the Python packages because there are a large number of packages being installed quickly one after the other.  But it can happen (and has happened) in principle any other time.  So I need to put a lock around `sage-rebase` to prevent it from being run simultaneously for multiple packages.



---

archive/issue_comments_439656.json:
```json
{
    "body": "<a id='comment:19'></a>\nReplying to [embray](#comment%3A14):\n> what should go in the shebang line?\n\n\nIf you intend to use the system Python if applicable, it should be `#!/usr/bin/env python`.",
    "created_at": "2017-10-25T12:37:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439656",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'></a>
Replying to [embray](#comment%3A14):
> what should go in the shebang line?


If you intend to use the system Python if applicable, it should be `#!/usr/bin/env python`.



---

archive/issue_comments_439657.json:
```json
{
    "body": "<a id='comment:20'></a>\nReplying to [jdemeyer](#comment%3A19):\n> Replying to [embray](#comment%3A14):\n> > what should go in the shebang line?\n\n> \n> If you intend to use the system Python if applicable, it should be `#!/usr/bin/env python`.\n\n\nBut that's the problem, because if it's intended to be used at runtime it should in that case be using Sage's Python (I guess?), and with `SAGE_PYTHON3=yes` this is incorrect since `python` still means `python2.7`.\n\nThat said, the original use case for this was with `pip`, and running `pip` is still arguably a \"build\" action, so maybe this should just be moved to `build/bin` to emphasize that it's a build tool.  It can use the system python by default and/or Sage's Python 2 because ultimately it doesn't matter what Python this is run with since it just execs the program it wraps.",
    "created_at": "2017-10-25T12:45:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439657",
    "user": "https://github.com/embray"
}
```

<a id='comment:20'></a>
Replying to [jdemeyer](#comment%3A19):
> Replying to [embray](#comment%3A14):
> > what should go in the shebang line?

> 
> If you intend to use the system Python if applicable, it should be `#!/usr/bin/env python`.


But that's the problem, because if it's intended to be used at runtime it should in that case be using Sage's Python (I guess?), and with `SAGE_PYTHON3=yes` this is incorrect since `python` still means `python2.7`.

That said, the original use case for this was with `pip`, and running `pip` is still arguably a "build" action, so maybe this should just be moved to `build/bin` to emphasize that it's a build tool.  It can use the system python by default and/or Sage's Python 2 because ultimately it doesn't matter what Python this is run with since it just execs the program it wraps.



---

archive/issue_comments_439658.json:
```json
{
    "body": "Changing commit from \"6e3333d66f82e35d671a99bd5ebde41e60656982\" to \"3ec24bc115b2af33c48fe26f27d42eadf38793f7\"",
    "created_at": "2017-10-25T12:48:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439658",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "6e3333d66f82e35d671a99bd5ebde41e60656982" to "3ec24bc115b2af33c48fe26f27d42eadf38793f7"



---

archive/issue_comments_439659.json:
```json
{
    "body": "<a id='comment:21'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                                                       |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------|\n|[3ec24bc](https://git.sagemath.org/sage.git/commit/?id=3ec24bc115b2af33c48fe26f27d42eadf38793f7)|`Moved to build/bin to emphasize that this is primarily a build utility (under its current use cases).`|",
    "created_at": "2017-10-25T12:48:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439659",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                                                       |
|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------|
|[3ec24bc](https://git.sagemath.org/sage.git/commit/?id=3ec24bc115b2af33c48fe26f27d42eadf38793f7)|`Moved to build/bin to emphasize that this is primarily a build utility (under its current use cases).`|



---

archive/issue_comments_439660.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-10-25T12:49:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439660",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_439661.json:
```json
{
    "body": "<a id='comment:22'></a>\nYou've convinced me (and/or I've convinced myself) that this is the best approach.",
    "created_at": "2017-10-25T12:49:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439661",
    "user": "https://github.com/embray"
}
```

<a id='comment:22'></a>
You've convinced me (and/or I've convinced myself) that this is the best approach.



---

archive/issue_comments_439662.json:
```json
{
    "body": "<a id='comment:23'></a>\nReplying to [embray](#comment%3A14):\n> That's not an issue.  We already addressed this some time ago... https://git.sagemath.org/sage.git/tree/build/sage_bootstrap/compat?id=3faf8d0519918feb308b3bb56fbe36e0a0c2a290\n\n\nBut then you need to ensure that your script can find this `argparse` module.",
    "created_at": "2017-10-25T13:17:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439662",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:23'></a>
Replying to [embray](#comment%3A14):
> That's not an issue.  We already addressed this some time ago... https://git.sagemath.org/sage.git/tree/build/sage_bootstrap/compat?id=3faf8d0519918feb308b3bb56fbe36e0a0c2a290


But then you need to ensure that your script can find this `argparse` module.



---

archive/issue_comments_439663.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-10-25T13:17:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439663",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_439664.json:
```json
{
    "body": "<a id='comment:24'></a>\nOkay, I was under the mistaken assumption, for some reason, that this was added to `PYTHONPATH` during builds.",
    "created_at": "2017-10-25T13:41:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439664",
    "user": "https://github.com/embray"
}
```

<a id='comment:24'></a>
Okay, I was under the mistaken assumption, for some reason, that this was added to `PYTHONPATH` during builds.



---

archive/issue_comments_439665.json:
```json
{
    "body": "<a id='comment:25'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                                                                                                                              |\n|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|\n|[18f9454](https://git.sagemath.org/sage.git/commit/?id=18f94549d75c43766b8ec8dc1c3d41a0e0607b9a)|`Move the contents of sage-flock into the sage_bootstrap package itself, and replace the sage-flock script with a boilerplate script to import and run it from sage_bootstrap`|",
    "created_at": "2017-10-26T09:45:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439665",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:25'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                                                                                                                              |
|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|[18f9454](https://git.sagemath.org/sage.git/commit/?id=18f94549d75c43766b8ec8dc1c3d41a0e0607b9a)|`Move the contents of sage-flock into the sage_bootstrap package itself, and replace the sage-flock script with a boilerplate script to import and run it from sage_bootstrap`|



---

archive/issue_comments_439666.json:
```json
{
    "body": "Changing commit from \"3ec24bc115b2af33c48fe26f27d42eadf38793f7\" to \"18f94549d75c43766b8ec8dc1c3d41a0e0607b9a\"",
    "created_at": "2017-10-26T09:45:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439666",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "3ec24bc115b2af33c48fe26f27d42eadf38793f7" to "18f94549d75c43766b8ec8dc1c3d41a0e0607b9a"



---

archive/issue_comments_439667.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-10-26T09:45:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439667",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_439668.json:
```json
{
    "body": "Changing commit from \"18f94549d75c43766b8ec8dc1c3d41a0e0607b9a\" to \"b6e4a62d7d304dd714c0c63ff35c53dc6484d0c5\"",
    "created_at": "2017-10-31T15:25:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439668",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "18f94549d75c43766b8ec8dc1c3d41a0e0607b9a" to "b6e4a62d7d304dd714c0c63ff35c53dc6484d0c5"



---

archive/issue_comments_439669.json:
```json
{
    "body": "<a id='comment:27'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                                                                                                    |\n|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------|\n|[b6e4a62](https://git.sagemath.org/sage.git/commit/?id=b6e4a62d7d304dd714c0c63ff35c53dc6484d0c5)|`Merely being part of the sage_bootstrap package doesn't mean we don't still have to manually try to import argparse from the bundled compat module`|",
    "created_at": "2017-10-31T15:25:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439669",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:27'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                                                                                                    |
|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------|
|[b6e4a62](https://git.sagemath.org/sage.git/commit/?id=b6e4a62d7d304dd714c0c63ff35c53dc6484d0c5)|`Merely being part of the sage_bootstrap package doesn't mean we don't still have to manually try to import argparse from the bundled compat module`|



---

archive/issue_comments_439670.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-11-03T12:44:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439670",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_439671.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2017-11-14T09:44:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439671",
    "user": "https://github.com/embray"
}
```

Changing priority from major to critical.



---

archive/issue_comments_439672.json:
```json
{
    "body": "<a id='comment:29'></a>\nThis is increasingly critical since not having it can lead to failures even in the patchbot base build, causing the patchbot to exit.",
    "created_at": "2017-11-14T09:44:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439672",
    "user": "https://github.com/embray"
}
```

<a id='comment:29'></a>
This is increasingly critical since not having it can lead to failures even in the patchbot base build, causing the patchbot to exit.



---

archive/issue_comments_439673.json:
```json
{
    "body": "Changing branch from \"u/embray/build/lockfile\" to \"b6e4a62d7d304dd714c0c63ff35c53dc6484d0c5\"",
    "created_at": "2017-12-11T01:04:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439673",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/embray/build/lockfile" to "b6e4a62d7d304dd714c0c63ff35c53dc6484d0c5"



---

archive/issue_comments_439674.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-12-11T01:04:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23397#issuecomment-439674",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_060152.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-12-11T01:04:13Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23397",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23397#event-60152"
}
```
