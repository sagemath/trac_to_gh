# Issue 23138: Cache assumptions and only send to Maxima when needed

archive/issues_022901.json:
```json
{
    "body": "CC:  @rwst @egourgoulhon\n\nKeywords: Maxima, symbolics, assume\n\nAs described in https://groups.google.com/forum/#!topic/sage-devel/jN6inWPyElM, `assume()` takes more and more time the bigger the `assumptions()` data base is. This causes a lot of slow-downs when e.g. declaring variables with a `domain` argument. Nils Bruin suggested that this is due to excessive interactions with the Maxima library and Ralf Stephan suggested that the assumptions could be cached and only sent to Maxima when needed, to speed up the process.\n\nIssue created by migration from https://trac.sagemath.org/ticket/23138\n\n",
    "created_at": "2017-06-04T20:24:41Z",
    "labels": [
        "component: performance"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "Cache assumptions and only send to Maxima when needed",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23138",
    "user": "https://trac.sagemath.org/admin/accounts/users/schymans"
}
```
CC:  @rwst @egourgoulhon

Keywords: Maxima, symbolics, assume

As described in https://groups.google.com/forum/#!topic/sage-devel/jN6inWPyElM, `assume()` takes more and more time the bigger the `assumptions()` data base is. This causes a lot of slow-downs when e.g. declaring variables with a `domain` argument. Nils Bruin suggested that this is due to excessive interactions with the Maxima library and Ralf Stephan suggested that the assumptions could be cached and only sent to Maxima when needed, to speed up the process.

Issue created by migration from https://trac.sagemath.org/ticket/23138





---

archive/issue_comments_319971.json:
```json
{
    "body": "Thanks. The Author field is for the developer, you're the Reporter as you can see top left.",
    "created_at": "2017-06-05T05:07:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23138#issuecomment-319971",
    "user": "https://github.com/rwst"
}
```

Thanks. The Author field is for the developer, you're the Reporter as you can see top left.



---

archive/issue_comments_319972.json:
```json
{
    "body": "The \"more persistent domains() database\" exists already in part as GiNaC/Pynac info flags that are set in parallel to Maxima's assumptions. They can be queried with ex.is_real() etc...What is not saved in Pynac are less elementary assumptions like x>1, y+z==pi. Now instead of caching all assumptions in a database (either Python or C++) and sending to Maxima on demand in bulk, another possibility could be, as you say, to just remove the assume calls on variable creation because they are all elementary assumptions. Then when Maxima needs them for integration, solving etc take the information from Pynac and do assumes for just those variables that are needed. Am I missing something?",
    "created_at": "2017-06-15T06:20:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23138#issuecomment-319972",
    "user": "https://github.com/rwst"
}
```

The "more persistent domains() database" exists already in part as GiNaC/Pynac info flags that are set in parallel to Maxima's assumptions. They can be queried with ex.is_real() etc...What is not saved in Pynac are less elementary assumptions like x>1, y+z==pi. Now instead of caching all assumptions in a database (either Python or C++) and sending to Maxima on demand in bulk, another possibility could be, as you say, to just remove the assume calls on variable creation because they are all elementary assumptions. Then when Maxima needs them for integration, solving etc take the information from Pynac and do assumes for just those variables that are needed. Am I missing something?



---

archive/issue_comments_319973.json:
```json
{
    "body": "`@`rws, that would be awesome. My current workaround is not to pass the domain information to var() at all, but just save it in a separate assumptions database, in case it is needed at some point. Unfortunately, this also prevents the domain information from being passed to GiNaC/Pynac. Removing the assume() calls during variable creation would be a neater way of going about this. The problem that assume() takes longer and longer the more assumptions have already been passed, could then be approached independently. Should I try to remove the assume() calls, run the doctests and try to create a patch, or could someone else? Sorry about my ignorance regarding the development processes for [SageMath](SageMath).",
    "created_at": "2017-06-19T11:30:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23138#issuecomment-319973",
    "user": "https://trac.sagemath.org/admin/accounts/users/schymans"
}
```

`@`rws, that would be awesome. My current workaround is not to pass the domain information to var() at all, but just save it in a separate assumptions database, in case it is needed at some point. Unfortunately, this also prevents the domain information from being passed to GiNaC/Pynac. Removing the assume() calls during variable creation would be a neater way of going about this. The problem that assume() takes longer and longer the more assumptions have already been passed, could then be approached independently. Should I try to remove the assume() calls, run the doctests and try to create a patch, or could someone else? Sorry about my ignorance regarding the development processes for [SageMath](SageMath).



---

archive/issue_comments_319974.json:
```json
{
    "body": "Replying to [comment:4 schymans]:\n> ...Should I try to remove the assume() calls, run the doctests and try to create a patch, or could someone else?\n\n\nOnly removing the calls will make all doctests fail that rely on different variable domains than complex with operations that use Maxima, like integration and solving equations. So additional code is needed. I'll look into it. Of course you can change it in your local copy if you don't need these operation. However it *is possible that other things break.",
    "created_at": "2017-06-20T05:54:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23138#issuecomment-319974",
    "user": "https://github.com/rwst"
}
```

Replying to [comment:4 schymans]:
> ...Should I try to remove the assume() calls, run the doctests and try to create a patch, or could someone else?


Only removing the calls will make all doctests fail that rely on different variable domains than complex with operations that use Maxima, like integration and solving equations. So additional code is needed. I'll look into it. Of course you can change it in your local copy if you don't need these operation. However it *is possible that other things break.



---

archive/issue_comments_319975.json:
```json
{
    "body": "I thought that in most doctests relying on other variable domains in maxima those would be passed as assume() anyway. I haven't really seen the `var(..., domain=...)` in use. Is there a way to search all doctests for `domain=`?",
    "created_at": "2017-06-20T08:23:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23138#issuecomment-319975",
    "user": "https://trac.sagemath.org/admin/accounts/users/schymans"
}
```

I thought that in most doctests relying on other variable domains in maxima those would be passed as assume() anyway. I haven't really seen the `var(..., domain=...)` in use. Is there a way to search all doctests for `domain=`?



---

archive/issue_comments_319976.json:
```json
{
    "body": "Replying to [comment:6 schymans]:\n> I thought that in most doctests relying on other variable domains in maxima those would be passed as assume() anyway. I haven't really seen the `var(..., domain=...)` in use. Is there a way to search all doctests for `domain=`?\n\n\n```\nralf@ark:~/sage> grep --recursive -l 'sage: .*var(.*domain=' src/sage/ |grep 'py$\\|pyx$'\nsrc/sage/misc/functional.py\nsrc/sage/symbolic/ring.pyx\nsrc/sage/symbolic/assumptions.py\nsrc/sage/symbolic/expression.pyx\nsrc/sage/tensor/modules/free_module_tensor.py\nsrc/sage/tensor/modules/free_module_alt_form.py\nsrc/sage/tensor/modules/comp.py\nsrc/sage/geometry/riemannian_manifolds/parametrized_surface3d.py\nsrc/sage/functions/other.py\nsrc/sage/functions/hyperbolic.py\nsrc/sage/functions/log.py\nsrc/sage/functions/trig.py\nsrc/sage/calculus/wester.py\nsrc/sage/calculus/var.pyx\n```",
    "created_at": "2017-06-20T08:58:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23138#issuecomment-319976",
    "user": "https://github.com/rwst"
}
```

Replying to [comment:6 schymans]:
> I thought that in most doctests relying on other variable domains in maxima those would be passed as assume() anyway. I haven't really seen the `var(..., domain=...)` in use. Is there a way to search all doctests for `domain=`?


```
ralf@ark:~/sage> grep --recursive -l 'sage: .*var(.*domain=' src/sage/ |grep 'py$\|pyx$'
src/sage/misc/functional.py
src/sage/symbolic/ring.pyx
src/sage/symbolic/assumptions.py
src/sage/symbolic/expression.pyx
src/sage/tensor/modules/free_module_tensor.py
src/sage/tensor/modules/free_module_alt_form.py
src/sage/tensor/modules/comp.py
src/sage/geometry/riemannian_manifolds/parametrized_surface3d.py
src/sage/functions/other.py
src/sage/functions/hyperbolic.py
src/sage/functions/log.py
src/sage/functions/trig.py
src/sage/calculus/wester.py
src/sage/calculus/var.pyx
```



---

archive/issue_comments_319977.json:
```json
{
    "body": "OK, the doctests do indeed use `domain=` in `var()` instead of `assume()` on many occasions, so this would not work. It is a bit strange, though, to populate the `assumptions()` data base through the `var()` call, as `assumptions()` can be modified and deleted at any time, whereas the GiNaC domain setting is persistent. I think it would be cleaner if all code passed to maxima was accompanied by its own assumptions, which would be partly derived from the GiNaC variable properties and partly user-defined. Would this require changing every single method that calls maxima?",
    "created_at": "2017-06-20T09:35:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23138#issuecomment-319977",
    "user": "https://trac.sagemath.org/admin/accounts/users/schymans"
}
```

OK, the doctests do indeed use `domain=` in `var()` instead of `assume()` on many occasions, so this would not work. It is a bit strange, though, to populate the `assumptions()` data base through the `var()` call, as `assumptions()` can be modified and deleted at any time, whereas the GiNaC domain setting is persistent. I think it would be cleaner if all code passed to maxima was accompanied by its own assumptions, which would be partly derived from the GiNaC variable properties and partly user-defined. Would this require changing every single method that calls maxima?



---

archive/issue_comments_319978.json:
```json
{
    "body": "Replying to [comment:5 rws]:\n> Replying to [comment:4 schymans]:\n> > ...Should I try to remove the assume() calls, run the doctests and try to create a patch, or could someone else?\n\n\nOkay, it's not as simple as that.",
    "created_at": "2017-06-21T05:47:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23138#issuecomment-319978",
    "user": "https://github.com/rwst"
}
```

Replying to [comment:5 rws]:
> Replying to [comment:4 schymans]:
> > ...Should I try to remove the assume() calls, run the doctests and try to create a patch, or could someone else?


Okay, it's not as simple as that.



---

archive/issue_comments_319979.json:
```json
{
    "body": "Changing component from symbolics to performance.",
    "created_at": "2017-06-21T08:05:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23138#issuecomment-319979",
    "user": "https://github.com/rwst"
}
```

Changing component from symbolics to performance.



---

archive/issue_comments_319980.json:
```json
{
    "body": "Changing type from task to enhancement.",
    "created_at": "2017-06-21T08:05:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23138#issuecomment-319980",
    "user": "https://github.com/rwst"
}
```

Changing type from task to enhancement.



---

archive/issue_comments_319981.json:
```json
{
    "body": "The first commit prevents calls to Maxima, so it should result in a speedup. There is however a bug in Pynac (fixed in 0.7.9) that prevents it from working correctly. With the fix a few doctests fail, so this needs the planned injection of variable domains (EDITED).\n\n---\nNew commits:",
    "created_at": "2017-06-21T08:05:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23138#issuecomment-319981",
    "user": "https://github.com/rwst"
}
```

The first commit prevents calls to Maxima, so it should result in a speedup. There is however a bug in Pynac (fixed in 0.7.9) that prevents it from working correctly. With the fix a few doctests fail, so this needs the planned injection of variable domains (EDITED).

---
New commits:



---

archive/issue_comments_319982.json:
```json
{
    "body": "Following on from https://groups.google.com/forum/#!topic/sage-devel/-A8ZzSKvYsA, `assume()` sends assumptions both to maxima and Pynac. In addition, `assume()` tests if the assumptions are consistent, which is probably not needed when we define a new variable. So, instead of calling `assume()` in `var()` maybe we should just replace it by the same as is done in `assume()` (https://github.com/sagemath/sage/blob/master/src/sage/symbolic/expression.pyx#L1785), i.e. `maxima.assume()`. \n\nTherefore, instead of removing send_sage_domain_to_maxima as in the patch, I would propose to substitute `maxima.assume()` for all `assume()` calls in `send_sage_domain_to_maxima()` (https://github.com/sagemath/sage/blob/master/src/sage/symbolic/ring.pyx#1017). Did I miss something?\n\nReplying to [comment:11 rws]:\n> The first commit prevents calls to Maxima, so it should result in a speedup. There is however a bug in Pynac (fixed in 0.7.9) that prevents it from working correctly. With the fix a few doctests fail, so this needs the planned injection of variable domains (EDITED).\n> \n> ---\n> New commits:\n> |                                                                                                                                          |                                           |\n> |------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------|\n> |[10c31a1](https://git.sagemath.org/sage.git/commit?id=10c31a1971edb7c32fd833d9a497a7ade393471f)|`23138: don't call Maxima with new symbols`|",
    "created_at": "2017-06-21T12:39:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23138#issuecomment-319982",
    "user": "https://trac.sagemath.org/admin/accounts/users/schymans"
}
```

Following on from https://groups.google.com/forum/#!topic/sage-devel/-A8ZzSKvYsA, `assume()` sends assumptions both to maxima and Pynac. In addition, `assume()` tests if the assumptions are consistent, which is probably not needed when we define a new variable. So, instead of calling `assume()` in `var()` maybe we should just replace it by the same as is done in `assume()` (https://github.com/sagemath/sage/blob/master/src/sage/symbolic/expression.pyx#L1785), i.e. `maxima.assume()`. 

Therefore, instead of removing send_sage_domain_to_maxima as in the patch, I would propose to substitute `maxima.assume()` for all `assume()` calls in `send_sage_domain_to_maxima()` (https://github.com/sagemath/sage/blob/master/src/sage/symbolic/ring.pyx#1017). Did I miss something?

Replying to [comment:11 rws]:
> The first commit prevents calls to Maxima, so it should result in a speedup. There is however a bug in Pynac (fixed in 0.7.9) that prevents it from working correctly. With the fix a few doctests fail, so this needs the planned injection of variable domains (EDITED).
> 
> ---
> New commits:
> |                                                                                                                                          |                                           |
> |------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------|
> |[10c31a1](https://git.sagemath.org/sage.git/commit?id=10c31a1971edb7c32fd833d9a497a7ade393471f)|`23138: don't call Maxima with new symbols`|



---

archive/issue_comments_319983.json:
```json
{
    "body": "Replying to [comment:12 schymans]:\n> Therefore, instead of removing send_sage_domain_to_maxima as in the patch, I would propose to substitute `maxima.assume()` for all `assume()` calls in `send_sage_domain_to_maxima()` (https://github.com/sagemath/sage/blob/master/src/sage/symbolic/ring.pyx#1017). Did I miss something?\n\n\nWhat takes the time with inconsistency checking is `maxima.assume()` so there would be no difference.",
    "created_at": "2017-06-21T12:51:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23138#issuecomment-319983",
    "user": "https://github.com/rwst"
}
```

Replying to [comment:12 schymans]:
> Therefore, instead of removing send_sage_domain_to_maxima as in the patch, I would propose to substitute `maxima.assume()` for all `assume()` calls in `send_sage_domain_to_maxima()` (https://github.com/sagemath/sage/blob/master/src/sage/symbolic/ring.pyx#1017). Did I miss something?


What takes the time with inconsistency checking is `maxima.assume()` so there would be no difference.



---

archive/issue_comments_319984.json:
```json
{
    "body": "Replying to [comment:7 rws]:\n> Replying to [comment:6 schymans]:\n> > I thought that in most doctests relying on other variable domains in maxima those would be passed as assume() anyway. I haven't really seen the `var(..., domain=...)` in use. Is there a way to search all doctests for `domain=`?\n\n\nJust to mention that `var(..., domain='real', ...)` is used in the code (not doctest part) for manifolds (specifically real manifolds); see line 1449 of `src/sage/manifolds/chart.py`.",
    "created_at": "2017-06-21T15:20:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23138#issuecomment-319984",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:7 rws]:
> Replying to [comment:6 schymans]:
> > I thought that in most doctests relying on other variable domains in maxima those would be passed as assume() anyway. I haven't really seen the `var(..., domain=...)` in use. Is there a way to search all doctests for `domain=`?


Just to mention that `var(..., domain='real', ...)` is used in the code (not doctest part) for manifolds (specifically real manifolds); see line 1449 of `src/sage/manifolds/chart.py`.



---

archive/issue_comments_319985.json:
```json
{
    "body": "Setting to review in order to get a patchbot assessment, now that the abovementioned Pynac fix is in develop. Please set back afterwards.",
    "created_at": "2017-09-06T05:51:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23138#issuecomment-319985",
    "user": "https://github.com/rwst"
}
```

Setting to review in order to get a patchbot assessment, now that the abovementioned Pynac fix is in develop. Please set back afterwards.



---

archive/issue_comments_319986.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-09-06T05:51:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23138#issuecomment-319986",
    "user": "https://github.com/rwst"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_319987.json:
```json
{
    "body": "See patchbot log.",
    "created_at": "2017-09-06T13:18:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23138#issuecomment-319987",
    "user": "https://github.com/rwst"
}
```

See patchbot log.



---

archive/issue_comments_319988.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-09-06T13:18:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23138#issuecomment-319988",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_review to needs_work.
