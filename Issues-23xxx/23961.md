# Issue 23961: construction functor for dendriform algebras

archive/issues_023724.json:
```json
{
    "body": "similar to #22591\n\nCC:  @tscrim\n\nReviewer: Travis Scrimshaw\n\nAuthor: Fr\u00e9d\u00e9ric Chapoton\n\nBranch: 24a631615b988438b571b8475c322f9c3c88a7a7\n\nCommit: 24a631615b988438b571b8475c322f9c3c88a7a7\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/23961\n\n",
    "closed_at": "2017-10-20T09:15:21Z",
    "created_at": "2017-10-03T18:56:02Z",
    "labels": [
        "component: combinatorics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "construction functor for dendriform algebras",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23961",
    "user": "https://github.com/fchapoton"
}
```
similar to #22591

CC:  @tscrim

Reviewer: Travis Scrimshaw

Author: Frédéric Chapoton

Branch: 24a631615b988438b571b8475c322f9c3c88a7a7

Commit: 24a631615b988438b571b8475c322f9c3c88a7a7

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/23961





---

archive/issue_comments_331964.json:
```json
{
    "body": "<a id='comment:1'></a>New commits:",
    "created_at": "2017-10-03T18:56:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23961#issuecomment-331964",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:1'></a>New commits:



---

archive/issue_comments_331965.json:
```json
{
    "body": "<a id='comment:3'></a>beware : there remains 2 failing doctests. I have copied the code from the pre-Lie case, but something seems to go wrong..",
    "created_at": "2017-10-04T06:31:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23961#issuecomment-331965",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:3'></a>beware : there remains 2 failing doctests. I have copied the code from the pre-Lie case, but something seems to go wrong..



---

archive/issue_comments_331966.json:
```json
{
    "body": "<a id='comment:4'></a>So it is doing the pushout correctly:\n\n```\nsage: R = algebras.FreeDendriform(ZZ, 'x,y,z')\nsage: S = algebras.FreeDendriform(QQ, 'zt')\nsage: P = pushout(R, S)\nsage: P\nFree Dendriform algebra on 4 generators ['z', 't', 'x', 'y'] over Rational Field\n```\nThe problem comes from this:\n\n```\nsage: P.coerce_map_from(R)\nsage: P.coerce_map_from(S)\n```\nContrast this with the pre-Lie algebra:\n\n```\nsage: R = algebras.FreePreLie(ZZ, 'xyz')\nsage: S = algebras.FreePreLie(QQ, 'zt')\nsage: P = pushout(R, S)\nsage: P.coerce_map_from(S)\nCoercion map:\n  From: Free PreLie algebra on 2 generators ['z', 't'] over Rational Field\n  To:   Free PreLie algebra on 4 generators ['z', 't', 'x', 'y'] over Rational Field\nsage: P.coerce_map_from(R)\nCoercion map:\n  From: Free PreLie algebra on 3 generators ['x', 'y', 'z'] over Integer Ring\n  To:   Free PreLie algebra on 4 generators ['z', 't', 'x', 'y'] over Rational Field\n```\nHowever, now I run into a problem with an infinite recursion that comes from this:\n\n```\nsage: T = R.basis().keys()\nLabelled binary trees\nsage: z in T  # Which calls the line below\nsage: T(z)    # This is where the problem really comes from\n```\nStrangely, this works:\n\n```\nsage: x in R.basis().keys()\nFalse\nsage: R.basis().keys()(x)\n...  # Takes quite a while to get to this error message\nTypeError: 'sage.rings.integer.Integer' object is not iterable\n```\nThis is the same on vanilla `8.1.beta6` (on `8.1.beta3`, the last one actually returned the \"correct\" error of `ValueError: this is not a binary tree`).\n\nStill investigating.",
    "created_at": "2017-10-04T18:33:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23961#issuecomment-331966",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:4'></a>So it is doing the pushout correctly:

```
sage: R = algebras.FreeDendriform(ZZ, 'x,y,z')
sage: S = algebras.FreeDendriform(QQ, 'zt')
sage: P = pushout(R, S)
sage: P
Free Dendriform algebra on 4 generators ['z', 't', 'x', 'y'] over Rational Field
```
The problem comes from this:

```
sage: P.coerce_map_from(R)
sage: P.coerce_map_from(S)
```
Contrast this with the pre-Lie algebra:

```
sage: R = algebras.FreePreLie(ZZ, 'xyz')
sage: S = algebras.FreePreLie(QQ, 'zt')
sage: P = pushout(R, S)
sage: P.coerce_map_from(S)
Coercion map:
  From: Free PreLie algebra on 2 generators ['z', 't'] over Rational Field
  To:   Free PreLie algebra on 4 generators ['z', 't', 'x', 'y'] over Rational Field
sage: P.coerce_map_from(R)
Coercion map:
  From: Free PreLie algebra on 3 generators ['x', 'y', 'z'] over Integer Ring
  To:   Free PreLie algebra on 4 generators ['z', 't', 'x', 'y'] over Rational Field
```
However, now I run into a problem with an infinite recursion that comes from this:

```
sage: T = R.basis().keys()
Labelled binary trees
sage: z in T  # Which calls the line below
sage: T(z)    # This is where the problem really comes from
```
Strangely, this works:

```
sage: x in R.basis().keys()
False
sage: R.basis().keys()(x)
...  # Takes quite a while to get to this error message
TypeError: 'sage.rings.integer.Integer' object is not iterable
```
This is the same on vanilla `8.1.beta6` (on `8.1.beta3`, the last one actually returned the "correct" error of `ValueError: this is not a binary tree`).

Still investigating.



---

archive/issue_comments_331967.json:
```json
{
    "body": "<a id='comment:5'></a>Okay, so the problem comes down to this:\n\n```\nsage: T(1)\nNone[., .]\nsage: T(1/2)  # BOOM\n```\nNow, why does it infinitely recurse? Answer: `BinaryTree.__init__` iterates over its input if it is not a string, empty list/tuple, or a binary tree. Now what is really strange is we can iterate over rational numbers, but not integers:\n\n```\nsage: list(QQ(1))\n[1]\nsage: list(ZZ(1))\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-10-9e757a9d24a6> in <module>()\n----> 1 list(ZZ(Integer(1)))\n\nTypeError: 'sage.rings.integer.Integer' object is not iterable\n```\nIt is the fact that a rational number iterator just yields itself, and hence the loop:\n\n```\nsage: list(1/2)\n[1/2]\n```\nIn particular, this iterator behavior comes from implemented in `Rational.list`. This was done for compatibility with number fields according to its docstring.\n\n---\nSo now we need to decide how to fix this bug (which we can do here or a separate ticket). Note #23821 does not affect this problem. Here are some possible solutions that come to my mind:\n\n1. Only allowing list, tuple, and subclasses of `Tree` for iteration (in `BinaryTree.__init__`).\n2. Immediately error out on subclasses of `FieldElement` for iteration.\n3. Immediately error out on any element whose parent is in `Rings` for iteration.\n4. Immediately error out if any iterator that does not give a length 2 list.",
    "created_at": "2017-10-04T19:02:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23961#issuecomment-331967",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:5'></a>Okay, so the problem comes down to this:

```
sage: T(1)
None[., .]
sage: T(1/2)  # BOOM
```
Now, why does it infinitely recurse? Answer: `BinaryTree.__init__` iterates over its input if it is not a string, empty list/tuple, or a binary tree. Now what is really strange is we can iterate over rational numbers, but not integers:

```
sage: list(QQ(1))
[1]
sage: list(ZZ(1))
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-10-9e757a9d24a6> in <module>()
----> 1 list(ZZ(Integer(1)))

TypeError: 'sage.rings.integer.Integer' object is not iterable
```
It is the fact that a rational number iterator just yields itself, and hence the loop:

```
sage: list(1/2)
[1/2]
```
In particular, this iterator behavior comes from implemented in `Rational.list`. This was done for compatibility with number fields according to its docstring.

---
So now we need to decide how to fix this bug (which we can do here or a separate ticket). Note #23821 does not affect this problem. Here are some possible solutions that come to my mind:

1. Only allowing list, tuple, and subclasses of `Tree` for iteration (in `BinaryTree.__init__`).
2. Immediately error out on subclasses of `FieldElement` for iteration.
3. Immediately error out on any element whose parent is in `Rings` for iteration.
4. Immediately error out if any iterator that does not give a length 2 list.



---

archive/issue_comments_331968.json:
```json
{
    "body": "<a id='comment:6'></a>New commits:",
    "created_at": "2017-10-04T19:03:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23961#issuecomment-331968",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:6'></a>New commits:



---

archive/issue_comments_331969.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-10-08T08:44:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23961#issuecomment-331969",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_331970.json:
```json
{
    "body": "<a id='comment:8'></a>I have added a simple check in the init of binary trees.",
    "created_at": "2017-10-08T08:47:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23961#issuecomment-331970",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:8'></a>I have added a simple check in the init of binary trees.



---

archive/issue_comments_331971.json:
```json
{
    "body": "<a id='comment:9'></a>Works for me, but I think we should add a test in the `BinaryTree.__init__` about the infinite loop with a `QQ` element. I would set a positive review otherwise if this is ready for review.",
    "created_at": "2017-10-08T15:31:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23961#issuecomment-331971",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:9'></a>Works for me, but I think we should add a test in the `BinaryTree.__init__` about the infinite loop with a `QQ` element. I would set a positive review otherwise if this is ready for review.



---

archive/issue_comments_331972.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-10-08T16:22:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23961#issuecomment-331972",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_331973.json:
```json
{
    "body": "<a id='comment:11'></a>I have added the doctest. Patchbot was green before this addition.",
    "created_at": "2017-10-08T16:24:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23961#issuecomment-331973",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:11'></a>I have added the doctest. Patchbot was green before this addition.



---

archive/issue_comments_331974.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-10-08T16:24:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23961#issuecomment-331974",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_331975.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-10-08T21:27:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23961#issuecomment-331975",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_331976.json:
```json
{
    "body": "<a id='comment:13'></a>I expanded the documentation about that test a little bit more. If my change is good, then positive review.",
    "created_at": "2017-10-08T21:28:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23961#issuecomment-331976",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:13'></a>I expanded the documentation about that test a little bit more. If my change is good, then positive review.



---

archive/issue_comments_331977.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-10-09T06:50:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23961#issuecomment-331977",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_331978.json:
```json
{
    "body": "<a id='comment:14'></a>ok, thanks",
    "created_at": "2017-10-09T06:50:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23961#issuecomment-331978",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:14'></a>ok, thanks



---

archive/issue_events_060971.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-10-20T09:15:21Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23961",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23961#event-60971"
}
```



---

archive/issue_comments_331979.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-10-20T09:15:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23961#issuecomment-331979",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
