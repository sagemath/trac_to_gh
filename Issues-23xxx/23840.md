# Issue 23840: Doctest failures in ell_number_field.py

archive/issues_023603.json:
```json
{
    "body": "When the optional package database_cremona_ellcurve is installed, doctest failures happen (see below). The underlying reason is that the Cremona database contains a different generator for elliptic curve `37a1` than the one computed with the `.gens()` method (the generators are each other's negative):\n\n```\nsage: EllipticCurve(\"37a1\")._compute_gens(proof=True, use_database=True)\n([(0 : 0 : 1)], True)\nsage: EllipticCurve(\"37a1\")._compute_gens(proof=True, use_database=False)\n([(0 : -1 : 1)], True)\n```\n\nDoctest failures:\n\n```\nsage -t --long --warn-long 74.4 src/sage/schemes/elliptic_curves/ell_number_field.py\n**********************************************************************\nFile \"src/sage/schemes/elliptic_curves/ell_number_field.py\", line 2457, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.gens\nFailed example:\n    E.gens()\nExpected:\n    [(-2 : -1/2*a - 1/2 : 1), (0 : -1 : 1)]\nGot:\n    [(-2 : 1/2*a - 1/2 : 1), (0 : 0 : 1)]\n**********************************************************************\nFile \"src/sage/schemes/elliptic_curves/ell_number_field.py\", line 2841, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.isogeny_class\nWarning, slow doctest:\n    CL = EL.isogeny_class(); len(CL) # long time (~80s)\nTest ran for 118.41 s\n**********************************************************************\nFile \"src/sage/schemes/elliptic_curves/ell_number_field.py\", line 3310, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.lll_reduce\nFailed example:\n    E.lll_reduce(E.gens())\nExpected:\n    (\n                                           [0 1]\n    [(0 : -1 : 1), (-2 : -1/2*a - 1/2 : 1)], [1 0]\n    )\nGot:\n    (\n                                           [0 1]\n    [(0 : 0 : 1), (-2 : 1/2*a - 1/2 : 1)], [1 0]\n    )\n**********************************************************************\nFile \"src/sage/schemes/elliptic_curves/ell_number_field.py\", line 3607, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.?\nFailed example:\n    EK.saturation([2*P, Q], max_prime=2)\nExpected:\n    ([(-1 : 1 : 1), (0 : -1 : 1)], 2, 0.152460177943144)\nGot:\n    ([(-1 : 1 : 1), (0 : 0 : 1)], 2, 0.152460177943144)\n**********************************************************************\nFile \"src/sage/schemes/elliptic_curves/ell_number_field.py\", line 3609, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.?\nFailed example:\n    EK.saturation([P+Q, P-Q], lower_ht_bound=.1, debug=2)\nExpected:\n    ([(-1 : 1 : 1), (1 : 0 : 1)], 2, 0.152460177943144)\nGot:\n    ([(-1 : 1 : 1), (4 : 8 : 1)], 2, 0.152460177943144)\n**********************************************************************\nFile \"src/sage/schemes/elliptic_curves/ell_number_field.py\", line 3611, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.?\nFailed example:\n    EK.saturation([P+Q, 17*Q], lower_ht_bound=0.1)\nExpected:\n    ([(4 : 8 : 1), (0 : -1 : 1)], 17, 0.152460177943143)\nGot:\n    ([(1 : 0 : 1), (0 : 0 : 1)], 17, 0.152460177943144)\n**********************************************************************\nFile \"src/sage/schemes/elliptic_curves/ell_number_field.py\", line 3615, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.?\nFailed example:\n    P, Q, R\nExpected:\n    ((i - 2 : -i - 3 : 1), (-1 : 1 : 1), (0 : -1 : 1))\nGot:\n    ((i + 1 : -2*i - 1 : 1), (-1 : 1 : 1), (0 : 0 : 1))\n**********************************************************************\nFile \"src/sage/schemes/elliptic_curves/ell_number_field.py\", line 3617, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.?\nFailed example:\n    EK.saturation([P+Q, Q+R, R+P], lower_ht_bound=0.1)\nExpected:\n    ([(841/1369*i - 171/1369 : 41334/50653*i - 74525/50653 : 1),\n      (4 : 8 : 1),\n      (-1/25*i + 18/25 : -69/125*i - 58/125 : 1)],\n     2,\n     0.103174443217351)\nGot:\n    ([(-5*i : -9*i - 8 : 1), (1 : 0 : 1), (1/2*i : 3/4*i - 5/4 : 1)],\n     2,\n     0.103174443217351)\n**********************************************************************\nFile \"src/sage/schemes/elliptic_curves/ell_number_field.py\", line 3623, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.?\nFailed example:\n    EK.saturation([26*R], lower_ht_bound=0.1)\nExpected:\n    ([(0 : -1 : 1)], 26, 0.327000773651605)\nGot:\n    ([(0 : 0 : 1)], 26, 0.327000773651605)\n**********************************************************************\nFile \"src/sage/schemes/elliptic_curves/ell_number_field.py\", line 3632, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.?\nFailed example:\n    EK.saturation([P+Q, P-Q], lower_ht_bound=0.1)\nExpected:\n    ([(-1 : 1 : 1), (1 : 0 : 1)], 2, 0.152460177943144)\nGot:\n    ([(-1 : 1 : 1), (4 : 8 : 1)], 2, 0.152460177943144)\n**********************************************************************\nFile \"src/sage/schemes/elliptic_curves/ell_number_field.py\", line 3634, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.?\nFailed example:\n    EK.saturation([3*P, P+5*Q], lower_ht_bound=0.1)\nExpected:\n    ([(-185/2209 : -119510/103823 : 1), (80041/34225 : -26714961/6331625 : 1)],\n     15,\n     0.152460177943144)\nGot:\n    ([(-14/25 : -216/125 : 1), (445/49 : -9955/343 : 1)], 15, 0.152460177943144)\n**********************************************************************\nFile \"src/sage/schemes/elliptic_curves/ell_number_field.py\", line 3645, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.?\nFailed example:\n    EK.saturation([3*P-Q, 3*P+Q], lower_ht_bound=.01)\nExpected:\n    ([(-a + 2 : 2*a - 4 : 1),\n      (8820833592677/3284478409969*a + 13569900067225/3284478409969 : 43082636045850669307/5952502920606148297*a + 76367500748298491757/5952502920606148297 : 1)],\n     6,\n     0.0317814530725985)\nGot:\n    ([(a + 2 : 2*a + 3 : 1),\n      (-8820833592677/3284478409969*a + 13569900067225/3284478409969 : 43082636045850669307/5952502920606148297*a - 82320003668904640054/5952502920606148297 : 1)],\n     6,\n     0.0317814530725985)\n**********************************************************************\nFile \"src/sage/schemes/elliptic_curves/ell_number_field.py\", line 3679, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.?\nFailed example:\n    EK.saturation([P+Q, P-Q], lower_ht_bound=.1, debug=2)\nExpected:\n    ([(-1 : 1 : 1), (1 : 0 : 1)], 2, 0.152460177943144)\nGot:\n    ([(-1 : 1 : 1), (4 : 8 : 1)], 2, 0.152460177943144)\n**********************************************************************\nFile \"src/sage/schemes/elliptic_curves/ell_number_field.py\", line 3681, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.?\nFailed example:\n    EK.saturation([5*P+6*Q, 5*P-3*Q], lower_ht_bound=.1)\nExpected:\n    ([(-3/4 : -15/8 : 1), (159965/16129 : -67536260/2048383 : 1)],\n    45,\n    0.152460177943144)\nGot:\n    ([(-51/25 : -68/125 : 1),\n      (1433882253389/379703672401 : 1707565715369408803/233973782637168601 : 1)],\n     45,\n     0.152460177943144)\n**********************************************************************\nFile \"src/sage/schemes/elliptic_curves/ell_number_field.py\", line 3685, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.?\nFailed example:\n    EK.saturation([5*P+6*Q, 5*P-3*Q], lower_ht_bound=.1, debug=2)\nExpected:\n    ([(-3/4 : -15/8 : 1), (159965/16129 : -67536260/2048383 : 1)],\n    45,\n    0.152460177943144)\nGot:\n    ([(-51/25 : -68/125 : 1),\n      (1433882253389/379703672401 : 1707565715369408803/233973782637168601 : 1)],\n     45,\n     0.152460177943144)\n**********************************************************************\nFile \"src/sage/schemes/elliptic_curves/ell_number_field.py\", line 3766, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.gens_quadratic\nFailed example:\n    E.change_ring(QuadraticField(-1, 'i')).gens_quadratic()\nExpected:\n    [(0 : -1 : 1)]\nGot:\n    [(0 : 0 : 1)]\n**********************************************************************\nFile \"src/sage/schemes/elliptic_curves/ell_number_field.py\", line 3768, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.gens_quadratic\nFailed example:\n    E.change_ring(QuadraticField(3, 'i')).gens_quadratic()\nExpected:\n    [(-i + 2 : 2*i - 4 : 1), (1/12 : 17/72*i - 1/2 : 1)]\nGot:\n    [(i + 2 : 2*i + 3 : 1), (1/12 : 17/72*i - 1/2 : 1)]\n**********************************************************************\nFile \"src/sage/schemes/elliptic_curves/ell_number_field.py\", line 3772, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.gens_quadratic\nFailed example:\n    EllipticCurve('11a').change_ring(K).gens_quadratic()\nExpected:\n    [(-6 : -11/2*a - 1/2 : 1)]\nGot:\n    [(-6 : 11/2*a - 1/2 : 1)]\n**********************************************************************\nFile \"src/sage/schemes/elliptic_curves/ell_number_field.py\", line 3774, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.gens_quadratic\nFailed example:\n    EllipticCurve('389a').change_ring(K).gens_quadratic()\nExpected:\n    [(1/8*a + 5/8 : -5/16*a - 9/16 : 1), (-1 : 1 : 1), (0 : -1 : 1)]\nGot:\n    [(1/2*a - 1/2 : 1/2*a - 5/2 : 1), (-1 : 1 : 1), (0 : 0 : 1)]\n**********************************************************************\n4 items had failures:\n  12 of  35 in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.?\n   1 of  18 in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.gens\n   4 of   9 in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.gens_quadratic\n   1 of  25 in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.lll_reduce\n    [766 tests, 18 failures, 273.84 s]\n----------------------------------------------------------------------\nsage -t --long --warn-long 74.4 src/sage/schemes/elliptic_curves/ell_number_field.py  # 18 doctests failed\n----------------------------------------------------------------------\n```\n\n**CC:**  @videlec\n\n**Branch/Commit:** [453419e242f8f3e9dcafa6713a13151144df28e2](https://github.com/sagemath/sagetrac-mirror/commit/453419e242f8f3e9dcafa6713a13151144df28e2)\n\n**Reviewer:** Jeroen Demeyer\n\n**Author:** John Cremona\n\nIssue created by migration from https://trac.sagemath.org/ticket/23840\n\n",
    "closed_at": "2017-09-20T22:26:46Z",
    "created_at": "2017-09-12T10:30:58Z",
    "labels": [
        "component: doctest coverage",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.1",
    "title": "Doctest failures in ell_number_field.py",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/23840",
    "user": "https://github.com/jdemeyer"
}
```
When the optional package database_cremona_ellcurve is installed, doctest failures happen (see below). The underlying reason is that the Cremona database contains a different generator for elliptic curve `37a1` than the one computed with the `.gens()` method (the generators are each other's negative):

```
sage: EllipticCurve("37a1")._compute_gens(proof=True, use_database=True)
([(0 : 0 : 1)], True)
sage: EllipticCurve("37a1")._compute_gens(proof=True, use_database=False)
([(0 : -1 : 1)], True)
```

Doctest failures:

```
sage -t --long --warn-long 74.4 src/sage/schemes/elliptic_curves/ell_number_field.py
**********************************************************************
File "src/sage/schemes/elliptic_curves/ell_number_field.py", line 2457, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.gens
Failed example:
    E.gens()
Expected:
    [(-2 : -1/2*a - 1/2 : 1), (0 : -1 : 1)]
Got:
    [(-2 : 1/2*a - 1/2 : 1), (0 : 0 : 1)]
**********************************************************************
File "src/sage/schemes/elliptic_curves/ell_number_field.py", line 2841, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.isogeny_class
Warning, slow doctest:
    CL = EL.isogeny_class(); len(CL) # long time (~80s)
Test ran for 118.41 s
**********************************************************************
File "src/sage/schemes/elliptic_curves/ell_number_field.py", line 3310, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.lll_reduce
Failed example:
    E.lll_reduce(E.gens())
Expected:
    (
                                           [0 1]
    [(0 : -1 : 1), (-2 : -1/2*a - 1/2 : 1)], [1 0]
    )
Got:
    (
                                           [0 1]
    [(0 : 0 : 1), (-2 : 1/2*a - 1/2 : 1)], [1 0]
    )
**********************************************************************
File "src/sage/schemes/elliptic_curves/ell_number_field.py", line 3607, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.?
Failed example:
    EK.saturation([2*P, Q], max_prime=2)
Expected:
    ([(-1 : 1 : 1), (0 : -1 : 1)], 2, 0.152460177943144)
Got:
    ([(-1 : 1 : 1), (0 : 0 : 1)], 2, 0.152460177943144)
**********************************************************************
File "src/sage/schemes/elliptic_curves/ell_number_field.py", line 3609, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.?
Failed example:
    EK.saturation([P+Q, P-Q], lower_ht_bound=.1, debug=2)
Expected:
    ([(-1 : 1 : 1), (1 : 0 : 1)], 2, 0.152460177943144)
Got:
    ([(-1 : 1 : 1), (4 : 8 : 1)], 2, 0.152460177943144)
**********************************************************************
File "src/sage/schemes/elliptic_curves/ell_number_field.py", line 3611, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.?
Failed example:
    EK.saturation([P+Q, 17*Q], lower_ht_bound=0.1)
Expected:
    ([(4 : 8 : 1), (0 : -1 : 1)], 17, 0.152460177943143)
Got:
    ([(1 : 0 : 1), (0 : 0 : 1)], 17, 0.152460177943144)
**********************************************************************
File "src/sage/schemes/elliptic_curves/ell_number_field.py", line 3615, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.?
Failed example:
    P, Q, R
Expected:
    ((i - 2 : -i - 3 : 1), (-1 : 1 : 1), (0 : -1 : 1))
Got:
    ((i + 1 : -2*i - 1 : 1), (-1 : 1 : 1), (0 : 0 : 1))
**********************************************************************
File "src/sage/schemes/elliptic_curves/ell_number_field.py", line 3617, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.?
Failed example:
    EK.saturation([P+Q, Q+R, R+P], lower_ht_bound=0.1)
Expected:
    ([(841/1369*i - 171/1369 : 41334/50653*i - 74525/50653 : 1),
      (4 : 8 : 1),
      (-1/25*i + 18/25 : -69/125*i - 58/125 : 1)],
     2,
     0.103174443217351)
Got:
    ([(-5*i : -9*i - 8 : 1), (1 : 0 : 1), (1/2*i : 3/4*i - 5/4 : 1)],
     2,
     0.103174443217351)
**********************************************************************
File "src/sage/schemes/elliptic_curves/ell_number_field.py", line 3623, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.?
Failed example:
    EK.saturation([26*R], lower_ht_bound=0.1)
Expected:
    ([(0 : -1 : 1)], 26, 0.327000773651605)
Got:
    ([(0 : 0 : 1)], 26, 0.327000773651605)
**********************************************************************
File "src/sage/schemes/elliptic_curves/ell_number_field.py", line 3632, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.?
Failed example:
    EK.saturation([P+Q, P-Q], lower_ht_bound=0.1)
Expected:
    ([(-1 : 1 : 1), (1 : 0 : 1)], 2, 0.152460177943144)
Got:
    ([(-1 : 1 : 1), (4 : 8 : 1)], 2, 0.152460177943144)
**********************************************************************
File "src/sage/schemes/elliptic_curves/ell_number_field.py", line 3634, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.?
Failed example:
    EK.saturation([3*P, P+5*Q], lower_ht_bound=0.1)
Expected:
    ([(-185/2209 : -119510/103823 : 1), (80041/34225 : -26714961/6331625 : 1)],
     15,
     0.152460177943144)
Got:
    ([(-14/25 : -216/125 : 1), (445/49 : -9955/343 : 1)], 15, 0.152460177943144)
**********************************************************************
File "src/sage/schemes/elliptic_curves/ell_number_field.py", line 3645, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.?
Failed example:
    EK.saturation([3*P-Q, 3*P+Q], lower_ht_bound=.01)
Expected:
    ([(-a + 2 : 2*a - 4 : 1),
      (8820833592677/3284478409969*a + 13569900067225/3284478409969 : 43082636045850669307/5952502920606148297*a + 76367500748298491757/5952502920606148297 : 1)],
     6,
     0.0317814530725985)
Got:
    ([(a + 2 : 2*a + 3 : 1),
      (-8820833592677/3284478409969*a + 13569900067225/3284478409969 : 43082636045850669307/5952502920606148297*a - 82320003668904640054/5952502920606148297 : 1)],
     6,
     0.0317814530725985)
**********************************************************************
File "src/sage/schemes/elliptic_curves/ell_number_field.py", line 3679, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.?
Failed example:
    EK.saturation([P+Q, P-Q], lower_ht_bound=.1, debug=2)
Expected:
    ([(-1 : 1 : 1), (1 : 0 : 1)], 2, 0.152460177943144)
Got:
    ([(-1 : 1 : 1), (4 : 8 : 1)], 2, 0.152460177943144)
**********************************************************************
File "src/sage/schemes/elliptic_curves/ell_number_field.py", line 3681, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.?
Failed example:
    EK.saturation([5*P+6*Q, 5*P-3*Q], lower_ht_bound=.1)
Expected:
    ([(-3/4 : -15/8 : 1), (159965/16129 : -67536260/2048383 : 1)],
    45,
    0.152460177943144)
Got:
    ([(-51/25 : -68/125 : 1),
      (1433882253389/379703672401 : 1707565715369408803/233973782637168601 : 1)],
     45,
     0.152460177943144)
**********************************************************************
File "src/sage/schemes/elliptic_curves/ell_number_field.py", line 3685, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.?
Failed example:
    EK.saturation([5*P+6*Q, 5*P-3*Q], lower_ht_bound=.1, debug=2)
Expected:
    ([(-3/4 : -15/8 : 1), (159965/16129 : -67536260/2048383 : 1)],
    45,
    0.152460177943144)
Got:
    ([(-51/25 : -68/125 : 1),
      (1433882253389/379703672401 : 1707565715369408803/233973782637168601 : 1)],
     45,
     0.152460177943144)
**********************************************************************
File "src/sage/schemes/elliptic_curves/ell_number_field.py", line 3766, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.gens_quadratic
Failed example:
    E.change_ring(QuadraticField(-1, 'i')).gens_quadratic()
Expected:
    [(0 : -1 : 1)]
Got:
    [(0 : 0 : 1)]
**********************************************************************
File "src/sage/schemes/elliptic_curves/ell_number_field.py", line 3768, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.gens_quadratic
Failed example:
    E.change_ring(QuadraticField(3, 'i')).gens_quadratic()
Expected:
    [(-i + 2 : 2*i - 4 : 1), (1/12 : 17/72*i - 1/2 : 1)]
Got:
    [(i + 2 : 2*i + 3 : 1), (1/12 : 17/72*i - 1/2 : 1)]
**********************************************************************
File "src/sage/schemes/elliptic_curves/ell_number_field.py", line 3772, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.gens_quadratic
Failed example:
    EllipticCurve('11a').change_ring(K).gens_quadratic()
Expected:
    [(-6 : -11/2*a - 1/2 : 1)]
Got:
    [(-6 : 11/2*a - 1/2 : 1)]
**********************************************************************
File "src/sage/schemes/elliptic_curves/ell_number_field.py", line 3774, in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.gens_quadratic
Failed example:
    EllipticCurve('389a').change_ring(K).gens_quadratic()
Expected:
    [(1/8*a + 5/8 : -5/16*a - 9/16 : 1), (-1 : 1 : 1), (0 : -1 : 1)]
Got:
    [(1/2*a - 1/2 : 1/2*a - 5/2 : 1), (-1 : 1 : 1), (0 : 0 : 1)]
**********************************************************************
4 items had failures:
  12 of  35 in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.?
   1 of  18 in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.gens
   4 of   9 in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.gens_quadratic
   1 of  25 in sage.schemes.elliptic_curves.ell_number_field.EllipticCurve_number_field.reduction.lll_reduce
    [766 tests, 18 failures, 273.84 s]
----------------------------------------------------------------------
sage -t --long --warn-long 74.4 src/sage/schemes/elliptic_curves/ell_number_field.py  # 18 doctests failed
----------------------------------------------------------------------
```

**CC:**  @videlec

**Branch/Commit:** [453419e242f8f3e9dcafa6713a13151144df28e2](https://github.com/sagemath/sagetrac-mirror/commit/453419e242f8f3e9dcafa6713a13151144df28e2)

**Reviewer:** Jeroen Demeyer

**Author:** John Cremona

Issue created by migration from https://trac.sagemath.org/ticket/23840





---

archive/issue_events_211842.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-09-12T13:16:05Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "rename": {
        "from": "Doctest failures in ell_number_field.py with optional packages",
        "to": "Doctest failures in ell_number_field.py"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23840#event-211842"
}
```



---

archive/issue_comments_362236.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-When certain optional packages are installed, this happens:\n+When the optional package database_cremona_ellcurve is installed, this happens:\n \n ```\n sage -t --long --warn-long 74.4 src/sage/schemes/elliptic_curves/ell_number_field.py\n``````\n",
    "created_at": "2017-09-12T13:16:05Z",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23840#issuecomment-362236",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-When certain optional packages are installed, this happens:
+When the optional package database_cremona_ellcurve is installed, this happens:
 
 ```
 sage -t --long --warn-long 74.4 src/sage/schemes/elliptic_curves/ell_number_field.py
``````




---

archive/issue_comments_362237.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,13 @@\n-When the optional package database_cremona_ellcurve is installed, this happens:\n+When the optional package database_cremona_ellcurve is installed, doctest failures happen (see below). The underlying reason is that the Cremona database contains a different generator for elliptic curve `37a1` than the one computed with the `.gens()` method:\n+\n+```\n+sage: EllipticCurve(\"37a1\")._compute_gens(proof=True, use_database=True)\n+([(0 : 0 : 1)], True)\n+sage: EllipticCurve(\"37a1\")._compute_gens(proof=True, use_database=False)\n+([(0 : -1 : 1)], True)\n+```\n+\n+Doctest failures:\n \n ```\n sage -t --long --warn-long 74.4 src/sage/schemes/elliptic_curves/ell_number_field.py\n``````\n",
    "created_at": "2017-09-12T13:59:30Z",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23840#issuecomment-362237",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,13 @@
-When the optional package database_cremona_ellcurve is installed, this happens:
+When the optional package database_cremona_ellcurve is installed, doctest failures happen (see below). The underlying reason is that the Cremona database contains a different generator for elliptic curve `37a1` than the one computed with the `.gens()` method:
+
+```
+sage: EllipticCurve("37a1")._compute_gens(proof=True, use_database=True)
+([(0 : 0 : 1)], True)
+sage: EllipticCurve("37a1")._compute_gens(proof=True, use_database=False)
+([(0 : -1 : 1)], True)
+```
+
+Doctest failures:
 
 ```
 sage -t --long --warn-long 74.4 src/sage/schemes/elliptic_curves/ell_number_field.py
``````




---

archive/issue_comments_362238.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-When the optional package database_cremona_ellcurve is installed, doctest failures happen (see below). The underlying reason is that the Cremona database contains a different generator for elliptic curve `37a1` than the one computed with the `.gens()` method:\n+When the optional package database_cremona_ellcurve is installed, doctest failures happen (see below). The underlying reason is that the Cremona database contains a different generator for elliptic curve `37a1` than the one computed with the `.gens()` method (the generators are each other's negative):\n \n ```\n sage: EllipticCurve(\"37a1\")._compute_gens(proof=True, use_database=True)\n``````\n",
    "created_at": "2017-09-12T14:01:10Z",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23840#issuecomment-362238",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-When the optional package database_cremona_ellcurve is installed, doctest failures happen (see below). The underlying reason is that the Cremona database contains a different generator for elliptic curve `37a1` than the one computed with the `.gens()` method:
+When the optional package database_cremona_ellcurve is installed, doctest failures happen (see below). The underlying reason is that the Cremona database contains a different generator for elliptic curve `37a1` than the one computed with the `.gens()` method (the generators are each other's negative):
 
 ```
 sage: EllipticCurve("37a1")._compute_gens(proof=True, use_database=True)
``````




---

archive/issue_comments_362239.json:
```json
{
    "body": "<a id='comment:4'></a>\nThese can all just be changed to match the output.  There is nothing more serious here than using +P instead of -P as a generator of an infinite cyclic group, and similarly for rank 2.  I went through all these making similar changes when testing #8829, and now they seem to have changed again (or gone back).\n\nFor testing only, we could obviously have tests which did not reply on a specific set of Z-module generators being output.  But we want to show examples for the documentation too, and these really do want actual points output.  It's a universal problem.",
    "created_at": "2017-09-12T14:43:26Z",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23840#issuecomment-362239",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:4'></a>
These can all just be changed to match the output.  There is nothing more serious here than using +P instead of -P as a generator of an infinite cyclic group, and similarly for rank 2.  I went through all these making similar changes when testing #8829, and now they seem to have changed again (or gone back).

For testing only, we could obviously have tests which did not reply on a specific set of Z-module generators being output.  But we want to show examples for the documentation too, and these really do want actual points output.  It's a universal problem.



---

archive/issue_comments_362240.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [cremona](#comment%3A4):\n> These can all just be changed to match the output.  There is nothing more serious here than using +P instead of -P as a generator of an infinite cyclic group, and similarly for rank 2.  I went through all these making similar changes when testing #8829, and now they seem to have changed again (or gone back).\n\n\nThere is no way to have an output dependent on an optional package... the following does not exist\n\n```\n    sage: my_test()\n    +1    # in sage\n    -1    # optional - cremona\n```\n> For testing only, we could obviously have tests which did not reply on a specific set of Z-module generators being output.  But we want to show examples for the documentation too, and these really do want actual points output.  It's a universal problem.\n",
    "created_at": "2017-09-12T14:47:23Z",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23840#issuecomment-362240",
    "user": "https://github.com/videlec"
}
```

<a id='comment:5'></a>
Replying to [cremona](#comment%3A4):
> These can all just be changed to match the output.  There is nothing more serious here than using +P instead of -P as a generator of an infinite cyclic group, and similarly for rank 2.  I went through all these making similar changes when testing #8829, and now they seem to have changed again (or gone back).


There is no way to have an output dependent on an optional package... the following does not exist

```
    sage: my_test()
    +1    # in sage
    -1    # optional - cremona
```
> For testing only, we could obviously have tests which did not reply on a specific set of Z-module generators being output.  But we want to show examples for the documentation too, and these really do want actual points output.  It's a universal problem.




---

archive/issue_comments_362241.json:
```json
{
    "body": "<a id='comment:6'></a>\nI don't understand your comment Vincent!  I was not suggesting such a thing, only that the output of E.gens() and similar often change when some underlying package (such as pari) changes.",
    "created_at": "2017-09-12T14:51:50Z",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23840#issuecomment-362241",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:6'></a>
I don't understand your comment Vincent!  I was not suggesting such a thing, only that the output of E.gens() and similar often change when some underlying package (such as pari) changes.



---

archive/issue_comments_362242.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [cremona](#comment%3A6):\n> I don't understand your comment Vincent!  I was not suggesting such a thing, only that the output of E.gens() and similar often change when some underlying package (such as pari) changes.\n\n\nThen I don't understand your [comment:4](#comment%3A4) either ;-) What do you suggest with the following sentence\n\n> These can all just be changed to match the output.\n\n\nI don't believe that `E.gens()` is uniformly minus the generators of what we have with the cremona database installed.",
    "created_at": "2017-09-12T14:55:31Z",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23840#issuecomment-362242",
    "user": "https://github.com/videlec"
}
```

<a id='comment:7'></a>
Replying to [cremona](#comment%3A6):
> I don't understand your comment Vincent!  I was not suggesting such a thing, only that the output of E.gens() and similar often change when some underlying package (such as pari) changes.


Then I don't understand your [comment:4](#comment%3A4) either ;-) What do you suggest with the following sentence

> These can all just be changed to match the output.


I don't believe that `E.gens()` is uniformly minus the generators of what we have with the cremona database installed.



---

archive/issue_comments_362243.json:
```json
{
    "body": "<a id='comment:8'></a>\nThe problem is that here the output depends on whether or not the optional package `database_cremona_ellcurve` is installed. So *with* that package, you get one output and *without* that package, you get a different output. The difference boils down to\n\n```\nsage: EllipticCurve(\"37a1\")._compute_gens(proof=True, use_database=True)\n([(0 : 0 : 1)], True)\nsage: EllipticCurve(\"37a1\")._compute_gens(proof=True, use_database=False)\n([(0 : -1 : 1)], True)\n```",
    "created_at": "2017-09-12T14:56:31Z",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23840#issuecomment-362243",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>
The problem is that here the output depends on whether or not the optional package `database_cremona_ellcurve` is installed. So *with* that package, you get one output and *without* that package, you get a different output. The difference boils down to

```
sage: EllipticCurve("37a1")._compute_gens(proof=True, use_database=True)
([(0 : 0 : 1)], True)
sage: EllipticCurve("37a1")._compute_gens(proof=True, use_database=False)
([(0 : -1 : 1)], True)
```



---

archive/issue_events_211843.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-09-12T14:59:26Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "label": "critical",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23840#event-211843"
}
```



---

archive/issue_events_211844.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-09-12T14:59:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "label": "blocker",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23840#event-211844"
}
```



---

archive/issue_comments_362244.json:
```json
{
    "body": "<a id='comment:10'></a>\nOK, this is clearer now.  As the ticket is about elliptic curves over number fields I did not think it would be affected by the optional database, but in fact it is since some of these examples take an elliptic curve over Q and base-change them up.  What we did for such examples over Q is not to use the gens() method at all but just hard-code the points in the examples.  I volunteer to do that -- but all the computers I use have the optional database installed (well, what would you expect?!) so it is harder for me to test.  I will not do this today though.",
    "created_at": "2017-09-12T15:04:35Z",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23840#issuecomment-362244",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:10'></a>
OK, this is clearer now.  As the ticket is about elliptic curves over number fields I did not think it would be affected by the optional database, but in fact it is since some of these examples take an elliptic curve over Q and base-change them up.  What we did for such examples over Q is not to use the gens() method at all but just hard-code the points in the examples.  I volunteer to do that -- but all the computers I use have the optional database installed (well, what would you expect?!) so it is harder for me to test.  I will not do this today though.



---

archive/issue_comments_362245.json:
```json
{
    "body": "<a id='comment:11'></a>\nEven if you do not do this today, do you have a suggestion for fixing it?",
    "created_at": "2017-09-12T15:06:44Z",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23840#issuecomment-362245",
    "user": "https://github.com/videlec"
}
```

<a id='comment:11'></a>
Even if you do not do this today, do you have a suggestion for fixing it?



---

archive/issue_comments_362246.json:
```json
{
    "body": "<a id='comment:12'></a>\nYes my suggestion was in Comment 10, i.e. don't get gens from the database.",
    "created_at": "2017-09-12T15:10:13Z",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23840#issuecomment-362246",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:12'></a>
Yes my suggestion was in Comment 10, i.e. don't get gens from the database.



---

archive/issue_comments_362247.json:
```json
{
    "body": "<a id='comment:13'></a>\nTaking a step back: Sage generates a \"mini\" Cremona database as standard package, containing only curves of conductor up to 10000. That mini database does not contain the generators of the curves. Should it?",
    "created_at": "2017-09-12T15:40:04Z",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23840#issuecomment-362247",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>
Taking a step back: Sage generates a "mini" Cremona database as standard package, containing only curves of conductor up to 10000. That mini database does not contain the generators of the curves. Should it?



---

archive/issue_comments_362248.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [jdemeyer](#comment%3A13):\n> Taking a step back: Sage generates a \"mini\" Cremona database as standard package, containing only curves of conductor up to 10000. That mini database does not contain the generators of the curves. Should it?\n\n\nProbably, if only for this reason concerning tests, but for anyone who cares at all about elliptic curves installing the optional package is obviously a good idea.",
    "created_at": "2017-09-12T16:07:17Z",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23840#issuecomment-362248",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:14'></a>
Replying to [jdemeyer](#comment%3A13):
> Taking a step back: Sage generates a "mini" Cremona database as standard package, containing only curves of conductor up to 10000. That mini database does not contain the generators of the curves. Should it?


Probably, if only for this reason concerning tests, but for anyone who cares at all about elliptic curves installing the optional package is obviously a good idea.



---

archive/issue_comments_362249.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [cremona](#comment%3A14):\n> Replying to [jdemeyer](#comment%3A13):\n> > Taking a step back: Sage generates a \"mini\" Cremona database as standard package, containing only curves of conductor up to 10000. That mini database does not contain the generators of the curves. Should it?\n\n> \n> Probably, if only for this reason concerning tests, but for anyone who cares at all about elliptic curves installing the optional package is obviously a good idea.\n\n\nThe mini database does not have the same columns as the big one!?",
    "created_at": "2017-09-12T18:07:15Z",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23840#issuecomment-362249",
    "user": "https://github.com/videlec"
}
```

<a id='comment:15'></a>
Replying to [cremona](#comment%3A14):
> Replying to [jdemeyer](#comment%3A13):
> > Taking a step back: Sage generates a "mini" Cremona database as standard package, containing only curves of conductor up to 10000. That mini database does not contain the generators of the curves. Should it?

> 
> Probably, if only for this reason concerning tests, but for anyone who cares at all about elliptic curves installing the optional package is obviously a good idea.


The mini database does not have the same columns as the big one!?



---

archive/issue_comments_362250.json:
```json
{
    "body": "<a id='comment:16'></a>\nReplying to [vdelecroix](#comment%3A15):\n> Replying to [cremona](#comment%3A14):\n> > Replying to [jdemeyer](#comment%3A13):\n> > > Taking a step back: Sage generates a \"mini\" Cremona database as standard package, containing only curves of conductor up to 10000. That mini database does not contain the generators of the curves. Should it?\n\n> > \n> > Probably, if only for this reason concerning tests, but for anyone who cares at all about elliptic curves installing the optional package is obviously a good idea.\n\n> \n> The mini database does not have the same columns as the big one!?\n\n\nThat is correct.  I didn't design it, it has been like that since 2007 if not earlier.",
    "created_at": "2017-09-12T18:35:05Z",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23840#issuecomment-362250",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:16'></a>
Replying to [vdelecroix](#comment%3A15):
> Replying to [cremona](#comment%3A14):
> > Replying to [jdemeyer](#comment%3A13):
> > > Taking a step back: Sage generates a "mini" Cremona database as standard package, containing only curves of conductor up to 10000. That mini database does not contain the generators of the curves. Should it?

> > 
> > Probably, if only for this reason concerning tests, but for anyone who cares at all about elliptic curves installing the optional package is obviously a good idea.

> 
> The mini database does not have the same columns as the big one!?


That is correct.  I didn't design it, it has been like that since 2007 if not earlier.



---

archive/issue_comments_362251.json:
```json
{
    "body": "<a id='comment:17'></a>\nI am looking at this now.  Note that there used to be a whole lot of discrepancies caused by the presence or otherwise of the optional database, which were all dealt with.  The new batch come from #8829 and are my fault, I think, since I forgot.  It is quite plausible that both I and the reviewer of that ticket had the optional database installed so it was not noticed until the patchbots picked it up.\n\nThere is no very easy way to uninstall the optional database but I'll try that after changing the relevant tests.",
    "created_at": "2017-09-12T18:38:46Z",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23840#issuecomment-362251",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:17'></a>
I am looking at this now.  Note that there used to be a whole lot of discrepancies caused by the presence or otherwise of the optional database, which were all dealt with.  The new batch come from #8829 and are my fault, I think, since I forgot.  It is quite plausible that both I and the reviewer of that ticket had the optional database installed so it was not noticed until the patchbots picked it up.

There is no very easy way to uninstall the optional database but I'll try that after changing the relevant tests.



---

archive/issue_comments_362252.json:
```json
{
    "body": "<a id='comment:18'></a>\nReplying to [cremona](#comment%3A17):\n> I am looking at this now.  Note that there used to be a whole lot of discrepancies caused by the presence or otherwise of the optional database, which were all dealt with.  The new batch come from #8829 and are my fault, I think, since I forgot.  It is quite plausible that both I and the reviewer of that ticket had the optional database installed so it was not noticed until the patchbots picked it up.\n> \n> There is no very easy way to uninstall the optional database but I'll try that after changing the relevant tests.\n\n\nAnd this is indeed a problem... however we might have #22510 in at some point! The only easy way I see is to have two installs of Sage.",
    "created_at": "2017-09-12T18:41:40Z",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23840#issuecomment-362252",
    "user": "https://github.com/videlec"
}
```

<a id='comment:18'></a>
Replying to [cremona](#comment%3A17):
> I am looking at this now.  Note that there used to be a whole lot of discrepancies caused by the presence or otherwise of the optional database, which were all dealt with.  The new batch come from #8829 and are my fault, I think, since I forgot.  It is quite plausible that both I and the reviewer of that ticket had the optional database installed so it was not noticed until the patchbots picked it up.
> 
> There is no very easy way to uninstall the optional database but I'll try that after changing the relevant tests.


And this is indeed a problem... however we might have #22510 in at some point! The only easy way I see is to have two installs of Sage.



---

archive/issue_comments_362253.json:
```json
{
    "body": "<a id='comment:19'></a>\nThis one should be easy since all the installation does is move one file into local/share/cremona.  Checking that made me see that despite what I said above, I had just tested this file on a Sage build with no optional database installed -- and all tests passed; but the version was beta3.  I am now building beta5 in there before continuing.",
    "created_at": "2017-09-12T18:47:58Z",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23840#issuecomment-362253",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:19'></a>
This one should be easy since all the installation does is move one file into local/share/cremona.  Checking that made me see that despite what I said above, I had just tested this file on a Sage build with no optional database installed -- and all tests passed; but the version was beta3.  I am now building beta5 in there before continuing.



---

archive/issue_comments_362254.json:
```json
{
    "body": "<a id='comment:20'></a>\nReplying to [vdelecroix](#comment%3A15):\n> The mini database does not have the same columns as the big one!?\n\n\nYes, that's the case. I have no idea why it is like this:\n\n```\njdemeyer@tamiyo:/usr/local/src/sage-config$ ./sage --sqlite3 local/share/cremona/cremona.db \nSQLite version 3.17.0 2017-02-13 16:02:40\nEnter \".help\" for usage hints.\nsqlite> .schema t_curve\nCREATE TABLE t_curve(reg REAL, om REAL, sha , tors INTEGER, eqn TEXT UNIQUE, cp INTEGER, curve TEXT PRIMARY KEY, class TEXT, gens TEXT);\nCREATE INDEX i_t_curve_class ON t_curve(class);\nsqlite> \njdemeyer@tamiyo:/usr/local/src/sage-config$ ./sage --sqlite3 local/share/cremona/cremona_mini.db \nSQLite version 3.17.0 2017-02-13 16:02:40\nEnter \".help\" for usage hints.\nsqlite> .schema t_curve\nCREATE TABLE t_curve(curve TEXT PRIMARY KEY, class TEXT, tors INTEGER, eqn TEXT UNIQUE);\nCREATE INDEX i_t_curve_class ON t_curve(class);\n```\n\nI vote for changing this. The mini database should be just a truncated version of the large database.",
    "created_at": "2017-09-13T08:58:39Z",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23840#issuecomment-362254",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>
Replying to [vdelecroix](#comment%3A15):
> The mini database does not have the same columns as the big one!?


Yes, that's the case. I have no idea why it is like this:

```
jdemeyer@tamiyo:/usr/local/src/sage-config$ ./sage --sqlite3 local/share/cremona/cremona.db 
SQLite version 3.17.0 2017-02-13 16:02:40
Enter ".help" for usage hints.
sqlite> .schema t_curve
CREATE TABLE t_curve(reg REAL, om REAL, sha , tors INTEGER, eqn TEXT UNIQUE, cp INTEGER, curve TEXT PRIMARY KEY, class TEXT, gens TEXT);
CREATE INDEX i_t_curve_class ON t_curve(class);
sqlite> 
jdemeyer@tamiyo:/usr/local/src/sage-config$ ./sage --sqlite3 local/share/cremona/cremona_mini.db 
SQLite version 3.17.0 2017-02-13 16:02:40
Enter ".help" for usage hints.
sqlite> .schema t_curve
CREATE TABLE t_curve(curve TEXT PRIMARY KEY, class TEXT, tors INTEGER, eqn TEXT UNIQUE);
CREATE INDEX i_t_curve_class ON t_curve(class);
```

I vote for changing this. The mini database should be just a truncated version of the large database.



---

archive/issue_comments_362255.json:
```json
{
    "body": "<a id='comment:21'></a>\nReplying to [cremona](#comment%3A17):\n> It is quite plausible that both I and the reviewer of that ticket had the optional database installed so it was not noticed until the patchbots picked it up.\n\n\nIt is the other way around. Tests pass without the database, they fail with the database.",
    "created_at": "2017-09-13T09:03:58Z",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23840#issuecomment-362255",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>
Replying to [cremona](#comment%3A17):
> It is quite plausible that both I and the reviewer of that ticket had the optional database installed so it was not noticed until the patchbots picked it up.


It is the other way around. Tests pass without the database, they fail with the database.



---

archive/issue_comments_362256.json:
```json
{
    "body": "<a id='comment:22'></a>\nReplying to [jdemeyer](#comment%3A21):\n> Replying to [cremona](#comment%3A17):\n> > It is quite plausible that both I and the reviewer of that ticket had the optional database installed so it was not noticed until the patchbots picked it up.\n\n> \n> It is the other way around. Tests pass without the database, they fail with the database.\n\n\nOK, I had just realised that.  I now have beta5 without the database (and saw that tests pass) so am almost in a state where I can try to deal with this.\n\nThe first failure (line 2457) is an extremely weird example.  With K a  number field the construction EllipticCurve(K,'37') really should not work.  It appears to get curve '37a1' from the database and base-change it to K, but '37' does not uniquely determine the curve.  This will change.\n\nThe trouble with that example (and probably more of the problem ones) is that we are testing something which was implemented whereby the generators of the base-change of a curve defined over Q from Q to a quadratic field are obtained by joining the gens of E and its quadratic twist and then saturating.  So we are at the mercy of what generators two curves over Q get assigned.  The only way I can think of avoiding the database issue is to use an example outside the database range.  That is, until someone makes the suggested changes to the mini database; then we'll only need to make sure that any curves in tests like this are in the mini database.",
    "created_at": "2017-09-13T09:24:14Z",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23840#issuecomment-362256",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:22'></a>
Replying to [jdemeyer](#comment%3A21):
> Replying to [cremona](#comment%3A17):
> > It is quite plausible that both I and the reviewer of that ticket had the optional database installed so it was not noticed until the patchbots picked it up.

> 
> It is the other way around. Tests pass without the database, they fail with the database.


OK, I had just realised that.  I now have beta5 without the database (and saw that tests pass) so am almost in a state where I can try to deal with this.

The first failure (line 2457) is an extremely weird example.  With K a  number field the construction EllipticCurve(K,'37') really should not work.  It appears to get curve '37a1' from the database and base-change it to K, but '37' does not uniquely determine the curve.  This will change.

The trouble with that example (and probably more of the problem ones) is that we are testing something which was implemented whereby the generators of the base-change of a curve defined over Q from Q to a quadratic field are obtained by joining the gens of E and its quadratic twist and then saturating.  So we are at the mercy of what generators two curves over Q get assigned.  The only way I can think of avoiding the database issue is to use an example outside the database range.  That is, until someone makes the suggested changes to the mini database; then we'll only need to make sure that any curves in tests like this are in the mini database.



---

archive/issue_comments_362257.json:
```json
{
    "body": "<a id='comment:23'></a>\nReplying to [jdemeyer](#comment%3A20):\n> \n> I vote for changing this. The mini database should be just a truncated version of the large database.\n\n\nYes this looks like the cleanest solution to me to, I don't know how much work this would be, but if it is significantly more work we could postpone it to a later ticket.",
    "created_at": "2017-09-13T10:29:53Z",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23840#issuecomment-362257",
    "user": "https://github.com/koffie"
}
```

<a id='comment:23'></a>
Replying to [jdemeyer](#comment%3A20):
> 
> I vote for changing this. The mini database should be just a truncated version of the large database.


Yes this looks like the cleanest solution to me to, I don't know how much work this would be, but if it is significantly more work we could postpone it to a later ticket.



---

archive/issue_comments_362258.json:
```json
{
    "body": "<a id='comment:24'></a>\nDefinitely changing the mini database, and the associated code, should not be in the *blocker* ticket!\n\nHere is what to do: there exist functions already to take some data tarball to create the db file for the optional database.  It would be easy to feed to that a smaller tarball with the range to 10000 only.  Then in the code there might be some places where changes are needed, e.g. if the code assumes that the mini database does not have the gens and possibly some other fields.",
    "created_at": "2017-09-13T12:40:19Z",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23840#issuecomment-362258",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:24'></a>
Definitely changing the mini database, and the associated code, should not be in the *blocker* ticket!

Here is what to do: there exist functions already to take some data tarball to create the db file for the optional database.  It would be easy to feed to that a smaller tarball with the range to 10000 only.  Then in the code there might be some places where changes are needed, e.g. if the code assumes that the mini database does not have the gens and possibly some other fields.



---

archive/issue_comments_362259.json:
```json
{
    "body": "<a id='comment:25'></a>\nI have a version of ell_number_field.py which should do the job as it no longer calls gens() on any elliptic curve over Q of conductor <400000.  It passes all tests on 8.1.beta5 without the optiona db installed.  I want to test on 8.0.beta5+database_cremona_ellcurve but am having trouble.  I just built it in an upgrade from some earlier version and Sage runs but sage -t gives\n\n```\nTraceback (most recent call last):\n  File \"/usr/local/sage/sage-2/src/bin/sage-runtests\", line 111, in <module>\n    from sage.doctest.control import DocTestController\n  File \"/usr/local/sage/sage-2/local/lib/python2.7/site-packages/sage/doctest/control.py\", line 33, in <module>\n    from .sources import FileDocTestSource, DictAsObject\n  File \"/usr/local/sage/sage-2/local/lib/python2.7/site-packages/sage/doctest/sources.py\", line 33, in <module>\n    from .parsing import SageDocTestParser\n  File \"/usr/local/sage/sage-2/local/lib/python2.7/site-packages/sage/doctest/parsing.py\", line 56, in <module>\n    from sage.all import RealIntervalField\n  File \"/usr/local/sage/sage-2/local/lib/python2.7/site-packages/sage/all.py\", line 87, in <module>\n    from sage.misc.all       import *         # takes a while\n  File \"/usr/local/sage/sage-2/local/lib/python2.7/site-packages/sage/misc/all.py\", line 84, in <module>\n    from .functional import (additive_order,\n  File \"/usr/local/sage/sage-2/local/lib/python2.7/site-packages/sage/misc/functional.py\", line 27, in <module>\n    from sage.rings.complex_double import CDF\n  File \"sage/rings/integer.pxd\", line 7, in init sage.rings.complex_double\n  File \"sage/rings/rational.pxd\", line 8, in init sage.rings.integer\n  File \"sage/rings/rational.pyx\", line 89, in init sage.rings.rational\n  File \"sage/rings/real_double.pxd\", line 8, in init sage.rings.real_mpfr\nImportError: /usr/local/sage/sage-2/local/lib/python2.7/site-packages/sage/rings/real_double.so: failed to map segment from shared object\n```\nwhich makes no sense to me.  I can make clean and start again but that will take a while.  I have another beta5 build happening elsewhere.  Meanwhile I'll upload the branch I have and someone else can try it.",
    "created_at": "2017-09-13T13:59:46Z",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23840#issuecomment-362259",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:25'></a>
I have a version of ell_number_field.py which should do the job as it no longer calls gens() on any elliptic curve over Q of conductor <400000.  It passes all tests on 8.1.beta5 without the optiona db installed.  I want to test on 8.0.beta5+database_cremona_ellcurve but am having trouble.  I just built it in an upgrade from some earlier version and Sage runs but sage -t gives

```
Traceback (most recent call last):
  File "/usr/local/sage/sage-2/src/bin/sage-runtests", line 111, in <module>
    from sage.doctest.control import DocTestController
  File "/usr/local/sage/sage-2/local/lib/python2.7/site-packages/sage/doctest/control.py", line 33, in <module>
    from .sources import FileDocTestSource, DictAsObject
  File "/usr/local/sage/sage-2/local/lib/python2.7/site-packages/sage/doctest/sources.py", line 33, in <module>
    from .parsing import SageDocTestParser
  File "/usr/local/sage/sage-2/local/lib/python2.7/site-packages/sage/doctest/parsing.py", line 56, in <module>
    from sage.all import RealIntervalField
  File "/usr/local/sage/sage-2/local/lib/python2.7/site-packages/sage/all.py", line 87, in <module>
    from sage.misc.all       import *         # takes a while
  File "/usr/local/sage/sage-2/local/lib/python2.7/site-packages/sage/misc/all.py", line 84, in <module>
    from .functional import (additive_order,
  File "/usr/local/sage/sage-2/local/lib/python2.7/site-packages/sage/misc/functional.py", line 27, in <module>
    from sage.rings.complex_double import CDF
  File "sage/rings/integer.pxd", line 7, in init sage.rings.complex_double
  File "sage/rings/rational.pxd", line 8, in init sage.rings.integer
  File "sage/rings/rational.pyx", line 89, in init sage.rings.rational
  File "sage/rings/real_double.pxd", line 8, in init sage.rings.real_mpfr
ImportError: /usr/local/sage/sage-2/local/lib/python2.7/site-packages/sage/rings/real_double.so: failed to map segment from shared object
```
which makes no sense to me.  I can make clean and start again but that will take a while.  I have another beta5 build happening elsewhere.  Meanwhile I'll upload the branch I have and someone else can try it.



---

archive/issue_comments_362260.json:
```json
{
    "body": "**Author:** John Cremona",
    "created_at": "2017-09-13T14:02:46Z",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23840#issuecomment-362260",
    "user": "https://github.com/JohnCremona"
}
```

**Author:** John Cremona



---

archive/issue_events_211845.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2017-09-13T14:02:46Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23840#event-211845"
}
```



---

archive/issue_comments_362261.json:
```json
{
    "body": "<a id='comment:26'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/453419e242f8f3e9dcafa6713a13151144df28e2\">453419e</a></td><td><code>#23840: fix tests whose output depends on optional elliptic curve database being installed</code></td></tr></table>\n",
    "created_at": "2017-09-13T14:02:46Z",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23840#issuecomment-362261",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:26'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/453419e242f8f3e9dcafa6713a13151144df28e2">453419e</a></td><td><code>#23840: fix tests whose output depends on optional elliptic curve database being installed</code></td></tr></table>




---

archive/issue_comments_362262.json:
```json
{
    "body": "**Branch:** [u/cremona/23840](https://github.com/sagemath/sagetrac-mirror/tree/u/cremona/23840)",
    "created_at": "2017-09-13T14:02:46Z",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23840#issuecomment-362262",
    "user": "https://github.com/JohnCremona"
}
```

**Branch:** [u/cremona/23840](https://github.com/sagemath/sagetrac-mirror/tree/u/cremona/23840)



---

archive/issue_comments_362263.json:
```json
{
    "body": "**Commit:** [453419e242f8f3e9dcafa6713a13151144df28e2](https://github.com/sagemath/sagetrac-mirror/commit/453419e242f8f3e9dcafa6713a13151144df28e2)",
    "created_at": "2017-09-13T14:02:46Z",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23840#issuecomment-362263",
    "user": "https://github.com/JohnCremona"
}
```

**Commit:** [453419e242f8f3e9dcafa6713a13151144df28e2](https://github.com/sagemath/sagetrac-mirror/commit/453419e242f8f3e9dcafa6713a13151144df28e2)



---

archive/issue_comments_362264.json:
```json
{
    "body": "<a id='comment:27'></a>\nI found out how to manually install the optional spkg in a way which allows for easy manual uninstallation:\n1. copy the file cremona.db into local/share/cremona\n2. copy the file local/var/lib/sage/installed/database_cremona_ellcurve-20161017\nin both cases copying from another build with this spkg installed.\n\nThe tests still pass -- good!  So I think this is now fixed.",
    "created_at": "2017-09-13T14:32:14Z",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23840#issuecomment-362264",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:27'></a>
I found out how to manually install the optional spkg in a way which allows for easy manual uninstallation:
1. copy the file cremona.db into local/share/cremona
2. copy the file local/var/lib/sage/installed/database_cremona_ellcurve-20161017
in both cases copying from another build with this spkg installed.

The tests still pass -- good!  So I think this is now fixed.



---

archive/issue_comments_362265.json:
```json
{
    "body": "<a id='comment:28'></a>\nYes, I agree. This works now.",
    "created_at": "2017-09-18T08:47:57Z",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23840#issuecomment-362265",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:28'></a>
Yes, I agree. This works now.



---

archive/issue_comments_362266.json:
```json
{
    "body": "**Reviewer:** Jeroen Demeyer",
    "created_at": "2017-09-18T08:48:33Z",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23840#issuecomment-362266",
    "user": "https://github.com/jdemeyer"
}
```

**Reviewer:** Jeroen Demeyer



---

archive/issue_events_211846.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-09-18T08:48:33Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23840#event-211846"
}
```



---

archive/issue_events_211847.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-09-18T08:48:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23840#event-211847"
}
```



---

archive/issue_comments_362267.json:
```json
{
    "body": "**Changing branch** from \"[u/cremona/23840](https://github.com/sagemath/sagetrac-mirror/tree/u/cremona/23840)\" to \"[453419e242f8f3e9dcafa6713a13151144df28e2](https://github.com/sagemath/sagetrac-mirror/commit/453419e242f8f3e9dcafa6713a13151144df28e2)\".",
    "created_at": "2017-09-20T22:26:46Z",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23840#issuecomment-362267",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/cremona/23840](https://github.com/sagemath/sagetrac-mirror/tree/u/cremona/23840)" to "[453419e242f8f3e9dcafa6713a13151144df28e2](https://github.com/sagemath/sagetrac-mirror/commit/453419e242f8f3e9dcafa6713a13151144df28e2)".



---

archive/issue_events_211848.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-09-20T22:26:46Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23840#event-211848"
}
```



---

archive/issue_events_211849.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "1d6d22db6d80d7de4ecf7718b7d3777a40aff7a4",
    "created_at": "2017-09-20T22:26:46Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/23840",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23840#event-211849"
}
```
