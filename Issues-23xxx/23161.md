# Issue 23161: Wrong zlib library might be loaded in sage-rst2txt

archive/issues_022924.json:
```json
{
    "assignees": [],
    "body": "The script `sage-rst2txt` suffers from the same issue as #23122.\n\nCC:  @embray @vbraun @kiwifb\n\nBranch/Commit: **[u/vbraun/wrong_zlib_library_might_be_loaded_in_sage_rst2txt](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/wrong_zlib_library_might_be_loaded_in_sage_rst2txt) @ [`050314a`](https://github.com/sagemath/sagetrac-mirror/commit/050314a4057553d7b25c5b880f71906742591de0)**\n\nReviewer: **Jeroen Demeyer**\n\nComponent: **scripts**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/23161_\n\n",
    "closed_at": "2017-08-31T08:53:36Z",
    "created_at": "2017-06-07T15:04:34Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/bug",
        "https://github.com/sagemath/sage/labels/c%3A%20scripts",
        "https://github.com/sagemath/sage/labels/worksforme"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Wrong zlib library might be loaded in sage-rst2txt",
    "type": "issue",
    "updated_at": "2017-08-31T08:53:36Z",
    "url": "https://github.com/sagemath/sage/issues/23161",
    "user": "https://github.com/jdemeyer"
}
```
The script `sage-rst2txt` suffers from the same issue as #23122.

CC:  @embray @vbraun @kiwifb

Branch/Commit: **[u/vbraun/wrong_zlib_library_might_be_loaded_in_sage_rst2txt](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/wrong_zlib_library_might_be_loaded_in_sage_rst2txt) @ [`050314a`](https://github.com/sagemath/sagetrac-mirror/commit/050314a4057553d7b25c5b880f71906742591de0)**

Reviewer: **Jeroen Demeyer**

Component: **scripts**

_Issue created by migration from https://trac.sagemath.org/ticket/23161_





---

archive/issue_events_322829.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-06-07T15:04:34Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "milestone_number": null,
    "milestone_title": "sage-8.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23161#event-322829"
}
```



---

archive/issue_events_322830.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-06-07T15:04:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20scripts",
    "label_color": "000080",
    "label_name": "c: scripts",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23161#event-322830"
}
```



---

archive/issue_events_322831.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-06-07T15:04:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "label": "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p: 1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23161#event-322831"
}
```



---

archive/issue_events_322832.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-06-07T15:04:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23161#event-322832"
}
```



---

archive/issue_comments_347325.json:
```json
{
    "body": "Branch: **[u/jdemeyer/wrong_zlib_library_might_be_loaded_in_sage_rst2txt](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/wrong_zlib_library_might_be_loaded_in_sage_rst2txt)**",
    "created_at": "2017-06-07T15:11:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23161#issuecomment-347325",
    "user": "https://github.com/jdemeyer"
}
```

Branch: **[u/jdemeyer/wrong_zlib_library_might_be_loaded_in_sage_rst2txt](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/wrong_zlib_library_might_be_loaded_in_sage_rst2txt)**



---

archive/issue_comments_347326.json:
```json
{
    "body": "Commit: **[`c0a9b2b`](https://github.com/sagemath/sagetrac-mirror/commit/c0a9b2b9e93f5abaa6adc136a28107dca482bbaf)**",
    "created_at": "2017-06-07T15:12:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23161#issuecomment-347326",
    "user": "https://github.com/jdemeyer"
}
```

Commit: **[`c0a9b2b`](https://github.com/sagemath/sagetrac-mirror/commit/c0a9b2b9e93f5abaa6adc136a28107dca482bbaf)**



---

archive/issue_comments_347327.json:
```json
{
    "body": "<div id=\"comment:2\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c0a9b2b9e93f5abaa6adc136a28107dca482bbaf\"><code>c0a9b2b</code></a></td><td><code>Wrong zlib library might be loaded in sage-rst2txt</code></td></tr></table>\n",
    "created_at": "2017-06-07T15:12:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23161#issuecomment-347327",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:2"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c0a9b2b9e93f5abaa6adc136a28107dca482bbaf"><code>c0a9b2b</code></a></td><td><code>Wrong zlib library might be loaded in sage-rst2txt</code></td></tr></table>




---

archive/issue_events_322833.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-06-07T15:12:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23161#event-322833"
}
```



---

archive/issue_comments_347328.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nHow would one test that this is fixed?   It does look identical to the fix in the previous ticket.",
    "created_at": "2017-06-08T14:48:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23161#issuecomment-347328",
    "user": "https://github.com/kcrisman"
}
```

<div id="comment:3" align="right">comment:3</div>

How would one test that this is fixed?   It does look identical to the fix in the previous ticket.



---

archive/issue_comments_347329.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nA better solution would probably be to fix the Python linking, there is something wrong with Jeroen's binaries that I can't reproduce. The `_ssl.so` module should have an RPATH set and this will come first in the library resolution order even for transitive dependencies...",
    "created_at": "2017-06-11T09:39:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23161#issuecomment-347329",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:4" align="right">comment:4</div>

A better solution would probably be to fix the Python linking, there is something wrong with Jeroen's binaries that I can't reproduce. The `_ssl.so` module should have an RPATH set and this will come first in the library resolution order even for transitive dependencies...



---

archive/issue_comments_347330.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nIn case it helps:\n\n```\n$ readelf -d local/lib/python2.7/lib-dynload/_ssl.so\n\nDynamic section at offset 0x14d60 contains 29 entries:\n  Tag        Type                         Name/Value\n 0x0000000000000001 (NEEDED)             Shared library: [libssl.so.1.0.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libcrypto.so.1.0.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]\n 0x000000000000001d (RUNPATH)            Library runpath: [/usr/local/src/sage-config/local/lib]\n 0x000000000000000c (INIT)               0x71d8\n 0x000000000000000d (FINI)               0xf6f0\n 0x0000000000000019 (INIT_ARRAY)         0x214d48\n 0x000000000000001b (INIT_ARRAYSZ)       8 (bytes)\n 0x000000000000001a (FINI_ARRAY)         0x214d50\n 0x000000000000001c (FINI_ARRAYSZ)       8 (bytes)\n 0x000000006ffffef5 (GNU_HASH)           0x1c8\n 0x0000000000000005 (STRTAB)             0x18d0\n 0x0000000000000006 (SYMTAB)             0x208\n 0x000000000000000a (STRSZ)              4539 (bytes)\n 0x000000000000000b (SYMENT)             24 (bytes)\n 0x0000000000000003 (PLTGOT)             0x215000\n 0x0000000000000002 (PLTRELSZ)           5256 (bytes)\n 0x0000000000000014 (PLTREL)             RELA\n 0x0000000000000017 (JMPREL)             0x5d50\n 0x0000000000000007 (RELA)               0x2cd8\n 0x0000000000000008 (RELASZ)             12408 (bytes)\n 0x0000000000000009 (RELAENT)            24 (bytes)\n 0x000000006ffffffe (VERNEED)            0x2c78\n 0x000000006fffffff (VERNEEDNUM)         2\n 0x000000006ffffff0 (VERSYM)             0x2a8c\n 0x000000006ffffff9 (RELACOUNT)          499\n 0x0000000000000000 (NULL)               0x0\n```",
    "created_at": "2017-06-14T08:39:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23161#issuecomment-347330",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:5" align="right">comment:5</div>

In case it helps:

```
$ readelf -d local/lib/python2.7/lib-dynload/_ssl.so

Dynamic section at offset 0x14d60 contains 29 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libssl.so.1.0.0]
 0x0000000000000001 (NEEDED)             Shared library: [libcrypto.so.1.0.0]
 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]
 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x000000000000001d (RUNPATH)            Library runpath: [/usr/local/src/sage-config/local/lib]
 0x000000000000000c (INIT)               0x71d8
 0x000000000000000d (FINI)               0xf6f0
 0x0000000000000019 (INIT_ARRAY)         0x214d48
 0x000000000000001b (INIT_ARRAYSZ)       8 (bytes)
 0x000000000000001a (FINI_ARRAY)         0x214d50
 0x000000000000001c (FINI_ARRAYSZ)       8 (bytes)
 0x000000006ffffef5 (GNU_HASH)           0x1c8
 0x0000000000000005 (STRTAB)             0x18d0
 0x0000000000000006 (SYMTAB)             0x208
 0x000000000000000a (STRSZ)              4539 (bytes)
 0x000000000000000b (SYMENT)             24 (bytes)
 0x0000000000000003 (PLTGOT)             0x215000
 0x0000000000000002 (PLTRELSZ)           5256 (bytes)
 0x0000000000000014 (PLTREL)             RELA
 0x0000000000000017 (JMPREL)             0x5d50
 0x0000000000000007 (RELA)               0x2cd8
 0x0000000000000008 (RELASZ)             12408 (bytes)
 0x0000000000000009 (RELAENT)            24 (bytes)
 0x000000006ffffffe (VERNEED)            0x2c78
 0x000000006fffffff (VERNEEDNUM)         2
 0x000000006ffffff0 (VERSYM)             0x2a8c
 0x000000006ffffff9 (RELACOUNT)          499
 0x0000000000000000 (NULL)               0x0
```



---

archive/issue_comments_347331.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nThe dependency on libz is not direct, but via libpython and libssl. The difference between our systems seems to be that I'm using RPATH any you use RUNPATH.\n\n```\n$ readelf -d local/lib/python2.7/lib-dynload/_ssl.so\n\nDynamic section at offset 0x13d60 contains 29 entries:\n  Tag        Type                         Name/Value\n 0x0000000000000001 (NEEDED)             Shared library: [libssl.so.10]\n 0x0000000000000001 (NEEDED)             Shared library: [libcrypto.so.10]\n 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]\n 0x000000000000000f (RPATH)              Library rpath: [/home/vbraun/Code/sage.git/local/lib]\n[...]\n```\nThe difference is of course that the executable\u2019s RUNPATH is not used for finding indirect library dependencies: http://blog.qt.io/blog/2011/10/28/rpath-and-runpath/\n\nIn an ideal world we'd either \n* ship all our dependencies (including openssl) without holes in the dependency chain, or \n* let you link against the same libs as openssl (and not build our own libz).\n\nThe best course of action is probably to add `-Wl,--disable-new-dtags` to our LDFLAGS when compiling Sage, that would ensure that our zlib wins.",
    "created_at": "2017-06-14T19:13:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23161#issuecomment-347331",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:6" align="right">comment:6</div>

The dependency on libz is not direct, but via libpython and libssl. The difference between our systems seems to be that I'm using RPATH any you use RUNPATH.

```
$ readelf -d local/lib/python2.7/lib-dynload/_ssl.so

Dynamic section at offset 0x13d60 contains 29 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libssl.so.10]
 0x0000000000000001 (NEEDED)             Shared library: [libcrypto.so.10]
 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]
 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x000000000000000f (RPATH)              Library rpath: [/home/vbraun/Code/sage.git/local/lib]
[...]
```
The difference is of course that the executableâ€™s RUNPATH is not used for finding indirect library dependencies: http://blog.qt.io/blog/2011/10/28/rpath-and-runpath/

In an ideal world we'd either 
* ship all our dependencies (including openssl) without holes in the dependency chain, or 
* let you link against the same libs as openssl (and not build our own libz).

The best course of action is probably to add `-Wl,--disable-new-dtags` to our LDFLAGS when compiling Sage, that would ensure that our zlib wins.



---

archive/issue_comments_347332.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nVery interesting blog post. Cleared a few things up for me. I am fairly sure Jeroen uses Gentoo and that it default to `-Wl,--enable-new-dtags` by default. So disabling that is an easy option.",
    "created_at": "2017-06-14T21:41:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23161#issuecomment-347332",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:7" align="right">comment:7</div>

Very interesting blog post. Cleared a few things up for me. I am fairly sure Jeroen uses Gentoo and that it default to `-Wl,--enable-new-dtags` by default. So disabling that is an easy option.



---

archive/issue_comments_347333.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nReplying to [@kiwifb](#comment:7):\n> Very interesting blog post. Cleared a few things up for me. I am fairly sure Jeroen uses Gentoo and that it default to `-Wl,--enable-new-dtags` by default. So disabling that is an easy option.\n\nThat would be a gnu ld setting, so valid for linux but not OS X. Don't know for freeBSD or cygwin.",
    "created_at": "2017-06-15T00:07:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23161#issuecomment-347333",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:8" align="right">comment:8</div>

Replying to [@kiwifb](#comment:7):
> Very interesting blog post. Cleared a few things up for me. I am fairly sure Jeroen uses Gentoo and that it default to `-Wl,--enable-new-dtags` by default. So disabling that is an easy option.

That would be a gnu ld setting, so valid for linux but not OS X. Don't know for freeBSD or cygwin.



---

archive/issue_comments_347334.json:
```json
{
    "body": "Changed branch from **[u/jdemeyer/wrong_zlib_library_might_be_loaded_in_sage_rst2txt](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/wrong_zlib_library_might_be_loaded_in_sage_rst2txt)** to **[u/vbraun/wrong_zlib_library_might_be_loaded_in_sage_rst2txt](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/wrong_zlib_library_might_be_loaded_in_sage_rst2txt)**",
    "created_at": "2017-06-17T13:50:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23161#issuecomment-347334",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/jdemeyer/wrong_zlib_library_might_be_loaded_in_sage_rst2txt](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/wrong_zlib_library_might_be_loaded_in_sage_rst2txt)** to **[u/vbraun/wrong_zlib_library_might_be_loaded_in_sage_rst2txt](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/wrong_zlib_library_might_be_loaded_in_sage_rst2txt)**



---

archive/issue_comments_347335.json:
```json
{
    "body": "Changed commit from **[`c0a9b2b`](https://github.com/sagemath/sagetrac-mirror/commit/c0a9b2b9e93f5abaa6adc136a28107dca482bbaf)** to **[`050314a`](https://github.com/sagemath/sagetrac-mirror/commit/050314a4057553d7b25c5b880f71906742591de0)**",
    "created_at": "2017-06-17T13:51:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23161#issuecomment-347335",
    "user": "https://github.com/vbraun"
}
```

Changed commit from **[`c0a9b2b`](https://github.com/sagemath/sagetrac-mirror/commit/c0a9b2b9e93f5abaa6adc136a28107dca482bbaf)** to **[`050314a`](https://github.com/sagemath/sagetrac-mirror/commit/050314a4057553d7b25c5b880f71906742591de0)**



---

archive/issue_comments_347336.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nJeroen, does that fix it for you?\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/050314a4057553d7b25c5b880f71906742591de0\"><code>050314a</code></a></td><td><code>Link with --disable-new-rtags on linux</code></td></tr></table>\n",
    "created_at": "2017-06-17T13:51:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23161#issuecomment-347336",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:10" align="right">comment:10</div>

Jeroen, does that fix it for you?

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/050314a4057553d7b25c5b880f71906742591de0"><code>050314a</code></a></td><td><code>Link with --disable-new-rtags on linux</code></td></tr></table>




---

archive/issue_comments_347337.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nHmm, for some reason I cannot reproduce the problem anymore. There must be some non-deterministic aspect...\n\nNow (without this patch), I get\n\n```\n$ readelf -d local/lib/python2.7/lib-dynload/_ssl.so\n\nDynamic section at offset 0x14d60 contains 29 entries:\n  Tag        Type                         Name/Value\n 0x0000000000000001 (NEEDED)             Shared library: [libssl.so.1.0.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libcrypto.so.1.0.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]\n 0x000000000000001d (RUNPATH)            Library runpath: [/usr/local/src/sage-config/local/lib]\n 0x000000000000000c (INIT)               0x71d8\n 0x000000000000000d (FINI)               0xf6f0\n 0x0000000000000019 (INIT_ARRAY)         0x214d48\n 0x000000000000001b (INIT_ARRAYSZ)       8 (bytes)\n 0x000000000000001a (FINI_ARRAY)         0x214d50\n 0x000000000000001c (FINI_ARRAYSZ)       8 (bytes)\n 0x000000006ffffef5 (GNU_HASH)           0x1c8\n 0x0000000000000005 (STRTAB)             0x18d0\n 0x0000000000000006 (SYMTAB)             0x208\n 0x000000000000000a (STRSZ)              4539 (bytes)\n 0x000000000000000b (SYMENT)             24 (bytes)\n 0x0000000000000003 (PLTGOT)             0x215000\n 0x0000000000000002 (PLTRELSZ)           5256 (bytes)\n 0x0000000000000014 (PLTREL)             RELA\n 0x0000000000000017 (JMPREL)             0x5d50\n 0x0000000000000007 (RELA)               0x2cd8\n 0x0000000000000008 (RELASZ)             12408 (bytes)\n 0x0000000000000009 (RELAENT)            24 (bytes)\n 0x000000006ffffffe (VERNEED)            0x2c78\n 0x000000006fffffff (VERNEEDNUM)         2\n 0x000000006ffffff0 (VERSYM)             0x2a8c\n 0x000000006ffffff9 (RELACOUNT)          499\n 0x0000000000000000 (NULL)               0x0\n```",
    "created_at": "2017-06-19T08:36:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23161#issuecomment-347337",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:11" align="right">comment:11</div>

Hmm, for some reason I cannot reproduce the problem anymore. There must be some non-deterministic aspect...

Now (without this patch), I get

```
$ readelf -d local/lib/python2.7/lib-dynload/_ssl.so

Dynamic section at offset 0x14d60 contains 29 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libssl.so.1.0.0]
 0x0000000000000001 (NEEDED)             Shared library: [libcrypto.so.1.0.0]
 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]
 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x000000000000001d (RUNPATH)            Library runpath: [/usr/local/src/sage-config/local/lib]
 0x000000000000000c (INIT)               0x71d8
 0x000000000000000d (FINI)               0xf6f0
 0x0000000000000019 (INIT_ARRAY)         0x214d48
 0x000000000000001b (INIT_ARRAYSZ)       8 (bytes)
 0x000000000000001a (FINI_ARRAY)         0x214d50
 0x000000000000001c (FINI_ARRAYSZ)       8 (bytes)
 0x000000006ffffef5 (GNU_HASH)           0x1c8
 0x0000000000000005 (STRTAB)             0x18d0
 0x0000000000000006 (SYMTAB)             0x208
 0x000000000000000a (STRSZ)              4539 (bytes)
 0x000000000000000b (SYMENT)             24 (bytes)
 0x0000000000000003 (PLTGOT)             0x215000
 0x0000000000000002 (PLTRELSZ)           5256 (bytes)
 0x0000000000000014 (PLTREL)             RELA
 0x0000000000000017 (JMPREL)             0x5d50
 0x0000000000000007 (RELA)               0x2cd8
 0x0000000000000008 (RELASZ)             12408 (bytes)
 0x0000000000000009 (RELAENT)            24 (bytes)
 0x000000006ffffffe (VERNEED)            0x2c78
 0x000000006fffffff (VERNEEDNUM)         2
 0x000000006ffffff0 (VERSYM)             0x2a8c
 0x000000006ffffff9 (RELACOUNT)          499
 0x0000000000000000 (NULL)               0x0
```



---

archive/issue_comments_347338.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@jdemeyer](#comment:11):\n> Hmm, for some reason I cannot reproduce the problem anymore. There must be some non-deterministic aspect...\n> \n> Now (without this patch), I get\n> \n> ```\n> $ readelf -d local/lib/python2.7/lib-dynload/_ssl.so\n> \n> Dynamic section at offset 0x14d60 contains 29 entries:\n>   Tag        Type                         Name/Value\n>  0x0000000000000001 (NEEDED)             Shared library: [libssl.so.1.0.0]\n>  0x0000000000000001 (NEEDED)             Shared library: [libcrypto.so.1.0.0]\n>  0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]\n>  0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]\n>  0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]\n>  0x000000000000001d (RUNPATH)            Library runpath: [/usr/local/src/sage-config/local/lib]\n>  0x000000000000000c (INIT)               0x71d8\n>  0x000000000000000d (FINI)               0xf6f0\n>  0x0000000000000019 (INIT_ARRAY)         0x214d48\n>  0x000000000000001b (INIT_ARRAYSZ)       8 (bytes)\n>  0x000000000000001a (FINI_ARRAY)         0x214d50\n>  0x000000000000001c (FINI_ARRAYSZ)       8 (bytes)\n>  0x000000006ffffef5 (GNU_HASH)           0x1c8\n>  0x0000000000000005 (STRTAB)             0x18d0\n>  0x0000000000000006 (SYMTAB)             0x208\n>  0x000000000000000a (STRSZ)              4539 (bytes)\n>  0x000000000000000b (SYMENT)             24 (bytes)\n>  0x0000000000000003 (PLTGOT)             0x215000\n>  0x0000000000000002 (PLTRELSZ)           5256 (bytes)\n>  0x0000000000000014 (PLTREL)             RELA\n>  0x0000000000000017 (JMPREL)             0x5d50\n>  0x0000000000000007 (RELA)               0x2cd8\n>  0x0000000000000008 (RELASZ)             12408 (bytes)\n>  0x0000000000000009 (RELAENT)            24 (bytes)\n>  0x000000006ffffffe (VERNEED)            0x2c78\n>  0x000000006fffffff (VERNEEDNUM)         2\n>  0x000000006ffffff0 (VERSYM)             0x2a8c\n>  0x000000006ffffff9 (RELACOUNT)          499\n>  0x0000000000000000 (NULL)               0x0\n> ```\n\nWhich looks very much the same as before. Would you happen to have upgraded the system zlib on your box? 1.2.11 is the only version available in Gentoo now and you wouldn't get the message if the version on the system is the same as in sage.",
    "created_at": "2017-06-19T08:58:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23161#issuecomment-347338",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@jdemeyer](#comment:11):
> Hmm, for some reason I cannot reproduce the problem anymore. There must be some non-deterministic aspect...
> 
> Now (without this patch), I get
> 
> ```
> $ readelf -d local/lib/python2.7/lib-dynload/_ssl.so
> 
> Dynamic section at offset 0x14d60 contains 29 entries:
>   Tag        Type                         Name/Value
>  0x0000000000000001 (NEEDED)             Shared library: [libssl.so.1.0.0]
>  0x0000000000000001 (NEEDED)             Shared library: [libcrypto.so.1.0.0]
>  0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]
>  0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]
>  0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
>  0x000000000000001d (RUNPATH)            Library runpath: [/usr/local/src/sage-config/local/lib]
>  0x000000000000000c (INIT)               0x71d8
>  0x000000000000000d (FINI)               0xf6f0
>  0x0000000000000019 (INIT_ARRAY)         0x214d48
>  0x000000000000001b (INIT_ARRAYSZ)       8 (bytes)
>  0x000000000000001a (FINI_ARRAY)         0x214d50
>  0x000000000000001c (FINI_ARRAYSZ)       8 (bytes)
>  0x000000006ffffef5 (GNU_HASH)           0x1c8
>  0x0000000000000005 (STRTAB)             0x18d0
>  0x0000000000000006 (SYMTAB)             0x208
>  0x000000000000000a (STRSZ)              4539 (bytes)
>  0x000000000000000b (SYMENT)             24 (bytes)
>  0x0000000000000003 (PLTGOT)             0x215000
>  0x0000000000000002 (PLTRELSZ)           5256 (bytes)
>  0x0000000000000014 (PLTREL)             RELA
>  0x0000000000000017 (JMPREL)             0x5d50
>  0x0000000000000007 (RELA)               0x2cd8
>  0x0000000000000008 (RELASZ)             12408 (bytes)
>  0x0000000000000009 (RELAENT)            24 (bytes)
>  0x000000006ffffffe (VERNEED)            0x2c78
>  0x000000006fffffff (VERNEEDNUM)         2
>  0x000000006ffffff0 (VERSYM)             0x2a8c
>  0x000000006ffffff9 (RELACOUNT)          499
>  0x0000000000000000 (NULL)               0x0
> ```

Which looks very much the same as before. Would you happen to have upgraded the system zlib on your box? 1.2.11 is the only version available in Gentoo now and you wouldn't get the message if the version on the system is the same as in sage.



---

archive/issue_comments_347339.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReplying to [@kiwifb](#comment:12):\n> Would you happen to have upgraded the system zlib on your box?\n\nNo, I did not. My system has `zlib-1.2.8-r1`.",
    "created_at": "2017-06-19T10:06:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23161#issuecomment-347339",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:13" align="right">comment:13</div>

Replying to [@kiwifb](#comment:12):
> Would you happen to have upgraded the system zlib on your box?

No, I did not. My system has `zlib-1.2.8-r1`.



---

archive/issue_comments_347340.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nIt depends on which transitive dependency is pulled first, so it may very well be random.",
    "created_at": "2017-06-20T10:52:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23161#issuecomment-347340",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:14" align="right">comment:14</div>

It depends on which transitive dependency is pulled first, so it may very well be random.



---

archive/issue_comments_347341.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nAfter looking up some more stuff as part of discussion we are also having regarding gf2x upcoming release, stuff on freeBSD and other libtool matters. I now think disabling `disable-new-dtags` may actually bring more harm than good.\n\nWithout it `DT_RUNPATH` is not present in the elf file. Just `DT_RPATH`, which means that `DT_RPATH` has priority look up over `LD_LIBRARY_PATH`. That doesn't seem to be a problem until you realise how libtool wraps binaries to be able run the `make check` target with `LD_LIBRARY_PATH` (or equivalent) to make sure you use the version of the library in the build tree. \n\nOf course sage's spkg install before testing, which is a bit goofy but that's another argument, so it may not feel relevant. But we are dealing with stuff that is a bit more complicated like `gf2x`'s tuning. For `gf2x`'s tuning to work, you actually need to use a version of the library that you haven't installed yet. In that context, unless you remove the old `gf2x` first, you cannot re-run the install of `gf2x` properly. That's probably the only case for standard packages, Dima would have mentioned any other one on the freeBSD support ticket (basically this branch would enable the current behavior observed on freeBSD).",
    "created_at": "2017-06-28T02:25:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23161#issuecomment-347341",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:15" align="right">comment:15</div>

After looking up some more stuff as part of discussion we are also having regarding gf2x upcoming release, stuff on freeBSD and other libtool matters. I now think disabling `disable-new-dtags` may actually bring more harm than good.

Without it `DT_RUNPATH` is not present in the elf file. Just `DT_RPATH`, which means that `DT_RPATH` has priority look up over `LD_LIBRARY_PATH`. That doesn't seem to be a problem until you realise how libtool wraps binaries to be able run the `make check` target with `LD_LIBRARY_PATH` (or equivalent) to make sure you use the version of the library in the build tree. 

Of course sage's spkg install before testing, which is a bit goofy but that's another argument, so it may not feel relevant. But we are dealing with stuff that is a bit more complicated like `gf2x`'s tuning. For `gf2x`'s tuning to work, you actually need to use a version of the library that you haven't installed yet. In that context, unless you remove the old `gf2x` first, you cannot re-run the install of `gf2x` properly. That's probably the only case for standard packages, Dima would have mentioned any other one on the freeBSD support ticket (basically this branch would enable the current behavior observed on freeBSD).



---

archive/issue_comments_347342.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nE.g. Fedora defaults to `disable-new-dtags` so it has to work; The only question is whether or not we want to support both.\n\nIMHO gf2x is just unnecessarily playing it on hard mode; Shared libraries with the same version number are supposed to be interchangeable. Why use shared libraries for tuning?",
    "created_at": "2017-06-28T19:58:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23161#issuecomment-347342",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:16" align="right">comment:16</div>

E.g. Fedora defaults to `disable-new-dtags` so it has to work; The only question is whether or not we want to support both.

IMHO gf2x is just unnecessarily playing it on hard mode; Shared libraries with the same version number are supposed to be interchangeable. Why use shared libraries for tuning?



---

archive/issue_comments_347343.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@vbraun](#comment:16):\n> E.g. Fedora defaults to `disable-new-dtags` so it has to work; The only question is whether or not we want to support both.\n> \n\nIt does work. And you'll get correct results on the first install.\n\n> IMHO gf2x is just unnecessarily playing it on hard mode; Shared libraries with the same version number are supposed to be interchangeable. Why use shared libraries for tuning?\n\nWell they are technically interchangeable, they expose the same API, they just have different internals during tuning to find the best internals. You are right, using static libraries would solve the problem, but you would probably have to rethink the way it is built and tuned.\nLike I said you, will have the correct result on first install, on subsequent installs or upgrade you will have to remove the old installed library to get the correct tuning.\n\nI won't oppose the change if you, Jeroen and Erik think it is the way to go. But I think having the conversation and understanding some of the implications was necessary.",
    "created_at": "2017-06-28T21:17:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23161#issuecomment-347343",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@vbraun](#comment:16):
> E.g. Fedora defaults to `disable-new-dtags` so it has to work; The only question is whether or not we want to support both.
> 

It does work. And you'll get correct results on the first install.

> IMHO gf2x is just unnecessarily playing it on hard mode; Shared libraries with the same version number are supposed to be interchangeable. Why use shared libraries for tuning?

Well they are technically interchangeable, they expose the same API, they just have different internals during tuning to find the best internals. You are right, using static libraries would solve the problem, but you would probably have to rethink the way it is built and tuned.
Like I said you, will have the correct result on first install, on subsequent installs or upgrade you will have to remove the old installed library to get the correct tuning.

I won't oppose the change if you, Jeroen and Erik think it is the way to go. But I think having the conversation and understanding some of the implications was necessary.



---

archive/issue_events_322834.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-07-06T10:26:04Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "label": "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p: 1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23161#event-322834"
}
```



---

archive/issue_events_322835.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-07-06T10:26:04Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23161#event-322835"
}
```



---

archive/issue_comments_347344.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nI can no longer reproduce this, so I'm downgrading the priority.",
    "created_at": "2017-07-06T10:26:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23161#issuecomment-347344",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:18" align="right">comment:18</div>

I can no longer reproduce this, so I'm downgrading the priority.



---

archive/issue_comments_347345.json:
```json
{
    "body": "Changed author from **Jeroen Demeyer** to none",
    "created_at": "2017-08-31T08:53:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23161#issuecomment-347345",
    "user": "https://github.com/jdemeyer"
}
```

Changed author from **Jeroen Demeyer** to none



---

archive/issue_events_322836.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-08-31T08:53:36Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "milestone_number": null,
    "milestone_title": "sage-8.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23161#event-322836"
}
```



---

archive/issue_events_322837.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-08-31T08:53:36Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23161#event-322837"
}
```



---

archive/issue_events_322838.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-08-31T08:53:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "label": "https://github.com/sagemath/sage/labels/invalid",
    "label_color": "a6a6a6",
    "label_name": "invalid",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23161#event-322838"
}
```



---

archive/issue_events_322839.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-08-31T08:53:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "label": "https://github.com/sagemath/sage/labels/worksforme",
    "label_color": "a6a6a6",
    "label_name": "worksforme",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23161#event-322839"
}
```



---

archive/issue_events_322840.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-08-31T08:53:36Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23161#event-322840"
}
```



---

archive/issue_events_322841.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-08-31T08:53:36Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23161#event-322841"
}
```



---

archive/issue_comments_347346.json:
```json
{
    "body": "Reviewer: **Jeroen Demeyer**",
    "created_at": "2017-08-31T08:53:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23161#issuecomment-347346",
    "user": "https://github.com/jdemeyer"
}
```

Reviewer: **Jeroen Demeyer**
