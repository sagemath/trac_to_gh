# Issue 23592: Faster comparison of manifold points

archive/issues_023355.json:
```json
{
    "body": "Comparison of manifold points, as implemented in `ManifoldPoint.__eq__`, relies on comparison of coordinate values in a common chart. When coordinates are symbolic, this goes through Maxima and can take a lot of time. Now, comparison of points is involved in the unique representation of tangent spaces. When many tangent spaces are created (as for instance when plotting a vector field), this has a non-neglible cost. This ticket makes `ManifoldPoint.__eq__` faster by invoking `(a-b).is_trivial_zero()` when `a` and `b` are symbolic coordinates of two points, while the previous version was using `a == b`. Note that for non-symbolic values (i.e. numerical values), `a == b` is still used.\n\nCC:  karimvanaelst @tscrim\n\nKeywords: manifold point\n\nBranch/Commit: 48a66fcc1282ca7749d69550a15c60d0ae56c3de\n\nReviewer: David Roe\n\nAuthor: Eric Gourgoulhon\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/23592\n\n",
    "closed_at": "2017-08-11T18:17:32Z",
    "created_at": "2017-08-07T20:26:22Z",
    "labels": [
        "component: geometry"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Faster comparison of manifold points",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23592",
    "user": "https://github.com/egourgoulhon"
}
```
Comparison of manifold points, as implemented in `ManifoldPoint.__eq__`, relies on comparison of coordinate values in a common chart. When coordinates are symbolic, this goes through Maxima and can take a lot of time. Now, comparison of points is involved in the unique representation of tangent spaces. When many tangent spaces are created (as for instance when plotting a vector field), this has a non-neglible cost. This ticket makes `ManifoldPoint.__eq__` faster by invoking `(a-b).is_trivial_zero()` when `a` and `b` are symbolic coordinates of two points, while the previous version was using `a == b`. Note that for non-symbolic values (i.e. numerical values), `a == b` is still used.

CC:  karimvanaelst @tscrim

Keywords: manifold point

Branch/Commit: 48a66fcc1282ca7749d69550a15c60d0ae56c3de

Reviewer: David Roe

Author: Eric Gourgoulhon

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/23592





---

archive/issue_comments_444275.json:
```json
{
    "body": "<a id='comment:1'></a>New commits:",
    "created_at": "2017-08-07T20:29:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23592#issuecomment-444275",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:1'></a>New commits:



---

archive/issue_comments_444276.json:
```json
{
    "body": "Changing branch from \"\" to \"public/manifolds/point_comparison-23592\"",
    "created_at": "2017-08-07T20:29:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23592#issuecomment-444276",
    "user": "https://github.com/egourgoulhon"
}
```

Changing branch from "" to "public/manifolds/point_comparison-23592"



---

archive/issue_comments_444277.json:
```json
{
    "body": "Changing commit from \"\" to \"34472e89cfdb36f96937cfdfd73b902e879d720d\"",
    "created_at": "2017-08-07T20:29:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23592#issuecomment-444277",
    "user": "https://github.com/egourgoulhon"
}
```

Changing commit from "" to "34472e89cfdb36f96937cfdfd73b902e879d720d"



---

archive/issue_comments_444278.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-08-07T20:31:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23592#issuecomment-444278",
    "user": "https://github.com/egourgoulhon"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_444279.json:
```json
{
    "body": "<a id='comment:3'></a>Shouldn't you also short-circuit the for loop in case you ever get False?",
    "created_at": "2017-08-07T20:34:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23592#issuecomment-444279",
    "user": "https://github.com/roed314"
}
```

<a id='comment:3'></a>Shouldn't you also short-circuit the for loop in case you ever get False?



---

archive/issue_comments_444280.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-08-07T20:56:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23592#issuecomment-444280",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_444281.json:
```json
{
    "body": "Changing commit from \"34472e89cfdb36f96937cfdfd73b902e879d720d\" to \"bd717d91f2edc087036328d55d0b02627fbd0914\"",
    "created_at": "2017-08-07T20:56:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23592#issuecomment-444281",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "34472e89cfdb36f96937cfdfd73b902e879d720d" to "bd717d91f2edc087036328d55d0b02627fbd0914"



---

archive/issue_comments_444282.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:3 roed]:\n> Shouldn't you also short-circuit the for loop in case you ever get False?\n\nYou are perfectly right! Thanks for pointing this. The latest commit takes it into account.",
    "created_at": "2017-08-07T20:57:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23592#issuecomment-444282",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:5'></a>Replying to [comment:3 roed]:
> Shouldn't you also short-circuit the for loop in case you ever get False?

You are perfectly right! Thanks for pointing this. The latest commit takes it into account.



---

archive/issue_comments_444283.json:
```json
{
    "body": "<a id='comment:6'></a>The only other comment that I have is that you have three nested if statements, e.g.\n\n```python\nif isinstance(diff_c, Expression):\n    if not diff_c.is_trivial_zero():\n        return False\n```\n\nI think it's clearer if such statements are phrased as\n\n```python\nif isinstance(diff_c, Expression) and not diff_c.is_trivial_zero():\n    return False\n```\nsince there are fewer nested blocks this way.\n\nOther than that, looks good once tests pass!",
    "created_at": "2017-08-07T21:18:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23592#issuecomment-444283",
    "user": "https://github.com/roed314"
}
```

<a id='comment:6'></a>The only other comment that I have is that you have three nested if statements, e.g.

```python
if isinstance(diff_c, Expression):
    if not diff_c.is_trivial_zero():
        return False
```

I think it's clearer if such statements are phrased as

```python
if isinstance(diff_c, Expression) and not diff_c.is_trivial_zero():
    return False
```
since there are fewer nested blocks this way.

Other than that, looks good once tests pass!



---

archive/issue_comments_444284.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:6 roed]:\n> The only other comment that I have is that you have three nested if statements, e.g.\n> \n> ```\n> #!python\n> if isinstance(diff_c, Expression):\n>     if not diff_c.is_trivial_zero():\n>         return False\n> ```\n> \n> I think it's clearer if such statements are phrased as\n> \n> ```\n> #!python\n> if isinstance(diff_c, Expression) and not diff_c.is_trivial_zero():\n>     return False\n> ```\n> since there are fewer nested blocks this way.\n> \n\n\nI wrote it with nested blocks because `is_trivial_zero()` is implemented only for instances of `Expression`. Is it safe to assume that the second form will never return any attribute error? i.e. that the test following the `and` is performed only \nif the test preceding the `and` is passed? (maybe this is guaranted by Python standard rules)\n\n> Other than that, looks good once tests pass!\n\n\nThe failures reported by the patchbot do not pertain to this ticket; on my computer all tests passed within Sage 8.1.beta1.",
    "created_at": "2017-08-07T22:56:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23592#issuecomment-444284",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:7'></a>Replying to [comment:6 roed]:
> The only other comment that I have is that you have three nested if statements, e.g.
> 
> ```
> #!python
> if isinstance(diff_c, Expression):
>     if not diff_c.is_trivial_zero():
>         return False
> ```
> 
> I think it's clearer if such statements are phrased as
> 
> ```
> #!python
> if isinstance(diff_c, Expression) and not diff_c.is_trivial_zero():
>     return False
> ```
> since there are fewer nested blocks this way.
> 


I wrote it with nested blocks because `is_trivial_zero()` is implemented only for instances of `Expression`. Is it safe to assume that the second form will never return any attribute error? i.e. that the test following the `and` is performed only 
if the test preceding the `and` is passed? (maybe this is guaranted by Python standard rules)

> Other than that, looks good once tests pass!


The failures reported by the patchbot do not pertain to this ticket; on my computer all tests passed within Sage 8.1.beta1.



---

archive/issue_comments_444285.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:7 egourgoulhon]:\n> Replying to [comment:6 roed]:\n> > The only other comment that I have is that you have three nested if statements, e.g.\n> > \n> > ```\n> > #!python\n> > if isinstance(diff_c, Expression):\n> >     if not diff_c.is_trivial_zero():\n> >         return False\n> > ```\n> > \n> > I think it's clearer if such statements are phrased as\n> > \n> > ```\n> > #!python\n> > if isinstance(diff_c, Expression) and not diff_c.is_trivial_zero():\n> >     return False\n> > ```\n> > since there are fewer nested blocks this way.\n> > \n\n> \n> I wrote it with nested blocks because `is_trivial_zero()` is implemented only for instances of `Expression`. Is it safe to assume that the second form will never return any attribute error? i.e. that the test following the `and` is performed only \n> if the test preceding the `and` is passed? (maybe this is guaranted by Python standard rules)\n\n\nYep, Python supports [short-circuit evaluation](https://docs.python.org/2/library/stdtypes.html#boolean-operations-and-or-not) for `and` and `or`.",
    "created_at": "2017-08-07T23:17:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23592#issuecomment-444285",
    "user": "https://github.com/roed314"
}
```

<a id='comment:8'></a>Replying to [comment:7 egourgoulhon]:
> Replying to [comment:6 roed]:
> > The only other comment that I have is that you have three nested if statements, e.g.
> > 
> > ```
> > #!python
> > if isinstance(diff_c, Expression):
> >     if not diff_c.is_trivial_zero():
> >         return False
> > ```
> > 
> > I think it's clearer if such statements are phrased as
> > 
> > ```
> > #!python
> > if isinstance(diff_c, Expression) and not diff_c.is_trivial_zero():
> >     return False
> > ```
> > since there are fewer nested blocks this way.
> > 

> 
> I wrote it with nested blocks because `is_trivial_zero()` is implemented only for instances of `Expression`. Is it safe to assume that the second form will never return any attribute error? i.e. that the test following the `and` is performed only 
> if the test preceding the `and` is passed? (maybe this is guaranted by Python standard rules)


Yep, Python supports [short-circuit evaluation](https://docs.python.org/2/library/stdtypes.html#boolean-operations-and-or-not) for `and` and `or`.



---

archive/issue_comments_444286.json:
```json
{
    "body": "Changing commit from \"bd717d91f2edc087036328d55d0b02627fbd0914\" to \"48a66fcc1282ca7749d69550a15c60d0ae56c3de\"",
    "created_at": "2017-08-08T10:02:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23592#issuecomment-444286",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "bd717d91f2edc087036328d55d0b02627fbd0914" to "48a66fcc1282ca7749d69550a15c60d0ae56c3de"



---

archive/issue_comments_444287.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-08-08T10:02:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23592#issuecomment-444287",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_444288.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:8 roed]:\n> Yep, Python supports [short-circuit evaluation](https://docs.python.org/2/library/stdtypes.html#boolean-operations-and-or-not) for `and` and `or`.\n\n\nVery good, thanks. I've updated the code accordingly. I've also slightly simplified it, since there was no need to create a list of coordinate differences.",
    "created_at": "2017-08-08T10:05:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23592#issuecomment-444288",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:10'></a>Replying to [comment:8 roed]:
> Yep, Python supports [short-circuit evaluation](https://docs.python.org/2/library/stdtypes.html#boolean-operations-and-or-not) for `and` and `or`.


Very good, thanks. I've updated the code accordingly. I've also slightly simplified it, since there was no need to create a list of coordinate differences.



---

archive/issue_comments_444289.json:
```json
{
    "body": "<a id='comment:11'></a>The errors all have to do with docbuilding, which clearly isn't your faults since you don't edit any documentation.\n\nLooks good to me.",
    "created_at": "2017-08-09T07:02:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23592#issuecomment-444289",
    "user": "https://github.com/roed314"
}
```

<a id='comment:11'></a>The errors all have to do with docbuilding, which clearly isn't your faults since you don't edit any documentation.

Looks good to me.



---

archive/issue_comments_444290.json:
```json
{
    "body": "Changing reviewer from \"\" to \"David Roe\"",
    "created_at": "2017-08-09T07:02:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23592#issuecomment-444290",
    "user": "https://github.com/roed314"
}
```

Changing reviewer from "" to "David Roe"



---

archive/issue_comments_444291.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-08-09T07:02:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23592#issuecomment-444291",
    "user": "https://github.com/roed314"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_444292.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:11 roed]:\n> The errors all have to do with docbuilding, which clearly isn't your faults since you don't edit any documentation.\n> \n> Looks good to me.\n\n\nThanks for the review!",
    "created_at": "2017-08-09T09:11:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23592#issuecomment-444292",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:12'></a>Replying to [comment:11 roed]:
> The errors all have to do with docbuilding, which clearly isn't your faults since you don't edit any documentation.
> 
> Looks good to me.


Thanks for the review!



---

archive/issue_comments_444293.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-08-11T18:17:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23592#issuecomment-444293",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_060440.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-08-11T18:17:32Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23592",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23592#event-60440"
}
```



---

archive/issue_comments_444294.json:
```json
{
    "body": "Changing branch from \"public/manifolds/point_comparison-23592\" to \"48a66fcc1282ca7749d69550a15c60d0ae56c3de\"",
    "created_at": "2017-08-11T18:17:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23592#issuecomment-444294",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/manifolds/point_comparison-23592" to "48a66fcc1282ca7749d69550a15c60d0ae56c3de"
