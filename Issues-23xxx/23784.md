# Issue 23784: p-adic Gamma function breaks on zero input

archive/issues_023547.json:
```json
{
    "body": "By construction, the p-adic Gamma function equals 1 when evaluated at 0. However, this is currently broken:\n\n```\nsage: F = Qp(7)\nsage: F(0).gamma() # should return F(1)\n---------------------------------------------------------------------------\nPariError                                 Traceback (most recent call last)\n<ipython-input-38-6f124d83fb80> in <module>()\n----> 1 F(Integer(0)).gamma()\n\n/home/kedlaya/sage-complete/src/sage/rings/padics/padic_generic_element.pyx in sage.rings.padics.padic_generic_element.pAdicGenericElement.gamma (/home/kedlaya/sage-complete/src/build/cythonized/sage/rings/padics/padic_generic_element.c:8619)()\n    823         parent = self.parent()\n    824         if algorithm == 'pari':\n--> 825             return parent(self.__pari__().gamma())\n    826         elif algorithm == 'sage':\n    827             from sage.misc.all import prod\n\ncypari2/auto_gen.pxi in cypari2.gen.Gen_auto.gamma (cypari2/gen.c:45723)()\n\ncypari2/handle_error.pyx in cypari2.handle_error._pari_err_handle (cypari2/handle_error.c:2075)()\n\nPariError: domain error in gamma: argument = non-positive integer\n```\nUsing Sage's internal code is no better:\n\n```\nsage: F(0).gamma(algorithm='sage')\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-41-b5818b2c6ffe> in <module>()\n----> 1 F(Integer(0)).gamma(algorithm='sage')\n\n/home/kedlaya/sage-complete/src/sage/rings/padics/padic_generic_element.pyx in sage.rings.padics.padic_generic_element.pAdicGenericElement.gamma (/home/kedlaya/sage-complete/src/build/cythonized/sage/rings/padics/padic_generic_element.c:8784)()\n    828             p = parent.prime()\n    829             n = self.precision_absolute()\n--> 830             bd = n + 2*n//p\n    831             if self.is_padic_unit():\n    832                 k = Integer(self.residue())  # leading coefficient of self, non-zero\n\n/home/kedlaya/sage-complete/src/sage/structure/element.pyx in sage.structure.element.Element.__floordiv__ (/home/kedlaya/sage-complete/src/build/cythonized/sage/structure/element.c:13179)()\n   1769             return (<Element>left)._floordiv_(right)\n   1770         if BOTH_ARE_ELEMENT(cl):\n-> 1771             return coercion_model.bin_op(left, right, floordiv)\n   1772 \n   1773         try:\n\n/home/kedlaya/sage-complete/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.bin_op (/home/kedlaya/sage-complete/src/build/cythonized/sage/structure/coerce.c:9350)()\n   1054             if xy is not None:\n   1055                 # The error was in calling, not coercing\n-> 1056                 raise\n   1057             self._record_exception()\n   1058 \n\n/home/kedlaya/sage-complete/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.bin_op (/home/kedlaya/sage-complete/src/build/cythonized/sage/structure/coerce.c:9288)()\n   1050         try:\n   1051             xy = self.canonical_coercion(x,y)\n-> 1052             return PyObject_CallObject(op, xy)\n   1053         except TypeError as err:\n   1054             if xy is not None:\n\n/home/kedlaya/sage-complete/src/sage/structure/element.pyx in sage.structure.element.Element.__floordiv__ (/home/kedlaya/sage-complete/src/build/cythonized/sage/structure/element.c:13144)()\n   1767         cdef int cl = classify_elements(left, right)\n   1768         if HAVE_SAME_PARENT(cl):\n-> 1769             return (<Element>left)._floordiv_(right)\n   1770         if BOTH_ARE_ELEMENT(cl):\n   1771             return coercion_model.bin_op(left, right, floordiv)\n\n/home/kedlaya/sage-complete/src/sage/structure/element.pyx in sage.structure.element.Element._floordiv_ (/home/kedlaya/sage-complete/src/build/cythonized/sage/structure/element.c:13470)()\n   1802             python_op = (<object>self)._floordiv_\n   1803         except AttributeError:\n-> 1804             raise bin_op_exception('//', self, other)\n   1805         else:\n   1806             return python_op(other)\n\nTypeError: unsupported operand parent(s) for //: 'The Infinity Ring' and 'The Infinity Ring'\n```\nIn both case, the problem is that the input really should be treated as an inexact zero, not an exact zero:\n\n```\nsage: F(0+O(7^20)).gamma()\n1 + O(7^20)\nsage: F(0+O(7^20)).gamma(algorithm='sage')\n1 + O(7^20)\n```\n\nKeywords: p-adic Gamma function\n\nReviewer: Kiran Kedlaya\n\nAuthor: David Roe\n\nBranch: e5f16fe21db58884525d943081a2698f7c5d0146\n\nCommit: e5f16fe21db58884525d943081a2698f7c5d0146\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/23784\n\n",
    "closed_at": "2017-09-10T11:56:44Z",
    "created_at": "2017-09-05T04:37:36Z",
    "labels": [
        "component: padics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "p-adic Gamma function breaks on zero input",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23784",
    "user": "https://github.com/kedlaya"
}
```
By construction, the p-adic Gamma function equals 1 when evaluated at 0. However, this is currently broken:

```
sage: F = Qp(7)
sage: F(0).gamma() # should return F(1)
---------------------------------------------------------------------------
PariError                                 Traceback (most recent call last)
<ipython-input-38-6f124d83fb80> in <module>()
----> 1 F(Integer(0)).gamma()

/home/kedlaya/sage-complete/src/sage/rings/padics/padic_generic_element.pyx in sage.rings.padics.padic_generic_element.pAdicGenericElement.gamma (/home/kedlaya/sage-complete/src/build/cythonized/sage/rings/padics/padic_generic_element.c:8619)()
    823         parent = self.parent()
    824         if algorithm == 'pari':
--> 825             return parent(self.__pari__().gamma())
    826         elif algorithm == 'sage':
    827             from sage.misc.all import prod

cypari2/auto_gen.pxi in cypari2.gen.Gen_auto.gamma (cypari2/gen.c:45723)()

cypari2/handle_error.pyx in cypari2.handle_error._pari_err_handle (cypari2/handle_error.c:2075)()

PariError: domain error in gamma: argument = non-positive integer
```
Using Sage's internal code is no better:

```
sage: F(0).gamma(algorithm='sage')
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-41-b5818b2c6ffe> in <module>()
----> 1 F(Integer(0)).gamma(algorithm='sage')

/home/kedlaya/sage-complete/src/sage/rings/padics/padic_generic_element.pyx in sage.rings.padics.padic_generic_element.pAdicGenericElement.gamma (/home/kedlaya/sage-complete/src/build/cythonized/sage/rings/padics/padic_generic_element.c:8784)()
    828             p = parent.prime()
    829             n = self.precision_absolute()
--> 830             bd = n + 2*n//p
    831             if self.is_padic_unit():
    832                 k = Integer(self.residue())  # leading coefficient of self, non-zero

/home/kedlaya/sage-complete/src/sage/structure/element.pyx in sage.structure.element.Element.__floordiv__ (/home/kedlaya/sage-complete/src/build/cythonized/sage/structure/element.c:13179)()
   1769             return (<Element>left)._floordiv_(right)
   1770         if BOTH_ARE_ELEMENT(cl):
-> 1771             return coercion_model.bin_op(left, right, floordiv)
   1772 
   1773         try:

/home/kedlaya/sage-complete/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.bin_op (/home/kedlaya/sage-complete/src/build/cythonized/sage/structure/coerce.c:9350)()
   1054             if xy is not None:
   1055                 # The error was in calling, not coercing
-> 1056                 raise
   1057             self._record_exception()
   1058 

/home/kedlaya/sage-complete/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.bin_op (/home/kedlaya/sage-complete/src/build/cythonized/sage/structure/coerce.c:9288)()
   1050         try:
   1051             xy = self.canonical_coercion(x,y)
-> 1052             return PyObject_CallObject(op, xy)
   1053         except TypeError as err:
   1054             if xy is not None:

/home/kedlaya/sage-complete/src/sage/structure/element.pyx in sage.structure.element.Element.__floordiv__ (/home/kedlaya/sage-complete/src/build/cythonized/sage/structure/element.c:13144)()
   1767         cdef int cl = classify_elements(left, right)
   1768         if HAVE_SAME_PARENT(cl):
-> 1769             return (<Element>left)._floordiv_(right)
   1770         if BOTH_ARE_ELEMENT(cl):
   1771             return coercion_model.bin_op(left, right, floordiv)

/home/kedlaya/sage-complete/src/sage/structure/element.pyx in sage.structure.element.Element._floordiv_ (/home/kedlaya/sage-complete/src/build/cythonized/sage/structure/element.c:13470)()
   1802             python_op = (<object>self)._floordiv_
   1803         except AttributeError:
-> 1804             raise bin_op_exception('//', self, other)
   1805         else:
   1806             return python_op(other)

TypeError: unsupported operand parent(s) for //: 'The Infinity Ring' and 'The Infinity Ring'
```
In both case, the problem is that the input really should be treated as an inexact zero, not an exact zero:

```
sage: F(0+O(7^20)).gamma()
1 + O(7^20)
sage: F(0+O(7^20)).gamma(algorithm='sage')
1 + O(7^20)
```

Keywords: p-adic Gamma function

Reviewer: Kiran Kedlaya

Author: David Roe

Branch: e5f16fe21db58884525d943081a2698f7c5d0146

Commit: e5f16fe21db58884525d943081a2698f7c5d0146

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/23784





---

archive/issue_comments_329525.json:
```json
{
    "body": "<a id='comment:2'></a>New commits:",
    "created_at": "2017-09-05T06:31:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23784",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23784#issuecomment-329525",
    "user": "https://github.com/roed314"
}
```

<a id='comment:2'></a>New commits:



---

archive/issue_comments_329526.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-09-05T06:31:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23784",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23784#issuecomment-329526",
    "user": "https://github.com/roed314"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_329527.json:
```json
{
    "body": "<a id='comment:3'></a>Looks good to me, and patchbot doesn't show any genuine doctest failures. Positive review.",
    "created_at": "2017-09-05T08:18:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23784",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23784#issuecomment-329527",
    "user": "https://github.com/kedlaya"
}
```

<a id='comment:3'></a>Looks good to me, and patchbot doesn't show any genuine doctest failures. Positive review.



---

archive/issue_comments_329528.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-09-05T08:18:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23784",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23784#issuecomment-329528",
    "user": "https://github.com/kedlaya"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_060661.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-09-10T11:56:44Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23784",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23784#event-60661"
}
```



---

archive/issue_comments_329529.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-09-10T11:56:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23784",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23784#issuecomment-329529",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
