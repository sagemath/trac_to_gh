# Issue 23153: Bug in finite field element GAP-to-Sage conversion when explicit field is specified

archive/issues_022916.json:
```json
{
    "body": "As [reported](https://groups.google.com/d/msg/sage-devel/1VHx3laSU_U/wFxF2JsABwAJ) on sage-devel\n\n```\nS = GF(2^4, 'a')\na = S.gen()\n\nG = SL(2, S)\n\ng1 = G([a**2, a**3 + a**2 + a, a + 1, 0])\ng2 = G([a, 0, 0, a**3 + 1])\n\n# prints True True\nprint g1 in G, g2 in G\n\n# Throws a ValueError\nprint g1 * g2\n```\nSpecifically, one gets\n\n```\nValueError: the given finite field has incompatible size\n```\n\nThe actual underlying bug is the fact that the `GapElement_FiniteField.sage` method malfunctions when an explicit `ring` argument is specified and the element lies in a subfield of the field passed in that argument (note that GAP performs such reductions automatically).\nOne would reasonably expect this to work, but a `ValueError` is thrown on the last line:\n\n```\nsage: n = libgap.eval('Z(2^4)^2 + Z(2^4)^1 + Z(2^4)^0')\nsage: n\nZ(2^2)^2\nsage: n.sage(ring=GF(2^4))\nValueError: the given finite field has incompatible size\n```\n\nAssignee: ibookstein\n\nCC:  @vbraun\n\nBranch/Commit: 117599e0987414baec6169a1b7dd337b7e681b23\n\nReviewer: Dima Pasechnik\n\nAuthor: Itay Bookstein\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/23153\n\n",
    "closed_at": "2017-07-26T22:13:52Z",
    "created_at": "2017-06-06T22:19:15Z",
    "labels": [
        "component: group theory",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Bug in finite field element GAP-to-Sage conversion when explicit field is specified",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23153",
    "user": "https://github.com/dimpase"
}
```
As [reported](https://groups.google.com/d/msg/sage-devel/1VHx3laSU_U/wFxF2JsABwAJ) on sage-devel

```
S = GF(2^4, 'a')
a = S.gen()

G = SL(2, S)

g1 = G([a**2, a**3 + a**2 + a, a + 1, 0])
g2 = G([a, 0, 0, a**3 + 1])

# prints True True
print g1 in G, g2 in G

# Throws a ValueError
print g1 * g2
```
Specifically, one gets

```
ValueError: the given finite field has incompatible size
```

The actual underlying bug is the fact that the `GapElement_FiniteField.sage` method malfunctions when an explicit `ring` argument is specified and the element lies in a subfield of the field passed in that argument (note that GAP performs such reductions automatically).
One would reasonably expect this to work, but a `ValueError` is thrown on the last line:

```
sage: n = libgap.eval('Z(2^4)^2 + Z(2^4)^1 + Z(2^4)^0')
sage: n
Z(2^2)^2
sage: n.sage(ring=GF(2^4))
ValueError: the given finite field has incompatible size
```

Assignee: ibookstein

CC:  @vbraun

Branch/Commit: 117599e0987414baec6169a1b7dd337b7e681b23

Reviewer: Dima Pasechnik

Author: Itay Bookstein

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/23153





---

archive/issue_comments_341345.json:
```json
{
    "body": "<a id='comment:1'></a>namely\n\n```\n---> 13 print g1*g2\n\n/home/dima/Sage/sage-dev/src/sage/structure/sage_object.pyx in sage.structure.sage_object.SageObject.__repr__ (build/cythonized/sage/structure/sage_object.c:2712)()\n    190             return str(type(self))\n    191         else:\n--> 192             result = repr_func()\n    193             if isinstance(result, unicode):\n    194                 # Py3 compatibility: allow _repr_ to return unicode\n\n/home/dima/Sage/sage-dev/src/sage/groups/matrix_gps/group_element.pyx in sage.groups.matrix_gps.group_element.MatrixGroupElement_gap._repr_ (build/cythonized/sage/groups/matrix_gps/group_element.c:6700)()\n    490             '[1 1]\\n[0 1]'\n    491         \"\"\"\n--> 492         return str(self.matrix())\n    493 \n    494     def _latex_(self):\n\n/home/dima/Sage/sage-dev/src/sage/misc/cachefunc.pyx in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (build/cythonized/sage/misc/cachefunc.c:13462)()\n   2399         if self.cache is None:\n   2400             f = self.f\n-> 2401             self.cache = f(self._instance)\n   2402         return self.cache\n   2403 \n\n/home/dima/Sage/sage-dev/src/sage/groups/matrix_gps/group_element.pyx in sage.groups.matrix_gps.group_element.MatrixGroupElement_gap.matrix (build/cythonized/sage/groups/matrix_gps/group_element.c:7760)()\n    585         MS = self.parent().matrix_space()\n    586         ring = MS.base_ring()\n--> 587         m = MS([x.sage(ring=ring) for x in entries])\n    588         m.set_immutable()\n    589         return m\n\n/home/dima/Sage/sage-dev/src/sage/libs/gap/element.pyx in sage.libs.gap.element.GapElement_FiniteField.sage (build/cythonized/sage/libs/gap/element.c:12711)()\n   1386             field = self.DefaultField()\n   1387             if field.Size().sage() != ring.cardinality():\n-> 1388                 raise ValueError('the given finite field has incompatible size')\n   1389             root = self.DefaultField().PrimitiveRoot()\n   1390             exp = self.LogFFE(root)\n\nValueError: the given finite field has incompatible size\n```\nand in this case one has\n`field.Size().sage() = 4` and `ring.cardinality() = 16`",
    "created_at": "2017-06-06T22:27:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23153#issuecomment-341345",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:1'></a>namely

```
---> 13 print g1*g2

/home/dima/Sage/sage-dev/src/sage/structure/sage_object.pyx in sage.structure.sage_object.SageObject.__repr__ (build/cythonized/sage/structure/sage_object.c:2712)()
    190             return str(type(self))
    191         else:
--> 192             result = repr_func()
    193             if isinstance(result, unicode):
    194                 # Py3 compatibility: allow _repr_ to return unicode

/home/dima/Sage/sage-dev/src/sage/groups/matrix_gps/group_element.pyx in sage.groups.matrix_gps.group_element.MatrixGroupElement_gap._repr_ (build/cythonized/sage/groups/matrix_gps/group_element.c:6700)()
    490             '[1 1]\n[0 1]'
    491         """
--> 492         return str(self.matrix())
    493 
    494     def _latex_(self):

/home/dima/Sage/sage-dev/src/sage/misc/cachefunc.pyx in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (build/cythonized/sage/misc/cachefunc.c:13462)()
   2399         if self.cache is None:
   2400             f = self.f
-> 2401             self.cache = f(self._instance)
   2402         return self.cache
   2403 

/home/dima/Sage/sage-dev/src/sage/groups/matrix_gps/group_element.pyx in sage.groups.matrix_gps.group_element.MatrixGroupElement_gap.matrix (build/cythonized/sage/groups/matrix_gps/group_element.c:7760)()
    585         MS = self.parent().matrix_space()
    586         ring = MS.base_ring()
--> 587         m = MS([x.sage(ring=ring) for x in entries])
    588         m.set_immutable()
    589         return m

/home/dima/Sage/sage-dev/src/sage/libs/gap/element.pyx in sage.libs.gap.element.GapElement_FiniteField.sage (build/cythonized/sage/libs/gap/element.c:12711)()
   1386             field = self.DefaultField()
   1387             if field.Size().sage() != ring.cardinality():
-> 1388                 raise ValueError('the given finite field has incompatible size')
   1389             root = self.DefaultField().PrimitiveRoot()
   1390             exp = self.LogFFE(root)

ValueError: the given finite field has incompatible size
```
and in this case one has
`field.Size().sage() = 4` and `ring.cardinality() = 16`



---

archive/issue_comments_341346.json:
```json
{
    "body": "<a id='comment:2'></a>Indeed, different entries of a matrix might belong to different subfields of the field of definition; this test is simply wrong here (there is an element from the order 4 subfield in one of these matrices).",
    "created_at": "2017-06-06T22:42:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23153#issuecomment-341346",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:2'></a>Indeed, different entries of a matrix might belong to different subfields of the field of definition; this test is simply wrong here (there is an element from the order 4 subfield in one of these matrices).



---

archive/issue_comments_341347.json:
```json
{
    "body": "<a id='comment:3'></a>Amending this to reflect the real underlying bug: \nWhen an explicit ring (field) argument is specified to the GapElement_FiniteField.sage method, and the finite field element lies in a subfield of that field, the conversion as it currently works fails because GAP reduces the representation to that of the subfield.",
    "created_at": "2017-07-13T17:21:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23153#issuecomment-341347",
    "user": "https://trac.sagemath.org/admin/accounts/users/ibookstein"
}
```

<a id='comment:3'></a>Amending this to reflect the real underlying bug: 
When an explicit ring (field) argument is specified to the GapElement_FiniteField.sage method, and the finite field element lies in a subfield of that field, the conversion as it currently works fails because GAP reduces the representation to that of the subfield.



---

archive/issue_comments_341348.json:
```json
{
    "body": "Set assignee to ibookstein.",
    "created_at": "2017-07-13T18:42:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23153#issuecomment-341348",
    "user": "https://trac.sagemath.org/admin/accounts/users/ibookstein"
}
```

Set assignee to ibookstein.



---

archive/issue_comments_341349.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -21,6 +21,17 @@\n ValueError: the given finite field has incompatible size\n ```\n \n+The actual underlying bug is the fact that the `GapElement_FiniteField.sage` method malfunctions when an explicit `ring` argument is specified and the element lies in a subfield of the field passed in that argument (note that GAP performs such reductions automatically).\n+One would reasonably expect this to work, but a ValueError is thrown on the last line:\n+\n+```\n+sage: n = libgap.eval('Z(2^4)^2 + Z(2^4)^1 + Z(2^4)^0')\n+sage: n\n+Z(2^2)^2\n+sage: n.sage(ring=GF(2^4))\n+ValueError: the given finite field has incompatible size\n+```\n+\n Comment: 1\n \n Summary: bug in SL(2,GF(q)) multiplication\n``````\n",
    "created_at": "2017-07-13T18:42:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23153#issuecomment-341349",
    "user": "https://trac.sagemath.org/admin/accounts/users/ibookstein"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -21,6 +21,17 @@
 ValueError: the given finite field has incompatible size
 ```
 
+The actual underlying bug is the fact that the `GapElement_FiniteField.sage` method malfunctions when an explicit `ring` argument is specified and the element lies in a subfield of the field passed in that argument (note that GAP performs such reductions automatically).
+One would reasonably expect this to work, but a ValueError is thrown on the last line:
+
+```
+sage: n = libgap.eval('Z(2^4)^2 + Z(2^4)^1 + Z(2^4)^0')
+sage: n
+Z(2^2)^2
+sage: n.sage(ring=GF(2^4))
+ValueError: the given finite field has incompatible size
+```
+
 Comment: 1
 
 Summary: bug in SL(2,GF(q)) multiplication
``````




---

archive/issue_comments_341350.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,36 @@\n+As [reported](https://groups.google.com/d/msg/sage-devel/1VHx3laSU_U/wFxF2JsABwAJ) on sage-devel\n \n+```\n+S = GF(2^4, 'a')\n+a = S.gen()\n+\n+G = SL(2, S)\n+\n+g1 = G([a**2, a**3 + a**2 + a, a + 1, 0])\n+g2 = G([a, 0, 0, a**3 + 1])\n+\n+# prints True True\n+print g1 in G, g2 in G\n+\n+# Throws a ValueError\n+print g1 * g2\n+```\n+Specifically, one gets\n+\n+```\n+ValueError: the given finite field has incompatible size\n+```\n+\n+The actual underlying bug is the fact that the `GapElement_FiniteField.sage` method malfunctions when an explicit `ring` argument is specified and the element lies in a subfield of the field passed in that argument (note that GAP performs such reductions automatically).\n+One would reasonably expect this to work, but a `ValueError` is thrown on the last line:\n+\n+```\n+sage: n = libgap.eval('Z(2^4)^2 + Z(2^4)^1 + Z(2^4)^0')\n+sage: n\n+Z(2^2)^2\n+sage: n.sage(ring=GF(2^4))\n+ValueError: the given finite field has incompatible size\n+```\n \n Comment: 1\n \n``````\n",
    "created_at": "2017-07-13T18:45:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23153#issuecomment-341350",
    "user": "https://trac.sagemath.org/admin/accounts/users/ibookstein"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,36 @@
+As [reported](https://groups.google.com/d/msg/sage-devel/1VHx3laSU_U/wFxF2JsABwAJ) on sage-devel
 
+```
+S = GF(2^4, 'a')
+a = S.gen()
+
+G = SL(2, S)
+
+g1 = G([a**2, a**3 + a**2 + a, a + 1, 0])
+g2 = G([a, 0, 0, a**3 + 1])
+
+# prints True True
+print g1 in G, g2 in G
+
+# Throws a ValueError
+print g1 * g2
+```
+Specifically, one gets
+
+```
+ValueError: the given finite field has incompatible size
+```
+
+The actual underlying bug is the fact that the `GapElement_FiniteField.sage` method malfunctions when an explicit `ring` argument is specified and the element lies in a subfield of the field passed in that argument (note that GAP performs such reductions automatically).
+One would reasonably expect this to work, but a `ValueError` is thrown on the last line:
+
+```
+sage: n = libgap.eval('Z(2^4)^2 + Z(2^4)^1 + Z(2^4)^0')
+sage: n
+Z(2^2)^2
+sage: n.sage(ring=GF(2^4))
+ValueError: the given finite field has incompatible size
+```
 
 Comment: 1
 
``````




---

archive/issue_comments_341351.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-13T19:30:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23153#issuecomment-341351",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_341352.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-13T19:36:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23153#issuecomment-341352",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_341353.json:
```json
{
    "body": "<a id='comment:9'></a>This fix looks as if it might lead to a huge slowdown.\nWould it be possible to avoid this test and creation of a field completely?",
    "created_at": "2017-07-14T07:34:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23153#issuecomment-341353",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:9'></a>This fix looks as if it might lead to a huge slowdown.
Would it be possible to avoid this test and creation of a field completely?



---

archive/issue_comments_341354.json:
```json
{
    "body": "<a id='comment:10'></a>I also do not understand how libGAP handles finite fields obtained by specifying an explicit irreducible polynomial, e.g.\n\n```\ngap> poly:=RandomPrimitivePolynomial(GF(2),20);\nx_1^20+x_1^17+x_1^16+x_1^12+x_1^9+x_1^6+Z(2)^0\ngap> f220:=GF(GF(2),poly);\n<algebra-with-one of dimension 20 over GF(2)>\n```",
    "created_at": "2017-07-14T08:17:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23153#issuecomment-341354",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:10'></a>I also do not understand how libGAP handles finite fields obtained by specifying an explicit irreducible polynomial, e.g.

```
gap> poly:=RandomPrimitivePolynomial(GF(2),20);
x_1^20+x_1^17+x_1^16+x_1^12+x_1^9+x_1^6+Z(2)^0
gap> f220:=GF(GF(2),poly);
<algebra-with-one of dimension 20 over GF(2)>
```



---

archive/issue_comments_341355.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-14T12:27:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23153#issuecomment-341355",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_341356.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,38 @@\n+Authors: Itay Bookstein\n \n+As [reported](https://groups.google.com/d/msg/sage-devel/1VHx3laSU_U/wFxF2JsABwAJ) on sage-devel\n+\n+```\n+S = GF(2^4, 'a')\n+a = S.gen()\n+\n+G = SL(2, S)\n+\n+g1 = G([a**2, a**3 + a**2 + a, a + 1, 0])\n+g2 = G([a, 0, 0, a**3 + 1])\n+\n+# prints True True\n+print g1 in G, g2 in G\n+\n+# Throws a ValueError\n+print g1 * g2\n+```\n+Specifically, one gets\n+\n+```\n+ValueError: the given finite field has incompatible size\n+```\n+\n+The actual underlying bug is the fact that the `GapElement_FiniteField.sage` method malfunctions when an explicit `ring` argument is specified and the element lies in a subfield of the field passed in that argument (note that GAP performs such reductions automatically).\n+One would reasonably expect this to work, but a `ValueError` is thrown on the last line:\n+\n+```\n+sage: n = libgap.eval('Z(2^4)^2 + Z(2^4)^1 + Z(2^4)^0')\n+sage: n\n+Z(2^2)^2\n+sage: n.sage(ring=GF(2^4))\n+ValueError: the given finite field has incompatible size\n+```\n \n Comment: 1\n \n``````\n",
    "created_at": "2017-07-14T12:29:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23153#issuecomment-341356",
    "user": "https://trac.sagemath.org/admin/accounts/users/ibookstein"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,38 @@
+Authors: Itay Bookstein
 
+As [reported](https://groups.google.com/d/msg/sage-devel/1VHx3laSU_U/wFxF2JsABwAJ) on sage-devel
+
+```
+S = GF(2^4, 'a')
+a = S.gen()
+
+G = SL(2, S)
+
+g1 = G([a**2, a**3 + a**2 + a, a + 1, 0])
+g2 = G([a, 0, 0, a**3 + 1])
+
+# prints True True
+print g1 in G, g2 in G
+
+# Throws a ValueError
+print g1 * g2
+```
+Specifically, one gets
+
+```
+ValueError: the given finite field has incompatible size
+```
+
+The actual underlying bug is the fact that the `GapElement_FiniteField.sage` method malfunctions when an explicit `ring` argument is specified and the element lies in a subfield of the field passed in that argument (note that GAP performs such reductions automatically).
+One would reasonably expect this to work, but a `ValueError` is thrown on the last line:
+
+```
+sage: n = libgap.eval('Z(2^4)^2 + Z(2^4)^1 + Z(2^4)^0')
+sage: n
+Z(2^2)^2
+sage: n.sage(ring=GF(2^4))
+ValueError: the given finite field has incompatible size
+```
 
 Comment: 1
 
``````




---

archive/issue_comments_341357.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-07-14T12:29:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23153#issuecomment-341357",
    "user": "https://trac.sagemath.org/admin/accounts/users/ibookstein"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_341358.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,36 @@\n+As [reported](https://groups.google.com/d/msg/sage-devel/1VHx3laSU_U/wFxF2JsABwAJ) on sage-devel\n \n+```\n+S = GF(2^4, 'a')\n+a = S.gen()\n+\n+G = SL(2, S)\n+\n+g1 = G([a**2, a**3 + a**2 + a, a + 1, 0])\n+g2 = G([a, 0, 0, a**3 + 1])\n+\n+# prints True True\n+print g1 in G, g2 in G\n+\n+# Throws a ValueError\n+print g1 * g2\n+```\n+Specifically, one gets\n+\n+```\n+ValueError: the given finite field has incompatible size\n+```\n+\n+The actual underlying bug is the fact that the `GapElement_FiniteField.sage` method malfunctions when an explicit `ring` argument is specified and the element lies in a subfield of the field passed in that argument (note that GAP performs such reductions automatically).\n+One would reasonably expect this to work, but a `ValueError` is thrown on the last line:\n+\n+```\n+sage: n = libgap.eval('Z(2^4)^2 + Z(2^4)^1 + Z(2^4)^0')\n+sage: n\n+Z(2^2)^2\n+sage: n.sage(ring=GF(2^4))\n+ValueError: the given finite field has incompatible size\n+```\n \n Comment: 1\n \n``````\n",
    "created_at": "2017-07-14T12:32:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23153#issuecomment-341358",
    "user": "https://trac.sagemath.org/admin/accounts/users/ibookstein"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,36 @@
+As [reported](https://groups.google.com/d/msg/sage-devel/1VHx3laSU_U/wFxF2JsABwAJ) on sage-devel
 
+```
+S = GF(2^4, 'a')
+a = S.gen()
+
+G = SL(2, S)
+
+g1 = G([a**2, a**3 + a**2 + a, a + 1, 0])
+g2 = G([a, 0, 0, a**3 + 1])
+
+# prints True True
+print g1 in G, g2 in G
+
+# Throws a ValueError
+print g1 * g2
+```
+Specifically, one gets
+
+```
+ValueError: the given finite field has incompatible size
+```
+
+The actual underlying bug is the fact that the `GapElement_FiniteField.sage` method malfunctions when an explicit `ring` argument is specified and the element lies in a subfield of the field passed in that argument (note that GAP performs such reductions automatically).
+One would reasonably expect this to work, but a `ValueError` is thrown on the last line:
+
+```
+sage: n = libgap.eval('Z(2^4)^2 + Z(2^4)^1 + Z(2^4)^0')
+sage: n
+Z(2^2)^2
+sage: n.sage(ring=GF(2^4))
+ValueError: the given finite field has incompatible size
+```
 
 Comment: 1
 
``````




---

archive/issue_comments_341359.json:
```json
{
    "body": "<a id='comment:14'></a>Sorry, missed your comments before I wrapped it all up and submitted it for review, assumed such comments would be part of the review.\n\n* Should I revert the ticket's status?\n* Regarding the slowdown resulting from the test and creation of a field: \n  * What test are you referring to? The modulus?\n  * I'm not sure what to replace the field creation with and what's considered cheap/expensive in Sage/GAP. What would you recommend? We could cut straight to the `PrimitiveRoot` for example by using GAP's `Z(...)` and plugging in the desired field's size, but I know nothing about GAP's implementation details and whether it creates the parent field anyway.\n* Regarding the finite fields with non-default (non-Conway) modulus polynomial:\n  * I actually looked into this as a separate issue/bug as part of researching a fix for this ticket, but I haven't submitted anything yet.\n  * The `_gap_init_()` string for Sage fields completely ignores the modulus polynomial - the conversion is lossy, and you get `F.<x> = GF(2)['x']; libgap(GF(2^18, 'x')) == libgap(GF(2^18, 'x', modulus=x**18 + x**16 + x**11 + x**4 + 1))` printing `True`",
    "created_at": "2017-07-14T12:56:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23153#issuecomment-341359",
    "user": "https://trac.sagemath.org/admin/accounts/users/ibookstein"
}
```

<a id='comment:14'></a>Sorry, missed your comments before I wrapped it all up and submitted it for review, assumed such comments would be part of the review.

* Should I revert the ticket's status?
* Regarding the slowdown resulting from the test and creation of a field: 
  * What test are you referring to? The modulus?
  * I'm not sure what to replace the field creation with and what's considered cheap/expensive in Sage/GAP. What would you recommend? We could cut straight to the `PrimitiveRoot` for example by using GAP's `Z(...)` and plugging in the desired field's size, but I know nothing about GAP's implementation details and whether it creates the parent field anyway.
* Regarding the finite fields with non-default (non-Conway) modulus polynomial:
  * I actually looked into this as a separate issue/bug as part of researching a fix for this ticket, but I haven't submitted anything yet.
  * The `_gap_init_()` string for Sage fields completely ignores the modulus polynomial - the conversion is lossy, and you get `F.<x> = GF(2)['x']; libgap(GF(2^18, 'x')) == libgap(GF(2^18, 'x', modulus=x**18 + x**16 + x**11 + x**4 + 1))` printing `True`



---

archive/issue_comments_341360.json:
```json
{
    "body": "<a id='comment:15'></a>A comment about your code; you create a lot of temporary variables without a reason; one does not need `compatible`, `gap_field_obj`, and `gap_field`, right?\nCould you get rid of them?\n\nOtherwise, your patch looks good; I now realise that because we deal with only \"standard\" finite fields here, for them `PrimitiveRoot` is instant.\n(this would not be true for extensions specified by arbitrary primitive polynomials).\n\nRegarding the latter (finite fields with non-default (non-Conway) modulus polynomial); so you think they are not handled in libGAP? If so, could you please open a ticket to deal with this?",
    "created_at": "2017-07-14T15:07:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23153#issuecomment-341360",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:15'></a>A comment about your code; you create a lot of temporary variables without a reason; one does not need `compatible`, `gap_field_obj`, and `gap_field`, right?
Could you get rid of them?

Otherwise, your patch looks good; I now realise that because we deal with only "standard" finite fields here, for them `PrimitiveRoot` is instant.
(this would not be true for extensions specified by arbitrary primitive polynomials).

Regarding the latter (finite fields with non-default (non-Conway) modulus polynomial); so you think they are not handled in libGAP? If so, could you please open a ticket to deal with this?



---

archive/issue_comments_341361.json:
```json
{
    "body": "<a id='comment:16'></a>No problem getting rid of them, just thought they make the code more readable (are these temporaries a performance concern?).\nI mean, in principal one could inline the entire second `else` clause to a huge one-liner, but that would be rather unreadable :)\n\nI was under the impression that the field creation within GAP might be performance issue, not the `PrimitiveRoot` lookup (which, by the way, was there before the patch).\nWe could also cut straight to `root = make_GapElement_FiniteField(self.parent(), gap_eval(ring.multiplicative_generator()._gap_init_()))`, but it may be worse.\n\nRegarding the finite fields with non-default (non-Conway) modulus polynomials, see `src/sage/rings/finite_rings/finite_field_base.pyx`, method `FiniteField._gap_init_`.\nAdding such support would be lengthier, as we may need to audit all Sage-finite-field-to-GAP-finite-field bridges and make sure they make no assumptions about the modulus being non-default, e.g. `src/sage/rings/finite_rings/element_ntl_gf2e.pyx` method `FiniteField_ntl_gf2eElement._gap_init_` (where it is *explicitly blocked*).",
    "created_at": "2017-07-14T15:48:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23153#issuecomment-341361",
    "user": "https://trac.sagemath.org/admin/accounts/users/ibookstein"
}
```

<a id='comment:16'></a>No problem getting rid of them, just thought they make the code more readable (are these temporaries a performance concern?).
I mean, in principal one could inline the entire second `else` clause to a huge one-liner, but that would be rather unreadable :)

I was under the impression that the field creation within GAP might be performance issue, not the `PrimitiveRoot` lookup (which, by the way, was there before the patch).
We could also cut straight to `root = make_GapElement_FiniteField(self.parent(), gap_eval(ring.multiplicative_generator()._gap_init_()))`, but it may be worse.

Regarding the finite fields with non-default (non-Conway) modulus polynomials, see `src/sage/rings/finite_rings/finite_field_base.pyx`, method `FiniteField._gap_init_`.
Adding such support would be lengthier, as we may need to audit all Sage-finite-field-to-GAP-finite-field bridges and make sure they make no assumptions about the modulus being non-default, e.g. `src/sage/rings/finite_rings/element_ntl_gf2e.pyx` method `FiniteField_ntl_gf2eElement._gap_init_` (where it is *explicitly blocked*).



---

archive/issue_comments_341362.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-14T16:13:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23153#issuecomment-341362",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_341363.json:
```json
{
    "body": "<a id='comment:18'></a>OK, this looks good enough. \n\nRegarding the non-Conway irreducible polynomials for GFs, I have opened #23452.",
    "created_at": "2017-07-18T07:01:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23153#issuecomment-341363",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:18'></a>OK, this looks good enough. 

Regarding the non-Conway irreducible polynomials for GFs, I have opened #23452.



---

archive/issue_comments_341364.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-07-18T07:01:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23153#issuecomment-341364",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_341365.json:
```json
{
    "body": "<a id='comment:19'></a>Should we also open tickets about the following two enhancements?\n* Adding support for GAP fields whose size is larger than `2^16` in both conversion directions? I actually tried hacking in a GAP-to-Sage conversion for this case (under `make_any_gap_element`'s `libGAP_T_POSOBJ` case if `result.IsFFE()` is true) and found out that the current GAP-to-sage conversion after my editing is extremely slow because of the `LogFFE` call (it's slow when GAP doesn't use the efficient internal representation, which happens precisely when the size is over `2^16`).\n* Adding support for algebraic extensions of non-prime fields via GAP's functionality? Maybe that's a bit much, I don't know.",
    "created_at": "2017-07-18T15:52:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23153#issuecomment-341365",
    "user": "https://trac.sagemath.org/admin/accounts/users/ibookstein"
}
```

<a id='comment:19'></a>Should we also open tickets about the following two enhancements?
* Adding support for GAP fields whose size is larger than `2^16` in both conversion directions? I actually tried hacking in a GAP-to-Sage conversion for this case (under `make_any_gap_element`'s `libGAP_T_POSOBJ` case if `result.IsFFE()` is true) and found out that the current GAP-to-sage conversion after my editing is extremely slow because of the `LogFFE` call (it's slow when GAP doesn't use the efficient internal representation, which happens precisely when the size is over `2^16`).
* Adding support for algebraic extensions of non-prime fields via GAP's functionality? Maybe that's a bit much, I don't know.



---

archive/issue_comments_341366.json:
```json
{
    "body": "<a id='comment:20'></a>IMHO Sage's support for GF(q) with large q is much better than in GAP - in particular for q=2<sup>k</sup>, where `gf2x` is used.\n\nAnyhow, why does one even need to call `LogFFE()`? Both GAP and Sage represent finite field elements as polynomials in the primitive element, can't one just rewrite these polynomials?",
    "created_at": "2017-07-19T08:03:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23153#issuecomment-341366",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:20'></a>IMHO Sage's support for GF(q) with large q is much better than in GAP - in particular for q=2<sup>k</sup>, where `gf2x` is used.

Anyhow, why does one even need to call `LogFFE()`? Both GAP and Sage represent finite field elements as polynomials in the primitive element, can't one just rewrite these polynomials?



---

archive/issue_comments_341367.json:
```json
{
    "body": "<a id='comment:21'></a>Regarding the `GF(p^n)` support - yes, but when I want to use a matrix group over a large field (`SL(2, 2^32)`, for instance, I'm completely unable to do that within Sage because Sage uses GAP for matrix group implementations and the Sage-GAP bridge doesn't support large fields.\nPerhaps this warrants abandoning GAP's matrix group implementations and having Sage implementations, I don't know.\n\nRegarding the `LogFFE()` call - I was wondering about that myself. Doing the conversion based on the polynomial representation should be pretty simple to implement. I guess the exponentiation implementation was easier and shorter to implement (see `src/sage/rings/finite_rings/element_givaro.pyx`, method `FiniteField_givaroElement._gap_init_` for example, where to do the conversion you just format the field's size and the exponent into a string).",
    "created_at": "2017-07-19T16:12:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23153#issuecomment-341367",
    "user": "https://trac.sagemath.org/admin/accounts/users/ibookstein"
}
```

<a id='comment:21'></a>Regarding the `GF(p^n)` support - yes, but when I want to use a matrix group over a large field (`SL(2, 2^32)`, for instance, I'm completely unable to do that within Sage because Sage uses GAP for matrix group implementations and the Sage-GAP bridge doesn't support large fields.
Perhaps this warrants abandoning GAP's matrix group implementations and having Sage implementations, I don't know.

Regarding the `LogFFE()` call - I was wondering about that myself. Doing the conversion based on the polynomial representation should be pretty simple to implement. I guess the exponentiation implementation was easier and shorter to implement (see `src/sage/rings/finite_rings/element_givaro.pyx`, method `FiniteField_givaroElement._gap_init_` for example, where to do the conversion you just format the field's size and the exponent into a string).



---

archive/issue_comments_341368.json:
```json
{
    "body": "<a id='comment:22'></a>Unless I miss something, for sufficiently big q GF(q) in Sage is implemented using NTL.",
    "created_at": "2017-07-19T16:47:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23153#issuecomment-341368",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:22'></a>Unless I miss something, for sufficiently big q GF(q) in Sage is implemented using NTL.



---

archive/issue_comments_341369.json:
```json
{
    "body": "<a id='comment:23'></a>They are, but once you try doing things in e.g. `SL(2, F)` the field elements are coerced back and forth (GAP-to-NTL and vice versa):\n\n```\nsage: G = SL(2, 2**24)\nsage: G.generators()\n...\nTypeError: sage() takes no keyword arguments\n```\n\nThis is because the objects being coerced are deduced as generic `GapElement`s instead of FFEs.\nPerhaps I should move this discussion to sage-devel.",
    "created_at": "2017-07-19T17:16:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23153#issuecomment-341369",
    "user": "https://trac.sagemath.org/admin/accounts/users/ibookstein"
}
```

<a id='comment:23'></a>They are, but once you try doing things in e.g. `SL(2, F)` the field elements are coerced back and forth (GAP-to-NTL and vice versa):

```
sage: G = SL(2, 2**24)
sage: G.generators()
...
TypeError: sage() takes no keyword arguments
```

This is because the objects being coerced are deduced as generic `GapElement`s instead of FFEs.
Perhaps I should move this discussion to sage-devel.



---

archive/issue_comments_341370.json:
```json
{
    "body": "<a id='comment:24'></a>I'm not very well acquainted with the development cycle (and didn't see anything about it on the developer guide), am I supposed to merge it to develop or is that on one of the admins?",
    "created_at": "2017-07-23T19:20:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23153#issuecomment-341370",
    "user": "https://trac.sagemath.org/admin/accounts/users/ibookstein"
}
```

<a id='comment:24'></a>I'm not very well acquainted with the development cycle (and didn't see anything about it on the developer guide), am I supposed to merge it to develop or is that on one of the admins?



---

archive/issue_events_059833.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2017-07-23T19:34:37Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23153",
    "milestone": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23153#event-59833"
}
```



---

archive/issue_comments_341371.json:
```json
{
    "body": "<a id='comment:25'></a>Replying to [comment:24 ibookstein]:\n> I'm not very well acquainted with the development cycle (and didn't see anything about it on the developer guide), am I supposed to merge it to develop or is that on one of the admins?\n\n\nthe rest is normally done by the release manager, no need to do anything at this point on your side.",
    "created_at": "2017-07-23T19:34:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23153#issuecomment-341371",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:25'></a>Replying to [comment:24 ibookstein]:
> I'm not very well acquainted with the development cycle (and didn't see anything about it on the developer guide), am I supposed to merge it to develop or is that on one of the admins?


the rest is normally done by the release manager, no need to do anything at this point on your side.



---

archive/issue_comments_341372.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-07-26T22:13:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23153#issuecomment-341372",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_059834.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-07-26T22:13:52Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23153",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23153#event-59834"
}
```
