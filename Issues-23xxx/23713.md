# Issue 23713: Support SAGE_NUM_THREADS everywhere for parallellism

archive/issues_023476.json:
```json
{
    "body": "There are several independent implementations in Sage to determine the number of threads or processors for a parallel computation. Instead, these should be one way to do that and it should support the environment variable `SAGE_NUM_THREADS`, which is precisely meant for that.\n\nOn top of that, doctests should never use too many threads. So we set `SAGE_NUM_THREADS=2` while doctesting, analogous to #23892.\n\nThis fixes doctests in:\n- parallel map/reduce\n- cryptominisat\n- cbc package: coin backend for MILP\n\nCC:  @hivert\n\nReviewer: Florent Hivert\n\nAuthor: Jeroen Demeyer\n\nBranch: f5e5765874b291d48bf4d8fede927befbddddfb7\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/23713\n\n",
    "closed_at": "2017-10-15T11:45:12Z",
    "created_at": "2017-08-25T13:56:18Z",
    "labels": [
        "component: doctest framework",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Support SAGE_NUM_THREADS everywhere for parallellism",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23713",
    "user": "https://github.com/jdemeyer"
}
```
There are several independent implementations in Sage to determine the number of threads or processors for a parallel computation. Instead, these should be one way to do that and it should support the environment variable `SAGE_NUM_THREADS`, which is precisely meant for that.

On top of that, doctests should never use too many threads. So we set `SAGE_NUM_THREADS=2` while doctesting, analogous to #23892.

This fixes doctests in:
- parallel map/reduce
- cryptominisat
- cbc package: coin backend for MILP

CC:  @hivert

Reviewer: Florent Hivert

Author: Jeroen Demeyer

Branch: f5e5765874b291d48bf4d8fede927befbddddfb7

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/23713





---

archive/issue_comments_449779.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-The number of files that the parallel map/reduce doctests requires is `O(N)` where `N` is the number of processors, while the number of open files allowed is typically `O(1)`. So, on a machine with 192 processors:\n+The number of files that the parallel map/reduce doctests requires is `O(N)` where `N` is the number of processors, while the number of open files allowed is typically fixed. So, on a machine with 192 processors:\n \n ```\n sage -t --long --warn-long 91.0 src/sage/parallel/map_reduce.py\n@@ -36,4 +36,4 @@\n **********************************************************************\n ```\n \n-A simple solution would be to restrict the number of processors while doctesting.\n+Apart from this, this doctest should not start too much processes. I suggest to set the *default* number of processors to the environment variable `SAGE_NUM_THREADS_PARALLEL`, which is precisely meant for that purpose.\n``````\n",
    "created_at": "2017-09-04T11:51:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23713#issuecomment-449779",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-The number of files that the parallel map/reduce doctests requires is `O(N)` where `N` is the number of processors, while the number of open files allowed is typically `O(1)`. So, on a machine with 192 processors:
+The number of files that the parallel map/reduce doctests requires is `O(N)` where `N` is the number of processors, while the number of open files allowed is typically fixed. So, on a machine with 192 processors:
 
 ```
 sage -t --long --warn-long 91.0 src/sage/parallel/map_reduce.py
@@ -36,4 +36,4 @@
 **********************************************************************
 ```
 
-A simple solution would be to restrict the number of processors while doctesting.
+Apart from this, this doctest should not start too much processes. I suggest to set the *default* number of processors to the environment variable `SAGE_NUM_THREADS_PARALLEL`, which is precisely meant for that purpose.
``````




---

archive/issue_events_068893.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/23713",
    "rename": {
        "from": "Parallel map/reduce doctests fail on machine with lots of CPUs",
        "to": "Support SAGE_NUM_THREADS_PARALLEL in parallel map/reduce"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23713#event-68893"
}
```



---

archive/issue_comments_449780.json:
```json
{
    "body": "Changing branch from \"\" to \"u/jdemeyer/support_sage_num_threads_parallel_in_parallel_map_reduce\"",
    "created_at": "2017-09-04T12:05:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23713#issuecomment-449780",
    "user": "https://github.com/jdemeyer"
}
```

Changing branch from "" to "u/jdemeyer/support_sage_num_threads_parallel_in_parallel_map_reduce"



---

archive/issue_comments_449781.json:
```json
{
    "body": "Changing commit from \"\" to \"282c95423512fe2c14481ab83ab29cfa4c64061f\"",
    "created_at": "2017-09-04T12:05:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23713#issuecomment-449781",
    "user": "https://github.com/jdemeyer"
}
```

Changing commit from "" to "282c95423512fe2c14481ab83ab29cfa4c64061f"



---

archive/issue_comments_449782.json:
```json
{
    "body": "<a id='comment:3'></a>\nNew commits:\n|                                                                                                                                          |                                                          |\n|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------|\n|[282c954](https://github.com/sagemath/sagetrac-mirror/commit/282c95423512fe2c14481ab83ab29cfa4c64061f)|`Support SAGE_NUM_THREADS_PARALLEL in parallel map/reduce`|",
    "created_at": "2017-09-04T12:05:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23713#issuecomment-449782",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>
New commits:
|                                                                                                                                          |                                                          |
|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------|
|[282c954](https://github.com/sagemath/sagetrac-mirror/commit/282c95423512fe2c14481ab83ab29cfa4c64061f)|`Support SAGE_NUM_THREADS_PARALLEL in parallel map/reduce`|



---

archive/issue_comments_449783.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-09-04T12:05:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23713#issuecomment-449783",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_events_068894.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/23713",
    "rename": {
        "from": "Support SAGE_NUM_THREADS_PARALLEL in parallel map/reduce",
        "to": "Support SAGE_NUM_THREADS for parallellism"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23713#event-68894"
}
```



---

archive/issue_comments_449784.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,39 +1,8 @@\n-The number of files that the parallel map/reduce doctests requires is `O(N)` where `N` is the number of processors, while the number of open files allowed is typically fixed. So, on a machine with 192 processors:\n+There are several independent implementations in Sage to determine the number of threads or processors for a parallel computation. Instead, these should be one way to do that and it should support the environment variable `SAGE_NUM_THREADS`, which is precisely meant for that.\n \n-```\n-sage -t --long --warn-long 91.0 src/sage/parallel/map_reduce.py\n-**********************************************************************\n-File \"src/sage/parallel/map_reduce.py\", line 228, in sage.parallel.map_reduce\n-Failed example:\n-    try:\n-        res = EX.run(timeout=60)\n-    except AbortError:\n-        print(\"Computation Timeout\")\n-    else:\n-        print(\"Computation normally finished\")\n-        res\n-Exception raised:\n-    Traceback (most recent call last):\n-      File \"/home/jdemeyer/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 515, in _run\n-        self.compile_and_execute(example, compiler, test.globs)\n-      File \"/home/jdemeyer/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 885, in compile_and_execute\n-        exec(compiled, globs)\n-      File \"<doctest sage.parallel.map_reduce[33]>\", line 2, in <module>\n-        res = EX.run(timeout=Integer(60))\n-      File \"/home/jdemeyer/sage-patchbot/local/lib/python2.7/site-packages/sage/parallel/map_reduce.py\", line 1394, in run\n-        self.setup_workers(max_proc, reduce_locally)\n-      File \"/home/jdemeyer/sage-patchbot/local/lib/python2.7/site-packages/sage/parallel/map_reduce.py\", line 1070, in setup_workers\n-        for i in range(self._nprocess)]\n-      File \"/home/jdemeyer/sage-patchbot/local/lib/python2.7/site-packages/sage/parallel/map_reduce.py\", line 1513, in __init__\n-        self._request = SimpleQueue()  # Faster than Queue\n-      File \"/home/jdemeyer/sage-patchbot/local/lib/python2.7/multiprocessing/queues.py\", line 353, in __init__\n-        self._reader, self._writer = Pipe(duplex=False)\n-      File \"/home/jdemeyer/sage-patchbot/local/lib/python2.7/multiprocessing/__init__.py\", line 107, in Pipe\n-        return Pipe(duplex)\n-      File \"/home/jdemeyer/sage-patchbot/local/lib/python2.7/multiprocessing/connection.py\", line 196, in Pipe\n-        fd1, fd2 = os.pipe()\n-    OSError: [Errno 24] Too many open files\n-**********************************************************************\n-```\n+On top of that, doctests should never use too many threads. So we set `SAGE_NUM_THREADS=2` while doctesting, analogous to #23892.\n \n-Apart from this, this doctest should not start too much processes. I suggest to set the *default* number of processors to the environment variable `SAGE_NUM_THREADS_PARALLEL`, which is precisely meant for that purpose.\n+This fixes doctests in:\n+- parallel map/reduce\n+- `cbc`\n+- `cryptominisat`\n``````\n",
    "created_at": "2017-10-05T10:17:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23713#issuecomment-449784",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,39 +1,8 @@
-The number of files that the parallel map/reduce doctests requires is `O(N)` where `N` is the number of processors, while the number of open files allowed is typically fixed. So, on a machine with 192 processors:
+There are several independent implementations in Sage to determine the number of threads or processors for a parallel computation. Instead, these should be one way to do that and it should support the environment variable `SAGE_NUM_THREADS`, which is precisely meant for that.
 
-```
-sage -t --long --warn-long 91.0 src/sage/parallel/map_reduce.py
-**********************************************************************
-File "src/sage/parallel/map_reduce.py", line 228, in sage.parallel.map_reduce
-Failed example:
-    try:
-        res = EX.run(timeout=60)
-    except AbortError:
-        print("Computation Timeout")
-    else:
-        print("Computation normally finished")
-        res
-Exception raised:
-    Traceback (most recent call last):
-      File "/home/jdemeyer/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
-        self.compile_and_execute(example, compiler, test.globs)
-      File "/home/jdemeyer/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
-        exec(compiled, globs)
-      File "<doctest sage.parallel.map_reduce[33]>", line 2, in <module>
-        res = EX.run(timeout=Integer(60))
-      File "/home/jdemeyer/sage-patchbot/local/lib/python2.7/site-packages/sage/parallel/map_reduce.py", line 1394, in run
-        self.setup_workers(max_proc, reduce_locally)
-      File "/home/jdemeyer/sage-patchbot/local/lib/python2.7/site-packages/sage/parallel/map_reduce.py", line 1070, in setup_workers
-        for i in range(self._nprocess)]
-      File "/home/jdemeyer/sage-patchbot/local/lib/python2.7/site-packages/sage/parallel/map_reduce.py", line 1513, in __init__
-        self._request = SimpleQueue()  # Faster than Queue
-      File "/home/jdemeyer/sage-patchbot/local/lib/python2.7/multiprocessing/queues.py", line 353, in __init__
-        self._reader, self._writer = Pipe(duplex=False)
-      File "/home/jdemeyer/sage-patchbot/local/lib/python2.7/multiprocessing/__init__.py", line 107, in Pipe
-        return Pipe(duplex)
-      File "/home/jdemeyer/sage-patchbot/local/lib/python2.7/multiprocessing/connection.py", line 196, in Pipe
-        fd1, fd2 = os.pipe()
-    OSError: [Errno 24] Too many open files
-**********************************************************************
-```
+On top of that, doctests should never use too many threads. So we set `SAGE_NUM_THREADS=2` while doctesting, analogous to #23892.
 
-Apart from this, this doctest should not start too much processes. I suggest to set the *default* number of processors to the environment variable `SAGE_NUM_THREADS_PARALLEL`, which is precisely meant for that purpose.
+This fixes doctests in:
+- parallel map/reduce
+- `cbc`
+- `cryptominisat`
``````




---

archive/issue_comments_449785.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-10-05T10:17:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23713#issuecomment-449785",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_449786.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -4,5 +4,4 @@\n \n This fixes doctests in:\n - parallel map/reduce\n-- `cbc`\n-- `cryptominisat`\n+- cryptominisat\n``````\n",
    "created_at": "2017-10-05T10:18:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23713#issuecomment-449786",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -4,5 +4,4 @@
 
 This fixes doctests in:
 - parallel map/reduce
-- `cbc`
-- `cryptominisat`
+- cryptominisat
``````




---

archive/issue_comments_449787.json:
```json
{
    "body": "Changing commit from \"282c95423512fe2c14481ab83ab29cfa4c64061f\" to \"f5e5765874b291d48bf4d8fede927befbddddfb7\"",
    "created_at": "2017-10-05T10:32:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23713#issuecomment-449787",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "282c95423512fe2c14481ab83ab29cfa4c64061f" to "f5e5765874b291d48bf4d8fede927befbddddfb7"



---

archive/issue_comments_449788.json:
```json
{
    "body": "<a id='comment:6'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                           |                                               |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------|\n|[f5e5765](https://github.com/sagemath/sagetrac-mirror/commit/f5e5765874b291d48bf4d8fede927befbddddfb7)|`Support SAGE_NUM_THREADS for all parallellism`|",
    "created_at": "2017-10-05T10:32:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23713#issuecomment-449788",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                           |                                               |
|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------|
|[f5e5765](https://github.com/sagemath/sagetrac-mirror/commit/f5e5765874b291d48bf4d8fede927befbddddfb7)|`Support SAGE_NUM_THREADS for all parallellism`|



---

archive/issue_comments_449789.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -5,3 +5,4 @@\n This fixes doctests in:\n - parallel map/reduce\n - cryptominisat\n+- cbc package: coin backend for MILP\n``````\n",
    "created_at": "2017-10-05T10:33:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23713#issuecomment-449789",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -5,3 +5,4 @@
 This fixes doctests in:
 - parallel map/reduce
 - cryptominisat
+- cbc package: coin backend for MILP
``````




---

archive/issue_events_068895.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/23713",
    "rename": {
        "from": "Support SAGE_NUM_THREADS for parallellism",
        "to": "Support SAGE_NUM_THREADS everywhere for parallellism"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23713#event-68895"
}
```



---

archive/issue_comments_449790.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-10-05T11:08:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23713#issuecomment-449790",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_449791.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Florent Hivert\"",
    "created_at": "2017-10-05T13:04:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23713#issuecomment-449791",
    "user": "https://github.com/hivert"
}
```

Changing reviewer from "" to "Florent Hivert"



---

archive/issue_comments_449792.json:
```json
{
    "body": "<a id='comment:10'></a>\nHi Jeroen, \n\nThanks for taking care of this one (and all the others) ! It's good to go for me. I assume that the limit `SAGE_NUM_THREADS=2` si set up to be able to doctests on small machines. It seems a little low to me. I'd rather put 4 just to shake up a little the parallel feature. Except for that, everything loos ok to me.\n\nFlorent",
    "created_at": "2017-10-05T13:04:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23713#issuecomment-449792",
    "user": "https://github.com/hivert"
}
```

<a id='comment:10'></a>
Hi Jeroen, 

Thanks for taking care of this one (and all the others) ! It's good to go for me. I assume that the limit `SAGE_NUM_THREADS=2` si set up to be able to doctests on small machines. It seems a little low to me. I'd rather put 4 just to shake up a little the parallel feature. Except for that, everything loos ok to me.

Florent



---

archive/issue_comments_449793.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-10-05T13:04:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23713#issuecomment-449793",
    "user": "https://github.com/hivert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_449794.json:
```json
{
    "body": "Changing branch from \"u/jdemeyer/support_sage_num_threads_parallel_in_parallel_map_reduce\" to \"f5e5765874b291d48bf4d8fede927befbddddfb7\"",
    "created_at": "2017-10-15T11:45:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23713#issuecomment-449794",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/jdemeyer/support_sage_num_threads_parallel_in_parallel_map_reduce" to "f5e5765874b291d48bf4d8fede927befbddddfb7"



---

archive/issue_events_068896.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-10-15T11:45:12Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23713",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23713#event-68896"
}
```



---

archive/issue_comments_449795.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-10-15T11:45:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23713#issuecomment-449795",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_449796.json:
```json
{
    "body": "Changing commit from \"f5e5765874b291d48bf4d8fede927befbddddfb7\" to \"\"",
    "created_at": "2018-05-26T13:47:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23713#issuecomment-449796",
    "user": "https://github.com/egourgoulhon"
}
```

Changing commit from "f5e5765874b291d48bf4d8fede927befbddddfb7" to ""



---

archive/issue_comments_449797.json:
```json
{
    "body": "<a id='comment:12'></a>\nSee #24937 for a follow up.",
    "created_at": "2018-05-26T13:47:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23713#issuecomment-449797",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:12'></a>
See #24937 for a follow up.
