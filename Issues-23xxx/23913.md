# Issue 23913: Doctest failures with GMP

archive/issues_023676.json:
```json
{
    "body": "With GMP is used instead of MPIR, there are two doctest failures because of error checking that GMP does but MPIR does not:\n\n```\n**********************************************************************\nFile \"src/sage/rings/integer.pyx\", line 6099, in sage.rings.integer.Integer._shift_helper\nFailed example:\n    1 << (2^60)\nExpected:\n    Traceback (most recent call last):\n    ...\n    MemoryError: failed to allocate ... bytes   \nGot:\n    gmp: overflow in mpz type\n    Traceback (most recent call last):\n      File \"/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 515, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 885, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.rings.integer.Integer._shift_helper[8]>\", line 1, in <module>\n        Integer(1) << (Integer(2)**Integer(60))\n      File \"sage/rings/integer.pyx\", line 6177, in sage.rings.integer.Integer.__lshift__ (build/cythonized/sage/rings/integer.c:39270)\n        return (<Integer>x)._shift_helper(y, 1)\n      File \"sage/rings/integer.pyx\", line 6138, in sage.rings.integer.Integer._shift_helper (build/cythonized/sage/rings/integer.c:39014)\n        sig_on()\n    RuntimeError: Aborted\n**********************************************************************\n```\nand\n\n```\nsage -t --warn-long 61.3 src/sage/ext/memory.pyx\n**********************************************************************\nFile \"src/sage/ext/memory.pyx\", line 9, in sage.ext.memory\nFailed example:\n    2^(2^63-2)\nExpected:\n    Traceback (most recent call last):\n    ...\n    MemoryError: failed to allocate 1152921504606847008 bytes  \nGot:\n    gmp: overflow in mpz type\n    Traceback (most recent call last):\n      File \"/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 515, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 885, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.ext.memory[0]>\", line 1, in <module>\n        Integer(2)**(Integer(2)**Integer(63)-Integer(2))\n      File \"sage/rings/integer.pyx\", line 2067, in sage.rings.integer.Integer.__pow__ (build/cythonized/sage/rings/integer.c:14173)\n        sig_on()\n    RuntimeError: Aborted\n**********************************************************************\n```\nUpstream GMP provides no way to hook this error: https://gmplib.org/list-archives/gmp-discuss/2017-September/006144.html\n\nCC:  @kiwifb @koffie\n\nBranch/Commit: bf7056499f7e4c9a7fca342523238a27144cc8c9\n\nUpstream: Reported upstream. No feedback yet.\n\nReviewer: Jeroen Demeyer\n\nAuthor: Maarten Derickx\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/23913\n\n",
    "closed_at": "2017-10-01T00:18:58Z",
    "created_at": "2017-09-21T13:42:52Z",
    "labels": [
        "component: packages: optional",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Doctest failures with GMP",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23913",
    "user": "https://github.com/jdemeyer"
}
```
With GMP is used instead of MPIR, there are two doctest failures because of error checking that GMP does but MPIR does not:

```
**********************************************************************
File "src/sage/rings/integer.pyx", line 6099, in sage.rings.integer.Integer._shift_helper
Failed example:
    1 << (2^60)
Expected:
    Traceback (most recent call last):
    ...
    MemoryError: failed to allocate ... bytes   
Got:
    gmp: overflow in mpz type
    Traceback (most recent call last):
      File "/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.integer.Integer._shift_helper[8]>", line 1, in <module>
        Integer(1) << (Integer(2)**Integer(60))
      File "sage/rings/integer.pyx", line 6177, in sage.rings.integer.Integer.__lshift__ (build/cythonized/sage/rings/integer.c:39270)
        return (<Integer>x)._shift_helper(y, 1)
      File "sage/rings/integer.pyx", line 6138, in sage.rings.integer.Integer._shift_helper (build/cythonized/sage/rings/integer.c:39014)
        sig_on()
    RuntimeError: Aborted
**********************************************************************
```
and

```
sage -t --warn-long 61.3 src/sage/ext/memory.pyx
**********************************************************************
File "src/sage/ext/memory.pyx", line 9, in sage.ext.memory
Failed example:
    2^(2^63-2)
Expected:
    Traceback (most recent call last):
    ...
    MemoryError: failed to allocate 1152921504606847008 bytes  
Got:
    gmp: overflow in mpz type
    Traceback (most recent call last):
      File "/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.ext.memory[0]>", line 1, in <module>
        Integer(2)**(Integer(2)**Integer(63)-Integer(2))
      File "sage/rings/integer.pyx", line 2067, in sage.rings.integer.Integer.__pow__ (build/cythonized/sage/rings/integer.c:14173)
        sig_on()
    RuntimeError: Aborted
**********************************************************************
```
Upstream GMP provides no way to hook this error: https://gmplib.org/list-archives/gmp-discuss/2017-September/006144.html

CC:  @kiwifb @koffie

Branch/Commit: bf7056499f7e4c9a7fca342523238a27144cc8c9

Upstream: Reported upstream. No feedback yet.

Reviewer: Jeroen Demeyer

Author: Maarten Derickx

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/23913





---

archive/issue_comments_451398.json:
```json
{
    "body": "<a id='comment:3'></a>Since both mpir and gmp are optional packages couldn't we also implement a fix by having\n\n```\n2^(2^63-2) #optional mpir\nsome error\n2^(2^63-2) #optional gmp\nanother error\n```\n\nin the mean time? If someone here at this ticket thinks that it is a good idea, then I will create a ticket with the relatively easy patch for it.",
    "created_at": "2017-09-25T20:23:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23913#issuecomment-451398",
    "user": "https://github.com/koffie"
}
```

<a id='comment:3'></a>Since both mpir and gmp are optional packages couldn't we also implement a fix by having

```
2^(2^63-2) #optional mpir
some error
2^(2^63-2) #optional gmp
another error
```

in the mean time? If someone here at this ticket thinks that it is a good idea, then I will create a ticket with the relatively easy patch for it.



---

archive/issue_comments_451399.json:
```json
{
    "body": "<a id='comment:4'></a>That's an interesting idea considering that by default tests are run with `--optional=mpir,python2,sage` so the default behavior isn't changed. But I am not sure what happens when `gmp` is selected. But I think that is a good approach.",
    "created_at": "2017-09-25T20:34:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23913#issuecomment-451399",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:4'></a>That's an interesting idea considering that by default tests are run with `--optional=mpir,python2,sage` so the default behavior isn't changed. But I am not sure what happens when `gmp` is selected. But I think that is a good approach.



---

archive/issue_comments_451400.json:
```json
{
    "body": "<a id='comment:5'></a>The default argument for optional is actually determined programmatically. `sage` is always there and the rest is just a list of optional packages. It just happens that python2 and mpir are optional packages that are installed by default. If you would build sage with python3 and gmp instead it will be `--optional=gmp,python3,sage` instead.",
    "created_at": "2017-09-25T21:06:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23913#issuecomment-451400",
    "user": "https://github.com/koffie"
}
```

<a id='comment:5'></a>The default argument for optional is actually determined programmatically. `sage` is always there and the rest is just a list of optional packages. It just happens that python2 and mpir are optional packages that are installed by default. If you would build sage with python3 and gmp instead it will be `--optional=gmp,python3,sage` instead.



---

archive/issue_comments_451401.json:
```json
{
    "body": "<a id='comment:6'></a>I was not sure of the mechanics but it makes sense for it be that way. Your solution should work. I'll be waiting to see your suggested branch.",
    "created_at": "2017-09-25T21:08:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23913#issuecomment-451401",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:6'></a>I was not sure of the mechanics but it makes sense for it be that way. Your solution should work. I'll be waiting to see your suggested branch.



---

archive/issue_comments_451402.json:
```json
{
    "body": "Changing branch from \"\" to \"public/23913\"",
    "created_at": "2017-09-26T21:29:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23913#issuecomment-451402",
    "user": "https://github.com/koffie"
}
```

Changing branch from "" to "public/23913"



---

archive/issue_comments_451403.json:
```json
{
    "body": "Changing author from \"\" to \"Maarten Derickx\"",
    "created_at": "2017-09-26T21:29:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23913#issuecomment-451403",
    "user": "https://github.com/koffie"
}
```

Changing author from "" to "Maarten Derickx"



---

archive/issue_comments_451404.json:
```json
{
    "body": "<a id='comment:7'></a>Ok, I created a branch with how I think the fix should look like. But I did not put it to needs review yet because I do not understand how to check that it works, the main problem is that I do not now how to properly build sage with gmp.\n\nI tried just:\n\n```\nsage -i gmp\n```\nin a sage that was already build since I was hoping to save time, but this does not work (it is running the optional gmp test and not the mpir one, but the test result is that of mpir). Should I do:\n\n```\nsage -i gmp\nmake build\n```\nOr do I need to do:\n\n```\nmake distclean\nmake gmp \nmake build\n```\n\n---\nNew commits:",
    "created_at": "2017-09-26T21:29:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23913#issuecomment-451404",
    "user": "https://github.com/koffie"
}
```

<a id='comment:7'></a>Ok, I created a branch with how I think the fix should look like. But I did not put it to needs review yet because I do not understand how to check that it works, the main problem is that I do not now how to properly build sage with gmp.

I tried just:

```
sage -i gmp
```
in a sage that was already build since I was hoping to save time, but this does not work (it is running the optional gmp test and not the mpir one, but the test result is that of mpir). Should I do:

```
sage -i gmp
make build
```
Or do I need to do:

```
make distclean
make gmp 
make build
```

---
New commits:



---

archive/issue_comments_451405.json:
```json
{
    "body": "Changing commit from \"\" to \"beef1a813eecf7d24de8f05ec839f824dc5275ee\"",
    "created_at": "2017-09-26T21:29:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23913#issuecomment-451405",
    "user": "https://github.com/koffie"
}
```

Changing commit from "" to "beef1a813eecf7d24de8f05ec839f824dc5275ee"



---

archive/issue_comments_451406.json:
```json
{
    "body": "<a id='comment:8'></a>I am not sure from an existing sage I am afraid, rebuilding is necessary and there could be stray libraries in the way. It would better and much cleaner - but unfortunately more time consuming - to do\n\n```\n./configure --with-mp=gmp\nmake\n```",
    "created_at": "2017-09-26T21:34:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23913#issuecomment-451406",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:8'></a>I am not sure from an existing sage I am afraid, rebuilding is necessary and there could be stray libraries in the way. It would better and much cleaner - but unfortunately more time consuming - to do

```
./configure --with-mp=gmp
make
```



---

archive/issue_comments_451407.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2017-09-26T21:36:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23913#issuecomment-451407",
    "user": "https://github.com/koffie"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_451408.json:
```json
{
    "body": "<a id='comment:10'></a>I got an error that configure was not found in a clean install, so I had to do\n\n```\nmake configure\n./configure --with-mp=gmp\nmake\n```\n\nI am now building and waiting for how the tests turn out. If you already have an install with gmp lying around and you test this branch there then you will probably know the results before I do.",
    "created_at": "2017-09-26T21:44:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23913#issuecomment-451408",
    "user": "https://github.com/koffie"
}
```

<a id='comment:10'></a>I got an error that configure was not found in a clean install, so I had to do

```
make configure
./configure --with-mp=gmp
make
```

I am now building and waiting for how the tests turn out. If you already have an install with gmp lying around and you test this branch there then you will probably know the results before I do.



---

archive/issue_comments_451409.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2017-09-26T21:44:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23913#issuecomment-451409",
    "user": "https://github.com/koffie"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_451410.json:
```json
{
    "body": "Attachment [mpfr-3.1.5.p0.log](tarball://root/attachments/some-uuid/ticket23913/mpfr-3.1.5.p0.log) by @koffie created at 2017-09-26 21:54:40",
    "created_at": "2017-09-26T21:54:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23913#issuecomment-451410",
    "user": "https://github.com/koffie"
}
```

Attachment [mpfr-3.1.5.p0.log](tarball://root/attachments/some-uuid/ticket23913/mpfr-3.1.5.p0.log) by @koffie created at 2017-09-26 21:54:40



---

archive/issue_comments_451411.json:
```json
{
    "body": "<a id='comment:11'></a>The commands:\n\n```\nmake configure\n./configure --with-mp=gmp\nmake\n```\nresulted in the failure building of mpfr on OS X 10.12.4 with Xcode 8.3.3 before gcc was build. I've attached the log, so I still don't know how to test it on this machine. I can test it on Ubuntu tomorrow.",
    "created_at": "2017-09-26T22:00:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23913#issuecomment-451411",
    "user": "https://github.com/koffie"
}
```

<a id='comment:11'></a>The commands:

```
make configure
./configure --with-mp=gmp
make
```
resulted in the failure building of mpfr on OS X 10.12.4 with Xcode 8.3.3 before gcc was build. I've attached the log, so I still don't know how to test it on this machine. I can test it on Ubuntu tomorrow.



---

archive/issue_comments_451412.json:
```json
{
    "body": "<a id='comment:12'></a>That's still a problem thanks for pointing it out. We didn't notice it on the `gmp` upgrade ticket but we should have.",
    "created_at": "2017-09-26T22:01:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23913#issuecomment-451412",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:12'></a>That's still a problem thanks for pointing it out. We didn't notice it on the `gmp` upgrade ticket but we should have.



---

archive/issue_comments_451413.json:
```json
{
    "body": "<a id='comment:13'></a>Ok, I have now noticed something. You are not using the latest `gmp` from the `gmp` upgrade ticket. It would be best if that was the case. Since it is not in a beta yet you should depend on #19706 and merge its branch with the one in this ticket. It looks like there is an issue with the produced libgmp with your version of xcode and it is quite possible it is fixed by the gmp version of #19706.",
    "created_at": "2017-09-26T22:09:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23913#issuecomment-451413",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:13'></a>Ok, I have now noticed something. You are not using the latest `gmp` from the `gmp` upgrade ticket. It would be best if that was the case. Since it is not in a beta yet you should depend on #19706 and merge its branch with the one in this ticket. It looks like there is an issue with the produced libgmp with your version of xcode and it is quite possible it is fixed by the gmp version of #19706.



---

archive/issue_comments_451414.json:
```json
{
    "body": "<a id='comment:14'></a>It took me longer then it should to figure out how to pull #19706, but it now works and gets me past mpfr. The build is now at the point of building gcc.  I'll report back tomorrow.",
    "created_at": "2017-09-26T23:15:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23913#issuecomment-451414",
    "user": "https://github.com/koffie"
}
```

<a id='comment:14'></a>It took me longer then it should to figure out how to pull #19706, but it now works and gets me past mpfr. The build is now at the point of building gcc.  I'll report back tomorrow.



---

archive/issue_comments_451415.json:
```json
{
    "body": "<a id='comment:15'></a>Good, that means that `gmp` before the upgrade was broken on OS X anyway, so it was high time to upgrade it.",
    "created_at": "2017-09-26T23:17:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23913#issuecomment-451415",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:15'></a>Good, that means that `gmp` before the upgrade was broken on OS X anyway, so it was high time to upgrade it.



---

archive/issue_comments_451416.json:
```json
{
    "body": "<a id='comment:16'></a>Your patch makes sense, but you will need to special-case 32-bit. I'm pretty sure that the 32-bit result is an `OverflowError` both with `mpir` and with `gmp`.",
    "created_at": "2017-09-27T09:11:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23913#issuecomment-451416",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'></a>Your patch makes sense, but you will need to special-case 32-bit. I'm pretty sure that the 32-bit result is an `OverflowError` both with `mpir` and with `gmp`.



---

archive/issue_comments_451417.json:
```json
{
    "body": "<a id='comment:17'></a>Thanks for pointing this out, I am now building sage with the gmp from #19706 on a 32bit machine as well to see what the exact error message looks like.",
    "created_at": "2017-09-27T17:30:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23913#issuecomment-451417",
    "user": "https://github.com/koffie"
}
```

<a id='comment:17'></a>Thanks for pointing this out, I am now building sage with the gmp from #19706 on a 32bit machine as well to see what the exact error message looks like.



---

archive/issue_comments_451418.json:
```json
{
    "body": "<a id='comment:18'></a>The `OverflowError` is raised by Cython, so it would be the same for `mpir` and `gmp`.",
    "created_at": "2017-09-27T17:33:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23913#issuecomment-451418",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>The `OverflowError` is raised by Cython, so it would be the same for `mpir` and `gmp`.



---

archive/issue_comments_451419.json:
```json
{
    "body": "<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-09-28T00:38:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23913#issuecomment-451419",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_451420.json:
```json
{
    "body": "Changing commit from \"beef1a813eecf7d24de8f05ec839f824dc5275ee\" to \"dcb984a4f99eefbfbd5064bf82fda815482c601d\"",
    "created_at": "2017-09-28T00:38:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23913#issuecomment-451420",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "beef1a813eecf7d24de8f05ec839f824dc5275ee" to "dcb984a4f99eefbfbd5064bf82fda815482c601d"



---

archive/issue_comments_451421.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-09-28T01:02:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23913#issuecomment-451421",
    "user": "https://github.com/koffie"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_451422.json:
```json
{
    "body": "<a id='comment:20'></a>Ok, I tested the current branch on:\n\n- 32-bit gmp + #19706\n- 32-bit mpir\n- 64-bit mpir\n\nI still need to test 64-bit gmp + #19706 since the build on my laptop got interrupted a few times, I think it should pass but I am not 100% sure. I am hesitant to put it into needs review before I know this case passes, however if either of you can verify that this case also passes then feel free to review this ticket.\n\nI don't think this ticket needs a dependency on #19706 since it merges cleanly with it.",
    "created_at": "2017-09-28T01:02:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23913#issuecomment-451422",
    "user": "https://github.com/koffie"
}
```

<a id='comment:20'></a>Ok, I tested the current branch on:

- 32-bit gmp + #19706
- 32-bit mpir
- 64-bit mpir

I still need to test 64-bit gmp + #19706 since the build on my laptop got interrupted a few times, I think it should pass but I am not 100% sure. I am hesitant to put it into needs review before I know this case passes, however if either of you can verify that this case also passes then feel free to review this ticket.

I don't think this ticket needs a dependency on #19706 since it merges cleanly with it.



---

archive/issue_comments_451423.json:
```json
{
    "body": "<a id='comment:21'></a>Ok the case: 64-bit gmp + #19706 failed.  I didn't realise that the doctesting framework only sees errors as errors if the error is thrown on the first line.\n\nSo the expected/got in \n\n```\nExpected:\n    Traceback (most recent call last):\n    ...\n    MemoryError: failed to allocate ... bytes   \nGot:\n    gmp: overflow in mpz type\n    Traceback (most recent call last):\n      File \"/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 515, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 885, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.rings.integer.Integer._shift_helper[8]>\", line 1, in <module>\n        Integer(1) << (Integer(2)**Integer(60))\n      File \"sage/rings/integer.pyx\", line 6177, in sage.rings.integer.Integer.__lshift__ (build/cythonized/sage/rings/integer.c:39270)\n        return (<Integer>x)._shift_helper(y, 1)\n      File \"sage/rings/integer.pyx\", line 6138, in sage.rings.integer.Integer._shift_helper (build/cythonized/sage/rings/integer.c:39014)\n        sig_on()\n    RuntimeError: Aborted\n```\nIs a bit misleading since for the passing doctest for this is without the \"gmp: overflow in mpz type\" line.\n\n```\n    Traceback (most recent call last):\n    ...\n    RuntimeError: Aborted\n```\nanyway. It now passes in all 4 cases for me, so ready for review.\n  \n---\nNew commits:",
    "created_at": "2017-09-28T04:29:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23913#issuecomment-451423",
    "user": "https://github.com/koffie"
}
```

<a id='comment:21'></a>Ok the case: 64-bit gmp + #19706 failed.  I didn't realise that the doctesting framework only sees errors as errors if the error is thrown on the first line.

So the expected/got in 

```
Expected:
    Traceback (most recent call last):
    ...
    MemoryError: failed to allocate ... bytes   
Got:
    gmp: overflow in mpz type
    Traceback (most recent call last):
      File "/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.integer.Integer._shift_helper[8]>", line 1, in <module>
        Integer(1) << (Integer(2)**Integer(60))
      File "sage/rings/integer.pyx", line 6177, in sage.rings.integer.Integer.__lshift__ (build/cythonized/sage/rings/integer.c:39270)
        return (<Integer>x)._shift_helper(y, 1)
      File "sage/rings/integer.pyx", line 6138, in sage.rings.integer.Integer._shift_helper (build/cythonized/sage/rings/integer.c:39014)
        sig_on()
    RuntimeError: Aborted
```
Is a bit misleading since for the passing doctest for this is without the "gmp: overflow in mpz type" line.

```
    Traceback (most recent call last):
    ...
    RuntimeError: Aborted
```
anyway. It now passes in all 4 cases for me, so ready for review.
  
---
New commits:



---

archive/issue_comments_451424.json:
```json
{
    "body": "Changing commit from \"dcb984a4f99eefbfbd5064bf82fda815482c601d\" to \"bf7056499f7e4c9a7fca342523238a27144cc8c9\"",
    "created_at": "2017-09-28T04:29:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23913#issuecomment-451424",
    "user": "https://github.com/koffie"
}
```

Changing commit from "dcb984a4f99eefbfbd5064bf82fda815482c601d" to "bf7056499f7e4c9a7fca342523238a27144cc8c9"



---

archive/issue_comments_451425.json:
```json
{
    "body": "Changing branch from \"public/23913\" to \"public/23913_clean\"",
    "created_at": "2017-09-28T04:29:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23913#issuecomment-451425",
    "user": "https://github.com/koffie"
}
```

Changing branch from "public/23913" to "public/23913_clean"



---

archive/issue_comments_451426.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Jeroen Demeyer\"",
    "created_at": "2017-09-28T20:34:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23913#issuecomment-451426",
    "user": "https://github.com/jdemeyer"
}
```

Changing reviewer from "" to "Jeroen Demeyer"



---

archive/issue_comments_451427.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-09-28T20:34:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23913#issuecomment-451427",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_451428.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-10-01T00:18:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23913#issuecomment-451428",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_060870.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-10-01T00:18:58Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23913",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23913#event-60870"
}
```



---

archive/issue_comments_451429.json:
```json
{
    "body": "Changing branch from \"public/23913_clean\" to \"bf7056499f7e4c9a7fca342523238a27144cc8c9\"",
    "created_at": "2017-10-01T00:18:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23913#issuecomment-451429",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/23913_clean" to "bf7056499f7e4c9a7fca342523238a27144cc8c9"
