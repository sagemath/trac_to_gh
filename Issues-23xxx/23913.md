# Issue 23913: Doctest failures with GMP

archive/issues_023676.json:
```json
{
    "assignees": [],
    "body": "With GMP is used instead of MPIR, there are two doctest failures because of error checking that GMP does but MPIR does not:\n\n```\n**********************************************************************\nFile \"src/sage/rings/integer.pyx\", line 6099, in sage.rings.integer.Integer._shift_helper\nFailed example:\n    1 << (2^60)\nExpected:\n    Traceback (most recent call last):\n    ...\n    MemoryError: failed to allocate ... bytes   \nGot:\n    gmp: overflow in mpz type\n    Traceback (most recent call last):\n      File \"/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 515, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 885, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.rings.integer.Integer._shift_helper[8]>\", line 1, in <module>\n        Integer(1) << (Integer(2)**Integer(60))\n      File \"sage/rings/integer.pyx\", line 6177, in sage.rings.integer.Integer.__lshift__ (build/cythonized/sage/rings/integer.c:39270)\n        return (<Integer>x)._shift_helper(y, 1)\n      File \"sage/rings/integer.pyx\", line 6138, in sage.rings.integer.Integer._shift_helper (build/cythonized/sage/rings/integer.c:39014)\n        sig_on()\n    RuntimeError: Aborted\n**********************************************************************\n```\nand\n\n```\nsage -t --warn-long 61.3 src/sage/ext/memory.pyx\n**********************************************************************\nFile \"src/sage/ext/memory.pyx\", line 9, in sage.ext.memory\nFailed example:\n    2^(2^63-2)\nExpected:\n    Traceback (most recent call last):\n    ...\n    MemoryError: failed to allocate 1152921504606847008 bytes  \nGot:\n    gmp: overflow in mpz type\n    Traceback (most recent call last):\n      File \"/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 515, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 885, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.ext.memory[0]>\", line 1, in <module>\n        Integer(2)**(Integer(2)**Integer(63)-Integer(2))\n      File \"sage/rings/integer.pyx\", line 2067, in sage.rings.integer.Integer.__pow__ (build/cythonized/sage/rings/integer.c:14173)\n        sig_on()\n    RuntimeError: Aborted\n**********************************************************************\n```\nUpstream GMP provides no way to hook this error: https://gmplib.org/list-archives/gmp-discuss/2017-September/006144.html\n\nCC:  @kiwifb @koffie\n\nBranch/Commit: **[`bf70564`](https://github.com/sagemath/sagetrac-mirror/commit/bf7056499f7e4c9a7fca342523238a27144cc8c9)**\n\nUpstream: **Reported upstream. No feedback yet.**\n\nReviewer: **Jeroen Demeyer**\n\nAuthor: **Maarten Derickx**\n\nComponent: **packages: optional**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/23913_\n\n",
    "closed_at": "2017-10-01T00:18:58Z",
    "created_at": "2017-09-21T13:42:52Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20packages%3A%20optional",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.1",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Doctest failures with GMP",
    "type": "issue",
    "updated_at": "2017-10-01T00:18:58Z",
    "url": "https://github.com/sagemath/sage/issues/23913",
    "user": "https://github.com/jdemeyer"
}
```
With GMP is used instead of MPIR, there are two doctest failures because of error checking that GMP does but MPIR does not:

```
**********************************************************************
File "src/sage/rings/integer.pyx", line 6099, in sage.rings.integer.Integer._shift_helper
Failed example:
    1 << (2^60)
Expected:
    Traceback (most recent call last):
    ...
    MemoryError: failed to allocate ... bytes   
Got:
    gmp: overflow in mpz type
    Traceback (most recent call last):
      File "/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.integer.Integer._shift_helper[8]>", line 1, in <module>
        Integer(1) << (Integer(2)**Integer(60))
      File "sage/rings/integer.pyx", line 6177, in sage.rings.integer.Integer.__lshift__ (build/cythonized/sage/rings/integer.c:39270)
        return (<Integer>x)._shift_helper(y, 1)
      File "sage/rings/integer.pyx", line 6138, in sage.rings.integer.Integer._shift_helper (build/cythonized/sage/rings/integer.c:39014)
        sig_on()
    RuntimeError: Aborted
**********************************************************************
```
and

```
sage -t --warn-long 61.3 src/sage/ext/memory.pyx
**********************************************************************
File "src/sage/ext/memory.pyx", line 9, in sage.ext.memory
Failed example:
    2^(2^63-2)
Expected:
    Traceback (most recent call last):
    ...
    MemoryError: failed to allocate 1152921504606847008 bytes  
Got:
    gmp: overflow in mpz type
    Traceback (most recent call last):
      File "/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.ext.memory[0]>", line 1, in <module>
        Integer(2)**(Integer(2)**Integer(63)-Integer(2))
      File "sage/rings/integer.pyx", line 2067, in sage.rings.integer.Integer.__pow__ (build/cythonized/sage/rings/integer.c:14173)
        sig_on()
    RuntimeError: Aborted
**********************************************************************
```
Upstream GMP provides no way to hook this error: https://gmplib.org/list-archives/gmp-discuss/2017-September/006144.html

CC:  @kiwifb @koffie

Branch/Commit: **[`bf70564`](https://github.com/sagemath/sagetrac-mirror/commit/bf7056499f7e4c9a7fca342523238a27144cc8c9)**

Upstream: **Reported upstream. No feedback yet.**

Reviewer: **Jeroen Demeyer**

Author: **Maarten Derickx**

Component: **packages: optional**

_Issue created by migration from https://trac.sagemath.org/ticket/23913_





---

archive/issue_events_332059.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-09-21T13:42:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "milestone_number": null,
    "milestone_title": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23913#event-332059"
}
```



---

archive/issue_events_332060.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-09-21T13:42:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20packages%3A%20optional",
    "label_color": "000080",
    "label_name": "c: packages: optional",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23913#event-332060"
}
```



---

archive/issue_events_332061.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-09-21T13:42:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23913#event-332061"
}
```



---

archive/issue_events_332062.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-09-21T13:42:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23913#event-332062"
}
```



---

archive/issue_comments_360917.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nSince both mpir and gmp are optional packages couldn't we also implement a fix by having\n\n```\n2^(2^63-2) #optional mpir\nsome error\n2^(2^63-2) #optional gmp\nanother error\n```\n\nin the mean time? If someone here at this ticket thinks that it is a good idea, then I will create a ticket with the relatively easy patch for it.",
    "created_at": "2017-09-25T20:23:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23913#issuecomment-360917",
    "user": "https://github.com/koffie"
}
```

<div id="comment:3" align="right">comment:3</div>

Since both mpir and gmp are optional packages couldn't we also implement a fix by having

```
2^(2^63-2) #optional mpir
some error
2^(2^63-2) #optional gmp
another error
```

in the mean time? If someone here at this ticket thinks that it is a good idea, then I will create a ticket with the relatively easy patch for it.



---

archive/issue_comments_360918.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nThat's an interesting idea considering that by default tests are run with `--optional=mpir,python2,sage` so the default behavior isn't changed. But I am not sure what happens when `gmp` is selected. But I think that is a good approach.",
    "created_at": "2017-09-25T20:34:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23913#issuecomment-360918",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:4" align="right">comment:4</div>

That's an interesting idea considering that by default tests are run with `--optional=mpir,python2,sage` so the default behavior isn't changed. But I am not sure what happens when `gmp` is selected. But I think that is a good approach.



---

archive/issue_comments_360919.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nThe default argument for optional is actually determined programmatically. `sage` is always there and the rest is just a list of optional packages. It just happens that python2 and mpir are optional packages that are installed by default. If you would build sage with python3 and gmp instead it will be `--optional=gmp,python3,sage` instead.",
    "created_at": "2017-09-25T21:06:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23913#issuecomment-360919",
    "user": "https://github.com/koffie"
}
```

<div id="comment:5" align="right">comment:5</div>

The default argument for optional is actually determined programmatically. `sage` is always there and the rest is just a list of optional packages. It just happens that python2 and mpir are optional packages that are installed by default. If you would build sage with python3 and gmp instead it will be `--optional=gmp,python3,sage` instead.



---

archive/issue_comments_360920.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nI was not sure of the mechanics but it makes sense for it be that way. Your solution should work. I'll be waiting to see your suggested branch.",
    "created_at": "2017-09-25T21:08:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23913#issuecomment-360920",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:6" align="right">comment:6</div>

I was not sure of the mechanics but it makes sense for it be that way. Your solution should work. I'll be waiting to see your suggested branch.



---

archive/issue_comments_360921.json:
```json
{
    "body": "Branch: **[public/23913](https://github.com/sagemath/sagetrac-mirror/tree/public/23913)**",
    "created_at": "2017-09-26T21:29:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23913#issuecomment-360921",
    "user": "https://github.com/koffie"
}
```

Branch: **[public/23913](https://github.com/sagemath/sagetrac-mirror/tree/public/23913)**



---

archive/issue_comments_360922.json:
```json
{
    "body": "Author: **Maarten Derickx**",
    "created_at": "2017-09-26T21:29:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23913#issuecomment-360922",
    "user": "https://github.com/koffie"
}
```

Author: **Maarten Derickx**



---

archive/issue_comments_360923.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nOk, I created a branch with how I think the fix should look like. But I did not put it to needs review yet because I do not understand how to check that it works, the main problem is that I do not now how to properly build sage with gmp.\n\nI tried just:\n\n```\nsage -i gmp\n```\nin a sage that was already build since I was hoping to save time, but this does not work (it is running the optional gmp test and not the mpir one, but the test result is that of mpir). Should I do:\n\n```\nsage -i gmp\nmake build\n```\nOr do I need to do:\n\n```\nmake distclean\nmake gmp \nmake build\n```\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/beef1a813eecf7d24de8f05ec839f824dc5275ee\">beef1a8</a></td><td><code>Trac #23913: Fixed doctest failures with GMP</code></td></tr></table>\n",
    "created_at": "2017-09-26T21:29:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23913#issuecomment-360923",
    "user": "https://github.com/koffie"
}
```

<div id="comment:7" align="right">comment:7</div>

Ok, I created a branch with how I think the fix should look like. But I did not put it to needs review yet because I do not understand how to check that it works, the main problem is that I do not now how to properly build sage with gmp.

I tried just:

```
sage -i gmp
```
in a sage that was already build since I was hoping to save time, but this does not work (it is running the optional gmp test and not the mpir one, but the test result is that of mpir). Should I do:

```
sage -i gmp
make build
```
Or do I need to do:

```
make distclean
make gmp 
make build
```

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/beef1a813eecf7d24de8f05ec839f824dc5275ee">beef1a8</a></td><td><code>Trac #23913: Fixed doctest failures with GMP</code></td></tr></table>




---

archive/issue_comments_360924.json:
```json
{
    "body": "Commit: **[`beef1a8`](https://github.com/sagemath/sagetrac-mirror/commit/beef1a813eecf7d24de8f05ec839f824dc5275ee)**",
    "created_at": "2017-09-26T21:29:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23913#issuecomment-360924",
    "user": "https://github.com/koffie"
}
```

Commit: **[`beef1a8`](https://github.com/sagemath/sagetrac-mirror/commit/beef1a813eecf7d24de8f05ec839f824dc5275ee)**



---

archive/issue_comments_360925.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nI am not sure from an existing sage I am afraid, rebuilding is necessary and there could be stray libraries in the way. It would better and much cleaner - but unfortunately more time consuming - to do\n\n```\n./configure --with-mp=gmp\nmake\n```",
    "created_at": "2017-09-26T21:34:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23913#issuecomment-360925",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:8" align="right">comment:8</div>

I am not sure from an existing sage I am afraid, rebuilding is necessary and there could be stray libraries in the way. It would better and much cleaner - but unfortunately more time consuming - to do

```
./configure --with-mp=gmp
make
```



---

archive/issue_events_332063.json:
```json
{
    "actor": "https://github.com/koffie",
    "created_at": "2017-09-26T21:36:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23913#event-332063"
}
```



---

archive/issue_comments_360926.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nI got an error that configure was not found in a clean install, so I had to do\n\n```\nmake configure\n./configure --with-mp=gmp\nmake\n```\n\nI am now building and waiting for how the tests turn out. If you already have an install with gmp lying around and you test this branch there then you will probably know the results before I do.",
    "created_at": "2017-09-26T21:44:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23913#issuecomment-360926",
    "user": "https://github.com/koffie"
}
```

<div id="comment:10" align="right">comment:10</div>

I got an error that configure was not found in a clean install, so I had to do

```
make configure
./configure --with-mp=gmp
make
```

I am now building and waiting for how the tests turn out. If you already have an install with gmp lying around and you test this branch there then you will probably know the results before I do.



---

archive/issue_events_332064.json:
```json
{
    "actor": "https://github.com/koffie",
    "created_at": "2017-09-26T21:44:45Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23913#event-332064"
}
```



---

archive/issue_events_332065.json:
```json
{
    "actor": "https://github.com/koffie",
    "created_at": "2017-09-26T21:44:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23913#event-332065"
}
```



---

archive/issue_comments_360927.json:
```json
{
    "body": "Attachment: **[mpfr-3.1.5.p0.log](https://github.com/sagemath/sage/files/ticket23913/mpfr-3.1.5.p0.log)**",
    "created_at": "2017-09-26T21:54:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23913#issuecomment-360927",
    "user": "https://github.com/koffie"
}
```

Attachment: **[mpfr-3.1.5.p0.log](https://github.com/sagemath/sage/files/ticket23913/mpfr-3.1.5.p0.log)**



---

archive/issue_comments_360928.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nThe commands:\n\n```\nmake configure\n./configure --with-mp=gmp\nmake\n```\nresulted in the failure building of mpfr on OS X 10.12.4 with Xcode 8.3.3 before gcc was build. I've attached the log, so I still don't know how to test it on this machine. I can test it on Ubuntu tomorrow.",
    "created_at": "2017-09-26T22:00:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23913#issuecomment-360928",
    "user": "https://github.com/koffie"
}
```

<div id="comment:11" align="right">comment:11</div>

The commands:

```
make configure
./configure --with-mp=gmp
make
```
resulted in the failure building of mpfr on OS X 10.12.4 with Xcode 8.3.3 before gcc was build. I've attached the log, so I still don't know how to test it on this machine. I can test it on Ubuntu tomorrow.



---

archive/issue_comments_360929.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nThat's still a problem thanks for pointing it out. We didn't notice it on the `gmp` upgrade ticket but we should have.",
    "created_at": "2017-09-26T22:01:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23913#issuecomment-360929",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:12" align="right">comment:12</div>

That's still a problem thanks for pointing it out. We didn't notice it on the `gmp` upgrade ticket but we should have.



---

archive/issue_comments_360930.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nOk, I have now noticed something. You are not using the latest `gmp` from the `gmp` upgrade ticket. It would be best if that was the case. Since it is not in a beta yet you should depend on #19706 and merge its branch with the one in this ticket. It looks like there is an issue with the produced libgmp with your version of xcode and it is quite possible it is fixed by the gmp version of #19706.",
    "created_at": "2017-09-26T22:09:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23913#issuecomment-360930",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:13" align="right">comment:13</div>

Ok, I have now noticed something. You are not using the latest `gmp` from the `gmp` upgrade ticket. It would be best if that was the case. Since it is not in a beta yet you should depend on #19706 and merge its branch with the one in this ticket. It looks like there is an issue with the produced libgmp with your version of xcode and it is quite possible it is fixed by the gmp version of #19706.



---

archive/issue_comments_360931.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nIt took me longer then it should to figure out how to pull #19706, but it now works and gets me past mpfr. The build is now at the point of building gcc.  I'll report back tomorrow.",
    "created_at": "2017-09-26T23:15:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23913#issuecomment-360931",
    "user": "https://github.com/koffie"
}
```

<div id="comment:14" align="right">comment:14</div>

It took me longer then it should to figure out how to pull #19706, but it now works and gets me past mpfr. The build is now at the point of building gcc.  I'll report back tomorrow.



---

archive/issue_comments_360932.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nGood, that means that `gmp` before the upgrade was broken on OS X anyway, so it was high time to upgrade it.",
    "created_at": "2017-09-26T23:17:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23913#issuecomment-360932",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:15" align="right">comment:15</div>

Good, that means that `gmp` before the upgrade was broken on OS X anyway, so it was high time to upgrade it.



---

archive/issue_comments_360933.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nYour patch makes sense, but you will need to special-case 32-bit. I'm pretty sure that the 32-bit result is an `OverflowError` both with `mpir` and with `gmp`.",
    "created_at": "2017-09-27T09:11:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23913#issuecomment-360933",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:16" align="right">comment:16</div>

Your patch makes sense, but you will need to special-case 32-bit. I'm pretty sure that the 32-bit result is an `OverflowError` both with `mpir` and with `gmp`.



---

archive/issue_comments_360934.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nThanks for pointing this out, I am now building sage with the gmp from #19706 on a 32bit machine as well to see what the exact error message looks like.",
    "created_at": "2017-09-27T17:30:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23913#issuecomment-360934",
    "user": "https://github.com/koffie"
}
```

<div id="comment:17" align="right">comment:17</div>

Thanks for pointing this out, I am now building sage with the gmp from #19706 on a 32bit machine as well to see what the exact error message looks like.



---

archive/issue_comments_360935.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nThe `OverflowError` is raised by Cython, so it would be the same for `mpir` and `gmp`.",
    "created_at": "2017-09-27T17:33:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23913#issuecomment-360935",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:18" align="right">comment:18</div>

The `OverflowError` is raised by Cython, so it would be the same for `mpir` and `gmp`.



---

archive/issue_comments_360936.json:
```json
{
    "body": "<div id=\"comment:19\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/dcb984a4f99eefbfbd5064bf82fda815482c601d\">dcb984a</a></td><td><code>Trac 23913: Fixed doctest failures with GMP in 32-bit</code></td></tr></table>\n",
    "created_at": "2017-09-28T00:38:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23913#issuecomment-360936",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:19"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/dcb984a4f99eefbfbd5064bf82fda815482c601d">dcb984a</a></td><td><code>Trac 23913: Fixed doctest failures with GMP in 32-bit</code></td></tr></table>




---

archive/issue_comments_360937.json:
```json
{
    "body": "Changed commit from **[`beef1a8`](https://github.com/sagemath/sagetrac-mirror/commit/beef1a813eecf7d24de8f05ec839f824dc5275ee)** to **[`dcb984a`](https://github.com/sagemath/sagetrac-mirror/commit/dcb984a4f99eefbfbd5064bf82fda815482c601d)**",
    "created_at": "2017-09-28T00:38:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23913#issuecomment-360937",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`beef1a8`](https://github.com/sagemath/sagetrac-mirror/commit/beef1a813eecf7d24de8f05ec839f824dc5275ee)** to **[`dcb984a`](https://github.com/sagemath/sagetrac-mirror/commit/dcb984a4f99eefbfbd5064bf82fda815482c601d)**



---

archive/issue_events_332066.json:
```json
{
    "actor": "https://github.com/koffie",
    "created_at": "2017-09-28T01:02:24Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23913#event-332066"
}
```



---

archive/issue_events_332067.json:
```json
{
    "actor": "https://github.com/koffie",
    "created_at": "2017-09-28T01:02:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23913#event-332067"
}
```



---

archive/issue_comments_360938.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nOk, I tested the current branch on:\n\n- 32-bit gmp + #19706\n- 32-bit mpir\n- 64-bit mpir\n\nI still need to test 64-bit gmp + #19706 since the build on my laptop got interrupted a few times, I think it should pass but I am not 100% sure. I am hesitant to put it into needs review before I know this case passes, however if either of you can verify that this case also passes then feel free to review this ticket.\n\nI don't think this ticket needs a dependency on #19706 since it merges cleanly with it.",
    "created_at": "2017-09-28T01:02:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23913#issuecomment-360938",
    "user": "https://github.com/koffie"
}
```

<div id="comment:20" align="right">comment:20</div>

Ok, I tested the current branch on:

- 32-bit gmp + #19706
- 32-bit mpir
- 64-bit mpir

I still need to test 64-bit gmp + #19706 since the build on my laptop got interrupted a few times, I think it should pass but I am not 100% sure. I am hesitant to put it into needs review before I know this case passes, however if either of you can verify that this case also passes then feel free to review this ticket.

I don't think this ticket needs a dependency on #19706 since it merges cleanly with it.



---

archive/issue_comments_360939.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nOk the case: 64-bit gmp + #19706 failed.  I didn't realise that the doctesting framework only sees errors as errors if the error is thrown on the first line.\n\nSo the expected/got in \n\n```\nExpected:\n    Traceback (most recent call last):\n    ...\n    MemoryError: failed to allocate ... bytes   \nGot:\n    gmp: overflow in mpz type\n    Traceback (most recent call last):\n      File \"/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 515, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 885, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.rings.integer.Integer._shift_helper[8]>\", line 1, in <module>\n        Integer(1) << (Integer(2)**Integer(60))\n      File \"sage/rings/integer.pyx\", line 6177, in sage.rings.integer.Integer.__lshift__ (build/cythonized/sage/rings/integer.c:39270)\n        return (<Integer>x)._shift_helper(y, 1)\n      File \"sage/rings/integer.pyx\", line 6138, in sage.rings.integer.Integer._shift_helper (build/cythonized/sage/rings/integer.c:39014)\n        sig_on()\n    RuntimeError: Aborted\n```\nIs a bit misleading since for the passing doctest for this is without the \"gmp: overflow in mpz type\" line.\n\n```\n    Traceback (most recent call last):\n    ...\n    RuntimeError: Aborted\n```\nanyway. It now passes in all 4 cases for me, so ready for review.\n  \n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bf7056499f7e4c9a7fca342523238a27144cc8c9\">bf70564</a></td><td><code>Trac #23913: Fixed doctest failures with GMP</code></td></tr></table>\n",
    "created_at": "2017-09-28T04:29:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23913#issuecomment-360939",
    "user": "https://github.com/koffie"
}
```

<div id="comment:21" align="right">comment:21</div>

Ok the case: 64-bit gmp + #19706 failed.  I didn't realise that the doctesting framework only sees errors as errors if the error is thrown on the first line.

So the expected/got in 

```
Expected:
    Traceback (most recent call last):
    ...
    MemoryError: failed to allocate ... bytes   
Got:
    gmp: overflow in mpz type
    Traceback (most recent call last):
      File "/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.integer.Integer._shift_helper[8]>", line 1, in <module>
        Integer(1) << (Integer(2)**Integer(60))
      File "sage/rings/integer.pyx", line 6177, in sage.rings.integer.Integer.__lshift__ (build/cythonized/sage/rings/integer.c:39270)
        return (<Integer>x)._shift_helper(y, 1)
      File "sage/rings/integer.pyx", line 6138, in sage.rings.integer.Integer._shift_helper (build/cythonized/sage/rings/integer.c:39014)
        sig_on()
    RuntimeError: Aborted
```
Is a bit misleading since for the passing doctest for this is without the "gmp: overflow in mpz type" line.

```
    Traceback (most recent call last):
    ...
    RuntimeError: Aborted
```
anyway. It now passes in all 4 cases for me, so ready for review.
  
---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bf7056499f7e4c9a7fca342523238a27144cc8c9">bf70564</a></td><td><code>Trac #23913: Fixed doctest failures with GMP</code></td></tr></table>




---

archive/issue_comments_360940.json:
```json
{
    "body": "Changed commit from **[`dcb984a`](https://github.com/sagemath/sagetrac-mirror/commit/dcb984a4f99eefbfbd5064bf82fda815482c601d)** to **[`bf70564`](https://github.com/sagemath/sagetrac-mirror/commit/bf7056499f7e4c9a7fca342523238a27144cc8c9)**",
    "created_at": "2017-09-28T04:29:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23913#issuecomment-360940",
    "user": "https://github.com/koffie"
}
```

Changed commit from **[`dcb984a`](https://github.com/sagemath/sagetrac-mirror/commit/dcb984a4f99eefbfbd5064bf82fda815482c601d)** to **[`bf70564`](https://github.com/sagemath/sagetrac-mirror/commit/bf7056499f7e4c9a7fca342523238a27144cc8c9)**



---

archive/issue_comments_360941.json:
```json
{
    "body": "Changed branch from **[public/23913](https://github.com/sagemath/sagetrac-mirror/tree/public/23913)** to **[public/23913_clean](https://github.com/sagemath/sagetrac-mirror/tree/public/23913_clean)**",
    "created_at": "2017-09-28T04:29:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23913#issuecomment-360941",
    "user": "https://github.com/koffie"
}
```

Changed branch from **[public/23913](https://github.com/sagemath/sagetrac-mirror/tree/public/23913)** to **[public/23913_clean](https://github.com/sagemath/sagetrac-mirror/tree/public/23913_clean)**



---

archive/issue_comments_360942.json:
```json
{
    "body": "Reviewer: **Jeroen Demeyer**",
    "created_at": "2017-09-28T20:34:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23913#issuecomment-360942",
    "user": "https://github.com/jdemeyer"
}
```

Reviewer: **Jeroen Demeyer**



---

archive/issue_events_332068.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-09-28T20:34:59Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23913#event-332068"
}
```



---

archive/issue_events_332069.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-09-28T20:34:59Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23913#event-332069"
}
```



---

archive/issue_events_332070.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-10-01T00:18:58Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23913#event-332070"
}
```



---

archive/issue_events_332071.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "780dbfbd0a491192226a28335e72d2097df83939",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2017-10-01T00:18:58Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23913#event-332071"
}
```



---

archive/issue_comments_360943.json:
```json
{
    "body": "Changed branch from **[public/23913_clean](https://github.com/sagemath/sagetrac-mirror/tree/public/23913_clean)** to **[`bf70564`](https://github.com/sagemath/sagetrac-mirror/commit/bf7056499f7e4c9a7fca342523238a27144cc8c9)**",
    "created_at": "2017-10-01T00:18:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23913#issuecomment-360943",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[public/23913_clean](https://github.com/sagemath/sagetrac-mirror/tree/public/23913_clean)** to **[`bf70564`](https://github.com/sagemath/sagetrac-mirror/commit/bf7056499f7e4c9a7fca342523238a27144cc8c9)**
