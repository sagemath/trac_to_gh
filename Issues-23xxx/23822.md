# Issue 23822: Python3 build error: unicode problem in pip_installed_packages()

archive/issues_023585.json:
```json
{
    "body": "The python 3 build was broken by #23615 because of incorrect unicode usage causing the building of sage failing in the following way\n\n```\nchapoton@icj-laptop:~/sage3$ ./sage -br\ncd . && export                                    \\\n    SAGE_ROOT=/doesnotexist                               \\\n    SAGE_SRC=/doesnotexist                                \\\n    SAGE_SRC_ROOT=/doesnotexist                           \\\n    SAGE_DOC_SRC=/doesnotexist                            \\\n    SAGE_BUILD_DIR=/doesnotexist                          \\\n    SAGE_PKGS=/home/chapoton/sage3/build/pkgs                \\\n    SAGE_CYTHONIZED=/home/chapoton/sage3/src/build/cythonized      \\\n&& sage-python23 -u setup.py --no-user-cfg build install\n************************************************************************\nTraceback (most recent call last):\n  File \"setup.py\", line 69, in <module>\n    from module_list import ext_modules, library_order, aliases\n  File \"/home/chapoton/sage3/src/module_list.py\", line 166, in <module>\n    from sage_setup.optional_extension import OptionalExtension\n  File \"/home/chapoton/sage3/src/sage_setup/optional_extension.py\", line 24, in <module>\n    all_packages = list_packages(local=True)\n  File \"/home/chapoton/sage3/src/sage/misc/package.py\", line 226, in list_packages\n    installed = installed_packages(exclude_pip)\n  File \"/home/chapoton/sage3/src/sage/misc/package.py\", line 286, in installed_packages\n    installed.update(pip_installed_packages())\n  File \"/home/chapoton/sage3/src/sage/misc/package.py\", line 148, in pip_installed_packages\n    return {package['name'].lower():package['version'] for package in json.loads(stdout)}\n  File \"/home/chapoton/sage3/local/lib/python3.6/json/__init__.py\", line 354, in loads\n    return _default_decoder.decode(s)\n  File \"/home/chapoton/sage3/local/lib/python3.6/json/decoder.py\", line 339, in decode\n    obj, end = self.raw_decode(s, idx=_w(s, 0).end())\n  File \"/home/chapoton/sage3/local/lib/python3.6/json/decoder.py\", line 357, in raw_decode\n    raise JSONDecodeError(\"Expecting value\", s, err.value) from None\njson.decoder.JSONDecodeError: Expecting value: line 1 column 1 (char 0)\n************************************************************************\nError building the Sage library\n************************************************************************\nMakefile:34 : la recette pour la cible \u00ab sage \u00bb a \u00e9chou\u00e9e\nmake: *** [sage] Erreur 1\n```\n\n**Branch/Commit:** [f3e5282c30fe45aa34b611f052341fb546e8e43b](https://github.com/sagemath/sagetrac-mirror/commit/f3e5282c30fe45aa34b611f052341fb546e8e43b)\n\n**Reviewer:** Fr\u00e9d\u00e9ric Chapoton\n\n**Author:** Maarten Derickx\n\n**Resolution:** fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/23822\n\n",
    "closed_at": "2017-09-20T22:26:43Z",
    "created_at": "2017-09-10T12:44:20Z",
    "labels": [
        "component: python3",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Python3 build error: unicode problem in pip_installed_packages()",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23822",
    "user": "https://github.com/koffie"
}
```
The python 3 build was broken by #23615 because of incorrect unicode usage causing the building of sage failing in the following way

```
chapoton@icj-laptop:~/sage3$ ./sage -br
cd . && export                                    \
    SAGE_ROOT=/doesnotexist                               \
    SAGE_SRC=/doesnotexist                                \
    SAGE_SRC_ROOT=/doesnotexist                           \
    SAGE_DOC_SRC=/doesnotexist                            \
    SAGE_BUILD_DIR=/doesnotexist                          \
    SAGE_PKGS=/home/chapoton/sage3/build/pkgs                \
    SAGE_CYTHONIZED=/home/chapoton/sage3/src/build/cythonized      \
&& sage-python23 -u setup.py --no-user-cfg build install
************************************************************************
Traceback (most recent call last):
  File "setup.py", line 69, in <module>
    from module_list import ext_modules, library_order, aliases
  File "/home/chapoton/sage3/src/module_list.py", line 166, in <module>
    from sage_setup.optional_extension import OptionalExtension
  File "/home/chapoton/sage3/src/sage_setup/optional_extension.py", line 24, in <module>
    all_packages = list_packages(local=True)
  File "/home/chapoton/sage3/src/sage/misc/package.py", line 226, in list_packages
    installed = installed_packages(exclude_pip)
  File "/home/chapoton/sage3/src/sage/misc/package.py", line 286, in installed_packages
    installed.update(pip_installed_packages())
  File "/home/chapoton/sage3/src/sage/misc/package.py", line 148, in pip_installed_packages
    return {package['name'].lower():package['version'] for package in json.loads(stdout)}
  File "/home/chapoton/sage3/local/lib/python3.6/json/__init__.py", line 354, in loads
    return _default_decoder.decode(s)
  File "/home/chapoton/sage3/local/lib/python3.6/json/decoder.py", line 339, in decode
    obj, end = self.raw_decode(s, idx=_w(s, 0).end())
  File "/home/chapoton/sage3/local/lib/python3.6/json/decoder.py", line 357, in raw_decode
    raise JSONDecodeError("Expecting value", s, err.value) from None
json.decoder.JSONDecodeError: Expecting value: line 1 column 1 (char 0)
************************************************************************
Error building the Sage library
************************************************************************
Makefile:34 : la recette pour la cible « sage » a échouée
make: *** [sage] Erreur 1
```

**Branch/Commit:** [f3e5282c30fe45aa34b611f052341fb546e8e43b](https://github.com/sagemath/sagetrac-mirror/commit/f3e5282c30fe45aa34b611f052341fb546e8e43b)

**Reviewer:** Frédéric Chapoton

**Author:** Maarten Derickx

**Resolution:** fixed

Issue created by migration from https://trac.sagemath.org/ticket/23822





---

archive/issue_comments_451960.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2017-09-10T12:53:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23822",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23822#issuecomment-451960",
    "user": "https://github.com/koffie"
}
```


**Changing status** from new to needs_review.



---

archive/issue_comments_451961.json:
```json
{
    "body": "<a id='comment:1'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f3e5282c30fe45aa34b611f052341fb546e8e43b\">f3e5282</a></td><td><code>Trac #23822: fix python3 build error: unicode problem in pip_installed_packages()</code></td></tr></table>\n",
    "created_at": "2017-09-10T12:53:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23822",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23822#issuecomment-451961",
    "user": "https://github.com/koffie"
}
```


<a id='comment:1'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f3e5282c30fe45aa34b611f052341fb546e8e43b">f3e5282</a></td><td><code>Trac #23822: fix python3 build error: unicode problem in pip_installed_packages()</code></td></tr></table>




---

archive/issue_comments_451962.json:
```json
{
    "body": "**Commit:** [f3e5282c30fe45aa34b611f052341fb546e8e43b](https://github.com/sagemath/sagetrac-mirror/commit/f3e5282c30fe45aa34b611f052341fb546e8e43b)",
    "created_at": "2017-09-10T12:53:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23822",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23822#issuecomment-451962",
    "user": "https://github.com/koffie"
}
```


**Commit:** [f3e5282c30fe45aa34b611f052341fb546e8e43b](https://github.com/sagemath/sagetrac-mirror/commit/f3e5282c30fe45aa34b611f052341fb546e8e43b)



---

archive/issue_comments_451963.json:
```json
{
    "body": "**Branch:** [u/mderickx/23822](https://github.com/sagemath/sagetrac-mirror/tree/u/mderickx/23822)",
    "created_at": "2017-09-10T12:53:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23822",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23822#issuecomment-451963",
    "user": "https://github.com/koffie"
}
```


**Branch:** [u/mderickx/23822](https://github.com/sagemath/sagetrac-mirror/tree/u/mderickx/23822)



---

archive/issue_comments_451964.json:
```json
{
    "body": "**Author:** Maarten Derickx",
    "created_at": "2017-09-10T13:07:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23822",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23822#issuecomment-451964",
    "user": "https://github.com/koffie"
}
```


**Author:** Maarten Derickx



---

archive/issue_comments_451965.json:
```json
{
    "body": "<a id='comment:3'></a>\nok, let it be",
    "created_at": "2017-09-18T08:01:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23822",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23822#issuecomment-451965",
    "user": "https://github.com/fchapoton"
}
```


<a id='comment:3'></a>
ok, let it be



---

archive/issue_comments_451966.json:
```json
{
    "body": "**Reviewer:** Fr\u00e9d\u00e9ric Chapoton",
    "created_at": "2017-09-18T08:01:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23822",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23822#issuecomment-451966",
    "user": "https://github.com/fchapoton"
}
```


**Reviewer:** Frédéric Chapoton



---

archive/issue_comments_451967.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2017-09-18T08:01:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23822",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23822#issuecomment-451967",
    "user": "https://github.com/fchapoton"
}
```


**Changing status** from needs_review to positive_review.



---

archive/issue_comments_451968.json:
```json
{
    "body": "<a id='comment:4'></a>\nDo you need the `.decode`, or can you just use\n\n```\nstdout = proc.communicate()[0]\n```\n?",
    "created_at": "2017-09-18T15:49:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23822",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23822#issuecomment-451968",
    "user": "https://github.com/jhpalmieri"
}
```


<a id='comment:4'></a>
Do you need the `.decode`, or can you just use

```
stdout = proc.communicate()[0]
```
?



---

archive/issue_comments_451969.json:
```json
{
    "body": "<a id='comment:5'></a>\nIn python 2 it is not needed but good praxis.  In python 3 it is needed since stdout is a bytestring before decoding and the json library only takes unicode strings and not bytestrings as input.",
    "created_at": "2017-09-18T21:49:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23822",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23822#issuecomment-451969",
    "user": "https://github.com/koffie"
}
```


<a id='comment:5'></a>
In python 2 it is not needed but good praxis.  In python 3 it is needed since stdout is a bytestring before decoding and the json library only takes unicode strings and not bytestrings as input.



---

archive/issue_comments_451970.json:
```json
{
    "body": "<a id='comment:6'></a>\nWhen I was looking at #23876, I came across this bug and didn't use `.decode`, and it seemed to work with Python 3. That is, before making any changes, Sage crashed on startup, complaining about this problem, but when I switched to `stdout = proc.communicate()[0]`, it didn't complain about that. (It crashed elsewhere, as described at #23876.) So I am not convinced that it is needed with Python 3.\n\nOkay, I checked the Python documentation. I agree that `stdout` should be a binary stream, but according to the [json documentation](https://docs.python.org/3/library/json.html#json.loads), `json.loads` can take something of type `bytes` as input.\n\nEdit: this behavior of `json` is new as of Python 3.6.",
    "created_at": "2017-09-18T22:00:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23822",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23822#issuecomment-451970",
    "user": "https://github.com/jhpalmieri"
}
```


<a id='comment:6'></a>
When I was looking at #23876, I came across this bug and didn't use `.decode`, and it seemed to work with Python 3. That is, before making any changes, Sage crashed on startup, complaining about this problem, but when I switched to `stdout = proc.communicate()[0]`, it didn't complain about that. (It crashed elsewhere, as described at #23876.) So I am not convinced that it is needed with Python 3.

Okay, I checked the Python documentation. I agree that `stdout` should be a binary stream, but according to the [json documentation](https://docs.python.org/3/library/json.html#json.loads), `json.loads` can take something of type `bytes` as input.

Edit: this behavior of `json` is new as of Python 3.6.



---

archive/issue_comments_451971.json:
```json
{
    "body": "<a id='comment:7'></a>\nI could have sworn that I only added the decode() because it was failing otherwise. But sage was already on 3.6 when I wrote this. I dont think either solution is clearly better then the other. But the one with a decode already has positive review so I propose to leave it as is.",
    "created_at": "2017-09-18T22:36:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23822",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23822#issuecomment-451971",
    "user": "https://github.com/koffie"
}
```


<a id='comment:7'></a>
I could have sworn that I only added the decode() because it was failing otherwise. But sage was already on 3.6 when I wrote this. I dont think either solution is clearly better then the other. But the one with a decode already has positive review so I propose to leave it as is.



---

archive/issue_comments_451972.json:
```json
{
    "body": "**Changing branch** from \"[u/mderickx/23822](https://github.com/sagemath/sagetrac-mirror/tree/u/mderickx/23822)\" to \"[f3e5282c30fe45aa34b611f052341fb546e8e43b](https://github.com/sagemath/sagetrac-mirror/commit/f3e5282c30fe45aa34b611f052341fb546e8e43b)\".",
    "created_at": "2017-09-20T22:26:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23822",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23822#issuecomment-451972",
    "user": "https://github.com/vbraun"
}
```


**Changing branch** from "[u/mderickx/23822](https://github.com/sagemath/sagetrac-mirror/tree/u/mderickx/23822)" to "[f3e5282c30fe45aa34b611f052341fb546e8e43b](https://github.com/sagemath/sagetrac-mirror/commit/f3e5282c30fe45aa34b611f052341fb546e8e43b)".



---

archive/issue_events_069059.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-09-20T22:26:43Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23822",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23822#event-69059"
}
```




---

archive/issue_comments_451973.json:
```json
{
    "body": "**Resolution:** fixed",
    "created_at": "2017-09-20T22:26:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23822",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23822#issuecomment-451973",
    "user": "https://github.com/vbraun"
}
```


**Resolution:** fixed
