# Issue 23748: Run doctests with limited memory

archive/issues_023511.json:
```json
{
    "assignees": [],
    "body": "There are various reasons to limit the maximal amount of memory that doctests can use:\n1. Bugs which cause large memory usage and which can cause trouble for the OS when running doctests.\n2. It is good to check that doctests do not use a large amount of memory.\n3. It allows to doctest graceful recovery when memory cannot be allocated by intentionally allocating more memory than available.\n\nI suggest to limit the virtual memory for doctests. The following two files contain the tests which need the most memory:\n\n```\nsrc/sage/game_theory/matching_game.py\nsrc/sage/schemes/elliptic_curves/heegner.py\n```\n\nThis branch also reduces the memory needed for `matching_game.py`, such that `heegner.py` is now the doctest which requires the most memory.\n\nBranch: **[`06d4307`](https://github.com/sagemath/sagetrac-mirror/commit/06d43071962808d1d8adf6d527a4e762f34290b5)**\n\nReviewer: **Travis Scrimshaw**\n\nAuthor: **Jeroen Demeyer**\n\nComponent: **doctest framework**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/23748_\n\n",
    "closed_at": "2017-09-11T13:47:16Z",
    "created_at": "2017-08-30T08:28:11Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20doctest%20framework",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.1",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Run doctests with limited memory",
    "type": "issue",
    "updated_at": "2017-10-20T09:38:16Z",
    "url": "https://github.com/sagemath/sage/issues/23748",
    "user": "https://github.com/jdemeyer"
}
```
There are various reasons to limit the maximal amount of memory that doctests can use:
1. Bugs which cause large memory usage and which can cause trouble for the OS when running doctests.
2. It is good to check that doctests do not use a large amount of memory.
3. It allows to doctest graceful recovery when memory cannot be allocated by intentionally allocating more memory than available.

I suggest to limit the virtual memory for doctests. The following two files contain the tests which need the most memory:

```
src/sage/game_theory/matching_game.py
src/sage/schemes/elliptic_curves/heegner.py
```

This branch also reduces the memory needed for `matching_game.py`, such that `heegner.py` is now the doctest which requires the most memory.

Branch: **[`06d4307`](https://github.com/sagemath/sagetrac-mirror/commit/06d43071962808d1d8adf6d527a4e762f34290b5)**

Reviewer: **Travis Scrimshaw**

Author: **Jeroen Demeyer**

Component: **doctest framework**

_Issue created by migration from https://trac.sagemath.org/ticket/23748_





---

archive/issue_events_330115.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-08-30T08:28:11Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "milestone_number": null,
    "milestone_title": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23748#event-330115"
}
```



---

archive/issue_events_330116.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-08-30T08:28:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20doctest%20framework",
    "label_color": "000080",
    "label_name": "c: doctest framework",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23748#event-330116"
}
```



---

archive/issue_events_330117.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-08-30T08:28:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23748#event-330117"
}
```



---

archive/issue_events_330118.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-08-30T08:28:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23748#event-330118"
}
```



---

archive/issue_comments_358256.json:
```json
{
    "body": "Branch: **[u/jdemeyer/run_doctests_with_limited_memory](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/run_doctests_with_limited_memory)**",
    "created_at": "2017-08-30T14:57:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358256",
    "user": "https://github.com/jdemeyer"
}
```

Branch: **[u/jdemeyer/run_doctests_with_limited_memory](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/run_doctests_with_limited_memory)**



---

archive/issue_comments_358257.json:
```json
{
    "body": "<div id=\"comment:2\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6b2589ee117284cc3dc24d58beda0aa2b3aa5a0e\">6b2589e</a></td><td><code>Run doctests with limited memory</code></td></tr></table>\n",
    "created_at": "2017-08-30T15:10:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358257",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:2"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6b2589ee117284cc3dc24d58beda0aa2b3aa5a0e">6b2589e</a></td><td><code>Run doctests with limited memory</code></td></tr></table>




---

archive/issue_comments_358258.json:
```json
{
    "body": "Commit: **[`6b2589e`](https://github.com/sagemath/sagetrac-mirror/commit/6b2589ee117284cc3dc24d58beda0aa2b3aa5a0e)**",
    "created_at": "2017-08-30T15:10:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358258",
    "user": "https://github.com/jdemeyer"
}
```

Commit: **[`6b2589e`](https://github.com/sagemath/sagetrac-mirror/commit/6b2589ee117284cc3dc24d58beda0aa2b3aa5a0e)**



---

archive/issue_events_330119.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-08-30T15:10:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23748#event-330119"
}
```



---

archive/issue_comments_358259.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nMaybe this should be discussed on sage-devel, but my vote would be for 1Gb as IMO, doctests should in general not use a large amount of memory similar to the paradigm that they should be fast.",
    "created_at": "2017-08-30T15:56:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358259",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:3" align="right">comment:3</div>

Maybe this should be discussed on sage-devel, but my vote would be for 1Gb as IMO, doctests should in general not use a large amount of memory similar to the paradigm that they should be fast.



---

archive/issue_comments_358260.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nReplying to [@tscrim](#comment:3):\n> Maybe this should be discussed on sage-devel, but my vote would be for 1Gb as IMO, doctests should in general not use a large amount of memory similar to the paradigm that they should be fast.\n\nWith 1GB, you cannot even start Sage.\n\nAnd some doctests in `src/sage/schemes/elliptic_curves/heegner.py` do not pass with a limit of only 3GB.",
    "created_at": "2017-08-30T17:09:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358260",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:4" align="right">comment:4</div>

Replying to [@tscrim](#comment:3):
> Maybe this should be discussed on sage-devel, but my vote would be for 1Gb as IMO, doctests should in general not use a large amount of memory similar to the paradigm that they should be fast.

With 1GB, you cannot even start Sage.

And some doctests in `src/sage/schemes/elliptic_curves/heegner.py` do not pass with a limit of only 3GB.



---

archive/issue_comments_358261.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nReplying to [@tscrim](#comment:3):\n> doctests should in general not use a large amount of memory similar to the paradigm that they should be fast.\n\nThat's precisely the reason for this patch.",
    "created_at": "2017-08-30T17:10:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358261",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:5" align="right">comment:5</div>

Replying to [@tscrim](#comment:3):
> doctests should in general not use a large amount of memory similar to the paradigm that they should be fast.

That's precisely the reason for this patch.



---

archive/issue_comments_358262.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,3 @@\n-Sometimes, due to bugs, it can happen that doctests take a very large amount of memory, causing trouble for the OS. I suggest to find a reasonable value of `ulimit -v` and use that to limit the virtual memory taken by doctests. This is also a check that doctests do not use too large amounts of memory.\n+Sometimes, due to bugs, it can happen that doctests take a very large amount of memory, causing trouble for the OS. Also, it is good to check that doctests do not use a large amount of memory.\n+\n+I suggest to limit the virtual memory for doctests to 4GiB. This may seem like a lot, but note that some doctests in `src/sage/schemes/elliptic_curves/heegner.py` do not pass with 3GiB.\n``````\n",
    "created_at": "2017-08-30T17:12:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358262",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,3 @@
-Sometimes, due to bugs, it can happen that doctests take a very large amount of memory, causing trouble for the OS. I suggest to find a reasonable value of `ulimit -v` and use that to limit the virtual memory taken by doctests. This is also a check that doctests do not use too large amounts of memory.
+Sometimes, due to bugs, it can happen that doctests take a very large amount of memory, causing trouble for the OS. Also, it is good to check that doctests do not use a large amount of memory.
+
+I suggest to limit the virtual memory for doctests to 4GiB. This may seem like a lot, but note that some doctests in `src/sage/schemes/elliptic_curves/heegner.py` do not pass with 3GiB.
``````




---

archive/issue_comments_358263.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nReplying to [@jdemeyer](#comment:4):\n> Replying to [@tscrim](#comment:3):\n> > Maybe this should be discussed on sage-devel, but my vote would be for 1Gb as IMO, doctests should in general not use a large amount of memory similar to the paradigm that they should be fast.\n\n> \n> With 1GB, you cannot even start Sage.\n\nOh, I was thinking this was the amount of memory specifically used by any particular doctest, not Sage + doctests. What about when doctests are run in parallel? Since it is using threads, we still have the same limit of 4Gb, so I am worried we will hit this limit on systems with larger amounts of cores.\n\n> And some doctests in `src/sage/schemes/elliptic_curves/heegner.py` do not pass with a limit of only 3GB.\n\nMaybe we also want to consider a `# high memory` marker (another ticket?) or have `# long time` also allow higher memory?",
    "created_at": "2017-08-30T17:23:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358263",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:7" align="right">comment:7</div>

Replying to [@jdemeyer](#comment:4):
> Replying to [@tscrim](#comment:3):
> > Maybe this should be discussed on sage-devel, but my vote would be for 1Gb as IMO, doctests should in general not use a large amount of memory similar to the paradigm that they should be fast.

> 
> With 1GB, you cannot even start Sage.

Oh, I was thinking this was the amount of memory specifically used by any particular doctest, not Sage + doctests. What about when doctests are run in parallel? Since it is using threads, we still have the same limit of 4Gb, so I am worried we will hit this limit on systems with larger amounts of cores.

> And some doctests in `src/sage/schemes/elliptic_curves/heegner.py` do not pass with a limit of only 3GB.

Maybe we also want to consider a `# high memory` marker (another ticket?) or have `# long time` also allow higher memory?



---

archive/issue_comments_358264.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nReplying to [@tscrim](#comment:7):\n> Oh, I was thinking this was the amount of memory specifically used by any particular doctest, not Sage + doctests.\n\nNo, it is the virtual memory limit for the whole process. This includes code (Python + Python modules + libraries) and data, also unused but allocated memory (like the PARI stack).\n\n> What about when doctests are run in parallel? Since it is using threads\n\nNo! It uses processes, not threads. The limit is per process, so we do not need to worry about that.\n\n> > And some doctests in `src/sage/schemes/elliptic_curves/heegner.py` do not pass with a limit of only 3GB.\n\n> \n> Maybe we also want to consider a `# high memory` marker (another ticket?) or have `# long time` also allow higher memory?\n\nPerhaps, but this is just a very simple limit, comparable to the absolute doctest time limit of 360s (short tests) or 1800s (long tests).",
    "created_at": "2017-08-30T19:16:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358264",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:8" align="right">comment:8</div>

Replying to [@tscrim](#comment:7):
> Oh, I was thinking this was the amount of memory specifically used by any particular doctest, not Sage + doctests.

No, it is the virtual memory limit for the whole process. This includes code (Python + Python modules + libraries) and data, also unused but allocated memory (like the PARI stack).

> What about when doctests are run in parallel? Since it is using threads

No! It uses processes, not threads. The limit is per process, so we do not need to worry about that.

> > And some doctests in `src/sage/schemes/elliptic_curves/heegner.py` do not pass with a limit of only 3GB.

> 
> Maybe we also want to consider a `# high memory` marker (another ticket?) or have `# long time` also allow higher memory?

Perhaps, but this is just a very simple limit, comparable to the absolute doctest time limit of 360s (short tests) or 1800s (long tests).



---

archive/issue_comments_358265.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nI'll try to lower the limit of 4GiB somewhat, but it certainly must be higher than 3GiB.",
    "created_at": "2017-08-30T19:21:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358265",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:9" align="right">comment:9</div>

I'll try to lower the limit of 4GiB somewhat, but it certainly must be higher than 3GiB.



---

archive/issue_comments_358266.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,6 @@\n-Sometimes, due to bugs, it can happen that doctests take a very large amount of memory, causing trouble for the OS. Also, it is good to check that doctests do not use a large amount of memory.\n+There are various reasons to limit the maximal amount of memory that doctests can use:\n+1. Bugs which cause large memory usage and which can cause trouble for the OS when running doctests.\n+2. It is good to check that doctests do not use a large amount of memory.\n+3. It allows to doctest graceful recovery when memory cannot be allocated by intentionally allocating more memory than available.\n \n-I suggest to limit the virtual memory for doctests to 4GiB. This may seem like a lot, but note that some doctests in `src/sage/schemes/elliptic_curves/heegner.py` do not pass with 3GiB.\n+I suggest to limit the virtual memory for doctests to 3400MiB. This may seem like a lot, but note that some doctests in `src/sage/schemes/elliptic_curves/heegner.py` need this.\n``````\n",
    "created_at": "2017-08-30T19:28:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358266",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,6 @@
-Sometimes, due to bugs, it can happen that doctests take a very large amount of memory, causing trouble for the OS. Also, it is good to check that doctests do not use a large amount of memory.
+There are various reasons to limit the maximal amount of memory that doctests can use:
+1. Bugs which cause large memory usage and which can cause trouble for the OS when running doctests.
+2. It is good to check that doctests do not use a large amount of memory.
+3. It allows to doctest graceful recovery when memory cannot be allocated by intentionally allocating more memory than available.
 
-I suggest to limit the virtual memory for doctests to 4GiB. This may seem like a lot, but note that some doctests in `src/sage/schemes/elliptic_curves/heegner.py` do not pass with 3GiB.
+I suggest to limit the virtual memory for doctests to 3400MiB. This may seem like a lot, but note that some doctests in `src/sage/schemes/elliptic_curves/heegner.py` need this.
``````




---

archive/issue_comments_358267.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -3,4 +3,4 @@\n 2. It is good to check that doctests do not use a large amount of memory.\n 3. It allows to doctest graceful recovery when memory cannot be allocated by intentionally allocating more memory than available.\n \n-I suggest to limit the virtual memory for doctests to 3400MiB. This may seem like a lot, but note that some doctests in `src/sage/schemes/elliptic_curves/heegner.py` need this.\n+I suggest to limit the virtual memory for doctests to 3500MiB. This may seem like a lot, but note that some doctests need this.\n``````\n",
    "created_at": "2017-08-30T19:34:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358267",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -3,4 +3,4 @@
 2. It is good to check that doctests do not use a large amount of memory.
 3. It allows to doctest graceful recovery when memory cannot be allocated by intentionally allocating more memory than available.
 
-I suggest to limit the virtual memory for doctests to 3400MiB. This may seem like a lot, but note that some doctests in `src/sage/schemes/elliptic_curves/heegner.py` need this.
+I suggest to limit the virtual memory for doctests to 3500MiB. This may seem like a lot, but note that some doctests need this.
``````




---

archive/issue_comments_358268.json:
```json
{
    "body": "<div id=\"comment:12\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f8fcb510bcbe16103fd133b868915b94e7555010\">f8fcb51</a></td><td><code>Run doctests with limited memory</code></td></tr></table>\n",
    "created_at": "2017-08-30T19:46:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358268",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:12"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f8fcb510bcbe16103fd133b868915b94e7555010">f8fcb51</a></td><td><code>Run doctests with limited memory</code></td></tr></table>




---

archive/issue_comments_358269.json:
```json
{
    "body": "Changed commit from **[`6b2589e`](https://github.com/sagemath/sagetrac-mirror/commit/6b2589ee117284cc3dc24d58beda0aa2b3aa5a0e)** to **[`f8fcb51`](https://github.com/sagemath/sagetrac-mirror/commit/f8fcb510bcbe16103fd133b868915b94e7555010)**",
    "created_at": "2017-08-30T19:46:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358269",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`6b2589e`](https://github.com/sagemath/sagetrac-mirror/commit/6b2589ee117284cc3dc24d58beda0aa2b3aa5a0e)** to **[`f8fcb51`](https://github.com/sagemath/sagetrac-mirror/commit/f8fcb510bcbe16103fd133b868915b94e7555010)**



---

archive/issue_comments_358270.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -3,4 +3,4 @@\n 2. It is good to check that doctests do not use a large amount of memory.\n 3. It allows to doctest graceful recovery when memory cannot be allocated by intentionally allocating more memory than available.\n \n-I suggest to limit the virtual memory for doctests to 3500MiB. This may seem like a lot, but note that some doctests need this.\n+I suggest to limit the virtual memory for doctests to 3600MiB. This may seem like a lot, but some doctests need this much.\n``````\n",
    "created_at": "2017-08-30T19:47:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358270",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -3,4 +3,4 @@
 2. It is good to check that doctests do not use a large amount of memory.
 3. It allows to doctest graceful recovery when memory cannot be allocated by intentionally allocating more memory than available.
 
-I suggest to limit the virtual memory for doctests to 3500MiB. This may seem like a lot, but note that some doctests need this.
+I suggest to limit the virtual memory for doctests to 3600MiB. This may seem like a lot, but some doctests need this much.
``````




---

archive/issue_comments_358271.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@jdemeyer](#comment:8):\n> Replying to [@tscrim](#comment:7):\n> > What about when doctests are run in parallel? Since it is using threads\n\n> \n> No! It uses processes, not threads. The limit is per process, so we do not need to worry about that.\n\nWe should probably change this then:\n\n```\ntravis@apricot:~/sage/src/sage/categories$ sage -tp category.py category_types.py \n[snip]\nDoctesting 2 files using 8 threads.\n```\nAlthough I am somewhat surprised my memory usage is not higher when I am running parallel tests since each copy of Sage should take a minimum of 1Gb. *shrugs*, oh well, not important.\n\n> > > And some doctests in `src/sage/schemes/elliptic_curves/heegner.py` do not pass with a limit of only 3GB.\n\n> > \n> > Maybe we also want to consider a `# high memory` marker (another ticket?) or have `# long time` also allow higher memory?\n\n> \n> Perhaps, but this is just a very simple limit, comparable to the absolute doctest time limit of 360s (short tests) or 1800s (long tests).\n\nI don't mind 4Gb, I probably prefer it over the 3.x for simplicity.",
    "created_at": "2017-08-30T21:23:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358271",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@jdemeyer](#comment:8):
> Replying to [@tscrim](#comment:7):
> > What about when doctests are run in parallel? Since it is using threads

> 
> No! It uses processes, not threads. The limit is per process, so we do not need to worry about that.

We should probably change this then:

```
travis@apricot:~/sage/src/sage/categories$ sage -tp category.py category_types.py 
[snip]
Doctesting 2 files using 8 threads.
```
Although I am somewhat surprised my memory usage is not higher when I am running parallel tests since each copy of Sage should take a minimum of 1Gb. *shrugs*, oh well, not important.

> > > And some doctests in `src/sage/schemes/elliptic_curves/heegner.py` do not pass with a limit of only 3GB.

> > 
> > Maybe we also want to consider a `# high memory` marker (another ticket?) or have `# long time` also allow higher memory?

> 
> Perhaps, but this is just a very simple limit, comparable to the absolute doctest time limit of 360s (short tests) or 1800s (long tests).

I don't mind 4Gb, I probably prefer it over the 3.x for simplicity.



---

archive/issue_comments_358272.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -3,4 +3,12 @@\n 2. It is good to check that doctests do not use a large amount of memory.\n 3. It allows to doctest graceful recovery when memory cannot be allocated by intentionally allocating more memory than available.\n \n-I suggest to limit the virtual memory for doctests to 3600MiB. This may seem like a lot, but some doctests need this much.\n+I suggest to limit the virtual memory for doctests to 4500MiB. This may seem like a lot, but these doctests do not pass with a limit of 4000MiB:\n+\n+```\n+src/sage/matrix/matrix_integer_dense.pyx\n+src/sage/rings/polynomial/pbori.pyx\n+src/sage/game_theory/matching_game.py\n+src/sage/rings/integer.pyx\n+```\n+The one requiring the most memory is `src/sage/game_theory/matching_game.py`\n``````\n",
    "created_at": "2017-08-31T08:29:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358272",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -3,4 +3,12 @@
 2. It is good to check that doctests do not use a large amount of memory.
 3. It allows to doctest graceful recovery when memory cannot be allocated by intentionally allocating more memory than available.
 
-I suggest to limit the virtual memory for doctests to 3600MiB. This may seem like a lot, but some doctests need this much.
+I suggest to limit the virtual memory for doctests to 4500MiB. This may seem like a lot, but these doctests do not pass with a limit of 4000MiB:
+
+```
+src/sage/matrix/matrix_integer_dense.pyx
+src/sage/rings/polynomial/pbori.pyx
+src/sage/game_theory/matching_game.py
+src/sage/rings/integer.pyx
+```
+The one requiring the most memory is `src/sage/game_theory/matching_game.py`
``````




---

archive/issue_comments_358273.json:
```json
{
    "body": "<div id=\"comment:16\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b4001c6dbad755c92abaaa4b5b2fb23867df74b8\">b4001c6</a></td><td><code>Run doctests with limited memory</code></td></tr></table>\n",
    "created_at": "2017-08-31T08:29:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358273",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:16"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b4001c6dbad755c92abaaa4b5b2fb23867df74b8">b4001c6</a></td><td><code>Run doctests with limited memory</code></td></tr></table>




---

archive/issue_comments_358274.json:
```json
{
    "body": "Changed commit from **[`f8fcb51`](https://github.com/sagemath/sagetrac-mirror/commit/f8fcb510bcbe16103fd133b868915b94e7555010)** to **[`b4001c6`](https://github.com/sagemath/sagetrac-mirror/commit/b4001c6dbad755c92abaaa4b5b2fb23867df74b8)**",
    "created_at": "2017-08-31T08:29:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358274",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`f8fcb51`](https://github.com/sagemath/sagetrac-mirror/commit/f8fcb510bcbe16103fd133b868915b94e7555010)** to **[`b4001c6`](https://github.com/sagemath/sagetrac-mirror/commit/b4001c6dbad755c92abaaa4b5b2fb23867df74b8)**



---

archive/issue_comments_358275.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@tscrim](#comment:14):\n> each copy of Sage should take a minimum of 1Gb.\n\nWell, remember that this is *virtual* memory. Most of that 1GB is shared between processes. If you run 10 copies of Sage, the executable code of Sage needs to be in *physical* memory only once: the OS maps the same physical memory inside the 10 processes.\n\nThen there is also memory which is reserved but typically not used: Sage might allocate a large PARI stack and GAP memory pool for example which counts against virtual memory. However, as long as this memory is not actually used, you don't need that much physical memory.",
    "created_at": "2017-08-31T08:35:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358275",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@tscrim](#comment:14):
> each copy of Sage should take a minimum of 1Gb.

Well, remember that this is *virtual* memory. Most of that 1GB is shared between processes. If you run 10 copies of Sage, the executable code of Sage needs to be in *physical* memory only once: the OS maps the same physical memory inside the 10 processes.

Then there is also memory which is reserved but typically not used: Sage might allocate a large PARI stack and GAP memory pool for example which counts against virtual memory. However, as long as this memory is not actually used, you don't need that much physical memory.



---

archive/issue_comments_358276.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nIt turns out that even 4GiB is not enough... This new version uses 4500MiB which passes `make ptestlong` on my machine.",
    "created_at": "2017-08-31T08:39:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358276",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:18" align="right">comment:18</div>

It turns out that even 4GiB is not enough... This new version uses 4500MiB which passes `make ptestlong` on my machine.



---

archive/issue_comments_358277.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nReplying to [@jdemeyer](#comment:17):\n> Replying to [@tscrim](#comment:14):\n> > each copy of Sage should take a minimum of 1Gb.\n\n> \n> Well, remember that this is *virtual* memory. Most of that 1GB is shared between processes. If you run 10 copies of Sage, the executable code of Sage needs to be in *physical* memory only once: the OS maps the same physical memory inside the 10 processes.\n> \n> Then there is also memory which is reserved but typically not used: Sage might allocate a large PARI stack and GAP memory pool for example which counts against virtual memory. However, as long as this memory is not actually used, you don't need that much physical memory.\n\nAh, right. Thank you for the explanation.",
    "created_at": "2017-08-31T14:04:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358277",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:19" align="right">comment:19</div>

Replying to [@jdemeyer](#comment:17):
> Replying to [@tscrim](#comment:14):
> > each copy of Sage should take a minimum of 1Gb.

> 
> Well, remember that this is *virtual* memory. Most of that 1GB is shared between processes. If you run 10 copies of Sage, the executable code of Sage needs to be in *physical* memory only once: the OS maps the same physical memory inside the 10 processes.
> 
> Then there is also memory which is reserved but typically not used: Sage might allocate a large PARI stack and GAP memory pool for example which counts against virtual memory. However, as long as this memory is not actually used, you don't need that much physical memory.

Ah, right. Thank you for the explanation.



---

archive/issue_comments_358278.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [@jdemeyer](#comment:18):\n> It turns out that even 4GiB is not enough... This new version uses 4500MiB which passes `make ptestlong` on my machine.\n\nI am pretty sure it is this block of tests that takes the large amount of memory (with `n = 10`):\n\n```\n        sage: from itertools import permutations\n        sage: suitr_preferences = list(permutations([-i-1 for i in range(n)]))\n        sage: revr_preferences = list(permutations([i+1 for i in range(n)]))\n        sage: for player in range(n):\n        ....:     big_game.suitors()[player].pref = suitr_preferences[player]\n        ....:     big_game.reviewers()[player].pref = revr_preferences[-player]\n        sage: big_game.solve()\n        {1: -1, 2: -8, 3: -9, 4: -10, 5: -7, 6: -6, 7: -5, 8: -4, 9: -3, 10: -2}\n```\nThat is `2 * 10! * 10 == 72576000` integers plus other stuff. Might consider dropping `n = 8` instead for this example.",
    "created_at": "2017-08-31T14:13:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358278",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [@jdemeyer](#comment:18):
> It turns out that even 4GiB is not enough... This new version uses 4500MiB which passes `make ptestlong` on my machine.

I am pretty sure it is this block of tests that takes the large amount of memory (with `n = 10`):

```
        sage: from itertools import permutations
        sage: suitr_preferences = list(permutations([-i-1 for i in range(n)]))
        sage: revr_preferences = list(permutations([i+1 for i in range(n)]))
        sage: for player in range(n):
        ....:     big_game.suitors()[player].pref = suitr_preferences[player]
        ....:     big_game.reviewers()[player].pref = revr_preferences[-player]
        sage: big_game.solve()
        {1: -1, 2: -8, 3: -9, 4: -10, 5: -7, 6: -6, 7: -5, 8: -4, 9: -3, 10: -2}
```
That is `2 * 10! * 10 == 72576000` integers plus other stuff. Might consider dropping `n = 8` instead for this example.



---

archive/issue_comments_358279.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nMaybe, but I consider lowering the actual memory requirements of doctests outside the scope of this ticket.",
    "created_at": "2017-08-31T14:59:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358279",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:21" align="right">comment:21</div>

Maybe, but I consider lowering the actual memory requirements of doctests outside the scope of this ticket.



---

archive/issue_events_330120.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-08-31T15:23:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23748#event-330120"
}
```



---

archive/issue_events_330121.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-08-31T15:23:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23748#event-330121"
}
```



---

archive/issue_comments_358280.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nThis is failing badly on the patchbot",
    "created_at": "2017-08-31T15:23:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358280",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:22" align="right">comment:22</div>

This is failing badly on the patchbot



---

archive/issue_comments_358281.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nThe problem seems to be that `setrlimit()` is done way too late. We need to limit the memory *before* starting Sage.",
    "created_at": "2017-09-04T08:50:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358281",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:23" align="right">comment:23</div>

The problem seems to be that `setrlimit()` is done way too late. We need to limit the memory *before* starting Sage.



---

archive/issue_comments_358282.json:
```json
{
    "body": "Changed commit from **[`b4001c6`](https://github.com/sagemath/sagetrac-mirror/commit/b4001c6dbad755c92abaaa4b5b2fb23867df74b8)** to **[`38f9823`](https://github.com/sagemath/sagetrac-mirror/commit/38f982331680d86b3ddafbb40f58ebd63df6719b)**",
    "created_at": "2017-09-04T09:48:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358282",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`b4001c6`](https://github.com/sagemath/sagetrac-mirror/commit/b4001c6dbad755c92abaaa4b5b2fb23867df74b8)** to **[`38f9823`](https://github.com/sagemath/sagetrac-mirror/commit/38f982331680d86b3ddafbb40f58ebd63df6719b)**



---

archive/issue_comments_358283.json:
```json
{
    "body": "<div id=\"comment:24\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/38f982331680d86b3ddafbb40f58ebd63df6719b\">38f9823</a></td><td><code>Run doctests with limited memory</code></td></tr></table>\n",
    "created_at": "2017-09-04T09:48:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358283",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:24"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/38f982331680d86b3ddafbb40f58ebd63df6719b">38f9823</a></td><td><code>Run doctests with limited memory</code></td></tr></table>




---

archive/issue_comments_358284.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -3,12 +3,9 @@\n 2. It is good to check that doctests do not use a large amount of memory.\n 3. It allows to doctest graceful recovery when memory cannot be allocated by intentionally allocating more memory than available.\n \n-I suggest to limit the virtual memory for doctests to 4500MiB. This may seem like a lot, but these doctests do not pass with a limit of 4000MiB:\n+I suggest to limit the virtual memory for doctests. The following two files contain the tests which need the most memory:\n \n ```\n-src/sage/matrix/matrix_integer_dense.pyx\n-src/sage/rings/polynomial/pbori.pyx\n src/sage/game_theory/matching_game.py\n-src/sage/rings/integer.pyx\n+src/sage/schemes/elliptic_curves/heegner.py\n ```\n-The one requiring the most memory is `src/sage/game_theory/matching_game.py`\n``````\n",
    "created_at": "2017-09-04T09:50:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358284",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -3,12 +3,9 @@
 2. It is good to check that doctests do not use a large amount of memory.
 3. It allows to doctest graceful recovery when memory cannot be allocated by intentionally allocating more memory than available.
 
-I suggest to limit the virtual memory for doctests to 4500MiB. This may seem like a lot, but these doctests do not pass with a limit of 4000MiB:
+I suggest to limit the virtual memory for doctests. The following two files contain the tests which need the most memory:
 
 ```
-src/sage/matrix/matrix_integer_dense.pyx
-src/sage/rings/polynomial/pbori.pyx
 src/sage/game_theory/matching_game.py
-src/sage/rings/integer.pyx
+src/sage/schemes/elliptic_curves/heegner.py
 ```
-The one requiring the most memory is `src/sage/game_theory/matching_game.py`
``````




---

archive/issue_comments_358285.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nNew attempt, this time limiting the memory in the `sage-runtests` script. Let's see what the patchbot says...",
    "created_at": "2017-09-04T09:50:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358285",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:25" align="right">comment:25</div>

New attempt, this time limiting the memory in the `sage-runtests` script. Let's see what the patchbot says...



---

archive/issue_events_330122.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-09-04T09:50:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23748#event-330122"
}
```



---

archive/issue_events_330123.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-09-04T09:50:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23748#event-330123"
}
```



---

archive/issue_comments_358286.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nHmm, patchbots won't test this because it's \"unsafe\".",
    "created_at": "2017-09-05T08:42:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358286",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:26" align="right">comment:26</div>

Hmm, patchbots won't test this because it's "unsafe".



---

archive/issue_comments_358287.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nIn case it helps, I did test this on `sardonis` (ppc64le with lots of RAM) and on my laptop (`x86_64` with 6GB of RAM) and it passed tests. 32-bit should also pass for the simple reason that the condition `memlimit <= sys.maxsize()` will be false.\n\nI just got hit again by the issue of doctests taking infinite memory, apparently this creates an infinite list:\n\n```\nsage: L = [1, 2, 3]\nsage: L.extend(-x for x in L)\n```\n\nI'm just saying that this ticket protects against stupid mistakes like this, which might otherwise cause the system to start to swap and become unresponsive.",
    "created_at": "2017-09-05T08:45:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358287",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:27" align="right">comment:27</div>

In case it helps, I did test this on `sardonis` (ppc64le with lots of RAM) and on my laptop (`x86_64` with 6GB of RAM) and it passed tests. 32-bit should also pass for the simple reason that the condition `memlimit <= sys.maxsize()` will be false.

I just got hit again by the issue of doctests taking infinite memory, apparently this creates an infinite list:

```
sage: L = [1, 2, 3]
sage: L.extend(-x for x in L)
```

I'm just saying that this ticket protects against stupid mistakes like this, which might otherwise cause the system to start to swap and become unresponsive.



---

archive/issue_events_330124.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2017-09-05T14:00:12Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23748#event-330124"
}
```



---

archive/issue_events_330125.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2017-09-05T14:00:12Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23748#event-330125"
}
```



---

archive/issue_comments_358288.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nReplying to [@jdemeyer](#comment:27):\n> In case it helps, I did test this on `sardonis` (ppc64le with lots of RAM) and on my laptop (`x86_64` with 6GB of RAM) and it passed tests. 32-bit should also pass for the simple reason that the condition `memlimit <= sys.maxsize()` will be false.\n\nEverything seems to be okay on my laptop as well (`x86_64` with 8Gb of RAM).\n\n> I just got hit again by the issue of doctests taking infinite memory, apparently this creates an infinite list:\n> \n> ```\n> sage: L = [1, 2, 3]\n> sage: L.extend(-x for x in L)\n> ```\n\nI'm actually slightly surprised Python doesn't catch that as it does so well (sometimes too well) with mutating `dict`s.\n\n> I'm just saying that this ticket protects against stupid mistakes like this, which might otherwise cause the system to start to swap and become unresponsive.\n\nIndeed. Let's kick this to the buildbots and into a beta to see if this causes any trouble.",
    "created_at": "2017-09-05T14:00:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358288",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:28" align="right">comment:28</div>

Replying to [@jdemeyer](#comment:27):
> In case it helps, I did test this on `sardonis` (ppc64le with lots of RAM) and on my laptop (`x86_64` with 6GB of RAM) and it passed tests. 32-bit should also pass for the simple reason that the condition `memlimit <= sys.maxsize()` will be false.

Everything seems to be okay on my laptop as well (`x86_64` with 8Gb of RAM).

> I just got hit again by the issue of doctests taking infinite memory, apparently this creates an infinite list:
> 
> ```
> sage: L = [1, 2, 3]
> sage: L.extend(-x for x in L)
> ```

I'm actually slightly surprised Python doesn't catch that as it does so well (sometimes too well) with mutating `dict`s.

> I'm just saying that this ticket protects against stupid mistakes like this, which might otherwise cause the system to start to swap and become unresponsive.

Indeed. Let's kick this to the buildbots and into a beta to see if this causes any trouble.



---

archive/issue_comments_358289.json:
```json
{
    "body": "Reviewer: **Travis Scrimshaw**",
    "created_at": "2017-09-05T14:00:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358289",
    "user": "https://github.com/tscrim"
}
```

Reviewer: **Travis Scrimshaw**



---

archive/issue_events_330126.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-09-06T17:49:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23748#event-330126"
}
```



---

archive/issue_events_330127.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-09-06T17:49:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23748#event-330127"
}
```



---

archive/issue_comments_358290.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nI'm getting \n\n```\nsage -t --warn-long 69.8 src/sage/game_theory/matching_game.py\n**********************************************************************\nFile \"src/sage/game_theory/matching_game.py\", line 161, in sage.game_theory.matching_game.MatchingGame\nFailed example:\n    revr_preferences = list(permutations([i+1 for i in range(n)]))\nException raised:\n    Traceback (most recent call last):\n      File \"/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 515, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 885, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.game_theory.matching_game.MatchingGame[17]>\", line 1, in <module>\n        revr_preferences = list(permutations([i+Integer(1) for i in range(n)]))\n    MemoryError\n```\nHere n=10, so 10! permutations...\n\nPS: This is x86_64 with 32GB ram",
    "created_at": "2017-09-06T17:49:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358290",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:29" align="right">comment:29</div>

I'm getting 

```
sage -t --warn-long 69.8 src/sage/game_theory/matching_game.py
**********************************************************************
File "src/sage/game_theory/matching_game.py", line 161, in sage.game_theory.matching_game.MatchingGame
Failed example:
    revr_preferences = list(permutations([i+1 for i in range(n)]))
Exception raised:
    Traceback (most recent call last):
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.game_theory.matching_game.MatchingGame[17]>", line 1, in <module>
        revr_preferences = list(permutations([i+Integer(1) for i in range(n)]))
    MemoryError
```
Here n=10, so 10! permutations...

PS: This is x86_64 with 32GB ram



---

archive/issue_comments_358291.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nSame as Volker. Also x86_64 with 32GB (although `free` says 12GB are free and 25GB available).",
    "created_at": "2017-09-06T21:18:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358291",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:30" align="right">comment:30</div>

Same as Volker. Also x86_64 with 32GB (although `free` says 12GB are free and 25GB available).



---

archive/issue_comments_358292.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nReplying to [@vbraun](#comment:29):\n> I'm getting \n> \n> ```\n> sage -t --warn-long 69.8 src/sage/game_theory/matching_game.py\n> **********************************************************************\n> File \"src/sage/game_theory/matching_game.py\", line 161, in sage.game_theory.matching_game.MatchingGame\n> Failed example:\n>     revr_preferences = list(permutations([i+1 for i in range(n)]))\n> Exception raised:\n>     Traceback (most recent call last):\n>       File \"/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 515, in _run\n>         self.compile_and_execute(example, compiler, test.globs)\n>       File \"/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 885, in compile_and_execute\n>         exec(compiled, globs)\n>       File \"<doctest sage.game_theory.matching_game.MatchingGame[17]>\", line 1, in <module>\n>         revr_preferences = list(permutations([i+Integer(1) for i in range(n)]))\n>     MemoryError\n> ```\n\nDid you run all doctests? Is this the only file which fails?",
    "created_at": "2017-09-06T21:24:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358292",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:31" align="right">comment:31</div>

Replying to [@vbraun](#comment:29):
> I'm getting 
> 
> ```
> sage -t --warn-long 69.8 src/sage/game_theory/matching_game.py
> **********************************************************************
> File "src/sage/game_theory/matching_game.py", line 161, in sage.game_theory.matching_game.MatchingGame
> Failed example:
>     revr_preferences = list(permutations([i+1 for i in range(n)]))
> Exception raised:
>     Traceback (most recent call last):
>       File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
>         self.compile_and_execute(example, compiler, test.globs)
>       File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
>         exec(compiled, globs)
>       File "<doctest sage.game_theory.matching_game.MatchingGame[17]>", line 1, in <module>
>         revr_preferences = list(permutations([i+Integer(1) for i in range(n)]))
>     MemoryError
> ```

Did you run all doctests? Is this the only file which fails?



---

archive/issue_comments_358293.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nFull failure\n\n```\nsage -t --long /usr/lib64/python2.7/site-packages/sage/game_theory/matching_game.py\n**********************************************************************\nFile \"/usr/lib64/python2.7/site-packages/sage/game_theory/matching_game.py\", line 161, in sage.game_theory.matching_game.MatchingGame\nFailed example:\n    revr_preferences = list(permutations([i+1 for i in range(n)]))\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib64/python2.7/site-packages/sage/doctest/forker.py\", line 518, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib64/python2.7/site-packages/sage/doctest/forker.py\", line 888, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.game_theory.matching_game.MatchingGame[17]>\", line 1, in <module>\n        revr_preferences = list(permutations([i+Integer(1) for i in range(n)]))\n    MemoryError\n**********************************************************************\nFile \"/usr/lib64/python2.7/site-packages/sage/game_theory/matching_game.py\", line 162, in sage.game_theory.matching_game.MatchingGame\nFailed example:\n    for player in range(n):\n        big_game.suitors()[player].pref = suitr_preferences[player]\n        big_game.reviewers()[player].pref = revr_preferences[-player]\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib64/python2.7/site-packages/sage/doctest/forker.py\", line 518, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib64/python2.7/site-packages/sage/doctest/forker.py\", line 888, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.game_theory.matching_game.MatchingGame[18]>\", line 3, in <module>\n        big_game.reviewers()[player].pref = revr_preferences[-player]\n    NameError: name 'revr_preferences' is not defined\n**********************************************************************\nFile \"/usr/lib64/python2.7/site-packages/sage/game_theory/matching_game.py\", line 165, in sage.game_theory.matching_game.MatchingGame\nFailed example:\n    big_game.solve()\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib64/python2.7/site-packages/sage/doctest/forker.py\", line 518, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib64/python2.7/site-packages/sage/doctest/forker.py\", line 888, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.game_theory.matching_game.MatchingGame[19]>\", line 1, in <module>\n        big_game.solve()\n      File \"/usr/lib64/python2.7/site-packages/sage/game_theory/matching_game.py\", line 901, in solve\n        self._is_complete()\n      File \"/usr/lib64/python2.7/site-packages/sage/game_theory/matching_game.py\", line 668, in _is_complete\n        raise ValueError(\"suitor preferences are not complete\")\n    ValueError: suitor preferences are not complete\n**********************************************************************\n```\nI cannot talk for Volker but this is the only file for which I have a failure related to this ticket. The other failure I got was [#23497 comment:39](https://github.com/sagemath/sage/issues/23497#comment:39)",
    "created_at": "2017-09-06T21:42:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358293",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:32" align="right">comment:32</div>

Full failure

```
sage -t --long /usr/lib64/python2.7/site-packages/sage/game_theory/matching_game.py
**********************************************************************
File "/usr/lib64/python2.7/site-packages/sage/game_theory/matching_game.py", line 161, in sage.game_theory.matching_game.MatchingGame
Failed example:
    revr_preferences = list(permutations([i+1 for i in range(n)]))
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 518, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 888, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.game_theory.matching_game.MatchingGame[17]>", line 1, in <module>
        revr_preferences = list(permutations([i+Integer(1) for i in range(n)]))
    MemoryError
**********************************************************************
File "/usr/lib64/python2.7/site-packages/sage/game_theory/matching_game.py", line 162, in sage.game_theory.matching_game.MatchingGame
Failed example:
    for player in range(n):
        big_game.suitors()[player].pref = suitr_preferences[player]
        big_game.reviewers()[player].pref = revr_preferences[-player]
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 518, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 888, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.game_theory.matching_game.MatchingGame[18]>", line 3, in <module>
        big_game.reviewers()[player].pref = revr_preferences[-player]
    NameError: name 'revr_preferences' is not defined
**********************************************************************
File "/usr/lib64/python2.7/site-packages/sage/game_theory/matching_game.py", line 165, in sage.game_theory.matching_game.MatchingGame
Failed example:
    big_game.solve()
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 518, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 888, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.game_theory.matching_game.MatchingGame[19]>", line 1, in <module>
        big_game.solve()
      File "/usr/lib64/python2.7/site-packages/sage/game_theory/matching_game.py", line 901, in solve
        self._is_complete()
      File "/usr/lib64/python2.7/site-packages/sage/game_theory/matching_game.py", line 668, in _is_complete
        raise ValueError("suitor preferences are not complete")
    ValueError: suitor preferences are not complete
**********************************************************************
```
I cannot talk for Volker but this is the only file for which I have a failure related to this ticket. The other failure I got was [#23497 comment:39](https://github.com/sagemath/sage/issues/23497#comment:39)



---

archive/issue_comments_358294.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nThats the only file that failed for me, too",
    "created_at": "2017-09-06T22:12:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358294",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:33" align="right">comment:33</div>

Thats the only file that failed for me, too



---

archive/issue_comments_358295.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nIf you both have only that file failing, it's a good reason to revisit those doctests after all and make them use less memory.",
    "created_at": "2017-09-07T10:31:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358295",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:34" align="right">comment:34</div>

If you both have only that file failing, it's a good reason to revisit those doctests after all and make them use less memory.



---

archive/issue_comments_358296.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nBut it didn't fail before this ticket and this ticket doesn't touch this particular file.",
    "created_at": "2017-09-07T10:35:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358296",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:35" align="right">comment:35</div>

But it didn't fail before this ticket and this ticket doesn't touch this particular file.



---

archive/issue_comments_358297.json:
```json
{
    "body": "Changed commit from **[`38f9823`](https://github.com/sagemath/sagetrac-mirror/commit/38f982331680d86b3ddafbb40f58ebd63df6719b)** to **[`06d4307`](https://github.com/sagemath/sagetrac-mirror/commit/06d43071962808d1d8adf6d527a4e762f34290b5)**",
    "created_at": "2017-09-07T11:08:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358297",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`38f9823`](https://github.com/sagemath/sagetrac-mirror/commit/38f982331680d86b3ddafbb40f58ebd63df6719b)** to **[`06d4307`](https://github.com/sagemath/sagetrac-mirror/commit/06d43071962808d1d8adf6d527a4e762f34290b5)**



---

archive/issue_comments_358298.json:
```json
{
    "body": "<div id=\"comment:36\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/06d43071962808d1d8adf6d527a4e762f34290b5\">06d4307</a></td><td><code>Simplify doctest in matching_game.py</code></td></tr></table>\n",
    "created_at": "2017-09-07T11:08:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358298",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:36"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/06d43071962808d1d8adf6d527a4e762f34290b5">06d4307</a></td><td><code>Simplify doctest in matching_game.py</code></td></tr></table>




---

archive/issue_events_330128.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-09-07T11:10:27Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23748#event-330128"
}
```



---

archive/issue_events_330129.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-09-07T11:10:27Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23748#event-330129"
}
```



---

archive/issue_comments_358299.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nReplying to [@kiwifb](#comment:35):\n> But it didn't fail before this ticket and this ticket doesn't touch this particular file.\n\nThe point of this ticket is to limit the amount of memory that doctests are allowed to use. Apparently `matching_game.py` is the file which uses the most memory of all doctests. There is no reason why the testcase in the `matching_game.py` doctests must be so large. I just simplified that.",
    "created_at": "2017-09-07T11:10:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358299",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:37" align="right">comment:37</div>

Replying to [@kiwifb](#comment:35):
> But it didn't fail before this ticket and this ticket doesn't touch this particular file.

The point of this ticket is to limit the amount of memory that doctests are allowed to use. Apparently `matching_game.py` is the file which uses the most memory of all doctests. There is no reason why the testcase in the `matching_game.py` doctests must be so large. I just simplified that.



---

archive/issue_comments_358300.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nReplying to [@kiwifb](#comment:35):\n> But it didn't fail before this ticket and this ticket doesn't touch this particular file.\n\nSo what would you suggest instead? Simply increasing the limit from 3300 MiB to some higher number?",
    "created_at": "2017-09-10T09:52:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358300",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:38" align="right">comment:38</div>

Replying to [@kiwifb](#comment:35):
> But it didn't fail before this ticket and this ticket doesn't touch this particular file.

So what would you suggest instead? Simply increasing the limit from 3300 MiB to some higher number?



---

archive/issue_comments_358301.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nReplying to [@jdemeyer](#comment:38):\n> Replying to [@kiwifb](#comment:35):\n> > But it didn't fail before this ticket and this ticket doesn't touch this particular file.\n\n> \n> So what would you suggest instead? Simply increasing the limit from 3300 MiB to some higher number?\n\nNo, after reading the description again properly, the fact that it passed before for me is irrelevant to what you try to achieve. I'll put it back to positive review to send it back to the bots.",
    "created_at": "2017-09-10T09:54:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358301",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:39" align="right">comment:39</div>

Replying to [@jdemeyer](#comment:38):
> Replying to [@kiwifb](#comment:35):
> > But it didn't fail before this ticket and this ticket doesn't touch this particular file.

> 
> So what would you suggest instead? Simply increasing the limit from 3300 MiB to some higher number?

No, after reading the description again properly, the fact that it passed before for me is irrelevant to what you try to achieve. I'll put it back to positive review to send it back to the bots.



---

archive/issue_events_330130.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2017-09-10T09:54:49Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23748#event-330130"
}
```



---

archive/issue_events_330131.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2017-09-10T09:54:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23748#event-330131"
}
```



---

archive/issue_comments_358302.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -9,3 +9,5 @@\n src/sage/game_theory/matching_game.py\n src/sage/schemes/elliptic_curves/heegner.py\n ```\n+\n+This branch also reduces the memory needed for `matching_game.py`, such that `heegner.py` is now the doctest which requires the most memory.\n``````\n",
    "created_at": "2017-09-10T15:32:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358302",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -9,3 +9,5 @@
 src/sage/game_theory/matching_game.py
 src/sage/schemes/elliptic_curves/heegner.py
 ```
+
+This branch also reduces the memory needed for `matching_game.py`, such that `heegner.py` is now the doctest which requires the most memory.
``````




---

archive/issue_comments_358303.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\nThanks!",
    "created_at": "2017-09-10T15:32:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358303",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:41" align="right">comment:41</div>

Thanks!



---

archive/issue_comments_358304.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nNow I get this on Volker's develop branch\n\n```\nsage -t --long /usr/lib64/python2.7/site-packages/sage/rings/integer.pyx\n**********************************************************************\nFile \"/usr/lib64/python2.7/site-packages/sage/rings/integer.pyx\", line 2828, in sage.rings.integer.Integer.divisors\nFailed example:\n    for i in range(20):  # long time\n        try:\n            alarm(RDF.random_element(1e-3, 0.5))\n            _ = n.divisors()\n            cancel_alarm()  # we never get here\n        except AlarmInterrupt:\n            pass\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib64/python2.7/site-packages/sage/doctest/forker.py\", line 518, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib64/python2.7/site-packages/sage/doctest/forker.py\", line 888, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.rings.integer.Integer.divisors[19]>\", line 4, in <module>\n        _ = n.divisors()\n      File \"sage/rings/integer.pyx\", line 2897, in sage.rings.integer.Integer.divisors (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/rings/integer.c:19409)\n        ptr = <unsigned long*>check_allocarray(divisor_count, 3 * sizeof(unsigned long))\n      File \"memory.pxd\", line 87, in cysignals.memory.check_allocarray (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/rings/integer.c:45630)\n    MemoryError: failed to allocate 33554432 * 24 bytes\n**********************************************************************\n```\nI have another failure in that file that is not related to memory, so there is probably problems with other tickets touching that file. I'll see if I can find out which one(s).",
    "created_at": "2017-09-11T09:04:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358304",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:42" align="right">comment:42</div>

Now I get this on Volker's develop branch

```
sage -t --long /usr/lib64/python2.7/site-packages/sage/rings/integer.pyx
**********************************************************************
File "/usr/lib64/python2.7/site-packages/sage/rings/integer.pyx", line 2828, in sage.rings.integer.Integer.divisors
Failed example:
    for i in range(20):  # long time
        try:
            alarm(RDF.random_element(1e-3, 0.5))
            _ = n.divisors()
            cancel_alarm()  # we never get here
        except AlarmInterrupt:
            pass
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 518, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 888, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.integer.Integer.divisors[19]>", line 4, in <module>
        _ = n.divisors()
      File "sage/rings/integer.pyx", line 2897, in sage.rings.integer.Integer.divisors (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/rings/integer.c:19409)
        ptr = <unsigned long*>check_allocarray(divisor_count, 3 * sizeof(unsigned long))
      File "memory.pxd", line 87, in cysignals.memory.check_allocarray (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/rings/integer.c:45630)
    MemoryError: failed to allocate 33554432 * 24 bytes
**********************************************************************
```
I have another failure in that file that is not related to memory, so there is probably problems with other tickets touching that file. I'll see if I can find out which one(s).



---

archive/issue_events_330132.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-09-11T13:47:16Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23748#event-330132"
}
```



---

archive/issue_events_330133.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "a98fc524f05325bc1f06cd186e4976ccfdba75db",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2017-09-11T13:47:16Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23748#event-330133"
}
```



---

archive/issue_comments_358305.json:
```json
{
    "body": "Changed branch from **[u/jdemeyer/run_doctests_with_limited_memory](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/run_doctests_with_limited_memory)** to **[`06d4307`](https://github.com/sagemath/sagetrac-mirror/commit/06d43071962808d1d8adf6d527a4e762f34290b5)**",
    "created_at": "2017-09-11T13:47:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358305",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/jdemeyer/run_doctests_with_limited_memory](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/run_doctests_with_limited_memory)** to **[`06d4307`](https://github.com/sagemath/sagetrac-mirror/commit/06d43071962808d1d8adf6d527a4e762f34290b5)**



---

archive/issue_comments_358306.json:
```json
{
    "body": "Changed commit from **[`06d4307`](https://github.com/sagemath/sagetrac-mirror/commit/06d43071962808d1d8adf6d527a4e762f34290b5)** to none",
    "created_at": "2017-10-20T08:40:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358306",
    "user": "https://github.com/videlec"
}
```

Changed commit from **[`06d4307`](https://github.com/sagemath/sagetrac-mirror/commit/06d43071962808d1d8adf6d527a4e762f34290b5)** to none



---

archive/issue_comments_358307.json:
```json
{
    "body": "<div id=\"comment:44\" align=\"right\">comment:44</div>\n\nCould this be the source of the problem in #24075?",
    "created_at": "2017-10-20T08:40:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358307",
    "user": "https://github.com/videlec"
}
```

<div id="comment:44" align="right">comment:44</div>

Could this be the source of the problem in #24075?



---

archive/issue_comments_358308.json:
```json
{
    "body": "<div id=\"comment:45\" align=\"right\">comment:45</div>\n\nReplying to [@videlec](#comment:44):\n> Could this be the source of the problem in #24075?\n\nI wouldn't think so but if you can repeat the failure you can just comment those two lines in `sage-runtests`\n\n```\n        if lim == resource.RLIM_INFINITY or lim > memlimit:\n            resource.setrlimit(resource.RLIMIT_AS, (memlimit, hard))\n```\nand see if it improves things.",
    "created_at": "2017-10-20T08:52:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358308",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:45" align="right">comment:45</div>

Replying to [@videlec](#comment:44):
> Could this be the source of the problem in #24075?

I wouldn't think so but if you can repeat the failure you can just comment those two lines in `sage-runtests`

```
        if lim == resource.RLIM_INFINITY or lim > memlimit:
            resource.setrlimit(resource.RLIMIT_AS, (memlimit, hard))
```
and see if it improves things.



---

archive/issue_comments_358309.json:
```json
{
    "body": "<div id=\"comment:46\" align=\"right\">comment:46</div>\n\nReplying to [@videlec](#comment:44):\n> Could this be the source of the problem in #24075?\n\nThat would be very surprising. How can runnning doctests with limited memory make something work accidentally?",
    "created_at": "2017-10-20T09:38:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23748#issuecomment-358309",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:46" align="right">comment:46</div>

Replying to [@videlec](#comment:44):
> Could this be the source of the problem in #24075?

That would be very surprising. How can runnning doctests with limited memory make something work accidentally?
