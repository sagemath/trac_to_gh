# Issue 23739: Conversion failure ℚ[√a] → CIF

archive/issues_023502.json:
```json
{
    "assignees": [],
    "body": "An issue found by Victor Spitzer:\n\n```\nsage: NF.<a> = QuadraticField(-2)\nsage: CIF(a)\n...\nValueError: can not convert complex algebraic number to real interval\n```\n\nBranch/Commit: **[public/rings/conversions_to_CIF-23739](https://github.com/sagemath/sagetrac-mirror/tree/public/rings/conversions_to_CIF-23739) @ [`f2bc7fc`](https://github.com/sagemath/sagetrac-mirror/commit/f2bc7fc50cf1338f0cefca315b1c15cd1d6162b9)**\n\nReviewer: **Travis Scrimshaw**\n\nAuthor: **Maarten Derickx**\n\nComponent: **numerical**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/23739_\n\n",
    "closed_at": "2018-05-18T17:16:26Z",
    "created_at": "2017-08-28T19:37:51Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/bug",
        "https://github.com/sagemath/sage/labels/c%3A%20numerical",
        "https://github.com/sagemath/sage/labels/wontfix"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Conversion failure \u211a[\u221aa] \u2192 CIF",
    "type": "issue",
    "updated_at": "2018-05-18T17:16:26Z",
    "url": "https://github.com/sagemath/sage/issues/23739",
    "user": "https://github.com/mezzarobba"
}
```
An issue found by Victor Spitzer:

```
sage: NF.<a> = QuadraticField(-2)
sage: CIF(a)
...
ValueError: can not convert complex algebraic number to real interval
```

Branch/Commit: **[public/rings/conversions_to_CIF-23739](https://github.com/sagemath/sagetrac-mirror/tree/public/rings/conversions_to_CIF-23739) @ [`f2bc7fc`](https://github.com/sagemath/sagetrac-mirror/commit/f2bc7fc50cf1338f0cefca315b1c15cd1d6162b9)**

Reviewer: **Travis Scrimshaw**

Author: **Maarten Derickx**

Component: **numerical**

_Issue created by migration from https://trac.sagemath.org/ticket/23739_





---

archive/issue_events_327142.json:
```json
{
    "actor": "https://github.com/mezzarobba",
    "created_at": "2017-08-28T19:37:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "milestone_number": null,
    "milestone_title": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23739#event-327142"
}
```



---

archive/issue_events_327143.json:
```json
{
    "actor": "https://github.com/mezzarobba",
    "created_at": "2017-08-28T19:37:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20numerical",
    "label_color": "0000ff",
    "label_name": "c: numerical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23739#event-327143"
}
```



---

archive/issue_events_327144.json:
```json
{
    "actor": "https://github.com/mezzarobba",
    "created_at": "2017-08-28T19:37:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23739#event-327144"
}
```



---

archive/issue_events_327145.json:
```json
{
    "actor": "https://github.com/mezzarobba",
    "created_at": "2017-08-28T19:37:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23739#event-327145"
}
```



---

archive/issue_comments_358031.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,7 +1,7 @@\n \n ```\n sage: NF.<a> = QuadraticField(-2)\n-sage: CIF(a/4)\n+sage: CIF(a)\n ...\n ValueError: can not convert complex algebraic number to real interval\n ```\n``````\n",
    "created_at": "2017-08-28T19:39:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23739#issuecomment-358031",
    "user": "https://github.com/mezzarobba"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,7 +1,7 @@
 
 ```
 sage: NF.<a> = QuadraticField(-2)
-sage: CIF(a/4)
+sage: CIF(a)
 ...
 ValueError: can not convert complex algebraic number to real interval
 ```
``````




---

archive/issue_comments_358032.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,4 @@\n+An issue found by Victor Spitzer:\n \n ```\n sage: NF.<a> = QuadraticField(-2)\n``````\n",
    "created_at": "2017-08-28T19:46:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23739#issuecomment-358032",
    "user": "https://github.com/mezzarobba"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,4 @@
+An issue found by Victor Spitzer:
 
 ```
 sage: NF.<a> = QuadraticField(-2)
``````




---

archive/issue_comments_358033.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nFirst I thought this was because there was no convert or coerce map registered. But apparently the coercion framework is not even called in this conversion, because the coercion framework works without problems!\n\n```\nsage: NF.<a> = QuadraticField(-2)\nsage: CIF.coerce_map_from(NF)\nComposite map:\n  From: Number Field in a with defining polynomial x^2 + 2\n  To:   Complex Interval Field with 53 bits of precision\n  Defn:   Generic morphism:\n          From: Number Field in a with defining polynomial x^2 + 2\n          To:   Complex Lazy Field\n          Defn: a -> 1.414213562373095?*I\n        then\n          Call morphism:\n          From: Complex Lazy Field\n          To:   Complex Interval Field with 53 bits of precision\nsage: CIF.coerce_map_from(NF)(a)\n1.414213562373095?*I\n```",
    "created_at": "2017-09-01T14:07:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23739#issuecomment-358033",
    "user": "https://github.com/koffie"
}
```

<div id="comment:3" align="right">comment:3</div>

First I thought this was because there was no convert or coerce map registered. But apparently the coercion framework is not even called in this conversion, because the coercion framework works without problems!

```
sage: NF.<a> = QuadraticField(-2)
sage: CIF.coerce_map_from(NF)
Composite map:
  From: Number Field in a with defining polynomial x^2 + 2
  To:   Complex Interval Field with 53 bits of precision
  Defn:   Generic morphism:
          From: Number Field in a with defining polynomial x^2 + 2
          To:   Complex Lazy Field
          Defn: a -> 1.414213562373095?*I
        then
          Call morphism:
          From: Complex Lazy Field
          To:   Complex Interval Field with 53 bits of precision
sage: CIF.coerce_map_from(NF)(a)
1.414213562373095?*I
```



---

archive/issue_comments_358034.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nThe problem is that CIF implements its own `__call__` function instead of providing an `_element_constructor_` method",
    "created_at": "2017-09-01T14:13:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23739#issuecomment-358034",
    "user": "https://github.com/koffie"
}
```

<div id="comment:4" align="right">comment:4</div>

The problem is that CIF implements its own `__call__` function instead of providing an `_element_constructor_` method



---

archive/issue_comments_358035.json:
```json
{
    "body": "Branch: **[u/mderickx/23739](https://github.com/sagemath/sagetrac-mirror/tree/u/mderickx/23739)**",
    "created_at": "2017-09-02T03:25:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23739#issuecomment-358035",
    "user": "https://github.com/koffie"
}
```

Branch: **[u/mderickx/23739](https://github.com/sagemath/sagetrac-mirror/tree/u/mderickx/23739)**



---

archive/issue_events_327146.json:
```json
{
    "actor": "https://github.com/koffie",
    "created_at": "2017-09-02T03:25:28Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23739#event-327146"
}
```



---

archive/issue_comments_358036.json:
```json
{
    "body": "Author: **Maarten Derickx**",
    "created_at": "2017-09-02T03:25:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23739#issuecomment-358036",
    "user": "https://github.com/koffie"
}
```

Author: **Maarten Derickx**



---

archive/issue_comments_358037.json:
```json
{
    "body": "<div id=\"comment:5\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d360262afd0929ea9334761ec5035323fa4d665d\"><code>d360262</code></a></td><td><code>trac #23739: Make ComplexIntervalField use new coercion framework</code></td></tr></table>\n",
    "created_at": "2017-09-02T03:25:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23739#issuecomment-358037",
    "user": "https://github.com/koffie"
}
```

<div id="comment:5"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d360262afd0929ea9334761ec5035323fa4d665d"><code>d360262</code></a></td><td><code>trac #23739: Make ComplexIntervalField use new coercion framework</code></td></tr></table>




---

archive/issue_comments_358038.json:
```json
{
    "body": "Commit: **[`d360262`](https://github.com/sagemath/sagetrac-mirror/commit/d360262afd0929ea9334761ec5035323fa4d665d)**",
    "created_at": "2017-09-02T03:25:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23739#issuecomment-358038",
    "user": "https://github.com/koffie"
}
```

Commit: **[`d360262`](https://github.com/sagemath/sagetrac-mirror/commit/d360262afd0929ea9334761ec5035323fa4d665d)**



---

archive/issue_comments_358039.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nsee patchbot for an error",
    "created_at": "2017-09-02T06:21:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23739#issuecomment-358039",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:6" align="right">comment:6</div>

see patchbot for an error



---

archive/issue_comments_358040.json:
```json
{
    "body": "Changed commit from **[`d360262`](https://github.com/sagemath/sagetrac-mirror/commit/d360262afd0929ea9334761ec5035323fa4d665d)** to **[`f5a18fb`](https://github.com/sagemath/sagetrac-mirror/commit/f5a18fbcdd63848c8744549e86aa442a6c603ab5)**",
    "created_at": "2017-09-02T07:33:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23739#issuecomment-358040",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`d360262`](https://github.com/sagemath/sagetrac-mirror/commit/d360262afd0929ea9334761ec5035323fa4d665d)** to **[`f5a18fb`](https://github.com/sagemath/sagetrac-mirror/commit/f5a18fbcdd63848c8744549e86aa442a6c603ab5)**



---

archive/issue_comments_358041.json:
```json
{
    "body": "<div id=\"comment:7\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f5a18fbcdd63848c8744549e86aa442a6c603ab5\"><code>f5a18fb</code></a></td><td><code>trac #23739 fix doctest</code></td></tr></table>\n",
    "created_at": "2017-09-02T07:33:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23739#issuecomment-358041",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:7"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f5a18fbcdd63848c8744549e86aa442a6c603ab5"><code>f5a18fb</code></a></td><td><code>trac #23739 fix doctest</code></td></tr></table>




---

archive/issue_comments_358042.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nOk, the error is fixed. Sorry for letting that one slip by.",
    "created_at": "2017-09-02T07:36:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23739#issuecomment-358042",
    "user": "https://github.com/koffie"
}
```

<div id="comment:8" align="right">comment:8</div>

Ok, the error is fixed. Sorry for letting that one slip by.



---

archive/issue_comments_358043.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nThanks for your work on this ticket!\n\nI think it would be better to remove the `__call__()` method completely, unless there is a strong reason to keep it.\n\nAlso, I realized that I had an old branch lying around where I had started doing something similar (perhaps in view of #15114). I'm not sure why I didn't post it for review; I believe I stumbled upon issues related to #22029 and never got around to recycling the parts that could be. It would probably be worth comparing our approaches and taking the best of both. I don't really have time for that right now (perhaps next week...), but I've pushed my commits to `u/mmezzarobba/wip/intervals` in case you want to have a look.",
    "created_at": "2017-09-02T09:26:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23739#issuecomment-358043",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:9" align="right">comment:9</div>

Thanks for your work on this ticket!

I think it would be better to remove the `__call__()` method completely, unless there is a strong reason to keep it.

Also, I realized that I had an old branch lying around where I had started doing something similar (perhaps in view of #15114). I'm not sure why I didn't post it for review; I believe I stumbled upon issues related to #22029 and never got around to recycling the parts that could be. It would probably be worth comparing our approaches and taking the best of both. I don't really have time for that right now (perhaps next week...), but I've pushed my commits to `u/mmezzarobba/wip/intervals` in case you want to have a look.



---

archive/issue_comments_358044.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nI agree that removing  `__call__` would be nicer.  In fact I tried to remove `__call__` but handling the optional `im = ` parameter further down the chain was getting really messy, and still had some doctest failures that I couldn't figure out how to fix. So in the end I decided this was the cleanest solution. If you figure a nice way to deal with this in `_emelent_constructor` feel free to do it I just don't know how to do this in a clean way. Also I think the way it works now is also still quite clean, since in the case that `im = None` the current code behave exactly as if there where no `__call__` at all.\nP.s. it is not the first place where this happens, look for example at `CC.__call__`, this has very similar logic.",
    "created_at": "2017-09-04T21:12:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23739#issuecomment-358044",
    "user": "https://github.com/koffie"
}
```

<div id="comment:10" align="right">comment:10</div>

I agree that removing  `__call__` would be nicer.  In fact I tried to remove `__call__` but handling the optional `im = ` parameter further down the chain was getting really messy, and still had some doctest failures that I couldn't figure out how to fix. So in the end I decided this was the cleanest solution. If you figure a nice way to deal with this in `_emelent_constructor` feel free to do it I just don't know how to do this in a clean way. Also I think the way it works now is also still quite clean, since in the case that `im = None` the current code behave exactly as if there where no `__call__` at all.
P.s. it is not the first place where this happens, look for example at `CC.__call__`, this has very similar logic.



---

archive/issue_comments_358045.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nP.s. are you sure you pushed it? \n\n```\nbt-nac-c220:src mderickx$ git pull trac u/mmezzarobba/wip/intervals\nfatal: Couldn't find remote ref u/mmezzarobba/wip/intervals\n```\n\nAnd I don't seem to be able to find it between your other branches as listed on https://github.com/sagemath/sagetrac-mirror/branchesheads",
    "created_at": "2017-09-04T21:20:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23739#issuecomment-358045",
    "user": "https://github.com/koffie"
}
```

<div id="comment:11" align="right">comment:11</div>

P.s. are you sure you pushed it? 

```
bt-nac-c220:src mderickx$ git pull trac u/mmezzarobba/wip/intervals
fatal: Couldn't find remote ref u/mmezzarobba/wip/intervals
```

And I don't seem to be able to find it between your other branches as listed on https://github.com/sagemath/sagetrac-mirror/branchesheads



---

archive/issue_comments_358046.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@koffie](#comment%3A11):\n> P.s. are you sure you pushed it? \n\nOops, looks like I didn't indeed. Thanks for the notice!",
    "created_at": "2017-09-06T08:39:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23739#issuecomment-358046",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@koffie](#comment%3A11):
> P.s. are you sure you pushed it? 

Oops, looks like I didn't indeed. Thanks for the notice!



---

archive/issue_comments_358047.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nI disagree with the `__call__` sending things up to parent as a wrapped tuple. This makes the conversions from different CIF's slower because of the extra indirection, and I believe we should attempt to keep this a little more optimized. So I think it should immediately return the constructed element when `im is not None`. (Also, the `return ans` is superfluous.) Likewise, I disagree with the `CC.__call__` implementation, and since the last time that was modified was 2008, it might be good to revisit that code again as well.\n\nIf you still feel like the best way forward is to remove the `__call__`, then I can try to help figure out what is going on and what we can do going forward. I don't understand what you mean by this:\n\n> since in the case that `im = None` the current code behave exactly as if there where no `__call__` at all.\n\nAlso, any `Parent` has a default `an_element` that implements a (very old) caching by calling `_an_element_` (if it exists). So that code path could error out in a way that the initial checking is saying it should not.\n\nI would also put the `if is_ComplexIntervalField(S):` block first, but this is more of my personal preference as the code feels cleaner to me (so feel free to ignore it).\n\nThis might also be a good time to convert this from an old-style parent to new-style.",
    "created_at": "2017-09-10T05:59:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23739#issuecomment-358047",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:13" align="right">comment:13</div>

I disagree with the `__call__` sending things up to parent as a wrapped tuple. This makes the conversions from different CIF's slower because of the extra indirection, and I believe we should attempt to keep this a little more optimized. So I think it should immediately return the constructed element when `im is not None`. (Also, the `return ans` is superfluous.) Likewise, I disagree with the `CC.__call__` implementation, and since the last time that was modified was 2008, it might be good to revisit that code again as well.

If you still feel like the best way forward is to remove the `__call__`, then I can try to help figure out what is going on and what we can do going forward. I don't understand what you mean by this:

> since in the case that `im = None` the current code behave exactly as if there where no `__call__` at all.

Also, any `Parent` has a default `an_element` that implements a (very old) caching by calling `_an_element_` (if it exists). So that code path could error out in a way that the initial checking is saying it should not.

I would also put the `if is_ComplexIntervalField(S):` block first, but this is more of my personal preference as the code feels cleaner to me (so feel free to ignore it).

This might also be a good time to convert this from an old-style parent to new-style.



---

archive/issue_comments_358048.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@tscrim](#comment%3A13):\n> If you still feel like the best way forward is to remove the `__call__`, then I can try to help figure out what is going on and what we can do going forward.\n\nYes, I think removing the `__call__` method completely is the way forward. If we do implement a custom `__call__` we should really call the `__call__` of parent if `im = None` since otherwise we break coercion. And I solved the reported issue of this ticket by fixing coercion. However removing `__call__` completely would be even nicer since then we also have as little as possible overhead when `im = None`. I personally don't care to much about what happens if `im != None` so I don't mind calling another function more direct in this case.\n\n> I don't understand what you mean by this:\n> > since in the case that `im = None` the current code behave exactly as if there where no `__call__` at all.\n\n> \n\nWhat I mean by this is unrelated to performance issues, but more related to behaviour issues. In general one should not overwrite the `__call__` method because it breaks all the nice category and coercion stuff in sage.  So I made the `__call__`  method behave as much as possible as if it were not there by making the code behave as if there were no `__call__` at all if `im = None`.\n\n> Also, any `Parent` has a default `an_element` that implements a (very old) caching by calling `_an_element_` (if it exists). So that code path could error out in a way that the initial checking is saying it should not.\n> \n> I would also put the `if is_ComplexIntervalField(S):` block first, but this is more of my personal preference as the code feels cleaner to me (so feel free to ignore it).\n> \n> This might also be a good time to convert this from an old-style parent to new-style.\n\nYes I agree this is a good time to do this. What kind of things would be involved in this? I guess at least replacing this\n\n```\nParentWithGens.__init__(self, self._real_field(), ('I',), False, category = Fields())\n```\nin the `__init__` function of CIF with something else.",
    "created_at": "2017-09-10T16:11:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23739#issuecomment-358048",
    "user": "https://github.com/koffie"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@tscrim](#comment%3A13):
> If you still feel like the best way forward is to remove the `__call__`, then I can try to help figure out what is going on and what we can do going forward.

Yes, I think removing the `__call__` method completely is the way forward. If we do implement a custom `__call__` we should really call the `__call__` of parent if `im = None` since otherwise we break coercion. And I solved the reported issue of this ticket by fixing coercion. However removing `__call__` completely would be even nicer since then we also have as little as possible overhead when `im = None`. I personally don't care to much about what happens if `im != None` so I don't mind calling another function more direct in this case.

> I don't understand what you mean by this:
> > since in the case that `im = None` the current code behave exactly as if there where no `__call__` at all.

> 

What I mean by this is unrelated to performance issues, but more related to behaviour issues. In general one should not overwrite the `__call__` method because it breaks all the nice category and coercion stuff in sage.  So I made the `__call__`  method behave as much as possible as if it were not there by making the code behave as if there were no `__call__` at all if `im = None`.

> Also, any `Parent` has a default `an_element` that implements a (very old) caching by calling `_an_element_` (if it exists). So that code path could error out in a way that the initial checking is saying it should not.
> 
> I would also put the `if is_ComplexIntervalField(S):` block first, but this is more of my personal preference as the code feels cleaner to me (so feel free to ignore it).
> 
> This might also be a good time to convert this from an old-style parent to new-style.

Yes I agree this is a good time to do this. What kind of things would be involved in this? I guess at least replacing this

```
ParentWithGens.__init__(self, self._real_field(), ('I',), False, category = Fields())
```
in the `__init__` function of CIF with something else.



---

archive/issue_comments_358049.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nI looked a bit more into it. And I think that there is no nice way to git rid of `__call__`  and support the optional im argument, since it will be very difficult to have different code paths depending on wether `im` is provided or not. The only way I see this happening with the coercion framework is by forcing every coercion morphism into CIF to be a subclass of our own categories.map class which looks ugly. \n\nSo maybe I start being in favour of keeping the `__call__`. So am I correct in understanding that you will be happy if I leave the code if `im = None` as is and change the behaviour if `im != None` to:\n\n```\n    return self.element_class(x, im)\n```",
    "created_at": "2017-09-10T17:31:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23739#issuecomment-358049",
    "user": "https://github.com/koffie"
}
```

<div id="comment:15" align="right">comment:15</div>

I looked a bit more into it. And I think that there is no nice way to git rid of `__call__`  and support the optional im argument, since it will be very difficult to have different code paths depending on wether `im` is provided or not. The only way I see this happening with the coercion framework is by forcing every coercion morphism into CIF to be a subclass of our own categories.map class which looks ugly. 

So maybe I start being in favour of keeping the `__call__`. So am I correct in understanding that you will be happy if I leave the code if `im = None` as is and change the behaviour if `im != None` to:

```
    return self.element_class(x, im)
```



---

archive/issue_comments_358050.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nYes, what I am advocating for is this:\n\n```python\ndef __call__(self, x, im=None):\n    if im is None:\n        return super(ComplexIntervalField_class,self).__call__(x)\n    return complex_interval.ComplexIntervalFieldElement(self, (x, im))\n```\n\nFor removing the old-style parent, from a quick look, it looks like the following needs to be done:\n- change `ParentWithGens` to `Parent` (maybe adding one or two extra methods to keep functionality)\n- specify `Element = ComplexIntervalFieldElement`\n- replace explicit calls to `ComplexIntervalFieldElement(self, args)` by `self.element_class(self, args)`\n\nI am pretty sure you can use `_element_constructor_(self, x, im=None)`.\n\nSorry for the shorter responses and not contributing actual code right now, I'm in the process of moving.",
    "created_at": "2017-09-10T17:42:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23739#issuecomment-358050",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:16" align="right">comment:16</div>

Yes, what I am advocating for is this:

```python
def __call__(self, x, im=None):
    if im is None:
        return super(ComplexIntervalField_class,self).__call__(x)
    return complex_interval.ComplexIntervalFieldElement(self, (x, im))
```

For removing the old-style parent, from a quick look, it looks like the following needs to be done:
- change `ParentWithGens` to `Parent` (maybe adding one or two extra methods to keep functionality)
- specify `Element = ComplexIntervalFieldElement`
- replace explicit calls to `ComplexIntervalFieldElement(self, args)` by `self.element_class(self, args)`

I am pretty sure you can use `_element_constructor_(self, x, im=None)`.

Sorry for the shorter responses and not contributing actual code right now, I'm in the process of moving.



---

archive/issue_comments_358051.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@tscrim](#comment%3A16):\n> I am pretty sure you can use `_element_constructor_(self, x, im=None)`.\n\nThat was a little too brief. What I mean is that the `__call__` should redirect extra arguments to `_element_constructor_` in the natural python way. Although I'm still slightly in favor of the special `__call__`.",
    "created_at": "2017-09-10T17:45:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23739#issuecomment-358051",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@tscrim](#comment%3A16):
> I am pretty sure you can use `_element_constructor_(self, x, im=None)`.

That was a little too brief. What I mean is that the `__call__` should redirect extra arguments to `_element_constructor_` in the natural python way. Although I'm still slightly in favor of the special `__call__`.



---

archive/issue_comments_358052.json:
```json
{
    "body": "<div id=\"comment:18\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/074572de3f422cb251ace22fd728dc96700f1487\"><code>074572d</code></a></td><td><code>Merge sage 8.1.beta4 into 23739</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6d01b5d02d4b3c479c7119d5458631aef1341ea6\"><code>6d01b5d</code></a></td><td><code>Trac #23739: Make CIF into newstyle class</code></td></tr></table>\n",
    "created_at": "2017-09-10T23:06:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23739#issuecomment-358052",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:18"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/074572de3f422cb251ace22fd728dc96700f1487"><code>074572d</code></a></td><td><code>Merge sage 8.1.beta4 into 23739</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6d01b5d02d4b3c479c7119d5458631aef1341ea6"><code>6d01b5d</code></a></td><td><code>Trac #23739: Make CIF into newstyle class</code></td></tr></table>




---

archive/issue_comments_358053.json:
```json
{
    "body": "Changed commit from **[`f5a18fb`](https://github.com/sagemath/sagetrac-mirror/commit/f5a18fbcdd63848c8744549e86aa442a6c603ab5)** to **[`6d01b5d`](https://github.com/sagemath/sagetrac-mirror/commit/6d01b5d02d4b3c479c7119d5458631aef1341ea6)**",
    "created_at": "2017-09-10T23:06:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23739#issuecomment-358053",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`f5a18fb`](https://github.com/sagemath/sagetrac-mirror/commit/f5a18fbcdd63848c8744549e86aa442a6c603ab5)** to **[`6d01b5d`](https://github.com/sagemath/sagetrac-mirror/commit/6d01b5d02d4b3c479c7119d5458631aef1341ea6)**



---

archive/issue_comments_358054.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nOk I tried to address all your comments. Made a minor modification to `CC` as well. I did't turn it into a new style class since it seemed like this would be way more work then for `CIF`.",
    "created_at": "2017-09-10T23:17:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23739#issuecomment-358054",
    "user": "https://github.com/koffie"
}
```

<div id="comment:19" align="right">comment:19</div>

Ok I tried to address all your comments. Made a minor modification to `CC` as well. I did't turn it into a new style class since it seemed like this would be way more work then for `CIF`.



---

archive/issue_comments_358055.json:
```json
{
    "body": "Changed branch from **[u/mderickx/23739](https://github.com/sagemath/sagetrac-mirror/tree/u/mderickx/23739)** to **[public/rings/conversions_to_CIF-23739](https://github.com/sagemath/sagetrac-mirror/tree/public/rings/conversions_to_CIF-23739)**",
    "created_at": "2017-09-16T17:04:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23739#issuecomment-358055",
    "user": "https://github.com/tscrim"
}
```

Changed branch from **[u/mderickx/23739](https://github.com/sagemath/sagetrac-mirror/tree/u/mderickx/23739)** to **[public/rings/conversions_to_CIF-23739](https://github.com/sagemath/sagetrac-mirror/tree/public/rings/conversions_to_CIF-23739)**



---

archive/issue_comments_358056.json:
```json
{
    "body": "Changed commit from **[`6d01b5d`](https://github.com/sagemath/sagetrac-mirror/commit/6d01b5d02d4b3c479c7119d5458631aef1341ea6)** to **[`f2bc7fc`](https://github.com/sagemath/sagetrac-mirror/commit/f2bc7fc50cf1338f0cefca315b1c15cd1d6162b9)**",
    "created_at": "2017-09-16T17:04:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23739#issuecomment-358056",
    "user": "https://github.com/tscrim"
}
```

Changed commit from **[`6d01b5d`](https://github.com/sagemath/sagetrac-mirror/commit/6d01b5d02d4b3c479c7119d5458631aef1341ea6)** to **[`f2bc7fc`](https://github.com/sagemath/sagetrac-mirror/commit/f2bc7fc50cf1338f0cefca315b1c15cd1d6162b9)**



---

archive/issue_comments_358057.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nGreat, thank you. Looks good. A good followup will be making this use `UniqueRepresentation` instead of its own custom cache. However, that will probably be a bit more invasive of a change, so I think it is better as a separate ticket.\n\nI added a little more documentation for `_coerce_map_from_` to match what the code does. I also implemented coercions from `CC` to match the real version:\n\n```\nsage: RIF.coerce_map_from(RR)\nCall morphism:\n  From: Real Field with 53 bits of precision\n  To:   Real Interval Field with 53 bits of precision\n```\nThe rest of my changes are PEP8 and trivial formatting.\n\nIf my changes look good, then positive review.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5e4ee68231c0ec9f41062a3b10f1cb68068c1924\"><code>5e4ee68</code></a></td><td><code>Merge branch 'u/mderickx/23739' of git://trac.sagemath.org/sage into public/rings/conversions_to_CIF-23739</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c8c36c5d40731ba2d3a271e037e57947aedd6ec5\"><code>c8c36c5</code></a></td><td><code>Some minor reviewer tweaks.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f2bc7fc50cf1338f0cefca315b1c15cd1d6162b9\"><code>f2bc7fc</code></a></td><td><code>Adding CC coercion to match RIF and RR.</code></td></tr></table>\n",
    "created_at": "2017-09-16T17:04:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23739#issuecomment-358057",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:20" align="right">comment:20</div>

Great, thank you. Looks good. A good followup will be making this use `UniqueRepresentation` instead of its own custom cache. However, that will probably be a bit more invasive of a change, so I think it is better as a separate ticket.

I added a little more documentation for `_coerce_map_from_` to match what the code does. I also implemented coercions from `CC` to match the real version:

```
sage: RIF.coerce_map_from(RR)
Call morphism:
  From: Real Field with 53 bits of precision
  To:   Real Interval Field with 53 bits of precision
```
The rest of my changes are PEP8 and trivial formatting.

If my changes look good, then positive review.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5e4ee68231c0ec9f41062a3b10f1cb68068c1924"><code>5e4ee68</code></a></td><td><code>Merge branch 'u/mderickx/23739' of git://trac.sagemath.org/sage into public/rings/conversions_to_CIF-23739</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c8c36c5d40731ba2d3a271e037e57947aedd6ec5"><code>c8c36c5</code></a></td><td><code>Some minor reviewer tweaks.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f2bc7fc50cf1338f0cefca315b1c15cd1d6162b9"><code>f2bc7fc</code></a></td><td><code>Adding CC coercion to match RIF and RR.</code></td></tr></table>




---

archive/issue_comments_358058.json:
```json
{
    "body": "Reviewer: **Travis Scrimshaw**",
    "created_at": "2017-09-16T17:04:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23739#issuecomment-358058",
    "user": "https://github.com/tscrim"
}
```

Reviewer: **Travis Scrimshaw**



---

archive/issue_events_327147.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2017-10-20T20:13:24Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23739#event-327147"
}
```



---

archive/issue_events_327148.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2017-10-20T20:13:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23739#event-327148"
}
```



---

archive/issue_comments_358059.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nmany failing doctests",
    "created_at": "2017-10-20T20:13:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23739#issuecomment-358059",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:21" align="right">comment:21</div>

many failing doctests



---

archive/issue_comments_358060.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nMost of them should be trivial, but there are a few I don't know what is going on without investigating. Maarten, would you be willing to make the first attempt?\n\nAlso, I don't quite understand the change in `multi_polynomial.pyx`. Can you explain the rationale?",
    "created_at": "2017-10-23T04:13:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23739#issuecomment-358060",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:22" align="right">comment:22</div>

Most of them should be trivial, but there are a few I don't know what is going on without investigating. Maarten, would you be willing to make the first attempt?

Also, I don't quite understand the change in `multi_polynomial.pyx`. Can you explain the rationale?



---

archive/issue_events_327149.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-12-16T08:44:34Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "milestone_number": null,
    "milestone_title": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23739#event-327149"
}
```



---

archive/issue_comments_358061.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nI'll try to fix this ticket instead in #24371.",
    "created_at": "2017-12-16T08:44:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23739#issuecomment-358061",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:23" align="right">comment:23</div>

I'll try to fix this ticket instead in #24371.



---

archive/issue_events_327150.json:
```json
{
    "actor": "https://github.com/koffie",
    "created_at": "2017-12-16T10:32:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23739#event-327150"
}
```



---

archive/issue_events_327151.json:
```json
{
    "actor": "https://github.com/koffie",
    "created_at": "2017-12-16T10:32:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23739#event-327151"
}
```



---

archive/issue_comments_358062.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nSorry for not following up on this ticket after my initial attempt, thanks for fixing it in #24371. I agree that this then can be seen as duplicate.",
    "created_at": "2017-12-16T10:32:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23739#issuecomment-358062",
    "user": "https://github.com/koffie"
}
```

<div id="comment:24" align="right">comment:24</div>

Sorry for not following up on this ticket after my initial attempt, thanks for fixing it in #24371. I agree that this then can be seen as duplicate.



---

archive/issue_events_327152.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-05-18T17:16:26Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23739#event-327152"
}
```



---

archive/issue_events_327153.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-05-18T17:16:26Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23739#event-327153"
}
```



---

archive/issue_events_327154.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-05-18T17:16:26Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23739#event-327154"
}
```



---

archive/issue_events_327155.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-05-18T17:16:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "label": "https://github.com/sagemath/sage/labels/wontfix",
    "label_color": "c6c6c6",
    "label_name": "wontfix",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23739#event-327155"
}
```



---

archive/issue_comments_358063.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nclosing positively reviewed duplicates",
    "created_at": "2018-05-18T17:16:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23739",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23739#issuecomment-358063",
    "user": "https://github.com/videlec"
}
```

<div id="comment:25" align="right">comment:25</div>

closing positively reviewed duplicates
