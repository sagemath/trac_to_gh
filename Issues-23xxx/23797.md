# Issue 23797: Cygwin: openblas does not install correctly

archive/issues_023560.json:
```json
{
    "body": "For most of the time I've worked on Cygwin, I've been building with Cygwin's system BLAS (which I don't think is actually ATLAS, but using `--with-blas=atlas` and the appropriate `SAGE_ATLAS_LIB` picks it up and runs with it).\n\nRecently I had to restart the Cygwin patchbot and forgot to configure it with these settings, so it built openblas (which seems to build successfully) but then grinds to a halt.  I think I was already aware there were problems like this with openblas and just didn't deal with it since there was a good workaround.  Still, it should be fixed.\n\nThe problem in scipy is that it simply fails to detect a BLAS library during its `setup.py egg_info`.\n\nSimilarly, gsl fails at configure time with:\n\n```\n[gsl-2.3] checking whether the C compiler works... no\n[gsl-2.3] configure: error: in `/home/Admin/src/sagemath/sage/local/var/tmp/sage/build/gsl-2.3/src':\n[gsl-2.3] configure: error: C compiler cannot create executables\n[gsl-2.3] See `config.log' for more details\n[gsl-2.3] Error configuring GSL.\n```\n\nwhere `config.log` shows:\n\n```\nconfigure:3480: checking whether the C compiler works\nconfigure:3502: gcc -g -O2   -L/home/Admin/src/sagemath/sage/local/lib -Wl,-rpath,/home/Admin/src/sagemath/sage/local/lib  conftest.c -lopenblas -lm >&5\n/usr/lib/gcc/x86_64-pc-cygwin/5.4.0/../../../../x86_64-pc-cygwin/bin/ld: cannot find -lopenblas\ncollect2: error: ld returned 1 exit status\nconfigure:3506: $? = 1\nconfigure:3544: result: no\nconfigure: failed program was:\nconfigure:3549: error: in `/home/Admin/src/sagemath/sage/local/var/tmp/sage/build/gsl-2.3/src':\nconfigure:3551: error: C compiler cannot create executables\n```\n| /* confdefs.h */\n| #define PACKAGE_NAME \"gsl\"\n| #define PACKAGE_TARNAME \"gsl\"\n| #define PACKAGE_VERSION \"2.3\"\n| #define PACKAGE_STRING \"gsl 2.3\"\n| #define PACKAGE_BUGREPORT \"\"\n| #define PACKAGE_URL \"\"\n| #define PACKAGE \"gsl\"\n| #define VERSION \"2.3\"\n| #define RELEASED /**/\n| /* end confdefs.h.  */\n| int\n| main ()\n| {\n|   ;\n|   return 0;\n| }\nSo it both cases it looks like it's trying to explicitly link `-lopenblas`.\n\nIt seems that under `$SAGE_LOCAL/bin` there is a `libopenblas.dll`, and there is no `libopenblas.dll.a` import lib under `$SAGE_LOCAL/lib`.  There are a couple problems with this:\n\n1) While current versions of gcc for Cygwin do not technically need a separate import lib (`.dll.a`), and can generate one directly from a `.dll`, the defaults (as explained [here https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/4/html/Using_ld_the_GNU_Linker/win32.html]) are such that on Cygwin there is a convention of prefixing library names with `cyg` instead of `lib`, and so for `ld` to find the right file for `-lopenblas` its name must be `cygopenblas.dll`.\n\n2) Even if we had `cygopenblas.dll`, `-L $SAGE_LOCAL/bin` needs to be explicitly added to the linker flags to search in bin.\n\nInstead I've been trying to keep the Cygwin build consistent about explicitly using import libs since that requires less fiddling.  So I'll investigate what needs to be fixed for openblas to install properly on Cygwin.\n\n**Upstream pull request:** https://github.com/xianyi/OpenBLAS/pull/1293\n\nKeywords: openblas\n\nBranch/Commit: 6799ec06e61bd91cce0aab376efbe80221eafd01\n\nUpstream: Fixed upstream, but not in a stable release.\n\nReviewer: Jeroen Demeyer\n\nAuthor: Erik Bray\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/23797\n\n",
    "closed_at": "2017-09-20T22:26:18Z",
    "created_at": "2017-09-07T10:25:39Z",
    "labels": [
        "component: porting: cygwin",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Cygwin: openblas does not install correctly",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23797",
    "user": "https://github.com/embray"
}
```
For most of the time I've worked on Cygwin, I've been building with Cygwin's system BLAS (which I don't think is actually ATLAS, but using `--with-blas=atlas` and the appropriate `SAGE_ATLAS_LIB` picks it up and runs with it).

Recently I had to restart the Cygwin patchbot and forgot to configure it with these settings, so it built openblas (which seems to build successfully) but then grinds to a halt.  I think I was already aware there were problems like this with openblas and just didn't deal with it since there was a good workaround.  Still, it should be fixed.

The problem in scipy is that it simply fails to detect a BLAS library during its `setup.py egg_info`.

Similarly, gsl fails at configure time with:

```
[gsl-2.3] checking whether the C compiler works... no
[gsl-2.3] configure: error: in `/home/Admin/src/sagemath/sage/local/var/tmp/sage/build/gsl-2.3/src':
[gsl-2.3] configure: error: C compiler cannot create executables
[gsl-2.3] See `config.log' for more details
[gsl-2.3] Error configuring GSL.
```

where `config.log` shows:

```
configure:3480: checking whether the C compiler works
configure:3502: gcc -g -O2   -L/home/Admin/src/sagemath/sage/local/lib -Wl,-rpath,/home/Admin/src/sagemath/sage/local/lib  conftest.c -lopenblas -lm >&5
/usr/lib/gcc/x86_64-pc-cygwin/5.4.0/../../../../x86_64-pc-cygwin/bin/ld: cannot find -lopenblas
collect2: error: ld returned 1 exit status
configure:3506: $? = 1
configure:3544: result: no
configure: failed program was:
configure:3549: error: in `/home/Admin/src/sagemath/sage/local/var/tmp/sage/build/gsl-2.3/src':
configure:3551: error: C compiler cannot create executables
```
| /* confdefs.h */
| #define PACKAGE_NAME "gsl"
| #define PACKAGE_TARNAME "gsl"
| #define PACKAGE_VERSION "2.3"
| #define PACKAGE_STRING "gsl 2.3"
| #define PACKAGE_BUGREPORT ""
| #define PACKAGE_URL ""
| #define PACKAGE "gsl"
| #define VERSION "2.3"
| #define RELEASED /**/
| /* end confdefs.h.  */
| int
| main ()
| {
|   ;
|   return 0;
| }
So it both cases it looks like it's trying to explicitly link `-lopenblas`.

It seems that under `$SAGE_LOCAL/bin` there is a `libopenblas.dll`, and there is no `libopenblas.dll.a` import lib under `$SAGE_LOCAL/lib`.  There are a couple problems with this:

1) While current versions of gcc for Cygwin do not technically need a separate import lib (`.dll.a`), and can generate one directly from a `.dll`, the defaults (as explained [here https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/4/html/Using_ld_the_GNU_Linker/win32.html]) are such that on Cygwin there is a convention of prefixing library names with `cyg` instead of `lib`, and so for `ld` to find the right file for `-lopenblas` its name must be `cygopenblas.dll`.

2) Even if we had `cygopenblas.dll`, `-L $SAGE_LOCAL/bin` needs to be explicitly added to the linker flags to search in bin.

Instead I've been trying to keep the Cygwin build consistent about explicitly using import libs since that requires less fiddling.  So I'll investigate what needs to be fixed for openblas to install properly on Cygwin.

**Upstream pull request:** https://github.com/xianyi/OpenBLAS/pull/1293

Keywords: openblas

Branch/Commit: 6799ec06e61bd91cce0aab376efbe80221eafd01

Upstream: Fixed upstream, but not in a stable release.

Reviewer: Jeroen Demeyer

Author: Erik Bray

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/23797





---

archive/issue_comments_329655.json:
```json
{
    "body": "Changing keywords from \"\" to \"openblas\".",
    "created_at": "2017-09-07T12:09:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23797#issuecomment-329655",
    "user": "https://github.com/embray"
}
```

Changing keywords from "" to "openblas".



---

archive/issue_comments_329656.json:
```json
{
    "body": "<a id='comment:1'></a>Adds a patch for this issue, which I will also submit upstream.\n\n---\nNew commits:",
    "created_at": "2017-09-07T12:09:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23797#issuecomment-329656",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>Adds a patch for this issue, which I will also submit upstream.

---
New commits:



---

archive/issue_comments_329657.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-09-07T12:09:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23797#issuecomment-329657",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_329658.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2017-09-07T12:09:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23797#issuecomment-329658",
    "user": "https://github.com/embray"
}
```

Changing priority from major to critical.



---

archive/issue_comments_329659.json:
```json
{
    "body": "<a id='comment:4'></a>If this works for you...",
    "created_at": "2017-09-19T09:35:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23797#issuecomment-329659",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>If this works for you...



---

archive/issue_comments_329660.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-09-19T09:35:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23797#issuecomment-329660",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_329661.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-09-20T22:26:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23797#issuecomment-329661",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_060677.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-09-20T22:26:18Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23797",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23797#event-60677"
}
```
