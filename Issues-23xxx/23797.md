# Issue 23797: Cygwin: openblas does not install correctly

archive/issues_023560.json:
```json
{
    "body": "For most of the time I've worked on Cygwin, I've been building with Cygwin's system BLAS (which I don't think is actually ATLAS, but using `--with-blas=atlas` and the appropriate `SAGE_ATLAS_LIB` picks it up and runs with it).\n\nRecently I had to restart the Cygwin patchbot and forgot to configure it with these settings, so it built openblas (which seems to build successfully) but then grinds to a halt.  I think I was already aware there were problems like this with openblas and just didn't deal with it since there was a good workaround.  Still, it should be fixed.\n\nThe problem in scipy is that it simply fails to detect a BLAS library during its `setup.py egg_info`.\n\nSimilarly, gsl fails at configure time with:\n\n```\n[gsl-2.3] checking whether the C compiler works... no\n[gsl-2.3] configure: error: in `/home/Admin/src/sagemath/sage/local/var/tmp/sage/build/gsl-2.3/src':\n[gsl-2.3] configure: error: C compiler cannot create executables\n[gsl-2.3] See `config.log' for more details\n[gsl-2.3] Error configuring GSL.\n```\n\nwhere `config.log` shows:\n\n```\nconfigure:3480: checking whether the C compiler works\nconfigure:3502: gcc -g -O2   -L/home/Admin/src/sagemath/sage/local/lib -Wl,-rpath,/home/Admin/src/sagemath/sage/local/lib  conftest.c -lopenblas -lm >&5\n/usr/lib/gcc/x86_64-pc-cygwin/5.4.0/../../../../x86_64-pc-cygwin/bin/ld: cannot find -lopenblas\ncollect2: error: ld returned 1 exit status\nconfigure:3506: $? = 1\nconfigure:3544: result: no\nconfigure: failed program was:\n| /* confdefs.h */\n| #define PACKAGE_NAME \"gsl\"\n| #define PACKAGE_TARNAME \"gsl\"\n| #define PACKAGE_VERSION \"2.3\"\n| #define PACKAGE_STRING \"gsl 2.3\"\n| #define PACKAGE_BUGREPORT \"\"\n| #define PACKAGE_URL \"\"\n| #define PACKAGE \"gsl\"\n| #define VERSION \"2.3\"\n| #define RELEASED /**/\n| /* end confdefs.h.  */\n|\n| int\n| main ()\n| {\n|\n|   ;\n|   return 0;\n| }\nconfigure:3549: error: in `/home/Admin/src/sagemath/sage/local/var/tmp/sage/build/gsl-2.3/src':\nconfigure:3551: error: C compiler cannot create executables\n```\n\nSo it both cases it looks like it's trying to explicitly link `-lopenblas`.\n\nIt seems that under `$SAGE_LOCAL/bin` there is a `libopenblas.dll`, and there is no `libopenblas.dll.a` import lib under `$SAGE_LOCAL/lib`.  There are a couple problems with this:\n\n1) While current versions of gcc for Cygwin do not technically need a separate import lib (`.dll.a`), and can generate one directly from a `.dll`, the defaults (as explained [here https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/4/html/Using_ld_the_GNU_Linker/win32.html]) are such that on Cygwin there is a convention of prefixing library names with `cyg` instead of `lib`, and so for `ld` to find the right file for `-lopenblas` its name must be `cygopenblas.dll`.\n\n2) Even if we had `cygopenblas.dll`, `-L $SAGE_LOCAL/bin` needs to be explicitly added to the linker flags to search in bin.\n\nInstead I've been trying to keep the Cygwin build consistent about explicitly using import libs since that requires less fiddling.  So I'll investigate what needs to be fixed for openblas to install properly on Cygwin.\n\n**Upstream pull request:** https://github.com/xianyi/OpenBLAS/pull/1293\n\n**Keywords:** openblas\n\n**Branch/Commit:** [6799ec06e61bd91cce0aab376efbe80221eafd01](https://github.com/sagemath/sagetrac-mirror/commit/6799ec06e61bd91cce0aab376efbe80221eafd01)\n\n**Upstream:** Fixed upstream, but not in a stable release.\n\n**Reviewer:** Jeroen Demeyer\n\n**Author:** Erik Bray\n\nIssue created by migration from https://trac.sagemath.org/ticket/23797\n\n",
    "closed_at": "2017-09-20T22:26:18Z",
    "created_at": "2017-09-07T10:25:39Z",
    "labels": [
        "component: porting: cygwin",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Cygwin: openblas does not install correctly",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23797",
    "user": "https://github.com/embray"
}
```
For most of the time I've worked on Cygwin, I've been building with Cygwin's system BLAS (which I don't think is actually ATLAS, but using `--with-blas=atlas` and the appropriate `SAGE_ATLAS_LIB` picks it up and runs with it).

Recently I had to restart the Cygwin patchbot and forgot to configure it with these settings, so it built openblas (which seems to build successfully) but then grinds to a halt.  I think I was already aware there were problems like this with openblas and just didn't deal with it since there was a good workaround.  Still, it should be fixed.

The problem in scipy is that it simply fails to detect a BLAS library during its `setup.py egg_info`.

Similarly, gsl fails at configure time with:

```
[gsl-2.3] checking whether the C compiler works... no
[gsl-2.3] configure: error: in `/home/Admin/src/sagemath/sage/local/var/tmp/sage/build/gsl-2.3/src':
[gsl-2.3] configure: error: C compiler cannot create executables
[gsl-2.3] See `config.log' for more details
[gsl-2.3] Error configuring GSL.
```

where `config.log` shows:

```
configure:3480: checking whether the C compiler works
configure:3502: gcc -g -O2   -L/home/Admin/src/sagemath/sage/local/lib -Wl,-rpath,/home/Admin/src/sagemath/sage/local/lib  conftest.c -lopenblas -lm >&5
/usr/lib/gcc/x86_64-pc-cygwin/5.4.0/../../../../x86_64-pc-cygwin/bin/ld: cannot find -lopenblas
collect2: error: ld returned 1 exit status
configure:3506: $? = 1
configure:3544: result: no
configure: failed program was:
| /* confdefs.h */
| #define PACKAGE_NAME "gsl"
| #define PACKAGE_TARNAME "gsl"
| #define PACKAGE_VERSION "2.3"
| #define PACKAGE_STRING "gsl 2.3"
| #define PACKAGE_BUGREPORT ""
| #define PACKAGE_URL ""
| #define PACKAGE "gsl"
| #define VERSION "2.3"
| #define RELEASED /**/
| /* end confdefs.h.  */
|
| int
| main ()
| {
|
|   ;
|   return 0;
| }
configure:3549: error: in `/home/Admin/src/sagemath/sage/local/var/tmp/sage/build/gsl-2.3/src':
configure:3551: error: C compiler cannot create executables
```

So it both cases it looks like it's trying to explicitly link `-lopenblas`.

It seems that under `$SAGE_LOCAL/bin` there is a `libopenblas.dll`, and there is no `libopenblas.dll.a` import lib under `$SAGE_LOCAL/lib`.  There are a couple problems with this:

1) While current versions of gcc for Cygwin do not technically need a separate import lib (`.dll.a`), and can generate one directly from a `.dll`, the defaults (as explained [here https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/4/html/Using_ld_the_GNU_Linker/win32.html]) are such that on Cygwin there is a convention of prefixing library names with `cyg` instead of `lib`, and so for `ld` to find the right file for `-lopenblas` its name must be `cygopenblas.dll`.

2) Even if we had `cygopenblas.dll`, `-L $SAGE_LOCAL/bin` needs to be explicitly added to the linker flags to search in bin.

Instead I've been trying to keep the Cygwin build consistent about explicitly using import libs since that requires less fiddling.  So I'll investigate what needs to be fixed for openblas to install properly on Cygwin.

**Upstream pull request:** https://github.com/xianyi/OpenBLAS/pull/1293

**Keywords:** openblas

**Branch/Commit:** [6799ec06e61bd91cce0aab376efbe80221eafd01](https://github.com/sagemath/sagetrac-mirror/commit/6799ec06e61bd91cce0aab376efbe80221eafd01)

**Upstream:** Fixed upstream, but not in a stable release.

**Reviewer:** Jeroen Demeyer

**Author:** Erik Bray

Issue created by migration from https://trac.sagemath.org/ticket/23797





---

archive/issue_comments_363044.json:
```json
{
    "body": "**Branch:** [u/embray/cygwin/ticket-23797](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/cygwin/ticket-23797)",
    "created_at": "2017-09-07T12:09:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23797#issuecomment-363044",
    "user": "https://github.com/embray"
}
```

**Branch:** [u/embray/cygwin/ticket-23797](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/cygwin/ticket-23797)



---

archive/issue_comments_363045.json:
```json
{
    "body": "**Commit:** [6799ec06e61bd91cce0aab376efbe80221eafd01](https://github.com/sagemath/sagetrac-mirror/commit/6799ec06e61bd91cce0aab376efbe80221eafd01)",
    "created_at": "2017-09-07T12:09:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23797#issuecomment-363045",
    "user": "https://github.com/embray"
}
```

**Commit:** [6799ec06e61bd91cce0aab376efbe80221eafd01](https://github.com/sagemath/sagetrac-mirror/commit/6799ec06e61bd91cce0aab376efbe80221eafd01)



---

archive/issue_comments_363046.json:
```json
{
    "body": "**Changing keywords** from \"\" to \"openblas\".",
    "created_at": "2017-09-07T12:09:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23797#issuecomment-363046",
    "user": "https://github.com/embray"
}
```

**Changing keywords** from "" to "openblas".



---

archive/issue_comments_363047.json:
```json
{
    "body": "<a id='comment:1'></a>\nAdds a patch for this issue, which I will also submit upstream.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6799ec06e61bd91cce0aab376efbe80221eafd01\">6799ec0</a></td><td><code>Patches openblas to install in a more canonical way on Cygwin:</code></td></tr></table>\n",
    "created_at": "2017-09-07T12:09:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23797#issuecomment-363047",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>
Adds a patch for this issue, which I will also submit upstream.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6799ec06e61bd91cce0aab376efbe80221eafd01">6799ec0</a></td><td><code>Patches openblas to install in a more canonical way on Cygwin:</code></td></tr></table>




---

archive/issue_comments_363048.json:
```json
{
    "body": "**Author:** Erik Bray",
    "created_at": "2017-09-07T12:09:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23797#issuecomment-363048",
    "user": "https://github.com/embray"
}
```

**Author:** Erik Bray



---

archive/issue_comments_363049.json:
```json
{
    "body": "**Changing upstream** from \"N/A\" to \"Not yet reported upstream; Will do shortly.\".",
    "created_at": "2017-09-07T12:09:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23797#issuecomment-363049",
    "user": "https://github.com/embray"
}
```

**Changing upstream** from "N/A" to "Not yet reported upstream; Will do shortly.".



---

archive/issue_events_215355.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-09-07T12:09:17Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/23797",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23797#event-215355"
}
```



---

archive/issue_events_215356.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-09-07T12:09:17Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/23797",
    "label": "critical",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23797#event-215356"
}
```



---

archive/issue_comments_363050.json:
```json
{
    "body": "**Changing upstream** from \"Not yet reported upstream; Will do shortly.\" to \"Reported upstream. No feedback yet.\".",
    "created_at": "2017-09-07T12:22:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23797#issuecomment-363050",
    "user": "https://github.com/embray"
}
```

**Changing upstream** from "Not yet reported upstream; Will do shortly." to "Reported upstream. No feedback yet.".



---

archive/issue_comments_363051.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -56,3 +56,5 @@\n 2) Even if we had `cygopenblas.dll`, `-L $SAGE_LOCAL/bin` needs to be explicitly added to the linker flags to search in bin.\n \n Instead I've been trying to keep the Cygwin build consistent about explicitly using import libs since that requires less fiddling.  So I'll investigate what needs to be fixed for openblas to install properly on Cygwin.\n+\n+**Upstream pull request:** https://github.com/xianyi/OpenBLAS/pull/1293\n``````\n",
    "created_at": "2017-09-07T12:22:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23797#issuecomment-363051",
    "user": "https://github.com/embray"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -56,3 +56,5 @@
 2) Even if we had `cygopenblas.dll`, `-L $SAGE_LOCAL/bin` needs to be explicitly added to the linker flags to search in bin.
 
 Instead I've been trying to keep the Cygwin build consistent about explicitly using import libs since that requires less fiddling.  So I'll investigate what needs to be fixed for openblas to install properly on Cygwin.
+
+**Upstream pull request:** https://github.com/xianyi/OpenBLAS/pull/1293
``````




---

archive/issue_comments_363052.json:
```json
{
    "body": "**Changing upstream** from \"Reported upstream. No feedback yet.\" to \"Fixed upstream, but not in a stable release.\".",
    "created_at": "2017-09-12T19:12:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23797#issuecomment-363052",
    "user": "https://github.com/embray"
}
```

**Changing upstream** from "Reported upstream. No feedback yet." to "Fixed upstream, but not in a stable release.".



---

archive/issue_comments_363053.json:
```json
{
    "body": "<a id='comment:4'></a>\nIf this works for you...",
    "created_at": "2017-09-19T09:35:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23797#issuecomment-363053",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>
If this works for you...



---

archive/issue_comments_363054.json:
```json
{
    "body": "**Reviewer:** Jeroen Demeyer",
    "created_at": "2017-09-19T09:35:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23797#issuecomment-363054",
    "user": "https://github.com/jdemeyer"
}
```

**Reviewer:** Jeroen Demeyer



---

archive/issue_events_215357.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-09-19T09:35:59Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/23797",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23797#event-215357"
}
```



---

archive/issue_events_215358.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-09-19T09:35:59Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/23797",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23797#event-215358"
}
```



---

archive/issue_comments_363055.json:
```json
{
    "body": "**Changing branch** from \"[u/embray/cygwin/ticket-23797](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/cygwin/ticket-23797)\" to \"[6799ec06e61bd91cce0aab376efbe80221eafd01](https://github.com/sagemath/sagetrac-mirror/commit/6799ec06e61bd91cce0aab376efbe80221eafd01)\".",
    "created_at": "2017-09-20T22:26:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23797#issuecomment-363055",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/embray/cygwin/ticket-23797](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/cygwin/ticket-23797)" to "[6799ec06e61bd91cce0aab376efbe80221eafd01](https://github.com/sagemath/sagetrac-mirror/commit/6799ec06e61bd91cce0aab376efbe80221eafd01)".



---

archive/issue_events_215359.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-09-20T22:26:18Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/23797",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23797#event-215359"
}
```



---

archive/issue_events_215360.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-09-20T22:26:18Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23797",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23797#event-215360"
}
```
