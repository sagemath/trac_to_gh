# Issue 23304: hold=True does not always prevent evaluation

archive/issues_023067.json:
```json
{
    "body": "```\nsage: x = SR.var(x)\nsage: x + 1/3\nx + 1/3\nsage: (x + 1/3).power(2, hold=True)\n(x + 1/3)^2\nsage: (x + 1/3).power(2, hold=True).mul(2, hold=True) # <<< evaluates!\n2*(1/9*(3*x + 1)^2)\nsage: (x + 1/3).mul(2, hold=True)\n2*(x + 1/3)\n```\n\nReported as https://github.com/pynac/pynac/issues/262\n\nCC:  @davewittemorris @slel\n\nUpstream: Fixed upstream, in a later stable release.\n\nAuthor: Fr\u00e9d\u00e9ric Chapoton\n\nBranch: u/chapoton/23304\n\nStatus: needs_work\n\nDependencies: #10035\n\nCommit: 277efed42215b451b8fb1b502b6964951a1031cc\n\nIssue created by migration from https://trac.sagemath.org/ticket/23304\n\n",
    "created_at": "2017-06-22T12:12:49Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "hold=True does not always prevent evaluation",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23304",
    "user": "https://github.com/mezzarobba"
}
```
```
sage: x = SR.var(x)
sage: x + 1/3
x + 1/3
sage: (x + 1/3).power(2, hold=True)
(x + 1/3)^2
sage: (x + 1/3).power(2, hold=True).mul(2, hold=True) # <<< evaluates!
2*(1/9*(3*x + 1)^2)
sage: (x + 1/3).mul(2, hold=True)
2*(x + 1/3)
```

Reported as https://github.com/pynac/pynac/issues/262

CC:  @davewittemorris @slel

Upstream: Fixed upstream, in a later stable release.

Author: Frédéric Chapoton

Branch: u/chapoton/23304

Status: needs_work

Dependencies: #10035

Commit: 277efed42215b451b8fb1b502b6964951a1031cc

Issue created by migration from https://trac.sagemath.org/ticket/23304





---

archive/issue_comments_343349.json:
```json
{
    "body": "<a id='comment:1'></a>See also #21754 and #21758.",
    "created_at": "2017-07-01T06:31:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23304#issuecomment-343349",
    "user": "https://github.com/rwst"
}
```

<a id='comment:1'></a>See also #21754 and #21758.



---

archive/issue_events_060012.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2017-07-01T06:35:29Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23304",
    "milestone": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23304#event-60012"
}
```



---

archive/issue_comments_343350.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -10,6 +10,8 @@\n 2*(x + 1/3)\n \\`\\`\\`\n \n+Reported as https://github.com/pynac/pynac/issues/262\n+\n Comment: 1\n \n Issue created by migration from https://trac.sagemath.org/ticket/23304\n```\n",
    "created_at": "2017-07-01T06:35:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23304#issuecomment-343350",
    "user": "https://github.com/rwst"
}
```

Description changed:
```diff
--- 
+++ 
@@ -10,6 +10,8 @@
 2*(x + 1/3)
 \`\`\`
 
+Reported as https://github.com/pynac/pynac/issues/262
+
 Comment: 1
 
 Issue created by migration from https://trac.sagemath.org/ticket/23304
```




---

archive/issue_events_060013.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2017-09-03T07:52:07Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23304",
    "milestone": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23304#event-60013"
}
```



---

archive/issue_events_060014.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2017-09-03T07:52:07Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23304",
    "milestone": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23304#event-60014"
}
```



---

archive/issue_comments_343351.json:
```json
{
    "body": "<a id='comment:3'></a>Operations like this are now better done in a hold context. With #10035:\n\n```\nsage: hold.start()\nsage: x + 1/3\nx + 1/3\nsage: (x + 1/3)^2\n(x + 1/3)^2\nsage: (x + 1/3)^2*2\n2*(x + 1/3)^2\nsage: (x + 1/3)*2\n2*(x + 1/3)\n```",
    "created_at": "2017-09-03T07:52:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23304#issuecomment-343351",
    "user": "https://github.com/rwst"
}
```

<a id='comment:3'></a>Operations like this are now better done in a hold context. With #10035:

```
sage: hold.start()
sage: x + 1/3
x + 1/3
sage: (x + 1/3)^2
(x + 1/3)^2
sage: (x + 1/3)^2*2
2*(x + 1/3)^2
sage: (x + 1/3)*2
2*(x + 1/3)
```



---

archive/issue_comments_343352.json:
```json
{
    "body": "<a id='comment:4'></a>The upstream fix in Pynac was merged in Pynac 0.7.11.\n\nThe upgrade to Pynac 0.7.11 was done in #23820, merged in Sage 8.1.beta6.\n\nIn the present ticket we should add a doctest.",
    "created_at": "2020-09-17T23:42:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23304#issuecomment-343352",
    "user": "https://github.com/slel"
}
```

<a id='comment:4'></a>The upstream fix in Pynac was merged in Pynac 0.7.11.

The upgrade to Pynac 0.7.11 was done in #23820, merged in Sage 8.1.beta6.

In the present ticket we should add a doctest.



---

archive/issue_events_060015.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2020-09-17T23:42:16Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23304",
    "milestone": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23304#event-60015"
}
```



---

archive/issue_events_060016.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2020-09-17T23:42:16Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23304",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23304#event-60016"
}
```



---

archive/issue_events_060017.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-07T19:29:15Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23304",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23304#event-60017"
}
```



---

archive/issue_events_060018.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-07T19:29:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23304",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23304#event-60018"
}
```



---

archive/issue_comments_343353.json:
```json
{
    "body": "<a id='comment:5'></a>Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-04-07T19:29:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23304#issuecomment-343353",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_events_060019.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-22T20:35:10Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23304",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23304#event-60019"
}
```



---

archive/issue_events_060020.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-22T20:35:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23304",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23304#event-60020"
}
```



---

archive/issue_events_060021.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T20:12:32Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23304",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23304#event-60021"
}
```



---

archive/issue_events_060022.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T20:12:32Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23304",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23304#event-60022"
}
```



---

archive/issue_comments_343354.json:
```json
{
    "body": "<a id='comment:9'></a>here is a doctest\n\n---\nNew commits:",
    "created_at": "2022-02-14T19:50:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23304#issuecomment-343354",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:9'></a>here is a doctest

---
New commits:



---

archive/issue_comments_343355.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-02-14T19:50:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23304#issuecomment-343355",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_343356.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-02-15T02:42:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23304#issuecomment-343356",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_343357.json:
```json
{
    "body": "<a id='comment:10'></a>I think that using `hold=true` should give the same result as using a hold context:\n\n```\nsage: with hold:\n....:     (x + 1/3).power(2).mul(2)\n2*(x + 1/3)^2\n```\nBut the proposed doctest validates `2*(1/9*(3*x + 1)^2)`, so I don't think we want this doctest.\n\nGinac (and therefore pynac) was not designed with \"hold\" in mind (see also #31597), so I think it will take considerable effort to fix the many problems, but fixing the specific problem on this ticket might not be hard.  I might have time to work on these issues in the next few months, but it's great if someone else wants to do it.\n\nOne possibility would be to have two tickets: one ticket to add a doctest for the hold context right now (because it already gives a good answer), and another ticket (which will remain open) for fixing `hold = true`.",
    "created_at": "2022-02-15T02:42:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23304",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23304#issuecomment-343357",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:10'></a>I think that using `hold=true` should give the same result as using a hold context:

```
sage: with hold:
....:     (x + 1/3).power(2).mul(2)
2*(x + 1/3)^2
```
But the proposed doctest validates `2*(1/9*(3*x + 1)^2)`, so I don't think we want this doctest.

Ginac (and therefore pynac) was not designed with "hold" in mind (see also #31597), so I think it will take considerable effort to fix the many problems, but fixing the specific problem on this ticket might not be hard.  I might have time to work on these issues in the next few months, but it's great if someone else wants to do it.

One possibility would be to have two tickets: one ticket to add a doctest for the hold context right now (because it already gives a good answer), and another ticket (which will remain open) for fixing `hold = true`.



---

archive/issue_events_060023.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-17T19:59:27Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23304",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23304#event-60023"
}
```



---

archive/issue_events_060024.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-17T19:59:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23304",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23304#event-60024"
}
```



---

archive/issue_events_060025.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23304",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23304#event-60025"
}
```



---

archive/issue_events_060026.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23304",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23304#event-60026"
}
```
