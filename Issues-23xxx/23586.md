# Issue 23586: Pretty print: sort by string if sorting fails

archive/issues_023349.json:
```json
{
    "assignees": [],
    "body": "Whenever IPython prints a dict or set, it tries to sort the keys for a nicer output. If the sorting fails, then no sorting is done.\n\nThis ticket proposes instead to sort on the string representation if the usual sorting fails. That way, we almost certainly get a deterministic output, which is mainly useful for doctests.\n\nIt must be said that sorting rarely fails on Python 2, so this would affect mostly Python 3.\n\n**Upstream**: https://github.com/ipython/ipython/pull/10767\n\nCC:  @mkoeppe @dkrenn @koffie\n\nBranch/Commit: **[u/jdemeyer/23586](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/23586) @ [`394d5a4`](https://github.com/sagemath/sagetrac-mirror/commit/394d5a4f035cf9ef4c92d0288bb4da1c6e420066)**\n\nUpstream: **Reported upstream. No feedback yet.**\n\nReviewer: **Fran\u00e7ois Bissey**\n\nAuthor: **Jeroen Demeyer**\n\nComponent: **packages: standard**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/23586_\n\n",
    "closed_at": "2021-10-11T08:43:22Z",
    "created_at": "2017-08-05T20:52:30Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/bug",
        "https://github.com/sagemath/sage/labels/c%3A%20packages%3A%20standard",
        "https://github.com/sagemath/sage/labels/invalid"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Pretty print: sort by string if sorting fails",
    "type": "issue",
    "updated_at": "2021-10-11T08:43:22Z",
    "url": "https://github.com/sagemath/sage/issues/23586",
    "user": "https://github.com/fchapoton"
}
```
Whenever IPython prints a dict or set, it tries to sort the keys for a nicer output. If the sorting fails, then no sorting is done.

This ticket proposes instead to sort on the string representation if the usual sorting fails. That way, we almost certainly get a deterministic output, which is mainly useful for doctests.

It must be said that sorting rarely fails on Python 2, so this would affect mostly Python 3.

**Upstream**: https://github.com/ipython/ipython/pull/10767

CC:  @mkoeppe @dkrenn @koffie

Branch/Commit: **[u/jdemeyer/23586](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/23586) @ [`394d5a4`](https://github.com/sagemath/sagetrac-mirror/commit/394d5a4f035cf9ef4c92d0288bb4da1c6e420066)**

Upstream: **Reported upstream. No feedback yet.**

Reviewer: **Fran√ßois Bissey**

Author: **Jeroen Demeyer**

Component: **packages: standard**

_Issue created by migration from https://trac.sagemath.org/ticket/23586_





---

archive/issue_events_328127.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2017-08-05T20:52:30Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "milestone_number": null,
    "milestone_title": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23586#event-328127"
}
```



---

archive/issue_events_328128.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2017-08-05T20:52:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20packages%3A%20optional",
    "label_color": "000080",
    "label_name": "c: packages: optional",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23586#event-328128"
}
```



---

archive/issue_events_328129.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2017-08-05T20:52:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23586#event-328129"
}
```



---

archive/issue_events_328130.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2017-08-05T20:52:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23586#event-328130"
}
```



---

archive/issue_comments_355013.json:
```json
{
    "body": "Branch: **[u/chapoton/23586](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/23586)**",
    "created_at": "2017-08-05T20:52:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355013",
    "user": "https://github.com/fchapoton"
}
```

Branch: **[u/chapoton/23586](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/23586)**



---

archive/issue_comments_355014.json:
```json
{
    "body": "Commit: **[`9b314dd`](https://github.com/sagemath/sagetrac-mirror/commit/9b314ddf075600df41a0433c5247abce218f36fb)**",
    "created_at": "2017-08-05T20:52:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355014",
    "user": "https://github.com/fchapoton"
}
```

Commit: **[`9b314dd`](https://github.com/sagemath/sagetrac-mirror/commit/9b314ddf075600df41a0433c5247abce218f36fb)**



---

archive/issue_events_328131.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2017-08-05T20:52:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23586#event-328131"
}
```



---

archive/issue_comments_355015.json:
```json
{
    "body": "<div id=\"comment:1\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9b314ddf075600df41a0433c5247abce218f36fb\">9b314dd</a></td><td><code>fixing pynormaliz doctests</code></td></tr></table>\n",
    "created_at": "2017-08-05T20:52:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355015",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:1"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9b314ddf075600df41a0433c5247abce218f36fb">9b314dd</a></td><td><code>fixing pynormaliz doctests</code></td></tr></table>




---

archive/issue_comments_355016.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nbot is morally green",
    "created_at": "2017-08-07T09:57:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355016",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:2" align="right">comment:2</div>

bot is morally green



---

archive/issue_events_328132.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-08-11T07:54:01Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23586#event-328132"
}
```



---

archive/issue_events_328133.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-08-11T07:54:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "label": "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p: 1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23586#event-328133"
}
```



---

archive/issue_comments_355017.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nDo you have any idea why the output has changed? I usually find it dangerous to just accept doctest changes like this without understanding the reason.",
    "created_at": "2017-08-11T07:55:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355017",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:4" align="right">comment:4</div>

Do you have any idea why the output has changed? I usually find it dangerous to just accept doctest changes like this without understanding the reason.



---

archive/issue_comments_355018.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nReplying to [@fchapoton](#comment:2):\n> bot is morally green\n\nThose bots do not have `pynormaliz` installed, that means nothing...\n\nOn my bots I try to install all optional packages, so `sage4` and `arando` should have it.",
    "created_at": "2017-08-11T07:57:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355018",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:5" align="right">comment:5</div>

Replying to [@fchapoton](#comment:2):
> bot is morally green

Those bots do not have `pynormaliz` installed, that means nothing...

On my bots I try to install all optional packages, so `sage4` and `arando` should have it.



---

archive/issue_comments_355019.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nLooks to me like only the ordering of the solutions has changed. The overall set is still the same.",
    "created_at": "2017-08-11T07:58:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355019",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:6" align="right">comment:6</div>

Looks to me like only the ordering of the solutions has changed. The overall set is still the same.



---

archive/issue_comments_355020.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nReplying to [@kiwifb](#comment:6):\n> Looks to me like only the ordering of the solutions has changed.\n\nThat still doesn't answer the \"why\" question.",
    "created_at": "2017-08-11T07:59:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355020",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:7" align="right">comment:7</div>

Replying to [@kiwifb](#comment:6):
> Looks to me like only the ordering of the solutions has changed.

That still doesn't answer the "why" question.



---

archive/issue_comments_355021.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nIt's a set, so it is inherently unordered. Although my guess is either changes in the comparisons or the hash led to this change. Perhaps it will be better to make this robust and just do `sorted(PI.Vrepresentation(), key=str)` instead.",
    "created_at": "2017-08-11T08:48:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355021",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:8" align="right">comment:8</div>

It's a set, so it is inherently unordered. Although my guess is either changes in the comparisons or the hash led to this change. Perhaps it will be better to make this robust and just do `sorted(PI.Vrepresentation(), key=str)` instead.



---

archive/issue_comments_355022.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nReplying to [@tscrim](#comment:8):\n> Perhaps it will be better to make this robust and just do `sorted(PI.Vrepresentation(), key=str)` instead.\n\n+1",
    "created_at": "2017-08-11T20:42:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355022",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:9" align="right">comment:9</div>

Replying to [@tscrim](#comment:8):
> Perhaps it will be better to make this robust and just do `sorted(PI.Vrepresentation(), key=str)` instead.

+1



---

archive/issue_events_328134.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2017-08-11T20:42:57Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23586#event-328134"
}
```



---

archive/issue_events_328135.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2017-08-11T20:42:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23586#event-328135"
}
```



---

archive/issue_comments_355023.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nReplying to [@tscrim](#comment:8):\n> Perhaps it will be better to make this robust and just do `sorted(PI.Vrepresentation(), key=str)` instead.\n\nNo, if we want to do that, it should be done at the level of the displayhook. We already do that for `dict`, so it makes sense to do the same for `set`.",
    "created_at": "2017-08-18T07:23:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355023",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:11" align="right">comment:11</div>

Replying to [@tscrim](#comment:8):
> Perhaps it will be better to make this robust and just do `sorted(PI.Vrepresentation(), key=str)` instead.

No, if we want to do that, it should be done at the level of the displayhook. We already do that for `dict`, so it makes sense to do the same for `set`.



---

archive/issue_comments_355024.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReplying to [@jdemeyer](#comment:11):\n> Replying to [@tscrim](#comment:8):\n> No, if we want to do that, it should be done at the level of the displayhook. We already do that for `dict`, so it makes sense to do the same for `set`.\n\n+1",
    "created_at": "2017-08-18T08:51:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355024",
    "user": "https://github.com/dkrenn"
}
```

<div id="comment:13" align="right">comment:13</div>

Replying to [@jdemeyer](#comment:11):
> Replying to [@tscrim](#comment:8):
> No, if we want to do that, it should be done at the level of the displayhook. We already do that for `dict`, so it makes sense to do the same for `set`.

+1



---

archive/issue_comments_355025.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@jdemeyer](#comment:11):\n> Replying to [@tscrim](#comment:8):\n> > Perhaps it will be better to make this robust and just do `sorted(PI.Vrepresentation(), key=str)` instead.\n\n> \n> No, if we want to do that, it should be done at the level of the displayhook. We already do that for `dict`, so it makes sense to do the same for `set`.\n\n+1",
    "created_at": "2017-08-18T09:14:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355025",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@jdemeyer](#comment:11):
> Replying to [@tscrim](#comment:8):
> > Perhaps it will be better to make this robust and just do `sorted(PI.Vrepresentation(), key=str)` instead.

> 
> No, if we want to do that, it should be done at the level of the displayhook. We already do that for `dict`, so it makes sense to do the same for `set`.

+1



---

archive/issue_comments_355026.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nI looked a bit into this, and from reading the sage and IPython code I currently understand how the printing of sets is handled is currently via the pretty printing of IPython. And this pretty printing of ipython already sorts items before printing (although on their actual value and not their string representation). \n\nI just verified this experimentally:\n\n```\nsage: str(set([13^i for i in  range(10,1,-1)]))\n'set([815730721, 62748517, 137858491849, 10604499373, 28561, 2197, 169, 4826809, 371293])'\nsage: set([13^i for i in  range(10,1,-1)])\n{169,\n 2197,\n 28561,\n 371293,\n 4826809,\n 62748517,\n 815730721,\n 10604499373,\n 137858491849}\n```\n\nSo the question is wether we want to change this sorting on `__cmp__` to a sorting on str (or on pretty). \n\nThe current sorting behaviour is ok with respect to the doctest for sets containing objects that have a meaningful `__cmp__` method. However the default fallback for `__cmp__` is comparing objects by their id which is really random. So although the IPython pretty printing is more robust then the standard printing, it is not really robust in general.\n\nThe following current printing behaviour is convincing enough for me that we should still change. \n\n```\nsage: set(GF(13)).union(GF(11))\n{0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10}\nsage: \nsage: set(GF(11)).union(GF(13))\n{0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10}\n```\n\nAfter restarting sage:\n\n```\nsage: set(GF(11)).union(GF(13))\n{0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12}\n```",
    "created_at": "2017-08-18T21:51:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355026",
    "user": "https://github.com/koffie"
}
```

<div id="comment:15" align="right">comment:15</div>

I looked a bit into this, and from reading the sage and IPython code I currently understand how the printing of sets is handled is currently via the pretty printing of IPython. And this pretty printing of ipython already sorts items before printing (although on their actual value and not their string representation). 

I just verified this experimentally:

```
sage: str(set([13^i for i in  range(10,1,-1)]))
'set([815730721, 62748517, 137858491849, 10604499373, 28561, 2197, 169, 4826809, 371293])'
sage: set([13^i for i in  range(10,1,-1)])
{169,
 2197,
 28561,
 371293,
 4826809,
 62748517,
 815730721,
 10604499373,
 137858491849}
```

So the question is wether we want to change this sorting on `__cmp__` to a sorting on str (or on pretty). 

The current sorting behaviour is ok with respect to the doctest for sets containing objects that have a meaningful `__cmp__` method. However the default fallback for `__cmp__` is comparing objects by their id which is really random. So although the IPython pretty printing is more robust then the standard printing, it is not really robust in general.

The following current printing behaviour is convincing enough for me that we should still change. 

```
sage: set(GF(13)).union(GF(11))
{0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10}
sage: 
sage: set(GF(11)).union(GF(13))
{0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10}
```

After restarting sage:

```
sage: set(GF(11)).union(GF(13))
{0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12}
```



---

archive/issue_comments_355027.json:
```json
{
    "body": "Changed commit from **[`9b314dd`](https://github.com/sagemath/sagetrac-mirror/commit/9b314ddf075600df41a0433c5247abce218f36fb)** to **[`50e8265`](https://github.com/sagemath/sagetrac-mirror/commit/50e826589372143407186dad219f86ecbe7ef032)**",
    "created_at": "2017-08-18T23:09:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355027",
    "user": "https://github.com/koffie"
}
```

Changed commit from **[`9b314dd`](https://github.com/sagemath/sagetrac-mirror/commit/9b314ddf075600df41a0433c5247abce218f36fb)** to **[`50e8265`](https://github.com/sagemath/sagetrac-mirror/commit/50e826589372143407186dad219f86ecbe7ef032)**



---

archive/issue_comments_355028.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nI implemented the sorting by str option. Although there are some things I didn't do yet:\n\n- Document the newly written code\n- Adapt the doctests to accommodate the new way of printing\n- Apply this also to the printing of the builtin Set of sage\n\nThe main reason is that I am not 100% sure ye that this is the way to fix this ticket. This way of fixing this ticket namely also means that we now have\n\n```\nsage: set(GF(11))\n{0, 1, 10, 2, 3, 4, 5, 6, 7, 8, 9}\n```\n\ninstead of\n\n```\nsage: set(GF(11))\n{0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10}\n```\n\nAnd this looks ugly to me.\n\nWe could make the order of the printing depend on wether we are currently doctesting, so that the end user is not bothered by the ugly output.\n\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/50e826589372143407186dad219f86ecbe7ef032\">50e8265</a></td><td><code>Make the printed output of sets deterministic, trac 23586</code></td></tr></table>\n",
    "created_at": "2017-08-18T23:09:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355028",
    "user": "https://github.com/koffie"
}
```

<div id="comment:16" align="right">comment:16</div>

I implemented the sorting by str option. Although there are some things I didn't do yet:

- Document the newly written code
- Adapt the doctests to accommodate the new way of printing
- Apply this also to the printing of the builtin Set of sage

The main reason is that I am not 100% sure ye that this is the way to fix this ticket. This way of fixing this ticket namely also means that we now have

```
sage: set(GF(11))
{0, 1, 10, 2, 3, 4, 5, 6, 7, 8, 9}
```

instead of

```
sage: set(GF(11))
{0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10}
```

And this looks ugly to me.

We could make the order of the printing depend on wether we are currently doctesting, so that the end user is not bothered by the ugly output.


---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/50e826589372143407186dad219f86ecbe7ef032">50e8265</a></td><td><code>Make the printed output of sets deterministic, trac 23586</code></td></tr></table>




---

archive/issue_comments_355029.json:
```json
{
    "body": "Changed branch from **[u/chapoton/23586](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/23586)** to **[u/mderickx/23586](https://github.com/sagemath/sagetrac-mirror/tree/u/mderickx/23586)**",
    "created_at": "2017-08-18T23:09:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355029",
    "user": "https://github.com/koffie"
}
```

Changed branch from **[u/chapoton/23586](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/23586)** to **[u/mderickx/23586](https://github.com/sagemath/sagetrac-mirror/tree/u/mderickx/23586)**



---

archive/issue_comments_355030.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nI am actually a little more split on the repr of `set` than initially. I feel like it is better to use the natural sorting, but this is not always sufficient to give a unique ordering (as per Jeoren's example). However, I think it is okay for things to not always work (because the data is essentially unordered), in which can for doctests, we should be more explicit. Yet, I am worried about not using `str` and Python3 of doing something like `set([int(1), 'a'])` as those become incomparable and raise an error. Those errors would be caught, but we would be back in the same situation as now in that the output is random.",
    "created_at": "2017-08-18T23:22:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355030",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:17" align="right">comment:17</div>

I am actually a little more split on the repr of `set` than initially. I feel like it is better to use the natural sorting, but this is not always sufficient to give a unique ordering (as per Jeoren's example). However, I think it is okay for things to not always work (because the data is essentially unordered), in which can for doctests, we should be more explicit. Yet, I am worried about not using `str` and Python3 of doing something like `set([int(1), 'a'])` as those become incomparable and raise an error. Those errors would be caught, but we would be back in the same situation as now in that the output is random.



---

archive/issue_comments_355031.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nYou may want to keep the distinction between sets and frozensets:\n\n```\nFailed example:\n    f.vars\nExpected:\n    frozenset({'x', 'y'})\nGot:\n    {'x', 'y'}\n```",
    "created_at": "2017-08-19T16:37:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355031",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:18" align="right">comment:18</div>

You may want to keep the distinction between sets and frozensets:

```
Failed example:
    f.vars
Expected:
    frozenset({'x', 'y'})
Got:
    {'x', 'y'}
```



---

archive/issue_comments_355032.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nI remember fixing similar fails by not depending on printing at all, i.e. make a result set and compare both sets, testing for \"True\".",
    "created_at": "2017-08-22T14:50:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355032",
    "user": "https://github.com/rwst"
}
```

<div id="comment:19" align="right">comment:19</div>

I remember fixing similar fails by not depending on printing at all, i.e. make a result set and compare both sets, testing for "True".



---

archive/issue_comments_355033.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [@rwst](#comment:19):\n> I remember fixing similar fails by not depending on printing at all, i.e. make a result set and compare both sets, testing for \"True\".\n\nThat might be good for tests, but certainly not for documentation.",
    "created_at": "2017-08-22T17:23:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355033",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [@rwst](#comment:19):
> I remember fixing similar fails by not depending on printing at all, i.e. make a result set and compare both sets, testing for "True".

That might be good for tests, but certainly not for documentation.



---

archive/issue_comments_355034.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nReplying to [@tscrim](#comment:17):\n> I am actually a little more split on the repr of `set` than initially.\n\nWhy are we even discussing this? The obvious answer is: do whatever we do for dicts. A set is just a dict without values and dicts are sorted nicely:\n\n```\nsage: dict((100**i,i) for i in range(20))\n\n{1: 0,\n 100: 1,\n 10000: 2,\n 1000000: 3,\n 100000000: 4,\n 10000000000: 5,\n 1000000000000: 6,\n 100000000000000: 7,\n 10000000000000000: 8,\n 1000000000000000000: 9,\n 100000000000000000000: 10,\n 10000000000000000000000: 11,\n 1000000000000000000000000: 12,\n 100000000000000000000000000: 13,\n 10000000000000000000000000000: 14,\n 1000000000000000000000000000000: 15,\n 100000000000000000000000000000000: 16,\n 10000000000000000000000000000000000: 17,\n 1000000000000000000000000000000000000: 18,\n 100000000000000000000000000000000000000: 19}\n```",
    "created_at": "2017-08-24T07:52:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355034",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:21" align="right">comment:21</div>

Replying to [@tscrim](#comment:17):
> I am actually a little more split on the repr of `set` than initially.

Why are we even discussing this? The obvious answer is: do whatever we do for dicts. A set is just a dict without values and dicts are sorted nicely:

```
sage: dict((100**i,i) for i in range(20))

{1: 0,
 100: 1,
 10000: 2,
 1000000: 3,
 100000000: 4,
 10000000000: 5,
 1000000000000: 6,
 100000000000000: 7,
 10000000000000000: 8,
 1000000000000000000: 9,
 100000000000000000000: 10,
 10000000000000000000000: 11,
 1000000000000000000000000: 12,
 100000000000000000000000000: 13,
 10000000000000000000000000000: 14,
 1000000000000000000000000000000: 15,
 100000000000000000000000000000000: 16,
 10000000000000000000000000000000000: 17,
 1000000000000000000000000000000000000: 18,
 100000000000000000000000000000000000000: 19}
```



---

archive/issue_comments_355035.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nReplying to [@jdemeyer](#comment:21):\n> Replying to [@tscrim](#comment:17):\n> > I am actually a little more split on the repr of `set` than initially.\n\n> \n> Why are we even discussing this? The obvious answer is: do whatever we do for dicts. A set is just a dict without values and dicts are sorted nicely:\n\nI agree that they should be consistent (they both are sorted by ipython, see [comment:15](#comment:15)), but I feel like the discussion is more about what we use for sorting. The question is the use their default comparisons or to use `str` as a key. After a little more thought, having the default comparison is probably best. If something needs special handling because objects are not comparable, then I think deserves to manually have a `sorted(foo, key=str)` for the doctest. Another option would be if their is an error caught by ipython, then default to `key=str`.",
    "created_at": "2017-08-24T14:21:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355035",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:22" align="right">comment:22</div>

Replying to [@jdemeyer](#comment:21):
> Replying to [@tscrim](#comment:17):
> > I am actually a little more split on the repr of `set` than initially.

> 
> Why are we even discussing this? The obvious answer is: do whatever we do for dicts. A set is just a dict without values and dicts are sorted nicely:

I agree that they should be consistent (they both are sorted by ipython, see [comment:15](#comment:15)), but I feel like the discussion is more about what we use for sorting. The question is the use their default comparisons or to use `str` as a key. After a little more thought, having the default comparison is probably best. If something needs special handling because objects are not comparable, then I think deserves to manually have a `sorted(foo, key=str)` for the doctest. Another option would be if their is an error caught by ipython, then default to `key=str`.



---

archive/issue_comments_355036.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nReplying to [@tscrim](#comment:22):\n> I agree that they should be consistent (they both are sorted by ipython, see [comment:15](#comment:15)), but I feel like the discussion is more about what we use for sorting. The question is the use their default comparisons or to use `str` as a key. \n\nYes exactly that is the main question we should reach a consensus over, and why I have stopped writing more code until we know which direction we want to go! I.e. is sorting by `__cmp__` already robust enough for doctest, and should we only allow doctests with sets containing objects with a `__cmp__` method that is deterministic and not likely to change in the future. Or should we adjust the way we sort the output according to str?\n\nIf we do want to sort for str, then there is another choice to be made. Do we want to do this both for user output or just for doctesting. Doing this for user output as well, will give the user less meaningful and more ugly looking output. So the question is whether nice user output outweighs the good practice of output order in doctests and user output being the same. I personally think this is ok since sets are inherently unordered, but am open for other opinions.\n\n> After a little more thought, having the default comparison is probably best. If something needs special handling because objects are not comparable, then I think deserves to manually have a `sorted(foo, key=str)` for the doctest. Another option would be if their is an error caught by ipython, then default to `key=str`.\n\nIn the current failing doctest IPython is not catching any errors so I don't see how the other option would help.\n\np.s. Slightly offtopic, thinking about the subtleties in this ticket I really start to dislike how the coercion framework, `__eq__` and hash interact. There seems to be something inherently contradictory in the assumptions of these three primitives, leading to things like\n\n```\nsage: set(srange(5)).union(GF(3)).union(GF(5))\n{0, 1, 2, 3, 4}\nsage: set(GF(3)).union(GF(5)).union(srange(5))\n{0, 1, 2, 0, 1, 2, 3, 4}\n```",
    "created_at": "2017-08-24T14:44:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355036",
    "user": "https://github.com/koffie"
}
```

<div id="comment:23" align="right">comment:23</div>

Replying to [@tscrim](#comment:22):
> I agree that they should be consistent (they both are sorted by ipython, see [comment:15](#comment:15)), but I feel like the discussion is more about what we use for sorting. The question is the use their default comparisons or to use `str` as a key. 

Yes exactly that is the main question we should reach a consensus over, and why I have stopped writing more code until we know which direction we want to go! I.e. is sorting by `__cmp__` already robust enough for doctest, and should we only allow doctests with sets containing objects with a `__cmp__` method that is deterministic and not likely to change in the future. Or should we adjust the way we sort the output according to str?

If we do want to sort for str, then there is another choice to be made. Do we want to do this both for user output or just for doctesting. Doing this for user output as well, will give the user less meaningful and more ugly looking output. So the question is whether nice user output outweighs the good practice of output order in doctests and user output being the same. I personally think this is ok since sets are inherently unordered, but am open for other opinions.

> After a little more thought, having the default comparison is probably best. If something needs special handling because objects are not comparable, then I think deserves to manually have a `sorted(foo, key=str)` for the doctest. Another option would be if their is an error caught by ipython, then default to `key=str`.

In the current failing doctest IPython is not catching any errors so I don't see how the other option would help.

p.s. Slightly offtopic, thinking about the subtleties in this ticket I really start to dislike how the coercion framework, `__eq__` and hash interact. There seems to be something inherently contradictory in the assumptions of these three primitives, leading to things like

```
sage: set(srange(5)).union(GF(3)).union(GF(5))
{0, 1, 2, 3, 4}
sage: set(GF(3)).union(GF(5)).union(srange(5))
{0, 1, 2, 0, 1, 2, 3, 4}
```



---

archive/issue_comments_355037.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nReplying to [@tscrim](#comment:17):\n> Yet, I am worried about not using `str` and Python3 of doing something like `set([int(1), 'a'])` as those become incomparable and raise an error. Those errors would be caught, but we would be back in the same situation as now in that the output is random.\n\nGood point, due to the work being done on making sage work on Python3 we also should take compatibility with Python3 in mind. I now understand your \"Another option would be if their is an error caught by ipython, then default to key=str.\" remark. This would however only fix things for python3 and not the current situation.",
    "created_at": "2017-08-24T15:01:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355037",
    "user": "https://github.com/koffie"
}
```

<div id="comment:24" align="right">comment:24</div>

Replying to [@tscrim](#comment:17):
> Yet, I am worried about not using `str` and Python3 of doing something like `set([int(1), 'a'])` as those become incomparable and raise an error. Those errors would be caught, but we would be back in the same situation as now in that the output is random.

Good point, due to the work being done on making sage work on Python3 we also should take compatibility with Python3 in mind. I now understand your "Another option would be if their is an error caught by ipython, then default to key=str." remark. This would however only fix things for python3 and not the current situation.



---

archive/issue_events_328136.json:
```json
{
    "actor": "https://github.com/koffie",
    "created_at": "2017-08-29T15:54:31Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "title_is": "Make doctest framework more robust with sets",
    "title_was": "fixing broken pynormaliz doctests",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23586#event-328136"
}
```



---

archive/issue_comments_355038.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nI'm degrading this ticket from blocker status, the blocker part of this ticket (i.e. make the output of patchbot useful again) is now #23637 . \n\nSee also the discussion in https://groups.google.com/forum/#!topic/sage-devel/_2vtRbauvrw",
    "created_at": "2017-08-29T15:54:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355038",
    "user": "https://github.com/koffie"
}
```

<div id="comment:25" align="right">comment:25</div>

I'm degrading this ticket from blocker status, the blocker part of this ticket (i.e. make the output of patchbot useful again) is now #23637 . 

See also the discussion in https://groups.google.com/forum/#!topic/sage-devel/_2vtRbauvrw



---

archive/issue_comments_355039.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,5 +1 @@\n-found by the patchbot\n-\n-see\n-\n-https://patchbot.sagemath.org/log/14153/Gentoo%20Base%20System/2.2/x86_64/4.4.26-gentoo/sage4/2017-08-05%2017:30:09?short\n+Even though the output of sets are sorted in sage it is done so using `__cmp__` which is often nondeterministic. Sorting object with respect to the string that is actually displayed makes the doctesting framework more robust.\n``````\n",
    "created_at": "2017-08-29T15:54:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355039",
    "user": "https://github.com/koffie"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,5 +1 @@
-found by the patchbot
-
-see
-
-https://patchbot.sagemath.org/log/14153/Gentoo%20Base%20System/2.2/x86_64/4.4.26-gentoo/sage4/2017-08-05%2017:30:09?short
+Even though the output of sets are sorted in sage it is done so using `__cmp__` which is often nondeterministic. Sorting object with respect to the string that is actually displayed makes the doctesting framework more robust.
``````




---

archive/issue_events_328137.json:
```json
{
    "actor": "https://github.com/koffie",
    "created_at": "2017-08-29T15:54:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "label": "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p: 1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23586#event-328137"
}
```



---

archive/issue_events_328138.json:
```json
{
    "actor": "https://github.com/koffie",
    "created_at": "2017-08-29T15:54:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23586#event-328138"
}
```



---

archive/issue_comments_355040.json:
```json
{
    "body": "Description changed:\n``````diff\n\n``````\n",
    "created_at": "2017-08-29T15:56:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355040",
    "user": "https://github.com/koffie"
}
```

Description changed:
``````diff

``````




---

archive/issue_comments_355041.json:
```json
{
    "body": "Changed author from **Fr\u00e9d\u00e9ric Chapoton** to **Fr\u00e9d\u00e9ric Chapoton, Jeroen Demeyer**",
    "created_at": "2017-08-31T13:17:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355041",
    "user": "https://github.com/jdemeyer"
}
```

Changed author from **Fr√©d√©ric Chapoton** to **Fr√©d√©ric Chapoton, Jeroen Demeyer**



---

archive/issue_comments_355042.json:
```json
{
    "body": "Changed author from **Fr\u00e9d\u00e9ric Chapoton, Jeroen Demeyer** to **Jeroen Demeyer**",
    "created_at": "2017-08-31T13:18:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355042",
    "user": "https://github.com/fchapoton"
}
```

Changed author from **Fr√©d√©ric Chapoton, Jeroen Demeyer** to **Jeroen Demeyer**



---

archive/issue_comments_355043.json:
```json
{
    "body": "Changed branch from **[u/mderickx/23586](https://github.com/sagemath/sagetrac-mirror/tree/u/mderickx/23586)** to **[u/jdemeyer/23586](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/23586)**",
    "created_at": "2017-08-31T13:54:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355043",
    "user": "https://github.com/jdemeyer"
}
```

Changed branch from **[u/mderickx/23586](https://github.com/sagemath/sagetrac-mirror/tree/u/mderickx/23586)** to **[u/jdemeyer/23586](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/23586)**



---

archive/issue_comments_355044.json:
```json
{
    "body": "Changed commit from **[`50e8265`](https://github.com/sagemath/sagetrac-mirror/commit/50e826589372143407186dad219f86ecbe7ef032)** to **[`394d5a4`](https://github.com/sagemath/sagetrac-mirror/commit/394d5a4f035cf9ef4c92d0288bb4da1c6e420066)**",
    "created_at": "2017-08-31T13:58:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355044",
    "user": "https://github.com/jdemeyer"
}
```

Changed commit from **[`50e8265`](https://github.com/sagemath/sagetrac-mirror/commit/50e826589372143407186dad219f86ecbe7ef032)** to **[`394d5a4`](https://github.com/sagemath/sagetrac-mirror/commit/394d5a4f035cf9ef4c92d0288bb4da1c6e420066)**



---

archive/issue_comments_355045.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1 @@\n-Even though the output of sets are sorted in sage it is done so using `__cmp__` which is often nondeterministic. Sorting object with respect to the string that is actually displayed makes the doctesting framework more robust.\n+Even though the output of sets are sorted in sage it is done so using `__cmp__` which is often nondeterministic.\n``````\n",
    "created_at": "2017-08-31T13:58:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355045",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1 @@
-Even though the output of sets are sorted in sage it is done so using `__cmp__` which is often nondeterministic. Sorting object with respect to the string that is actually displayed makes the doctesting framework more robust.
+Even though the output of sets are sorted in sage it is done so using `__cmp__` which is often nondeterministic.
``````




---

archive/issue_comments_355046.json:
```json
{
    "body": "<div id=\"comment:30\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/394d5a4f035cf9ef4c92d0288bb4da1c6e420066\">394d5a4</a></td><td><code>In pretty printing, sort on str() if sorting fails</code></td></tr></table>\n",
    "created_at": "2017-08-31T13:58:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355046",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:30"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/394d5a4f035cf9ef4c92d0288bb4da1c6e420066">394d5a4</a></td><td><code>In pretty printing, sort on str() if sorting fails</code></td></tr></table>




---

archive/issue_comments_355047.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nI'm starting to think that we don't need a general solution at all. First of all, Python 3 will help here since it will disallow sorting arbitrary objects:\n\n```\n>>> sorted([object(), object()])\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\nTypeError: unorderable types: object() < object()\n```\n\nSecond, this issue doesn't seem to be so severe: this optional doctest is the only place where it comes up.",
    "created_at": "2017-08-31T14:05:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355047",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:31" align="right">comment:31</div>

I'm starting to think that we don't need a general solution at all. First of all, Python 3 will help here since it will disallow sorting arbitrary objects:

```
>>> sorted([object(), object()])
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
TypeError: unorderable types: object() < object()
```

Second, this issue doesn't seem to be so severe: this optional doctest is the only place where it comes up.



---

archive/issue_comments_355048.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nHi, Jeroen.\n\nI agree with your Second point. But I don't agree with your first point. \n\nYou are right that comparing arbitrary objects and hence sorting of hetrogenous collections is not allowed anymore. But I think this will actually make the situation worse, since one is still allowed to make heterogenous sets like set([object(),\"a\",1]). IPython doesn't sort the sets where sorting raises a TypeError, so for these sets it will just print them in the order that python iterates over them, which (I admittedly didn't check) I suspect to be nondeterministic.\n\nHowever as mentioned by Travis in comment 22, we can catch this error and just use sorting by string if normal sorting fails. I think this is a clean solution, so we could also just fix it for python 3 and leave the python 2 behaviour as is.",
    "created_at": "2017-08-31T15:05:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355048",
    "user": "https://github.com/koffie"
}
```

<div id="comment:32" align="right">comment:32</div>

Hi, Jeroen.

I agree with your Second point. But I don't agree with your first point. 

You are right that comparing arbitrary objects and hence sorting of hetrogenous collections is not allowed anymore. But I think this will actually make the situation worse, since one is still allowed to make heterogenous sets like set([object(),"a",1]). IPython doesn't sort the sets where sorting raises a TypeError, so for these sets it will just print them in the order that python iterates over them, which (I admittedly didn't check) I suspect to be nondeterministic.

However as mentioned by Travis in comment 22, we can catch this error and just use sorting by string if normal sorting fails. I think this is a clean solution, so we could also just fix it for python 3 and leave the python 2 behaviour as is.



---

archive/issue_events_328139.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-08-31T15:16:41Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "title_is": "Pretty print: sort by string if sorting fails",
    "title_was": "Make doctest framework more robust with sets",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23586#event-328139"
}
```



---

archive/issue_events_328140.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-08-31T15:16:41Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20packages%3A%20optional",
    "label_color": "000080",
    "label_name": "c: packages: optional",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23586#event-328140"
}
```



---

archive/issue_events_328141.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-08-31T15:16:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20packages%3A%20standard",
    "label_color": "000080",
    "label_name": "c: packages: standard",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23586#event-328141"
}
```



---

archive/issue_events_328142.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-08-31T15:16:41Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23586#event-328142"
}
```



---

archive/issue_events_328143.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-08-31T15:16:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23586#event-328143"
}
```



---

archive/issue_comments_355049.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,7 @@\n-Even though the output of sets are sorted in sage it is done so using `__cmp__` which is often nondeterministic.\n+Whenever IPython prints a dict or set, it tries to sort the keys for a nicer output. If the sorting fails, then no sorting is done.\n+\n+This ticket proposes instead to sort on the string representation if the usual sorting fails. That way, we almost certainly get a deterministic output, which is mainly useful for doctests.\n+\n+It must be said that sorting rarely fails on Python 2, so this would affect mostly Python 3.\n+\n+**Upstream**: https://github.com/ipython/ipython/pull/10767\n``````\n",
    "created_at": "2017-08-31T15:16:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355049",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,7 @@
-Even though the output of sets are sorted in sage it is done so using `__cmp__` which is often nondeterministic.
+Whenever IPython prints a dict or set, it tries to sort the keys for a nicer output. If the sorting fails, then no sorting is done.
+
+This ticket proposes instead to sort on the string representation if the usual sorting fails. That way, we almost certainly get a deterministic output, which is mainly useful for doctests.
+
+It must be said that sorting rarely fails on Python 2, so this would affect mostly Python 3.
+
+**Upstream**: https://github.com/ipython/ipython/pull/10767
``````




---

archive/issue_comments_355050.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nWhy needs review? I agree with the new description. But we still need to see if IPython accepts our PR and update ipython after it had done so.",
    "created_at": "2017-08-31T15:26:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355050",
    "user": "https://github.com/koffie"
}
```

<div id="comment:34" align="right">comment:34</div>

Why needs review? I agree with the new description. But we still need to see if IPython accepts our PR and update ipython after it had done so.



---

archive/issue_events_328144.json:
```json
{
    "actor": "https://github.com/koffie",
    "created_at": "2017-08-31T15:26:51Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23586#event-328144"
}
```



---

archive/issue_events_328145.json:
```json
{
    "actor": "https://github.com/koffie",
    "created_at": "2017-08-31T15:26:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23586#event-328145"
}
```



---

archive/issue_comments_355051.json:
```json
{
    "body": "Upstream: **Reported upstream. No feedback yet.**",
    "created_at": "2017-08-31T15:26:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355051",
    "user": "https://github.com/koffie"
}
```

Upstream: **Reported upstream. No feedback yet.**



---

archive/issue_comments_355052.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nPull request has been merged...",
    "created_at": "2017-11-24T08:25:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355052",
    "user": "https://github.com/videlec"
}
```

<div id="comment:35" align="right">comment:35</div>

Pull request has been merged...



---

archive/issue_comments_355053.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nclose as obsolete ?",
    "created_at": "2021-10-10T08:34:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355053",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:36" align="right">comment:36</div>

close as obsolete ?



---

archive/issue_events_328146.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2021-10-10T08:34:07Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "milestone_number": null,
    "milestone_title": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23586#event-328146"
}
```



---

archive/issue_events_328147.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2021-10-10T08:34:07Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23586#event-328147"
}
```



---

archive/issue_events_328148.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2021-10-10T08:34:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "label": "https://github.com/sagemath/sage/labels/invalid",
    "label_color": "a6a6a6",
    "label_name": "invalid",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23586#event-328148"
}
```



---

archive/issue_events_328149.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2021-10-10T08:34:07Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23586#event-328149"
}
```



---

archive/issue_events_328150.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2021-10-10T08:34:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23586#event-328150"
}
```



---

archive/issue_comments_355054.json:
```json
{
    "body": "Reviewer: **Fran\u00e7ois Bissey**",
    "created_at": "2021-10-10T08:40:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355054",
    "user": "https://github.com/kiwifb"
}
```

Reviewer: **Fran√ßois Bissey**



---

archive/issue_events_328151.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2021-10-10T08:40:24Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23586#event-328151"
}
```



---

archive/issue_events_328152.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2021-10-10T08:40:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23586#event-328152"
}
```



---

archive/issue_comments_355055.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nSeems like the people involved lost interest 4 years ago so let's obsolete it.",
    "created_at": "2021-10-10T08:40:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23586#issuecomment-355055",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:37" align="right">comment:37</div>

Seems like the people involved lost interest 4 years ago so let's obsolete it.



---

archive/issue_events_328153.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2021-10-11T08:43:22Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23586#event-328153"
}
```



---

archive/issue_events_328154.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2021-10-11T08:43:22Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/23586",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23586#event-328154"
}
```
