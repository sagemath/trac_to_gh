# Issue 23586: Pretty print: sort by string if sorting fails

archive/issues_023349.json:
```json
{
    "body": "Whenever IPython prints a dict or set, it tries to sort the keys for a nicer output. If the sorting fails, then no sorting is done.\n\nThis ticket proposes instead to sort on the string representation if the usual sorting fails. That way, we almost certainly get a deterministic output, which is mainly useful for doctests.\n\nIt must be said that sorting rarely fails on Python 2, so this would affect mostly Python 3.\n\n**Upstream**: https://github.com/ipython/ipython/pull/10767\n\nCC:  @mkoeppe @dkrenn @koffie\n\nUpstream: Reported upstream. No feedback yet.\n\nReviewer: Fran\u00e7ois Bissey\n\nAuthor: Jeroen Demeyer\n\nBranch: u/jdemeyer/23586\n\nCommit: 394d5a4f035cf9ef4c92d0288bb4da1c6e420066\n\nResolution: invalid\n\nIssue created by migration from https://trac.sagemath.org/ticket/23586\n\n",
    "closed_at": "2021-10-11T08:43:22Z",
    "created_at": "2017-08-05T20:52:30Z",
    "labels": [
        "component: packages: standard",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Pretty print: sort by string if sorting fails",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23586",
    "user": "https://github.com/fchapoton"
}
```
Whenever IPython prints a dict or set, it tries to sort the keys for a nicer output. If the sorting fails, then no sorting is done.

This ticket proposes instead to sort on the string representation if the usual sorting fails. That way, we almost certainly get a deterministic output, which is mainly useful for doctests.

It must be said that sorting rarely fails on Python 2, so this would affect mostly Python 3.

**Upstream**: https://github.com/ipython/ipython/pull/10767

CC:  @mkoeppe @dkrenn @koffie

Upstream: Reported upstream. No feedback yet.

Reviewer: Fran√ßois Bissey

Author: Jeroen Demeyer

Branch: u/jdemeyer/23586

Commit: 394d5a4f035cf9ef4c92d0288bb4da1c6e420066

Resolution: invalid

Issue created by migration from https://trac.sagemath.org/ticket/23586





---

archive/issue_comments_347855.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-08-05T20:52:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347855",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_347856.json:
```json
{
    "body": "<a id='comment:1'></a>New commits:",
    "created_at": "2017-08-05T20:52:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347856",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:1'></a>New commits:



---

archive/issue_comments_347857.json:
```json
{
    "body": "<a id='comment:2'></a>bot is morally green",
    "created_at": "2017-08-07T09:57:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347857",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:2'></a>bot is morally green



---

archive/issue_comments_347858.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2017-08-11T07:54:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347858",
    "user": "https://github.com/jdemeyer"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_347859.json:
```json
{
    "body": "<a id='comment:4'></a>Do you have any idea why the output has changed? I usually find it dangerous to just accept doctest changes like this without understanding the reason.",
    "created_at": "2017-08-11T07:55:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347859",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>Do you have any idea why the output has changed? I usually find it dangerous to just accept doctest changes like this without understanding the reason.



---

archive/issue_comments_347860.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:2 chapoton]:\n> bot is morally green\n\n\nThose bots do not have `pynormaliz` installed, that means nothing...\n\nOn my bots I try to install all optional packages, so `sage4` and `arando` should have it.",
    "created_at": "2017-08-11T07:57:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347860",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>Replying to [comment:2 chapoton]:
> bot is morally green


Those bots do not have `pynormaliz` installed, that means nothing...

On my bots I try to install all optional packages, so `sage4` and `arando` should have it.



---

archive/issue_comments_347861.json:
```json
{
    "body": "<a id='comment:6'></a>Looks to me like only the ordering of the solutions has changed. The overall set is still the same.",
    "created_at": "2017-08-11T07:58:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347861",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:6'></a>Looks to me like only the ordering of the solutions has changed. The overall set is still the same.



---

archive/issue_comments_347862.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:6 fbissey]:\n> Looks to me like only the ordering of the solutions has changed.\n\n\nThat still doesn't answer the \"why\" question.",
    "created_at": "2017-08-11T07:59:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347862",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>Replying to [comment:6 fbissey]:
> Looks to me like only the ordering of the solutions has changed.


That still doesn't answer the "why" question.



---

archive/issue_comments_347863.json:
```json
{
    "body": "<a id='comment:8'></a>It's a set, so it is inherently unordered. Although my guess is either changes in the comparisons or the hash led to this change. Perhaps it will be better to make this robust and just do `sorted(PI.Vrepresentation(), key=str)` instead.",
    "created_at": "2017-08-11T08:48:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347863",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:8'></a>It's a set, so it is inherently unordered. Although my guess is either changes in the comparisons or the hash led to this change. Perhaps it will be better to make this robust and just do `sorted(PI.Vrepresentation(), key=str)` instead.



---

archive/issue_comments_347864.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:8 tscrim]:\n> Perhaps it will be better to make this robust and just do `sorted(PI.Vrepresentation(), key=str)` instead.\n\n\n+1",
    "created_at": "2017-08-11T20:42:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347864",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'></a>Replying to [comment:8 tscrim]:
> Perhaps it will be better to make this robust and just do `sorted(PI.Vrepresentation(), key=str)` instead.


+1



---

archive/issue_comments_347865.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-08-11T20:42:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347865",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_347866.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:8 tscrim]:\n> Perhaps it will be better to make this robust and just do `sorted(PI.Vrepresentation(), key=str)` instead.\n\n\nNo, if we want to do that, it should be done at the level of the displayhook. We already do that for `dict`, so it makes sense to do the same for `set`.",
    "created_at": "2017-08-18T07:23:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347866",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>Replying to [comment:8 tscrim]:
> Perhaps it will be better to make this robust and just do `sorted(PI.Vrepresentation(), key=str)` instead.


No, if we want to do that, it should be done at the level of the displayhook. We already do that for `dict`, so it makes sense to do the same for `set`.



---

archive/issue_comments_347867.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:11 jdemeyer]:\n> Replying to [comment:8 tscrim]:\n> No, if we want to do that, it should be done at the level of the displayhook. We already do that for `dict`, so it makes sense to do the same for `set`.\n\n\n+1",
    "created_at": "2017-08-18T08:51:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347867",
    "user": "https://github.com/dkrenn"
}
```

<a id='comment:13'></a>Replying to [comment:11 jdemeyer]:
> Replying to [comment:8 tscrim]:
> No, if we want to do that, it should be done at the level of the displayhook. We already do that for `dict`, so it makes sense to do the same for `set`.


+1



---

archive/issue_comments_347868.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [comment:11 jdemeyer]:\n> Replying to [comment:8 tscrim]:\n> > Perhaps it will be better to make this robust and just do `sorted(PI.Vrepresentation(), key=str)` instead.\n\n> \n> No, if we want to do that, it should be done at the level of the displayhook. We already do that for `dict`, so it makes sense to do the same for `set`.\n\n\n+1",
    "created_at": "2017-08-18T09:14:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347868",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:14'></a>Replying to [comment:11 jdemeyer]:
> Replying to [comment:8 tscrim]:
> > Perhaps it will be better to make this robust and just do `sorted(PI.Vrepresentation(), key=str)` instead.

> 
> No, if we want to do that, it should be done at the level of the displayhook. We already do that for `dict`, so it makes sense to do the same for `set`.


+1



---

archive/issue_comments_347869.json:
```json
{
    "body": "<a id='comment:15'></a>I looked a bit into this, and from reading the sage and IPython code I currently understand how the printing of sets is handled is currently via the pretty printing of IPython. And this pretty printing of ipython already sorts items before printing (although on their actual value and not their string representation). \n\nI just verified this experimentally:\n\n```\nsage: str(set([13^i for i in  range(10,1,-1)]))\n'set([815730721, 62748517, 137858491849, 10604499373, 28561, 2197, 169, 4826809, 371293])'\nsage: set([13^i for i in  range(10,1,-1)])\n{169,\n 2197,\n 28561,\n 371293,\n 4826809,\n 62748517,\n 815730721,\n 10604499373,\n 137858491849}\n```\n\nSo the question is wether we want to change this sorting on `__cmp__` to a sorting on str (or on pretty). \n\nThe current sorting behaviour is ok with respect to the doctest for sets containing objects that have a meaningful `__cmp__` method. However the default fallback for `__cmp__` is comparing objects by their id which is really random. So although the IPython pretty printing is more robust then the standard printing, it is not really robust in general.\n\nThe following current printing behaviour is convincing enough for me that we should still change. \n\n```\nsage: set(GF(13)).union(GF(11))\n{0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10}\nsage: \nsage: set(GF(11)).union(GF(13))\n{0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10}\n```\n\nAfter restarting sage:\n\n```\nsage: set(GF(11)).union(GF(13))\n{0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12}\n```",
    "created_at": "2017-08-18T21:51:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347869",
    "user": "https://github.com/koffie"
}
```

<a id='comment:15'></a>I looked a bit into this, and from reading the sage and IPython code I currently understand how the printing of sets is handled is currently via the pretty printing of IPython. And this pretty printing of ipython already sorts items before printing (although on their actual value and not their string representation). 

I just verified this experimentally:

```
sage: str(set([13^i for i in  range(10,1,-1)]))
'set([815730721, 62748517, 137858491849, 10604499373, 28561, 2197, 169, 4826809, 371293])'
sage: set([13^i for i in  range(10,1,-1)])
{169,
 2197,
 28561,
 371293,
 4826809,
 62748517,
 815730721,
 10604499373,
 137858491849}
```

So the question is wether we want to change this sorting on `__cmp__` to a sorting on str (or on pretty). 

The current sorting behaviour is ok with respect to the doctest for sets containing objects that have a meaningful `__cmp__` method. However the default fallback for `__cmp__` is comparing objects by their id which is really random. So although the IPython pretty printing is more robust then the standard printing, it is not really robust in general.

The following current printing behaviour is convincing enough for me that we should still change. 

```
sage: set(GF(13)).union(GF(11))
{0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10}
sage: 
sage: set(GF(11)).union(GF(13))
{0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10}
```

After restarting sage:

```
sage: set(GF(11)).union(GF(13))
{0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12}
```



---

archive/issue_comments_347870.json:
```json
{
    "body": "<a id='comment:16'></a>I implemented the sorting by str option. Although there are some things I didn't do yet:\n\n- Document the newly written code\n- Adapt the doctests to accommodate the new way of printing\n- Apply this also to the printing of the builtin Set of sage\n\nThe main reason is that I am not 100% sure ye that this is the way to fix this ticket. This way of fixing this ticket namely also means that we now have\n\n```\nsage: set(GF(11))\n{0, 1, 10, 2, 3, 4, 5, 6, 7, 8, 9}\n```\n\ninstead of\n\n```\nsage: set(GF(11))\n{0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10}\n```\n\nAnd this looks ugly to me.\n\nWe could make the order of the printing depend on wether we are currently doctesting, so that the end user is not bothered by the ugly output.\n\n\n---\nNew commits:",
    "created_at": "2017-08-18T23:09:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347870",
    "user": "https://github.com/koffie"
}
```

<a id='comment:16'></a>I implemented the sorting by str option. Although there are some things I didn't do yet:

- Document the newly written code
- Adapt the doctests to accommodate the new way of printing
- Apply this also to the printing of the builtin Set of sage

The main reason is that I am not 100% sure ye that this is the way to fix this ticket. This way of fixing this ticket namely also means that we now have

```
sage: set(GF(11))
{0, 1, 10, 2, 3, 4, 5, 6, 7, 8, 9}
```

instead of

```
sage: set(GF(11))
{0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10}
```

And this looks ugly to me.

We could make the order of the printing depend on wether we are currently doctesting, so that the end user is not bothered by the ugly output.


---
New commits:



---

archive/issue_comments_347871.json:
```json
{
    "body": "<a id='comment:17'></a>I am actually a little more split on the repr of `set` than initially. I feel like it is better to use the natural sorting, but this is not always sufficient to give a unique ordering (as per Jeoren's example). However, I think it is okay for things to not always work (because the data is essentially unordered), in which can for doctests, we should be more explicit. Yet, I am worried about not using `str` and Python3 of doing something like `set([int(1), 'a'])` as those become incomparable and raise an error. Those errors would be caught, but we would be back in the same situation as now in that the output is random.",
    "created_at": "2017-08-18T23:22:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347871",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:17'></a>I am actually a little more split on the repr of `set` than initially. I feel like it is better to use the natural sorting, but this is not always sufficient to give a unique ordering (as per Jeoren's example). However, I think it is okay for things to not always work (because the data is essentially unordered), in which can for doctests, we should be more explicit. Yet, I am worried about not using `str` and Python3 of doing something like `set([int(1), 'a'])` as those become incomparable and raise an error. Those errors would be caught, but we would be back in the same situation as now in that the output is random.



---

archive/issue_comments_347872.json:
```json
{
    "body": "<a id='comment:18'></a>You may want to keep the distinction between sets and frozensets:\n\n```\nFailed example:\n    f.vars\nExpected:\n    frozenset({'x', 'y'})\nGot:\n    {'x', 'y'}\n```",
    "created_at": "2017-08-19T16:37:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347872",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:18'></a>You may want to keep the distinction between sets and frozensets:

```
Failed example:
    f.vars
Expected:
    frozenset({'x', 'y'})
Got:
    {'x', 'y'}
```



---

archive/issue_comments_347873.json:
```json
{
    "body": "<a id='comment:19'></a>I remember fixing similar fails by not depending on printing at all, i.e. make a result set and compare both sets, testing for \"True\".",
    "created_at": "2017-08-22T14:50:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347873",
    "user": "https://github.com/rwst"
}
```

<a id='comment:19'></a>I remember fixing similar fails by not depending on printing at all, i.e. make a result set and compare both sets, testing for "True".



---

archive/issue_comments_347874.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [comment:19 rws]:\n> I remember fixing similar fails by not depending on printing at all, i.e. make a result set and compare both sets, testing for \"True\".\n\n\nThat might be good for tests, but certainly not for documentation.",
    "created_at": "2017-08-22T17:23:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347874",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>Replying to [comment:19 rws]:
> I remember fixing similar fails by not depending on printing at all, i.e. make a result set and compare both sets, testing for "True".


That might be good for tests, but certainly not for documentation.



---

archive/issue_comments_347875.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [comment:17 tscrim]:\n> I am actually a little more split on the repr of `set` than initially.\n\n\nWhy are we even discussing this? The obvious answer is: do whatever we do for dicts. A set is just a dict without values and dicts are sorted nicely:\n\n```\nsage: dict((100**i,i) for i in range(20))\n\n{1: 0,\n 100: 1,\n 10000: 2,\n 1000000: 3,\n 100000000: 4,\n 10000000000: 5,\n 1000000000000: 6,\n 100000000000000: 7,\n 10000000000000000: 8,\n 1000000000000000000: 9,\n 100000000000000000000: 10,\n 10000000000000000000000: 11,\n 1000000000000000000000000: 12,\n 100000000000000000000000000: 13,\n 10000000000000000000000000000: 14,\n 1000000000000000000000000000000: 15,\n 100000000000000000000000000000000: 16,\n 10000000000000000000000000000000000: 17,\n 1000000000000000000000000000000000000: 18,\n 100000000000000000000000000000000000000: 19}\n```",
    "created_at": "2017-08-24T07:52:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347875",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>Replying to [comment:17 tscrim]:
> I am actually a little more split on the repr of `set` than initially.


Why are we even discussing this? The obvious answer is: do whatever we do for dicts. A set is just a dict without values and dicts are sorted nicely:

```
sage: dict((100**i,i) for i in range(20))

{1: 0,
 100: 1,
 10000: 2,
 1000000: 3,
 100000000: 4,
 10000000000: 5,
 1000000000000: 6,
 100000000000000: 7,
 10000000000000000: 8,
 1000000000000000000: 9,
 100000000000000000000: 10,
 10000000000000000000000: 11,
 1000000000000000000000000: 12,
 100000000000000000000000000: 13,
 10000000000000000000000000000: 14,
 1000000000000000000000000000000: 15,
 100000000000000000000000000000000: 16,
 10000000000000000000000000000000000: 17,
 1000000000000000000000000000000000000: 18,
 100000000000000000000000000000000000000: 19}
```



---

archive/issue_comments_347876.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [comment:21 jdemeyer]:\n> Replying to [comment:17 tscrim]:\n> > I am actually a little more split on the repr of `set` than initially.\n\n> \n> Why are we even discussing this? The obvious answer is: do whatever we do for dicts. A set is just a dict without values and dicts are sorted nicely:\n\n\nI agree that they should be consistent (they both are sorted by ipython, see comment:15), but I feel like the discussion is more about what we use for sorting. The question is the use their default comparisons or to use `str` as a key. After a little more thought, having the default comparison is probably best. If something needs special handling because objects are not comparable, then I think deserves to manually have a `sorted(foo, key=str)` for the doctest. Another option would be if their is an error caught by ipython, then default to `key=str`.",
    "created_at": "2017-08-24T14:21:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347876",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:22'></a>Replying to [comment:21 jdemeyer]:
> Replying to [comment:17 tscrim]:
> > I am actually a little more split on the repr of `set` than initially.

> 
> Why are we even discussing this? The obvious answer is: do whatever we do for dicts. A set is just a dict without values and dicts are sorted nicely:


I agree that they should be consistent (they both are sorted by ipython, see comment:15), but I feel like the discussion is more about what we use for sorting. The question is the use their default comparisons or to use `str` as a key. After a little more thought, having the default comparison is probably best. If something needs special handling because objects are not comparable, then I think deserves to manually have a `sorted(foo, key=str)` for the doctest. Another option would be if their is an error caught by ipython, then default to `key=str`.



---

archive/issue_comments_347877.json:
```json
{
    "body": "<a id='comment:23'></a>Replying to [comment:22 tscrim]:\n> I agree that they should be consistent (they both are sorted by ipython, see comment:15), but I feel like the discussion is more about what we use for sorting. The question is the use their default comparisons or to use `str` as a key. \n\n\nYes exactly that is the main question we should reach a consensus over, and why I have stopped writing more code until we know which direction we want to go! I.e. is sorting by `__cmp__` already robust enough for doctest, and should we only allow doctests with sets containing objects with a `__cmp__` method that is deterministic and not likely to change in the future. Or should we adjust the way we sort the output according to str?\n\nIf we do want to sort for str, then there is another choice to be made. Do we want to do this both for user output or just for doctesting. Doing this for user output as well, will give the user less meaningful and more ugly looking output. So the question is whether nice user output outweighs the good practice of output order in doctests and user output being the same. I personally think this is ok since sets are inherently unordered, but am open for other opinions.\n\n> After a little more thought, having the default comparison is probably best. If something needs special handling because objects are not comparable, then I think deserves to manually have a `sorted(foo, key=str)` for the doctest. Another option would be if their is an error caught by ipython, then default to `key=str`.\n\n\nIn the current failing doctest IPython is not catching any errors so I don't see how the other option would help.\n\np.s. Slightly offtopic, thinking about the subtleties in this ticket I really start to dislike how the coercion framework, `__eq__` and hash interact. There seems to be something inherently contradictory in the assumptions of these three primitives, leading to things like\n\n```\nsage: set(srange(5)).union(GF(3)).union(GF(5))\n{0, 1, 2, 3, 4}\nsage: set(GF(3)).union(GF(5)).union(srange(5))\n{0, 1, 2, 0, 1, 2, 3, 4}\n```",
    "created_at": "2017-08-24T14:44:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347877",
    "user": "https://github.com/koffie"
}
```

<a id='comment:23'></a>Replying to [comment:22 tscrim]:
> I agree that they should be consistent (they both are sorted by ipython, see comment:15), but I feel like the discussion is more about what we use for sorting. The question is the use their default comparisons or to use `str` as a key. 


Yes exactly that is the main question we should reach a consensus over, and why I have stopped writing more code until we know which direction we want to go! I.e. is sorting by `__cmp__` already robust enough for doctest, and should we only allow doctests with sets containing objects with a `__cmp__` method that is deterministic and not likely to change in the future. Or should we adjust the way we sort the output according to str?

If we do want to sort for str, then there is another choice to be made. Do we want to do this both for user output or just for doctesting. Doing this for user output as well, will give the user less meaningful and more ugly looking output. So the question is whether nice user output outweighs the good practice of output order in doctests and user output being the same. I personally think this is ok since sets are inherently unordered, but am open for other opinions.

> After a little more thought, having the default comparison is probably best. If something needs special handling because objects are not comparable, then I think deserves to manually have a `sorted(foo, key=str)` for the doctest. Another option would be if their is an error caught by ipython, then default to `key=str`.


In the current failing doctest IPython is not catching any errors so I don't see how the other option would help.

p.s. Slightly offtopic, thinking about the subtleties in this ticket I really start to dislike how the coercion framework, `__eq__` and hash interact. There seems to be something inherently contradictory in the assumptions of these three primitives, leading to things like

```
sage: set(srange(5)).union(GF(3)).union(GF(5))
{0, 1, 2, 3, 4}
sage: set(GF(3)).union(GF(5)).union(srange(5))
{0, 1, 2, 0, 1, 2, 3, 4}
```



---

archive/issue_comments_347878.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:17 tscrim]:\n> Yet, I am worried about not using `str` and Python3 of doing something like `set([int(1), 'a'])` as those become incomparable and raise an error. Those errors would be caught, but we would be back in the same situation as now in that the output is random.\n\n\nGood point, due to the work being done on making sage work on Python3 we also should take compatibility with Python3 in mind. I now understand your \"Another option would be if their is an error caught by ipython, then default to key=str.\" remark. This would however only fix things for python3 and not the current situation.",
    "created_at": "2017-08-24T15:01:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347878",
    "user": "https://github.com/koffie"
}
```

<a id='comment:24'></a>Replying to [comment:17 tscrim]:
> Yet, I am worried about not using `str` and Python3 of doing something like `set([int(1), 'a'])` as those become incomparable and raise an error. Those errors would be caught, but we would be back in the same situation as now in that the output is random.


Good point, due to the work being done on making sage work on Python3 we also should take compatibility with Python3 in mind. I now understand your "Another option would be if their is an error caught by ipython, then default to key=str." remark. This would however only fix things for python3 and not the current situation.



---

archive/issue_comments_347879.json:
```json
{
    "body": "<a id='comment:25'></a>I'm degrading this ticket from blocker status, the blocker part of this ticket (i.e. make the output of patchbot useful again) is now #23637 . \n\nSee also the discussion in https://groups.google.com/forum/#!topic/sage-devel/_2vtRbauvrw",
    "created_at": "2017-08-29T15:54:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347879",
    "user": "https://github.com/koffie"
}
```

<a id='comment:25'></a>I'm degrading this ticket from blocker status, the blocker part of this ticket (i.e. make the output of patchbot useful again) is now #23637 . 

See also the discussion in https://groups.google.com/forum/#!topic/sage-devel/_2vtRbauvrw



---

archive/issue_comments_347880.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,8 +1,4 @@\n-found by the patchbot\n-\n-see\n-\n-https://patchbot.sagemath.org/log/14153/Gentoo%20Base%20System/2.2/x86_64/4.4.26-gentoo/sage4/2017-08-05%2017:30:09?short\n+Even though the output of sets are sorted in sage it is done so using __cmp__ which is often nondeterministic. Sorting object with respect to the string that is actually displayed makes the doctesting framework more robust.\n \n Author: Fr\u00e9d\u00e9ric Chapoton\n \n```\n",
    "created_at": "2017-08-29T15:54:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347880",
    "user": "https://github.com/koffie"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,8 +1,4 @@
-found by the patchbot
-
-see
-
-https://patchbot.sagemath.org/log/14153/Gentoo%20Base%20System/2.2/x86_64/4.4.26-gentoo/sage4/2017-08-05%2017:30:09?short
+Even though the output of sets are sorted in sage it is done so using __cmp__ which is often nondeterministic. Sorting object with respect to the string that is actually displayed makes the doctesting framework more robust.
 
 Author: Fr√©d√©ric Chapoton
 
```




---

archive/issue_comments_347881.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-\n+Even though the output of sets are sorted in sage it is done so using \\`__cmp__\\` which is often nondeterministic. Sorting object with respect to the string that is actually displayed makes the doctesting framework more robust.\n \n Author: Fr\u00e9d\u00e9ric Chapoton\n \n```\n",
    "created_at": "2017-08-29T15:56:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347881",
    "user": "https://github.com/koffie"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,4 @@
-
+Even though the output of sets are sorted in sage it is done so using \`__cmp__\` which is often nondeterministic. Sorting object with respect to the string that is actually displayed makes the doctesting framework more robust.
 
 Author: Fr√©d√©ric Chapoton
 
```




---

archive/issue_comments_347882.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-\n+Even though the output of sets are sorted in sage it is done so using \\`__cmp__\\` which is often nondeterministic.\n \n Author: Fr\u00e9d\u00e9ric Chapoton\n \n```\n",
    "created_at": "2017-08-31T13:58:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347882",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,4 @@
-
+Even though the output of sets are sorted in sage it is done so using \`__cmp__\` which is often nondeterministic.
 
 Author: Fr√©d√©ric Chapoton
 
```




---

archive/issue_comments_347883.json:
```json
{
    "body": "<a id='comment:30'></a>New commits:",
    "created_at": "2017-08-31T13:58:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347883",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:30'></a>New commits:



---

archive/issue_comments_347884.json:
```json
{
    "body": "<a id='comment:31'></a>I'm starting to think that we don't need a general solution at all. First of all, Python 3 will help here since it will disallow sorting arbitrary objects:\n\n```\n>>> sorted([object(), object()])\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\nTypeError: unorderable types: object() < object()\n```\n\nSecond, this issue doesn't seem to be so severe: this optional doctest is the only place where it comes up.",
    "created_at": "2017-08-31T14:05:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347884",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:31'></a>I'm starting to think that we don't need a general solution at all. First of all, Python 3 will help here since it will disallow sorting arbitrary objects:

```
>>> sorted([object(), object()])
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
TypeError: unorderable types: object() < object()
```

Second, this issue doesn't seem to be so severe: this optional doctest is the only place where it comes up.



---

archive/issue_comments_347885.json:
```json
{
    "body": "<a id='comment:32'></a>Hi, Jeroen.\n\nI agree with your Second point. But I don't agree with your first point. \n\nYou are right that comparing arbitrary objects and hence sorting of hetrogenous collections is not allowed anymore. But I think this will actually make the situation worse, since one is still allowed to make heterogenous sets like set([object(),\"a\",1]). IPython doesn't sort the sets where sorting raises a TypeError, so for these sets it will just print them in the order that python iterates over them, which (I admittedly didn't check) I suspect to be nondeterministic.\n\nHowever as mentioned by Travis in comment 22, we can catch this error and just use sorting by string if normal sorting fails. I think this is a clean solution, so we could also just fix it for python 3 and leave the python 2 behaviour as is.",
    "created_at": "2017-08-31T15:05:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347885",
    "user": "https://github.com/koffie"
}
```

<a id='comment:32'></a>Hi, Jeroen.

I agree with your Second point. But I don't agree with your first point. 

You are right that comparing arbitrary objects and hence sorting of hetrogenous collections is not allowed anymore. But I think this will actually make the situation worse, since one is still allowed to make heterogenous sets like set([object(),"a",1]). IPython doesn't sort the sets where sorting raises a TypeError, so for these sets it will just print them in the order that python iterates over them, which (I admittedly didn't check) I suspect to be nondeterministic.

However as mentioned by Travis in comment 22, we can catch this error and just use sorting by string if normal sorting fails. I think this is a clean solution, so we could also just fix it for python 3 and leave the python 2 behaviour as is.



---

archive/issue_comments_347886.json:
```json
{
    "body": "Changing component from packages: optional to packages: standard.",
    "created_at": "2017-08-31T15:16:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347886",
    "user": "https://github.com/jdemeyer"
}
```

Changing component from packages: optional to packages: standard.



---

archive/issue_comments_347887.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-08-31T15:16:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347887",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_347888.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,10 @@\n+Whenever IPython prints a dict or set, it tries to sort the keys for a nicer output. If the sorting fails, then no sorting is done.\n \n+This ticket proposes instead to sort on the string representation if the usual sorting fails. That way, we almost certainly get a deterministic output, which is mainly useful for doctests.\n+\n+It must be said that sorting rarely fails on Python 2, so this would affect mostly Python 3.\n+\n+**Upstream**: https://github.com/ipython/ipython/pull/10767\n \n Author: Fr\u00e9d\u00e9ric Chapoton\n \n```\n",
    "created_at": "2017-08-31T15:16:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347888",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,10 @@
+Whenever IPython prints a dict or set, it tries to sort the keys for a nicer output. If the sorting fails, then no sorting is done.
 
+This ticket proposes instead to sort on the string representation if the usual sorting fails. That way, we almost certainly get a deterministic output, which is mainly useful for doctests.
+
+It must be said that sorting rarely fails on Python 2, so this would affect mostly Python 3.
+
+**Upstream**: https://github.com/ipython/ipython/pull/10767
 
 Author: Fr√©d√©ric Chapoton
 
```




---

archive/issue_comments_347889.json:
```json
{
    "body": "<a id='comment:34'></a>Why needs review? I agree with the new description. But we still need to see if IPython accepts our PR and update ipython after it had done so.",
    "created_at": "2017-08-31T15:26:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347889",
    "user": "https://github.com/koffie"
}
```

<a id='comment:34'></a>Why needs review? I agree with the new description. But we still need to see if IPython accepts our PR and update ipython after it had done so.



---

archive/issue_comments_347890.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-08-31T15:26:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347890",
    "user": "https://github.com/koffie"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_347891.json:
```json
{
    "body": "<a id='comment:35'></a>Pull request has been merged...",
    "created_at": "2017-11-24T08:25:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347891",
    "user": "https://github.com/videlec"
}
```

<a id='comment:35'></a>Pull request has been merged...



---

archive/issue_comments_347892.json:
```json
{
    "body": "<a id='comment:36'></a>close as obsolete ?",
    "created_at": "2021-10-10T08:34:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347892",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:36'></a>close as obsolete ?



---

archive/issue_events_060431.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2021-10-10T08:34:07Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23586#event-60431"
}
```



---

archive/issue_comments_347893.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-10-10T08:34:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347893",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_347894.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-10-10T08:40:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347894",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_347895.json:
```json
{
    "body": "<a id='comment:37'></a>Seems like the people involved lost interest 4 years ago so let's obsolete it.",
    "created_at": "2021-10-10T08:40:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347895",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:37'></a>Seems like the people involved lost interest 4 years ago so let's obsolete it.



---

archive/issue_comments_347896.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2021-10-11T08:43:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23586#issuecomment-347896",
    "user": "https://github.com/fchapoton"
}
```

Resolution: invalid



---

archive/issue_events_060432.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2021-10-11T08:43:22Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23586",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23586#event-60432"
}
```
