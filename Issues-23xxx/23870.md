# Issue 23870: speed_up_Permutation_to_matrix

archive/issues_023633.json:
```json
{
    "assignees": [],
    "body": "old:\n\n```\nsage: l = [pi for pi in Permutations(8)]\nsage: timeit(\"[elt.to_matrix() for elt in l]\")\n5 loops, best of 3: 11.2 s per loop\n```\nnew:\n\n```\nsage: timeit(\"[elt.to_matrix() for elt in l]\")\n5 loops, best of 3: 3.57 s per loop\n```\n\nBranch/Commit: **[32620a9](https://github.com/sagemath/sagetrac-mirror/commit/32620a936c3cb794a92b009ca59e292da0d4765b)**\n\nReviewer: **Travis Scrimshaw, Martin Rubey**\n\nAuthor: **Martin Rubey, Travis Scrimshaw**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/23870_\n\n",
    "closed_at": "2017-09-20T22:26:20Z",
    "created_at": "2017-09-15T17:53:51Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20combinatorics",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.1",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "speed_up_Permutation_to_matrix",
    "type": "issue",
    "updated_at": "2017-09-20T22:26:20Z",
    "url": "https://github.com/sagemath/sage/issues/23870",
    "user": "https://github.com/mantepse"
}
```
old:

```
sage: l = [pi for pi in Permutations(8)]
sage: timeit("[elt.to_matrix() for elt in l]")
5 loops, best of 3: 11.2 s per loop
```
new:

```
sage: timeit("[elt.to_matrix() for elt in l]")
5 loops, best of 3: 3.57 s per loop
```

Branch/Commit: **[32620a9](https://github.com/sagemath/sagetrac-mirror/commit/32620a936c3cb794a92b009ca59e292da0d4765b)**

Reviewer: **Travis Scrimshaw, Martin Rubey**

Author: **Martin Rubey, Travis Scrimshaw**

_Issue created by migration from https://trac.sagemath.org/ticket/23870_





---

archive/issue_events_313521.json:
```json
{
    "actor": "https://github.com/mantepse",
    "created_at": "2017-09-15T17:53:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "milestone_number": null,
    "milestone_title": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23870#event-313521"
}
```



---

archive/issue_events_313522.json:
```json
{
    "actor": "https://github.com/mantepse",
    "created_at": "2017-09-15T17:53:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23870#event-313522"
}
```



---

archive/issue_comments_362782.json:
```json
{
    "body": "Branch: **[u/mantepse/speed_up_permutation_to_matrix](https://github.com/sagemath/sagetrac-mirror/tree/u/mantepse/speed_up_permutation_to_matrix)**",
    "created_at": "2017-09-15T17:59:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-362782",
    "user": "https://github.com/mantepse"
}
```

Branch: **[u/mantepse/speed_up_permutation_to_matrix](https://github.com/sagemath/sagetrac-mirror/tree/u/mantepse/speed_up_permutation_to_matrix)**



---

archive/issue_comments_362783.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/319b9914fbb0a531b11363c8ab8d907191a56897\">319b991</a></td><td><code>clean Permutation.to_matrix, move out import in MatrixSpace.matrix</code></td></tr></table>\n",
    "created_at": "2017-09-15T18:07:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-362783",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:2'>Comment 2:</a>
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/319b9914fbb0a531b11363c8ab8d907191a56897">319b991</a></td><td><code>clean Permutation.to_matrix, move out import in MatrixSpace.matrix</code></td></tr></table>




---

archive/issue_comments_362784.json:
```json
{
    "body": "Author: **Martin Rubey**",
    "created_at": "2017-09-15T18:07:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-362784",
    "user": "https://github.com/mantepse"
}
```

Author: **Martin Rubey**



---

archive/issue_events_313523.json:
```json
{
    "actor": "https://github.com/mantepse",
    "created_at": "2017-09-15T18:07:47Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23870#event-313523"
}
```



---

archive/issue_events_313524.json:
```json
{
    "actor": "https://github.com/mantepse",
    "created_at": "2017-09-15T18:07:47Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23870#event-313524"
}
```



---

archive/issue_events_313525.json:
```json
{
    "actor": "https://github.com/mantepse",
    "created_at": "2017-09-15T18:07:47Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20combinatorics",
    "label_color": "0000ff",
    "label_name": "component: combinatorics",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23870#event-313525"
}
```



---

archive/issue_comments_362785.json:
```json
{
    "body": "Commit: **[319b991](https://github.com/sagemath/sagetrac-mirror/commit/319b9914fbb0a531b11363c8ab8d907191a56897)**",
    "created_at": "2017-09-15T18:07:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-362785",
    "user": "https://github.com/mantepse"
}
```

Commit: **[319b991](https://github.com/sagemath/sagetrac-mirror/commit/319b9914fbb0a531b11363c8ab8d907191a56897)**



---

archive/issue_comments_362786.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,13 @@\n+old:\n \n+```\n+sage: l = [pi for pi in Permutations(8)]\n+sage: timeit(\"[elt.to_matrix() for elt in l]\")\n+5 loops, best of 3: 11.2 s per loop\n+```\n+new:\n+\n+```\n+sage: timeit(\"[elt.to_matrix() for elt in l]\")\n+5 loops, best of 3: 3.57 s per loop\n+```\n``````\n",
    "created_at": "2017-09-15T18:28:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-362786",
    "user": "https://github.com/mantepse"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,13 @@
+old:
 
+```
+sage: l = [pi for pi in Permutations(8)]
+sage: timeit("[elt.to_matrix() for elt in l]")
+5 loops, best of 3: 11.2 s per loop
+```
+new:
+
+```
+sage: timeit("[elt.to_matrix() for elt in l]")
+5 loops, best of 3: 3.57 s per loop
+```
``````




---

archive/issue_comments_362787.json:
```json
{
    "body": "Changed commit from **[319b991](https://github.com/sagemath/sagetrac-mirror/commit/319b9914fbb0a531b11363c8ab8d907191a56897)** to **[5f9ec28](https://github.com/sagemath/sagetrac-mirror/commit/5f9ec285678e068ce50cace2b275af136b352bc7)**",
    "created_at": "2017-09-15T19:43:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-362787",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[319b991](https://github.com/sagemath/sagetrac-mirror/commit/319b9914fbb0a531b11363c8ab8d907191a56897)** to **[5f9ec28](https://github.com/sagemath/sagetrac-mirror/commit/5f9ec285678e068ce50cace2b275af136b352bc7)**



---

archive/issue_comments_362788.json:
```json
{
    "body": "<a id='comment:4'>Comment 4:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5f9ec285678e068ce50cace2b275af136b352bc7\">5f9ec28</a></td><td><code>use the sparse matrix class directly in Permutation.to_matrix</code></td></tr></table>\n",
    "created_at": "2017-09-15T19:43:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-362788",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:4'>Comment 4:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5f9ec285678e068ce50cace2b275af136b352bc7">5f9ec28</a></td><td><code>use the sparse matrix class directly in Permutation.to_matrix</code></td></tr></table>




---

archive/issue_comments_362789.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\nWhy is this needs_info? What information are you requesting? From the sage-devel thread?\n\nAlso, trivial PEP8 thing: `sparse = True` -> `sparse=True`.",
    "created_at": "2017-09-15T19:50:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-362789",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:5'>Comment 5:</a>
Why is this needs_info? What information are you requesting? From the sage-devel thread?

Also, trivial PEP8 thing: `sparse = True` -> `sparse=True`.



---

archive/issue_comments_362790.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nReplying to [@tscrim](#comment%3A5):\n> Why is this needs_info? What information are you requesting? From the sage-devel thread?\n\nI don't really like calling `Matrix_integer_sparse` directly.  I still have to check whether I can get comparable speed by removing the local imports in `MatrixSpace.matrix`.  If so, I would like to know why they are there in the first place.",
    "created_at": "2017-09-15T20:06:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-362790",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:6'>Comment 6:</a>
Replying to [@tscrim](#comment%3A5):
> Why is this needs_info? What information are you requesting? From the sage-devel thread?

I don't really like calling `Matrix_integer_sparse` directly.  I still have to check whether I can get comparable speed by removing the local imports in `MatrixSpace.matrix`.  If so, I would like to know why they are there in the first place.



---

archive/issue_comments_362791.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nWith the current version (calling the constructor directly), I'm down to\n\n```\nsage: timeit(\"[elt.to_matrix() for elt in l]\")\n5 loops, best of 3: 2.33 s per loop\n```",
    "created_at": "2017-09-15T20:27:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-362791",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:7'>Comment 7:</a>
With the current version (calling the constructor directly), I'm down to

```
sage: timeit("[elt.to_matrix() for elt in l]")
5 loops, best of 3: 2.33 s per loop
```



---

archive/issue_comments_362792.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\nUsing a `late_import` function, I get\n\n```\nsage: timeit(\"[elt.to_matrix() for elt in l]\", repeat=1, number=1)\n1 loops, best of 1: 3.01 s per loop\n```\n\nCould some design expert let me know what I should do now?\n\n1. `late_import`: speedup by a factor 3.7, but all calls to `MatrixSpace` benefit.\n2. `Matrix_integer_sparse`: speedup by a factor 4.8\n3. both\n\nI am for 1. or 3., but do not know which of the two is really better.\n\nOf course, I am willing to run more tests, but I wouldn't know which are expressive.",
    "created_at": "2017-09-15T20:53:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-362792",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:8'>Comment 8:</a>
Using a `late_import` function, I get

```
sage: timeit("[elt.to_matrix() for elt in l]", repeat=1, number=1)
1 loops, best of 1: 3.01 s per loop
```

Could some design expert let me know what I should do now?

1. `late_import`: speedup by a factor 3.7, but all calls to `MatrixSpace` benefit.
2. `Matrix_integer_sparse`: speedup by a factor 4.8
3. both

I am for 1. or 3., but do not know which of the two is really better.

Of course, I am willing to run more tests, but I wouldn't know which are expressive.



---

archive/issue_comments_362793.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nAs I mentioned on sage-devel, use `lazy_import`, which should be more efficient because you don't have to do a Python call every time (which I am slightly surprised that the late_import is faster too). However, I am thinking a better way out is to use the hook we already have for matrices by `_matrix_`, which will open it up to more things (things that, IMO, it should already work for).\n\nSide note - I feel permutations should have `_matrix_ = to_matrix` to use `matrix(P)`.",
    "created_at": "2017-09-15T21:20:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-362793",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:9'>Comment 9:</a>
As I mentioned on sage-devel, use `lazy_import`, which should be more efficient because you don't have to do a Python call every time (which I am slightly surprised that the late_import is faster too). However, I am thinking a better way out is to use the hook we already have for matrices by `_matrix_`, which will open it up to more things (things that, IMO, it should already work for).

Side note - I feel permutations should have `_matrix_ = to_matrix` to use `matrix(P)`.



---

archive/issue_comments_362794.json:
```json
{
    "body": "<a id='comment:10'>Comment 10:</a>\nActually, instead of directly calling the class, I would use\n\n```\nsage: MS = MatrixSpace(QQ, 3)\nsage: MS._get_matrix_class()\n<type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense'>\n```\nbut that would be acceptable for me because it is more robust against changes in the parent.",
    "created_at": "2017-09-15T21:24:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-362794",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:10'>Comment 10:</a>
Actually, instead of directly calling the class, I would use

```
sage: MS = MatrixSpace(QQ, 3)
sage: MS._get_matrix_class()
<type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense'>
```
but that would be acceptable for me because it is more robust against changes in the parent.



---

archive/issue_comments_362795.json:
```json
{
    "body": "<a id='comment:11'>Comment 11:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ccc44c87ede2a19b00889cdef79f978a647dd90a\">ccc44c8</a></td><td><code>move local imports into a late_import function</code></td></tr></table>\n",
    "created_at": "2017-09-15T21:25:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-362795",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:11'>Comment 11:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ccc44c87ede2a19b00889cdef79f978a647dd90a">ccc44c8</a></td><td><code>move local imports into a late_import function</code></td></tr></table>




---

archive/issue_comments_362796.json:
```json
{
    "body": "Changed commit from **[5f9ec28](https://github.com/sagemath/sagetrac-mirror/commit/5f9ec285678e068ce50cace2b275af136b352bc7)** to **[ccc44c8](https://github.com/sagemath/sagetrac-mirror/commit/ccc44c87ede2a19b00889cdef79f978a647dd90a)**",
    "created_at": "2017-09-15T21:25:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-362796",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[5f9ec28](https://github.com/sagemath/sagetrac-mirror/commit/5f9ec285678e068ce50cace2b275af136b352bc7)** to **[ccc44c8](https://github.com/sagemath/sagetrac-mirror/commit/ccc44c87ede2a19b00889cdef79f978a647dd90a)**



---

archive/issue_comments_362797.json:
```json
{
    "body": "<a id='comment:12'>Comment 12:</a>\nReplying to [@tscrim](#comment%3A9):\n> As I mentioned on sage-devel, use `lazy_import`, which should be more efficient because you don't have to do a Python call every time (which I am slightly surprised that the late_import is faster too).\n\nI have no idea how to use `lazy_import`.  I just pushed my `late_import` implementation, maybe you can guide me.\n\n> However, I am thinking a better way out is to use the hook we already have for matrices by `_matrix_`, which will open it up to more things (things that, IMO, it should already work for).\n\nI have no idea what you mean here.\n\n> Side note - I feel permutations should have `_matrix_ = to_matrix` to use `matrix(P)`.\n\nThis would allow to write `matrix(pi)` instead of `pi.to_matrix()`?",
    "created_at": "2017-09-15T21:30:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-362797",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:12'>Comment 12:</a>
Replying to [@tscrim](#comment%3A9):
> As I mentioned on sage-devel, use `lazy_import`, which should be more efficient because you don't have to do a Python call every time (which I am slightly surprised that the late_import is faster too).

I have no idea how to use `lazy_import`.  I just pushed my `late_import` implementation, maybe you can guide me.

> However, I am thinking a better way out is to use the hook we already have for matrices by `_matrix_`, which will open it up to more things (things that, IMO, it should already work for).

I have no idea what you mean here.

> Side note - I feel permutations should have `_matrix_ = to_matrix` to use `matrix(P)`.

This would allow to write `matrix(pi)` instead of `pi.to_matrix()`?



---

archive/issue_comments_362798.json:
```json
{
    "body": "<a id='comment:13'>Comment 13:</a>\nReplying to [@tscrim](#comment%3A10):\n> Actually, instead of directly calling the class, I would use\n> \n> ```\n> sage: MS = MatrixSpace(QQ, 3)\n> sage: MS._get_matrix_class()\n> <type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense'>\n> ```\n> but that would be acceptable for me because it is more robust against changes in the parent.\n\nI tried this, but it kills quite a bit of the performance gain.",
    "created_at": "2017-09-15T21:31:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-362798",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:13'>Comment 13:</a>
Replying to [@tscrim](#comment%3A10):
> Actually, instead of directly calling the class, I would use
> 
> ```
> sage: MS = MatrixSpace(QQ, 3)
> sage: MS._get_matrix_class()
> <type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense'>
> ```
> but that would be acceptable for me because it is more robust against changes in the parent.

I tried this, but it kills quite a bit of the performance gain.



---

archive/issue_comments_362799.json:
```json
{
    "body": "<a id='comment:14'>Comment 14:</a>\nReplying to [@mantepse](#comment%3A12):\n> Replying to [@tscrim](#comment%3A9):\n> > As I mentioned on sage-devel, use `lazy_import`, which should be more efficient because you don't have to do a Python call every time (which I am slightly surprised that the late_import is faster too).\n\n> \n> I have no idea how to use `lazy_import`.  I just pushed my `late_import` implementation, maybe you can guide me.\n\n`grep` for `lazy_import`. It's self-explanatory and all over Sage.\n\n> > However, I am thinking a better way out is to use the hook we already have for matrices by `_matrix_`, which will open it up to more things (things that, IMO, it should already work for).\n\n> \n> I have no idea what you mean here.\n\nThis is what is done in the `matrix()` construction function. You just check `hasattr(M, \"_matrix_\")`. So, for example, permutations would be accepted as input with the change proposed below (which, IMO, is very natural).\n\n> > Side note - I feel permutations should have `_matrix_ = to_matrix` to use `matrix(P)`.\n\n> \n> This would allow to write `matrix(pi)` instead of `pi.to_matrix()`?\n\nCorrect.",
    "created_at": "2017-09-15T21:50:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-362799",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:14'>Comment 14:</a>
Replying to [@mantepse](#comment%3A12):
> Replying to [@tscrim](#comment%3A9):
> > As I mentioned on sage-devel, use `lazy_import`, which should be more efficient because you don't have to do a Python call every time (which I am slightly surprised that the late_import is faster too).

> 
> I have no idea how to use `lazy_import`.  I just pushed my `late_import` implementation, maybe you can guide me.

`grep` for `lazy_import`. It's self-explanatory and all over Sage.

> > However, I am thinking a better way out is to use the hook we already have for matrices by `_matrix_`, which will open it up to more things (things that, IMO, it should already work for).

> 
> I have no idea what you mean here.

This is what is done in the `matrix()` construction function. You just check `hasattr(M, "_matrix_")`. So, for example, permutations would be accepted as input with the change proposed below (which, IMO, is very natural).

> > Side note - I feel permutations should have `_matrix_ = to_matrix` to use `matrix(P)`.

> 
> This would allow to write `matrix(pi)` instead of `pi.to_matrix()`?

Correct.



---

archive/issue_comments_362800.json:
```json
{
    "body": "<a id='comment:15'>Comment 15:</a>\nReplying to [@mantepse](#comment%3A13):\n> Replying to [@tscrim](#comment%3A10):\n> > Actually, instead of directly calling the class, I would use\n> > \n> > ```\n> > sage: MS = MatrixSpace(QQ, 3)\n> > sage: MS._get_matrix_class()\n> > <type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense'>\n> > ```\n> > but that would be acceptable for me because it is more robust against changes in the parent.\n\n> \n> I tried this, but it kills quite a bit of the performance gain.\n\nThe problem is caching. It is, in effect, cached, by being called in the `__init__` and setting the attribute `__matrix_class`. I am sure this was written a long time ago. So I would probably make `_matrix_class` a `@lazy_attribute`, replace the `__matrix_class` with `_matrix_class`, and get rid of `_get_matrix_class` (it needs no deprecation because it is not public).",
    "created_at": "2017-09-15T21:55:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-362800",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:15'>Comment 15:</a>
Replying to [@mantepse](#comment%3A13):
> Replying to [@tscrim](#comment%3A10):
> > Actually, instead of directly calling the class, I would use
> > 
> > ```
> > sage: MS = MatrixSpace(QQ, 3)
> > sage: MS._get_matrix_class()
> > <type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense'>
> > ```
> > but that would be acceptable for me because it is more robust against changes in the parent.

> 
> I tried this, but it kills quite a bit of the performance gain.

The problem is caching. It is, in effect, cached, by being called in the `__init__` and setting the attribute `__matrix_class`. I am sure this was written a long time ago. So I would probably make `_matrix_class` a `@lazy_attribute`, replace the `__matrix_class` with `_matrix_class`, and get rid of `_get_matrix_class` (it needs no deprecation because it is not public).



---

archive/issue_comments_362801.json:
```json
{
    "body": "<a id='comment:16'>Comment 16:</a>\n> > I have no idea how to use `lazy_import`.  I just pushed my `late_import` implementation, maybe you can guide me.\n\n> \n> `grep` for `lazy_import`. It's self-explanatory and all over Sage.\n\nI did this before I wrote the `late_import` thing:\n\n```\nfrom sage.misc.lazy_import import lazy_import\nlazy_import('sage.groups.matrix_gps.group_element', 'is_MatrixGroupElement')\nlazy_import('sage.modular.arithgroup.arithgroup_element', 'ArithmeticSubgroupElement')\n```\n\nbut sage crashed on startup.  But I didn't try long - maybe I made a mistake when compiling or so.",
    "created_at": "2017-09-15T22:08:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-362801",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:16'>Comment 16:</a>
> > I have no idea how to use `lazy_import`.  I just pushed my `late_import` implementation, maybe you can guide me.

> 
> `grep` for `lazy_import`. It's self-explanatory and all over Sage.

I did this before I wrote the `late_import` thing:

```
from sage.misc.lazy_import import lazy_import
lazy_import('sage.groups.matrix_gps.group_element', 'is_MatrixGroupElement')
lazy_import('sage.modular.arithgroup.arithgroup_element', 'ArithmeticSubgroupElement')
```

but sage crashed on startup.  But I didn't try long - maybe I made a mistake when compiling or so.



---

archive/issue_comments_362802.json:
```json
{
    "body": "Changed commit from **[ccc44c8](https://github.com/sagemath/sagetrac-mirror/commit/ccc44c87ede2a19b00889cdef79f978a647dd90a)** to **[9fe10b6](https://github.com/sagemath/sagetrac-mirror/commit/9fe10b6e1a2cbc2bd275ff2321ff20b2245d5c14)**",
    "created_at": "2017-09-15T22:25:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-362802",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[ccc44c8](https://github.com/sagemath/sagetrac-mirror/commit/ccc44c87ede2a19b00889cdef79f978a647dd90a)** to **[9fe10b6](https://github.com/sagemath/sagetrac-mirror/commit/9fe10b6e1a2cbc2bd275ff2321ff20b2245d5c14)**



---

archive/issue_comments_362803.json:
```json
{
    "body": "<a id='comment:17'>Comment 17:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9fe10b6e1a2cbc2bd275ff2321ff20b2245d5c14\">9fe10b6</a></td><td><code>provide _matrix_</code></td></tr></table>\n",
    "created_at": "2017-09-15T22:25:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-362803",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:17'>Comment 17:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9fe10b6e1a2cbc2bd275ff2321ff20b2245d5c14">9fe10b6</a></td><td><code>provide _matrix_</code></td></tr></table>




---

archive/issue_comments_362804.json:
```json
{
    "body": "Changed branch from **[u/mantepse/speed_up_permutation_to_matrix](https://github.com/sagemath/sagetrac-mirror/tree/u/mantepse/speed_up_permutation_to_matrix)** to **[public/combinat/speed_up_permutation_to_matrix-23870](https://github.com/sagemath/sagetrac-mirror/tree/public/combinat/speed_up_permutation_to_matrix-23870)**",
    "created_at": "2017-09-16T21:11:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-362804",
    "user": "https://github.com/tscrim"
}
```

Changed branch from **[u/mantepse/speed_up_permutation_to_matrix](https://github.com/sagemath/sagetrac-mirror/tree/u/mantepse/speed_up_permutation_to_matrix)** to **[public/combinat/speed_up_permutation_to_matrix-23870](https://github.com/sagemath/sagetrac-mirror/tree/public/combinat/speed_up_permutation_to_matrix-23870)**



---

archive/issue_comments_362805.json:
```json
{
    "body": "Reviewer: **Travis Scrimshaw**",
    "created_at": "2017-09-16T21:11:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-362805",
    "user": "https://github.com/tscrim"
}
```

Reviewer: **Travis Scrimshaw**



---

archive/issue_comments_362806.json:
```json
{
    "body": "<a id='comment:18'>Comment 18:</a>\nYou needed to tell Sage that this needs to be resolved at startup (as the error message indicates). This is primarily a temporary solution until more involved changes with the matrix spaces are done (make `_get_matrix_class` into a `@lazy_attribute` `Element` so it behaves more like a proper parent and we can then use `MS.element_class` and use the methods `_matrix_`/`matrix` for constructing `matrix` and possibly coercion), which might need some further discussions.\n\nIf my changes are good, then I think we can set a positive review.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e0a64cc5b0fa12683440fe9fed587221a39b931f\">e0a64cc</a></td><td><code>Use the much better lazy_import.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/32620a936c3cb794a92b009ca59e292da0d4765b\">32620a9</a></td><td><code>A little bit of cleanup.</code></td></tr></table>\n",
    "created_at": "2017-09-16T21:11:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-362806",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:18'>Comment 18:</a>
You needed to tell Sage that this needs to be resolved at startup (as the error message indicates). This is primarily a temporary solution until more involved changes with the matrix spaces are done (make `_get_matrix_class` into a `@lazy_attribute` `Element` so it behaves more like a proper parent and we can then use `MS.element_class` and use the methods `_matrix_`/`matrix` for constructing `matrix` and possibly coercion), which might need some further discussions.

If my changes are good, then I think we can set a positive review.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e0a64cc5b0fa12683440fe9fed587221a39b931f">e0a64cc</a></td><td><code>Use the much better lazy_import.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/32620a936c3cb794a92b009ca59e292da0d4765b">32620a9</a></td><td><code>A little bit of cleanup.</code></td></tr></table>




---

archive/issue_comments_362807.json:
```json
{
    "body": "Changed commit from **[9fe10b6](https://github.com/sagemath/sagetrac-mirror/commit/9fe10b6e1a2cbc2bd275ff2321ff20b2245d5c14)** to **[32620a9](https://github.com/sagemath/sagetrac-mirror/commit/32620a936c3cb794a92b009ca59e292da0d4765b)**",
    "created_at": "2017-09-16T21:11:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-362807",
    "user": "https://github.com/tscrim"
}
```

Changed commit from **[9fe10b6](https://github.com/sagemath/sagetrac-mirror/commit/9fe10b6e1a2cbc2bd275ff2321ff20b2245d5c14)** to **[32620a9](https://github.com/sagemath/sagetrac-mirror/commit/32620a936c3cb794a92b009ca59e292da0d4765b)**



---

archive/issue_events_313526.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2017-09-16T21:11:32Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23870#event-313526"
}
```



---

archive/issue_events_313527.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2017-09-16T21:11:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23870#event-313527"
}
```



---

archive/issue_comments_362808.json:
```json
{
    "body": "<a id='comment:19'>Comment 19:</a>\nGreat and thank you for explaining `startup`!  One question: is this going to affect startup time?",
    "created_at": "2017-09-17T06:36:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-362808",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:19'>Comment 19:</a>
Great and thank you for explaining `startup`!  One question: is this going to affect startup time?



---

archive/issue_comments_362809.json:
```json
{
    "body": "<a id='comment:20'>Comment 20:</a>\nNot really, or at least I would be surprised if it did have an impact.",
    "created_at": "2017-09-17T07:19:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-362809",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:20'>Comment 20:</a>
Not really, or at least I would be surprised if it did have an impact.



---

archive/issue_comments_362810.json:
```json
{
    "body": "Changed reviewer from **Travis Scrimshaw** to **Travis Scrimshaw, Martin Rubey**",
    "created_at": "2017-09-17T07:25:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-362810",
    "user": "https://github.com/mantepse"
}
```

Changed reviewer from **Travis Scrimshaw** to **Travis Scrimshaw, Martin Rubey**



---

archive/issue_comments_362811.json:
```json
{
    "body": "Changed author from **Martin Rubey** to **Martin Rubey, Travis Scrimshaw**",
    "created_at": "2017-09-17T07:25:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-362811",
    "user": "https://github.com/mantepse"
}
```

Changed author from **Martin Rubey** to **Martin Rubey, Travis Scrimshaw**



---

archive/issue_events_313528.json:
```json
{
    "actor": "https://github.com/mantepse",
    "created_at": "2017-09-17T07:25:05Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23870#event-313528"
}
```



---

archive/issue_events_313529.json:
```json
{
    "actor": "https://github.com/mantepse",
    "created_at": "2017-09-17T07:25:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23870#event-313529"
}
```



---

archive/issue_events_313530.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-09-20T22:26:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23870#event-313530"
}
```



---

archive/issue_events_313531.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "43505eec3b24f03c1ea3b4a247bb3ed502f8b9bd",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2017-09-20T22:26:20Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23870#event-313531"
}
```



---

archive/issue_comments_362812.json:
```json
{
    "body": "Changed branch from **[public/combinat/speed_up_permutation_to_matrix-23870](https://github.com/sagemath/sagetrac-mirror/tree/public/combinat/speed_up_permutation_to_matrix-23870)** to **[32620a9](https://github.com/sagemath/sagetrac-mirror/commit/32620a936c3cb794a92b009ca59e292da0d4765b)**",
    "created_at": "2017-09-20T22:26:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-362812",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[public/combinat/speed_up_permutation_to_matrix-23870](https://github.com/sagemath/sagetrac-mirror/tree/public/combinat/speed_up_permutation_to_matrix-23870)** to **[32620a9](https://github.com/sagemath/sagetrac-mirror/commit/32620a936c3cb794a92b009ca59e292da0d4765b)**
