# Issue 23870: speed_up_Permutation_to_matrix

archive/issues_023633.json:
```json
{
    "assignees": [],
    "body": "old:\n\n```\nsage: l = [pi for pi in Permutations(8)]\nsage: timeit(\"[elt.to_matrix() for elt in l]\")\n5 loops, best of 3: 11.2 s per loop\n```\nnew:\n\n```\nsage: timeit(\"[elt.to_matrix() for elt in l]\")\n5 loops, best of 3: 3.57 s per loop\n```\n\nComponent: **combinatorics**\n\nAuthor: **Martin Rubey, Travis Scrimshaw**\n\nBranch/Commit: **[`32620a9`](https://github.com/sagemath/sagetrac-mirror/commit/32620a936c3cb794a92b009ca59e292da0d4765b)**\n\nReviewer: **Travis Scrimshaw, Martin Rubey**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/23870_\n\n",
    "closed_at": "2017-09-20T22:26:20Z",
    "created_at": "2017-09-15T17:53:51Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20combinatorics",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.1",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "speed_up_Permutation_to_matrix",
    "type": "issue",
    "updated_at": "2017-09-20T22:26:20Z",
    "url": "https://github.com/sagemath/sage/issues/23870",
    "user": "https://github.com/mantepse"
}
```
old:

```
sage: l = [pi for pi in Permutations(8)]
sage: timeit("[elt.to_matrix() for elt in l]")
5 loops, best of 3: 11.2 s per loop
```
new:

```
sage: timeit("[elt.to_matrix() for elt in l]")
5 loops, best of 3: 3.57 s per loop
```

Component: **combinatorics**

Author: **Martin Rubey, Travis Scrimshaw**

Branch/Commit: **[`32620a9`](https://github.com/sagemath/sagetrac-mirror/commit/32620a936c3cb794a92b009ca59e292da0d4765b)**

Reviewer: **Travis Scrimshaw, Martin Rubey**

_Issue created by migration from https://trac.sagemath.org/ticket/23870_





---

archive/issue_events_328666.json:
```json
{
    "actor": "https://github.com/mantepse",
    "created_at": "2017-09-15T17:53:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "milestone_number": null,
    "milestone_title": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23870#event-328666"
}
```



---

archive/issue_events_328667.json:
```json
{
    "actor": "https://github.com/mantepse",
    "created_at": "2017-09-15T17:53:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23870#event-328667"
}
```



---

archive/issue_comments_360028.json:
```json
{
    "body": "Branch: **[u/mantepse/speed_up_permutation_to_matrix](https://github.com/sagemath/sagetrac-mirror/tree/u/mantepse/speed_up_permutation_to_matrix)**",
    "created_at": "2017-09-15T17:59:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-360028",
    "user": "https://github.com/mantepse"
}
```

Branch: **[u/mantepse/speed_up_permutation_to_matrix](https://github.com/sagemath/sagetrac-mirror/tree/u/mantepse/speed_up_permutation_to_matrix)**



---

archive/issue_comments_360029.json:
```json
{
    "body": "<div id=\"comment:2\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/319b9914fbb0a531b11363c8ab8d907191a56897\"><code>319b991</code></a></td><td><code>clean Permutation.to_matrix, move out import in MatrixSpace.matrix</code></td></tr></table>\n",
    "created_at": "2017-09-15T18:07:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-360029",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:2"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/319b9914fbb0a531b11363c8ab8d907191a56897"><code>319b991</code></a></td><td><code>clean Permutation.to_matrix, move out import in MatrixSpace.matrix</code></td></tr></table>




---

archive/issue_comments_360030.json:
```json
{
    "body": "Author: **Martin Rubey**",
    "created_at": "2017-09-15T18:07:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-360030",
    "user": "https://github.com/mantepse"
}
```

Author: **Martin Rubey**



---

archive/issue_events_328668.json:
```json
{
    "actor": "https://github.com/mantepse",
    "created_at": "2017-09-15T18:07:47Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23870#event-328668"
}
```



---

archive/issue_events_328669.json:
```json
{
    "actor": "https://github.com/mantepse",
    "created_at": "2017-09-15T18:07:47Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23870#event-328669"
}
```



---

archive/issue_events_328670.json:
```json
{
    "actor": "https://github.com/mantepse",
    "created_at": "2017-09-15T18:07:47Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20combinatorics",
    "label_color": "0000ff",
    "label_name": "c: combinatorics",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23870#event-328670"
}
```



---

archive/issue_comments_360031.json:
```json
{
    "body": "Commit: **[`319b991`](https://github.com/sagemath/sagetrac-mirror/commit/319b9914fbb0a531b11363c8ab8d907191a56897)**",
    "created_at": "2017-09-15T18:07:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-360031",
    "user": "https://github.com/mantepse"
}
```

Commit: **[`319b991`](https://github.com/sagemath/sagetrac-mirror/commit/319b9914fbb0a531b11363c8ab8d907191a56897)**



---

archive/issue_comments_360032.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,13 @@\n+old:\n \n+```\n+sage: l = [pi for pi in Permutations(8)]\n+sage: timeit(\"[elt.to_matrix() for elt in l]\")\n+5 loops, best of 3: 11.2 s per loop\n+```\n+new:\n+\n+```\n+sage: timeit(\"[elt.to_matrix() for elt in l]\")\n+5 loops, best of 3: 3.57 s per loop\n+```\n``````\n",
    "created_at": "2017-09-15T18:28:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-360032",
    "user": "https://github.com/mantepse"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,13 @@
+old:
 
+```
+sage: l = [pi for pi in Permutations(8)]
+sage: timeit("[elt.to_matrix() for elt in l]")
+5 loops, best of 3: 11.2 s per loop
+```
+new:
+
+```
+sage: timeit("[elt.to_matrix() for elt in l]")
+5 loops, best of 3: 3.57 s per loop
+```
``````




---

archive/issue_comments_360033.json:
```json
{
    "body": "Changed commit from **[`319b991`](https://github.com/sagemath/sagetrac-mirror/commit/319b9914fbb0a531b11363c8ab8d907191a56897)** to **[`5f9ec28`](https://github.com/sagemath/sagetrac-mirror/commit/5f9ec285678e068ce50cace2b275af136b352bc7)**",
    "created_at": "2017-09-15T19:43:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-360033",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`319b991`](https://github.com/sagemath/sagetrac-mirror/commit/319b9914fbb0a531b11363c8ab8d907191a56897)** to **[`5f9ec28`](https://github.com/sagemath/sagetrac-mirror/commit/5f9ec285678e068ce50cace2b275af136b352bc7)**



---

archive/issue_comments_360034.json:
```json
{
    "body": "<div id=\"comment:4\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5f9ec285678e068ce50cace2b275af136b352bc7\"><code>5f9ec28</code></a></td><td><code>use the sparse matrix class directly in Permutation.to_matrix</code></td></tr></table>\n",
    "created_at": "2017-09-15T19:43:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-360034",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:4"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5f9ec285678e068ce50cace2b275af136b352bc7"><code>5f9ec28</code></a></td><td><code>use the sparse matrix class directly in Permutation.to_matrix</code></td></tr></table>




---

archive/issue_comments_360035.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nWhy is this needs_info? What information are you requesting? From the sage-devel thread?\n\nAlso, trivial PEP8 thing: `sparse = True` -> `sparse=True`.",
    "created_at": "2017-09-15T19:50:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-360035",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:5" align="right">comment:5</div>

Why is this needs_info? What information are you requesting? From the sage-devel thread?

Also, trivial PEP8 thing: `sparse = True` -> `sparse=True`.



---

archive/issue_comments_360036.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nReplying to [@tscrim](#comment%3A5):\n> Why is this needs_info? What information are you requesting? From the sage-devel thread?\n\nI don't really like calling `Matrix_integer_sparse` directly.  I still have to check whether I can get comparable speed by removing the local imports in `MatrixSpace.matrix`.  If so, I would like to know why they are there in the first place.",
    "created_at": "2017-09-15T20:06:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-360036",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:6" align="right">comment:6</div>

Replying to [@tscrim](#comment%3A5):
> Why is this needs_info? What information are you requesting? From the sage-devel thread?

I don't really like calling `Matrix_integer_sparse` directly.  I still have to check whether I can get comparable speed by removing the local imports in `MatrixSpace.matrix`.  If so, I would like to know why they are there in the first place.



---

archive/issue_comments_360037.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nWith the current version (calling the constructor directly), I'm down to\n\n```\nsage: timeit(\"[elt.to_matrix() for elt in l]\")\n5 loops, best of 3: 2.33 s per loop\n```",
    "created_at": "2017-09-15T20:27:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-360037",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:7" align="right">comment:7</div>

With the current version (calling the constructor directly), I'm down to

```
sage: timeit("[elt.to_matrix() for elt in l]")
5 loops, best of 3: 2.33 s per loop
```



---

archive/issue_comments_360038.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nUsing a `late_import` function, I get\n\n```\nsage: timeit(\"[elt.to_matrix() for elt in l]\", repeat=1, number=1)\n1 loops, best of 1: 3.01 s per loop\n```\n\nCould some design expert let me know what I should do now?\n\n1. `late_import`: speedup by a factor 3.7, but all calls to `MatrixSpace` benefit.\n2. `Matrix_integer_sparse`: speedup by a factor 4.8\n3. both\n\nI am for 1. or 3., but do not know which of the two is really better.\n\nOf course, I am willing to run more tests, but I wouldn't know which are expressive.",
    "created_at": "2017-09-15T20:53:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-360038",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:8" align="right">comment:8</div>

Using a `late_import` function, I get

```
sage: timeit("[elt.to_matrix() for elt in l]", repeat=1, number=1)
1 loops, best of 1: 3.01 s per loop
```

Could some design expert let me know what I should do now?

1. `late_import`: speedup by a factor 3.7, but all calls to `MatrixSpace` benefit.
2. `Matrix_integer_sparse`: speedup by a factor 4.8
3. both

I am for 1. or 3., but do not know which of the two is really better.

Of course, I am willing to run more tests, but I wouldn't know which are expressive.



---

archive/issue_comments_360039.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nAs I mentioned on sage-devel, use `lazy_import`, which should be more efficient because you don't have to do a Python call every time (which I am slightly surprised that the late_import is faster too). However, I am thinking a better way out is to use the hook we already have for matrices by `_matrix_`, which will open it up to more things (things that, IMO, it should already work for).\n\nSide note - I feel permutations should have `_matrix_ = to_matrix` to use `matrix(P)`.",
    "created_at": "2017-09-15T21:20:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-360039",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:9" align="right">comment:9</div>

As I mentioned on sage-devel, use `lazy_import`, which should be more efficient because you don't have to do a Python call every time (which I am slightly surprised that the late_import is faster too). However, I am thinking a better way out is to use the hook we already have for matrices by `_matrix_`, which will open it up to more things (things that, IMO, it should already work for).

Side note - I feel permutations should have `_matrix_ = to_matrix` to use `matrix(P)`.



---

archive/issue_comments_360040.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nActually, instead of directly calling the class, I would use\n\n```\nsage: MS = MatrixSpace(QQ, 3)\nsage: MS._get_matrix_class()\n<type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense'>\n```\nbut that would be acceptable for me because it is more robust against changes in the parent.",
    "created_at": "2017-09-15T21:24:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-360040",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:10" align="right">comment:10</div>

Actually, instead of directly calling the class, I would use

```
sage: MS = MatrixSpace(QQ, 3)
sage: MS._get_matrix_class()
<type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense'>
```
but that would be acceptable for me because it is more robust against changes in the parent.



---

archive/issue_comments_360041.json:
```json
{
    "body": "<div id=\"comment:11\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ccc44c87ede2a19b00889cdef79f978a647dd90a\"><code>ccc44c8</code></a></td><td><code>move local imports into a late_import function</code></td></tr></table>\n",
    "created_at": "2017-09-15T21:25:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-360041",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:11"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ccc44c87ede2a19b00889cdef79f978a647dd90a"><code>ccc44c8</code></a></td><td><code>move local imports into a late_import function</code></td></tr></table>




---

archive/issue_comments_360042.json:
```json
{
    "body": "Changed commit from **[`5f9ec28`](https://github.com/sagemath/sagetrac-mirror/commit/5f9ec285678e068ce50cace2b275af136b352bc7)** to **[`ccc44c8`](https://github.com/sagemath/sagetrac-mirror/commit/ccc44c87ede2a19b00889cdef79f978a647dd90a)**",
    "created_at": "2017-09-15T21:25:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-360042",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`5f9ec28`](https://github.com/sagemath/sagetrac-mirror/commit/5f9ec285678e068ce50cace2b275af136b352bc7)** to **[`ccc44c8`](https://github.com/sagemath/sagetrac-mirror/commit/ccc44c87ede2a19b00889cdef79f978a647dd90a)**



---

archive/issue_comments_360043.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@tscrim](#comment%3A9):\n> As I mentioned on sage-devel, use `lazy_import`, which should be more efficient because you don't have to do a Python call every time (which I am slightly surprised that the late_import is faster too).\n\nI have no idea how to use `lazy_import`.  I just pushed my `late_import` implementation, maybe you can guide me.\n\n> However, I am thinking a better way out is to use the hook we already have for matrices by `_matrix_`, which will open it up to more things (things that, IMO, it should already work for).\n\nI have no idea what you mean here.\n\n> Side note - I feel permutations should have `_matrix_ = to_matrix` to use `matrix(P)`.\n\nThis would allow to write `matrix(pi)` instead of `pi.to_matrix()`?",
    "created_at": "2017-09-15T21:30:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-360043",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@tscrim](#comment%3A9):
> As I mentioned on sage-devel, use `lazy_import`, which should be more efficient because you don't have to do a Python call every time (which I am slightly surprised that the late_import is faster too).

I have no idea how to use `lazy_import`.  I just pushed my `late_import` implementation, maybe you can guide me.

> However, I am thinking a better way out is to use the hook we already have for matrices by `_matrix_`, which will open it up to more things (things that, IMO, it should already work for).

I have no idea what you mean here.

> Side note - I feel permutations should have `_matrix_ = to_matrix` to use `matrix(P)`.

This would allow to write `matrix(pi)` instead of `pi.to_matrix()`?



---

archive/issue_comments_360044.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReplying to [@tscrim](#comment%3A10):\n> Actually, instead of directly calling the class, I would use\n> \n> ```\n> sage: MS = MatrixSpace(QQ, 3)\n> sage: MS._get_matrix_class()\n> <type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense'>\n> ```\n> but that would be acceptable for me because it is more robust against changes in the parent.\n\nI tried this, but it kills quite a bit of the performance gain.",
    "created_at": "2017-09-15T21:31:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-360044",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:13" align="right">comment:13</div>

Replying to [@tscrim](#comment%3A10):
> Actually, instead of directly calling the class, I would use
> 
> ```
> sage: MS = MatrixSpace(QQ, 3)
> sage: MS._get_matrix_class()
> <type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense'>
> ```
> but that would be acceptable for me because it is more robust against changes in the parent.

I tried this, but it kills quite a bit of the performance gain.



---

archive/issue_comments_360045.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@mantepse](#comment%3A12):\n> Replying to [@tscrim](#comment%3A9):\n> > As I mentioned on sage-devel, use `lazy_import`, which should be more efficient because you don't have to do a Python call every time (which I am slightly surprised that the late_import is faster too).\n\n> \n> I have no idea how to use `lazy_import`.  I just pushed my `late_import` implementation, maybe you can guide me.\n\n`grep` for `lazy_import`. It's self-explanatory and all over Sage.\n\n> > However, I am thinking a better way out is to use the hook we already have for matrices by `_matrix_`, which will open it up to more things (things that, IMO, it should already work for).\n\n> \n> I have no idea what you mean here.\n\nThis is what is done in the `matrix()` construction function. You just check `hasattr(M, \"_matrix_\")`. So, for example, permutations would be accepted as input with the change proposed below (which, IMO, is very natural).\n\n> > Side note - I feel permutations should have `_matrix_ = to_matrix` to use `matrix(P)`.\n\n> \n> This would allow to write `matrix(pi)` instead of `pi.to_matrix()`?\n\nCorrect.",
    "created_at": "2017-09-15T21:50:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-360045",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@mantepse](#comment%3A12):
> Replying to [@tscrim](#comment%3A9):
> > As I mentioned on sage-devel, use `lazy_import`, which should be more efficient because you don't have to do a Python call every time (which I am slightly surprised that the late_import is faster too).

> 
> I have no idea how to use `lazy_import`.  I just pushed my `late_import` implementation, maybe you can guide me.

`grep` for `lazy_import`. It's self-explanatory and all over Sage.

> > However, I am thinking a better way out is to use the hook we already have for matrices by `_matrix_`, which will open it up to more things (things that, IMO, it should already work for).

> 
> I have no idea what you mean here.

This is what is done in the `matrix()` construction function. You just check `hasattr(M, "_matrix_")`. So, for example, permutations would be accepted as input with the change proposed below (which, IMO, is very natural).

> > Side note - I feel permutations should have `_matrix_ = to_matrix` to use `matrix(P)`.

> 
> This would allow to write `matrix(pi)` instead of `pi.to_matrix()`?

Correct.



---

archive/issue_comments_360046.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nReplying to [@mantepse](#comment%3A13):\n> Replying to [@tscrim](#comment%3A10):\n> > Actually, instead of directly calling the class, I would use\n> > \n> > ```\n> > sage: MS = MatrixSpace(QQ, 3)\n> > sage: MS._get_matrix_class()\n> > <type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense'>\n> > ```\n> > but that would be acceptable for me because it is more robust against changes in the parent.\n\n> \n> I tried this, but it kills quite a bit of the performance gain.\n\nThe problem is caching. It is, in effect, cached, by being called in the `__init__` and setting the attribute `__matrix_class`. I am sure this was written a long time ago. So I would probably make `_matrix_class` a `@lazy_attribute`, replace the `__matrix_class` with `_matrix_class`, and get rid of `_get_matrix_class` (it needs no deprecation because it is not public).",
    "created_at": "2017-09-15T21:55:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-360046",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:15" align="right">comment:15</div>

Replying to [@mantepse](#comment%3A13):
> Replying to [@tscrim](#comment%3A10):
> > Actually, instead of directly calling the class, I would use
> > 
> > ```
> > sage: MS = MatrixSpace(QQ, 3)
> > sage: MS._get_matrix_class()
> > <type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense'>
> > ```
> > but that would be acceptable for me because it is more robust against changes in the parent.

> 
> I tried this, but it kills quite a bit of the performance gain.

The problem is caching. It is, in effect, cached, by being called in the `__init__` and setting the attribute `__matrix_class`. I am sure this was written a long time ago. So I would probably make `_matrix_class` a `@lazy_attribute`, replace the `__matrix_class` with `_matrix_class`, and get rid of `_get_matrix_class` (it needs no deprecation because it is not public).



---

archive/issue_comments_360047.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\n> > I have no idea how to use `lazy_import`.  I just pushed my `late_import` implementation, maybe you can guide me.\n\n> \n> `grep` for `lazy_import`. It's self-explanatory and all over Sage.\n\nI did this before I wrote the `late_import` thing:\n\n```\nfrom sage.misc.lazy_import import lazy_import\nlazy_import('sage.groups.matrix_gps.group_element', 'is_MatrixGroupElement')\nlazy_import('sage.modular.arithgroup.arithgroup_element', 'ArithmeticSubgroupElement')\n```\n\nbut sage crashed on startup.  But I didn't try long - maybe I made a mistake when compiling or so.",
    "created_at": "2017-09-15T22:08:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-360047",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:16" align="right">comment:16</div>

> > I have no idea how to use `lazy_import`.  I just pushed my `late_import` implementation, maybe you can guide me.

> 
> `grep` for `lazy_import`. It's self-explanatory and all over Sage.

I did this before I wrote the `late_import` thing:

```
from sage.misc.lazy_import import lazy_import
lazy_import('sage.groups.matrix_gps.group_element', 'is_MatrixGroupElement')
lazy_import('sage.modular.arithgroup.arithgroup_element', 'ArithmeticSubgroupElement')
```

but sage crashed on startup.  But I didn't try long - maybe I made a mistake when compiling or so.



---

archive/issue_comments_360048.json:
```json
{
    "body": "Changed commit from **[`ccc44c8`](https://github.com/sagemath/sagetrac-mirror/commit/ccc44c87ede2a19b00889cdef79f978a647dd90a)** to **[`9fe10b6`](https://github.com/sagemath/sagetrac-mirror/commit/9fe10b6e1a2cbc2bd275ff2321ff20b2245d5c14)**",
    "created_at": "2017-09-15T22:25:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-360048",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`ccc44c8`](https://github.com/sagemath/sagetrac-mirror/commit/ccc44c87ede2a19b00889cdef79f978a647dd90a)** to **[`9fe10b6`](https://github.com/sagemath/sagetrac-mirror/commit/9fe10b6e1a2cbc2bd275ff2321ff20b2245d5c14)**



---

archive/issue_comments_360049.json:
```json
{
    "body": "<div id=\"comment:17\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9fe10b6e1a2cbc2bd275ff2321ff20b2245d5c14\"><code>9fe10b6</code></a></td><td><code>provide _matrix_</code></td></tr></table>\n",
    "created_at": "2017-09-15T22:25:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-360049",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:17"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9fe10b6e1a2cbc2bd275ff2321ff20b2245d5c14"><code>9fe10b6</code></a></td><td><code>provide _matrix_</code></td></tr></table>




---

archive/issue_comments_360050.json:
```json
{
    "body": "Changed branch from **[u/mantepse/speed_up_permutation_to_matrix](https://github.com/sagemath/sagetrac-mirror/tree/u/mantepse/speed_up_permutation_to_matrix)** to **[public/combinat/speed_up_permutation_to_matrix-23870](https://github.com/sagemath/sagetrac-mirror/tree/public/combinat/speed_up_permutation_to_matrix-23870)**",
    "created_at": "2017-09-16T21:11:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-360050",
    "user": "https://github.com/tscrim"
}
```

Changed branch from **[u/mantepse/speed_up_permutation_to_matrix](https://github.com/sagemath/sagetrac-mirror/tree/u/mantepse/speed_up_permutation_to_matrix)** to **[public/combinat/speed_up_permutation_to_matrix-23870](https://github.com/sagemath/sagetrac-mirror/tree/public/combinat/speed_up_permutation_to_matrix-23870)**



---

archive/issue_comments_360051.json:
```json
{
    "body": "Reviewer: **Travis Scrimshaw**",
    "created_at": "2017-09-16T21:11:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-360051",
    "user": "https://github.com/tscrim"
}
```

Reviewer: **Travis Scrimshaw**



---

archive/issue_comments_360052.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nYou needed to tell Sage that this needs to be resolved at startup (as the error message indicates). This is primarily a temporary solution until more involved changes with the matrix spaces are done (make `_get_matrix_class` into a `@lazy_attribute` `Element` so it behaves more like a proper parent and we can then use `MS.element_class` and use the methods `_matrix_`/`matrix` for constructing `matrix` and possibly coercion), which might need some further discussions.\n\nIf my changes are good, then I think we can set a positive review.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e0a64cc5b0fa12683440fe9fed587221a39b931f\"><code>e0a64cc</code></a></td><td><code>Use the much better lazy_import.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/32620a936c3cb794a92b009ca59e292da0d4765b\"><code>32620a9</code></a></td><td><code>A little bit of cleanup.</code></td></tr></table>\n",
    "created_at": "2017-09-16T21:11:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-360052",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:18" align="right">comment:18</div>

You needed to tell Sage that this needs to be resolved at startup (as the error message indicates). This is primarily a temporary solution until more involved changes with the matrix spaces are done (make `_get_matrix_class` into a `@lazy_attribute` `Element` so it behaves more like a proper parent and we can then use `MS.element_class` and use the methods `_matrix_`/`matrix` for constructing `matrix` and possibly coercion), which might need some further discussions.

If my changes are good, then I think we can set a positive review.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e0a64cc5b0fa12683440fe9fed587221a39b931f"><code>e0a64cc</code></a></td><td><code>Use the much better lazy_import.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/32620a936c3cb794a92b009ca59e292da0d4765b"><code>32620a9</code></a></td><td><code>A little bit of cleanup.</code></td></tr></table>




---

archive/issue_comments_360053.json:
```json
{
    "body": "Changed commit from **[`9fe10b6`](https://github.com/sagemath/sagetrac-mirror/commit/9fe10b6e1a2cbc2bd275ff2321ff20b2245d5c14)** to **[`32620a9`](https://github.com/sagemath/sagetrac-mirror/commit/32620a936c3cb794a92b009ca59e292da0d4765b)**",
    "created_at": "2017-09-16T21:11:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-360053",
    "user": "https://github.com/tscrim"
}
```

Changed commit from **[`9fe10b6`](https://github.com/sagemath/sagetrac-mirror/commit/9fe10b6e1a2cbc2bd275ff2321ff20b2245d5c14)** to **[`32620a9`](https://github.com/sagemath/sagetrac-mirror/commit/32620a936c3cb794a92b009ca59e292da0d4765b)**



---

archive/issue_events_328671.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2017-09-16T21:11:32Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23870#event-328671"
}
```



---

archive/issue_events_328672.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2017-09-16T21:11:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23870#event-328672"
}
```



---

archive/issue_comments_360054.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nGreat and thank you for explaining `startup`!  One question: is this going to affect startup time?",
    "created_at": "2017-09-17T06:36:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-360054",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:19" align="right">comment:19</div>

Great and thank you for explaining `startup`!  One question: is this going to affect startup time?



---

archive/issue_comments_360055.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nNot really, or at least I would be surprised if it did have an impact.",
    "created_at": "2017-09-17T07:19:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-360055",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:20" align="right">comment:20</div>

Not really, or at least I would be surprised if it did have an impact.



---

archive/issue_comments_360056.json:
```json
{
    "body": "Changed reviewer from **Travis Scrimshaw** to **Travis Scrimshaw, Martin Rubey**",
    "created_at": "2017-09-17T07:25:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-360056",
    "user": "https://github.com/mantepse"
}
```

Changed reviewer from **Travis Scrimshaw** to **Travis Scrimshaw, Martin Rubey**



---

archive/issue_comments_360057.json:
```json
{
    "body": "Changed author from **Martin Rubey** to **Martin Rubey, Travis Scrimshaw**",
    "created_at": "2017-09-17T07:25:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-360057",
    "user": "https://github.com/mantepse"
}
```

Changed author from **Martin Rubey** to **Martin Rubey, Travis Scrimshaw**



---

archive/issue_events_328673.json:
```json
{
    "actor": "https://github.com/mantepse",
    "created_at": "2017-09-17T07:25:05Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23870#event-328673"
}
```



---

archive/issue_events_328674.json:
```json
{
    "actor": "https://github.com/mantepse",
    "created_at": "2017-09-17T07:25:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23870#event-328674"
}
```



---

archive/issue_events_328675.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-09-20T22:26:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23870#event-328675"
}
```



---

archive/issue_events_328676.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "43505eec3b24f03c1ea3b4a247bb3ed502f8b9bd",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2017-09-20T22:26:20Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23870#event-328676"
}
```



---

archive/issue_comments_360058.json:
```json
{
    "body": "Changed branch from **[public/combinat/speed_up_permutation_to_matrix-23870](https://github.com/sagemath/sagetrac-mirror/tree/public/combinat/speed_up_permutation_to_matrix-23870)** to **[`32620a9`](https://github.com/sagemath/sagetrac-mirror/commit/32620a936c3cb794a92b009ca59e292da0d4765b)**",
    "created_at": "2017-09-20T22:26:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23870#issuecomment-360058",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[public/combinat/speed_up_permutation_to_matrix-23870](https://github.com/sagemath/sagetrac-mirror/tree/public/combinat/speed_up_permutation_to_matrix-23870)** to **[`32620a9`](https://github.com/sagemath/sagetrac-mirror/commit/32620a936c3cb794a92b009ca59e292da0d4765b)**
