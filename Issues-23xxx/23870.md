# Issue 23870: speed_up_Permutation_to_matrix

archive/issues_023633.json:
```json
{
    "body": "old:\n\n```\nsage: l = [pi for pi in Permutations(8)]\nsage: timeit(\"[elt.to_matrix() for elt in l]\")\n5 loops, best of 3: 11.2 s per loop\n```\nnew:\n\n```\nsage: timeit(\"[elt.to_matrix() for elt in l]\")\n5 loops, best of 3: 3.57 s per loop\n```\n\nBranch/Commit: [32620a936c3cb794a92b009ca59e292da0d4765b](https://github.com/sagemath/sagetrac-mirror/commit/32620a936c3cb794a92b009ca59e292da0d4765b)\n\nReviewer: Travis Scrimshaw, Martin Rubey\n\nAuthor: Martin Rubey, Travis Scrimshaw\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/23870\n\n",
    "closed_at": "2017-09-20T22:26:20Z",
    "created_at": "2017-09-15T17:53:51Z",
    "labels": [
        "component: combinatorics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "speed_up_Permutation_to_matrix",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23870",
    "user": "https://github.com/mantepse"
}
```
old:

```
sage: l = [pi for pi in Permutations(8)]
sage: timeit("[elt.to_matrix() for elt in l]")
5 loops, best of 3: 11.2 s per loop
```
new:

```
sage: timeit("[elt.to_matrix() for elt in l]")
5 loops, best of 3: 3.57 s per loop
```

Branch/Commit: [32620a936c3cb794a92b009ca59e292da0d4765b](https://github.com/sagemath/sagetrac-mirror/commit/32620a936c3cb794a92b009ca59e292da0d4765b)

Reviewer: Travis Scrimshaw, Martin Rubey

Author: Martin Rubey, Travis Scrimshaw

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/23870





---

archive/issue_comments_452770.json:
```json
{
    "body": "Changing branch from \"\" to \"u/mantepse/speed_up_permutation_to_matrix\"",
    "created_at": "2017-09-15T17:59:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452770",
    "user": "https://github.com/mantepse"
}
```

Changing branch from "" to "u/mantepse/speed_up_permutation_to_matrix"



---

archive/issue_comments_452771.json:
```json
{
    "body": "<a id='comment:2'></a>\nNew commits:\n|                                                                                                                                          |                                                                    |\n|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------|\n|[319b991](https://github.com/sagemath/sagetrac-mirror/commit/319b9914fbb0a531b11363c8ab8d907191a56897)|`clean Permutation.to_matrix, move out import in MatrixSpace.matrix`|",
    "created_at": "2017-09-15T18:07:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452771",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:2'></a>
New commits:
|                                                                                                                                          |                                                                    |
|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------|
|[319b991](https://github.com/sagemath/sagetrac-mirror/commit/319b9914fbb0a531b11363c8ab8d907191a56897)|`clean Permutation.to_matrix, move out import in MatrixSpace.matrix`|



---

archive/issue_comments_452772.json:
```json
{
    "body": "Changing author from \"\" to \"Martin Rubey\"",
    "created_at": "2017-09-15T18:07:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452772",
    "user": "https://github.com/mantepse"
}
```

Changing author from "" to "Martin Rubey"



---

archive/issue_comments_452773.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2017-09-15T18:07:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452773",
    "user": "https://github.com/mantepse"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_452774.json:
```json
{
    "body": "Changing commit from \"\" to \"319b9914fbb0a531b11363c8ab8d907191a56897\"",
    "created_at": "2017-09-15T18:07:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452774",
    "user": "https://github.com/mantepse"
}
```

Changing commit from "" to "319b9914fbb0a531b11363c8ab8d907191a56897"



---

archive/issue_comments_452775.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,13 @@\n+old:\n \n+```\n+sage: l = [pi for pi in Permutations(8)]\n+sage: timeit(\"[elt.to_matrix() for elt in l]\")\n+5 loops, best of 3: 11.2 s per loop\n+```\n+new:\n+\n+```\n+sage: timeit(\"[elt.to_matrix() for elt in l]\")\n+5 loops, best of 3: 3.57 s per loop\n+```\n``````\n",
    "created_at": "2017-09-15T18:28:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452775",
    "user": "https://github.com/mantepse"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,13 @@
+old:
 
+```
+sage: l = [pi for pi in Permutations(8)]
+sage: timeit("[elt.to_matrix() for elt in l]")
+5 loops, best of 3: 11.2 s per loop
+```
+new:
+
+```
+sage: timeit("[elt.to_matrix() for elt in l]")
+5 loops, best of 3: 3.57 s per loop
+```
``````




---

archive/issue_comments_452776.json:
```json
{
    "body": "Changing commit from \"319b9914fbb0a531b11363c8ab8d907191a56897\" to \"5f9ec285678e068ce50cace2b275af136b352bc7\"",
    "created_at": "2017-09-15T19:43:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452776",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "319b9914fbb0a531b11363c8ab8d907191a56897" to "5f9ec285678e068ce50cace2b275af136b352bc7"



---

archive/issue_comments_452777.json:
```json
{
    "body": "<a id='comment:4'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                               |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------|\n|[5f9ec28](https://github.com/sagemath/sagetrac-mirror/commit/5f9ec285678e068ce50cace2b275af136b352bc7)|`use the sparse matrix class directly in Permutation.to_matrix`|",
    "created_at": "2017-09-15T19:43:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452777",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                               |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------|
|[5f9ec28](https://github.com/sagemath/sagetrac-mirror/commit/5f9ec285678e068ce50cace2b275af136b352bc7)|`use the sparse matrix class directly in Permutation.to_matrix`|



---

archive/issue_comments_452778.json:
```json
{
    "body": "<a id='comment:5'></a>\nWhy is this needs_info? What information are you requesting? From the sage-devel thread?\n\nAlso, trivial PEP8 thing: `sparse = True` -> `sparse=True`.",
    "created_at": "2017-09-15T19:50:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452778",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:5'></a>
Why is this needs_info? What information are you requesting? From the sage-devel thread?

Also, trivial PEP8 thing: `sparse = True` -> `sparse=True`.



---

archive/issue_comments_452779.json:
```json
{
    "body": "<a id='comment:6'></a>\nReplying to [tscrim](#comment%3A5):\n> Why is this needs_info? What information are you requesting? From the sage-devel thread?\n\n\nI don't really like calling `Matrix_integer_sparse` directly.  I still have to check whether I can get comparable speed by removing the local imports in `MatrixSpace.matrix`.  If so, I would like to know why they are there in the first place.",
    "created_at": "2017-09-15T20:06:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452779",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:6'></a>
Replying to [tscrim](#comment%3A5):
> Why is this needs_info? What information are you requesting? From the sage-devel thread?


I don't really like calling `Matrix_integer_sparse` directly.  I still have to check whether I can get comparable speed by removing the local imports in `MatrixSpace.matrix`.  If so, I would like to know why they are there in the first place.



---

archive/issue_comments_452780.json:
```json
{
    "body": "<a id='comment:7'></a>\nWith the current version (calling the constructor directly), I'm down to\n\n```\nsage: timeit(\"[elt.to_matrix() for elt in l]\")\n5 loops, best of 3: 2.33 s per loop\n```",
    "created_at": "2017-09-15T20:27:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452780",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:7'></a>
With the current version (calling the constructor directly), I'm down to

```
sage: timeit("[elt.to_matrix() for elt in l]")
5 loops, best of 3: 2.33 s per loop
```



---

archive/issue_comments_452781.json:
```json
{
    "body": "<a id='comment:8'></a>\nUsing a `late_import` function, I get\n\n```\nsage: timeit(\"[elt.to_matrix() for elt in l]\", repeat=1, number=1)\n1 loops, best of 1: 3.01 s per loop\n```\n\nCould some design expert let me know what I should do now?\n\n1. `late_import`: speedup by a factor 3.7, but all calls to `MatrixSpace` benefit.\n2. `Matrix_integer_sparse`: speedup by a factor 4.8\n3. both\n\nI am for 1. or 3., but do not know which of the two is really better.\n\nOf course, I am willing to run more tests, but I wouldn't know which are expressive.",
    "created_at": "2017-09-15T20:53:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452781",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:8'></a>
Using a `late_import` function, I get

```
sage: timeit("[elt.to_matrix() for elt in l]", repeat=1, number=1)
1 loops, best of 1: 3.01 s per loop
```

Could some design expert let me know what I should do now?

1. `late_import`: speedup by a factor 3.7, but all calls to `MatrixSpace` benefit.
2. `Matrix_integer_sparse`: speedup by a factor 4.8
3. both

I am for 1. or 3., but do not know which of the two is really better.

Of course, I am willing to run more tests, but I wouldn't know which are expressive.



---

archive/issue_comments_452782.json:
```json
{
    "body": "<a id='comment:9'></a>\nAs I mentioned on sage-devel, use `lazy_import`, which should be more efficient because you don't have to do a Python call every time (which I am slightly surprised that the late_import is faster too). However, I am thinking a better way out is to use the hook we already have for matrices by `_matrix_`, which will open it up to more things (things that, IMO, it should already work for).\n\nSide note - I feel permutations should have `_matrix_ = to_matrix` to use `matrix(P)`.",
    "created_at": "2017-09-15T21:20:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452782",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:9'></a>
As I mentioned on sage-devel, use `lazy_import`, which should be more efficient because you don't have to do a Python call every time (which I am slightly surprised that the late_import is faster too). However, I am thinking a better way out is to use the hook we already have for matrices by `_matrix_`, which will open it up to more things (things that, IMO, it should already work for).

Side note - I feel permutations should have `_matrix_ = to_matrix` to use `matrix(P)`.



---

archive/issue_comments_452783.json:
```json
{
    "body": "<a id='comment:10'></a>\nActually, instead of directly calling the class, I would use\n\n```\nsage: MS = MatrixSpace(QQ, 3)\nsage: MS._get_matrix_class()\n<type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense'>\n```\nbut that would be acceptable for me because it is more robust against changes in the parent.",
    "created_at": "2017-09-15T21:24:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452783",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:10'></a>
Actually, instead of directly calling the class, I would use

```
sage: MS = MatrixSpace(QQ, 3)
sage: MS._get_matrix_class()
<type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense'>
```
but that would be acceptable for me because it is more robust against changes in the parent.



---

archive/issue_comments_452784.json:
```json
{
    "body": "<a id='comment:11'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                |\n|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------|\n|[ccc44c8](https://github.com/sagemath/sagetrac-mirror/commit/ccc44c87ede2a19b00889cdef79f978a647dd90a)|`move local imports into a late_import function`|",
    "created_at": "2017-09-15T21:25:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452784",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                |
|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------|
|[ccc44c8](https://github.com/sagemath/sagetrac-mirror/commit/ccc44c87ede2a19b00889cdef79f978a647dd90a)|`move local imports into a late_import function`|



---

archive/issue_comments_452785.json:
```json
{
    "body": "Changing commit from \"5f9ec285678e068ce50cace2b275af136b352bc7\" to \"ccc44c87ede2a19b00889cdef79f978a647dd90a\"",
    "created_at": "2017-09-15T21:25:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452785",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "5f9ec285678e068ce50cace2b275af136b352bc7" to "ccc44c87ede2a19b00889cdef79f978a647dd90a"



---

archive/issue_comments_452786.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [tscrim](#comment%3A9):\n> As I mentioned on sage-devel, use `lazy_import`, which should be more efficient because you don't have to do a Python call every time (which I am slightly surprised that the late_import is faster too).\n\n\nI have no idea how to use `lazy_import`.  I just pushed my `late_import` implementation, maybe you can guide me.\n\n> However, I am thinking a better way out is to use the hook we already have for matrices by `_matrix_`, which will open it up to more things (things that, IMO, it should already work for).\n\n\nI have no idea what you mean here.\n\n> Side note - I feel permutations should have `_matrix_ = to_matrix` to use `matrix(P)`.\n\n\nThis would allow to write `matrix(pi)` instead of `pi.to_matrix()`?",
    "created_at": "2017-09-15T21:30:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452786",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:12'></a>
Replying to [tscrim](#comment%3A9):
> As I mentioned on sage-devel, use `lazy_import`, which should be more efficient because you don't have to do a Python call every time (which I am slightly surprised that the late_import is faster too).


I have no idea how to use `lazy_import`.  I just pushed my `late_import` implementation, maybe you can guide me.

> However, I am thinking a better way out is to use the hook we already have for matrices by `_matrix_`, which will open it up to more things (things that, IMO, it should already work for).


I have no idea what you mean here.

> Side note - I feel permutations should have `_matrix_ = to_matrix` to use `matrix(P)`.


This would allow to write `matrix(pi)` instead of `pi.to_matrix()`?



---

archive/issue_comments_452787.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [tscrim](#comment%3A10):\n> Actually, instead of directly calling the class, I would use\n> \n> ```\n> sage: MS = MatrixSpace(QQ, 3)\n> sage: MS._get_matrix_class()\n> <type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense'>\n> ```\n> but that would be acceptable for me because it is more robust against changes in the parent.\n\n\nI tried this, but it kills quite a bit of the performance gain.",
    "created_at": "2017-09-15T21:31:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452787",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:13'></a>
Replying to [tscrim](#comment%3A10):
> Actually, instead of directly calling the class, I would use
> 
> ```
> sage: MS = MatrixSpace(QQ, 3)
> sage: MS._get_matrix_class()
> <type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense'>
> ```
> but that would be acceptable for me because it is more robust against changes in the parent.


I tried this, but it kills quite a bit of the performance gain.



---

archive/issue_comments_452788.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [mantepse](#comment%3A12):\n> Replying to [tscrim](#comment%3A9):\n> > As I mentioned on sage-devel, use `lazy_import`, which should be more efficient because you don't have to do a Python call every time (which I am slightly surprised that the late_import is faster too).\n\n> \n> I have no idea how to use `lazy_import`.  I just pushed my `late_import` implementation, maybe you can guide me.\n\n\n`grep` for `lazy_import`. It's self-explanatory and all over Sage.\n\n> > However, I am thinking a better way out is to use the hook we already have for matrices by `_matrix_`, which will open it up to more things (things that, IMO, it should already work for).\n\n> \n> I have no idea what you mean here.\n\n\nThis is what is done in the `matrix()` construction function. You just check `hasattr(M, \"_matrix_\")`. So, for example, permutations would be accepted as input with the change proposed below (which, IMO, is very natural).\n\n> > Side note - I feel permutations should have `_matrix_ = to_matrix` to use `matrix(P)`.\n\n> \n> This would allow to write `matrix(pi)` instead of `pi.to_matrix()`?\n\n\nCorrect.",
    "created_at": "2017-09-15T21:50:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452788",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:14'></a>
Replying to [mantepse](#comment%3A12):
> Replying to [tscrim](#comment%3A9):
> > As I mentioned on sage-devel, use `lazy_import`, which should be more efficient because you don't have to do a Python call every time (which I am slightly surprised that the late_import is faster too).

> 
> I have no idea how to use `lazy_import`.  I just pushed my `late_import` implementation, maybe you can guide me.


`grep` for `lazy_import`. It's self-explanatory and all over Sage.

> > However, I am thinking a better way out is to use the hook we already have for matrices by `_matrix_`, which will open it up to more things (things that, IMO, it should already work for).

> 
> I have no idea what you mean here.


This is what is done in the `matrix()` construction function. You just check `hasattr(M, "_matrix_")`. So, for example, permutations would be accepted as input with the change proposed below (which, IMO, is very natural).

> > Side note - I feel permutations should have `_matrix_ = to_matrix` to use `matrix(P)`.

> 
> This would allow to write `matrix(pi)` instead of `pi.to_matrix()`?


Correct.



---

archive/issue_comments_452789.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [mantepse](#comment%3A13):\n> Replying to [tscrim](#comment%3A10):\n> > Actually, instead of directly calling the class, I would use\n> > \n> > ```\n> > sage: MS = MatrixSpace(QQ, 3)\n> > sage: MS._get_matrix_class()\n> > <type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense'>\n> > ```\n> > but that would be acceptable for me because it is more robust against changes in the parent.\n\n> \n> I tried this, but it kills quite a bit of the performance gain.\n\n\nThe problem is caching. It is, in effect, cached, by being called in the `__init__` and setting the attribute `__matrix_class`. I am sure this was written a long time ago. So I would probably make `_matrix_class` a ``@`lazy_attribute`, replace the `__matrix_class` with `_matrix_class`, and get rid of `_get_matrix_class` (it needs no deprecation because it is not public).",
    "created_at": "2017-09-15T21:55:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452789",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:15'></a>
Replying to [mantepse](#comment%3A13):
> Replying to [tscrim](#comment%3A10):
> > Actually, instead of directly calling the class, I would use
> > 
> > ```
> > sage: MS = MatrixSpace(QQ, 3)
> > sage: MS._get_matrix_class()
> > <type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense'>
> > ```
> > but that would be acceptable for me because it is more robust against changes in the parent.

> 
> I tried this, but it kills quite a bit of the performance gain.


The problem is caching. It is, in effect, cached, by being called in the `__init__` and setting the attribute `__matrix_class`. I am sure this was written a long time ago. So I would probably make `_matrix_class` a ``@`lazy_attribute`, replace the `__matrix_class` with `_matrix_class`, and get rid of `_get_matrix_class` (it needs no deprecation because it is not public).



---

archive/issue_comments_452790.json:
```json
{
    "body": "<a id='comment:16'></a>\n> > I have no idea how to use `lazy_import`.  I just pushed my `late_import` implementation, maybe you can guide me.\n\n> \n> `grep` for `lazy_import`. It's self-explanatory and all over Sage.\n\n\nI did this before I wrote the `late_import` thing:\n\n```\nfrom sage.misc.lazy_import import lazy_import\nlazy_import('sage.groups.matrix_gps.group_element', 'is_MatrixGroupElement')\nlazy_import('sage.modular.arithgroup.arithgroup_element', 'ArithmeticSubgroupElement')\n```\n\nbut sage crashed on startup.  But I didn't try long - maybe I made a mistake when compiling or so.",
    "created_at": "2017-09-15T22:08:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452790",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:16'></a>
> > I have no idea how to use `lazy_import`.  I just pushed my `late_import` implementation, maybe you can guide me.

> 
> `grep` for `lazy_import`. It's self-explanatory and all over Sage.


I did this before I wrote the `late_import` thing:

```
from sage.misc.lazy_import import lazy_import
lazy_import('sage.groups.matrix_gps.group_element', 'is_MatrixGroupElement')
lazy_import('sage.modular.arithgroup.arithgroup_element', 'ArithmeticSubgroupElement')
```

but sage crashed on startup.  But I didn't try long - maybe I made a mistake when compiling or so.



---

archive/issue_comments_452791.json:
```json
{
    "body": "Changing commit from \"ccc44c87ede2a19b00889cdef79f978a647dd90a\" to \"9fe10b6e1a2cbc2bd275ff2321ff20b2245d5c14\"",
    "created_at": "2017-09-15T22:25:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452791",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "ccc44c87ede2a19b00889cdef79f978a647dd90a" to "9fe10b6e1a2cbc2bd275ff2321ff20b2245d5c14"



---

archive/issue_comments_452792.json:
```json
{
    "body": "<a id='comment:17'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                  |\n|-------------------------------------------------------------------------------------------------------------------------------------------|------------------|\n|[9fe10b6](https://github.com/sagemath/sagetrac-mirror/commit/9fe10b6e1a2cbc2bd275ff2321ff20b2245d5c14)|`provide _matrix_`|",
    "created_at": "2017-09-15T22:25:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452792",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                  |
|-------------------------------------------------------------------------------------------------------------------------------------------|------------------|
|[9fe10b6](https://github.com/sagemath/sagetrac-mirror/commit/9fe10b6e1a2cbc2bd275ff2321ff20b2245d5c14)|`provide _matrix_`|



---

archive/issue_comments_452793.json:
```json
{
    "body": "Changing branch from \"u/mantepse/speed_up_permutation_to_matrix\" to \"public/combinat/speed_up_permutation_to_matrix-23870\"",
    "created_at": "2017-09-16T21:11:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452793",
    "user": "https://github.com/tscrim"
}
```

Changing branch from "u/mantepse/speed_up_permutation_to_matrix" to "public/combinat/speed_up_permutation_to_matrix-23870"



---

archive/issue_comments_452794.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Travis Scrimshaw\"",
    "created_at": "2017-09-16T21:11:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452794",
    "user": "https://github.com/tscrim"
}
```

Changing reviewer from "" to "Travis Scrimshaw"



---

archive/issue_comments_452795.json:
```json
{
    "body": "<a id='comment:18'></a>\nYou needed to tell Sage that this needs to be resolved at startup (as the error message indicates). This is primarily a temporary solution until more involved changes with the matrix spaces are done (make `_get_matrix_class` into a ``@`lazy_attribute` `Element` so it behaves more like a proper parent and we can then use `MS.element_class` and use the methods `_matrix_`/`matrix` for constructing `matrix` and possibly coercion), which might need some further discussions.\n\nIf my changes are good, then I think we can set a positive review.\n\n---\nNew commits:\n|                                                                                                                                          |                                  |\n|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------|\n|[e0a64cc](https://github.com/sagemath/sagetrac-mirror/commit/e0a64cc5b0fa12683440fe9fed587221a39b931f)|`Use the much better lazy_import.`|\n|[32620a9](https://github.com/sagemath/sagetrac-mirror/commit/32620a936c3cb794a92b009ca59e292da0d4765b)|`A little bit of cleanup.`|",
    "created_at": "2017-09-16T21:11:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452795",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:18'></a>
You needed to tell Sage that this needs to be resolved at startup (as the error message indicates). This is primarily a temporary solution until more involved changes with the matrix spaces are done (make `_get_matrix_class` into a ``@`lazy_attribute` `Element` so it behaves more like a proper parent and we can then use `MS.element_class` and use the methods `_matrix_`/`matrix` for constructing `matrix` and possibly coercion), which might need some further discussions.

If my changes are good, then I think we can set a positive review.

---
New commits:
|                                                                                                                                          |                                  |
|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------|
|[e0a64cc](https://github.com/sagemath/sagetrac-mirror/commit/e0a64cc5b0fa12683440fe9fed587221a39b931f)|`Use the much better lazy_import.`|
|[32620a9](https://github.com/sagemath/sagetrac-mirror/commit/32620a936c3cb794a92b009ca59e292da0d4765b)|`A little bit of cleanup.`|



---

archive/issue_comments_452796.json:
```json
{
    "body": "Changing commit from \"9fe10b6e1a2cbc2bd275ff2321ff20b2245d5c14\" to \"32620a936c3cb794a92b009ca59e292da0d4765b\"",
    "created_at": "2017-09-16T21:11:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452796",
    "user": "https://github.com/tscrim"
}
```

Changing commit from "9fe10b6e1a2cbc2bd275ff2321ff20b2245d5c14" to "32620a936c3cb794a92b009ca59e292da0d4765b"



---

archive/issue_comments_452797.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2017-09-16T21:11:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452797",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_452798.json:
```json
{
    "body": "<a id='comment:19'></a>\nGreat and thank you for explaining `startup`!  One question: is this going to affect startup time?",
    "created_at": "2017-09-17T06:36:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452798",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:19'></a>
Great and thank you for explaining `startup`!  One question: is this going to affect startup time?



---

archive/issue_comments_452799.json:
```json
{
    "body": "<a id='comment:20'></a>\nNot really, or at least I would be surprised if it did have an impact.",
    "created_at": "2017-09-17T07:19:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452799",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:20'></a>
Not really, or at least I would be surprised if it did have an impact.



---

archive/issue_comments_452800.json:
```json
{
    "body": "Changing reviewer from \"Travis Scrimshaw\" to \"Travis Scrimshaw, Martin Rubey\"",
    "created_at": "2017-09-17T07:25:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452800",
    "user": "https://github.com/mantepse"
}
```

Changing reviewer from "Travis Scrimshaw" to "Travis Scrimshaw, Martin Rubey"



---

archive/issue_comments_452801.json:
```json
{
    "body": "Changing author from \"Martin Rubey\" to \"Martin Rubey, Travis Scrimshaw\"",
    "created_at": "2017-09-17T07:25:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452801",
    "user": "https://github.com/mantepse"
}
```

Changing author from "Martin Rubey" to "Martin Rubey, Travis Scrimshaw"



---

archive/issue_comments_452802.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-09-17T07:25:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452802",
    "user": "https://github.com/mantepse"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_452803.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-09-20T22:26:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452803",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_069129.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-09-20T22:26:20Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23870#event-69129"
}
```



---

archive/issue_comments_452804.json:
```json
{
    "body": "Changing branch from \"public/combinat/speed_up_permutation_to_matrix-23870\" to \"32620a936c3cb794a92b009ca59e292da0d4765b\"",
    "created_at": "2017-09-20T22:26:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23870#issuecomment-452804",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/combinat/speed_up_permutation_to_matrix-23870" to "32620a936c3cb794a92b009ca59e292da0d4765b"
