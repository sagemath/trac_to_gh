# Issue 23308: Doctest: segmentation fault with coefficients() on symbolic expressions

archive/issues_023308.json:
```json
{
    "body": "CC:  @rwst\n\nKeywords: bug, symbolics\n\nOn sage 8.0\n\n```\nsage: (x^2/(1+x)).coefficients()\nSegmentation fault (core dumped)\n```\n\ngdb shows that this is an infinite recursion in the Pynac library:\n\n```\n#0  GiNaC::add::integer_content (this=0x4095f00) at normal.cpp:95\n#1  0x00007fff50051660 in GiNaC::ex::integer_content (this=this@entry=0x7fffff7ff410) at normal.cpp:81\n#2  0x00007fff50076fdc in GiNaC::power::eval (this=0x7fffff800040, level=<optimized out>) at power.cpp:674\n#3  0x00007fff4ff9b29e in GiNaC::ex::construct_from_basic (other=...) at ex.cpp:691\n#4  0x00007fff50041ac3 in ex (other=..., this=0x7fffff800030) at ex.h:305\n#5  GiNaC::mul::combine_ex_with_coeff_to_pair (this=0x40961a0, e=..., c=...) at mul.cpp:1228\n#6  0x00007fff4ffa3084 in GiNaC::expairseq::evalchildren (this=this@entry=0x40961a0, level=1) at expairseq.cpp:1647\n#7  0x00007fff50047390 in GiNaC::mul::eval (this=0x40961a0, level=<optimized out>) at mul.cpp:666\n#8  0x00007fff4ff9b29e in GiNaC::ex::construct_from_basic (other=...) at ex.cpp:691\n#9  0x00007fff50049ff6 in ex (other=..., this=0x7fffff800690) at ex.h:305\n#10 GiNaC::mul::expand (this=0x4096030, options=0) at mul.cpp:1490\n#11 0x00007fff4ff9ac0d in GiNaC::ex::expand (this=this@entry=0x7fffff800bf0, options=options@entry=0) at ex.cpp:84\n#12 0x00007fff4ff9eec9 in expand (options=0, thisex=...) at ex.h:701\n#13 GiNaC::match_monom (term=..., symb=..., vec=..., map=...) at ex.cpp:523\n#14 0x00007fff4ff9f8c8 in GiNaC::ex::coefficients (this=this@entry=0x7fffff800e00, s=..., vec=...) at ex.cpp:576\n#15 0x00007fff4ff9eed7 in GiNaC::match_monom (term=..., symb=..., vec=..., map=...) at ex.cpp:523\n#16 0x00007fff4ff9f8c8 in GiNaC::ex::coefficients (this=this@entry=0x7fffff8011c0, s=..., vec=...) at ex.cpp:576\n#17 0x00007fff4ff9eed7 in GiNaC::match_monom (term=..., symb=..., vec=..., map=...) at ex.cpp:523\n#18 0x00007fff4ff9f8c8 in GiNaC::ex::coefficients (this=this@entry=0x7fffff801580, s=..., vec=...) at ex.cpp:576\n#19 0x00007fff4ff9eed7 in GiNaC::match_monom (term=..., symb=..., vec=..., map=...) at ex.cpp:523\n#20 0x00007fff4ff9f8c8 in GiNaC::ex::coefficients (this=this@entry=0x7fffff801940, s=..., vec=...) at ex.cpp:576\n[...]\n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/23545\n\n",
    "closed_at": "2017-12-29T08:57:26Z",
    "created_at": "2017-07-26T09:44:39Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Doctest: segmentation fault with coefficients() on symbolic expressions",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23308",
    "user": "https://github.com/videlec"
}
```
CC:  @rwst

Keywords: bug, symbolics

On sage 8.0

```
sage: (x^2/(1+x)).coefficients()
Segmentation fault (core dumped)
```

gdb shows that this is an infinite recursion in the Pynac library:

```
#0  GiNaC::add::integer_content (this=0x4095f00) at normal.cpp:95
#1  0x00007fff50051660 in GiNaC::ex::integer_content (this=this@entry=0x7fffff7ff410) at normal.cpp:81
#2  0x00007fff50076fdc in GiNaC::power::eval (this=0x7fffff800040, level=<optimized out>) at power.cpp:674
#3  0x00007fff4ff9b29e in GiNaC::ex::construct_from_basic (other=...) at ex.cpp:691
#4  0x00007fff50041ac3 in ex (other=..., this=0x7fffff800030) at ex.h:305
#5  GiNaC::mul::combine_ex_with_coeff_to_pair (this=0x40961a0, e=..., c=...) at mul.cpp:1228
#6  0x00007fff4ffa3084 in GiNaC::expairseq::evalchildren (this=this@entry=0x40961a0, level=1) at expairseq.cpp:1647
#7  0x00007fff50047390 in GiNaC::mul::eval (this=0x40961a0, level=<optimized out>) at mul.cpp:666
#8  0x00007fff4ff9b29e in GiNaC::ex::construct_from_basic (other=...) at ex.cpp:691
#9  0x00007fff50049ff6 in ex (other=..., this=0x7fffff800690) at ex.h:305
#10 GiNaC::mul::expand (this=0x4096030, options=0) at mul.cpp:1490
#11 0x00007fff4ff9ac0d in GiNaC::ex::expand (this=this@entry=0x7fffff800bf0, options=options@entry=0) at ex.cpp:84
#12 0x00007fff4ff9eec9 in expand (options=0, thisex=...) at ex.h:701
#13 GiNaC::match_monom (term=..., symb=..., vec=..., map=...) at ex.cpp:523
#14 0x00007fff4ff9f8c8 in GiNaC::ex::coefficients (this=this@entry=0x7fffff800e00, s=..., vec=...) at ex.cpp:576
#15 0x00007fff4ff9eed7 in GiNaC::match_monom (term=..., symb=..., vec=..., map=...) at ex.cpp:523
#16 0x00007fff4ff9f8c8 in GiNaC::ex::coefficients (this=this@entry=0x7fffff8011c0, s=..., vec=...) at ex.cpp:576
#17 0x00007fff4ff9eed7 in GiNaC::match_monom (term=..., symb=..., vec=..., map=...) at ex.cpp:523
#18 0x00007fff4ff9f8c8 in GiNaC::ex::coefficients (this=this@entry=0x7fffff801580, s=..., vec=...) at ex.cpp:576
#19 0x00007fff4ff9eed7 in GiNaC::match_monom (term=..., symb=..., vec=..., map=...) at ex.cpp:523
#20 0x00007fff4ff9f8c8 in GiNaC::ex::coefficients (this=this@entry=0x7fffff801940, s=..., vec=...) at ex.cpp:576
[...]
```

Issue created by migration from https://trac.sagemath.org/ticket/23545





---

archive/issue_comments_325796.json:
```json
{
    "body": "Confirmed. I added a minimal case.",
    "created_at": "2017-07-26T13:39:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23308#issuecomment-325796",
    "user": "https://github.com/rwst"
}
```

Confirmed. I added a minimal case.



---

archive/issue_comments_325797.json:
```json
{
    "body": "The Pynac code does not check if the expression is a polynomial fraction in `x`. That case cannot be handled via `coefficient()` (the user should expand as a series). I will add a check to prevent this problem.",
    "created_at": "2017-07-29T14:41:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23308#issuecomment-325797",
    "user": "https://github.com/rwst"
}
```

The Pynac code does not check if the expression is a polynomial fraction in `x`. That case cannot be handled via `coefficient()` (the user should expand as a series). I will add a check to prevent this problem.



---

archive/issue_comments_325798.json:
```json
{
    "body": "Pynac master has the fix. This branch adds doctests.\n\n---\nNew commits:",
    "created_at": "2017-08-03T06:33:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23308#issuecomment-325798",
    "user": "https://github.com/rwst"
}
```

Pynac master has the fix. This branch adds doctests.

---
New commits:



---

archive/issue_comments_325799.json:
```json
{
    "body": "While the core dump is fixed in develop, one of the doctests fails.",
    "created_at": "2017-09-06T04:47:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23308#issuecomment-325799",
    "user": "https://github.com/rwst"
}
```

While the core dump is fixed in develop, one of the doctests fails.



---

archive/issue_comments_325800.json:
```json
{
    "body": "Fixed by #24262. I will give positive review if necessary, but as suggest to matk it duplicate and close it (after positive review of #24262, pf course...)..",
    "created_at": "2017-11-22T22:19:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23308#issuecomment-325800",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Fixed by #24262. I will give positive review if necessary, but as suggest to matk it duplicate and close it (after positive review of #24262, pf course...)..



---

archive/issue_comments_325801.json:
```json
{
    "body": "This ticket has doctests for #24147 too so let's make #24147 the duplicate.",
    "created_at": "2017-11-23T06:44:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23308#issuecomment-325801",
    "user": "https://github.com/rwst"
}
```

This ticket has doctests for #24147 too so let's make #24147 the duplicate.



---

archive/issue_events_060334.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2017-12-26T09:35:07Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23308",
    "milestone": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23308#event-60334"
}
```



---

archive/issue_comments_325802.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-12-26T09:35:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23308#issuecomment-325802",
    "user": "https://github.com/rwst"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_325803.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-12-27T08:29:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23308#issuecomment-325803",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_325804.json:
```json
{
    "body": "LGTM.",
    "created_at": "2017-12-27T08:29:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23308#issuecomment-325804",
    "user": "https://github.com/tscrim"
}
```

LGTM.



---

archive/issue_events_060335.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-12-29T08:57:26Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23308",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23308#event-60335"
}
```



---

archive/issue_comments_325805.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-12-29T08:57:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23308#issuecomment-325805",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
