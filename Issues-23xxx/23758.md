# Issue 23758: sage.env: _add_variable_or_fallback depends on the order of a dict

archive/issues_023521.json:
```json
{
    "body": "In `sage/env.py`, the function `_add_variable_or_fallback` does some variable substitution: if a string contains `$VAR`, it substitutes the value of `VAR` in the dictionary `SAGE_ENV`. It does this by iterating through the items of `SAGE_ENV`, which means that if both `VAR` and `VAR_OTHER` are in `SAGE_ENV`, it's sort of a coin toss as to what happens when it comes across `$VAR_OTHER`.\n\n(This arose when I was working on #21469: the string `$SAGE_SRC_ROOT` was being replaced by the value of `SAGE_SRC`, followed by the string `_ROOT`.)\n\nCC:  @mkoeppe\n\nReviewer: Matthias Koeppe\n\nAuthor: John Palmieri\n\nBranch: 343d685800f3c4018724cbea795e79d64c9adeca\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/23758\n\n",
    "closed_at": "2017-09-04T06:11:11Z",
    "created_at": "2017-08-30T18:33:18Z",
    "labels": [
        "component: build",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "sage.env: _add_variable_or_fallback depends on the order of a dict",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23758",
    "user": "https://github.com/jhpalmieri"
}
```
In `sage/env.py`, the function `_add_variable_or_fallback` does some variable substitution: if a string contains `$VAR`, it substitutes the value of `VAR` in the dictionary `SAGE_ENV`. It does this by iterating through the items of `SAGE_ENV`, which means that if both `VAR` and `VAR_OTHER` are in `SAGE_ENV`, it's sort of a coin toss as to what happens when it comes across `$VAR_OTHER`.

(This arose when I was working on #21469: the string `$SAGE_SRC_ROOT` was being replaced by the value of `SAGE_SRC`, followed by the string `_ROOT`.)

CC:  @mkoeppe

Reviewer: Matthias Koeppe

Author: John Palmieri

Branch: 343d685800f3c4018724cbea795e79d64c9adeca

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/23758





---

archive/issue_comments_448268.json:
```json
{
    "body": "Changing branch from \"\" to \"u/jhpalmieri/variable_replacement\"",
    "created_at": "2017-08-30T18:51:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23758#issuecomment-448268",
    "user": "https://github.com/jhpalmieri"
}
```

Changing branch from "" to "u/jhpalmieri/variable_replacement"



---

archive/issue_comments_448269.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-08-30T18:51:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23758#issuecomment-448269",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_448270.json:
```json
{
    "body": "<a id='comment:2'></a>New commits:",
    "created_at": "2017-08-30T18:51:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23758#issuecomment-448270",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:2'></a>New commits:



---

archive/issue_comments_448271.json:
```json
{
    "body": "Changing commit from \"\" to \"60927e52bd991cce1467ce0488ad29a4915b1986\"",
    "created_at": "2017-08-30T18:51:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23758#issuecomment-448271",
    "user": "https://github.com/jhpalmieri"
}
```

Changing commit from "" to "60927e52bd991cce1467ce0488ad29a4915b1986"



---

archive/issue_comments_448272.json:
```json
{
    "body": "Changing commit from \"60927e52bd991cce1467ce0488ad29a4915b1986\" to \"c23cc1cb041c57d364edd3b39389af7e1945ff44\"",
    "created_at": "2017-08-30T20:28:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23758#issuecomment-448272",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "60927e52bd991cce1467ce0488ad29a4915b1986" to "c23cc1cb041c57d364edd3b39389af7e1945ff44"



---

archive/issue_comments_448273.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-08-30T20:28:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23758#issuecomment-448273",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_448274.json:
```json
{
    "body": "<a id='comment:4'></a>I don't know, maybe we can just get rid of this whole variable substitution business, by using the Python variable `SAGE_ROOT` instead of `\"$SAGE_ROOT\"`?",
    "created_at": "2017-08-30T23:26:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23758#issuecomment-448274",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>I don't know, maybe we can just get rid of this whole variable substitution business, by using the Python variable `SAGE_ROOT` instead of `"$SAGE_ROOT"`?



---

archive/issue_comments_448275.json:
```json
{
    "body": "<a id='comment:5'></a>(Could be a follow-up ticket.)",
    "created_at": "2017-08-30T23:41:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23758#issuecomment-448275",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>(Could be a follow-up ticket.)



---

archive/issue_comments_448276.json:
```json
{
    "body": "<a id='comment:6'></a>Perhaps add a doctest?",
    "created_at": "2017-08-30T23:42:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23758#issuecomment-448276",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>Perhaps add a doctest?



---

archive/issue_comments_448277.json:
```json
{
    "body": "Changing commit from \"c23cc1cb041c57d364edd3b39389af7e1945ff44\" to \"343d685800f3c4018724cbea795e79d64c9adeca\"",
    "created_at": "2017-08-31T01:18:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23758#issuecomment-448277",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "c23cc1cb041c57d364edd3b39389af7e1945ff44" to "343d685800f3c4018724cbea795e79d64c9adeca"



---

archive/issue_comments_448278.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-08-31T01:18:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23758#issuecomment-448278",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_448279.json:
```json
{
    "body": "<a id='comment:8'></a>Here is a doctest. The same test fails for me in the develop branch, but I suppose that failure may not be repeatable on all platforms, since dictionaries are not ordered.",
    "created_at": "2017-08-31T01:19:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23758#issuecomment-448279",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:8'></a>Here is a doctest. The same test fails for me in the develop branch, but I suppose that failure may not be repeatable on all platforms, since dictionaries are not ordered.



---

archive/issue_comments_448280.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:4 mkoeppe]:\n> I don't know, maybe we can just get rid of this whole variable substitution business, by using the Python variable `SAGE_ROOT` instead of `\"$SAGE_ROOT\"`?\n\n\nI agree, a followup ticket if we want to address this. I'm not sure what the point of the substitution is, compared to using shell variables or some shortcut for accessing `SAGE_ENV['foo']`.",
    "created_at": "2017-08-31T01:22:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23758#issuecomment-448280",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:9'></a>Replying to [comment:4 mkoeppe]:
> I don't know, maybe we can just get rid of this whole variable substitution business, by using the Python variable `SAGE_ROOT` instead of `"$SAGE_ROOT"`?


I agree, a followup ticket if we want to address this. I'm not sure what the point of the substitution is, compared to using shell variables or some shortcut for accessing `SAGE_ENV['foo']`.



---

archive/issue_comments_448281.json:
```json
{
    "body": "Changing author from \"\" to \"John H. Palmieri\"",
    "created_at": "2017-08-31T04:54:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23758#issuecomment-448281",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "" to "John H. Palmieri"



---

archive/issue_comments_448282.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-08-31T04:54:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23758#issuecomment-448282",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_448283.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Matthias Koeppe\"",
    "created_at": "2017-08-31T04:54:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23758#issuecomment-448283",
    "user": "https://github.com/mkoeppe"
}
```

Changing reviewer from "" to "Matthias Koeppe"



---

archive/issue_comments_448284.json:
```json
{
    "body": "<a id='comment:11'></a>Follow up ticket is #23762.",
    "created_at": "2017-08-31T05:01:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23758#issuecomment-448284",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:11'></a>Follow up ticket is #23762.



---

archive/issue_comments_448285.json:
```json
{
    "body": "Changing commit from \"343d685800f3c4018724cbea795e79d64c9adeca\" to \"c7cff80c2eb7c62e09917ac95f44305d3884ebd2\"",
    "created_at": "2017-08-31T22:32:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23758#issuecomment-448285",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "343d685800f3c4018724cbea795e79d64c9adeca" to "c7cff80c2eb7c62e09917ac95f44305d3884ebd2"



---

archive/issue_comments_448286.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2017-08-31T22:32:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23758#issuecomment-448286",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_448287.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2017-08-31T22:32:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23758#issuecomment-448287",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_448288.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-08-31T22:33:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23758#issuecomment-448288",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_448289.json:
```json
{
    "body": "Changing commit from \"c7cff80c2eb7c62e09917ac95f44305d3884ebd2\" to \"343d685800f3c4018724cbea795e79d64c9adeca\"",
    "created_at": "2017-08-31T22:33:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23758#issuecomment-448289",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "c7cff80c2eb7c62e09917ac95f44305d3884ebd2" to "343d685800f3c4018724cbea795e79d64c9adeca"



---

archive/issue_comments_448290.json:
```json
{
    "body": "<a id='comment:14'></a>Sorry, I accidentally pushed a branch here instead of to the appropriate ticket. The positively reviewed branch has been restored.",
    "created_at": "2017-08-31T22:35:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23758#issuecomment-448290",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:14'></a>Sorry, I accidentally pushed a branch here instead of to the appropriate ticket. The positively reviewed branch has been restored.



---

archive/issue_comments_448291.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-09-01T15:53:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23758#issuecomment-448291",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_448292.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-09-04T06:11:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23758#issuecomment-448292",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_448293.json:
```json
{
    "body": "Changing branch from \"u/jhpalmieri/variable_replacement\" to \"343d685800f3c4018724cbea795e79d64c9adeca\"",
    "created_at": "2017-09-04T06:11:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23758#issuecomment-448293",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/jhpalmieri/variable_replacement" to "343d685800f3c4018724cbea795e79d64c9adeca"



---

archive/issue_events_060633.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-09-04T06:11:11Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23758",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23758#event-60633"
}
```



---

archive/issue_comments_448294.json:
```json
{
    "body": "Changing commit from \"343d685800f3c4018724cbea795e79d64c9adeca\" to \"\"",
    "created_at": "2017-12-08T14:51:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23758#issuecomment-448294",
    "user": "https://github.com/jdemeyer"
}
```

Changing commit from "343d685800f3c4018724cbea795e79d64c9adeca" to ""



---

archive/issue_comments_448295.json:
```json
{
    "body": "Changing author from \"John H. Palmieri\" to \"John Palmieri\"",
    "created_at": "2017-12-08T14:51:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23758",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23758#issuecomment-448295",
    "user": "https://github.com/jdemeyer"
}
```

Changing author from "John H. Palmieri" to "John Palmieri"
