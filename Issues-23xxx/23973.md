# Issue 23973: doc build hangs on Cygwin

archive/issues_023736.json:
```json
{
    "body": "For a few weeks now (I haven't been able to pursue the issue much due to travel) I've had to take the Cygwin patchbot down due to an issue that didn't occur before where building the docs, particularly with multiple processes, hangs indefinitely.\n\nFor some reason, the problem appears to begin with [this commit](https://git.sagemath.org/sage.git/commit/?id=8cb8a4d58dd74922a5b66d6b20f0b3a7507ea611).  Before this commit the docs build no problem.  After this commit it will build several documents and then all the worker processes will just deadlock it seems.\n\n**Upstream PR:** https://github.com/ivmai/bdwgc/pull/187\n\nKeywords: windows cygwin ecl gc\n\nUpstream: Fixed upstream, but not in a stable release.\n\nReviewer: Jeroen Demeyer\n\nAuthor: Erik Bray\n\nBranch: 5863356b68e1796ea3c6d92391753a6bfbc93ca7\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/23973\n\n",
    "closed_at": "2017-10-16T22:45:06Z",
    "created_at": "2017-10-06T07:51:40Z",
    "labels": [
        "component: porting: cygwin",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "doc build hangs on Cygwin",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23973",
    "user": "https://github.com/embray"
}
```
For a few weeks now (I haven't been able to pursue the issue much due to travel) I've had to take the Cygwin patchbot down due to an issue that didn't occur before where building the docs, particularly with multiple processes, hangs indefinitely.

For some reason, the problem appears to begin with [this commit](https://git.sagemath.org/sage.git/commit/?id=8cb8a4d58dd74922a5b66d6b20f0b3a7507ea611).  Before this commit the docs build no problem.  After this commit it will build several documents and then all the worker processes will just deadlock it seems.

**Upstream PR:** https://github.com/ivmai/bdwgc/pull/187

Keywords: windows cygwin ecl gc

Upstream: Fixed upstream, but not in a stable release.

Reviewer: Jeroen Demeyer

Author: Erik Bray

Branch: 5863356b68e1796ea3c6d92391753a6bfbc93ca7

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/23973





---

archive/issue_comments_452848.json:
```json
{
    "body": "<a id='comment:1'></a>Does this happen after a *failure* or during a *successful* build?",
    "created_at": "2017-10-06T09:07:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452848",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:1'></a>Does this happen after a *failure* or during a *successful* build?



---

archive/issue_comments_452849.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,3 @@\n For a few weeks now (I haven't been able to pursue the issue much due to travel) I've had to take the Cygwin patchbot down due to an issue that didn't occur before where building the docs, particularly with multiple processes, hangs indefinitely.\n \n-I'm still trying to track down the commit where this issue began.  But in the meantime testing on Cygwin has been stunted due to this.  I hope to get to the bottom of it ASAP.\n+For some reason, the problem appears to begin with [this commit](https://git.sagemath.org/sage.git/commit/?id=8cb8a4d58dd74922a5b66d6b20f0b3a7507ea611).  Before this commit the docs build no problem.  After this commit it will build several documents and then all the worker processes will just deadlock it seems.\n``````\n",
    "created_at": "2017-10-06T09:16:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452849",
    "user": "https://github.com/embray"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,3 @@
 For a few weeks now (I haven't been able to pursue the issue much due to travel) I've had to take the Cygwin patchbot down due to an issue that didn't occur before where building the docs, particularly with multiple processes, hangs indefinitely.
 
-I'm still trying to track down the commit where this issue began.  But in the meantime testing on Cygwin has been stunted due to this.  I hope to get to the bottom of it ASAP.
+For some reason, the problem appears to begin with [this commit](https://git.sagemath.org/sage.git/commit/?id=8cb8a4d58dd74922a5b66d6b20f0b3a7507ea611).  Before this commit the docs build no problem.  After this commit it will build several documents and then all the worker processes will just deadlock it seems.
``````




---

archive/issue_comments_452850.json:
```json
{
    "body": "<a id='comment:3'></a>Hard to say, but now that I take a careful look at the doc build log I think there might be an unhandled failure of some sort. I just tried a new build from scratch and here's what I found:  The document `en/constructions`, that was edited in that commit, starts building (again, this is a parallel build so the log is interleaved):\n\n```\n[dochtml] Building en/constructions.\n[dochtml]\n[dochtml] [construct] loading pickled environment... not yet created\n[dochtml] [construct] Compiling the master document\n[dochtml] [construct] building [mo]: targets for 0 po files that are out of date\n[dochtml] [construct] building [html]: targets for 16 source files that are out of date\n[dochtml] [construct] updating environment: 16 added, 0 changed, 0 removed\n[dochtml] [construct] reading sources... [  6%] algebraic_geometry\n[dochtml] [a_tour_of] pickling environment... done\n[dochtml] [a_tour_of] checking consistency... done\n[dochtml] [a_tour_of] preparing documents... done\n[dochtml] [a_tour_of] writing output... [100%] index\n[dochtml] [construct] reading sources... [ 12%] calculus\n[dochtml] [a_tour_of] generating indices... genindex\n[dochtml] [a_tour_of] Merging js index files...\n[dochtml] [a_tour_of] ... done (108 js index entries)\n[dochtml] [a_tour_of] Writing js search indexes...writing additional pages... search\n[dochtml] [a_tour_of] copying images... [ 50%] sin_plot.png\n[dochtml] [a_tour_of] copying images... [100%] eigen_plot.png\n[dochtml] Insufficient memory for black list\n```\n\nIt's not clear where \"Insufficient memory for black list\" is coming from but probably `en/constructions`.  After that there's no more output from that worker, but the remaining documents get built successfully, and then the build hangs.\n\nSo I guess this is a matter of poor error handling.  Reminds me I should finish my work to generalize `DocTestDispatcher.parallel_dispatch` :)",
    "created_at": "2017-10-06T11:08:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452850",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>Hard to say, but now that I take a careful look at the doc build log I think there might be an unhandled failure of some sort. I just tried a new build from scratch and here's what I found:  The document `en/constructions`, that was edited in that commit, starts building (again, this is a parallel build so the log is interleaved):

```
[dochtml] Building en/constructions.
[dochtml]
[dochtml] [construct] loading pickled environment... not yet created
[dochtml] [construct] Compiling the master document
[dochtml] [construct] building [mo]: targets for 0 po files that are out of date
[dochtml] [construct] building [html]: targets for 16 source files that are out of date
[dochtml] [construct] updating environment: 16 added, 0 changed, 0 removed
[dochtml] [construct] reading sources... [  6%] algebraic_geometry
[dochtml] [a_tour_of] pickling environment... done
[dochtml] [a_tour_of] checking consistency... done
[dochtml] [a_tour_of] preparing documents... done
[dochtml] [a_tour_of] writing output... [100%] index
[dochtml] [construct] reading sources... [ 12%] calculus
[dochtml] [a_tour_of] generating indices... genindex
[dochtml] [a_tour_of] Merging js index files...
[dochtml] [a_tour_of] ... done (108 js index entries)
[dochtml] [a_tour_of] Writing js search indexes...writing additional pages... search
[dochtml] [a_tour_of] copying images... [ 50%] sin_plot.png
[dochtml] [a_tour_of] copying images... [100%] eigen_plot.png
[dochtml] Insufficient memory for black list
```

It's not clear where "Insufficient memory for black list" is coming from but probably `en/constructions`.  After that there's no more output from that worker, but the remaining documents get built successfully, and then the build hangs.

So I guess this is a matter of poor error handling.  Reminds me I should finish my work to generalize `DocTestDispatcher.parallel_dispatch` :)



---

archive/issue_comments_452851.json:
```json
{
    "body": "<a id='comment:4'></a>Well this is definitely strange. I don't know why it would give an \"Insufficient memory\" error.  This error is apparently coming from gc which is trying to initialize about 1 MB, and it definitely should be able to do that...",
    "created_at": "2017-10-06T14:28:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452851",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>Well this is definitely strange. I don't know why it would give an "Insufficient memory" error.  This error is apparently coming from gc which is trying to initialize about 1 MB, and it definitely should be able to do that...



---

archive/issue_comments_452852.json:
```json
{
    "body": "<a id='comment:5'></a>Sorry for the obvious question, but are you sure that you are not *actually* running out of memory? It's well known that the Sage docbuilder requires a lot of memory.",
    "created_at": "2017-10-06T14:39:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452852",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>Sorry for the obvious question, but are you sure that you are not *actually* running out of memory? It's well known that the Sage docbuilder requires a lot of memory.



---

archive/issue_comments_452853.json:
```json
{
    "body": "<a id='comment:6'></a>Yeah it's a fair question, but I'm pretty sure not.  I have 32GB available and got this even when closing most other applications.  I watched memory usage during a build and it still did not even come close to using all my system's memory.  In any case, it fails almost deterministically to make this one 1 MB allocation, so that seems unlikely.  I fear it might be a more subtle bug with gc and/or ecl, possibly having to do with fork (it wouldn't be the first one I've encountered).",
    "created_at": "2017-10-06T15:35:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452853",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>Yeah it's a fair question, but I'm pretty sure not.  I have 32GB available and got this even when closing most other applications.  I watched memory usage during a build and it still did not even come close to using all my system's memory.  In any case, it fails almost deterministically to make this one 1 MB allocation, so that seems unlikely.  I fear it might be a more subtle bug with gc and/or ecl, possibly having to do with fork (it wouldn't be the first one I've encountered).



---

archive/issue_comments_452854.json:
```json
{
    "body": "<a id='comment:7'></a>Yes, 32GB should be enough, unless you are using too many processes. Does it work when building the docs serially? See also #21389.",
    "created_at": "2017-10-07T15:46:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452854",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>Yes, 32GB should be enough, unless you are using too many processes. Does it work when building the docs serially? See also #21389.



---

archive/issue_comments_452855.json:
```json
{
    "body": "<a id='comment:8'></a>Yes, it seems to occur specifically when using multiprocessing (I'm only using 4 processes for the present test, but I will try manually undoing #21389 and seeing if it happens even with 1 process).  Still, that all makes me think it's nothing to do with the doc build itself, though I'm failing to reproduce the issue outside that context.",
    "created_at": "2017-10-09T08:21:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452855",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>Yes, it seems to occur specifically when using multiprocessing (I'm only using 4 processes for the present test, but I will try manually undoing #21389 and seeing if it happens even with 1 process).  Still, that all makes me think it's nothing to do with the doc build itself, though I'm failing to reproduce the issue outside that context.



---

archive/issue_comments_452856.json:
```json
{
    "body": "<a id='comment:9'></a>Given the commit that you pointed to, it seems that something goes wrong when producing that plot in the context of multiprocessing.\n\nMaybe a simple workaround would be to disallow docbuilding in parallel on Cygwin?",
    "created_at": "2017-10-09T08:45:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452856",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>Given the commit that you pointed to, it seems that something goes wrong when producing that plot in the context of multiprocessing.

Maybe a simple workaround would be to disallow docbuilding in parallel on Cygwin?



---

archive/issue_comments_452857.json:
```json
{
    "body": "<a id='comment:10'></a>Well yes, clearly.  But that would be shuffling the problem under the rug (which might be fine if I can't find something else out soon...).  It's in reading the sources for that file where it crashes.  But I can reproduce that plot fine on my own--even running that code directly using `multiprocessing.Pool` appears to work fine.  What's also strange is I can't reproduce the issue if I run a parallel doc build with just that document, or with a small handful of documents.\n\nThe code for that plot calls `PiecewiseFunction.fourier_series_partial_sum` which is using maxima do some symbolic integrations, and that's specifically where the failure must be occurring. I'm running the doc build again with `GC_PRINT_VERBOSE_STATS=1` to see if anything turns up...",
    "created_at": "2017-10-09T09:07:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452857",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'></a>Well yes, clearly.  But that would be shuffling the problem under the rug (which might be fine if I can't find something else out soon...).  It's in reading the sources for that file where it crashes.  But I can reproduce that plot fine on my own--even running that code directly using `multiprocessing.Pool` appears to work fine.  What's also strange is I can't reproduce the issue if I run a parallel doc build with just that document, or with a small handful of documents.

The code for that plot calls `PiecewiseFunction.fourier_series_partial_sum` which is using maxima do some symbolic integrations, and that's specifically where the failure must be occurring. I'm running the doc build again with `GC_PRINT_VERBOSE_STATS=1` to see if anything turns up...



---

archive/issue_comments_452858.json:
```json
{
    "body": "<a id='comment:11'></a>There are a few potentially relevant bug fixes in libgc since the current version in Sage.  I'm going to try merging #23700 (for starters) and see if that helps.",
    "created_at": "2017-10-09T09:59:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452858",
    "user": "https://github.com/embray"
}
```

<a id='comment:11'></a>There are a few potentially relevant bug fixes in libgc since the current version in Sage.  I'm going to try merging #23700 (for starters) and see if that helps.



---

archive/issue_comments_452859.json:
```json
{
    "body": "<a id='comment:12'></a>Unfortunately simply upgrading to gc 7.6 did not resolve the problem.  All it gave me was a little additional error output but nothing immediately helpful.",
    "created_at": "2017-10-09T11:46:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452859",
    "user": "https://github.com/embray"
}
```

<a id='comment:12'></a>Unfortunately simply upgrading to gc 7.6 did not resolve the problem.  All it gave me was a little additional error output but nothing immediately helpful.



---

archive/issue_comments_452860.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:12 embray]:\n> Unfortunately simply upgrading to gc 7.6 did not resolve the problem.  All it gave me was a little additional error output but nothing immediately helpful.\n\n\nI take it back. Looking at the error message it gave it actually couldn't have been using gc 7.6.  In fact for some reason when I upgraded gc it did not replace the old DLL.",
    "created_at": "2017-10-09T12:02:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452860",
    "user": "https://github.com/embray"
}
```

<a id='comment:13'></a>Replying to [comment:12 embray]:
> Unfortunately simply upgrading to gc 7.6 did not resolve the problem.  All it gave me was a little additional error output but nothing immediately helpful.


I take it back. Looking at the error message it gave it actually couldn't have been using gc 7.6.  In fact for some reason when I upgraded gc it did not replace the old DLL.



---

archive/issue_comments_452861.json:
```json
{
    "body": "<a id='comment:14'></a>I got gc 7.6 installed correctly this time, but unfortunately it still did not resolve the problem.  The error message output during the build of this document is now slightly more helpful but not by much:\n\n```\nGC Warning: Out of memory - trying to allocate requested amount (8224 bytes)...\nInsufficient memory for black list\n```",
    "created_at": "2017-10-09T14:56:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452861",
    "user": "https://github.com/embray"
}
```

<a id='comment:14'></a>I got gc 7.6 installed correctly this time, but unfortunately it still did not resolve the problem.  The error message output during the build of this document is now slightly more helpful but not by much:

```
GC Warning: Out of memory - trying to allocate requested amount (8224 bytes)...
Insufficient memory for black list
```



---

archive/issue_comments_452862.json:
```json
{
    "body": "<a id='comment:15'></a>I think I may have run across a possible answer to this conundrum, from Hans Boehm himself: http://www.hpl.hp.com/hosted/linux/mail-archives/gc/2006-March/001214.html\n\nIndeed, it seems gc on Cygwin is using sbrk to allocate memory, and this runs into the hard-coded upper limit on the data segment of the Cygwin process (most memory allocation in Cygwin uses mmap which avoids these issues).  I'll try rebuilding gc with mmap support enabled (which it is not, by default, on Cygwin, though not for any particular reason apparently).  That should probably fix it...",
    "created_at": "2017-10-10T10:01:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452862",
    "user": "https://github.com/embray"
}
```

<a id='comment:15'></a>I think I may have run across a possible answer to this conundrum, from Hans Boehm himself: http://www.hpl.hp.com/hosted/linux/mail-archives/gc/2006-March/001214.html

Indeed, it seems gc on Cygwin is using sbrk to allocate memory, and this runs into the hard-coded upper limit on the data segment of the Cygwin process (most memory allocation in Cygwin uses mmap which avoids these issues).  I'll try rebuilding gc with mmap support enabled (which it is not, by default, on Cygwin, though not for any particular reason apparently).  That should probably fix it...



---

archive/issue_comments_452863.json:
```json
{
    "body": "Changing upstream from \"N/A\" to \"Not yet reported upstream; Will do shortly.\"",
    "created_at": "2017-10-10T15:24:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452863",
    "user": "https://github.com/embray"
}
```

Changing upstream from "N/A" to "Not yet reported upstream; Will do shortly."



---

archive/issue_comments_452864.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-10-10T15:24:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452864",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_452865.json:
```json
{
    "body": "Changing branch from \"\" to \"u/embray/cygwin/ticket-23973\"",
    "created_at": "2017-10-10T15:24:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452865",
    "user": "https://github.com/embray"
}
```

Changing branch from "" to "u/embray/cygwin/ticket-23973"



---

archive/issue_comments_452866.json:
```json
{
    "body": "Changing author from \"\" to \"Erik Bray\"",
    "created_at": "2017-10-10T15:24:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452866",
    "user": "https://github.com/embray"
}
```

Changing author from "" to "Erik Bray"



---

archive/issue_comments_452867.json:
```json
{
    "body": "Changing keywords from \"\" to \"windows cygwin ecl gc\".",
    "created_at": "2017-10-10T15:24:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452867",
    "user": "https://github.com/embray"
}
```

Changing keywords from "" to "windows cygwin ecl gc".



---

archive/issue_comments_452868.json:
```json
{
    "body": "<a id='comment:16'></a>Here's a full summary of the issue so far, and how the attached patch addresses it:\n\n* Cygwin processes reserve an address space for Cygwin's \"private heap\" for the process--most POSIX system calls that manipulate the heap (e.g. `brk`, `sbrk`) are manipulating Cygwin's heap.\n  * This private heap is of a fixed size and reserved at process startup--this allows it to be used freely without interference from Windows, which may be doing whatever it wants with the rest of the process's virtual address space.\n  * Most of the time this is not a problem--while Cygwin's `malloc` does make small allocations to the heap, larger allocations are made with `mmap` and can be anywhere in the Windows process's VM space (not within the private heap).\n  * However, a custom memory allocator (such as that used by libgc) may still run into problems here. In particular, the default configuration for libgc on Cygwin is to use `sbrk` *only* for memory allocations.  \n  * It *just happened* that running the doc build in the manner I was running it deterministically (but otherwise arbitrarily) caused ``sbrk`` to bump into the fixed size limit of the private heap (at least I think--I have not directly confirmed this but it seems likely).  This was happening to me in the context of the doc build, but in principle this error could have come up in some other context.\n  * The obvious solution is to build libgc to use `mmap` (which generally works well on Cygwin) and not rely on `sbrk`.  Another workaround would be to manually increase the max heap size on the `ecl` executable (this can be done with the `peflags` utility) but that's only sweeping the problem under the rug somewhat.\n* libgc hard-codes a lot of the defaults for various settings depending on platform, such as `USE_MMAP` for whether or not it should use `mmap` for allocations (in fact, it seems on Linux this is not the default for some reason).  The only way to force this at configure time, it seems, is to (seemingly strangely) pass `--enable-munmap` to `configure`.\n  * However, on Cygwin this does *not* enable `USE_MMAP`.  It seems like maybe it used to, but now it also sets `USE_WINALLOC`, a setting whereby gc uses the Windows API directly for managing memory allocation.\n    * This has a surprising side-effect that it *forces* `--enable-handle-fork` to be disabled, as relying on direct handling of virtual memory allocations is inherently incompatible with Cygwin's fork emulation.  However, we *need* this setting in order for ecl to work at all in a multi-process environment where it might be forked (see #22694)\n    * Therefore we need to force `USE_MMAP` as well as `USE_MUNMAP` to be defined by manually passing them in via `CFLAGS`.  Other workarounds are possible of course but this is the simplest.\n* However there's a reason `USE_MMAP` was explicitly disabled on Cygwin.\n  * libgc's memory allocator uses algorithms that require it to be able to keep ranges of memory allocated but unusuable--in particular it remaps an existing `mmap` with the `PROT_NONE` flag to do this.  This runs afoul of the same problem we had in #22810, where Cygwin does not like this.\n  * This can be fixed on Cygwin by simply using `mprotect(..., PROT_NONE)` here, instead of `mmap`.  However, this alone is not sufficient and can lead quickly to failures because:\n    * The `mprotect` call must be aligned to the start of the `mmap`'d region, which libgc calculates using its `GC_page_size` global variable, which is initialized early on.  However, it currently calculates this incorrectly on Cygwin; rather it uses it incorrectly.  Although it does get the page size right, what it really needs is a value called the allocation granularity--the alignment for the start address of mmap'd regions.  On many systems this is equal to the page size but not on 64-bit windows where the page size is 4k but the allocation granularity is 64k.  Regions allocated by Cygwin's `mmap` are aligned to the latter.  The easiest workaround here is to just use the allocation granularity for `GC_page_size`.  There's not much sense in trying to use the actual page size anywhere in this case.\n \n---\nNew commits:",
    "created_at": "2017-10-10T15:24:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452868",
    "user": "https://github.com/embray"
}
```

<a id='comment:16'></a>Here's a full summary of the issue so far, and how the attached patch addresses it:

* Cygwin processes reserve an address space for Cygwin's "private heap" for the process--most POSIX system calls that manipulate the heap (e.g. `brk`, `sbrk`) are manipulating Cygwin's heap.
  * This private heap is of a fixed size and reserved at process startup--this allows it to be used freely without interference from Windows, which may be doing whatever it wants with the rest of the process's virtual address space.
  * Most of the time this is not a problem--while Cygwin's `malloc` does make small allocations to the heap, larger allocations are made with `mmap` and can be anywhere in the Windows process's VM space (not within the private heap).
  * However, a custom memory allocator (such as that used by libgc) may still run into problems here. In particular, the default configuration for libgc on Cygwin is to use `sbrk` *only* for memory allocations.  
  * It *just happened* that running the doc build in the manner I was running it deterministically (but otherwise arbitrarily) caused ``sbrk`` to bump into the fixed size limit of the private heap (at least I think--I have not directly confirmed this but it seems likely).  This was happening to me in the context of the doc build, but in principle this error could have come up in some other context.
  * The obvious solution is to build libgc to use `mmap` (which generally works well on Cygwin) and not rely on `sbrk`.  Another workaround would be to manually increase the max heap size on the `ecl` executable (this can be done with the `peflags` utility) but that's only sweeping the problem under the rug somewhat.
* libgc hard-codes a lot of the defaults for various settings depending on platform, such as `USE_MMAP` for whether or not it should use `mmap` for allocations (in fact, it seems on Linux this is not the default for some reason).  The only way to force this at configure time, it seems, is to (seemingly strangely) pass `--enable-munmap` to `configure`.
  * However, on Cygwin this does *not* enable `USE_MMAP`.  It seems like maybe it used to, but now it also sets `USE_WINALLOC`, a setting whereby gc uses the Windows API directly for managing memory allocation.
    * This has a surprising side-effect that it *forces* `--enable-handle-fork` to be disabled, as relying on direct handling of virtual memory allocations is inherently incompatible with Cygwin's fork emulation.  However, we *need* this setting in order for ecl to work at all in a multi-process environment where it might be forked (see #22694)
    * Therefore we need to force `USE_MMAP` as well as `USE_MUNMAP` to be defined by manually passing them in via `CFLAGS`.  Other workarounds are possible of course but this is the simplest.
* However there's a reason `USE_MMAP` was explicitly disabled on Cygwin.
  * libgc's memory allocator uses algorithms that require it to be able to keep ranges of memory allocated but unusuable--in particular it remaps an existing `mmap` with the `PROT_NONE` flag to do this.  This runs afoul of the same problem we had in #22810, where Cygwin does not like this.
  * This can be fixed on Cygwin by simply using `mprotect(..., PROT_NONE)` here, instead of `mmap`.  However, this alone is not sufficient and can lead quickly to failures because:
    * The `mprotect` call must be aligned to the start of the `mmap`'d region, which libgc calculates using its `GC_page_size` global variable, which is initialized early on.  However, it currently calculates this incorrectly on Cygwin; rather it uses it incorrectly.  Although it does get the page size right, what it really needs is a value called the allocation granularity--the alignment for the start address of mmap'd regions.  On many systems this is equal to the page size but not on 64-bit windows where the page size is 4k but the allocation granularity is 64k.  Regions allocated by Cygwin's `mmap` are aligned to the latter.  The easiest workaround here is to just use the allocation granularity for `GC_page_size`.  There's not much sense in trying to use the actual page size anywhere in this case.
 
---
New commits:



---

archive/issue_comments_452869.json:
```json
{
    "body": "Changing commit from \"\" to \"188ed32783282e72f3e76393a4b049576c0dfc67\"",
    "created_at": "2017-10-10T15:24:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452869",
    "user": "https://github.com/embray"
}
```

Changing commit from "" to "188ed32783282e72f3e76393a4b049576c0dfc67"



---

archive/issue_comments_452870.json:
```json
{
    "body": "Changing upstream from \"Not yet reported upstream; Will do shortly.\" to \"Reported upstream. No feedback yet.\"",
    "created_at": "2017-10-10T15:49:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452870",
    "user": "https://github.com/embray"
}
```

Changing upstream from "Not yet reported upstream; Will do shortly." to "Reported upstream. No feedback yet."



---

archive/issue_comments_452871.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,5 @@\n For a few weeks now (I haven't been able to pursue the issue much due to travel) I've had to take the Cygwin patchbot down due to an issue that didn't occur before where building the docs, particularly with multiple processes, hangs indefinitely.\n \n For some reason, the problem appears to begin with [this commit](https://git.sagemath.org/sage.git/commit/?id=8cb8a4d58dd74922a5b66d6b20f0b3a7507ea611).  Before this commit the docs build no problem.  After this commit it will build several documents and then all the worker processes will just deadlock it seems.\n+\n+**Upstream PR:** https://github.com/ivmai/bdwgc/pull/187\n``````\n",
    "created_at": "2017-10-10T15:49:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452871",
    "user": "https://github.com/embray"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,5 @@
 For a few weeks now (I haven't been able to pursue the issue much due to travel) I've had to take the Cygwin patchbot down due to an issue that didn't occur before where building the docs, particularly with multiple processes, hangs indefinitely.
 
 For some reason, the problem appears to begin with [this commit](https://git.sagemath.org/sage.git/commit/?id=8cb8a4d58dd74922a5b66d6b20f0b3a7507ea611).  Before this commit the docs build no problem.  After this commit it will build several documents and then all the worker processes will just deadlock it seems.
+
+**Upstream PR:** https://github.com/ivmai/bdwgc/pull/187
``````




---

archive/issue_comments_452872.json:
```json
{
    "body": "<a id='comment:18'></a>Pardon my ignorance, but are you sure that `CYGWIN32` is the correct macro to check?",
    "created_at": "2017-10-11T12:29:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452872",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>Pardon my ignorance, but are you sure that `CYGWIN32` is the correct macro to check?



---

archive/issue_comments_452873.json:
```json
{
    "body": "Changing commit from \"188ed32783282e72f3e76393a4b049576c0dfc67\" to \"5863356b68e1796ea3c6d92391753a6bfbc93ca7\"",
    "created_at": "2017-10-11T13:27:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452873",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "188ed32783282e72f3e76393a4b049576c0dfc67" to "5863356b68e1796ea3c6d92391753a6bfbc93ca7"



---

archive/issue_comments_452874.json:
```json
{
    "body": "<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-10-11T13:27:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452874",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452875.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [comment:18 jdemeyer]:\n> Pardon my ignorance, but are you sure that `CYGWIN32` is the correct macro to check?\n\n\nYeah that's just the macro they use internally for \"cygwin\".  The \"32\" part is a misnomer.",
    "created_at": "2017-10-11T13:29:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452875",
    "user": "https://github.com/embray"
}
```

<a id='comment:20'></a>Replying to [comment:18 jdemeyer]:
> Pardon my ignorance, but are you sure that `CYGWIN32` is the correct macro to check?


Yeah that's just the macro they use internally for "cygwin".  The "32" part is a misnomer.



---

archive/issue_comments_452876.json:
```json
{
    "body": "<a id='comment:21'></a>Isn't `__CYGWIN__` the official macro to check for Cygwin?",
    "created_at": "2017-10-11T13:38:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452876",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>Isn't `__CYGWIN__` the official macro to check for Cygwin?



---

archive/issue_comments_452877.json:
```json
{
    "body": "<a id='comment:22'></a>It doesn't matter--have a look at the source code for gc.  It defines its own macros for platform checks.  This is only consistent with their style.",
    "created_at": "2017-10-11T14:26:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452877",
    "user": "https://github.com/embray"
}
```

<a id='comment:22'></a>It doesn't matter--have a look at the source code for gc.  It defines its own macros for platform checks.  This is only consistent with their style.



---

archive/issue_comments_452878.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Jeroen Demeyer\"",
    "created_at": "2017-10-12T07:51:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452878",
    "user": "https://github.com/jdemeyer"
}
```

Changing reviewer from "" to "Jeroen Demeyer"



---

archive/issue_comments_452879.json:
```json
{
    "body": "<a id='comment:23'></a>OK. I trust you on this one.",
    "created_at": "2017-10-12T07:51:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452879",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:23'></a>OK. I trust you on this one.



---

archive/issue_comments_452880.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-10-12T07:51:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452880",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_452881.json:
```json
{
    "body": "<a id='comment:24'></a>It would be helpful to have feedback from upstream in case there's somehow something outright wrong about this approach, but it at least resolved the problem, so...",
    "created_at": "2017-10-12T09:50:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452881",
    "user": "https://github.com/embray"
}
```

<a id='comment:24'></a>It would be helpful to have feedback from upstream in case there's somehow something outright wrong about this approach, but it at least resolved the problem, so...



---

archive/issue_comments_452882.json:
```json
{
    "body": "Changing branch from \"u/embray/cygwin/ticket-23973\" to \"5863356b68e1796ea3c6d92391753a6bfbc93ca7\"",
    "created_at": "2017-10-16T22:45:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452882",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/embray/cygwin/ticket-23973" to "5863356b68e1796ea3c6d92391753a6bfbc93ca7"



---

archive/issue_comments_452883.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-10-16T22:45:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452883",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_060985.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-10-16T22:45:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23973#event-60985"
}
```



---

archive/issue_comments_452884.json:
```json
{
    "body": "Changing upstream from \"Reported upstream. No feedback yet.\" to \"Fixed upstream, but not in a stable release.\"",
    "created_at": "2017-10-18T17:15:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452884",
    "user": "https://github.com/embray"
}
```

Changing upstream from "Reported upstream. No feedback yet." to "Fixed upstream, but not in a stable release."



---

archive/issue_comments_452885.json:
```json
{
    "body": "Changing commit from \"5863356b68e1796ea3c6d92391753a6bfbc93ca7\" to \"\"",
    "created_at": "2017-10-18T17:15:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23973#issuecomment-452885",
    "user": "https://github.com/embray"
}
```

Changing commit from "5863356b68e1796ea3c6d92391753a6bfbc93ca7" to ""
