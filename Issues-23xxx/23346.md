# Issue 23346: Doing some maintanence on LieAlgebraElement

archive/issues_023109.json:
```json
{
    "assignees": [],
    "body": "We can now `cdef` the class `LieAlgebraElement` since #22632 is merged. This also does some other fixes to `__mul__` to better handle `int` input and to `lift` to handle when the UEA has a different indexing set or is the PBW basis.\n\nDepends on #23404\n\nCC:  @sagetrac-sage-combinat @bsalisbury1\n\nBranch/Commit: **[65f1584](https://github.com/sagemath/sagetrac-mirror/commit/65f1584624f7c8a8f59e3ebf72913819c202ed9a)**\n\nReviewer: **Fr\u00e9d\u00e9ric Chapoton, Jeroen Demeyer**\n\nAuthor: **Travis Scrimshaw**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/23346_\n\n",
    "closed_at": "2017-08-26T09:58:04Z",
    "created_at": "2017-07-01T00:11:40Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20algebra",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.0",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Doing some maintanence on LieAlgebraElement",
    "type": "issue",
    "updated_at": "2017-08-26T09:58:04Z",
    "url": "https://github.com/sagemath/sage/issues/23346",
    "user": "https://github.com/tscrim"
}
```
We can now `cdef` the class `LieAlgebraElement` since #22632 is merged. This also does some other fixes to `__mul__` to better handle `int` input and to `lift` to handle when the UEA has a different indexing set or is the PBW basis.

Depends on #23404

CC:  @sagetrac-sage-combinat @bsalisbury1

Branch/Commit: **[65f1584](https://github.com/sagemath/sagetrac-mirror/commit/65f1584624f7c8a8f59e3ebf72913819c202ed9a)**

Reviewer: **Frédéric Chapoton, Jeroen Demeyer**

Author: **Travis Scrimshaw**

_Issue created by migration from https://trac.sagemath.org/ticket/23346_





---

archive/issue_events_307073.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2017-07-01T00:11:40Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "milestone_number": null,
    "milestone_title": "sage-8.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23346#event-307073"
}
```



---

archive/issue_events_307074.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2017-07-01T00:11:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20algebra",
    "label_color": "0000ff",
    "label_name": "component: algebra",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23346#event-307074"
}
```



---

archive/issue_events_307075.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2017-07-01T00:11:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23346#event-307075"
}
```



---

archive/issue_events_307076.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2017-07-01T00:11:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23346#event-307076"
}
```



---

archive/issue_comments_353219.json:
```json
{
    "body": "Commit: **[6516b95](https://github.com/sagemath/sagetrac-mirror/commit/6516b95bac6fc08affa0d5b87fd93fec9708d47d)**",
    "created_at": "2017-07-01T00:12:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353219",
    "user": "https://github.com/tscrim"
}
```

Commit: **[6516b95](https://github.com/sagemath/sagetrac-mirror/commit/6516b95bac6fc08affa0d5b87fd93fec9708d47d)**



---

archive/issue_comments_353220.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">Comment 1</div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6516b95bac6fc08affa0d5b87fd93fec9708d47d\">6516b95</a></td><td><code>cdef-ing LieAlgebraElement and fixes to `__mul__` and lift.</code></td></tr></table>\n",
    "created_at": "2017-07-01T00:12:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353220",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:1" align="right">Comment 1</div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6516b95bac6fc08affa0d5b87fd93fec9708d47d">6516b95</a></td><td><code>cdef-ing LieAlgebraElement and fixes to `__mul__` and lift.</code></td></tr></table>




---

archive/issue_comments_353221.json:
```json
{
    "body": "Branch: **[public/lie_algebras/cythonize_element-23346](https://github.com/sagemath/sagetrac-mirror/tree/public/lie_algebras/cythonize_element-23346)**",
    "created_at": "2017-07-01T00:12:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353221",
    "user": "https://github.com/tscrim"
}
```

Branch: **[public/lie_algebras/cythonize_element-23346](https://github.com/sagemath/sagetrac-mirror/tree/public/lie_algebras/cythonize_element-23346)**



---

archive/issue_events_307077.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2017-07-01T00:12:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23346#event-307077"
}
```



---

archive/issue_comments_353222.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">Comment 2</div>\n\nJust commenting on the Cython code in `lie_algebra_element.pyx`:\n\n1. You are cimporting various things that you don't actually use. I assume that this was for some earlier failed experiment?\n\n2. Is there any reason that `self` should have a `lift()` method? Remember that arithmetic in Cython is different from Python: you cannot assume that `self` is an instance of the class. For that reason, I would also avoid the name `self`: the signature would better be written as `def __mul__(left, right)`.\n\n3. Why did you change `self.lift() * y` to `coercion_model.bin_op(self.lift(), y, mul)`? There is normally no reason to explicitly invoke the coercion model like this.",
    "created_at": "2017-07-04T12:58:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353222",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:2" align="right">Comment 2</div>

Just commenting on the Cython code in `lie_algebra_element.pyx`:

1. You are cimporting various things that you don't actually use. I assume that this was for some earlier failed experiment?

2. Is there any reason that `self` should have a `lift()` method? Remember that arithmetic in Cython is different from Python: you cannot assume that `self` is an instance of the class. For that reason, I would also avoid the name `self`: the signature would better be written as `def __mul__(left, right)`.

3. Why did you change `self.lift() * y` to `coercion_model.bin_op(self.lift(), y, mul)`? There is normally no reason to explicitly invoke the coercion model like this.



---

archive/issue_events_307078.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-07-04T12:58:48Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23346#event-307078"
}
```



---

archive/issue_events_307079.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-07-04T12:58:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23346#event-307079"
}
```



---

archive/issue_comments_353223.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">Comment 3</div>\n\nReplying to [@jdemeyer](#comment%3A2):\n> Just commenting on the Cython code in `lie_algebra_element.pyx`:\n> \n> 1. You are cimporting various things that you don't actually use. I assume that this was for some earlier failed experiment?\n\nYes, that's right. Those should be removed.\n\n> 2. Is there any reason that `self` should have a `lift()` method? Remember that arithmetic in Cython is different from Python: you cannot assume that `self` is an instance of the class. For that reason, I would also avoid the name `self`: the signature would better be written as `def __mul__(left, right)`.\n\n>\n>   3. Why did you change `self.lift() * y` to `coercion_model.bin_op(self.lift(), y, mul)`? There is normally no reason to explicitly invoke the coercion model like this.\n\nWhat I am trying to do is implement `x * y` such that if `x` is a Lie algebra element and `y` is not in is base ring (or with the role of `x` and `y` swapped), then it lifts `x` up to a bigger algebra (the universal enveloping algebra) where `*` is defined (associatively). So really this should be a coercion map where it converts `x` and `y` to a common parent as there is not an action of `y` on `x` (or vice versa).\n\nHowever, I don't know how to do this in the current system as the bigger algebra may not have been constructed yet (but is available through `L.universal_enveloping_algebra`). I would be happy enough if `x` and `y` were both elements of `L` (i.e., using `_mul_`) and then call `lift()` on both elements and multiply, but the coercion framework needs the result to be in `L`. So what I am trying to do is essentially emulate the coercion framework to get around this.\n\nDoing things this way is what got it to do what I wanted it to do without breaking anything. However, I am sure there is a better way to do this. Suggestions welcomed.\n\nMaybe an analogy in a less specialized area of math would be when you do `x + y` with two (multiplicative) group elements, then it would automatically coerce into the corresponding group algebras. (I'm not saying this is a feature we want, but merely would be the same concept).",
    "created_at": "2017-07-04T13:51:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353223",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:3" align="right">Comment 3</div>

Replying to [@jdemeyer](#comment%3A2):
> Just commenting on the Cython code in `lie_algebra_element.pyx`:
> 
> 1. You are cimporting various things that you don't actually use. I assume that this was for some earlier failed experiment?

Yes, that's right. Those should be removed.

> 2. Is there any reason that `self` should have a `lift()` method? Remember that arithmetic in Cython is different from Python: you cannot assume that `self` is an instance of the class. For that reason, I would also avoid the name `self`: the signature would better be written as `def __mul__(left, right)`.

>
>   3. Why did you change `self.lift() * y` to `coercion_model.bin_op(self.lift(), y, mul)`? There is normally no reason to explicitly invoke the coercion model like this.

What I am trying to do is implement `x * y` such that if `x` is a Lie algebra element and `y` is not in is base ring (or with the role of `x` and `y` swapped), then it lifts `x` up to a bigger algebra (the universal enveloping algebra) where `*` is defined (associatively). So really this should be a coercion map where it converts `x` and `y` to a common parent as there is not an action of `y` on `x` (or vice versa).

However, I don't know how to do this in the current system as the bigger algebra may not have been constructed yet (but is available through `L.universal_enveloping_algebra`). I would be happy enough if `x` and `y` were both elements of `L` (i.e., using `_mul_`) and then call `lift()` on both elements and multiply, but the coercion framework needs the result to be in `L`. So what I am trying to do is essentially emulate the coercion framework to get around this.

Doing things this way is what got it to do what I wanted it to do without breaking anything. However, I am sure there is a better way to do this. Suggestions welcomed.

Maybe an analogy in a less specialized area of math would be when you do `x + y` with two (multiplicative) group elements, then it would automatically coerce into the corresponding group algebras. (I'm not saying this is a feature we want, but merely would be the same concept).



---

archive/issue_comments_353224.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">Comment 4</div>\n\nReplying to [@tscrim](#comment%3A3):\n> Maybe an analogy in a less specialized area of math would be when you do `x + y` with two (multiplicative) group elements\n\nContinuing your analogy, it seems that your input is really one group element and one other object which could be anything. Since it really could be anything, you shouldn't force the Sage coercion model on it.\n\nWhat's wrong with something like\n\n```\ndef __mul__(left, right):\n    # ...\n    # handle base ring stuff first\n    # ...\n    if isinstance(left, LieAlgebraElement):\n        left = left.lift()   # Or (<LieAlgebraElement>left).lift() if lift is cpdef\n    if isinstance(right, LieAlgebraElement):\n        right = right.lift()\n    return left * right\n```",
    "created_at": "2017-07-04T14:04:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353224",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:4" align="right">Comment 4</div>

Replying to [@tscrim](#comment%3A3):
> Maybe an analogy in a less specialized area of math would be when you do `x + y` with two (multiplicative) group elements

Continuing your analogy, it seems that your input is really one group element and one other object which could be anything. Since it really could be anything, you shouldn't force the Sage coercion model on it.

What's wrong with something like

```
def __mul__(left, right):
    # ...
    # handle base ring stuff first
    # ...
    if isinstance(left, LieAlgebraElement):
        left = left.lift()   # Or (<LieAlgebraElement>left).lift() if lift is cpdef
    if isinstance(right, LieAlgebraElement):
        right = right.lift()
    return left * right
```



---

archive/issue_comments_353225.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">Comment 5</div>\n\nReplying to [@jdemeyer](#comment%3A4):\n> Replying to [@tscrim](#comment%3A3):\n> > Maybe an analogy in a less specialized area of math would be when you do `x + y` with two (multiplicative) group elements\n\n> \n> Continuing your analogy, it seems that your input is really one group element and one other object which could be anything. Since it really could be anything, you shouldn't force the Sage coercion model on it.\n\nTrue, well, I want to assume that the other one is something coercible into a group element. So I need to invoke the coercion model at some point. Although I guess I can let the coercion model do its thing via `+` once I lift up the group element.\n\n> What's wrong with something like\n> \n> ```\n> def __mul__(left, right):\n>     # ...\n>     # handle base ring stuff first\n>     # ...\n>     if isinstance(left, LieAlgebraElement):\n>         left = left.lift()   # Or (<LieAlgebraElement>left).lift() if lift is cpdef\n>     if isinstance(right, LieAlgebraElement):\n>         right = right.lift()\n>     return left * right\n> ```\n\nI think that should work. At least I don't see anything wrong with that at this point. I will test.",
    "created_at": "2017-07-04T14:20:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353225",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:5" align="right">Comment 5</div>

Replying to [@jdemeyer](#comment%3A4):
> Replying to [@tscrim](#comment%3A3):
> > Maybe an analogy in a less specialized area of math would be when you do `x + y` with two (multiplicative) group elements

> 
> Continuing your analogy, it seems that your input is really one group element and one other object which could be anything. Since it really could be anything, you shouldn't force the Sage coercion model on it.

True, well, I want to assume that the other one is something coercible into a group element. So I need to invoke the coercion model at some point. Although I guess I can let the coercion model do its thing via `+` once I lift up the group element.

> What's wrong with something like
> 
> ```
> def __mul__(left, right):
>     # ...
>     # handle base ring stuff first
>     # ...
>     if isinstance(left, LieAlgebraElement):
>         left = left.lift()   # Or (<LieAlgebraElement>left).lift() if lift is cpdef
>     if isinstance(right, LieAlgebraElement):
>         right = right.lift()
>     return left * right
> ```

I think that should work. At least I don't see anything wrong with that at this point. I will test.



---

archive/issue_comments_353226.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">Comment 6</div>\n\nReplying to [@tscrim](#comment%3A5):\n> Although I guess I can let the coercion model do its thing via `+` once I lift up the group element.\n\nYes, that is what I meant. There is usually no reason to call the coercion model directly.",
    "created_at": "2017-07-04T14:35:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353226",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:6" align="right">Comment 6</div>

Replying to [@tscrim](#comment%3A5):
> Although I guess I can let the coercion model do its thing via `+` once I lift up the group element.

Yes, that is what I meant. There is usually no reason to call the coercion model directly.



---

archive/issue_comments_353227.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">Comment 7</div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f6559b7fe8259033e1da8a43a672b16c354e0aef\">f6559b7</a></td><td><code>Merge branch 'public/lie_algebras/cythonize_element-23346' of git://trac.sagemath.org/sage into public/lie_algebras/cythonize_element-23346</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f7db76c7b958765a99534edb44ac2a872c560690\">f7db76c</a></td><td><code>Fixing things with `__mul__` and some other things from that.</code></td></tr></table>\n",
    "created_at": "2017-07-04T15:39:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353227",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:7" align="right">Comment 7</div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f6559b7fe8259033e1da8a43a672b16c354e0aef">f6559b7</a></td><td><code>Merge branch 'public/lie_algebras/cythonize_element-23346' of git://trac.sagemath.org/sage into public/lie_algebras/cythonize_element-23346</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f7db76c7b958765a99534edb44ac2a872c560690">f7db76c</a></td><td><code>Fixing things with `__mul__` and some other things from that.</code></td></tr></table>




---

archive/issue_comments_353228.json:
```json
{
    "body": "Changed commit from **[6516b95](https://github.com/sagemath/sagetrac-mirror/commit/6516b95bac6fc08affa0d5b87fd93fec9708d47d)** to **[f7db76c](https://github.com/sagemath/sagetrac-mirror/commit/f7db76c7b958765a99534edb44ac2a872c560690)**",
    "created_at": "2017-07-04T15:39:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353228",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[6516b95](https://github.com/sagemath/sagetrac-mirror/commit/6516b95bac6fc08affa0d5b87fd93fec9708d47d)** to **[f7db76c](https://github.com/sagemath/sagetrac-mirror/commit/f7db76c7b958765a99534edb44ac2a872c560690)**



---

archive/issue_comments_353229.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">Comment 8</div>\n\nOkay, I've converted it to use the way suggested in [comment:5](#comment%3A5). This also uncovered some other small issues with how lifting to the UEA is done in the `LieAlgebraFromAssociative`, which prompted the generic enough `lift` method in `LieAlgebrasWithBasis`. However, I did implement Cython `cpdef lift` versions because these might end up being used in my upcoming Verma module code. I also did some other tidying up I saw along the way.",
    "created_at": "2017-07-04T15:43:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353229",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:8" align="right">Comment 8</div>

Okay, I've converted it to use the way suggested in [comment:5](#comment%3A5). This also uncovered some other small issues with how lifting to the UEA is done in the `LieAlgebraFromAssociative`, which prompted the generic enough `lift` method in `LieAlgebrasWithBasis`. However, I did implement Cython `cpdef lift` versions because these might end up being used in my upcoming Verma module code. I also did some other tidying up I saw along the way.



---

archive/issue_events_307080.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2017-07-04T15:43:37Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23346#event-307080"
}
```



---

archive/issue_events_307081.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2017-07-04T15:43:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23346#event-307081"
}
```



---

archive/issue_comments_353230.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">Comment 10</div>\n\nTypo: <code>We are going to lift \\`\\`self\\`\\` the the UEA</code>",
    "created_at": "2017-07-05T12:59:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353230",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:10" align="right">Comment 10</div>

Typo: <code>We are going to lift \`\`self\`\` the the UEA</code>



---

archive/issue_comments_353231.json:
```json
{
    "body": "Changed commit from **[f7db76c](https://github.com/sagemath/sagetrac-mirror/commit/f7db76c7b958765a99534edb44ac2a872c560690)** to **[e62f646](https://github.com/sagemath/sagetrac-mirror/commit/e62f6461a60944353f43734a66c682aacd18b96d)**",
    "created_at": "2017-07-05T13:01:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353231",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[f7db76c](https://github.com/sagemath/sagetrac-mirror/commit/f7db76c7b958765a99534edb44ac2a872c560690)** to **[e62f646](https://github.com/sagemath/sagetrac-mirror/commit/e62f6461a60944353f43734a66c682aacd18b96d)**



---

archive/issue_comments_353232.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">Comment 11</div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e62f6461a60944353f43734a66c682aacd18b96d\">e62f646</a></td><td><code>Fixing typo.</code></td></tr></table>\n",
    "created_at": "2017-07-05T13:01:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353232",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:11" align="right">Comment 11</div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e62f6461a60944353f43734a66c682aacd18b96d">e62f646</a></td><td><code>Fixing typo.</code></td></tr></table>




---

archive/issue_comments_353233.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">Comment 12</div>\n\nFixed.",
    "created_at": "2017-07-05T13:01:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353233",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:12" align="right">Comment 12</div>

Fixed.



---

archive/issue_events_307082.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-07-05T13:05:34Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23346#event-307082"
}
```



---

archive/issue_events_307083.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-07-05T13:05:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23346#event-307083"
}
```



---

archive/issue_comments_353234.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">Comment 13</div>\n\n1. Obvious mathematical question: is this multiplication always commutative? Because your code seems to assume that it is.\n\n2. I guess this can be dropped: `from operator import mul`\n\n3. Do you really need return `iter(D.iteritems())`? Is `D.iteritems()` not sufficient?\n\n4. This is considered bad style in PEP 8: `names_map = lambda x: x`. Write this as `def names_map(x): return x` (on 1 or 2 lines as you wish). Same for `get_var`.",
    "created_at": "2017-07-05T13:05:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353234",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:13" align="right">Comment 13</div>

1. Obvious mathematical question: is this multiplication always commutative? Because your code seems to assume that it is.

2. I guess this can be dropped: `from operator import mul`

3. Do you really need return `iter(D.iteritems())`? Is `D.iteritems()` not sufficient?

4. This is considered bad style in PEP 8: `names_map = lambda x: x`. Write this as `def names_map(x): return x` (on 1 or 2 lines as you wish). Same for `get_var`.



---

archive/issue_comments_353235.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">Comment 14</div>\n\nReplying to [@jdemeyer](#comment%3A13):\n> 1. Obvious mathematical question: is this multiplication always commutative? Because your code seems to assume that it is.\n\nIt is not...ugg...right...I will have to think a little more about how to fix this with making a super call. Simply doing `IndexedFreeModuleElement.__mul__(left, right)` didn't work for me when `left` is, e.g., an `int`.\n\n> 2. I guess this can be dropped: `from operator import mul`\n\nTrue.\n\n> 3. Do you really need return `iter(D.iteritems())`? Is `D.iteritems()` not sufficient?\n\nNo, I do not need that. Fixed.\n\n> 4. This is considered bad style in PEP 8: `names_map = lambda x: x`. Write this as `def names_map(x): return x` (on 1 or 2 lines as you wish). Same for `get_var`.\n\nFixed.\n\nI will push my changes once I figure out the best way to handle 1.",
    "created_at": "2017-07-06T00:18:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353235",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:14" align="right">Comment 14</div>

Replying to [@jdemeyer](#comment%3A13):
> 1. Obvious mathematical question: is this multiplication always commutative? Because your code seems to assume that it is.

It is not...ugg...right...I will have to think a little more about how to fix this with making a super call. Simply doing `IndexedFreeModuleElement.__mul__(left, right)` didn't work for me when `left` is, e.g., an `int`.

> 2. I guess this can be dropped: `from operator import mul`

True.

> 3. Do you really need return `iter(D.iteritems())`? Is `D.iteritems()` not sufficient?

No, I do not need that. Fixed.

> 4. This is considered bad style in PEP 8: `names_map = lambda x: x`. Write this as `def names_map(x): return x` (on 1 or 2 lines as you wish). Same for `get_var`.

Fixed.

I will push my changes once I figure out the best way to handle 1.



---

archive/issue_comments_353236.json:
```json
{
    "body": "Changed commit from **[e62f646](https://github.com/sagemath/sagetrac-mirror/commit/e62f6461a60944353f43734a66c682aacd18b96d)** to **[db49d8f](https://github.com/sagemath/sagetrac-mirror/commit/db49d8fee18b35d177e6407314421cc3fa75cbe1)**",
    "created_at": "2017-07-06T01:52:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353236",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[e62f646](https://github.com/sagemath/sagetrac-mirror/commit/e62f6461a60944353f43734a66c682aacd18b96d)** to **[db49d8f](https://github.com/sagemath/sagetrac-mirror/commit/db49d8fee18b35d177e6407314421cc3fa75cbe1)**



---

archive/issue_comments_353237.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">Comment 15</div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/db49d8fee18b35d177e6407314421cc3fa75cbe1\">db49d8f</a></td><td><code>More fixing of `__mul__` for Lie algebra elements.</code></td></tr></table>\n",
    "created_at": "2017-07-06T01:52:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353237",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:15" align="right">Comment 15</div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/db49d8fee18b35d177e6407314421cc3fa75cbe1">db49d8f</a></td><td><code>More fixing of `__mul__` for Lie algebra elements.</code></td></tr></table>




---

archive/issue_events_307084.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2017-07-06T01:56:41Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23346#event-307084"
}
```



---

archive/issue_events_307085.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2017-07-06T01:56:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23346#event-307085"
}
```



---

archive/issue_comments_353238.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">Comment 16</div>\n\nOkay, here is the new fix. I ended up copying most of the logic from `Element.__mul__`, but I need to make sure it attempts to go through the usual coercion framework first in order to test for things like the Lie algebra element acting on something else. However, I don't mind how the code turned out; it ended up being more straightforward than I was originally thinking.",
    "created_at": "2017-07-06T01:56:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353238",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:16" align="right">Comment 16</div>

Okay, here is the new fix. I ended up copying most of the logic from `Element.__mul__`, but I need to make sure it attempts to go through the usual coercion framework first in order to test for things like the Lie algebra element acting on something else. However, I don't mind how the code turned out; it ended up being more straightforward than I was originally thinking.



---

archive/issue_comments_353239.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">Comment 17</div>\n\nReplying to [@tscrim](#comment%3A14):\n> It is not...ugg...right...I will have to think a little more about how to fix this with making a super call. Simply doing `IndexedFreeModuleElement.__mul__(left, right)` didn't work for me when `left` is, e.g., an `int`.\n\nDid you try calling the `__rmul__` method, like `IndexedFreeModuleElement.__rmul__(right, left)`?",
    "created_at": "2017-07-06T09:05:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353239",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:17" align="right">Comment 17</div>

Replying to [@tscrim](#comment%3A14):
> It is not...ugg...right...I will have to think a little more about how to fix this with making a super call. Simply doing `IndexedFreeModuleElement.__mul__(left, right)` didn't work for me when `left` is, e.g., an `int`.

Did you try calling the `__rmul__` method, like `IndexedFreeModuleElement.__rmul__(right, left)`?



---

archive/issue_comments_353240.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">Comment 18</div>\n\nReplying to [@jdemeyer](#comment%3A17):\n> Replying to [@tscrim](#comment%3A14):\n> > It is not...ugg...right...I will have to think a little more about how to fix this with making a super call. Simply doing `IndexedFreeModuleElement.__mul__(left, right)` didn't work for me when `left` is, e.g., an `int`.\n\n> \n> Did you try calling the `__rmul__` method, like `IndexedFreeModuleElement.__rmul__(right, left)`?\n\nNo, I didn't. I believe we would have to do type checking first in order to do that. Super calls (including `Foo.__bar__(x, y)`) for special methods in Cython seem to be a little fragile.",
    "created_at": "2017-07-07T00:01:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353240",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:18" align="right">Comment 18</div>

Replying to [@jdemeyer](#comment%3A17):
> Replying to [@tscrim](#comment%3A14):
> > It is not...ugg...right...I will have to think a little more about how to fix this with making a super call. Simply doing `IndexedFreeModuleElement.__mul__(left, right)` didn't work for me when `left` is, e.g., an `int`.

> 
> Did you try calling the `__rmul__` method, like `IndexedFreeModuleElement.__rmul__(right, left)`?

No, I didn't. I believe we would have to do type checking first in order to do that. Super calls (including `Foo.__bar__(x, y)`) for special methods in Cython seem to be a little fragile.



---

archive/issue_comments_353241.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">Comment 19</div>\n\nIt seems to me like copying a large part of the element `__mul__` just to avoid one or two `super()` calls is a bit overkill.\n\nI have no idea why you think that `super()` wouldn't work with slot wrappers (I guess that's technically what you mean with \"special methods in Cython\"). I think that `super()` simply works on the level of attributes. I don't see why it would matter if the attribute is a Python method or a slot wrapper.",
    "created_at": "2017-07-07T08:43:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353241",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:19" align="right">Comment 19</div>

It seems to me like copying a large part of the element `__mul__` just to avoid one or two `super()` calls is a bit overkill.

I have no idea why you think that `super()` wouldn't work with slot wrappers (I guess that's technically what you mean with "special methods in Cython"). I think that `super()` simply works on the level of attributes. I don't see why it would matter if the attribute is a Python method or a slot wrapper.



---

archive/issue_comments_353242.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">Comment 20</div>\n\nI'm not doing it because I want to (although we do get a faster hook when both are elements of the same Lie algebra and directly treating the `int` as a scalar). If I do something like\n\n```\nreturn Element.__mul__(left, right)\n```\nto handle the base ring input, then I get\n\n```\nsage: x = L.an_element()\nsage: int(3) * x\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n...\nTypeError: descriptor '__mul__' requires a 'sage.structure.element.Element' object but received a 'int'\n```\nI agree that it does work properly when you can promise that `left` is a subclass of `Element`.\n\nNow, I can catch that error and then proceed in the reversed order, but that creates some messy code. Well, at least I don't see a clean way to do it to separate out the `TypeError` from the bad object type vs the one from not being able to actually do the multiplication. Even still, it would mean doing some logic to keep track of which one is what type.",
    "created_at": "2017-07-07T13:52:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353242",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:20" align="right">Comment 20</div>

I'm not doing it because I want to (although we do get a faster hook when both are elements of the same Lie algebra and directly treating the `int` as a scalar). If I do something like

```
return Element.__mul__(left, right)
```
to handle the base ring input, then I get

```
sage: x = L.an_element()
sage: int(3) * x
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
...
TypeError: descriptor '__mul__' requires a 'sage.structure.element.Element' object but received a 'int'
```
I agree that it does work properly when you can promise that `left` is a subclass of `Element`.

Now, I can catch that error and then proceed in the reversed order, but that creates some messy code. Well, at least I don't see a clean way to do it to separate out the `TypeError` from the bad object type vs the one from not being able to actually do the multiplication. Even still, it would mean doing some logic to keep track of which one is what type.



---

archive/issue_comments_353243.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">Comment 21</div>\n\nReplying to [@tscrim](#comment%3A20):\n> Now, I can catch that error and then proceed in the reversed order, but that creates some messy code.\n\nIn this case, LBYL is better than EAFP. You are doing `isinstance()` checks anyway, so you really already know whether to use `__mul__` or `__rmul__`.\n\nFor example, the old code\n\n```\n        if isinstance(left, LieAlgebraElement):\n            self = <LieAlgebraElement> left\n            y = right\n        else:\n            self = <LieAlgebraElement> right\n            y = left\n        try:\n            return super(LieAlgebraElement, self).__mul__(y)\n        except TypeError:\n            pass\n```\ncould be rewritten as\n\n```\n        try:\n            if isinstance(left, LieAlgebraElement):\n                return super(LieAlgebraElement, left).__mul__(right)\n            else:\n                return super(LieAlgebraElement, right).__rmul__(left)\n        except TypeError:\n            pass\n```",
    "created_at": "2017-07-07T14:01:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353243",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:21" align="right">Comment 21</div>

Replying to [@tscrim](#comment%3A20):
> Now, I can catch that error and then proceed in the reversed order, but that creates some messy code.

In this case, LBYL is better than EAFP. You are doing `isinstance()` checks anyway, so you really already know whether to use `__mul__` or `__rmul__`.

For example, the old code

```
        if isinstance(left, LieAlgebraElement):
            self = <LieAlgebraElement> left
            y = right
        else:
            self = <LieAlgebraElement> right
            y = left
        try:
            return super(LieAlgebraElement, self).__mul__(y)
        except TypeError:
            pass
```
could be rewritten as

```
        try:
            if isinstance(left, LieAlgebraElement):
                return super(LieAlgebraElement, left).__mul__(right)
            else:
                return super(LieAlgebraElement, right).__rmul__(left)
        except TypeError:
            pass
```



---

archive/issue_comments_353244.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">Comment 22</div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c13da59d442c5841e4a1a41dfb78fed6e79254f1\">c13da59</a></td><td><code>Fixing copy/paste mistake.</code></td></tr></table>\n",
    "created_at": "2017-07-07T14:12:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353244",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:22" align="right">Comment 22</div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c13da59d442c5841e4a1a41dfb78fed6e79254f1">c13da59</a></td><td><code>Fixing copy/paste mistake.</code></td></tr></table>




---

archive/issue_comments_353245.json:
```json
{
    "body": "Changed commit from **[db49d8f](https://github.com/sagemath/sagetrac-mirror/commit/db49d8fee18b35d177e6407314421cc3fa75cbe1)** to **[c13da59](https://github.com/sagemath/sagetrac-mirror/commit/c13da59d442c5841e4a1a41dfb78fed6e79254f1)**",
    "created_at": "2017-07-07T14:12:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353245",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[db49d8f](https://github.com/sagemath/sagetrac-mirror/commit/db49d8fee18b35d177e6407314421cc3fa75cbe1)** to **[c13da59](https://github.com/sagemath/sagetrac-mirror/commit/c13da59d442c5841e4a1a41dfb78fed6e79254f1)**



---

archive/issue_comments_353246.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">Comment 23</div>\n\nWith the current implementation, I only need to do that when one of them is not an element and can assume it is a scalar. (Although I noticed some bad copy/pasting: `left = (<LieAlgebraElement> right).lift()` :P). Moreover, it saves a few `isinstance` checks; granted, this is far from the bottleneck point in practical code. I also think the logic is easier to follow this way, but yes, there is a technical debt from doing a bit of near duplication.\n\nReally, I think Cython should let `Element.__mul__(left, right)` work since it makes no assumptions on the type of `Foo.__mul__(left, right)`. I would almost consider this to be a bug in Cython because of that.",
    "created_at": "2017-07-07T14:19:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353246",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:23" align="right">Comment 23</div>

With the current implementation, I only need to do that when one of them is not an element and can assume it is a scalar. (Although I noticed some bad copy/pasting: `left = (<LieAlgebraElement> right).lift()` :P). Moreover, it saves a few `isinstance` checks; granted, this is far from the bottleneck point in practical code. I also think the logic is easier to follow this way, but yes, there is a technical debt from doing a bit of near duplication.

Really, I think Cython should let `Element.__mul__(left, right)` work since it makes no assumptions on the type of `Foo.__mul__(left, right)`. I would almost consider this to be a bug in Cython because of that.



---

archive/issue_comments_353247.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">Comment 24</div>\n\nReplying to [@tscrim](#comment%3A23):\n> Really, I think Cython should let `Element.__mul__(left, right)` work\n\nIt's not a Cython issue but a Python issue. I understand the confusion because\n\n```\ncdef class Element:\n    def __mul__(left, right):\n        ...\n```\nlooks like it is providing `Element.__mul__` but that isn't actually the case. In Cython, the syntax `def __mul__(left, right)` is used to define the `nb_multiply` function in the `PyTypeObject` structure. Python (not Cython) then adds `__mul__` and `__rmul__` attributes which call the `nb_multiply` function implementated by Cython.\n\nMaybe it's easier to understand with `__richcmp__` on the one hand and `__eq__`, `__lt__`, ... on the other hand. `__richcmp__` is just Cython syntax, there is no actual method called `__richcmp__`. But Python does generate `__eq__`, ... methods from this.\n\nThinking about it, you *could* actually call `nb_multiply` directly from Cython. But that would not qualify as a clean solution.",
    "created_at": "2017-07-07T14:55:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353247",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:24" align="right">Comment 24</div>

Replying to [@tscrim](#comment%3A23):
> Really, I think Cython should let `Element.__mul__(left, right)` work

It's not a Cython issue but a Python issue. I understand the confusion because

```
cdef class Element:
    def __mul__(left, right):
        ...
```
looks like it is providing `Element.__mul__` but that isn't actually the case. In Cython, the syntax `def __mul__(left, right)` is used to define the `nb_multiply` function in the `PyTypeObject` structure. Python (not Cython) then adds `__mul__` and `__rmul__` attributes which call the `nb_multiply` function implementated by Cython.

Maybe it's easier to understand with `__richcmp__` on the one hand and `__eq__`, `__lt__`, ... on the other hand. `__richcmp__` is just Cython syntax, there is no actual method called `__richcmp__`. But Python does generate `__eq__`, ... methods from this.

Thinking about it, you *could* actually call `nb_multiply` directly from Cython. But that would not qualify as a clean solution.



---

archive/issue_comments_353248.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">Comment 25</div>\n\nThinking more about it: I think I know how to make the call `Element.__mul__(left, right)` work. I could write a function `wrapperdescr_call_nocheck()` which overrides some checks that Python does. Then `Element.__mul__(left, right)` would become\n\n```\nwrapperdescr_call_nocheck(Element.__mul__, left, right)\n```\nwhich would skip the check of the `self` argument.\n\nWould that make you happy or do you think it's a bad idea?",
    "created_at": "2017-07-07T15:08:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353248",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:25" align="right">Comment 25</div>

Thinking more about it: I think I know how to make the call `Element.__mul__(left, right)` work. I could write a function `wrapperdescr_call_nocheck()` which overrides some checks that Python does. Then `Element.__mul__(left, right)` would become

```
wrapperdescr_call_nocheck(Element.__mul__, left, right)
```
which would skip the check of the `self` argument.

Would that make you happy or do you think it's a bad idea?



---

archive/issue_comments_353249.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">Comment 26</div>\n\nJust to be certain, the error is coming from Python with the wrapper `Element.__mul__(left, right)`, but when `def __mul__(left, right):` in `Foo` is called, it is actually just calling the underlying `nb_multiply`. So by instead calling `nb_multiply`, it would avoid the Python checks and start the `Element.__mul__` code. Is that correct?\n\nAm also I correct in that `wrapperdescr_call_nocheck()` is just a more general-purpose function instead of calling `nb_multiply` (or other similar functions) directly in the Cython code? Since this is likely a more special case, I would say for now we can just call directly `nb_multiply` with some comments about it is done to avoid Python type checks. However, I would be happy with such a function if you think it is better to not call `nb_multiply`. If you're okay with directly calling `nb_multiply`, what is the syntax I should use and what do I need to do to import it?",
    "created_at": "2017-07-07T15:37:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353249",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:26" align="right">Comment 26</div>

Just to be certain, the error is coming from Python with the wrapper `Element.__mul__(left, right)`, but when `def __mul__(left, right):` in `Foo` is called, it is actually just calling the underlying `nb_multiply`. So by instead calling `nb_multiply`, it would avoid the Python checks and start the `Element.__mul__` code. Is that correct?

Am also I correct in that `wrapperdescr_call_nocheck()` is just a more general-purpose function instead of calling `nb_multiply` (or other similar functions) directly in the Cython code? Since this is likely a more special case, I would say for now we can just call directly `nb_multiply` with some comments about it is done to avoid Python type checks. However, I would be happy with such a function if you think it is better to not call `nb_multiply`. If you're okay with directly calling `nb_multiply`, what is the syntax I should use and what do I need to do to import it?



---

archive/issue_comments_353250.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">Comment 27</div>\n\nReplying to [@tscrim](#comment%3A26):\n> Just to be certain, the error is coming from Python with the wrapper `Element.__mul__(left, right)`, but when `def __mul__(left, right):` in `Foo` is called, it is actually just calling the underlying `nb_multiply`.\n\nI don't really understand your question. But let me try to clarify anyway. Consider\n\n```\ncdef class Foo:\n    def __mul__(left, right):\n        pass\n```\nNow, this `def __mul__` is not a Python method or function or anything like that. It's really a C function to put in the `nb_multiply` slot. Cython chose the syntax `def __mul__` because it would be familiar to Python programmers, but the similar syntax hides the difference in what it really is.\n\nNow, when a type(*) is initialized by Python, ordinary Python attributes `__mul__` and `__rmul__` are generated from the slots like `nb_multiply`. These attributes are of type \"slot wrapper\" and you can see them in the `__dict__`:\n\n```\nsage: Integer.__mul__\n<slot wrapper '__mul__' of 'sage.rings.integer.Integer' objects>\nsage: Integer.__rmul__\n<slot wrapper '__rmul__' of 'sage.rings.integer.Integer' objects>\nsage: Integer.__dict__\ndict_proxy({'__abs__': <slot wrapper '__abs__' of 'sage.rings.integer.Integer' objects>,\n            '__add__': <slot wrapper '__add__' of 'sage.rings.integer.Integer' objects>,\n            '__and__': <slot wrapper '__and__' of 'sage.rings.integer.Integer' objects>,\n            '__array_interface__': <attribute '__array_interface__' of 'sage.rings.integer.Integer' objects>,\n            '__copy__': <method '__copy__' of 'sage.rings.integer.Integer' objects>,\n            '__div__': <slot wrapper '__div__' of 'sage.rings.integer.Integer' objects>,\n            .......\n```\nThese behave mostly like ordinary methods. They are implemented by Python and call the underlying slot function, which is `nb_multiply` for both `__mul__` and `__rmul__`.\n\nIn other words, the Python code `cls.__mul__(left, right)` roughly translates to `cls->nb_multiply(left, right)` in C, *with extra checking* added (like ordinary methods, the first argument `self` should be a suitable type). Now what I propose is to have a special function\n\n```\ndef wrapperdescr_call_nocheck(slotwrapper, *args)\n```\nwhich would call the underlying slot function but *without checks*.\n\nI haven't actually tried if it would work, but it should. And I can imagine it being useful for other purposes too. This might turn out to be one of these things where, if you know that it exists, you start seeing lots of use cases.\n\nYou might think that the problem could also be solved by implementing a custom `__mul__` method-like attribute on the type(*), which would be like the standard `__mul__` slot wrapper, except that it would not check that the first argument is of the right type. That sounds good, but breaks when subtyping(*): Python insists on \"restoring\" the slot wrapper in the subtype(*). I know because this broke an earlier attempt of #23102.\n\n(*) \"type\" and \"class\" mean the same thing in Python. However, there is a tendency to use \"type\" when talking about Python internals but \"class\" when talking about user code. The only exception are old-style classes, which are not types: indeed, `type(obj)` is not the same as `obj.__class__` for instances of old-style classes.",
    "created_at": "2017-07-07T20:49:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353250",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:27" align="right">Comment 27</div>

Replying to [@tscrim](#comment%3A26):
> Just to be certain, the error is coming from Python with the wrapper `Element.__mul__(left, right)`, but when `def __mul__(left, right):` in `Foo` is called, it is actually just calling the underlying `nb_multiply`.

I don't really understand your question. But let me try to clarify anyway. Consider

```
cdef class Foo:
    def __mul__(left, right):
        pass
```
Now, this `def __mul__` is not a Python method or function or anything like that. It's really a C function to put in the `nb_multiply` slot. Cython chose the syntax `def __mul__` because it would be familiar to Python programmers, but the similar syntax hides the difference in what it really is.

Now, when a type(*) is initialized by Python, ordinary Python attributes `__mul__` and `__rmul__` are generated from the slots like `nb_multiply`. These attributes are of type "slot wrapper" and you can see them in the `__dict__`:

```
sage: Integer.__mul__
<slot wrapper '__mul__' of 'sage.rings.integer.Integer' objects>
sage: Integer.__rmul__
<slot wrapper '__rmul__' of 'sage.rings.integer.Integer' objects>
sage: Integer.__dict__
dict_proxy({'__abs__': <slot wrapper '__abs__' of 'sage.rings.integer.Integer' objects>,
            '__add__': <slot wrapper '__add__' of 'sage.rings.integer.Integer' objects>,
            '__and__': <slot wrapper '__and__' of 'sage.rings.integer.Integer' objects>,
            '__array_interface__': <attribute '__array_interface__' of 'sage.rings.integer.Integer' objects>,
            '__copy__': <method '__copy__' of 'sage.rings.integer.Integer' objects>,
            '__div__': <slot wrapper '__div__' of 'sage.rings.integer.Integer' objects>,
            .......
```
These behave mostly like ordinary methods. They are implemented by Python and call the underlying slot function, which is `nb_multiply` for both `__mul__` and `__rmul__`.

In other words, the Python code `cls.__mul__(left, right)` roughly translates to `cls->nb_multiply(left, right)` in C, *with extra checking* added (like ordinary methods, the first argument `self` should be a suitable type). Now what I propose is to have a special function

```
def wrapperdescr_call_nocheck(slotwrapper, *args)
```
which would call the underlying slot function but *without checks*.

I haven't actually tried if it would work, but it should. And I can imagine it being useful for other purposes too. This might turn out to be one of these things where, if you know that it exists, you start seeing lots of use cases.

You might think that the problem could also be solved by implementing a custom `__mul__` method-like attribute on the type(*), which would be like the standard `__mul__` slot wrapper, except that it would not check that the first argument is of the right type. That sounds good, but breaks when subtyping(*): Python insists on "restoring" the slot wrapper in the subtype(*). I know because this broke an earlier attempt of #23102.

(*) "type" and "class" mean the same thing in Python. However, there is a tendency to use "type" when talking about Python internals but "class" when talking about user code. The only exception are old-style classes, which are not types: indeed, `type(obj)` is not the same as `obj.__class__` for instances of old-style classes.



---

archive/issue_comments_353251.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">Comment 28</div>\n\nSide comment: most special methods (like `__init__`, `__getattribute__`, `__hash__`, `__repr__`, `__iter__`, ...) are implemented this way. Usually, there is a close correspondence between the Python attribute and the C function: the first argument really is `self` and 1 slot function only has 1 attribute. The main exceptions to these are:\n\n1. `__new__` which is special in many \"interesting\" ways\n\n2. Rich comparison like `__eq__` because one C function corresponds to six Python methods. The first argument is still `self` though.\n\n3. Arithmetic like `__mul__` because the first argument may not be `self`.\n\nInterestingly, Cython already special cases calls to `__new__` (`cls.__new__(cls)` does not mean the same thing in Python and Cython) and I recently dealt with various tickets to improve Python support for rich comparisons. So, to finish the list, maybe there should be a ticket to close the gap between the Python and C implementations of arithmetic too.",
    "created_at": "2017-07-07T21:15:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353251",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:28" align="right">Comment 28</div>

Side comment: most special methods (like `__init__`, `__getattribute__`, `__hash__`, `__repr__`, `__iter__`, ...) are implemented this way. Usually, there is a close correspondence between the Python attribute and the C function: the first argument really is `self` and 1 slot function only has 1 attribute. The main exceptions to these are:

1. `__new__` which is special in many "interesting" ways

2. Rich comparison like `__eq__` because one C function corresponds to six Python methods. The first argument is still `self` though.

3. Arithmetic like `__mul__` because the first argument may not be `self`.

Interestingly, Cython already special cases calls to `__new__` (`cls.__new__(cls)` does not mean the same thing in Python and Cython) and I recently dealt with various tickets to improve Python support for rich comparisons. So, to finish the list, maybe there should be a ticket to close the gap between the Python and C implementations of arithmetic too.



---

archive/issue_comments_353252.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">Comment 29</div>\n\nThank you for the explanation; that is very useful. So my question right now is should we simply use `nb_multiply` as the super call? Although there definitely should be other use-cases for a `wrapperdescr_call_nocheck`, and from looking at #23102, I agree that it should be possible to write such a function. I'm wondering what you think the best approach is?",
    "created_at": "2017-07-09T06:29:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353252",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:29" align="right">Comment 29</div>

Thank you for the explanation; that is very useful. So my question right now is should we simply use `nb_multiply` as the super call? Although there definitely should be other use-cases for a `wrapperdescr_call_nocheck`, and from looking at #23102, I agree that it should be possible to write such a function. I'm wondering what you think the best approach is?



---

archive/issue_comments_353253.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">Comment 30</div>\n\nReplying to [@tscrim](#comment%3A29):\n> Thank you for the explanation; that is very useful. So my question right now is should we simply use `nb_multiply` as the super call? Although there definitely should be other use-cases for a `wrapperdescr_call_nocheck`, and from looking at #23102, I agree that it should be possible to write such a function. I'm wondering what you think the best approach is?\n\nI would prefer `wrapperdescr_call_nocheck` because it's a general solution. The `nb_multiply` thing would be very specific and it would probably also require some trivial changes to Cython upstream.",
    "created_at": "2017-07-10T08:13:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353253",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:30" align="right">Comment 30</div>

Replying to [@tscrim](#comment%3A29):
> Thank you for the explanation; that is very useful. So my question right now is should we simply use `nb_multiply` as the super call? Although there definitely should be other use-cases for a `wrapperdescr_call_nocheck`, and from looking at #23102, I agree that it should be possible to write such a function. I'm wondering what you think the best approach is?

I would prefer `wrapperdescr_call_nocheck` because it's a general solution. The `nb_multiply` thing would be very specific and it would probably also require some trivial changes to Cython upstream.



---

archive/issue_comments_353254.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">Comment 31</div>\n\nReplying to [@jdemeyer](#comment%3A30):\n> Replying to [@tscrim](#comment%3A29):\n> > Thank you for the explanation; that is very useful. So my question right now is should we simply use `nb_multiply` as the super call? Although there definitely should be other use-cases for a `wrapperdescr_call_nocheck`, and from looking at #23102, I agree that it should be possible to write such a function. I'm wondering what you think the best approach is?\n\n> \n> I would prefer `wrapperdescr_call_nocheck` because it's a general solution. The `nb_multiply` thing would be very specific and it would probably also require some trivial changes to Cython upstream.\n\nIf you write such a function, I will make the appropriate changes in here to use it.",
    "created_at": "2017-07-10T15:40:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353254",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:31" align="right">Comment 31</div>

Replying to [@jdemeyer](#comment%3A30):
> Replying to [@tscrim](#comment%3A29):
> > Thank you for the explanation; that is very useful. So my question right now is should we simply use `nb_multiply` as the super call? Although there definitely should be other use-cases for a `wrapperdescr_call_nocheck`, and from looking at #23102, I agree that it should be possible to write such a function. I'm wondering what you think the best approach is?

> 
> I would prefer `wrapperdescr_call_nocheck` because it's a general solution. The `nb_multiply` thing would be very specific and it would probably also require some trivial changes to Cython upstream.

If you write such a function, I will make the appropriate changes in here to use it.



---

archive/issue_comments_353255.json:
```json
{
    "body": "Dependencies: **#23404**",
    "created_at": "2017-07-12T12:15:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353255",
    "user": "https://github.com/jdemeyer"
}
```

Dependencies: **#23404**



---

archive/issue_events_307086.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-07-12T12:15:18Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23346#event-307086"
}
```



---

archive/issue_events_307087.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-07-12T12:15:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23346#event-307087"
}
```



---

archive/issue_comments_353256.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">Comment 33</div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/cf224b7e57b9dfc46446d8673a546f3e9f377008\">cf224b7</a></td><td><code>Implement wrapperdescr_call without checking</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3160dc0c815c69fbabf0dca984bda0c0740bfbff\">3160dc0</a></td><td><code>Merge branch 'u/jdemeyer/implement_wrapperdescr_call_without_checking' of git://trac.sagemath.org/sage into public/lie_algebras/cythonize_element-23346</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/97e6ec2db773073aa188e268467d823cb3527184\">97e6ec2</a></td><td><code>Rebased on #23404 to implement a super-type call for __mul__.</code></td></tr></table>\n",
    "created_at": "2017-07-12T14:19:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353256",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:33" align="right">Comment 33</div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/cf224b7e57b9dfc46446d8673a546f3e9f377008">cf224b7</a></td><td><code>Implement wrapperdescr_call without checking</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3160dc0c815c69fbabf0dca984bda0c0740bfbff">3160dc0</a></td><td><code>Merge branch 'u/jdemeyer/implement_wrapperdescr_call_without_checking' of git://trac.sagemath.org/sage into public/lie_algebras/cythonize_element-23346</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/97e6ec2db773073aa188e268467d823cb3527184">97e6ec2</a></td><td><code>Rebased on #23404 to implement a super-type call for __mul__.</code></td></tr></table>




---

archive/issue_comments_353257.json:
```json
{
    "body": "Changed commit from **[c13da59](https://github.com/sagemath/sagetrac-mirror/commit/c13da59d442c5841e4a1a41dfb78fed6e79254f1)** to **[97e6ec2](https://github.com/sagemath/sagetrac-mirror/commit/97e6ec2db773073aa188e268467d823cb3527184)**",
    "created_at": "2017-07-12T14:19:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353257",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[c13da59](https://github.com/sagemath/sagetrac-mirror/commit/c13da59d442c5841e4a1a41dfb78fed6e79254f1)** to **[97e6ec2](https://github.com/sagemath/sagetrac-mirror/commit/97e6ec2db773073aa188e268467d823cb3527184)**



---

archive/issue_events_307088.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2017-07-12T14:29:49Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23346#event-307088"
}
```



---

archive/issue_events_307089.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2017-07-12T14:29:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23346#event-307089"
}
```



---

archive/issue_comments_353258.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">Comment 34</div>\n\nRebased. Thank you for adding the function. Although this does result in a slowdown in some of the operations:\n\n```\nsage: L.<x,y,z> = LieAlgebra(QQ, {('x','y'): {'z':1}})\nsage: %timeit int(3) * x\n100000 loops, best of 3: 4.09 \u00b5s per loop\nsage: %timeit x * int(3)\n100000 loops, best of 3: 4.14 \u00b5s per loop\nsage: %timeit x * y\n10000 loops, best of 3: 86.1 \u00b5s per loop\nsage: %timeit 3 * x\n100000 loops, best of 3: 4.15 \u00b5s per loop\nsage: %timeit x * 3\n100000 loops, best of 3: 4.11 \u00b5s per loop\nsage: %timeit (3/2) * x\n100000 loops, best of 3: 3.1 \u00b5s per loop\nsage: %timeit x * (3/2)\n100000 loops, best of 3: 3.02 \u00b5s per loop\nsage: %timeit for _ in range(1000): 3 * x\n100 loops, best of 3: 4.01 ms per loop\nsage: %timeit for _ in range(1000): x * 3\n100 loops, best of 3: 3.99 ms per loop\n```\nversus the previous commit:\n\n```\nLsage: L.<x,y,z> = LieAlgebra(QQ, {('x','y'): {'z':1}})\nsage: %timeit int(3) * x\n100000 loops, best of 3: 3.07 \u00b5s per loop\nsage: %timeit x * int(3)\n100000 loops, best of 3: 2.85 \u00b5s per loop\nsage: %timeit x * y\n100000 loops, best of 3: 7.32 \u00b5s per loop\nsage: %timeit 3 * x\n100000 loops, best of 3: 3.87 \u00b5s per loop\nsage: %timeit x * 3\n100000 loops, best of 3: 3.67 \u00b5s per loop\nsage: %timeit (3/2) * x\n100000 loops, best of 3: 2.93 \u00b5s per loop\nsage: %timeit x * (3/2)\n100000 loops, best of 3: 2.81 \u00b5s per loop\nsage: %timeit for _ in range(1000): 3 * x\n100 loops, best of 3: 3.88 ms per loop\nsage: %timeit for _ in range(1000): x * 3\n100 loops, best of 3: 3.74 ms per loop\n```\nThe multiplication of elements in the Lie algebra should be a rare event and is mainly used as a convenience (the better way is to do the lift within the code itself). I also would say multiplying by an `int` should not really be done either.\n\nTL;DR - I can live with the 5-10% regression for the typical multiplication cases in order to have cleaner code.",
    "created_at": "2017-07-12T14:29:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353258",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:34" align="right">Comment 34</div>

Rebased. Thank you for adding the function. Although this does result in a slowdown in some of the operations:

```
sage: L.<x,y,z> = LieAlgebra(QQ, {('x','y'): {'z':1}})
sage: %timeit int(3) * x
100000 loops, best of 3: 4.09 µs per loop
sage: %timeit x * int(3)
100000 loops, best of 3: 4.14 µs per loop
sage: %timeit x * y
10000 loops, best of 3: 86.1 µs per loop
sage: %timeit 3 * x
100000 loops, best of 3: 4.15 µs per loop
sage: %timeit x * 3
100000 loops, best of 3: 4.11 µs per loop
sage: %timeit (3/2) * x
100000 loops, best of 3: 3.1 µs per loop
sage: %timeit x * (3/2)
100000 loops, best of 3: 3.02 µs per loop
sage: %timeit for _ in range(1000): 3 * x
100 loops, best of 3: 4.01 ms per loop
sage: %timeit for _ in range(1000): x * 3
100 loops, best of 3: 3.99 ms per loop
```
versus the previous commit:

```
Lsage: L.<x,y,z> = LieAlgebra(QQ, {('x','y'): {'z':1}})
sage: %timeit int(3) * x
100000 loops, best of 3: 3.07 µs per loop
sage: %timeit x * int(3)
100000 loops, best of 3: 2.85 µs per loop
sage: %timeit x * y
100000 loops, best of 3: 7.32 µs per loop
sage: %timeit 3 * x
100000 loops, best of 3: 3.87 µs per loop
sage: %timeit x * 3
100000 loops, best of 3: 3.67 µs per loop
sage: %timeit (3/2) * x
100000 loops, best of 3: 2.93 µs per loop
sage: %timeit x * (3/2)
100000 loops, best of 3: 2.81 µs per loop
sage: %timeit for _ in range(1000): 3 * x
100 loops, best of 3: 3.88 ms per loop
sage: %timeit for _ in range(1000): x * 3
100 loops, best of 3: 3.74 ms per loop
```
The multiplication of elements in the Lie algebra should be a rare event and is mainly used as a convenience (the better way is to do the lift within the code itself). I also would say multiplying by an `int` should not really be done either.

TL;DR - I can live with the 5-10% regression for the typical multiplication cases in order to have cleaner code.



---

archive/issue_comments_353259.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">Comment 35</div>\n\nI can think of 2 reasons for the slowdown:\n\n1. The method access `IndexedFreeModuleElement.__mul__` takes some time. You could do this at the top-level like\n\n```\ncdef object IndexedFreeModuleElement__mul__ = IndexedFreeModuleElement.__mul__\n```\n\n2. You are constructing `{}` for every call of `wrapperdescr_fastcall`. Since this `kwds` argument is not actually used, you could pass `None` instead.",
    "created_at": "2017-07-12T14:38:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353259",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:35" align="right">Comment 35</div>

I can think of 2 reasons for the slowdown:

1. The method access `IndexedFreeModuleElement.__mul__` takes some time. You could do this at the top-level like

```
cdef object IndexedFreeModuleElement__mul__ = IndexedFreeModuleElement.__mul__
```

2. You are constructing `{}` for every call of `wrapperdescr_fastcall`. Since this `kwds` argument is not actually used, you could pass `None` instead.



---

archive/issue_comments_353260.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">Comment 36</div>\n\nInstead of passing `None` as `kwds`, even faster would be passing `<object>NULL`.",
    "created_at": "2017-07-12T14:46:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353260",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:36" align="right">Comment 36</div>

Instead of passing `None` as `kwds`, even faster would be passing `<object>NULL`.



---

archive/issue_comments_353261.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">Comment 37</div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5390476fc9925af42d8fe08d4fb658107e6fb4e6\">5390476</a></td><td><code>Pass None instead of {} as kwargs.</code></td></tr></table>\n",
    "created_at": "2017-07-12T14:47:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353261",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:37" align="right">Comment 37</div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5390476fc9925af42d8fe08d4fb658107e6fb4e6">5390476</a></td><td><code>Pass None instead of {} as kwargs.</code></td></tr></table>




---

archive/issue_comments_353262.json:
```json
{
    "body": "Changed commit from **[97e6ec2](https://github.com/sagemath/sagetrac-mirror/commit/97e6ec2db773073aa188e268467d823cb3527184)** to **[5390476](https://github.com/sagemath/sagetrac-mirror/commit/5390476fc9925af42d8fe08d4fb658107e6fb4e6)**",
    "created_at": "2017-07-12T14:47:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353262",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[97e6ec2](https://github.com/sagemath/sagetrac-mirror/commit/97e6ec2db773073aa188e268467d823cb3527184)** to **[5390476](https://github.com/sagemath/sagetrac-mirror/commit/5390476fc9925af42d8fe08d4fb658107e6fb4e6)**



---

archive/issue_comments_353263.json:
```json
{
    "body": "Changed commit from **[5390476](https://github.com/sagemath/sagetrac-mirror/commit/5390476fc9925af42d8fe08d4fb658107e6fb4e6)** to **[d168a36](https://github.com/sagemath/sagetrac-mirror/commit/d168a36fce0ca011179580acf312fac9b53088ac)**",
    "created_at": "2017-07-12T14:49:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353263",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[5390476](https://github.com/sagemath/sagetrac-mirror/commit/5390476fc9925af42d8fe08d4fb658107e6fb4e6)** to **[d168a36](https://github.com/sagemath/sagetrac-mirror/commit/d168a36fce0ca011179580acf312fac9b53088ac)**



---

archive/issue_comments_353264.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">Comment 38</div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d168a36fce0ca011179580acf312fac9b53088ac\">d168a36</a></td><td><code>Pass <object>NULL instead of {} as kwds.</code></td></tr></table>\n",
    "created_at": "2017-07-12T14:49:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353264",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:38" align="right">Comment 38</div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d168a36fce0ca011179580acf312fac9b53088ac">d168a36</a></td><td><code>Pass <object>NULL instead of {} as kwds.</code></td></tr></table>




---

archive/issue_comments_353265.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">Comment 39</div>\n\nThat does put me back in the same timing realm as before, thank you.",
    "created_at": "2017-07-12T14:50:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353265",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:39" align="right">Comment 39</div>

That does put me back in the same timing realm as before, thank you.



---

archive/issue_comments_353266.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">Comment 40</div>\n\nPing. I also checked that this does not conflict with #23440.",
    "created_at": "2017-07-26T02:57:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353266",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:40" align="right">Comment 40</div>

Ping. I also checked that this does not conflict with #23440.



---

archive/issue_comments_353267.json:
```json
{
    "body": "Changed commit from **[d168a36](https://github.com/sagemath/sagetrac-mirror/commit/d168a36fce0ca011179580acf312fac9b53088ac)** to **[16a034b](https://github.com/sagemath/sagetrac-mirror/commit/16a034b1649da00dee3a35390f8cebc23e85ef49)**",
    "created_at": "2017-07-31T03:09:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353267",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[d168a36](https://github.com/sagemath/sagetrac-mirror/commit/d168a36fce0ca011179580acf312fac9b53088ac)** to **[16a034b](https://github.com/sagemath/sagetrac-mirror/commit/16a034b1649da00dee3a35390f8cebc23e85ef49)**



---

archive/issue_comments_353268.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">Comment 41</div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/16a034b1649da00dee3a35390f8cebc23e85ef49\">16a034b</a></td><td><code>Merge branch 'public/lie_algebras/cythonize_element-23346' of git://trac.sagemath.org/sage into public/lie_algebras/cythonize_element-23346</code></td></tr></table>\n",
    "created_at": "2017-07-31T03:09:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353268",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:41" align="right">Comment 41</div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/16a034b1649da00dee3a35390f8cebc23e85ef49">16a034b</a></td><td><code>Merge branch 'public/lie_algebras/cythonize_element-23346' of git://trac.sagemath.org/sage into public/lie_algebras/cythonize_element-23346</code></td></tr></table>




---

archive/issue_comments_353269.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">Comment 42</div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/65f1584624f7c8a8f59e3ebf72913819c202ed9a\">65f1584</a></td><td><code>Fixing some stuff from the merge.</code></td></tr></table>\n",
    "created_at": "2017-08-10T22:40:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353269",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:42" align="right">Comment 42</div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/65f1584624f7c8a8f59e3ebf72913819c202ed9a">65f1584</a></td><td><code>Fixing some stuff from the merge.</code></td></tr></table>




---

archive/issue_comments_353270.json:
```json
{
    "body": "Changed commit from **[16a034b](https://github.com/sagemath/sagetrac-mirror/commit/16a034b1649da00dee3a35390f8cebc23e85ef49)** to **[65f1584](https://github.com/sagemath/sagetrac-mirror/commit/65f1584624f7c8a8f59e3ebf72913819c202ed9a)**",
    "created_at": "2017-08-10T22:40:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353270",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[16a034b](https://github.com/sagemath/sagetrac-mirror/commit/16a034b1649da00dee3a35390f8cebc23e85ef49)** to **[65f1584](https://github.com/sagemath/sagetrac-mirror/commit/65f1584624f7c8a8f59e3ebf72913819c202ed9a)**



---

archive/issue_events_307090.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2017-08-20T13:45:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23346#event-307090"
}
```



---

archive/issue_events_307091.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2017-08-20T13:45:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23346#event-307091"
}
```



---

archive/issue_comments_353271.json:
```json
{
    "body": "Reviewer: **Fr\u00e9d\u00e9ric Chapoton, Jeroen Demeyer**",
    "created_at": "2017-08-20T13:45:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353271",
    "user": "https://github.com/fchapoton"
}
```

Reviewer: **Frédéric Chapoton, Jeroen Demeyer**



---

archive/issue_comments_353272.json:
```json
{
    "body": "<div id=\"comment:43\" align=\"right\">Comment 43</div>\n\nok, I am setting this to positive",
    "created_at": "2017-08-20T13:45:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353272",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:43" align="right">Comment 43</div>

ok, I am setting this to positive



---

archive/issue_comments_353273.json:
```json
{
    "body": "Changed branch from **[public/lie_algebras/cythonize_element-23346](https://github.com/sagemath/sagetrac-mirror/tree/public/lie_algebras/cythonize_element-23346)** to **[65f1584](https://github.com/sagemath/sagetrac-mirror/commit/65f1584624f7c8a8f59e3ebf72913819c202ed9a)**",
    "created_at": "2017-08-26T09:58:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23346#issuecomment-353273",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[public/lie_algebras/cythonize_element-23346](https://github.com/sagemath/sagetrac-mirror/tree/public/lie_algebras/cythonize_element-23346)** to **[65f1584](https://github.com/sagemath/sagetrac-mirror/commit/65f1584624f7c8a8f59e3ebf72913819c202ed9a)**



---

archive/issue_events_307092.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-08-26T09:58:04Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23346#event-307092"
}
```



---

archive/issue_events_307093.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "9720578ccc3fd73f0c25d716e2fe5605948960f4",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2017-08-26T09:58:04Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/23346",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23346#event-307093"
}
```
