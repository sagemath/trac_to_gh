# Issue 23927: discrete log takes a huge amount of time in some cases

archive/issues_023690.json:
```json
{
    "body": "for some inputs, the discrete log can take a huge amount of time, whereas for other similar inputs it takes negligible time. Here is a first example that takes negligible time (with Sage 8.0):\n\n```\nsage: time mod(17,10^15+37).log(3)\nCPU times: user 48 ms, sys: 0 ns, total: 48 ms\nWall time: 53.3 ms\n502952226729022\n```\nNow consider this other computation modulo a very near prime:\n\n```\nsage: time mod(17,10^15+56719).log(3)\nCPU times: user 1min 3s, sys: 1.42 s, total: 1min 5s\nWall time: 1min 6s\n420536002305675\n```\nIf we directly call the Pari/GP discrete log function, it is much faster:\n\n```\nsage: time gp.znlog(17,mod(3,10^15+56719))\nCPU times: user 16 ms, sys: 4 ms, total: 20 ms\nWall time: 130 ms\n420536002305675\n```\nWhy don't we call the Pari/GP function?\n\nCC:  @JohnCremona @jdemeyer\n\nBranch/Commit: 9eb3de78a691e262a8e1c6a56d57ea5e221d1566\n\nReviewer: Paul Zimmermann\n\nAuthor: Maarten Derickx\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/23927\n\n",
    "closed_at": "2017-10-01T00:18:47Z",
    "created_at": "2017-09-25T13:26:33Z",
    "labels": [
        "component: basic arithmetic",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "discrete log takes a huge amount of time in some cases",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23927",
    "user": "https://github.com/zimmermann6"
}
```
for some inputs, the discrete log can take a huge amount of time, whereas for other similar inputs it takes negligible time. Here is a first example that takes negligible time (with Sage 8.0):

```
sage: time mod(17,10^15+37).log(3)
CPU times: user 48 ms, sys: 0 ns, total: 48 ms
Wall time: 53.3 ms
502952226729022
```
Now consider this other computation modulo a very near prime:

```
sage: time mod(17,10^15+56719).log(3)
CPU times: user 1min 3s, sys: 1.42 s, total: 1min 5s
Wall time: 1min 6s
420536002305675
```
If we directly call the Pari/GP discrete log function, it is much faster:

```
sage: time gp.znlog(17,mod(3,10^15+56719))
CPU times: user 16 ms, sys: 4 ms, total: 20 ms
Wall time: 130 ms
420536002305675
```
Why don't we call the Pari/GP function?

CC:  @JohnCremona @jdemeyer

Branch/Commit: 9eb3de78a691e262a8e1c6a56d57ea5e221d1566

Reviewer: Paul Zimmermann

Author: Maarten Derickx

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/23927





---

archive/issue_comments_445985.json:
```json
{
    "body": "<a id='comment:1'></a>\nHi,\n\nI just looked at the source code, and it seems that this happens because 3 is not a generator of  `Integers(10^15+56719)`, sage already calls pari, but falls back to a generic implementation if the base is not a generator of the unit group. \n\n```\nsage: time mod(17,10^15+56719).log(7)\nCPU times: user 45.3 ms, sys: 786 \u00b5s, total: 46.1 ms\nWall time: 46.2 ms\n502331130239286\n```\nThis might stem from a time where pari could not handle this case yet. I'm writing a patch that should fix this.\n\n\nNote that the running time is not really the worst thing, the memory usage of python reaches a peak of about 4GB during the execution of\n`mod(17,10^15+56719).log(3)`.",
    "created_at": "2017-09-25T17:20:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23927#issuecomment-445985",
    "user": "https://github.com/koffie"
}
```

<a id='comment:1'></a>
Hi,

I just looked at the source code, and it seems that this happens because 3 is not a generator of  `Integers(10^15+56719)`, sage already calls pari, but falls back to a generic implementation if the base is not a generator of the unit group. 

```
sage: time mod(17,10^15+56719).log(7)
CPU times: user 45.3 ms, sys: 786 Âµs, total: 46.1 ms
Wall time: 46.2 ms
502331130239286
```
This might stem from a time where pari could not handle this case yet. I'm writing a patch that should fix this.


Note that the running time is not really the worst thing, the memory usage of python reaches a peak of about 4GB during the execution of
`mod(17,10^15+56719).log(3)`.



---

archive/issue_comments_445986.json:
```json
{
    "body": "Changing author from \"\" to \"Maarten Derickx\"",
    "created_at": "2017-09-25T19:46:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23927#issuecomment-445986",
    "user": "https://github.com/koffie"
}
```

Changing author from "" to "Maarten Derickx"



---

archive/issue_comments_445987.json:
```json
{
    "body": "Changing commit from \"\" to \"ce829a64cf8daaf541027c92c43c6c549b6f3139\"",
    "created_at": "2017-09-25T19:46:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23927#issuecomment-445987",
    "user": "https://github.com/koffie"
}
```

Changing commit from "" to "ce829a64cf8daaf541027c92c43c6c549b6f3139"



---

archive/issue_comments_445988.json:
```json
{
    "body": "<a id='comment:2'></a>\nHere a fix, it passes all doctests in `src/sage/rings` for me, I leave the rest to the patchbot.\n\n---\nNew commits:\n|                                                                                                                                          |                                                        |\n|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------|\n|[ce829a6](https://github.com/sagemath/sagetrac-mirror/commit/ce829a64cf8daaf541027c92c43c6c549b6f3139)|`Trac 23927: Speedup discrete logarithm for integer_mod`|",
    "created_at": "2017-09-25T19:46:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23927#issuecomment-445988",
    "user": "https://github.com/koffie"
}
```

<a id='comment:2'></a>
Here a fix, it passes all doctests in `src/sage/rings` for me, I leave the rest to the patchbot.

---
New commits:
|                                                                                                                                          |                                                        |
|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------|
|[ce829a6](https://github.com/sagemath/sagetrac-mirror/commit/ce829a64cf8daaf541027c92c43c6c549b6f3139)|`Trac 23927: Speedup discrete logarithm for integer_mod`|



---

archive/issue_comments_445989.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-09-25T19:46:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23927#issuecomment-445989",
    "user": "https://github.com/koffie"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_445990.json:
```json
{
    "body": "Changing branch from \"\" to \"public/23927\"",
    "created_at": "2017-09-25T19:46:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23927#issuecomment-445990",
    "user": "https://github.com/koffie"
}
```

Changing branch from "" to "public/23927"



---

archive/issue_comments_445991.json:
```json
{
    "body": "<a id='comment:3'></a>\nThe added doctest to check that this tickets is fixed should take about 0.3 seconds with the patch. It tests that this ticket is fixed because it does not return within the standard doctest timeout setting without the fix.",
    "created_at": "2017-09-25T19:51:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23927#issuecomment-445991",
    "user": "https://github.com/koffie"
}
```

<a id='comment:3'></a>
The added doctest to check that this tickets is fixed should take about 0.3 seconds with the patch. It tests that this ticket is fixed because it does not return within the standard doctest timeout setting without the fix.



---

archive/issue_comments_445992.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-09-26T07:21:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23927#issuecomment-445992",
    "user": "https://github.com/zimmermann6"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_445993.json:
```json
{
    "body": "<a id='comment:4'></a>\nI see some failures in the patchbot doctests. Needs work?",
    "created_at": "2017-09-26T07:21:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23927#issuecomment-445993",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:4'></a>
I see some failures in the patchbot doctests. Needs work?



---

archive/issue_comments_445994.json:
```json
{
    "body": "Changing commit from \"ce829a64cf8daaf541027c92c43c6c549b6f3139\" to \"9eb3de78a691e262a8e1c6a56d57ea5e221d1566\"",
    "created_at": "2017-09-26T13:39:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23927#issuecomment-445994",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "ce829a64cf8daaf541027c92c43c6c549b6f3139" to "9eb3de78a691e262a8e1c6a56d57ea5e221d1566"



---

archive/issue_comments_445995.json:
```json
{
    "body": "<a id='comment:5'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                               |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------|\n|[9eb3de7](https://github.com/sagemath/sagetrac-mirror/commit/9eb3de78a691e262a8e1c6a56d57ea5e221d1566)|`Trac 23927: minor doctest fix`|",
    "created_at": "2017-09-26T13:39:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23927#issuecomment-445995",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                               |
|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------|
|[9eb3de7](https://github.com/sagemath/sagetrac-mirror/commit/9eb3de78a691e262a8e1c6a56d57ea5e221d1566)|`Trac 23927: minor doctest fix`|



---

archive/issue_comments_445996.json:
```json
{
    "body": "<a id='comment:6'></a>\nIt seems to me only one failure was due to this ticket, and I fixed that one. \nI created #23930 for one of the other doctest failures.\n\n---\nNew commits:\n|                                                                                                                                          |                               |\n|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------|\n|[9eb3de7](https://github.com/sagemath/sagetrac-mirror/commit/9eb3de78a691e262a8e1c6a56d57ea5e221d1566)|`Trac 23927: minor doctest fix`|",
    "created_at": "2017-09-26T13:42:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23927#issuecomment-445996",
    "user": "https://github.com/koffie"
}
```

<a id='comment:6'></a>
It seems to me only one failure was due to this ticket, and I fixed that one. 
I created #23930 for one of the other doctest failures.

---
New commits:
|                                                                                                                                          |                               |
|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------|
|[9eb3de7](https://github.com/sagemath/sagetrac-mirror/commit/9eb3de78a691e262a8e1c6a56d57ea5e221d1566)|`Trac 23927: minor doctest fix`|



---

archive/issue_comments_445997.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-09-26T13:42:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23927#issuecomment-445997",
    "user": "https://github.com/koffie"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_445998.json:
```json
{
    "body": "<a id='comment:7'></a>\nOk, all the doctest failures that were not due to this ticket are now listed at the meta ticket for known patchbot failures #23832 .",
    "created_at": "2017-09-26T14:54:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23927#issuecomment-445998",
    "user": "https://github.com/koffie"
}
```

<a id='comment:7'></a>
Ok, all the doctest failures that were not due to this ticket are now listed at the meta ticket for known patchbot failures #23832 .



---

archive/issue_comments_445999.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-09-27T08:51:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23927#issuecomment-445999",
    "user": "https://github.com/zimmermann6"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_446000.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Paul Zimmermann\"",
    "created_at": "2017-09-27T08:51:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23927#issuecomment-446000",
    "user": "https://github.com/zimmermann6"
}
```

Changing reviewer from "" to "Paul Zimmermann"



---

archive/issue_comments_446001.json:
```json
{
    "body": "<a id='comment:8'></a>\nseems good to me: positive review. Thanks!",
    "created_at": "2017-09-27T08:51:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23927#issuecomment-446001",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:8'></a>
seems good to me: positive review. Thanks!



---

archive/issue_comments_446002.json:
```json
{
    "body": "Changing branch from \"public/23927\" to \"9eb3de78a691e262a8e1c6a56d57ea5e221d1566\"",
    "created_at": "2017-10-01T00:18:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23927#issuecomment-446002",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/23927" to "9eb3de78a691e262a8e1c6a56d57ea5e221d1566"



---

archive/issue_events_077070.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-10-01T00:18:47Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23927",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23927#event-77070"
}
```



---

archive/issue_comments_446003.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-10-01T00:18:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23927#issuecomment-446003",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
