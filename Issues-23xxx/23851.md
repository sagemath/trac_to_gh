# Issue 23851: Fix memoryleak introduced in #11670

archive/issues_023614.json:
```json
{
    "body": "In #11670 the following leak was introduced:\n\n```\n        sage: u=id(NumberField(x^2-5,'a').absolute_field('b'))\n        sage: import gc\n        sage: gc.collect() #random\n        10\n        sage: [id(v) for v in gc.get_objects() if id(v) == u]\n```\n\nSee Nils's explanation in [#23807 comment:14](https://github.com/sagemath/sage/issues/23807#comment:14) and the surrounding discussion, where this bug was found.\n\n**Keywords:** thursdaysbdx\n\n**Branch/Commit:** [b7e1042ab0f3948aa2416c03ebe7c70701418dc3](https://github.com/sagemath/sagetrac-mirror/commit/b7e1042ab0f3948aa2416c03ebe7c70701418dc3)\n\n**Reviewer:** S\u00e9bastien Labb\u00e9\n\n**Author:** Nils Bruin, Peter Bruin\n\nIssue created by migration from https://trac.sagemath.org/ticket/23851\n\n",
    "closed_at": "2018-05-18T17:04:22Z",
    "created_at": "2017-09-13T22:03:18Z",
    "labels": [
        "component: memleak",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.3",
    "title": "Fix memoryleak introduced in #11670",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/23851",
    "user": "https://github.com/nbruin"
}
```
In #11670 the following leak was introduced:

```
        sage: u=id(NumberField(x^2-5,'a').absolute_field('b'))
        sage: import gc
        sage: gc.collect() #random
        10
        sage: [id(v) for v in gc.get_objects() if id(v) == u]
```

See Nils's explanation in [#23807 comment:14](https://github.com/sagemath/sage/issues/23807#comment:14) and the surrounding discussion, where this bug was found.

**Keywords:** thursdaysbdx

**Branch/Commit:** [b7e1042ab0f3948aa2416c03ebe7c70701418dc3](https://github.com/sagemath/sagetrac-mirror/commit/b7e1042ab0f3948aa2416c03ebe7c70701418dc3)

**Reviewer:** Sébastien Labbé

**Author:** Nils Bruin, Peter Bruin

Issue created by migration from https://trac.sagemath.org/ticket/23851





---

archive/issue_comments_362450.json:
```json
{
    "body": "**Branch:** [u/nbruin/fix_memoryleak_introduced_in__11670](https://github.com/sagemath/sagetrac-mirror/tree/u/nbruin/fix_memoryleak_introduced_in__11670)",
    "created_at": "2017-09-13T22:05:26Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362450",
    "user": "https://github.com/nbruin"
}
```

**Branch:** [u/nbruin/fix_memoryleak_introduced_in__11670](https://github.com/sagemath/sagetrac-mirror/tree/u/nbruin/fix_memoryleak_introduced_in__11670)



---

archive/issue_events_211936.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2017-09-13T22:09:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-211936"
}
```



---

archive/issue_comments_362451.json:
```json
{
    "body": "**Author:** nbruin, pbruin",
    "created_at": "2017-09-13T22:09:36Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362451",
    "user": "https://github.com/nbruin"
}
```

**Author:** nbruin, pbruin



---

archive/issue_events_211937.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2017-09-13T22:09:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "component: memleak",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-211937"
}
```



---

archive/issue_comments_362452.json:
```json
{
    "body": "**Commit:** [bf22de066dacc686296cf17c0f098484dddf1f1e](https://github.com/sagemath/sagetrac-mirror/commit/bf22de066dacc686296cf17c0f098484dddf1f1e)",
    "created_at": "2017-09-13T22:09:36Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362452",
    "user": "https://github.com/nbruin"
}
```

**Commit:** [bf22de066dacc686296cf17c0f098484dddf1f1e](https://github.com/sagemath/sagetrac-mirror/commit/bf22de066dacc686296cf17c0f098484dddf1f1e)



---

archive/issue_comments_362453.json:
```json
{
    "body": "<a id='comment:2'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bf22de066dacc686296cf17c0f098484dddf1f1e\">bf22de0</a></td><td><code>amend caching of \"absolute_field\" to avoid memory leaks due to \"structure\" storage.</code></td></tr></table>\n",
    "created_at": "2017-09-13T22:09:36Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362453",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:2'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bf22de066dacc686296cf17c0f098484dddf1f1e">bf22de0</a></td><td><code>amend caching of "absolute_field" to avoid memory leaks due to "structure" storage.</code></td></tr></table>




---

archive/issue_events_211938.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2017-09-13T22:09:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "bug",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-211938"
}
```



---

archive/issue_comments_362454.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1 +1,12 @@\n+In #11670 the following leak was introduced:\n \n+```\n+        sage: u=id(NumberField(x^2-5,'a').absolute_field('b'))\n+        sage: import gc\n+        sage: gc.collect() #random\n+        10\n+        sage: [id(v) for v in gc.get_objects() if id(v) == u]\n+```\n+Fix from 23807:15\n+\n+\n``````\n",
    "created_at": "2017-09-13T22:09:36Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362454",
    "user": "https://github.com/nbruin"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1 +1,12 @@
+In #11670 the following leak was introduced:
 
+```
+        sage: u=id(NumberField(x^2-5,'a').absolute_field('b'))
+        sage: import gc
+        sage: gc.collect() #random
+        10
+        sage: [id(v) for v in gc.get_objects() if id(v) == u]
+```
+Fix from 23807:15
+
+
``````




---

archive/issue_comments_362455.json:
```json
{
    "body": "**Changing author** from \"nbruin, pbruin\" to \"Nils Bruin, Peter Bruin\".",
    "created_at": "2017-09-14T06:54:52Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362455",
    "user": "https://github.com/pjbruin"
}
```

**Changing author** from "nbruin, pbruin" to "Nils Bruin, Peter Bruin".



---

archive/issue_comments_362456.json:
```json
{
    "body": "**Changing branch** from \"[u/nbruin/fix_memoryleak_introduced_in__11670](https://github.com/sagemath/sagetrac-mirror/tree/u/nbruin/fix_memoryleak_introduced_in__11670)\" to \"[u/pbruin/23851-memory_leak](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/23851-memory_leak)\".",
    "created_at": "2017-09-14T06:54:52Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362456",
    "user": "https://github.com/pjbruin"
}
```

**Changing branch** from "[u/nbruin/fix_memoryleak_introduced_in__11670](https://github.com/sagemath/sagetrac-mirror/tree/u/nbruin/fix_memoryleak_introduced_in__11670)" to "[u/pbruin/23851-memory_leak](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/23851-memory_leak)".



---

archive/issue_comments_362457.json:
```json
{
    "body": "**Changing commit** from \"[bf22de066dacc686296cf17c0f098484dddf1f1e](https://github.com/sagemath/sagetrac-mirror/commit/bf22de066dacc686296cf17c0f098484dddf1f1e)\" to \"[4568007a9d08ccaa744c1f9b1832ea351eb5ccac](https://github.com/sagemath/sagetrac-mirror/commit/4568007a9d08ccaa744c1f9b1832ea351eb5ccac)\".",
    "created_at": "2017-09-14T06:54:52Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362457",
    "user": "https://github.com/pjbruin"
}
```

**Changing commit** from "[bf22de066dacc686296cf17c0f098484dddf1f1e](https://github.com/sagemath/sagetrac-mirror/commit/bf22de066dacc686296cf17c0f098484dddf1f1e)" to "[4568007a9d08ccaa744c1f9b1832ea351eb5ccac](https://github.com/sagemath/sagetrac-mirror/commit/4568007a9d08ccaa744c1f9b1832ea351eb5ccac)".



---

archive/issue_comments_362458.json:
```json
{
    "body": "<a id='comment:3'></a>\nCleaned up the docstrings of `absolute_field()` a bit.",
    "created_at": "2017-09-14T06:54:52Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362458",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:3'></a>
Cleaned up the docstrings of `absolute_field()` a bit.



---

archive/issue_comments_362459.json:
```json
{
    "body": "<a id='comment:4'></a>\nI do not know what is happening with the patchbot. The bug is fixed and I get `All tests passed` after running `make ptestlong` on my machine.",
    "created_at": "2017-09-14T14:48:59Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362459",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:4'></a>
I do not know what is happening with the patchbot. The bug is fixed and I get `All tests passed` after running `make ptestlong` on my machine.



---

archive/issue_comments_362460.json:
```json
{
    "body": "**Changing keywords** from \"\" to \"thursdaysbdx\".",
    "created_at": "2017-09-14T14:48:59Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362460",
    "user": "https://github.com/seblabbe"
}
```

**Changing keywords** from "" to "thursdaysbdx".



---

archive/issue_comments_362461.json:
```json
{
    "body": "**Reviewer:** S\u00e9bastien Labb\u00e9",
    "created_at": "2017-09-14T14:48:59Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362461",
    "user": "https://github.com/seblabbe"
}
```

**Reviewer:** Sébastien Labbé



---

archive/issue_events_211939.json:
```json
{
    "actor": "https://github.com/seblabbe",
    "created_at": "2017-09-14T14:48:59Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-211939"
}
```



---

archive/issue_events_211940.json:
```json
{
    "actor": "https://github.com/seblabbe",
    "created_at": "2017-09-14T14:48:59Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-211940"
}
```



---

archive/issue_events_211941.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-09-17T18:12:19Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-211941"
}
```



---

archive/issue_events_211942.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-09-17T18:12:19Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-211942"
}
```



---

archive/issue_comments_362462.json:
```json
{
    "body": "<a id='comment:5'></a>\nI'm getting this on various buildbots:\n\n```\nFile \"src/sage/rings/polynomial/polynomial_quotient_ring.py\", line 1389, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units\nFailed example:\n    u,o = K.S_units([])[0]; u, o\nExpected:\n    (-1/2*a + 1/2, 6)\nGot:\n    (1/2*a + 1/2, 6)\n**********************************************************************\nFile \"src/sage/rings/polynomial/polynomial_quotient_ring.py\", line 1395, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units\nFailed example:\n    u^2\nExpected:\n    -1/2*a - 1/2\nGot:\n    1/2*a - 1/2\n**********************************************************************\nFile \"src/sage/rings/polynomial/polynomial_quotient_ring.py\", line 1404, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units\nFailed example:\n    L.S_units([])\nExpected:\n    [(-1/2*a + 1/2, 6),\n     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),\n     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]\nGot:\n    [(1/2*a + 1/2, 6),\n     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),\n     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]\n**********************************************************************\nFile \"src/sage/rings/polynomial/polynomial_quotient_ring.py\", line 1408, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units\nFailed example:\n    L.S_units([K.ideal(1/2*a - 3/2)])\nExpected:\n    [((-1/6*a - 1/2)*b^2 + (1/3*a - 1)*b + 4/3*a, +Infinity),\n     (-1/2*a + 1/2, 6),\n     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),\n     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]\nGot:\n    [((-1/6*a - 1/2)*b^2 + (1/3*a - 1)*b + 4/3*a, +Infinity),\n     (1/2*a + 1/2, 6),\n     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),\n     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]\n**********************************************************************\nFile \"src/sage/rings/polynomial/polynomial_quotient_ring.py\", line 1413, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units\nFailed example:\n    L.S_units([K.ideal(2)])\nExpected:\n    [((1/2*a - 1/2)*b^2 + (a + 1)*b + 3, +Infinity),\n     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a + 1/2, +Infinity),\n     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a - 1/2, +Infinity),\n     (-1/2*a + 1/2, 6),\n     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),\n     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]\nGot:\n    [((1/2*a - 1/2)*b^2 + (a + 1)*b + 3, +Infinity),\n     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a + 1/2, +Infinity),\n     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a - 1/2, +Infinity),\n     (1/2*a + 1/2, 6),\n     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),\n     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]\n**********************************************************************\nFile \"src/sage/rings/polynomial/polynomial_quotient_ring.py\", line 1476, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units\nFailed example:\n    u = K.units()[0][0]; u\nExpected:\n    -1/2*a + 1/2\nGot:\n    1/2*a + 1/2\n**********************************************************************\nFile \"src/sage/rings/polynomial/polynomial_quotient_ring.py\", line 1482, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units\nFailed example:\n    u^2\nExpected:\n    -1/2*a - 1/2\nGot:\n    1/2*a - 1/2\n**********************************************************************\nFile \"src/sage/rings/polynomial/polynomial_quotient_ring.py\", line 1494, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units\nFailed example:\n    L.units()\nExpected:\n    [(-1/2*a + 1/2, 6),\n     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),\n     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]\nGot:\n    [(1/2*a + 1/2, 6),\n     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),\n     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]\n**********************************************************************\nFile \"src/sage/rings/polynomial/polynomial_quotient_ring.py\", line 1503, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units\nFailed example:\n    L.unit_group().gens_values()\nExpected:\n    [1/2*a + 1/2, (-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, 2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2]\nGot:\n    [-1/2*a + 1/2, (-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, 2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2]\n**********************************************************************\n2 items had failures:\n   5 of  18 in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units\n   4 of  23 in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units\n    [448 tests, 9 failures, 6.99 s]\n```",
    "created_at": "2017-09-17T18:12:19Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362462",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:5'></a>
I'm getting this on various buildbots:

```
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1389, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units
Failed example:
    u,o = K.S_units([])[0]; u, o
Expected:
    (-1/2*a + 1/2, 6)
Got:
    (1/2*a + 1/2, 6)
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1395, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units
Failed example:
    u^2
Expected:
    -1/2*a - 1/2
Got:
    1/2*a - 1/2
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1404, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units
Failed example:
    L.S_units([])
Expected:
    [(-1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
Got:
    [(1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1408, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units
Failed example:
    L.S_units([K.ideal(1/2*a - 3/2)])
Expected:
    [((-1/6*a - 1/2)*b^2 + (1/3*a - 1)*b + 4/3*a, +Infinity),
     (-1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
Got:
    [((-1/6*a - 1/2)*b^2 + (1/3*a - 1)*b + 4/3*a, +Infinity),
     (1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1413, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units
Failed example:
    L.S_units([K.ideal(2)])
Expected:
    [((1/2*a - 1/2)*b^2 + (a + 1)*b + 3, +Infinity),
     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a + 1/2, +Infinity),
     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a - 1/2, +Infinity),
     (-1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
Got:
    [((1/2*a - 1/2)*b^2 + (a + 1)*b + 3, +Infinity),
     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a + 1/2, +Infinity),
     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a - 1/2, +Infinity),
     (1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1476, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units
Failed example:
    u = K.units()[0][0]; u
Expected:
    -1/2*a + 1/2
Got:
    1/2*a + 1/2
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1482, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units
Failed example:
    u^2
Expected:
    -1/2*a - 1/2
Got:
    1/2*a - 1/2
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1494, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units
Failed example:
    L.units()
Expected:
    [(-1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
Got:
    [(1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1503, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units
Failed example:
    L.unit_group().gens_values()
Expected:
    [1/2*a + 1/2, (-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, 2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2]
Got:
    [-1/2*a + 1/2, (-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, 2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2]
**********************************************************************
2 items had failures:
   5 of  18 in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units
   4 of  23 in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units
    [448 tests, 9 failures, 6.99 s]
```



---

archive/issue_comments_362463.json:
```json
{
    "body": "<a id='comment:6'></a>\nWith the following change (which is probably a bad idea) I consistently get the same doctest failures as above:\n\n```diff\n--- a/src/sage/rings/polynomial/polynomial_quotient_ring.py\n+++ b/src/sage/rings/polynomial/polynomial_quotient_ring.py\n@@ -1050,7 +1050,6 @@ class PolynomialQuotientRing_generic(CommutativeRing):\n         return self(self.polynomial_ring().random_element( \\\n             degree=self.degree()-1, *args, **kwds))\n \n-    @cached_method\n     def _S_decomposition(self, S):\n         \"\"\"\n         Compute the decomposition of self into a product of number fields.\n```",
    "created_at": "2017-09-18T12:12:15Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362463",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:6'></a>
With the following change (which is probably a bad idea) I consistently get the same doctest failures as above:

```diff
--- a/src/sage/rings/polynomial/polynomial_quotient_ring.py
+++ b/src/sage/rings/polynomial/polynomial_quotient_ring.py
@@ -1050,7 +1050,6 @@ class PolynomialQuotientRing_generic(CommutativeRing):
         return self(self.polynomial_ring().random_element( \
             degree=self.degree()-1, *args, **kwds))
 
-    @cached_method
     def _S_decomposition(self, S):
         """
         Compute the decomposition of self into a product of number fields.
```



---

archive/issue_comments_362464.json:
```json
{
    "body": "**Changing commit** from \"[4568007a9d08ccaa744c1f9b1832ea351eb5ccac](https://github.com/sagemath/sagetrac-mirror/commit/4568007a9d08ccaa744c1f9b1832ea351eb5ccac)\" to \"[55a59ff3da2c50c83c23d5021a127026f811f0cd](https://github.com/sagemath/sagetrac-mirror/commit/55a59ff3da2c50c83c23d5021a127026f811f0cd)\".",
    "created_at": "2017-09-19T07:35:19Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362464",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[4568007a9d08ccaa744c1f9b1832ea351eb5ccac](https://github.com/sagemath/sagetrac-mirror/commit/4568007a9d08ccaa744c1f9b1832ea351eb5ccac)" to "[55a59ff3da2c50c83c23d5021a127026f811f0cd](https://github.com/sagemath/sagetrac-mirror/commit/55a59ff3da2c50c83c23d5021a127026f811f0cd)".



---

archive/issue_comments_362465.json:
```json
{
    "body": "<a id='comment:7'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/55a59ff3da2c50c83c23d5021a127026f811f0cd\">55a59ff</a></td><td><code>Trac 23851: force garbage collection to make S-unit computations deterministic</code></td></tr></table>\n",
    "created_at": "2017-09-19T07:35:19Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362465",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/55a59ff3da2c50c83c23d5021a127026f811f0cd">55a59ff</a></td><td><code>Trac 23851: force garbage collection to make S-unit computations deterministic</code></td></tr></table>




---

archive/issue_comments_362466.json:
```json
{
    "body": "<a id='comment:8'></a>\nThe above commit appears to make the computation deterministic again.  Let's see if the patchbot agrees.",
    "created_at": "2017-09-19T07:36:36Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362466",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:8'></a>
The above commit appears to make the computation deterministic again.  Let's see if the patchbot agrees.



---

archive/issue_events_211943.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2017-09-19T07:36:42Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-211943"
}
```



---

archive/issue_events_211944.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2017-09-19T07:36:42Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-211944"
}
```



---

archive/issue_comments_362467.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [slabbe](#comment%3A4):\n> I do not know what is happening with the patchbot. The bug is fixed and I get `All tests passed` after running `make ptestlong` on my machine.\n\nI confirm that I get the same errors when run alone:\n\n```\n sage -t src/sage/rings/polynomial/polynomial_quotient_ring.py\n```\n\nI am sorry, I do not know what happened with my run of `make ptestlong` which said `All tests passed`. I rechecked the log file of ptestlong.log, and I confirm that I got `All tests passed`:\n\n```\nRunning doctests with ID 2017-09-14-16-16-01-0e639740.\nGit branch: 23851\nUsing --optional=ccache,cmake,cryptominisat,mpir,pandoc_attributes,pandocfilters,python2,rst2ipynb,sage\nDoctesting entire Sage library.\nSorting sources by runtime so that slower doctests are run first....\nDoctesting 3587 files using 8 threads.\n...\nsage -t --long --warn-long 58.9 src/sage/rings/polynomial/polynomial_quotient_ring.py\n    [448 tests, 3.09 s]\n...\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 1623.2 seconds\n    cpu time: 10208.6 seconds\n    cumulative wall time: 12523.8 seconds\n```",
    "created_at": "2017-09-19T08:31:31Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362467",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:10'></a>
Replying to [slabbe](#comment%3A4):
> I do not know what is happening with the patchbot. The bug is fixed and I get `All tests passed` after running `make ptestlong` on my machine.

I confirm that I get the same errors when run alone:

```
 sage -t src/sage/rings/polynomial/polynomial_quotient_ring.py
```

I am sorry, I do not know what happened with my run of `make ptestlong` which said `All tests passed`. I rechecked the log file of ptestlong.log, and I confirm that I got `All tests passed`:

```
Running doctests with ID 2017-09-14-16-16-01-0e639740.
Git branch: 23851
Using --optional=ccache,cmake,cryptominisat,mpir,pandoc_attributes,pandocfilters,python2,rst2ipynb,sage
Doctesting entire Sage library.
Sorting sources by runtime so that slower doctests are run first....
Doctesting 3587 files using 8 threads.
...
sage -t --long --warn-long 58.9 src/sage/rings/polynomial/polynomial_quotient_ring.py
    [448 tests, 3.09 s]
...
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 1623.2 seconds
    cpu time: 10208.6 seconds
    cumulative wall time: 12523.8 seconds
```



---

archive/issue_comments_362468.json:
```json
{
    "body": "<a id='comment:11'></a>\n\n```\n+        First, we force garbage collection to make the `S`-unit\n+        computations below deterministic::\n```\n\nWhy? Can you add a sentence in this paragraph saying why the computatino of `S`-unit depends on the existence of objects that were not yet collected by the garbage collector?",
    "created_at": "2017-09-19T08:41:48Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362468",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:11'></a>

```
+        First, we force garbage collection to make the `S`-unit
+        computations below deterministic::
```

Why? Can you add a sentence in this paragraph saying why the computatino of `S`-unit depends on the existence of objects that were not yet collected by the garbage collector?



---

archive/issue_comments_362469.json:
```json
{
    "body": "<a id='comment:12'></a>\nI confirm that the last commit fixes the sage -t of `polynomial_quotient_ring.py` when run alone.",
    "created_at": "2017-09-19T08:44:19Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362469",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:12'></a>
I confirm that the last commit fixes the sage -t of `polynomial_quotient_ring.py` when run alone.



---

archive/issue_comments_362470.json:
```json
{
    "body": "<a id='comment:13'></a>\nWhat is apparently happening is that commit bf22de0 (see [comment:2](#comment%3A2)) causes the quadratic field of discriminant -3 to be garbage-collected more often.  This is in principle a good thing, but every time the field is constructed again, the computed generator of the unit group may be different than the previous time.  This also happens if you run\n\n```\nK = nfinit(y^2 + 3); nfbasistoalg(K, nfrootsof1(K)[2])\n```\nseveral times in GP; the result varies randomly between `1/2*y + 1/2` and `-1/2*y + 1/2`, the two roots of unity of order 6.\n\nCommit 55a59ff (see [comment:7](#comment%3A7)) reduces the randomness in the number of times that `K` is constructed.  Experimentally it seems to work; I ran doctests in `polynomial_quotient_ring.py` 128 times with this commit applied and got no failures.  However, I now realise that it may not be entirely watertight and that we should check if there are other points at which `K` may be randomly garbage-collected.  Alternatively, we could construct `K` once at the beginning of the file, keeping it alive by binding it to a name that is not used anywhere else in the file.",
    "created_at": "2017-09-19T09:03:55Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362470",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:13'></a>
What is apparently happening is that commit bf22de0 (see [comment:2](#comment%3A2)) causes the quadratic field of discriminant -3 to be garbage-collected more often.  This is in principle a good thing, but every time the field is constructed again, the computed generator of the unit group may be different than the previous time.  This also happens if you run

```
K = nfinit(y^2 + 3); nfbasistoalg(K, nfrootsof1(K)[2])
```
several times in GP; the result varies randomly between `1/2*y + 1/2` and `-1/2*y + 1/2`, the two roots of unity of order 6.

Commit 55a59ff (see [comment:7](#comment%3A7)) reduces the randomness in the number of times that `K` is constructed.  Experimentally it seems to work; I ran doctests in `polynomial_quotient_ring.py` 128 times with this commit applied and got no failures.  However, I now realise that it may not be entirely watertight and that we should check if there are other points at which `K` may be randomly garbage-collected.  Alternatively, we could construct `K` once at the beginning of the file, keeping it alive by binding it to a name that is not used anywhere else in the file.



---

archive/issue_comments_362471.json:
```json
{
    "body": "<a id='comment:14'></a>\nWith the recent commit, when running `make ptestlong` or when running `sage -t --long` alone on the file, I get problems:\n\n```\n----------------------------------------------------------------------\nsage -t --long --warn-long 58.5 src/sage/rings/polynomial/polynomial_quotient_ring.py  # 9 doctests failed\n----------------------------------------------------------------------\n```\n\nWhen running `sage -t` alone on the file without the option `--long` , I get `All tests passed`:\n\n```\nDoctesting 1 file.\nsage -t --warn-long 32.7 src/sage/rings/polynomial/polynomial_quotient_ring.py\n    [448 tests, 1.81 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\n```\n\nBut the failing tests are not marked with `long time` ... ??? Why are they not failing in the second case?",
    "created_at": "2017-09-19T09:37:47Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362471",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:14'></a>
With the recent commit, when running `make ptestlong` or when running `sage -t --long` alone on the file, I get problems:

```
----------------------------------------------------------------------
sage -t --long --warn-long 58.5 src/sage/rings/polynomial/polynomial_quotient_ring.py  # 9 doctests failed
----------------------------------------------------------------------
```

When running `sage -t` alone on the file without the option `--long` , I get `All tests passed`:

```
Doctesting 1 file.
sage -t --warn-long 32.7 src/sage/rings/polynomial/polynomial_quotient_ring.py
    [448 tests, 1.81 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
```

But the failing tests are not marked with `long time` ... ??? Why are they not failing in the second case?



---

archive/issue_comments_362472.json:
```json
{
    "body": "**Work Issues:** fix random doctest failures",
    "created_at": "2017-09-19T09:49:44Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362472",
    "user": "https://github.com/pjbruin"
}
```

**Work Issues:** fix random doctest failures



---

archive/issue_comments_362473.json:
```json
{
    "body": "<a id='comment:15'></a>\nThis seems to indicate that those tests are still non-deterministic.  We should either make them deterministic again or mark them with `# random` (but then it is harder to notice in case the output actually becomes wrong at some point.)",
    "created_at": "2017-09-19T09:49:44Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362473",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:15'></a>
This seems to indicate that those tests are still non-deterministic.  We should either make them deterministic again or mark them with `# random` (but then it is harder to notice in case the output actually becomes wrong at some point.)



---

archive/issue_events_211945.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2017-09-19T09:49:44Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-211945"
}
```



---

archive/issue_events_211946.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2017-09-19T09:49:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-211946"
}
```



---

archive/issue_comments_362474.json:
```json
{
    "body": "<a id='comment:16'></a>\nThese new changes are just showing that the doctests were fragile to begin with. There's a bunch of things you can do to check the result is correct:\n- look at the norms\n- verify they and their inverses are S-integral (factorize the denominator)\n- hard-code an S-unit basis and check that these occur as a power product of the computed set.\nIt's a pain, but I don't think we really have another option.\n(I guess the answers only differ in some sign choices, so you could just construct the set of all sign choices and check your answer lies in there. That would be a reasonably strict test and will probably take a little longer before it breaks again)\n\nAlso, if you want to prevent the field from being garbage collected, just bind it explicitly to an identifier. That's how users should prevent garbage collections too. That doesn't help the non-deterministic doctests, though it may hide the problem for a while.",
    "created_at": "2017-09-19T11:20:21Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362474",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:16'></a>
These new changes are just showing that the doctests were fragile to begin with. There's a bunch of things you can do to check the result is correct:
- look at the norms
- verify they and their inverses are S-integral (factorize the denominator)
- hard-code an S-unit basis and check that these occur as a power product of the computed set.
It's a pain, but I don't think we really have another option.
(I guess the answers only differ in some sign choices, so you could just construct the set of all sign choices and check your answer lies in there. That would be a reasonably strict test and will probably take a little longer before it breaks again)

Also, if you want to prevent the field from being garbage collected, just bind it explicitly to an identifier. That's how users should prevent garbage collections too. That doesn't help the non-deterministic doctests, though it may hide the problem for a while.



---

archive/issue_comments_362475.json:
```json
{
    "body": "**Changing commit** from \"[55a59ff3da2c50c83c23d5021a127026f811f0cd](https://github.com/sagemath/sagetrac-mirror/commit/55a59ff3da2c50c83c23d5021a127026f811f0cd)\" to \"[dd0594d391a365ff8d6d53c56767178c7d910903](https://github.com/sagemath/sagetrac-mirror/commit/dd0594d391a365ff8d6d53c56767178c7d910903)\".",
    "created_at": "2017-09-20T09:35:29Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362475",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[55a59ff3da2c50c83c23d5021a127026f811f0cd](https://github.com/sagemath/sagetrac-mirror/commit/55a59ff3da2c50c83c23d5021a127026f811f0cd)" to "[dd0594d391a365ff8d6d53c56767178c7d910903](https://github.com/sagemath/sagetrac-mirror/commit/dd0594d391a365ff8d6d53c56767178c7d910903)".



---

archive/issue_comments_362476.json:
```json
{
    "body": "<a id='comment:17'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/dd0594d391a365ff8d6d53c56767178c7d910903\">dd0594d</a></td><td><code>Trac 23851: accept both roots of unity of order 6 in doctests</code></td></tr></table>\n",
    "created_at": "2017-09-20T09:35:29Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362476",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/dd0594d391a365ff8d6d53c56767178c7d910903">dd0594d</a></td><td><code>Trac 23851: accept both roots of unity of order 6 in doctests</code></td></tr></table>




---

archive/issue_comments_362477.json:
```json
{
    "body": "<a id='comment:18'></a>\nThe above commit is a more robust alternative to the `gc.collect()` solution; we now just avoid distinguishing between the two generators for the unit group of `QuadraticField(-3)`.",
    "created_at": "2017-09-20T09:37:31Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362477",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:18'></a>
The above commit is a more robust alternative to the `gc.collect()` solution; we now just avoid distinguishing between the two generators for the unit group of `QuadraticField(-3)`.



---

archive/issue_events_211947.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2017-09-20T09:37:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-211947"
}
```



---

archive/issue_events_211948.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2017-09-20T09:37:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-211948"
}
```



---

archive/issue_comments_362478.json:
```json
{
    "body": "<a id='comment:19'></a>\nDo we really want to delete `@cached_method` on `absolute_field`?",
    "created_at": "2017-11-01T21:24:00Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362478",
    "user": "https://github.com/roed314"
}
```

<a id='comment:19'></a>
Do we really want to delete `@cached_method` on `absolute_field`?



---

archive/issue_comments_362479.json:
```json
{
    "body": "<a id='comment:20'></a>\nReplying to [roed](#comment%3A19):\n> Do we really want to delete `@cached_method` on `absolute_field`?\n\nOne argument for caching a method is when it takes long time to compute which is not the case here:\n\n```\nsage: %time nf = NumberField(x^2-5,'a')\nCPU times: user 1.12 ms, sys: 97 \u00b5s, total: 1.21 ms\nWall time: 962 \u00b5s\nsage: %time nf.absolute_field('b')\nCPU times: user 9 \u00b5s, sys: 1e+03 ns, total: 10 \u00b5s\nWall time: 13.8 \u00b5s\nNumber Field in b with defining polynomial x^2 - 5\n```\n\nIs there another reason why `absolute_field` should be cached?",
    "created_at": "2018-05-01T09:56:20Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362479",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:20'></a>
Replying to [roed](#comment%3A19):
> Do we really want to delete `@cached_method` on `absolute_field`?

One argument for caching a method is when it takes long time to compute which is not the case here:

```
sage: %time nf = NumberField(x^2-5,'a')
CPU times: user 1.12 ms, sys: 97 µs, total: 1.21 ms
Wall time: 962 µs
sage: %time nf.absolute_field('b')
CPU times: user 9 µs, sys: 1e+03 ns, total: 10 µs
Wall time: 13.8 µs
Number Field in b with defining polynomial x^2 - 5
```

Is there another reason why `absolute_field` should be cached?



---

archive/issue_events_211949.json:
```json
{
    "actor": "https://github.com/seblabbe",
    "created_at": "2018-05-01T10:03:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-211949"
}
```



---

archive/issue_events_211950.json:
```json
{
    "actor": "https://github.com/seblabbe",
    "created_at": "2018-05-01T10:03:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-211950"
}
```



---

archive/issue_comments_362480.json:
```json
{
    "body": "**Changing work issues** from \"fix random doctest failures\" to \"\".",
    "created_at": "2018-05-01T10:03:21Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362480",
    "user": "https://github.com/seblabbe"
}
```

**Changing work issues** from "fix random doctest failures" to "".



---

archive/issue_events_211951.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-05-04T05:44:55Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "milestone": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-211951"
}
```



---

archive/issue_events_211952.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-05-04T05:44:55Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "milestone": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-211952"
}
```



---

archive/issue_comments_362481.json:
```json
{
    "body": "<a id='comment:23'></a>\nReplying to [slabbe](#comment%3A20):\n> Replying to [roed](#comment%3A19):\n> > Do we really want to delete `@cached_method` on `absolute_field`?\n\n> \n> One argument for caching a method is when it takes long time to compute which is not the case here:\n> \n> ```\n> sage: %time nf = NumberField(x^2-5,'a')\n> CPU times: user 1.12 ms, sys: 97 \u00b5s, total: 1.21 ms\n> Wall time: 962 \u00b5s\n> sage: %time nf.absolute_field('b')\n> CPU times: user 9 \u00b5s, sys: 1e+03 ns, total: 10 \u00b5s\n> Wall time: 13.8 \u00b5s\n> Number Field in b with defining polynomial x^2 - 5\n> ```\n\nYour timings, on a quadratic field which is already absolute, aren't particularly convincing that this method is always fast.  However, running some other tests on higher degree relative extensions shows that they're quite fast as well.  I'll withdraw my objection to removing the `cached_method`.\n> \n> Is there another reason why `absolute_field` should be cached?",
    "created_at": "2018-05-04T06:00:00Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362481",
    "user": "https://github.com/roed314"
}
```

<a id='comment:23'></a>
Replying to [slabbe](#comment%3A20):
> Replying to [roed](#comment%3A19):
> > Do we really want to delete `@cached_method` on `absolute_field`?

> 
> One argument for caching a method is when it takes long time to compute which is not the case here:
> 
> ```
> sage: %time nf = NumberField(x^2-5,'a')
> CPU times: user 1.12 ms, sys: 97 µs, total: 1.21 ms
> Wall time: 962 µs
> sage: %time nf.absolute_field('b')
> CPU times: user 9 µs, sys: 1e+03 ns, total: 10 µs
> Wall time: 13.8 µs
> Number Field in b with defining polynomial x^2 - 5
> ```

Your timings, on a quadratic field which is already absolute, aren't particularly convincing that this method is always fast.  However, running some other tests on higher degree relative extensions shows that they're quite fast as well.  I'll withdraw my objection to removing the `cached_method`.
> 
> Is there another reason why `absolute_field` should be cached?



---

archive/issue_comments_362482.json:
```json
{
    "body": "<a id='comment:24'></a>\nMerge conflict",
    "created_at": "2018-05-05T22:38:07Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362482",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:24'></a>
Merge conflict



---

archive/issue_events_211953.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-05-05T22:38:07Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-211953"
}
```



---

archive/issue_events_211954.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-05-05T22:38:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-211954"
}
```



---

archive/issue_comments_362483.json:
```json
{
    "body": "<a id='comment:25'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b7e1042ab0f3948aa2416c03ebe7c70701418dc3\">b7e1042</a></td><td><code>Merge branch 'develop' into ticket/23851-memory_leak</code></td></tr></table>\n",
    "created_at": "2018-05-15T12:01:19Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362483",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:25'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b7e1042ab0f3948aa2416c03ebe7c70701418dc3">b7e1042</a></td><td><code>Merge branch 'develop' into ticket/23851-memory_leak</code></td></tr></table>




---

archive/issue_comments_362484.json:
```json
{
    "body": "**Changing commit** from \"[dd0594d391a365ff8d6d53c56767178c7d910903](https://github.com/sagemath/sagetrac-mirror/commit/dd0594d391a365ff8d6d53c56767178c7d910903)\" to \"[b7e1042ab0f3948aa2416c03ebe7c70701418dc3](https://github.com/sagemath/sagetrac-mirror/commit/b7e1042ab0f3948aa2416c03ebe7c70701418dc3)\".",
    "created_at": "2018-05-15T12:01:19Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362484",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[dd0594d391a365ff8d6d53c56767178c7d910903](https://github.com/sagemath/sagetrac-mirror/commit/dd0594d391a365ff8d6d53c56767178c7d910903)" to "[b7e1042ab0f3948aa2416c03ebe7c70701418dc3](https://github.com/sagemath/sagetrac-mirror/commit/b7e1042ab0f3948aa2416c03ebe7c70701418dc3)".



---

archive/issue_events_211955.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2018-05-15T12:02:13Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-211955"
}
```



---

archive/issue_events_211956.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2018-05-15T12:02:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-211956"
}
```



---

archive/issue_comments_362485.json:
```json
{
    "body": "<a id='comment:27'></a>\nI don't really understand the memory leak. If the original code leaks, isn't that a deeper problem with `@cached_method`?",
    "created_at": "2018-05-15T12:07:15Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362485",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:27'></a>
I don't really understand the memory leak. If the original code leaks, isn't that a deeper problem with `@cached_method`?



---

archive/issue_events_211957.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-05-15T12:07:46Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-211957"
}
```



---

archive/issue_events_211958.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-05-15T12:07:46Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "needs info",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-211958"
}
```



---

archive/issue_comments_362486.json:
```json
{
    "body": "<a id='comment:29'></a>\nDoes anybody have an idea? If not, please say so. I'm just asking to know whether it's worth my time to investigate it.",
    "created_at": "2018-05-15T12:57:10Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362486",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:29'></a>
Does anybody have an idea? If not, please say so. I'm just asking to know whether it's worth my time to investigate it.



---

archive/issue_comments_362487.json:
```json
{
    "body": "<a id='comment:30'></a>\nReplying to [jdemeyer](#comment%3A27):\n> I don't really understand the memory leak. If the original code leaks, isn't that a deeper problem with `@cached_method`?\n\nThe leak is caused by the combination of `@cached_method` and `UniqueFactory`; see Nils's explanation in [#23807 comment:14](https://github.com/sagemath/sage/issues/23807#comment:14) and the surrounding discussion, where this bug was found.",
    "created_at": "2018-05-15T13:30:49Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362487",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:30'></a>
Replying to [jdemeyer](#comment%3A27):
> I don't really understand the memory leak. If the original code leaks, isn't that a deeper problem with `@cached_method`?

The leak is caused by the combination of `@cached_method` and `UniqueFactory`; see Nils's explanation in [#23807 comment:14](https://github.com/sagemath/sage/issues/23807#comment:14) and the surrounding discussion, where this bug was found.



---

archive/issue_comments_362488.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -7,6 +7,5 @@\n         10\n         sage: [id(v) for v in gc.get_objects() if id(v) == u]\n ```\n-Fix from 23807:15\n \n-\n+See Nils's explanation in [#23807 comment:14](https://github.com/sagemath/sage/issues/23807#comment:14) and the surrounding discussion, where this bug was found.\n``````\n",
    "created_at": "2018-05-15T13:34:59Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362488",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -7,6 +7,5 @@
         10
         sage: [id(v) for v in gc.get_objects() if id(v) == u]
 ```
-Fix from 23807:15
 
-
+See Nils's explanation in [#23807 comment:14](https://github.com/sagemath/sage/issues/23807#comment:14) and the surrounding discussion, where this bug was found.
``````




---

archive/issue_events_211959.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-05-15T13:37:58Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "needs info",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-211959"
}
```



---

archive/issue_events_211960.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-05-15T13:37:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-211960"
}
```



---

archive/issue_comments_362489.json:
```json
{
    "body": "<a id='comment:32'></a>\nThanks for the pointer! It all makes sense to me now.",
    "created_at": "2018-05-15T13:37:58Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362489",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:32'></a>
Thanks for the pointer! It all makes sense to me now.



---

archive/issue_events_211961.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-05-18T17:04:22Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-211961"
}
```



---

archive/issue_events_211962.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "4dc912cd8c3a3166d100312a07c037c4ade5728d",
    "created_at": "2018-05-18T17:04:22Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-211962"
}
```



---

archive/issue_comments_362490.json:
```json
{
    "body": "**Changing branch** from \"[u/pbruin/23851-memory_leak](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/23851-memory_leak)\" to \"[b7e1042ab0f3948aa2416c03ebe7c70701418dc3](https://github.com/sagemath/sagetrac-mirror/commit/b7e1042ab0f3948aa2416c03ebe7c70701418dc3)\".",
    "created_at": "2018-05-18T17:04:22Z",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-362490",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/pbruin/23851-memory_leak](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/23851-memory_leak)" to "[b7e1042ab0f3948aa2416c03ebe7c70701418dc3](https://github.com/sagemath/sagetrac-mirror/commit/b7e1042ab0f3948aa2416c03ebe7c70701418dc3)".
