# Issue 23851: Fix memoryleak introduced in #11670

archive/issues_023614.json:
```json
{
    "assignees": [],
    "body": "In #11670 the following leak was introduced:\n\n```\n        sage: u=id(NumberField(x^2-5,'a').absolute_field('b'))\n        sage: import gc\n        sage: gc.collect() #random\n        10\n        sage: [id(v) for v in gc.get_objects() if id(v) == u]\n```\n\nSee Nils's explanation in [#23807 comment:14](https://github.com/sagemath/sage/issues/23807#comment:14) and the surrounding discussion, where this bug was found.\n\nComponent: **memleak**\n\nKeywords: **thursdaysbdx**\n\nAuthor: **Nils Bruin, Peter Bruin**\n\nBranch/Commit: **[`b7e1042`](https://github.com/sagemath/sagetrac-mirror/commit/b7e1042ab0f3948aa2416c03ebe7c70701418dc3)**\n\nReviewer: **S\u00e9bastien Labb\u00e9**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/23851_\n\n",
    "closed_at": "2018-05-18T17:04:22Z",
    "created_at": "2017-09-13T22:03:18Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/memleak",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.3",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Fix memoryleak introduced in #11670",
    "type": "issue",
    "updated_at": "2018-05-18T17:04:22Z",
    "url": "https://github.com/sagemath/sage/issues/23851",
    "user": "https://github.com/nbruin"
}
```
In #11670 the following leak was introduced:

```
        sage: u=id(NumberField(x^2-5,'a').absolute_field('b'))
        sage: import gc
        sage: gc.collect() #random
        10
        sage: [id(v) for v in gc.get_objects() if id(v) == u]
```

See Nils's explanation in [#23807 comment:14](https://github.com/sagemath/sage/issues/23807#comment:14) and the surrounding discussion, where this bug was found.

Component: **memleak**

Keywords: **thursdaysbdx**

Author: **Nils Bruin, Peter Bruin**

Branch/Commit: **[`b7e1042`](https://github.com/sagemath/sagetrac-mirror/commit/b7e1042ab0f3948aa2416c03ebe7c70701418dc3)**

Reviewer: **Sébastien Labbé**

_Issue created by migration from https://trac.sagemath.org/ticket/23851_





---

archive/issue_events_328463.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2017-09-13T22:03:18Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "milestone_number": null,
    "milestone_title": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-328463"
}
```



---

archive/issue_events_328464.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2017-09-13T22:03:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-328464"
}
```



---

archive/issue_comments_359825.json:
```json
{
    "body": "Branch: **[u/nbruin/fix_memoryleak_introduced_in__11670](https://github.com/sagemath/sagetrac-mirror/tree/u/nbruin/fix_memoryleak_introduced_in__11670)**",
    "created_at": "2017-09-13T22:05:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359825",
    "user": "https://github.com/nbruin"
}
```

Branch: **[u/nbruin/fix_memoryleak_introduced_in__11670](https://github.com/sagemath/sagetrac-mirror/tree/u/nbruin/fix_memoryleak_introduced_in__11670)**



---

archive/issue_events_328465.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2017-09-13T22:09:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-328465"
}
```



---

archive/issue_comments_359826.json:
```json
{
    "body": "Author: **nbruin, pbruin**",
    "created_at": "2017-09-13T22:09:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359826",
    "user": "https://github.com/nbruin"
}
```

Author: **nbruin, pbruin**



---

archive/issue_events_328466.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2017-09-13T22:09:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "https://github.com/sagemath/sage/labels/memleak",
    "label_color": "d73a4a",
    "label_name": "memleak",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-328466"
}
```



---

archive/issue_comments_359827.json:
```json
{
    "body": "Commit: **[`bf22de0`](https://github.com/sagemath/sagetrac-mirror/commit/bf22de066dacc686296cf17c0f098484dddf1f1e)**",
    "created_at": "2017-09-13T22:09:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359827",
    "user": "https://github.com/nbruin"
}
```

Commit: **[`bf22de0`](https://github.com/sagemath/sagetrac-mirror/commit/bf22de066dacc686296cf17c0f098484dddf1f1e)**



---

archive/issue_comments_359828.json:
```json
{
    "body": "<div id=\"comment:2\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bf22de066dacc686296cf17c0f098484dddf1f1e\"><code>bf22de0</code></a></td><td><code>amend caching of \"absolute_field\" to avoid memory leaks due to \"structure\" storage.</code></td></tr></table>\n",
    "created_at": "2017-09-13T22:09:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359828",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:2"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bf22de066dacc686296cf17c0f098484dddf1f1e"><code>bf22de0</code></a></td><td><code>amend caching of "absolute_field" to avoid memory leaks due to "structure" storage.</code></td></tr></table>




---

archive/issue_events_328467.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2017-09-13T22:09:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-328467"
}
```



---

archive/issue_comments_359829.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,12 @@\n+In #11670 the following leak was introduced:\n \n+```\n+        sage: u=id(NumberField(x^2-5,'a').absolute_field('b'))\n+        sage: import gc\n+        sage: gc.collect() #random\n+        10\n+        sage: [id(v) for v in gc.get_objects() if id(v) == u]\n+```\n+Fix from 23807:15\n+\n+\n``````\n",
    "created_at": "2017-09-13T22:09:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359829",
    "user": "https://github.com/nbruin"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,12 @@
+In #11670 the following leak was introduced:
 
+```
+        sage: u=id(NumberField(x^2-5,'a').absolute_field('b'))
+        sage: import gc
+        sage: gc.collect() #random
+        10
+        sage: [id(v) for v in gc.get_objects() if id(v) == u]
+```
+Fix from 23807:15
+
+
``````




---

archive/issue_comments_359830.json:
```json
{
    "body": "Changed author from **nbruin, pbruin** to **Nils Bruin, Peter Bruin**",
    "created_at": "2017-09-14T06:54:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359830",
    "user": "https://github.com/pjbruin"
}
```

Changed author from **nbruin, pbruin** to **Nils Bruin, Peter Bruin**



---

archive/issue_comments_359831.json:
```json
{
    "body": "Changed branch from **[u/nbruin/fix_memoryleak_introduced_in__11670](https://github.com/sagemath/sagetrac-mirror/tree/u/nbruin/fix_memoryleak_introduced_in__11670)** to **[u/pbruin/23851-memory_leak](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/23851-memory_leak)**",
    "created_at": "2017-09-14T06:54:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359831",
    "user": "https://github.com/pjbruin"
}
```

Changed branch from **[u/nbruin/fix_memoryleak_introduced_in__11670](https://github.com/sagemath/sagetrac-mirror/tree/u/nbruin/fix_memoryleak_introduced_in__11670)** to **[u/pbruin/23851-memory_leak](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/23851-memory_leak)**



---

archive/issue_comments_359832.json:
```json
{
    "body": "Changed commit from **[`bf22de0`](https://github.com/sagemath/sagetrac-mirror/commit/bf22de066dacc686296cf17c0f098484dddf1f1e)** to **[`4568007`](https://github.com/sagemath/sagetrac-mirror/commit/4568007a9d08ccaa744c1f9b1832ea351eb5ccac)**",
    "created_at": "2017-09-14T06:54:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359832",
    "user": "https://github.com/pjbruin"
}
```

Changed commit from **[`bf22de0`](https://github.com/sagemath/sagetrac-mirror/commit/bf22de066dacc686296cf17c0f098484dddf1f1e)** to **[`4568007`](https://github.com/sagemath/sagetrac-mirror/commit/4568007a9d08ccaa744c1f9b1832ea351eb5ccac)**



---

archive/issue_comments_359833.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nCleaned up the docstrings of `absolute_field()` a bit.",
    "created_at": "2017-09-14T06:54:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359833",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:3" align="right">comment:3</div>

Cleaned up the docstrings of `absolute_field()` a bit.



---

archive/issue_comments_359834.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nI do not know what is happening with the patchbot. The bug is fixed and I get `All tests passed` after running `make ptestlong` on my machine.",
    "created_at": "2017-09-14T14:48:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359834",
    "user": "https://github.com/seblabbe"
}
```

<div id="comment:4" align="right">comment:4</div>

I do not know what is happening with the patchbot. The bug is fixed and I get `All tests passed` after running `make ptestlong` on my machine.



---

archive/issue_comments_359835.json:
```json
{
    "body": "Changed keywords from none to **thursdaysbdx**",
    "created_at": "2017-09-14T14:48:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359835",
    "user": "https://github.com/seblabbe"
}
```

Changed keywords from none to **thursdaysbdx**



---

archive/issue_comments_359836.json:
```json
{
    "body": "Reviewer: **S\u00e9bastien Labb\u00e9**",
    "created_at": "2017-09-14T14:48:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359836",
    "user": "https://github.com/seblabbe"
}
```

Reviewer: **Sébastien Labbé**



---

archive/issue_events_328468.json:
```json
{
    "actor": "https://github.com/seblabbe",
    "created_at": "2017-09-14T14:48:59Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-328468"
}
```



---

archive/issue_events_328469.json:
```json
{
    "actor": "https://github.com/seblabbe",
    "created_at": "2017-09-14T14:48:59Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-328469"
}
```



---

archive/issue_events_328470.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-09-17T18:12:19Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-328470"
}
```



---

archive/issue_events_328471.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-09-17T18:12:19Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-328471"
}
```



---

archive/issue_comments_359837.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nI'm getting this on various buildbots:\n\n```\nFile \"src/sage/rings/polynomial/polynomial_quotient_ring.py\", line 1389, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units\nFailed example:\n    u,o = K.S_units([])[0]; u, o\nExpected:\n    (-1/2*a + 1/2, 6)\nGot:\n    (1/2*a + 1/2, 6)\n**********************************************************************\nFile \"src/sage/rings/polynomial/polynomial_quotient_ring.py\", line 1395, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units\nFailed example:\n    u^2\nExpected:\n    -1/2*a - 1/2\nGot:\n    1/2*a - 1/2\n**********************************************************************\nFile \"src/sage/rings/polynomial/polynomial_quotient_ring.py\", line 1404, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units\nFailed example:\n    L.S_units([])\nExpected:\n    [(-1/2*a + 1/2, 6),\n     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),\n     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]\nGot:\n    [(1/2*a + 1/2, 6),\n     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),\n     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]\n**********************************************************************\nFile \"src/sage/rings/polynomial/polynomial_quotient_ring.py\", line 1408, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units\nFailed example:\n    L.S_units([K.ideal(1/2*a - 3/2)])\nExpected:\n    [((-1/6*a - 1/2)*b^2 + (1/3*a - 1)*b + 4/3*a, +Infinity),\n     (-1/2*a + 1/2, 6),\n     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),\n     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]\nGot:\n    [((-1/6*a - 1/2)*b^2 + (1/3*a - 1)*b + 4/3*a, +Infinity),\n     (1/2*a + 1/2, 6),\n     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),\n     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]\n**********************************************************************\nFile \"src/sage/rings/polynomial/polynomial_quotient_ring.py\", line 1413, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units\nFailed example:\n    L.S_units([K.ideal(2)])\nExpected:\n    [((1/2*a - 1/2)*b^2 + (a + 1)*b + 3, +Infinity),\n     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a + 1/2, +Infinity),\n     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a - 1/2, +Infinity),\n     (-1/2*a + 1/2, 6),\n     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),\n     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]\nGot:\n    [((1/2*a - 1/2)*b^2 + (a + 1)*b + 3, +Infinity),\n     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a + 1/2, +Infinity),\n     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a - 1/2, +Infinity),\n     (1/2*a + 1/2, 6),\n     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),\n     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]\n**********************************************************************\nFile \"src/sage/rings/polynomial/polynomial_quotient_ring.py\", line 1476, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units\nFailed example:\n    u = K.units()[0][0]; u\nExpected:\n    -1/2*a + 1/2\nGot:\n    1/2*a + 1/2\n**********************************************************************\nFile \"src/sage/rings/polynomial/polynomial_quotient_ring.py\", line 1482, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units\nFailed example:\n    u^2\nExpected:\n    -1/2*a - 1/2\nGot:\n    1/2*a - 1/2\n**********************************************************************\nFile \"src/sage/rings/polynomial/polynomial_quotient_ring.py\", line 1494, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units\nFailed example:\n    L.units()\nExpected:\n    [(-1/2*a + 1/2, 6),\n     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),\n     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]\nGot:\n    [(1/2*a + 1/2, 6),\n     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),\n     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]\n**********************************************************************\nFile \"src/sage/rings/polynomial/polynomial_quotient_ring.py\", line 1503, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units\nFailed example:\n    L.unit_group().gens_values()\nExpected:\n    [1/2*a + 1/2, (-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, 2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2]\nGot:\n    [-1/2*a + 1/2, (-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, 2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2]\n**********************************************************************\n2 items had failures:\n   5 of  18 in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units\n   4 of  23 in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units\n    [448 tests, 9 failures, 6.99 s]\n```",
    "created_at": "2017-09-17T18:12:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359837",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:5" align="right">comment:5</div>

I'm getting this on various buildbots:

```
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1389, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units
Failed example:
    u,o = K.S_units([])[0]; u, o
Expected:
    (-1/2*a + 1/2, 6)
Got:
    (1/2*a + 1/2, 6)
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1395, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units
Failed example:
    u^2
Expected:
    -1/2*a - 1/2
Got:
    1/2*a - 1/2
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1404, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units
Failed example:
    L.S_units([])
Expected:
    [(-1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
Got:
    [(1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1408, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units
Failed example:
    L.S_units([K.ideal(1/2*a - 3/2)])
Expected:
    [((-1/6*a - 1/2)*b^2 + (1/3*a - 1)*b + 4/3*a, +Infinity),
     (-1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
Got:
    [((-1/6*a - 1/2)*b^2 + (1/3*a - 1)*b + 4/3*a, +Infinity),
     (1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1413, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units
Failed example:
    L.S_units([K.ideal(2)])
Expected:
    [((1/2*a - 1/2)*b^2 + (a + 1)*b + 3, +Infinity),
     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a + 1/2, +Infinity),
     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a - 1/2, +Infinity),
     (-1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
Got:
    [((1/2*a - 1/2)*b^2 + (a + 1)*b + 3, +Infinity),
     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a + 1/2, +Infinity),
     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a - 1/2, +Infinity),
     (1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1476, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units
Failed example:
    u = K.units()[0][0]; u
Expected:
    -1/2*a + 1/2
Got:
    1/2*a + 1/2
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1482, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units
Failed example:
    u^2
Expected:
    -1/2*a - 1/2
Got:
    1/2*a - 1/2
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1494, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units
Failed example:
    L.units()
Expected:
    [(-1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
Got:
    [(1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1503, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units
Failed example:
    L.unit_group().gens_values()
Expected:
    [1/2*a + 1/2, (-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, 2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2]
Got:
    [-1/2*a + 1/2, (-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, 2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2]
**********************************************************************
2 items had failures:
   5 of  18 in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units
   4 of  23 in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units
    [448 tests, 9 failures, 6.99 s]
```



---

archive/issue_comments_359838.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nWith the following change (which is probably a bad idea) I consistently get the same doctest failures as above:\n\n```diff\n--- a/src/sage/rings/polynomial/polynomial_quotient_ring.py\n+++ b/src/sage/rings/polynomial/polynomial_quotient_ring.py\n@@ -1050,7 +1050,6 @@ class PolynomialQuotientRing_generic(CommutativeRing):\n         return self(self.polynomial_ring().random_element( \\\n             degree=self.degree()-1, *args, **kwds))\n \n-    @cached_method\n     def _S_decomposition(self, S):\n         \"\"\"\n         Compute the decomposition of self into a product of number fields.\n```",
    "created_at": "2017-09-18T12:12:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359838",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:6" align="right">comment:6</div>

With the following change (which is probably a bad idea) I consistently get the same doctest failures as above:

```diff
--- a/src/sage/rings/polynomial/polynomial_quotient_ring.py
+++ b/src/sage/rings/polynomial/polynomial_quotient_ring.py
@@ -1050,7 +1050,6 @@ class PolynomialQuotientRing_generic(CommutativeRing):
         return self(self.polynomial_ring().random_element( \
             degree=self.degree()-1, *args, **kwds))
 
-    @cached_method
     def _S_decomposition(self, S):
         """
         Compute the decomposition of self into a product of number fields.
```



---

archive/issue_comments_359839.json:
```json
{
    "body": "Changed commit from **[`4568007`](https://github.com/sagemath/sagetrac-mirror/commit/4568007a9d08ccaa744c1f9b1832ea351eb5ccac)** to **[`55a59ff`](https://github.com/sagemath/sagetrac-mirror/commit/55a59ff3da2c50c83c23d5021a127026f811f0cd)**",
    "created_at": "2017-09-19T07:35:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359839",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`4568007`](https://github.com/sagemath/sagetrac-mirror/commit/4568007a9d08ccaa744c1f9b1832ea351eb5ccac)** to **[`55a59ff`](https://github.com/sagemath/sagetrac-mirror/commit/55a59ff3da2c50c83c23d5021a127026f811f0cd)**



---

archive/issue_comments_359840.json:
```json
{
    "body": "<div id=\"comment:7\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/55a59ff3da2c50c83c23d5021a127026f811f0cd\"><code>55a59ff</code></a></td><td><code>Trac 23851: force garbage collection to make S-unit computations deterministic</code></td></tr></table>\n",
    "created_at": "2017-09-19T07:35:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359840",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:7"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/55a59ff3da2c50c83c23d5021a127026f811f0cd"><code>55a59ff</code></a></td><td><code>Trac 23851: force garbage collection to make S-unit computations deterministic</code></td></tr></table>




---

archive/issue_comments_359841.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nThe above commit appears to make the computation deterministic again.  Let's see if the patchbot agrees.",
    "created_at": "2017-09-19T07:36:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359841",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:8" align="right">comment:8</div>

The above commit appears to make the computation deterministic again.  Let's see if the patchbot agrees.



---

archive/issue_events_328472.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2017-09-19T07:36:42Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-328472"
}
```



---

archive/issue_events_328473.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2017-09-19T07:36:42Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-328473"
}
```



---

archive/issue_comments_359842.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@seblabbe](#comment%3A4):\n> I do not know what is happening with the patchbot. The bug is fixed and I get `All tests passed` after running `make ptestlong` on my machine.\n\nI confirm that I get the same errors when run alone:\n\n```\n sage -t src/sage/rings/polynomial/polynomial_quotient_ring.py\n```\n\nI am sorry, I do not know what happened with my run of `make ptestlong` which said `All tests passed`. I rechecked the log file of ptestlong.log, and I confirm that I got `All tests passed`:\n\n```\nRunning doctests with ID 2017-09-14-16-16-01-0e639740.\nGit branch: 23851\nUsing --optional=ccache,cmake,cryptominisat,mpir,pandoc_attributes,pandocfilters,python2,rst2ipynb,sage\nDoctesting entire Sage library.\nSorting sources by runtime so that slower doctests are run first....\nDoctesting 3587 files using 8 threads.\n...\nsage -t --long --warn-long 58.9 src/sage/rings/polynomial/polynomial_quotient_ring.py\n    [448 tests, 3.09 s]\n...\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 1623.2 seconds\n    cpu time: 10208.6 seconds\n    cumulative wall time: 12523.8 seconds\n```",
    "created_at": "2017-09-19T08:31:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359842",
    "user": "https://github.com/seblabbe"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@seblabbe](#comment%3A4):
> I do not know what is happening with the patchbot. The bug is fixed and I get `All tests passed` after running `make ptestlong` on my machine.

I confirm that I get the same errors when run alone:

```
 sage -t src/sage/rings/polynomial/polynomial_quotient_ring.py
```

I am sorry, I do not know what happened with my run of `make ptestlong` which said `All tests passed`. I rechecked the log file of ptestlong.log, and I confirm that I got `All tests passed`:

```
Running doctests with ID 2017-09-14-16-16-01-0e639740.
Git branch: 23851
Using --optional=ccache,cmake,cryptominisat,mpir,pandoc_attributes,pandocfilters,python2,rst2ipynb,sage
Doctesting entire Sage library.
Sorting sources by runtime so that slower doctests are run first....
Doctesting 3587 files using 8 threads.
...
sage -t --long --warn-long 58.9 src/sage/rings/polynomial/polynomial_quotient_ring.py
    [448 tests, 3.09 s]
...
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 1623.2 seconds
    cpu time: 10208.6 seconds
    cumulative wall time: 12523.8 seconds
```



---

archive/issue_comments_359843.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\n\n```\n+        First, we force garbage collection to make the `S`-unit\n+        computations below deterministic::\n```\n\nWhy? Can you add a sentence in this paragraph saying why the computatino of `S`-unit depends on the existence of objects that were not yet collected by the garbage collector?",
    "created_at": "2017-09-19T08:41:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359843",
    "user": "https://github.com/seblabbe"
}
```

<div id="comment:11" align="right">comment:11</div>


```
+        First, we force garbage collection to make the `S`-unit
+        computations below deterministic::
```

Why? Can you add a sentence in this paragraph saying why the computatino of `S`-unit depends on the existence of objects that were not yet collected by the garbage collector?



---

archive/issue_comments_359844.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nI confirm that the last commit fixes the sage -t of `polynomial_quotient_ring.py` when run alone.",
    "created_at": "2017-09-19T08:44:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359844",
    "user": "https://github.com/seblabbe"
}
```

<div id="comment:12" align="right">comment:12</div>

I confirm that the last commit fixes the sage -t of `polynomial_quotient_ring.py` when run alone.



---

archive/issue_comments_359845.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nWhat is apparently happening is that commit bf22de0 (see [comment:2](#comment%3A2)) causes the quadratic field of discriminant -3 to be garbage-collected more often.  This is in principle a good thing, but every time the field is constructed again, the computed generator of the unit group may be different than the previous time.  This also happens if you run\n\n```\nK = nfinit(y^2 + 3); nfbasistoalg(K, nfrootsof1(K)[2])\n```\nseveral times in GP; the result varies randomly between `1/2*y + 1/2` and `-1/2*y + 1/2`, the two roots of unity of order 6.\n\nCommit 55a59ff (see [comment:7](#comment%3A7)) reduces the randomness in the number of times that `K` is constructed.  Experimentally it seems to work; I ran doctests in `polynomial_quotient_ring.py` 128 times with this commit applied and got no failures.  However, I now realise that it may not be entirely watertight and that we should check if there are other points at which `K` may be randomly garbage-collected.  Alternatively, we could construct `K` once at the beginning of the file, keeping it alive by binding it to a name that is not used anywhere else in the file.",
    "created_at": "2017-09-19T09:03:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359845",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:13" align="right">comment:13</div>

What is apparently happening is that commit bf22de0 (see [comment:2](#comment%3A2)) causes the quadratic field of discriminant -3 to be garbage-collected more often.  This is in principle a good thing, but every time the field is constructed again, the computed generator of the unit group may be different than the previous time.  This also happens if you run

```
K = nfinit(y^2 + 3); nfbasistoalg(K, nfrootsof1(K)[2])
```
several times in GP; the result varies randomly between `1/2*y + 1/2` and `-1/2*y + 1/2`, the two roots of unity of order 6.

Commit 55a59ff (see [comment:7](#comment%3A7)) reduces the randomness in the number of times that `K` is constructed.  Experimentally it seems to work; I ran doctests in `polynomial_quotient_ring.py` 128 times with this commit applied and got no failures.  However, I now realise that it may not be entirely watertight and that we should check if there are other points at which `K` may be randomly garbage-collected.  Alternatively, we could construct `K` once at the beginning of the file, keeping it alive by binding it to a name that is not used anywhere else in the file.



---

archive/issue_comments_359846.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nWith the recent commit, when running `make ptestlong` or when running `sage -t --long` alone on the file, I get problems:\n\n```\n----------------------------------------------------------------------\nsage -t --long --warn-long 58.5 src/sage/rings/polynomial/polynomial_quotient_ring.py  # 9 doctests failed\n----------------------------------------------------------------------\n```\n\nWhen running `sage -t` alone on the file without the option `--long` , I get `All tests passed`:\n\n```\nDoctesting 1 file.\nsage -t --warn-long 32.7 src/sage/rings/polynomial/polynomial_quotient_ring.py\n    [448 tests, 1.81 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\n```\n\nBut the failing tests are not marked with `long time` ... ??? Why are they not failing in the second case?",
    "created_at": "2017-09-19T09:37:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359846",
    "user": "https://github.com/seblabbe"
}
```

<div id="comment:14" align="right">comment:14</div>

With the recent commit, when running `make ptestlong` or when running `sage -t --long` alone on the file, I get problems:

```
----------------------------------------------------------------------
sage -t --long --warn-long 58.5 src/sage/rings/polynomial/polynomial_quotient_ring.py  # 9 doctests failed
----------------------------------------------------------------------
```

When running `sage -t` alone on the file without the option `--long` , I get `All tests passed`:

```
Doctesting 1 file.
sage -t --warn-long 32.7 src/sage/rings/polynomial/polynomial_quotient_ring.py
    [448 tests, 1.81 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
```

But the failing tests are not marked with `long time` ... ??? Why are they not failing in the second case?



---

archive/issue_comments_359847.json:
```json
{
    "body": "Work Issues: **fix random doctest failures**",
    "created_at": "2017-09-19T09:49:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359847",
    "user": "https://github.com/pjbruin"
}
```

Work Issues: **fix random doctest failures**



---

archive/issue_comments_359848.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nThis seems to indicate that those tests are still non-deterministic.  We should either make them deterministic again or mark them with `# random` (but then it is harder to notice in case the output actually becomes wrong at some point.)",
    "created_at": "2017-09-19T09:49:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359848",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:15" align="right">comment:15</div>

This seems to indicate that those tests are still non-deterministic.  We should either make them deterministic again or mark them with `# random` (but then it is harder to notice in case the output actually becomes wrong at some point.)



---

archive/issue_events_328474.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2017-09-19T09:49:44Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-328474"
}
```



---

archive/issue_events_328475.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2017-09-19T09:49:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-328475"
}
```



---

archive/issue_comments_359849.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nThese new changes are just showing that the doctests were fragile to begin with. There's a bunch of things you can do to check the result is correct:\n- look at the norms\n- verify they and their inverses are S-integral (factorize the denominator)\n- hard-code an S-unit basis and check that these occur as a power product of the computed set.\nIt's a pain, but I don't think we really have another option.\n(I guess the answers only differ in some sign choices, so you could just construct the set of all sign choices and check your answer lies in there. That would be a reasonably strict test and will probably take a little longer before it breaks again)\n\nAlso, if you want to prevent the field from being garbage collected, just bind it explicitly to an identifier. That's how users should prevent garbage collections too. That doesn't help the non-deterministic doctests, though it may hide the problem for a while.",
    "created_at": "2017-09-19T11:20:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359849",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:16" align="right">comment:16</div>

These new changes are just showing that the doctests were fragile to begin with. There's a bunch of things you can do to check the result is correct:
- look at the norms
- verify they and their inverses are S-integral (factorize the denominator)
- hard-code an S-unit basis and check that these occur as a power product of the computed set.
It's a pain, but I don't think we really have another option.
(I guess the answers only differ in some sign choices, so you could just construct the set of all sign choices and check your answer lies in there. That would be a reasonably strict test and will probably take a little longer before it breaks again)

Also, if you want to prevent the field from being garbage collected, just bind it explicitly to an identifier. That's how users should prevent garbage collections too. That doesn't help the non-deterministic doctests, though it may hide the problem for a while.



---

archive/issue_comments_359850.json:
```json
{
    "body": "Changed commit from **[`55a59ff`](https://github.com/sagemath/sagetrac-mirror/commit/55a59ff3da2c50c83c23d5021a127026f811f0cd)** to **[`dd0594d`](https://github.com/sagemath/sagetrac-mirror/commit/dd0594d391a365ff8d6d53c56767178c7d910903)**",
    "created_at": "2017-09-20T09:35:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359850",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`55a59ff`](https://github.com/sagemath/sagetrac-mirror/commit/55a59ff3da2c50c83c23d5021a127026f811f0cd)** to **[`dd0594d`](https://github.com/sagemath/sagetrac-mirror/commit/dd0594d391a365ff8d6d53c56767178c7d910903)**



---

archive/issue_comments_359851.json:
```json
{
    "body": "<div id=\"comment:17\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/dd0594d391a365ff8d6d53c56767178c7d910903\"><code>dd0594d</code></a></td><td><code>Trac 23851: accept both roots of unity of order 6 in doctests</code></td></tr></table>\n",
    "created_at": "2017-09-20T09:35:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359851",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:17"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/dd0594d391a365ff8d6d53c56767178c7d910903"><code>dd0594d</code></a></td><td><code>Trac 23851: accept both roots of unity of order 6 in doctests</code></td></tr></table>




---

archive/issue_comments_359852.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nThe above commit is a more robust alternative to the `gc.collect()` solution; we now just avoid distinguishing between the two generators for the unit group of `QuadraticField(-3)`.",
    "created_at": "2017-09-20T09:37:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359852",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:18" align="right">comment:18</div>

The above commit is a more robust alternative to the `gc.collect()` solution; we now just avoid distinguishing between the two generators for the unit group of `QuadraticField(-3)`.



---

archive/issue_events_328476.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2017-09-20T09:37:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-328476"
}
```



---

archive/issue_events_328477.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2017-09-20T09:37:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-328477"
}
```



---

archive/issue_comments_359853.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nDo we really want to delete `@cached_method` on `absolute_field`?",
    "created_at": "2017-11-01T21:24:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359853",
    "user": "https://github.com/roed314"
}
```

<div id="comment:19" align="right">comment:19</div>

Do we really want to delete `@cached_method` on `absolute_field`?



---

archive/issue_comments_359854.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [@roed314](#comment%3A19):\n> Do we really want to delete `@cached_method` on `absolute_field`?\n\nOne argument for caching a method is when it takes long time to compute which is not the case here:\n\n```\nsage: %time nf = NumberField(x^2-5,'a')\nCPU times: user 1.12 ms, sys: 97 \u00b5s, total: 1.21 ms\nWall time: 962 \u00b5s\nsage: %time nf.absolute_field('b')\nCPU times: user 9 \u00b5s, sys: 1e+03 ns, total: 10 \u00b5s\nWall time: 13.8 \u00b5s\nNumber Field in b with defining polynomial x^2 - 5\n```\n\nIs there another reason why `absolute_field` should be cached?",
    "created_at": "2018-05-01T09:56:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359854",
    "user": "https://github.com/seblabbe"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [@roed314](#comment%3A19):
> Do we really want to delete `@cached_method` on `absolute_field`?

One argument for caching a method is when it takes long time to compute which is not the case here:

```
sage: %time nf = NumberField(x^2-5,'a')
CPU times: user 1.12 ms, sys: 97 µs, total: 1.21 ms
Wall time: 962 µs
sage: %time nf.absolute_field('b')
CPU times: user 9 µs, sys: 1e+03 ns, total: 10 µs
Wall time: 13.8 µs
Number Field in b with defining polynomial x^2 - 5
```

Is there another reason why `absolute_field` should be cached?



---

archive/issue_events_328478.json:
```json
{
    "actor": "https://github.com/seblabbe",
    "created_at": "2018-05-01T10:03:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-328478"
}
```



---

archive/issue_events_328479.json:
```json
{
    "actor": "https://github.com/seblabbe",
    "created_at": "2018-05-01T10:03:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-328479"
}
```



---

archive/issue_comments_359855.json:
```json
{
    "body": "Changed work issues from **fix random doctest failures** to none",
    "created_at": "2018-05-01T10:03:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359855",
    "user": "https://github.com/seblabbe"
}
```

Changed work issues from **fix random doctest failures** to none



---

archive/issue_events_328480.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-05-04T05:44:55Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "milestone_number": null,
    "milestone_title": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-328480"
}
```



---

archive/issue_events_328481.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-05-04T05:44:55Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "milestone_number": null,
    "milestone_title": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-328481"
}
```



---

archive/issue_comments_359856.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nReplying to [@seblabbe](#comment%3A20):\n> Replying to [@roed314](#comment%3A19):\n> > Do we really want to delete `@cached_method` on `absolute_field`?\n\n> \n> One argument for caching a method is when it takes long time to compute which is not the case here:\n> \n> ```\n> sage: %time nf = NumberField(x^2-5,'a')\n> CPU times: user 1.12 ms, sys: 97 \u00b5s, total: 1.21 ms\n> Wall time: 962 \u00b5s\n> sage: %time nf.absolute_field('b')\n> CPU times: user 9 \u00b5s, sys: 1e+03 ns, total: 10 \u00b5s\n> Wall time: 13.8 \u00b5s\n> Number Field in b with defining polynomial x^2 - 5\n> ```\n\nYour timings, on a quadratic field which is already absolute, aren't particularly convincing that this method is always fast.  However, running some other tests on higher degree relative extensions shows that they're quite fast as well.  I'll withdraw my objection to removing the `cached_method`.\n> \n> Is there another reason why `absolute_field` should be cached?",
    "created_at": "2018-05-04T06:00:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359856",
    "user": "https://github.com/roed314"
}
```

<div id="comment:23" align="right">comment:23</div>

Replying to [@seblabbe](#comment%3A20):
> Replying to [@roed314](#comment%3A19):
> > Do we really want to delete `@cached_method` on `absolute_field`?

> 
> One argument for caching a method is when it takes long time to compute which is not the case here:
> 
> ```
> sage: %time nf = NumberField(x^2-5,'a')
> CPU times: user 1.12 ms, sys: 97 µs, total: 1.21 ms
> Wall time: 962 µs
> sage: %time nf.absolute_field('b')
> CPU times: user 9 µs, sys: 1e+03 ns, total: 10 µs
> Wall time: 13.8 µs
> Number Field in b with defining polynomial x^2 - 5
> ```

Your timings, on a quadratic field which is already absolute, aren't particularly convincing that this method is always fast.  However, running some other tests on higher degree relative extensions shows that they're quite fast as well.  I'll withdraw my objection to removing the `cached_method`.
> 
> Is there another reason why `absolute_field` should be cached?



---

archive/issue_comments_359857.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nMerge conflict",
    "created_at": "2018-05-05T22:38:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359857",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:24" align="right">comment:24</div>

Merge conflict



---

archive/issue_events_328482.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-05-05T22:38:07Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-328482"
}
```



---

archive/issue_events_328483.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-05-05T22:38:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-328483"
}
```



---

archive/issue_comments_359858.json:
```json
{
    "body": "<div id=\"comment:25\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b7e1042ab0f3948aa2416c03ebe7c70701418dc3\"><code>b7e1042</code></a></td><td><code>Merge branch 'develop' into ticket/23851-memory_leak</code></td></tr></table>\n",
    "created_at": "2018-05-15T12:01:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359858",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:25"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b7e1042ab0f3948aa2416c03ebe7c70701418dc3"><code>b7e1042</code></a></td><td><code>Merge branch 'develop' into ticket/23851-memory_leak</code></td></tr></table>




---

archive/issue_comments_359859.json:
```json
{
    "body": "Changed commit from **[`dd0594d`](https://github.com/sagemath/sagetrac-mirror/commit/dd0594d391a365ff8d6d53c56767178c7d910903)** to **[`b7e1042`](https://github.com/sagemath/sagetrac-mirror/commit/b7e1042ab0f3948aa2416c03ebe7c70701418dc3)**",
    "created_at": "2018-05-15T12:01:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359859",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`dd0594d`](https://github.com/sagemath/sagetrac-mirror/commit/dd0594d391a365ff8d6d53c56767178c7d910903)** to **[`b7e1042`](https://github.com/sagemath/sagetrac-mirror/commit/b7e1042ab0f3948aa2416c03ebe7c70701418dc3)**



---

archive/issue_events_328484.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2018-05-15T12:02:13Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-328484"
}
```



---

archive/issue_events_328485.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2018-05-15T12:02:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-328485"
}
```



---

archive/issue_comments_359860.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nI don't really understand the memory leak. If the original code leaks, isn't that a deeper problem with `@cached_method`?",
    "created_at": "2018-05-15T12:07:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359860",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:27" align="right">comment:27</div>

I don't really understand the memory leak. If the original code leaks, isn't that a deeper problem with `@cached_method`?



---

archive/issue_events_328486.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-05-15T12:07:46Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-328486"
}
```



---

archive/issue_events_328487.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-05-15T12:07:46Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-328487"
}
```



---

archive/issue_comments_359861.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nDoes anybody have an idea? If not, please say so. I'm just asking to know whether it's worth my time to investigate it.",
    "created_at": "2018-05-15T12:57:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359861",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:29" align="right">comment:29</div>

Does anybody have an idea? If not, please say so. I'm just asking to know whether it's worth my time to investigate it.



---

archive/issue_comments_359862.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nReplying to [@jdemeyer](#comment%3A27):\n> I don't really understand the memory leak. If the original code leaks, isn't that a deeper problem with `@cached_method`?\n\nThe leak is caused by the combination of `@cached_method` and `UniqueFactory`; see Nils's explanation in [#23807 comment:14](https://github.com/sagemath/sage/issues/23807#comment:14) and the surrounding discussion, where this bug was found.",
    "created_at": "2018-05-15T13:30:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359862",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:30" align="right">comment:30</div>

Replying to [@jdemeyer](#comment%3A27):
> I don't really understand the memory leak. If the original code leaks, isn't that a deeper problem with `@cached_method`?

The leak is caused by the combination of `@cached_method` and `UniqueFactory`; see Nils's explanation in [#23807 comment:14](https://github.com/sagemath/sage/issues/23807#comment:14) and the surrounding discussion, where this bug was found.



---

archive/issue_comments_359863.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -7,6 +7,5 @@\n         10\n         sage: [id(v) for v in gc.get_objects() if id(v) == u]\n ```\n-Fix from 23807:15\n \n-\n+See Nils's explanation in [#23807 comment:14](https://github.com/sagemath/sage/issues/23807#comment:14) and the surrounding discussion, where this bug was found.\n``````\n",
    "created_at": "2018-05-15T13:34:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359863",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -7,6 +7,5 @@
         10
         sage: [id(v) for v in gc.get_objects() if id(v) == u]
 ```
-Fix from 23807:15
 
-
+See Nils's explanation in [#23807 comment:14](https://github.com/sagemath/sage/issues/23807#comment:14) and the surrounding discussion, where this bug was found.
``````




---

archive/issue_events_328488.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-05-15T13:37:58Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-328488"
}
```



---

archive/issue_events_328489.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-05-15T13:37:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-328489"
}
```



---

archive/issue_comments_359864.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nThanks for the pointer! It all makes sense to me now.",
    "created_at": "2018-05-15T13:37:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359864",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:32" align="right">comment:32</div>

Thanks for the pointer! It all makes sense to me now.



---

archive/issue_events_328490.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-05-18T17:04:22Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-328490"
}
```



---

archive/issue_events_328491.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "4dc912cd8c3a3166d100312a07c037c4ade5728d",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2018-05-18T17:04:22Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23851#event-328491"
}
```



---

archive/issue_comments_359865.json:
```json
{
    "body": "Changed branch from **[u/pbruin/23851-memory_leak](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/23851-memory_leak)** to **[`b7e1042`](https://github.com/sagemath/sagetrac-mirror/commit/b7e1042ab0f3948aa2416c03ebe7c70701418dc3)**",
    "created_at": "2018-05-18T17:04:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23851#issuecomment-359865",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/pbruin/23851-memory_leak](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/23851-memory_leak)** to **[`b7e1042`](https://github.com/sagemath/sagetrac-mirror/commit/b7e1042ab0f3948aa2416c03ebe7c70701418dc3)**
