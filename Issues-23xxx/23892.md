# Issue 23892: Run doctests with OMP_NUM_THREADS=2

archive/issues_023655.json:
```json
{
    "assignees": [],
    "body": "The `normaliz` package uses OMP for threading, which can create many threads. In doctests, this is bad for two reasons:\n\n1. Doctests should not use an unexpectedly large number of system resources.\n\n2. When there are too many threads, the virtual memory limit from #23748 will be hit.\n\nThere is a solution: set the environment variable `OMP_NUM_THREADS=2` while doctesting.\n\nCC:  @koffie\n\nBranch: **[`9f9f7b7`](https://github.com/sagemath/sagetrac-mirror/commit/9f9f7b71f56c1c7ac20ed8601355ef495bf42fa3)**\n\nReviewer: **Maarten Derickx**\n\nAuthor: **Jeroen Demeyer**\n\nComponent: **packages: optional**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/23892_\n\n",
    "closed_at": "2017-10-01T00:19:15Z",
    "created_at": "2017-09-19T10:58:06Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20packages%3A%20optional",
        "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.1",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Run doctests with OMP_NUM_THREADS=2",
    "type": "issue",
    "updated_at": "2017-10-05T16:55:51Z",
    "url": "https://github.com/sagemath/sage/issues/23892",
    "user": "https://github.com/jdemeyer"
}
```
The `normaliz` package uses OMP for threading, which can create many threads. In doctests, this is bad for two reasons:

1. Doctests should not use an unexpectedly large number of system resources.

2. When there are too many threads, the virtual memory limit from #23748 will be hit.

There is a solution: set the environment variable `OMP_NUM_THREADS=2` while doctesting.

CC:  @koffie

Branch: **[`9f9f7b7`](https://github.com/sagemath/sagetrac-mirror/commit/9f9f7b71f56c1c7ac20ed8601355ef495bf42fa3)**

Reviewer: **Maarten Derickx**

Author: **Jeroen Demeyer**

Component: **packages: optional**

_Issue created by migration from https://trac.sagemath.org/ticket/23892_





---

archive/issue_events_331809.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-09-19T10:58:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "milestone_number": null,
    "milestone_title": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23892#event-331809"
}
```



---

archive/issue_events_331810.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-09-19T10:58:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20packages%3A%20optional",
    "label_color": "000080",
    "label_name": "c: packages: optional",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23892#event-331810"
}
```



---

archive/issue_events_331811.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-09-19T10:58:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "label": "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p: 1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23892#event-331811"
}
```



---

archive/issue_events_331812.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-09-19T10:58:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23892#event-331812"
}
```



---

archive/issue_comments_360580.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nAgain??? :(",
    "created_at": "2017-09-19T11:20:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23892#issuecomment-360580",
    "user": "https://github.com/koffie"
}
```

<div id="comment:1" align="right">comment:1</div>

Again??? :(



---

archive/issue_comments_360581.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,33 @@\n-Details to follow...\n+\n+```\n+sage -t --long --warn-long 63.7 src/sage/graphs/generic_graph.py  # Killed due to segmentation fault\n+sage -t --long --warn-long 63.7 src/sage/crypto/mq/sr.py  # Killed due to abort\n+sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/tensor_product_kr_tableaux.py  # Bad exit: 1\n+sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/rigged_configurations.py  # Bad exit: 127\n+sage -t --long --warn-long 63.7 src/sage/rings/integer.pyx  # 1 doctest failed\n+sage -t --long --warn-long 63.7 src/sage/combinat/crystals/kirillov_reshetikhin.py  # Bad exit: 1\n+sage -t --long --warn-long 63.7 src/sage/structure/sage_object.pyx  # Killed due to abort\n+sage -t --long --warn-long 63.7 src/sage/rings/polynomial/multi_polynomial_sequence.py  # Killed due to abort\n+sage -t --long --warn-long 63.7 src/sage/rings/polynomial/pbori.pyx  # Killed due to segmentation fault\n+sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/rigged_configuration_element.py  # Bad exit: 1\n+sage -t --long --warn-long 63.7 src/sage/crypto/sbox.py  # Killed due to abort\n+sage -t --long --warn-long 63.7 src/sage/graphs/base/graph_backends.pyx  # Killed due to segmentation fault\n+sage -t --long --warn-long 63.7 src/sage/rings/polynomial/multi_polynomial_libsingular.pyx  # Killed due to segmentation fault\n+sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/bij_type_B.py  # Bad exit: 1\n+sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/tensor_product_kr_tableaux_element.py  # Bad exit: 2\n+sage -t --long --warn-long 63.7 src/sage/crypto/boolean_function.pyx  # Killed due to abort\n+sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/kleber_tree.py  # Bad exit: 127\n+sage -t --long --warn-long 63.7 src/sage/combinat/crystals/affinization.py  # Bad exit: 1\n+sage -t --long --warn-long 63.7 src/sage/structure/category_object.pyx  # Killed due to abort\n+sage -t --long --warn-long 63.7 src/sage/combinat/crystals/tensor_product_element.pyx  # Bad exit: 127\n+sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/bij_type_E67.py  # Bad exit: 1\n+sage -t --long --warn-long 63.7 src/sage/geometry/polyhedron/backend_normaliz.py  # Bad exit: 127\n+sage -t --long --warn-long 63.7 src/sage/sat/solvers/dimacs.py  # Killed due to abort\n+sage -t --long --warn-long 63.7 src/doc/en/reference/sat/index.rst  # Killed due to abort\n+sage -t --long --warn-long 63.7 src/sage/sat/boolean_polynomials.py  # Killed due to abort\n+sage -t --long --warn-long 63.7 src/sage/rings/polynomial/polynomial_ring_constructor.py  # Killed due to abort\n+sage -t --long --warn-long 63.7 src/sage/sat/converters/polybori.py  # Killed due to abort\n+sage -t --long --warn-long 63.7 src/sage/ext/memory.pyx  # 1 doctest failed\n+```\n+\n+The cause seems to be the same as #23879: `pynormaliz` requires a very large amount of memory (more than what #23748 allows).\n``````\n",
    "created_at": "2017-09-20T07:07:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23892#issuecomment-360581",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,33 @@
-Details to follow...
+
+```
+sage -t --long --warn-long 63.7 src/sage/graphs/generic_graph.py  # Killed due to segmentation fault
+sage -t --long --warn-long 63.7 src/sage/crypto/mq/sr.py  # Killed due to abort
+sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/tensor_product_kr_tableaux.py  # Bad exit: 1
+sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/rigged_configurations.py  # Bad exit: 127
+sage -t --long --warn-long 63.7 src/sage/rings/integer.pyx  # 1 doctest failed
+sage -t --long --warn-long 63.7 src/sage/combinat/crystals/kirillov_reshetikhin.py  # Bad exit: 1
+sage -t --long --warn-long 63.7 src/sage/structure/sage_object.pyx  # Killed due to abort
+sage -t --long --warn-long 63.7 src/sage/rings/polynomial/multi_polynomial_sequence.py  # Killed due to abort
+sage -t --long --warn-long 63.7 src/sage/rings/polynomial/pbori.pyx  # Killed due to segmentation fault
+sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/rigged_configuration_element.py  # Bad exit: 1
+sage -t --long --warn-long 63.7 src/sage/crypto/sbox.py  # Killed due to abort
+sage -t --long --warn-long 63.7 src/sage/graphs/base/graph_backends.pyx  # Killed due to segmentation fault
+sage -t --long --warn-long 63.7 src/sage/rings/polynomial/multi_polynomial_libsingular.pyx  # Killed due to segmentation fault
+sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/bij_type_B.py  # Bad exit: 1
+sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/tensor_product_kr_tableaux_element.py  # Bad exit: 2
+sage -t --long --warn-long 63.7 src/sage/crypto/boolean_function.pyx  # Killed due to abort
+sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/kleber_tree.py  # Bad exit: 127
+sage -t --long --warn-long 63.7 src/sage/combinat/crystals/affinization.py  # Bad exit: 1
+sage -t --long --warn-long 63.7 src/sage/structure/category_object.pyx  # Killed due to abort
+sage -t --long --warn-long 63.7 src/sage/combinat/crystals/tensor_product_element.pyx  # Bad exit: 127
+sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/bij_type_E67.py  # Bad exit: 1
+sage -t --long --warn-long 63.7 src/sage/geometry/polyhedron/backend_normaliz.py  # Bad exit: 127
+sage -t --long --warn-long 63.7 src/sage/sat/solvers/dimacs.py  # Killed due to abort
+sage -t --long --warn-long 63.7 src/doc/en/reference/sat/index.rst  # Killed due to abort
+sage -t --long --warn-long 63.7 src/sage/sat/boolean_polynomials.py  # Killed due to abort
+sage -t --long --warn-long 63.7 src/sage/rings/polynomial/polynomial_ring_constructor.py  # Killed due to abort
+sage -t --long --warn-long 63.7 src/sage/sat/converters/polybori.py  # Killed due to abort
+sage -t --long --warn-long 63.7 src/sage/ext/memory.pyx  # 1 doctest failed
+```
+
+The cause seems to be the same as #23879: `pynormaliz` requires a very large amount of memory (more than what #23748 allows).
``````




---

archive/issue_comments_360582.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -4,7 +4,6 @@\n sage -t --long --warn-long 63.7 src/sage/crypto/mq/sr.py  # Killed due to abort\n sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/tensor_product_kr_tableaux.py  # Bad exit: 1\n sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/rigged_configurations.py  # Bad exit: 127\n-sage -t --long --warn-long 63.7 src/sage/rings/integer.pyx  # 1 doctest failed\n sage -t --long --warn-long 63.7 src/sage/combinat/crystals/kirillov_reshetikhin.py  # Bad exit: 1\n sage -t --long --warn-long 63.7 src/sage/structure/sage_object.pyx  # Killed due to abort\n sage -t --long --warn-long 63.7 src/sage/rings/polynomial/multi_polynomial_sequence.py  # Killed due to abort\n@@ -27,7 +26,6 @@\n sage -t --long --warn-long 63.7 src/sage/sat/boolean_polynomials.py  # Killed due to abort\n sage -t --long --warn-long 63.7 src/sage/rings/polynomial/polynomial_ring_constructor.py  # Killed due to abort\n sage -t --long --warn-long 63.7 src/sage/sat/converters/polybori.py  # Killed due to abort\n-sage -t --long --warn-long 63.7 src/sage/ext/memory.pyx  # 1 doctest failed\n ```\n \n The cause seems to be the same as #23879: `pynormaliz` requires a very large amount of memory (more than what #23748 allows).\n``````\n",
    "created_at": "2017-09-20T09:03:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23892#issuecomment-360582",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -4,7 +4,6 @@
 sage -t --long --warn-long 63.7 src/sage/crypto/mq/sr.py  # Killed due to abort
 sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/tensor_product_kr_tableaux.py  # Bad exit: 1
 sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/rigged_configurations.py  # Bad exit: 127
-sage -t --long --warn-long 63.7 src/sage/rings/integer.pyx  # 1 doctest failed
 sage -t --long --warn-long 63.7 src/sage/combinat/crystals/kirillov_reshetikhin.py  # Bad exit: 1
 sage -t --long --warn-long 63.7 src/sage/structure/sage_object.pyx  # Killed due to abort
 sage -t --long --warn-long 63.7 src/sage/rings/polynomial/multi_polynomial_sequence.py  # Killed due to abort
@@ -27,7 +26,6 @@
 sage -t --long --warn-long 63.7 src/sage/sat/boolean_polynomials.py  # Killed due to abort
 sage -t --long --warn-long 63.7 src/sage/rings/polynomial/polynomial_ring_constructor.py  # Killed due to abort
 sage -t --long --warn-long 63.7 src/sage/sat/converters/polybori.py  # Killed due to abort
-sage -t --long --warn-long 63.7 src/sage/ext/memory.pyx  # 1 doctest failed
 ```
 
 The cause seems to be the same as #23879: `pynormaliz` requires a very large amount of memory (more than what #23748 allows).
``````




---

archive/issue_comments_360583.json:
```json
{
    "body": "Author: **Jeroen Demeyer**",
    "created_at": "2017-09-20T11:56:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23892#issuecomment-360583",
    "user": "https://github.com/jdemeyer"
}
```

Author: **Jeroen Demeyer**



---

archive/issue_comments_360584.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,31 +1,7 @@\n+The `normaliz` package uses OMP for threading, which can create many threads. In doctests, this is bad for two reasons:\n \n-```\n-sage -t --long --warn-long 63.7 src/sage/graphs/generic_graph.py  # Killed due to segmentation fault\n-sage -t --long --warn-long 63.7 src/sage/crypto/mq/sr.py  # Killed due to abort\n-sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/tensor_product_kr_tableaux.py  # Bad exit: 1\n-sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/rigged_configurations.py  # Bad exit: 127\n-sage -t --long --warn-long 63.7 src/sage/combinat/crystals/kirillov_reshetikhin.py  # Bad exit: 1\n-sage -t --long --warn-long 63.7 src/sage/structure/sage_object.pyx  # Killed due to abort\n-sage -t --long --warn-long 63.7 src/sage/rings/polynomial/multi_polynomial_sequence.py  # Killed due to abort\n-sage -t --long --warn-long 63.7 src/sage/rings/polynomial/pbori.pyx  # Killed due to segmentation fault\n-sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/rigged_configuration_element.py  # Bad exit: 1\n-sage -t --long --warn-long 63.7 src/sage/crypto/sbox.py  # Killed due to abort\n-sage -t --long --warn-long 63.7 src/sage/graphs/base/graph_backends.pyx  # Killed due to segmentation fault\n-sage -t --long --warn-long 63.7 src/sage/rings/polynomial/multi_polynomial_libsingular.pyx  # Killed due to segmentation fault\n-sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/bij_type_B.py  # Bad exit: 1\n-sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/tensor_product_kr_tableaux_element.py  # Bad exit: 2\n-sage -t --long --warn-long 63.7 src/sage/crypto/boolean_function.pyx  # Killed due to abort\n-sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/kleber_tree.py  # Bad exit: 127\n-sage -t --long --warn-long 63.7 src/sage/combinat/crystals/affinization.py  # Bad exit: 1\n-sage -t --long --warn-long 63.7 src/sage/structure/category_object.pyx  # Killed due to abort\n-sage -t --long --warn-long 63.7 src/sage/combinat/crystals/tensor_product_element.pyx  # Bad exit: 127\n-sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/bij_type_E67.py  # Bad exit: 1\n-sage -t --long --warn-long 63.7 src/sage/geometry/polyhedron/backend_normaliz.py  # Bad exit: 127\n-sage -t --long --warn-long 63.7 src/sage/sat/solvers/dimacs.py  # Killed due to abort\n-sage -t --long --warn-long 63.7 src/doc/en/reference/sat/index.rst  # Killed due to abort\n-sage -t --long --warn-long 63.7 src/sage/sat/boolean_polynomials.py  # Killed due to abort\n-sage -t --long --warn-long 63.7 src/sage/rings/polynomial/polynomial_ring_constructor.py  # Killed due to abort\n-sage -t --long --warn-long 63.7 src/sage/sat/converters/polybori.py  # Killed due to abort\n-```\n+1. Doctests should not use an unexpectedly large number of system resources.\n \n-The cause seems to be the same as #23879: `pynormaliz` requires a very large amount of memory (more than what #23748 allows).\n+2. When there are too many threads, the virtual memory limit from #23748 will be hit.\n+\n+There is a solution: set the environment variable `OMP_NUM_THREADS=2` while doctesting.\n``````\n",
    "created_at": "2017-09-20T11:56:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23892#issuecomment-360584",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,31 +1,7 @@
+The `normaliz` package uses OMP for threading, which can create many threads. In doctests, this is bad for two reasons:
 
-```
-sage -t --long --warn-long 63.7 src/sage/graphs/generic_graph.py  # Killed due to segmentation fault
-sage -t --long --warn-long 63.7 src/sage/crypto/mq/sr.py  # Killed due to abort
-sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/tensor_product_kr_tableaux.py  # Bad exit: 1
-sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/rigged_configurations.py  # Bad exit: 127
-sage -t --long --warn-long 63.7 src/sage/combinat/crystals/kirillov_reshetikhin.py  # Bad exit: 1
-sage -t --long --warn-long 63.7 src/sage/structure/sage_object.pyx  # Killed due to abort
-sage -t --long --warn-long 63.7 src/sage/rings/polynomial/multi_polynomial_sequence.py  # Killed due to abort
-sage -t --long --warn-long 63.7 src/sage/rings/polynomial/pbori.pyx  # Killed due to segmentation fault
-sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/rigged_configuration_element.py  # Bad exit: 1
-sage -t --long --warn-long 63.7 src/sage/crypto/sbox.py  # Killed due to abort
-sage -t --long --warn-long 63.7 src/sage/graphs/base/graph_backends.pyx  # Killed due to segmentation fault
-sage -t --long --warn-long 63.7 src/sage/rings/polynomial/multi_polynomial_libsingular.pyx  # Killed due to segmentation fault
-sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/bij_type_B.py  # Bad exit: 1
-sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/tensor_product_kr_tableaux_element.py  # Bad exit: 2
-sage -t --long --warn-long 63.7 src/sage/crypto/boolean_function.pyx  # Killed due to abort
-sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/kleber_tree.py  # Bad exit: 127
-sage -t --long --warn-long 63.7 src/sage/combinat/crystals/affinization.py  # Bad exit: 1
-sage -t --long --warn-long 63.7 src/sage/structure/category_object.pyx  # Killed due to abort
-sage -t --long --warn-long 63.7 src/sage/combinat/crystals/tensor_product_element.pyx  # Bad exit: 127
-sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/bij_type_E67.py  # Bad exit: 1
-sage -t --long --warn-long 63.7 src/sage/geometry/polyhedron/backend_normaliz.py  # Bad exit: 127
-sage -t --long --warn-long 63.7 src/sage/sat/solvers/dimacs.py  # Killed due to abort
-sage -t --long --warn-long 63.7 src/doc/en/reference/sat/index.rst  # Killed due to abort
-sage -t --long --warn-long 63.7 src/sage/sat/boolean_polynomials.py  # Killed due to abort
-sage -t --long --warn-long 63.7 src/sage/rings/polynomial/polynomial_ring_constructor.py  # Killed due to abort
-sage -t --long --warn-long 63.7 src/sage/sat/converters/polybori.py  # Killed due to abort
-```
+1. Doctests should not use an unexpectedly large number of system resources.
 
-The cause seems to be the same as #23879: `pynormaliz` requires a very large amount of memory (more than what #23748 allows).
+2. When there are too many threads, the virtual memory limit from #23748 will be hit.
+
+There is a solution: set the environment variable `OMP_NUM_THREADS=2` while doctesting.
``````




---

archive/issue_events_331813.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-09-20T11:56:32Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "title_is": "Run doctests with OMP_NUM_THREADS=2",
    "title_was": "Various doctest failures if pynormaliz is installed",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23892#event-331813"
}
```



---

archive/issue_comments_360585.json:
```json
{
    "body": "Branch: **[u/jdemeyer/run_doctests_with_omp_num_threads_2](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/run_doctests_with_omp_num_threads_2)**",
    "created_at": "2017-09-20T12:01:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23892#issuecomment-360585",
    "user": "https://github.com/jdemeyer"
}
```

Branch: **[u/jdemeyer/run_doctests_with_omp_num_threads_2](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/run_doctests_with_omp_num_threads_2)**



---

archive/issue_comments_360586.json:
```json
{
    "body": "Commit: **[`9f9f7b7`](https://github.com/sagemath/sagetrac-mirror/commit/9f9f7b71f56c1c7ac20ed8601355ef495bf42fa3)**",
    "created_at": "2017-09-20T12:02:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23892#issuecomment-360586",
    "user": "https://github.com/jdemeyer"
}
```

Commit: **[`9f9f7b7`](https://github.com/sagemath/sagetrac-mirror/commit/9f9f7b71f56c1c7ac20ed8601355ef495bf42fa3)**



---

archive/issue_events_331814.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-09-20T12:02:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23892#event-331814"
}
```



---

archive/issue_comments_360587.json:
```json
{
    "body": "<div id=\"comment:7\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9f9f7b71f56c1c7ac20ed8601355ef495bf42fa3\">9f9f7b7</a></td><td><code>Run doctests with OMP_NUM_THREADS=2</code></td></tr></table>\n",
    "created_at": "2017-09-20T12:02:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23892#issuecomment-360587",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:7"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9f9f7b71f56c1c7ac20ed8601355ef495bf42fa3">9f9f7b7</a></td><td><code>Run doctests with OMP_NUM_THREADS=2</code></td></tr></table>




---

archive/issue_comments_360588.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nHi Jeroen,\n\nI want to review this, but before doing so I run into trouble, because on my machine all doctests pass in sage 8.1.beta5 with pynormaliz. Could you give pointers to which doctests failed for you and maybe help reproduce the failure so I can better understand wether this solution works. Also is there any particular reason for the integer 2? Why not 3 or 4? I agree it should not be 1 because certain bugs might go undetected in that way.",
    "created_at": "2017-09-20T12:22:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23892#issuecomment-360588",
    "user": "https://github.com/koffie"
}
```

<div id="comment:8" align="right">comment:8</div>

Hi Jeroen,

I want to review this, but before doing so I run into trouble, because on my machine all doctests pass in sage 8.1.beta5 with pynormaliz. Could you give pointers to which doctests failed for you and maybe help reproduce the failure so I can better understand wether this solution works. Also is there any particular reason for the integer 2? Why not 3 or 4? I agree it should not be 1 because certain bugs might go undetected in that way.



---

archive/issue_comments_360589.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nIn particular, many tests in `src/sage/combinat/rigged_configurations` fail for me with `pynormaliz`.\n\nSince the problem depends on the number of threads, which is the number of cores by default, it could very well be that this problem only occurs on systems with many cores. The system where I saw the failure has 24 cores. Maybe you could get the failure with `OMP_NUM_THREADS=24`?",
    "created_at": "2017-09-20T13:21:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23892#issuecomment-360589",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:9" align="right">comment:9</div>

In particular, many tests in `src/sage/combinat/rigged_configurations` fail for me with `pynormaliz`.

Since the problem depends on the number of threads, which is the number of cores by default, it could very well be that this problem only occurs on systems with many cores. The system where I saw the failure has 24 cores. Maybe you could get the failure with `OMP_NUM_THREADS=24`?



---

archive/issue_comments_360590.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@koffie](#comment:8):\n> Also is there any particular reason for the integer 2?\n\nYes, it is the smallest integer strictly larger than 1.\n\n1 thread is too few, because it doesn't really test threading. With 2 threads, you do test threading. On the other hand, the system load will at most be a factor 200% too large, which is not too bad.",
    "created_at": "2017-09-20T13:22:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23892#issuecomment-360590",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@koffie](#comment:8):
> Also is there any particular reason for the integer 2?

Yes, it is the smallest integer strictly larger than 1.

1 thread is too few, because it doesn't really test threading. With 2 threads, you do test threading. On the other hand, the system load will at most be a factor 200% too large, which is not too bad.



---

archive/issue_comments_360591.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nWithout the patch I indeed get 4 files with failing doctests if I do:\n\n```\nexport OMP_NUM_THREADS=24\nsage -t long src/sage/combinat/rigged_configurations\n```\n\nand it does not fail anymore with the patch. So it seems to be the right thing to do in order to fix it. \n\nOne thing that I don't like about the current patch is that it overwrites `OMP_NUM_THREADS` even if it is already explicitly set before running sage tests. This means that if someone for some reason wants to run the doctests with a different number of `OMP_NUM_THREADS` for debugging purposes that involve problems with threading then one has to modify the source code. So I think it would be better to only set `OMP_NUM_THREADS=2` if nothing was set before, providing a sane default value, but still allowing a less sane default value if one really insists. What are your thoughts on this?",
    "created_at": "2017-09-20T15:02:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23892#issuecomment-360591",
    "user": "https://github.com/koffie"
}
```

<div id="comment:11" align="right">comment:11</div>

Without the patch I indeed get 4 files with failing doctests if I do:

```
export OMP_NUM_THREADS=24
sage -t long src/sage/combinat/rigged_configurations
```

and it does not fail anymore with the patch. So it seems to be the right thing to do in order to fix it. 

One thing that I don't like about the current patch is that it overwrites `OMP_NUM_THREADS` even if it is already explicitly set before running sage tests. This means that if someone for some reason wants to run the doctests with a different number of `OMP_NUM_THREADS` for debugging purposes that involve problems with threading then one has to modify the source code. So I think it would be better to only set `OMP_NUM_THREADS=2` if nothing was set before, providing a sane default value, but still allowing a less sane default value if one really insists. What are your thoughts on this?



---

archive/issue_comments_360592.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@koffie](#comment:11):\n> One thing that I don't like about the current patch is that it overwrites `OMP_NUM_THREADS` even if it is already explicitly set before running sage tests.\n\nI consider that a feature. The point is that doctests should be reproducible and not depend too much on the external environment. If somebody has set an environment variable `OMP_NUM_THREADS`, the most likely reason is that he wants to use that number of threads for actual computations. It does not mean that he wants to use that many threads for doctests too.\n\n> This means that if someone for some reason wants to run the doctests with a different number of `OMP_NUM_THREADS` for debugging purposes that involve problems with threading then one has to modify the source code.\n\nAlternatively, you can set `os.environ['OMP_NUM_THREADS']` in a doctest too. That's easy to do and would fix the testing problem.",
    "created_at": "2017-09-21T07:53:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23892#issuecomment-360592",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@koffie](#comment:11):
> One thing that I don't like about the current patch is that it overwrites `OMP_NUM_THREADS` even if it is already explicitly set before running sage tests.

I consider that a feature. The point is that doctests should be reproducible and not depend too much on the external environment. If somebody has set an environment variable `OMP_NUM_THREADS`, the most likely reason is that he wants to use that number of threads for actual computations. It does not mean that he wants to use that many threads for doctests too.

> This means that if someone for some reason wants to run the doctests with a different number of `OMP_NUM_THREADS` for debugging purposes that involve problems with threading then one has to modify the source code.

Alternatively, you can set `os.environ['OMP_NUM_THREADS']` in a doctest too. That's easy to do and would fix the testing problem.



---

archive/issue_comments_360593.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nOk, I am now running all the doctest after `export OMP_NUM_THREADS=100` since I think standard patchbot testing is not good enough. If this passes then I will give positive review.\n\nDoes your remark mean that it would also be better to fix #23612 (edit: sorry I meant #23613) by unsetting `PYTHONPATH` instead of making the doctest more admissible?",
    "created_at": "2017-09-25T13:15:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23892#issuecomment-360593",
    "user": "https://github.com/koffie"
}
```

<div id="comment:13" align="right">comment:13</div>

Ok, I am now running all the doctest after `export OMP_NUM_THREADS=100` since I think standard patchbot testing is not good enough. If this passes then I will give positive review.

Does your remark mean that it would also be better to fix #23612 (edit: sorry I meant #23613) by unsetting `PYTHONPATH` instead of making the doctest more admissible?



---

archive/issue_comments_360594.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@koffie](#comment:13):\n> Does your remark mean that it would also be better to fix #23612 by unsetting `PYTHONPATH` instead of making the doctest more admissible?\n\nAre you sure you mean #23612? It seems unrelated to `PYTHONPATH` or doctests.",
    "created_at": "2017-09-25T13:24:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23892#issuecomment-360594",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@koffie](#comment:13):
> Does your remark mean that it would also be better to fix #23612 by unsetting `PYTHONPATH` instead of making the doctest more admissible?

Are you sure you mean #23612? It seems unrelated to `PYTHONPATH` or doctests.



---

archive/issue_comments_360595.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nSorry, I meant #23613.",
    "created_at": "2017-09-25T13:35:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23892#issuecomment-360595",
    "user": "https://github.com/koffie"
}
```

<div id="comment:15" align="right">comment:15</div>

Sorry, I meant #23613.



---

archive/issue_comments_360596.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nOk looks good to me.",
    "created_at": "2017-09-25T15:43:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23892#issuecomment-360596",
    "user": "https://github.com/koffie"
}
```

<div id="comment:16" align="right">comment:16</div>

Ok looks good to me.



---

archive/issue_events_331815.json:
```json
{
    "actor": "https://github.com/koffie",
    "created_at": "2017-09-25T15:43:05Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23892#event-331815"
}
```



---

archive/issue_events_331816.json:
```json
{
    "actor": "https://github.com/koffie",
    "created_at": "2017-09-25T15:43:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23892#event-331816"
}
```



---

archive/issue_events_331817.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-09-25T22:42:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23892#event-331817"
}
```



---

archive/issue_events_331818.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-09-25T22:42:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23892#event-331818"
}
```



---

archive/issue_comments_360597.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReviewer name",
    "created_at": "2017-09-25T22:42:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23892#issuecomment-360597",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:17" align="right">comment:17</div>

Reviewer name



---

archive/issue_events_331819.json:
```json
{
    "actor": "https://github.com/koffie",
    "created_at": "2017-09-26T01:59:30Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23892#event-331819"
}
```



---

archive/issue_events_331820.json:
```json
{
    "actor": "https://github.com/koffie",
    "created_at": "2017-09-26T01:59:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23892#event-331820"
}
```



---

archive/issue_comments_360598.json:
```json
{
    "body": "Reviewer: **Maarten Derickx**",
    "created_at": "2017-09-26T01:59:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23892#issuecomment-360598",
    "user": "https://github.com/koffie"
}
```

Reviewer: **Maarten Derickx**



---

archive/issue_events_331821.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-10-01T00:19:15Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23892#event-331821"
}
```



---

archive/issue_events_331822.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "9c5933ff64c04d7c8eed86ef56340240a8fad718",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2017-10-01T00:19:15Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23892#event-331822"
}
```



---

archive/issue_comments_360599.json:
```json
{
    "body": "Changed branch from **[u/jdemeyer/run_doctests_with_omp_num_threads_2](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/run_doctests_with_omp_num_threads_2)** to **[`9f9f7b7`](https://github.com/sagemath/sagetrac-mirror/commit/9f9f7b71f56c1c7ac20ed8601355ef495bf42fa3)**",
    "created_at": "2017-10-01T00:19:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23892#issuecomment-360599",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/jdemeyer/run_doctests_with_omp_num_threads_2](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/run_doctests_with_omp_num_threads_2)** to **[`9f9f7b7`](https://github.com/sagemath/sagetrac-mirror/commit/9f9f7b71f56c1c7ac20ed8601355ef495bf42fa3)**



---

archive/issue_comments_360600.json:
```json
{
    "body": "Changed commit from **[`9f9f7b7`](https://github.com/sagemath/sagetrac-mirror/commit/9f9f7b71f56c1c7ac20ed8601355ef495bf42fa3)** to none",
    "created_at": "2017-10-05T16:54:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23892#issuecomment-360600",
    "user": "https://github.com/embray"
}
```

Changed commit from **[`9f9f7b7`](https://github.com/sagemath/sagetrac-mirror/commit/9f9f7b71f56c1c7ac20ed8601355ef495bf42fa3)** to none



---

archive/issue_comments_360601.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nI wonder if this and/or #23748 will fix the doc build problems I was having on Windows for the past several weeks (which caused me to have to take down the Window patchbot >_<).  Fingers crossed...",
    "created_at": "2017-10-05T16:54:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23892#issuecomment-360601",
    "user": "https://github.com/embray"
}
```

<div id="comment:20" align="right">comment:20</div>

I wonder if this and/or #23748 will fix the doc build problems I was having on Windows for the past several weeks (which caused me to have to take down the Window patchbot >_<).  Fingers crossed...



---

archive/issue_comments_360602.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nOh wait, this was just for the doctests, I misread.  Maybe not then...",
    "created_at": "2017-10-05T16:55:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23892#issuecomment-360602",
    "user": "https://github.com/embray"
}
```

<div id="comment:21" align="right">comment:21</div>

Oh wait, this was just for the doctests, I misread.  Maybe not then...
