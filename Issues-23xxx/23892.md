# Issue 23892: Run doctests with OMP_NUM_THREADS=2

archive/issues_023655.json:
```json
{
    "body": "The `normaliz` package uses OMP for threading, which can create many threads. In doctests, this is bad for two reasons:\n\n1. Doctests should not use an unexpectedly large number of system resources.\n\n2. When there are too many threads, the virtual memory limit from #23748 will be hit.\n\nThere is a solution: set the environment variable `OMP_NUM_THREADS=2` while doctesting.\n\nCC:  @koffie\n\nReviewer: Maarten Derickx\n\nAuthor: Jeroen Demeyer\n\nBranch: 9f9f7b71f56c1c7ac20ed8601355ef495bf42fa3\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/23892\n\n",
    "closed_at": "2017-10-01T00:19:15Z",
    "created_at": "2017-09-19T10:58:06Z",
    "labels": [
        "component: packages: optional",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Run doctests with OMP_NUM_THREADS=2",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23892",
    "user": "https://github.com/jdemeyer"
}
```
The `normaliz` package uses OMP for threading, which can create many threads. In doctests, this is bad for two reasons:

1. Doctests should not use an unexpectedly large number of system resources.

2. When there are too many threads, the virtual memory limit from #23748 will be hit.

There is a solution: set the environment variable `OMP_NUM_THREADS=2` while doctesting.

CC:  @koffie

Reviewer: Maarten Derickx

Author: Jeroen Demeyer

Branch: 9f9f7b71f56c1c7ac20ed8601355ef495bf42fa3

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/23892





---

archive/issue_comments_450973.json:
```json
{
    "body": "<a id='comment:1'></a>Again??? :(",
    "created_at": "2017-09-19T11:20:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23892#issuecomment-450973",
    "user": "https://github.com/koffie"
}
```

<a id='comment:1'></a>Again??? :(



---

archive/issue_comments_450974.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,33 @@\n-Details to follow...\n+\n+```\n+sage -t --long --warn-long 63.7 src/sage/graphs/generic_graph.py  # Killed due to segmentation fault\n+sage -t --long --warn-long 63.7 src/sage/crypto/mq/sr.py  # Killed due to abort\n+sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/tensor_product_kr_tableaux.py  # Bad exit: 1\n+sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/rigged_configurations.py  # Bad exit: 127\n+sage -t --long --warn-long 63.7 src/sage/rings/integer.pyx  # 1 doctest failed\n+sage -t --long --warn-long 63.7 src/sage/combinat/crystals/kirillov_reshetikhin.py  # Bad exit: 1\n+sage -t --long --warn-long 63.7 src/sage/structure/sage_object.pyx  # Killed due to abort\n+sage -t --long --warn-long 63.7 src/sage/rings/polynomial/multi_polynomial_sequence.py  # Killed due to abort\n+sage -t --long --warn-long 63.7 src/sage/rings/polynomial/pbori.pyx  # Killed due to segmentation fault\n+sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/rigged_configuration_element.py  # Bad exit: 1\n+sage -t --long --warn-long 63.7 src/sage/crypto/sbox.py  # Killed due to abort\n+sage -t --long --warn-long 63.7 src/sage/graphs/base/graph_backends.pyx  # Killed due to segmentation fault\n+sage -t --long --warn-long 63.7 src/sage/rings/polynomial/multi_polynomial_libsingular.pyx  # Killed due to segmentation fault\n+sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/bij_type_B.py  # Bad exit: 1\n+sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/tensor_product_kr_tableaux_element.py  # Bad exit: 2\n+sage -t --long --warn-long 63.7 src/sage/crypto/boolean_function.pyx  # Killed due to abort\n+sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/kleber_tree.py  # Bad exit: 127\n+sage -t --long --warn-long 63.7 src/sage/combinat/crystals/affinization.py  # Bad exit: 1\n+sage -t --long --warn-long 63.7 src/sage/structure/category_object.pyx  # Killed due to abort\n+sage -t --long --warn-long 63.7 src/sage/combinat/crystals/tensor_product_element.pyx  # Bad exit: 127\n+sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/bij_type_E67.py  # Bad exit: 1\n+sage -t --long --warn-long 63.7 src/sage/geometry/polyhedron/backend_normaliz.py  # Bad exit: 127\n+sage -t --long --warn-long 63.7 src/sage/sat/solvers/dimacs.py  # Killed due to abort\n+sage -t --long --warn-long 63.7 src/doc/en/reference/sat/index.rst  # Killed due to abort\n+sage -t --long --warn-long 63.7 src/sage/sat/boolean_polynomials.py  # Killed due to abort\n+sage -t --long --warn-long 63.7 src/sage/rings/polynomial/polynomial_ring_constructor.py  # Killed due to abort\n+sage -t --long --warn-long 63.7 src/sage/sat/converters/polybori.py  # Killed due to abort\n+sage -t --long --warn-long 63.7 src/sage/ext/memory.pyx  # 1 doctest failed\n+```\n+\n+The cause seems to be the same as #23879: `pynormaliz` requires a very large amount of memory (more than what #23748 allows).\n``````\n",
    "created_at": "2017-09-20T07:07:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23892#issuecomment-450974",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,33 @@
-Details to follow...
+
+```
+sage -t --long --warn-long 63.7 src/sage/graphs/generic_graph.py  # Killed due to segmentation fault
+sage -t --long --warn-long 63.7 src/sage/crypto/mq/sr.py  # Killed due to abort
+sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/tensor_product_kr_tableaux.py  # Bad exit: 1
+sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/rigged_configurations.py  # Bad exit: 127
+sage -t --long --warn-long 63.7 src/sage/rings/integer.pyx  # 1 doctest failed
+sage -t --long --warn-long 63.7 src/sage/combinat/crystals/kirillov_reshetikhin.py  # Bad exit: 1
+sage -t --long --warn-long 63.7 src/sage/structure/sage_object.pyx  # Killed due to abort
+sage -t --long --warn-long 63.7 src/sage/rings/polynomial/multi_polynomial_sequence.py  # Killed due to abort
+sage -t --long --warn-long 63.7 src/sage/rings/polynomial/pbori.pyx  # Killed due to segmentation fault
+sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/rigged_configuration_element.py  # Bad exit: 1
+sage -t --long --warn-long 63.7 src/sage/crypto/sbox.py  # Killed due to abort
+sage -t --long --warn-long 63.7 src/sage/graphs/base/graph_backends.pyx  # Killed due to segmentation fault
+sage -t --long --warn-long 63.7 src/sage/rings/polynomial/multi_polynomial_libsingular.pyx  # Killed due to segmentation fault
+sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/bij_type_B.py  # Bad exit: 1
+sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/tensor_product_kr_tableaux_element.py  # Bad exit: 2
+sage -t --long --warn-long 63.7 src/sage/crypto/boolean_function.pyx  # Killed due to abort
+sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/kleber_tree.py  # Bad exit: 127
+sage -t --long --warn-long 63.7 src/sage/combinat/crystals/affinization.py  # Bad exit: 1
+sage -t --long --warn-long 63.7 src/sage/structure/category_object.pyx  # Killed due to abort
+sage -t --long --warn-long 63.7 src/sage/combinat/crystals/tensor_product_element.pyx  # Bad exit: 127
+sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/bij_type_E67.py  # Bad exit: 1
+sage -t --long --warn-long 63.7 src/sage/geometry/polyhedron/backend_normaliz.py  # Bad exit: 127
+sage -t --long --warn-long 63.7 src/sage/sat/solvers/dimacs.py  # Killed due to abort
+sage -t --long --warn-long 63.7 src/doc/en/reference/sat/index.rst  # Killed due to abort
+sage -t --long --warn-long 63.7 src/sage/sat/boolean_polynomials.py  # Killed due to abort
+sage -t --long --warn-long 63.7 src/sage/rings/polynomial/polynomial_ring_constructor.py  # Killed due to abort
+sage -t --long --warn-long 63.7 src/sage/sat/converters/polybori.py  # Killed due to abort
+sage -t --long --warn-long 63.7 src/sage/ext/memory.pyx  # 1 doctest failed
+```
+
+The cause seems to be the same as #23879: `pynormaliz` requires a very large amount of memory (more than what #23748 allows).
``````




---

archive/issue_comments_450975.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -4,7 +4,6 @@\n sage -t --long --warn-long 63.7 src/sage/crypto/mq/sr.py  # Killed due to abort\n sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/tensor_product_kr_tableaux.py  # Bad exit: 1\n sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/rigged_configurations.py  # Bad exit: 127\n-sage -t --long --warn-long 63.7 src/sage/rings/integer.pyx  # 1 doctest failed\n sage -t --long --warn-long 63.7 src/sage/combinat/crystals/kirillov_reshetikhin.py  # Bad exit: 1\n sage -t --long --warn-long 63.7 src/sage/structure/sage_object.pyx  # Killed due to abort\n sage -t --long --warn-long 63.7 src/sage/rings/polynomial/multi_polynomial_sequence.py  # Killed due to abort\n@@ -27,7 +26,6 @@\n sage -t --long --warn-long 63.7 src/sage/sat/boolean_polynomials.py  # Killed due to abort\n sage -t --long --warn-long 63.7 src/sage/rings/polynomial/polynomial_ring_constructor.py  # Killed due to abort\n sage -t --long --warn-long 63.7 src/sage/sat/converters/polybori.py  # Killed due to abort\n-sage -t --long --warn-long 63.7 src/sage/ext/memory.pyx  # 1 doctest failed\n ```\n \n The cause seems to be the same as #23879: `pynormaliz` requires a very large amount of memory (more than what #23748 allows).\n``````\n",
    "created_at": "2017-09-20T09:03:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23892#issuecomment-450975",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -4,7 +4,6 @@
 sage -t --long --warn-long 63.7 src/sage/crypto/mq/sr.py  # Killed due to abort
 sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/tensor_product_kr_tableaux.py  # Bad exit: 1
 sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/rigged_configurations.py  # Bad exit: 127
-sage -t --long --warn-long 63.7 src/sage/rings/integer.pyx  # 1 doctest failed
 sage -t --long --warn-long 63.7 src/sage/combinat/crystals/kirillov_reshetikhin.py  # Bad exit: 1
 sage -t --long --warn-long 63.7 src/sage/structure/sage_object.pyx  # Killed due to abort
 sage -t --long --warn-long 63.7 src/sage/rings/polynomial/multi_polynomial_sequence.py  # Killed due to abort
@@ -27,7 +26,6 @@
 sage -t --long --warn-long 63.7 src/sage/sat/boolean_polynomials.py  # Killed due to abort
 sage -t --long --warn-long 63.7 src/sage/rings/polynomial/polynomial_ring_constructor.py  # Killed due to abort
 sage -t --long --warn-long 63.7 src/sage/sat/converters/polybori.py  # Killed due to abort
-sage -t --long --warn-long 63.7 src/sage/ext/memory.pyx  # 1 doctest failed
 ```
 
 The cause seems to be the same as #23879: `pynormaliz` requires a very large amount of memory (more than what #23748 allows).
``````




---

archive/issue_comments_450976.json:
```json
{
    "body": "Changing author from \"\" to \"Jeroen Demeyer\"",
    "created_at": "2017-09-20T11:56:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23892#issuecomment-450976",
    "user": "https://github.com/jdemeyer"
}
```

Changing author from "" to "Jeroen Demeyer"



---

archive/issue_comments_450977.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,31 +1,7 @@\n+The `normaliz` package uses OMP for threading, which can create many threads. In doctests, this is bad for two reasons:\n \n-```\n-sage -t --long --warn-long 63.7 src/sage/graphs/generic_graph.py  # Killed due to segmentation fault\n-sage -t --long --warn-long 63.7 src/sage/crypto/mq/sr.py  # Killed due to abort\n-sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/tensor_product_kr_tableaux.py  # Bad exit: 1\n-sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/rigged_configurations.py  # Bad exit: 127\n-sage -t --long --warn-long 63.7 src/sage/combinat/crystals/kirillov_reshetikhin.py  # Bad exit: 1\n-sage -t --long --warn-long 63.7 src/sage/structure/sage_object.pyx  # Killed due to abort\n-sage -t --long --warn-long 63.7 src/sage/rings/polynomial/multi_polynomial_sequence.py  # Killed due to abort\n-sage -t --long --warn-long 63.7 src/sage/rings/polynomial/pbori.pyx  # Killed due to segmentation fault\n-sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/rigged_configuration_element.py  # Bad exit: 1\n-sage -t --long --warn-long 63.7 src/sage/crypto/sbox.py  # Killed due to abort\n-sage -t --long --warn-long 63.7 src/sage/graphs/base/graph_backends.pyx  # Killed due to segmentation fault\n-sage -t --long --warn-long 63.7 src/sage/rings/polynomial/multi_polynomial_libsingular.pyx  # Killed due to segmentation fault\n-sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/bij_type_B.py  # Bad exit: 1\n-sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/tensor_product_kr_tableaux_element.py  # Bad exit: 2\n-sage -t --long --warn-long 63.7 src/sage/crypto/boolean_function.pyx  # Killed due to abort\n-sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/kleber_tree.py  # Bad exit: 127\n-sage -t --long --warn-long 63.7 src/sage/combinat/crystals/affinization.py  # Bad exit: 1\n-sage -t --long --warn-long 63.7 src/sage/structure/category_object.pyx  # Killed due to abort\n-sage -t --long --warn-long 63.7 src/sage/combinat/crystals/tensor_product_element.pyx  # Bad exit: 127\n-sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/bij_type_E67.py  # Bad exit: 1\n-sage -t --long --warn-long 63.7 src/sage/geometry/polyhedron/backend_normaliz.py  # Bad exit: 127\n-sage -t --long --warn-long 63.7 src/sage/sat/solvers/dimacs.py  # Killed due to abort\n-sage -t --long --warn-long 63.7 src/doc/en/reference/sat/index.rst  # Killed due to abort\n-sage -t --long --warn-long 63.7 src/sage/sat/boolean_polynomials.py  # Killed due to abort\n-sage -t --long --warn-long 63.7 src/sage/rings/polynomial/polynomial_ring_constructor.py  # Killed due to abort\n-sage -t --long --warn-long 63.7 src/sage/sat/converters/polybori.py  # Killed due to abort\n-```\n+1. Doctests should not use an unexpectedly large number of system resources.\n \n-The cause seems to be the same as #23879: `pynormaliz` requires a very large amount of memory (more than what #23748 allows).\n+2. When there are too many threads, the virtual memory limit from #23748 will be hit.\n+\n+There is a solution: set the environment variable `OMP_NUM_THREADS=2` while doctesting.\n``````\n",
    "created_at": "2017-09-20T11:56:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23892#issuecomment-450977",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,31 +1,7 @@
+The `normaliz` package uses OMP for threading, which can create many threads. In doctests, this is bad for two reasons:
 
-```
-sage -t --long --warn-long 63.7 src/sage/graphs/generic_graph.py  # Killed due to segmentation fault
-sage -t --long --warn-long 63.7 src/sage/crypto/mq/sr.py  # Killed due to abort
-sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/tensor_product_kr_tableaux.py  # Bad exit: 1
-sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/rigged_configurations.py  # Bad exit: 127
-sage -t --long --warn-long 63.7 src/sage/combinat/crystals/kirillov_reshetikhin.py  # Bad exit: 1
-sage -t --long --warn-long 63.7 src/sage/structure/sage_object.pyx  # Killed due to abort
-sage -t --long --warn-long 63.7 src/sage/rings/polynomial/multi_polynomial_sequence.py  # Killed due to abort
-sage -t --long --warn-long 63.7 src/sage/rings/polynomial/pbori.pyx  # Killed due to segmentation fault
-sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/rigged_configuration_element.py  # Bad exit: 1
-sage -t --long --warn-long 63.7 src/sage/crypto/sbox.py  # Killed due to abort
-sage -t --long --warn-long 63.7 src/sage/graphs/base/graph_backends.pyx  # Killed due to segmentation fault
-sage -t --long --warn-long 63.7 src/sage/rings/polynomial/multi_polynomial_libsingular.pyx  # Killed due to segmentation fault
-sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/bij_type_B.py  # Bad exit: 1
-sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/tensor_product_kr_tableaux_element.py  # Bad exit: 2
-sage -t --long --warn-long 63.7 src/sage/crypto/boolean_function.pyx  # Killed due to abort
-sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/kleber_tree.py  # Bad exit: 127
-sage -t --long --warn-long 63.7 src/sage/combinat/crystals/affinization.py  # Bad exit: 1
-sage -t --long --warn-long 63.7 src/sage/structure/category_object.pyx  # Killed due to abort
-sage -t --long --warn-long 63.7 src/sage/combinat/crystals/tensor_product_element.pyx  # Bad exit: 127
-sage -t --long --warn-long 63.7 src/sage/combinat/rigged_configurations/bij_type_E67.py  # Bad exit: 1
-sage -t --long --warn-long 63.7 src/sage/geometry/polyhedron/backend_normaliz.py  # Bad exit: 127
-sage -t --long --warn-long 63.7 src/sage/sat/solvers/dimacs.py  # Killed due to abort
-sage -t --long --warn-long 63.7 src/doc/en/reference/sat/index.rst  # Killed due to abort
-sage -t --long --warn-long 63.7 src/sage/sat/boolean_polynomials.py  # Killed due to abort
-sage -t --long --warn-long 63.7 src/sage/rings/polynomial/polynomial_ring_constructor.py  # Killed due to abort
-sage -t --long --warn-long 63.7 src/sage/sat/converters/polybori.py  # Killed due to abort
-```
+1. Doctests should not use an unexpectedly large number of system resources.
 
-The cause seems to be the same as #23879: `pynormaliz` requires a very large amount of memory (more than what #23748 allows).
+2. When there are too many threads, the virtual memory limit from #23748 will be hit.
+
+There is a solution: set the environment variable `OMP_NUM_THREADS=2` while doctesting.
``````




---

archive/issue_comments_450978.json:
```json
{
    "body": "Changing branch from \"\" to \"u/jdemeyer/run_doctests_with_omp_num_threads_2\"",
    "created_at": "2017-09-20T12:01:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23892#issuecomment-450978",
    "user": "https://github.com/jdemeyer"
}
```

Changing branch from "" to "u/jdemeyer/run_doctests_with_omp_num_threads_2"



---

archive/issue_comments_450979.json:
```json
{
    "body": "Changing commit from \"\" to \"9f9f7b71f56c1c7ac20ed8601355ef495bf42fa3\"",
    "created_at": "2017-09-20T12:02:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23892#issuecomment-450979",
    "user": "https://github.com/jdemeyer"
}
```

Changing commit from "" to "9f9f7b71f56c1c7ac20ed8601355ef495bf42fa3"



---

archive/issue_comments_450980.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-09-20T12:02:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23892#issuecomment-450980",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_450981.json:
```json
{
    "body": "<a id='comment:7'></a>New commits:",
    "created_at": "2017-09-20T12:02:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23892#issuecomment-450981",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>New commits:



---

archive/issue_comments_450982.json:
```json
{
    "body": "<a id='comment:8'></a>Hi Jeroen,\n\nI want to review this, but before doing so I run into trouble, because on my machine all doctests pass in sage 8.1.beta5 with pynormaliz. Could you give pointers to which doctests failed for you and maybe help reproduce the failure so I can better understand wether this solution works. Also is there any particular reason for the integer 2? Why not 3 or 4? I agree it should not be 1 because certain bugs might go undetected in that way.",
    "created_at": "2017-09-20T12:22:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23892#issuecomment-450982",
    "user": "https://github.com/koffie"
}
```

<a id='comment:8'></a>Hi Jeroen,

I want to review this, but before doing so I run into trouble, because on my machine all doctests pass in sage 8.1.beta5 with pynormaliz. Could you give pointers to which doctests failed for you and maybe help reproduce the failure so I can better understand wether this solution works. Also is there any particular reason for the integer 2? Why not 3 or 4? I agree it should not be 1 because certain bugs might go undetected in that way.



---

archive/issue_comments_450983.json:
```json
{
    "body": "<a id='comment:9'></a>In particular, many tests in `src/sage/combinat/rigged_configurations` fail for me with `pynormaliz`.\n\nSince the problem depends on the number of threads, which is the number of cores by default, it could very well be that this problem only occurs on systems with many cores. The system where I saw the failure has 24 cores. Maybe you could get the failure with `OMP_NUM_THREADS=24`?",
    "created_at": "2017-09-20T13:21:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23892#issuecomment-450983",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>In particular, many tests in `src/sage/combinat/rigged_configurations` fail for me with `pynormaliz`.

Since the problem depends on the number of threads, which is the number of cores by default, it could very well be that this problem only occurs on systems with many cores. The system where I saw the failure has 24 cores. Maybe you could get the failure with `OMP_NUM_THREADS=24`?



---

archive/issue_comments_450984.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [mderickx](#comment%3A8):\n> Also is there any particular reason for the integer 2?\n\n\nYes, it is the smallest integer strictly larger than 1.\n\n1 thread is too few, because it doesn't really test threading. With 2 threads, you do test threading. On the other hand, the system load will at most be a factor 200% too large, which is not too bad.",
    "created_at": "2017-09-20T13:22:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23892#issuecomment-450984",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>Replying to [mderickx](#comment%3A8):
> Also is there any particular reason for the integer 2?


Yes, it is the smallest integer strictly larger than 1.

1 thread is too few, because it doesn't really test threading. With 2 threads, you do test threading. On the other hand, the system load will at most be a factor 200% too large, which is not too bad.



---

archive/issue_comments_450985.json:
```json
{
    "body": "<a id='comment:11'></a>Without the patch I indeed get 4 files with failing doctests if I do:\n\n```\nexport OMP_NUM_THREADS=24\nsage -t long src/sage/combinat/rigged_configurations\n```\n\nand it does not fail anymore with the patch. So it seems to be the right thing to do in order to fix it. \n\nOne thing that I don't like about the current patch is that it overwrites `OMP_NUM_THREADS` even if it is already explicitly set before running sage tests. This means that if someone for some reason wants to run the doctests with a different number of `OMP_NUM_THREADS` for debugging purposes that involve problems with threading then one has to modify the source code. So I think it would be better to only set `OMP_NUM_THREADS=2` if nothing was set before, providing a sane default value, but still allowing a less sane default value if one really insists. What are your thoughts on this?",
    "created_at": "2017-09-20T15:02:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23892#issuecomment-450985",
    "user": "https://github.com/koffie"
}
```

<a id='comment:11'></a>Without the patch I indeed get 4 files with failing doctests if I do:

```
export OMP_NUM_THREADS=24
sage -t long src/sage/combinat/rigged_configurations
```

and it does not fail anymore with the patch. So it seems to be the right thing to do in order to fix it. 

One thing that I don't like about the current patch is that it overwrites `OMP_NUM_THREADS` even if it is already explicitly set before running sage tests. This means that if someone for some reason wants to run the doctests with a different number of `OMP_NUM_THREADS` for debugging purposes that involve problems with threading then one has to modify the source code. So I think it would be better to only set `OMP_NUM_THREADS=2` if nothing was set before, providing a sane default value, but still allowing a less sane default value if one really insists. What are your thoughts on this?



---

archive/issue_comments_450986.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [mderickx](#comment%3A11):\n> One thing that I don't like about the current patch is that it overwrites `OMP_NUM_THREADS` even if it is already explicitly set before running sage tests.\n\n\nI consider that a feature. The point is that doctests should be reproducible and not depend too much on the external environment. If somebody has set an environment variable `OMP_NUM_THREADS`, the most likely reason is that he wants to use that number of threads for actual computations. It does not mean that he wants to use that many threads for doctests too.\n\n> This means that if someone for some reason wants to run the doctests with a different number of `OMP_NUM_THREADS` for debugging purposes that involve problems with threading then one has to modify the source code.\n\n\nAlternatively, you can set `os.environ['OMP_NUM_THREADS']` in a doctest too. That's easy to do and would fix the testing problem.",
    "created_at": "2017-09-21T07:53:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23892#issuecomment-450986",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>Replying to [mderickx](#comment%3A11):
> One thing that I don't like about the current patch is that it overwrites `OMP_NUM_THREADS` even if it is already explicitly set before running sage tests.


I consider that a feature. The point is that doctests should be reproducible and not depend too much on the external environment. If somebody has set an environment variable `OMP_NUM_THREADS`, the most likely reason is that he wants to use that number of threads for actual computations. It does not mean that he wants to use that many threads for doctests too.

> This means that if someone for some reason wants to run the doctests with a different number of `OMP_NUM_THREADS` for debugging purposes that involve problems with threading then one has to modify the source code.


Alternatively, you can set `os.environ['OMP_NUM_THREADS']` in a doctest too. That's easy to do and would fix the testing problem.



---

archive/issue_comments_450987.json:
```json
{
    "body": "<a id='comment:13'></a>Ok, I am now running all the doctest after `export OMP_NUM_THREADS=100` since I think standard patchbot testing is not good enough. If this passes then I will give positive review.\n\nDoes your remark mean that it would also be better to fix #23612 (edit: sorry I meant #23613) by unsetting `PYTHONPATH` instead of making the doctest more admissible?",
    "created_at": "2017-09-25T13:15:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23892#issuecomment-450987",
    "user": "https://github.com/koffie"
}
```

<a id='comment:13'></a>Ok, I am now running all the doctest after `export OMP_NUM_THREADS=100` since I think standard patchbot testing is not good enough. If this passes then I will give positive review.

Does your remark mean that it would also be better to fix #23612 (edit: sorry I meant #23613) by unsetting `PYTHONPATH` instead of making the doctest more admissible?



---

archive/issue_comments_450988.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [mderickx](#comment%3A13):\n> Does your remark mean that it would also be better to fix #23612 by unsetting `PYTHONPATH` instead of making the doctest more admissible?\n\n\nAre you sure you mean #23612? It seems unrelated to `PYTHONPATH` or doctests.",
    "created_at": "2017-09-25T13:24:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23892#issuecomment-450988",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>Replying to [mderickx](#comment%3A13):
> Does your remark mean that it would also be better to fix #23612 by unsetting `PYTHONPATH` instead of making the doctest more admissible?


Are you sure you mean #23612? It seems unrelated to `PYTHONPATH` or doctests.



---

archive/issue_comments_450989.json:
```json
{
    "body": "<a id='comment:15'></a>Sorry, I meant #23613.",
    "created_at": "2017-09-25T13:35:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23892#issuecomment-450989",
    "user": "https://github.com/koffie"
}
```

<a id='comment:15'></a>Sorry, I meant #23613.



---

archive/issue_comments_450990.json:
```json
{
    "body": "<a id='comment:16'></a>Ok looks good to me.",
    "created_at": "2017-09-25T15:43:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23892#issuecomment-450990",
    "user": "https://github.com/koffie"
}
```

<a id='comment:16'></a>Ok looks good to me.



---

archive/issue_comments_450991.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-09-25T15:43:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23892#issuecomment-450991",
    "user": "https://github.com/koffie"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_450992.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-09-25T22:42:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23892#issuecomment-450992",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_450993.json:
```json
{
    "body": "<a id='comment:17'></a>Reviewer name",
    "created_at": "2017-09-25T22:42:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23892#issuecomment-450993",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:17'></a>Reviewer name



---

archive/issue_comments_450994.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2017-09-26T01:59:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23892#issuecomment-450994",
    "user": "https://github.com/koffie"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_450995.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Maarten Derickx\"",
    "created_at": "2017-09-26T01:59:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23892#issuecomment-450995",
    "user": "https://github.com/koffie"
}
```

Changing reviewer from "" to "Maarten Derickx"



---

archive/issue_comments_450996.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-10-01T00:19:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23892#issuecomment-450996",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_060840.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-10-01T00:19:15Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23892",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23892#event-60840"
}
```



---

archive/issue_comments_450997.json:
```json
{
    "body": "Changing branch from \"u/jdemeyer/run_doctests_with_omp_num_threads_2\" to \"9f9f7b71f56c1c7ac20ed8601355ef495bf42fa3\"",
    "created_at": "2017-10-01T00:19:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23892#issuecomment-450997",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/jdemeyer/run_doctests_with_omp_num_threads_2" to "9f9f7b71f56c1c7ac20ed8601355ef495bf42fa3"



---

archive/issue_comments_450998.json:
```json
{
    "body": "Changing commit from \"9f9f7b71f56c1c7ac20ed8601355ef495bf42fa3\" to \"\"",
    "created_at": "2017-10-05T16:54:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23892#issuecomment-450998",
    "user": "https://github.com/embray"
}
```

Changing commit from "9f9f7b71f56c1c7ac20ed8601355ef495bf42fa3" to ""



---

archive/issue_comments_450999.json:
```json
{
    "body": "<a id='comment:20'></a>I wonder if this and/or #23748 will fix the doc build problems I was having on Windows for the past several weeks (which caused me to have to take down the Window patchbot >_<).  Fingers crossed...",
    "created_at": "2017-10-05T16:54:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23892#issuecomment-450999",
    "user": "https://github.com/embray"
}
```

<a id='comment:20'></a>I wonder if this and/or #23748 will fix the doc build problems I was having on Windows for the past several weeks (which caused me to have to take down the Window patchbot >_<).  Fingers crossed...



---

archive/issue_comments_451000.json:
```json
{
    "body": "<a id='comment:21'></a>Oh wait, this was just for the doctests, I misread.  Maybe not then...",
    "created_at": "2017-10-05T16:55:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23892#issuecomment-451000",
    "user": "https://github.com/embray"
}
```

<a id='comment:21'></a>Oh wait, this was just for the doctests, I misread.  Maybe not then...
