# Issue 23781: python2/3: split spkg-install to spkg-build; fix various build issues

archive/issues_023544.json:
```json
{
    "body": "This ticket starts by splitting the `spkg-install` for python2 and python3 into separate `spkg-build` and `spkg-install` scripts as recommended by #21726 (we said we would apply this change to individual packages on a case-by-case basis, and I figured as long as I was making changes to these scripts it would be good to do).\n\nThis also fixes a general bug with the build, where building a new Python can link the python executable and extension modules with an old libpython left in `$SAGE_LOCAL`, leading to possible errors.\n\nRather than deleting the old libpython first, I think it's cleaner to pass the correct `$LDFLAGS` to prevent this from happening.\n\nFinally, this moves the tests that certain extension modules built to after building, but before installing, and runs the tests out of the source directory.  This is a change extracted from #22509.\n\nKeywords: python2 python3\n\nBranch/Commit: f326c1acfa9804d583f03611e729c3bebeff4083\n\nReviewer: Jeroen Demeyer\n\nAuthor: Erik Bray\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/23781\n\n",
    "closed_at": "2017-10-25T06:58:09Z",
    "created_at": "2017-09-04T16:44:59Z",
    "labels": [
        "component: packages: standard",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "python2/3: split spkg-install to spkg-build; fix various build issues",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23781",
    "user": "https://github.com/embray"
}
```
This ticket starts by splitting the `spkg-install` for python2 and python3 into separate `spkg-build` and `spkg-install` scripts as recommended by #21726 (we said we would apply this change to individual packages on a case-by-case basis, and I figured as long as I was making changes to these scripts it would be good to do).

This also fixes a general bug with the build, where building a new Python can link the python executable and extension modules with an old libpython left in `$SAGE_LOCAL`, leading to possible errors.

Rather than deleting the old libpython first, I think it's cleaner to pass the correct `$LDFLAGS` to prevent this from happening.

Finally, this moves the tests that certain extension modules built to after building, but before installing, and runs the tests out of the source directory.  This is a change extracted from #22509.

Keywords: python2 python3

Branch/Commit: f326c1acfa9804d583f03611e729c3bebeff4083

Reviewer: Jeroen Demeyer

Author: Erik Bray

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/23781





---

archive/issue_comments_350988.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-09-04T16:45:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-350988",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_350989.json:
```json
{
    "body": "<a id='comment:2'></a>Given that these scripts are mostly the same for Python 2 and Python 3, would it be possible to have just one script (say, by symlinking) and then use `$PKG_NAME` inside the script where needed?",
    "created_at": "2017-09-05T12:15:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-350989",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>Given that these scripts are mostly the same for Python 2 and Python 3, would it be possible to have just one script (say, by symlinking) and then use `$PKG_NAME` inside the script where needed?



---

archive/issue_comments_350990.json:
```json
{
    "body": "<a id='comment:3'></a>Looking at the difference between the Python 2 and Python 3 scripts, I wonder why this only occurs for Python 2:\n\n```\n  # Use EXTRA_CFLAGS for user-defined CFLAGS since Python puts its own\n  # default flags like -O3 after CFLAGS but before EXTRA_CFLAGS.\n  # We also disable warnings about unused variables/functions which are\n  # common in Cython-generated code.\n  export EXTRA_CFLAGS=\"`testcflags.sh -Wno-unused` $CFLAGS\"\n  unset CFLAGS\n```\nI think this is just an omission and it should be there for Python 3 also.",
    "created_at": "2017-09-05T12:19:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-350990",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>Looking at the difference between the Python 2 and Python 3 scripts, I wonder why this only occurs for Python 2:

```
  # Use EXTRA_CFLAGS for user-defined CFLAGS since Python puts its own
  # default flags like -O3 after CFLAGS but before EXTRA_CFLAGS.
  # We also disable warnings about unused variables/functions which are
  # common in Cython-generated code.
  export EXTRA_CFLAGS="`testcflags.sh -Wno-unused` $CFLAGS"
  unset CFLAGS
```
I think this is just an omission and it should be there for Python 3 also.



---

archive/issue_comments_350991.json:
```json
{
    "body": "<a id='comment:4'></a>Apart from that, everything looks fine from looking at the diff.",
    "created_at": "2017-09-05T12:34:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-350991",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>Apart from that, everything looks fine from looking at the diff.



---

archive/issue_comments_350992.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:2 jdemeyer]:\n> Given that these scripts are mostly the same for Python 2 and Python 3, would it be possible to have just one script (say, by symlinking) and then use `$PKG_NAME` inside the script where needed?\n\n\nI've wondered that myself.  It's tempting--maybe this ticket would be a good place to do it as long as I'm making changes...",
    "created_at": "2017-09-05T14:08:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-350992",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>Replying to [comment:2 jdemeyer]:
> Given that these scripts are mostly the same for Python 2 and Python 3, would it be possible to have just one script (say, by symlinking) and then use `$PKG_NAME` inside the script where needed?


I've wondered that myself.  It's tempting--maybe this ticket would be a good place to do it as long as I'm making changes...



---

archive/issue_comments_350993.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:3 jdemeyer]:\n> Looking at the difference between the Python 2 and Python 3 scripts, I wonder why this only occurs for Python 2:\n> \n> ```\n>   # Use EXTRA_CFLAGS for user-defined CFLAGS since Python puts its own\n>   # default flags like -O3 after CFLAGS but before EXTRA_CFLAGS.\n>   # We also disable warnings about unused variables/functions which are\n>   # common in Cython-generated code.\n>   export EXTRA_CFLAGS=\"`testcflags.sh -Wno-unused` $CFLAGS\"\n>   unset CFLAGS\n> ```\n> I think this is just an omission and it should be there for Python 3 also.\n\n\nApparently you added that in #19899, but didn't add it to python3, presumably just due to lack of python3 testing at the time.  Probably it applies there too.",
    "created_at": "2017-09-05T14:14:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-350993",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>Replying to [comment:3 jdemeyer]:
> Looking at the difference between the Python 2 and Python 3 scripts, I wonder why this only occurs for Python 2:
> 
> ```
>   # Use EXTRA_CFLAGS for user-defined CFLAGS since Python puts its own
>   # default flags like -O3 after CFLAGS but before EXTRA_CFLAGS.
>   # We also disable warnings about unused variables/functions which are
>   # common in Cython-generated code.
>   export EXTRA_CFLAGS="`testcflags.sh -Wno-unused` $CFLAGS"
>   unset CFLAGS
> ```
> I think this is just an omission and it should be there for Python 3 also.


Apparently you added that in #19899, but didn't add it to python3, presumably just due to lack of python3 testing at the time.  Probably it applies there too.



---

archive/issue_comments_350994.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:5 embray]:\n> Replying to [comment:2 jdemeyer]:\n> > Given that these scripts are mostly the same for Python 2 and Python 3, would it be possible to have just one script (say, by symlinking) and then use `$PKG_NAME` inside the script where needed?\n\n> \n> I've wondered that myself.  It's tempting--maybe this ticket would be a good place to do it as long as I'm making changes...\n\n\nGreat! Please do.",
    "created_at": "2017-09-06T08:24:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-350994",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>Replying to [comment:5 embray]:
> Replying to [comment:2 jdemeyer]:
> > Given that these scripts are mostly the same for Python 2 and Python 3, would it be possible to have just one script (say, by symlinking) and then use `$PKG_NAME` inside the script where needed?

> 
> I've wondered that myself.  It's tempting--maybe this ticket would be a good place to do it as long as I'm making changes...


Great! Please do.



---

archive/issue_comments_350995.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-09-06T08:24:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-350995",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_350996.json:
```json
{
    "body": "<a id='comment:8'></a>For some reason I thought I already did this.  I guess I'll finish this up now since this is a dependency of #22509, which I'd also really like to move forward on.",
    "created_at": "2017-10-11T13:38:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-350996",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>For some reason I thought I already did this.  I guess I'll finish this up now since this is a dependency of #22509, which I'd also really like to move forward on.



---

archive/issue_comments_350997.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-10-11T13:44:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-350997",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_350998.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-10-11T14:30:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-350998",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_350999.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-10-11T14:31:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-350999",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_351000.json:
```json
{
    "body": "<a id='comment:11'></a>As suggested, merged the mostly duplicate scripts into one (this will be *much* better maintenance-wise going forward).  This required one small change to `sage-spkg` to ensure that symlinks are dereferenced when copying to the build directory.",
    "created_at": "2017-10-11T14:31:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-351000",
    "user": "https://github.com/embray"
}
```

<a id='comment:11'></a>As suggested, merged the mostly duplicate scripts into one (this will be *much* better maintenance-wise going forward).  This required one small change to `sage-spkg` to ensure that symlinks are dereferenced when copying to the build directory.



---

archive/issue_comments_351001.json:
```json
{
    "body": "<a id='comment:12'></a>I see that you are checking for the importability of various modules *before* installing Python. That makes sense, but it also means that you can remove the duplicate check\n\n```\nif [ -z `find build -name _scproxy.so` ]; then\n```",
    "created_at": "2017-10-13T09:00:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-351001",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>I see that you are checking for the importability of various modules *before* installing Python. That makes sense, but it also means that you can remove the duplicate check

```
if [ -z `find build -name _scproxy.so` ]; then
```



---

archive/issue_comments_351002.json:
```json
{
    "body": "<a id='comment:13'></a>Maybe also fold both import checks into one by doing something like\n\n```\ntestmodules=\"ctypes math hashlib crypt readline socket\"\nif ...; then\n    testmodules=\"_scproxy $testmodules\"\nfi\nfor modules in $testmodules; do\n```",
    "created_at": "2017-10-13T09:02:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-351002",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>Maybe also fold both import checks into one by doing something like

```
testmodules="ctypes math hashlib crypt readline socket"
if ...; then
    testmodules="_scproxy $testmodules"
fi
for modules in $testmodules; do
```



---

archive/issue_comments_351003.json:
```json
{
    "body": "<a id='comment:14'></a>Please explain this:\n\n```\n# Make sure -L. is placed before -L$SAGE_LOCAL/lib so that python and extension\n# modules are linked with the right libpython\nexport LDFLAGS=\"-L. $LDFLAGS\"\n```\nWe didn't need this before...",
    "created_at": "2017-10-13T09:04:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-351003",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>Please explain this:

```
# Make sure -L. is placed before -L$SAGE_LOCAL/lib so that python and extension
# modules are linked with the right libpython
export LDFLAGS="-L. $LDFLAGS"
```
We didn't need this before...



---

archive/issue_comments_351004.json:
```json
{
    "body": "<a id='comment:15'></a>`$CUR` is undefined here:\n\n```\n    mkdir \"$CUR/include\"\n```\nJust replace it with `..` since that's what it was.",
    "created_at": "2017-10-13T09:08:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-351004",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:15'></a>`$CUR` is undefined here:

```
    mkdir "$CUR/include"
```
Just replace it with `..` since that's what it was.



---

archive/issue_comments_351005.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:14 jdemeyer]:\n> Please explain this:\n> \n> ```\n> # Make sure -L. is placed before -L$SAGE_LOCAL/lib so that python and extension\n> # modules are linked with the right libpython\n> export LDFLAGS=\"-L. $LDFLAGS\"\n> ```\n> We didn't need this before...\n\n\nActually you did, you just didn't know it :)  I try to write reasonably descriptive commit messages: https://git.sagemath.org/sage.git/commit/?h=56408511f00875d68b76c150455b2bcfb5f0174f&id=cab490ec9f568b6bf70ede31f93ba86d71c865e8",
    "created_at": "2017-10-13T09:21:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-351005",
    "user": "https://github.com/embray"
}
```

<a id='comment:16'></a>Replying to [comment:14 jdemeyer]:
> Please explain this:
> 
> ```
> # Make sure -L. is placed before -L$SAGE_LOCAL/lib so that python and extension
> # modules are linked with the right libpython
> export LDFLAGS="-L. $LDFLAGS"
> ```
> We didn't need this before...


Actually you did, you just didn't know it :)  I try to write reasonably descriptive commit messages: https://git.sagemath.org/sage.git/commit/?h=56408511f00875d68b76c150455b2bcfb5f0174f&id=cab490ec9f568b6bf70ede31f93ba86d71c865e8



---

archive/issue_comments_351006.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [comment:12 jdemeyer]:\n> I see that you are checking for the importability of various modules *before* installing Python. That makes sense, but it also means that you can remove the duplicate check\n> \n> ```\n> if [ -z `find build -name _scproxy.so` ]; then\n> ```\n\n\nI'm not honestly even sure what that check is for (or why it was ever separate to begin with).  Could you provide some background?",
    "created_at": "2017-10-13T09:22:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-351006",
    "user": "https://github.com/embray"
}
```

<a id='comment:17'></a>Replying to [comment:12 jdemeyer]:
> I see that you are checking for the importability of various modules *before* installing Python. That makes sense, but it also means that you can remove the duplicate check
> 
> ```
> if [ -z `find build -name _scproxy.so` ]; then
> ```


I'm not honestly even sure what that check is for (or why it was ever separate to begin with).  Could you provide some background?



---

archive/issue_comments_351007.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [comment:15 jdemeyer]:\n> `$CUR` is undefined here:\n> \n> ```\n>     mkdir \"$CUR/include\"\n> ```\n> Just replace it with `..` since that's what it was.\n\n\nOops--carry over from a merge conflict resolution.  I'll fix that.",
    "created_at": "2017-10-13T09:24:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-351007",
    "user": "https://github.com/embray"
}
```

<a id='comment:18'></a>Replying to [comment:15 jdemeyer]:
> `$CUR` is undefined here:
> 
> ```
>     mkdir "$CUR/include"
> ```
> Just replace it with `..` since that's what it was.


Oops--carry over from a merge conflict resolution.  I'll fix that.



---

archive/issue_comments_351008.json:
```json
{
    "body": "<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-10-13T09:32:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-351008",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_351009.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [comment:17 embray]:\n> I'm not honestly even sure what that check is for (or why it was ever separate to begin with).  Could you provide some background?\n\n\nWell, the old install script worked like:\n\nA. Build Python\n\nB. Check that `_scproxy.so` was compiled (Python does not consider it an error if this optional module was not compiled)\n\nC. Install Python\n\nD. Check that `_scproxy` can be imported.\n\nEarlier versions of the install script did not have step B. This means that a broken Python could be installed in step C. So step B was added as a way of doing step D before installing. But now that you have arranged things like\n\n\nA. Build Python\n\nB. Check that `_scproxy.so` was compiled (Python does not consider it an error if this optional module was not compiled)\n\nD. Check that `_scproxy` can be imported.\n\nC. Install Python\n\nthere is no longer any reason for B: if `_scproxy` can be imported, surely it was compiled.",
    "created_at": "2017-10-13T09:32:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-351009",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>Replying to [comment:17 embray]:
> I'm not honestly even sure what that check is for (or why it was ever separate to begin with).  Could you provide some background?


Well, the old install script worked like:

A. Build Python

B. Check that `_scproxy.so` was compiled (Python does not consider it an error if this optional module was not compiled)

C. Install Python

D. Check that `_scproxy` can be imported.

Earlier versions of the install script did not have step B. This means that a broken Python could be installed in step C. So step B was added as a way of doing step D before installing. But now that you have arranged things like


A. Build Python

B. Check that `_scproxy.so` was compiled (Python does not consider it an error if this optional module was not compiled)

D. Check that `_scproxy` can be imported.

C. Install Python

there is no longer any reason for B: if `_scproxy` can be imported, surely it was compiled.



---

archive/issue_comments_351010.json:
```json
{
    "body": "<a id='comment:21'></a>I'm going to try testing this on OSX.  I now supposedly have access to an OSX machine now, but I haven't tried using it for anything yet...  Would be great if there were a reliable OSX patchbot (maybe once I get things up and running there will be :)",
    "created_at": "2017-10-13T09:33:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-351010",
    "user": "https://github.com/embray"
}
```

<a id='comment:21'></a>I'm going to try testing this on OSX.  I now supposedly have access to an OSX machine now, but I haven't tried using it for anything yet...  Would be great if there were a reliable OSX patchbot (maybe once I get things up and running there will be :)



---

archive/issue_comments_351011.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [comment:20 jdemeyer]:\n> Replying to [comment:17 embray]:\n> there is no longer any reason for B: if `_scproxy` can be imported, surely it was compiled.\n\n\nI see. I'll remove \"B\" then.  \n\nI just meant I don't know what the `_scproxy` module is or why it's checked for in the first place.",
    "created_at": "2017-10-13T09:35:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-351011",
    "user": "https://github.com/embray"
}
```

<a id='comment:22'></a>Replying to [comment:20 jdemeyer]:
> Replying to [comment:17 embray]:
> there is no longer any reason for B: if `_scproxy` can be imported, surely it was compiled.


I see. I'll remove "B" then.  

I just meant I don't know what the `_scproxy` module is or why it's checked for in the first place.



---

archive/issue_comments_351012.json:
```json
{
    "body": "<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-10-13T09:36:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-351012",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_351013.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:22 embray]:\n> I just meant I don't know what the `_scproxy` module is or why it's checked for in the first place.\n\n\nWell, I don't know it either. But clearly people consider it important.\n\n---\nNew commits:",
    "created_at": "2017-10-13T09:38:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-351013",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'></a>Replying to [comment:22 embray]:
> I just meant I don't know what the `_scproxy` module is or why it's checked for in the first place.


Well, I don't know it either. But clearly people consider it important.

---
New commits:



---

archive/issue_comments_351014.json:
```json
{
    "body": "<a id='comment:25'></a>I still don't fully understand the `-L.` issue. Under which scenario would things break without it?",
    "created_at": "2017-10-13T09:39:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-351014",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:25'></a>I still don't fully understand the `-L.` issue. Under which scenario would things break without it?



---

archive/issue_comments_351015.json:
```json
{
    "body": "<a id='comment:26'></a>Replying to [comment:25 jdemeyer]:\n> I still don't fully understand the `-L.` issue. Under which scenario would things break without it?\n\n\nSure, I'll demonstrate.  Say I disable that, and I also (for some reason) change `--enable-unicode=ucs4` to `--enable-unicode=ucs2` (this is just an easy way to wind up with an incompatible libpython).  Then I run `./sage -f python2`.  Soon as it goes to build the first extension module:\n\n```\n[python2-2.7.13.p1] gcc -shared -Wl,--enable-auto-image-base -L/home/embray/src/sagemath/sage/local/lib -Wl,-rpath,/home/embray/src/sagemath/sage/local/lib -L/home/embray/src/sagemath/sage/local/lib -Wl,-rpath,/home/embray/src/sagemath/sage/local/lib build/temp.cygwin-2.8.0-x86_64-2.7/home/embray/src/sagemath/sage/local/var/tmp/sage/build/python2-2.7.13.p1/src/Modules/_struct.o -L/home/embray/src/sagemath/sage/local/lib -L/usr/local/lib -L. -L. -lpython2.7 -o build/lib.cygwin-2.8.0-x86_64-2.7/_struct.dll\n[python2-2.7.13.p1] build/temp.cygwin-2.8.0-x86_64-2.7/home/embray/src/sagemath/sage/local/var/tmp/sage/build/python2-2.7.13.p1/src/Modules/_struct.o: In function `s_init':\n[python2-2.7.13.p1] /home/embray/src/sagemath/sage/local/var/tmp/sage/build/python2-2.7.13.p1/src/Modules/_struct.c:1383: undefined reference to `PyUnicodeUCS2_AsEncodedString'\n[python2-2.7.13.p1] /home/embray/src/sagemath/sage/local/var/tmp/sage/build/python2-2.7.13.p1/src/Modules/_struct.c:1383:(.text+0x1234): relocation truncated to fit: R_X86_64_PC32 against undefined symbol `PyUnicodeUCS2_AsEncodedString'\n[python2-2.7.13.p1] collect2: error: ld returned 1 exit status\n```\n\nThose gcc flags are already something of a mess.  Several of the flags are duplicated (I'm not sure why). But also, as I explained in the commit message, our `LDFLAGS` are inserted very early on, so the linker finds `-lpython2.7` in `$SAGE_LOCAL/lib`, when it should be finding it in the current directory--the libpython that was just built.",
    "created_at": "2017-10-13T10:01:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-351015",
    "user": "https://github.com/embray"
}
```

<a id='comment:26'></a>Replying to [comment:25 jdemeyer]:
> I still don't fully understand the `-L.` issue. Under which scenario would things break without it?


Sure, I'll demonstrate.  Say I disable that, and I also (for some reason) change `--enable-unicode=ucs4` to `--enable-unicode=ucs2` (this is just an easy way to wind up with an incompatible libpython).  Then I run `./sage -f python2`.  Soon as it goes to build the first extension module:

```
[python2-2.7.13.p1] gcc -shared -Wl,--enable-auto-image-base -L/home/embray/src/sagemath/sage/local/lib -Wl,-rpath,/home/embray/src/sagemath/sage/local/lib -L/home/embray/src/sagemath/sage/local/lib -Wl,-rpath,/home/embray/src/sagemath/sage/local/lib build/temp.cygwin-2.8.0-x86_64-2.7/home/embray/src/sagemath/sage/local/var/tmp/sage/build/python2-2.7.13.p1/src/Modules/_struct.o -L/home/embray/src/sagemath/sage/local/lib -L/usr/local/lib -L. -L. -lpython2.7 -o build/lib.cygwin-2.8.0-x86_64-2.7/_struct.dll
[python2-2.7.13.p1] build/temp.cygwin-2.8.0-x86_64-2.7/home/embray/src/sagemath/sage/local/var/tmp/sage/build/python2-2.7.13.p1/src/Modules/_struct.o: In function `s_init':
[python2-2.7.13.p1] /home/embray/src/sagemath/sage/local/var/tmp/sage/build/python2-2.7.13.p1/src/Modules/_struct.c:1383: undefined reference to `PyUnicodeUCS2_AsEncodedString'
[python2-2.7.13.p1] /home/embray/src/sagemath/sage/local/var/tmp/sage/build/python2-2.7.13.p1/src/Modules/_struct.c:1383:(.text+0x1234): relocation truncated to fit: R_X86_64_PC32 against undefined symbol `PyUnicodeUCS2_AsEncodedString'
[python2-2.7.13.p1] collect2: error: ld returned 1 exit status
```

Those gcc flags are already something of a mess.  Several of the flags are duplicated (I'm not sure why). But also, as I explained in the commit message, our `LDFLAGS` are inserted very early on, so the linker finds `-lpython2.7` in `$SAGE_LOCAL/lib`, when it should be finding it in the current directory--the libpython that was just built.



---

archive/issue_comments_351016.json:
```json
{
    "body": "<a id='comment:27'></a>I'll note it's possible this isn't as often a problem on Linux since it's not necessary to resolve all symbols at link time when linking shared libraries.",
    "created_at": "2017-10-13T10:04:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-351016",
    "user": "https://github.com/embray"
}
```

<a id='comment:27'></a>I'll note it's possible this isn't as often a problem on Linux since it's not necessary to resolve all symbols at link time when linking shared libraries.



---

archive/issue_comments_351017.json:
```json
{
    "body": "<a id='comment:28'></a>I don't agree with the `-L.` thing. I suggest to take it out and create a separate ticket of it (if you think that it is important enough).\n\nThe problem with the current approach is that those `LDFLAGS` are inherited by other Python packages. I don't know the exact mechanism, since it doesn't happen with the Sage library for example. But this is an example command line from scipy with this patch:\n\n```\ngcc -pthread -shared -L. -L/home/jdemeyer/sage/local/lib -Wl,-rpath,/home/jdemeyer/sage/local/lib -shared -L/home/jdemeyer/sage/local/lib -Wl,-rpath,/home/jdemeyer/sage/local/lib build/temp.linux-x86_64-2.7/scipy/cluster/_vq.o -L/home/jdemeyer/sage/local/lib -L/home/jdemeyer/sage/local/lib -Lbuild/temp.linux-x86_64-2.7 -lopenblas -lopenblas -lpython2.7 -o build/lib.linux-x86_64-2.7/scipy/cluster/_vq.so\n```\nWithout this patch, this `-L.` wasn't there.",
    "created_at": "2017-10-14T07:44:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-351017",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:28'></a>I don't agree with the `-L.` thing. I suggest to take it out and create a separate ticket of it (if you think that it is important enough).

The problem with the current approach is that those `LDFLAGS` are inherited by other Python packages. I don't know the exact mechanism, since it doesn't happen with the Sage library for example. But this is an example command line from scipy with this patch:

```
gcc -pthread -shared -L. -L/home/jdemeyer/sage/local/lib -Wl,-rpath,/home/jdemeyer/sage/local/lib -shared -L/home/jdemeyer/sage/local/lib -Wl,-rpath,/home/jdemeyer/sage/local/lib build/temp.linux-x86_64-2.7/scipy/cluster/_vq.o -L/home/jdemeyer/sage/local/lib -L/home/jdemeyer/sage/local/lib -Lbuild/temp.linux-x86_64-2.7 -lopenblas -lopenblas -lpython2.7 -o build/lib.linux-x86_64-2.7/scipy/cluster/_vq.so
```
Without this patch, this `-L.` wasn't there.



---

archive/issue_comments_351018.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-10-14T07:44:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-351018",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_351019.json:
```json
{
    "body": "<a id='comment:29'></a>If you want to fix the `-L.` issue, I think it's better to fix the upstream build system instead.",
    "created_at": "2017-10-14T07:45:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-351019",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:29'></a>If you want to fix the `-L.` issue, I think it's better to fix the upstream build system instead.



---

archive/issue_comments_351020.json:
```json
{
    "body": "<a id='comment:30'></a>I see what you're saying, but this is a problem that needs to be solved somehow.\n\nI don't want to make a separate ticket because \n\na) I'm sick of refactoring \n\nb) At some point (weeks ago, so I can't remember why) this was important enough to add to this ticket, because without it something was breaking.",
    "created_at": "2017-10-16T12:19:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-351020",
    "user": "https://github.com/embray"
}
```

<a id='comment:30'></a>I see what you're saying, but this is a problem that needs to be solved somehow.

I don't want to make a separate ticket because 

a) I'm sick of refactoring 

b) At some point (weeks ago, so I can't remember why) this was important enough to add to this ticket, because without it something was breaking.



---

archive/issue_comments_351021.json:
```json
{
    "body": "<a id='comment:31'></a>Replying to [comment:30 embray]:\n> I see what you're saying, but this is a problem that needs to be solved somehow.\n\n\nWhat do you think of my proposal to fix the Python upstream build system to put `-L.` in the correct place? That looks like the best solution. And it doesn't affect distros because this is a pure build issue.",
    "created_at": "2017-10-16T12:31:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-351021",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:31'></a>Replying to [comment:30 embray]:
> I see what you're saying, but this is a problem that needs to be solved somehow.


What do you think of my proposal to fix the Python upstream build system to put `-L.` in the correct place? That looks like the best solution. And it doesn't affect distros because this is a pure build issue.



---

archive/issue_comments_351022.json:
```json
{
    "body": "<a id='comment:32'></a>Replying to [comment:31 jdemeyer]:\n> Replying to [comment:30 embray]:\n> > I see what you're saying, but this is a problem that needs to be solved somehow.\n\n> \n> What do you think of my proposal to fix the Python upstream build system to put `-L.` in the correct place? That looks like the best solution. And it doesn't affect distros because this is a pure build issue.\n\n\nI'd definitely be fine with that--I'm just going to look around a bit more to see if there isn't already a solution to this.  It seems odd to me that there wouldn't be.",
    "created_at": "2017-10-16T12:41:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-351022",
    "user": "https://github.com/embray"
}
```

<a id='comment:32'></a>Replying to [comment:31 jdemeyer]:
> Replying to [comment:30 embray]:
> > I see what you're saying, but this is a problem that needs to be solved somehow.

> 
> What do you think of my proposal to fix the Python upstream build system to put `-L.` in the correct place? That looks like the best solution. And it doesn't affect distros because this is a pure build issue.


I'd definitely be fine with that--I'm just going to look around a bit more to see if there isn't already a solution to this.  It seems odd to me that there wouldn't be.



---

archive/issue_comments_351023.json:
```json
{
    "body": "<a id='comment:33'></a>Okay, there is a better solution, which in retrospect is obvious--instead of exporting `LDFLAGS=\"-L. ...\"`, just pass the additional flags at `make` time:\n\n    `make LDFLAGS=\"-L. $LDFLAGS\"`\n\nThis does not change the defaults that are saved to the `Makefile` by `configure` (and hence does not impact the flags used in the future for building extension modules).  But it does ensure that the correct flags are added for building the extension modules included with Python.\n\nWhether or not this is an upstream bug is debatable, but I'll ask on python-dev.",
    "created_at": "2017-10-16T13:04:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-351023",
    "user": "https://github.com/embray"
}
```

<a id='comment:33'></a>Okay, there is a better solution, which in retrospect is obvious--instead of exporting `LDFLAGS="-L. ..."`, just pass the additional flags at `make` time:

    `make LDFLAGS="-L. $LDFLAGS"`

This does not change the defaults that are saved to the `Makefile` by `configure` (and hence does not impact the flags used in the future for building extension modules).  But it does ensure that the correct flags are added for building the extension modules included with Python.

Whether or not this is an upstream bug is debatable, but I'll ask on python-dev.



---

archive/issue_comments_351024.json:
```json
{
    "body": "<a id='comment:34'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-10-16T15:02:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-351024",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:34'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_351025.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-10-16T15:03:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-351025",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_351026.json:
```json
{
    "body": "<a id='comment:35'></a>How does this looks?  It seems to work for me.\n\nIf you still really want me to make a separate ticket for the link issue I can do so; I would just prefer not to bother.",
    "created_at": "2017-10-16T15:03:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-351026",
    "user": "https://github.com/embray"
}
```

<a id='comment:35'></a>How does this looks?  It seems to work for me.

If you still really want me to make a separate ticket for the link issue I can do so; I would just prefer not to bother.



---

archive/issue_comments_351027.json:
```json
{
    "body": "<a id='comment:36'></a>I just need to test this, but your explanation sounds OK.",
    "created_at": "2017-10-18T20:25:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-351027",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:36'></a>I just need to test this, but your explanation sounds OK.



---

archive/issue_comments_351028.json:
```json
{
    "body": "<a id='comment:37'></a>Replying to [comment:35 embray]:\n> If you still really want me to make a separate ticket for the link issue I can do so; I would just prefer not to bother.\n\n\nIf there is an easy fix, that's fine. It's just that I'd rather finish this ticket instead of keeping struggling with this one issue.",
    "created_at": "2017-10-18T20:26:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-351028",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:37'></a>Replying to [comment:35 embray]:
> If you still really want me to make a separate ticket for the link issue I can do so; I would just prefer not to bother.


If there is an easy fix, that's fine. It's just that I'd rather finish this ticket instead of keeping struggling with this one issue.



---

archive/issue_comments_351029.json:
```json
{
    "body": "<a id='comment:39'></a>Looks good to me. One final thing: when making such substantial changes to the build/install scripts, it is safer to increase the patchlevel of the packages (even if one could argue that this is not strictly needed). I did that in a follow-up commit. Do you agree?\n\n---\nNew commits:",
    "created_at": "2017-10-20T14:52:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-351029",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:39'></a>Looks good to me. One final thing: when making such substantial changes to the build/install scripts, it is safer to increase the patchlevel of the packages (even if one could argue that this is not strictly needed). I did that in a follow-up commit. Do you agree?

---
New commits:



---

archive/issue_comments_351030.json:
```json
{
    "body": "<a id='comment:40'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-10-22T20:26:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-351030",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:40'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_351031.json:
```json
{
    "body": "<a id='comment:41'></a>Yes--I think that's an unfortunate quirk of how we do continuous integration for Sage, but under the current circumstances I think it makes sense.",
    "created_at": "2017-10-23T08:48:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-351031",
    "user": "https://github.com/embray"
}
```

<a id='comment:41'></a>Yes--I think that's an unfortunate quirk of how we do continuous integration for Sage, but under the current circumstances I think it makes sense.



---

archive/issue_comments_351032.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-10-23T08:57:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-351032",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_060659.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-10-25T06:58:09Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23781#event-60659"
}
```



---

archive/issue_comments_351033.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-10-25T06:58:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23781#issuecomment-351033",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
