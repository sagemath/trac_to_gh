# Issue 23411: Fix pickling of matrix_gfpn_dense

archive/issues_023174.json:
```json
{
    "body": "There currently are two problems related with pickling of `Matrix_gfpn_dense`: \n- When a string is provided as argument to `__init__`, it is interpreted as the name of a file from which data are read by some MeatAxe command. If the file doesn't exist, it was intended to have an uninitialised matrix (to be properly initialised later). But currently it crashes, which needs to be fixed.\n- The number of bytes used holding the data of a matrix row is machine independent. However, the number of bytes actually used to store the row always is a multiple of `sizeof(long)`, which is machine dependent (at least in theory). Pickling should of course only involve the machine independent memory chunks, but currently it involves the machine dependent chunks.\n\nBranch/Commit: ba72abac8a53b3d292df570d31709ab5c2f57157\n\nReviewer: Jeroen Demeyer\n\nAuthor: Simon King\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/23411\n\n",
    "closed_at": "2017-07-29T15:30:47Z",
    "created_at": "2017-07-12T14:19:25Z",
    "labels": [
        "component: packages: optional",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Fix pickling of matrix_gfpn_dense",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23411",
    "user": "https://github.com/simon-king-jena"
}
```
There currently are two problems related with pickling of `Matrix_gfpn_dense`: 
- When a string is provided as argument to `__init__`, it is interpreted as the name of a file from which data are read by some MeatAxe command. If the file doesn't exist, it was intended to have an uninitialised matrix (to be properly initialised later). But currently it crashes, which needs to be fixed.
- The number of bytes used holding the data of a matrix row is machine independent. However, the number of bytes actually used to store the row always is a multiple of `sizeof(long)`, which is machine dependent (at least in theory). Pickling should of course only involve the machine independent memory chunks, but currently it involves the machine dependent chunks.

Branch/Commit: ba72abac8a53b3d292df570d31709ab5c2f57157

Reviewer: Jeroen Demeyer

Author: Simon King

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/23411





---

archive/issue_comments_440038.json:
```json
{
    "body": "Changing branch from \"\" to \"u/SimonKing/fix_pickling_of_matrix_gfpn_dense\"",
    "created_at": "2017-07-12T15:08:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440038",
    "user": "https://github.com/simon-king-jena"
}
```

Changing branch from "" to "u/SimonKing/fix_pickling_of_matrix_gfpn_dense"



---

archive/issue_comments_440039.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-07-12T15:09:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440039",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_440040.json:
```json
{
    "body": "Changing author from \"\" to \"Simon King\"",
    "created_at": "2017-07-12T15:09:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440040",
    "user": "https://github.com/simon-king-jena"
}
```

Changing author from "" to "Simon King"



---

archive/issue_comments_440041.json:
```json
{
    "body": "<a id='comment:2'></a>\nNew commits:\n|                                                                                                                                          |                                               |\n|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------|\n|[4960a81](https://git.sagemath.org/sage.git/commit?id=4960a8166debbb446e7da6f26586d742e9f12f0d)|`Fix reading mtx-matrix from non-existent file`|\n|[4e85fca](https://git.sagemath.org/sage.git/commit?id=4e85fca604650a1f29ff2ae13aa1263737685891)|`Make pickling of matrix_gfpn_dense machine independent`|",
    "created_at": "2017-07-12T15:09:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440041",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:2'></a>
New commits:
|                                                                                                                                          |                                               |
|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------|
|[4960a81](https://git.sagemath.org/sage.git/commit?id=4960a8166debbb446e7da6f26586d742e9f12f0d)|`Fix reading mtx-matrix from non-existent file`|
|[4e85fca](https://git.sagemath.org/sage.git/commit?id=4e85fca604650a1f29ff2ae13aa1263737685891)|`Make pickling of matrix_gfpn_dense machine independent`|



---

archive/issue_comments_440042.json:
```json
{
    "body": "Changing commit from \"\" to \"4e85fca604650a1f29ff2ae13aa1263737685891\"",
    "created_at": "2017-07-12T15:09:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440042",
    "user": "https://github.com/simon-king-jena"
}
```

Changing commit from "" to "4e85fca604650a1f29ff2ae13aa1263737685891"



---

archive/issue_comments_440043.json:
```json
{
    "body": "<a id='comment:3'></a>\nSorry, one commit is missing",
    "created_at": "2017-07-12T15:12:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440043",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:3'></a>
Sorry, one commit is missing



---

archive/issue_comments_440044.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-07-12T15:12:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440044",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_440045.json:
```json
{
    "body": "Changing commit from \"4e85fca604650a1f29ff2ae13aa1263737685891\" to \"f9d878abdf0c0742ffaeefe2176c5217521b3dd7\"",
    "created_at": "2017-07-12T15:48:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440045",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "4e85fca604650a1f29ff2ae13aa1263737685891" to "f9d878abdf0c0742ffaeefe2176c5217521b3dd7"



---

archive/issue_comments_440046.json:
```json
{
    "body": "<a id='comment:4'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                           |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------|\n|[f9d878a](https://git.sagemath.org/sage.git/commit/?id=f9d878abdf0c0742ffaeefe2176c5217521b3dd7)|`Add test for reading from non-existing file; add cimports`|",
    "created_at": "2017-07-12T15:48:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440046",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                           |
|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------|
|[f9d878a](https://git.sagemath.org/sage.git/commit/?id=f9d878abdf0c0742ffaeefe2176c5217521b3dd7)|`Add test for reading from non-existing file; add cimports`|



---

archive/issue_comments_440047.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-07-12T15:49:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440047",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_440048.json:
```json
{
    "body": "<a id='comment:5'></a>\nNow it builds and tests are passing...",
    "created_at": "2017-07-12T15:49:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440048",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:5'></a>
Now it builds and tests are passing...



---

archive/issue_comments_440049.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-07-13T09:50:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440049",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_440050.json:
```json
{
    "body": "<a id='comment:6'></a>\n1. As I mentioned on some other ticket, use `bytes` instead of `str` for pickling.\n\n2. If you claim that this makes pickling machine-independent, it would be good to actually test that. You can hardcode a pickle in a doctest (essentially, the output of `dumps()`) and then test that.",
    "created_at": "2017-07-13T09:50:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440050",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>
1. As I mentioned on some other ticket, use `bytes` instead of `str` for pickling.

2. If you claim that this makes pickling machine-independent, it would be good to actually test that. You can hardcode a pickle in a doctest (essentially, the output of `dumps()`) and then test that.



---

archive/issue_comments_440051.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [jdemeyer](#comment%3A6):\n> 1. As I mentioned on some other ticket, use `bytes` instead of `str` for pickling.\n\n\nYou also said I should split my original patchbomb into smaller parts. That's why I wanted to leave the transition from `str` to `bytes` for a ticket dedicated to cleaning code.\n\n> 2. If you claim that this makes pickling machine-independent, it would be good to actually test that. You can hardcode a pickle in a doctest (essentially, the output of `dumps()`) and then test that.\n\n\nOK. Just to be on the safe side: You do not say that I should imitate a pickle string that results from a machine where, say, `sizeof(long)==3`? Cause otherwise we would never see the deprecation warning.",
    "created_at": "2017-07-13T10:07:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440051",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:7'></a>
Replying to [jdemeyer](#comment%3A6):
> 1. As I mentioned on some other ticket, use `bytes` instead of `str` for pickling.


You also said I should split my original patchbomb into smaller parts. That's why I wanted to leave the transition from `str` to `bytes` for a ticket dedicated to cleaning code.

> 2. If you claim that this makes pickling machine-independent, it would be good to actually test that. You can hardcode a pickle in a doctest (essentially, the output of `dumps()`) and then test that.


OK. Just to be on the safe side: You do not say that I should imitate a pickle string that results from a machine where, say, `sizeof(long)==3`? Cause otherwise we would never see the deprecation warning.



---

archive/issue_comments_440052.json:
```json
{
    "body": "<a id='comment:8'></a>\nReplying to [SimonKing](#comment%3A7):\n> You also said I should split my original patchbomb into smaller parts. That's why I wanted to leave the transition from `str` to `bytes` for a ticket dedicated to cleaning code.\n\n\nPS: Adding such patch would also imply to modify the lines where I import the `PyString...` functions, which means that there will be further conflicts with #21437.",
    "created_at": "2017-07-13T10:12:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440052",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'></a>
Replying to [SimonKing](#comment%3A7):
> You also said I should split my original patchbomb into smaller parts. That's why I wanted to leave the transition from `str` to `bytes` for a ticket dedicated to cleaning code.


PS: Adding such patch would also imply to modify the lines where I import the `PyString...` functions, which means that there will be further conflicts with #21437.



---

archive/issue_comments_440053.json:
```json
{
    "body": "<a id='comment:9'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                   |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------|\n|[e477948](https://git.sagemath.org/sage.git/commit/?id=e477948bb0a393997082fffea411e1724517ecaa)|`Test meataxe unpickling being machine independent`|",
    "created_at": "2017-07-13T11:20:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440053",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                   |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------|
|[e477948](https://git.sagemath.org/sage.git/commit/?id=e477948bb0a393997082fffea411e1724517ecaa)|`Test meataxe unpickling being machine independent`|



---

archive/issue_comments_440054.json:
```json
{
    "body": "Changing commit from \"f9d878abdf0c0742ffaeefe2176c5217521b3dd7\" to \"e477948bb0a393997082fffea411e1724517ecaa\"",
    "created_at": "2017-07-13T11:20:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440054",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "f9d878abdf0c0742ffaeefe2176c5217521b3dd7" to "e477948bb0a393997082fffea411e1724517ecaa"



---

archive/issue_comments_440055.json:
```json
{
    "body": "<a id='comment:10'></a>\nIn the latest commit, I add a test that should demonstrate machine independence of pickling (provided that the patchbots provide a whole lot of different architectures, including little and big endian and different sizes of `long`). I also add a test that triggers the deprecation warning.\n\nI am not really happy about doing part of the code cleanup here. Would you accept to do all cleanup on a separate ticket. If you do, then please consider this ticket as \"needs review\".",
    "created_at": "2017-07-13T11:24:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440055",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:10'></a>
In the latest commit, I add a test that should demonstrate machine independence of pickling (provided that the patchbots provide a whole lot of different architectures, including little and big endian and different sizes of `long`). I also add a test that triggers the deprecation warning.

I am not really happy about doing part of the code cleanup here. Would you accept to do all cleanup on a separate ticket. If you do, then please consider this ticket as "needs review".



---

archive/issue_comments_440056.json:
```json
{
    "body": "<a id='comment:11'></a>\nSetting it to \"needs review\" in order to allow the patchbots to test the ticket.",
    "created_at": "2017-07-13T11:25:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440056",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:11'></a>
Setting it to "needs review" in order to allow the patchbots to test the ticket.



---

archive/issue_comments_440057.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-07-13T11:25:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440057",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_440058.json:
```json
{
    "body": "<a id='comment:12'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                  |\n|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------|\n|[01e2c0d](https://git.sagemath.org/sage.git/commit/?id=01e2c0dcbcf05ef8dbe4b1f83b8334873ebd6f5a)|`Mark new meataxe test 'optional'`|",
    "created_at": "2017-07-13T12:37:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440058",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                  |
|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------|
|[01e2c0d](https://git.sagemath.org/sage.git/commit/?id=01e2c0dcbcf05ef8dbe4b1f83b8334873ebd6f5a)|`Mark new meataxe test 'optional'`|



---

archive/issue_comments_440059.json:
```json
{
    "body": "Changing commit from \"e477948bb0a393997082fffea411e1724517ecaa\" to \"01e2c0dcbcf05ef8dbe4b1f83b8334873ebd6f5a\"",
    "created_at": "2017-07-13T12:37:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440059",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "e477948bb0a393997082fffea411e1724517ecaa" to "01e2c0dcbcf05ef8dbe4b1f83b8334873ebd6f5a"



---

archive/issue_comments_440060.json:
```json
{
    "body": "<a id='comment:13'></a>\nQuestion: Will the buildbot automatically test with and without meataxe being installed? If not: How can I advice the buildbot to do so?",
    "created_at": "2017-07-13T12:40:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440060",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:13'></a>
Question: Will the buildbot automatically test with and without meataxe being installed? If not: How can I advice the buildbot to do so?



---

archive/issue_comments_440061.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [SimonKing](#comment%3A7):\n> Replying to [jdemeyer](#comment%3A6):\n> > 1. As I mentioned on some other ticket, use `bytes` instead of `str` for pickling.\n  \n> \n> You also said I should split my original patchbomb into smaller parts. That's why I wanted to leave the transition from `str` to `bytes` for a ticket dedicated to cleaning code.\n\n\nIt's just a bit strange that you write \"unclean\" code in one ticket and then at the same time have another ticket to clean it up.\n\nBut that's not a big deal since the old code also uses strings.",
    "created_at": "2017-07-13T13:35:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440061",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>
Replying to [SimonKing](#comment%3A7):
> Replying to [jdemeyer](#comment%3A6):
> > 1. As I mentioned on some other ticket, use `bytes` instead of `str` for pickling.
  
> 
> You also said I should split my original patchbomb into smaller parts. That's why I wanted to leave the transition from `str` to `bytes` for a ticket dedicated to cleaning code.


It's just a bit strange that you write "unclean" code in one ticket and then at the same time have another ticket to clean it up.

But that's not a big deal since the old code also uses strings.



---

archive/issue_comments_440062.json:
```json
{
    "body": "<a id='comment:15'></a>\nAlso in some other ticket, I made the comment that you should use floor division (`//`) if that's what you want.",
    "created_at": "2017-07-13T13:36:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440062",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:15'></a>
Also in some other ticket, I made the comment that you should use floor division (`//`) if that's what you want.



---

archive/issue_comments_440063.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-07-13T13:39:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440063",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_440064.json:
```json
{
    "body": "<a id='comment:16'></a>\nPlease do not use the `for ... from ...` syntax. Cython understands `range()`.",
    "created_at": "2017-07-13T13:39:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440064",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'></a>
Please do not use the `for ... from ...` syntax. Cython understands `range()`.



---

archive/issue_comments_440065.json:
```json
{
    "body": "<a id='comment:17'></a>\nWhen unpickling, it seems that there is no protecting against reading out of bounds. The case where `x` is too short should be handled gracefully. The code should be more like:\n\n```\nif len(Data) == expected_size:\n    # Handle new-style pickle\nelif len(Data) == expected_size_for_old_pickle:\n    # Handle deprecated pickle\nelse:\n    raise ValueError(f\"expected a pickle with {expected_size} bytes, got {len(Data)} instead\")\n```\nEDIT: note the swapped conditions. It is possible that `expected_size == expected_size_for_old_pickle`.\n\nAnd a small detail: you write twice `x = PyString_AsString(Data)` while once (outside the branch) should be sufficient.",
    "created_at": "2017-07-13T13:47:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440065",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>
When unpickling, it seems that there is no protecting against reading out of bounds. The case where `x` is too short should be handled gracefully. The code should be more like:

```
if len(Data) == expected_size:
    # Handle new-style pickle
elif len(Data) == expected_size_for_old_pickle:
    # Handle deprecated pickle
else:
    raise ValueError(f"expected a pickle with {expected_size} bytes, got {len(Data)} instead")
```
EDIT: note the swapped conditions. It is possible that `expected_size == expected_size_for_old_pickle`.

And a small detail: you write twice `x = PyString_AsString(Data)` while once (outside the branch) should be sufficient.



---

archive/issue_comments_440066.json:
```json
{
    "body": "<a id='comment:18'></a>\nReplying to [jdemeyer](#comment%3A14):\n> It's just a bit strange that you write \"unclean\" code in one ticket and then at the same time have another ticket to clean it up.\n> \n> But that's not a big deal since the old code also uses strings.\n\n\nRight. And you spotted further problems with the code added by this ticket.\n\nSo, I guess it is better to clean the new code, although it will imply manual merging in other tickets.",
    "created_at": "2017-07-13T14:02:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440066",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:18'></a>
Replying to [jdemeyer](#comment%3A14):
> It's just a bit strange that you write "unclean" code in one ticket and then at the same time have another ticket to clean it up.
> 
> But that's not a big deal since the old code also uses strings.


Right. And you spotted further problems with the code added by this ticket.

So, I guess it is better to clean the new code, although it will imply manual merging in other tickets.



---

archive/issue_comments_440067.json:
```json
{
    "body": "<a id='comment:19'></a>\nIf I were you, I would first focus on getting these first tickets accepted, otherwise you will be forever merging and rebasing :-)",
    "created_at": "2017-07-13T14:30:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440067",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'></a>
If I were you, I would first focus on getting these first tickets accepted, otherwise you will be forever merging and rebasing :-)



---

archive/issue_comments_440068.json:
```json
{
    "body": "Changing commit from \"01e2c0dcbcf05ef8dbe4b1f83b8334873ebd6f5a\" to \"d1748351fe1ab0201647ce98b83c29188534a2ea\"",
    "created_at": "2017-07-13T14:38:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440068",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "01e2c0dcbcf05ef8dbe4b1f83b8334873ebd6f5a" to "d1748351fe1ab0201647ce98b83c29188534a2ea"



---

archive/issue_comments_440069.json:
```json
{
    "body": "<a id='comment:20'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                               |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------|\n|[d174835](https://git.sagemath.org/sage.git/commit/?id=d1748351fe1ab0201647ce98b83c29188534a2ea)|`Check bounds when unpickling meataxe matrices`|",
    "created_at": "2017-07-13T14:38:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440069",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:20'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                               |
|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------|
|[d174835](https://git.sagemath.org/sage.git/commit/?id=d1748351fe1ab0201647ce98b83c29188534a2ea)|`Check bounds when unpickling meataxe matrices`|



---

archive/issue_comments_440070.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-07-13T14:39:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440070",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_440071.json:
```json
{
    "body": "<a id='comment:22'></a>\nReplying to [jdemeyer](#comment%3A19):\n> If I were you, I would first focus on getting these first tickets accepted, otherwise you will be forever merging and rebasing :-)\n\n\nHooray, it merges cleanly into #21437...\n\nI guess I'll wait a while till I move on to #23400.",
    "created_at": "2017-07-13T14:44:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440071",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:22'></a>
Replying to [jdemeyer](#comment%3A19):
> If I were you, I would first focus on getting these first tickets accepted, otherwise you will be forever merging and rebasing :-)


Hooray, it merges cleanly into #21437...

I guess I'll wait a while till I move on to #23400.



---

archive/issue_comments_440072.json:
```json
{
    "body": "<a id='comment:23'></a>\nPS: Perhaps it would have been better to *first* clean the existing code, and then do the bug fixes and additions. But I suppose I shouldn't change the order of tickets again, or should I?",
    "created_at": "2017-07-13T14:45:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440072",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:23'></a>
PS: Perhaps it would have been better to *first* clean the existing code, and then do the bug fixes and additions. But I suppose I shouldn't change the order of tickets again, or should I?



---

archive/issue_comments_440073.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-07-13T14:57:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440073",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_440074.json:
```json
{
    "body": "<a id='comment:24'></a>\nThis is a potential division by zero:\n\n```\ncdef size_t pickled_rowsize = lenData//nr\n```\nIt would be good to add a doctest for the case `nr == 0`.\n\nI think the best solution is to replace the condition `if Data` by `if nr`.",
    "created_at": "2017-07-13T14:57:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440074",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'></a>
This is a potential division by zero:

```
cdef size_t pickled_rowsize = lenData//nr
```
It would be good to add a doctest for the case `nr == 0`.

I think the best solution is to replace the condition `if Data` by `if nr`.



---

archive/issue_comments_440075.json:
```json
{
    "body": "<a id='comment:25'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                  |\n|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------|\n|[8873330](https://git.sagemath.org/sage.git/commit/?id=8873330db79f5aa72de43f9be0e7babba07b05dd)|`Mark further meataxe tests optional; fix potential zero division`|",
    "created_at": "2017-07-15T11:39:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440075",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:25'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                  |
|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------|
|[8873330](https://git.sagemath.org/sage.git/commit/?id=8873330db79f5aa72de43f9be0e7babba07b05dd)|`Mark further meataxe tests optional; fix potential zero division`|



---

archive/issue_comments_440076.json:
```json
{
    "body": "Changing commit from \"d1748351fe1ab0201647ce98b83c29188534a2ea\" to \"8873330db79f5aa72de43f9be0e7babba07b05dd\"",
    "created_at": "2017-07-15T11:39:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440076",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "d1748351fe1ab0201647ce98b83c29188534a2ea" to "8873330db79f5aa72de43f9be0e7babba07b05dd"



---

archive/issue_comments_440077.json:
```json
{
    "body": "<a id='comment:26'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                |\n|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------|\n|[7a1ed5a](https://git.sagemath.org/sage.git/commit/?id=7a1ed5adf98cdbfbc4300205faa584df83728766)|`Meataxe unpickling: Further consistency checks`|",
    "created_at": "2017-07-15T11:48:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440077",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:26'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                |
|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------|
|[7a1ed5a](https://git.sagemath.org/sage.git/commit/?id=7a1ed5adf98cdbfbc4300205faa584df83728766)|`Meataxe unpickling: Further consistency checks`|



---

archive/issue_comments_440078.json:
```json
{
    "body": "Changing commit from \"8873330db79f5aa72de43f9be0e7babba07b05dd\" to \"7a1ed5adf98cdbfbc4300205faa584df83728766\"",
    "created_at": "2017-07-15T11:48:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440078",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "8873330db79f5aa72de43f9be0e7babba07b05dd" to "7a1ed5adf98cdbfbc4300205faa584df83728766"



---

archive/issue_comments_440079.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-07-15T11:50:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440079",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_440080.json:
```json
{
    "body": "<a id='comment:28'></a>\nAssertions are meant to guard against bugs, not against invalid input. Your `assert` should be a `raise ValueError`.",
    "created_at": "2017-07-17T08:38:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440080",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:28'></a>
Assertions are meant to guard against bugs, not against invalid input. Your `assert` should be a `raise ValueError`.



---

archive/issue_comments_440081.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-07-17T08:38:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440081",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_440082.json:
```json
{
    "body": "<a id='comment:29'></a>\nIt would be good to add doctests for *correct* unpickling of matrices with zero rows or columns.",
    "created_at": "2017-07-17T08:40:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440082",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:29'></a>
It would be good to add doctests for *correct* unpickling of matrices with zero rows or columns.



---

archive/issue_comments_440083.json:
```json
{
    "body": "<a id='comment:30'></a>\nReplying to [jdemeyer](#comment%3A28):\n> Assertions are meant to guard against bugs, not against invalid input. Your `assert` should be a `raise ValueError`.\n\n\nOK. And I guess since I am touching some sub-optimal code here (using `PyString...`), it'd be better to clean this here, not in #23400",
    "created_at": "2017-07-17T08:42:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440083",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:30'></a>
Replying to [jdemeyer](#comment%3A28):
> Assertions are meant to guard against bugs, not against invalid input. Your `assert` should be a `raise ValueError`.


OK. And I guess since I am touching some sub-optimal code here (using `PyString...`), it'd be better to clean this here, not in #23400



---

archive/issue_comments_440084.json:
```json
{
    "body": "<a id='comment:31'></a>\nReplying to [jdemeyer](#comment%3A29):\n> It would be good to add doctests for *correct* unpickling of matrices with zero rows or columns.\n\n\nDo you mean a test with hard-coded pickle string? Or a test in the form `loads(dumps(M))==M`?",
    "created_at": "2017-07-17T08:43:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440084",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:31'></a>
Replying to [jdemeyer](#comment%3A29):
> It would be good to add doctests for *correct* unpickling of matrices with zero rows or columns.


Do you mean a test with hard-coded pickle string? Or a test in the form `loads(dumps(M))==M`?



---

archive/issue_comments_440085.json:
```json
{
    "body": "<a id='comment:32'></a>\nReplying to [SimonKing](#comment%3A31):\n> Replying to [jdemeyer](#comment%3A29):\n> > It would be good to add doctests for *correct* unpickling of matrices with zero rows or columns.\n\n> \n> Do you mean a test with hard-coded pickle string? Or a test in the form `loads(dumps(M))==M`?\n\n\nI meant the latter.  Although an explicit call to `mtx_unpickle` with empty `Data` would be good also.",
    "created_at": "2017-07-17T08:45:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440085",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:32'></a>
Replying to [SimonKing](#comment%3A31):
> Replying to [jdemeyer](#comment%3A29):
> > It would be good to add doctests for *correct* unpickling of matrices with zero rows or columns.

> 
> Do you mean a test with hard-coded pickle string? Or a test in the form `loads(dumps(M))==M`?


I meant the latter.  Although an explicit call to `mtx_unpickle` with empty `Data` would be good also.



---

archive/issue_comments_440086.json:
```json
{
    "body": "Replying to [ticket:23411 SimonKing]:\n> - When a string is provided as argument to `__init__`, it is interpreted as the name of a file from which data are read by some MeatAxe command. If the file doesn't exist, it was intended to have an uninitialised matrix (to be properly initialised later). But currently it crashes, which needs to be fixed.\n\n\nI don't like your fix for this for several reasons:\n\n1. I can't actually reproduce the issue. Without this patch, the doctest that you added passes. I think this is because the memory for Python objects is automatically initialized with all zeros.\n\n2. If the result of `__cinit__` is really invalid in some way, then it means that there is something wrong with `__cinit__`. Most importantly, `__cinit__` should already return an object which doesn't cause segfaults.\n\n3. A non-existing file should be an error, not something to be silently ignored.\n\n4. Do you really need to open the file in Python and then close it and then let MeatAxe open it again? At a minimum, you should document in a comment why you are doing it this way.\n\nFrom reading the code, I think the best solution would be to remove `__cinit__` completely and handle all initialization in `__init__`.",
    "created_at": "2017-07-17T09:10:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440086",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [ticket:23411 SimonKing]:
> - When a string is provided as argument to `__init__`, it is interpreted as the name of a file from which data are read by some MeatAxe command. If the file doesn't exist, it was intended to have an uninitialised matrix (to be properly initialised later). But currently it crashes, which needs to be fixed.


I don't like your fix for this for several reasons:

1. I can't actually reproduce the issue. Without this patch, the doctest that you added passes. I think this is because the memory for Python objects is automatically initialized with all zeros.

2. If the result of `__cinit__` is really invalid in some way, then it means that there is something wrong with `__cinit__`. Most importantly, `__cinit__` should already return an object which doesn't cause segfaults.

3. A non-existing file should be an error, not something to be silently ignored.

4. Do you really need to open the file in Python and then close it and then let MeatAxe open it again? At a minimum, you should document in a comment why you are doing it this way.

From reading the code, I think the best solution would be to remove `__cinit__` completely and handle all initialization in `__init__`.



---

archive/issue_comments_440087.json:
```json
{
    "body": "<a id='comment:34'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                          |\n|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------|\n|[f274beb](https://git.sagemath.org/sage.git/commit/?id=f274beb66bfee75ff975b72795ffbafb5cdd178b)|`Meataxe unpickling: Further corner cases`|",
    "created_at": "2017-07-17T09:12:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440087",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:34'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                          |
|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------|
|[f274beb](https://git.sagemath.org/sage.git/commit/?id=f274beb66bfee75ff975b72795ffbafb5cdd178b)|`Meataxe unpickling: Further corner cases`|



---

archive/issue_comments_440088.json:
```json
{
    "body": "Changing commit from \"7a1ed5adf98cdbfbc4300205faa584df83728766\" to \"f274beb66bfee75ff975b72795ffbafb5cdd178b\"",
    "created_at": "2017-07-17T09:12:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440088",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "7a1ed5adf98cdbfbc4300205faa584df83728766" to "f274beb66bfee75ff975b72795ffbafb5cdd178b"



---

archive/issue_comments_440089.json:
```json
{
    "body": "<a id='comment:35'></a>\nReplying to [jdemeyer](#comment%3A33):\n> Replying to [ticket:23411 SimonKing]:\n> > - When a string is provided as argument to `__init__`, it is interpreted as the name of a file from which data are read by some MeatAxe command. If the file doesn't exist, it was intended to have an uninitialised matrix (to be properly initialised later). But currently it crashes, which needs to be fixed.\n \n> \n> I don't like your fix for this for several reasons:\n> \n> 1. I can't actually reproduce the issue.\n\n\nStrange. has there been a recent change in Cython? If I recall correctly, reading from a non-existing file left the matrix in an undefined state. In particular, it was possible that the `self.Data` pointer was *not* NULL.\n\n> 3. A non-existing file should be an error, not something to be silently ignored.\n\n\nOK.\n \n> 4. Do you really need to open the file in Python and then close it and then let MeatAxe open it again? At a minimum, you should document in a comment why you are doing it this way.\n> \n> From reading the code, I think the best solution would be to remove `__cinit__` completely and handle all initialization in `__init__`.\n\n\nIf it is really the case that I can rely on `self.Data` being initialised to NULL, then I guess removing `__cinit__` is fine.",
    "created_at": "2017-07-17T09:24:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440089",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:35'></a>
Replying to [jdemeyer](#comment%3A33):
> Replying to [ticket:23411 SimonKing]:
> > - When a string is provided as argument to `__init__`, it is interpreted as the name of a file from which data are read by some MeatAxe command. If the file doesn't exist, it was intended to have an uninitialised matrix (to be properly initialised later). But currently it crashes, which needs to be fixed.
 
> 
> I don't like your fix for this for several reasons:
> 
> 1. I can't actually reproduce the issue.


Strange. has there been a recent change in Cython? If I recall correctly, reading from a non-existing file left the matrix in an undefined state. In particular, it was possible that the `self.Data` pointer was *not* NULL.

> 3. A non-existing file should be an error, not something to be silently ignored.


OK.
 
> 4. Do you really need to open the file in Python and then close it and then let MeatAxe open it again? At a minimum, you should document in a comment why you are doing it this way.
> 
> From reading the code, I think the best solution would be to remove `__cinit__` completely and handle all initialization in `__init__`.


If it is really the case that I can rely on `self.Data` being initialised to NULL, then I guess removing `__cinit__` is fine.



---

archive/issue_comments_440090.json:
```json
{
    "body": "<a id='comment:36'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                        |\n|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------|\n|[6586e97](https://git.sagemath.org/sage.git/commit/?id=6586e97ae1f092eb3a8d2ad9d0da4c7728a87cdc)|`Sanitise meataxe matrix initialisation`|",
    "created_at": "2017-07-17T09:55:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440090",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:36'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                        |
|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------|
|[6586e97](https://git.sagemath.org/sage.git/commit/?id=6586e97ae1f092eb3a8d2ad9d0da4c7728a87cdc)|`Sanitise meataxe matrix initialisation`|



---

archive/issue_comments_440091.json:
```json
{
    "body": "Changing commit from \"f274beb66bfee75ff975b72795ffbafb5cdd178b\" to \"6586e97ae1f092eb3a8d2ad9d0da4c7728a87cdc\"",
    "created_at": "2017-07-17T09:55:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440091",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "f274beb66bfee75ff975b72795ffbafb5cdd178b" to "6586e97ae1f092eb3a8d2ad9d0da4c7728a87cdc"



---

archive/issue_comments_440092.json:
```json
{
    "body": "<a id='comment:37'></a>\nReplying to [jdemeyer](#comment%3A33):\n> Replying to [ticket:23411 SimonKing]:\n> 2. If the result of `__cinit__` is really invalid in some way, then it means that there is something wrong with `__cinit__`. Most importantly, `__cinit__` should already return an object which doesn't cause segfaults.\n\n\nThat is the case, provided that `self.Data` is correctly initialised to NULL by cython.\n \n> 3. A non-existing file should be an error, not something to be silently ignored.\n\n\nDone. Now, an error raised by MeatAxe is propagated.\n\n> 4. Do you really need to open the file in Python and then close it and then let MeatAxe open it again? \n\n\nNo, one can simply catch the resulting error, if one likes...\n\n> From reading the code, I think the best solution would be to remove `__cinit__` completely and handle all initialization in `__init__`.\n\n\nDone. And the tests pass :)",
    "created_at": "2017-07-17T09:59:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440092",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:37'></a>
Replying to [jdemeyer](#comment%3A33):
> Replying to [ticket:23411 SimonKing]:
> 2. If the result of `__cinit__` is really invalid in some way, then it means that there is something wrong with `__cinit__`. Most importantly, `__cinit__` should already return an object which doesn't cause segfaults.


That is the case, provided that `self.Data` is correctly initialised to NULL by cython.
 
> 3. A non-existing file should be an error, not something to be silently ignored.


Done. Now, an error raised by MeatAxe is propagated.

> 4. Do you really need to open the file in Python and then close it and then let MeatAxe open it again? 


No, one can simply catch the resulting error, if one likes...

> From reading the code, I think the best solution would be to remove `__cinit__` completely and handle all initialization in `__init__`.


Done. And the tests pass :)



---

archive/issue_comments_440093.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-07-17T09:59:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440093",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_440094.json:
```json
{
    "body": "<a id='comment:39'></a>\nThere is something wrong with the indentation here:\n\n```\n        5. Creating a matrix from a file in MeatAxe format. If the file doesn't exist,\n            an error raised by the MeatAxe library is propagated::\n\n            sage: Matrix_gfpn_dense('foobarNONEXISTING_FILE')       # optional: meataxe\n            Traceback (most recent call last):\n            ...\n            SystemError: .../foobarNONEXISTING_FILE: No such file or directory in file os.c (line 254)\n```\nCorrect indentation would be\n\n```\n        5.  Creating a matrix from a file in MeatAxe format. If the file doesn't exist,\n            an error raised by the MeatAxe library is propagated::\n\n                sage: Matrix_gfpn_dense('foobarNONEXISTING_FILE')       # optional: meataxe\n                Traceback (most recent call last):\n                ...\n                SystemError: .../foobarNONEXISTING_FILE: No such file or directory in file os.c (line 254)\n```\n(note the double space after `5.` to make allow 4 spaces of indentation on the next line)",
    "created_at": "2017-07-17T11:49:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440094",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:39'></a>
There is something wrong with the indentation here:

```
        5. Creating a matrix from a file in MeatAxe format. If the file doesn't exist,
            an error raised by the MeatAxe library is propagated::

            sage: Matrix_gfpn_dense('foobarNONEXISTING_FILE')       # optional: meataxe
            Traceback (most recent call last):
            ...
            SystemError: .../foobarNONEXISTING_FILE: No such file or directory in file os.c (line 254)
```
Correct indentation would be

```
        5.  Creating a matrix from a file in MeatAxe format. If the file doesn't exist,
            an error raised by the MeatAxe library is propagated::

                sage: Matrix_gfpn_dense('foobarNONEXISTING_FILE')       # optional: meataxe
                Traceback (most recent call last):
                ...
                SystemError: .../foobarNONEXISTING_FILE: No such file or directory in file os.c (line 254)
```
(note the double space after `5.` to make allow 4 spaces of indentation on the next line)



---

archive/issue_comments_440095.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-07-17T11:49:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440095",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_440096.json:
```json
{
    "body": "Changing commit from \"6586e97ae1f092eb3a8d2ad9d0da4c7728a87cdc\" to \"77bc58b647af83ca457798bd57e7c57b57a1a6a2\"",
    "created_at": "2017-07-17T11:53:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440096",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "6586e97ae1f092eb3a8d2ad9d0da4c7728a87cdc" to "77bc58b647af83ca457798bd57e7c57b57a1a6a2"



---

archive/issue_comments_440097.json:
```json
{
    "body": "<a id='comment:40'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                |\n|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------|\n|[77bc58b](https://git.sagemath.org/sage.git/commit/?id=77bc58b647af83ca457798bd57e7c57b57a1a6a2)|`Fix indentation in meataxe matrix __init__ doc`|",
    "created_at": "2017-07-17T11:53:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440097",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:40'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                |
|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------|
|[77bc58b](https://git.sagemath.org/sage.git/commit/?id=77bc58b647af83ca457798bd57e7c57b57a1a6a2)|`Fix indentation in meataxe matrix __init__ doc`|



---

archive/issue_comments_440098.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-07-17T11:54:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440098",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_440099.json:
```json
{
    "body": "<a id='comment:42'></a>\nWhat is the purpose of\n\n```\n            if not parent:\n                self._cache == {}\n```\n\nIt seems that you want to allow `Matrix_gfpn_dense(\"\")` to return an uninitialized matrix but I wonder why. If you *really* want that for some reason, it would be better to replace `if parent is None` above by `if not parent`.",
    "created_at": "2017-07-17T11:56:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440099",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:42'></a>
What is the purpose of

```
            if not parent:
                self._cache == {}
```

It seems that you want to allow `Matrix_gfpn_dense("")` to return an uninitialized matrix but I wonder why. If you *really* want that for some reason, it would be better to replace `if parent is None` above by `if not parent`.



---

archive/issue_comments_440100.json:
```json
{
    "body": "<a id='comment:43'></a>\nExcept for my last comment, this ticket is fine for me.",
    "created_at": "2017-07-17T11:59:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440100",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:43'></a>
Except for my last comment, this ticket is fine for me.



---

archive/issue_comments_440101.json:
```json
{
    "body": "<a id='comment:44'></a>\nReplying to [jdemeyer](#comment%3A42):\n> What is the purpose of\n> \n> ```\n>             if not parent:\n>                 self._cache == {}\n> ```\n> \n> It seems that you want to allow `Matrix_gfpn_dense(\"\")` to return an uninitialized matrix but I wonder why. If you *really* want that for some reason, it would be better to replace `if parent is None` above by `if not parent`.\n\n\nI do use uninitialised meataxe matrices in some application (of course in my group cohomology package), namely when I want to create a `Matrix_gfpn_dense` from an existing `Matrix_t*`. But your suggestion makes perfect sense.",
    "created_at": "2017-07-17T12:01:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440101",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:44'></a>
Replying to [jdemeyer](#comment%3A42):
> What is the purpose of
> 
> ```
>             if not parent:
>                 self._cache == {}
> ```
> 
> It seems that you want to allow `Matrix_gfpn_dense("")` to return an uninitialized matrix but I wonder why. If you *really* want that for some reason, it would be better to replace `if parent is None` above by `if not parent`.


I do use uninitialised meataxe matrices in some application (of course in my group cohomology package), namely when I want to create a `Matrix_gfpn_dense` from an existing `Matrix_t*`. But your suggestion makes perfect sense.



---

archive/issue_comments_440102.json:
```json
{
    "body": "Changing commit from \"77bc58b647af83ca457798bd57e7c57b57a1a6a2\" to \"5106ebb42dcc69206b33d15c4a96f8a14fbc2f8c\"",
    "created_at": "2017-07-17T12:04:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440102",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "77bc58b647af83ca457798bd57e7c57b57a1a6a2" to "5106ebb42dcc69206b33d15c4a96f8a14fbc2f8c"



---

archive/issue_comments_440103.json:
```json
{
    "body": "<a id='comment:45'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                         |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------|\n|[5106ebb](https://git.sagemath.org/sage.git/commit/?id=5106ebb42dcc69206b33d15c4a96f8a14fbc2f8c)|`Simplified code path for uninitialised meataxe matrices`|",
    "created_at": "2017-07-17T12:04:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440103",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:45'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                         |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------|
|[5106ebb](https://git.sagemath.org/sage.git/commit/?id=5106ebb42dcc69206b33d15c4a96f8a14fbc2f8c)|`Simplified code path for uninitialised meataxe matrices`|



---

archive/issue_comments_440104.json:
```json
{
    "body": "<a id='comment:46'></a>\nDone!",
    "created_at": "2017-07-17T12:04:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440104",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:46'></a>
Done!



---

archive/issue_comments_440105.json:
```json
{
    "body": "<a id='comment:47'></a>\nReplying to [SimonKing](#comment%3A44):\n> I do use uninitialised meataxe matrices in some application\n\n\nI would argue that the *proper* way to get an \"uninitialised meataxe matrix\" is precisely to do `Matrix_gfpn_dense.__new__(Matrix_gfpn_dense)`.\n\nThis idiom of using `__new__` and then manually filling in a data structure is used a lot in Sage. For example, in the `numerator` method for rational numbers:\n\n```\n    def numerator(self):\n        cdef Integer n = Integer.__new__(Integer)\n        n.set_from_mpz(mpq_numref(self.value))\n        return n\n```",
    "created_at": "2017-07-17T12:18:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440105",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:47'></a>
Replying to [SimonKing](#comment%3A44):
> I do use uninitialised meataxe matrices in some application


I would argue that the *proper* way to get an "uninitialised meataxe matrix" is precisely to do `Matrix_gfpn_dense.__new__(Matrix_gfpn_dense)`.

This idiom of using `__new__` and then manually filling in a data structure is used a lot in Sage. For example, in the `numerator` method for rational numbers:

```
    def numerator(self):
        cdef Integer n = Integer.__new__(Integer)
        n.set_from_mpz(mpq_numref(self.value))
        return n
```



---

archive/issue_comments_440106.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-07-17T12:26:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440106",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_440107.json:
```json
{
    "body": "<a id='comment:48'></a>\nReplying to [jdemeyer](#comment%3A47):\n> I would argue that the *proper* way to get an \"uninitialised meataxe matrix\" is precisely to do `Matrix_gfpn_dense.__new__(Matrix_gfpn_dense)`.\n\n\nActually I just checked: I am using the `.__new__` thing in some part of my cohomology code, and in some other parts I'd really better do it as well. I suppose it should be removed.",
    "created_at": "2017-07-17T12:26:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440107",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:48'></a>
Replying to [jdemeyer](#comment%3A47):
> I would argue that the *proper* way to get an "uninitialised meataxe matrix" is precisely to do `Matrix_gfpn_dense.__new__(Matrix_gfpn_dense)`.


Actually I just checked: I am using the `.__new__` thing in some part of my cohomology code, and in some other parts I'd really better do it as well. I suppose it should be removed.



---

archive/issue_comments_440108.json:
```json
{
    "body": "<a id='comment:49'></a>\nPS: Also note the statement in the docstring of `__init__`, where I say that the case `parent = None` is used for unpickling --- which is not true, as I am using `__new__` there as well!",
    "created_at": "2017-07-17T12:28:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440108",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:49'></a>
PS: Also note the statement in the docstring of `__init__`, where I say that the case `parent = None` is used for unpickling --- which is not true, as I am using `__new__` there as well!



---

archive/issue_comments_440109.json:
```json
{
    "body": "Changing commit from \"5106ebb42dcc69206b33d15c4a96f8a14fbc2f8c\" to \"3d94133f7514a2d5f3887aabeb2a6068e981a272\"",
    "created_at": "2017-07-17T12:37:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440109",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "5106ebb42dcc69206b33d15c4a96f8a14fbc2f8c" to "3d94133f7514a2d5f3887aabeb2a6068e981a272"



---

archive/issue_comments_440110.json:
```json
{
    "body": "<a id='comment:50'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                           |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------|\n|[3d94133](https://git.sagemath.org/sage.git/commit/?id=3d94133f7514a2d5f3887aabeb2a6068e981a272)|`Remove codepath for creating uninitialised meataxe matrix`|",
    "created_at": "2017-07-17T12:37:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440110",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:50'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                           |
|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------|
|[3d94133](https://git.sagemath.org/sage.git/commit/?id=3d94133f7514a2d5f3887aabeb2a6068e981a272)|`Remove codepath for creating uninitialised meataxe matrix`|



---

archive/issue_comments_440111.json:
```json
{
    "body": "<a id='comment:51'></a>\nAvoid `six` in Cython files if possible! Please revert to `basestring`.",
    "created_at": "2017-07-17T12:39:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440111",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:51'></a>
Avoid `six` in Cython files if possible! Please revert to `basestring`.



---

archive/issue_comments_440112.json:
```json
{
    "body": "<a id='comment:52'></a>\nReplying to [jdemeyer](#comment%3A51):\n> Avoid `six` in Cython files if possible! Please revert to `basestring`.\n\n\nReally? I thought this was needed to make things Python3 compliant. OK, I'll revert it.\n\nSomething else: If the MeatAxe function `MatLoad` gets an empty file name, it apparently just returns the NULL pointer, but doesn't raise an error. What shall I do? Shall I change\n`Matrix_t *MatLoad(char *fn) except NULL` into `Matrix_t *MatLoad(char *fn) except? NULL` (or what's the syntax if NULL can also be returned without an error)?",
    "created_at": "2017-07-17T12:42:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440112",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:52'></a>
Replying to [jdemeyer](#comment%3A51):
> Avoid `six` in Cython files if possible! Please revert to `basestring`.


Really? I thought this was needed to make things Python3 compliant. OK, I'll revert it.

Something else: If the MeatAxe function `MatLoad` gets an empty file name, it apparently just returns the NULL pointer, but doesn't raise an error. What shall I do? Shall I change
`Matrix_t *MatLoad(char *fn) except NULL` into `Matrix_t *MatLoad(char *fn) except? NULL` (or what's the syntax if NULL can also be returned without an error)?



---

archive/issue_comments_440113.json:
```json
{
    "body": "<a id='comment:53'></a>\nReplying to [SimonKing](#comment%3A52):\n> I thought this was needed to make things Python3 compliant.\n\n\nYes, `six` is needed to make things Python 3 compliant.\n\nHowever, Cython is a language by itself. Cython is not Python 2 and it's not Python 3. Cython tries to be compatible with Python 2 and Python 3. This makes porting Cython code to Python 3 much easier than porting Python code.\n\nOf course, some Cython code is really just Python code and that code can depend on the Python version. And there are some incompatibilities that Cython cannot fix: support for `__cmp__` is gone in Python 3, there is nothing that Cython can do about that.",
    "created_at": "2017-07-17T12:47:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440113",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:53'></a>
Replying to [SimonKing](#comment%3A52):
> I thought this was needed to make things Python3 compliant.


Yes, `six` is needed to make things Python 3 compliant.

However, Cython is a language by itself. Cython is not Python 2 and it's not Python 3. Cython tries to be compatible with Python 2 and Python 3. This makes porting Cython code to Python 3 much easier than porting Python code.

Of course, some Cython code is really just Python code and that code can depend on the Python version. And there are some incompatibilities that Cython cannot fix: support for `__cmp__` is gone in Python 3, there is nothing that Cython can do about that.



---

archive/issue_comments_440114.json:
```json
{
    "body": "<a id='comment:54'></a>\nReplying to [SimonKing](#comment%3A52):\n> Replying to [jdemeyer](#comment%3A51):\n> > Avoid `six` in Cython files if possible! Please revert to `basestring`.\n\n> \n> Really? I thought this was needed to make things Python3 compliant. OK, I'll revert it.\n> \n> Something else: If the MeatAxe function `MatLoad` gets an empty file name, it apparently just returns the NULL pointer, but doesn't raise an error. What shall I do? Shall I change\n> `Matrix_t *MatLoad(char *fn) except NULL` into `Matrix_t *MatLoad(char *fn) except? NULL` (or what's the syntax if NULL can also be returned without an error)?\n\n\nYes, `except? NULL` is fine. I would still raise a Python exception in this case though.",
    "created_at": "2017-07-17T12:48:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440114",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:54'></a>
Replying to [SimonKing](#comment%3A52):
> Replying to [jdemeyer](#comment%3A51):
> > Avoid `six` in Cython files if possible! Please revert to `basestring`.

> 
> Really? I thought this was needed to make things Python3 compliant. OK, I'll revert it.
> 
> Something else: If the MeatAxe function `MatLoad` gets an empty file name, it apparently just returns the NULL pointer, but doesn't raise an error. What shall I do? Shall I change
> `Matrix_t *MatLoad(char *fn) except NULL` into `Matrix_t *MatLoad(char *fn) except? NULL` (or what's the syntax if NULL can also be returned without an error)?


Yes, `except? NULL` is fine. I would still raise a Python exception in this case though.



---

archive/issue_comments_440115.json:
```json
{
    "body": "<a id='comment:55'></a>\nReplying to [jdemeyer](#comment%3A54):\n> Yes, `except? NULL` is fine. I would still raise a Python exception in this case though.\n\n\nIf you want an error being raised on `Matrix_gfpn_dense('')`, then I need to re-introduce the test `if not parent` (but then raise an error). Is that OK for you?\n\nIn any case, changing the function header of `MatLoad` should be done.",
    "created_at": "2017-07-17T12:52:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440115",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:55'></a>
Replying to [jdemeyer](#comment%3A54):
> Yes, `except? NULL` is fine. I would still raise a Python exception in this case though.


If you want an error being raised on `Matrix_gfpn_dense('')`, then I need to re-introduce the test `if not parent` (but then raise an error). Is that OK for you?

In any case, changing the function header of `MatLoad` should be done.



---

archive/issue_comments_440116.json:
```json
{
    "body": "<a id='comment:56'></a>\nReplying to [SimonKing](#comment%3A55):\n> Replying to [jdemeyer](#comment%3A54):\n> > Yes, `except? NULL` is fine. I would still raise a Python exception in this case though.\n\n> \n> If you want an error being raised on `Matrix_gfpn_dense('')`, then I need to re-introduce the test `if not parent` (but then raise an error). Is that OK for you?\n\n\nBut you say that MeatAxe returns `NULL` without exception in this case. So it suffices to check the result of `MatLoad()`.",
    "created_at": "2017-07-17T13:01:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440116",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:56'></a>
Replying to [SimonKing](#comment%3A55):
> Replying to [jdemeyer](#comment%3A54):
> > Yes, `except? NULL` is fine. I would still raise a Python exception in this case though.

> 
> If you want an error being raised on `Matrix_gfpn_dense('')`, then I need to re-introduce the test `if not parent` (but then raise an error). Is that OK for you?


But you say that MeatAxe returns `NULL` without exception in this case. So it suffices to check the result of `MatLoad()`.



---

archive/issue_comments_440117.json:
```json
{
    "body": "<a id='comment:57'></a>\nReplying to [jdemeyer](#comment%3A56):\n> But you say that MeatAxe returns `NULL` without exception in this case. So it suffices to check the result of `MatLoad()`.\n\n\nFrom my perspective, one could simply return an empty 0x0-matrix over an unspecified field in that special case. But if you prefer an error being raised (`ValueError(\"Received NULL pointer from initialisation of MeatAxe matrix\")`, perhaps?), I can do that.",
    "created_at": "2017-07-17T13:50:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440117",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:57'></a>
Replying to [jdemeyer](#comment%3A56):
> But you say that MeatAxe returns `NULL` without exception in this case. So it suffices to check the result of `MatLoad()`.


From my perspective, one could simply return an empty 0x0-matrix over an unspecified field in that special case. But if you prefer an error being raised (`ValueError("Received NULL pointer from initialisation of MeatAxe matrix")`, perhaps?), I can do that.



---

archive/issue_comments_440118.json:
```json
{
    "body": "<a id='comment:58'></a>\nI consider it a bug that `MatLoad(\"\")` returns `NULL` without an error. So we are just working around a MeatAxe bug here...",
    "created_at": "2017-07-17T14:00:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440118",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:58'></a>
I consider it a bug that `MatLoad("")` returns `NULL` without an error. So we are just working around a MeatAxe bug here...



---

archive/issue_comments_440119.json:
```json
{
    "body": "<a id='comment:59'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                            |\n|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------|\n|[564104e](https://git.sagemath.org/sage.git/commit/?id=564104e5c3c09769b921c10a10788063c9c39096)|`Don't use six.string_types, but basestring`|\n|[982755f](https://git.sagemath.org/sage.git/commit/?id=982755f103b4d1225051c060f93e9a4069deb87a)|`Workaround: MeatAxe's MatLoad returns NULL on empty filename without setting error`|",
    "created_at": "2017-07-17T14:11:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440119",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:59'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                            |
|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------|
|[564104e](https://git.sagemath.org/sage.git/commit/?id=564104e5c3c09769b921c10a10788063c9c39096)|`Don't use six.string_types, but basestring`|
|[982755f](https://git.sagemath.org/sage.git/commit/?id=982755f103b4d1225051c060f93e9a4069deb87a)|`Workaround: MeatAxe's MatLoad returns NULL on empty filename without setting error`|



---

archive/issue_comments_440120.json:
```json
{
    "body": "Changing commit from \"3d94133f7514a2d5f3887aabeb2a6068e981a272\" to \"982755f103b4d1225051c060f93e9a4069deb87a\"",
    "created_at": "2017-07-17T14:11:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440120",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "3d94133f7514a2d5f3887aabeb2a6068e981a272" to "982755f103b4d1225051c060f93e9a4069deb87a"



---

archive/issue_comments_440121.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-07-17T14:11:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440121",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_440122.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Jeroen Demeyer\"",
    "created_at": "2017-07-25T09:58:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440122",
    "user": "https://github.com/jdemeyer"
}
```

Changing reviewer from "" to "Jeroen Demeyer"



---

archive/issue_comments_440123.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-07-25T09:58:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440123",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_440124.json:
```json
{
    "body": "<a id='comment:61'></a>\nAs expected, this \"machine dependent\" doctest may fail depending on the machine:\n\n```\n        sage: t = 'Uq\\x82\\x00\\x00\\x00\\x00\\x00\\xa7\\x8bh\\x00\\x00\\x00\\x00\\x00'\n        sage: len(t)\n        16\n        sage: N == mtx_unpickle(MS, 2, 5, t, True)           # optional: meataxe\n```",
    "created_at": "2017-07-25T09:58:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440124",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:61'></a>
As expected, this "machine dependent" doctest may fail depending on the machine:

```
        sage: t = 'Uq\x82\x00\x00\x00\x00\x00\xa7\x8bh\x00\x00\x00\x00\x00'
        sage: len(t)
        16
        sage: N == mtx_unpickle(MS, 2, 5, t, True)           # optional: meataxe
```



---

archive/issue_comments_440125.json:
```json
{
    "body": "<a id='comment:62'></a>\nOn a 32-bit system, this gives:\n\n```\nsage -t --long --warn-long 87.3 src/sage/matrix/matrix_gfpn_dense.pyx\n**********************************************************************\nFile \"src/sage/matrix/matrix_gfpn_dense.pyx\", line 1635, in sage.matrix.matrix_gfpn_dense.mtx_unpickle\nFailed example:\n    N == mtx_unpickle(MS, 2, 5, t, True)           # optional: meataxe\nException raised:\n    Traceback (most recent call last):\n      File \"/home/jdemeyer/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 509, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/jdemeyer/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 872, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.matrix.matrix_gfpn_dense.mtx_unpickle[18]>\", line 1, in <module>\n        N == mtx_unpickle(MS, Integer(2), Integer(5), t, True)           # optional: meataxe\n      File \"sage/matrix/matrix_gfpn_dense.pyx\", line 1712, in sage.matrix.matrix_gfpn_dense.mtx_unpickle (/home/jdemeyer/sage-git/src/build/cythonized/sage/matrix/matrix_gfpn_dense.c:14936)\n        raise ValueError(f\"Expected a pickle with {FfCurrentRowSizeIo}*{nr} bytes per row, got {lenData} instead\")\n    ValueError: Expected a pickle with 3*2 bytes per row, got 16 instead\n**********************************************************************\n```",
    "created_at": "2017-07-25T09:59:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440125",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:62'></a>
On a 32-bit system, this gives:

```
sage -t --long --warn-long 87.3 src/sage/matrix/matrix_gfpn_dense.pyx
**********************************************************************
File "src/sage/matrix/matrix_gfpn_dense.pyx", line 1635, in sage.matrix.matrix_gfpn_dense.mtx_unpickle
Failed example:
    N == mtx_unpickle(MS, 2, 5, t, True)           # optional: meataxe
Exception raised:
    Traceback (most recent call last):
      File "/home/jdemeyer/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 509, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/jdemeyer/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 872, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.matrix.matrix_gfpn_dense.mtx_unpickle[18]>", line 1, in <module>
        N == mtx_unpickle(MS, Integer(2), Integer(5), t, True)           # optional: meataxe
      File "sage/matrix/matrix_gfpn_dense.pyx", line 1712, in sage.matrix.matrix_gfpn_dense.mtx_unpickle (/home/jdemeyer/sage-git/src/build/cythonized/sage/matrix/matrix_gfpn_dense.c:14936)
        raise ValueError(f"Expected a pickle with {FfCurrentRowSizeIo}*{nr} bytes per row, got {lenData} instead")
    ValueError: Expected a pickle with 3*2 bytes per row, got 16 instead
**********************************************************************
```



---

archive/issue_comments_440126.json:
```json
{
    "body": "<a id='comment:63'></a>\nReplying to [jdemeyer](#comment%3A62):\n> On a 32-bit system, this gives:\n> \n> ```\n> sage -t --long --warn-long 87.3 src/sage/matrix/matrix_gfpn_dense.pyx\n> ...\n>     ValueError: Expected a pickle with 3*2 bytes per row, got 16 instead\n> **********************************************************************\n> ```\n\n\nThank you for testing on different architectures!\n\nSo, what shall we do with that test?\n- On the one hand, that test is about a pickling format that is known to be machine dependent and is therefore deprecated. That's an argument for removing it (which I would like to avoid).\n- On the other hand, I could try to do better and make unpickling work in that case as well.\n\nI think I prefer the second way.",
    "created_at": "2017-07-25T12:19:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440126",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:63'></a>
Replying to [jdemeyer](#comment%3A62):
> On a 32-bit system, this gives:
> 
> ```
> sage -t --long --warn-long 87.3 src/sage/matrix/matrix_gfpn_dense.pyx
> ...
>     ValueError: Expected a pickle with 3*2 bytes per row, got 16 instead
> **********************************************************************
> ```


Thank you for testing on different architectures!

So, what shall we do with that test?
- On the one hand, that test is about a pickling format that is known to be machine dependent and is therefore deprecated. That's an argument for removing it (which I would like to avoid).
- On the other hand, I could try to do better and make unpickling work in that case as well.

I think I prefer the second way.



---

archive/issue_comments_440127.json:
```json
{
    "body": "<a id='comment:64'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                                             |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------|\n|[78d7b21](https://git.sagemath.org/sage.git/commit/?id=78d7b21fe53577926bf0af4ab5dad5f426ca780a)|`MeatAxe: Enable unpickling of deprecated pickle created with different machine architecture`|",
    "created_at": "2017-07-25T12:50:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440127",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:64'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                                             |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------|
|[78d7b21](https://git.sagemath.org/sage.git/commit/?id=78d7b21fe53577926bf0af4ab5dad5f426ca780a)|`MeatAxe: Enable unpickling of deprecated pickle created with different machine architecture`|



---

archive/issue_comments_440128.json:
```json
{
    "body": "Changing commit from \"982755f103b4d1225051c060f93e9a4069deb87a\" to \"78d7b21fe53577926bf0af4ab5dad5f426ca780a\"",
    "created_at": "2017-07-25T12:50:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440128",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "982755f103b4d1225051c060f93e9a4069deb87a" to "78d7b21fe53577926bf0af4ab5dad5f426ca780a"



---

archive/issue_comments_440129.json:
```json
{
    "body": "<a id='comment:65'></a>\nDone! And I demonstrate that a deprecated pickle can be opened even if it was created on a silly machine with `sizeof(long)==9`.",
    "created_at": "2017-07-25T12:52:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440129",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:65'></a>
Done! And I demonstrate that a deprecated pickle can be opened even if it was created on a silly machine with `sizeof(long)==9`.



---

archive/issue_comments_440130.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-07-25T12:52:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440130",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_440131.json:
```json
{
    "body": "<a id='comment:66'></a>\nCool test! Now, we are still missing a doctest for the `else` case, when `elif pickled_rowsize < FfCurrentRowSizeIo`",
    "created_at": "2017-07-25T14:44:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440131",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:66'></a>
Cool test! Now, we are still missing a doctest for the `else` case, when `elif pickled_rowsize < FfCurrentRowSizeIo`



---

archive/issue_comments_440132.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-07-25T14:44:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440132",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_440133.json:
```json
{
    "body": "<a id='comment:67'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                       |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------|\n|[ba72aba](https://git.sagemath.org/sage.git/commit/?id=ba72abac8a53b3d292df570d31709ab5c2f57157)|`Test another code path in unpickling meataxe matrices`|",
    "created_at": "2017-07-26T11:45:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440133",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:67'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                       |
|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------|
|[ba72aba](https://git.sagemath.org/sage.git/commit/?id=ba72abac8a53b3d292df570d31709ab5c2f57157)|`Test another code path in unpickling meataxe matrices`|



---

archive/issue_comments_440134.json:
```json
{
    "body": "Changing commit from \"78d7b21fe53577926bf0af4ab5dad5f426ca780a\" to \"ba72abac8a53b3d292df570d31709ab5c2f57157\"",
    "created_at": "2017-07-26T11:45:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440134",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "78d7b21fe53577926bf0af4ab5dad5f426ca780a" to "ba72abac8a53b3d292df570d31709ab5c2f57157"



---

archive/issue_comments_440135.json:
```json
{
    "body": "<a id='comment:68'></a>\nDone!\n\nThere is now one test where the number of bytes is not divisible by the number of rows and one test where the number is divisible but too small to contain a matrix of the given dimensions. Together with the existing tests, I think it covers all code paths.\n\n---\nNew commits:\n|                                                                                                                                          |                                                       |\n|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------|\n|[ba72aba](https://git.sagemath.org/sage.git/commit?id=ba72abac8a53b3d292df570d31709ab5c2f57157)|`Test another code path in unpickling meataxe matrices`|",
    "created_at": "2017-07-26T11:47:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440135",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:68'></a>
Done!

There is now one test where the number of bytes is not divisible by the number of rows and one test where the number is divisible but too small to contain a matrix of the given dimensions. Together with the existing tests, I think it covers all code paths.

---
New commits:
|                                                                                                                                          |                                                       |
|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------|
|[ba72aba](https://git.sagemath.org/sage.git/commit?id=ba72abac8a53b3d292df570d31709ab5c2f57157)|`Test another code path in unpickling meataxe matrices`|



---

archive/issue_comments_440136.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-07-26T11:47:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440136",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_440137.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-07-27T09:26:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440137",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_440138.json:
```json
{
    "body": "Changing branch from \"u/SimonKing/fix_pickling_of_matrix_gfpn_dense\" to \"ba72abac8a53b3d292df570d31709ab5c2f57157\"",
    "created_at": "2017-07-29T15:30:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440138",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/SimonKing/fix_pickling_of_matrix_gfpn_dense" to "ba72abac8a53b3d292df570d31709ab5c2f57157"



---

archive/issue_comments_440139.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-07-29T15:30:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23411#issuecomment-440139",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_060170.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-07-29T15:30:47Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23411",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23411#event-60170"
}
```
