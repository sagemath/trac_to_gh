# Issue 23383: Speeding up congruence-related lattice functions

archive/issues_023146.json:
```json
{
    "body": "This patch adds precomputing intervals in the `HasseDiagram` to speed up some congruence-related lattice functions. If `L = Posets.BooleanLattice(7)`, then we have\n\n```\nsage: timeit(\"list(L._hasse_diagram.congruences_iterator())\")\n5 loops, best of 3: 4.63 s per loop\n```\n\nand after `L._hasse_diagram._precompute_intervals()`\n\n```\nsage: timeit(\"list(L._hasse_diagram.congruences_iterator())\")\n5 loops, best of 3: 656 ms per loop\n```\n\nOTOH this will eat memory.\n\nCurrently this feature is well hidden, only available as a `_`-function of a `_`-variable. Later we should think about interface. A global \"save-cpu-eat-memory\" -switch or \"aux functions\" to lattices (posets?) or something else?\n\nCC:  @tscrim @fchapoton\n\nBranch/Commit: 6f8c5108ad9d96fa548c61d1efcdd9ee757be3d4\n\nReviewer: Travis Scrimshaw\n\nAuthor: Jori M\u00e4ntysalo\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/23383\n\n",
    "closed_at": "2017-07-29T15:30:50Z",
    "created_at": "2017-07-07T08:13:56Z",
    "labels": [
        "component: combinatorics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Speeding up congruence-related lattice functions",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23383",
    "user": "https://github.com/jm58660"
}
```
This patch adds precomputing intervals in the `HasseDiagram` to speed up some congruence-related lattice functions. If `L = Posets.BooleanLattice(7)`, then we have

```
sage: timeit("list(L._hasse_diagram.congruences_iterator())")
5 loops, best of 3: 4.63 s per loop
```

and after `L._hasse_diagram._precompute_intervals()`

```
sage: timeit("list(L._hasse_diagram.congruences_iterator())")
5 loops, best of 3: 656 ms per loop
```

OTOH this will eat memory.

Currently this feature is well hidden, only available as a `_`-function of a `_`-variable. Later we should think about interface. A global "save-cpu-eat-memory" -switch or "aux functions" to lattices (posets?) or something else?

CC:  @tscrim @fchapoton

Branch/Commit: 6f8c5108ad9d96fa548c61d1efcdd9ee757be3d4

Reviewer: Travis Scrimshaw

Author: Jori MÃ¤ntysalo

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/23383





---

archive/issue_comments_323369.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2017-07-07T08:14:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23383#issuecomment-323369",
    "user": "https://github.com/jm58660"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_323370.json:
```json
{
    "body": "<a id='comment:4'></a>I consider Hasse diagrams not as part of the true API, but an implementation detail of posets. So I don't see any problem with changing the output type. Although it is part of the API for `HasseDiagram`, thus, it technically is a backwards incompatible change.\n\nAlso, it might be faster to have the `dict` indexed by a pair `(x,y)` as it only needs to do 1 hash and table lookup instead of 2. Also, a better way to populate `_intervals`:\n\n```\nself._intervals = {u: {v: v_up[u].intersection(v_down[v]) for v in range(n)}\n                   for u in range(n)}\n```\nThere is no need to create the empty object and you save a lot of Python calls by doing the dict comprehension.\n\n---\nNew commits:",
    "created_at": "2017-07-07T14:32:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23383#issuecomment-323370",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:4'></a>I consider Hasse diagrams not as part of the true API, but an implementation detail of posets. So I don't see any problem with changing the output type. Although it is part of the API for `HasseDiagram`, thus, it technically is a backwards incompatible change.

Also, it might be faster to have the `dict` indexed by a pair `(x,y)` as it only needs to do 1 hash and table lookup instead of 2. Also, a better way to populate `_intervals`:

```
self._intervals = {u: {v: v_up[u].intersection(v_down[v]) for v in range(n)}
                   for u in range(n)}
```
There is no need to create the empty object and you save a lot of Python calls by doing the dict comprehension.

---
New commits:



---

archive/issue_comments_323371.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:4 tscrim]:\n\n> Also, it might be faster to have the `dict` indexed by a pair `(x,y)` as it only needs to do 1 hash and table lookup instead of 2.\n\n\nActually, even faster should be a list of lists, that needs no lookup at all.\n\n> There is no need to create the empty object and you save a lot of Python calls by doing the dict comprehension.\n\n\nTrue. I was thinking about lists but then somehow ended up to dict in this PoC.\n\nAnd now the most important:\n\n> I consider Hasse diagrams not as part of the true API, but an implementation detail of posets. So I don't see any problem with changing the output type.\n\n\nOK. I tested by adding precomputing to `__init__` of poset. Only errors I got from long test of `combinat/posets` where from `.open_interval` in `posets.py`. But I think currently intervals are given as in the linear extension order, and that is propably a good thing.",
    "created_at": "2017-07-07T16:33:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23383#issuecomment-323371",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:5'></a>Replying to [comment:4 tscrim]:

> Also, it might be faster to have the `dict` indexed by a pair `(x,y)` as it only needs to do 1 hash and table lookup instead of 2.


Actually, even faster should be a list of lists, that needs no lookup at all.

> There is no need to create the empty object and you save a lot of Python calls by doing the dict comprehension.


True. I was thinking about lists but then somehow ended up to dict in this PoC.

And now the most important:

> I consider Hasse diagrams not as part of the true API, but an implementation detail of posets. So I don't see any problem with changing the output type.


OK. I tested by adding precomputing to `__init__` of poset. Only errors I got from long test of `combinat/posets` where from `.open_interval` in `posets.py`. But I think currently intervals are given as in the linear extension order, and that is propably a good thing.



---

archive/issue_comments_323372.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:5 jmantysalo]:\n> Replying to [comment:4 tscrim]:\n> \n> > Also, it might be faster to have the `dict` indexed by a pair `(x,y)` as it only needs to do 1 hash and table lookup instead of 2.\n\n> \n> Actually, even faster should be a list of lists, that needs no lookup at all.\n\n\nWell, there still is a lookup, but now it is (relatively) very fast. +1 for list of lists.\n\n> > I consider Hasse diagrams not as part of the true API, but an implementation detail of posets. So I don't see any problem with changing the output type.\n\n> \n> OK. I tested by adding precomputing to `__init__` of poset. Only errors I got from long test of `combinat/posets` where from `.open_interval` in `posets.py`. But I think currently intervals are given as in the linear extension order, and that is propably a good thing.\n\n\nI think it would be best if the numbering was done increasing (as that is assumed to be a linear extension IIRC).",
    "created_at": "2017-07-09T06:15:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23383#issuecomment-323372",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:6'></a>Replying to [comment:5 jmantysalo]:
> Replying to [comment:4 tscrim]:
> 
> > Also, it might be faster to have the `dict` indexed by a pair `(x,y)` as it only needs to do 1 hash and table lookup instead of 2.

> 
> Actually, even faster should be a list of lists, that needs no lookup at all.


Well, there still is a lookup, but now it is (relatively) very fast. +1 for list of lists.

> > I consider Hasse diagrams not as part of the true API, but an implementation detail of posets. So I don't see any problem with changing the output type.

> 
> OK. I tested by adding precomputing to `__init__` of poset. Only errors I got from long test of `combinat/posets` where from `.open_interval` in `posets.py`. But I think currently intervals are given as in the linear extension order, and that is propably a good thing.


I think it would be best if the numbering was done increasing (as that is assumed to be a linear extension IIRC).



---

archive/issue_comments_323373.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-10T09:21:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23383#issuecomment-323373",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_323374.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2017-07-10T09:24:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23383#issuecomment-323374",
    "user": "https://github.com/jm58660"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_323375.json:
```json
{
    "body": "<a id='comment:8'></a>Here it is. The speedup is quite big:\n\n```\nsage: L = Posets.BooleanLattice(7)\nsage: timeit(\"list(L._hasse_diagram.congruences_iterator())\")\n5 loops, best of 3: 4.63 s per loop\nsage: timeit(\"L._hasse_diagram._precompute_intervals()\")\n25 loops, best of 3: 23.6 ms per loop\nsage: timeit(\"list(L._hasse_diagram.congruences_iterator())\")\n5 loops, best of 3: 656 ms per loop\n```",
    "created_at": "2017-07-10T09:24:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23383#issuecomment-323375",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:8'></a>Here it is. The speedup is quite big:

```
sage: L = Posets.BooleanLattice(7)
sage: timeit("list(L._hasse_diagram.congruences_iterator())")
5 loops, best of 3: 4.63 s per loop
sage: timeit("L._hasse_diagram._precompute_intervals()")
25 loops, best of 3: 23.6 ms per loop
sage: timeit("list(L._hasse_diagram.congruences_iterator())")
5 loops, best of 3: 656 ms per loop
```



---

archive/issue_events_060136.json:
```json
{
    "actor": "https://github.com/jm58660",
    "created_at": "2017-07-10T09:24:07Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23383",
    "milestone": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23383#event-60136"
}
```



---

archive/issue_comments_323376.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-07-10T15:55:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23383#issuecomment-323376",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_323377.json:
```json
{
    "body": "<a id='comment:9'></a>If you want even more speed:\n\n```diff\n-        v_up = [None] * n\n-        v_down = [None] * n\n-        for v in range(n):\n-            v_up[v] = frozenset(self.depth_first_search(v))\n-            v_down[v] = frozenset(self.depth_first_search(v, neighbors=self.neighbors_in))\n+        v_up = [frozenset(self.depth_first_search(v)) for v in range(n)]\n+        v_down = [frozenset(self.depth_first_search(v, neighbors=self.neighbors_in))\n+                  for v in range(n)]\n \n-        self._intervals = [[None] * n for _ in range(n)]\n-        for u in range(n):\n-            for v in range(n):\n-                self._intervals[u][v] = sorted(v_up[u].intersection(v_down[v]))\n+        self._intervals = [[sorted(up.intersection(down)) for down in v_down]\n+                           for up in v_up]\n```\nI've seen using list comprehension have a significant effect for things like this because of the extra Python overhead.\n\nI do not like the documentation of `_alt_interval`. It should explain what it is doing (well, really it should be similar/same as `interval`. Moreover, you should put somewhere in some documentation about this feature and how to use it. It probably is good to make this part of the API for posets somewhere with a warning about the memory usage.\n\nYou also should update the ticket description.",
    "created_at": "2017-07-10T15:55:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23383#issuecomment-323377",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:9'></a>If you want even more speed:

```diff
-        v_up = [None] * n
-        v_down = [None] * n
-        for v in range(n):
-            v_up[v] = frozenset(self.depth_first_search(v))
-            v_down[v] = frozenset(self.depth_first_search(v, neighbors=self.neighbors_in))
+        v_up = [frozenset(self.depth_first_search(v)) for v in range(n)]
+        v_down = [frozenset(self.depth_first_search(v, neighbors=self.neighbors_in))
+                  for v in range(n)]
 
-        self._intervals = [[None] * n for _ in range(n)]
-        for u in range(n):
-            for v in range(n):
-                self._intervals[u][v] = sorted(v_up[u].intersection(v_down[v]))
+        self._intervals = [[sorted(up.intersection(down)) for down in v_down]
+                           for up in v_up]
```
I've seen using list comprehension have a significant effect for things like this because of the extra Python overhead.

I do not like the documentation of `_alt_interval`. It should explain what it is doing (well, really it should be similar/same as `interval`. Moreover, you should put somewhere in some documentation about this feature and how to use it. It probably is good to make this part of the API for posets somewhere with a warning about the memory usage.

You also should update the ticket description.



---

archive/issue_comments_323378.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-11T05:33:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23383#issuecomment-323378",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_323379.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-07-11T05:48:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23383#issuecomment-323379",
    "user": "https://github.com/jm58660"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_323380.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:9 tscrim]:\n> If you want even more speed:\n\n\nDone that. And yes, it gives some milliseconds: for `Posets.BooleanLattice(10)` it took 1,65 seconds, now it takes 1,41 seconds. (Of course that means nothing when compared to time to compute congruences.) And the code is shorted and more pythonic.\n\nMuch more speedup should be possible with better algorithm: an interval from `a` with covers `a1` and `a2` to `b` is union of intervals `(a1, b)` and `(a2, b)`.\n\n> I do not like the documentation of `_alt_interval`. It should explain what it is doing (well, really it should be similar/same as `interval`. Moreover, you should put somewhere in some documentation about this feature and how to use it. It probably is good to make this part of the API for posets somewhere with a warning about the memory usage.\n> \n> You also should update the ticket description.\n\n\nI added a note about this to the description. Needs to think for a while.",
    "created_at": "2017-07-11T05:48:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23383#issuecomment-323380",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:11'></a>Replying to [comment:9 tscrim]:
> If you want even more speed:


Done that. And yes, it gives some milliseconds: for `Posets.BooleanLattice(10)` it took 1,65 seconds, now it takes 1,41 seconds. (Of course that means nothing when compared to time to compute congruences.) And the code is shorted and more pythonic.

Much more speedup should be possible with better algorithm: an interval from `a` with covers `a1` and `a2` to `b` is union of intervals `(a1, b)` and `(a2, b)`.

> I do not like the documentation of `_alt_interval`. It should explain what it is doing (well, really it should be similar/same as `interval`. Moreover, you should put somewhere in some documentation about this feature and how to use it. It probably is good to make this part of the API for posets somewhere with a warning about the memory usage.
> 
> You also should update the ticket description.


I added a note about this to the description. Needs to think for a while.



---

archive/issue_comments_323381.json:
```json
{
    "body": "<a id='comment:12'></a>However, I still would like to see a bit better of documentation for `_alt_interval` describing the algorithm (i.e., by precomputing) and what you need to do to make it work. In some ways, I don't like the implementation because you need to explicitly call another function first instead of it just working. I am see this through the eyes of someone browsing through the code and seeing this who did not read this specific ticket, which will almost certainly happen at some point.",
    "created_at": "2017-07-11T07:16:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23383#issuecomment-323381",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:12'></a>However, I still would like to see a bit better of documentation for `_alt_interval` describing the algorithm (i.e., by precomputing) and what you need to do to make it work. In some ways, I don't like the implementation because you need to explicitly call another function first instead of it just working. I am see this through the eyes of someone browsing through the code and seeing this who did not read this specific ticket, which will almost certainly happen at some point.



---

archive/issue_comments_323382.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-07-11T07:16:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23383#issuecomment-323382",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_323383.json:
```json
{
    "body": "<a id='comment:13'></a>First, a technical question: A Python function can return an internal function, i.e. this will print \"Hello\":\n\n```\ndef f():\n    def g(): print(\"Hello\")\n    return g\nf()()\n```\n\nWould it be meaningfull to use this feature, and remove `_alt_interval` from the top level of Hasse diagram?\n\nNow to the main question.\n\nThe problem is, IMO, `UniqueRepresentation`. No created poset will ever be freed from the memory, and so making test with random posets will eventually eat all the memory. And if we compute `lequal_matrix()` or `_meet` etc, those will be saved too. That's why I am worried about this.\n\nWhen should this precomputing be called? In `interval()`? In `congruence()`? In, say, `is_isoform()`?\n\nI will formulate longer description for `_atl_interval`.",
    "created_at": "2017-07-11T08:29:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23383#issuecomment-323383",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:13'></a>First, a technical question: A Python function can return an internal function, i.e. this will print "Hello":

```
def f():
    def g(): print("Hello")
    return g
f()()
```

Would it be meaningfull to use this feature, and remove `_alt_interval` from the top level of Hasse diagram?

Now to the main question.

The problem is, IMO, `UniqueRepresentation`. No created poset will ever be freed from the memory, and so making test with random posets will eventually eat all the memory. And if we compute `lequal_matrix()` or `_meet` etc, those will be saved too. That's why I am worried about this.

When should this precomputing be called? In `interval()`? In `congruence()`? In, say, `is_isoform()`?

I will formulate longer description for `_atl_interval`.



---

archive/issue_comments_323384.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-11T08:39:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23383#issuecomment-323384",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_323385.json:
```json
{
    "body": "<a id='comment:15'></a>More comments on this? Specially for this:\n\n> When should this precomputing be called? In `interval()`? In `congruence()`? In, say, `is_isoform()`?",
    "created_at": "2017-07-21T07:39:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23383#issuecomment-323385",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:15'></a>More comments on this? Specially for this:

> When should this precomputing be called? In `interval()`? In `congruence()`? In, say, `is_isoform()`?



---

archive/issue_comments_323386.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-07-21T07:39:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23383#issuecomment-323386",
    "user": "https://github.com/jm58660"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_323387.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:13 jmantysalo]:\n> First, a technical question: A Python function can return an internal function, i.e. this will print \"Hello\":\n> \n> \n> ```\n> def f():\n>     def g(): print(\"Hello\")\n>     return g\n> f()()\n> ```\n\n\nYes, that is correct. We return functions in a number of places within Sage too.\n\n> Would it be meaningfull to use this feature, and remove `_alt_interval` from the top level of Hasse diagram?\n\n\nI do not think so by default because of how much memory this would use. Although it could be something we do for small posets (less that 5 vertices?).\n\n> The problem is, IMO, `UniqueRepresentation`. No created poset will ever be freed from the memory, and so making test with random posets will eventually eat all the memory. And if we compute `lequal_matrix()` or `_meet` etc, those will be saved too. That's why I am worried about this.\n\n\nThat should not be true. Once you delete all references to a poset, it should be freeable as it is a weak reference (otherwise it is a memory leak bug).\n\n> When should this precomputing be called? In `interval()`? In `congruence()`? In, say, `is_isoform()`?\n\n\nProbably in none of these places, but instead we should document it as an alternative method for increasing the speed.",
    "created_at": "2017-07-21T23:11:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23383#issuecomment-323387",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:16'></a>Replying to [comment:13 jmantysalo]:
> First, a technical question: A Python function can return an internal function, i.e. this will print "Hello":
> 
> 
> ```
> def f():
>     def g(): print("Hello")
>     return g
> f()()
> ```


Yes, that is correct. We return functions in a number of places within Sage too.

> Would it be meaningfull to use this feature, and remove `_alt_interval` from the top level of Hasse diagram?


I do not think so by default because of how much memory this would use. Although it could be something we do for small posets (less that 5 vertices?).

> The problem is, IMO, `UniqueRepresentation`. No created poset will ever be freed from the memory, and so making test with random posets will eventually eat all the memory. And if we compute `lequal_matrix()` or `_meet` etc, those will be saved too. That's why I am worried about this.


That should not be true. Once you delete all references to a poset, it should be freeable as it is a weak reference (otherwise it is a memory leak bug).

> When should this precomputing be called? In `interval()`? In `congruence()`? In, say, `is_isoform()`?


Probably in none of these places, but instead we should document it as an alternative method for increasing the speed.



---

archive/issue_comments_323388.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [comment:16 tscrim]:\n\n> That should not be true. Once you delete all references to a poset, it should be freeable as it is a weak reference (otherwise it is a memory leak bug).\n\n\nIf that would be true, then for example this should print the same number again and again:\n\n```\ni = 0\nj = 0\nfor P in Posets(8):\n    j += 1\n    if j % 1000 == 0:\n        print(sage.misc.getusage.get_memory_usage())\n    if P.is_connected():\n        i += 1\nprint(i)\n```\n\n(Compare this with same except `digraphs(8)` instead of `Posets(8)`.)\n\nCurrently there is no way to for example search for counter-example with random posets to unlimited time.",
    "created_at": "2017-07-22T06:57:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23383#issuecomment-323388",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:17'></a>Replying to [comment:16 tscrim]:

> That should not be true. Once you delete all references to a poset, it should be freeable as it is a weak reference (otherwise it is a memory leak bug).


If that would be true, then for example this should print the same number again and again:

```
i = 0
j = 0
for P in Posets(8):
    j += 1
    if j % 1000 == 0:
        print(sage.misc.getusage.get_memory_usage())
    if P.is_connected():
        i += 1
print(i)
```

(Compare this with same except `digraphs(8)` instead of `Posets(8)`.)

Currently there is no way to for example search for counter-example with random posets to unlimited time.



---

archive/issue_comments_323389.json:
```json
{
    "body": "<a id='comment:18'></a>I know `UniqueRepresentation` is a weak cache, and I do not see anything that would explicitly nail it in the memory. What is probably happening is with the iterator populating the cache and moving around all of the memory is not giving the garbage collector time to work. If I force a garbage collection, then the memory usage (basically) does not grow:\n\n```python\nimport gc\ni = 0\nj = 0\nfor P in Posets(8):\n    j += 1\n    if j % 100 == 0:\n        gc.collect()\n        print(sage.misc.getusage.get_memory_usage())\n    if P.is_connected():\n        i += 1\nprint(i)\n```\nIIRC, Python will force a garbage collection to see if it can free up the memory before giving an out-of-memory exception. Although I've never really done anything that would cause that to happen.",
    "created_at": "2017-07-22T11:42:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23383#issuecomment-323389",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:18'></a>I know `UniqueRepresentation` is a weak cache, and I do not see anything that would explicitly nail it in the memory. What is probably happening is with the iterator populating the cache and moving around all of the memory is not giving the garbage collector time to work. If I force a garbage collection, then the memory usage (basically) does not grow:

```python
import gc
i = 0
j = 0
for P in Posets(8):
    j += 1
    if j % 100 == 0:
        gc.collect()
        print(sage.misc.getusage.get_memory_usage())
    if P.is_connected():
        i += 1
print(i)
```
IIRC, Python will force a garbage collection to see if it can free up the memory before giving an out-of-memory exception. Although I've never really done anything that would cause that to happen.



---

archive/issue_comments_323390.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [comment:18 tscrim]:\n\nFirst, thanks for `gc.collect()`! I think I have read it before, and totally forget.\n\n> IIRC, Python will force a garbage collection to see if it can free up the memory before giving an out-of-memory exception. Although I've never really done anything that would cause that to happen.\n\n\nThe problem is propably memory overcommit or usage of every bit of memory. When almost every byte is used, Linux is extremely slow, and so never goes to the limit where Python would give out-of-memory exception.\n\nThis should be handled in Python level or in OS level. Sage can only add some temporary workarounds.",
    "created_at": "2017-07-23T05:20:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23383#issuecomment-323390",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:19'></a>Replying to [comment:18 tscrim]:

First, thanks for `gc.collect()`! I think I have read it before, and totally forget.

> IIRC, Python will force a garbage collection to see if it can free up the memory before giving an out-of-memory exception. Although I've never really done anything that would cause that to happen.


The problem is propably memory overcommit or usage of every bit of memory. When almost every byte is used, Linux is extremely slow, and so never goes to the limit where Python would give out-of-memory exception.

This should be handled in Python level or in OS level. Sage can only add some temporary workarounds.



---

archive/issue_comments_323391.json:
```json
{
    "body": "<a id='comment:20'></a>One last trivial thing: code format ```x``` and ```y``` in `_alternate_interval`. Once done, you can set a positive review on my behalf.",
    "created_at": "2017-07-25T00:48:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23383#issuecomment-323391",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:20'></a>One last trivial thing: code format ```x``` and ```y``` in `_alternate_interval`. Once done, you can set a positive review on my behalf.



---

archive/issue_comments_323392.json:
```json
{
    "body": "<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-25T05:49:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23383#issuecomment-323392",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_323393.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [comment:20 tscrim]:\n> One last trivial thing: code format ```x``` and ```y``` in `_alternate_interval`. Once done, you can set a positive review on my behalf.\n\n\nDone that.",
    "created_at": "2017-07-25T05:49:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23383#issuecomment-323393",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:22'></a>Replying to [comment:20 tscrim]:
> One last trivial thing: code format ```x``` and ```y``` in `_alternate_interval`. Once done, you can set a positive review on my behalf.


Done that.



---

archive/issue_comments_323394.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-07-25T05:49:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23383#issuecomment-323394",
    "user": "https://github.com/jm58660"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_060137.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-07-29T15:30:50Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23383",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23383#event-60137"
}
```



---

archive/issue_comments_323395.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-07-29T15:30:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23383#issuecomment-323395",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
