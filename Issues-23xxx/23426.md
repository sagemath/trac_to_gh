# Issue 23426: Mac app fails to build

archive/issues_023189.json:
```json
{
    "body": "Applescript errors out on the buildbot:\n\n```\nm -f sage-8.0.rc1-OSX_10.12.5_x86_64/Applications\nln -s /Applications/ sage-8.0.rc1-OSX_10.12.5_x86_64/Applications\nhdiutil create -srcfolder sage-8.0.rc1-OSX_10.12.5_x86_64 -volname sage-8.0.rc1-OSX_10.12.5_x86_64 -format UDRW tmp-sage-8.0.rc1-OSX_10.12.5_x86_64.app.dmg\ncreated: /Users/buildslave-sage/slave/binary_pkg/build/staging/OSX_mac_app/SageMath/src/mac-app/tmp-sage-8.0.rc1-OSX_10.12.5_x86_64.app.dmg\nmkdir -p mnt\nhdiutil attach tmp-sage-8.0.rc1-OSX_10.12.5_x86_64.app.dmg -mountpoint mnt\n/dev/disk1          \tGUID_partition_scheme          \t\n/dev/disk1s1        \tEFI                            \t\n/dev/disk1s2        \tApple_HFS                      \t/Users/buildslave-sage/slave/binary_pkg/build/staging/OSX_mac_app/SageMath/src/mac-app/mnt\nosascript arrangeIcons.applescript mnt SageMath-8.0.rc1.app\narrangeIcons.applescript:107:111: execution error: An error of type -10810 has occurred. (-10810)\nmake[2]: *** [tmp-sage-8.0.rc1-OSX_10.12.5_x86_64.app.dmg] Error 1\nmake[2]: Target `default' not remade because of errors.\ncp: SageMath/src/mac-app/sage-8.0.rc1-*.app.dmg: No such file or directory\nERROR:root:Script failed:\nERROR:root:DMG=/Users/buildslave-sage/slave/binary_pkg/build/dist/sage-8.0.rc1-OSX_10.12.5-x86_64.app.dmg\nrm -f $DMG\npwd\n(cd SageMath/src/mac-app && make)\ncp SageMath/src/mac-app/sage-8.0.rc1-*.app.dmg $DMG\nTraceback (most recent call last):\n  File \"/Users/buildslave-sage/slave/binary_pkg/build/tools/binary-pkg/lib/python3.4/runpy.py\", line 170, in _run_module_as_main\n    \"__main__\", mod_spec)\n  File \"/Users/buildslave-sage/slave/binary_pkg/build/tools/binary-pkg/lib/python3.4/runpy.py\", line 85, in _run_code\n    exec(code, run_globals)\n  File \"/Users/buildslave-sage/slave/binary_pkg/build/binary_pkg/cmdline.py\", line 78, in <module>\n    launch()\n  File \"/Users/buildslave-sage/slave/binary_pkg/build/binary_pkg/cmdline.py\", line 74, in launch\n    package.dist_script.run()\n  File \"/Users/buildslave-sage/slave/binary_pkg/build/binary_pkg/bash_script.py\", line 37, in run\n    ['bash', self._filename], cwd=self._cwd, env=self.env())\n  File \"/Users/buildslave-sage/slave/binary_pkg/build/tools/binary-pkg/lib/python3.4/subprocess.py\", line 561, in check_call\n    raise CalledProcessError(retcode, cmd)\nsubprocess.CalledProcessError: Command '['bash', '/Users/buildslave-sage/slave/binary_pkg/build/tmp/SageMath/tmpeawae8g9.sh']' returned non-zero exit status 1\nNamespace(build=False, checkout=False, config='sage.yaml', debug=False, dist=True, info=False, log=None, option_help=False, package='OSX mac app', stage=False)\nmake[1]: *** [dist-sage] Error 1\nmake: *** [bdist-sage-osx] Error 2\n```\n\nAssignee: @unhyperbolic\n\nBranch/Commit: 4459c37cdb8b235d89b23e6e062829ca818a9a4a\n\nReviewer: Volker Braun\n\nAuthor: Matthias Goerner\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/23426\n\n",
    "closed_at": "2018-01-04T07:59:42Z",
    "created_at": "2017-07-13T20:49:12Z",
    "labels": [
        "component: build",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Mac app fails to build",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23426",
    "user": "https://github.com/vbraun"
}
```
Applescript errors out on the buildbot:

```
m -f sage-8.0.rc1-OSX_10.12.5_x86_64/Applications
ln -s /Applications/ sage-8.0.rc1-OSX_10.12.5_x86_64/Applications
hdiutil create -srcfolder sage-8.0.rc1-OSX_10.12.5_x86_64 -volname sage-8.0.rc1-OSX_10.12.5_x86_64 -format UDRW tmp-sage-8.0.rc1-OSX_10.12.5_x86_64.app.dmg
created: /Users/buildslave-sage/slave/binary_pkg/build/staging/OSX_mac_app/SageMath/src/mac-app/tmp-sage-8.0.rc1-OSX_10.12.5_x86_64.app.dmg
mkdir -p mnt
hdiutil attach tmp-sage-8.0.rc1-OSX_10.12.5_x86_64.app.dmg -mountpoint mnt
/dev/disk1          	GUID_partition_scheme          	
/dev/disk1s1        	EFI                            	
/dev/disk1s2        	Apple_HFS                      	/Users/buildslave-sage/slave/binary_pkg/build/staging/OSX_mac_app/SageMath/src/mac-app/mnt
osascript arrangeIcons.applescript mnt SageMath-8.0.rc1.app
arrangeIcons.applescript:107:111: execution error: An error of type -10810 has occurred. (-10810)
make[2]: *** [tmp-sage-8.0.rc1-OSX_10.12.5_x86_64.app.dmg] Error 1
make[2]: Target `default' not remade because of errors.
cp: SageMath/src/mac-app/sage-8.0.rc1-*.app.dmg: No such file or directory
ERROR:root:Script failed:
ERROR:root:DMG=/Users/buildslave-sage/slave/binary_pkg/build/dist/sage-8.0.rc1-OSX_10.12.5-x86_64.app.dmg
rm -f $DMG
pwd
(cd SageMath/src/mac-app && make)
cp SageMath/src/mac-app/sage-8.0.rc1-*.app.dmg $DMG
Traceback (most recent call last):
  File "/Users/buildslave-sage/slave/binary_pkg/build/tools/binary-pkg/lib/python3.4/runpy.py", line 170, in _run_module_as_main
    "__main__", mod_spec)
  File "/Users/buildslave-sage/slave/binary_pkg/build/tools/binary-pkg/lib/python3.4/runpy.py", line 85, in _run_code
    exec(code, run_globals)
  File "/Users/buildslave-sage/slave/binary_pkg/build/binary_pkg/cmdline.py", line 78, in <module>
    launch()
  File "/Users/buildslave-sage/slave/binary_pkg/build/binary_pkg/cmdline.py", line 74, in launch
    package.dist_script.run()
  File "/Users/buildslave-sage/slave/binary_pkg/build/binary_pkg/bash_script.py", line 37, in run
    ['bash', self._filename], cwd=self._cwd, env=self.env())
  File "/Users/buildslave-sage/slave/binary_pkg/build/tools/binary-pkg/lib/python3.4/subprocess.py", line 561, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command '['bash', '/Users/buildslave-sage/slave/binary_pkg/build/tmp/SageMath/tmpeawae8g9.sh']' returned non-zero exit status 1
Namespace(build=False, checkout=False, config='sage.yaml', debug=False, dist=True, info=False, log=None, option_help=False, package='OSX mac app', stage=False)
make[1]: *** [dist-sage] Error 1
make: *** [bdist-sage-osx] Error 2
```

Assignee: @unhyperbolic

Branch/Commit: 4459c37cdb8b235d89b23e6e062829ca818a9a4a

Reviewer: Volker Braun

Author: Matthias Goerner

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/23426





---

archive/issue_comments_434725.json:
```json
{
    "body": "<a id='comment:1'></a>\nWorks while logged in on the GUI, but not when headless",
    "created_at": "2017-07-13T21:15:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23426#issuecomment-434725",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:1'></a>
Works while logged in on the GUI, but not when headless



---

archive/issue_comments_434726.json:
```json
{
    "body": "<a id='comment:2'></a>\nTo summarize the history of this bug, there are two methods to generate the .DS_store file and get the nice background image (see Ticket #20119).\n1. Use al45tair's ds_store to generate from python. I wrote code for that in sage in src/mac-app/tools/createDSStore but then removed it in [db0460e0](https://github.com/sagemath/sagetrac-mirror/commit/db0460e04ff4bce8becc26804c8b2449673850b5) to favor\n2. Use AppleScript which I did in [8e10f56](https://github.com/sagemath/sagetrac-mirror/commit/8e10f56bfd47b651ebc1481de1c6cf05eeeb9396) to address Ticket #22739.\n\nMethod 1. has the advantage that it is headless and faster (doesn't require an intermediate packing und unpacking a .dmg). It has the disadvantage that it doesn't work on the first release of Mac OS Sierra.\n\n**The news: It appears that Apple has fixed the bug in Finder and method 1. should work again.** It can even be made to work with the one broken release of Mac OS Sierra, see al45tair's [comment](https://bitbucket.org/al45tair/ds_store/issues/7) on bitbucket.\n\nIf we need headless, we can simply try to reinstantiate the code I deleted in [db0460e0](https://github.com/sagemath/sagetrac-mirror/commit/db0460e04ff4bce8becc26804c8b2449673850b5) and revert [8e10f56](https://github.com/sagemath/sagetrac-mirror/commit/8e10f56bfd47b651ebc1481de1c6cf05eeeb9396).",
    "created_at": "2017-12-16T18:43:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23426#issuecomment-434726",
    "user": "https://github.com/unhyperbolic"
}
```

<a id='comment:2'></a>
To summarize the history of this bug, there are two methods to generate the .DS_store file and get the nice background image (see Ticket #20119).
1. Use al45tair's ds_store to generate from python. I wrote code for that in sage in src/mac-app/tools/createDSStore but then removed it in [db0460e0](https://github.com/sagemath/sagetrac-mirror/commit/db0460e04ff4bce8becc26804c8b2449673850b5) to favor
2. Use AppleScript which I did in [8e10f56](https://github.com/sagemath/sagetrac-mirror/commit/8e10f56bfd47b651ebc1481de1c6cf05eeeb9396) to address Ticket #22739.

Method 1. has the advantage that it is headless and faster (doesn't require an intermediate packing und unpacking a .dmg). It has the disadvantage that it doesn't work on the first release of Mac OS Sierra.

**The news: It appears that Apple has fixed the bug in Finder and method 1. should work again.** It can even be made to work with the one broken release of Mac OS Sierra, see al45tair's [comment](https://bitbucket.org/al45tair/ds_store/issues/7) on bitbucket.

If we need headless, we can simply try to reinstantiate the code I deleted in [db0460e0](https://github.com/sagemath/sagetrac-mirror/commit/db0460e04ff4bce8becc26804c8b2449673850b5) and revert [8e10f56](https://github.com/sagemath/sagetrac-mirror/commit/8e10f56bfd47b651ebc1481de1c6cf05eeeb9396).



---

archive/issue_comments_434727.json:
```json
{
    "body": "<a id='comment:3'></a>\nThere is no need to support the first release of Sierra. Please go back to solution number 1...",
    "created_at": "2017-12-23T16:24:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23426#issuecomment-434727",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:3'></a>
There is no need to support the first release of Sierra. Please go back to solution number 1...



---

archive/issue_comments_434728.json:
```json
{
    "body": "<a id='comment:4'></a>\nAgreed. Will do after New Year.",
    "created_at": "2017-12-23T17:32:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23426#issuecomment-434728",
    "user": "https://github.com/unhyperbolic"
}
```

<a id='comment:4'></a>
Agreed. Will do after New Year.



---

archive/issue_comments_434729.json:
```json
{
    "body": "Changing branch from \"\" to \"u/mgoerner/mac_app_fails_to_build\"",
    "created_at": "2017-12-31T08:31:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23426#issuecomment-434729",
    "user": "https://github.com/unhyperbolic"
}
```

Changing branch from "" to "u/mgoerner/mac_app_fails_to_build"



---

archive/issue_comments_434730.json:
```json
{
    "body": "<a id='comment:6'></a>\nNew commits:\n|                                                                                                                                          |                                                                           |\n|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------|\n|[6c0daf8](https://github.com/sagemath/sagetrac-mirror/commit/6c0daf85e2ef75e875131f5cf7dec0617a192867)|`Moving arrangeIcons.applescript (used when building the .dmg for Mac OS).`|\n|[9d47f2e](https://github.com/sagemath/sagetrac-mirror/commit/9d47f2e0d29fbc9ad1b8972c7cf07a583415abde)|`Makefile for Mac OS .dmg: marking non_app_files as .PHONY.`|\n|[4459c37](https://github.com/sagemath/sagetrac-mirror/commit/4459c37cdb8b235d89b23e6e062829ca818a9a4a)|`When building the Mac .dmg, re-enabling createDSStore (first introduced in ticket 20119 and then removed in ticket 22739) to set the background image.`|",
    "created_at": "2017-12-31T08:38:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23426#issuecomment-434730",
    "user": "https://github.com/unhyperbolic"
}
```

<a id='comment:6'></a>
New commits:
|                                                                                                                                          |                                                                           |
|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------|
|[6c0daf8](https://github.com/sagemath/sagetrac-mirror/commit/6c0daf85e2ef75e875131f5cf7dec0617a192867)|`Moving arrangeIcons.applescript (used when building the .dmg for Mac OS).`|
|[9d47f2e](https://github.com/sagemath/sagetrac-mirror/commit/9d47f2e0d29fbc9ad1b8972c7cf07a583415abde)|`Makefile for Mac OS .dmg: marking non_app_files as .PHONY.`|
|[4459c37](https://github.com/sagemath/sagetrac-mirror/commit/4459c37cdb8b235d89b23e6e062829ca818a9a4a)|`When building the Mac .dmg, re-enabling createDSStore (first introduced in ticket 20119 and then removed in ticket 22739) to set the background image.`|



---

archive/issue_comments_434731.json:
```json
{
    "body": "Set assignee to @unhyperbolic.",
    "created_at": "2017-12-31T08:38:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23426#issuecomment-434731",
    "user": "https://github.com/unhyperbolic"
}
```

Set assignee to @unhyperbolic.



---

archive/issue_comments_434732.json:
```json
{
    "body": "Changing commit from \"\" to \"4459c37cdb8b235d89b23e6e062829ca818a9a4a\"",
    "created_at": "2017-12-31T08:38:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23426#issuecomment-434732",
    "user": "https://github.com/unhyperbolic"
}
```

Changing commit from "" to "4459c37cdb8b235d89b23e6e062829ca818a9a4a"



---

archive/issue_comments_434733.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-12-31T16:41:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23426#issuecomment-434733",
    "user": "https://github.com/unhyperbolic"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_434734.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Volker Braun\"",
    "created_at": "2018-01-01T21:31:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23426#issuecomment-434734",
    "user": "https://github.com/vbraun"
}
```

Changing reviewer from "" to "Volker Braun"



---

archive/issue_comments_434735.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-01-01T21:31:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23426#issuecomment-434735",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_434736.json:
```json
{
    "body": "Changing author from \"\" to \"Matthias Goerner\"",
    "created_at": "2018-01-01T21:31:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23426#issuecomment-434736",
    "user": "https://github.com/vbraun"
}
```

Changing author from "" to "Matthias Goerner"



---

archive/issue_comments_434737.json:
```json
{
    "body": "<a id='comment:8'></a>\nthanks!",
    "created_at": "2018-01-01T21:31:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23426#issuecomment-434737",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:8'></a>
thanks!



---

archive/issue_events_076268.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-01-04T07:59:42Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23426",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23426#event-76268"
}
```



---

archive/issue_comments_434738.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-01-04T07:59:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23426#issuecomment-434738",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_434739.json:
```json
{
    "body": "Changing branch from \"u/mgoerner/mac_app_fails_to_build\" to \"4459c37cdb8b235d89b23e6e062829ca818a9a4a\"",
    "created_at": "2018-01-04T07:59:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23426#issuecomment-434739",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/mgoerner/mac_app_fails_to_build" to "4459c37cdb8b235d89b23e6e062829ca818a9a4a"
