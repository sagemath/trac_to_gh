# Issue 23648: Py3: TypeError from Cython string conversion

archive/issues_023411.json:
```json
{
    "assignees": [],
    "body": "With Py3, as reported in https://github.com/pynac/pynac/issues/271\n\n```\nIn [2]: import sage\nIn [3]: from sage.libs.pynac.constant import PynacConstant\nIn [4]: f = PynacConstant('foo', 'foo', 'real')\n...\nTypeError: expected bytes, str found\n```\nIt's is in this part of the Sage-Pynac interface:\n\n```\n  /* \"sage/libs/pynac/constant.pyx\":68\n *             self.pointer = <GConstant *>&g_NaN\n *         else:\n>>> *          self._object = new GConstant(name, ConstantEvalf, texname, domain)             # <<<<<<<<<<<<<<\n *             self.pointer = self._object\n * \n */\n  /*else*/ {\n    __pyx_t_2 = __Pyx_PyObject_AsWritableString(__pyx_v_name); if (unlikely((!__pyx_t_2) && PyErr_Occurred())) __PYX_ERR(0, 68, __pyx_L1_error)\n    __pyx_t_3 = __Pyx_PyObject_AsWritableString(__pyx_v_texname); if (unlikely((!__pyx_t_3) && PyErr_Occurred())) __PYX_ERR(0, 68, __pyx_L1_error)\n    __pyx_v_self->_object = new constant(__pyx_t_2, ConstantEvalf, __pyx_t_3, __pyx_v_domain);\n```\nApparently the error comes from this function (or below): https://github.com/cython/cython/blob/master/Cython/Utility/TypeConversion.c#L202\n\nEDIT: also, one currently gets\n\n```\nIn [28]: f = PynacConstant(b'foo', b'foo', 'real')\n\nIn [29]: f.__repr__()\nOut[29]: b'foo'\n```\n\nDepends on #24222\n\nCC:  @fchapoton @embray\n\nKeywords: **Py3, unicode**\n\nBranch/Commit: **[public/23648](https://github.com/sagemath/sagetrac-mirror/tree/public/23648) @ [7e01422](https://github.com/sagemath/sagetrac-mirror/commit/7e014227489fa0d52a9528681833670ab7926904)**\n\nAuthor: **Fr\u00e9d\u00e9ric Chapoton**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/23648_\n\n",
    "closed_at": "2018-02-12T17:33:08Z",
    "created_at": "2017-08-19T07:51:25Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/bug",
        "https://github.com/sagemath/sage/labels/component%3A%20python3",
        "https://github.com/sagemath/sage/labels/invalid",
        "https://github.com/sagemath/sage/labels/worksforme"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Py3: TypeError from Cython string conversion",
    "type": "issue",
    "updated_at": "2018-02-12T17:33:08Z",
    "url": "https://github.com/sagemath/sage/issues/23648",
    "user": "https://github.com/rwst"
}
```
With Py3, as reported in https://github.com/pynac/pynac/issues/271

```
In [2]: import sage
In [3]: from sage.libs.pynac.constant import PynacConstant
In [4]: f = PynacConstant('foo', 'foo', 'real')
...
TypeError: expected bytes, str found
```
It's is in this part of the Sage-Pynac interface:

```
  /* "sage/libs/pynac/constant.pyx":68
 *             self.pointer = <GConstant *>&g_NaN
 *         else:
>>> *          self._object = new GConstant(name, ConstantEvalf, texname, domain)             # <<<<<<<<<<<<<<
 *             self.pointer = self._object
 * 
 */
  /*else*/ {
    __pyx_t_2 = __Pyx_PyObject_AsWritableString(__pyx_v_name); if (unlikely((!__pyx_t_2) && PyErr_Occurred())) __PYX_ERR(0, 68, __pyx_L1_error)
    __pyx_t_3 = __Pyx_PyObject_AsWritableString(__pyx_v_texname); if (unlikely((!__pyx_t_3) && PyErr_Occurred())) __PYX_ERR(0, 68, __pyx_L1_error)
    __pyx_v_self->_object = new constant(__pyx_t_2, ConstantEvalf, __pyx_t_3, __pyx_v_domain);
```
Apparently the error comes from this function (or below): https://github.com/cython/cython/blob/master/Cython/Utility/TypeConversion.c#L202

EDIT: also, one currently gets

```
In [28]: f = PynacConstant(b'foo', b'foo', 'real')

In [29]: f.__repr__()
Out[29]: b'foo'
```

Depends on #24222

CC:  @fchapoton @embray

Keywords: **Py3, unicode**

Branch/Commit: **[public/23648](https://github.com/sagemath/sagetrac-mirror/tree/public/23648) @ [7e01422](https://github.com/sagemath/sagetrac-mirror/commit/7e014227489fa0d52a9528681833670ab7926904)**

Author: **Frédéric Chapoton**

_Issue created by migration from https://trac.sagemath.org/ticket/23648_





---

archive/issue_events_310903.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2017-08-19T07:51:25Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "milestone_number": null,
    "milestone_title": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23648#event-310903"
}
```



---

archive/issue_events_310904.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2017-08-19T07:51:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20cython",
    "label_color": "000080",
    "label_name": "component: cython",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23648#event-310904"
}
```



---

archive/issue_events_310905.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2017-08-19T07:51:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23648#event-310905"
}
```



---

archive/issue_events_310906.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2017-08-19T07:51:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23648#event-310906"
}
```



---

archive/issue_events_310907.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-08-19T18:27:24Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20cython",
    "label_color": "000080",
    "label_name": "component: cython",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23648#event-310907"
}
```



---

archive/issue_events_310908.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-08-19T18:27:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20python3",
    "label_color": "000080",
    "label_name": "component: python3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23648#event-310908"
}
```



---

archive/issue_comments_358648.json:
```json
{
    "body": "Changed keywords from **Py3, cython** to **Py3**",
    "created_at": "2017-08-19T18:27:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358648",
    "user": "https://github.com/jdemeyer"
}
```

Changed keywords from **Py3, cython** to **Py3**



---

archive/issue_comments_358649.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">Comment 2</div>\n\nso this is not a cython problem ? where is the issue then ?",
    "created_at": "2017-08-22T13:40:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358649",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:2" align="right">Comment 2</div>

so this is not a cython problem ? where is the issue then ?



---

archive/issue_comments_358650.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">Comment 3</div>\n\nIt's just your typical `unicode` vs. `bytes` issue. Some API expects `bytes` but is given `unicode` instead.",
    "created_at": "2017-08-22T13:44:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358650",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:3" align="right">Comment 3</div>

It's just your typical `unicode` vs. `bytes` issue. Some API expects `bytes` but is given `unicode` instead.



---

archive/issue_comments_358651.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">Comment 4</div>\n\nwell, same kind of thing as here then ?\n\n```\ncypari2/auto_gen.pxi in cypari2.gen.Gen_auto.Polrev()\n\ncypari2/pari_instance.pyx in cypari2.pari_instance.get_var()\n\nTypeError: string argument without an encoding\n```\nHopefully this one will be fixed by #23518",
    "created_at": "2017-08-22T14:30:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358651",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:4" align="right">Comment 4</div>

well, same kind of thing as here then ?

```
cypari2/auto_gen.pxi in cypari2.gen.Gen_auto.Polrev()

cypari2/pari_instance.pyx in cypari2.pari_instance.get_var()

TypeError: string argument without an encoding
```
Hopefully this one will be fixed by #23518



---

archive/issue_comments_358652.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">Comment 5</div>\n\nConfirmed in the latest python3 build.\n\nEDIT: And this is a major blocking point.",
    "created_at": "2017-09-10T16:36:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358652",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:5" align="right">Comment 5</div>

Confirmed in the latest python3 build.

EDIT: And this is a major blocking point.



---

archive/issue_comments_358653.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -23,3 +23,12 @@\n     __pyx_v_self->_object = new constant(__pyx_t_2, ConstantEvalf, __pyx_t_3, __pyx_v_domain);\n ```\n Apparently the error comes from this function (or below): https://github.com/cython/cython/blob/master/Cython/Utility/TypeConversion.c#L202\n+\n+EDIT: also, one currently gets\n+\n+```\n+In [28]: f = PynacConstant(b'foo', b'foo', 'real')\n+\n+In [29]: f.__repr__()\n+Out[29]: b'foo'\n+```\n``````\n",
    "created_at": "2017-09-11T11:05:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358653",
    "user": "https://github.com/fchapoton"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -23,3 +23,12 @@
     __pyx_v_self->_object = new constant(__pyx_t_2, ConstantEvalf, __pyx_t_3, __pyx_v_domain);
 ```
 Apparently the error comes from this function (or below): https://github.com/cython/cython/blob/master/Cython/Utility/TypeConversion.c#L202
+
+EDIT: also, one currently gets
+
+```
+In [28]: f = PynacConstant(b'foo', b'foo', 'real')
+
+In [29]: f.__repr__()
+Out[29]: b'foo'
+```
``````




---

archive/issue_events_310909.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2017-09-11T11:05:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23648#event-310909"
}
```



---

archive/issue_comments_358654.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">Comment 7</div>\n\nJeroen, can you please clarify where this should be fixed?",
    "created_at": "2017-09-12T05:46:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358654",
    "user": "https://github.com/rwst"
}
```

<div id="comment:7" align="right">Comment 7</div>

Jeroen, can you please clarify where this should be fixed?



---

archive/issue_comments_358655.json:
```json
{
    "body": "Commit: **[587938f](https://github.com/sagemath/sagetrac-mirror/commit/587938f63792af7a0d893e1126e5bc0cbd86c3a0)**",
    "created_at": "2017-09-14T08:23:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358655",
    "user": "https://github.com/fchapoton"
}
```

Commit: **[587938f](https://github.com/sagemath/sagetrac-mirror/commit/587938f63792af7a0d893e1126e5bc0cbd86c3a0)**



---

archive/issue_events_310910.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2017-09-14T08:23:47Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23648#event-310910"
}
```



---

archive/issue_events_310911.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2017-09-14T08:23:47Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23648#event-310911"
}
```



---

archive/issue_comments_358656.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">Comment 8</div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/069fd3614fb0861b16ac2b706043f134445a12d9\">069fd36</a></td><td><code>new method \"to_bytes\" and change in pynac constant</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/587938f63792af7a0d893e1126e5bc0cbd86c3a0\">587938f</a></td><td><code>adding an alias for u</code></td></tr></table>\n",
    "created_at": "2017-09-14T08:23:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358656",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:8" align="right">Comment 8</div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/069fd3614fb0861b16ac2b706043f134445a12d9">069fd36</a></td><td><code>new method "to_bytes" and change in pynac constant</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/587938f63792af7a0d893e1126e5bc0cbd86c3a0">587938f</a></td><td><code>adding an alias for u</code></td></tr></table>




---

archive/issue_comments_358657.json:
```json
{
    "body": "Branch: **[public/23648](https://github.com/sagemath/sagetrac-mirror/tree/public/23648)**",
    "created_at": "2017-09-14T08:23:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358657",
    "user": "https://github.com/fchapoton"
}
```

Branch: **[public/23648](https://github.com/sagemath/sagetrac-mirror/tree/public/23648)**



---

archive/issue_comments_358658.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">Comment 9</div>\n\n1. Please remove `to_unicode = u`, that is not relevant here.\n\n2. I suggest to use `sys.getfilesystemencoding()` instead of hard-coding UTF-8. The reason is that the conversions you are doing here are really analogous to the implicit `bytes <-> unicode` conversions that Python 3 does internally. In those cases, Python 3 mostly uses `sys.getfilesystemencoding()`.",
    "created_at": "2017-09-14T08:37:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358658",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:9" align="right">Comment 9</div>

1. Please remove `to_unicode = u`, that is not relevant here.

2. I suggest to use `sys.getfilesystemencoding()` instead of hard-coding UTF-8. The reason is that the conversions you are doing here are really analogous to the implicit `bytes <-> unicode` conversions that Python 3 does internally. In those cases, Python 3 mostly uses `sys.getfilesystemencoding()`.



---

archive/issue_comments_358659.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">Comment 10</div>\n\n3. Maybe renaming the function to `string_to_bytes` to make it clear that it accepts only string-like objects, it does not convert everything to `bytes`.\n\n4. For efficiency, I would implement this in a Cython file as `cpdef` functions such that Cython code can benefit from fast calls. Maybe a new file like `src/sage/cpython/string.pyx`?",
    "created_at": "2017-09-14T08:39:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358659",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:10" align="right">Comment 10</div>

3. Maybe renaming the function to `string_to_bytes` to make it clear that it accepts only string-like objects, it does not convert everything to `bytes`.

4. For efficiency, I would implement this in a Cython file as `cpdef` functions such that Cython code can benefit from fast calls. Maybe a new file like `src/sage/cpython/string.pyx`?



---

archive/issue_comments_358660.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">Comment 11</div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7e014227489fa0d52a9528681833670ab7926904\">7e01422</a></td><td><code>trac 23648</code></td></tr></table>\n",
    "created_at": "2017-09-14T08:44:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358660",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:11" align="right">Comment 11</div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7e014227489fa0d52a9528681833670ab7926904">7e01422</a></td><td><code>trac 23648</code></td></tr></table>




---

archive/issue_comments_358661.json:
```json
{
    "body": "Changed commit from **[587938f](https://github.com/sagemath/sagetrac-mirror/commit/587938f63792af7a0d893e1126e5bc0cbd86c3a0)** to **[7e01422](https://github.com/sagemath/sagetrac-mirror/commit/7e014227489fa0d52a9528681833670ab7926904)**",
    "created_at": "2017-09-14T08:44:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358661",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[587938f](https://github.com/sagemath/sagetrac-mirror/commit/587938f63792af7a0d893e1126e5bc0cbd86c3a0)** to **[7e01422](https://github.com/sagemath/sagetrac-mirror/commit/7e014227489fa0d52a9528681833670ab7926904)**



---

archive/issue_comments_358662.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">Comment 13</div>\n\nAlternatively, you could directly implement conversion `char *` -> `str` (skipping the intermediate `bytes` step) using `PyUnicode_DecodeFSDefault` in Python 3.",
    "created_at": "2017-09-14T13:02:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358662",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:13" align="right">Comment 13</div>

Alternatively, you could directly implement conversion `char *` -> `str` (skipping the intermediate `bytes` step) using `PyUnicode_DecodeFSDefault` in Python 3.



---

archive/issue_comments_358663.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">Comment 14</div>\n\nHow is your last comment related to #23857 ?\n\nI am not able to turn the branche here easily into a cpdef function. Could one of you do that please ?",
    "created_at": "2017-09-20T09:53:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358663",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:14" align="right">Comment 14</div>

How is your last comment related to #23857 ?

I am not able to turn the branche here easily into a cpdef function. Could one of you do that please ?



---

archive/issue_comments_358664.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">Comment 15</div>\n\nReplying to [@fchapoton](#comment%3A14):\n> How is your last comment related to #23857 ?\n\nIt is not strictly related to #23857. It is just that #23857 also fixes some `bytes` vs `str` bugs, but only for C++ code.",
    "created_at": "2017-09-20T12:31:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358664",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:15" align="right">Comment 15</div>

Replying to [@fchapoton](#comment%3A14):
> How is your last comment related to #23857 ?

It is not strictly related to #23857. It is just that #23857 also fixes some `bytes` vs `str` bugs, but only for C++ code.



---

archive/issue_comments_358665.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">Comment 16</div>\n\nReplying to [@fchapoton](#comment%3A14):\n> How is your last comment related to #23857 ?\n> \n> I am not able to turn the branche here easily into a cpdef function. Could one of you do that please ?\n\n***ping*** ?",
    "created_at": "2017-10-12T08:21:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358665",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:16" align="right">Comment 16</div>

Replying to [@fchapoton](#comment%3A14):
> How is your last comment related to #23857 ?
> 
> I am not able to turn the branche here easily into a cpdef function. Could one of you do that please ?

***ping*** ?



---

archive/issue_comments_358666.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">Comment 17</div>\n\nTraceback please!",
    "created_at": "2017-10-13T15:24:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358666",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:17" align="right">Comment 17</div>

Traceback please!



---

archive/issue_comments_358667.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">Comment 18</div>\n\nSee also https://groups.google.com/d/msg/sage-devel/H0t9l6XdfPI/5ss5I5A4CAAJ",
    "created_at": "2017-10-13T15:25:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358667",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:18" align="right">Comment 18</div>

See also https://groups.google.com/d/msg/sage-devel/H0t9l6XdfPI/5ss5I5A4CAAJ



---

archive/issue_comments_358668.json:
```json
{
    "body": "Changed keywords from **Py3** to **Py3, unicode**",
    "created_at": "2017-10-30T16:22:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358668",
    "user": "https://github.com/fchapoton"
}
```

Changed keywords from **Py3** to **Py3, unicode**



---

archive/issue_comments_358669.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">Comment 20</div>\n\nHere is some traceback (using ipython3 with a failed python3-built):\n\n```\nIn [3]: from sage.all import *\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-3-90a1b1fe16c5> in <module>()\n----> 1 from sage.all import *\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/all.py in <module>()\n    100 from sage.matrix.all     import *\n    101 \n--> 102 from sage.symbolic.all   import *\n    103 from sage.modules.all    import *\n    104 from sage.monoids.all    import *\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/symbolic/all.py in <module>()\n      5 \n      6 from .ring import SR\n----> 7 from .constants import (pi, e, NaN, golden_ratio, log2, euler_gamma, catalan,\n      8                        khinchin, twinprime, mertens, glaisher)\n      9 from .expression import Expression, solve_diophantine\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/symbolic/constants.py in <module>()\n    842         return sympy.GoldenRatio\n    843 \n--> 844 golden_ratio = GoldenRatio().expression()\n    845 \n    846 class Log2(Constant):\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/symbolic/constants.py in __init__(self, name)\n    772                            kash='(1+Sqrt(5))/2', giac='(1+sqrt(5))/2')\n    773         Constant.__init__(self, name, conversions=conversions,\n--> 774                           latex=r'\\phi', domain='positive')\n    775 \n    776     def minpoly(self, bits=None, degree=None, epsilon=0):\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/symbolic/constants.py in __init__(self, name, conversions, latex, mathml, domain)\n    286 \n    287         from sage.libs.pynac.constant import PynacConstant\n--> 288         self._pynac = PynacConstant(self._name, self._latex, self._domain)\n    289         self._serial = self._pynac.serial()\n    290         constants_table[self._serial] = self\n\n/home/chapoton/sage3/src/sage/libs/pynac/constant.pyx in sage.libs.pynac.constant.PynacConstant.__cinit__ (build/cythonized/sage/libs/pynac/constant.cpp:2527)()\n\nTypeError: expected bytes, str found\n```",
    "created_at": "2017-10-31T15:47:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358669",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:20" align="right">Comment 20</div>

Here is some traceback (using ipython3 with a failed python3-built):

```
In [3]: from sage.all import *
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-3-90a1b1fe16c5> in <module>()
----> 1 from sage.all import *

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/all.py in <module>()
    100 from sage.matrix.all     import *
    101 
--> 102 from sage.symbolic.all   import *
    103 from sage.modules.all    import *
    104 from sage.monoids.all    import *

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/symbolic/all.py in <module>()
      5 
      6 from .ring import SR
----> 7 from .constants import (pi, e, NaN, golden_ratio, log2, euler_gamma, catalan,
      8                        khinchin, twinprime, mertens, glaisher)
      9 from .expression import Expression, solve_diophantine

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/symbolic/constants.py in <module>()
    842         return sympy.GoldenRatio
    843 
--> 844 golden_ratio = GoldenRatio().expression()
    845 
    846 class Log2(Constant):

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/symbolic/constants.py in __init__(self, name)
    772                            kash='(1+Sqrt(5))/2', giac='(1+sqrt(5))/2')
    773         Constant.__init__(self, name, conversions=conversions,
--> 774                           latex=r'\phi', domain='positive')
    775 
    776     def minpoly(self, bits=None, degree=None, epsilon=0):

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/symbolic/constants.py in __init__(self, name, conversions, latex, mathml, domain)
    286 
    287         from sage.libs.pynac.constant import PynacConstant
--> 288         self._pynac = PynacConstant(self._name, self._latex, self._domain)
    289         self._serial = self._pynac.serial()
    290         constants_table[self._serial] = self

/home/chapoton/sage3/src/sage/libs/pynac/constant.pyx in sage.libs.pynac.constant.PynacConstant.__cinit__ (build/cythonized/sage/libs/pynac/constant.cpp:2527)()

TypeError: expected bytes, str found
```



---

archive/issue_comments_358670.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">Comment 21</div>\n\nping ?\n\nOnce again, I am not able to make a cpdef function, so please do that.",
    "created_at": "2017-11-04T08:38:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358670",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:21" align="right">Comment 21</div>

ping ?

Once again, I am not able to make a cpdef function, so please do that.



---

archive/issue_comments_358671.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">Comment 22</div>\n\nI have created a new ticket that just wants to introduce the conversion tools: #24186.",
    "created_at": "2017-11-10T12:45:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358671",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:22" align="right">Comment 22</div>

I have created a new ticket that just wants to introduce the conversion tools: #24186.



---

archive/issue_comments_358672.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">Comment 23</div>\n\nNo patchbot on this until now, strange.",
    "created_at": "2017-11-26T17:08:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358672",
    "user": "https://github.com/rwst"
}
```

<div id="comment:23" align="right">Comment 23</div>

No patchbot on this until now, strange.



---

archive/issue_comments_358673.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">Comment 24</div>\n\nAuthors field is empty..",
    "created_at": "2017-11-26T20:12:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358673",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:24" align="right">Comment 24</div>

Authors field is empty..



---

archive/issue_comments_358674.json:
```json
{
    "body": "Dependencies: **#24222**",
    "created_at": "2017-11-27T07:39:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358674",
    "user": "https://github.com/rwst"
}
```

Dependencies: **#24222**



---

archive/issue_comments_358675.json:
```json
{
    "body": "Author: **Fr\u00e9d\u00e9ric Chapoton**",
    "created_at": "2017-11-28T12:32:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358675",
    "user": "https://github.com/jdemeyer"
}
```

Author: **Frédéric Chapoton**



---

archive/issue_comments_358676.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">Comment 27</div>\n\nThis should use the functions introduced in #24222.",
    "created_at": "2017-11-28T12:35:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358676",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:27" align="right">Comment 27</div>

This should use the functions introduced in #24222.



---

archive/issue_events_310912.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-11-28T12:35:36Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23648#event-310912"
}
```



---

archive/issue_events_310913.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-11-28T12:35:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23648#event-310913"
}
```



---

archive/issue_events_310914.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-02-12T14:08:45Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "milestone_number": null,
    "milestone_title": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23648#event-310914"
}
```



---

archive/issue_events_310915.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-02-12T14:08:45Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23648#event-310915"
}
```



---

archive/issue_events_310916.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-02-12T14:08:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "label": "https://github.com/sagemath/sage/labels/invalid",
    "label_color": "a6a6a6",
    "label_name": "invalid",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23648#event-310916"
}
```



---

archive/issue_comments_358677.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">Comment 28</div>\n\nLet us close this one as invalid, please",
    "created_at": "2018-02-12T14:08:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358677",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:28" align="right">Comment 28</div>

Let us close this one as invalid, please



---

archive/issue_events_310917.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-02-12T14:08:45Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23648#event-310917"
}
```



---

archive/issue_events_310918.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-02-12T14:08:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23648#event-310918"
}
```



---

archive/issue_comments_358678.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">Comment 29</div>\n\nWhy? Is it already fixed?",
    "created_at": "2018-02-12T14:14:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358678",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:29" align="right">Comment 29</div>

Why? Is it already fixed?



---

archive/issue_comments_358679.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">Comment 30</div>\n\nIt seems so. I am not able to reproduce that in ipython. And I am also currently no longer able to have a starting python3-sage, sadly.",
    "created_at": "2018-02-12T14:17:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358679",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:30" align="right">Comment 30</div>

It seems so. I am not able to reproduce that in ipython. And I am also currently no longer able to have a starting python3-sage, sadly.



---

archive/issue_comments_358680.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">Comment 31</div>\n\nSo we need more info, no?",
    "created_at": "2018-02-12T15:44:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358680",
    "user": "https://github.com/rwst"
}
```

<div id="comment:31" align="right">Comment 31</div>

So we need more info, no?



---

archive/issue_events_310919.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2018-02-12T15:44:47Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23648#event-310919"
}
```



---

archive/issue_events_310920.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2018-02-12T15:44:47Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23648#event-310920"
}
```



---

archive/issue_comments_358681.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">Comment 32</div>\n\nNo, no need for more info. Maybe I was not clear enough.\n\nUsing an ipython shell, I can do exactly what I did in the first part of the ticket description. And there is no longer any failure. So the problem has been fixed somewhere in one of the previous py3 tickets.\n\nBelieve me, one should close this one and concentrate on the many other py3 tickets..",
    "created_at": "2018-02-12T16:44:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358681",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:32" align="right">Comment 32</div>

No, no need for more info. Maybe I was not clear enough.

Using an ipython shell, I can do exactly what I did in the first part of the ticket description. And there is no longer any failure. So the problem has been fixed somewhere in one of the previous py3 tickets.

Believe me, one should close this one and concentrate on the many other py3 tickets..



---

archive/issue_events_310921.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-02-12T16:44:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23648#event-310921"
}
```



---

archive/issue_events_310922.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-02-12T16:44:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23648#event-310922"
}
```



---

archive/issue_events_310923.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2018-02-12T16:57:54Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23648#event-310923"
}
```



---

archive/issue_events_310924.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2018-02-12T16:57:54Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23648#event-310924"
}
```



---

archive/issue_events_310925.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-12T17:33:08Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23648#event-310925"
}
```



---

archive/issue_events_310926.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-12T17:33:08Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23648#event-310926"
}
```



---

archive/issue_comments_358682.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">Comment 34</div>\n\nIndeed, this is fixed now.",
    "created_at": "2018-02-12T17:33:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23648#issuecomment-358682",
    "user": "https://github.com/embray"
}
```

<div id="comment:34" align="right">Comment 34</div>

Indeed, this is fixed now.



---

archive/issue_events_310927.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-12T17:33:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23648",
    "label": "https://github.com/sagemath/sage/labels/worksforme",
    "label_color": "a6a6a6",
    "label_name": "worksforme",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23648#event-310927"
}
```
