# Issue 23097: Maxima leaves a ton of compiled lips DLLs from ECL in /tmp when running tests

archive/issues_022860.json:
```json
{
    "body": "I noticed a while ago that my `/tmp` directory was filling up often, and it seems to be that every time I run the Sage tests I'm left with ~650 temp DLLs generated by ECL totaling around 8 GB.  This is even with a fully successful test run.\n\nJust starting Maxima with `sage -maxima` causes three temp DLLs to be created, but they are properly deleted upon exiting.  Likewise, running commands in Sage with the `maxima` interface creates DLLs, but they are cleaned up when Sage exits.  It seems like maybe when running the test suite Maxima isn't always exited cleanly, and the temp files do not get tidied up.\n\n**Upstream report:** https://gitlab.com/embeddable-common-lisp/ecl/issues/388\n\nKeywords: windows cygwin ecl maxima\n\nBranch/Commit: 60b5d0f23b5cbb19780df784dcc8eee8a242e5bf\n\nUpstream: Reported upstream. Developers deny it's a bug.\n\nReviewer: Emmanuel Charpentier\n\nAuthor: Erik Bray\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/23097\n\n",
    "closed_at": "2017-07-26T22:13:54Z",
    "created_at": "2017-05-29T14:29:41Z",
    "labels": [
        "component: porting: cygwin",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "Maxima leaves a ton of compiled lips DLLs from ECL in /tmp when running tests",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23097",
    "user": "https://github.com/embray"
}
```
I noticed a while ago that my `/tmp` directory was filling up often, and it seems to be that every time I run the Sage tests I'm left with ~650 temp DLLs generated by ECL totaling around 8 GB.  This is even with a fully successful test run.

Just starting Maxima with `sage -maxima` causes three temp DLLs to be created, but they are properly deleted upon exiting.  Likewise, running commands in Sage with the `maxima` interface creates DLLs, but they are cleaned up when Sage exits.  It seems like maybe when running the test suite Maxima isn't always exited cleanly, and the temp files do not get tidied up.

**Upstream report:** https://gitlab.com/embeddable-common-lisp/ecl/issues/388

Keywords: windows cygwin ecl maxima

Branch/Commit: 60b5d0f23b5cbb19780df784dcc8eee8a242e5bf

Upstream: Reported upstream. Developers deny it's a bug.

Reviewer: Emmanuel Charpentier

Author: Erik Bray

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/23097





---

archive/issue_comments_340330.json:
```json
{
    "body": "Changing keywords from \"windows cygwin ecl\" to \"windows cygwin ecl maxima\".",
    "created_at": "2017-05-29T14:39:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23097#issuecomment-340330",
    "user": "https://github.com/embray"
}
```

Changing keywords from "windows cygwin ecl" to "windows cygwin ecl maxima".



---

archive/issue_comments_340331.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,8 +1,6 @@\n I noticed a while ago that my `/tmp` directory was filling up often, and it seems to be that every time I run the Sage tests I'm left with ~650 temp DLLs generated by ECL totaling around 8 GB.  This is even with a fully successful test run.\n \n-Not sure exactly what invokes the creation of these DLLs or why there are so many and not being deleted, but presumably this isn't just limited to the test suite.\n-\n-Keywords: windows cygwin ecl\n+Not sure exactly what invokes the creation of these DLLs except that they are created when running certain commands in Maxima.  Not sure why they aren't being deleted either.\n \n Comment: 1\n \n```\n",
    "created_at": "2017-05-29T14:48:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23097#issuecomment-340331",
    "user": "https://github.com/embray"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,8 +1,6 @@
 I noticed a while ago that my `/tmp` directory was filling up often, and it seems to be that every time I run the Sage tests I'm left with ~650 temp DLLs generated by ECL totaling around 8 GB.  This is even with a fully successful test run.
 
-Not sure exactly what invokes the creation of these DLLs or why there are so many and not being deleted, but presumably this isn't just limited to the test suite.
-
-Keywords: windows cygwin ecl
+Not sure exactly what invokes the creation of these DLLs except that they are created when running certain commands in Maxima.  Not sure why they aren't being deleted either.
 
 Comment: 1
 
```




---

archive/issue_comments_340332.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,6 @@\n+I noticed a while ago that my `/tmp` directory was filling up often, and it seems to be that every time I run the Sage tests I'm left with ~650 temp DLLs generated by ECL totaling around 8 GB.  This is even with a fully successful test run.\n \n+Just starting Maxima with `sage -maxima` causes three temp DLLs to be created, but they are properly deleted upon exiting.  Likewise, running commands in Sage with the `maxima` interface creates DLLs, but they are cleaned up when Sage exits.  It seems like maybe when running the test suite Maxima isn't always exited cleanly, and the temp files do not get tidied up.\n \n Comment: 1\n \n```\n",
    "created_at": "2017-05-29T15:00:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23097#issuecomment-340332",
    "user": "https://github.com/embray"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,6 @@
+I noticed a while ago that my `/tmp` directory was filling up often, and it seems to be that every time I run the Sage tests I'm left with ~650 temp DLLs generated by ECL totaling around 8 GB.  This is even with a fully successful test run.
 
+Just starting Maxima with `sage -maxima` causes three temp DLLs to be created, but they are properly deleted upon exiting.  Likewise, running commands in Sage with the `maxima` interface creates DLLs, but they are cleaned up when Sage exits.  It seems like maybe when running the test suite Maxima isn't always exited cleanly, and the temp files do not get tidied up.
 
 Comment: 1
 
```




---

archive/issue_comments_340333.json:
```json
{
    "body": "<a id='comment:4'></a>I see--these temp files get created by ECL on !Windows/Cygwin when loading a compiled module and force_reload feature is enabled.  In order for this to work on Windows a copy of the module needs to be made and loaded, since Windows does not allow loading the same DLL more than once in the same process.  ECL takes care to clean this up during proper shutdown with an `atexit()` handler, but if the test suite is just killing processes that may prevent the handler from being run.",
    "created_at": "2017-05-29T15:38:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23097#issuecomment-340333",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>I see--these temp files get created by ECL on !Windows/Cygwin when loading a compiled module and force_reload feature is enabled.  In order for this to work on Windows a copy of the module needs to be made and loaded, since Windows does not allow loading the same DLL more than once in the same process.  ECL takes care to clean this up during proper shutdown with an `atexit()` handler, but if the test suite is just killing processes that may prevent the handler from being run.



---

archive/issue_comments_340334.json:
```json
{
    "body": "<a id='comment:5'></a>I'm trying to decide what would be best to do about this.  There are a few possibilities, none of which are ideal:\n\na) Patch ECL so that it handles more exit signals (SIGTERM, SIGHUP, etc.) to shut down cleanly / delete temp files.  This won't help for SIGKILL, but in most cases (during the tests) I think the maxima processes are just being SIGTERM'd (but this needs to be confirmed).  So that would fix most issues.  Actually, this should probably be done regardless--there's no reason ECL couldn't shutdown more cleanly on signals.\n\nb) Do the cleanup from Sage.  This has the advantage that it can even handle an unclean shutdown of ECL.  The only problem is I don't see an obvious way to get a list of temp files created by a given ECL process.  If there is only one ECL, no problem.  But it shouldn't clean up temp files used by another ECL.  Granted, for the limited case on Windows, which is the only place this applies, trying to delete temp DLLs still in use by a process should fail, so it might work just to clean all `ecl*.dll` from `/tmp`...",
    "created_at": "2017-06-01T14:25:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23097#issuecomment-340334",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>I'm trying to decide what would be best to do about this.  There are a few possibilities, none of which are ideal:

a) Patch ECL so that it handles more exit signals (SIGTERM, SIGHUP, etc.) to shut down cleanly / delete temp files.  This won't help for SIGKILL, but in most cases (during the tests) I think the maxima processes are just being SIGTERM'd (but this needs to be confirmed).  So that would fix most issues.  Actually, this should probably be done regardless--there's no reason ECL couldn't shutdown more cleanly on signals.

b) Do the cleanup from Sage.  This has the advantage that it can even handle an unclean shutdown of ECL.  The only problem is I don't see an obvious way to get a list of temp files created by a given ECL process.  If there is only one ECL, no problem.  But it shouldn't clean up temp files used by another ECL.  Granted, for the limited case on Windows, which is the only place this applies, trying to delete temp DLLs still in use by a process should fail, so it might work just to clean all `ecl*.dll` from `/tmp`...



---

archive/issue_comments_340335.json:
```json
{
    "body": "<a id='comment:6'></a>Reported upstream to ECL since I feel this should be fixed there.  Haven't attempted a fix myself yet.",
    "created_at": "2017-06-09T08:32:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23097#issuecomment-340335",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>Reported upstream to ECL since I feel this should be fixed there.  Haven't attempted a fix myself yet.



---

archive/issue_comments_340336.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,8 @@\n+I noticed a while ago that my `/tmp` directory was filling up often, and it seems to be that every time I run the Sage tests I'm left with ~650 temp DLLs generated by ECL totaling around 8 GB.  This is even with a fully successful test run.\n \n+Just starting Maxima with `sage -maxima` causes three temp DLLs to be created, but they are properly deleted upon exiting.  Likewise, running commands in Sage with the `maxima` interface creates DLLs, but they are cleaned up when Sage exits.  It seems like maybe when running the test suite Maxima isn't always exited cleanly, and the temp files do not get tidied up.\n+\n+**Upstream report:** https://gitlab.com/embeddable-common-lisp/ecl/issues/388\n \n Comment: 1\n \n```\n",
    "created_at": "2017-06-09T08:32:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23097#issuecomment-340336",
    "user": "https://github.com/embray"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,8 @@
+I noticed a while ago that my `/tmp` directory was filling up often, and it seems to be that every time I run the Sage tests I'm left with ~650 temp DLLs generated by ECL totaling around 8 GB.  This is even with a fully successful test run.
 
+Just starting Maxima with `sage -maxima` causes three temp DLLs to be created, but they are properly deleted upon exiting.  Likewise, running commands in Sage with the `maxima` interface creates DLLs, but they are cleaned up when Sage exits.  It seems like maybe when running the test suite Maxima isn't always exited cleanly, and the temp files do not get tidied up.
+
+**Upstream report:** https://gitlab.com/embeddable-common-lisp/ecl/issues/388
 
 Comment: 1
 
```




---

archive/issue_comments_340337.json:
```json
{
    "body": "<a id='comment:8'></a>I haven't attempted to patch ECL for this yet; its signal handling code is a bit complex and I think I need to understand it better before doing so.\n\nHowever, this provides a workaround that I think is worth having with or without a patch to ECL for this: This ensures that when ECL and/or Maxima are called from Sage, rather than writing temp files to `/tmp` it uses `SAGE_TMP`.  This way an individual Sage session can take responsibility for cleaning up any temp files created by ECL/Maxima processes it spawns (or that it creates through the `sage.libs.ecl` interface).\n\nAs far as I'm concerned this solves the problem from Sage's end.\n\n---\nNew commits:",
    "created_at": "2017-06-19T15:54:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23097#issuecomment-340337",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>I haven't attempted to patch ECL for this yet; its signal handling code is a bit complex and I think I need to understand it better before doing so.

However, this provides a workaround that I think is worth having with or without a patch to ECL for this: This ensures that when ECL and/or Maxima are called from Sage, rather than writing temp files to `/tmp` it uses `SAGE_TMP`.  This way an individual Sage session can take responsibility for cleaning up any temp files created by ECL/Maxima processes it spawns (or that it creates through the `sage.libs.ecl` interface).

As far as I'm concerned this solves the problem from Sage's end.

---
New commits:



---

archive/issue_comments_340338.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-06-19T15:54:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23097#issuecomment-340338",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_340339.json:
```json
{
    "body": "<a id='comment:10'></a>Reviewers set to Emmanuel Charpentier (revert)\n    Status changed from needs_review to positive_review\n\nOn a Virtulbox running Windows10 professional, I compiled 8.0.rc0 + #21399 + #23359 (as suggested in \u200bthe Wiki) + #21233 + #23097 (present ticket) with the options :\n\nexport PREREQ_OPTIONS=--with-blas=atlas\nexport SAGE_ATLAS_LIB=/usr/lib\nexport MAKE=\"make -j4\"\n\nThis passes ptestlong with no failures.\n\n==> positive_review\n\nNote : I have no advice on the contents of the patches (I do not know Cygwin well enough to undetstand what they are supposed to do) ; I just checked that this leads to a functional Sage.",
    "created_at": "2017-07-01T06:03:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23097#issuecomment-340339",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:10'></a>Reviewers set to Emmanuel Charpentier (revert)
    Status changed from needs_review to positive_review

On a Virtulbox running Windows10 professional, I compiled 8.0.rc0 + #21399 + #23359 (as suggested in ​the Wiki) + #21233 + #23097 (present ticket) with the options :

export PREREQ_OPTIONS=--with-blas=atlas
export SAGE_ATLAS_LIB=/usr/lib
export MAKE="make -j4"

This passes ptestlong with no failures.

==> positive_review

Note : I have no advice on the contents of the patches (I do not know Cygwin well enough to undetstand what they are supposed to do) ; I just checked that this leads to a functional Sage.



---

archive/issue_comments_340340.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-07-01T06:03:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23097#issuecomment-340340",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_340341.json:
```json
{
    "body": "<a id='comment:11'></a>For what it's worth, the ECL developers decided this is a \"wontfix\" after all.  I'm not entirely sure I agree but not gonna fight them on it.",
    "created_at": "2017-07-03T11:48:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23097#issuecomment-340341",
    "user": "https://github.com/embray"
}
```

<a id='comment:11'></a>For what it's worth, the ECL developers decided this is a "wontfix" after all.  I'm not entirely sure I agree but not gonna fight them on it.



---

archive/issue_comments_340342.json:
```json
{
    "body": "<a id='comment:12'></a>milestone ?",
    "created_at": "2017-07-10T12:39:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23097#issuecomment-340342",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:12'></a>milestone ?



---

archive/issue_events_059754.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-07-10T14:38:32Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23097",
    "milestone": "sage-8.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23097#event-59754"
}
```



---

archive/issue_comments_340343.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2017-07-10T14:39:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23097#issuecomment-340343",
    "user": "https://github.com/embray"
}
```

Changing priority from major to critical.



---

archive/issue_comments_340344.json:
```json
{
    "body": "<a id='comment:14'></a>Not sure why the milestone was missing from this.  This is actually pretty critical to have :/",
    "created_at": "2017-07-10T14:39:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23097#issuecomment-340344",
    "user": "https://github.com/embray"
}
```

<a id='comment:14'></a>Not sure why the milestone was missing from this.  This is actually pretty critical to have :/



---

archive/issue_comments_340345.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-07-26T22:13:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23097#issuecomment-340345",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_059755.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-07-26T22:13:54Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23097",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23097#event-59755"
}
```
