# Issue 23876: Starting sage with python3: crash handler cannot return the source of the crash

archive/issues_023639.json:
```json
{
    "body": "because the function that is supposed to provide the information is itself crashing.\n\nWhen starting sage with python3.6, sage crashes immediately. The crash report ends up with\n\n```\n/usr/lib64/python3.6/site-packages/sage/misc/sageinspect.py in _extract_embedded_signature(docstring=b'\\n        Construct a new object of this class...  # indirect doctest\\n            True\\n        ', name='__classcall__')\n    245 \n    246     EXAMPLES::\n    247 \n    248         sage: from sage.misc.sageinspect import _extract_embedded_signature\n    249         sage: from sage.misc.nested_class import MainClass\n    250         sage: print(_extract_embedded_signature(MainClass.NestedClass.NestedSubClass.dummy.__doc__, 'dummy')[0])\n    251         File: sage/misc/nested_class.pyx (starting at line 314)\n    252         ...\n    253         sage: _extract_embedded_signature(MainClass.NestedClass.NestedSubClass.dummy.__doc__, 'dummy')[1]\n    254         ArgSpec(args=['self', 'x', 'r'], varargs='args', keywords='kwds', defaults=((1, 2, 3.4),))\n    255         sage: _extract_embedded_signature(range.__call__.__doc__, '__call__')\n    256         ('x.__call__(...) <==> x(...)', None)\n    257 \n    258     \"\"\"\n    259     # If there is an embedded signature, it is in the first line\n--> 260     L = docstring.split(os.linesep, 1)\n        L = undefined\n        docstring.split = <built-in method split of bytes object at 0x7fb5a40c9800>\n        global os.linesep = '\\n'\n    261     firstline = L[0]\n    262     # It is possible that the signature is of the form ClassName.method_name,\n    263     # and thus we need to do the following:\n    264     if name not in firstline:\n    265         return docstring, None\n    266     signature = firstline.split(name, 1)[-1]\n    267     if signature.startswith(\"(\") and signature.endswith(\")\"):\n    268         docstring = L[1] if len(L)>1 else '' # Remove first line, keep the rest\n    269         def_string = \"def \"+name+signature+\": pass\"\n    270         try:\n    271             return docstring, inspect.ArgSpec(*_sage_getargspec_cython(def_string))\n    272         except SyntaxError:\n    273             docstring = os.linesep.join(L)\n    274     return docstring, None\n    275 \n\nTypeError: a bytes-like object is required, not 'str'\n```\nThis is not the source of the crash. But the function supposed to provide information on the origin of the crash is itself crashing because `docstring` is of type `str` when `bytes` is required.\n\nThe code is in `_sage_getdoc_unformatted` (`docstring` is the return value of this function)\n\n```\n    # Check if the __doc__ attribute was actually a string, and\n    # not a 'getset_descriptor' or similar.\n    if not isinstance(r, string_types):\n        return ''\n    elif isinstance(r, unicode):\n        return r.encode('utf-8', 'ignore')\n    else:\n        return r\n```\nFor things to work properly I currently invert the last two returns call. It is probably sub-optimal. But after that operation the crash report works and give us the real reason sage crashed in the first place.\n\nCC:  @fchapoton\n\nBranch/Commit: 7076e8d9274aec7e8bd677200419cc81e57e2839\n\nReviewer: Jeroen Demeyer\n\nAuthor: Fran\u00e7ois Bissey\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/23876\n\n",
    "closed_at": "2017-09-20T22:26:05Z",
    "created_at": "2017-09-17T22:18:27Z",
    "labels": [
        "component: python3",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Starting sage with python3: crash handler cannot return the source of the crash",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23876",
    "user": "https://github.com/kiwifb"
}
```
because the function that is supposed to provide the information is itself crashing.

When starting sage with python3.6, sage crashes immediately. The crash report ends up with

```
/usr/lib64/python3.6/site-packages/sage/misc/sageinspect.py in _extract_embedded_signature(docstring=b'\n        Construct a new object of this class...  # indirect doctest\n            True\n        ', name='__classcall__')
    245 
    246     EXAMPLES::
    247 
    248         sage: from sage.misc.sageinspect import _extract_embedded_signature
    249         sage: from sage.misc.nested_class import MainClass
    250         sage: print(_extract_embedded_signature(MainClass.NestedClass.NestedSubClass.dummy.__doc__, 'dummy')[0])
    251         File: sage/misc/nested_class.pyx (starting at line 314)
    252         ...
    253         sage: _extract_embedded_signature(MainClass.NestedClass.NestedSubClass.dummy.__doc__, 'dummy')[1]
    254         ArgSpec(args=['self', 'x', 'r'], varargs='args', keywords='kwds', defaults=((1, 2, 3.4),))
    255         sage: _extract_embedded_signature(range.__call__.__doc__, '__call__')
    256         ('x.__call__(...) <==> x(...)', None)
    257 
    258     """
    259     # If there is an embedded signature, it is in the first line
--> 260     L = docstring.split(os.linesep, 1)
        L = undefined
        docstring.split = <built-in method split of bytes object at 0x7fb5a40c9800>
        global os.linesep = '\n'
    261     firstline = L[0]
    262     # It is possible that the signature is of the form ClassName.method_name,
    263     # and thus we need to do the following:
    264     if name not in firstline:
    265         return docstring, None
    266     signature = firstline.split(name, 1)[-1]
    267     if signature.startswith("(") and signature.endswith(")"):
    268         docstring = L[1] if len(L)>1 else '' # Remove first line, keep the rest
    269         def_string = "def "+name+signature+": pass"
    270         try:
    271             return docstring, inspect.ArgSpec(*_sage_getargspec_cython(def_string))
    272         except SyntaxError:
    273             docstring = os.linesep.join(L)
    274     return docstring, None
    275 

TypeError: a bytes-like object is required, not 'str'
```
This is not the source of the crash. But the function supposed to provide information on the origin of the crash is itself crashing because `docstring` is of type `str` when `bytes` is required.

The code is in `_sage_getdoc_unformatted` (`docstring` is the return value of this function)

```
    # Check if the __doc__ attribute was actually a string, and
    # not a 'getset_descriptor' or similar.
    if not isinstance(r, string_types):
        return ''
    elif isinstance(r, unicode):
        return r.encode('utf-8', 'ignore')
    else:
        return r
```
For things to work properly I currently invert the last two returns call. It is probably sub-optimal. But after that operation the crash report works and give us the real reason sage crashed in the first place.

CC:  @fchapoton

Branch/Commit: 7076e8d9274aec7e8bd677200419cc81e57e2839

Reviewer: Jeroen Demeyer

Author: François Bissey

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/23876





---

archive/issue_comments_450634.json:
```json
{
    "body": "Changing commit from \"\" to \"64b3533ba608f8be4270c2c73942699edd82bba6\"",
    "created_at": "2017-09-17T22:22:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450634",
    "user": "https://github.com/kiwifb"
}
```

Changing commit from "" to "64b3533ba608f8be4270c2c73942699edd82bba6"



---

archive/issue_comments_450635.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-09-17T22:22:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450635",
    "user": "https://github.com/kiwifb"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_450636.json:
```json
{
    "body": "<a id='comment:1'></a>\nFor information once you fix this, the real crash is \n\n```\n/usr/lib64/python3.6/site-packages/sage/categories/finite_enumerated_sets.py in ParentMethods()\n    606                 sage: C in EnumeratedSets().Finite()\n    607                 True\n    608 \n    609                 sage: C.random_element.__module__\n    610                 'sage.categories.sets_cat'\n    611 \n    612                 sage: C.cardinality.__module__\n    613                 'sage.categories.sets_cat'\n    614 \n    615                 sage: C.__iter__.__module__\n    616                 'sage.categories.sets_cat'\n    617             \"\"\"\n    618 \n    619             # Ambiguity resolution between methods inherited from\n    620             # Sets.CartesianProducts and from EnumeratedSets.Finite.\n--> 621             random_element = Sets.CartesianProducts.ParentMethods.random_element.__func__\n        global random_element = undefined\n        global Sets.CartesianProducts.ParentMethods.random_element.__func__ = undefined\n    622             cardinality = Sets.CartesianProducts.ParentMethods.cardinality.__func__\n    623             __iter__ = Sets.CartesianProducts.ParentMethods.__iter__.__func__\n    624 \n    625             def last(self):\n    626                 r\"\"\"\n    627                 Return the last element\n    628 \n    629                 EXAMPLES::\n    630 \n    631                     sage: C = cartesian_product([Zmod(42), Partitions(10), IntegerRange(5)])\n    632                     sage: C.last()\n    633                     (41, [1, 1, 1, 1, 1, 1, 1, 1, 1, 1], 4)\n    634                 \"\"\"\n    635                 return self._cartesian_product_of_elements(\n    636                         tuple(c.last() for c in self.cartesian_factors()))\n\nAttributeError: 'function' object has no attribute '__func__'\n```\n\n---\nNew commits:\n|                                                                                                                                          |                                                                               |\n|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------|\n|[64b3533](https://git.sagemath.org/sage.git/commit?id=64b3533ba608f8be4270c2c73942699edd82bba6)|`Make the returned value of _sage_getdoc_unformatted a bytes object in python3`|",
    "created_at": "2017-09-17T22:22:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450636",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:1'></a>
For information once you fix this, the real crash is 

```
/usr/lib64/python3.6/site-packages/sage/categories/finite_enumerated_sets.py in ParentMethods()
    606                 sage: C in EnumeratedSets().Finite()
    607                 True
    608 
    609                 sage: C.random_element.__module__
    610                 'sage.categories.sets_cat'
    611 
    612                 sage: C.cardinality.__module__
    613                 'sage.categories.sets_cat'
    614 
    615                 sage: C.__iter__.__module__
    616                 'sage.categories.sets_cat'
    617             """
    618 
    619             # Ambiguity resolution between methods inherited from
    620             # Sets.CartesianProducts and from EnumeratedSets.Finite.
--> 621             random_element = Sets.CartesianProducts.ParentMethods.random_element.__func__
        global random_element = undefined
        global Sets.CartesianProducts.ParentMethods.random_element.__func__ = undefined
    622             cardinality = Sets.CartesianProducts.ParentMethods.cardinality.__func__
    623             __iter__ = Sets.CartesianProducts.ParentMethods.__iter__.__func__
    624 
    625             def last(self):
    626                 r"""
    627                 Return the last element
    628 
    629                 EXAMPLES::
    630 
    631                     sage: C = cartesian_product([Zmod(42), Partitions(10), IntegerRange(5)])
    632                     sage: C.last()
    633                     (41, [1, 1, 1, 1, 1, 1, 1, 1, 1, 1], 4)
    634                 """
    635                 return self._cartesian_product_of_elements(
    636                         tuple(c.last() for c in self.cartesian_factors()))

AttributeError: 'function' object has no attribute '__func__'
```

---
New commits:
|                                                                                                                                          |                                                                               |
|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------|
|[64b3533](https://git.sagemath.org/sage.git/commit?id=64b3533ba608f8be4270c2c73942699edd82bba6)|`Make the returned value of _sage_getdoc_unformatted a bytes object in python3`|



---

archive/issue_comments_450637.json:
```json
{
    "body": "Changing branch from \"\" to \"u/fbissey/python3_crash\"",
    "created_at": "2017-09-17T22:22:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450637",
    "user": "https://github.com/kiwifb"
}
```

Changing branch from "" to "u/fbissey/python3_crash"



---

archive/issue_comments_450638.json:
```json
{
    "body": "Changing author from \"\" to \"Fran\u00e7ois Bissey\"",
    "created_at": "2017-09-17T22:22:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450638",
    "user": "https://github.com/kiwifb"
}
```

Changing author from "" to "François Bissey"



---

archive/issue_comments_450639.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-09-18T00:15:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450639",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_450640.json:
```json
{
    "body": "<a id='comment:2'></a>\nOK, the patch makes building the documentation fail with python2.7 so it will have to be more subtle than that.",
    "created_at": "2017-09-18T00:15:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450640",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:2'></a>
OK, the patch makes building the documentation fail with python2.7 so it will have to be more subtle than that.



---

archive/issue_comments_450641.json:
```json
{
    "body": "<a id='comment:3'></a>\nTo get the Sage library to build at all, I need to make this change:\n\n```diff\ndiff --git a/src/sage/misc/package.py b/src/sage/misc/package.py\nindex a3c3e923f6..fd58ddab29 100644\n--- a/src/sage/misc/package.py\n+++ b/src/sage/misc/package.py\n@@ -144,7 +144,7 @@ def pip_installed_packages():\n         '...'\n     \"\"\"\n     proc = subprocess.Popen([\"pip\", \"list\", \"--no-index\", \"--format\", \"json\"], stdout=subprocess.PIPE)\n-    stdout = str(proc.communicate()[0])\n+    stdout = proc.communicate()[0]\n     return {package['name'].lower():package['version'] for package in json.loads(stdout)}\n \n def list_packages(*pkg_types, **opts):\n```\nWhat else do I need to do to get to your stage? Do you have an experimental Python 3 branch?",
    "created_at": "2017-09-18T01:08:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450641",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:3'></a>
To get the Sage library to build at all, I need to make this change:

```diff
diff --git a/src/sage/misc/package.py b/src/sage/misc/package.py
index a3c3e923f6..fd58ddab29 100644
--- a/src/sage/misc/package.py
+++ b/src/sage/misc/package.py
@@ -144,7 +144,7 @@ def pip_installed_packages():
         '...'
     """
     proc = subprocess.Popen(["pip", "list", "--no-index", "--format", "json"], stdout=subprocess.PIPE)
-    stdout = str(proc.communicate()[0])
+    stdout = proc.communicate()[0]
     return {package['name'].lower():package['version'] for package in json.loads(stdout)}
 
 def list_packages(*pkg_types, **opts):
```
What else do I need to do to get to your stage? Do you have an experimental Python 3 branch?



---

archive/issue_comments_450642.json:
```json
{
    "body": "<a id='comment:4'></a>\nI don't understand half the problems you have building with python3. sage-on-gentoo just builds out of the box with python3.6. That being said your problem is with `package.py` which in sage-on-gentoo I replace with a shorter version https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage/files/sage-7.3-package.py this is because from the point of view of sage-on-gentoo the sage \"library\" has no business in package management and what's left is solely to make patching minimal in other areas of the sage code.\n\nI do not mess anything just to get python3 to build (apart from pynac for side by side python install), if there is something helping that's just a side effect.\n\nI guess you have the same kind of issue python3 must expect stdout to be bytes when in python2 it was made a nice string.",
    "created_at": "2017-09-18T01:19:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450642",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:4'></a>
I don't understand half the problems you have building with python3. sage-on-gentoo just builds out of the box with python3.6. That being said your problem is with `package.py` which in sage-on-gentoo I replace with a shorter version https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage/files/sage-7.3-package.py this is because from the point of view of sage-on-gentoo the sage "library" has no business in package management and what's left is solely to make patching minimal in other areas of the sage code.

I do not mess anything just to get python3 to build (apart from pynac for side by side python install), if there is something helping that's just a side effect.

I guess you have the same kind of issue python3 must expect stdout to be bytes when in python2 it was made a nice string.



---

archive/issue_comments_450643.json:
```json
{
    "body": "<a id='comment:5'></a>\nI am just finishing a build of sage-on-gentoo with both python2.7 and 3.6 - documentation build with 2.7 using this patch instead of what's in the branch\n\n```diff\ndiff --git a/src/sage/misc/sageinspect.py b/src/sage/misc/sageinspect.py\nindex f9dffc1ce3..d6013851fc 100644\n--- a/src/sage/misc/sageinspect.py\n+++ b/src/sage/misc/sageinspect.py\n@@ -1636,8 +1636,6 @@ def _sage_getdoc_unformatted(obj):\n     # not a 'getset_descriptor' or similar.\n     if not isinstance(r, string_types):\n         return ''\n-    elif isinstance(r, text_type):  # unicode (py2) = str (py3)\n-        return r.encode('utf-8', 'ignore')\n     else:\n         return r\n \n```\nI'll see if it survives doctesting in a couple of minutes.",
    "created_at": "2017-09-18T01:25:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450643",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:5'></a>
I am just finishing a build of sage-on-gentoo with both python2.7 and 3.6 - documentation build with 2.7 using this patch instead of what's in the branch

```diff
diff --git a/src/sage/misc/sageinspect.py b/src/sage/misc/sageinspect.py
index f9dffc1ce3..d6013851fc 100644
--- a/src/sage/misc/sageinspect.py
+++ b/src/sage/misc/sageinspect.py
@@ -1636,8 +1636,6 @@ def _sage_getdoc_unformatted(obj):
     # not a 'getset_descriptor' or similar.
     if not isinstance(r, string_types):
         return ''
-    elif isinstance(r, text_type):  # unicode (py2) = str (py3)
-        return r.encode('utf-8', 'ignore')
     else:
         return r
 
```
I'll see if it survives doctesting in a couple of minutes.



---

archive/issue_comments_450644.json:
```json
{
    "body": "Changing commit from \"64b3533ba608f8be4270c2c73942699edd82bba6\" to \"b75a0ec5a123558bf4ad00087d02b189d923e3e6\"",
    "created_at": "2017-09-18T01:30:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450644",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "64b3533ba608f8be4270c2c73942699edd82bba6" to "b75a0ec5a123558bf4ad00087d02b189d923e3e6"



---

archive/issue_comments_450645.json:
```json
{
    "body": "<a id='comment:6'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                               |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------|\n|[b75a0ec](https://git.sagemath.org/sage.git/commit/?id=b75a0ec5a123558bf4ad00087d02b189d923e3e6)|`simplify patch and the result allow documentation to be built`|",
    "created_at": "2017-09-18T01:30:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450645",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                               |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------|
|[b75a0ec](https://git.sagemath.org/sage.git/commit/?id=b75a0ec5a123558bf4ad00087d02b189d923e3e6)|`simplify patch and the result allow documentation to be built`|



---

archive/issue_comments_450646.json:
```json
{
    "body": "<a id='comment:7'></a>\nSurvived doctesting with python2.7 so I pushed. I am fairly sure that's the only place `text_type` is used in the file so further edits should probably be done.",
    "created_at": "2017-09-18T01:33:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450646",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:7'></a>
Survived doctesting with python2.7 so I pushed. I am fairly sure that's the only place `text_type` is used in the file so further edits should probably be done.



---

archive/issue_comments_450647.json:
```json
{
    "body": "<a id='comment:8'></a>\nI would prefer to replace\n\n```\nelif isinstance(r, text_type):\n```\nby\n\n```\nelif not isinstance(r, str):\n```\n\nI think that would work on Python 3 and the functionality would remain exactly the same on Python 2 since we already know at that point that it's either `str` or `unicode`.",
    "created_at": "2017-09-18T08:56:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450647",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>
I would prefer to replace

```
elif isinstance(r, text_type):
```
by

```
elif not isinstance(r, str):
```

I think that would work on Python 3 and the functionality would remain exactly the same on Python 2 since we already know at that point that it's either `str` or `unicode`.



---

archive/issue_comments_450648.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Jeroen Demeyer\"",
    "created_at": "2017-09-18T08:56:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450648",
    "user": "https://github.com/jdemeyer"
}
```

Changing reviewer from "" to "Jeroen Demeyer"



---

archive/issue_comments_450649.json:
```json
{
    "body": "<a id='comment:10'></a>\nOk Jeroen, it does work at runtime with python3. Doing a full build to see if work as intended with python2 including building documentation.",
    "created_at": "2017-09-18T09:19:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450649",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:10'></a>
Ok Jeroen, it does work at runtime with python3. Doing a full build to see if work as intended with python2 including building documentation.



---

archive/issue_comments_450650.json:
```json
{
    "body": "<a id='comment:11'></a>\nLooks like it does the job for both python2 and python3 so I made a clean branch.\n\n---\nNew commits:\n|                                                                                                                                          |                                                                                         |\n|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------|\n|[0886c6b](https://git.sagemath.org/sage.git/commit?id=0886c6be0f5617ed11ce58c749ae0e6e679b05b3)|`Change test in _sage_getdoc_unformatted so that a bytes object is returned with python3`|",
    "created_at": "2017-09-18T10:35:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450650",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:11'></a>
Looks like it does the job for both python2 and python3 so I made a clean branch.

---
New commits:
|                                                                                                                                          |                                                                                         |
|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------|
|[0886c6b](https://git.sagemath.org/sage.git/commit?id=0886c6be0f5617ed11ce58c749ae0e6e679b05b3)|`Change test in _sage_getdoc_unformatted so that a bytes object is returned with python3`|



---

archive/issue_comments_450651.json:
```json
{
    "body": "Changing commit from \"b75a0ec5a123558bf4ad00087d02b189d923e3e6\" to \"0886c6be0f5617ed11ce58c749ae0e6e679b05b3\"",
    "created_at": "2017-09-18T10:35:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450651",
    "user": "https://github.com/kiwifb"
}
```

Changing commit from "b75a0ec5a123558bf4ad00087d02b189d923e3e6" to "0886c6be0f5617ed11ce58c749ae0e6e679b05b3"



---

archive/issue_comments_450652.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-09-18T10:35:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450652",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_450653.json:
```json
{
    "body": "Changing branch from \"u/fbissey/python3_crash\" to \"u/fbissey/23876v2\"",
    "created_at": "2017-09-18T10:35:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450653",
    "user": "https://github.com/kiwifb"
}
```

Changing branch from "u/fbissey/python3_crash" to "u/fbissey/23876v2"



---

archive/issue_comments_450654.json:
```json
{
    "body": "<a id='comment:12'></a>\nThe comment `# unicode (py2) = str (py3)` no longer makes sense. Maybe write `# On Python 2, we want str, not unicode`.\n\nIf the comment is fixed and `make doc-clean && make ptestlong` passes, this can be set to positive_review.",
    "created_at": "2017-09-18T10:41:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450654",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>
The comment `# unicode (py2) = str (py3)` no longer makes sense. Maybe write `# On Python 2, we want str, not unicode`.

If the comment is fixed and `make doc-clean && make ptestlong` passes, this can be set to positive_review.



---

archive/issue_comments_450655.json:
```json
{
    "body": "<a id='comment:13'></a>\nAlthough... maybe the code could be restructured to be more clear:\n\n```\n    if isinstance(r, str):\n        return r\n    elif isinstance(r, text_type):\n        # On Python 2, we want str, not unicode\n        return r.encode('utf-8', 'ignore')\n    else:\n        # Not a string of any kind\n        return ''\n```",
    "created_at": "2017-09-18T10:44:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450655",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>
Although... maybe the code could be restructured to be more clear:

```
    if isinstance(r, str):
        return r
    elif isinstance(r, text_type):
        # On Python 2, we want str, not unicode
        return r.encode('utf-8', 'ignore')
    else:
        # Not a string of any kind
        return ''
```



---

archive/issue_comments_450656.json:
```json
{
    "body": "<a id='comment:14'></a>\nI'll give that a go in the morning, I agree it looks a bit better.",
    "created_at": "2017-09-18T10:46:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450656",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:14'></a>
I'll give that a go in the morning, I agree it looks a bit better.



---

archive/issue_comments_450657.json:
```json
{
    "body": "Changing branch from \"u/fbissey/23876v2\" to \"u/fbissey/python3_crash\"",
    "created_at": "2017-09-18T15:50:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450657",
    "user": "https://github.com/jhpalmieri"
}
```

Changing branch from "u/fbissey/23876v2" to "u/fbissey/python3_crash"



---

archive/issue_comments_450658.json:
```json
{
    "body": "<a id='comment:15'></a>\nMy problem in[comment:3](#comment%3A3) is being taken care of in #23822.",
    "created_at": "2017-09-18T15:50:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450658",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:15'></a>
My problem in[comment:3](#comment%3A3) is being taken care of in #23822.



---

archive/issue_comments_450659.json:
```json
{
    "body": "Changing commit from \"0886c6be0f5617ed11ce58c749ae0e6e679b05b3\" to \"b75a0ec5a123558bf4ad00087d02b189d923e3e6\"",
    "created_at": "2017-09-18T15:50:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450659",
    "user": "https://github.com/jhpalmieri"
}
```

Changing commit from "0886c6be0f5617ed11ce58c749ae0e6e679b05b3" to "b75a0ec5a123558bf4ad00087d02b189d923e3e6"



---

archive/issue_comments_450660.json:
```json
{
    "body": "Changing reviewer from \"Jeroen Demeyer\" to \"\"",
    "created_at": "2017-09-18T15:50:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450660",
    "user": "https://github.com/jhpalmieri"
}
```

Changing reviewer from "Jeroen Demeyer" to ""



---

archive/issue_comments_450661.json:
```json
{
    "body": "Changing commit from \"b75a0ec5a123558bf4ad00087d02b189d923e3e6\" to \"0886c6be0f5617ed11ce58c749ae0e6e679b05b3\"",
    "created_at": "2017-09-18T15:50:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450661",
    "user": "https://github.com/jhpalmieri"
}
```

Changing commit from "b75a0ec5a123558bf4ad00087d02b189d923e3e6" to "0886c6be0f5617ed11ce58c749ae0e6e679b05b3"



---

archive/issue_comments_450662.json:
```json
{
    "body": "Changing branch from \"u/fbissey/python3_crash\" to \"u/fbissey/23876v2\"",
    "created_at": "2017-09-18T15:50:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450662",
    "user": "https://github.com/jhpalmieri"
}
```

Changing branch from "u/fbissey/python3_crash" to "u/fbissey/23876v2"



---

archive/issue_comments_450663.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Jeroen Demeyer\"",
    "created_at": "2017-09-18T15:50:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450663",
    "user": "https://github.com/jhpalmieri"
}
```

Changing reviewer from "" to "Jeroen Demeyer"



---

archive/issue_comments_450664.json:
```json
{
    "body": "<a id='comment:17'></a>\n(Sorry, when I added my last comment, I messed up various other fields for this ticket: \"Reviewer\", \"Commit\", \"Branch\". I've tried to fix them.)",
    "created_at": "2017-09-18T17:18:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450664",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:17'></a>
(Sorry, when I added my last comment, I messed up various other fields for this ticket: "Reviewer", "Commit", "Branch". I've tried to fix them.)



---

archive/issue_comments_450665.json:
```json
{
    "body": "Changing commit from \"0886c6be0f5617ed11ce58c749ae0e6e679b05b3\" to \"7076e8d9274aec7e8bd677200419cc81e57e2839\"",
    "created_at": "2017-09-18T22:56:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450665",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "0886c6be0f5617ed11ce58c749ae0e6e679b05b3" to "7076e8d9274aec7e8bd677200419cc81e57e2839"



---

archive/issue_comments_450666.json:
```json
{
    "body": "<a id='comment:18'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                   |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------|\n|[7076e8d](https://git.sagemath.org/sage.git/commit/?id=7076e8d9274aec7e8bd677200419cc81e57e2839)|`Use Jeroen latest suggestion which is way clearer`|",
    "created_at": "2017-09-18T22:56:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450666",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                   |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------|
|[7076e8d](https://git.sagemath.org/sage.git/commit/?id=7076e8d9274aec7e8bd677200419cc81e57e2839)|`Use Jeroen latest suggestion which is way clearer`|



---

archive/issue_comments_450667.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-09-18T22:59:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450667",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_450668.json:
```json
{
    "body": "<a id='comment:19'></a>\nOk that works with python3 and pass `make doc-clean && make ptestlong` with python2. So this is ready to go.",
    "created_at": "2017-09-18T22:59:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450668",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:19'></a>
Ok that works with python3 and pass `make doc-clean && make ptestlong` with python2. So this is ready to go.



---

archive/issue_comments_450669.json:
```json
{
    "body": "<a id='comment:20'></a>\n+1",
    "created_at": "2017-09-19T08:29:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450669",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>
+1



---

archive/issue_comments_450670.json:
```json
{
    "body": "Changing branch from \"u/fbissey/23876v2\" to \"7076e8d9274aec7e8bd677200419cc81e57e2839\"",
    "created_at": "2017-09-20T22:26:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450670",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/fbissey/23876v2" to "7076e8d9274aec7e8bd677200419cc81e57e2839"



---

archive/issue_comments_450671.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-09-20T22:26:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23876#issuecomment-450671",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_060823.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-09-20T22:26:05Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23876",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23876#event-60823"
}
```
