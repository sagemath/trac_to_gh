# Issue 23179: Automatically wrap spkg-install scripts with boilerplate

archive/issues_022942.json:
```json
{
    "body": "I mentioned this idea in [this ticket](https://trac.sagemath.org/ticket/23160#comment:8), but to summarize the purpose of this is to make the `spkg-install` scripts (as well as `spkg-build` and `spkg-check` when they exist) not directly executable on their own outside of package build directories.  This is to prevent them from being accidentally executed in any other context.  Further, they are wrapped to source the `sage-env` script from the `$SAGE_ROOT` the package is being installed into.  So if one manually enters a package build directory and runs the `spkg-install` it will automatically ensure that the correct Sage environment is loaded.\n\nThis obviates the need for the guard boilerplate that checks for `$SAGE_LOCAL`, though it can't hurt to keep, in case `sage-env` itself is broken somehow.\n\nThis ticket changes a ton of files, so let me just summarize the changes briefly:\n\n* Modifies `sage-spkg` to write a wrapper containing the boilerplate around each `sage-build/install/check` script *after* it is copied into a package build directory.\n\n* For all existing `sage-build/install/check` scripts, the executable bit is removed from the copies in the source tree in `build/pkgs/`, and the shebang lines are removed.\n\n* For the handful of scripts that were written in Python, the `spkg-install` becomes just `exec sage-python23 sage-install.py`, where the original Python-based install script is moved to `sage-install.py`.\n\nI think it would be good to do something like this, but it's just an idea and not strictly required for any future work.\n\nCC:  @vbraun\n\nReviewer: Jeroen Demeyer\n\nAuthor: Erik Bray\n\nBranch: 9dfaeeb2dcec72608c7cb5eceaecdd554f508132\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/23179\n\n",
    "closed_at": "2017-08-01T22:25:12Z",
    "created_at": "2017-06-08T14:49:56Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Automatically wrap spkg-install scripts with boilerplate",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23179",
    "user": "https://github.com/embray"
}
```
I mentioned this idea in [this ticket](https://trac.sagemath.org/ticket/23160#comment:8), but to summarize the purpose of this is to make the `spkg-install` scripts (as well as `spkg-build` and `spkg-check` when they exist) not directly executable on their own outside of package build directories.  This is to prevent them from being accidentally executed in any other context.  Further, they are wrapped to source the `sage-env` script from the `$SAGE_ROOT` the package is being installed into.  So if one manually enters a package build directory and runs the `spkg-install` it will automatically ensure that the correct Sage environment is loaded.

This obviates the need for the guard boilerplate that checks for `$SAGE_LOCAL`, though it can't hurt to keep, in case `sage-env` itself is broken somehow.

This ticket changes a ton of files, so let me just summarize the changes briefly:

* Modifies `sage-spkg` to write a wrapper containing the boilerplate around each `sage-build/install/check` script *after* it is copied into a package build directory.

* For all existing `sage-build/install/check` scripts, the executable bit is removed from the copies in the source tree in `build/pkgs/`, and the shebang lines are removed.

* For the handful of scripts that were written in Python, the `spkg-install` becomes just `exec sage-python23 sage-install.py`, where the original Python-based install script is moved to `sage-install.py`.

I think it would be good to do something like this, but it's just an idea and not strictly required for any future work.

CC:  @vbraun

Reviewer: Jeroen Demeyer

Author: Erik Bray

Branch: 9dfaeeb2dcec72608c7cb5eceaecdd554f508132

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/23179





---

archive/issue_comments_429439.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-06-08T14:50:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429439",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_429440.json:
```json
{
    "body": "Changing commit from \"16a51f0dda366c0a66f7da6539cf88c830677d25\" to \"176356a43391a1d11e34eceac25627e6d01ce657\"",
    "created_at": "2017-06-08T14:51:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429440",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "16a51f0dda366c0a66f7da6539cf88c830677d25" to "176356a43391a1d11e34eceac25627e6d01ce657"



---

archive/issue_comments_429441.json:
```json
{
    "body": "<a id='comment:2'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                             |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------|\n|[176356a](https://github.com/sagemath/sagetrac-mirror/commit/176356a43391a1d11e34eceac25627e6d01ce657)|`Remove this check as it is no longer needed`|",
    "created_at": "2017-06-08T14:51:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429441",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                             |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------|
|[176356a](https://github.com/sagemath/sagetrac-mirror/commit/176356a43391a1d11e34eceac25627e6d01ce657)|`Remove this check as it is no longer needed`|



---

archive/issue_comments_429442.json:
```json
{
    "body": "<a id='comment:3'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                           |                                                     |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------|\n|[f39f099](https://github.com/sagemath/sagetrac-mirror/commit/f39f0999b4e6aeebecc480e18de17260ed52d2f6)|`Mark all spkg-build|install|check as not executable`|\n|[94d2626](https://github.com/sagemath/sagetrac-mirror/commit/94d2626f2a9c902b31bf7792a6f45eb36b5c9fd4)|`Create wrapper script around spkg-build, spkg-check, and spkg-install`|\n|[7a7424b](https://github.com/sagemath/sagetrac-mirror/commit/7a7424bfa649dbf538ebda17f58d32b6c90fee3a)|`In accordance with the new restrictions, strips shebank lines from all spkg-install, spkg-build, and spkg-check`|\n|[d30624b](https://github.com/sagemath/sagetrac-mirror/commit/d30624b03cc6f62087e0c3c9a820148d46b67616)|`Remove this check as it is no longer needed`|",
    "created_at": "2017-06-20T12:15:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429442",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                           |                                                     |
|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------|
|[f39f099](https://github.com/sagemath/sagetrac-mirror/commit/f39f0999b4e6aeebecc480e18de17260ed52d2f6)|`Mark all spkg-build|install|check as not executable`|
|[94d2626](https://github.com/sagemath/sagetrac-mirror/commit/94d2626f2a9c902b31bf7792a6f45eb36b5c9fd4)|`Create wrapper script around spkg-build, spkg-check, and spkg-install`|
|[7a7424b](https://github.com/sagemath/sagetrac-mirror/commit/7a7424bfa649dbf538ebda17f58d32b6c90fee3a)|`In accordance with the new restrictions, strips shebank lines from all spkg-install, spkg-build, and spkg-check`|
|[d30624b](https://github.com/sagemath/sagetrac-mirror/commit/d30624b03cc6f62087e0c3c9a820148d46b67616)|`Remove this check as it is no longer needed`|



---

archive/issue_comments_429443.json:
```json
{
    "body": "Changing commit from \"176356a43391a1d11e34eceac25627e6d01ce657\" to \"d30624b03cc6f62087e0c3c9a820148d46b67616\"",
    "created_at": "2017-06-20T12:15:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429443",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "176356a43391a1d11e34eceac25627e6d01ce657" to "d30624b03cc6f62087e0c3c9a820148d46b67616"



---

archive/issue_comments_429444.json:
```json
{
    "body": "<a id='comment:4'></a>\nRebased.",
    "created_at": "2017-06-20T12:16:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429444",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>
Rebased.



---

archive/issue_comments_429445.json:
```json
{
    "body": "<a id='comment:5'></a>\nI don't really like this idea.\n\n1. Having those scripts executable can be useful for debugging.\n\n2. I would still want to keep the check `if [ \"$SAGE_LOCAL\" = \"\" ]; then` (possibly in a different form) to guard against accidental execution outside of a Sage shell. This is important, since there can be severe consequences if `$SAGE_LOCAL` is not set.\n\n3. Too much magic makes the logic harder to understand.",
    "created_at": "2017-06-20T13:31:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429445",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>
I don't really like this idea.

1. Having those scripts executable can be useful for debugging.

2. I would still want to keep the check `if [ "$SAGE_LOCAL" = "" ]; then` (possibly in a different form) to guard against accidental execution outside of a Sage shell. This is important, since there can be severe consequences if `$SAGE_LOCAL` is not set.

3. Too much magic makes the logic harder to understand.



---

archive/issue_comments_429446.json:
```json
{
    "body": "<a id='comment:6'></a>\nReplying to [jdemeyer](#comment%3A5):\n> I don't really like this idea.\n> \n> 1. Having those scripts executable can be useful for debugging.\n\n\nI'm not aware of any scenario that's impeded by this.  Could you give me an example?\n\n> 2. I would still want to keep the check `if [ \"$SAGE_LOCAL\" = \"\" ]; then` (possibly in a different form) to guard against accidental execution outside of a Sage shell. This is important, since there can be severe consequences if `$SAGE_LOCAL` is not set.\n\n\nRight, as I wrote in the ticket I would still keep this guard, and the goal is not to remove it.  That said, I don't see why this is a big deal.  I'm not aware of any other packaging system that worries about this.  If the consequences can be \"severe\" that's maybe a bigger problem.\n\nIn any case, checking `$SAGE_LOCAL` isn't always completely sufficient either, to prevent unwanted side-effects.  What I'm proposing I believe is a lot safer because it discourages execution of these scripts outside of the appropriate context.\n\n> 3. Too much magic makes the logic harder to understand.\n\n\nI've tried giving this some thought, but to be honest I really don't know what you mean by this at all.",
    "created_at": "2017-06-21T07:50:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429446",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>
Replying to [jdemeyer](#comment%3A5):
> I don't really like this idea.
> 
> 1. Having those scripts executable can be useful for debugging.


I'm not aware of any scenario that's impeded by this.  Could you give me an example?

> 2. I would still want to keep the check `if [ "$SAGE_LOCAL" = "" ]; then` (possibly in a different form) to guard against accidental execution outside of a Sage shell. This is important, since there can be severe consequences if `$SAGE_LOCAL` is not set.


Right, as I wrote in the ticket I would still keep this guard, and the goal is not to remove it.  That said, I don't see why this is a big deal.  I'm not aware of any other packaging system that worries about this.  If the consequences can be "severe" that's maybe a bigger problem.

In any case, checking `$SAGE_LOCAL` isn't always completely sufficient either, to prevent unwanted side-effects.  What I'm proposing I believe is a lot safer because it discourages execution of these scripts outside of the appropriate context.

> 3. Too much magic makes the logic harder to understand.


I've tried giving this some thought, but to be honest I really don't know what you mean by this at all.



---

archive/issue_comments_429447.json:
```json
{
    "body": "<a id='comment:7'></a>\n> I'm not aware of any other packaging system that worries about this.\n\n\nWell, other packaging systems aren't written in a very fragile language like `bash` :-)\n\nAnyway, let me reconsider this ticket. I am starting to understand better why it's useful.",
    "created_at": "2017-06-22T08:33:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429447",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>
> I'm not aware of any other packaging system that worries about this.


Well, other packaging systems aren't written in a very fragile language like `bash` :-)

Anyway, let me reconsider this ticket. I am starting to understand better why it's useful.



---

archive/issue_comments_429448.json:
```json
{
    "body": "<a id='comment:8'></a>\nTrue, but as far as I can tell the problem here is not that what language the packaging system itself, however you define that, is written in.\n\nThe way I see it, on most systems, the danger of accidentally installing outside SAGE_LOCAL is mitigated by permissions--you wouldn't be running these scripts with `sudo`.  And if you *are* doing anything with `sudo` it sort of becomes your responsibility what happens.\n\nI think at the end of the day this makes our scripts *safer* because they are no executable by default (if you really wanted to you could still run them with `bash <filename>`), and the wrapped scripts will always source the correct sage-env for the Sage that you're installing into.",
    "created_at": "2017-06-22T14:44:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429448",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>
True, but as far as I can tell the problem here is not that what language the packaging system itself, however you define that, is written in.

The way I see it, on most systems, the danger of accidentally installing outside SAGE_LOCAL is mitigated by permissions--you wouldn't be running these scripts with `sudo`.  And if you *are* doing anything with `sudo` it sort of becomes your responsibility what happens.

I think at the end of the day this makes our scripts *safer* because they are no executable by default (if you really wanted to you could still run them with `bash <filename>`), and the wrapped scripts will always source the correct sage-env for the Sage that you're installing into.



---

archive/issue_comments_429449.json:
```json
{
    "body": "<a id='comment:9'></a>\n1. Instead of this:\n\n```\nif [ -f \"/usr/local/src/sage-config/src/bin/sage-env\" ]; then\n    . \"/usr/local/src/sage-config/src/bin/sage-env\"\nelse\n    echo >&2 \"Error: sage-env not found; is /usr/local/src/sage-config the correct SAGE_ROOT?\"\n    exit 1\nfi\n```\nI would prefer something more like\n\n```\nsource \"/usr/local/src/sage-config/src/bin/sage-env\"\nif [ $? -ne 0 ]; then\n    echo >&2 \"Error: failed to source sage-env; is /usr/local/src/sage-config the correct SAGE_ROOT?\"\n    exit 1\nfi\n```\nAt the very least, you need to check for errors when sourcing `sage-env`.\n\n2. If you really want to make the `spkg-install` script be usable outside of a Sage shell, starting with a `cd` statement into the correct directory would be good too. Otherwise you get\n\n```\n$ /usr/local/src/sage-config/local/var/tmp/sage/build/patch-2.7.5/spkg-install \n/usr/local/src/sage-config/local/var/tmp/sage/build/patch-2.7.5/spkg-install: line 45: ./configure: No such file or directory\nError configuring GNU patch\n```\n\n3. `grep -q -x -m 1`: I have some doubts about the portability of these options. GNU grep may have them, but we should support other `grep` implementations too.\n\n4. For readability, assign `\".tmp-$script\"` to a variable: `tmpscript=\".tmp-$script\"`.\n\n5. In `sage-spkg`, there is a check for a `spkg-install` implemented in Python. That is obsolete now.",
    "created_at": "2017-06-23T13:31:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429449",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>
1. Instead of this:

```
if [ -f "/usr/local/src/sage-config/src/bin/sage-env" ]; then
    . "/usr/local/src/sage-config/src/bin/sage-env"
else
    echo >&2 "Error: sage-env not found; is /usr/local/src/sage-config the correct SAGE_ROOT?"
    exit 1
fi
```
I would prefer something more like

```
source "/usr/local/src/sage-config/src/bin/sage-env"
if [ $? -ne 0 ]; then
    echo >&2 "Error: failed to source sage-env; is /usr/local/src/sage-config the correct SAGE_ROOT?"
    exit 1
fi
```
At the very least, you need to check for errors when sourcing `sage-env`.

2. If you really want to make the `spkg-install` script be usable outside of a Sage shell, starting with a `cd` statement into the correct directory would be good too. Otherwise you get

```
$ /usr/local/src/sage-config/local/var/tmp/sage/build/patch-2.7.5/spkg-install 
/usr/local/src/sage-config/local/var/tmp/sage/build/patch-2.7.5/spkg-install: line 45: ./configure: No such file or directory
Error configuring GNU patch
```

3. `grep -q -x -m 1`: I have some doubts about the portability of these options. GNU grep may have them, but we should support other `grep` implementations too.

4. For readability, assign `".tmp-$script"` to a variable: `tmpscript=".tmp-$script"`.

5. In `sage-spkg`, there is a check for a `spkg-install` implemented in Python. That is obsolete now.



---

archive/issue_comments_429450.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-06-23T13:31:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429450",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_429451.json:
```json
{
    "body": "<a id='comment:11'></a>\n6. I find it a bit strange that you are treating a `#!` line in the `spkg-install` file as a hard error, while the executable bit is only a warning. I think the executability is something that we explicitly do not want, so that should be an error.",
    "created_at": "2017-06-23T13:39:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429451",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>
6. I find it a bit strange that you are treating a `#!` line in the `spkg-install` file as a hard error, while the executable bit is only a warning. I think the executability is something that we explicitly do not want, so that should be an error.



---

archive/issue_comments_429452.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [jdemeyer](#comment%3A11):\n> 6. I find it a bit strange that you are treating a `#!` line in the `spkg-install` file as a hard error, while the executable bit is only a warning. I think the executability is something that we explicitly do not want, so that should be an error.\n\n\nThat can be a problem on Cygwin where, depending on how permission emulation is configured, all files may be treated as executable even if they aren't really (annoying, yes).  My configuration isn't like that but it's not guaranteed.",
    "created_at": "2017-06-26T08:56:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429452",
    "user": "https://github.com/embray"
}
```

<a id='comment:12'></a>
Replying to [jdemeyer](#comment%3A11):
> 6. I find it a bit strange that you are treating a `#!` line in the `spkg-install` file as a hard error, while the executable bit is only a warning. I think the executability is something that we explicitly do not want, so that should be an error.


That can be a problem on Cygwin where, depending on how permission emulation is configured, all files may be treated as executable even if they aren't really (annoying, yes).  My configuration isn't like that but it's not guaranteed.



---

archive/issue_comments_429453.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [jdemeyer](#comment%3A9):\n> 3. `grep -q -x -m 1`: I have some doubts about the portability of these options. GNU grep may have them, but we should support other `grep` implementations too.\n\n\nThese options are available on BSD grep as well, including on OSX.  If someone can point out a specific implementation where they're not then I can change it.",
    "created_at": "2017-06-26T09:00:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429453",
    "user": "https://github.com/embray"
}
```

<a id='comment:13'></a>
Replying to [jdemeyer](#comment%3A9):
> 3. `grep -q -x -m 1`: I have some doubts about the portability of these options. GNU grep may have them, but we should support other `grep` implementations too.


These options are available on BSD grep as well, including on OSX.  If someone can point out a specific implementation where they're not then I can change it.



---

archive/issue_comments_429454.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [embray](#comment%3A13):\n> If someone can point out a specific implementation where they're not then I can change it.\n\n\nSince you challenged me, [OpenBSD grep](http://man.openbsd.org/grep) does not have `-m`. But really, there is no reason to use `-m`, you can use `head -1 | grep`. And instead of using `-x`, you can match a whole line with `^regex$`. And instead of using `-q`, use `> /dev/null`.",
    "created_at": "2017-06-26T09:17:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429454",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>
Replying to [embray](#comment%3A13):
> If someone can point out a specific implementation where they're not then I can change it.


Since you challenged me, [OpenBSD grep](http://man.openbsd.org/grep) does not have `-m`. But really, there is no reason to use `-m`, you can use `head -1 | grep`. And instead of using `-x`, you can match a whole line with `^regex$`. And instead of using `-q`, use `> /dev/null`.



---

archive/issue_comments_429455.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [jdemeyer](#comment%3A14):\n> Replying to [embray](#comment%3A13):\n> > If someone can point out a specific implementation where they're not then I can change it.\n\n> \n> Since you challenged me, [OpenBSD grep](http://man.openbsd.org/grep) does not have `-m`. But really, there is no reason to use `-m`, you can use `head -1 | grep`. And instead of using `-x`, you can match a whole line with `^regex$`. And instead of using `-q`, use `> /dev/null`.\n\n\nOkay, that's fine--obviously all of these alternatives are possible just annoying.",
    "created_at": "2017-06-26T09:35:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429455",
    "user": "https://github.com/embray"
}
```

<a id='comment:15'></a>
Replying to [jdemeyer](#comment%3A14):
> Replying to [embray](#comment%3A13):
> > If someone can point out a specific implementation where they're not then I can change it.

> 
> Since you challenged me, [OpenBSD grep](http://man.openbsd.org/grep) does not have `-m`. But really, there is no reason to use `-m`, you can use `head -1 | grep`. And instead of using `-x`, you can match a whole line with `^regex$`. And instead of using `-q`, use `> /dev/null`.


Okay, that's fine--obviously all of these alternatives are possible just annoying.



---

archive/issue_comments_429456.json:
```json
{
    "body": "<a id='comment:16'></a>\nReplying to [embray](#comment%3A12):\n> Replying to [jdemeyer](#comment%3A11):\n> > 6. I find it a bit strange that you are treating a `#!` line in the `spkg-install` file as a hard error, while the executable bit is only a warning. I think the executability is something that we explicitly do not want, so that should be an error.\n  \n> \n> That can be a problem on Cygwin where, depending on how permission emulation is configured, all files may be treated as executable even if they aren't really (annoying, yes).  My configuration isn't like that but it's not guaranteed.\n\n\nPerhaps for Cygwin I could just output a warning, but make it an error everywhere else, where presumably we can rely on permissions being sane.",
    "created_at": "2017-06-27T08:04:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429456",
    "user": "https://github.com/embray"
}
```

<a id='comment:16'></a>
Replying to [embray](#comment%3A12):
> Replying to [jdemeyer](#comment%3A11):
> > 6. I find it a bit strange that you are treating a `#!` line in the `spkg-install` file as a hard error, while the executable bit is only a warning. I think the executability is something that we explicitly do not want, so that should be an error.
  
> 
> That can be a problem on Cygwin where, depending on how permission emulation is configured, all files may be treated as executable even if they aren't really (annoying, yes).  My configuration isn't like that but it's not guaranteed.


Perhaps for Cygwin I could just output a warning, but make it an error everywhere else, where presumably we can rely on permissions being sane.



---

archive/issue_comments_429457.json:
```json
{
    "body": "<a id='comment:17'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                   |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------|\n|[d5399f7](https://github.com/sagemath/sagetrac-mirror/commit/d5399f76b2905687fe78de35573d68b3536022b7)|`Don't use not entirely portable GNU grep features`|\n|[3c34582](https://github.com/sagemath/sagetrac-mirror/commit/3c34582918eb8e1ddd1455103a62d1b535b817d4)|`Instead of looking before we leap, always try sourcing sage-env, and handle any errors that might occur`|\n|[38647dc](https://github.com/sagemath/sagetrac-mirror/commit/38647dc23dd9986ec8080045c9ce850eceabc819)|`Pass write_script_wrapper the absolute path to the script it's writing`|\n|[8cd0049](https://github.com/sagemath/sagetrac-mirror/commit/8cd0049c3a56040758eaa6ad4b52b39023da7f67)|`Use a variable for the path to the temporary file for clarity's sake`|\n|[01e3c03](https://github.com/sagemath/sagetrac-mirror/commit/01e3c0398e9eac74eadab95ee8e199de48d376f4)|`Remove this check from sage-spkg since spkg-installs will no longer be written in Python`|",
    "created_at": "2017-06-27T08:56:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429457",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                   |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------|
|[d5399f7](https://github.com/sagemath/sagetrac-mirror/commit/d5399f76b2905687fe78de35573d68b3536022b7)|`Don't use not entirely portable GNU grep features`|
|[3c34582](https://github.com/sagemath/sagetrac-mirror/commit/3c34582918eb8e1ddd1455103a62d1b535b817d4)|`Instead of looking before we leap, always try sourcing sage-env, and handle any errors that might occur`|
|[38647dc](https://github.com/sagemath/sagetrac-mirror/commit/38647dc23dd9986ec8080045c9ce850eceabc819)|`Pass write_script_wrapper the absolute path to the script it's writing`|
|[8cd0049](https://github.com/sagemath/sagetrac-mirror/commit/8cd0049c3a56040758eaa6ad4b52b39023da7f67)|`Use a variable for the path to the temporary file for clarity's sake`|
|[01e3c03](https://github.com/sagemath/sagetrac-mirror/commit/01e3c0398e9eac74eadab95ee8e199de48d376f4)|`Remove this check from sage-spkg since spkg-installs will no longer be written in Python`|



---

archive/issue_comments_429458.json:
```json
{
    "body": "Changing commit from \"d30624b03cc6f62087e0c3c9a820148d46b67616\" to \"01e3c0398e9eac74eadab95ee8e199de48d376f4\"",
    "created_at": "2017-06-27T08:56:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429458",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "d30624b03cc6f62087e0c3c9a820148d46b67616" to "01e3c0398e9eac74eadab95ee8e199de48d376f4"



---

archive/issue_comments_429459.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Jeroen Demeyer\"",
    "created_at": "2017-06-27T08:58:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429459",
    "user": "https://github.com/embray"
}
```

Changing reviewer from "" to "Jeroen Demeyer"



---

archive/issue_comments_429460.json:
```json
{
    "body": "<a id='comment:18'></a>\nI think this addresses all your comments so far.  If this needs any further tweaks that's fine, but even if not please set this back to *needs work* so that I can work on updating the developer documentation, assuming there are no further objections to this in principle.",
    "created_at": "2017-06-27T08:58:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429460",
    "user": "https://github.com/embray"
}
```

<a id='comment:18'></a>
I think this addresses all your comments so far.  If this needs any further tweaks that's fine, but even if not please set this back to *needs work* so that I can work on updating the developer documentation, assuming there are no further objections to this in principle.



---

archive/issue_comments_429461.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-06-27T08:58:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429461",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_429462.json:
```json
{
    "body": "<a id='comment:19'></a>\nSorry, I think there's a bug somewhere.",
    "created_at": "2017-06-27T09:06:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429462",
    "user": "https://github.com/embray"
}
```

<a id='comment:19'></a>
Sorry, I think there's a bug somewhere.



---

archive/issue_comments_429463.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-06-27T09:06:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429463",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_429464.json:
```json
{
    "body": "Changing commit from \"01e3c0398e9eac74eadab95ee8e199de48d376f4\" to \"e2362e1c2cc93293f1e206f8a95169995e9e4ea3\"",
    "created_at": "2017-06-27T09:10:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429464",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "01e3c0398e9eac74eadab95ee8e199de48d376f4" to "e2362e1c2cc93293f1e206f8a95169995e9e4ea3"



---

archive/issue_comments_429465.json:
```json
{
    "body": "<a id='comment:20'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                           |                                                                                                         |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------|\n|[b05f707](https://github.com/sagemath/sagetrac-mirror/commit/b05f707269963cb5df58ed8caa92959676c788f6)|`Instead of looking before we leap, always try sourcing sage-env, and handle any errors that might occur`|\n|[d22768d](https://github.com/sagemath/sagetrac-mirror/commit/d22768df25f4128ab2739f8f2408a7125de9db37)|`Pass write_script_wrapper the absolute path to the script it's writing`|\n|[84cbd4e](https://github.com/sagemath/sagetrac-mirror/commit/84cbd4e5e94eb4bef775a47a436acf1a00648683)|`Use a variable for the path to the temporary file for clarity's sake`|\n|[e2362e1](https://github.com/sagemath/sagetrac-mirror/commit/e2362e1c2cc93293f1e206f8a95169995e9e4ea3)|`Remove this check from sage-spkg since spkg-installs will no longer be written in Python`|",
    "created_at": "2017-06-27T09:10:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429465",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:20'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                           |                                                                                                         |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------|
|[b05f707](https://github.com/sagemath/sagetrac-mirror/commit/b05f707269963cb5df58ed8caa92959676c788f6)|`Instead of looking before we leap, always try sourcing sage-env, and handle any errors that might occur`|
|[d22768d](https://github.com/sagemath/sagetrac-mirror/commit/d22768df25f4128ab2739f8f2408a7125de9db37)|`Pass write_script_wrapper the absolute path to the script it's writing`|
|[84cbd4e](https://github.com/sagemath/sagetrac-mirror/commit/84cbd4e5e94eb4bef775a47a436acf1a00648683)|`Use a variable for the path to the temporary file for clarity's sake`|
|[e2362e1](https://github.com/sagemath/sagetrac-mirror/commit/e2362e1c2cc93293f1e206f8a95169995e9e4ea3)|`Remove this check from sage-spkg since spkg-installs will no longer be written in Python`|



---

archive/issue_comments_429466.json:
```json
{
    "body": "<a id='comment:21'></a>\nSeems fine now; just had a stupid typo.",
    "created_at": "2017-06-27T09:11:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429466",
    "user": "https://github.com/embray"
}
```

<a id='comment:21'></a>
Seems fine now; just had a stupid typo.



---

archive/issue_comments_429467.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-06-27T09:11:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429467",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_429468.json:
```json
{
    "body": "Changing commit from \"e2362e1c2cc93293f1e206f8a95169995e9e4ea3\" to \"1d8b94e22b6e501139e4efcf7992a1bce467ec62\"",
    "created_at": "2017-06-27T09:31:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429468",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "e2362e1c2cc93293f1e206f8a95169995e9e4ea3" to "1d8b94e22b6e501139e4efcf7992a1bce467ec62"



---

archive/issue_comments_429469.json:
```json
{
    "body": "<a id='comment:22'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                           |                                                   |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------|\n|[9c34d45](https://github.com/sagemath/sagetrac-mirror/commit/9c34d454be51adb3e0e1ff2de3f10bf8b08e15c6)|`Don't use not entirely portable GNU grep features`|\n|[e677e4e](https://github.com/sagemath/sagetrac-mirror/commit/e677e4e0c88c9492ced5d3b8e75d69c92636f752)|`Instead of looking before we leap, always try sourcing sage-env, and handle any errors that might occur`|\n|[a426c02](https://github.com/sagemath/sagetrac-mirror/commit/a426c0244b157f126aae85e49c3cac98c52c0bab)|`Pass write_script_wrapper the absolute path to the script it's writing`|\n|[1b66b8c](https://github.com/sagemath/sagetrac-mirror/commit/1b66b8c8ddb816097d888977876ef02e843663f3)|`Use a variable for the path to the temporary file for clarity's sake`|\n|[1d8b94e](https://github.com/sagemath/sagetrac-mirror/commit/1d8b94e22b6e501139e4efcf7992a1bce467ec62)|`Remove this check from sage-spkg since spkg-installs will no longer be written in Python`|",
    "created_at": "2017-06-27T09:31:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429469",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:22'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                           |                                                   |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------|
|[9c34d45](https://github.com/sagemath/sagetrac-mirror/commit/9c34d454be51adb3e0e1ff2de3f10bf8b08e15c6)|`Don't use not entirely portable GNU grep features`|
|[e677e4e](https://github.com/sagemath/sagetrac-mirror/commit/e677e4e0c88c9492ced5d3b8e75d69c92636f752)|`Instead of looking before we leap, always try sourcing sage-env, and handle any errors that might occur`|
|[a426c02](https://github.com/sagemath/sagetrac-mirror/commit/a426c0244b157f126aae85e49c3cac98c52c0bab)|`Pass write_script_wrapper the absolute path to the script it's writing`|
|[1b66b8c](https://github.com/sagemath/sagetrac-mirror/commit/1b66b8c8ddb816097d888977876ef02e843663f3)|`Use a variable for the path to the temporary file for clarity's sake`|
|[1d8b94e](https://github.com/sagemath/sagetrac-mirror/commit/1d8b94e22b6e501139e4efcf7992a1bce467ec62)|`Remove this check from sage-spkg since spkg-installs will no longer be written in Python`|



---

archive/issue_comments_429470.json:
```json
{
    "body": "<a id='comment:23'></a>\nTo be clear: I have no further objections to the principle (you convinced me).",
    "created_at": "2017-06-27T09:38:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429470",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:23'></a>
To be clear: I have no further objections to the principle (you convinced me).



---

archive/issue_comments_429471.json:
```json
{
    "body": "<a id='comment:24'></a>\nOkay, thanks--I'll work on the documentation updates then.",
    "created_at": "2017-06-27T11:52:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429471",
    "user": "https://github.com/embray"
}
```

<a id='comment:24'></a>
Okay, thanks--I'll work on the documentation updates then.



---

archive/issue_comments_429472.json:
```json
{
    "body": "<a id='comment:25'></a>\nI just built Sage from scratch with this branch and it worked.",
    "created_at": "2017-06-28T21:08:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429472",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:25'></a>
I just built Sage from scratch with this branch and it worked.



---

archive/issue_comments_429473.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-06-29T13:43:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429473",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_429474.json:
```json
{
    "body": "<a id='comment:26'></a>\nThanks; I'll work on updating the documentation.",
    "created_at": "2017-06-29T13:43:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429474",
    "user": "https://github.com/embray"
}
```

<a id='comment:26'></a>
Thanks; I'll work on updating the documentation.



---

archive/issue_comments_429475.json:
```json
{
    "body": "Changing commit from \"1d8b94e22b6e501139e4efcf7992a1bce467ec62\" to \"66888230ed1976e7ca075464499ae3ce4e9a4951\"",
    "created_at": "2017-06-30T08:07:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429475",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "1d8b94e22b6e501139e4efcf7992a1bce467ec62" to "66888230ed1976e7ca075464499ae3ce4e9a4951"



---

archive/issue_comments_429476.json:
```json
{
    "body": "<a id='comment:27'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                                                                          |\n|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------|\n|[6688823](https://github.com/sagemath/sagetrac-mirror/commit/66888230ed1976e7ca075464499ae3ce4e9a4951)|`Make it a mere warning on Cygwin if any of the scripts in build/pkgs are executable, but a hard error on other platforms`|",
    "created_at": "2017-06-30T08:07:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429476",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:27'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                                                                          |
|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
|[6688823](https://github.com/sagemath/sagetrac-mirror/commit/66888230ed1976e7ca075464499ae3ce4e9a4951)|`Make it a mere warning on Cygwin if any of the scripts in build/pkgs are executable, but a hard error on other platforms`|



---

archive/issue_comments_429477.json:
```json
{
    "body": "<a id='comment:28'></a>\nSo your plan is to change *only* the documentation and nothing else?\n\nI am asking because I want to give the final version of the code another round of testing. But that is only meaningful if you are not going to change the code.",
    "created_at": "2017-06-30T14:28:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429477",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:28'></a>
So your plan is to change *only* the documentation and nothing else?

I am asking because I want to give the final version of the code another round of testing. But that is only meaningful if you are not going to change the code.



---

archive/issue_comments_429478.json:
```json
{
    "body": "<a id='comment:29'></a>\nI don't plan to make any further updates to the code on this ticket, unless you or someone else comes up with a suggestion.",
    "created_at": "2017-07-03T09:22:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429478",
    "user": "https://github.com/embray"
}
```

<a id='comment:29'></a>
I don't plan to make any further updates to the code on this ticket, unless you or someone else comes up with a suggestion.



---

archive/issue_comments_429479.json:
```json
{
    "body": "<a id='comment:30'></a>\n`$?` should be quoted otherwise you get\n\n```/usr/bin/env bash\n\nsource \"/opt/sage/sage-test/src/bin/sage-env\"\nif [ 0 -ne 0 ]; then\n    echo >&2 \"Error: failed to source sage-env; is /opt/sage/sage-test the correct SAGE_ROOT?\"\n    exit 1\nfi\n\ncd \"/opt/sage/sage-test/local/var/tmp/sage/build/pari-2.9.2.p2\"\nif [ 0 -ne 0 ]; then\n    echo >&2 \"Error: could not cd to the package build directory /opt/sage/sage-test/local/var/tmp/sage/build/pari-2.9.2.p2\"\n    exit 1\nfi\n```\n\nI wonder why you don't use a here document for this:\n\n```\ncat <<EOF\n...\nEOF\n```\nThat way, there would no need to quote `\"`.",
    "created_at": "2017-07-04T09:12:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429479",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:30'></a>
`$?` should be quoted otherwise you get

```/usr/bin/env bash

source "/opt/sage/sage-test/src/bin/sage-env"
if [ 0 -ne 0 ]; then
    echo >&2 "Error: failed to source sage-env; is /opt/sage/sage-test the correct SAGE_ROOT?"
    exit 1
fi

cd "/opt/sage/sage-test/local/var/tmp/sage/build/pari-2.9.2.p2"
if [ 0 -ne 0 ]; then
    echo >&2 "Error: could not cd to the package build directory /opt/sage/sage-test/local/var/tmp/sage/build/pari-2.9.2.p2"
    exit 1
fi
```

I wonder why you don't use a here document for this:

```
cat <<EOF
...
EOF
```
That way, there would no need to quote `"`.



---

archive/issue_comments_429480.json:
```json
{
    "body": "<a id='comment:31'></a>\nOops, good catch.  I don't know why I didn't use a heredoc either.  Maybe just because it started out shorter.",
    "created_at": "2017-07-04T09:48:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429480",
    "user": "https://github.com/embray"
}
```

<a id='comment:31'></a>
Oops, good catch.  I don't know why I didn't use a heredoc either.  Maybe just because it started out shorter.



---

archive/issue_comments_429481.json:
```json
{
    "body": "<a id='comment:32'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                 |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------|\n|[932b859](https://github.com/sagemath/sagetrac-mirror/commit/932b85910f6ace2d8d2f806865f7ae73699300aa)|`Use a heredoc instead of a quoted variable, for clarity's sake.`|",
    "created_at": "2017-07-04T14:17:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429481",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:32'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                 |
|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------|
|[932b859](https://github.com/sagemath/sagetrac-mirror/commit/932b85910f6ace2d8d2f806865f7ae73699300aa)|`Use a heredoc instead of a quoted variable, for clarity's sake.`|



---

archive/issue_comments_429482.json:
```json
{
    "body": "Changing commit from \"66888230ed1976e7ca075464499ae3ce4e9a4951\" to \"932b85910f6ace2d8d2f806865f7ae73699300aa\"",
    "created_at": "2017-07-04T14:17:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429482",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "66888230ed1976e7ca075464499ae3ce4e9a4951" to "932b85910f6ace2d8d2f806865f7ae73699300aa"



---

archive/issue_comments_429483.json:
```json
{
    "body": "<a id='comment:33'></a>\nThis breaks old-style packages:\n\n```\n$ ./sage -p cluster_seed\nFound package cluster_seed in /opt/sage/sage-test/upstream/cluster_seed-1.0.spkg\ncluster_seed-1.0\n====================================================\nExtracting package /opt/sage/sage-test/upstream/cluster_seed-1.0.spkg\n-rw-r--r-- 1 jdemeyer jdemeyer 150910 Jul  5 14:26 /opt/sage/sage-test/upstream/cluster_seed-1.0.spkg\nFinished extraction\nNo patch files found in ../patches\n************************************************************************\nspkg-install should not be marked executable in the                 build/pkgs directory\n************************************************************************\nPlease email sage-devel (http://groups.google.com/group/sage-devel)\nexplaining the problem and including the log file\n  /opt/sage/sage-test/logs/pkgs/cluster_seed-1.0.log\nDescribe your computer, operating system, etc.\n************************************************************************\n```\n\nNow I see two solutions to this: either you need to bypass the boilerplate stuff from this ticket for old-style packages, or we need to drop support for old-style packages completely.\n\nI will write to sage-devel to ask opinions about the latter.\n\nMinor note: this causes excessive whitespace:\n\n```\n            msg=\"spkg-$script should not be marked executable in the \\\n                build/pkgs directory\"\n```\nI would just put this on one line.",
    "created_at": "2017-07-05T12:31:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429483",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:33'></a>
This breaks old-style packages:

```
$ ./sage -p cluster_seed
Found package cluster_seed in /opt/sage/sage-test/upstream/cluster_seed-1.0.spkg
cluster_seed-1.0
====================================================
Extracting package /opt/sage/sage-test/upstream/cluster_seed-1.0.spkg
-rw-r--r-- 1 jdemeyer jdemeyer 150910 Jul  5 14:26 /opt/sage/sage-test/upstream/cluster_seed-1.0.spkg
Finished extraction
No patch files found in ../patches
************************************************************************
spkg-install should not be marked executable in the                 build/pkgs directory
************************************************************************
Please email sage-devel (http://groups.google.com/group/sage-devel)
explaining the problem and including the log file
  /opt/sage/sage-test/logs/pkgs/cluster_seed-1.0.log
Describe your computer, operating system, etc.
************************************************************************
```

Now I see two solutions to this: either you need to bypass the boilerplate stuff from this ticket for old-style packages, or we need to drop support for old-style packages completely.

I will write to sage-devel to ask opinions about the latter.

Minor note: this causes excessive whitespace:

```
            msg="spkg-$script should not be marked executable in the \
                build/pkgs directory"
```
I would just put this on one line.



---

archive/issue_comments_429484.json:
```json
{
    "body": "<a id='comment:34'></a>\nAh, you're right about the whitespace. On the REPL it will strip the leading whitespace but not in a script.  Too bad, but okay.\n\nYeah, I actually wasn't sure what this would do with \"old style\" packages. I figured if someone cared they would point it out.  I've just never actually *seen* one of these old-style packages and wouldn't know where to find one.\n\nI'd be all for removing support entirely, but obviously that should be a separate issue.  In the meantime I make exceptions for them.",
    "created_at": "2017-07-05T12:49:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429484",
    "user": "https://github.com/embray"
}
```

<a id='comment:34'></a>
Ah, you're right about the whitespace. On the REPL it will strip the leading whitespace but not in a script.  Too bad, but okay.

Yeah, I actually wasn't sure what this would do with "old style" packages. I figured if someone cared they would point it out.  I've just never actually *seen* one of these old-style packages and wouldn't know where to find one.

I'd be all for removing support entirely, but obviously that should be a separate issue.  In the meantime I make exceptions for them.



---

archive/issue_comments_429485.json:
```json
{
    "body": "<a id='comment:35'></a>\nOne idea that came to me while updating the docs, though possibly a bit too surprising: The current docs explicitly state that `spkg-install` can be either a shell script or a Python script (though I don't think there's anything stopping it from being an arbitrary executable).  The Python case, in the very least, could still be supported though.  The way I handled the few existing Python scripts is quite mechanical--simply rename the Python `spkg-install` to `spkg-install.py`, and run `exec sage-python23 spkg-install.py` in the actual `spkg-install`.  This mechanism of wrapping Python scripts could just as easily be automated.  Not sure if it's worth the trouble though--it's probably simpler to just require it to be a bash script, full stop.",
    "created_at": "2017-07-06T09:53:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429485",
    "user": "https://github.com/embray"
}
```

<a id='comment:35'></a>
One idea that came to me while updating the docs, though possibly a bit too surprising: The current docs explicitly state that `spkg-install` can be either a shell script or a Python script (though I don't think there's anything stopping it from being an arbitrary executable).  The Python case, in the very least, could still be supported though.  The way I handled the few existing Python scripts is quite mechanical--simply rename the Python `spkg-install` to `spkg-install.py`, and run `exec sage-python23 spkg-install.py` in the actual `spkg-install`.  This mechanism of wrapping Python scripts could just as easily be automated.  Not sure if it's worth the trouble though--it's probably simpler to just require it to be a bash script, full stop.



---

archive/issue_comments_429486.json:
```json
{
    "body": "<a id='comment:36'></a>\nPresumably this won't be in Sage 8.0 since it's already in the release candidate stage...",
    "created_at": "2017-07-06T10:01:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429486",
    "user": "https://github.com/embray"
}
```

<a id='comment:36'></a>
Presumably this won't be in Sage 8.0 since it's already in the release candidate stage...



---

archive/issue_events_075888.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-07-06T10:01:57Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "milestone": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23179#event-75888"
}
```



---

archive/issue_comments_429487.json:
```json
{
    "body": "<a id='comment:37'></a>\nReplying to [embray](#comment%3A35):\n> it's probably simpler to just require it to be a bash script, full stop.\n\n\nI agree. I think it suffices to mention in the docs how to support a Python install script using `sage-python23`.",
    "created_at": "2017-07-06T10:20:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429487",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:37'></a>
Replying to [embray](#comment%3A35):
> it's probably simpler to just require it to be a bash script, full stop.


I agree. I think it suffices to mention in the docs how to support a Python install script using `sage-python23`.



---

archive/issue_comments_429488.json:
```json
{
    "body": "<a id='comment:38'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:\n|                                                                                                                                           |                                                   |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------|\n|[ff832c4](https://github.com/sagemath/sagetrac-mirror/commit/ff832c4e8a652f8dc4698c81f8be1492fa33d087)|`Don't use not entirely portable GNU grep features`|\n|[4a77569](https://github.com/sagemath/sagetrac-mirror/commit/4a77569a7b9e69e73de798cf41b217e410677c1c)|`Instead of looking before we leap, always try sourcing sage-env, and handle any errors that might occur`|\n|[8d19362](https://github.com/sagemath/sagetrac-mirror/commit/8d193620bb21446edd4b05a6ff553fb5238b6ada)|`Pass write_script_wrapper the absolute path to the script it's writing`|\n|[be6559d](https://github.com/sagemath/sagetrac-mirror/commit/be6559dba568fde3b5a01967fef534113f9812eb)|`Use a variable for the path to the temporary file for clarity's sake`|\n|[954630f](https://github.com/sagemath/sagetrac-mirror/commit/954630ff8f956654357b13dfb4bd35e3f2f254da)|`Remove this check from sage-spkg since spkg-installs will no longer be written in Python`|\n|[1b96a66](https://github.com/sagemath/sagetrac-mirror/commit/1b96a665e8e18a7df035835b268b3a08496da553)|`Make it a mere warning on Cygwin if any of the scripts in build/pkgs are executable, but a hard error on other platforms`|\n|[b1155dd](https://github.com/sagemath/sagetrac-mirror/commit/b1155ddfcbf19a10a240d463015e367d336c5f90)|`Use a heredoc instead of a quoted variable, for clarity's sake.`|\n|[d28f35d](https://github.com/sagemath/sagetrac-mirror/commit/d28f35dce4a1f2718909ce47e24be20031ed6df3)|`Add an explicit variable indicating if this is an old-style package`|\n|[4c4941f](https://github.com/sagemath/sagetrac-mirror/commit/4c4941fcfc1c417dd334f3475adda1576805c7c7)|`Restore support old-style packages, for now, by not creating script wrappers`|\n|[a6163ce](https://github.com/sagemath/sagetrac-mirror/commit/a6163ce73554a602a484026f700849130d796665)|`Updated the developer docs to reflect the changes in #23179`|",
    "created_at": "2017-07-06T10:22:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429488",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:38'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:
|                                                                                                                                           |                                                   |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------|
|[ff832c4](https://github.com/sagemath/sagetrac-mirror/commit/ff832c4e8a652f8dc4698c81f8be1492fa33d087)|`Don't use not entirely portable GNU grep features`|
|[4a77569](https://github.com/sagemath/sagetrac-mirror/commit/4a77569a7b9e69e73de798cf41b217e410677c1c)|`Instead of looking before we leap, always try sourcing sage-env, and handle any errors that might occur`|
|[8d19362](https://github.com/sagemath/sagetrac-mirror/commit/8d193620bb21446edd4b05a6ff553fb5238b6ada)|`Pass write_script_wrapper the absolute path to the script it's writing`|
|[be6559d](https://github.com/sagemath/sagetrac-mirror/commit/be6559dba568fde3b5a01967fef534113f9812eb)|`Use a variable for the path to the temporary file for clarity's sake`|
|[954630f](https://github.com/sagemath/sagetrac-mirror/commit/954630ff8f956654357b13dfb4bd35e3f2f254da)|`Remove this check from sage-spkg since spkg-installs will no longer be written in Python`|
|[1b96a66](https://github.com/sagemath/sagetrac-mirror/commit/1b96a665e8e18a7df035835b268b3a08496da553)|`Make it a mere warning on Cygwin if any of the scripts in build/pkgs are executable, but a hard error on other platforms`|
|[b1155dd](https://github.com/sagemath/sagetrac-mirror/commit/b1155ddfcbf19a10a240d463015e367d336c5f90)|`Use a heredoc instead of a quoted variable, for clarity's sake.`|
|[d28f35d](https://github.com/sagemath/sagetrac-mirror/commit/d28f35dce4a1f2718909ce47e24be20031ed6df3)|`Add an explicit variable indicating if this is an old-style package`|
|[4c4941f](https://github.com/sagemath/sagetrac-mirror/commit/4c4941fcfc1c417dd334f3475adda1576805c7c7)|`Restore support old-style packages, for now, by not creating script wrappers`|
|[a6163ce](https://github.com/sagemath/sagetrac-mirror/commit/a6163ce73554a602a484026f700849130d796665)|`Updated the developer docs to reflect the changes in #23179`|



---

archive/issue_comments_429489.json:
```json
{
    "body": "Changing commit from \"932b85910f6ace2d8d2f806865f7ae73699300aa\" to \"a6163ce73554a602a484026f700849130d796665\"",
    "created_at": "2017-07-06T10:22:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429489",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "932b85910f6ace2d8d2f806865f7ae73699300aa" to "a6163ce73554a602a484026f700849130d796665"



---

archive/issue_comments_429490.json:
```json
{
    "body": "<a id='comment:39'></a>\nRestored support for old-style packages (still needs to be tested), updated developer docs, and rebased on latest develop branch.",
    "created_at": "2017-07-06T10:22:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429490",
    "user": "https://github.com/embray"
}
```

<a id='comment:39'></a>
Restored support for old-style packages (still needs to be tested), updated developer docs, and rebased on latest develop branch.



---

archive/issue_comments_429491.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-07-06T10:23:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429491",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_429492.json:
```json
{
    "body": "<a id='comment:41'></a>\n(Ran `./sage -p cluster_seed` and it worked fine--in short, for old-style packages it just uses the unmodified `spkg-install` as before).",
    "created_at": "2017-07-06T10:25:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429492",
    "user": "https://github.com/embray"
}
```

<a id='comment:41'></a>
(Ran `./sage -p cluster_seed` and it worked fine--in short, for old-style packages it just uses the unmodified `spkg-install` as before).



---

archive/issue_comments_429493.json:
```json
{
    "body": "<a id='comment:42'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                  |\n|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------|\n|[8819114](https://github.com/sagemath/sagetrac-mirror/commit/8819114afb5494f4f25231fb183fb75b6209e476)|`Set some variables in the wrapper script itself.`|",
    "created_at": "2017-07-12T11:29:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429493",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:42'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                  |
|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------|
|[8819114](https://github.com/sagemath/sagetrac-mirror/commit/8819114afb5494f4f25231fb183fb75b6209e476)|`Set some variables in the wrapper script itself.`|



---

archive/issue_comments_429494.json:
```json
{
    "body": "Changing commit from \"a6163ce73554a602a484026f700849130d796665\" to \"8819114afb5494f4f25231fb183fb75b6209e476\"",
    "created_at": "2017-07-12T11:29:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429494",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "a6163ce73554a602a484026f700849130d796665" to "8819114afb5494f4f25231fb183fb75b6209e476"



---

archive/issue_comments_429495.json:
```json
{
    "body": "<a id='comment:43'></a>\nI'm researching open package update tickets with patches that could conflict with this (specifically, those that update `spkg-install`--if they don't then there shouldn't be much conflict).\n\nTickets with positive review:\n* #23023\n* #23357\n\nTickets still needing work/review:\n* #13268\n* #13426\n* #14645\n* #15674\n* #18197\n* #18514\n* #19680\n* #19719\n* #20922\n* #21170\n* #21525\n* #21888\n* #22072\n* #23024\n* #23325\n* #23353\n\nThe following old tickets conflict with #20136 (or other more recent changes) and will need to be rebased anyways:\n* #5310\n* #10879\n* #15209\n* #15813\n* #18749\n* #19706\n* #20670\n\nSince tickets like this one (and #22509 + #22510) that make mass updates to packages are notoriously unwieldy it would be good to get merged quickly if/when it has a positive review.\n\nTo that end, I can make this depend on #23023 and #23357 since they already have positive review.  Of the tickets still needing work, it might be nice if some of them added this ticket as a dependency (especially #23325 and #23353 since they were opened later) but if they can be given a positive review quickly, I also have no problem adding them as dependencies to this ticket.  Most of the other tickets on that list either haven't been updated for several months, or are still in development, so I would prefer not to wait on them unless I hear otherwise.",
    "created_at": "2017-07-12T12:29:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429495",
    "user": "https://github.com/embray"
}
```

<a id='comment:43'></a>
I'm researching open package update tickets with patches that could conflict with this (specifically, those that update `spkg-install`--if they don't then there shouldn't be much conflict).

Tickets with positive review:
* #23023
* #23357

Tickets still needing work/review:
* #13268
* #13426
* #14645
* #15674
* #18197
* #18514
* #19680
* #19719
* #20922
* #21170
* #21525
* #21888
* #22072
* #23024
* #23325
* #23353

The following old tickets conflict with #20136 (or other more recent changes) and will need to be rebased anyways:
* #5310
* #10879
* #15209
* #15813
* #18749
* #19706
* #20670

Since tickets like this one (and #22509 + #22510) that make mass updates to packages are notoriously unwieldy it would be good to get merged quickly if/when it has a positive review.

To that end, I can make this depend on #23023 and #23357 since they already have positive review.  Of the tickets still needing work, it might be nice if some of them added this ticket as a dependency (especially #23325 and #23353 since they were opened later) but if they can be given a positive review quickly, I also have no problem adding them as dependencies to this ticket.  Most of the other tickets on that list either haven't been updated for several months, or are still in development, so I would prefer not to wait on them unless I hear otherwise.



---

archive/issue_comments_429496.json:
```json
{
    "body": "<a id='comment:44'></a>\nThere is no need for `$PKG_OLD_STYLE` since it is simply the negation of `$USE_LOCAL_SCRIPTS`. So you can replace `[ -z \"$PKG_OLD_STYLE\" ]` by `[ \"$USE_LOCAL_SCRIPTS\" = yes ]` and then you don't need the `PKG_OLD_STYLE` variable.",
    "created_at": "2017-07-12T12:31:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429496",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:44'></a>
There is no need for `$PKG_OLD_STYLE` since it is simply the negation of `$USE_LOCAL_SCRIPTS`. So you can replace `[ -z "$PKG_OLD_STYLE" ]` by `[ "$USE_LOCAL_SCRIPTS" = yes ]` and then you don't need the `PKG_OLD_STYLE` variable.



---

archive/issue_comments_429497.json:
```json
{
    "body": "<a id='comment:45'></a>\nReplying to [embray](#comment%3A43):\n> To that end, I can make this depend on #23023 and #23357\n\n\nAs far as I can see, there should be no conflict with #23357 (it does edit `spkg-install` but in a way that git should merge cleanly).\n\nThere *is* a conflict with #23023 since that actually adds a new package.",
    "created_at": "2017-07-12T12:33:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429497",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:45'></a>
Replying to [embray](#comment%3A43):
> To that end, I can make this depend on #23023 and #23357


As far as I can see, there should be no conflict with #23357 (it does edit `spkg-install` but in a way that git should merge cleanly).

There *is* a conflict with #23023 since that actually adds a new package.



---

archive/issue_comments_429498.json:
```json
{
    "body": "<a id='comment:46'></a>\nReplying to [jdemeyer](#comment%3A44):\n> There is no need for `$PKG_OLD_STYLE` since it is simply the negation of `$USE_LOCAL_SCRIPTS`. So you can replace `[ -z \"$PKG_OLD_STYLE\" ]` by `[ \"$USE_LOCAL_SCRIPTS\" = yes ]` and then you don't need the `PKG_OLD_STYLE` variable.\n\n\nNote: I deliberately added this variable because the fact that `$USE_LOCAL_SCRIPTS` meant this implicitly was unclear.  I thought it would help make clearer which bits to remove upon removing support for old-style packages which I guess will happen soon anyways.",
    "created_at": "2017-07-12T12:35:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429498",
    "user": "https://github.com/embray"
}
```

<a id='comment:46'></a>
Replying to [jdemeyer](#comment%3A44):
> There is no need for `$PKG_OLD_STYLE` since it is simply the negation of `$USE_LOCAL_SCRIPTS`. So you can replace `[ -z "$PKG_OLD_STYLE" ]` by `[ "$USE_LOCAL_SCRIPTS" = yes ]` and then you don't need the `PKG_OLD_STYLE` variable.


Note: I deliberately added this variable because the fact that `$USE_LOCAL_SCRIPTS` meant this implicitly was unclear.  I thought it would help make clearer which bits to remove upon removing support for old-style packages which I guess will happen soon anyways.



---

archive/issue_comments_429499.json:
```json
{
    "body": "<a id='comment:47'></a>\nReplying to [jdemeyer](#comment%3A45):\n> Replying to [embray](#comment%3A43):\n> > To that end, I can make this depend on #23023 and #23357\n\n> \n> As far as I can see, there should be no conflict with #23357 (it does edit `spkg-install` but in a way that git should merge cleanly).\n\n\nAgreed, and same for a few others on the list, but I wanted to be on the safe side.",
    "created_at": "2017-07-12T12:36:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429499",
    "user": "https://github.com/embray"
}
```

<a id='comment:47'></a>
Replying to [jdemeyer](#comment%3A45):
> Replying to [embray](#comment%3A43):
> > To that end, I can make this depend on #23023 and #23357

> 
> As far as I can see, there should be no conflict with #23357 (it does edit `spkg-install` but in a way that git should merge cleanly).


Agreed, and same for a few others on the list, but I wanted to be on the safe side.



---

archive/issue_comments_429500.json:
```json
{
    "body": "<a id='comment:48'></a>\nReplying to [embray](#comment%3A46):\n> Note: I deliberately added this variable because the fact that `$USE_LOCAL_SCRIPTS` meant this implicitly was unclear.\n\n\nIt's pretty explicit:\n\n```\n##################################################################\n# Extract the package\n##################################################################\n\nif [ \"$USE_LOCAL_SCRIPTS\" = yes ]; then\n    # New-style package\n    ...\nelse\n    # Old-style package (deprecated)\n    ...\nfi\n```\n\nI'm -1 on adding a new variable just because you find that an existing variable has a confusing name. If you don't like the name `USE_LOCAL_SCRIPTS`, you can just change the name everywhere.",
    "created_at": "2017-07-12T12:39:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429500",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:48'></a>
Replying to [embray](#comment%3A46):
> Note: I deliberately added this variable because the fact that `$USE_LOCAL_SCRIPTS` meant this implicitly was unclear.


It's pretty explicit:

```
##################################################################
# Extract the package
##################################################################

if [ "$USE_LOCAL_SCRIPTS" = yes ]; then
    # New-style package
    ...
else
    # Old-style package (deprecated)
    ...
fi
```

I'm -1 on adding a new variable just because you find that an existing variable has a confusing name. If you don't like the name `USE_LOCAL_SCRIPTS`, you can just change the name everywhere.



---

archive/issue_comments_429501.json:
```json
{
    "body": "<a id='comment:49'></a>\nYeah, I see your point.  In retrospect I didn't even understand why it was called \"USE_LOCAL_SCRIPTS\" but I guess that is actually synonymous with \"new-style package\".\n\nI'll just remove the commit that added the new variable and the rest should fall into place.",
    "created_at": "2017-07-12T12:43:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429501",
    "user": "https://github.com/embray"
}
```

<a id='comment:49'></a>
Yeah, I see your point.  In retrospect I didn't even understand why it was called "USE_LOCAL_SCRIPTS" but I guess that is actually synonymous with "new-style package".

I'll just remove the commit that added the new variable and the rest should fall into place.



---

archive/issue_comments_429502.json:
```json
{
    "body": "<a id='comment:50'></a>\nGood! After that, I'll do a (hopefully) final round of testing and then it should be good to go.",
    "created_at": "2017-07-12T12:45:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429502",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:50'></a>
Good! After that, I'll do a (hopefully) final round of testing and then it should be good to go.



---

archive/issue_comments_429503.json:
```json
{
    "body": "<a id='comment:51'></a>\nI don't mind to rebase #23023 on top of this ticket, I think that would be better.",
    "created_at": "2017-07-12T12:46:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429503",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:51'></a>
I don't mind to rebase #23023 on top of this ticket, I think that would be better.



---

archive/issue_comments_429504.json:
```json
{
    "body": "Changing commit from \"8819114afb5494f4f25231fb183fb75b6209e476\" to \"6e322b8079aa01a9720ebc1b67f6056ba4086b9b\"",
    "created_at": "2017-07-12T12:48:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429504",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "8819114afb5494f4f25231fb183fb75b6209e476" to "6e322b8079aa01a9720ebc1b67f6056ba4086b9b"



---

archive/issue_comments_429505.json:
```json
{
    "body": "<a id='comment:52'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                           |                                                                 |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------|\n|[c447855](https://github.com/sagemath/sagetrac-mirror/commit/c447855fc668700246a1118241940bd44919de38)|`Use a heredoc instead of a quoted variable, for clarity's sake.`|\n|[f53ee4d](https://github.com/sagemath/sagetrac-mirror/commit/f53ee4db0e0bfbf72cb6230170d749bcc73b2cff)|`Updated the developer docs to reflect the changes in #23179`|\n|[6e322b8](https://github.com/sagemath/sagetrac-mirror/commit/6e322b8079aa01a9720ebc1b67f6056ba4086b9b)|`Set some variables in the wrapper script itself.`|",
    "created_at": "2017-07-12T12:48:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429505",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:52'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                           |                                                                 |
|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------|
|[c447855](https://github.com/sagemath/sagetrac-mirror/commit/c447855fc668700246a1118241940bd44919de38)|`Use a heredoc instead of a quoted variable, for clarity's sake.`|
|[f53ee4d](https://github.com/sagemath/sagetrac-mirror/commit/f53ee4db0e0bfbf72cb6230170d749bcc73b2cff)|`Updated the developer docs to reflect the changes in #23179`|
|[6e322b8](https://github.com/sagemath/sagetrac-mirror/commit/6e322b8079aa01a9720ebc1b67f6056ba4086b9b)|`Set some variables in the wrapper script itself.`|



---

archive/issue_comments_429506.json:
```json
{
    "body": "<a id='comment:53'></a>\nOkay, done.\n\nI should say, since I wasn't my best self a couple weeks ago, that I always appreciate your meticulous reviews whether or not we agree on everything.",
    "created_at": "2017-07-12T12:49:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429506",
    "user": "https://github.com/embray"
}
```

<a id='comment:53'></a>
Okay, done.

I should say, since I wasn't my best self a couple weeks ago, that I always appreciate your meticulous reviews whether or not we agree on everything.



---

archive/issue_comments_429507.json:
```json
{
    "body": "<a id='comment:54'></a>\nTypo: `neecessarily`",
    "created_at": "2017-07-12T12:52:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429507",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:54'></a>
Typo: `neecessarily`



---

archive/issue_comments_429508.json:
```json
{
    "body": "<a id='comment:55'></a>\nTypo: `enforsed`",
    "created_at": "2017-07-12T12:53:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429508",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:55'></a>
Typo: `enforsed`



---

archive/issue_comments_429509.json:
```json
{
    "body": "Changing commit from \"6e322b8079aa01a9720ebc1b67f6056ba4086b9b\" to \"caf64bfa51ee2d3c9eb3ca9c148bde0ef22e8fd5\"",
    "created_at": "2017-07-12T13:06:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429509",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "6e322b8079aa01a9720ebc1b67f6056ba4086b9b" to "caf64bfa51ee2d3c9eb3ca9c148bde0ef22e8fd5"



---

archive/issue_comments_429510.json:
```json
{
    "body": "<a id='comment:56'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                           |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------|\n|[caf64bf](https://github.com/sagemath/sagetrac-mirror/commit/caf64bfa51ee2d3c9eb3ca9c148bde0ef22e8fd5)|`Fix typos in this comment`|",
    "created_at": "2017-07-12T13:06:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429510",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:56'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                           |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------|
|[caf64bf](https://github.com/sagemath/sagetrac-mirror/commit/caf64bfa51ee2d3c9eb3ca9c148bde0ef22e8fd5)|`Fix typos in this comment`|



---

archive/issue_comments_429511.json:
```json
{
    "body": "<a id='comment:57'></a>\nFor info I have marked #15674 in your list as duplicate since it was superseded by #22817 which was merged.",
    "created_at": "2017-07-12T23:31:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429511",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:57'></a>
For info I have marked #15674 in your list as duplicate since it was superseded by #22817 which was merged.



---

archive/issue_comments_429512.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-07-13T09:55:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429512",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_429513.json:
```json
{
    "body": "<a id='comment:59'></a>\nSetting to blocker to get the attention of the release manager.\n\nVolker: since this touches a lot of files, it would be best to merge this early in Sage 8.1 to avoid conflicts.",
    "created_at": "2017-07-13T10:11:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429513",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:59'></a>
Setting to blocker to get the attention of the release manager.

Volker: since this touches a lot of files, it would be best to merge this early in Sage 8.1 to avoid conflicts.



---

archive/issue_events_075889.json:
```json
{
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "label": "blocker",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23179#event-75889"
}
```



---

archive/issue_events_075890.json:
```json
{
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "label": "blocker",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23179#event-75890"
}
```



---

archive/issue_comments_429514.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-07-23T22:46:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429514",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_429515.json:
```json
{
    "body": "<a id='comment:61'></a>\n\n```\nSuccessfully installed scipy-0.17.1.p0\nRunning the test suite for scipy-0.17.1.p0...\n/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/bin/python2: can't open file 'sage-check.py': [Errno 2] No such file or directory\n```",
    "created_at": "2017-07-23T22:46:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429515",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:61'></a>

```
Successfully installed scipy-0.17.1.p0
Running the test suite for scipy-0.17.1.p0...
/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/bin/python2: can't open file 'sage-check.py': [Errno 2] No such file or directory
```



---

archive/issue_comments_429516.json:
```json
{
    "body": "<a id='comment:62'></a>\nTypo: `sage-check.py` -> `spkg-check.py`",
    "created_at": "2017-07-24T13:46:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429516",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:62'></a>
Typo: `sage-check.py` -> `spkg-check.py`



---

archive/issue_comments_429517.json:
```json
{
    "body": "Changing commit from \"caf64bfa51ee2d3c9eb3ca9c148bde0ef22e8fd5\" to \"9dfaeeb2dcec72608c7cb5eceaecdd554f508132\"",
    "created_at": "2017-07-31T12:07:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429517",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "caf64bfa51ee2d3c9eb3ca9c148bde0ef22e8fd5" to "9dfaeeb2dcec72608c7cb5eceaecdd554f508132"



---

archive/issue_comments_429518.json:
```json
{
    "body": "<a id='comment:63'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                  |\n|-------------------------------------------------------------------------------------------------------------------------------------------|------------------|\n|[9dfaeeb](https://github.com/sagemath/sagetrac-mirror/commit/9dfaeeb2dcec72608c7cb5eceaecdd554f508132)|`Fix obvious typo`|",
    "created_at": "2017-07-31T12:07:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429518",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:63'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                  |
|-------------------------------------------------------------------------------------------------------------------------------------------|------------------|
|[9dfaeeb](https://github.com/sagemath/sagetrac-mirror/commit/9dfaeeb2dcec72608c7cb5eceaecdd554f508132)|`Fix obvious typo`|



---

archive/issue_comments_429519.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2017-07-31T12:08:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429519",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_429520.json:
```json
{
    "body": "<a id='comment:64'></a>\nThis was just a typo as confirmed by Jeroen so I'll set it back to positive review.",
    "created_at": "2017-07-31T12:08:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429520",
    "user": "https://github.com/embray"
}
```

<a id='comment:64'></a>
This was just a typo as confirmed by Jeroen so I'll set it back to positive review.



---

archive/issue_events_075891.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-08-01T22:25:12Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23179#event-75891"
}
```



---

archive/issue_comments_429521.json:
```json
{
    "body": "Changing branch from \"u/embray/build/script-wrappers\" to \"9dfaeeb2dcec72608c7cb5eceaecdd554f508132\"",
    "created_at": "2017-08-01T22:25:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429521",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/embray/build/script-wrappers" to "9dfaeeb2dcec72608c7cb5eceaecdd554f508132"



---

archive/issue_comments_429522.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-08-01T22:25:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429522",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_429523.json:
```json
{
    "body": "<a id='comment:66'></a>\nI just flagged #23498 which was merged at the same time for follow up. Do we have a ticket for mopping up any new/upgrade packages that will trickle in until people are fully aware of the new system? We may have to do a bit of spotting and pre-emptive reviewing for a while.",
    "created_at": "2017-08-01T23:43:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429523",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:66'></a>
I just flagged #23498 which was merged at the same time for follow up. Do we have a ticket for mopping up any new/upgrade packages that will trickle in until people are fully aware of the new system? We may have to do a bit of spotting and pre-emptive reviewing for a while.



---

archive/issue_comments_429524.json:
```json
{
    "body": "Changing commit from \"9dfaeeb2dcec72608c7cb5eceaecdd554f508132\" to \"\"",
    "created_at": "2017-08-01T23:43:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429524",
    "user": "https://github.com/kiwifb"
}
```

Changing commit from "9dfaeeb2dcec72608c7cb5eceaecdd554f508132" to ""



---

archive/issue_comments_429525.json:
```json
{
    "body": "<a id='comment:67'></a>\nI mean, I made a big list of tickets that are affected by this: #23179#comment:45  But #23498 slipped through the cracks.",
    "created_at": "2017-08-07T09:00:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429525",
    "user": "https://github.com/embray"
}
```

<a id='comment:67'></a>
I mean, I made a big list of tickets that are affected by this: #23179#comment:45  But #23498 slipped through the cracks.



---

archive/issue_comments_429526.json:
```json
{
    "body": "<a id='comment:68'></a>\nYes the list of \"older\" ticket is fine. I already warned one upgrade (arb) on rebasing on this ticket before 8.1.beta1 was released. But apart from those one, we need to be careful of new package/upgrade ticket for a while as well.",
    "created_at": "2017-08-07T09:47:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23179#issuecomment-429526",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:68'></a>
Yes the list of "older" ticket is fine. I already warned one upgrade (arb) on rebasing on this ticket before 8.1.beta1 was released. But apart from those one, we need to be careful of new package/upgrade ticket for a while as well.
