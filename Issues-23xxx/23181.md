# Issue 23181: Incorrect implementation of Hasse-Witt matrix for Hyperelliptic Curves

archive/issues_022944.json:
```json
{
    "body": "Currently there are two errors in in the method `HyperellipticCurve._Hasse_Witt_cached()`. \n\nThe first: the function `frob_mat` does not actually apply frobenius to the matrix entries, the current codes follow (comment not be myself)\n {{{\ndef frob_mat(Coeffs, k):\n      a = p ** k\n      mat = []\n      Coeffs_pow = [c ** a for c in Coeffs]  # not used ??\n      for i in range(1, g + 1):\n           H = [(Coeffs[j]) for j in range((p*i-1), (p*i - g-1), -1)]\n           mat.append(H)\n     return matrix(Fq, mat)\n}}}\n\nThe fix is that in the for loop we should have:\n `H = [(Coeffs_pow[j]) for j in range((p*i-1), (p*i - g-1), -1)]`.\n\nThe second mistake relates to an error in the literature used in the implementation (see the attached file). Summary, the matrices are multiplied in the reverse order.\n\n\nExample:\nSee the attached file for details but the sage code to reproduce the error follows.\n\n```\nsage: K.<z>=PolynomialRing(GF(5))\nsage: L.<a>=GF(5).extension(z^3+3*z+3,'a')\nsage: H.<x> = L[]\nsage: E=HyperellipticCurve(x^5+x^4+a^92*x^3+a^18*x^2+a^56*x,0)\nsage: E.p_rank()\n1\n```\n\nRunning the correct code\n\n```\nM, Coeffs, g, Fq, p, E = E._Cartier_matrix_cached()\n\n#This compute the action of p^kth Frobenius  on list of coefficients\ndef frob_mat(Coeffs, k):\n    a = p ** k\n    mat = []\n    Coeffs_pow = [c ** a for c in Coeffs]  # not used ??\n    for i in range(1, g + 1):\n        H = [(Coeffs_pow[j]) for j in range((p*i-1), (p*i - g-1), -1)]\n        mat.append(H)\n    return matrix(Fq, mat)\n\n#Computes all the different possible action of frobenius on matrix M and stores in list Mall\nMall = [M] + [frob_mat(Coeffs, k) for k in range(1, g)]\nMall = list(reversed(Mall))\n#initial N=I, so we can go through Mall and multiply all matrices with I and\n#get the Hasse-Witt matrix.\nN = identity_matrix(Fq, g)\nfor l in Mall:\n    N = N * l\nrank(N)\n}}\nYields 0 as the correct p-rank.\n\nKeywords: sd86.5\n\nBranch/Commit: f0a45cf27ee97701e4fc0477a1235c29496c3538\n\nReviewer: Fr\u00e9d\u00e9ric Chapoton\n\nAuthor: Dean Bisogno\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/23181\n\n",
    "closed_at": "2017-06-12T18:01:51Z",
    "created_at": "2017-06-08T16:56:32Z",
    "labels": [
        "component: number theory",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "Incorrect implementation of Hasse-Witt matrix for Hyperelliptic Curves",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23181",
    "user": "https://trac.sagemath.org/admin/accounts/users/dbisogno"
}
```
Currently there are two errors in in the method `HyperellipticCurve._Hasse_Witt_cached()`. 

The first: the function `frob_mat` does not actually apply frobenius to the matrix entries, the current codes follow (comment not be myself)
 {{{
def frob_mat(Coeffs, k):
      a = p ** k
      mat = []
      Coeffs_pow = [c ** a for c in Coeffs]  # not used ??
      for i in range(1, g + 1):
           H = [(Coeffs[j]) for j in range((p*i-1), (p*i - g-1), -1)]
           mat.append(H)
     return matrix(Fq, mat)
}}}

The fix is that in the for loop we should have:
 `H = [(Coeffs_pow[j]) for j in range((p*i-1), (p*i - g-1), -1)]`.

The second mistake relates to an error in the literature used in the implementation (see the attached file). Summary, the matrices are multiplied in the reverse order.


Example:
See the attached file for details but the sage code to reproduce the error follows.

```
sage: K.<z>=PolynomialRing(GF(5))
sage: L.<a>=GF(5).extension(z^3+3*z+3,'a')
sage: H.<x> = L[]
sage: E=HyperellipticCurve(x^5+x^4+a^92*x^3+a^18*x^2+a^56*x,0)
sage: E.p_rank()
1
```

Running the correct code

```
M, Coeffs, g, Fq, p, E = E._Cartier_matrix_cached()

#This compute the action of p^kth Frobenius  on list of coefficients
def frob_mat(Coeffs, k):
    a = p ** k
    mat = []
    Coeffs_pow = [c ** a for c in Coeffs]  # not used ??
    for i in range(1, g + 1):
        H = [(Coeffs_pow[j]) for j in range((p*i-1), (p*i - g-1), -1)]
        mat.append(H)
    return matrix(Fq, mat)

#Computes all the different possible action of frobenius on matrix M and stores in list Mall
Mall = [M] + [frob_mat(Coeffs, k) for k in range(1, g)]
Mall = list(reversed(Mall))
#initial N=I, so we can go through Mall and multiply all matrices with I and
#get the Hasse-Witt matrix.
N = identity_matrix(Fq, g)
for l in Mall:
    N = N * l
rank(N)
}}
Yields 0 as the correct p-rank.

Keywords: sd86.5

Branch/Commit: f0a45cf27ee97701e4fc0477a1235c29496c3538

Reviewer: Frédéric Chapoton

Author: Dean Bisogno

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/23181





---

archive/issue_comments_320667.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-06-08T17:04:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-320667",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_320668.json:
```json
{
    "body": "<a id='comment:3'></a>Hello,\n\nYou do not need to wrap with list here:\n\n```\n+        Mall = list(reversed(Mall))\n```\nbecause you only want to iterate over that.\n\nAnd you should add a doctest to show that you have fixed something.",
    "created_at": "2017-06-08T18:03:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-320668",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:3'></a>Hello,

You do not need to wrap with list here:

```
+        Mall = list(reversed(Mall))
```
because you only want to iterate over that.

And you should add a doctest to show that you have fixed something.



---

archive/issue_comments_320669.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-06-08T18:32:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-320669",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_320670.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-06-09T00:32:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-320670",
    "user": "https://trac.sagemath.org/admin/accounts/users/dbisogno"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_320671.json:
```json
{
    "body": "<a id='comment:6'></a>I just made some small cosmetic changes to the doc of the method. If you agree with my changes, you can set the ticket to \"positive review\".\n\n---\nNew commits:",
    "created_at": "2017-06-09T16:12:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-320671",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:6'></a>I just made some small cosmetic changes to the doc of the method. If you agree with my changes, you can set the ticket to "positive review".

---
New commits:



---

archive/issue_comments_320672.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-06-09T16:12:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-320672",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_320673.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-06-09T17:22:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-320673",
    "user": "https://trac.sagemath.org/admin/accounts/users/dbisogno"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_059864.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-06-12T18:01:51Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23181#event-59864"
}
```



---

archive/issue_comments_320674.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-06-12T18:01:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-320674",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
