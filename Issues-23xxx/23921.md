# Issue 23921: Expression.__pow__ should try to coerce in both directions

archive/issues_023684.json:
```json
{
    "body": "When computing `symbolic_expression ** something_else`, the result could also live in a common parent of the respective parents, and not necessarily in `SR`. Example, we want:\n\n```\nsage: A.<n> = AsymptoticRing('SR^n * n^SR', SR)\nsage: SR(2)^n\n2^n\n```\n\nCurrently, this code yields\n\n```\nsage: SR(2)^n\nTraceback (most recent call last):\n...\nTypeError: no canonical coercion from Asymptotic Ring <SR^n * n^SR> over Symbolic Ring to Symbolic Ring\n```\n\nCC:  @dkrenn @cheuberg @rwst\n\nBranch/Commit: [acacede3c24c551f067c2291fa72de6a479dd056](https://github.com/sagemath/sagetrac-mirror/commit/acacede3c24c551f067c2291fa72de6a479dd056)\n\nReviewer: Jeroen Demeyer\n\nAuthor: Benjamin Hackl, Daniel Krenn\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/23921\n\n",
    "closed_at": "2017-10-01T00:18:50Z",
    "created_at": "2017-09-22T14:47:15Z",
    "labels": [
        "component: symbolics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Expression.__pow__ should try to coerce in both directions",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23921",
    "user": "https://github.com/behackl"
}
```
When computing `symbolic_expression ** something_else`, the result could also live in a common parent of the respective parents, and not necessarily in `SR`. Example, we want:

```
sage: A.<n> = AsymptoticRing('SR^n * n^SR', SR)
sage: SR(2)^n
2^n
```

Currently, this code yields

```
sage: SR(2)^n
Traceback (most recent call last):
...
TypeError: no canonical coercion from Asymptotic Ring <SR^n * n^SR> over Symbolic Ring to Symbolic Ring
```

CC:  @dkrenn @cheuberg @rwst

Branch/Commit: [acacede3c24c551f067c2291fa72de6a479dd056](https://github.com/sagemath/sagetrac-mirror/commit/acacede3c24c551f067c2291fa72de6a479dd056)

Reviewer: Jeroen Demeyer

Author: Benjamin Hackl, Daniel Krenn

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/23921





---

archive/issue_comments_453929.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-09-22T14:47:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23921#issuecomment-453929",
    "user": "https://github.com/behackl"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_453930.json:
```json
{
    "body": "<a id='comment:2'></a>\nAnd are you sure that you still want to try the \"single-sided\" coercions `base = nexp.coerce_in(self)` and `nexp = base.coerce_in(exp)`? I would try to use code inspired by `Element.__add__`, calling `bin_op` to do the coercion.",
    "created_at": "2017-09-22T14:54:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23921#issuecomment-453930",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>
And are you sure that you still want to try the "single-sided" coercions `base = nexp.coerce_in(self)` and `nexp = base.coerce_in(exp)`? I would try to use code inspired by `Element.__add__`, calling `bin_op` to do the coercion.



---

archive/issue_comments_453931.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-09-22T14:54:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23921#issuecomment-453931",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_453932.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Jeroen Demeyer\"",
    "created_at": "2017-09-22T14:54:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23921#issuecomment-453932",
    "user": "https://github.com/jdemeyer"
}
```

Changing reviewer from "" to "Jeroen Demeyer"



---

archive/issue_comments_453933.json:
```json
{
    "body": "<a id='comment:3'></a>\nReplying to [jdemeyer](#comment%3A2):\n> And are you sure that you still want to try the \"single-sided\" coercions `base = nexp.coerce_in(self)` and `nexp = base.coerce_in(exp)`? I would try to use code inspired by `Element.__add__`, calling `bin_op` to do the coercion.\n\n\nThanks for the hint! I'll have a look at `Element.__add__` and change this branch accordingly.",
    "created_at": "2017-09-22T15:25:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23921#issuecomment-453933",
    "user": "https://github.com/behackl"
}
```

<a id='comment:3'></a>
Replying to [jdemeyer](#comment%3A2):
> And are you sure that you still want to try the "single-sided" coercions `base = nexp.coerce_in(self)` and `nexp = base.coerce_in(exp)`? I would try to use code inspired by `Element.__add__`, calling `bin_op` to do the coercion.


Thanks for the hint! I'll have a look at `Element.__add__` and change this branch accordingly.



---

archive/issue_comments_453934.json:
```json
{
    "body": "<a id='comment:5'></a>\nAlso: the example that motivated this ticket would better become a doctest.",
    "created_at": "2017-09-22T15:44:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23921#issuecomment-453934",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>
Also: the example that motivated this ticket would better become a doctest.



---

archive/issue_comments_453935.json:
```json
{
    "body": "<a id='comment:6'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |             |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-------------|\n|[2f366fd](https://github.com/sagemath/sagetrac-mirror/commit/2f366fdd3943324237ad1bf431284f194a782e70)|`add doctest`|\n|[97dc5a4](https://github.com/sagemath/sagetrac-mirror/commit/97dc5a4d1157fd4a2d6e2e76f8c147617739d695)|`rewrite Expression.__pow__ in the spirit of Element.__add__`|\n|[e8e86a5](https://github.com/sagemath/sagetrac-mirror/commit/e8e86a5a262bbbbe111da994e3fbae0b98c065a8)|`fix doctests with powers involving None`|",
    "created_at": "2017-09-22T16:25:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23921#issuecomment-453935",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |             |
|-------------------------------------------------------------------------------------------------------------------------------------------|-------------|
|[2f366fd](https://github.com/sagemath/sagetrac-mirror/commit/2f366fdd3943324237ad1bf431284f194a782e70)|`add doctest`|
|[97dc5a4](https://github.com/sagemath/sagetrac-mirror/commit/97dc5a4d1157fd4a2d6e2e76f8c147617739d695)|`rewrite Expression.__pow__ in the spirit of Element.__add__`|
|[e8e86a5](https://github.com/sagemath/sagetrac-mirror/commit/e8e86a5a262bbbbe111da994e3fbae0b98c065a8)|`fix doctests with powers involving None`|



---

archive/issue_comments_453936.json:
```json
{
    "body": "Changing commit from \"9b2c939c767daea7d8d7e99e3372845700079e4b\" to \"e8e86a5a262bbbbe111da994e3fbae0b98c065a8\"",
    "created_at": "2017-09-22T16:25:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23921#issuecomment-453936",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "9b2c939c767daea7d8d7e99e3372845700079e4b" to "e8e86a5a262bbbbe111da994e3fbae0b98c065a8"



---

archive/issue_comments_453937.json:
```json
{
    "body": "<a id='comment:7'></a>\n`Expression.__pow__` now behaves a litte bit more like `Element.__add__`, is this (at least approximately) what you intended?",
    "created_at": "2017-09-22T16:28:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23921#issuecomment-453937",
    "user": "https://github.com/behackl"
}
```

<a id='comment:7'></a>
`Expression.__pow__` now behaves a litte bit more like `Element.__add__`, is this (at least approximately) what you intended?



---

archive/issue_comments_453938.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-09-22T16:28:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23921#issuecomment-453938",
    "user": "https://github.com/behackl"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_453939.json:
```json
{
    "body": "<a id='comment:8'></a>\nYes, that is more or less what I had in mind. I'll need to check the details.\n\nIn the doctest `2^n`, could you also show the `parent()` of the result?",
    "created_at": "2017-09-22T16:49:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23921#issuecomment-453939",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>
Yes, that is more or less what I had in mind. I'll need to check the details.

In the doctest `2^n`, could you also show the `parent()` of the result?



---

archive/issue_comments_453940.json:
```json
{
    "body": "Changing commit from \"e8e86a5a262bbbbe111da994e3fbae0b98c065a8\" to \"cbff5f9555ff7e2dfad70b796c6633964f46e405\"",
    "created_at": "2017-09-22T17:06:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23921#issuecomment-453940",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "e8e86a5a262bbbbe111da994e3fbae0b98c065a8" to "cbff5f9555ff7e2dfad70b796c6633964f46e405"



---

archive/issue_comments_453941.json:
```json
{
    "body": "<a id='comment:9'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                          |\n|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------|\n|[cbff5f9](https://github.com/sagemath/sagetrac-mirror/commit/cbff5f9555ff7e2dfad70b796c6633964f46e405)|`show 2^n together with parent in doctest`|",
    "created_at": "2017-09-22T17:06:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23921#issuecomment-453941",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                          |
|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------|
|[cbff5f9](https://github.com/sagemath/sagetrac-mirror/commit/cbff5f9555ff7e2dfad70b796c6633964f46e405)|`show 2^n together with parent in doctest`|



---

archive/issue_comments_453942.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [jdemeyer](#comment%3A8):\n> Yes, that is more or less what I had in mind. I'll need to check the details.\n> \n> In the doctest `2^n`, could you also show the `parent()` of the result?\n\n\nI forgot to comment: sure, done. :-)",
    "created_at": "2017-09-23T16:35:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23921#issuecomment-453942",
    "user": "https://github.com/behackl"
}
```

<a id='comment:10'></a>
Replying to [jdemeyer](#comment%3A8):
> Yes, that is more or less what I had in mind. I'll need to check the details.
> 
> In the doctest `2^n`, could you also show the `parent()` of the result?


I forgot to comment: sure, done. :-)



---

archive/issue_comments_453943.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-09-26T11:19:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23921#issuecomment-453943",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_453944.json:
```json
{
    "body": "<a id='comment:11'></a>\nOK, one more detail: `from sage.structure.element import get_coercion_model` is slow because it's a function and, even worse, a Python function. Better use `from sage.structure.element cimport coercion_model` and use that.",
    "created_at": "2017-09-26T11:19:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23921#issuecomment-453944",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>
OK, one more detail: `from sage.structure.element import get_coercion_model` is slow because it's a function and, even worse, a Python function. Better use `from sage.structure.element cimport coercion_model` and use that.



---

archive/issue_comments_453945.json:
```json
{
    "body": "Changing commit from \"cbff5f9555ff7e2dfad70b796c6633964f46e405\" to \"acacede3c24c551f067c2291fa72de6a479dd056\"",
    "created_at": "2017-09-26T11:53:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23921#issuecomment-453945",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "cbff5f9555ff7e2dfad70b796c6633964f46e405" to "acacede3c24c551f067c2291fa72de6a479dd056"



---

archive/issue_comments_453946.json:
```json
{
    "body": "<a id='comment:12'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                     |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------|\n|[acacede](https://github.com/sagemath/sagetrac-mirror/commit/acacede3c24c551f067c2291fa72de6a479dd056)|`import get_coercion_model -> cimport coercion_model`|",
    "created_at": "2017-09-26T11:53:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23921#issuecomment-453946",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                     |
|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------|
|[acacede](https://github.com/sagemath/sagetrac-mirror/commit/acacede3c24c551f067c2291fa72de6a479dd056)|`import get_coercion_model -> cimport coercion_model`|



---

archive/issue_comments_453947.json:
```json
{
    "body": "<a id='comment:13'></a>\n... changed and now back up for review!",
    "created_at": "2017-09-26T12:04:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23921#issuecomment-453947",
    "user": "https://github.com/behackl"
}
```

<a id='comment:13'></a>
... changed and now back up for review!



---

archive/issue_comments_453948.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-09-26T12:04:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23921#issuecomment-453948",
    "user": "https://github.com/behackl"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_453949.json:
```json
{
    "body": "<a id='comment:14'></a>\npositive_review if the patchbot is happy.",
    "created_at": "2017-09-26T13:10:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23921#issuecomment-453949",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>
positive_review if the patchbot is happy.



---

archive/issue_comments_453950.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-09-28T19:19:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23921#issuecomment-453950",
    "user": "https://github.com/dkrenn"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_069226.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-10-01T00:18:50Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23921",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23921#event-69226"
}
```



---

archive/issue_comments_453951.json:
```json
{
    "body": "Changing branch from \"u/behackl/symbolic/power_coercion\" to \"acacede3c24c551f067c2291fa72de6a479dd056\"",
    "created_at": "2017-10-01T00:18:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23921#issuecomment-453951",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/behackl/symbolic/power_coercion" to "acacede3c24c551f067c2291fa72de6a479dd056"



---

archive/issue_comments_453952.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-10-01T00:18:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23921#issuecomment-453952",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
