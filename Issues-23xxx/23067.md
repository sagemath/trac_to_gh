# Issue 23067: Upgrade R to 3.4.0

archive/issues_022830.json:
```json
{
    "assignees": [],
    "body": "Usual reasons (working on an u-to-date R is a prerequisite to get answers from the R Core Team on r-help...)\n\nThe new upstream version has been released almost a month ago.\n\nUpstream tarball : [https://cran.r-project.org/src/base/R-3/R-3.4.0.tar.gz](https://cran.r-project.org/src/base/R-3/R-3.4.0.tar.gz)\n\n\nDepends on #23291\n\n**CC:**  @embray jpflori\n\n**Keywords:** r-project\n\n**Branch/Commit:** [344d1403b7e2d1210978974887aabaa16466e0ac](https://github.com/sagemath/sagetrac-mirror/commit/344d1403b7e2d1210978974887aabaa16466e0ac)\n\n**Reviewer:** Erik Bray\n\n**Author:** Emmanuel Charpentier\n\nIssue created by migration from https://trac.sagemath.org/ticket/23067\n\n",
    "closed_at": "2017-06-25T15:45:21Z",
    "created_at": "2017-05-24T04:55:37Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20packages%3A%20standard",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.0",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Upgrade R to 3.4.0",
    "type": "issue",
    "updated_at": "2017-06-25T15:45:21Z",
    "url": "https://github.com/sagemath/sage/issues/23067",
    "user": "https://github.com/EmmanuelCharpentier"
}
```
Usual reasons (working on an u-to-date R is a prerequisite to get answers from the R Core Team on r-help...)

The new upstream version has been released almost a month ago.

Upstream tarball : [https://cran.r-project.org/src/base/R-3/R-3.4.0.tar.gz](https://cran.r-project.org/src/base/R-3/R-3.4.0.tar.gz)


Depends on #23291

**CC:**  @embray jpflori

**Keywords:** r-project

**Branch/Commit:** [344d1403b7e2d1210978974887aabaa16466e0ac](https://github.com/sagemath/sagetrac-mirror/commit/344d1403b7e2d1210978974887aabaa16466e0ac)

**Reviewer:** Erik Bray

**Author:** Emmanuel Charpentier

Issue created by migration from https://trac.sagemath.org/ticket/23067





---

archive/issue_events_279307.json:
```json
{
    "actor": "https://github.com/EmmanuelCharpentier",
    "created_at": "2017-05-24T04:55:37Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "milestone_number": null,
    "milestone_title": "sage-8.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23067#event-279307"
}
```



---

archive/issue_events_279308.json:
```json
{
    "actor": "https://github.com/EmmanuelCharpentier",
    "created_at": "2017-05-24T04:55:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20packages%3A%20standard",
    "label_color": "08517b",
    "label_name": "component: packages: standard",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23067#event-279308"
}
```



---

archive/issue_events_279309.json:
```json
{
    "actor": "https://github.com/EmmanuelCharpentier",
    "created_at": "2017-05-24T04:55:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "008080",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23067#event-279309"
}
```



---

archive/issue_comments_348004.json:
```json
{
    "body": "**Branch:** [u/charpent/R340](https://github.com/sagemath/sagetrac-mirror/tree/u/charpent/R340)",
    "created_at": "2017-05-24T04:56:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23067#issuecomment-348004",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

**Branch:** [u/charpent/R340](https://github.com/sagemath/sagetrac-mirror/tree/u/charpent/R340)



---

archive/issue_comments_348005.json:
```json
{
    "body": "**Author:** Emmanuel Charpentier",
    "created_at": "2017-05-24T05:00:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23067#issuecomment-348005",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

**Author:** Emmanuel Charpentier



---

archive/issue_comments_348006.json:
```json
{
    "body": "**Commit:** [344d1403b7e2d1210978974887aabaa16466e0ac](https://github.com/sagemath/sagetrac-mirror/commit/344d1403b7e2d1210978974887aabaa16466e0ac)",
    "created_at": "2017-05-24T05:00:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23067#issuecomment-348006",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

**Commit:** [344d1403b7e2d1210978974887aabaa16466e0ac](https://github.com/sagemath/sagetrac-mirror/commit/344d1403b7e2d1210978974887aabaa16466e0ac)



---

archive/issue_events_279310.json:
```json
{
    "actor": "https://github.com/EmmanuelCharpentier",
    "created_at": "2017-05-24T05:00:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23067#event-279310"
}
```



---

archive/issue_comments_348007.json:
```json
{
    "body": "<a id='comment:2'></a>\nMerged with #22989 (which `needs_review`, BTW), passes `ptestlong` with the usual transient failure `sage -t --long src/sage/homology/simplicial_complex.py  # 1 doctest failed`, which passes when run standalone.\n\n==>`needs_review`\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/344d1403b7e2d1210978974887aabaa16466e0ac\">344d140</a></td><td><code>R 3.4.0 : dropped new source in place, fixed patches.</code></td></tr></table>\n",
    "created_at": "2017-05-24T05:00:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23067#issuecomment-348007",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:2'></a>
Merged with #22989 (which `needs_review`, BTW), passes `ptestlong` with the usual transient failure `sage -t --long src/sage/homology/simplicial_complex.py  # 1 doctest failed`, which passes when run standalone.

==>`needs_review`

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/344d1403b7e2d1210978974887aabaa16466e0ac">344d140</a></td><td><code>R 3.4.0 : dropped new source in place, fixed patches.</code></td></tr></table>




---

archive/issue_comments_348008.json:
```json
{
    "body": "<a id='comment:3'></a>\nNote : I am not sure that we are still justified to keep `patches/libcurl_https_support.patch`, which drops upstream's requirement of https support in libcurl.\n\nThis is unnecessary on Linux. I seem to remember that this was introduced to ease cygwin and/or OS/X compilation. Is that still the case ?",
    "created_at": "2017-05-24T05:07:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23067#issuecomment-348008",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:3'></a>
Note : I am not sure that we are still justified to keep `patches/libcurl_https_support.patch`, which drops upstream's requirement of https support in libcurl.

This is unnecessary on Linux. I seem to remember that this was introduced to ease cygwin and/or OS/X compilation. Is that still the case ?



---

archive/issue_comments_348009.json:
```json
{
    "body": "<a id='comment:4'></a>\nForgot to add : This R passes its own test suite (`sage -f -c r` succeeds, i. e. some failures are expected).\n\nNote that in order to pass it, you HAVE to have en_GB.utf8 configured in your locales. This is also true of the original unpatched R. Note also that the test suite passes much more slowly in Sage than it does on the original unpatched R ; I do not yet know why.",
    "created_at": "2017-05-24T06:42:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23067#issuecomment-348009",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:4'></a>
Forgot to add : This R passes its own test suite (`sage -f -c r` succeeds, i. e. some failures are expected).

Note that in order to pass it, you HAVE to have en_GB.utf8 configured in your locales. This is also true of the original unpatched R. Note also that the test suite passes much more slowly in Sage than it does on the original unpatched R ; I do not yet know why.



---

archive/issue_comments_348010.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -2,4 +2,5 @@\n \n The new upstream version has been released almost a month ago.\n \n+Upstream tarball : [https://cran.r-project.org/src/base/R-3/R-3.4.0.tar.gz](https://cran.r-project.org/src/base/R-3/R-3.4.0.tar.gz)\n \n``````\n",
    "created_at": "2017-05-27T06:53:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23067#issuecomment-348010",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -2,4 +2,5 @@
 
 The new upstream version has been released almost a month ago.
 
+Upstream tarball : [https://cran.r-project.org/src/base/R-3/R-3.4.0.tar.gz](https://cran.r-project.org/src/base/R-3/R-3.4.0.tar.gz)
 
``````




---

archive/issue_comments_348011.json:
```json
{
    "body": "<a id='comment:5'></a>\nWups ! Forgot to point to the upstream tarball...  Fixed now.",
    "created_at": "2017-05-27T06:53:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23067#issuecomment-348011",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:5'></a>
Wups ! Forgot to point to the upstream tarball...  Fixed now.



---

archive/issue_comments_348012.json:
```json
{
    "body": "<a id='comment:6'></a>\nReplying to [@EmmanuelCharpentier](#comment%3A3):\n> Note : I am not sure that we are still justified to keep `patches/libcurl_https_support.patch`, which drops upstream's requirement of https support in libcurl.\n> \n> This is unnecessary on Linux. I seem to remember that this was introduced to ease cygwin and/or OS/X compilation. Is that still the case ?\n\nI guess so. Did anything change upstream?\nI cannot see anything relevant in the changelog.",
    "created_at": "2017-05-30T10:23:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23067#issuecomment-348012",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:6'></a>
Replying to [@EmmanuelCharpentier](#comment%3A3):
> Note : I am not sure that we are still justified to keep `patches/libcurl_https_support.patch`, which drops upstream's requirement of https support in libcurl.
> 
> This is unnecessary on Linux. I seem to remember that this was introduced to ease cygwin and/or OS/X compilation. Is that still the case ?

I guess so. Did anything change upstream?
I cannot see anything relevant in the changelog.



---

archive/issue_comments_348013.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-Usual reasons (working on an u-to-date R is a perequirement to get answers from the R Core Team on r-help...)\n+Usual reasons (working on an u-to-date R is a prerequisite to get answers from the R Core Team on r-help...)\n \n The new upstream version has been released almost a month ago.\n \n``````\n",
    "created_at": "2017-06-04T21:53:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23067#issuecomment-348013",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-Usual reasons (working on an u-to-date R is a perequirement to get answers from the R Core Team on r-help...)
+Usual reasons (working on an u-to-date R is a prerequisite to get answers from the R Core Team on r-help...)
 
 The new upstream version has been released almost a month ago.
 
``````




---

archive/issue_events_279311.json:
```json
{
    "actor": "https://github.com/EmmanuelCharpentier",
    "created_at": "2017-06-04T21:53:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23067#event-279311"
}
```



---

archive/issue_events_279312.json:
```json
{
    "actor": "https://github.com/EmmanuelCharpentier",
    "created_at": "2017-06-04T21:53:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23067#event-279312"
}
```



---

archive/issue_comments_348014.json:
```json
{
    "body": "<a id='comment:7'></a>\nThis installs cleanly on Debian testing and on Ubuntu-over-WSL, but fails to install on cygwin. Reason nunuderstandable (the installation of the recommended packages \"stats\" seems to need under Cygwin  a post-compilation step unneeded on Linux, which fails : rebasing needed ?)\n\n==> `needs_work`\n\nHelp needed from people knowing cygwin better than I do.\n\nAlso : no news from the Maoc OS X front (I don't have that in my zoo...), and Apple's shenanigans with SSL have caused trouble for R in the past...",
    "created_at": "2017-06-04T21:53:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23067#issuecomment-348014",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:7'></a>
This installs cleanly on Debian testing and on Ubuntu-over-WSL, but fails to install on cygwin. Reason nunuderstandable (the installation of the recommended packages "stats" seems to need under Cygwin  a post-compilation step unneeded on Linux, which fails : rebasing needed ?)

==> `needs_work`

Help needed from people knowing cygwin better than I do.

Also : no news from the Maoc OS X front (I don't have that in my zoo...), and Apple's shenanigans with SSL have caused trouble for R in the past...



---

archive/issue_comments_348015.json:
```json
{
    "body": "<a id='comment:8'></a>\nI'm having a look at the Cygwin build issue.",
    "created_at": "2017-06-20T12:25:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23067#issuecomment-348015",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>
I'm having a look at the Cygwin build issue.



---

archive/issue_comments_348016.json:
```json
{
    "body": "<a id='comment:9'></a>\nFWIW the failure I get is:\n\n```\n[r-3.4.0.p0] make[7]: Entering directory '/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/r-3.4.0.p0/src/src/library/stats'\n[r-3.4.0.p0] byte-compiling package 'stats'\n[r-3.4.0.p0] Error in loadNamespace(j <- i[[1L]], c(lib.loc, .libPaths()), versionCheck = vI[[j]]) :\n[r-3.4.0.p0]   object 'vI' not found\n[r-3.4.0.p0] Calls: <Anonymous> ... namespaceImportFrom -> asNamespace -> loadNamespace\n[r-3.4.0.p0] Execution halted\n[r-3.4.0.p0] make[7]: *** [../../../share/make/lazycomp.mk:9: ../../../library/stats/R/stats.rdb] Error 1\n```\n\nNo idea what any of this means.  Still investigating.",
    "created_at": "2017-06-20T13:28:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23067#issuecomment-348016",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>
FWIW the failure I get is:

```
[r-3.4.0.p0] make[7]: Entering directory '/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/r-3.4.0.p0/src/src/library/stats'
[r-3.4.0.p0] byte-compiling package 'stats'
[r-3.4.0.p0] Error in loadNamespace(j <- i[[1L]], c(lib.loc, .libPaths()), versionCheck = vI[[j]]) :
[r-3.4.0.p0]   object 'vI' not found
[r-3.4.0.p0] Calls: <Anonymous> ... namespaceImportFrom -> asNamespace -> loadNamespace
[r-3.4.0.p0] Execution halted
[r-3.4.0.p0] make[7]: *** [../../../share/make/lazycomp.mk:9: ../../../library/stats/R/stats.rdb] Error 1
```

No idea what any of this means.  Still investigating.



---

archive/issue_comments_348017.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [@embray](#comment%3A9):\n> FWIW the failure I get is:\n> \n> ```\n> [r-3.4.0.p0] make[7]: Entering directory '/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/r-3.4.0.p0/src/src/library/stats'\n> [r-3.4.0.p0] byte-compiling package 'stats'\n> [r-3.4.0.p0] Error in loadNamespace(j <- i[[1L]], c(lib.loc, .libPaths()), versionCheck = vI[[j]]) :\n> [r-3.4.0.p0]   object 'vI' not found\n> [r-3.4.0.p0] Calls: <Anonymous> ... namespaceImportFrom -> asNamespace -> loadNamespace\n> [r-3.4.0.p0] Execution halted\n> [r-3.4.0.p0] make[7]: *** [../../../share/make/lazycomp.mk:9: ../../../library/stats/R/stats.rdb] Error 1\n> ```\n\nThat's *exactly* the error I got (see the logs I sent ~ one week ago...).\n\n> No idea what any of this means.\n\nNeither do I. ISTR that I *thought* it might be a rebasing problem, but I can't remember how I went to this guess, nor what was its rationale...\n\n> Still investigating.\n\nThank you *very much* : I'm out of my depth, here...",
    "created_at": "2017-06-20T13:43:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23067#issuecomment-348017",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:10'></a>
Replying to [@embray](#comment%3A9):
> FWIW the failure I get is:
> 
> ```
> [r-3.4.0.p0] make[7]: Entering directory '/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/r-3.4.0.p0/src/src/library/stats'
> [r-3.4.0.p0] byte-compiling package 'stats'
> [r-3.4.0.p0] Error in loadNamespace(j <- i[[1L]], c(lib.loc, .libPaths()), versionCheck = vI[[j]]) :
> [r-3.4.0.p0]   object 'vI' not found
> [r-3.4.0.p0] Calls: <Anonymous> ... namespaceImportFrom -> asNamespace -> loadNamespace
> [r-3.4.0.p0] Execution halted
> [r-3.4.0.p0] make[7]: *** [../../../share/make/lazycomp.mk:9: ../../../library/stats/R/stats.rdb] Error 1
> ```

That's *exactly* the error I got (see the logs I sent ~ one week ago...).

> No idea what any of this means.

Neither do I. ISTR that I *thought* it might be a rebasing problem, but I can't remember how I went to this guess, nor what was its rationale...

> Still investigating.

Thank you *very much* : I'm out of my depth, here...



---

archive/issue_comments_348018.json:
```json
{
    "body": "<a id='comment:11'></a>\nWell for starters there's a bug in R here.  The `object 'vI' not found` is referring to a variable that is defined [here](https://github.com/wch/r-source/blob/R-3-4-branch/src/library/base/R/namespace.R#L375), in a branch that is not being entered because the \"package.rds\" file, whatever that is, doesn't exist.  There's even a comment that reads:\n\n```\n        ## Can we rely on the existence of R-ng 'nsInfo.rds' and\n        ## 'package.rds'?\n        ## No, not during builds of standard packages\n        ## stats4 depends on methods, but exports do not matter\n```\n\nI don't fully know what that means, but we are in fact building a standard package (the \"stats\" package) so this file, apparently, isn't guaranteed to exist.  The fact that later code uses a variable that isn't guaranteed to be defined is a bug.\n\nWhy this is being a problem on Cygwin and not on other platforms I don't know.",
    "created_at": "2017-06-20T14:30:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23067#issuecomment-348018",
    "user": "https://github.com/embray"
}
```

<a id='comment:11'></a>
Well for starters there's a bug in R here.  The `object 'vI' not found` is referring to a variable that is defined [here](https://github.com/wch/r-source/blob/R-3-4-branch/src/library/base/R/namespace.R#L375), in a branch that is not being entered because the "package.rds" file, whatever that is, doesn't exist.  There's even a comment that reads:

```
        ## Can we rely on the existence of R-ng 'nsInfo.rds' and
        ## 'package.rds'?
        ## No, not during builds of standard packages
        ## stats4 depends on methods, but exports do not matter
```

I don't fully know what that means, but we are in fact building a standard package (the "stats" package) so this file, apparently, isn't guaranteed to exist.  The fact that later code uses a variable that isn't guaranteed to be defined is a bug.

Why this is being a problem on Cygwin and not on other platforms I don't know.



---

archive/issue_comments_348019.json:
```json
{
    "body": "<a id='comment:12'></a>\nSo on Linux I'm able to reproduce this bug by going into the built source, rm'ing `src/library/stats/Meta/package.rds` and then running `tools:::makeLazyLoading(\"stats\")`.  What's interesting is that on Linux the \"package.rds\" file *does* exist by this stage in the build process, whereas it does not on Cygwin.  The comment I quoted that \"package.rds\" should not be relied on for builds of standard packages seems to contradict the current state of things.\n\nNow just need to figure out where \"package.rds\" gets generated and see why that's not happening on Cygwin.",
    "created_at": "2017-06-20T14:48:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23067#issuecomment-348019",
    "user": "https://github.com/embray"
}
```

<a id='comment:12'></a>
So on Linux I'm able to reproduce this bug by going into the built source, rm'ing `src/library/stats/Meta/package.rds` and then running `tools:::makeLazyLoading("stats")`.  What's interesting is that on Linux the "package.rds" file *does* exist by this stage in the build process, whereas it does not on Cygwin.  The comment I quoted that "package.rds" should not be relied on for builds of standard packages seems to contradict the current state of things.

Now just need to figure out where "package.rds" gets generated and see why that's not happening on Cygwin.



---

archive/issue_comments_348020.json:
```json
{
    "body": "<a id='comment:13'></a>\nWell this escalated quickly.  Turns out the \"package.rds\" files were not being written due to a segfault occurring during their processing, in the `strsplit` function.  The following snippet reproduces: `strsplit(\"Package\", \"\\n[ \\t\\n]*\\n\", perl = TRUE)`.  It doesn't segfault with `perl = FALSE`.\n\nEven worse, for some reason R's SIGSEGV handler isn't working and it causes R to exit with a zero return code, indicating success.  Weirdly, when I try to find out what was up with that, it seems like something is going horribly wrong in the signal handling.  When I try to run it in gdb it seems like R's SIGSEGV handler is not being called at all.  But when I run the process through strace, its SIGSEGV handler *is* called.  So there's some shenanigans with the signal stack going on.\n\nFinally, this doesn't break R's `make` because the target that generates these \"package.rds\" files is just a phony target called `mkdesc`, and the files it outputs are not specified anywhere as real prerequisites, so as far as `make` is concerned this rule succeeded an it proceeds under that assumption.",
    "created_at": "2017-06-20T15:25:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23067#issuecomment-348020",
    "user": "https://github.com/embray"
}
```

<a id='comment:13'></a>
Well this escalated quickly.  Turns out the "package.rds" files were not being written due to a segfault occurring during their processing, in the `strsplit` function.  The following snippet reproduces: `strsplit("Package", "\n[ \t\n]*\n", perl = TRUE)`.  It doesn't segfault with `perl = FALSE`.

Even worse, for some reason R's SIGSEGV handler isn't working and it causes R to exit with a zero return code, indicating success.  Weirdly, when I try to find out what was up with that, it seems like something is going horribly wrong in the signal handling.  When I try to run it in gdb it seems like R's SIGSEGV handler is not being called at all.  But when I run the process through strace, its SIGSEGV handler *is* called.  So there's some shenanigans with the signal stack going on.

Finally, this doesn't break R's `make` because the target that generates these "package.rds" files is just a phony target called `mkdesc`, and the files it outputs are not specified anywhere as real prerequisites, so as far as `make` is concerned this rule succeeded an it proceeds under that assumption.



---

archive/issue_comments_348021.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [@embray](#comment%3A13):\n> Well this escalated quickly.  Turns out the \"package.rds\" files were not being written due to a segfault occurring during their processing, in the `strsplit` function.  The following snippet reproduces: `strsplit(\"Package\", \"\\n[ \\t\\n]*\\n\", perl = TRUE)`.  It doesn't segfault with `perl = FALSE`.\n\nDoes this happen\na. on Cygwin only, or\nb. on Linux also ?\n\n> Even worse, for some reason R's SIGSEGV handler isn't working and it causes R to exit with a zero return code, indicating success.  Weirdly, when I try to find out what was up with that, it seems like something is going horribly wrong in the signal handling.  When I try to run it in gdb it seems like R's SIGSEGV handler is not being called at all.  But when I run the process through strace, its SIGSEGV handler *is* called.  So there's some shenanigans with the signal stack going on.\n\nSame question : is this Cygwin-specific, or can it be reproduced on Linux (the successful compilation of R being just an happenstance) ?\n\n> Finally, this doesn't break R's `make` because the target that generates these \"package.rds\" files is just a phony target called `mkdesc`, and the files it outputs are not specified anywhere as real prerequisites, so as far as `make` is concerned this rule succeeded an it proceeds under that assumption.\n\n**This** is a bug, notwithstanding it gets triggered on Linux or not. Don't you think that it should be reported upstream ?",
    "created_at": "2017-06-20T15:36:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23067#issuecomment-348021",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:14'></a>
Replying to [@embray](#comment%3A13):
> Well this escalated quickly.  Turns out the "package.rds" files were not being written due to a segfault occurring during their processing, in the `strsplit` function.  The following snippet reproduces: `strsplit("Package", "\n[ \t\n]*\n", perl = TRUE)`.  It doesn't segfault with `perl = FALSE`.

Does this happen
a. on Cygwin only, or
b. on Linux also ?

> Even worse, for some reason R's SIGSEGV handler isn't working and it causes R to exit with a zero return code, indicating success.  Weirdly, when I try to find out what was up with that, it seems like something is going horribly wrong in the signal handling.  When I try to run it in gdb it seems like R's SIGSEGV handler is not being called at all.  But when I run the process through strace, its SIGSEGV handler *is* called.  So there's some shenanigans with the signal stack going on.

Same question : is this Cygwin-specific, or can it be reproduced on Linux (the successful compilation of R being just an happenstance) ?

> Finally, this doesn't break R's `make` because the target that generates these "package.rds" files is just a phony target called `mkdesc`, and the files it outputs are not specified anywhere as real prerequisites, so as far as `make` is concerned this rule succeeded an it proceeds under that assumption.

**This** is a bug, notwithstanding it gets triggered on Linux or not. Don't you think that it should be reported upstream ?



---

archive/issue_comments_348022.json:
```json
{
    "body": "<a id='comment:15'></a>\nI agree, the latter issue is a bug, as is the potentially undefined variable I mentioned earlier.\n\nThe other two issues seem to be Cygwin specific.  R is using `signaltstack` for its `SIGSEGV` handling, which Cygwin *does* support, but I haven't seen too many programs that use this, so it could be buggy.  That's sort of a tangential issue though--the real problem is the segfault itself, which I will investigate now.",
    "created_at": "2017-06-20T15:44:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23067#issuecomment-348022",
    "user": "https://github.com/embray"
}
```

<a id='comment:15'></a>
I agree, the latter issue is a bug, as is the potentially undefined variable I mentioned earlier.

The other two issues seem to be Cygwin specific.  R is using `signaltstack` for its `SIGSEGV` handling, which Cygwin *does* support, but I haven't seen too many programs that use this, so it could be buggy.  That's sort of a tangential issue though--the real problem is the segfault itself, which I will investigate now.



---

archive/issue_comments_348023.json:
```json
{
    "body": "<a id='comment:16'></a>\nWell I can't do anything more with this today.  I've traced the segfault to somewhere deep inside the `pcre_exec` function.  So I'm going to see if I can reproduce a simple example of this outside of R.   That would give us a better idea if it was just an issue with rebase or not.  I suspect not, because if were you wouldn't typically just get a segfault, but who knows.  More likely, since Sage compiles its own libpcre, I wouldn't be surprised if there's a bug in there somewhere.",
    "created_at": "2017-06-20T16:12:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23067#issuecomment-348023",
    "user": "https://github.com/embray"
}
```

<a id='comment:16'></a>
Well I can't do anything more with this today.  I've traced the segfault to somewhere deep inside the `pcre_exec` function.  So I'm going to see if I can reproduce a simple example of this outside of R.   That would give us a better idea if it was just an issue with rebase or not.  I suspect not, because if were you wouldn't typically just get a segfault, but who knows.  More likely, since Sage compiles its own libpcre, I wouldn't be surprised if there's a bug in there somewhere.



---

archive/issue_comments_348024.json:
```json
{
    "body": "<a id='comment:17'></a>\nThere's a patch from Cygwin that purports to fix the segfault in pcre.  I'm trying it out now.",
    "created_at": "2017-06-21T08:31:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23067#issuecomment-348024",
    "user": "https://github.com/embray"
}
```

<a id='comment:17'></a>
There's a patch from Cygwin that purports to fix the segfault in pcre.  I'm trying it out now.



---

archive/issue_comments_348025.json:
```json
{
    "body": "<a id='comment:18'></a>\nI should add, the bug causing the segfault makes such a mess of the stack that it *probably* explains why the segfault wasn't being handled properly either, though I haven't examined the specifics closely, and it's probably not worth the trouble to.",
    "created_at": "2017-06-21T08:39:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23067#issuecomment-348025",
    "user": "https://github.com/embray"
}
```

<a id='comment:18'></a>
I should add, the bug causing the segfault makes such a mess of the stack that it *probably* explains why the segfault wasn't being handled properly either, though I haven't examined the specifics closely, and it's probably not worth the trouble to.



---

archive/issue_comments_348026.json:
```json
{
    "body": "**Dependencies:** #23291",
    "created_at": "2017-06-21T08:51:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23067#issuecomment-348026",
    "user": "https://github.com/embray"
}
```

**Dependencies:** #23291



---

archive/issue_comments_348027.json:
```json
{
    "body": "<a id='comment:19'></a>\nAdded #23291, which seems to fix the immediate build issue on Cygwin.  Still needs to test that the package actually *works*.",
    "created_at": "2017-06-21T08:51:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23067#issuecomment-348027",
    "user": "https://github.com/embray"
}
```

<a id='comment:19'></a>
Added #23291, which seems to fix the immediate build issue on Cygwin.  Still needs to test that the package actually *works*.



---

archive/issue_comments_348028.json:
```json
{
    "body": "<a id='comment:20'></a>\nWell, the R interpreter at least starts up fine and seems to work.  That doesn't mean it's free of bugs, but the spkg-check for R is already known to have failures (#22866) so I think any other problems are outside the scope of this ticket, so long as it *builds*.",
    "created_at": "2017-06-21T08:55:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23067#issuecomment-348028",
    "user": "https://github.com/embray"
}
```

<a id='comment:20'></a>
Well, the R interpreter at least starts up fine and seems to work.  That doesn't mean it's free of bugs, but the spkg-check for R is already known to have failures (#22866) so I think any other problems are outside the scope of this ticket, so long as it *builds*.



---

archive/issue_comments_348029.json:
```json
{
    "body": "<a id='comment:21'></a>\nI support this statement.",
    "created_at": "2017-06-21T08:56:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23067#issuecomment-348029",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:21'></a>
I support this statement.



---

archive/issue_comments_348030.json:
```json
{
    "body": "<a id='comment:22'></a>\nDo you (embray, jpflori) think that #23067+23291 is ready for review ? (BTW, #23291 is already at `positive_review`).\n\nIf so, I can do that tonight.",
    "created_at": "2017-06-21T09:25:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23067#issuecomment-348030",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:22'></a>
Do you (embray, jpflori) think that #23067+23291 is ready for review ? (BTW, #23291 is already at `positive_review`).

If so, I can do that tonight.



---

archive/issue_comments_348031.json:
```json
{
    "body": "<a id='comment:23'></a>\nIt looks good to me.  I'm not sure what you're saying you'll do tonight though.",
    "created_at": "2017-06-21T09:28:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23067#issuecomment-348031",
    "user": "https://github.com/embray"
}
```

<a id='comment:23'></a>
It looks good to me.  I'm not sure what you're saying you'll do tonight though.



---

archive/issue_comments_348032.json:
```json
{
    "body": "**Reviewer:** Erik Bray",
    "created_at": "2017-06-21T09:28:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23067#issuecomment-348032",
    "user": "https://github.com/embray"
}
```

**Reviewer:** Erik Bray



---

archive/issue_events_279313.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-06-21T09:28:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23067#event-279313"
}
```



---

archive/issue_events_279314.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-06-21T09:28:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23067#event-279314"
}
```



---

archive/issue_comments_348033.json:
```json
{
    "body": "**Changing reviewer** from \"Erik Bray\" to \"\".",
    "created_at": "2017-06-21T09:33:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23067#issuecomment-348033",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

**Changing reviewer** from "Erik Bray" to "".



---

archive/issue_comments_348034.json:
```json
{
    "body": "<a id='comment:24'></a>\nBTW : are you aware of a Mac user who might be solicited to test this on Mac OS X : Apple's shenanigans wit SLL (an, more generally, Xcode) has caused touble in the past...\n\nDima Pasechnik comes to mind, but seems awfukly busy nowadays...\n\nReplying to [@EmmanuelCharpentier](#comment%3A22):\n> Do you (embray, jpflori) think that #23067+23291 is ready for review ? (BTW, #23291 is already at `positive_review`).\n> \n> If so, I can do that tonight.",
    "created_at": "2017-06-21T09:33:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23067#issuecomment-348034",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:24'></a>
BTW : are you aware of a Mac user who might be solicited to test this on Mac OS X : Apple's shenanigans wit SLL (an, more generally, Xcode) has caused touble in the past...

Dima Pasechnik comes to mind, but seems awfukly busy nowadays...

Replying to [@EmmanuelCharpentier](#comment%3A22):
> Do you (embray, jpflori) think that #23067+23291 is ready for review ? (BTW, #23291 is already at `positive_review`).
> 
> If so, I can do that tonight.



---

archive/issue_comments_348035.json:
```json
{
    "body": "**Reviewer:** Erik Bray",
    "created_at": "2017-06-21T09:38:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23067#issuecomment-348035",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

**Reviewer:** Erik Bray



---

archive/issue_comments_348036.json:
```json
{
    "body": "<a id='comment:25'></a>\nReplying to [@embray](#comment%3A23):\n> It looks good to me.  I'm not sure what you're saying you'll do tonight though.\n\nJust checking that starting from a fresh VM, I can obtain a working system (and install a few dozen R packages I happen to use more or less constantly).\n\nBut I agree that's just kicking the tyres... I also think that a similar tyre-kicking might be useful on Macs.\n\nNB : the deletion of \"Reviewer\" has been done by Trac, not by me ! Setting it back.",
    "created_at": "2017-06-21T09:38:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23067#issuecomment-348036",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:25'></a>
Replying to [@embray](#comment%3A23):
> It looks good to me.  I'm not sure what you're saying you'll do tonight though.

Just checking that starting from a fresh VM, I can obtain a working system (and install a few dozen R packages I happen to use more or less constantly).

But I agree that's just kicking the tyres... I also think that a similar tyre-kicking might be useful on Macs.

NB : the deletion of "Reviewer" has been done by Trac, not by me ! Setting it back.



---

archive/issue_comments_348037.json:
```json
{
    "body": "**Changing branch** from \"[u/charpent/R340](https://github.com/sagemath/sagetrac-mirror/tree/u/charpent/R340)\" to \"[344d1403b7e2d1210978974887aabaa16466e0ac](https://github.com/sagemath/sagetrac-mirror/commit/344d1403b7e2d1210978974887aabaa16466e0ac)\".",
    "created_at": "2017-06-25T15:45:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/23067#issuecomment-348037",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/charpent/R340](https://github.com/sagemath/sagetrac-mirror/tree/u/charpent/R340)" to "[344d1403b7e2d1210978974887aabaa16466e0ac](https://github.com/sagemath/sagetrac-mirror/commit/344d1403b7e2d1210978974887aabaa16466e0ac)".



---

archive/issue_events_279315.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-06-25T15:45:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23067#event-279315"
}
```



---

archive/issue_events_279316.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "1e5f842f5e8881989b3a35eea0688f108dea298f",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2017-06-25T15:45:21Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/23067",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/23067#event-279316"
}
```
