# Issue 23119: Change behavior if SAGE_PYTHON3=yes: build for both Python 2 and Python 3

archive/issues_022882.json:
```json
{
    "body": "CC:  @embray @jdemeyer @nbruin\n\nThis is a proposal for changing Sage's build behavior: if `SAGE_PYTHON3=yes`, then build for both Python 2 and Python 3. This will increase the build time and the required disk space, but then at runtime, you can choose which version of Sage to run.\n\nI also propose that we introduce a new shell command \"sage3\" which runs Sage using Python 3.\n\nAfter Sage builds with Python 3, we can change the default to `SAGE_PYTHON3=yes`, so more people can test this. A while after that, we can stop supporting Python 2 altogether.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/23119\n\n",
    "closed_at": "2018-02-14T13:43:02Z",
    "created_at": "2017-05-31T19:35:58Z",
    "labels": [
        "component: python3"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Change behavior if SAGE_PYTHON3=yes: build for both Python 2 and Python 3",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23119",
    "user": "https://github.com/jhpalmieri"
}
```
CC:  @embray @jdemeyer @nbruin

This is a proposal for changing Sage's build behavior: if `SAGE_PYTHON3=yes`, then build for both Python 2 and Python 3. This will increase the build time and the required disk space, but then at runtime, you can choose which version of Sage to run.

I also propose that we introduce a new shell command "sage3" which runs Sage using Python 3.

After Sage builds with Python 3, we can change the default to `SAGE_PYTHON3=yes`, so more people can test this. A while after that, we can stop supporting Python 2 altogether.


Issue created by migration from https://trac.sagemath.org/ticket/23119





---

archive/issue_comments_319728.json:
```json
{
    "body": "This branch is not complete, but it is good enough for testing. In particular, it does not address all of the issues at #23106, only the ones absolutely necessary for running Sage (not that Sage builds with Python 3 yet, but it almost does). Also, there are a few spkg-check scripts that still use `sage-python23` (cvxopt, gmpy2, pycrypto, python_igraph, scipy). Should they still use `sage-python23`? Should they run tests twice if `SAGE_PYTHON3=yes`, once for each version of Python?\n\n---\nNew commits:",
    "created_at": "2017-05-31T19:47:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319728",
    "user": "https://github.com/jhpalmieri"
}
```

This branch is not complete, but it is good enough for testing. In particular, it does not address all of the issues at #23106, only the ones absolutely necessary for running Sage (not that Sage builds with Python 3 yet, but it almost does). Also, there are a few spkg-check scripts that still use `sage-python23` (cvxopt, gmpy2, pycrypto, python_igraph, scipy). Should they still use `sage-python23`? Should they run tests twice if `SAGE_PYTHON3=yes`, once for each version of Python?

---
New commits:



---

archive/issue_comments_319729.json:
```json
{
    "body": "I recommend running \"autoreconf\" with this branch, because it changes `configure.ac`. What do I need to do to create a new configure tarball? (If you don't run autoreconf and if `SAGE_PYTHON3=yes`, just make sure that Python 2 is built before any packages depending on PYTHON in `build/make/Makefile`. For example, I think you could run `./configure; ./sage -i python2; make`.)",
    "created_at": "2017-05-31T20:06:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319729",
    "user": "https://github.com/jhpalmieri"
}
```

I recommend running "autoreconf" with this branch, because it changes `configure.ac`. What do I need to do to create a new configure tarball? (If you don't run autoreconf and if `SAGE_PYTHON3=yes`, just make sure that Python 2 is built before any packages depending on PYTHON in `build/make/Makefile`. For example, I think you could run `./configure; ./sage -i python2; make`.)



---

archive/issue_comments_319730.json:
```json
{
    "body": "One issue with this: if SAGE_PYTHON3=yes, the cythonizing scripts are not written correctly: the scripts `local/bin/cython`, `local/bin/cythonize`, and `local/bin/cygdb` start with `#!/usr/bin/env python3` (because the pip3 version is installed after the pip2 version). It would be better to have separate `cython`, `cython2`, and `cython3` scripts, the way IPython does.",
    "created_at": "2017-06-01T00:10:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319730",
    "user": "https://github.com/jhpalmieri"
}
```

One issue with this: if SAGE_PYTHON3=yes, the cythonizing scripts are not written correctly: the scripts `local/bin/cython`, `local/bin/cythonize`, and `local/bin/cygdb` start with `#!/usr/bin/env python3` (because the pip3 version is installed after the pip2 version). It would be better to have separate `cython`, `cython2`, and `cython3` scripts, the way IPython does.



---

archive/issue_comments_319731.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-06-01T21:07:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319731",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_319732.json:
```json
{
    "body": "Here is a partial fix for the Cython problem. I wonder if we need to do the same for cysignals, and possibly for other packages. Is pynac also going to be a problem?",
    "created_at": "2017-06-01T21:08:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319732",
    "user": "https://github.com/jhpalmieri"
}
```

Here is a partial fix for the Cython problem. I wonder if we need to do the same for cysignals, and possibly for other packages. Is pynac also going to be a problem?



---

archive/issue_comments_319733.json:
```json
{
    "body": "Replying to [comment:7 jhpalmieri]:\n> ... Is pynac also going to be a problem?\n\n\nYes. Pynac uses the Python C API and several functions there that changed name between version 2 and 3.",
    "created_at": "2017-06-02T06:00:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319733",
    "user": "https://github.com/rwst"
}
```

Replying to [comment:7 jhpalmieri]:
> ... Is pynac also going to be a problem?


Yes. Pynac uses the Python C API and several functions there that changed name between version 2 and 3.



---

archive/issue_comments_319734.json:
```json
{
    "body": "Further we need a new release of pynac or at least https://github.com/pynac/pynac/pull/248 just to build pynac.",
    "created_at": "2017-06-02T10:10:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319734",
    "user": "https://github.com/kiwifb"
}
```

Further we need a new release of pynac or at least https://github.com/pynac/pynac/pull/248 just to build pynac.



---

archive/issue_comments_319735.json:
```json
{
    "body": "I will make a new release of brial early next week which will make it easier (and faster) to install for both python, although I don't know if it will work well with `pip` since I am not usually using it.",
    "created_at": "2017-06-02T10:23:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319735",
    "user": "https://github.com/kiwifb"
}
```

I will make a new release of brial early next week which will make it easier (and faster) to install for both python, although I don't know if it will work well with `pip` since I am not usually using it.



---

archive/issue_comments_319736.json:
```json
{
    "body": "So what is the status of all that, now ? I would appreciate if something would happen, but I am not able to review these tickets.",
    "created_at": "2017-06-19T19:51:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319736",
    "user": "https://github.com/fchapoton"
}
```

So what is the status of all that, now ? I would appreciate if something would happen, but I am not able to review these tickets.



---

archive/issue_comments_319737.json:
```json
{
    "body": "Replying to [comment:12 chapoton]:\n> So what is the status of all that, now ? I would appreciate if something would happen, but I am not able to review these tickets.\n\n\nI am not sure what the hold up is in #23039 but the present ticket looks fine to me once this is resolved. I can do my `brial` stuff once this is merged.",
    "created_at": "2017-06-19T21:46:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319737",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:12 chapoton]:
> So what is the status of all that, now ? I would appreciate if something would happen, but I am not able to review these tickets.


I am not sure what the hold up is in #23039 but the present ticket looks fine to me once this is resolved. I can do my `brial` stuff once this is merged.



---

archive/issue_comments_319738.json:
```json
{
    "body": "Replying to [comment:13 fbissey]:\n> I am not sure what the hold up is in #23039\n\n\nThere is a different approach to solve the same problem in #23129, and I think the plan is to merge that early in 8.1, to give it lots of time for testing.",
    "created_at": "2017-06-19T22:27:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319738",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:13 fbissey]:
> I am not sure what the hold up is in #23039


There is a different approach to solve the same problem in #23129, and I think the plan is to merge that early in 8.1, to give it lots of time for testing.



---

archive/issue_comments_319739.json:
```json
{
    "body": "Replying to [comment:14 jhpalmieri]:\n> Replying to [comment:13 fbissey]:\n> > I am not sure what the hold up is in #23039\n\n> \n> There is a different approach to solve the same problem in #23129, and I think the plan is to merge that early in 8.1, to give it lots of time for testing.\n\n\nSo, does this ticket depend on #23039 or not?",
    "created_at": "2017-06-19T22:29:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319739",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:14 jhpalmieri]:
> Replying to [comment:13 fbissey]:
> > I am not sure what the hold up is in #23039

> 
> There is a different approach to solve the same problem in #23129, and I think the plan is to merge that early in 8.1, to give it lots of time for testing.


So, does this ticket depend on #23039 or not?



---

archive/issue_comments_319740.json:
```json
{
    "body": "Replying to [comment:15 fbissey]:\n> Replying to [comment:14 jhpalmieri]:\n> > Replying to [comment:13 fbissey]:\n> > > I am not sure what the hold up is in #23039\n\n> > \n> > There is a different approach to solve the same problem in #23129, and I think the plan is to merge that early in 8.1, to give it lots of time for testing.\n\n> \n> So, does this ticket depend on #23039 or not?\n\n\nIt depends on #23039 or #23129. If #23129 gets merged, then we'll close #23039 as a duplicate, and vice versa, so I'll make both dependencies.",
    "created_at": "2017-06-20T02:38:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319740",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:15 fbissey]:
> Replying to [comment:14 jhpalmieri]:
> > Replying to [comment:13 fbissey]:
> > > I am not sure what the hold up is in #23039

> > 
> > There is a different approach to solve the same problem in #23129, and I think the plan is to merge that early in 8.1, to give it lots of time for testing.

> 
> So, does this ticket depend on #23039 or not?


It depends on #23039 or #23129. If #23129 gets merged, then we'll close #23039 as a duplicate, and vice versa, so I'll make both dependencies.



---

archive/issue_comments_319741.json:
```json
{
    "body": "So what happens here now ? the branch does not apply.",
    "created_at": "2017-08-07T12:06:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319741",
    "user": "https://github.com/fchapoton"
}
```

So what happens here now ? the branch does not apply.



---

archive/issue_comments_319742.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-08-07T18:19:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319742",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_319743.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-08-07T18:21:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319743",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_319744.json:
```json
{
    "body": "This should apply now.",
    "created_at": "2017-08-07T18:28:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319744",
    "user": "https://github.com/jhpalmieri"
}
```

This should apply now.



---

archive/issue_comments_319745.json:
```json
{
    "body": "I don't know if we also need to include #23325 as a dependency. In any case we need to somehow deal with Pynac. Does it need to be built twice, once for each version of Python? If so, how do we distinguish between the library files once they have been built? Do we need two different `local/lib` directories?",
    "created_at": "2017-08-07T20:08:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319745",
    "user": "https://github.com/jhpalmieri"
}
```

I don't know if we also need to include #23325 as a dependency. In any case we need to somehow deal with Pynac. Does it need to be built twice, once for each version of Python? If so, how do we distinguish between the library files once they have been built? Do we need two different `local/lib` directories?



---

archive/issue_comments_319746.json:
```json
{
    "body": "Replying to [comment:21 jhpalmieri]:\n> I don't know if we also need to include #23325 as a dependency. In any case we need to somehow deal with Pynac. Does it need to be built twice, once for each version of Python? If so, how do we distinguish between the library files once they have been built? Do we need two different `local/lib` directories?\n\n\n`pynac` produce only one usable library with soname `libpynac.so.x.y`. It is not versioned for python, meaning that even if you build it twice, you get the same library again. It will just be linked to a different python after rebuild (and since some internals depend on the python version, you cannot just underlink to provide whichever python when you link against pynac).\n\nFurther, as far as I can tell, and I tried, there is no way to introduce the python implementation as a variable in the library name in libtool. It just doesn't work. In sage-on-gentoo I\n* make a copy of the source for each version of python\n* patch Makfeile.am in each copy to replace `libpynac.la` by `libpynac_pythonX_Y.la`\n* rerun autoconf in each copy\n* build and install each copy which now install `libpynac_pythonX_Y.so`\n* Finally patch sage to get the right pynac library depending on the python I build for.\nLuckily the header are independent of the python implementation, otherwise it would be even more tricky.\n\nGiven that sage doesn't ship autotools by default, if you want to reproduce that setup you need to re-create one tarball by version of python.",
    "created_at": "2017-08-07T21:37:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319746",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:21 jhpalmieri]:
> I don't know if we also need to include #23325 as a dependency. In any case we need to somehow deal with Pynac. Does it need to be built twice, once for each version of Python? If so, how do we distinguish between the library files once they have been built? Do we need two different `local/lib` directories?


`pynac` produce only one usable library with soname `libpynac.so.x.y`. It is not versioned for python, meaning that even if you build it twice, you get the same library again. It will just be linked to a different python after rebuild (and since some internals depend on the python version, you cannot just underlink to provide whichever python when you link against pynac).

Further, as far as I can tell, and I tried, there is no way to introduce the python implementation as a variable in the library name in libtool. It just doesn't work. In sage-on-gentoo I
* make a copy of the source for each version of python
* patch Makfeile.am in each copy to replace `libpynac.la` by `libpynac_pythonX_Y.la`
* rerun autoconf in each copy
* build and install each copy which now install `libpynac_pythonX_Y.so`
* Finally patch sage to get the right pynac library depending on the python I build for.
Luckily the header are independent of the python implementation, otherwise it would be even more tricky.

Given that sage doesn't ship autotools by default, if you want to reproduce that setup you need to re-create one tarball by version of python.



---

archive/issue_comments_319747.json:
```json
{
    "body": "This is far from my area of expertise, but could we instead put a version of `libpynac.so.x.y` in `local/lib/python2.7/` or `local/lib/python3.6/` (or elsewhere), depending on the Python version used when building it, and then give !Sage/Python the appropriate library path?",
    "created_at": "2017-08-07T22:36:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319747",
    "user": "https://github.com/jhpalmieri"
}
```

This is far from my area of expertise, but could we instead put a version of `libpynac.so.x.y` in `local/lib/python2.7/` or `local/lib/python3.6/` (or elsewhere), depending on the Python version used when building it, and then give !Sage/Python the appropriate library path?



---

archive/issue_comments_319748.json:
```json
{
    "body": "Replying to [comment:23 jhpalmieri]:\n> This is far from my area of expertise, but could we instead put a version of `libpynac.so.x.y` in `local/lib/python2.7/` or `local/lib/python3.6/` (or elsewhere), depending on the Python version used when building it, and then give !Sage/Python the appropriate library path?\n\n\nThis is not a standard path, so you will have to add specific rpath for it if you do it this way.",
    "created_at": "2017-08-07T22:38:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319748",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:23 jhpalmieri]:
> This is far from my area of expertise, but could we instead put a version of `libpynac.so.x.y` in `local/lib/python2.7/` or `local/lib/python3.6/` (or elsewhere), depending on the Python version used when building it, and then give !Sage/Python the appropriate library path?


This is not a standard path, so you will have to add specific rpath for it if you do it this way.



---

archive/issue_comments_319749.json:
```json
{
    "body": "And installation would need to be manual (`make install` will not give you what you want). But Erik's stuff about staging before installing could help with that. Distro are quite adept with this kind of stuff.",
    "created_at": "2017-08-07T22:44:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319749",
    "user": "https://github.com/kiwifb"
}
```

And installation would need to be manual (`make install` will not give you what you want). But Erik's stuff about staging before installing could help with that. Distro are quite adept with this kind of stuff.



---

archive/issue_comments_319750.json:
```json
{
    "body": "Looking at the ticket in its present form. `brial` doesn't quite have the same trouble as `pynac` but it uses an autotool building system. So I would prefer if, like I suggested for `pynac`, `PYTHON` was set at the end of the configure line.\n\nOf course the point will be moot once we bump `brial` since I decoupled the python part from the autotool build system to allow it to be more easily built against multiple python.",
    "created_at": "2017-08-07T22:49:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319750",
    "user": "https://github.com/kiwifb"
}
```

Looking at the ticket in its present form. `brial` doesn't quite have the same trouble as `pynac` but it uses an autotool building system. So I would prefer if, like I suggested for `pynac`, `PYTHON` was set at the end of the configure line.

Of course the point will be moot once we bump `brial` since I decoupled the python part from the autotool build system to allow it to be more easily built against multiple python.



---

archive/issue_comments_319751.json:
```json
{
    "body": "Replying to [comment:25 fbissey]:\n> And installation would need to be manual (`make install` will not give you what you want). But Erik's stuff about staging before installing could help with that. Distro are quite adept with this kind of stuff.\n\n\nI am talking rubbish. Ignore this comment, configure will help you with this. \n\nHowever you will still need to put `-L$SAGE_LOCAL/lib/pythonX.Y -Wl,-rpath=$SAGE_LOCAL/lib/pythonX.Y` somewhere in `setup.py` or `module_list.py` and distros may hate for putting stuff in a non standard place, and they'll have to fix it to whatever they want to use.",
    "created_at": "2017-08-08T01:28:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319751",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:25 fbissey]:
> And installation would need to be manual (`make install` will not give you what you want). But Erik's stuff about staging before installing could help with that. Distro are quite adept with this kind of stuff.


I am talking rubbish. Ignore this comment, configure will help you with this. 

However you will still need to put `-L$SAGE_LOCAL/lib/pythonX.Y -Wl,-rpath=$SAGE_LOCAL/lib/pythonX.Y` somewhere in `setup.py` or `module_list.py` and distros may hate for putting stuff in a non standard place, and they'll have to fix it to whatever they want to use.



---

archive/issue_comments_319752.json:
```json
{
    "body": "I am thinking of this ticket as being useful for developers who want to use Python 3, so maybe we should keep the default setup. So for example, build copies of the `pynac` library and put them in `local/lib/python...`, and then maybe at the very end of building Sage, construct a symlink at `local/lib/pynac.so.x.y` pointing to one of them. Which one? It could depend on the value of `SAGE_PYTHON3`, but this comes back to the old question of whether `SAGE_PYTHON3` should have any effect at run time, or only build time. For developers only, we could have scripts `sage2` and `sage3` which first create the appropriate symlink and then run Sage using the appropriate version of Python. (For developers only because we should not in general assume write access to `SAGE_LOCAL/lib`.)\n\nAs I said, this is not my area of expertise, so I would hope other people could come up with better solutions.",
    "created_at": "2017-08-08T03:00:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319752",
    "user": "https://github.com/jhpalmieri"
}
```

I am thinking of this ticket as being useful for developers who want to use Python 3, so maybe we should keep the default setup. So for example, build copies of the `pynac` library and put them in `local/lib/python...`, and then maybe at the very end of building Sage, construct a symlink at `local/lib/pynac.so.x.y` pointing to one of them. Which one? It could depend on the value of `SAGE_PYTHON3`, but this comes back to the old question of whether `SAGE_PYTHON3` should have any effect at run time, or only build time. For developers only, we could have scripts `sage2` and `sage3` which first create the appropriate symlink and then run Sage using the appropriate version of Python. (For developers only because we should not in general assume write access to `SAGE_LOCAL/lib`.)

As I said, this is not my area of expertise, so I would hope other people could come up with better solutions.



---

archive/issue_comments_319753.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-08-08T03:05:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319753",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_319754.json:
```json
{
    "body": "Replying to [comment:26 fbissey]:\n> Looking at the ticket in its present form. `brial` doesn't quite have the same trouble as `pynac` but it uses an autotool building system. So I would prefer if, like I suggested for `pynac`, `PYTHON` was set at the end of the configure line.\n\n\nI made this change for `brial`.",
    "created_at": "2017-08-08T03:05:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319754",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:26 fbissey]:
> Looking at the ticket in its present form. `brial` doesn't quite have the same trouble as `pynac` but it uses an autotool building system. So I would prefer if, like I suggested for `pynac`, `PYTHON` was set at the end of the configure line.


I made this change for `brial`.



---

archive/issue_comments_319755.json:
```json
{
    "body": "Replying to [comment:28 jhpalmieri]:\n> I am thinking of this ticket as being useful for developers who want to use Python 3, so maybe we should keep the default setup. So for example, build copies of the `pynac` library and put them in `local/lib/python...`, and then maybe at the very end of building Sage, construct a symlink at `local/lib/pynac.so.x.y` pointing to one of them. Which one? It could depend on the value of `SAGE_PYTHON3`, but this comes back to the old question of whether `SAGE_PYTHON3` should have any effect at run time, or only build time. For developers only, we could have scripts `sage2` and `sage3` which first create the appropriate symlink and then run Sage using the appropriate version of Python. (For developers only because we should not in general assume write access to `SAGE_LOCAL/lib`.)\n> \n> As I said, this is not my area of expertise, so I would hope other people could come up with better solutions.\n\n\nThe same discussion happened in https://groups.google.com/forum/?hl=en#!searchin/sage-devel/Pynac$20python%7Csort:date/sage-devel/IY8rc3i-sh4/-MfB1OvkBQAJ\n\nNils Bruin: \"But then we need to either build libraries libpynac2 and libpynac3 or put libpynac somewhere in local/lib/python*\".\n\nWhat's wrong with building Pynac twice?",
    "created_at": "2017-08-08T15:03:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319755",
    "user": "https://github.com/rwst"
}
```

Replying to [comment:28 jhpalmieri]:
> I am thinking of this ticket as being useful for developers who want to use Python 3, so maybe we should keep the default setup. So for example, build copies of the `pynac` library and put them in `local/lib/python...`, and then maybe at the very end of building Sage, construct a symlink at `local/lib/pynac.so.x.y` pointing to one of them. Which one? It could depend on the value of `SAGE_PYTHON3`, but this comes back to the old question of whether `SAGE_PYTHON3` should have any effect at run time, or only build time. For developers only, we could have scripts `sage2` and `sage3` which first create the appropriate symlink and then run Sage using the appropriate version of Python. (For developers only because we should not in general assume write access to `SAGE_LOCAL/lib`.)
> 
> As I said, this is not my area of expertise, so I would hope other people could come up with better solutions.


The same discussion happened in https://groups.google.com/forum/?hl=en#!searchin/sage-devel/Pynac$20python%7Csort:date/sage-devel/IY8rc3i-sh4/-MfB1OvkBQAJ

Nils Bruin: "But then we need to either build libraries libpynac2 and libpynac3 or put libpynac somewhere in local/lib/python*".

What's wrong with building Pynac twice?



---

archive/issue_comments_319756.json:
```json
{
    "body": "Replying to [comment:31 rws]:\n> What's wrong with building Pynac twice?\n\n\nThere is nothing wrong with that. The only thing we need to make sure is that there is a difference between the libraries either in name or location. In sage-on-gentoo I choose name but it is the hard way.",
    "created_at": "2017-08-08T20:22:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319756",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:31 rws]:
> What's wrong with building Pynac twice?


There is nothing wrong with that. The only thing we need to make sure is that there is a difference between the libraries either in name or location. In sage-on-gentoo I choose name but it is the hard way.



---

archive/issue_comments_319757.json:
```json
{
    "body": "Singular also has a Python module, but I guess it apparently isn't used by Sage in any way so it can just be built against one Python.\n\nAnyways I'm actually -1 on this approach of having two separate Sage installs for Python 2 and Python 3 in the same SAGE_LOCAL in general.  I think it overcomplicates things needlessly, when one could simply have two separate installs in separate SAGE_LOCALs each using different Pythons.",
    "created_at": "2017-08-09T09:07:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319757",
    "user": "https://github.com/embray"
}
```

Singular also has a Python module, but I guess it apparently isn't used by Sage in any way so it can just be built against one Python.

Anyways I'm actually -1 on this approach of having two separate Sage installs for Python 2 and Python 3 in the same SAGE_LOCAL in general.  I think it overcomplicates things needlessly, when one could simply have two separate installs in separate SAGE_LOCALs each using different Pythons.



---

archive/issue_comments_319758.json:
```json
{
    "body": "Replying to [comment:33 embray]:\n> Singular also has a Python module, but I guess it apparently isn't used by Sage in any way so it can just be built against one Python.\n> \n\n\nIt is also only python2.7 as far as I remember.\n\n> Anyways I'm actually -1 on this approach of having two separate Sage installs for Python 2 and Python 3 in the same SAGE_LOCAL in general.  I think it overcomplicates things needlessly, when one could simply have two separate installs in separate SAGE_LOCALs each using different Pythons.\n\n\nAs far as standalone sage is concerned, I approve of that approach. The dual install is only nice for people like me that do sage-on-distro. You don't really get the freedom you are talking about in that case. But I'll admit to being marginal.",
    "created_at": "2017-08-09T09:12:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319758",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:33 embray]:
> Singular also has a Python module, but I guess it apparently isn't used by Sage in any way so it can just be built against one Python.
> 


It is also only python2.7 as far as I remember.

> Anyways I'm actually -1 on this approach of having two separate Sage installs for Python 2 and Python 3 in the same SAGE_LOCAL in general.  I think it overcomplicates things needlessly, when one could simply have two separate installs in separate SAGE_LOCALs each using different Pythons.


As far as standalone sage is concerned, I approve of that approach. The dual install is only nice for people like me that do sage-on-distro. You don't really get the freedom you are talking about in that case. But I'll admit to being marginal.



---

archive/issue_comments_319759.json:
```json
{
    "body": "I'm not sure I follow.  Why install Sage via a distribution package that includes a Python 2 Sage and a Python 3 Sage.  Having both only seems relevant to me for development reasons, in which case one would't be installing via a packaging system anyways...\n\nI'm not against this if it's helpful to you somehow.  But I don't understand how it's helpful, and it throws a wrench slightly into support for virtual packages (of which Python would be one).",
    "created_at": "2017-08-09T09:15:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319759",
    "user": "https://github.com/embray"
}
```

I'm not sure I follow.  Why install Sage via a distribution package that includes a Python 2 Sage and a Python 3 Sage.  Having both only seems relevant to me for development reasons, in which case one would't be installing via a packaging system anyways...

I'm not against this if it's helpful to you somehow.  But I don't understand how it's helpful, and it throws a wrench slightly into support for virtual packages (of which Python would be one).



---

archive/issue_comments_319760.json:
```json
{
    "body": "Distros offer side by side installations of many package for different version of python - unless there is a major problem with doing so. Of course python 2.7 will be phased out eventually.\n\nDevelopment is also a reason. It looks like until a few days ago I may have been the only one with a complete real python3 build.\n\nAnyway, **I don't use any bits of sage packaging** - nor do other distros. What you do about it has usually marginal effect on us at best. I try not to be dragged into ticket about sage's packaging system for that reason. Not relevant, unless it impact some of my other interests like clang support - primarily for OS X.",
    "created_at": "2017-08-09T09:22:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319760",
    "user": "https://github.com/kiwifb"
}
```

Distros offer side by side installations of many package for different version of python - unless there is a major problem with doing so. Of course python 2.7 will be phased out eventually.

Development is also a reason. It looks like until a few days ago I may have been the only one with a complete real python3 build.

Anyway, **I don't use any bits of sage packaging** - nor do other distros. What you do about it has usually marginal effect on us at best. I try not to be dragged into ticket about sage's packaging system for that reason. Not relevant, unless it impact some of my other interests like clang support - primarily for OS X.



---

archive/issue_comments_319761.json:
```json
{
    "body": "Replying to [comment:33 embray]:\n> Anyways I'm actually -1 on this approach of having two separate Sage installs for Python 2 and Python 3 in the same SAGE_LOCAL in general.  I think it overcomplicates things needlessly, when one could simply have two separate installs in separate SAGE_LOCALs each using different Pythons.\n\n\nCan you implement something like this so we can test it out?",
    "created_at": "2017-08-09T15:39:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319761",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:33 embray]:
> Anyways I'm actually -1 on this approach of having two separate Sage installs for Python 2 and Python 3 in the same SAGE_LOCAL in general.  I think it overcomplicates things needlessly, when one could simply have two separate installs in separate SAGE_LOCALs each using different Pythons.


Can you implement something like this so we can test it out?



---

archive/issue_comments_319762.json:
```json
{
    "body": "I'm just talking about `export SAGE_LOCAL=<whatever>`.  Is this not possible?",
    "created_at": "2017-08-10T18:18:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319762",
    "user": "https://github.com/embray"
}
```

I'm just talking about `export SAGE_LOCAL=<whatever>`.  Is this not possible?



---

archive/issue_comments_319763.json:
```json
{
    "body": "First, my proposed goal is to build Sage so that you can switch, at run-time, between Python 2 and Python 3. With that goal, I don't want to build everything twice, just the things that depend on the version of Python. On OS X or other systems with a bad default version of `gcc`, building `gcc` twice will increase the build time considerably, for example. Singular or R can take a while to build, and I don't think they depend on the version of Python. So I would want something more clever than just setting `SAGE_LOCAL` twice during the build process.",
    "created_at": "2017-08-10T19:12:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319763",
    "user": "https://github.com/jhpalmieri"
}
```

First, my proposed goal is to build Sage so that you can switch, at run-time, between Python 2 and Python 3. With that goal, I don't want to build everything twice, just the things that depend on the version of Python. On OS X or other systems with a bad default version of `gcc`, building `gcc` twice will increase the build time considerably, for example. Singular or R can take a while to build, and I don't think they depend on the version of Python. So I would want something more clever than just setting `SAGE_LOCAL` twice during the build process.



---

archive/issue_comments_319764.json:
```json
{
    "body": "Replying to [comment:37 jhpalmieri]:\n> Replying to [comment:33 embray]:\n> > Anyways I'm actually -1 on this approach of having two separate Sage installs for Python 2 and Python 3 in the same SAGE_LOCAL in general.  I think it overcomplicates things needlessly, when one could simply have two separate installs in separate SAGE_LOCALs each using different Pythons.\n\n> \n> Can you implement something like this so we can test it out?\n\n\nI would also prefer to have separate installs, one for python2-sage and one for python3-sage. I am not interested in being able to switch inside one unique SAGE_LOCAL. But the point is: when is this going to be possible ? I have been asking for this for quite some time now. Using SAGE_PYTHON3=yes is not enough, for example because of the scripts in src/bin, but more generally because of other build issues that have not been cared about that much so far.",
    "created_at": "2017-08-26T08:10:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319764",
    "user": "https://github.com/fchapoton"
}
```

Replying to [comment:37 jhpalmieri]:
> Replying to [comment:33 embray]:
> > Anyways I'm actually -1 on this approach of having two separate Sage installs for Python 2 and Python 3 in the same SAGE_LOCAL in general.  I think it overcomplicates things needlessly, when one could simply have two separate installs in separate SAGE_LOCALs each using different Pythons.

> 
> Can you implement something like this so we can test it out?


I would also prefer to have separate installs, one for python2-sage and one for python3-sage. I am not interested in being able to switch inside one unique SAGE_LOCAL. But the point is: when is this going to be possible ? I have been asking for this for quite some time now. Using SAGE_PYTHON3=yes is not enough, for example because of the scripts in src/bin, but more generally because of other build issues that have not been cared about that much so far.



---

archive/issue_comments_319765.json:
```json
{
    "body": "People who are interested in separate SAGE_LOCALs from one source tree might be interested in helping to update/complete ticket #21469 (VPATH builds).",
    "created_at": "2017-08-27T02:43:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319765",
    "user": "https://github.com/mkoeppe"
}
```

People who are interested in separate SAGE_LOCALs from one source tree might be interested in helping to update/complete ticket #21469 (VPATH builds).



---

archive/issue_comments_319766.json:
```json
{
    "body": "Close as wontfix?",
    "created_at": "2018-02-14T13:22:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319766",
    "user": "https://github.com/jdemeyer"
}
```

Close as wontfix?



---

archive/issue_comments_319767.json:
```json
{
    "body": "Yes, I think so.",
    "created_at": "2018-02-14T13:22:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319767",
    "user": "https://github.com/fchapoton"
}
```

Yes, I think so.



---

archive/issue_events_059796.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-02-14T13:43:02Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23119#event-59796"
}
```



---

archive/issue_events_059797.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-02-14T13:43:02Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23119#event-59797"
}
```



---

archive/issue_comments_319768.json:
```json
{
    "body": "Resolution: wontfix",
    "created_at": "2018-02-14T13:43:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23119#issuecomment-319768",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: wontfix
