# Issue 11054: Sympow spkg fails with gcc 4.6.0

Issue created by migration from https://trac.sagemath.org/ticket/11226

Original creator: jdemeyer

Original creation time: 2011-04-20 15:57:03

Assignee: tbd

Keywords: sympow

On Linux Itanium (ia64) systems, sympow builds with gcc 4.6.0 but fails doctests.
Example from cleo (RHEL 5.3 ia64 Itanium 2):

```
sage -t -long  -force_lib devel/sage/sage/lfunctions/sympow.py
**********************************************************************
File "/home/buildbot/build/sage/cleo-1/cleo_full/build/sage-4.7.alpha5/devel/sage-main/sage/lfunctions/sympow.py", line 213:
    sage: sympow.modular_degree(EllipticCurve('11a'))
Exception raised:
    Traceback (most recent call last):
      File "/home/buildbot/build/sage/cleo-1/cleo_full/build/sage-4.7.alpha5/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/home/buildbot/build/sage/cleo-1/cleo_full/build/sage-4.7.alpha5/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/home/buildbot/build/sage/cleo-1/cleo_full/build/sage-4.7.alpha5/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_6[2]>", line 1, in <module>
        sympow.modular_degree(EllipticCurve('11a'))###line 213:
    sage: sympow.modular_degree(EllipticCurve('11a'))
      File "/home/buildbot/build/sage/cleo-1/cleo_full/build/sage-4.7.alpha5/local/lib/python/site-packages/sage/lfunctions/sympow.py", line 229, in modular_degree
        raise RuntimeError, "failed to compute modular degree"
    RuntimeError: failed to compute modular degree
**********************************************************************

[...]

The following tests failed:

	sage -t -long  -force_lib devel/sage/sage/modular/hecke/submodule.py # 1 doctests failed
	sage -t -long  -force_lib devel/sage/sage/modular/abvar/abvar.py # 1 doctests failed
	sage -t -long  -force_lib devel/sage/sage/lfunctions/sympow.py # 13 doctests failed
	sage -t -long  -force_lib devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py # 17 doctests failed
----------------------------------------------------------------------
```



---

Comment by jdemeyer created at 2011-04-20 16:09:10

On first sight, it looks like compiling with `-O1` solves the problem.


---

Comment by fbissey created at 2011-04-24 01:56:48

Can't say I am surprised. Any clues from the build log?


---

Comment by drkirkby created at 2011-04-24 02:29:22

Replying to [comment:4 fbissey]:
> Can't say I am surprised. 

Me neither! 

Dave


---

Comment by drkirkby created at 2011-04-27 13:11:08

Has the '`-fno-ivopts`' option, (which has fixed several gcc-4.6.0 specific issues), been tried?


---

Comment by mariah created at 2011-04-27 19:18:26

Replying to [comment:6 drkirkby]:
> Has the '`-fno-ivopts`' option, (which has fixed several gcc-4.6.0 specific issues), been tried?

Yes.  I tried compiling with `-O3 -fno-ivopts`, but sadly
the reported problem still exists.


---

Comment by mariah created at 2011-04-27 20:48:24

If src/QD.c is compiled with -O1 (and the rest with -O3) then
`sage -t -long  -force_lib devel/sage/sage/lfunctions/sympow.py`
no longer fails.  

I am working on isolating the code in QD.c that demonstrates the gcc-4.6.0 optimization bug.


---

Comment by drkirkby created at 2011-04-27 21:49:08

Replying to [comment:8 mariah]:
> If src/QD.c is compiled with -O1 (and the rest with -O3) then
> `sage -t -long  -force_lib devel/sage/sage/lfunctions/sympow.py`
> no longer fails.  
> 
> I am working on isolating the code in QD.c that demonstrates the gcc-4.6.0 optimization bug.

You are a brave lady Mariah - any code in SYMPOW is difficult to understand. Bill  Hart described it as "virtually obfuscated". Unfortunately, since it not actually standard C (the Sun compiler wont compile it), it can't be entered into The International Obfuscated C Code Contest

http://www.ioccc.org/

I particualry like SYMPOW's Configure script

http://boxen.math.washington.edu/home/kirkby/bad-code/sympow-1.018.1.p7/src/Configure

which starts off


```/bin/sh
```


then later has a test to see if sh exists on the system!


```
SH=`whichexe sh` && echo "#define SH \"$SH\"" >> $CONFIG
if [ -z "$SH" ]; then
  echo "**ERROR**: Could not find sh"; exit 1;
else
  echo "SH = $SH"
fi
```


Good luck Mariah - I don't envy you. 

Dave


---

Comment by mariah created at 2011-04-29 14:52:29

Changing assignee from tbd to mariah.


---

Comment by mariah created at 2011-04-29 16:00:34

Changing status from new to needs_review.


---

Comment by mariah created at 2011-04-29 16:00:34

gcc-4.6.0 optimization regression of src/QD.c reported to gcc bugzilla [http://gcc.gnu.org/bugzilla/show_bug.cgi?id=48823](http://gcc.gnu.org/bugzilla/show_bug.cgi?id=48823)


---

Comment by drkirkby created at 2011-04-29 23:27:08

Hi Mariah, 

the test in the code 


```
if [ "`uname -m`" = "ia64" ] && [ $CC = "gcc" ]; then 
```


will fail if CC is set to something like /usr/local/bin/gcc. In this case, $CC is not just gcc. 

I would suggest making use of the script `$SAGE_ROOT/local/bin/testcc.sh`, which actually compiles a bit of code and checks that __GNU__ is defined. Then use something like the following, which I'm doing from memory and have not tested. 


```
if [ "x$UNAME" = xLinux ] && [ "x`$SAGE_LOCAL/bin/testcc.sh $CC`" = xGCC ] && [ "x`$CC -dumpversion 2>/dev/null`" = x4.6.0 ] ; then  
```


That will
 * Ensure the test only gets performed on Linux. We currently have no evidence to assume this will be an issue on HP-UX, which also runs on the Itanium processor. 
 * Since the first test uses $UNAME, it should be faster on non-Linux systems, as there is no need to call any external scripts or programs. 
 * $CC really is a GNU-like compiler. 

You might want to review #11169 which changes the exit code of the script testcc.sh if it fails. But it wont effect your code here, as you are checking the text output. 

Dave


---

Comment by drkirkby created at 2011-04-29 23:27:08

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2011-04-30 10:47:06

Replying to [comment:12 drkirkby]:
>  * Ensure the test only gets performed on Linux. We currently have no evidence to assume this will be an issue on HP-UX, which also runs on the Itanium processor.

I would prefer to be on the safe side and lower the optimization on _any_ ia64 machine (Linux or not).


---

Comment by drkirkby created at 2011-05-01 17:50:19

Replying to [comment:13 jdemeyer]:
> Replying to [comment:12 drkirkby]:
> >  * Ensure the test only gets performed on Linux. We currently have no evidence to assume this will be an issue on HP-UX, which also runs on the Itanium processor.
> 
> I would prefer to be on the safe side and lower the optimization on _any_ ia64 machine (Linux or not).

Fair enough, so change the test to something like:


```
if [ "x`$SAGE_LOCAL/bin/testcc.sh $CC`" = xGCC ] && [ "x`$CC -dumpversion 2>/dev/null`" = x4.6.0 ] ; then  
```


then we will know it is gcc, even if someone sets the environment variable CC to be {{{/usr/local/bin/gcc}}

This release of gcc seems to have caused a fair number of problems for Sage. I'm not aware of any other gcc "upgrade" which has caused so much trouble. 

Dave


---

Comment by drkirkby created at 2011-05-01 18:18:22

Replying to [comment:12 drkirkby]:

> I would suggest making use of the script `$SAGE_ROOT/local/bin/testcc.sh`, which actually compiles a bit of code and checks that __GNU!__ is defined.

The trac formatting has screwed that up a bit. The script `$SAGE_ROOT/local/bin/testcc.sh` checks if !__GNU!__ is defined (I have to put a couple of exclamation marks to escape the formatting, as two underscores causes the text to be underlined).

Dave


---

Comment by jdemeyer created at 2011-05-02 09:17:14

I simplified the testcase and came up with the following minimal code to demonstrate the problem:

```
extern int printf (__const char *__restrict __format, ...);

double p0 = 2.718281828459045091e+00;
double p1 = 1.445646891729250158e-16;
double q0 = 3.141592653589793116e+00;
double q1 = 1.224646799147353207e-16;

int main()
{
  double x;
  x = p0*q1 + p1*q0 + p0*q0;
  printf("%a\n", x);

  return 0;
}
```


Also, `-fno-expensive-optimizations` solves this problem.


---

Comment by jdemeyer created at 2011-05-02 10:07:17

Changing priority from major to blocker.


---

Comment by jdemeyer created at 2011-05-02 10:07:17

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2011-05-02 10:07:17

New spkg (with uncommitted changes) needs review: [http://boxen.math.washington.edu/home/jdemeyer/spkg/sympow-1.018.1.p9.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/sympow-1.018.1.p9.spkg)


---

Comment by jdemeyer created at 2011-05-03 12:43:07

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2011-05-03 12:59:38

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2011-05-03 12:59:38

Changing keywords from "sympow" to "sympow spkg".


---

Comment by drkirkby created at 2011-05-03 15:11:22

Changing status from needs_review to needs_work.


---

Comment by drkirkby created at 2011-05-03 15:11:22

The changes are not checked in


```
drkirkby@hawk:~/sage-4.7.rc0/spkg/standard/sympow-1.018.1.p9$ hg status
M SPKG.txt
M spkg-install
```


That obviously needs fixing. A minor point, gcc 4.6.1 will cause the patch to be applied too, despite the comment saying _"Working around problems with gcc 4.6.0 on Itanium systems"_

Dave


---

Comment by mariah created at 2011-05-03 20:33:04

I recommend that the patch only apply to gcc-4.6.0.  It might
be fixed in later gcc versions.


---

Comment by jdemeyer created at 2011-05-04 07:32:14

Replying to [comment:23 mariah]:
> I recommend that the patch only apply to gcc-4.6.0.  It might
> be fixed in later gcc versions.

I think that having the workaround for all versions 4.6.x doesn't really hurt. It is certainly a safer alternative than applying the workaround only for gcc 4.6.0. If at some point, this bug is fixed in a later gcc 4.6.x, then we can still change the spkg accordingly.


---

Comment by jdemeyer created at 2011-05-04 09:44:35

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2011-05-04 09:44:35

Replying to [comment:22 drkirkby]:
> The changes are not checked in
> 
> {{{
> drkirkby`@`hawk:~/sage-4.7.rc0/spkg/standard/sympow-1.018.1.p9$ hg status
> M SPKG.txt
> M spkg-install
> }}}
> 
> That obviously needs fixing.
Never mind this, it will be fixed after positive_review.

> A minor point, gcc 4.6.1 will cause the patch to be applied too, despite the comment saying _"Working around problems with gcc 4.6.0 on Itanium systems"_
I have changed the comment slightly to:

```
        echo "Detected GCC version `$CC -dumpversion` on Itanium. Adding"
        echo "work-around to fix a bug when sympow is compiled with gcc 4.6.0"
```



---

Comment by jdemeyer created at 2011-05-04 09:44:47

Diff for the sympow spkg, for reviewing only


---

Attachment


---

Comment by drkirkby created at 2011-05-05 21:27:44

That looks fine, so positive review, though don't forget to commit the changes.


---

Comment by drkirkby created at 2011-05-05 21:27:44

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2011-05-06 07:18:49

Resolution: fixed


---

Comment by jdemeyer created at 2011-10-13 19:53:29

According to gcc, it's okay to violate the floating-point standard with `-O3`.  They also say the correct workaround is the *undocumented* option

```
-ffp-contract=on
```



---

Comment by jdemeyer created at 2011-10-13 19:56:28

Sorry, it is documented.  I was looking at documentation of an older gcc.


---

Comment by jdemeyer created at 2011-10-13 19:59:25

From [http://gcc.gnu.org/onlinedocs/gcc/Optimize-Options.html](http://gcc.gnu.org/onlinedocs/gcc/Optimize-Options.html):

```
-ffp-contract=style
    -ffp-contract=off disables floating-point expression contraction. -ffp-contract=fast enables floating-point expression contraction such as forming of fused multiply-add operations if the target has native support for them. -ffp-contract=on enables floating-point expression contraction if allowed by the language standard. This is currently not implemented and treated equal to -ffp-contract=off.

    The default is -ffp-contract=fast.
```

