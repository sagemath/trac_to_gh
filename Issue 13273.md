# Issue 13273: Cuspidal subspace of modular forms over finite field contains forms that are not cuspidal

archive/issues_013273.json:
```json
{
    "body": "Assignee: craigcitro\n\nExecuting:\n\n```\nM=ModularForms(Gamma1(29),base_ring=GF(29))\nS=M.cuspidal_subspace()\nS.basis()\n```\n\ngives:\n\n```\n[\n1 + O(q^6),\nq + O(q^6),\nq^2 + O(q^6),\nq^3 + O(q^6),\nq^4 + O(q^6),\nq^5 + O(q^6),\nO(q^6),\nO(q^6),\nO(q^6),\nO(q^6),\nO(q^6),\nO(q^6),\nO(q^6),\nO(q^6),\nO(q^6),\nO(q^6),\nO(q^6),\nO(q^6),\nO(q^6),\nO(q^6),\nO(q^6),\nO(q^6)\n]\n```\n\n\nThe first element is clearly not cuspidal\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/13445\n\n",
    "created_at": "2012-09-11T08:45:36Z",
    "labels": [
        "modular forms",
        "major",
        "bug"
    ],
    "title": "Cuspidal subspace of modular forms over finite field contains forms that are not cuspidal",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13273",
    "user": "mderickx"
}
```
Assignee: craigcitro

Executing:

```
M=ModularForms(Gamma1(29),base_ring=GF(29))
S=M.cuspidal_subspace()
S.basis()
```

gives:

```
[
1 + O(q^6),
q + O(q^6),
q^2 + O(q^6),
q^3 + O(q^6),
q^4 + O(q^6),
q^5 + O(q^6),
O(q^6),
O(q^6),
O(q^6),
O(q^6),
O(q^6),
O(q^6),
O(q^6),
O(q^6),
O(q^6),
O(q^6),
O(q^6),
O(q^6),
O(q^6),
O(q^6),
O(q^6),
O(q^6)
]
```


The first element is clearly not cuspidal


Issue created by migration from https://trac.sagemath.org/ticket/13445





---

archive/issue_comments_162787.json:
```json
{
    "body": "Looking at sage/modular/modform/cuspidal_submodule.py, it seems that the cuspidal submodule is just defined by\n\n* computing its dimension d\n* taken the first d vectors of the basis of modular forms\n\nSo it implicitly assumes that the cusp forms come first in the listing of the basis.\n\nOn the other hand, the \"is_cuspidal\" method just checks that the element is in the cuspidal submodule. Is there a way to really check if something is cuspidal ?",
    "created_at": "2013-08-08T08:58:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13273",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13273#issuecomment-162787",
    "user": "chapoton"
}
```

Looking at sage/modular/modform/cuspidal_submodule.py, it seems that the cuspidal submodule is just defined by

* computing its dimension d
* taken the first d vectors of the basis of modular forms

So it implicitly assumes that the cusp forms come first in the listing of the basis.

On the other hand, the "is_cuspidal" method just checks that the element is in the cuspidal submodule. Is there a way to really check if something is cuspidal ?



---

archive/issue_comments_162788.json:
```json
{
    "body": "Smaller example:\n\n\n```\nsage: M = ModularForms(Gamma1(11), base_ring=GF(11))\nsage: S = M.cuspidal_subspace()\nsage: S.basis()\n[\n1 + O(q^6)\n]\n```\n",
    "created_at": "2014-04-18T23:35:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13273",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13273#issuecomment-162788",
    "user": "AlexGhitza"
}
```

Smaller example:


```
sage: M = ModularForms(Gamma1(11), base_ring=GF(11))
sage: S = M.cuspidal_subspace()
sage: S.basis()
[
1 + O(q^6)
]
```




---

archive/issue_comments_162789.json:
```json
{
    "body": "Even smaller example:\n\n\n```\nsage: M = ModularForms(Gamma0(11), base_ring=GF(11)); M\nModular Forms space of dimension 2 for Congruence Subgroup Gamma0(11) of weight 2 over Finite Field of size 11\nsage: M.basis()\n[\n1 + q^2 + q^3 + q^4 + q^5 + O(q^6),\nq + 9*q^2 + 10*q^3 + 2*q^4 + q^5 + O(q^6)\n]\nsage: S = M.cuspidal_subspace()\nsage: S.basis()\n[\n1 + q^2 + q^3 + q^4 + q^5 + O(q^6)\n]\n```\n",
    "created_at": "2014-04-18T23:43:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13273",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13273#issuecomment-162789",
    "user": "AlexGhitza"
}
```

Even smaller example:


```
sage: M = ModularForms(Gamma0(11), base_ring=GF(11)); M
Modular Forms space of dimension 2 for Congruence Subgroup Gamma0(11) of weight 2 over Finite Field of size 11
sage: M.basis()
[
1 + q^2 + q^3 + q^4 + q^5 + O(q^6),
q + 9*q^2 + 10*q^3 + 2*q^4 + q^5 + O(q^6)
]
sage: S = M.cuspidal_subspace()
sage: S.basis()
[
1 + q^2 + q^3 + q^4 + q^5 + O(q^6)
]
```




---

archive/issue_comments_162790.json:
```json
{
    "body": "The issue was in `sage.modular.modform.ambient_R.py`, where `q_integral_basis` was used for positive characteristic base rings.  However, `q_integral_basis` does not guarantee that its output is in the format exhibited by `q_expansion_basis`, i.e. starting with a basis for the cuspidal subspace and completed to a basis of the entire space.\n\nThe modified code now computes an integral basis for the cuspidal subspace and then completes it to an integral basis of the whole space.  This strategy works for rings of prime power characteristic (e.g. finite fields or integers modulo a prime power, the two main use cases currently in Sage).\n----\nNew commits:",
    "created_at": "2014-04-24T06:11:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13273",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13273#issuecomment-162790",
    "user": "AlexGhitza"
}
```

The issue was in `sage.modular.modform.ambient_R.py`, where `q_integral_basis` was used for positive characteristic base rings.  However, `q_integral_basis` does not guarantee that its output is in the format exhibited by `q_expansion_basis`, i.e. starting with a basis for the cuspidal subspace and completed to a basis of the entire space.

The modified code now computes an integral basis for the cuspidal subspace and then completes it to an integral basis of the whole space.  This strategy works for rings of prime power characteristic (e.g. finite fields or integers modulo a prime power, the two main use cases currently in Sage).
----
New commits:



---

archive/issue_comments_162791.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-04-24T06:11:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13273",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13273#issuecomment-162791",
    "user": "AlexGhitza"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_162792.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-05-09T11:05:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13273",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13273#issuecomment-162792",
    "user": "pbruin"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_162793.json:
```json
{
    "body": "The code looks good and the patchbot is happy.",
    "created_at": "2014-05-09T11:05:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13273",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13273#issuecomment-162793",
    "user": "pbruin"
}
```

The code looks good and the patchbot is happy.



---

archive/issue_comments_162794.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-05-12T11:34:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13273",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13273#issuecomment-162794",
    "user": "vbraun"
}
```

Resolution: fixed
