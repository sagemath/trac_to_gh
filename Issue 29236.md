# Issue 29236: fedora: Add python3-devel system packages, standardize build/pkgs/python3/distros/*.txt

Issue created by migration from https://trac.sagemath.org/ticket/29473

Original creator: mkoeppe

Original creation time: 2020-04-06 20:37:42

CC:  dimpase fbissey

Currently, on `fedora-31-standard` we do not find a system package that passes the python3 spkg-configure test (https://github.com/mkoeppe/sage/runs/563300830).

In this ticket, we add the needed system packages to `build/pkgs/python3/distros/fedora.txt`.

Also, for uniformity, we move some system packages from `build/pkgs/cygwin.txt` to `build/pkgs/python3/distros/cygwin.txt` so that they are only available in a `standard` build but not a `minimal` build.

We also add the system package information for `python3` for some more distributions in preparation for supporting them.


---

Comment by mkoeppe created at 2020-04-08 13:27:17

Tests at https://github.com/mkoeppe/sage/actions/runs/73584944


---

Comment by mkoeppe created at 2020-04-08 19:52:35

This correctly rejects old python3s for `fedora` < 29 and too new python3 for `fedora-32-standard`.

It accepts `python3.7` on `fedora-29-standard` (https://github.com/mkoeppe/sage/runs/570853071)
but then runs into trouble compiling cysignals:

```
    gcc -Wno-unused-result -Wsign-compare -DDYNAMIC_ANNOTATIONS_ENABLED=1 -DNDEBUG -O2 -g -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -fexceptions -fstack-protector-strong -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -specs=/usr/lib/rpm/redhat/redhat-annobin-cc1 -m64 -mtune=generic -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection -D_GNU_SOURCE -fPIC -fwrapv -fPIC -DCYTHON_CLINE_IN_TRACEBACK=0 -U_FORTIFY_SOURCE -Isrc/cysignals -Isrc -I/sage/local/include -I/usr/include/python3.7m -c build/src/cysignals/signals.c -o build/temp.linux-x86_64-3.7/build/src/cysignals/signals.o -pthread
    In file included from build/src/cysignals/signals.c:1552:
    build/src/cysignals/implementation.c:27:2: error: #error "cysignals must be compiled without _FORTIFY_SOURCE"
     #error "cysignals must be compiled without _FORTIFY_SOURCE"
      ^~~~~
    error: command 'gcc' failed with exit status 1
    Running setup.py install for cysignals: finished with status 'error'
```

Same on `fedora-30-standard`, `fedora-31-standard`.


---

Comment by mkoeppe created at 2020-04-08 22:33:58

New commits:


---

Comment by git created at 2020-04-08 22:34:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-04-08 22:53:10

Tests at https://github.com/mkoeppe/sage/actions/runs/73955490


---

Comment by mkoeppe created at 2020-04-08 23:38:23

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-04-08 23:48:42

What's happening here is that `cysignals` tries to make sure that `_FORTIFY_SOURCE` is undefined by using `Extension(undef_macros=...)` (https://github.com/sagemath/cysignals/blob/master/setup.py#L46). `distutils.ccompiler.CCompiler.gen_preprocess_options` generates the compiler flag `-U_FORTIFY_SOURCE` from that.

However, Fedora uses `-Wp,-D_FORTIFY_SOURCE=2`, which is passed directly to the C preprocessor and overrides the `-U` flag.
We override that by passing `-Wp,-U_FORTIFY_SOURCE` via `CPPFLAGS` in the `spkg-install` script.


---

Comment by mkoeppe created at 2020-04-08 23:51:09

This should probably be reported upstream, but to which?


---

Comment by mkoeppe created at 2020-04-09 16:02:35

Reported at https://github.com/sagemath/cysignals/issues/120


---

Comment by mkoeppe created at 2020-04-09 22:57:10

This can be observed to work correctly for `fedora-29-standard` (https://github.com/mkoeppe/sage/runs/572856776),  `fedora-30-standard` (https://github.com/mkoeppe/sage/runs/572856797), `fedora-31-standard` (https://github.com/mkoeppe/sage/runs/572856814).

Ready for review


---

Comment by mkoeppe created at 2020-04-11 16:31:56

Needs review... let's get this into the next beta please


---

Comment by dimpase created at 2020-04-12 04:46:43

lgtm. Regarding upstream, not sure if cysignals has a maintainer now, or Jeroen abandoned it.


---

Comment by dimpase created at 2020-04-12 04:46:43

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-04-12 05:26:37

Thanks!


---

Comment by mkoeppe created at 2020-04-12 23:57:38

Changing priority from major to critical.


---

Comment by mkoeppe created at 2020-04-15 03:20:04

Changing priority from critical to blocker.


---

Comment by vbraun created at 2020-04-16 22:33:46

Resolution: fixed
