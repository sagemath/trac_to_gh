# Issue 33664: sage-bootstrap-python doesn't work with pyenv installed

Issue created by migration from https://trac.sagemath.org/ticket/33901

Original creator: @k3w1k0d3r

Original creation time: 2022-05-25 06:27:00

Keywords: bootstrap, build, python, pyenv

The script sage-bootstrap-python attempts to call a command like
"/path/to/python" -c "..."
Pyenv python treats "python" differently from just python, giving the output:
/home/.../.pyenv/shims/python: line 1: 2: command not found

With pyenv installed and configured normally, the script will never check a non-pyenv version of python, and thus will fail to find a suitable python. My fix was to attempt to remove pyenv from the PATH before testing for python.

I've only confirmed this behavior on arch linux


---

Comment by @k3w1k0d3r created at 2022-05-25 06:28:52

New commits:


---

Comment by @k3w1k0d3r created at 2022-05-25 06:28:52

Set assignee to @k3w1k0d3r.


---

Comment by @k3w1k0d3r created at 2022-05-25 06:28:58

Changing status from new to needs_review.


---

Comment by @k3w1k0d3r created at 2022-05-25 16:40:13

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2022-05-25 16:56:53

Could you please open a bug report with pyenv? It's pretty wild that they install a broken python command in PATH


---

Comment by @k3w1k0d3r created at 2022-05-25 17:32:28

yeah sure

do you think I should give up on this ticket or should I still work on it to make the build not fail?


---

Comment by @k3w1k0d3r created at 2022-05-25 17:35:20

well I'll fix it because it's not too bad, I just used bash-only syntax and for some reason when I tested it locally it still worked


---

Comment by mkoeppe created at 2022-05-25 17:36:37

Yes, we can merge a workaround in Sage. But the bug is in pyenv


---

Comment by git created at 2022-05-25 17:43:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @k3w1k0d3r created at 2022-05-25 17:43:33

great thank you


---

Comment by git created at 2022-05-25 17:53:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-05-25 18:09:30


```
+paths=$(echo $SAGE_ORIG_PATH | tr ":" "\n")
+NEW_PATH=""
+for path in $paths
```

Loops like this are better done with IFS


---

Comment by git created at 2022-05-25 18:09:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @k3w1k0d3r created at 2022-05-25 18:16:21

Replying to [comment:13 mkoeppe]:
> {{{
> +paths=$(echo $SAGE_ORIG_PATH | tr ":" "\n")
> +NEW_PATH=""
> +for path in $paths
> }}}
> Loops like this are better done with IFS
alright I'll change it thanks


---

Comment by git created at 2022-05-25 18:28:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @k3w1k0d3r created at 2022-05-25 18:30:24

I realized my system sh was a symlink to bash instead of dash, which is why my local tests worked. I've now properly tested with dash, so hopefully now everything works.


---

Comment by @k3w1k0d3r created at 2022-05-25 19:08:31

https://github.com/pyenv/pyenv/issues/2378


---

Comment by @k3w1k0d3r created at 2022-05-25 19:53:19

it seems that the issue with pyenv is most likely a misconfiguration on my end of some sort


---

Comment by @k3w1k0d3r created at 2022-05-25 21:07:32

yeah the quotes issue is fixed on my system, but the old script still doesn't work for me. I assume it's because of #29285


---

Comment by @k3w1k0d3r created at 2022-05-25 21:40:28

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-05-25 23:19:54


```
+        *      ) NEW_PATH="$NEW_PATH$path:";;
```

shouldn't the colon be in a different place?


---

Comment by @k3w1k0d3r created at 2022-05-25 23:23:11

I think ":$NEW_PATH$path" also works if that's what you mean.


---

Comment by mkoeppe created at 2022-05-25 23:26:58

I think the constructed path should neither begin nor end with `:` because that would mean that the current directory is included.


---

Comment by @k3w1k0d3r created at 2022-05-25 23:28:42

okay I'll get rid of the extra `:`


---

Comment by mkoeppe created at 2022-05-25 23:31:07

Also could you make the pattern `*pyenv*` a bit more specific?


---

Comment by git created at 2022-05-25 23:44:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-05-26 00:49:21


```
+        '/home/'*'/.pyenv/shims'*);;
```

Well that's now a bit too specific. For example, on macOS, user home directories live in `/Users`. By the way, words don't need to be quoted in these patterns


---

Comment by git created at 2022-05-26 00:52:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @k3w1k0d3r created at 2022-05-26 00:53:21

Replying to [comment:28 mkoeppe]:
> {{{
> +        '/home/'*'/.pyenv/shims'*);;
> }}}
> Well that's now a bit too specific. For example, on macOS, user home directories live in `/Users`. By the way, words don't need to be quoted in these patterns
yeah I didn't think that through very well


---

Comment by mkoeppe created at 2022-05-26 16:04:38


```
+IFS=' '
```

It doesn't matter very much here, but note that this is not the default value of `IFS`.
It would be more idiomatic to either save the old IFS in a variable and then restore it, or to `unset IFS` to restore the default behavior of the shell.


---

Comment by git created at 2022-05-26 18:46:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @k3w1k0d3r created at 2022-05-26 18:49:16

it seems odd that this failed a startup time test right? it doesn't seem like this script ever gets executed after it's already been configured


---

Comment by mkoeppe created at 2022-05-26 18:51:35

The startup time test is safe to ignore. It is much too optimistic regarding the precision of its measurements.


---

Comment by mkoeppe created at 2022-05-26 18:53:50

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-05-26 18:53:50

Thanks for this contribution.


---

Comment by mkoeppe created at 2022-05-26 18:54:39

Changing priority from trivial to major.


---

Comment by vbraun created at 2022-05-29 11:29:06

Resolution: fixed
