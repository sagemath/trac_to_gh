# Issue 26555: py3: Stop to use sort on KeyConvertingDict object

archive/issues_026555.json:
```json
{
    "body": "With python3 we currently have 40 failures of type \n\n```\nTypeError: '<' not supported between instances of 'KeyConvertingDict' and 'KeyConvertingDict'\n```\n\nThese errors comes from the call of `V.sort()` in multi_polynomial_ideal.py\", line 2381, `variety` function.\n\nThe root reason for calling `sort` is for doctest displaying : \n>commit 17f42824d8941b23825fea1a6d82278bd5ef6c74\n>Author: Carl Witty <cwitty`@`newtonlabs.com>\n>Date:   Wed Oct 24 18:36:37 2007 -0700\n>\n>    Sort results of variety(), for better cross-architecture doctest compatibility.\n>    This compensates for the fact that the results of Singular's triangular\n>    decomposition algorithm triangLfak appear in a different order on\n>    different architectures.  (It would be better to fix this in\n>    triangular_decomposition(), but the obvious approach of sorting its\n>    result failed due to TRAC #991.)\n\nAs it will not make a lot of sense to implement comparison operators for KeyConvertingDict this ticket aim at solving the sorting problems at doctests level rather than at python source code level.\n\nIssue created by migration from https://trac.sagemath.org/ticket/26792\n\n",
    "created_at": "2018-11-30T10:37:50Z",
    "labels": [
        "python3",
        "major",
        "enhancement"
    ],
    "title": "py3: Stop to use sort on KeyConvertingDict object",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26555",
    "user": "vklein"
}
```
With python3 we currently have 40 failures of type 

```
TypeError: '<' not supported between instances of 'KeyConvertingDict' and 'KeyConvertingDict'
```

These errors comes from the call of `V.sort()` in multi_polynomial_ideal.py", line 2381, `variety` function.

The root reason for calling `sort` is for doctest displaying : 
>commit 17f42824d8941b23825fea1a6d82278bd5ef6c74
>Author: Carl Witty <cwitty`@`newtonlabs.com>
>Date:   Wed Oct 24 18:36:37 2007 -0700
>
>    Sort results of variety(), for better cross-architecture doctest compatibility.
>    This compensates for the fact that the results of Singular's triangular
>    decomposition algorithm triangLfak appear in a different order on
>    different architectures.  (It would be better to fix this in
>    triangular_decomposition(), but the obvious approach of sorting its
>    result failed due to TRAC #991.)

As it will not make a lot of sense to implement comparison operators for KeyConvertingDict this ticket aim at solving the sorting problems at doctests level rather than at python source code level.

Issue created by migration from https://trac.sagemath.org/ticket/26792





---

archive/issue_comments_373363.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-11-30T17:03:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373363",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_373364.json:
```json
{
    "body": "Add #23572 as dependency for mpoly renaming.",
    "created_at": "2018-12-03T08:54:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373364",
    "user": "vklein"
}
```

Add #23572 as dependency for mpoly renaming.



---

archive/issue_comments_373365.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2019-01-23T10:20:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373365",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_373366.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-01-31T14:30:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373366",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_373367.json:
```json
{
    "body": "Ticket rebased on 8.7.beta1.",
    "created_at": "2019-01-31T14:32:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373367",
    "user": "vklein"
}
```

Ticket rebased on 8.7.beta1.



---

archive/issue_comments_373368.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-01-31T15:35:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373368",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_373369.json:
```json
{
    "body": "Fix mpoly.py doctests and remove #23572 dependency.",
    "created_at": "2019-01-31T15:35:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373369",
    "user": "vklein"
}
```

Fix mpoly.py doctests and remove #23572 dependency.



---

archive/issue_comments_373370.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-01-31T15:51:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373370",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_373371.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-01-31T16:13:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373371",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_373372.json:
```json
{
    "body": "ticket on hold in order to let priority for #23572",
    "created_at": "2019-01-31T16:15:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373372",
    "user": "vklein"
}
```

ticket on hold in order to let priority for #23572



---

archive/issue_comments_373373.json:
```json
{
    "body": "time to start again with this ticket ; this should be a great step forward when done",
    "created_at": "2019-02-15T20:24:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373373",
    "user": "chapoton"
}
```

time to start again with this ticket ; this should be a great step forward when done



---

archive/issue_comments_373374.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-02-16T19:31:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373374",
    "user": "chapoton"
}
```

New commits:



---

archive/issue_comments_373375.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-02-16T19:31:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373375",
    "user": "chapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_373376.json:
```json
{
    "body": "remains one failing doctest",
    "created_at": "2019-02-17T07:32:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373376",
    "user": "chapoton"
}
```

remains one failing doctest



---

archive/issue_comments_373377.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-02-17T07:32:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373377",
    "user": "chapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_373378.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-18T19:15:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373378",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_373379.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-02-18T19:16:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373379",
    "user": "chapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_373380.json:
```json
{
    "body": "I get a merge conflict with 8.7.beta4: src/sage/tests/books/computational-mathematics-with-sagemath/mpoly_doctest.py",
    "created_at": "2019-02-18T19:41:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373380",
    "user": "jhpalmieri"
}
```

I get a merge conflict with 8.7.beta4: src/sage/tests/books/computational-mathematics-with-sagemath/mpoly_doctest.py



---

archive/issue_comments_373381.json:
```json
{
    "body": "There is a related doctest failure in `misc/converting_dict.py`. Four Python 3 failures in the develop branch are replaced by 1 with this branch.",
    "created_at": "2019-02-18T19:51:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373381",
    "user": "jhpalmieri"
}
```

There is a related doctest failure in `misc/converting_dict.py`. Four Python 3 failures in the develop branch are replaced by 1 with this branch.



---

archive/issue_comments_373382.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-18T20:51:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373382",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_373383.json:
```json
{
    "body": "The new test passes with py3 but not py2.",
    "created_at": "2019-02-18T23:33:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373383",
    "user": "jhpalmieri"
}
```

The new test passes with py3 but not py2.



---

archive/issue_comments_373384.json:
```json
{
    "body": "and before my last commit it was the contrary. Probably one should make sure that the repr of these \"dicts\" is conveniently sorted in the same way for both py2 and py3.",
    "created_at": "2019-02-19T08:10:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373384",
    "user": "chapoton"
}
```

and before my last commit it was the contrary. Probably one should make sure that the repr of these "dicts" is conveniently sorted in the same way for both py2 and py3.



---

archive/issue_comments_373385.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-02-19T08:10:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373385",
    "user": "chapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_373386.json:
```json
{
    "body": "I will fix that.",
    "created_at": "2019-02-19T08:20:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373386",
    "user": "vklein"
}
```

I will fix that.



---

archive/issue_comments_373387.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-19T10:01:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373387",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_373388.json:
```json
{
    "body": "Replying to [comment:24 chapoton]:\n> and before my last commit it was the contrary. Probably one should make sure that the repr of these \"dicts\" is conveniently sorted in the same way for both py2 and py3.\n\nThe `__repr__` called by `KeyConvertingDict` is the one inherited from python's `dict` i don't think we should override it just for doctests compatibility. I prefer to modify the doctests.",
    "created_at": "2019-02-19T10:48:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373388",
    "user": "vklein"
}
```

Replying to [comment:24 chapoton]:
> and before my last commit it was the contrary. Probably one should make sure that the repr of these "dicts" is conveniently sorted in the same way for both py2 and py3.

The `__repr__` called by `KeyConvertingDict` is the one inherited from python's `dict` i don't think we should override it just for doctests compatibility. I prefer to modify the doctests.



---

archive/issue_comments_373389.json:
```json
{
    "body": "I was talking about the ipython representation. This is different (already for dict) from using str or repr. Using that in the repr would be better.",
    "created_at": "2019-02-19T10:49:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373389",
    "user": "chapoton"
}
```

I was talking about the ipython representation. This is different (already for dict) from using str or repr. Using that in the repr would be better.



---

archive/issue_comments_373390.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-19T12:29:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373390",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_373391.json:
```json
{
    "body": "Replying to [comment:28 chapoton]:\n> I was talking about the ipython representation. This is different (already for dict) from using str or repr. Using that in the repr would be better.\n\nI think you mean using Ipython pretty print. I don't know why it is like it's not called by default for `KeyConvertingDict` as it is for `dict`: \n\nAdding some traces :\n\n```\ndiff --git a/src/sage/misc/converting_dict.py b/src/sage/misc/converting_dict.py\nindex f9bdb17..f08e13f 100644\n--- a/src/sage/misc/converting_dict.py\n+++ b/src/sage/misc/converting_dict.py\n@@ -140,6 +140,13 @@ class KeyConvertingDict(dict):\n         key = self.key_conversion_function(key)\n         return super(KeyConvertingDict, self).__setitem__(key, value)\n \n+    def __repr__(self):\n+        print(\"call __repr__\")\n+        return super(KeyConvertingDict, self).__repr__()\n+\n+    def _repr_pretty_(self, p, cycle):\n+        print(\"pretty\")\n+\n     def __delitem__(self, key):\n         r\"\"\"\n         Remove a mapping from the dictionary.\n```\n\n\nYou get this:\n\n```\nsage: K.<x,y> = QQ[]\nsage: I = ideal([x^2+2*y-5,x+y+3])\nsage: v = I.variety(AA)[0]; v\ncall __repr__\n{x: 4.464101615137755?, y: -7.464101615137755?}\nsage: from IPython.lib.pretty import pprint\nsage: pprint(v)\npretty\n```\n",
    "created_at": "2019-02-19T13:23:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373391",
    "user": "vklein"
}
```

Replying to [comment:28 chapoton]:
> I was talking about the ipython representation. This is different (already for dict) from using str or repr. Using that in the repr would be better.

I think you mean using Ipython pretty print. I don't know why it is like it's not called by default for `KeyConvertingDict` as it is for `dict`: 

Adding some traces :

```
diff --git a/src/sage/misc/converting_dict.py b/src/sage/misc/converting_dict.py
index f9bdb17..f08e13f 100644
--- a/src/sage/misc/converting_dict.py
+++ b/src/sage/misc/converting_dict.py
@@ -140,6 +140,13 @@ class KeyConvertingDict(dict):
         key = self.key_conversion_function(key)
         return super(KeyConvertingDict, self).__setitem__(key, value)
 
+    def __repr__(self):
+        print("call __repr__")
+        return super(KeyConvertingDict, self).__repr__()
+
+    def _repr_pretty_(self, p, cycle):
+        print("pretty")
+
     def __delitem__(self, key):
         r"""
         Remove a mapping from the dictionary.
```


You get this:

```
sage: K.<x,y> = QQ[]
sage: I = ideal([x^2+2*y-5,x+y+3])
sage: v = I.variety(AA)[0]; v
call __repr__
{x: 4.464101615137755?, y: -7.464101615137755?}
sage: from IPython.lib.pretty import pprint
sage: pprint(v)
pretty
```




---

archive/issue_comments_373392.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-20T08:55:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373392",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_373393.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-02-20T09:08:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373393",
    "user": "vklein"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_373394.json:
```json
{
    "body": "I fixed the remaining cases using `#py2` `#py3` flags as it seems to be the most readable solution right now. \n\nThere is still one failling test sort related to `KeyConvertingDict`: \n\n```\nFile \"src/sage/tests/books/computational-mathematics-with-sagemath/mpoly_doctest.py\", line 409, in sage.tests.books.computational-mathematics-with-sagemath.mpoly_doctest\nFailed example:\n    J.variety(RealField(51))\nExpected:\n    [{y: 396340.890166545, x: -14.1660266425312}]\nGot:\n    [{y: 396340.890166545, x: -35.0231212211684}]\n```\n\n\nThe difference being the value of x i think this is out the scope of this ticket.",
    "created_at": "2019-02-20T09:08:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373394",
    "user": "vklein"
}
```

I fixed the remaining cases using `#py2` `#py3` flags as it seems to be the most readable solution right now. 

There is still one failling test sort related to `KeyConvertingDict`: 

```
File "src/sage/tests/books/computational-mathematics-with-sagemath/mpoly_doctest.py", line 409, in sage.tests.books.computational-mathematics-with-sagemath.mpoly_doctest
Failed example:
    J.variety(RealField(51))
Expected:
    [{y: 396340.890166545, x: -14.1660266425312}]
Got:
    [{y: 396340.890166545, x: -35.0231212211684}]
```


The difference being the value of x i think this is out the scope of this ticket.



---

archive/issue_comments_373395.json:
```json
{
    "body": "ok, let us move on here.",
    "created_at": "2019-02-20T12:59:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373395",
    "user": "chapoton"
}
```

ok, let us move on here.



---

archive/issue_comments_373396.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-02-20T12:59:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373396",
    "user": "chapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_373397.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-02-22T22:01:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26555",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26555#issuecomment-373397",
    "user": "vbraun"
}
```

Resolution: fixed
