# Issue 26555: py3: Stop to use sort on KeyConvertingDict object

Issue created by migration from https://trac.sagemath.org/ticket/26792

Original creator: vklein

Original creation time: 2018-11-30 10:37:50

With python3 we currently have 40 failures of type 

```
TypeError: '<' not supported between instances of 'KeyConvertingDict' and 'KeyConvertingDict'
```

These errors comes from the call of `V.sort()` in multi_polynomial_ideal.py", line 2381, `variety` function.

The root reason for calling `sort` is for doctest displaying : 
>commit 17f42824d8941b23825fea1a6d82278bd5ef6c74
>Author: Carl Witty <cwitty`@`newtonlabs.com>
>Date:   Wed Oct 24 18:36:37 2007 -0700
>
>    Sort results of variety(), for better cross-architecture doctest compatibility.
>    This compensates for the fact that the results of Singular's triangular
>    decomposition algorithm triangLfak appear in a different order on
>    different architectures.  (It would be better to fix this in
>    triangular_decomposition(), but the obvious approach of sorting its
>    result failed due to TRAC #991.)

As it will not make a lot of sense to implement comparison operators for KeyConvertingDict this ticket aim at solving the sorting problems at doctests level rather than at python source code level.


---

Comment by git created at 2018-11-30 17:03:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vklein created at 2018-12-03 08:54:02

Add #23572 as dependency for mpoly renaming.


---

Comment by git created at 2019-01-23 10:20:44

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2019-01-31 14:30:40

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vklein created at 2019-01-31 14:32:52

Ticket rebased on 8.7.beta1.


---

Comment by git created at 2019-01-31 15:35:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vklein created at 2019-01-31 15:35:43

Fix mpoly.py doctests and remove #23572 dependency.


---

Comment by git created at 2019-01-31 15:51:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-01-31 16:13:07

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vklein created at 2019-01-31 16:15:11

ticket on hold in order to let priority for #23572


---

Comment by chapoton created at 2019-02-15 20:24:37

time to start again with this ticket ; this should be a great step forward when done


---

Comment by chapoton created at 2019-02-16 19:31:40

New commits:


---

Comment by chapoton created at 2019-02-16 19:31:40

Changing status from new to needs_review.


---

Comment by chapoton created at 2019-02-17 07:32:40

remains one failing doctest


---

Comment by chapoton created at 2019-02-17 07:32:40

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-02-18 19:15:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-02-18 19:16:01

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2019-02-18 19:41:59

I get a merge conflict with 8.7.beta4: src/sage/tests/books/computational-mathematics-with-sagemath/mpoly_doctest.py


---

Comment by jhpalmieri created at 2019-02-18 19:51:27

There is a related doctest failure in `misc/converting_dict.py`. Four Python 3 failures in the develop branch are replaced by 1 with this branch.


---

Comment by git created at 2019-02-18 20:51:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2019-02-18 23:33:46

The new test passes with py3 but not py2.


---

Comment by chapoton created at 2019-02-19 08:10:10

and before my last commit it was the contrary. Probably one should make sure that the repr of these "dicts" is conveniently sorted in the same way for both py2 and py3.


---

Comment by chapoton created at 2019-02-19 08:10:10

Changing status from needs_review to needs_work.


---

Comment by vklein created at 2019-02-19 08:20:42

I will fix that.


---

Comment by git created at 2019-02-19 10:01:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vklein created at 2019-02-19 10:48:13

Replying to [comment:24 chapoton]:
> and before my last commit it was the contrary. Probably one should make sure that the repr of these "dicts" is conveniently sorted in the same way for both py2 and py3.

The `__repr__` called by `KeyConvertingDict` is the one inherited from python's `dict` i don't think we should override it just for doctests compatibility. I prefer to modify the doctests.


---

Comment by chapoton created at 2019-02-19 10:49:34

I was talking about the ipython representation. This is different (already for dict) from using str or repr. Using that in the repr would be better.


---

Comment by git created at 2019-02-19 12:29:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vklein created at 2019-02-19 13:23:13

Replying to [comment:28 chapoton]:
> I was talking about the ipython representation. This is different (already for dict) from using str or repr. Using that in the repr would be better.

I think you mean using Ipython pretty print. I don't know why it is like it's not called by default for `KeyConvertingDict` as it is for `dict`: 

Adding some traces :

```
diff --git a/src/sage/misc/converting_dict.py b/src/sage/misc/converting_dict.py
index f9bdb17..f08e13f 100644
--- a/src/sage/misc/converting_dict.py
+++ b/src/sage/misc/converting_dict.py
@@ -140,6 +140,13 @@ class KeyConvertingDict(dict):
         key = self.key_conversion_function(key)
         return super(KeyConvertingDict, self).__setitem__(key, value)
 
+    def __repr__(self):
+        print("call __repr__")
+        return super(KeyConvertingDict, self).__repr__()
+
+    def _repr_pretty_(self, p, cycle):
+        print("pretty")
+
     def __delitem__(self, key):
         r"""
         Remove a mapping from the dictionary.
```


You get this:

```
sage: K.<x,y> = QQ[]
sage: I = ideal([x^2+2*y-5,x+y+3])
sage: v = I.variety(AA)[0]; v
call __repr__
{x: 4.464101615137755?, y: -7.464101615137755?}
sage: from IPython.lib.pretty import pprint
sage: pprint(v)
pretty
```



---

Comment by git created at 2019-02-20 08:55:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vklein created at 2019-02-20 09:08:42

Changing status from needs_work to needs_review.


---

Comment by vklein created at 2019-02-20 09:08:42

I fixed the remaining cases using `#py2` `#py3` flags as it seems to be the most readable solution right now. 

There is still one failling test sort related to `KeyConvertingDict`: 

```
File "src/sage/tests/books/computational-mathematics-with-sagemath/mpoly_doctest.py", line 409, in sage.tests.books.computational-mathematics-with-sagemath.mpoly_doctest
Failed example:
    J.variety(RealField(51))
Expected:
    [{y: 396340.890166545, x: -14.1660266425312}]
Got:
    [{y: 396340.890166545, x: -35.0231212211684}]
```


The difference being the value of x i think this is out the scope of this ticket.


---

Comment by chapoton created at 2019-02-20 12:59:28

ok, let us move on here.


---

Comment by chapoton created at 2019-02-20 12:59:28

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-02-22 22:01:10

Resolution: fixed
