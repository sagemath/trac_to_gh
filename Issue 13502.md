# Issue 13502: atlas spkg does not take the SAGE_ATLAS_ARCH variable into account when SAGE_FAT_BINARY is set to 'yes'

Issue created by migration from https://trac.sagemath.org/ticket/13706

Original creator: tmonteil

Original creation time: 2012-11-13 08:38:34

Assignee: GeorgSWeber

Keywords: atlas, days43

The spkg-install code of atlas spkg is structured as follow (from line 192):


```
if SAGE_FAT_BINARY == 'yes':
    arch = 'HAMMER'
if SAGE_ATLAS_ARCH is defined:
    arch = 'SAGE_ATLAS_ARCH'
```


It has the effect not to take the SAGE_ATLAS_ARCH variable into account when SAGE_FAT_BINARY is set to 'yes'. I consider it as a bug, since on may want to build a fat binary for an architecture that is not HAMMER (for example, one may want to build a fat binary able to run on Pentium 3).


---

Attachment

proposal minimalistic patch


---

Comment by tmonteil created at 2012-11-13 08:47:52

May it be cleaner to switch the two conditions instead of replacing the 'elif' by a 'if' ? Also, why was the arch 'HAMMER' chosen by default ?


---

Comment by vbraun created at 2012-11-15 17:39:32

#10508 uses the new x86x87 target for building ATLAS on i386 with SAGE_FAT_BINARY, so I'm pretty sure that this has been fixed for a while now.


---

Comment by tmonteil created at 2012-11-15 19:51:29

As of today, this seems not to be fixed in the spkg proposed in #10508 : SAGE_FAT_BINARY default still overwrites SAGE_ATLAS_ARCH when it is set.

SAGE_FAT_BINARY is not only used for atlas, but also for (according to grep in the sage-5.4 sources) : ecm-6.3.p8 libm4ri-20120613 mpir-2.4.0.p6 polybori-0.8.2 r-2.14.0.p6 hence one may want to take advantage of it and be more precise by setting the SAGE_ATLAS_ARCH variable.

By the way, it is interesting to see that, when SAGE_FAT_BINARY=='yes' in sage-5.4, libm4ri-20120613 explicitely disables SSE2 set of instructions and atlas-3.8.4.p1 explicitely enables it.

Also, in the #10508 package, configure_base() method adds 3DNow set of instructions to some Intel architecture, which seems not to know it: [https://en.wikipedia.org/wiki/3DNow!](https://en.wikipedia.org/wiki/3DNow!)


---

Comment by vbraun created at 2012-11-15 22:18:51

> SAGE_FAT_BINARY default still overwrites SAGE_ATLAS_ARCH when it is set.

The combination is nonsensical: You either want a binary that runs on all reasonably old hardware for distribution, or you want to specify the architecture in detail. Which one is it? I don't mind adding support for nonsensical combinations if there is demand. But the only bug here is that it requires SSE2 on i386, which is probably too much. Note that the old ATLAS  (which we currently ship, and probably will for a while) doesn't have "generic" archdefs to start with so it always was a crapshot.

> Also, in the #10508 package, configure_base() method adds 3DNow set of 
> instructions to some Intel architecture, which seems not to know it: 
> https://en.wikipedia.org/wiki/3DNow! 

So? Sage will never run with only the original 8086 instruction set. For many of the processors on your web page you'll have to recompile a linux distro from source, never mind Sage.


---

Comment by vbraun created at 2012-12-18 16:28:35

Close as invalid since everybody seems to agree that the combination in nonsensical and the SSE2 issue is addressed at #10508.


---

Comment by vbraun created at 2012-12-18 16:28:35

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2013-05-19 12:54:35

Changing status from needs_review to positive_review.


---

Comment by tmonteil created at 2013-05-19 15:31:44

I disagree with this positive review. 

- "everybody seems to agree that the combination in nonsensical" -> Citation needed !

- "You either want a binary that runs on all reasonably old hardware for distribution, or you want to specify the architecture in detail" -> i want both, that is why local and global variables are made for !

- The fact that the cross-packages SAGE_FAT_BINARY variable takes precedence over the atlas-specific variable SAGE_ATLAS_ARCH is not addressed in #10508.

- Currently, if i want to tune atlas for a specific old architecture, and at the same time tell other packages not to use too recent sets of instructions (which is coherent), i simply can not. I still consider this as a bug. It makes all the predefined atlas architectures settings useless: if i want to specify one of them, i can not use SAGE_FAT_BINARY for the other packages, which impossible for an old architecture.


---

Comment by vbraun created at 2013-05-19 16:02:22

You can recompile atlas after installing sage using the atlas-config script. This allows your obscure use case without burdening the process for making binary distributions. As a plus you'll actually have a chance of getting the correct tuning values since the script can disable CPU sleep states.

#10508 addresses the issue presented here in that we don't require SSE for generic i386 builds any more.


---

Comment by tmonteil created at 2013-05-19 17:00:26

Changing keywords from "atlas, days43" to "atlas, days43 denigration community management".


---

Comment by tmonteil created at 2013-05-19 17:00:26

Understood, i won't bother anymore about this.


---

Comment by jdemeyer created at 2013-05-19 19:52:31

Replying to [comment:8 tmonteil]:
> - "You either want a binary that runs on all reasonably old hardware for distribution, or you want to specify the architecture in detail" -> i want both, that is why local and global variables are made for !

I don't understand what "both" could possibly mean. How can it run on all architectures while still being optimized for one architecture? If it needs to run on all architectures, it cannot use Core2-specific instructions for example, so how could be optimized for Core2?

> Currently, if i want to tune atlas for a specific old architecture, and at the same time tell other packages not to use too recent sets of instructions (which is coherent), i simply can not.
1) If the "specific old architecture" is the one you're building on, it's easy: don't set any environment variable and build as usual.

2) If the "specific old architecture" is _not_ the one you're building on but you still don't want a generic binary: first of all, why would you want that? But this can probably be achieved by setting specific `CFLAGS`, although this isn't really supported.


---

Comment by jdemeyer created at 2013-05-24 12:29:46

Resolution: wontfix


---

Comment by jdemeyer created at 2013-05-24 12:29:46

No answer, closing this.


---

Comment by leif created at 2013-06-17 16:02:17

Replying to [comment:11 jdemeyer]:
> Replying to [comment:8 tmonteil]:
> > - "You either want a binary that runs on all reasonably old hardware for distribution, or you want to specify the architecture in detail" -> i want both, that is why local and global variables are made for !
> 
> I don't understand what "both" could possibly mean.

Well, he apparently meant he wants to specify what "reasonably old" means to him (or, more precisely, what's needed / more appropriate in his use case).

To me doesn't sound too exotic or "obscure"...


---

Comment by vbraun created at 2013-06-17 16:06:33

You can (and always could) specify precisely what you want for ATLAS using SAGE_ATLAS_ARCH.


---

Comment by leif created at 2013-06-17 19:13:13

Replying to [comment:14 vbraun]:
> You can (and always could) specify precisely what you want for ATLAS using SAGE_ATLAS_ARCH.

... unless you also specified `SAGE_FAT_BINARY=yes`, which is what this ticket was all about. ;-)


---

Comment by vbraun created at 2013-06-17 19:17:14

That is because `SAGE_FAT_BINARY` really means: give me what Sage considers to be sufficiently generic to run on a variety of old hardware.


---

Comment by leif created at 2013-06-17 19:21:49

Replying to [comment:16 vbraun]:
> That is because `SAGE_FAT_BINARY` really means: give me what Sage considers to be sufficiently generic to run on a variety of old hardware.

.. which is a misinterpretation of "fat".


---

Comment by vbraun created at 2013-06-17 19:28:13

If you are complaining about the misnomer then you are quite late to the party ;-)


---

Comment by leif created at 2013-06-17 19:46:05

Replying to [comment:18 vbraun]:
> If you are complaining about the misnomer then you are quite late to the party ;-)

You know, je später die Gäste...

(Although that's not the first time I'm arguing that way.)

The MPIR spkg supports exactly what's meant by "fat binary", although on x86 / x86_64 only IIRC.


---

Comment by jdemeyer created at 2013-06-17 20:36:03

For leif, we should support the variable

```
SAGE_FAT_BINARY_OR_GENERIC_BINARY_DEPENDING_ON_THE_PACKAGE_AND_PROCESSOR=yes
```



---

Comment by tmonteil created at 2019-08-27 19:45:19

Changing keywords from "atlas, days43 denigration community management" to "atlas, days43, denigration, community, management, sdl".
