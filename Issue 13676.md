# Issue 13676: Fix doctest for amout of swap

archive/issues_013676.json:
```json
{
    "body": "Assignee: jason\n\nAllow zero-sized swap in a doctest.\n\nIssue created by migration from https://trac.sagemath.org/ticket/13880\n\n",
    "created_at": "2012-12-29T19:18:53Z",
    "labels": [
        "misc",
        "major",
        "bug"
    ],
    "title": "Fix doctest for amout of swap",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13676",
    "user": "vbraun"
}
```
Assignee: jason

Allow zero-sized swap in a doctest.

Issue created by migration from https://trac.sagemath.org/ticket/13880





---

archive/issue_comments_169442.json:
```json
{
    "body": "Attachment\n\nUpdated patch",
    "created_at": "2012-12-29T19:22:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169442",
    "user": "vbraun"
}
```

Attachment

Updated patch



---

archive/issue_comments_169443.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-12-29T19:23:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169443",
    "user": "vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_169444.json:
```json
{
    "body": "Why `available_swap() in ZZ`?\n\n\n\n\nI'm not sure whether the fallback value of `virtual_memory_limit()` (`self.available_swap() + self.available_ram()`) is appropriate.\n\nIt doesn't take into account the memory already used by the process, and the available (or total) swap can be much larger than what's available to *a single process* (e.g. 16 GB swap space on a 32-bit processor or OS); similar for the RAM \"available\".",
    "created_at": "2012-12-29T21:45:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169444",
    "user": "leif"
}
```

Why `available_swap() in ZZ`?




I'm not sure whether the fallback value of `virtual_memory_limit()` (`self.available_swap() + self.available_ram()`) is appropriate.

It doesn't take into account the memory already used by the process, and the available (or total) swap can be much larger than what's available to *a single process* (e.g. 16 GB swap space on a 32-bit processor or OS); similar for the RAM "available".



---

archive/issue_comments_169445.json:
```json
{
    "body": "Replying to [comment:3 leif]:\n> Why `available_swap() in ZZ`?\n\nTo test that it returns an integer as promised in the docstring.\n\nI've added a manual 2GB limit for the rare case of 32-bit machines with >> 2GB ram.",
    "created_at": "2012-12-29T22:20:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169445",
    "user": "vbraun"
}
```

Replying to [comment:3 leif]:
> Why `available_swap() in ZZ`?

To test that it returns an integer as promised in the docstring.

I've added a manual 2GB limit for the rare case of 32-bit machines with >> 2GB ram.



---

archive/issue_comments_169446.json:
```json
{
    "body": "Replying to [comment:4 vbraun]:\n> Replying to [comment:3 leif]:\n> > Why `available_swap() in ZZ`?\n> \n> To test that it returns an integer as promised in the docstring.\n\nNot that obvious, to me at least... ;-)\n\nStill wonder whether we shouldn't also test that the result is actually non-negative.\n\n\n\n\n> I've added a manual 2GB limit for the rare case of 32-bit machines with >> 2GB ram.\n\nOk.  (The more common case -- which I meant -- is having >> 2 GB *swap space*, which is handled now as well.)\n\n\n\n\nSlightly related (`memory_info.py` probably deserved its own ticket):\n\n`available_ram()` should probably have an optional boolean parameter to not just return the amount of *free* memory (\"`MemFree`\"), as this can often be pretty close to zero, due to buffering and especially caching.  (I.e., the amount of \"available\" RAM, allocatable by a process without running out of [physical] memory, might in fact be much larger, regardless of whether swap space is available or not.)  \n\nAs is, although its docstring contains \"free\" in parentheses, the term \"available RAM\" is IMHO potentially misleading.\n\nW.r.t. GAP, I think it may currently \"run out of memory\" simply because [there's no or not enough swap space *and*] most (or at least much) of the physical memory is eaten up by just caches.",
    "created_at": "2012-12-30T01:46:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169446",
    "user": "leif"
}
```

Replying to [comment:4 vbraun]:
> Replying to [comment:3 leif]:
> > Why `available_swap() in ZZ`?
> 
> To test that it returns an integer as promised in the docstring.

Not that obvious, to me at least... ;-)

Still wonder whether we shouldn't also test that the result is actually non-negative.




> I've added a manual 2GB limit for the rare case of 32-bit machines with >> 2GB ram.

Ok.  (The more common case -- which I meant -- is having >> 2 GB *swap space*, which is handled now as well.)




Slightly related (`memory_info.py` probably deserved its own ticket):

`available_ram()` should probably have an optional boolean parameter to not just return the amount of *free* memory ("`MemFree`"), as this can often be pretty close to zero, due to buffering and especially caching.  (I.e., the amount of "available" RAM, allocatable by a process without running out of [physical] memory, might in fact be much larger, regardless of whether swap space is available or not.)  

As is, although its docstring contains "free" in parentheses, the term "available RAM" is IMHO potentially misleading.

W.r.t. GAP, I think it may currently "run out of memory" simply because [there's no or not enough swap space *and*] most (or at least much) of the physical memory is eaten up by just caches.



---

archive/issue_comments_169447.json:
```json
{
    "body": "I disagree with\n\n```\nsuggested_size = min(suggested_size, int(mem.virtual_memory_limit()/10))\n```\n\nThis `virtual_memory_limit` is *per-process*, so the suggested size should be roughly equal to `virtual_memory_limit`, not much less. Maybe something like\n\n```\n# Respect ulimit -v, use slightly less than maximum allowed amount of memory\nsuggested_size = min(suggested_size, int(mem.virtual_memory_limit()*7/8))\n```\n",
    "created_at": "2012-12-30T08:51:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169447",
    "user": "jdemeyer"
}
```

I disagree with

```
suggested_size = min(suggested_size, int(mem.virtual_memory_limit()/10))
```

This `virtual_memory_limit` is *per-process*, so the suggested size should be roughly equal to `virtual_memory_limit`, not much less. Maybe something like

```
# Respect ulimit -v, use slightly less than maximum allowed amount of memory
suggested_size = min(suggested_size, int(mem.virtual_memory_limit()*7/8))
```




---

archive/issue_comments_169448.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2012-12-30T09:03:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169448",
    "user": "jdemeyer"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_169449.json:
```json
{
    "body": "I'm sure you can improve on `available_ram()` but its good enough for starting GAP, I think. The perfect is the enemy of the good.\n\nFor libGAP the pool is actually in the Sage process, so what Jeroen suggests would be a bad idea.\n\nAlso, I don't think the user's intention when setting `ulimit -v` was for Sage to spawn a couple of processes that each try to get as close as possible to the limit.",
    "created_at": "2012-12-30T10:21:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169449",
    "user": "vbraun"
}
```

I'm sure you can improve on `available_ram()` but its good enough for starting GAP, I think. The perfect is the enemy of the good.

For libGAP the pool is actually in the Sage process, so what Jeroen suggests would be a bad idea.

Also, I don't think the user's intention when setting `ulimit -v` was for Sage to spawn a couple of processes that each try to get as close as possible to the limit.



---

archive/issue_comments_169450.json:
```json
{
    "body": "Replying to [comment:8 vbraun]:\n> I'm sure you can improve on `available_ram()` but its good enough for starting GAP, I think. The perfect is the enemy of the good.\nBut I'd say that this patch actually makes things worse than they are. GAP currently works fine with `ulimit -v`, it automatically adjusts (remember the \"halving pool size\" messages).\n\n> For libGAP the pool is actually in the Sage process, so what Jeroen suggests would be a bad idea.\nNo, because this ticket doesn't refer to libGAP.\n\n> Also, I don't think the user's intention when setting `ulimit -v` was for Sage to spawn a couple of processes that each try to get as close as possible to the limit.\nI don't think the user intends GAP to take 1/10th of the memory either. If I would set the memory limit to 2GB and GAP doesn't want to allocate 300MB, I would be quite surprised.\n\nI do agree this is all bikeshedding, that's why I intentionally don't set this to needs_work.",
    "created_at": "2012-12-30T10:58:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169450",
    "user": "jdemeyer"
}
```

Replying to [comment:8 vbraun]:
> I'm sure you can improve on `available_ram()` but its good enough for starting GAP, I think. The perfect is the enemy of the good.
But I'd say that this patch actually makes things worse than they are. GAP currently works fine with `ulimit -v`, it automatically adjusts (remember the "halving pool size" messages).

> For libGAP the pool is actually in the Sage process, so what Jeroen suggests would be a bad idea.
No, because this ticket doesn't refer to libGAP.

> Also, I don't think the user's intention when setting `ulimit -v` was for Sage to spawn a couple of processes that each try to get as close as possible to the limit.
I don't think the user intends GAP to take 1/10th of the memory either. If I would set the memory limit to 2GB and GAP doesn't want to allocate 300MB, I would be quite surprised.

I do agree this is all bikeshedding, that's why I intentionally don't set this to needs_work.



---

archive/issue_comments_169451.json:
```json
{
    "body": "Replying to [comment:9 jdemeyer]:\n> But I'd say that this patch actually makes things worse than they are. GAP currently works fine with `ulimit -v`, it automatically adjusts (remember the \"halving pool size\" messages).\n\nNot if you use libgap. It also adjusts to the point where you don't have any virtual memory left for Sage and then other stuff runs of of memory.",
    "created_at": "2012-12-30T11:15:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169451",
    "user": "vbraun"
}
```

Replying to [comment:9 jdemeyer]:
> But I'd say that this patch actually makes things worse than they are. GAP currently works fine with `ulimit -v`, it automatically adjusts (remember the "halving pool size" messages).

Not if you use libgap. It also adjusts to the point where you don't have any virtual memory left for Sage and then other stuff runs of of memory.



---

archive/issue_comments_169452.json:
```json
{
    "body": "The libGAP discussion IMHO belongs to another ticket (and is IMHO pretty irrelevant at this point).  Dima mentioned the GAP developers seem to be working on a new memory manager, probably also because the current one is unsuitable for a library, at least when used together with other libraries or memory managers.\n\n\n\n\nWould it make sense to use a different pool size for doctesting (i.e., a close[r]-to-minimal one)?\n\n\n\n\nI still believe the current implementation will prevent GAP from working if the RAM is filled up with buffers and caches (and there's no or \"not enough\" swap space), which to me doesn't seem to be too untypical.  Haven't tried yet though.",
    "created_at": "2012-12-30T18:56:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169452",
    "user": "leif"
}
```

The libGAP discussion IMHO belongs to another ticket (and is IMHO pretty irrelevant at this point).  Dima mentioned the GAP developers seem to be working on a new memory manager, probably also because the current one is unsuitable for a library, at least when used together with other libraries or memory managers.




Would it make sense to use a different pool size for doctesting (i.e., a close[r]-to-minimal one)?




I still believe the current implementation will prevent GAP from working if the RAM is filled up with buffers and caches (and there's no or "not enough" swap space), which to me doesn't seem to be too untypical.  Haven't tried yet though.



---

archive/issue_comments_169453.json:
```json
{
    "body": "The libGAP discussion is relevant because they share the function to determine the pool size.\n\nIf you have neither free ram nor any swap then we'll still reserve a pool that is large enough to run all long doctests.",
    "created_at": "2012-12-30T20:08:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169453",
    "user": "vbraun"
}
```

The libGAP discussion is relevant because they share the function to determine the pool size.

If you have neither free ram nor any swap then we'll still reserve a pool that is large enough to run all long doctests.



---

archive/issue_comments_169454.json:
```json
{
    "body": "Replying to [comment:12 vbraun]:\n> The libGAP discussion is relevant because they share the function to determine the pool size.\nPerhaps the `suggested_size` routine needs a flag `for_libgap=true/false` then, to compute appropriate defaults for either situation. Obviously, the two cases ask for separate considerations in the face of per-process limits.\n\nIsn't this ticket dealing with a sage in which libgap is non-existent? patching this upon introduction of libgap is rather straightforward.",
    "created_at": "2012-12-30T20:45:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169454",
    "user": "nbruin"
}
```

Replying to [comment:12 vbraun]:
> The libGAP discussion is relevant because they share the function to determine the pool size.
Perhaps the `suggested_size` routine needs a flag `for_libgap=true/false` then, to compute appropriate defaults for either situation. Obviously, the two cases ask for separate considerations in the face of per-process limits.

Isn't this ticket dealing with a sage in which libgap is non-existent? patching this upon introduction of libgap is rather straightforward.



---

archive/issue_comments_169455.json:
```json
{
    "body": "Replying to [comment:13 nbruin]:\n> Isn't this ticket dealing with a sage in which libgap is non-existent? patching this upon introduction of libgap is rather straightforward.\n\nThat's what I meant with (currently) \"irrelevant\".  (Besides that libGAP may come with a new / alternate memory manager when Sage is \"ready\" for it.)",
    "created_at": "2012-12-30T21:08:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169455",
    "user": "leif"
}
```

Replying to [comment:13 nbruin]:
> Isn't this ticket dealing with a sage in which libgap is non-existent? patching this upon introduction of libgap is rather straightforward.

That's what I meant with (currently) "irrelevant".  (Besides that libGAP may come with a new / alternate memory manager when Sage is "ready" for it.)



---

archive/issue_comments_169456.json:
```json
{
    "body": "Replying to [comment:12 vbraun]:\n> If you have neither free ram nor any swap then we'll still reserve a pool that is large enough to run all long doctests.\n\nOk.  That's probably enough for \"ordinary\" Sage sessions as well.\n\nNot sure right now how it behaves when users happen to need a larger pool size.  (They should get an appropriate error message, and the pool size should be easily customizable.  AFAIK, the latter currently requires modifying `$DOT_SAGE/init.sage`.)",
    "created_at": "2012-12-30T21:22:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169456",
    "user": "leif"
}
```

Replying to [comment:12 vbraun]:
> If you have neither free ram nor any swap then we'll still reserve a pool that is large enough to run all long doctests.

Ok.  That's probably enough for "ordinary" Sage sessions as well.

Not sure right now how it behaves when users happen to need a larger pool size.  (They should get an appropriate error message, and the pool size should be easily customizable.  AFAIK, the latter currently requires modifying `$DOT_SAGE/init.sage`.)



---

archive/issue_comments_169457.json:
```json
{
    "body": "You can always use `sage.interfaces.gap.set_gap_memory_pool_size()` before starting any gap computation if you want to set it manually. This is not changed in this ticket.",
    "created_at": "2012-12-30T21:58:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169457",
    "user": "vbraun"
}
```

You can always use `sage.interfaces.gap.set_gap_memory_pool_size()` before starting any gap computation if you want to set it manually. This is not changed in this ticket.



---

archive/issue_comments_169458.json:
```json
{
    "body": "Replying to [comment:14 leif]:\n> Besides that libGAP may come with a new / alternate memory manager when Sage is \"ready\" for it.\n\nLibGAP is ready. It only needs review for a few obvious improvements over the previously reviewed version. I.e. will probably never be merged considering the glacial process. But ready it is.",
    "created_at": "2012-12-30T22:03:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169458",
    "user": "vbraun"
}
```

Replying to [comment:14 leif]:
> Besides that libGAP may come with a new / alternate memory manager when Sage is "ready" for it.

LibGAP is ready. It only needs review for a few obvious improvements over the previously reviewed version. I.e. will probably never be merged considering the glacial process. But ready it is.



---

archive/issue_comments_169459.json:
```json
{
    "body": "Replying to [comment:17 vbraun]:\n> Replying to [comment:14 leif]:\n> > Besides that libGAP may come with a new / alternate memory manager when Sage is \"ready\" for it.\n> \n> LibGAP is ready. It only needs review for a few obvious improvements over the previously reviewed version. I.e. will probably never be merged considering the glacial process. \n\nI'm working on this from a crevasse in a local Singaporean glacier. It helps against hardware overheating...",
    "created_at": "2013-01-02T13:32:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169459",
    "user": "dimpase"
}
```

Replying to [comment:17 vbraun]:
> Replying to [comment:14 leif]:
> > Besides that libGAP may come with a new / alternate memory manager when Sage is "ready" for it.
> 
> LibGAP is ready. It only needs review for a few obvious improvements over the previously reviewed version. I.e. will probably never be merged considering the glacial process. 

I'm working on this from a crevasse in a local Singaporean glacier. It helps against hardware overheating...



---

archive/issue_comments_169460.json:
```json
{
    "body": "I am testing this on a system where mem.available_swap() comes up negative:\n\n```\nsage: t = mem._parse_proc_meminfo(); t\n{'available_ram': 1435963392, 'total_swap': 10909376512, 'available_swap': 8558673920, 'Committed_AS': 16000847872, 'total_ram': 7929249792}\nsage: mem.available_swap()\n-5091471360\n```\n\nwhich is not surprising, as mem.available_swap() computes ` t['total_swap']-t['Committed_AS']`, rather than returning `t['available_swap']`. \n\nWhat is going on? A bug or a feature?\n\nThat's how far I get digging up the cause of\n\n```\nsage -t -long \"devel/sage-main/sage/misc/memory_info.py\"    \n**********************************************************************\nFile \"/usr/local/src/sage/sage-5.5/devel/sage-main/sage/misc/memory_info.py\", line 122:\n    sage: mem.virtual_memory_limit() > 0\nExpected:\n    True\nGot:\n    False\n**********************************************************************\n1 items had failures:\n```\n",
    "created_at": "2013-01-03T03:12:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169460",
    "user": "dimpase"
}
```

I am testing this on a system where mem.available_swap() comes up negative:

```
sage: t = mem._parse_proc_meminfo(); t
{'available_ram': 1435963392, 'total_swap': 10909376512, 'available_swap': 8558673920, 'Committed_AS': 16000847872, 'total_ram': 7929249792}
sage: mem.available_swap()
-5091471360
```

which is not surprising, as mem.available_swap() computes ` t['total_swap']-t['Committed_AS']`, rather than returning `t['available_swap']`. 

What is going on? A bug or a feature?

That's how far I get digging up the cause of

```
sage -t -long "devel/sage-main/sage/misc/memory_info.py"    
**********************************************************************
File "/usr/local/src/sage/sage-5.5/devel/sage-main/sage/misc/memory_info.py", line 122:
    sage: mem.virtual_memory_limit() > 0
Expected:
    True
Got:
    False
**********************************************************************
1 items had failures:
```




---

archive/issue_comments_169461.json:
```json
{
    "body": "How about the following patch:\n\n```\ndiff --git a/sage/misc/memory_info.py b/sage/misc/memory_info.py\n--- a/sage/misc/memory_info.py\n+++ b/sage/misc/memory_info.py\n@@ -263,7 +263,10 @@\n         \"\"\"\n         info = self._parse_proc_meminfo()\n         try:\n-            return info['total_swap'] - info['Committed_AS']\n+            dif = info['total_swap'] - info['Committed_AS']\n+            if dif > 0:\n+               return dif\n+            return info['available_swap']\n         except KeyError:\n             return info['available_swap']\n```\n\nat least this fixes the doctests on the system in question",
    "created_at": "2013-01-04T04:40:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169461",
    "user": "dimpase"
}
```

How about the following patch:

```
diff --git a/sage/misc/memory_info.py b/sage/misc/memory_info.py
--- a/sage/misc/memory_info.py
+++ b/sage/misc/memory_info.py
@@ -263,7 +263,10 @@
         """
         info = self._parse_proc_meminfo()
         try:
-            return info['total_swap'] - info['Committed_AS']
+            dif = info['total_swap'] - info['Committed_AS']
+            if dif > 0:
+               return dif
+            return info['available_swap']
         except KeyError:
             return info['available_swap']
```

at least this fixes the doctests on the system in question



---

archive/issue_comments_169462.json:
```json
{
    "body": "Replying to [comment:20 dimpase]:\n> How about the following patch:\n> {{{\n> diff --git a/sage/misc/memory_info.py b/sage/misc/memory_info.py\n> --- a/sage/misc/memory_info.py\n> +++ b/sage/misc/memory_info.py\n> `@``@` -263,7 +263,10 `@``@`\n>          \"\"\"\n>          info = self._parse_proc_meminfo()\n>          try:\n> -            return info['total_swap'] - info['Committed_AS']\n> +            dif = info['total_swap'] - info['Committed_AS']\n> +            if dif > 0:\n> +               return dif\n> +            return info['available_swap']\n>          except KeyError:\n>              return info['available_swap']\n> }}}\n> at least this fixes the doctests on the system in question\n\nI actually have no clear idea why 'Committed_AS' gets into the picture here. E.g. I read\n\n[Committed_AS: An estimate of how much RAM you would need to make a 99.99% guarantee that there never is OOM (out of memory) for this workload. Normally the kernel will overcommit memory. That means, say you do a 1GB malloc, nothing happens, really. Only when you start USING that malloc memory you will get real memory on demand, and just as much as you use. So you sort of take a mortgage and hope the bank doesn't go bust. Other cases might include when you mmap a file that's shared only when you write to it and you get a private copy of that data. While it normally is shared between processes. The Committed_AS is a guesstimate of how much RAM/swap you would need worst-case.](http://www.redhat.com/advice/tips/meminfo.html)\n\nSo this is a worst-case estimate, and `info['total_swap'] < info['Committed_AS']` means, from the OS point of view, that you're living on the edge. Well, maybe. And the measurement is taken while `make -j4 ptestlong` on this 4-processor machine.",
    "created_at": "2013-01-04T05:47:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169462",
    "user": "dimpase"
}
```

Replying to [comment:20 dimpase]:
> How about the following patch:
> {{{
> diff --git a/sage/misc/memory_info.py b/sage/misc/memory_info.py
> --- a/sage/misc/memory_info.py
> +++ b/sage/misc/memory_info.py
> `@``@` -263,7 +263,10 `@``@`
>          """
>          info = self._parse_proc_meminfo()
>          try:
> -            return info['total_swap'] - info['Committed_AS']
> +            dif = info['total_swap'] - info['Committed_AS']
> +            if dif > 0:
> +               return dif
> +            return info['available_swap']
>          except KeyError:
>              return info['available_swap']
> }}}
> at least this fixes the doctests on the system in question

I actually have no clear idea why 'Committed_AS' gets into the picture here. E.g. I read

[Committed_AS: An estimate of how much RAM you would need to make a 99.99% guarantee that there never is OOM (out of memory) for this workload. Normally the kernel will overcommit memory. That means, say you do a 1GB malloc, nothing happens, really. Only when you start USING that malloc memory you will get real memory on demand, and just as much as you use. So you sort of take a mortgage and hope the bank doesn't go bust. Other cases might include when you mmap a file that's shared only when you write to it and you get a private copy of that data. While it normally is shared between processes. The Committed_AS is a guesstimate of how much RAM/swap you would need worst-case.](http://www.redhat.com/advice/tips/meminfo.html)

So this is a worst-case estimate, and `info['total_swap'] < info['Committed_AS']` means, from the OS point of view, that you're living on the edge. Well, maybe. And the measurement is taken while `make -j4 ptestlong` on this 4-processor machine.



---

archive/issue_comments_169463.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-01-04T09:40:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169463",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_169464.json:
```json
{
    "body": "dimpase: the new test simply checks\n\n```\nMemoryInfo().available_swap() in ZZ\n```\n\nso perhaps this is a feature, not a bug? I don't mind that `available_swap()` can be negative.",
    "created_at": "2013-01-04T09:43:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169464",
    "user": "jdemeyer"
}
```

dimpase: the new test simply checks

```
MemoryInfo().available_swap() in ZZ
```

so perhaps this is a feature, not a bug? I don't mind that `available_swap()` can be negative.



---

archive/issue_comments_169465.json:
```json
{
    "body": "The problem is that I don't know an easy way to report \"available swap\". It could all be reserved by some other gap session for all we know. So `Total-Committed_AS` is a good approximation. Yes it can go negative if the kernel is overcommitting, but one could argue that it is then to be expected that a negative number is returned. In any case, it works as I intended it. If you have a better metric for available swap that doesn't involve going through the VM allocations of every process then I'd be happy to implement that. But in its present state it is good enough for starting GAP; if `Committed_AS > Total` then you probably want the minimial sized pool for GAP.",
    "created_at": "2013-01-04T11:05:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169465",
    "user": "vbraun"
}
```

The problem is that I don't know an easy way to report "available swap". It could all be reserved by some other gap session for all we know. So `Total-Committed_AS` is a good approximation. Yes it can go negative if the kernel is overcommitting, but one could argue that it is then to be expected that a negative number is returned. In any case, it works as I intended it. If you have a better metric for available swap that doesn't involve going through the VM allocations of every process then I'd be happy to implement that. But in its present state it is good enough for starting GAP; if `Committed_AS > Total` then you probably want the minimial sized pool for GAP.



---

archive/issue_comments_169466.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-01-04T11:07:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169466",
    "user": "vbraun"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_169467.json:
```json
{
    "body": "Replying to [comment:24 vbraun]:\n> The problem is that I don't know an easy way to report \"available swap\".\nhow about `self._parse_proc_meminfo()['available_swap']` ?\n\nAs it is now, this value can be different from `MemoryInfo().available_swap()`, and this is rather confusing.\n\n\n> It could all be reserved by some other gap session for all we know. \nbut we also know that this might be a huge overestimate.\n\n> So `Total-Committed_AS` is a good approximation. \n\nat least it should be named differently, not `MemoryInfo().available_swap()`, to avoid the clash with `self._parse_proc_meminfo()['available_swap']`\n\nYes it can go negative if the kernel is overcommitting, but one could argue that it is then to be expected that a negative number is returned. In any case, it works as I intended it. If you have a better metric for available swap that doesn't involve going through the VM allocations of every process then I'd be happy to implement that. But in its present state it is good enough for starting GAP; if `Committed_AS > Total` then you probably want the minimial sized pool for GAP.",
    "created_at": "2013-01-04T11:31:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169467",
    "user": "dimpase"
}
```

Replying to [comment:24 vbraun]:
> The problem is that I don't know an easy way to report "available swap".
how about `self._parse_proc_meminfo()['available_swap']` ?

As it is now, this value can be different from `MemoryInfo().available_swap()`, and this is rather confusing.


> It could all be reserved by some other gap session for all we know. 
but we also know that this might be a huge overestimate.

> So `Total-Committed_AS` is a good approximation. 

at least it should be named differently, not `MemoryInfo().available_swap()`, to avoid the clash with `self._parse_proc_meminfo()['available_swap']`

Yes it can go negative if the kernel is overcommitting, but one could argue that it is then to be expected that a negative number is returned. In any case, it works as I intended it. If you have a better metric for available swap that doesn't involve going through the VM allocations of every process then I'd be happy to implement that. But in its present state it is good enough for starting GAP; if `Committed_AS > Total` then you probably want the minimial sized pool for GAP.



---

archive/issue_comments_169468.json:
```json
{
    "body": "`/proc/meminfo` doesn't exclude reserved yet unused swap in the SwapFree field.\n\n\nI've renamed the (private) dict key to `free_swap`. In any case thats not visible to the user.",
    "created_at": "2013-01-04T11:54:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169468",
    "user": "vbraun"
}
```

`/proc/meminfo` doesn't exclude reserved yet unused swap in the SwapFree field.


I've renamed the (private) dict key to `free_swap`. In any case thats not visible to the user.



---

archive/issue_comments_169469.json:
```json
{
    "body": "Replying to [comment:27 vbraun]:\n> `/proc/meminfo` doesn't exclude reserved yet unused swap in the SwapFree field.\n> \n> \n> I've renamed the (private) dict key to `free_swap`. In any case thats not visible to the user.\nThis is not enough.\nI still get \n\n```\nFile \"/usr/local/src/sage/sage-5.6.beta2/devel/sage-main/sage/misc/memory_info.py\", line 122:\n    sage: mem.virtual_memory_limit() > 0\nExpected:\n    True\nGot:\n    False\n```\n\n\nvirtual_memory_limit() as implemented is too conservative, I think. Indeed:\n\n```\nsage: from sage.misc.memory_info import MemoryInfo\nsage: mem = MemoryInfo()\nsage: mem.av\nmem.available_ram   mem.available_swap  \nsage: mem.available_swap()\n-5123952640\nsage: mem.available_ram() \n1262751744\nsage: mem.virtual_memory_limit()\n-3861200896\n```\n\n\nunless you will allow virtual_memory_limit() be negative, too, but this is IMHO even weirder...\nShouldn't an implementation respect the overcommitting settings somehow?",
    "created_at": "2013-01-04T15:49:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169469",
    "user": "dimpase"
}
```

Replying to [comment:27 vbraun]:
> `/proc/meminfo` doesn't exclude reserved yet unused swap in the SwapFree field.
> 
> 
> I've renamed the (private) dict key to `free_swap`. In any case thats not visible to the user.
This is not enough.
I still get 

```
File "/usr/local/src/sage/sage-5.6.beta2/devel/sage-main/sage/misc/memory_info.py", line 122:
    sage: mem.virtual_memory_limit() > 0
Expected:
    True
Got:
    False
```


virtual_memory_limit() as implemented is too conservative, I think. Indeed:

```
sage: from sage.misc.memory_info import MemoryInfo
sage: mem = MemoryInfo()
sage: mem.av
mem.available_ram   mem.available_swap  
sage: mem.available_swap()
-5123952640
sage: mem.available_ram() 
1262751744
sage: mem.virtual_memory_limit()
-3861200896
```


unless you will allow virtual_memory_limit() be negative, too, but this is IMHO even weirder...
Shouldn't an implementation respect the overcommitting settings somehow?



---

archive/issue_comments_169470.json:
```json
{
    "body": "Attachment\n\nUpdated patch",
    "created_at": "2013-01-04T16:00:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169470",
    "user": "vbraun"
}
```

Attachment

Updated patch



---

archive/issue_comments_169471.json:
```json
{
    "body": "I've change `virtual_memory_limit()` to default to total swap+ram instead of available swap+ram. Now its always positive (and quite large unless you set a limit manually).",
    "created_at": "2013-01-04T16:01:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169471",
    "user": "vbraun"
}
```

I've change `virtual_memory_limit()` to default to total swap+ram instead of available swap+ram. Now its always positive (and quite large unless you set a limit manually).



---

archive/issue_comments_169472.json:
```json
{
    "body": "Replying to [comment:29 vbraun]:\n> I've change `virtual_memory_limit()` to default to total swap+ram instead of available swap+ram. Now its always positive (and quite large unless you set a limit manually).\n\nWhy don't you use 'free_swap' instead of 'available_swap' ?\nThis reflects the reality and the system settings (for overcommitting) far better.\n\nWith 'total swap'+'total ram' one would potentially end up with too much swap reserved for GAP.",
    "created_at": "2013-01-04T16:08:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169472",
    "user": "dimpase"
}
```

Replying to [comment:29 vbraun]:
> I've change `virtual_memory_limit()` to default to total swap+ram instead of available swap+ram. Now its always positive (and quite large unless you set a limit manually).

Why don't you use 'free_swap' instead of 'available_swap' ?
This reflects the reality and the system settings (for overcommitting) far better.

With 'total swap'+'total ram' one would potentially end up with too much swap reserved for GAP.



---

archive/issue_comments_169473.json:
```json
{
    "body": "No, the virtual memory limit should only be used for the pool size if either it was set by hand to a relatively small value or if the address space is small compared to ram size (32-bit PAE).",
    "created_at": "2013-01-04T16:18:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169473",
    "user": "vbraun"
}
```

No, the virtual memory limit should only be used for the pool size if either it was set by hand to a relatively small value or if the address space is small compared to ram size (32-bit PAE).



---

archive/issue_comments_169474.json:
```json
{
    "body": "Replying to [comment:31 vbraun]:\n> No, the virtual memory limit should only be used for the pool size if either it was set by hand to a relatively small value or if the address space is small compared to ram size (32-bit PAE). \n\nThe docstring for virtual memory limit  says:\n\n```\n    This is the value set by ``ulimit -v`` at the command line or\n    a practical limit if no limit is set.\n```\n\nThis does not describe the current implementation. (And it wasn't really true before, either).",
    "created_at": "2013-01-04T16:49:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169474",
    "user": "dimpase"
}
```

Replying to [comment:31 vbraun]:
> No, the virtual memory limit should only be used for the pool size if either it was set by hand to a relatively small value or if the address space is small compared to ram size (32-bit PAE). 

The docstring for virtual memory limit  says:

```
    This is the value set by ``ulimit -v`` at the command line or
    a practical limit if no limit is set.
```

This does not describe the current implementation. (And it wasn't really true before, either).



---

archive/issue_comments_169475.json:
```json
{
    "body": "Why not? For all practical purposes, the limit is either swap+ram or your processor address limit if you don't set it.",
    "created_at": "2013-01-04T17:00:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169475",
    "user": "vbraun"
}
```

Why not? For all practical purposes, the limit is either swap+ram or your processor address limit if you don't set it.



---

archive/issue_comments_169476.json:
```json
{
    "body": "Replying to [comment:33 vbraun]:\n> Why not? For all practical purposes, the limit is either swap+ram or your processor address limit if you don't set it.\nbecause you neither return **the** value X set by ``ulimit -v`` (you return X+Y, for some nonzero Y), nor anything practical (no single process can reach this limit, ever) to speak about.",
    "created_at": "2013-01-04T17:13:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169476",
    "user": "dimpase"
}
```

Replying to [comment:33 vbraun]:
> Why not? For all practical purposes, the limit is either swap+ram or your processor address limit if you don't set it.
because you neither return **the** value X set by ``ulimit -v`` (you return X+Y, for some nonzero Y), nor anything practical (no single process can reach this limit, ever) to speak about.



---

archive/issue_comments_169477.json:
```json
{
    "body": "Are you sure? I do return RLIMIT_AS if set:\n\n```\n[vbraun@volker-desktop ~]$ ulimit -v 12341234\n[vbraun@volker-desktop ~]$ sage \n...\nsage: from sage.misc.memory_info import MemoryInfo  \nsage: MemoryInfo().virtual_memory_limit()\n12637423616\nsage: _/1024\n12341234\n```\n\nAnd you probably can request total ram+swap thanks to overcommit if not much else is going on or the overcommit ratio is stupidly high.",
    "created_at": "2013-01-04T17:20:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169477",
    "user": "vbraun"
}
```

Are you sure? I do return RLIMIT_AS if set:

```
[vbraun@volker-desktop ~]$ ulimit -v 12341234
[vbraun@volker-desktop ~]$ sage 
...
sage: from sage.misc.memory_info import MemoryInfo  
sage: MemoryInfo().virtual_memory_limit()
12637423616
sage: _/1024
12341234
```

And you probably can request total ram+swap thanks to overcommit if not much else is going on or the overcommit ratio is stupidly high.



---

archive/issue_comments_169478.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-01-05T02:01:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169478",
    "user": "dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_169479.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-01-07T20:57:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13676#issuecomment-169479",
    "user": "jdemeyer"
}
```

Resolution: fixed
