# Issue 21232: Enable VPATH builds

Issue created by migration from Trac.

Original creator: mkoeppe

Original creation time: 2016-09-11 03:59:17

CC:  felixs jdemeyer fbissey embray leif vbraun dimpase chapoton jhpalmieri

It would be convenient for VPATH builds to work.

```
 mkdir BUILDDIR
 cd BUILDDIR
 SRCDIR/configure --srcdir=SRCDIR
 make
```


Probably #14796 has work into this direction, but it seems to be an abandoned effort.


---

Comment by mkoeppe created at 2016-09-11 18:12:37

New commits:


---

Comment by git created at 2016-09-11 21:36:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2016-09-11 21:39:39

Changing status from new to needs_review.


---

Comment by git created at 2016-09-11 22:55:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-09-12 00:04:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-09-12 00:41:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-09-12 05:17:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2016-09-12 05:32:23

The current patch makes some high-level preparations for a VPATH build, in particular the package system.

"make" runs through until it gets to sagelib, which needs some more VPATH work (the current patch tries to get away by just making a symlink from $SAGE_SRC_ROOT/src to $SAGE_ROOT/src, which of course fails).

I've set this to 'needs review' in the hope of receiving some feedback regarding the approach of this patch.


---

Comment by fbissey created at 2016-09-12 05:49:26

I am not sure what the objective of this ticket is. Considering the nature of sage's build system I am not sure what `VPATH` brings me.

This is most evident in the latest commit. As a distro maintainer of sage there are already build time things in `env.py` that are not needed at runtime and in a way are superfluous. You have just added one. Here the problem that I am forced to consider, is that going by the separation rules that I try to follow, there should be stuff in `sage/env.py` and some in a new file `sage_setup/build_env.py` but that's marginal to what you are doing.

Other people may have a different opinion but there is no value in this for me so far. Possibly more work in fact.


---

Comment by mkoeppe created at 2016-09-12 05:52:50

Replying to [comment:10 fbissey]:
> I am not sure what the objective of this ticket is. Considering the nature of sage's build system I am not sure what `VPATH` brings me.

A VPATH build makes it easy to build from the same source in many different configurations. Concretely, I've started to run some VMs (with Linux 64 bit, 32 bit) via Docker, which mount the Sage source directory from the host.


---

Comment by git created at 2016-09-12 06:17:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2016-09-12 06:21:15

Replying to [comment:10 fbissey]:
> As a distro maintainer of sage there are already build time things in `env.py` that are not needed at runtime and in a way are superfluous. You have just added one. Here the problem that I am forced to consider, is that going by the separation rules that I try to follow, there should be stuff in `sage/env.py` and some in a new file `sage_setup/build_env.py` but that's marginal to what you are doing.

Yes, this ticket does not address any of the issues that would arise in distribution packaging. 

Instead it adds a standard feature expected from autotools build system, for those who use sage as a distribution.


---

Comment by fbissey created at 2016-09-12 07:43:46

I should apologize for being so negative. Currently `configure` is run by the initial call to make, it would be nice to get to the stage where we run `configure` first :)

Seriously, yes `VPATH` as lots of advantages, since most people run sage from where they build it, being able to do several builds from the same source without `make distclean` or `git clone` is a good thing.

I guess, it mostly started my brain on the fact that the separation build and runtime is not clean in vanilla sage. Your `VPATH` work may help to clarify it in some areas. Let's try to minimise where it would mix things further.


---

Comment by mkoeppe created at 2016-09-12 07:51:50

Replying to [comment:14 fbissey]:
> I should apologize for being so negative. 
No worries.
> Currently `configure` is run by the initial call to make, it would be nice to get to the stage where we run `configure` first :)
That already works with this patch.
> 
> Seriously, yes `VPATH` as lots of advantages, since most people run sage from where they build it, being able to do several builds from the same source without `make distclean` or `git clone` is a good thing.
> 
> I guess, it mostly started my brain on the fact that the separation build and runtime is not clean in vanilla sage. Your `VPATH` work may help to clarify it in some areas. Let's try to minimise where it would mix things further.
Sounds good. Yes, I'm hoping too that it helps clarify some things as a side-effect.


---

Comment by jdemeyer created at 2016-09-12 11:57:41

Replying to [comment:13 mkoeppe]:
> Instead it adds a standard feature expected from autotools build system, for those who use sage as a distribution.

I sort of agree with FranÃ§ois.

Part of the problem is that Sage is a distribution (a collection of packages) as well as a Python library. The fact this this is currently mixed up in the sources (the sources of the distribution-part and the library-part are in one repo) makes it more difficult to understand what this ticket is about.

For the distribution part, there really is no such thing as a build directory. There is a a temporary directory in `local/var/tmp/sage/build` but I would not consider that a build directory in the usual sense.

For the library part, a `VPATH` build is meaningful. Although, I think that `VPATH` builds are unusual in the Python world. Luckily, the default build directories are platform-dependendent. Anyway, it seems like this ticket isn't about that.


---

Comment by jdemeyer created at 2016-09-12 12:00:22

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2016-09-12 12:00:22

I think the ticket description should have a _lot_ more information about

1. which problem that this ticket is trying to solve (the *why*).

2. what the branch actually does (the *what*).

Note that this are 2 independent things (which are unfortunately often confused).


---

Comment by mkoeppe created at 2016-09-12 17:47:36

Changing status from needs_info to needs_review.


---

Comment by mkoeppe created at 2016-09-12 17:47:36

I've updated the description.


---

Comment by mkoeppe created at 2016-09-12 17:57:26

Replying to [comment:16 jdemeyer]:
> Replying to [comment:13 mkoeppe]:
> Part of the problem is that Sage is a distribution (a collection of packages) as well as a Python library. The fact this this is currently mixed up in the sources (the sources of the distribution-part and the library-part are in one repo) makes it more difficult to understand what this ticket is about.

I've now clarified the goal in the description. I have not touched `sagelib` yet; but without VPATH work on sagelib, the distribution VPATH changes won't work. I could use help with the work on `sagelib`.

> For the distribution part, there really is no such thing as a build directory. There is a a temporary directory in `local/var/tmp/sage/build` but I would not consider that a build directory in the usual sense.

Right, `local/var/tmp/sage/build` falls short of being a real build directory. because for example `src/build/` has a lot of more generated stuff.

> For the library part, a `VPATH` build is meaningful. Although, I think that `VPATH` builds are unusual in the Python world. Luckily, the default build directories are platform-dependendent. Anyway, it seems like this ticket isn't about that.

Certainly there `src/build/lib.macosx-10.9-x86_64-2.7` includes the platform name, but it does not account for other configuration differences that a VPATH build can take care of (neither does `src/build/cythonized`).


---

Comment by mkoeppe created at 2016-09-12 18:58:13

Replying to [comment:16 jdemeyer]:
> For the library part, a `VPATH` build is meaningful. Although, I think that `VPATH` builds are unusual in the Python world. Luckily, the default build directories are platform-dependendent. Anyway, it seems like this ticket isn't about that.

It seems that `pip install` keeps the source directory clean, building instead in a temporary directory. 
`pip install` also offers options `--build` to select a build directory (though it seems as if it does not work with all packages).


---

Comment by mkoeppe created at 2016-09-12 19:10:04

Replying to [comment:22 mkoeppe]:
> It seems that `pip install` keeps the source directory clean, building instead in a temporary directory. 
> `pip install` also offers options `--build` to select a build directory (though it seems as if it does not work with all packages).

However, there are some pip issues: https://github.com/pypa/pip/issues/2060 https://github.com/pypa/pip/issues/2053 https://github.com/pypa/pip/issues/804


---

Comment by mkoeppe created at 2016-09-12 19:51:24

> Replying to [comment:16 jdemeyer]:
> For the library part, a `VPATH` build is meaningful. Although, I think that `VPATH` builds are unusual in the Python world. Luckily, the default build directories are platform-dependendent. Anyway, it seems like this ticket isn't about that.

Also, in the traditional distutils ways (https://docs.python.org/2/install/), it appears that one can use `--build-base` to do VPATH builds.

```
python setup.py build --build-base=BUILDDIR
```



---

Comment by mkoeppe created at 2016-09-12 22:01:47

This is now #21480.


---

Comment by git created at 2016-09-13 00:07:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2016-09-18 21:19:51

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-08-27 04:24:28

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2017-08-27 04:25:14

squashed into 1 commit to simplify rebasing.


---

Comment by mkoeppe created at 2017-08-27 05:12:25

The next step towards VPATH builds should probably be #21535 (enabling `src/setup.py build --build-base`, to replace the hard-coded "build").


---

Comment by git created at 2017-08-28 02:58:49

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-08-28 05:53:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-08-28 15:41:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2017-08-28 15:49:11

Removed #21535 dependency. `setup.py --build-base` actually works already.

With the current status of the branch, `make` builds a working sage, only the docbuild does not go through yet.


---

Comment by jhpalmieri created at 2017-08-28 16:10:49

On OS X, some directories are not being created:

```
$ mkdir BUILD
$ cd BUILD
$ /path/to/sage/configure --srcdir=/path/to/sage
...
/path/to/sage/configure: line 7017: build/make/Makefile: No such file or directory
```

If I create that directory, `configure` finishes but with warning messages like this

```
$ mkdir -p build/make
$ /path/to/sage/configure --srcdir=/path/to/sage
...
touch: /path/to/BUILD/src/bin/sage-env-config: No such file or directory
find: /path/to/BUILD/src/ext: No such file or directory
cat: /path/to/BUILD/build/make/deps: No such file or directory
...
$ make
make: *** No targets specified and no makefile found.  Stop.
```



---

Comment by mkoeppe created at 2017-08-28 20:59:35

Did you autoreconf?


---

Comment by jhpalmieri created at 2017-08-28 22:50:28

No, that fixed it.


---

Comment by jhpalmieri created at 2017-08-29 03:19:10

With the changes

```diff
diff --git a/src/bin/sage-env b/src/bin/sage-env
index dc2bd34cc0..8aa523d7ea 100644
--- a/src/bin/sage-env
+++ b/src/bin/sage-env
`@``@` -313,7 +313,7 `@``@` export SAGE_EXTCODE="$SAGE_SHARE/sage/ext"
 export SAGE_SPKG_INST="$SAGE_LOCAL/var/lib/sage/installed"
 export SAGE_LOGS="$SAGE_ROOT/logs/pkgs"
 export SAGE_SRC="$SAGE_ROOT/src"
-export SAGE_DOC_SRC="$SAGE_SRC/doc"
+export SAGE_DOC_SRC="$SAGE_SRC_ROOT/src/doc"
 export SAGE_DOC="$SAGE_SHARE/doc/sage"
 
 if [ -z "${SAGE_ORIG_PATH_SET}" ]; then
diff --git a/src/doc/common/conf.py b/src/doc/common/conf.py
index 2e115fab88..88f3fdfa4a 100644
--- a/src/doc/common/conf.py
+++ b/src/doc/common/conf.py
`@``@` -1,10 +1,10 `@``@`
 import sys, os, sphinx
-from sage.env import SAGE_DOC_SRC, SAGE_DOC, SAGE_SRC, THEBE_DIR
+from sage.env import SAGE_DOC_SRC, SAGE_DOC, SAGE_SRC_ROOT, THEBE_DIR
 from datetime import date
 from six import iteritems
 
 # If your extensions are in another directory, add it here.
-sys.path.append(os.path.join(SAGE_SRC, "sage_setup", "docbuild", "ext"))
+sys.path.append(os.path.join(SAGE_SRC_ROOT, "src", "sage_setup", "docbuild", "ext"))
 
 # General configuration
 # ---------------------
```

the documentation starts to build, but I eventually get an error:

```
[dochtml] [arithgrou] /path/to/SAGE_ROOT/src/doc/en/reference/arithgroup/sage/modular/arithgroup/arithgroup_element.rst:11: WARNING: error while formatting arguments for sage.modular.arithgroup.arithgroup_element.ArithmeticSubgroupElement.b: 'NoneType' object has no attribute 'find'
```

I can't figure out where this is coming from.


---

Comment by git created at 2017-08-29 17:52:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2017-08-29 17:53:20

Thanks, I've added your changes as a commit.


---

Comment by mkoeppe created at 2017-08-29 17:59:43

Replying to [comment:42 jhpalmieri]:
> the documentation starts to build, but I eventually get an error:
> {{{
> [dochtml] [arithgrou] /path/to/SAGE_ROOT/src/doc/en/reference/arithgroup/sage/modular/arithgroup/arithgroup_element.rst:11: WARNING: error while formatting arguments for sage.modular.arithgroup.arithgroup_element.ArithmeticSubgroupElement.b: 'NoneType' object has no attribute 'find'
> }}}

I get the same error


---

Comment by jhpalmieri created at 2017-08-29 18:04:56

One more change, to help `make distclean` work:

```diff
diff --git a/build/make/deps b/build/make/deps
index 3128f4c656..03f2c8fff1 100644
--- a/build/make/deps
+++ b/build/make/deps
`@``@` -235,7 +235,7 `@``@` doc-pdf: $(DOC_DEPENDENCIES)
 doc-clean: doc-src-clean doc-output-clean
 
 doc-src-clean:
-       cd "$(SAGE_SRC)/doc" && $(MAKE) clean
+       cd "$(SAGE_SRC_ROOT)/src/doc" && $(MAKE) clean
 
 doc-output-clean:
        rm -rf "$(SAGE_SHARE)/doc/sage"
```



---

Comment by git created at 2017-08-29 18:17:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2017-08-29 18:35:14

Perhaps the sphinx problem is related to failing source discovery for Cython modules:

```
sage: sage.rings.number_field.number_field_element_quadratic??
Error getting source: s must be a string
Type:            module
...
```



---

Comment by jhpalmieri created at 2017-08-29 18:36:21

Yes, that looks like it.


---

Comment by jhpalmieri created at 2017-08-29 19:07:02

Okay, how about this:

```diff
diff --git a/src/sage/misc/sageinspect.py b/src/sage/misc/sageinspect.py
index f9dffc1ce3..3a286c7934 100644
--- a/src/sage/misc/sageinspect.py
+++ b/src/sage/misc/sageinspect.py
`@``@` -125,7 +125,7 `@``@` import tokenize
 import types
 import re
 EMBEDDED_MODE = False
-from sage.env import SAGE_SRC
+from sage.env import SAGE_SRC_ROOT
 
 def loadable_module_extension():
     r"""
`@``@` -222,7 +222,7 `@``@` def _extract_embedded_position(docstring):
         return None
 
     raw_filename = res.group('FILENAME')
-    filename = os.path.join(SAGE_SRC, raw_filename)
+    filename = os.path.join(SAGE_SRC_ROOT, 'src', raw_filename)
     if not os.path.isfile(filename):
         from sage.misc.misc import SPYX_TMP
         filename = os.path.join(SPYX_TMP, '_'.join(raw_filename.split('_')[:-1]), raw_filename)
`@``@` -2308,7 +2308,7 `@``@` def __internal_tests():
 
     Test _extract_embedded_position:
 
-    We cannot test the filename since it depends on SAGE_SRC.
+    We cannot test the filename since it depends on SAGE_SRC_ROOT.
 
     Make sure things work with no trailing newline::
 
```



---

Comment by jhpalmieri created at 2017-08-29 20:40:01

Now the cross-references are wrong or missing:

```
[dochtml] OSError: [parallel ] /.../sage-8.1.beta3/src/doc/en/reference/parallel/index.rst:17: WARNING: undefined label: sage.interfaces.psage (if the link has no caption the label must precede a section header)
```



---

Comment by jhpalmieri created at 2017-08-29 20:40:31

Also, it seems that the docbuilding doesn't recognize when a document has been built already, so everything is rebuilt every time.


---

Comment by git created at 2017-08-29 21:23:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2017-08-29 21:25:33

Replying to [comment:50 jhpalmieri]:
> Okay, how about this:
> {{{
> #!diff
> diff --git a/src/sage/misc/sageinspect.py b/src/sage/misc/sageinspect.py
> index f9dffc1ce3..3a286c7934 100644
> --- a/src/sage/misc/sageinspect.py
> +++ b/src/sage/misc/sageinspect.py
> `@``@` -222,7 +222,7 `@``@` def _extract_embedded_position(docstring):
>          return None
>  
>      raw_filename = res.group('FILENAME')
> -    filename = os.path.join(SAGE_SRC, raw_filename)
> +    filename = os.path.join(SAGE_SRC_ROOT, 'src', raw_filename)
>      if not os.path.isfile(filename):
>          from sage.misc.misc import SPYX_TMP
>          filename = os.path.join(SPYX_TMP, '_'.join(raw_filename.split('_')[:-1]), raw_filename)
> }}}

Instead, I have changed `SAGE_SRC` to point to the actual source tree. This was inconsistent before.


---

Comment by mkoeppe created at 2017-08-29 21:54:41

I'm now testing the VPATH build using a separate user account that cannot write into the source tree. 
More changes to the docbuild are necessary to separate sources from built files:

```
[dochtml] IOError: [Errno 13] Permission denied: '/Users/mkoeppe/s/sage/sage-rebasing/vpath/B/../src/doc/en/reference/repl/sage/misc/trace.rst'
```



---

Comment by jhpalmieri created at 2017-08-29 22:06:43

By the way, I get warnings like

```
touch: /.../BUILDDIR/src/bin/sage-env-config: No such file or directory
```

I assume this isn't a big deal since you're planning on getting rid of this file. It also doesn't seem to interfere with the build or running Sage.


---

Comment by mkoeppe created at 2017-08-29 22:09:17

I don't plan to eliminate `sage-env-config` (perhaps you mean `sage-arch-env`, #23733)?


---

Comment by jhpalmieri created at 2017-08-29 22:10:03

Sorry, yes, that's what I meant, and that's what most of the warnings have been about.


---

Comment by mkoeppe created at 2017-08-29 22:17:12

The `sage-arch-env` message is harmless.
But there's indeed also something wrong with `sage-env-config` too. Fix will come shortly.


---

Comment by git created at 2017-08-29 22:18:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2017-08-30 01:13:58

I'm getting this build error:

```
make[2]: *** No rule to make target `/.../BUILDDIR/local/share/sage/ext/doctest/invalid/syntax_error.tachyon', needed by `sagelib'.  Stop.
```



---

Comment by git created at 2017-08-30 03:34:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2017-08-30 15:26:37

The make target "sage-starts" fails for me. This fixes it; is it the right way to fix it?

```diff
diff --git a/src/bin/sage-starts b/src/bin/sage-starts
index 85cbae67e5..498c930810 100755
--- a/src/bin/sage-starts
+++ b/src/bin/sage-starts
`@``@` -14,7 +14,7 `@``@` echo "[`date +'%Y-%m-%d %H:%M:%S'`] `cat VERSION.txt 2>/dev/null`" | tee -a logs
 # sysadmin.  We use --nodotsage so we don't force a .sage directory
 # in the sysadmin's HOME directory.
 cmd='sage.all._write_started_file(); print "Yes, Sage starts."'
-build/bin/sage-logger "./sage --nodotsage -c '$cmd'" logs/start.log
+"$SAGE_SRC_ROOT"/build/bin/sage-logger "./sage --nodotsage -c '$cmd'" logs/start.log
 
 if [ $? -ne 0 ]; then
     echo >&2 "Sage failed to start up."
```



---

Comment by jhpalmieri created at 2017-08-30 18:04:51

With that change, `make ptestlong` fails:

```
Testing that Sage starts...
[2017-08-30 09:19:29] 
This looks like the first time you are running Sage.
Cleaning up, do not interrupt this.
Done cleaning.
Yes, Sage starts.

real	52m33.269s
user	191m2.435s
sys	19m38.034s
Sage build/upgrade complete!

To install small scripts to directly run Sage's versions of GAP,
the PARI/GP interpreter, Maxima, or Singular etc. (by typing e.g.
just 'gap' or 'gp') into a standard 'bin' directory, start Sage
by typing 'sage' (or './sage') and enter something like

    install_scripts('/usr/local/bin')

at the Sage command prompt ('sage:').

/.../SAGE_SRC_ROOT/sage -t -p --all --long --logfile=logs/ptestlong.log
************************************************************************
It seems that you are attempting to run Sage from an unpacked source
tarball, but you have not compiled it yet (or maybe the build has not
finished). You should run `make` in the Sage root directory first.
If you did not intend to build Sage from source, you should download
a binary tarball instead. Read README.txt for more information.
************************************************************************
make: *** [ptestlong] Error 1
```

I think that the make target

```
TESTALL = $(top_srcdir)/sage -t --all
```

needs to be changed so that it runs `SAGE_ROOT/sage` instead of `SAGE_SRC_ROOT/sage`.

`./sage -t -all` also fails:

```
$ ./sage -t --all
/.../SAGE_SRC_ROOT/src/bin/sage-env: line 527: /.../BUILDDIR/src/bin/sage-arch-env: No such file or directory
Traceback (most recent call last):
  File "/.../SAGE_SRC_ROOT/src/bin/sage-runtests", line 97, in <module>
    DC = DocTestController(options, args)
  File "/.../BUILDDIR/local/lib/python2.7/site-packages/sage/doctest/control.py", line 334, in __init__
    for pkg in list_packages('optional', local=True).values():
  File "/.../BUILDDIR/local/lib/python2.7/site-packages/sage/misc/package.py", line 230, in list_packages
    for p in os.listdir(SAGE_PKGS):
OSError: [Errno 2] No such file or directory: '/.../BUILDDIR/build/pkgs'
```

This can almost be fixed by

```diff
diff --git a/src/sage/env.py b/src/sage/env.py
index 33cd754a06..f91c70ba7d 100644
--- a/src/sage/env.py
+++ b/src/sage/env.py
`@``@` -111,7 +111,7 `@``@` _add_variable_or_fallback('SAGE_LIB',        SITE_PACKAGES[0])
 _add_variable_or_fallback('SAGE_CYTHONIZED', opj('$SAGE_ROOT', 'src', 'build', 'cythonized'))
 
 # Used by sage/misc/package.py.  Should be SAGE_SRC_ROOT in VPATH.
-_add_variable_or_fallback('SAGE_PKGS', opj('$SAGE_ROOT', 'build', 'pkgs'))
+_add_variable_or_fallback('SAGE_PKGS', opj('$SAGE_SRC_ROOT', 'build', 'pkgs'))
 
 
 _add_variable_or_fallback('SAGE_EXTCODE',    opj('$SAGE_SHARE', 'sage', 'ext'))
```

but there is a bug in the function `_add_variable_or_fallback` in how it parses variable names prefixed with dollar signs. I'll open a new ticket for that.


---

Comment by jhpalmieri created at 2017-08-30 20:36:24

If I hack the top-level Makefile so that `make ptestlong` works, then I only get test failures in `sage/tests/cmdline.py`.


---

Comment by jhpalmieri created at 2017-08-30 20:36:52

Replying to [comment:64 jhpalmieri]:
> there is a bug in the function `_add_variable_or_fallback` in how it parses variable names prefixed with dollar signs. I'll open a new ticket for that.

See #23758.


---

Comment by git created at 2017-08-31 05:30:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2017-08-31 05:31:36

I'm still getting docbuild errors of the type ` WARNING: undefined label: sage.interfaces.psage (if the link has no caption the label must precede a section header)`


---

Comment by dimpase created at 2017-08-31 09:42:44

Replying to [comment:68 mkoeppe]:
> I'm still getting docbuild errors of the type ` WARNING: undefined label: sage.interfaces.psage (if the link has no caption the label must precede a section header)`

This is a general problem, nothing to worry in the context of this ticket.

By the way you might like to use here the upgraded sphinx on #23023, which will most probably be in the next beta.


---

Comment by jhpalmieri created at 2017-08-31 17:20:54

I agree that the docbuild warnings are not new. (My issue in comment:51 was that these were errors, causing docbuilding to actually fail. I am now able to build the docs successfully.)

I am still having the problem in comment:63 with `sage-starts`.


---

Comment by mkoeppe created at 2017-08-31 21:36:55

Replying to [comment:70 jhpalmieri]:
> I agree that the docbuild warnings are not new. (My issue in comment:51 was that these were errors, causing docbuilding to actually fail. I am now able to build the docs successfully.)

Unfortunately these warnings get upgraded to errors like this:

```
[dochtml] OSError: [parallel ] /Users/mkoeppe/s/sage/sage-rebasing/vpath/src/doc/en/reference/parallel/index.rst:17: WARNING: undefined label: sage.interfaces.psage (if the link has no caption the label must precede a section header)
```

which stops this build for me.

I'll try with  #23023 as suggested by Dima.


---

Comment by jhpalmieri created at 2017-08-31 22:00:26

Replying to [comment:71 mkoeppe]:
> Replying to [comment:70 jhpalmieri]:
> > I agree that the docbuild warnings are not new. (My issue in comment:51 was that these were errors, causing docbuilding to actually fail. I am now able to build the docs successfully.)
> 
> Unfortunately these warnings get upgraded to errors like this:
> {{{
> [dochtml] OSError: [parallel ] /Users/mkoeppe/s/sage/sage-rebasing/vpath/src/doc/en/reference/parallel/index.rst:17: WARNING: undefined label: sage.interfaces.psage (if the link has no caption the label must precede a section header)
> }}}
> which stops this build for me.

Your change in comment:53 fixed that issue for me. (At least I think that's what fixed it.)


---

Comment by git created at 2017-08-31 23:46:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2017-08-31 23:47:01

Replying to [comment:70 jhpalmieri]:
> I am still having the problem in comment:63 with `sage-starts`.

I agree with your patch and have added a commit; but see #23769.


---

Comment by git created at 2017-09-01 04:27:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2017-09-01 04:49:12

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2017-09-01 04:49:47

I think this ticket is ready for broader review.


---

Comment by jhpalmieri created at 2017-09-01 04:56:54

`make distclean` fails because `make sagelib-clean` fails:

```
cd "/.../SAGE_SRC_ROOT/src" && make -j6 clean
make[2]: warning: -jN forced in submake: disabling jobserver mode.
make[2]: *** No rule to make target `clean'.  Stop.
make[1]: *** [sagelib-clean] Error 2
```

I guess it should cd to `/.../BUILDDIR/src` instead.


---

Comment by git created at 2017-09-01 05:13:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-09-01 05:35:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2017-09-01 17:50:21

I tried again from a distcleaned tree. Now I'm running into:

```
[sagelib-8.1.beta3] Generating auto-generated sources
[sagelib-8.1.beta3] Building interpreters for fast_callable
[sagelib-8.1.beta3] -> First build of interpreters
[sagelib-8.1.beta3] error: [Errno 2] No such file or directory: 'sage/ext/interpreters/interp_cc.c'
```



---

Comment by jhpalmieri created at 2017-09-01 20:08:25

I haven't seen that after running `make distclean` in both the original source directory and the build directory, but I could imagine it would happen if you don't have write access to the original source directory, since the interpreters directory and its contents are autogenerated (see `src/sage_setup/autogen`). Where should those files be created?


---

Comment by mkoeppe created at 2017-09-01 20:41:36

Replying to [comment:82 jhpalmieri]:
> I haven't seen that after running `make distclean` in both the original source directory and the build directory, but I could imagine it would happen if you don't have write access to the original source directory, since the interpreters directory and its contents are autogenerated (see `src/sage_setup/autogen`). 

Yes, this is how I am testing it (except I made `src/doc` writable).

Something in the code generator is missing error checking. I suspect it's coming from`src/sage_setup/autogen/interpreters/__init__.py`, which has some complicated exception handling.

> Where should those files be created?

They should be created in `SAGE_ROOT/src/sage/ext`.


---

Comment by mkoeppe created at 2017-09-01 20:47:28

I think we need a variable for `SAGE_ROOT/src` to make this patch cleaner. Suggestions for the variable name?


---

Comment by mkoeppe created at 2017-09-01 20:57:44

Perhaps should:
 - rename SAGE_SRC_ROOT to SAGE_VPATH
 - rename SAGE_SRC to SAGE_VPATH_SRC = SAGE_VPATH/src (and change many places that now use SAGE_SRC)
 - create SAGE_SRC = SAGE_ROOT/src
 - rename SAGE_DOC_SRC to SAGE_VPATH_SRC_DOC = SAGE_VPATH/src/doc
 - create SAGE_SRC_DOC = SAGE_ROOT/src/doc


---

Comment by jhpalmieri created at 2017-09-01 21:00:48

Replying to [comment:85 mkoeppe]:
>  - create SAGE_SRC = SAGE_ROOT/src

How about `SAGE_ROOT_SRC`? (only if you're changing `SAGE_SRC_ROOT`)

>  - rename SAGE_DOC_SRC to SAGE_VPATH_SRC_DOC = SAGE_VPATH/src/doc
>  - create SAGE_SRC_DOC = SAGE_ROOT/src/doc 

Or `SAGE_ROOT_SRC_DOC`?


---

Comment by mkoeppe created at 2017-09-01 21:24:16

Thanks, these are good suggestions.


---

Comment by git created at 2017-09-01 21:25:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2017-09-01 22:09:09

Replying to [comment:83 mkoeppe]:
> Replying to [comment:82 jhpalmieri]:
> > I haven't seen that after running `make distclean` in both the original source directory and the build directory, but I could imagine it would happen if you don't have write access to the original source directory, since the interpreters directory and its contents are autogenerated (see `src/sage_setup/autogen`). 
> 
> Yes, this is how I am testing it (except I made `src/doc` writable).
> 
> Something in the code generator is missing error checking. I suspect it's coming from`src/sage_setup/autogen/interpreters/__init__.py`, which has some complicated exception handling.
> 
> > Where should those files be created?
> 
> They should be created in `SAGE_ROOT/src/sage/ext`.

It looks like they are actually created in `SAGE_SRC_ROOT=SAGE_VPATH`, then copied to `SAGE_ROOT/...`.


---

Comment by mkoeppe created at 2017-09-01 22:17:22

Replying to [comment:83 mkoeppe]:
> Something in the code generator is missing error checking. I suspect it's coming from`src/sage_setup/autogen/interpreters/__init__.py`, which has some complicated exception handling.

See #23774.


---

Comment by mkoeppe created at 2017-09-01 22:20:46

Replying to [comment:90 jhpalmieri]:
> > > Where should those files be created?
> > 
> > They should be created in `SAGE_ROOT/src/sage/ext`.
> 
> It looks like they are actually created in `SAGE_SRC_ROOT=SAGE_VPATH`...

Yes, see `src/sage_setup/autogen/interpreters/__main__.py`.

But I think I will defer full VPATHification of this and of the docbuild to follow-up tickets.


---

Comment by embray created at 2017-09-05 09:27:43

I wonder if instead of

```
+dnl Set up files for VPATH build
+AS_IF([test x$srcdir != x.],
+    [AC_CONFIG_COMMANDS([vpath],
+	[
+	    SAGE_ROOT=${ac_abs_top_builddir}
+	    SAGE_VPATH=${ac_abs_top_srcdir}
+	    # Assume that $srcdir is readonly, so symlink existing upstream files into build directory upstream
+	    # If new packages are downloaded, they end up in the build directory upstream.
+	    mkdir -p upstream
+	    for a in $SAGE_VPATH/upstream/* ; do
+		if test -f "$a" -a ! -f "upstream/`basename $a`" ; then
+		    ln -s "$a" upstream/
+		fi
+	    done
+	    cat > sage <<EOF
```


we could simply modify whatever code looks for the `upstream/` directory (presumably mostly in `sage-spkg`) to explicitly look for it under `$SAGE_ROOT`.  In other words I don't see why making symlinks in the VPATH sources are necessary if we already _know_ where to find the `upstream/` directory.


---

Comment by jdemeyer created at 2017-09-05 15:40:45

I'm seeing a lot of activity on this ticket that I haven't followed.

Anyway, I still don't quite understand what a `VPATH` build even means in the context of Sage. I really think that this should be explained better, and how this differs from `./configure --prefix=...`


---

Comment by mkoeppe created at 2017-09-05 15:50:11

--prefix selects the install tree (SAGE_LOCAL) of sage-the-distribution.

The vpath mechanism selects the build tree (SAGE_ROOT) of sage-the-distribution. This includes the configuration and build artifacts such as src/build/...


---

Comment by jdemeyer created at 2017-09-06 08:17:45

Replying to [comment:95 mkoeppe]:
> --prefix selects the install tree (SAGE_LOCAL) of sage-the-distribution.
> 
> The vpath mechanism selects the build tree (SAGE_ROOT) of sage-the-distribution. This includes the configuration and build artifacts such as src/build/...

This short reply is much better than the long explanation in the ticket description. It's all totally clear now.


---

Comment by dimpase created at 2017-09-08 08:38:47

Would the old way to build still work unamended, or `BUILDDIR` will need to be created separately?


---

Comment by dimpase created at 2017-09-08 08:46:56

I wonder how this can be syncronised with git branches. Namely, it would be nice if a build is tagged by the source commit, so that it is known at which source state the build was done (I gather there could even be a git feature for this...).


---

Comment by embray created at 2017-09-08 09:28:11

Replying to [comment:98 dimpase]:
> I wonder how this can be syncronised with git branches. Namely, it would be nice if a build is tagged by the source commit, so that it is known at which source state the build was done (I gather there could even be a git feature for this...).

When making a VPATH build you typically specify the path to the build tree yourself, so you could do something like `VPATH=builds/$(git symbolic-ref --short HEAD)`.  But indeed it might be nice to have a way to automate that (or even enable by default).


---

Comment by dimpase created at 2017-09-08 09:31:50

Replying to [comment:99 embray]:
> Replying to [comment:98 dimpase]:
> > I wonder how this can be syncronised with git branches. Namely, it would be nice if a build is tagged by the source commit, so that it is known at which source state the build was done (I gather there could even be a git feature for this...).

Maybe [git-worktree](https://git-scm.com/docs/git-worktree) is the right git functionality to use...

> 
> When making a VPATH build you typically specify the path to the build tree yourself, so you could do something like `VPATH=builds/$(git symbolic-ref --short HEAD)`.  But indeed it might be nice to have a way to automate that (or even enable by default).


---

Comment by mkoeppe created at 2017-09-08 19:33:38

Replying to [comment:98 dimpase]:
> I wonder how this can be syncronised with git branches. Namely, it would be nice if a build is tagged by the source commit, so that it is known at which source state the build was done (I gather there could even be a git feature for this...).

It would be nice if the Sage version number that it displays at startup would show the git commit from which it is built.
But this is entirely unrelated to the present ticket.


---

Comment by mkoeppe created at 2017-09-08 19:36:00

Replying to [comment:99 embray]:
> When making a VPATH build you typically specify the path to the build tree yourself, so you could do something like `VPATH=builds/$(git symbolic-ref --short HEAD)`.  

Just a quick note. When one says "VPATH", it refers to the source directory, not to the build directory. https://www.gnu.org/software/make/manual/html_node/General-Search.html


---

Comment by mkoeppe created at 2017-09-08 19:37:06

Replying to [comment:97 dimpase]:
> Would the old way to build still work unamended, or `BUILDDIR` will need to be created separately?

Yes, with this patch one can still do non-VPATH builds, without any change.


---

Comment by dimpase created at 2017-09-08 20:12:29

Replying to [comment:101 mkoeppe]:
> Replying to [comment:98 dimpase]:
> > I wonder how this can be syncronised with git branches. Namely, it would be nice if a build is tagged by the source commit, so that it is known at which source state the build was done (I gather there could even be a git feature for this...).
> 
> It would be nice if the Sage version number that it displays at startup would show the git commit from which it is built.
> But this is entirely unrelated to the present ticket.

I suppose I just don't understand what happens to a VPATH build after the source tree it is built from is changed. Will it become broken, or not?


---

Comment by jhpalmieri created at 2017-09-28 18:47:12

Are there any immediate issues left here beside comment:93?


---

Comment by saraedum created at 2018-01-14 01:57:36

Changing status from needs_review to needs_work.


---

Comment by saraedum created at 2020-02-28 00:04:39

I actually could really use this feature right now :)

mkoeppe, should I try to resolve conflicts here? Or do you have time to do so, so I can review afterwards and maybe fix comment:93?


---

Comment by mkoeppe created at 2020-02-28 00:14:32

I hope to get back to it within the next month, but not right now. It will likely interact with some of my build-related tickets that are waiting for review...

If you need this earlier, please feel free to work on it.

I don't think comment 93 should hold up this ticket. Improvements could always be done in a follow-up ticket.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.
