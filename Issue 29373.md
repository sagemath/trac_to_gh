# Issue 29373: Implement Vertex algebras and related algebraic structures

Issue created by migration from https://trac.sagemath.org/ticket/29610

Original creator: heluani

Original creation time: 2020-04-28 13:00:52

CC:  tscrim heluani bump

Keywords: vertex algebras, lie conformal algebras

This ticket implements **vertex algebras**, **Poisson vertex algebras**, **Lie conformal algebras** and related algebraic structures. 

## Summary of implemented structures
- Lie conformal algebras: 
   - category of such and their subcategories (graded, finitely generated, etc)
   - Freely and finitely generated Lie conformal algebras and central extensions of those. 
   - H-graded Lie conformal algebras.
- Vertex algebras:
    - category of such and their subcategories as above.
    - Universal enveloping vertex algebras of Lie conformal algebras.
    - canonical embedding from a Lie conformal algebra to its universal enveloping algebra. 
    - Vertex algebra ideals of graded vertex algebras, generated by primary vectors. 
    - Quotients of vertex algebras by vertex algebra ideals. 
    - Li filtration and associated graded. 
- Poisson vertex algebras:
    - category of such and their subcategories as above.
    - classical limits of universal enveloping vertex algebras and their quotients by primary vectors. 
- Graded commutative algebras with a derivation (it's a pity that `dca` has very different meanings in the literature and has already been taken in Sage)
    - Affine arc algebras (differential polynomial algebra). Possibly weighted and using different `TermOrders`. 
    - differential ideals 
    - quotients of Affine arc algebras by their differential ideals.
   


## Examples from the documentation:

The base class for all vertex algebras is `VertexAlgebra`. 
All subclasses are called through its method `__classcall_private__`.
We provide some convenience functions to define named vertex algebras
like `VirasoroVertexAlgebra` and `AffineVertexAlgebra`

- We create the Universal Virasoro Vertex algebra at central charge `c=1/2` and perform some basic computations:


```
sage: V = VirasoroVertexAlgebra(QQ,1/2); V.inject_variables()
Defining L
sage: L*L
L_-2L_-2|0>
sage: (L*L).T()
2*L_-3L_-2|0>+L_-5|0>
sage: sorted(L.bracket(L*L).items())
[(0, 2*L_-3L_-2|0>+L_-5|0>),
 (1, 4*L_-2L_-2|0>),
 (2, 3*L_-3|0>),
 (3, 17/2*L_-2|0>),
 (5, 3/2*|0>)]
```



- We compute it's irreducible quotient:

```
sage: V.find_singular(6)    [L_-2L_-2L_-2|0>-33/8*L_-4L_-2|0>+93/64*L_-3L_-3|0>-27/16*L_-6|0>]
sage: v = _[0]; I = V.ideal(v)
sage: I
ideal of The Virasoro vertex algebra at central charge 1/2 generated by (L_-2L_-2L_-2|0>-33/8*L_-4L_-2|0>+93/64*L_-3L_-3|0>-27/16*L_-6|0>,)
sage: Q = V.quotient(I)
sage: Q
Quotient of The Virasoro vertex algebra at central charge 1/2 by the ideal generated by (L_-2L_-2L_-2|0>-33/8*L_-4L_-2|0>+93/64*L_-3L_-3|0>-27/16*L_-6|0>,)
sage: Q.retract(L*L*L)
65/8*L_-4L_-2|0>+35/64*L_-3L_-3|0>+35/16*L_-6|0>
```


- We construct the universal Affine vertex algebra for `sl_3` at level `2` and perform some basic computations:


```
sage: V = AffineVertexAlgebra(QQ,'A2',2)
sage: V.gens()
(E(alpha[2])_-1|0>,
 E(alpha[1])_-1|0>,
 E(alpha[1] + alpha[2])_-1|0>,
 E(alphacheck[1])_-1|0>,
 E(alphacheck[2])_-1|0>,
 E(-alpha[2])_-1|0>,
 E(-alpha[1])_-1|0>,
 E(-alpha[1] - alpha[2])_-1|0>)
sage: e = V.gen(0); f = V.gen(7)
sage: e.bracket(f)
{0: -E(-alpha[1])_-1|0>}
sage: e*f
E(alpha[2])_-1E(-alpha[1] - alpha[2])_-1|0>
```


- We construct the universal affine vertex algebra for `sl_2` at level`3` and check that a vector is singular:

```
sage: V = AffineVertexAlgebra(QQ,'A1',3)
sage: V.gens()
(E(alpha[1])_-1|0>, E(alphacheck[1])_-1|0>, E(-alpha[1])_-1|0>)
sage: e = V.gen(0)
sage: e*(e*(e*e))
E(alpha[1])_-1E(alpha[1])_-1E(alpha[1])_-1E(alpha[1])_-1|0>
sage: (e*(e*(e*e))).is_singular()
True
```


- We construct the classical limit of `V` and check that the multiplication is associative in this limit while not in `V`:


```
sage: P = V.classical_limit()
sage: P
The Poisson vertex algebra quasi-classical limit of The universal affine vertex algebra of CartanType ['A', 1] at level 3
sage: f = V.gen(2)
sage: e*(e*f) == (e*e)*f
False
sage: e=P(e); e.parent()
The Poisson vertex algebra quasi-classical limit of The universal affine vertex algebra of CartanType ['A', 1] at level 3
sage: f=P(f)
sage: e*(e*f) == (e*e)*f
True
```


## Comments

- This ticket fails one of the first //Guidelines for opening tickets//:
       "It is much better to open several specific tickets than one that is very broad. Indeed, a single ticket which deals with lots of different issues can be quite problematic, and should be avoided."
    However I feel that most of the structures defined here are so much intimately related that it makes more sense to have all of them in the same ticket. 

- One exception to the above is the code on `GradedCommutativeAlgebraWithDerivation` (it's a pity that `dca` has very different meanings in the literature and has already been taken in Sage). But I kept it in the same ticket because it may be eventually absorbed by `PoissonVertexAlgebra` or perhaps will eventually use another ticket of people working with arc and jet spaces. 
- I am no programmer and just started using Sage (and python for that matter) last year. I focused on having a mathematically correct code first and will go over implementation details and good programming conduct in the near future. 

## Immediate Goals
- Implement super versions of the above structures. I have a subbranch implementing this but it is even less stable than this one.
- Better implementation of arithmetics, specially with classical limits of vertex algebras. The code on Poisson vertex algebra in this branch is horrible and very expensive to do calculations. This was the cost of trying to code generic implementations of classical limits instead of particular cases like universal enveloping algebras and the such. I have another branch implementing these limits as `AffineArcAlgebras` which is faster. In any case most of the arithmetic will need to be cythonized anyway. 

## What is not implemented
- Lattice vertex algebras
- Coset models
- Representations of vertex algebras


---

Comment by chapoton created at 2020-04-28 16:50:45

The problem with such a huge ticket is that you will have even harder times to find a reviewer.

Small comment:

```
+EXAMPLES::
+
+- We construct the algebra of functions of the arc space of the *fat origin of
+  the line* `\mathbb{A}^1` over the rationals and compute it's graded
+  dimension::
```

This is not correct, only lines with indented content should end with ::

More generally you should build the doc and look at it.


---

Attachment

image built doc


---

Comment by heluani created at 2020-04-28 17:18:33

Thanks. Regarding the comment it looks good in my built copy of the doc (modulo the "it's" that should be "its"):
![](ticket:29610:ticket.jpg)


---

Comment by chapoton created at 2020-05-01 18:47:21

The suggestion from comment:1 must be followed, please.


---

Comment by git created at 2020-06-22 19:29:04

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by tscrim created at 2020-06-22 23:19:50

I am very much interested in getting this into Sage, and it is a very good project.

Like Frédéric, I think it would be better if you can split this into at least a few separate tickets. For example, the basic framework that can handle generic data can go in one and then some of the more specific examples can in another (or at most one specific implementation if there is no generic data possible that you can use for your doctests).

Something else from a quick browse through your code, it looks like at this point your framework of ABCs for Lie conformal algebras is better to be lifted to the respective categories.

I think another good thing to have is a catalog object as a common entry point for the different specific examples.


---

Comment by git created at 2020-06-25 20:27:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by heluani created at 2020-06-25 20:34:35

Replying to [comment:6 tscrim]:
> I am very much interested in getting this into Sage, and it is a very good project.
> 
> Like Frédéric, I think it would be better if you can split this into at least a few separate tickets. For example, the basic framework that can handle generic data can go in one and then some of the more specific examples can in another (or at most one specific implementation if there is no generic data possible that you can use for your doctests).
> 
> Something else from a quick browse through your code, it looks like at this point your framework of ABCs for Lie conformal algebras is better to be lifted to the respective categories.
> 
> I think another good thing to have is a catalog object as a common entry point for the different specific examples.

Thanks for the comments, I'll finish documenting what I have now, following Chapoton's comments on the documentation (I refactored the whole with basis thing to use CombinatorialFreeModules and added plenty of examples of super algebras) and then I'll ask for help into how to break this. I have some ideas, but they all lead to breakage of doctesting, which I put a lot of effort into having plenty of them. 

I should be ready to ask for reviewers in the next few days. I am happy with the functionality as it is now, the biggest problem is the speed of arithmetics when working with classical limits of quotients of vertex algebras. I will move the main computations to cython in a following ticket, but I am afraid that it may even be my choice of recursion instead of brutally computing commutators of Lie algebra modes.


---

Comment by git created at 2020-06-28 00:32:43

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by heluani created at 2020-06-28 01:29:15

Changing status from new to needs_review.


---

Comment by heluani created at 2020-06-28 01:58:42

Replying to [comment:6 tscrim]:
> I am very much interested in getting this into Sage, and it is a very good project.
> 
Hello I just posted the last of what I had n mind for a first draft and I am hoping to get some reviewers. I posted some views in sage-devel (which I suppose is better to discuss than trac) but I am happy to break this if this would help reviewers. 

Before doing so I wanted to come back to some of your comments:

> 
> Something else from a quick browse through your code, it looks like at this point your framework of ABCs for Lie conformal algebras is better to be lifted to the respective categories.

I tried to put every method that was implementation independent in the category, is this what you mean? did I miss much?

> 
> I think another good thing to have is a catalog object as a common entry point for the different specific examples.

This I don't know what you mean? I tried to copy your model on LieAlgebras where there's one exposed class that you call to construct any other object through it's __classcall_private__ method. These are LieConformalAlgebra, VertexAlgebra and PoissonVertexAlgebra respectively now. The first is essentially the same as you LieAlgebra: you feed it structure constants and it constructs something. Is this what you mean by catalog?


---

Comment by mkoeppe created at 2020-06-28 02:17:43

I would suggest to split out the changes to `src/sage/combinat/partition_tuple.py` to a separate ticket, but I would suspect that there is no point in trying to break the other things into many tickets.


---

Comment by heluani created at 2020-06-28 10:08:24

Replying to [comment:13 mkoeppe]:
> I would suggest to split out the changes to `src/sage/combinat/partition_tuple.py` to a separate ticket, but I would suspect that there is no point in trying to break the other things into many tickets. 
> 
Ah thanks, I opened #30007


---

Comment by git created at 2020-06-29 23:54:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-30 02:15:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-30 18:14:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-30 18:33:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-30 20:37:36

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by heluani created at 2020-06-30 20:38:20

Last 10 new commits:


---

Comment by git created at 2020-07-01 00:59:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-02 01:52:44

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2020-07-02 02:58:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-02 10:21:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-02 10:49:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-04 00:13:32

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by chapoton created at 2020-08-14 12:48:40

red branch => needs work


---

Comment by chapoton created at 2020-08-14 12:48:55

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-08-28 11:27:59

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2020-08-28 12:21:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by heluani created at 2020-08-28 12:24:34

Changing status from needs_work to needs_review.


---

Comment by git created at 2020-08-28 15:54:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by heluani created at 2020-08-30 18:45:25

On my bot it came back green, but on Linux/1_SMP_Debian_4.19.132-1_%282020-07-24%29/x86_64/4.19.0-10-amd64/tmonteil-lxc it comes back with failed tests, but those look like timeouts on other parts of Sage, perhaps the bot is low on resources? anyhow, I'll be reading the code for PEP changes and similar, but I assume the tests are alright.


---

Comment by tscrim created at 2020-08-31 05:35:58

I wouldn't worry too much about those failing tests.

I will try to get through this ticket soon, but I am not sure if I will get it done in time to get into 9.2...


---

Comment by heluani created at 2020-08-31 09:31:45

Replying to [comment:38 tscrim]:
> I wouldn't worry too much about those failing tests.
> 
> I will try to get through this ticket soon, but I am not sure if I will get it done in time to get into 9.2...
Thanks. Indeed I don't think this will get into 9.2. besides lots of places where I broke lines to stick to PEP8 and the coding formats that you corrected in #30032, there will be some contentious points. I'd pay attention to classes like `EnergyPartitionTuples` that are just wrappers around partition tuples and the classes like `VertexALgebraIdealBasis` that are just an infinite `EnumeratedSet` with some methods to allow to construct cokernels of maps of graded vector spaces. This seems to me like a recurring theme in representation theory that perhaps can be coded into `ModulesWithBasis`: you have a graded infinite dimensional vector space and it's graded infinite dimensional subspace. Supposing that the graded pieces are finite dimensional, the quotient should be easy to construct. These classes do that. Unfortunately, in many places in Sage, "graded" is assumed to be integrally graded. Similarly filtrations are assumed to be indexed by natural numbers. I needed rational gradings so I worked these classes particularly for my case-use instead of trying to add anything to `modules/with_bssis/subquotients`.


---

Comment by tscrim created at 2020-09-13 02:48:26

Looking this over, I am again reminded that this is indeed quite a project. It will be great to have this in Sage. Here are my comments from a very quick first glance through everything.

Avoid

```diff
-from sage.rings.all import ZZ
+from sage.rings.integer_ring import ZZ
```

The more specific import helps in preventing cyclic imports and deal with Sage's import hell.

For basis indices, such as `PoissonVertexAlgebraIdealBasis`, you should look at inheriting from `AbstractFamily` and/or `LazyFamily` as those already have a lot of the features you want. Perhaps you can even just use `Family` objects without any modification either. See `sage/sets/family.py`. This would help make things more uniform across Sage.

For, e.g., `PoissonVertexAlgebraIdealElement`, it seems like that is something that should be defined completely in the category using generic/default methods in the corresponding `Subobjects` (and/or `Quotients`) category.

Changes like this:

```diff
-            if any([w not in QQ or w < 0 for w in weights]):
-                raise NotImplementedError("hilbert_series is not "\
-                                  "implemented for {}".format(self))
+            if any(w not in QQ or w < 0 for w in weights):
+                raise NotImplementedError("hilbert_series is not "
+                                  "implemented for {}".format(self))
```

The inner list is not necessary (and in principle slower because of the extra transient object); IIRC it is good practice to not have the list. You don't need the trailing line continuation because of the parentheses; it makes the code a little cleaner and more robust. As another example:

```diff
-                f = sum(self.dimension_at_weight(n/l)*q**(n/l) for\
-                        n in range(ord))
+                f = sum(self.dimension_at_weight(n/l) * q**(n/l)
+                        for n in range(ord))
```



```diff
-            if l==1:
-                from sage.rings.power_series_ring import\
-                                                    PowerSeriesRing
+            if l == 1:
+                from sage.rings.power_series_ring import PowerSeriesRing
```

Here I will say both follow PEP8 and don't follow it so strictly as enforcing the 80 char/line limit makes the code harder to read IMO.

`\mathbb{Z}` -> `\ZZ` for standardization within Sage's doc.


```diff
-The associated graded of `V` with respect to this filtration is a
+The associated graded algebra of `V` with respect to this filtration is a
```


Instead of having documentation in the `__init__`, I think it is generally better to have it at the class level. That way in the `__init__` you can have more technical information that is not available to the end-user (and put `TestSuite(foo).run()` tests).

Error messages should start with a lowercase letter.

I would Cythonize `vertex_algebra_element.py` since that will likely have some performance critical code that will benefit from the cythonization.

Also, code like 

```
i1 = next((j for j,x in enumerate(a.index()) if x))
n1 = a.index()[i1][0]
```

suggests to me that it should become a method on `a` to get this information.


```diff
-if energy==None:
+if energy is None:
```


This comment

```
        #__mro__ picks Modules before VertexAlgebras.Quotients
        return self.lift().is_even_odd()
```

makes me think that there should be something added to the corresponding module quotient category. Although I find it a bit surprising that it does happen at all since the `VertexAlgebras.Quotients` category should be very early in the MRO...

Usually we don't call objects "The foo..." but simply "foo...", e.g.:

```
sage: ZZ                                                                                                              
Integer Ring
```


I like the name proto vertex algebras. I will have to use that for Lie algebras.

Your `poisson_vertex_algebras.rst` is overindented.

In `GradedLCAElement.degree()`, I would move the import of infinity outside to optimize it. Also, this should be faster:

```
-if self.is_zero():
+if not self:
```



---

Comment by heluani created at 2020-09-13 09:59:45

Replying to [comment:40 tscrim]:

Thanks a lot for this, I'll try to go over it during the next weeks, I'm a bit overwhelmed at the moment. I was planning though to submit a small ticket implementing the infinite dimensional Lie algebra associated to a LCA to give some functionality to 9.2 since the LCAs alone is nothing compared to this ticket. 

> I would Cythonize `vertex_algebra_element.py` since that will likely have some performance critical code that will benefit from the cythonization.
> 

I already tried this and it became slower for the examples in the doctesting, and slightly faster in very large computations, but barely noticeable. I am not sure if this is the heavy use of list comprehension or the overhead of the category framework to call methods. This code is way slower, a lot slower than Thielemann's Mathematica Package from the nineties, and it uses the same algorithm to compute OPEs. What did help a little is some parallelization that I implemented for my own computations.


---

Comment by tscrim created at 2020-09-15 23:05:58

Replying to [comment:41 heluani]:
> Replying to [comment:40 tscrim]:
> 
> Thanks a lot for this, I'll try to go over it during the next weeks, I'm a bit overwhelmed at the moment. I was planning though to submit a small ticket implementing the infinite dimensional Lie algebra associated to a LCA to give some functionality to 9.2 since the LCAs alone is nothing compared to this ticket. 

No rush. Feel free to subdivide or do other small tickets too.

> > I would Cythonize `vertex_algebra_element.py` since that will likely have some performance critical code that will benefit from the cythonization.
> > 
> 
> I already tried this and it became slower for the examples in the doctesting, and slightly faster in very large computations, but barely noticeable. I am not sure if this is the heavy use of list comprehension or the overhead of the category framework to call methods. This code is way slower, a lot slower than Thielemann's Mathematica Package from the nineties, and it uses the same algorithm to compute OPEs. What did help a little is some parallelization that I implemented for my own computations.

I will have to try this too. Can you give me what you are using to do the timings (more so for the smaller computations)?


---

Comment by mkoeppe created at 2021-03-15 22:07:04

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by chapoton created at 2021-10-05 11:17:45

red branch => needs work


---

Comment by chapoton created at 2021-10-05 11:17:45

Changing status from needs_review to needs_work.
