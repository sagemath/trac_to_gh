# Issue 17569: MPIR fails to build on 32-bit Linux with SAGE_FAT_BINARY=yes

Issue created by migration from Trac.

Original creator: vbraun

Original creation time: 2015-02-18 20:13:14

CC:  leif

Both the arando buildbot binary build as well as the virtual machine build of Sage-6.5 failed with 

```
In file included from fat.c:123:0:
../cpuid.c: In function '__gmpn_cpu':
../cpuid.c:96:47: error: 'CPUSETUP_ivybridge' undeclared (first use in this function)
 #define CPUIS(x) do{TRACE(printf("  "#x"\n"));CPUSETUP_##x;}while(0)
                                               ^
../cpuid.c:174:24: note: in expansion of macro 'CPUIS'
      if (model == 58){ CPUIS(ivybridge);break;}
                        ^
../cpuid.c:96:47: note: each undeclared identifier is reported only once for each function it appears in
 #define CPUIS(x) do{TRACE(printf("  "#x"\n"));CPUSETUP_##x;}while(0)
                                               ^
../cpuid.c:174:24: note: in expansion of macro 'CPUIS'
      if (model == 58){ CPUIS(ivybridge);break;}
                        ^
../cpuid.c:96:47: error: 'CPUSETUP_haswell' undeclared (first use in this function)
 #define CPUIS(x) do{TRACE(printf("  "#x"\n"));CPUSETUP_##x;}while(0)
                                               ^
../cpuid.c:175:22: note: in expansion of macro 'CPUIS'
    if (model == 60){ CPUIS(haswell);break;}
                      ^
../cpuid.c:96:47: error: 'CPUSETUP_piledriver' undeclared (first use in this function)
 #define CPUIS(x) do{TRACE(printf("  "#x"\n"));CPUSETUP_##x;}while(0)
                                               ^
../cpuid.c:230:24: note: in expansion of macro 'CPUIS'
      if (model == 2) { CPUIS(piledriver); break; }
                        ^
make[6]: *** [fat.lo] Error 1
```


Arando MPIR build log http://build.sagedev.org/release/builders/Zbin%20%20fast%20Oxford%20arando%20%28Ubuntu%2013.04%20i686%29%20binary/builds/8/steps/compile_2/logs/mpir


---

Comment by tmonteil created at 2015-02-20 00:45:02

I confirm this bug appears on Debian stable 32 bits with `SAGE_FAT_BINARY=yes` (trying to build Sage Debian Live).


---

Comment by tmonteil created at 2015-02-20 09:44:30

I confirm the same VM (qemu) can compile MPIR without `SAGE_FAT_BINARY=yes`. Any clue about that issue ? If you need some logs or tests, please do  not hesitate to ask.


---

Comment by leif created at 2015-02-20 17:43:46

"Acknowledge", well... ;-)

Note that fat builds now do not even work on true 32-bit (x86) CPUs.  (That is, they don't and cannot _compile_ either.)

Although there's no specific 32-bit code for the added (64-bit) CPUs, it's not sufficient to just add "dummy" macro definitions for those to `mpn/x86/fat/fat.c`.  (Not sure yet, but probably `configure[.ac]` needs to get fixed / updated accordingly as well.)


---

Comment by leif created at 2015-02-20 18:14:16

Ouch:  Looks like the `cpuvec_t` struct (containing function pointers) has been extended, but the _32-bit version_ of `fat.c` doesn't yet reflect this, so (at best) wrong functions get called...


---

Comment by leif created at 2015-02-20 19:43:36

Ok, I _think<sup>TM</sup>_ I do have an (initial, at least) fix now:


```diff
--- mpir-2.7.0-alpha12/mpn/x86/fat/fat.c.orig	2014-09-14 21:59:13.000000000 +0200
+++ mpir-2.7.0-alpha12/mpn/x86/fat/fat.c	2015-02-20 20:16:13.909300216 +0100
`@``@` -37,6 +37,8 `@``@`
 long __gmpn_cpuid __GMP_PROTO ((char dst[12], int id));
 
 struct cpuvec_t __gmpn_cpuvec = {
+  __MPN(add_err1_n_init),
+  __MPN(add_err2_n_init),
   __MPN(add_n_init),
   __MPN(addmul_1_init),
   __MPN(copyd_init),
`@``@` -55,11 +57,14 `@``@`
   __MPN(modexact_1c_odd_init),
   __MPN(mul_1_init),
   __MPN(mul_basecase_init),
+  __MPN(mulmid_basecase_init),
   __MPN(preinv_divrem_1_init),
   __MPN(preinv_mod_1_init),
   __MPN(redc_1_init),
   __MPN(rshift_init),
   __MPN(sqr_basecase_init),
+  __MPN(sub_err1_n_init),
+  __MPN(sub_err2_n_init),
   __MPN(sub_n_init),
   __MPN(submul_1_init),
   __MPN(sumdiff_n_init),
`@``@` -102,6 +107,8 `@``@`
 #define CPUSETUP_nehalem	CPUVEC_SETUP_nehalem
 #define CPUSETUP_westmere	CPUVEC_SETUP_nehalem
 #define CPUSETUP_sandybridge	CPUVEC_SETUP_nehalem
+#define CPUSETUP_ivybridge	CPUVEC_SETUP_nehalem
+#define CPUSETUP_haswell	CPUVEC_SETUP_nehalem
 #define CPUSETUP_atom		CPUVEC_SETUP_p6;CPUVEC_SETUP_p6_mmx;CPUVEC_SETUP_p6_p3mmx
 #define CPUSETUP_nano		CPUVEC_SETUP_p6;CPUVEC_SETUP_p6_mmx;CPUVEC_SETUP_p6_p3mmx
 #define CPUSETUP_pentium4	CPUVEC_SETUP_pentium4;CPUVEC_SETUP_pentium4_mmx;CPUVEC_SETUP_pentium4_sse2
`@``@` -116,6 +123,7 `@``@`
 #define CPUSETUP_k102		CPUVEC_SETUP_k7;CPUVEC_SETUP_k7_mmx;CPUVEC_SETUP_k7_mmx_k8;CPUVEC_SETUP_k7_mmx_k8_k10;CPUVEC_SETUP_k7_mmx_k8_k10_k102
 #define CPUSETUP_k103		CPUVEC_SETUP_k7;CPUVEC_SETUP_k7_mmx;CPUVEC_SETUP_k7_mmx_k8;CPUVEC_SETUP_k7_mmx_k8_k10;CPUVEC_SETUP_k7_mmx_k8_k10_k102
 #define CPUSETUP_bulldozer	CPUVEC_SETUP_k7;CPUVEC_SETUP_k7_mmx;CPUVEC_SETUP_k7_mmx_k8;CPUVEC_SETUP_k7_mmx_k8_k10;CPUVEC_SETUP_k7_mmx_k8_k10_k102
+#define CPUSETUP_piledriver	CPUVEC_SETUP_k7;CPUVEC_SETUP_k7_mmx;CPUVEC_SETUP_k7_mmx_k8;CPUVEC_SETUP_k7_mmx_k8_k10;CPUVEC_SETUP_k7_mmx_k8_k10_k102
 #define CPUSETUP_bobcat		CPUVEC_SETUP_k7;CPUVEC_SETUP_k7_mmx;CPUVEC_SETUP_k7_mmx_k8;CPUVEC_SETUP_k7_mmx_k8_k10;CPUVEC_SETUP_k7_mmx_k8_k10_k102
 #define CPUSETUP_viac3		do{}while(0)
 #define CPUSETUP_viac32		do{}while(0)
```


Works for me (i.e., builds and passes `make check`) on x86 as well as x86_64 with `ABI=32`.

Feel free to create an "updated spkg" / Sage patch from that (presumably by simply adding the patch to the spkg "metadata") -- I won't soon.


---

Comment by leif created at 2015-02-21 21:19:07

Looks like your branch lacks the last hunk.  (I've posted the patch to mpir-devel.)
----
New commits:


---

Comment by leif created at 2015-02-21 21:23:08

Patch against MPIR 2.7.0-alpha12 (submitted upstream)


---

Attachment

Replying to [comment:10 leif]:
> (I've posted the patch to mpir-devel.)

Now attached here as well.


---

Comment by git created at 2015-02-21 21:33:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2015-02-21 21:34:48

Changing status from new to needs_review.


---

Comment by tmonteil created at 2015-02-21 21:34:48

Thanks for the fix !


---

Comment by tmonteil created at 2015-03-03 20:09:03

For what it worth, i confirm it allows me to build Sage on a 32 bits machine with `SAGE_FAT_BINARY=yes` (tested both with qemu and on a real 32 bits machine). What is the status of arando buildbot with this patch ? Could someone else try do do the same ?


---

Comment by vbraun created at 2015-03-03 20:31:45

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-03-04 23:16:22

Resolution: fixed


---

Comment by leif created at 2015-03-07 16:15:15

Just for the record:

With assertions enabled (MPIR configured with `--enable-assert`), I'm getting an _MPIR_ test suite failure in 32-bit fat mode (`ABI=32` and `--enable-fat` on a 64-bit machine), which doesn't show up in non-fat 32-bit mode nor 64-bit fat mode:


```
FAIL: t-gcd (exit: 134)
=======================

divexact.c:107: GNU MP assertion failed: (np[0]) != 0
```


Haven't tracked this down yet, but apparently there's more to do upstream, not necessarily really related to the issue here...


---

Comment by leif created at 2015-03-19 14:59:10

Replying to [comment:17 leif]:
> With assertions enabled (MPIR configured with `--enable-assert`), I'm getting an _MPIR_ test suite failure in 32-bit fat mode (`ABI=32` and `--enable-fat` on a 64-bit machine), which doesn't show up in non-fat 32-bit mode nor 64-bit fat mode:
> 
> {{{
> FAIL: t-gcd (exit: 134)
> =======================
> 
> divexact.c:107: GNU MP assertion failed: (np[0]) != 0
> }}}

The same happens on a true 32-bit machine, and also *without* `--enable-fat`, so the failure seems rather unrelated to the issue (and the patch) here.


---

Comment by tmonteil created at 2019-08-27 19:45:19

Changing keywords from "" to "sdl".
