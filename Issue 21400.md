# Issue 21400: Bug with PARI interface gen.eval on Cygwin

archive/issues_021400.json:
```json
{
    "body": "Keywords: pari windows cygwin\n\nIt seems that `gen.eval()` is returning `pari('0')` in cases where it should be returning `None`.  The relevant code is\n\n```cython\n        if t == t_CLOSURE:\n            if nkwds > 0:\n                raise TypeError(\"cannot evaluate a PARI closure using keyword arguments\")\n            if closure_is_variadic(self.g):\n                arity = closure_arity(self.g) - 1\n                args = list(args[:arity]) + [0]*(arity-nargs) + [args[arity:]]\n            t0 = objtogen(args)\n            sig_on()\n            result = closure_callgenvec(self.g, t0.g)\n            if result == gnil:\n                P.clear_stack()\n                return None\n            return P.new_gen(result)\n```\n\nSo it seems like `result != gnil` when it is expected to be.  For example this test from the doctests is failing:\n\n```\nsage: def printme(x):\n....:     print(x)\n....:\nsage: objtoclosure(printme)('matid(2)')\n[1, 0; 0, 1]\n0\n```\n\nThe final `0` is the return value from calling the closure.  It should return `None`.  This is especially odd because the logic in `objtoclosure` is that if the called Python function returns `None` the PARI function should return `gnil`.\n\nI didn't have this bug a few weeks ago, and it's strange that I'm only seeing it on Cygwin.\n\nIssue created by migration from https://trac.sagemath.org/ticket/21637\n\n",
    "created_at": "2016-10-04T09:12:29Z",
    "labels": [
        "component: porting: cygwin",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.4",
    "title": "Bug with PARI interface gen.eval on Cygwin",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21400",
    "user": "https://github.com/embray"
}
```
Keywords: pari windows cygwin

It seems that `gen.eval()` is returning `pari('0')` in cases where it should be returning `None`.  The relevant code is

```cython
        if t == t_CLOSURE:
            if nkwds > 0:
                raise TypeError("cannot evaluate a PARI closure using keyword arguments")
            if closure_is_variadic(self.g):
                arity = closure_arity(self.g) - 1
                args = list(args[:arity]) + [0]*(arity-nargs) + [args[arity:]]
            t0 = objtogen(args)
            sig_on()
            result = closure_callgenvec(self.g, t0.g)
            if result == gnil:
                P.clear_stack()
                return None
            return P.new_gen(result)
```

So it seems like `result != gnil` when it is expected to be.  For example this test from the doctests is failing:

```
sage: def printme(x):
....:     print(x)
....:
sage: objtoclosure(printme)('matid(2)')
[1, 0; 0, 1]
0
```

The final `0` is the return value from calling the closure.  It should return `None`.  This is especially odd because the logic in `objtoclosure` is that if the called Python function returns `None` the PARI function should return `gnil`.

I didn't have this bug a few weeks ago, and it's strange that I'm only seeing it on Cygwin.

Issue created by migration from https://trac.sagemath.org/ticket/21637





---

archive/issue_comments_296798.json:
```json
{
    "body": "Just FYI: the PARI value `gnil` is like Python's `None`. But it is really just a pointer to a \"special\" `0`. It is indistinguishable from any other `0` except by comparing pointers.",
    "created_at": "2016-10-04T10:03:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296798",
    "user": "https://github.com/jdemeyer"
}
```

Just FYI: the PARI value `gnil` is like Python's `None`. But it is really just a pointer to a "special" `0`. It is indistinguishable from any other `0` except by comparing pointers.



---

archive/issue_comments_296799.json:
```json
{
    "body": "Can you test this:\n\n```\nsage: pari(\"x -> print(x);\")(\"hello\")\nhello\n```",
    "created_at": "2016-10-04T10:06:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296799",
    "user": "https://github.com/jdemeyer"
}
```

Can you test this:

```
sage: pari("x -> print(x);")("hello")
hello
```



---

archive/issue_comments_296800.json:
```json
{
    "body": "That test fails too in the same way.",
    "created_at": "2016-10-04T10:56:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296800",
    "user": "https://github.com/embray"
}
```

That test fails too in the same way.



---

archive/issue_comments_296801.json:
```json
{
    "body": "Replying to [comment:1 jdemeyer]:\n> Just FYI: the PARI value `gnil` is like Python's `None`. But it is really just a pointer to a \"special\" `0`. It is indistinguishable from any other `0` except by comparing pointers.\n\n\nI see--that helps explain it.  Maybe there's something odd going on with pointer comparison.",
    "created_at": "2016-10-04T10:57:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296801",
    "user": "https://github.com/embray"
}
```

Replying to [comment:1 jdemeyer]:
> Just FYI: the PARI value `gnil` is like Python's `None`. But it is really just a pointer to a "special" `0`. It is indistinguishable from any other `0` except by comparing pointers.


I see--that helps explain it.  Maybe there's something odd going on with pointer comparison.



---

archive/issue_comments_296802.json:
```json
{
    "body": "OK, next thing is to try GP itself:\n\n```\n$ ./sage --gp\n```\nand then\n\n```\n? (x -> print(x))(\"hello\")\nhello\n```",
    "created_at": "2016-10-04T11:28:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296802",
    "user": "https://github.com/jdemeyer"
}
```

OK, next thing is to try GP itself:

```
$ ./sage --gp
```
and then

```
? (x -> print(x))("hello")
hello
```



---

archive/issue_comments_296803.json:
```json
{
    "body": "Could you try this patch to PARI:\n\n```diff\ndiff --git a/src/headers/pariinl.h b/src/headers/pariinl.h\nindex 2567d55..e37b435 100644\n--- a/src/headers/pariinl.h\n+++ b/src/headers/pariinl.h\n@@ -1272,7 +1272,7 @@ INLINE void\n killblock(GEN x) { gunclone(x); }\n \n INLINE int\n-is_universal_constant(GEN x) { return (x >= gen_0 && x <= ghalf); }\n+is_universal_constant(GEN x) { return (x >= gnil && x <= ghalf); }\n \n /*******************************************************************/\n /*                                                                 */\n```\n\nJust copy this to some file inside `build/pkgs/patches/`, rebuild PARI (`./sage -f pari`) and test again.",
    "created_at": "2016-10-04T11:35:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296803",
    "user": "https://github.com/jdemeyer"
}
```

Could you try this patch to PARI:

```diff
diff --git a/src/headers/pariinl.h b/src/headers/pariinl.h
index 2567d55..e37b435 100644
--- a/src/headers/pariinl.h
+++ b/src/headers/pariinl.h
@@ -1272,7 +1272,7 @@ INLINE void
 killblock(GEN x) { gunclone(x); }
 
 INLINE int
-is_universal_constant(GEN x) { return (x >= gen_0 && x <= ghalf); }
+is_universal_constant(GEN x) { return (x >= gnil && x <= ghalf); }
 
 /*******************************************************************/
 /*                                                                 */
```

Just copy this to some file inside `build/pkgs/patches/`, rebuild PARI (`./sage -f pari`) and test again.



---

archive/issue_comments_296804.json:
```json
{
    "body": "Ok, I'll try that.  Any idea why that patch?",
    "created_at": "2016-10-04T11:40:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296804",
    "user": "https://github.com/embray"
}
```

Ok, I'll try that.  Any idea why that patch?



---

archive/issue_comments_296805.json:
```json
{
    "body": "Another potentially useful patch:\n\n```diff\ndiff --git a/src/language/eval.c b/src/language/eval.c\nindex 4dba513..c0f015f 100644\n--- a/src/language/eval.c\n+++ b/src/language/eval.c\n@@ -1590,7 +1590,14 @@ INLINE GEN\n closure_returnupto(GEN C)\n {\n   pari_sp av=avma;\n-  return copyupto(closure_return(C),(GEN)av);\n+  printf(\"\\navma = %p\\n\", (GEN)avma);\n+  GEN z = closure_return(C);\n+  printf(\"z = %p\\n\", z);\n+  printf(\"is_universal_constant(z) = %i\\n\", is_universal_constant(z));\n+  printf(\"gnil = %p\\n\", gnil);\n+  GEN c = copyupto(z, (GEN)av);\n+  printf(\"c = %p\\n\", z);\n+  return c;\n }\n \n GEN\n```",
    "created_at": "2016-10-04T11:48:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296805",
    "user": "https://github.com/jdemeyer"
}
```

Another potentially useful patch:

```diff
diff --git a/src/language/eval.c b/src/language/eval.c
index 4dba513..c0f015f 100644
--- a/src/language/eval.c
+++ b/src/language/eval.c
@@ -1590,7 +1590,14 @@ INLINE GEN
 closure_returnupto(GEN C)
 {
   pari_sp av=avma;
-  return copyupto(closure_return(C),(GEN)av);
+  printf("\navma = %p\n", (GEN)avma);
+  GEN z = closure_return(C);
+  printf("z = %p\n", z);
+  printf("is_universal_constant(z) = %i\n", is_universal_constant(z));
+  printf("gnil = %p\n", gnil);
+  GEN c = copyupto(z, (GEN)av);
+  printf("c = %p\n", z);
+  return c;
 }
 
 GEN
```



---

archive/issue_comments_296806.json:
```json
{
    "body": "Replying to [comment:7 embray]:\n> Ok, I'll try that.  Any idea why that patch?\n\n\nPARI's handling for closure return values has special code to deal with \"universal constants\". I'm suspecting a problem there.",
    "created_at": "2016-10-04T11:50:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296806",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:7 embray]:
> Ok, I'll try that.  Any idea why that patch?


PARI's handling for closure return values has special code to deal with "universal constants". I'm suspecting a problem there.



---

archive/issue_comments_296807.json:
```json
{
    "body": "Never mind the patch from [comment:6], that's not the problem.\n\nI found one place regarding constants which is undefined behaviour. To be sure that I am diagnosing the problem correctly, I need you to try this patch:\n\n```diff\ndiff --git a/src/language/eval.c b/src/language/eval.c\nindex 4dba513..c7c4c62 100644\n--- a/src/language/eval.c\n+++ b/src/language/eval.c\n@@ -1590,7 +1590,16 @@ INLINE GEN\n closure_returnupto(GEN C)\n {\n   pari_sp av=avma;\n-  return copyupto(closure_return(C),(GEN)av);\n+  printf(\"\\navma = %p\\n\", (GEN)avma);\n+  GEN z = closure_return(C);\n+  printf(\"z =     %p\\n\", z);\n+  printf(\"is_universal_constant(z) = %i\\n\", is_universal_constant(z));\n+  printf(\"gnil =  %p\\n\", gnil);\n+  printf(\"gen_0 = %p\\n\", gen_0);\n+  printf(\"ghalf = %p\\n\", ghalf);\n+  GEN c = copyupto(z, (GEN)av);\n+  printf(\"c =     %p\\n\", z);\n+  return c;\n }\n \n GEN\n```",
    "created_at": "2016-10-04T12:02:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296807",
    "user": "https://github.com/jdemeyer"
}
```

Never mind the patch from [comment:6], that's not the problem.

I found one place regarding constants which is undefined behaviour. To be sure that I am diagnosing the problem correctly, I need you to try this patch:

```diff
diff --git a/src/language/eval.c b/src/language/eval.c
index 4dba513..c7c4c62 100644
--- a/src/language/eval.c
+++ b/src/language/eval.c
@@ -1590,7 +1590,16 @@ INLINE GEN
 closure_returnupto(GEN C)
 {
   pari_sp av=avma;
-  return copyupto(closure_return(C),(GEN)av);
+  printf("\navma = %p\n", (GEN)avma);
+  GEN z = closure_return(C);
+  printf("z =     %p\n", z);
+  printf("is_universal_constant(z) = %i\n", is_universal_constant(z));
+  printf("gnil =  %p\n", gnil);
+  printf("gen_0 = %p\n", gen_0);
+  printf("ghalf = %p\n", ghalf);
+  GEN c = copyupto(z, (GEN)av);
+  printf("c =     %p\n", z);
+  return c;
 }
 
 GEN
```



---

archive/issue_comments_296808.json:
```json
{
    "body": "Once you applied the patch from [comment:10], I need you to try\n\n```\nsage: pari(\"x -> print(x);\")(\"hello\")\n```",
    "created_at": "2016-10-04T12:03:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296808",
    "user": "https://github.com/jdemeyer"
}
```

Once you applied the patch from [comment:10], I need you to try

```
sage: pari("x -> print(x);")("hello")
```



---

archive/issue_comments_296809.json:
```json
{
    "body": "Another thing to try (with or without the patches) in GP. You should get an error message here:\n\n```\n? install(gaffect, \"vGG\"); gaffect(0, print())\n  ***   at top-level: install(gaffect,\"vGG\");gaffect(0,print())\n  ***                                        ^------------------\n  *** gaffect: bug in gaffect [overwriting universal object: gnil)], please report.\n```",
    "created_at": "2016-10-04T12:07:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296809",
    "user": "https://github.com/jdemeyer"
}
```

Another thing to try (with or without the patches) in GP. You should get an error message here:

```
? install(gaffect, "vGG"); gaffect(0, print())
  ***   at top-level: install(gaffect,"vGG");gaffect(0,print())
  ***                                        ^------------------
  *** gaffect: bug in gaffect [overwriting universal object: gnil)], please report.
```



---

archive/issue_comments_296810.json:
```json
{
    "body": "Actually, it appears the patch in [comment:6] fixed it.  But I can try the other stuff if you think it needs a more general fix.",
    "created_at": "2016-10-04T13:02:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296810",
    "user": "https://github.com/embray"
}
```

Actually, it appears the patch in [comment:6] fixed it.  But I can try the other stuff if you think it needs a more general fix.



---

archive/issue_comments_296811.json:
```json
{
    "body": "Replying to [comment:13 embray]:\n> Actually, it appears the patch in [comment:6] fixed it.\n\n\nThat's impossible :-)\n\nI would be very interested in the debug output from the patch at [comment:10] with or without the other patch.",
    "created_at": "2016-10-04T13:07:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296811",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:13 embray]:
> Actually, it appears the patch in [comment:6] fixed it.


That's impossible :-)

I would be very interested in the debug output from the patch at [comment:10] with or without the other patch.



---

archive/issue_comments_296812.json:
```json
{
    "body": "Perhaps there is some non-determinism in the build? Maybe every time you build PARI, you have a certain chance of a broken build. That might explain these two things:\n\n> I didn't have this bug a few weeks ago, and it's strange that I'm only seeing it on Cygwin.\n\n\n> Actually, it appears the patch in [comment:6] fixed it.",
    "created_at": "2016-10-04T13:10:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296812",
    "user": "https://github.com/jdemeyer"
}
```

Perhaps there is some non-determinism in the build? Maybe every time you build PARI, you have a certain chance of a broken build. That might explain these two things:

> I didn't have this bug a few weeks ago, and it's strange that I'm only seeing it on Cygwin.


> Actually, it appears the patch in [comment:6] fixed it.



---

archive/issue_comments_296813.json:
```json
{
    "body": "FWIW Here's the output with the patch from [comment:10]\n\n```\nsage: pari(\"x -> print(x);\")(\"hello\")\n\navma = 0x6fff79c0000\nhello\nz =     0x2e01690\nis_universal_constant(z) = 1\ngnil =  0x2e01690\ngen_0 = 0x2e01680\nghalf = 0x2e01700\nc =     0x2e01690\n```\n\nbut yeah, the other patch really did fix it.  The only other possibility is that I built with SAGE_DEBUG=yes while previously I did not.  If somehow *SAGE_DEBUG* turned out to be the difference I'll eat my socks :)",
    "created_at": "2016-10-04T13:17:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296813",
    "user": "https://github.com/embray"
}
```

FWIW Here's the output with the patch from [comment:10]

```
sage: pari("x -> print(x);")("hello")

avma = 0x6fff79c0000
hello
z =     0x2e01690
is_universal_constant(z) = 1
gnil =  0x2e01690
gen_0 = 0x2e01680
ghalf = 0x2e01700
c =     0x2e01690
```

but yeah, the other patch really did fix it.  The only other possibility is that I built with SAGE_DEBUG=yes while previously I did not.  If somehow *SAGE_DEBUG* turned out to be the difference I'll eat my socks :)



---

archive/issue_comments_296814.json:
```json
{
    "body": "Though I guess `is_universal_constant(gen_0)` ought to return `1` if I'm reading the docs correctly, so I guess that patch is the wrong thing to do?",
    "created_at": "2016-10-04T13:26:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296814",
    "user": "https://github.com/embray"
}
```

Though I guess `is_universal_constant(gen_0)` ought to return `1` if I'm reading the docs correctly, so I guess that patch is the wrong thing to do?



---

archive/issue_comments_296815.json:
```json
{
    "body": "Replying to [comment:16 embray]:\n> but yeah, the other patch really did fix it.\n\n\nJust to double-check, can you remove that patch and check again (with the debugging info from [comment:10])",
    "created_at": "2016-10-04T13:26:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296815",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:16 embray]:
> but yeah, the other patch really did fix it.


Just to double-check, can you remove that patch and check again (with the debugging info from [comment:10])



---

archive/issue_comments_296816.json:
```json
{
    "body": "Replying to [comment:17 embray]:\n> Though I guess `is_universal_constant(gen_0)` ought to return `1` if I'm reading the docs correctly, so I guess that patch is the wrong thing to do?  \n\n\nYes, the patch is wrong and it shouldn't fix the problem.",
    "created_at": "2016-10-04T13:27:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296816",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:17 embray]:
> Though I guess `is_universal_constant(gen_0)` ought to return `1` if I'm reading the docs correctly, so I guess that patch is the wrong thing to do?  


Yes, the patch is wrong and it shouldn't fix the problem.



---

archive/issue_comments_296817.json:
```json
{
    "body": "Replying to [comment:18 jdemeyer]:\n> Replying to [comment:16 embray]:\n> > but yeah, the other patch really did fix it.\n\n> \n> Just to double-check, can you remove that patch and check again (with the debugging info from [comment:10])\n\n\nYeah, I'm doing that right now.  Wanted to make sure not to drive either of us crazy.",
    "created_at": "2016-10-04T13:32:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296817",
    "user": "https://github.com/embray"
}
```

Replying to [comment:18 jdemeyer]:
> Replying to [comment:16 embray]:
> > but yeah, the other patch really did fix it.

> 
> Just to double-check, can you remove that patch and check again (with the debugging info from [comment:10])


Yeah, I'm doing that right now.  Wanted to make sure not to drive either of us crazy.



---

archive/issue_comments_296818.json:
```json
{
    "body": "Well the good news is, you were right that the little patch to `is_universal_constant` seems to have been irrelevant.  The bad news is that I tried rebuilding with `SAGE_DEBUG=no` again and it broke again.  The worse news is I like to try to keep my word (warning: gross picture) https://goo.gl/photos/oNiF1i6gLEfequY3A\n\nThe output I get is\n\n```\navma = 0x6fff77c0000\n[1, 0; 0, 1]\nz =     0x2e86890\nis_universal_constant(z) = 0\ngnil =  0x2e86890\ngen_0 = 0x2e86880\nghalf = 0x2e86850\nc =     0x2e86890\n0\n```\n\nFor some reason with optimizations enabled `ghalf` winds up below `gen_0`.",
    "created_at": "2016-10-04T13:52:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296818",
    "user": "https://github.com/embray"
}
```

Well the good news is, you were right that the little patch to `is_universal_constant` seems to have been irrelevant.  The bad news is that I tried rebuilding with `SAGE_DEBUG=no` again and it broke again.  The worse news is I like to try to keep my word (warning: gross picture) https://goo.gl/photos/oNiF1i6gLEfequY3A

The output I get is

```
avma = 0x6fff77c0000
[1, 0; 0, 1]
z =     0x2e86890
is_universal_constant(z) = 0
gnil =  0x2e86890
gen_0 = 0x2e86880
ghalf = 0x2e86850
c =     0x2e86890
0
```

For some reason with optimizations enabled `ghalf` winds up below `gen_0`.



---

archive/issue_comments_296819.json:
```json
{
    "body": "By the way, it's really annoying that this logic assumes anything about the memory layout for static constants defined in C.  There's no reason it should think it can make any such assumptions.",
    "created_at": "2016-10-04T13:58:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296819",
    "user": "https://github.com/embray"
}
```

By the way, it's really annoying that this logic assumes anything about the memory layout for static constants defined in C.  There's no reason it should think it can make any such assumptions.



---

archive/issue_comments_296820.json:
```json
{
    "body": "Replying to [comment:22 embray]:\n> By the way, it's really annoying that this logic assumes anything about the memory layout for static constants defined in C.\n\n\nOf course, that is obviously a bug and I'm pretty sure that the PARI devs will accept that. At this point, we have enough information to report the issue upstream.",
    "created_at": "2016-10-04T14:03:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296820",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:22 embray]:
> By the way, it's really annoying that this logic assumes anything about the memory layout for static constants defined in C.


Of course, that is obviously a bug and I'm pretty sure that the PARI devs will accept that. At this point, we have enough information to report the issue upstream.



---

archive/issue_comments_296821.json:
```json
{
    "body": "I will report it upstream.",
    "created_at": "2016-10-04T14:03:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296821",
    "user": "https://github.com/jdemeyer"
}
```

I will report it upstream.



---

archive/issue_comments_296822.json:
```json
{
    "body": "I've realized I should never make logical assumptions.",
    "created_at": "2016-10-04T14:12:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296822",
    "user": "https://github.com/embray"
}
```

I've realized I should never make logical assumptions.



---

archive/issue_comments_296823.json:
```json
{
    "body": "Changing component from porting: Cygwin to packages: standard.",
    "created_at": "2016-10-04T14:56:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296823",
    "user": "https://github.com/jdemeyer"
}
```

Changing component from porting: Cygwin to packages: standard.



---

archive/issue_comments_296824.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-10-04T15:23:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296824",
    "user": "https://github.com/jdemeyer"
}
```

New commits:



---

archive/issue_comments_296825.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-10-04T15:23:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296825",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_296826.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-10-04T20:29:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296826",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_296827.json:
```json
{
    "body": "This is the patch merged in the upstream git repo: http://pari.math.u-bordeaux.fr/cgi-bin/gitweb.cgi?p=pari.git;a=commitdiff;h=e2ce19f (I removed the patch to `CHANGES` to avoid conflicts)",
    "created_at": "2016-10-04T20:31:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296827",
    "user": "https://github.com/jdemeyer"
}
```

This is the patch merged in the upstream git repo: http://pari.math.u-bordeaux.fr/cgi-bin/gitweb.cgi?p=pari.git;a=commitdiff;h=e2ce19f (I removed the patch to `CHANGES` to avoid conflicts)



---

archive/issue_comments_296828.json:
```json
{
    "body": "Great.  Looking at the patch I can see now why maybe they did things they way they did originally, but this looks much better.\n\nI need to fire up a new non-debug build in order to test this but I think this will fix it.",
    "created_at": "2016-10-05T10:15:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296828",
    "user": "https://github.com/embray"
}
```

Great.  Looking at the patch I can see now why maybe they did things they way they did originally, but this looks much better.

I need to fire up a new non-debug build in order to test this but I think this will fix it.



---

archive/issue_comments_296829.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-10-11T13:35:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296829",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_296830.json:
```json
{
    "body": "Meant to update on this sooner.  I can confirm that the new patch fixes the issue as well.",
    "created_at": "2016-10-11T13:35:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296830",
    "user": "https://github.com/embray"
}
```

Meant to update on this sooner.  I can confirm that the new patch fixes the issue as well.



---

archive/issue_comments_296831.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2016-10-11T14:59:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296831",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_296832.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2016-10-11T14:59:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296832",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_296833.json:
```json
{
    "body": "Bumping the PARI version (there was another PARI ticket merged in rc0).",
    "created_at": "2016-10-11T15:00:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296833",
    "user": "https://github.com/jdemeyer"
}
```

Bumping the PARI version (there was another PARI ticket merged in rc0).



---

archive/issue_comments_296834.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-10-11T15:00:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296834",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_296835.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-10-21T07:03:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296835",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_057381.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-10-21T07:03:44Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21400#event-57381"
}
```



---

archive/issue_comments_296836.json:
```json
{
    "body": "log of compilation of 7.5beta0 WITHOUT #20523 (okay)",
    "created_at": "2016-10-23T16:47:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296836",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

log of compilation of 7.5beta0 WITHOUT #20523 (okay)



---

archive/issue_comments_296837.json:
```json
{
    "body": "Attachment [pari-2.8.0.alpha.p2.log](tarball://root/attachments/some-uuid/ticket21637/pari-2.8.0.alpha.p2.log) by @EmmanuelCharpentier created at 2016-10-23 16:48:47\n\nLog of compilation of 7.5beta0 WITH #20523 (problematic)",
    "created_at": "2016-10-23T16:48:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296837",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Attachment [pari-2.8.0.alpha.p2.log](tarball://root/attachments/some-uuid/ticket21637/pari-2.8.0.alpha.p2.log) by @EmmanuelCharpentier created at 2016-10-23 16:48:47

Log of compilation of 7.5beta0 WITH #20523 (problematic)



---

archive/issue_comments_296838.json:
```json
{
    "body": "Attachment [pari-2.8-2771-gb70b447.p0.log](tarball://root/attachments/some-uuid/ticket21637/pari-2.8-2771-gb70b447.p0.log) by @EmmanuelCharpentier created at 2016-10-23 16:56:37\n\nI have trouble compiling 7.5beta0 with #20523 (R 3.1.1, *a priori* unrelated), and this patch is the prime suspect.\n\nI'll annotate #20523 (reminder...).",
    "created_at": "2016-10-23T16:56:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296838",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Attachment [pari-2.8-2771-gb70b447.p0.log](tarball://root/attachments/some-uuid/ticket21637/pari-2.8-2771-gb70b447.p0.log) by @EmmanuelCharpentier created at 2016-10-23 16:56:37

I have trouble compiling 7.5beta0 with #20523 (R 3.1.1, *a priori* unrelated), and this patch is the prime suspect.

I'll annotate #20523 (reminder...).



---

archive/issue_comments_296839.json:
```json
{
    "body": "`pari-2.8-2771-gb70b447` is an old version. Please delete that log file such that you are no longer confused by it.\n\n`pari-2.8.0.alpha.p2` is the current version which built correctly. So I see no problem here.",
    "created_at": "2016-10-23T18:26:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296839",
    "user": "https://github.com/jdemeyer"
}
```

`pari-2.8-2771-gb70b447` is an old version. Please delete that log file such that you are no longer confused by it.

`pari-2.8.0.alpha.p2` is the current version which built correctly. So I see no problem here.



---

archive/issue_comments_296840.json:
```json
{
    "body": "Replying to [comment:41 jdemeyer]:\n> `pari-2.8-2771-gb70b447` is an old version. Please delete that log file such that you are no longer confused by it.\n\n\nI have already tried that : The damn thing sprouts back (and the error is the same...).\n\n> `pari-2.8.0.alpha.p2` is the current version which built correctly. So I see no problem here.\n\n\nI see it : I've spent a large part of Sunday trying to get 7.5beta0+#20523 to compile, to no avail... the problem comes back even after a `make distclean`.\n\n\nCurrently I'm compiling 7.4+#20523+#a preliminary version of 21744 (not yet pushed), which seems to have passed the critical point. However, each passage from 7.4 to 7.5.beta0 needs >1h to compile (something seems to have radically changed, and I don't see what...).\n\nI'll keep you posted after a `ptestlong` of this 7.4 patched version.\n\n[EDIT] According to [Volker's announcement](https://groups.google.com/forum/#!topic/sage-release/RxGpeK0kMsc), the present patch (#21637) has been added between 7.4 and 7.5beta0... To me, it's newer than 2.8.0.alpha.p2 (which I seem to remember to have seen late 7.4 betas...). Hasn't it been merged in error ? On my workin sage installation(7.4) :\n\n```\ncharpent@asus16-ec:/usr/local/sage-7$ sage -standard\n[package]...............................[latest version] ([version])\n....\npari....................................2.8.0.alpha.p1 (2.8.0.alpha.p1)\n...}}}",
    "created_at": "2016-10-23T19:37:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296840",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Replying to [comment:41 jdemeyer]:
> `pari-2.8-2771-gb70b447` is an old version. Please delete that log file such that you are no longer confused by it.


I have already tried that : The damn thing sprouts back (and the error is the same...).

> `pari-2.8.0.alpha.p2` is the current version which built correctly. So I see no problem here.


I see it : I've spent a large part of Sunday trying to get 7.5beta0+#20523 to compile, to no avail... the problem comes back even after a `make distclean`.


Currently I'm compiling 7.4+#20523+#a preliminary version of 21744 (not yet pushed), which seems to have passed the critical point. However, each passage from 7.4 to 7.5.beta0 needs >1h to compile (something seems to have radically changed, and I don't see what...).

I'll keep you posted after a `ptestlong` of this 7.4 patched version.

[EDIT] According to [Volker's announcement](https://groups.google.com/forum/#!topic/sage-release/RxGpeK0kMsc), the present patch (#21637) has been added between 7.4 and 7.5beta0... To me, it's newer than 2.8.0.alpha.p2 (which I seem to remember to have seen late 7.4 betas...). Hasn't it been merged in error ? On my workin sage installation(7.4) :

```
charpent@asus16-ec:/usr/local/sage-7$ sage -standard
[package]...............................[latest version] ([version])
....
pari....................................2.8.0.alpha.p1 (2.8.0.alpha.p1)
...}}}



---

archive/issue_comments_296841.json:
```json
{
    "body": "Replying to [comment:42 charpent]:\n> Replying to [comment:41 jdemeyer]:\n> > `pari-2.8-2771-gb70b447` is an old version. Please delete that log file such that you are no longer confused by it.\n\n> \n> I have already tried that : The damn thing sprouts back (and the error is the same...).\n\n\nIn that case, you are either using an old version of Sage (if so: merge current `develop`) or there is something wrong with your branch (which git branch is that?).",
    "created_at": "2016-10-23T19:44:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296841",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:42 charpent]:
> Replying to [comment:41 jdemeyer]:
> > `pari-2.8-2771-gb70b447` is an old version. Please delete that log file such that you are no longer confused by it.

> 
> I have already tried that : The damn thing sprouts back (and the error is the same...).


In that case, you are either using an old version of Sage (if so: merge current `develop`) or there is something wrong with your branch (which git branch is that?).



---

archive/issue_comments_296842.json:
```json
{
    "body": "Replying to [comment:43 jdemeyer]:\n> Replying to [comment:42 charpent]:\n> > Replying to [comment:41 jdemeyer]:\n> > > `pari-2.8-2771-gb70b447` is an old version. Please delete that log file such that you are no longer confused by it.\n\n> > \n> > I have already tried that : The damn thing sprouts back (and the error is the same...).\n\n> \n> In that case, you are either using an old version of Sage (if so: merge current `develop`) or there is something wrong with your branch (which git branch is that?).\n\n\n`develop`##20523+#21744 (and, yes, I did `git fetch` and `git pull` before that.\n\nMaybe I should try a fresh tree ?",
    "created_at": "2016-10-23T19:52:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296842",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Replying to [comment:43 jdemeyer]:
> Replying to [comment:42 charpent]:
> > Replying to [comment:41 jdemeyer]:
> > > `pari-2.8-2771-gb70b447` is an old version. Please delete that log file such that you are no longer confused by it.

> > 
> > I have already tried that : The damn thing sprouts back (and the error is the same...).

> 
> In that case, you are either using an old version of Sage (if so: merge current `develop`) or there is something wrong with your branch (which git branch is that?).


`develop`##20523+#21744 (and, yes, I did `git fetch` and `git pull` before that.

Maybe I should try a fresh tree ?



---

archive/issue_comments_296843.json:
```json
{
    "body": "Replying to [comment:42 charpent], because my edit didn't went through the mail...\n\n[EDIT] According to \u200bVolker's announcement, the present patch (#21637) has been added between 7.4 and 7.5beta0... To me, it's newer than 2.8.0.alpha.p2 (which I seem to remember to have seen late 7.4 betas...). Hasn't it been merged in error ? On my workin sage installation(7.4) :\n\n`charpent`@`asus16-ec:/usr/local/sage-7$ sage -standard [package]...............................[latest version] ([version]) .... pari....................................2.8.0.alpha.p1 (2.8.0.alpha.p1) ...`",
    "created_at": "2016-10-23T20:04:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296843",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Replying to [comment:42 charpent], because my edit didn't went through the mail...

[EDIT] According to â€‹Volker's announcement, the present patch (#21637) has been added between 7.4 and 7.5beta0... To me, it's newer than 2.8.0.alpha.p2 (which I seem to remember to have seen late 7.4 betas...). Hasn't it been merged in error ? On my workin sage installation(7.4) :

`charpent`@`asus16-ec:/usr/local/sage-7$ sage -standard [package]...............................[latest version] ([version]) .... pari....................................2.8.0.alpha.p1 (2.8.0.alpha.p1) ...`



---

archive/issue_comments_296844.json:
```json
{
    "body": "Replying to [comment:44 charpent]:\n> `develop`##20523+#21744\n\n\nDouble-check that your `develop` branch is really what you think it is (should be `7.5.beta0`). If it is, you somehow messed up the merging of `develop` with those 2 branches.",
    "created_at": "2016-10-23T20:09:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296844",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:44 charpent]:
> `develop`##20523+#21744


Double-check that your `develop` branch is really what you think it is (should be `7.5.beta0`). If it is, you somehow messed up the merging of `develop` with those 2 branches.



---

archive/issue_comments_296845.json:
```json
{
    "body": "Starting from a fresh tree, I managed to build and ptestlong successfully (modulo the usual transient error on `simplicial_complex.py`) #20523+#21744 over both 7.4 and 7.5beta0.\n\nI still do not understand how I managed to mess up my previous attempts.",
    "created_at": "2016-10-24T07:33:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21400#issuecomment-296845",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Starting from a fresh tree, I managed to build and ptestlong successfully (modulo the usual transient error on `simplicial_complex.py`) #20523+#21744 over both 7.4 and 7.5beta0.

I still do not understand how I managed to mess up my previous attempts.
