# Issue 21400: Bug with PARI interface gen.eval on Cygwin

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2016-10-04 09:12:29

Keywords: pari windows cygwin

It seems that `gen.eval()` is returning `pari('0')` in cases where it should be returning `None`.  The relevant code is


```cython
        if t == t_CLOSURE:
            if nkwds > 0:
                raise TypeError("cannot evaluate a PARI closure using keyword arguments")
            if closure_is_variadic(self.g):
                arity = closure_arity(self.g) - 1
                args = list(args[:arity]) + [0]*(arity-nargs) + [args[arity:]]
            t0 = objtogen(args)
            sig_on()
            result = closure_callgenvec(self.g, t0.g)
            if result == gnil:
                P.clear_stack()
                return None
            return P.new_gen(result)
```


So it seems like `result != gnil` when it is expected to be.  For example this test from the doctests is failing:


```
sage: def printme(x):
....:     print(x)
....:
sage: objtoclosure(printme)('matid(2)')
[1, 0; 0, 1]
0
```


The final `0` is the return value from calling the closure.  It should return `None`.  This is especially odd because the logic in `objtoclosure` is that if the called Python function returns `None` the PARI function should return `gnil`.

I didn't have this bug a few weeks ago, and it's strange that I'm only seeing it on Cygwin.


---

Comment by jdemeyer created at 2016-10-04 10:03:22

Just FYI: the PARI value `gnil` is like Python's `None`. But it is really just a pointer to a "special" `0`. It is indistinguishable from any other `0` except by comparing pointers.


---

Comment by jdemeyer created at 2016-10-04 10:06:34

Can you test this:

```
sage: pari("x -> print(x);")("hello")
hello
```



---

Comment by embray created at 2016-10-04 10:56:06

That test fails too in the same way.


---

Comment by embray created at 2016-10-04 10:57:00

Replying to [comment:1 jdemeyer]:
> Just FYI: the PARI value `gnil` is like Python's `None`. But it is really just a pointer to a "special" `0`. It is indistinguishable from any other `0` except by comparing pointers.

I see--that helps explain it.  Maybe there's something odd going on with pointer comparison.


---

Comment by jdemeyer created at 2016-10-04 11:28:11

OK, next thing is to try GP itself:

```
$ ./sage --gp
```

and then

```
? (x -> print(x))("hello")
hello
```



---

Comment by jdemeyer created at 2016-10-04 11:35:56

Could you try this patch to PARI:

```diff
diff --git a/src/headers/pariinl.h b/src/headers/pariinl.h
index 2567d55..e37b435 100644
--- a/src/headers/pariinl.h
+++ b/src/headers/pariinl.h
`@``@` -1272,7 +1272,7 `@``@` INLINE void
 killblock(GEN x) { gunclone(x); }
 
 INLINE int
-is_universal_constant(GEN x) { return (x >= gen_0 && x <= ghalf); }
+is_universal_constant(GEN x) { return (x >= gnil && x <= ghalf); }
 
 /*******************************************************************/
 /*                                                                 */
```


Just copy this to some file inside `build/pkgs/patches/`, rebuild PARI (`./sage -f pari`) and test again.


---

Comment by embray created at 2016-10-04 11:40:27

Ok, I'll try that.  Any idea why that patch?


---

Comment by jdemeyer created at 2016-10-04 11:48:04

Another potentially useful patch:

```diff
diff --git a/src/language/eval.c b/src/language/eval.c
index 4dba513..c0f015f 100644
--- a/src/language/eval.c
+++ b/src/language/eval.c
`@``@` -1590,7 +1590,14 `@``@` INLINE GEN
 closure_returnupto(GEN C)
 {
   pari_sp av=avma;
-  return copyupto(closure_return(C),(GEN)av);
+  printf("\navma = %p\n", (GEN)avma);
+  GEN z = closure_return(C);
+  printf("z = %p\n", z);
+  printf("is_universal_constant(z) = %i\n", is_universal_constant(z));
+  printf("gnil = %p\n", gnil);
+  GEN c = copyupto(z, (GEN)av);
+  printf("c = %p\n", z);
+  return c;
 }
 
 GEN
```



---

Comment by jdemeyer created at 2016-10-04 11:50:20

Replying to [comment:7 embray]:
> Ok, I'll try that.  Any idea why that patch?

PARI's handling for closure return values has special code to deal with "universal constants". I'm suspecting a problem there.


---

Comment by jdemeyer created at 2016-10-04 12:02:21

Never mind the patch from [comment:6], that's not the problem.

I found one place regarding constants which is undefined behaviour. To be sure that I am diagnosing the problem correctly, I need you to try this patch:

```diff
diff --git a/src/language/eval.c b/src/language/eval.c
index 4dba513..c7c4c62 100644
--- a/src/language/eval.c
+++ b/src/language/eval.c
`@``@` -1590,7 +1590,16 `@``@` INLINE GEN
 closure_returnupto(GEN C)
 {
   pari_sp av=avma;
-  return copyupto(closure_return(C),(GEN)av);
+  printf("\navma = %p\n", (GEN)avma);
+  GEN z = closure_return(C);
+  printf("z =     %p\n", z);
+  printf("is_universal_constant(z) = %i\n", is_universal_constant(z));
+  printf("gnil =  %p\n", gnil);
+  printf("gen_0 = %p\n", gen_0);
+  printf("ghalf = %p\n", ghalf);
+  GEN c = copyupto(z, (GEN)av);
+  printf("c =     %p\n", z);
+  return c;
 }
 
 GEN
```



---

Comment by jdemeyer created at 2016-10-04 12:03:30

Once you applied the patch from [comment:10], I need you to try

```
sage: pari("x -> print(x);")("hello")
```



---

Comment by jdemeyer created at 2016-10-04 12:07:17

Another thing to try (with or without the patches) in GP. You should get an error message here:

```
? install(gaffect, "vGG"); gaffect(0, print())
  ***   at top-level: install(gaffect,"vGG");gaffect(0,print())
  ***                                        ^------------------
  *** gaffect: bug in gaffect [overwriting universal object: gnil)], please report.
```



---

Comment by embray created at 2016-10-04 13:02:43

Actually, it appears the patch in [comment:6] fixed it.  But I can try the other stuff if you think it needs a more general fix.


---

Comment by jdemeyer created at 2016-10-04 13:07:50

Replying to [comment:13 embray]:
> Actually, it appears the patch in [comment:6] fixed it.

That's impossible :-)

I would be very interested in the debug output from the patch at [comment:10] with or without the other patch.


---

Comment by jdemeyer created at 2016-10-04 13:10:05

Perhaps there is some non-determinism in the build? Maybe every time you build PARI, you have a certain chance of a broken build. That might explain these two things:

> I didn't have this bug a few weeks ago, and it's strange that I'm only seeing it on Cygwin.

> Actually, it appears the patch in [comment:6] fixed it.


---

Comment by embray created at 2016-10-04 13:17:05

FWIW Here's the output with the patch from [comment:10]


```
sage: pari("x -> print(x);")("hello")

avma = 0x6fff79c0000
hello
z =     0x2e01690
is_universal_constant(z) = 1
gnil =  0x2e01690
gen_0 = 0x2e01680
ghalf = 0x2e01700
c =     0x2e01690
```


but yeah, the other patch really did fix it.  The only other possibility is that I built with SAGE_DEBUG=yes while previously I did not.  If somehow _SAGE_DEBUG_ turned out to be the difference I'll eat my socks :)


---

Comment by embray created at 2016-10-04 13:26:04

Though I guess `is_universal_constant(gen_0)` ought to return `1` if I'm reading the docs correctly, so I guess that patch is the wrong thing to do?


---

Comment by jdemeyer created at 2016-10-04 13:26:54

Replying to [comment:16 embray]:
> but yeah, the other patch really did fix it.

Just to double-check, can you remove that patch and check again (with the debugging info from [comment:10])


---

Comment by jdemeyer created at 2016-10-04 13:27:31

Replying to [comment:17 embray]:
> Though I guess `is_universal_constant(gen_0)` ought to return `1` if I'm reading the docs correctly, so I guess that patch is the wrong thing to do?  

Yes, the patch is wrong and it shouldn't fix the problem.


---

Comment by embray created at 2016-10-04 13:32:50

Replying to [comment:18 jdemeyer]:
> Replying to [comment:16 embray]:
> > but yeah, the other patch really did fix it.
> 
> Just to double-check, can you remove that patch and check again (with the debugging info from [comment:10])

Yeah, I'm doing that right now.  Wanted to make sure not to drive either of us crazy.


---

Comment by embray created at 2016-10-04 13:52:59

Well the good news is, you were right that the little patch to `is_universal_constant` seems to have been irrelevant.  The bad news is that I tried rebuilding with `SAGE_DEBUG=no` again and it broke again.  The worse news is I like to try to keep my word (warning: gross picture) https://goo.gl/photos/oNiF1i6gLEfequY3A

The output I get is

```
avma = 0x6fff77c0000
[1, 0; 0, 1]
z =     0x2e86890
is_universal_constant(z) = 0
gnil =  0x2e86890
gen_0 = 0x2e86880
ghalf = 0x2e86850
c =     0x2e86890
0
```


For some reason with optimizations enabled `ghalf` winds up below `gen_0`.


---

Comment by embray created at 2016-10-04 13:58:22

By the way, it's really annoying that this logic assumes anything about the memory layout for static constants defined in C.  There's no reason it should think it can make any such assumptions.


---

Comment by jdemeyer created at 2016-10-04 14:03:08

Replying to [comment:22 embray]:
> By the way, it's really annoying that this logic assumes anything about the memory layout for static constants defined in C.

Of course, that is obviously a bug and I'm pretty sure that the PARI devs will accept that. At this point, we have enough information to report the issue upstream.


---

Comment by jdemeyer created at 2016-10-04 14:03:22

I will report it upstream.


---

Comment by embray created at 2016-10-04 14:12:59

I've realized I should never make logical assumptions.


---

Comment by jdemeyer created at 2016-10-04 14:56:11

Changing component from porting: Cygwin to packages: standard.


---

Comment by jdemeyer created at 2016-10-04 15:23:18

New commits:


---

Comment by jdemeyer created at 2016-10-04 15:23:18

Changing status from new to needs_review.


---

Comment by git created at 2016-10-04 20:29:16

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2016-10-04 20:31:36

This is the patch merged in the upstream git repo: http://pari.math.u-bordeaux.fr/cgi-bin/gitweb.cgi?p=pari.git;a=commitdiff;h=e2ce19f (I removed the patch to `CHANGES` to avoid conflicts)


---

Comment by embray created at 2016-10-05 10:15:30

Great.  Looking at the patch I can see now why maybe they did things they way they did originally, but this looks much better.

I need to fire up a new non-debug build in order to test this but I think this will fix it.


---

Comment by embray created at 2016-10-11 13:35:29

Changing status from needs_review to positive_review.


---

Comment by embray created at 2016-10-11 13:35:29

Meant to update on this sooner.  I can confirm that the new patch fixes the issue as well.


---

Comment by git created at 2016-10-11 14:59:31

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2016-10-11 14:59:31

Changing status from positive_review to needs_review.


---

Comment by jdemeyer created at 2016-10-11 15:00:13

Bumping the PARI version (there was another PARI ticket merged in rc0).


---

Comment by jdemeyer created at 2016-10-11 15:00:20

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-10-21 07:03:44

Resolution: fixed


---

Comment by charpent created at 2016-10-23 16:47:21

log of compilation of 7.5beta0 WITHOUT #20523 (okay)


---

Attachment

Log of compilation of 7.5beta0 WITH #20523 (problematic)


---

Attachment

I have trouble compiling 7.5beta0 with #20523 (R 3.1.1, _a priori_ unrelated), and this patch is the prime suspect.

I'll annotate #20523 (reminder...).


---

Comment by jdemeyer created at 2016-10-23 18:26:49

`pari-2.8-2771-gb70b447` is an old version. Please delete that log file such that you are no longer confused by it.

`pari-2.8.0.alpha.p2` is the current version which built correctly. So I see no problem here.


---

Comment by charpent created at 2016-10-23 19:37:24

Replying to [comment:41 jdemeyer]:
> `pari-2.8-2771-gb70b447` is an old version. Please delete that log file such that you are no longer confused by it.

I have already tried that : The damn thing sprouts back (and the error is the same...).

> `pari-2.8.0.alpha.p2` is the current version which built correctly. So I see no problem here.

I see it : I've spent a large part of Sunday trying to get 7.5beta0+#20523 to compile, to no avail... the problem comes back even after a `make distclean`.


Currently I'm compiling 7.4+#20523+#a preliminary version of 21744 (not yet pushed), which seems to have passed the critical point. However, each passage from 7.4 to 7.5.beta0 needs >1h to compile (something seems to have radically changed, and I don't see what...).

I'll keep you posted after a `ptestlong` of this 7.4 patched version.

[EDIT] According to [Volker's announcement](https://groups.google.com/forum/#!topic/sage-release/RxGpeK0kMsc), the present patch (#21637) has been added between 7.4 and 7.5beta0... To me, it's newer than 2.8.0.alpha.p2 (which I seem to remember to have seen late 7.4 betas...). Hasn't it been merged in error ? On my workin sage installation(7.4) :

{{{charpent`@`asus16-ec:/usr/local/sage-7$ sage -standard
[package]...............................[latest version] ([version])
....
pari....................................2.8.0.alpha.p1 (2.8.0.alpha.p1)
...}}}


---

Comment by jdemeyer created at 2016-10-23 19:44:02

Replying to [comment:42 charpent]:
> Replying to [comment:41 jdemeyer]:
> > `pari-2.8-2771-gb70b447` is an old version. Please delete that log file such that you are no longer confused by it.
> 
> I have already tried that : The damn thing sprouts back (and the error is the same...).

In that case, you are either using an old version of Sage (if so: merge current `develop`) or there is something wrong with your branch (which git branch is that?).


---

Comment by charpent created at 2016-10-23 19:52:19

Replying to [comment:43 jdemeyer]:
> Replying to [comment:42 charpent]:
> > Replying to [comment:41 jdemeyer]:
> > > `pari-2.8-2771-gb70b447` is an old version. Please delete that log file such that you are no longer confused by it.
> > 
> > I have already tried that : The damn thing sprouts back (and the error is the same...).
> 
> In that case, you are either using an old version of Sage (if so: merge current `develop`) or there is something wrong with your branch (which git branch is that?).

`develop`##20523+#21744 (and, yes, I did `git fetch` and `git pull` before that.

Maybe I should try a fresh tree ?


---

Comment by charpent created at 2016-10-23 20:04:21

Replying to [comment:42 charpent], because my edit didn't went through the mail...

[EDIT] According to ​Volker's announcement, the present patch (#21637) has been added between 7.4 and 7.5beta0... To me, it's newer than 2.8.0.alpha.p2 (which I seem to remember to have seen late 7.4 betas...). Hasn't it been merged in error ? On my workin sage installation(7.4) :

`charpent`@`asus16-ec:/usr/local/sage-7$ sage -standard [package]...............................[latest version] ([version]) .... pari....................................2.8.0.alpha.p1 (2.8.0.alpha.p1) ...`


---

Comment by jdemeyer created at 2016-10-23 20:09:11

Replying to [comment:44 charpent]:
> `develop`##20523+#21744

Double-check that your `develop` branch is really what you think it is (should be `7.5.beta0`). If it is, you somehow messed up the merging of `develop` with those 2 branches.


---

Comment by charpent created at 2016-10-24 07:33:46

Starting from a fresh tree, I managed to build and ptestlong successfully (modulo the usual transient error on `simplicial_complex.py`) #20523+#21744 over both 7.4 and 7.5beta0.

I still do not understand how I managed to mess up my previous attempts.
