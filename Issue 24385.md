# Issue 24385: Pseudo-Riemannian manifods

Issue created by migration from https://trac.sagemath.org/ticket/24622

Original creator: egourgoulhon

Original creation time: 2018-01-31 09:56:13

CC:  tscrim

Keywords: pseudo-Riemannian, Riemannian, manifold, gradient, divergence, Laplacian

This ticket implements pseudo-Riemannian manifolds, i.e. real differentiable manifolds equipped with a metric tensor. Important subcases are of course Riemannian manifolds and Lorentzian manifolds. Taking into account that generic metric tensors are already implemented in Sage (see [here](http://doc.sagemath.org/html/en/reference/manifolds/sage/manifolds/differentiable/metric.html)), this ticket introduces

- the parent class `PseudoRiemannianManifold`, as a subclass of the existing class `DifferentiableManifold`
- new methods `gradient` and `laplacian` for scalar fields
- new methods `divergence`, `laplacian` for tensor fields 
- new methods `curl`, `dot_product`, `cross_product` and `norm` for vector fields

For a greater generality, all these methods have an optional argument `metric`; if it is omitted, the metric of the underlying pseudo-Riemannian manifold is assumed.


---

Comment by egourgoulhon created at 2018-01-31 09:58:01

This is work in progress...
----
New commits:


---

Comment by git created at 2018-01-31 16:56:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-01-31 22:42:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-02-02 17:37:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-02-06 15:59:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-02-07 18:00:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-02-08 21:58:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-02-09 17:48:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-02-11 16:47:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2018-02-11 17:06:53

Changing status from new to needs_review.


---

Comment by tscrim created at 2018-02-28 10:05:49

The biggest issue I have with this ticket is the addition of functions to the global namespace. `curl`, `laplacian`, and `dalembertian` I think are okay. `grad` over `gradient` I am not sure about. `div` looks too much like it is coming from "divide" or "division". I think you should ask on sage-devel to see if anyone has any objections with adding these to the global namespace and about them being a simple re-direct. (Ralf may want to have them interact with the symbolics in some way.)

In the same vein, this is bad to me:

```python
        # Import differential operators in the user global namespace:
        if 'grad' not in get_globals():
            from sage.manifolds.differentiable.operators import (grad, div,
                                                 curl, laplacian, dalembertian)
            set_global('grad', grad)
            set_global('div', div)
            set_global('curl', curl)
            set_global('rot', curl)
            set_global('laplacian', laplacian)
            set_global('dalembertian', dalembertian)
```

I think a much better way is just to either have them all in the global namespace at start or having some function `inject_functions()`, but with some better name than I can come up with in 5 seconds.

----

Other small comments:

This is under-indetented:

```diff
diff --git a/src/sage/manifolds/differentiable/tensorfield.py b/src/sage/manifolds/differentiable/tensorfield.py
index 63ace1d..d8d173c 100644
--- a/src/sage/manifolds/differentiable/tensorfield.py
+++ b/src/sage/manifolds/differentiable/tensorfield.py
@@ -3087,9 +3087,9 @@ class TensorField(ModuleElement):
 
         .. MATH::
 
-            (T^\sharp)^{a_1\ldots a_{k+1}}_{\qquad\ \ b_1 \ldots b_{l-1}}
-            = g^{a_{k+1} i} \,
-            T^{a_1\ldots a_k}_{\qquad\   b_1 \ldots b_{p-k} \, i \, b_{p-k+1}\ldots b_{l-1}},
+          (T^\sharp)^{a_1\ldots a_{k+1}}_{\phantom{a_1\ldots a_{k+1}}\, b_1 \ldots b_{l-1}}
+          = g^{a_{k+1} i} \,
+          T^{a_1\ldots a_k}_{\phantom{a_1\ldots a_k}\, b_1 \ldots b_{p-k} \, i \, b_{p-k+1}\ldots b_{l-1}},
 
         `g^{ab}` being the components of the inverse metric.
 
@@ -3235,9 +3235,9 @@ class TensorField(ModuleElement):
 
         .. MATH::
 
-            (T^\flat)^{a_1\ldots a_{k-1}}_{\qquad\ \  b_1 \ldots b_{l+1}}
-            = g_{b_1 i} \,
-            T^{a_1\ldots a_{p} \, i \, a_{p+1}\ldots a_{k-1}}_{\qquad\qquad\quad\; b_2 \ldots b_{l+1}},
+          (T^\flat)^{a_1\ldots a_{k-1}}_{\phantom{a_1\ldots a_{k-1}}\, b_1 \ldots b_{l+1}}
+          = g_{b_1 i} \,
+          T^{a_1\ldots a_{p} \, i \, a_{p+1}\ldots a_{k-1}}_{\phantom{a_1\ldots a_{p} \, i \, a_{p+1}\ldots a_{k-1}}\, b_2 \ldots b_{l+1}},
 
         `g_{ab}` being the components of the metric tensor.
 
```

(It's okay that not everything in a `.. MATH::` block, but I do prefer the >= 4 spaces indentation visually.)

Everything else LGTM.


---

Comment by egourgoulhon created at 2018-03-03 16:32:53

Replying to [comment:15 tscrim]:

Thanks for looking to this ticket and for your comments.
> The biggest issue I have with this ticket is the addition of functions to the global namespace. `curl`, `laplacian`, and `dalembertian` I think are okay. `grad` over `gradient` I am not sure about. `div` looks too much like it is coming from "divide" or "division". 

I agree that `div` may evoke "division", however `grad` and `div` are pretty much standard notations in both elementary vector calculus and differential geometry, see e.g. 
- https://en.wikipedia.org/wiki/Vector_calculus#Differential_operators
- https://en.wikipedia.org/wiki/Vector_calculus_identities#Operator_notations
- https://en.wikipedia.org/wiki/Divergence

As a side note, neither `grad` nor `div` is already used as a global function in Sage, so the slot is free.

>I think you should ask on sage-devel to see if anyone has any objections with adding these to the global namespace and about them being a simple re-direct. 

OK I will.
> 
> In the same vein, this is bad to me:
> {{{#!python
>         # Import differential operators in the user global namespace:
>         if 'grad' not in get_globals():
>             from sage.manifolds.differentiable.operators import (grad, div,
>                                                  curl, laplacian, dalembertian)
>             set_global('grad', grad)
>             set_global('div', div)
>             set_global('curl', curl)
>             set_global('rot', curl)
>             set_global('laplacian', laplacian)
>             set_global('dalembertian', dalembertian)
> }}}
> I think a much better way is just to either have them all in the global namespace at start or having some function `inject_functions()`, but with some better name than I can come up with in 5 seconds.

Why is it bad? Is it because it prevents the user from discovering the grad function with the TAB key and/or `grad?` before having set up any pseudo-Riemannian manifold? This would indeed be a good reason to have the operators in the global namespace at start.
> 
> This is under-indetented:
> (It's okay that not everything in a `.. MATH::` block, but I do prefer the >= 4 spaces indentation visually.)
> 
OK, I will correct this.


---

Comment by tscrim created at 2018-03-03 22:16:58

Replying to [comment:16 egourgoulhon]:
> Replying to [comment:15 tscrim]:
> 
> Thanks for looking to this ticket and for your comments.
> > The biggest issue I have with this ticket is the addition of functions to the global namespace. `curl`, `laplacian`, and `dalembertian` I think are okay. `grad` over `gradient` I am not sure about. `div` looks too much like it is coming from "divide" or "division". 
> 
> I agree that `div` may evoke "division", however `grad` and `div` are pretty much standard notations in both elementary vector calculus and differential geometry, see e.g. 
> - https://en.wikipedia.org/wiki/Vector_calculus#Differential_operators
> - https://en.wikipedia.org/wiki/Vector_calculus_identities#Operator_notations
> - https://en.wikipedia.org/wiki/Divergence
> 
> As a side note, neither `grad` nor `div` is already used as a global function in Sage, so the slot is free.

The difference is that in those links, you know you are doing vector calculus, whereas in Python you have `operator.div`.

> > In the same vein, this is bad to me:
> > {{{#!python
> >         # Import differential operators in the user global namespace:
> >         if 'grad' not in get_globals():
> >             from sage.manifolds.differentiable.operators import (grad, div,
> >                                                  curl, laplacian, dalembertian)
> >             set_global('grad', grad)
> >             set_global('div', div)
> >             set_global('curl', curl)
> >             set_global('rot', curl)
> >             set_global('laplacian', laplacian)
> >             set_global('dalembertian', dalembertian)
> > }}}
> > I think a much better way is just to either have them all in the global namespace at start or having some function `inject_functions()`, but with some better name than I can come up with in 5 seconds.
> 
> Why is it bad? Is it because it prevents the user from discovering the grad function with the TAB key and/or `grad?` before having set up any pseudo-Riemannian manifold? This would indeed be a good reason to have the operators in the global namespace at start.

You should not inject them without the user knowing. In particular, what if you have `rot = some expensive computation`, then you create your manifold (with not having created a `grad`) and all of a sudden, your `rot` computation is gone. On the other side, what if we add a different `grad` to the global namespace, something I think could happen, then you will not get these injections.

I agree that they should be in the global namespace from the start and would making this issue moot. Some other thoughts that come to my mind is a function like `setup_manifolds_environment` and/or getting people who use SageManifolds to have a specific section to their `.sage/init.sage` file.


---

Comment by egourgoulhon created at 2018-03-04 10:51:17

Replying to [comment:17 tscrim]:
> 
> The difference is that in those links, you know you are doing vector calculus, whereas in Python you have `operator.div`.

Yes I agree, this depends on the context.

> 
> You should not inject them without the user knowing. In particular, what if you have `rot = some expensive computation`, then you create your manifold (with not having created a `grad`) and all of a sudden, your `rot` computation is gone. On the other side, what if we add a different `grad` to the global namespace, something I think could happen, then you will not get these injections.
> 

Thanks for these explanations. I totally overlooked this point... I am now 100% convinced that injecting silently names in the global namespace is a very bad thing.


> I agree that they should be in the global namespace from the start and would making this issue moot. Some other thoughts that come to my mind is a function like `setup_manifolds_environment` and/or getting people who use SageManifolds to have a specific section to their `.sage/init.sage` file.

I'll think about this, given that the discussion on sage-devel leans toward not adding new stuff in the global namespace.


---

Comment by git created at 2018-03-06 12:21:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2018-03-06 12:35:09

Following the conclusions of the [sage-devel thread](https://groups.google.com/d/msg/sage-devel/iSFwyR2E1f8/_rssKxleAQAJ), the above commit allows only explicit imports of the type:

```
sage: from sage.manifolds.operators import *
```

to inject the differential operators in the global namespace (the [demo worksheet](http://nbviewer.jupyter.org/github/egourgoulhon/SageMathTest/blob/master/Worksheets/vector_calculus.ipynb) has been updated accordingly).
Besides, this commit corrects the indentation of `.. MATH` blocks mentioned in comment:15.


---

Comment by tscrim created at 2018-03-06 22:15:48

One little trivial thing: the functions are no longer global (at least, I am interpreting that as being in the global namespace):

```diff
-        The function :func:`~sage.manifolds.operators.laplacian` can be
+        The global function :func:`~sage.manifolds.operators.laplacian` can be
+        used instead of the method ``laplacian()``::
```

and similar for `div` and `curl`, etc.
Also, do you want to link `laplacition()` to a (the?) corresponding method via `:meth:`?


---

Comment by jhpalmieri created at 2018-03-06 22:45:15

A few typos with proposed corrections:

```diff
diff --git a/src/sage/manifolds/differentiable/pseudo_riemannian.py b/src/sage/manifolds/differentiable/pseudo_riemannian.py
index fcfbe500e1..d68d797096 100644
--- a/src/sage/manifolds/differentiable/pseudo_riemannian.py
+++ b/src/sage/manifolds/differentiable/pseudo_riemannian.py
@@ -4,7 +4,7 @@ Pseudo-Riemannian Manifolds
 A *pseudo-Riemannian manifold* is a pair `(M,g)` where `M` is a real
 differentiable manifold `M` (see
 :class:`~sage.manifolds.differentiable.manifold.DifferentiableManifold`)
-and `g` is a field non-degenerate symmetric bilinear forms on `M`, which is
+and `g` is a field of non-degenerate symmetric bilinear forms on `M`, which is
 called the *metric tensor*, or simply the *metric* (see
 :class:`~sage.manifolds.differentiable.metric.PseudoRiemannianMetric`).
 
@@ -58,7 +58,7 @@ We get the metric defining the Riemannian structure by::
     sage: g
     Riemannian metric g on the 2-dimensional Riemannian manifold S^2
 
-At this stage, the metric `g` is defined a Python object but there remains to
+At this stage, the metric `g` is defined as a Python object but there remains to
 initialize it by setting its components with respect to the vector frames
 associated with the stereographic coordinates. Let us begin with the frame
 of chart ``stereoN``::
@@ -145,7 +145,7 @@ manifold, we can get the metric on it via the method ``metric()``::
     sage: gU.display()
     g = 4/(x^2 + y^2 + 1)^2 dx*dx + 4/(x^2 + y^2 + 1)^2 dy*dy
 
-On course, ``gU`` is nothing but the restriction of `g` to `U`::
+Of course, ``gU`` is nothing but the restriction of `g` to `U`::
 
     sage: gU is g.restrict(U)
     True
@@ -153,7 +153,7 @@ On course, ``gU`` is nothing but the restriction of `g` to `U`::
 .. RUBRIC:: Example 2: Minkowski spacetime as a Lorentzian manifold of
   dimension 4
 
-We start by declaring 4-dimensional Lorentzian manifold::
+We start by declaring a 4-dimensional Lorentzian manifold::
 
     sage: M = Manifold(4, 'M', structure='Lorentzian')
     sage: M
@@ -223,7 +223,7 @@ class PseudoRiemannianManifold(DifferentiableManifold):
     A *pseudo-Riemannian manifold* is a pair `(M,g)` where `M` is a real
     differentiable manifold `M` (see
     :class:`~sage.manifolds.differentiable.manifold.DifferentiableManifold`)
-    and `g` is a field non-degenerate symmetric bilinear forms on `M`, which is
+    and `g` is a field of non-degenerate symmetric bilinear forms on `M`, which is
     called the *metric tensor*, or simply the *metric* (see
     :class:`~sage.manifolds.differentiable.metric.PseudoRiemannianMetric`).
 
@@ -405,7 +405,7 @@ class PseudoRiemannianManifold(DifferentiableManifold):
                dest_map=None):
         r"""
         Return the metric giving the pseudo-Riemannian structure to the
-        manifold, or defines a new metric tensor on the manifold.
+        manifold, or define a new metric tensor on the manifold.
 
         INPUT:
 
```



---

Comment by git created at 2018-03-07 10:17:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2018-03-07 10:22:21

Replying to [comment:21 tscrim]:
> One little trivial thing: the functions are no longer global (at least, I am interpreting that as being in the global namespace):
>
> and similar for `div` and `curl`, etc.
> Also, do you want to link `laplacition()` to a (the?) corresponding method via `:meth:`?

Thanks for pointing this. This is corrected in the above commit. I have also added some simple vector fields in the Minkowski spacetime example (example 2 at the top of `pseudo_riemannian.py`).


---

Comment by egourgoulhon created at 2018-03-07 10:23:41

Replying to [comment:22 jhpalmieri]:
> A few typos with proposed corrections:

Thank you very much for these corrections. They are effective in the above commit.


---

Comment by tscrim created at 2018-03-08 01:35:31

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2018-03-08 01:35:31

LGTM. Thank you.


---

Comment by egourgoulhon created at 2018-03-08 09:02:58

Thank you very much for the review!


---

Comment by vbraun created at 2018-03-19 07:57:58

Resolution: fixed
