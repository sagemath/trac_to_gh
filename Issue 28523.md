# Issue 28523: py3: imagemagick,internet,latex str vs bytes doctests failures

archive/issues_028523.json:
```json
{
    "body": "\n```\nsage -t --optional=sage,optional,external src/sage/coding/databases.py src/sage/repl/load.py src/sage/misc/latex.py  \n```\n\n\ngives\n\n\n```\ntoo many failed tests, not using stored timings\nRunning doctests with ID 2019-11-19-09-45-34-de2336ec.\nGit branch: develop\nUsing --optional=4ti2,cbc,ccache,cryptominisat,dot2tex,e_antic,external,glucose,latte_int,lidia,lrslib,memlimit,normaliz,notedown,openssl,pandoc_attributes,pycosat,pynormaliz,rst2ipynb,sage,sagenb\nExternal software to be detected: cplex,ffmpeg,graphviz,gurobi,imagemagick,internet,latex,macaulay2,magma,maple,mathematica,matlab,octave,pandoc,scilab\nDoctesting 3 files.\nsage -t src/sage/coding/databases.py\n**********************************************************************\nFile \"src/sage/coding/databases.py\", line 137, in sage.coding.databases.best_linear_code_in_codetables_dot_de\nFailed example:\n    L = codes.databases.best_linear_code_in_codetables_dot_de(72, 36, GF(2))    # optional - internet\nException raised:\n    Traceback (most recent call last):\n      File \"/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 681, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1123, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.coding.databases.best_linear_code_in_codetables_dot_de[0]>\", line 1, in <module>\n        L = codes.databases.best_linear_code_in_codetables_dot_de(Integer(72), Integer(36), GF(Integer(2)))    # optional - internet\n      File \"/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/coding/databases.py\", line 174, in best_linear_code_in_codetables_dot_de\n        i = s.find(\"<PRE>\")\n    TypeError: argument should be integer or bytes-like object, not 'str'\n**********************************************************************\nFile \"src/sage/coding/databases.py\", line 138, in sage.coding.databases.best_linear_code_in_codetables_dot_de\nFailed example:\n    print(L)                                                                    # optional - internet\nException raised:\n    Traceback (most recent call last):\n      File \"/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 681, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1123, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.coding.databases.best_linear_code_in_codetables_dot_de[1]>\", line 1, in <module>\n        print(L)                                                                    # optional - internet\n    NameError: name 'L' is not defined\n**********************************************************************\n1 item had failures:\n   2 of   3 in sage.coding.databases.best_linear_code_in_codetables_dot_de\n    [7 tests, 2 failures, 1.17 s]\nsage -t src/sage/repl/load.py\n**********************************************************************\nFile \"src/sage/repl/load.py\", line 157, in sage.repl.load.load\nFailed example:\n    sage.repl.load.load('https://github.com/jasongrout/minimum_rank/raw/minimum_rank_1_0_0/minrank.py', globals())  # optional - internet\nException raised:\n    Traceback (most recent call last):\n      File \"/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 681, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1123, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.repl.load.load[16]>\", line 1, in <module>\n        sage.repl.load.load('https://github.com/jasongrout/minimum_rank/raw/minimum_rank_1_0_0/minrank.py', globals())  # optional - internet\n      File \"/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/repl/load.py\", line 235, in load\n        filename = get_remote_file(filename, verbose=False)\n      File \"/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/misc/remote_file.py\", line 49, in get_remote_file\n        f.write(content.read())\n    TypeError: write() argument must be str, not bytes\n**********************************************************************\n1 item had failures:\n   1 of  36 in sage.repl.load.load\n    [44 tests, 1 failure, 1.14 s]\nsage -t src/sage/misc/latex.py\n**********************************************************************\nFile \"src/sage/misc/latex.py\", line 1085, in sage.misc.latex.Latex.?\nFailed example:\n    latex.eval(\"\\ThisIsAnInvalidCommand\", {}) # optional -- ImageMagick\nException raised:\n    Traceback (most recent call last):\n      File \"/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 681, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1123, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.misc.latex.Latex.?[1]>\", line 1, in <module>\n        latex.eval(\"\\ThisIsAnInvalidCommand\", {}) # optional -- ImageMagick\n      File \"/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/misc/latex.py\", line 1114, in eval\n        O.write(str_to_bytes(x, encoding='utf-8'))\n    TypeError: write() argument must be str, not bytes\n**********************************************************************\n1 item had failures:\n   1 of   3 in sage.misc.latex.Latex.?\n    [309 tests, 1 failure, 1.20 s]\n----------------------------------------------------------------------\nsage -t src/sage/coding/databases.py  # 2 doctests failed\nsage -t src/sage/repl/load.py  # 1 doctest failed\nsage -t src/sage/misc/latex.py  # 1 doctest failed\n----------------------------------------------------------------------\nTotal time for all tests: 3.9 seconds\n    cpu time: 1.3 seconds\n    cumulative wall time: 3.5 seconds\nExternal software detected for doctesting: imagemagick,internet,latex\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/28760\n\n",
    "created_at": "2019-11-19T08:47:20Z",
    "labels": [
        "python3",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.0",
    "title": "py3: imagemagick,internet,latex str vs bytes doctests failures",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28523",
    "user": "slabbe"
}
```

```
sage -t --optional=sage,optional,external src/sage/coding/databases.py src/sage/repl/load.py src/sage/misc/latex.py  
```


gives


```
too many failed tests, not using stored timings
Running doctests with ID 2019-11-19-09-45-34-de2336ec.
Git branch: develop
Using --optional=4ti2,cbc,ccache,cryptominisat,dot2tex,e_antic,external,glucose,latte_int,lidia,lrslib,memlimit,normaliz,notedown,openssl,pandoc_attributes,pycosat,pynormaliz,rst2ipynb,sage,sagenb
External software to be detected: cplex,ffmpeg,graphviz,gurobi,imagemagick,internet,latex,macaulay2,magma,maple,mathematica,matlab,octave,pandoc,scilab
Doctesting 3 files.
sage -t src/sage/coding/databases.py
**********************************************************************
File "src/sage/coding/databases.py", line 137, in sage.coding.databases.best_linear_code_in_codetables_dot_de
Failed example:
    L = codes.databases.best_linear_code_in_codetables_dot_de(72, 36, GF(2))    # optional - internet
Exception raised:
    Traceback (most recent call last):
      File "/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1123, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.coding.databases.best_linear_code_in_codetables_dot_de[0]>", line 1, in <module>
        L = codes.databases.best_linear_code_in_codetables_dot_de(Integer(72), Integer(36), GF(Integer(2)))    # optional - internet
      File "/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/coding/databases.py", line 174, in best_linear_code_in_codetables_dot_de
        i = s.find("<PRE>")
    TypeError: argument should be integer or bytes-like object, not 'str'
**********************************************************************
File "src/sage/coding/databases.py", line 138, in sage.coding.databases.best_linear_code_in_codetables_dot_de
Failed example:
    print(L)                                                                    # optional - internet
Exception raised:
    Traceback (most recent call last):
      File "/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1123, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.coding.databases.best_linear_code_in_codetables_dot_de[1]>", line 1, in <module>
        print(L)                                                                    # optional - internet
    NameError: name 'L' is not defined
**********************************************************************
1 item had failures:
   2 of   3 in sage.coding.databases.best_linear_code_in_codetables_dot_de
    [7 tests, 2 failures, 1.17 s]
sage -t src/sage/repl/load.py
**********************************************************************
File "src/sage/repl/load.py", line 157, in sage.repl.load.load
Failed example:
    sage.repl.load.load('https://github.com/jasongrout/minimum_rank/raw/minimum_rank_1_0_0/minrank.py', globals())  # optional - internet
Exception raised:
    Traceback (most recent call last):
      File "/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1123, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.repl.load.load[16]>", line 1, in <module>
        sage.repl.load.load('https://github.com/jasongrout/minimum_rank/raw/minimum_rank_1_0_0/minrank.py', globals())  # optional - internet
      File "/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/repl/load.py", line 235, in load
        filename = get_remote_file(filename, verbose=False)
      File "/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/misc/remote_file.py", line 49, in get_remote_file
        f.write(content.read())
    TypeError: write() argument must be str, not bytes
**********************************************************************
1 item had failures:
   1 of  36 in sage.repl.load.load
    [44 tests, 1 failure, 1.14 s]
sage -t src/sage/misc/latex.py
**********************************************************************
File "src/sage/misc/latex.py", line 1085, in sage.misc.latex.Latex.?
Failed example:
    latex.eval("\ThisIsAnInvalidCommand", {}) # optional -- ImageMagick
Exception raised:
    Traceback (most recent call last):
      File "/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1123, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.latex.Latex.?[1]>", line 1, in <module>
        latex.eval("\ThisIsAnInvalidCommand", {}) # optional -- ImageMagick
      File "/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/misc/latex.py", line 1114, in eval
        O.write(str_to_bytes(x, encoding='utf-8'))
    TypeError: write() argument must be str, not bytes
**********************************************************************
1 item had failures:
   1 of   3 in sage.misc.latex.Latex.?
    [309 tests, 1 failure, 1.20 s]
----------------------------------------------------------------------
sage -t src/sage/coding/databases.py  # 2 doctests failed
sage -t src/sage/repl/load.py  # 1 doctest failed
sage -t src/sage/misc/latex.py  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 3.9 seconds
    cpu time: 1.3 seconds
    cumulative wall time: 3.5 seconds
External software detected for doctesting: imagemagick,internet,latex
```


Issue created by migration from https://trac.sagemath.org/ticket/28760





---

archive/issue_comments_402786.json:
```json
{
    "body": "src/sage/misc/persist.pyx is fixed in #28761",
    "created_at": "2019-11-19T10:50:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28523#issuecomment-402786",
    "user": "chapoton"
}
```

src/sage/misc/persist.pyx is fixed in #28761



---

archive/issue_comments_402787.json:
```json
{
    "body": "src/sage/repl/load.py is almost fixed by #28761 too",
    "created_at": "2019-11-19T12:57:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28523#issuecomment-402787",
    "user": "chapoton"
}
```

src/sage/repl/load.py is almost fixed by #28761 too



---

archive/issue_comments_402788.json:
```json
{
    "body": "Here is a fix for databases\n----\nNew commits:",
    "created_at": "2019-11-19T14:53:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28523#issuecomment-402788",
    "user": "chapoton"
}
```

Here is a fix for databases
----
New commits:



---

archive/issue_comments_402789.json:
```json
{
    "body": "Spliting this ticket and moving the other issues to #28808",
    "created_at": "2019-11-27T15:14:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28523#issuecomment-402789",
    "user": "slabbe"
}
```

Spliting this ticket and moving the other issues to #28808



---

archive/issue_comments_402790.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-11-27T15:15:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28523#issuecomment-402790",
    "user": "slabbe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_402791.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-11-27T15:15:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28523#issuecomment-402791",
    "user": "slabbe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_402792.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-11-29T23:57:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28523#issuecomment-402792",
    "user": "vbraun"
}
```

Resolution: fixed
