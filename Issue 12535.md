# Issue 12535: Add an optional 'git' spkg

Issue created by migration from Trac.

Original creator: leif

Original creation time: 2012-03-20 12:40:45

Assignee: kini

CC:  leif schilly jdemeyer

Keywords: SCM VCS RCS distributed revision control

Git is a fast, scalable, distributed revision control system with an unusually rich command set that provides both high-operations and full access to internals.

See [http://git-scm.com/](http://git-scm.com/)




I should note that git has no connection to anything else in Sage at the
moment. This is mainly for people who want to play around with git as we
prepare to eventually switch our repos to git and consolidate them, among
other things, and who don't have git installed systemwide, or maybe
don't have a recent version of git installed systemwide, for whatever
reason.

-Keshav


----

*New optional spkg:* [http://boxen.math.washington.edu/home/keshav/files/git-1.7.9.4.spkg](http://boxen.math.washington.edu/home/keshav/files/git-1.7.9.4.spkg)

*md5sum:* `c802ddbac949f14ba6647158559d3aa8  git-1.7.9.4.spkg`


### git-1.7.9.4 (Keshav Kini, 2012-03-19)

 * Upgrade to latest stable
 * Track dependencies

### git-1.7.2.4 (William Stein, 2012-03-19)

 * Initial version


---

Comment by kini created at 2012-03-20 12:42:29

This is already an experimental spkg thanks to #12705. You might use this ticket to "upgrade" it to optional, if you so desire.


---

Comment by schilly created at 2012-03-20 12:47:03

ah ok, it's optional now. i didn't knew where i was supposed to put it :-)


---

Comment by leif created at 2012-03-20 12:47:54

`spkg-install` could be beautified.

It lacks `#!/usr/bin/env bash` and the usual sanity check (`if [This is the Trac macro *-z "$SAGE_LOCAL" * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#-z "$SAGE_LOCAL" -macro); then ...`), and error messages should be redirected to `stderr`.

I'd also split the build (`make`) from `make install`.


---

Comment by leif created at 2012-03-20 12:47:54

Changing status from new to needs_review.


---

Comment by leif created at 2012-03-20 12:50:35

Replying to [comment:1 kini]:
> This is already an experimental spkg thanks to #12705. You might use this ticket to "upgrade" it to optional, if you so desire.

Ooops, I searched for "git" on trac but have apparently been too slow with creating the ticket (or trac lied, as it sometimes does).

Sorry for the noise, or is anybody going to further work on this ticket?


---

Comment by kini created at 2012-03-20 12:56:22

I will make the changes you suggest. As the spkg has been published already (no matter how briefly) I guess that means this should be a .p1. So I'll change the name of this ticket to upgrade the SPKG to p1.


---

Comment by kini created at 2012-03-20 14:27:02

I've uploaded the package here: http://boxen.math.washington.edu/home/keshav/files/git-1.7.9.4.p1.spkg


---

Comment by kini created at 2012-03-21 02:20:49

Leif told me on IRC that I should handle SAGE64 and CPPFLAGS/LDFLAGS. I guess I will also add an spkg-check script.


---

Comment by kini created at 2012-03-21 02:20:49

Changing status from needs_review to needs_work.


---

Comment by kini created at 2012-03-23 03:27:01

Sorry, forgot to mark this as needs review again. I think I've addressed the issues Leif pointed out to me.


---

Comment by kini created at 2012-04-20 04:37:33

Changing status from needs_work to needs_review.


---

Comment by kini created at 2012-04-20 04:37:33

... wtf? Apparently it didn't get set as needs review after all... trying again


---

Comment by jhpalmieri created at 2012-04-20 05:20:16

On sage.math, the Python path is hardcoded, as you noted in sage-devel. So this uses the system Python, and so fails to build for me.

On OS X Lion with sage-5.0.beta13, I see this:

```
    AR libgit.a
/usr/bin/ranlib: file: libgit.a(gettext.o) has no symbols
    LINK git-daemon
    LINK git-fast-import
ld: warning: ignoring file /opt/local/lib/libz.dylib, file was built for unsupported file format ld: warning: whichignoring is not the architecture file /opt/local/lib/libz.dylib, file was built for unsupported file format which is not the architecture being linked (x86_64)
ld: warning: ignoring file /sw/lib/libiconv.dylib, file was built for unsupported file format which is not the architecture  being linked (x86_64)
ld: warning: ignoring file /sw/lib/libiconv.dylib, file was built for unsupported file format which is not the architecture being linked (x86_64)
ld: warning: ignoring file /opt/local/lib/libcrypto.dylib, file was built for unsupported file format which is not the architecture being linked (x86_64)
Undefined symbols for architecture x86_64:
  "_crc32", referenced from:
      _check_pack_crc in libgit.a(pack-check.o)
      _sha1write in libgit.a(csum-file.o)
      _crc32_begin in libgit.a(csum-file.o)
     (maybe you meant: _crc32_end, _crc32_begin )
  "_SHA1_Init", referenced from:
      _write_sha1_file_prepare in libgit.a(sha1_file.obeing linked (x86_64)
ld: warning: ignoring file /opt/local/lib/libcrypto.dylib, file was built for unsupported file format which is not the architecture)
      _write_loose_object in libgit.a(sha1_file.o)
      _verify_pack_index in libgit.a(pack-check.o)
      _verify_pack in libgit.a(pack-check.o)
      _deflate_to_pack.constprop.1 in libgit.a(bulk-checkin.o)
      being linked ( _sha1fd_throughput in libgit.a(csum-file.o)
      _write_idx_file in libgit.a(pack-write.o)
     x86_64)
Undefined symbols for architecture  ...
  "_SHA1_Update", referenced from:
      _write_sha1_file_prepare inx86_64:
  "_SHA1_Init", referenced from:
    libgit.a(sha1_file.o)
      _write_loose_object in libgit.a(sha1_file.o)
   _store_object in fast-import.o
      _stream_blob in       _verify_pack_index in libgit.a(pack-check.o)
    fast-import.o
      _sha1fd_throughput in libgit.a(csum-file.o)
      _write_sha1_file_prepare in libgit.a(sha1_file.o)
      _write_loose_object in libgit.a(sha1_file.o)
      _read_index_from in libgit.a(read-cache.o)
      _write_index in libgit.a(read-cache.o  _verify_pack in libgit.a(pack-check.o)
      _deflate_to_pack.constprop.1 in libgit.a(bulk-checkin.o)
      _sha1flush in libgit.a()
      ...
  "_SHA1_Update", referenced from:
      _store_object in fast-import.o
      _stream_blob in fast-import.o
      _sha1flush in libgit.a(csum-file.o)
      _sha1write in libgit.a(csum-file.o)
 csum-file.o) 
         _write_sha1_file_prepare  _sha1write in libgit.a(csum-file.o)
      ...
  "_SHA1_Final", referenced from:in libgit.a(sha1_file.o)
      _write_loose_object in libgit.a(sha1_file.o)
      _ce_write in libgit.a(read-cache.o)
      ...
  "_SHA1_Final", referenced from:
      _store_object in fast-import.o
      _stream_blob in fast-import.o
      _sha1close in libgit.a(csum
      _write_sha1_file_prepare in libgit.a(sha1_file.o)
      _write_loose_object in libgit.a(sha1_file.o)
      _verify_pack_index in libgit.a(-file.o)
      _write_sha1_file_prepare in libgit.a(sha1_file.o)
      _write_loose_object in libgit.a(sha1_file.o)
      _read_index_from in libgit.apack-check.o)
      _verify_pack in libgit.a(pack-check.o)(read-cache.o)
      _write_index in libgit.a(read-cache.o)
 
         ...
  "_crc32", referenced from:
      _sha1write in libgit.a(csum-file.o)
      _crc32_begin in libgit.a(csum-file.o)
      _check_pack_crc in libgit.a( pack -check.o_deflate_to_pack.constprop.1 in libgit.a(bulk-checkin.o)
      _sha1close in libgit.a(csum-file.o)
      _write_idx_file in libgit.a(pack-)
     (maybe you meant: _crc32_end, _crc32_begin )
  "_libiconv_open", referenced from:
      _reencode_string in libgit.awrite.o(utf8.o)
  "_libiconv", referenced from:
      _reencode_string in libgit.a(utf8.o)
  "_libiconv_close", referenced from:
      _reencode_string in libgit.a(utf8.o)
  "_inflateInit_", referenced from:
     )
      . _git_inflate_init in libgit.a(zlib.o)
  "_inflateInit2_", referenced from:
      ..
  "_libiconv_open", referenced from:
      _reencode_string in libgit.a(utf8.o)
  "_libiconv", referenced from:
      _reencode_string in libgit.a(utf8.o)
  "_libiconv_close", referenced from:
      _reencode_string in libgit.a(utf8.o)
  "_inflateInit_", referenced from:
      _git_inflate_init in libgit.a(zlib.o_git_inflate_init_gzip_only in libgit.a(zlib.o)
  "_inflateEnd", referenced from:
      _git_inflate_end in libgit.a(zlib.o)
  "_inflate", referenced from:
      _git_inflate in libgit.a(zlib.o)
  "_inflateInit2_", referenced from:
      _git_inflate_init_gzip_only in libgit.a(zlib.o)
  "_inflateEnd", referenced from:
  )
     (maybe you meant: _git_inflate, _git_inflate_init_gzip_only , _git_inflate_init , _git_inflate_end )
  "_deflateBound", referenced from:
      _git_deflate_bound in libgit.a(zlib.o)
  "_deflateInit_", referenced from:
      _git_deflate_init in libgit.a(zlib.o)
  "_deflateInit2_", referenced from:
      _git_inflate_end in    _git_deflate_init_gzip in libgit.a(zlib.o)
  "_deflateEnd", referenced from:
      _git_deflate_abort in libgit.a(zlib.o)
      _git_deflate_end_gently in libgit.a(zlib.o)
  "_deflate", referenced from:
      _git_deflate libgit.a(zlib.o)
  "_inflate", referenced from:
   in libgit.a(zlib.o)
     (maybe you meant: _git_deflate_end_gently    _git_inflate in libgit.a(zlib.o)
     (maybe , you_git_deflate , _git_deflate_bound , _git_deflate_end , _git_deflate_abort , _git_deflate_init_gzip , _git_deflate_init )
ld: symbol(s) not found for architecture x86_64
 meant: _git_inflate, _git_inflate_init_gzip_only , _git_inflate_init , _git_inflate_end )
  "_deflateBound", referenced from:
      _git_deflate_bound in libgit.a(zlib.o)
  "collect2: ld returned 1 exit status
_deflateInit_", referenced from:
      _git_deflate_init in libgit.a(zlib.o)
  "_deflateInit2_", referenced from:
      _git_deflate_init_gzip in libgit.a(zlib.o)
  "_deflateEnd", referenced from:
      _git_deflate_abort in libgit.a(zlib.o)
      _git_deflate_end_gently in libgit.a(zlib.o)
  "_deflate", referenced from:
      _git_deflate in libgit.a(zlib.o)
     (maybe you meant: _git_deflate_end_gently, _git_deflate , _git_deflate_bound , _git_deflate_end , _git_deflate_abort , _git_deflate_init_gzip , _git_deflate_init )
ld: symbol(s) not found for architecture x86_64
collect2: ld returned 1 exit status
make: *** [git-fast-import] Error 1
make: *** Waiting for unfinished jobs....
make: *** [git-daemon] Error 1
Error building git.
```

I don't know why it's picking up files in /opt and /sw; I don't reference those directories in any environment variables. Oh, according to the Makefile, it looks like we should set `NO_FINK` and `NO_DARWIN_PORTS`, at least on Darwin. Putting `export NO_FINK=yes` (and similar for `NO_DARWIN_PORTS`) in spkg-install fixes the installation on this machine.


---

Comment by jhpalmieri created at 2012-04-20 05:20:36

Changing status from needs_review to needs_work.


---

Comment by kini created at 2012-04-20 06:08:37

Thanks for your detective work on OS X, John! The problem on sage.math I know how to fix - just pass some params to the configure script. New SPKG will be up in a little bit.


---

Comment by kini created at 2012-04-20 06:32:53

I took the opportunity to upgrade to the latest stable git version, 1.7.10, as well.

http://boxen.math.washington.edu/home/keshav/files/git-1.7.10.spkg


---

Comment by kini created at 2012-04-20 06:32:53

Changing status from needs_work to needs_review.


---

Comment by kini created at 2012-04-20 07:54:37

Changing status from needs_review to needs_work.


---

Comment by kini created at 2012-04-20 07:54:37

Um. Strange, I posted in a comment earlier that I had implemented Leif's suggestions about SAGE64 and CPPFLAGS/LDFLAGS, but I see no evidence of them in the current SPKG. I'm setting this back to needs_work until I find out where that version of the scripts went...


---

Comment by kini created at 2012-04-20 20:54:46

OK, seems I did make those changes and commit them but never uploaded the resulting SPKG... so now we have a rare occurrence, which is a merge commit inside an SPKG repo :)

New SPKG is up and ready for review IMO.


---

Comment by kini created at 2012-04-20 20:54:46

Changing status from needs_work to needs_review.


---

Comment by kini created at 2012-05-26 02:12:05

Jeroen, you mentioned you want to look at the git SPKG, so here it is (there is already an older one up under optional SPKGs, but this is newer and improved).


---

Comment by kini created at 2012-06-12 22:34:36

How did I forget this...


---

Attachment

scripts repo


---

Comment by jhpalmieri created at 2012-06-12 23:26:35

You need a patch for the scripts repo: see [attachment:trac_12707-git-scripts.patch attached].


---

Comment by kini created at 2012-06-12 23:40:36

Thanks!


---

Comment by jhpalmieri created at 2012-06-12 23:44:28

It builds on a few machines (sage.math, OS X Lion), but it fails on an OpenSolaris box:

```
ld:ldld:ld::   fatalfatalldfatal::  file:  filedaemon.ofile :shell.o:  show wrongwrong- index.oELF : ldwrong ELFclass: :ELFCLASS32
ld : fatal fatal::  class fatal::  filefile ELFCLASS32processing
 lderrors.  Noupload:- pack.ofatal::   wrong fileELF  classoutput:  ELFCLASS32processingwritten  
errors.to  Nogit ldoutput- :writtenfile   toshell fast
-gitfatalimport.o::  -show-index
file processing errors. collect2: wrongNo  ELFoutput written collect2: to ld returned git-upload-pack
1 exit statusld returned  class: 
ELFCLASS321 exit status
collect2: ld returned 1 exit statusld

: ld:fatal: file http-backend.o: wrong ELF class: ELFCLASS32
ld: fatal: file processing errors. No  output writtenfatal :to  filegit -processinghttp -errors. Nobackend
collect2:  output written to git-fast-import
ld returned 1 exit status
collect2: ld returned 1 exit status
: fatal: file imap-send.o: wrong ELF class: ELFCLASS32
ld: fatal: file processing errors. No output written to git-imap-send
collect2: ld returned 1 exit status
 ELF class: ELFCLASS32
ld: fatal: file processing errors. No output written to git-daemon
collect2: ld returned 1 exit status
make: *** [git-http-backend] Error 1
make: *** Waiting for unfinished jobs....
make: *** [git-imap-send] Error 1
make: *** [git-fast-import] Error 1
make: *** [git-show-index] Error 1
make: *** [git-shell] Error 1
make: *** [git-upload-pack] Error 1
make: *** [git-daemon] Error 1
ld: fatal: file sh-i18n--envsubst.o: wrong ELF class: ELFCLASS32
ld: fatal: file processing errors. No output written to git-sh-i18n--envsubst
collect2: ld returned 1 exit status
    LINK git-http-fetch
make: *** [git-sh-i18n--envsubst] Error 1
ld: fatal: file credential-store.o: wrong ELF class: ELFCLASS32
ld: fatal: file processing errors. No output written to git-credential-store
collect2: ld returned 1 exit status
make: *** [git-credential-store] Error 1
ld: fatal: file revision.o: wrong ELF class: ELFCLASS32
ld: fatal: file processing errors. No output written to git-http-fetch
collect2: ld returned 1 exit status
make: *** [git-http-fetch] Error 1
Error building git.
```



---

Comment by kini created at 2012-06-13 00:02:38

What's going on in those first few lines? Is something being parallelized that you could serialize and retest, perhaps?


---

Comment by jhpalmieri created at 2012-06-13 17:16:58

I unset `MAKE` and tried again:

```
    CC xdiff/xpatience.o
    CC xdiff/xhistogram.o
    AR xdiff/lib.a
    LINK git-daemon
ld: fatal: file daemon.o: wrong ELF class: ELFCLASS32
ld: fatal: file processing errors. No output written to git-daemon
collect2: ld returned 1 exit status
make: *** [git-daemon] Error 1
Error building git.
```



---

Comment by jdemeyer created at 2012-10-01 15:04:06

This should not be needed:

```
CPPFLAGS="-I$SAGE_LOCAL/include $CPPFLAGS"
LDFLAGS="-L$SAGE_LOCAL/lib $LDFLAGS"
```


Also, why use `#!/usr/bin/env sh`?  Forcing `bash` (like everywhere else in Sage) might be slightly more portable.

(None of this is serious enough to warrant `needs_work`, just pointing out these things)


---

Comment by jdemeyer created at 2012-10-01 15:06:55

It indeed fails to build on various systems.  I'l try updating to the latest upstream, but git's website is very unhelpful, do they even host the git source code?


---

Comment by jdemeyer created at 2012-10-01 15:11:15

Found the git sources (http://code.google.com/p/git-core/downloads/list) after some non-trivial amount of searching.


---

Comment by jdemeyer created at 2012-10-01 15:11:15

Changing assignee from kini to jdemeyer.


---

Comment by jdemeyer created at 2012-10-01 15:13:10

There is some broken Shell code in `spkg-install`, fixing...  hang on for a new version.


---

Comment by jdemeyer created at 2012-10-01 15:13:10

Changing status from needs_review to needs_work.


---

Comment by kini created at 2012-10-01 16:15:28

Thanks for looking at this, Jeroen. By the way, the repository linked to from the git website, http://git-scm.com/ , is here: https://github.com/git/git

I believe the actual main repository is this one, though: http://git.kernel.org/?p=git/git.git;a=summary (not sure what the actual pullable/clonable URI is for this one).


---

Comment by schilly created at 2012-10-01 16:24:33

Replying to [comment:27 kini]:
> I believe the actual main repository is this one, though: http://git.kernel.org/?p=git/git.git;a=summary (not sure what the actual pullable/clonable URI is for this one).

The page says `git://git.kernel.org/pub/scm/git/git.git` which looks good to me.


---

Comment by kini created at 2012-10-01 16:29:10

Oh wow, not sure how I didn't see that. It's right there in the middle of the page...


---

Comment by jdemeyer created at 2012-10-01 18:07:48

I updated the spkg a bit.  Still doesn't build on a lot of platforms though...


---

Comment by jdemeyer created at 2012-10-02 19:34:25

Changing status from needs_work to needs_review.


---

Attachment


---

Comment by jdemeyer created at 2012-10-02 19:36:00

Fixed the various issues, now builds on all systems that I tried.  needs_review.


---

Comment by vbraun created at 2012-10-03 15:55:54

Instead of trying to find install and dying if not, we should just include `install-sh` from our favourite autotools version and `export INSTALL=install-sh`. Really its upstream's fault for disabling `AC_PROG_INSTALL` in `configure.ac`. Apparently Junio doesn't like auto-files in the project root directory. On a related note, I'm surprised that upstream doesn't have a `src/` subfolder...

Anyways, we don't really have to do this now though I suspect it'll bite us eventually. Apart from that it look good!


---

Comment by vbraun created at 2012-10-03 15:55:54

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-10-03 19:13:52

Replying to [comment:34 vbraun]:
> Instead of trying to find install and dying if not, we should just include `install-sh` from our favourite autotools version and `export INSTALL=install-sh`. Really its upstream's fault for disabling `AC_PROG_INSTALL` in `configure.ac`.
Indeed.  But it seems all systems I tried do have a good enough `install` program, so it's not that much of an issue.


---

Comment by vbraun created at 2012-10-03 19:48:40

The postgresql guys thought that, too. But it did become an issue:

http://archives.postgresql.org/pgsql-bugs/2001-03/msg00049.php

Thats why `AC_PROG_INSTALL` not only searches for a system `install`, but also checks that it is bsd compatible. Not every `install` binary in the path is going to be good enough.


---

Comment by jdemeyer created at 2012-10-03 20:07:48

Replying to [comment:36 vbraun]:
> Thats why `AC_PROG_INSTALL` not only searches for a system `install`, but also checks that it is bsd compatible. Not every `install` binary in the path is going to be good enough.
You're right of course, but at least the git spkg checks for `/usr/ucb/install`, which is what Solaris uses.


---

Comment by jhpalmieri created at 2012-10-03 22:26:12

For what it's worth, self-tests pass on sage.math, but fail for me on OS X and OpenSolaris. Since this is an optional spkg, I'm willing to ignore this.


---

Comment by schilly created at 2012-10-07 09:37:03

file is on the server + mirrors


---

Comment by jhpalmieri created at 2012-10-08 18:18:18

Is it time to change the first line of SPKG.txt yet?

```
# git - the stupid content tracker
```



---

Comment by kini created at 2012-10-08 18:46:38

Change it? Why? That's verbatim from `man git` :)


---

Comment by jhpalmieri created at 2012-10-08 18:59:56

Okay, never mind. (I guess it's a reference to the name.)


---

Comment by kini created at 2012-10-08 19:03:32

Yup.

>Linus Torvalds has quipped about the name "git", which is English slang for a stupid or unpleasant person. Torvalds said: "I'm an egotistical bastard, and I name all my projects after myself. First 'Linux', now 'git'." The man page describes git as "the stupid content tracker".

-- [Wikipedia](http://en.wikipedia.org/wiki/Git_(software)#Name)


---

Comment by jdemeyer created at 2012-10-14 18:55:01

Resolution: fixed
