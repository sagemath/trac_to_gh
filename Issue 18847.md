# Issue 18847: libSingular functions' ring parameter defaults to the last used ring

Issue created by migration from https://trac.sagemath.org/ticket/19084

Original creator: klee

Original creation time: 2015-08-25 07:47:34

CC:  jakobkroeker malb

libSingular functions require a ring parameter set. But for some functions the ring parameter is redundant.

Martin Albrecht answers to this issue:

We could do this: 

- if no ring is given, we try to find one as we do currently. 
- if that fails because the inputs are not polynomials of any kind, we could use a dummy ring.

My own solution to this problem is to store the last used ring in libSingular function calls, instead of using a dummy ring. In a Singular function call, if a ring is not found from the arguments, then the ring parameter defaults to the last used ring. The initial "last used" ring is set to `PolynomialRing(QQ,2,'x,y')`.


---

Comment by git created at 2015-08-25 07:50:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2015-08-25 13:50:03

Changing status from new to needs_review.


---

Comment by nbruin created at 2015-08-26 01:32:37

Could you just change the initial assignment to `last_ring` to

```
last_ring=PolynomialRing(QQ,"dummy",1)
```

and _not_ update `last_ring`? Perhaps rename the global variable to `dummy_ring` too.

There are some reasons why using a dedicated dummy ring might be nicer than reusing arbitrary objects for the purpose:
 - by making global links to arbitrary objects, where the global link has a rather unpredictable lifetime, you're making garbage collection and detection of memory leaks harder.
 - you're making a link to a globally unique object. In principle, you're allowed to do so, but this can have very subtle effects on the system, because it can change the minimal lifetime of all kinds of related objects. So for the sake of sanity in debugging elsewhere, it might be better to not do this.

A pro of your current approach is that you might avoid having to create a dummy ring, thus saving the slight memory penalty for it.


---

Comment by klee created at 2015-08-26 02:43:26

Replying to [comment:3 nbruin]:
> Could you just change the initial assignment to `last_ring` to
> {{{
> last_ring=PolynomialRing(QQ,"dummy",1)
> }}}

This seems better. I will do it.

> There are some reasons why using a dedicated dummy ring might be nicer than reusing arbitrary objects for the purpose:
>  - by making global links to arbitrary objects, where the global link has a rather unpredictable lifetime, you're making garbage collection and detection of memory leaks harder.

I don't understand this very well, mainly because I don't have a good sense about the garbage collection and memory leaks problems.

>  - you're making a link to a globally unique object. In principle, you're allowed to do so, but this can have very subtle effects on the system, because it can change the minimal lifetime of all kinds of related objects. So for the sake of sanity in debugging elsewhere, it might be better to not do this.

I don't understand this...

> A pro of your current approach is that you might avoid having to create a dummy ring, thus saving the slight memory penalty for it.

This is not true since a dummy ring is created initially.

A pro of my approach, I think, is reusing the user's "current" ring, thus minimizing switching of the internal Singular (current) ring, which seems a good thing.

As I am not sure about the seriousness of the issues you raised, I will wait for Martin's opinion about this. If the two experts, Martin and you, concern about my approach, then I will adopt your suggestion.


---

Comment by nbruin created at 2015-08-26 03:16:58

Replying to [comment:4 klee]:
> > A pro of your current approach is that you might avoid having to create a dummy ring, thus saving the slight memory penalty for it.
> This is not true since a dummy ring is created initially.

If the first call that arrives does have a ring parameter (the usual circumstance) then doesn't that ring get used? You could just leave `last_ring` uninitialized and only give it your dummy value if the value is required before `last_ring = ring` is executed. But as I discussed, I think there are drawbacks reusing rings of interest to the user for this purpose.

Note, by the way, that we have a `currRingHdl` just above it, which also gets initialized to a dummy value. If we're going to keep a dummy ring around on sage level, we might as well make the singular dummy ring the matching singular ring to that sage dummy ring. That should significantly simplify proper reference counting of that object, if we ever figure out how to properly interface with singular's reference counts (we currently don't).

> A pro of my approach, I think, is reusing the user's "current" ring, thus minimizing switching of the internal Singular (current) ring, which seems a good thing.

Do we check that? In that case you might want to do some timing. Note that most calls will have a ring anyway, so you'll have to search hard for an example where it matters.

> As I am not sure about the seriousness of the issues you raised, I will wait for Martin's opinion about this. If the two experts, Martin and you, concern about my approach, then I will adopt your suggestion. 

Yes, good plan (although I wouldn't call myself an expert on libSingular--I've just seen some truly horrible debugging of memory leaks around it)


---

Comment by git created at 2015-09-04 04:45:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-09-04 04:54:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-09-04 05:00:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2015-09-04 05:07:56

As there is no further comment from Martin, I decided to follow suggestions by `nbruin`. So we use the fixed dummy ring instead of the last used ring. The dummy ring, univariate polynomial ring over `QQ`, is created on the first use.


---

Comment by git created at 2016-03-04 06:16:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2016-03-04 06:23:57

Hmmm. Perhaps I should not have done this. The last commit is to merge Sage 7.1.beta6.


---

Comment by SimonKing created at 2016-04-15 09:01:54

Replying to [ticket:19084 klee]:
> libSingular functions require a ring parameter set. But for some functions the ring parameter is redundant.
> 
> Martin Albrecht answers to this issue:
> 
> We could do this: 
> 
> - if no ring is given, we try to find one as we do currently. 
> - if that fails because the inputs are not polynomials of any kind, we could use a dummy ring.
> 
> We implement this.

I thought I have seen dummy rings in the libsingular code a couple of years ago. So, I am surprised that you say "we implement this". I am not sure, though, whether I will find the time to check the current code.


---

Comment by klee created at 2016-04-15 09:19:07

Replying to [comment:16 SimonKing]:
> I thought I have seen dummy rings in the libsingular code a couple of years ago. 

I don't know. Anyway this seems to be the first implementation. The essential code is quite short. The others are docstring changes.


---

Comment by vbraun created at 2016-04-15 22:01:45

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-04-16 10:25:57

Resolution: fixed
