# Issue 30138: Gather and clean up compiler flags

archive/issues_030138.json:
```json
{
    "body": "CC:  @slel @dimpase\n\nKeywords: compile flags\n\nWe gather and clean up compiler flags. Also we\n\n    add --enable-fat-binary to configure (as an alternative to setting SAGE_FAT_BINARY)\n    add --enable_debug={no|symbols|yes} as alternative to setting SAGE_DEBUG \n\n    compile with -Og -g if SAGE_DEBUG=yes\n    compile with -O2 if SAGE_DEBUG=no (some packages with O3 instead)\n    compile with -O2 -g otherwise (some packages with O3 instead) \n\nDuring the build of sage there are now flags that can be exported in spkg_install.in with one line, instead of checking SAGE_DEBUG etc. for each individual package, e.g. by\n\n    export CFLAGS=$CFLAGS (redundant, use flags as above)\n    export CFLAGS=$CFLAGS_O3 (O3 instead of O2, but only if not in debug mode)\n    export CFLAGS=$ORIGINAL_CFLAGS (use $CFLAGS as set before configure) \n\nLikewise we do with CXXFLAGS, FCFLAGS, F77FLAGS.\n\nWe try to respect the users choice and do not overwrite the flags if already set by the user, but only add compile flags if necessary for packages to work.\n\nInidividual packages can still be compiled with specified flags or in debug mode using\n\nmake CFLAGS=-O2 some-package\n\nor\n\nmake SAGE_DEBUG=\"yes\" some-package\n\nThis ticket prepares #27122, which adds `-march=native` to the defaults.\n\nIssue created by migration from https://trac.sagemath.org/ticket/30375\n\n",
    "created_at": "2020-08-16T07:22:28Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "Gather and clean up compiler flags",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30138",
    "user": "https://github.com/kliem"
}
```
CC:  @slel @dimpase

Keywords: compile flags

We gather and clean up compiler flags. Also we

    add --enable-fat-binary to configure (as an alternative to setting SAGE_FAT_BINARY)
    add --enable_debug={no|symbols|yes} as alternative to setting SAGE_DEBUG 

    compile with -Og -g if SAGE_DEBUG=yes
    compile with -O2 if SAGE_DEBUG=no (some packages with O3 instead)
    compile with -O2 -g otherwise (some packages with O3 instead) 

During the build of sage there are now flags that can be exported in spkg_install.in with one line, instead of checking SAGE_DEBUG etc. for each individual package, e.g. by

    export CFLAGS=$CFLAGS (redundant, use flags as above)
    export CFLAGS=$CFLAGS_O3 (O3 instead of O2, but only if not in debug mode)
    export CFLAGS=$ORIGINAL_CFLAGS (use $CFLAGS as set before configure) 

Likewise we do with CXXFLAGS, FCFLAGS, F77FLAGS.

We try to respect the users choice and do not overwrite the flags if already set by the user, but only add compile flags if necessary for packages to work.

Inidividual packages can still be compiled with specified flags or in debug mode using

make CFLAGS=-O2 some-package

or

make SAGE_DEBUG="yes" some-package

This ticket prepares #27122, which adds `-march=native` to the defaults.

Issue created by migration from https://trac.sagemath.org/ticket/30375





---

archive/issue_comments_428854.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-08-16T07:22:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428854",
    "user": "https://github.com/kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_428855.json:
```json
{
    "body": "One point that probably needs discussion is the following.\n\nWhen an spkg is built, the current design of `sage-spkg` is to create a self-contained script `spkg-install` that sets all necessary environment variables (by sourcing `sage-env` etc.). (This makes it relatively easy to debug the installation process.)\n\nMaking package installs depend on exported environment variables in `Makefile.in` breaks this design.\n\nIt would probably be better to create a new script `sage-build-env` (to complement `sage-build-env-config`) to take care of these environment variable settings.",
    "created_at": "2020-10-15T04:14:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428855",
    "user": "https://github.com/mkoeppe"
}
```

One point that probably needs discussion is the following.

When an spkg is built, the current design of `sage-spkg` is to create a self-contained script `spkg-install` that sets all necessary environment variables (by sourcing `sage-env` etc.). (This makes it relatively easy to debug the installation process.)

Making package installs depend on exported environment variables in `Makefile.in` breaks this design.

It would probably be better to create a new script `sage-build-env` (to complement `sage-build-env-config`) to take care of these environment variable settings.



---

archive/issue_comments_428856.json:
```json
{
    "body": "Ok, I think I'm beginning to understand.\n\nCreate a new file `build/bin/sage-build-env.in` and move the stuff that I added to the makefile there?\n\nThen make sure `build/bin/sage-build-env` is added to the correct places?\n\nWhy should I not add the things to `build/bin/sage-build-env-config` directly?",
    "created_at": "2020-10-16T08:05:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428856",
    "user": "https://github.com/kliem"
}
```

Ok, I think I'm beginning to understand.

Create a new file `build/bin/sage-build-env.in` and move the stuff that I added to the makefile there?

Then make sure `build/bin/sage-build-env` is added to the correct places?

Why should I not add the things to `build/bin/sage-build-env-config` directly?



---

archive/issue_comments_428857.json:
```json
{
    "body": "Replying to [comment:4 gh-kliem]:\n> Create a new file `build/bin/sage-build-env.in` and move the stuff that I added to the makefile there?\n> \n> Then make sure `build/bin/sage-build-env` is added to the correct places?\n\nYes\n\n> Why should I not add the things to `build/bin/sage-build-env-config` directly?\n\nJust a suggestion, to keep the analogy to `src/bin/sage-env` (which implements some logic) and `src/bin/sage-env-config` (which purely sets some variables).  Not very important.",
    "created_at": "2020-10-16T22:32:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428857",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:4 gh-kliem]:
> Create a new file `build/bin/sage-build-env.in` and move the stuff that I added to the makefile there?
> 
> Then make sure `build/bin/sage-build-env` is added to the correct places?

Yes

> Why should I not add the things to `build/bin/sage-build-env-config` directly?

Just a suggestion, to keep the analogy to `src/bin/sage-env` (which implements some logic) and `src/bin/sage-env-config` (which purely sets some variables).  Not very important.



---

archive/issue_comments_428858.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-10-17T10:35:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428858",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_428859.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-10-18T08:59:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428859",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_428860.json:
```json
{
    "body": "I think I have mostly figured it out.\n\nBut it seems that this is no longer applied. If I configure with some `CFLAGS`, it seems that when making still the standard `CFLAGS` are applied. It is consistent with the `CFLAGS` in `sage -sh` at least.",
    "created_at": "2020-10-18T09:02:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428860",
    "user": "https://github.com/kliem"
}
```

I think I have mostly figured it out.

But it seems that this is no longer applied. If I configure with some `CFLAGS`, it seems that when making still the standard `CFLAGS` are applied. It is consistent with the `CFLAGS` in `sage -sh` at least.



---

archive/issue_comments_428861.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-10-18T09:57:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428861",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_428862.json:
```json
{
    "body": "Ok, seems to work now.\n\nAnd in the `sage -buildsh` this thing is run correctly.",
    "created_at": "2020-10-18T09:57:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428862",
    "user": "https://github.com/kliem"
}
```

Ok, seems to work now.

And in the `sage -buildsh` this thing is run correctly.



---

archive/issue_comments_428863.json:
```json
{
    "body": "Looking good; but I think `sage-build-env` would ideally not be a generated file but rather get its settings from `sage-build-env-config`.",
    "created_at": "2020-10-22T21:08:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428863",
    "user": "https://github.com/mkoeppe"
}
```

Looking good; but I think `sage-build-env` would ideally not be a generated file but rather get its settings from `sage-build-env-config`.



---

archive/issue_comments_428864.json:
```json
{
    "body": "(If both are generated, there is really no point in splitting into these two files)",
    "created_at": "2020-10-22T21:08:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428864",
    "user": "https://github.com/mkoeppe"
}
```

(If both are generated, there is really no point in splitting into these two files)



---

archive/issue_comments_428865.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-10-26T13:44:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428865",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_428866.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-10-26T17:09:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428866",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_428867.json:
```json
{
    "body": "Would it not be cleaner if instead of\n\n```\n+# The configured compilation flags.\n+if [ \"x$CFLAGS\" == \"x\" ]; then\n+    export CFLAGS=\"@ORIGINAL_CFLAGS@\"\n+fi\n```\n\nin `build-env-config`, you would unconditionally set a variable `ORIGINAL_CFLAGS`?",
    "created_at": "2020-10-27T02:33:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428867",
    "user": "https://github.com/mkoeppe"
}
```

Would it not be cleaner if instead of

```
+# The configured compilation flags.
+if [ "x$CFLAGS" == "x" ]; then
+    export CFLAGS="@ORIGINAL_CFLAGS@"
+fi
```

in `build-env-config`, you would unconditionally set a variable `ORIGINAL_CFLAGS`?



---

archive/issue_comments_428868.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-10-27T08:23:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428868",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_428869.json:
```json
{
    "body": "I don't understand anything at this point anymore.\n\n- \n\n```\n$ export CFLAGS='-march=native'\n$ export CXXFLAGS='-O1'\n$ ./configure\n$ sage --buildsh\necho $CFLAGS\n-march=native\necho $CXXFLAGS\n-O1\n```\n\n  Okay, this is exactly what we want. But \n\n```\nexport CFLAGS='-march=native'\n./configure CXXFLAGS='-O1'\nsage --buildsh\necho $CFLAGS\n-march=native\necho $CXXFLAGS\n-march=native\n```\n\n  Why? `build/bin/sage-build-env-config` was configured exactly the same. However, if you `echo $CXXFLAGS` at the start of `build/bin/sage-build-env/config`, you see that `CXXFLAGS` was already set to `-march=native`. Were does this come from?\n\n- At the moment I overwrite `CFLAGS` etc. conditionally so that a user may run `make CFLAGS='-Og' <some package>`. `ORIGINAL_CFLAGS` should be the same as this value in this case, shouldn't it (and all other related values as well: `CFLAGS_O3` etc). Any package may choose any such environment variable and append flags, but should never discard flags the user handed in.\n\n  It is really confusing however, that the exported stuff at configure time is called `ORIGINAL_CFLAGS`, as ``@`CFLAGS`@`` already tells us that this is from configure time. I changed that.\n----\nNew commits:",
    "created_at": "2020-10-27T08:24:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428869",
    "user": "https://github.com/kliem"
}
```

I don't understand anything at this point anymore.

- 

```
$ export CFLAGS='-march=native'
$ export CXXFLAGS='-O1'
$ ./configure
$ sage --buildsh
echo $CFLAGS
-march=native
echo $CXXFLAGS
-O1
```

  Okay, this is exactly what we want. But 

```
export CFLAGS='-march=native'
./configure CXXFLAGS='-O1'
sage --buildsh
echo $CFLAGS
-march=native
echo $CXXFLAGS
-march=native
```

  Why? `build/bin/sage-build-env-config` was configured exactly the same. However, if you `echo $CXXFLAGS` at the start of `build/bin/sage-build-env/config`, you see that `CXXFLAGS` was already set to `-march=native`. Were does this come from?

- At the moment I overwrite `CFLAGS` etc. conditionally so that a user may run `make CFLAGS='-Og' <some package>`. `ORIGINAL_CFLAGS` should be the same as this value in this case, shouldn't it (and all other related values as well: `CFLAGS_O3` etc). Any package may choose any such environment variable and append flags, but should never discard flags the user handed in.

  It is really confusing however, that the exported stuff at configure time is called `ORIGINAL_CFLAGS`, as ``@`CFLAGS`@`` already tells us that this is from configure time. I changed that.
----
New commits:



---

archive/issue_comments_428870.json:
```json
{
    "body": "Note that also `sage-env` and `sage-env-config` are sourced.",
    "created_at": "2020-10-27T17:50:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428870",
    "user": "https://github.com/mkoeppe"
}
```

Note that also `sage-env` and `sage-env-config` are sourced.



---

archive/issue_comments_428871.json:
```json
{
    "body": "Shall we try to get this into 9.3...?",
    "created_at": "2020-11-11T17:39:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428871",
    "user": "https://github.com/mkoeppe"
}
```

Shall we try to get this into 9.3...?



---

archive/issue_comments_428872.json:
```json
{
    "body": "Yes, please.\n\nHowever, I might need some help.",
    "created_at": "2020-11-12T07:48:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428872",
    "user": "https://github.com/kliem"
}
```

Yes, please.

However, I might need some help.



---

archive/issue_comments_428873.json:
```json
{
    "body": "A suggestion: \n\nSet similar shell variables in `build/bin/sage-build-env-config.in` that are set in `src/bin/sage-env-config.in`:\n\n```\nCONFIGURED_CC=\"@CC@\"\nCONFIGURED_CXX=\"@CXX@\"\nCONFIGURED_FC=\"@FC@\"\nCONFIGURED_OBJC=\"@OBJC@\"\nCONFIGURED_OBJCXX=\"@OBJCXX@\"\n```\n\nand move all code for modifying environment variables such as CFLAGS to one place, `build/bin/sage-build-env`...",
    "created_at": "2020-11-12T19:14:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428873",
    "user": "https://github.com/mkoeppe"
}
```

A suggestion: 

Set similar shell variables in `build/bin/sage-build-env-config.in` that are set in `src/bin/sage-env-config.in`:

```
CONFIGURED_CC="@CC@"
CONFIGURED_CXX="@CXX@"
CONFIGURED_FC="@FC@"
CONFIGURED_OBJC="@OBJC@"
CONFIGURED_OBJCXX="@OBJCXX@"
```

and move all code for modifying environment variables such as CFLAGS to one place, `build/bin/sage-build-env`...



---

archive/issue_comments_428874.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-13T14:09:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428874",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_428875.json:
```json
{
    "body": "Merged into develop.",
    "created_at": "2020-11-13T14:09:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428875",
    "user": "https://github.com/kliem"
}
```

Merged into develop.



---

archive/issue_comments_428876.json:
```json
{
    "body": "Should I remove the printing of things in `build/pkgs/gcc/spkg-configure.m4`.\n\nThe only thing that really needs to done there, is to check whether `-march=native` is supported in general (not this ticket). Everything else we redo later anyway.",
    "created_at": "2020-11-13T14:11:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428876",
    "user": "https://github.com/kliem"
}
```

Should I remove the printing of things in `build/pkgs/gcc/spkg-configure.m4`.

The only thing that really needs to done there, is to check whether `-march=native` is supported in general (not this ticket). Everything else we redo later anyway.



---

archive/issue_comments_428877.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-13T14:31:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428877",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_428878.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-13T14:35:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428878",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_428879.json:
```json
{
    "body": "Replying to [comment:24 gh-kliem]:\n> Should I remove the printing of things in `build/pkgs/gcc/spkg-configure.m4`.\n> \n> The only thing that really needs to done there, is to check whether `-march=native` is supported in general (not this ticket). Everything else we redo later anyway.\n\nOk, I just went ahead an did this. It's a lot simpler now. Almost everything is at one place.\n`configure.ac` needs to save the flags and `build/bin/sage-build-env-config.in` picks them up again as `CONFIGURED_CFLAGS` etc.",
    "created_at": "2020-11-13T14:37:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428879",
    "user": "https://github.com/kliem"
}
```

Replying to [comment:24 gh-kliem]:
> Should I remove the printing of things in `build/pkgs/gcc/spkg-configure.m4`.
> 
> The only thing that really needs to done there, is to check whether `-march=native` is supported in general (not this ticket). Everything else we redo later anyway.

Ok, I just went ahead an did this. It's a lot simpler now. Almost everything is at one place.
`configure.ac` needs to save the flags and `build/bin/sage-build-env-config.in` picks them up again as `CONFIGURED_CFLAGS` etc.



---

archive/issue_comments_428880.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-11-29T22:26:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428880",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_428881.json:
```json
{
    "body": "This looks great but I think you'll need to modify `build/bin/sage-spkg` as well so that the install scripts for normal packages source `sage-build-env`.",
    "created_at": "2020-11-29T22:26:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428881",
    "user": "https://github.com/mkoeppe"
}
```

This looks great but I think you'll need to modify `build/bin/sage-spkg` as well so that the install scripts for normal packages source `sage-build-env`.



---

archive/issue_comments_428882.json:
```json
{
    "body": "Also, in `sage-build-env`, remove spaces around `=` in `export` -- this is not valid shell syntax",
    "created_at": "2020-11-29T22:57:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428882",
    "user": "https://github.com/mkoeppe"
}
```

Also, in `sage-build-env`, remove spaces around `=` in `export` -- this is not valid shell syntax



---

archive/issue_comments_428883.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-30T08:06:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428883",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_428884.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-30T08:24:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428884",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_428885.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-30T08:30:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428885",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_428886.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-11-30T08:30:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428886",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_428887.json:
```json
{
    "body": "`sage-build-env` and `sage-build-env-config` are in `build/bin`, not `src/bin`. They should not be listed in `src/setup.py`, `build/pkgs/sagelib/src/setup.py`.",
    "created_at": "2020-11-30T16:44:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428887",
    "user": "https://github.com/mkoeppe"
}
```

`sage-build-env` and `sage-build-env-config` are in `build/bin`, not `src/bin`. They should not be listed in `src/setup.py`, `build/pkgs/sagelib/src/setup.py`.



---

archive/issue_comments_428888.json:
```json
{
    "body": "Also the comments in `build/make/Makefile.in` introduce the wrong path - it should be build/bin",
    "created_at": "2020-11-30T16:45:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428888",
    "user": "https://github.com/mkoeppe"
}
```

Also the comments in `build/make/Makefile.in` introduce the wrong path - it should be build/bin



---

archive/issue_comments_428889.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-11-30T16:45:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428889",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_428890.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-30T17:01:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428890",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_428891.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-30T17:04:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428891",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_428892.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-11-30T17:04:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428892",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_428893.json:
```json
{
    "body": "Sorry, I got confused.\n----\nNew commits:",
    "created_at": "2020-11-30T17:04:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428893",
    "user": "https://github.com/kliem"
}
```

Sorry, I got confused.
----
New commits:



---

archive/issue_comments_428894.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-11-30T22:31:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428894",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_428895.json:
```json
{
    "body": "This seems to work well.\n\nLet's get this merged for wider testing by developers.",
    "created_at": "2020-11-30T22:31:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428895",
    "user": "https://github.com/mkoeppe"
}
```

This seems to work well.

Let's get this merged for wider testing by developers.



---

archive/issue_comments_428896.json:
```json
{
    "body": "Thank you.",
    "created_at": "2020-12-01T07:01:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428896",
    "user": "https://github.com/kliem"
}
```

Thank you.



---

archive/issue_comments_428897.json:
```json
{
    "body": "One thing is actually strange.\n\nI guess the `gfortran` or something else sets the default `FCFLAGS` to ` -ffree-form`.\n\nI didn't consider this, so efficiently `-O2 -g` isn't added anymore.",
    "created_at": "2020-12-03T10:17:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428897",
    "user": "https://github.com/kliem"
}
```

One thing is actually strange.

I guess the `gfortran` or something else sets the default `FCFLAGS` to ` -ffree-form`.

I didn't consider this, so efficiently `-O2 -g` isn't added anymore.



---

archive/issue_comments_428898.json:
```json
{
    "body": "Replying to [comment:42 gh-kliem]:\n> One thing is actually strange.\n> \n> I guess the `gfortran` or something else sets the default `FCFLAGS` to ` -ffree-form`.\n> \n> I didn't consider this, so efficiently `-O2 -g` isn't added anymore.\n\nAnyway, I fixed that in #27122, but can also fix it here, if that makes sense.",
    "created_at": "2020-12-03T10:32:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428898",
    "user": "https://github.com/kliem"
}
```

Replying to [comment:42 gh-kliem]:
> One thing is actually strange.
> 
> I guess the `gfortran` or something else sets the default `FCFLAGS` to ` -ffree-form`.
> 
> I didn't consider this, so efficiently `-O2 -g` isn't added anymore.

Anyway, I fixed that in #27122, but can also fix it here, if that makes sense.



---

archive/issue_comments_428899.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-12-03T16:30:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428899",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_428900.json:
```json
{
    "body": "Best to fix it here already",
    "created_at": "2020-12-03T16:30:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428900",
    "user": "https://github.com/mkoeppe"
}
```

Best to fix it here already



---

archive/issue_comments_428901.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-03T17:51:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428901",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_428902.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-12-03T17:51:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428902",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_428903.json:
```json
{
    "body": "I'm not sure if I like this fix...",
    "created_at": "2020-12-03T18:05:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428903",
    "user": "https://github.com/mkoeppe"
}
```

I'm not sure if I like this fix...



---

archive/issue_comments_428904.json:
```json
{
    "body": "It works. But it's probably not perfect.\n\nIt appears that this is set by the gfortran configure. It is definitely in the compiled configure \n\n\n```\nfor ac_flag in none -ffree-form -FR -free -qfree -Mfree -Mfreeform\n```\n\n\nI suppose that is enforced by `AC_FC_FREEFORM` and will end up adding something to `FCFLAGS`.",
    "created_at": "2020-12-03T18:13:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428904",
    "user": "https://github.com/kliem"
}
```

It works. But it's probably not perfect.

It appears that this is set by the gfortran configure. It is definitely in the compiled configure 


```
for ac_flag in none -ffree-form -FR -free -qfree -Mfree -Mfreeform
```


I suppose that is enforced by `AC_FC_FREEFORM` and will end up adding something to `FCFLAGS`.



---

archive/issue_comments_428905.json:
```json
{
    "body": "I agree, that this solution changes behavior.\n\nCalling `AC_FC_FREEFORM` appends ` -ffree-form`. I don't know why. Do we want this or is this just for testing and we really should call `AC_SUBST(FCFLAGS)` before this?",
    "created_at": "2020-12-03T18:16:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428905",
    "user": "https://github.com/kliem"
}
```

I agree, that this solution changes behavior.

Calling `AC_FC_FREEFORM` appends ` -ffree-form`. I don't know why. Do we want this or is this just for testing and we really should call `AC_SUBST(FCFLAGS)` before this?



---

archive/issue_comments_428906.json:
```json
{
    "body": "I think we shouldn't pass on the `FCFLAGS` discovered by this to avoid subtle change of behavior. The individual packages are in charge of figuring out the flags that they need for the Fortran compiler.\n\nSo I think it's best to save and restore the flags around the spkg-configure code",
    "created_at": "2020-12-03T18:29:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428906",
    "user": "https://github.com/mkoeppe"
}
```

I think we shouldn't pass on the `FCFLAGS` discovered by this to avoid subtle change of behavior. The individual packages are in charge of figuring out the flags that they need for the Fortran compiler.

So I think it's best to save and restore the flags around the spkg-configure code



---

archive/issue_comments_428907.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-03T18:35:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428907",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_428908.json:
```json
{
    "body": "Actually, replacing `AC_SUBST(FCFLAGS, \"$FCFLAGS\")` by `AC_SUBST(CONFIGURED_FCFLAGS, \"$FCFLAGS\")`, does the job.\n\nApparently this is somewhat split into two. First we set `FCFLAGS=$FLAGS` and later the substitution is triggered. So any changes that are applied later to `FCFLAGS` will still have an effect, but not if we change the name.\n\nNow that apparently the `gfortran` configure changes `FCLFAGS` is a different story.",
    "created_at": "2020-12-03T18:39:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428908",
    "user": "https://github.com/kliem"
}
```

Actually, replacing `AC_SUBST(FCFLAGS, "$FCFLAGS")` by `AC_SUBST(CONFIGURED_FCFLAGS, "$FCFLAGS")`, does the job.

Apparently this is somewhat split into two. First we set `FCFLAGS=$FLAGS` and later the substitution is triggered. So any changes that are applied later to `FCFLAGS` will still have an effect, but not if we change the name.

Now that apparently the `gfortran` configure changes `FCLFAGS` is a different story.



---

archive/issue_comments_428909.json:
```json
{
    "body": "Note that `FCFLAGS` is automatically `AC_SUBST`'ed as well:\n\n```\n$ grep FCFLAGS config.status\nac_cs_config=\"'PKG_CONFIG_PATH=/usr/local/opt/zlib/lib/pkgconfig:/usr/local/opt/sqlite/lib/pkgconfig:/usr/local/opt/readline/lib/pkgconfig:/usr/local/opt/openssl/lib/pkgconfig:/usr/local/opt/openblas/lib/pkgconfig:/usr/local/lib/pkgconfig:' 'FCFLAGS=-g -g -g'\"\n  set X /bin/sh './configure'  'PKG_CONFIG_PATH=/usr/local/opt/zlib/lib/pkgconfig:/usr/local/opt/sqlite/lib/pkgconfig:/usr/local/opt/readline/lib/pkgconfig:/usr/local/opt/openssl/lib/pkgconfig:/usr/local/opt/openblas/lib/pkgconfig:/usr/local/lib/pkgconfig:' 'FCFLAGS=-g -g -g' $ac_configure_extra_args --no-create --no-recursion\nS[\"FCFLAGS\"]=\"-g -g -g -ffree-form\"\nS[\"CONFIGURED_FCFLAGS\"]=\"-g -g -g\"\n```\n\nI would much prefer the solution using save/restore of flags instead of introducing a new substitution variable. This would keep things closer to automake.",
    "created_at": "2020-12-03T19:10:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428909",
    "user": "https://github.com/mkoeppe"
}
```

Note that `FCFLAGS` is automatically `AC_SUBST`'ed as well:

```
$ grep FCFLAGS config.status
ac_cs_config="'PKG_CONFIG_PATH=/usr/local/opt/zlib/lib/pkgconfig:/usr/local/opt/sqlite/lib/pkgconfig:/usr/local/opt/readline/lib/pkgconfig:/usr/local/opt/openssl/lib/pkgconfig:/usr/local/opt/openblas/lib/pkgconfig:/usr/local/lib/pkgconfig:' 'FCFLAGS=-g -g -g'"
  set X /bin/sh './configure'  'PKG_CONFIG_PATH=/usr/local/opt/zlib/lib/pkgconfig:/usr/local/opt/sqlite/lib/pkgconfig:/usr/local/opt/readline/lib/pkgconfig:/usr/local/opt/openssl/lib/pkgconfig:/usr/local/opt/openblas/lib/pkgconfig:/usr/local/lib/pkgconfig:' 'FCFLAGS=-g -g -g' $ac_configure_extra_args --no-create --no-recursion
S["FCFLAGS"]="-g -g -g -ffree-form"
S["CONFIGURED_FCFLAGS"]="-g -g -g"
```

I would much prefer the solution using save/restore of flags instead of introducing a new substitution variable. This would keep things closer to automake.



---

archive/issue_comments_428910.json:
```json
{
    "body": "From https://www.gnu.org/software/autoconf/manual/autoconf-2.66/html_node/Fortran-Compiler.html\n\n> The AC_FC_FREEFORM tries to ensure that the Fortran compiler ($FC) allows free-format source code (as opposed to the older fixed-format style from Fortran 77). If necessary, it may add some additional flags to FCFLAGS. \n\nSo, `AC_FC_FREEFORM` has added ` -ffree-form` to my flags, because it feels that this is needed. So I think, we should either respect that or not call `AC_FC_FREEFORM`.\n\nIf we want to respect this (starting with this ticket), what do you think would be the best way? Somehow I must store that `FCFLAGS` wasn't set by the user and I may add our defaults to this.",
    "created_at": "2020-12-03T19:24:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428910",
    "user": "https://github.com/kliem"
}
```

From https://www.gnu.org/software/autoconf/manual/autoconf-2.66/html_node/Fortran-Compiler.html

> The AC_FC_FREEFORM tries to ensure that the Fortran compiler ($FC) allows free-format source code (as opposed to the older fixed-format style from Fortran 77). If necessary, it may add some additional flags to FCFLAGS. 

So, `AC_FC_FREEFORM` has added ` -ffree-form` to my flags, because it feels that this is needed. So I think, we should either respect that or not call `AC_FC_FREEFORM`.

If we want to respect this (starting with this ticket), what do you think would be the best way? Somehow I must store that `FCFLAGS` wasn't set by the user and I may add our defaults to this.



---

archive/issue_comments_428911.json:
```json
{
    "body": "Replying to [comment:54 gh-kliem]:\n> From https://www.gnu.org/software/autoconf/manual/autoconf-2.66/html_node/Fortran-Compiler.html\n> \n> > The AC_FC_FREEFORM tries to ensure that the Fortran compiler ($FC) allows free-format source code (as opposed to the older fixed-format style from Fortran 77). If necessary, it may add some additional flags to FCFLAGS. \n> \n> So, `AC_FC_FREEFORM` has added ` -ffree-form` to my flags, because it feels that this is needed. So I think, we should either respect that or not call `AC_FC_FREEFORM`.\n\nWe run this to find out whether the configured Fortran compiler has a free form mode.\n\nWe do this for our decision whether we have to install gfortran or not.\n\nBut it must be up to the individual packages how they invoke the Fortran compiler.",
    "created_at": "2020-12-03T19:27:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428911",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:54 gh-kliem]:
> From https://www.gnu.org/software/autoconf/manual/autoconf-2.66/html_node/Fortran-Compiler.html
> 
> > The AC_FC_FREEFORM tries to ensure that the Fortran compiler ($FC) allows free-format source code (as opposed to the older fixed-format style from Fortran 77). If necessary, it may add some additional flags to FCFLAGS. 
> 
> So, `AC_FC_FREEFORM` has added ` -ffree-form` to my flags, because it feels that this is needed. So I think, we should either respect that or not call `AC_FC_FREEFORM`.

We run this to find out whether the configured Fortran compiler has a free form mode.

We do this for our decision whether we have to install gfortran or not.

But it must be up to the individual packages how they invoke the Fortran compiler.



---

archive/issue_comments_428912.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-03T20:05:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428912",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_428913.json:
```json
{
    "body": "Ok. I'm storing and restoring the `FCFLAGS` during gfortran configure now.\nDefining a macro was the only way, I could enforce the order. But maybe there is a better way of doing this.",
    "created_at": "2020-12-03T20:07:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428913",
    "user": "https://github.com/kliem"
}
```

Ok. I'm storing and restoring the `FCFLAGS` during gfortran configure now.
Defining a macro was the only way, I could enforce the order. But maybe there is a better way of doing this.



---

archive/issue_comments_428914.json:
```json
{
    "body": "That's fine, yes, `AC_FC_FREEFORM` is executed out of order.\n\nThese lines:\n\n```\n+    sage_saved_fcflags=$FCFLAGS\n+    FCFLAGS=$sage_saved_fcflags\n```\n\nneed quoting around the assigned value.",
    "created_at": "2020-12-03T22:19:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428914",
    "user": "https://github.com/mkoeppe"
}
```

That's fine, yes, `AC_FC_FREEFORM` is executed out of order.

These lines:

```
+    sage_saved_fcflags=$FCFLAGS
+    FCFLAGS=$sage_saved_fcflags
```

need quoting around the assigned value.



---

archive/issue_comments_428915.json:
```json
{
    "body": "Also these macro calls are better without the use of the second argument (look at the generated shell code)\n\n```\n+# Save compiler flags as configured by the user.\n+AC_SUBST(CFLAGS, \"$CFLAGS\")\n+AC_SUBST(CXXFLAGS, \"$CXXFLAGS\")\n+AC_SUBST(FCFLAGS, \"$FCFLAGS\")\n+AC_SUBST(F77FLAGS, \"$F77FLAGS\")\n```\n",
    "created_at": "2020-12-03T22:20:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428915",
    "user": "https://github.com/mkoeppe"
}
```

Also these macro calls are better without the use of the second argument (look at the generated shell code)

```
+# Save compiler flags as configured by the user.
+AC_SUBST(CFLAGS, "$CFLAGS")
+AC_SUBST(CXXFLAGS, "$CXXFLAGS")
+AC_SUBST(FCFLAGS, "$FCFLAGS")
+AC_SUBST(F77FLAGS, "$F77FLAGS")
```




---

archive/issue_comments_428916.json:
```json
{
    "body": "Replying to [comment:59 mkoeppe]:\n> Also these macro calls are better without the use of the second argument (look at the generated shell code)\n> {{{\n> +# Save compiler flags as configured by the user.\n> +AC_SUBST(CFLAGS, \"$CFLAGS\")\n> +AC_SUBST(CXXFLAGS, \"$CXXFLAGS\")\n> +AC_SUBST(FCFLAGS, \"$FCFLAGS\")\n> +AC_SUBST(F77FLAGS, \"$F77FLAGS\")\n> }}}\n\nYour proposed change does not work. `AC_PROG_CC()` changes the value of `CFLAGS` if not set. `AC_SUBST(CFLAGS, \"$CFLAGS\")` will implicitly set `CFLAGS` (even though possibly to the empty value), but prevents `AC_PROG_CC` from messing with it.",
    "created_at": "2020-12-04T07:33:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428916",
    "user": "https://github.com/kliem"
}
```

Replying to [comment:59 mkoeppe]:
> Also these macro calls are better without the use of the second argument (look at the generated shell code)
> {{{
> +# Save compiler flags as configured by the user.
> +AC_SUBST(CFLAGS, "$CFLAGS")
> +AC_SUBST(CXXFLAGS, "$CXXFLAGS")
> +AC_SUBST(FCFLAGS, "$FCFLAGS")
> +AC_SUBST(F77FLAGS, "$F77FLAGS")
> }}}

Your proposed change does not work. `AC_PROG_CC()` changes the value of `CFLAGS` if not set. `AC_SUBST(CFLAGS, "$CFLAGS")` will implicitly set `CFLAGS` (even though possibly to the empty value), but prevents `AC_PROG_CC` from messing with it.



---

archive/issue_comments_428917.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-04T07:34:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428917",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_428918.json:
```json
{
    "body": "Replying to [comment:60 gh-kliem]:\n> Replying to [comment:59 mkoeppe]:\n> > Also these macro calls are better without the use of the second argument (look at the generated shell code)\n> > {{{\n> > +# Save compiler flags as configured by the user.\n> > +AC_SUBST(CFLAGS, \"$CFLAGS\")\n> > +AC_SUBST(CXXFLAGS, \"$CXXFLAGS\")\n> > +AC_SUBST(FCFLAGS, \"$FCFLAGS\")\n> > +AC_SUBST(F77FLAGS, \"$F77FLAGS\")\n> > }}}\n> \n> Your proposed change does not work. `AC_PROG_CC()` changes the value of `CFLAGS` if not set. `AC_SUBST(CFLAGS, \"$CFLAGS\")` will implicitly set `CFLAGS` (even though possibly to the empty value), but prevents `AC_PROG_CC` from messing with it.\n\nI could deal with it the same way, I did with the `FCFLAGS` and save all of those flags beforehand. Maybe that is cleaner.",
    "created_at": "2020-12-04T07:37:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428918",
    "user": "https://github.com/kliem"
}
```

Replying to [comment:60 gh-kliem]:
> Replying to [comment:59 mkoeppe]:
> > Also these macro calls are better without the use of the second argument (look at the generated shell code)
> > {{{
> > +# Save compiler flags as configured by the user.
> > +AC_SUBST(CFLAGS, "$CFLAGS")
> > +AC_SUBST(CXXFLAGS, "$CXXFLAGS")
> > +AC_SUBST(FCFLAGS, "$FCFLAGS")
> > +AC_SUBST(F77FLAGS, "$F77FLAGS")
> > }}}
> 
> Your proposed change does not work. `AC_PROG_CC()` changes the value of `CFLAGS` if not set. `AC_SUBST(CFLAGS, "$CFLAGS")` will implicitly set `CFLAGS` (even though possibly to the empty value), but prevents `AC_PROG_CC` from messing with it.

I could deal with it the same way, I did with the `FCFLAGS` and save all of those flags beforehand. Maybe that is cleaner.



---

archive/issue_comments_428919.json:
```json
{
    "body": "Maybe we can take care of this.",
    "created_at": "2020-12-06T18:39:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428919",
    "user": "https://github.com/kliem"
}
```

Maybe we can take care of this.



---

archive/issue_comments_428920.json:
```json
{
    "body": "Changing keywords from \"compile flags\" to \"compile flags, sd111\".",
    "created_at": "2020-12-06T18:39:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428920",
    "user": "https://github.com/kliem"
}
```

Changing keywords from "compile flags" to "compile flags, sd111".



---

archive/issue_comments_428921.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-12-09T21:12:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428921",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_428922.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-10T08:18:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428922",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_428923.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-12-10T08:20:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428923",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_428924.json:
```json
{
    "body": "Ok, at least it is prepared for precious variables.\n\n#29507 would have to take care of using this.",
    "created_at": "2020-12-10T08:20:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428924",
    "user": "https://github.com/kliem"
}
```

Ok, at least it is prepared for precious variables.

#29507 would have to take care of using this.



---

archive/issue_comments_428925.json:
```json
{
    "body": "Actually, it kind of works.\n\nDuring make, reconfiguration will be done using `./config.status` and this one does not alter the variables.",
    "created_at": "2020-12-10T08:33:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428925",
    "user": "https://github.com/kliem"
}
```

Actually, it kind of works.

During make, reconfiguration will be done using `./config.status` and this one does not alter the variables.



---

archive/issue_comments_428926.json:
```json
{
    "body": "Looking great, let's get this in.",
    "created_at": "2020-12-11T03:02:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428926",
    "user": "https://github.com/mkoeppe"
}
```

Looking great, let's get this in.



---

archive/issue_comments_428927.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-12-11T03:02:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428927",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_428928.json:
```json
{
    "body": "Thanks again.",
    "created_at": "2020-12-11T07:02:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428928",
    "user": "https://github.com/kliem"
}
```

Thanks again.



---

archive/issue_events_027716.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-12-13T20:30:47Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30138#event-27716"
}
```



---

archive/issue_comments_428929.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-12-13T20:30:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30138",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30138#issuecomment-428929",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
