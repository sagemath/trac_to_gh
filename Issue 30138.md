# Issue 30138: Gather and clean up compiler flags

Issue created by migration from https://trac.sagemath.org/ticket/30375

Original creator: @kliem

Original creation time: 2020-08-16 07:22:28

CC:  slelievre dimpase

Keywords: compile flags

We gather and clean up compiler flags. Also we

    add --enable-fat-binary to configure (as an alternative to setting SAGE_FAT_BINARY)
    add --enable_debug={no|symbols|yes} as alternative to setting SAGE_DEBUG 

    compile with -Og -g if SAGE_DEBUG=yes
    compile with -O2 if SAGE_DEBUG=no (some packages with O3 instead)
    compile with -O2 -g otherwise (some packages with O3 instead) 

During the build of sage there are now flags that can be exported in spkg_install.in with one line, instead of checking SAGE_DEBUG etc. for each individual package, e.g. by

    export CFLAGS=$CFLAGS (redundant, use flags as above)
    export CFLAGS=$CFLAGS_O3 (O3 instead of O2, but only if not in debug mode)
    export CFLAGS=$ORIGINAL_CFLAGS (use $CFLAGS as set before configure) 

Likewise we do with CXXFLAGS, FCFLAGS, F77FLAGS.

We try to respect the users choice and do not overwrite the flags if already set by the user, but only add compile flags if necessary for packages to work.

Inidividual packages can still be compiled with specified flags or in debug mode using

make CFLAGS=-O2 some-package

or

make SAGE_DEBUG="yes" some-package

This ticket prepares #27122, which adds `-march=native` to the defaults.


---

Comment by @kliem created at 2020-08-16 07:22:41

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-10-15 04:14:17

One point that probably needs discussion is the following.

When an spkg is built, the current design of `sage-spkg` is to create a self-contained script `spkg-install` that sets all necessary environment variables (by sourcing `sage-env` etc.). (This makes it relatively easy to debug the installation process.)

Making package installs depend on exported environment variables in `Makefile.in` breaks this design.

It would probably be better to create a new script `sage-build-env` (to complement `sage-build-env-config`) to take care of these environment variable settings.


---

Comment by @kliem created at 2020-10-16 08:05:15

Ok, I think I'm beginning to understand.

Create a new file `build/bin/sage-build-env.in` and move the stuff that I added to the makefile there?

Then make sure `build/bin/sage-build-env` is added to the correct places?

Why should I not add the things to `build/bin/sage-build-env-config` directly?


---

Comment by mkoeppe created at 2020-10-16 22:32:52

Replying to [comment:4 gh-kliem]:
> Create a new file `build/bin/sage-build-env.in` and move the stuff that I added to the makefile there?
> 
> Then make sure `build/bin/sage-build-env` is added to the correct places?

Yes

> Why should I not add the things to `build/bin/sage-build-env-config` directly?

Just a suggestion, to keep the analogy to `src/bin/sage-env` (which implements some logic) and `src/bin/sage-env-config` (which purely sets some variables).  Not very important.


---

Comment by git created at 2020-10-17 10:35:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-10-18 08:59:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-10-18 09:02:23

I think I have mostly figured it out.

But it seems that this is no longer applied. If I configure with some `CFLAGS`, it seems that when making still the standard `CFLAGS` are applied. It is consistent with the `CFLAGS` in `sage -sh` at least.


---

Comment by git created at 2020-10-18 09:57:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-10-18 09:57:54

Ok, seems to work now.

And in the `sage -buildsh` this thing is run correctly.


---

Comment by mkoeppe created at 2020-10-22 21:08:04

Looking good; but I think `sage-build-env` would ideally not be a generated file but rather get its settings from `sage-build-env-config`.


---

Comment by mkoeppe created at 2020-10-22 21:08:43

(If both are generated, there is really no point in splitting into these two files)


---

Comment by git created at 2020-10-26 13:44:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-10-26 17:09:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-10-27 02:33:38

Would it not be cleaner if instead of

```
+# The configured compilation flags.
+if [ "x$CFLAGS" == "x" ]; then
+    export CFLAGS="@ORIGINAL_CFLAGS@"
+fi
```

in `build-env-config`, you would unconditionally set a variable `ORIGINAL_CFLAGS`?


---

Comment by git created at 2020-10-27 08:23:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-10-27 08:24:56

I don't understand anything at this point anymore.

- 

```
$ export CFLAGS='-march=native'
$ export CXXFLAGS='-O1'
$ ./configure
$ sage --buildsh
echo $CFLAGS
-march=native
echo $CXXFLAGS
-O1
```

  Okay, this is exactly what we want. But 

```
export CFLAGS='-march=native'
./configure CXXFLAGS='-O1'
sage --buildsh
echo $CFLAGS
-march=native
echo $CXXFLAGS
-march=native
```

  Why? `build/bin/sage-build-env-config` was configured exactly the same. However, if you `echo $CXXFLAGS` at the start of `build/bin/sage-build-env/config`, you see that `CXXFLAGS` was already set to `-march=native`. Were does this come from?

- At the moment I overwrite `CFLAGS` etc. conditionally so that a user may run `make CFLAGS='-Og' <some package>`. `ORIGINAL_CFLAGS` should be the same as this value in this case, shouldn't it (and all other related values as well: `CFLAGS_O3` etc). Any package may choose any such environment variable and append flags, but should never discard flags the user handed in.

  It is really confusing however, that the exported stuff at configure time is called `ORIGINAL_CFLAGS`, as ``@`CFLAGS`@`` already tells us that this is from configure time. I changed that.
----
New commits:


---

Comment by mkoeppe created at 2020-10-27 17:50:46

Note that also `sage-env` and `sage-env-config` are sourced.


---

Comment by mkoeppe created at 2020-11-11 17:39:51

Shall we try to get this into 9.3...?


---

Comment by @kliem created at 2020-11-12 07:48:00

Yes, please.

However, I might need some help.


---

Comment by mkoeppe created at 2020-11-12 19:14:13

A suggestion: 

Set similar shell variables in `build/bin/sage-build-env-config.in` that are set in `src/bin/sage-env-config.in`:

```
CONFIGURED_CC="@CC@"
CONFIGURED_CXX="@CXX@"
CONFIGURED_FC="@FC@"
CONFIGURED_OBJC="@OBJC@"
CONFIGURED_OBJCXX="@OBJCXX@"
```

and move all code for modifying environment variables such as CFLAGS to one place, `build/bin/sage-build-env`...


---

Comment by git created at 2020-11-13 14:09:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-11-13 14:09:46

Merged into develop.


---

Comment by @kliem created at 2020-11-13 14:11:31

Should I remove the printing of things in `build/pkgs/gcc/spkg-configure.m4`.

The only thing that really needs to done there, is to check whether `-march=native` is supported in general (not this ticket). Everything else we redo later anyway.


---

Comment by git created at 2020-11-13 14:31:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-11-13 14:35:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-11-13 14:37:40

Replying to [comment:24 gh-kliem]:
> Should I remove the printing of things in `build/pkgs/gcc/spkg-configure.m4`.
> 
> The only thing that really needs to done there, is to check whether `-march=native` is supported in general (not this ticket). Everything else we redo later anyway.

Ok, I just went ahead an did this. It's a lot simpler now. Almost everything is at one place.
`configure.ac` needs to save the flags and `build/bin/sage-build-env-config.in` picks them up again as `CONFIGURED_CFLAGS` etc.


---

Comment by mkoeppe created at 2020-11-29 22:26:03

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-11-29 22:26:03

This looks great but I think you'll need to modify `build/bin/sage-spkg` as well so that the install scripts for normal packages source `sage-build-env`.


---

Comment by mkoeppe created at 2020-11-29 22:57:40

Also, in `sage-build-env`, remove spaces around `=` in `export` -- this is not valid shell syntax


---

Comment by git created at 2020-11-30 08:06:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-11-30 08:24:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-11-30 08:30:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-11-30 08:30:22

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-11-30 16:44:49

`sage-build-env` and `sage-build-env-config` are in `build/bin`, not `src/bin`. They should not be listed in `src/setup.py`, `build/pkgs/sagelib/src/setup.py`.


---

Comment by mkoeppe created at 2020-11-30 16:45:48

Also the comments in `build/make/Makefile.in` introduce the wrong path - it should be build/bin


---

Comment by mkoeppe created at 2020-11-30 16:45:53

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-11-30 17:01:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-11-30 17:04:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-11-30 17:04:54

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2020-11-30 17:04:54

Sorry, I got confused.
----
New commits:


---

Comment by mkoeppe created at 2020-11-30 22:31:15

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-11-30 22:31:15

This seems to work well.

Let's get this merged for wider testing by developers.


---

Comment by @kliem created at 2020-12-01 07:01:37

Thank you.


---

Comment by @kliem created at 2020-12-03 10:17:57

One thing is actually strange.

I guess the `gfortran` or something else sets the default `FCFLAGS` to ` -ffree-form`.

I didn't consider this, so efficiently `-O2 -g` isn't added anymore.


---

Comment by @kliem created at 2020-12-03 10:32:45

Replying to [comment:42 gh-kliem]:
> One thing is actually strange.
> 
> I guess the `gfortran` or something else sets the default `FCFLAGS` to ` -ffree-form`.
> 
> I didn't consider this, so efficiently `-O2 -g` isn't added anymore.

Anyway, I fixed that in #27122, but can also fix it here, if that makes sense.


---

Comment by mkoeppe created at 2020-12-03 16:30:17

Changing status from positive_review to needs_work.


---

Comment by mkoeppe created at 2020-12-03 16:30:17

Best to fix it here already


---

Comment by git created at 2020-12-03 17:51:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-12-03 17:51:48

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-12-03 18:05:06

I'm not sure if I like this fix...


---

Comment by @kliem created at 2020-12-03 18:13:02

It works. But it's probably not perfect.

It appears that this is set by the gfortran configure. It is definitely in the compiled configure 


```
for ac_flag in none -ffree-form -FR -free -qfree -Mfree -Mfreeform
```


I suppose that is enforced by `AC_FC_FREEFORM` and will end up adding something to `FCFLAGS`.


---

Comment by @kliem created at 2020-12-03 18:16:19

I agree, that this solution changes behavior.

Calling `AC_FC_FREEFORM` appends ` -ffree-form`. I don't know why. Do we want this or is this just for testing and we really should call `AC_SUBST(FCFLAGS)` before this?


---

Comment by mkoeppe created at 2020-12-03 18:29:33

I think we shouldn't pass on the `FCFLAGS` discovered by this to avoid subtle change of behavior. The individual packages are in charge of figuring out the flags that they need for the Fortran compiler.

So I think it's best to save and restore the flags around the spkg-configure code


---

Comment by git created at 2020-12-03 18:35:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-12-03 18:39:13

Actually, replacing `AC_SUBST(FCFLAGS, "$FCFLAGS")` by `AC_SUBST(CONFIGURED_FCFLAGS, "$FCFLAGS")`, does the job.

Apparently this is somewhat split into two. First we set `FCFLAGS=$FLAGS` and later the substitution is triggered. So any changes that are applied later to `FCFLAGS` will still have an effect, but not if we change the name.

Now that apparently the `gfortran` configure changes `FCLFAGS` is a different story.


---

Comment by mkoeppe created at 2020-12-03 19:10:34

Note that `FCFLAGS` is automatically `AC_SUBST`'ed as well:

```
$ grep FCFLAGS config.status
ac_cs_config="'PKG_CONFIG_PATH=/usr/local/opt/zlib/lib/pkgconfig:/usr/local/opt/sqlite/lib/pkgconfig:/usr/local/opt/readline/lib/pkgconfig:/usr/local/opt/openssl/lib/pkgconfig:/usr/local/opt/openblas/lib/pkgconfig:/usr/local/lib/pkgconfig:' 'FCFLAGS=-g -g -g'"
  set X /bin/sh './configure'  'PKG_CONFIG_PATH=/usr/local/opt/zlib/lib/pkgconfig:/usr/local/opt/sqlite/lib/pkgconfig:/usr/local/opt/readline/lib/pkgconfig:/usr/local/opt/openssl/lib/pkgconfig:/usr/local/opt/openblas/lib/pkgconfig:/usr/local/lib/pkgconfig:' 'FCFLAGS=-g -g -g' $ac_configure_extra_args --no-create --no-recursion
S["FCFLAGS"]="-g -g -g -ffree-form"
S["CONFIGURED_FCFLAGS"]="-g -g -g"
```

I would much prefer the solution using save/restore of flags instead of introducing a new substitution variable. This would keep things closer to automake.


---

Comment by @kliem created at 2020-12-03 19:24:21

From https://www.gnu.org/software/autoconf/manual/autoconf-2.66/html_node/Fortran-Compiler.html

> The AC_FC_FREEFORM tries to ensure that the Fortran compiler ($FC) allows free-format source code (as opposed to the older fixed-format style from Fortran 77). If necessary, it may add some additional flags to FCFLAGS. 

So, `AC_FC_FREEFORM` has added ` -ffree-form` to my flags, because it feels that this is needed. So I think, we should either respect that or not call `AC_FC_FREEFORM`.

If we want to respect this (starting with this ticket), what do you think would be the best way? Somehow I must store that `FCFLAGS` wasn't set by the user and I may add our defaults to this.


---

Comment by mkoeppe created at 2020-12-03 19:27:37

Replying to [comment:54 gh-kliem]:
> From https://www.gnu.org/software/autoconf/manual/autoconf-2.66/html_node/Fortran-Compiler.html
> 
> > The AC_FC_FREEFORM tries to ensure that the Fortran compiler ($FC) allows free-format source code (as opposed to the older fixed-format style from Fortran 77). If necessary, it may add some additional flags to FCFLAGS. 
> 
> So, `AC_FC_FREEFORM` has added ` -ffree-form` to my flags, because it feels that this is needed. So I think, we should either respect that or not call `AC_FC_FREEFORM`.

We run this to find out whether the configured Fortran compiler has a free form mode.

We do this for our decision whether we have to install gfortran or not.

But it must be up to the individual packages how they invoke the Fortran compiler.


---

Comment by git created at 2020-12-03 20:05:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-12-03 20:07:02

Ok. I'm storing and restoring the `FCFLAGS` during gfortran configure now.
Defining a macro was the only way, I could enforce the order. But maybe there is a better way of doing this.


---

Comment by mkoeppe created at 2020-12-03 22:19:21

That's fine, yes, `AC_FC_FREEFORM` is executed out of order.

These lines:

```
+    sage_saved_fcflags=$FCFLAGS
+    FCFLAGS=$sage_saved_fcflags
```

need quoting around the assigned value.


---

Comment by mkoeppe created at 2020-12-03 22:20:34

Also these macro calls are better without the use of the second argument (look at the generated shell code)

```
+# Save compiler flags as configured by the user.
+AC_SUBST(CFLAGS, "$CFLAGS")
+AC_SUBST(CXXFLAGS, "$CXXFLAGS")
+AC_SUBST(FCFLAGS, "$FCFLAGS")
+AC_SUBST(F77FLAGS, "$F77FLAGS")
```



---

Comment by @kliem created at 2020-12-04 07:33:41

Replying to [comment:59 mkoeppe]:
> Also these macro calls are better without the use of the second argument (look at the generated shell code)
> {{{
> +# Save compiler flags as configured by the user.
> +AC_SUBST(CFLAGS, "$CFLAGS")
> +AC_SUBST(CXXFLAGS, "$CXXFLAGS")
> +AC_SUBST(FCFLAGS, "$FCFLAGS")
> +AC_SUBST(F77FLAGS, "$F77FLAGS")
> }}}

Your proposed change does not work. `AC_PROG_CC()` changes the value of `CFLAGS` if not set. `AC_SUBST(CFLAGS, "$CFLAGS")` will implicitly set `CFLAGS` (even though possibly to the empty value), but prevents `AC_PROG_CC` from messing with it.


---

Comment by git created at 2020-12-04 07:34:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-12-04 07:37:17

Replying to [comment:60 gh-kliem]:
> Replying to [comment:59 mkoeppe]:
> > Also these macro calls are better without the use of the second argument (look at the generated shell code)
> > {{{
> > +# Save compiler flags as configured by the user.
> > +AC_SUBST(CFLAGS, "$CFLAGS")
> > +AC_SUBST(CXXFLAGS, "$CXXFLAGS")
> > +AC_SUBST(FCFLAGS, "$FCFLAGS")
> > +AC_SUBST(F77FLAGS, "$F77FLAGS")
> > }}}
> 
> Your proposed change does not work. `AC_PROG_CC()` changes the value of `CFLAGS` if not set. `AC_SUBST(CFLAGS, "$CFLAGS")` will implicitly set `CFLAGS` (even though possibly to the empty value), but prevents `AC_PROG_CC` from messing with it.

I could deal with it the same way, I did with the `FCFLAGS` and save all of those flags beforehand. Maybe that is cleaner.


---

Comment by @kliem created at 2020-12-06 18:39:46

Maybe we can take care of this.


---

Comment by @kliem created at 2020-12-06 18:39:46

Changing keywords from "compile flags" to "compile flags, sd111".


---

Comment by @kliem created at 2020-12-09 21:12:01

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-12-10 08:18:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-12-10 08:20:20

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2020-12-10 08:20:20

Ok, at least it is prepared for precious variables.

#29507 would have to take care of using this.


---

Comment by @kliem created at 2020-12-10 08:33:40

Actually, it kind of works.

During make, reconfiguration will be done using `./config.status` and this one does not alter the variables.


---

Comment by mkoeppe created at 2020-12-11 03:02:53

Looking great, let's get this in.


---

Comment by mkoeppe created at 2020-12-11 03:02:53

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2020-12-11 07:02:54

Thanks again.


---

Comment by vbraun created at 2020-12-13 20:30:47

Resolution: fixed
