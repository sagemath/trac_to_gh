# Issue 14423: Make mod_int signed and speed up matrix_modn_dense_float

Issue created by migration from Trac.

Original creator: vbraun

Original creation time: 2013-05-22 18:17:37

Assignee: jason, was

CC:  stefan

As discussed on https://groups.google.com/d/msg/sage-devel/hnO8gT8VON4/YyZ5UCM5wUEJ, unsigned longs are much slower than signed longs when converted to a Python object.


---

Attachment

Performance test script


---

Comment by vbraun created at 2013-05-22 20:09:32

Changing status from new to needs_review.


---

Comment by malb created at 2013-05-23 08:40:35

Patch looks good, a few small comments/questions:

 * "The expression below assumes unsigned." I don't think this is true any more.
 * Those pari changes (sage.libs.pari.gen.pari  => pari) are a bit out of place? It's not bad enough though to make you take it out, just curious.
 * I thought we're supposed to use .pxd in place of .pxi, but you seem to prefer .pxi here?


---

Comment by vbraun created at 2013-05-23 09:26:50

I'm just following http://wiki.cython.org/FAQ#Whatisthedifferencebetweena.pxdand.pxifile.3FWhenshouldeitherbeused.3F, pxd for class declarations and pxi for include headers.

The `sage.libs.pari.gen.pari` gave me import errors after taking out some import statements. The module already imports it as `pari` on module-level so the short version should have been used from the start.


---

Comment by vbraun created at 2013-05-23 09:28:54

I changed "assumes unsigned" -> "assumes signed", which is of course the whole point of the patch ;-)


---

Comment by malb created at 2013-05-23 13:00:45

re: pxi vs. pxd: They are concluding with "Now that "cimport *" can be used, there is no reason to use .pxi files for external declarations." I think it would be better to use a .pxd which seems to be best practice as recommended by the Cython devs. But I am not insisting on it.

In other news: all tests passed.


---

Attachment

Updated patch


---

Comment by vbraun created at 2013-05-23 13:51:59

Ok, sounds good. New patch uses `mod_int.pxd` and `stdint.pxd`.


---

Comment by malb created at 2013-05-23 15:26:00

* doctests pass
 * patch looks okay
 * I can confirm the performance improvements


---

Comment by malb created at 2013-05-23 15:26:00

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-06-05 07:34:18

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-06-05 07:34:18

This breaks badly on 32-bit systems:

```
sage -t --long devel/sage/sage/matrix/matrix2.pyx
**********************************************************************
File "devel/sage/sage/matrix/matrix2.pyx", line 2320, in sage.matrix.matrix2.Matrix.diagonal._right_kernel_matrix_over_field
Failed example:
    P = result[1]; P
Expected:
    [       -1        -1         1         0]
    [-zeta14^3 -zeta14^4         0         1]
Got:
    [         3716055149462127149669597391230365/1741122812024444137450032682964234          3716055149462127149669597391230365/1741122812024444137450032682964234                                                                              1                                                                              0]
    [3716055149462127149669597391230365/1741122812024444137450032682964234*zeta14^3 3716055149462127149669597391230365/1741122812024444137450032682964234*zeta14^4                                                                              0                                                                              1]
**********************************************************************
```

And many more failures and timeouts: [http://build.sagemath.org/sage/builders/NTU%20arando%20%28Ubuntu%2012.10%20i686%29/builds/182/steps/shell_8/logs/stdio](http://build.sagemath.org/sage/builders/NTU%20arando%20%28Ubuntu%2012.10%20i686%29/builds/182/steps/shell_8/logs/stdio)


---

Comment by jdemeyer created at 2013-06-05 07:37:55

There are warnings

```
RuntimeWarning: sig_off() without sig_on() at build/cythonized/sage/matrix/misc.c:13370
```

which aren't caused by this ticket, but might as well be fixed: the `sig_on()` in `misc.pyx` should be _outside_ the `try/finally` block:

```
sig_on()
try:
    stuff
finally:
    sig_off()
```



---

Comment by vbraun created at 2013-07-11 16:14:35

Updated patch


---

Attachment

I've fixed the 32-bit error, added documentation, and also fixed Jeroen's `sig_on` branch issue.


---

Comment by vbraun created at 2013-07-11 16:30:45

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2013-07-11 16:30:45

The second patch needs review only


---

Comment by malb created at 2013-07-12 12:37:33

The changes look good. I don't have a 32-bit machine here to test, but other than that, I'd say it's good to go. Volker, you tested it on a 32-bit system, I presume?


---

Comment by vbraun created at 2013-07-12 13:33:14

Yes, of course I tested it on a 32-bit machine


---

Comment by malb created at 2013-07-12 14:22:20

Changing status from needs_review to positive_review.


---

Attachment

Initial patch


---

Comment by vbraun created at 2013-07-18 12:15:05

I noticed that #10281 intentionally uses 64-bit integers on all platforms for `mod_int`, since otherwise you can run out of primes. This is checked in one #long doctest that I missed. So the `trac_14627_more_primes.patch` switches to signed `int_fast64_t` for `mod_int`, this is fast on 64-bit Linux/OSX and sub-optimal (but with enough primes) on 64-bit Windows and all 32-bit platforms.


---

Comment by vbraun created at 2013-07-18 12:17:22

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2013-07-18 12:18:32

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2013-07-18 12:18:32

`make ptestlong` passes on both 32-bit ad 64-bit now. Martin, can you review the final patch?


---

Comment by malb created at 2013-07-18 13:03:19

Looks good to me


---

Comment by malb created at 2013-07-18 13:03:19

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-08-02 14:18:48

Resolution: fixed


---

Comment by mmezzarobba created at 2013-09-24 06:06:30

Could the changes in that ticket be the cause of #15220?
