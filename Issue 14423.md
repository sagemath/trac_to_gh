# Issue 14423: Make mod_int signed and speed up matrix_modn_dense_float

archive/issues_014423.json:
```json
{
    "body": "Assignee: jason, was\n\nCC:  stefan\n\nAs discussed on https://groups.google.com/d/msg/sage-devel/hnO8gT8VON4/YyZ5UCM5wUEJ, unsigned longs are much slower than signed longs when converted to a Python object.\n\nIssue created by migration from https://trac.sagemath.org/ticket/14627\n\n",
    "created_at": "2013-05-22T18:17:37Z",
    "labels": [
        "linear algebra",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.12",
    "title": "Make mod_int signed and speed up matrix_modn_dense_float",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14423",
    "user": "@vbraun"
}
```
Assignee: jason, was

CC:  stefan

As discussed on https://groups.google.com/d/msg/sage-devel/hnO8gT8VON4/YyZ5UCM5wUEJ, unsigned longs are much slower than signed longs when converted to a Python object.

Issue created by migration from https://trac.sagemath.org/ticket/14627





---

archive/issue_comments_182356.json:
```json
{
    "body": "Attachment [test_matrix_modn_float.py](tarball://root/attachments/some-uuid/ticket14627/test_matrix_modn_float.py) by @vbraun created at 2013-05-22 19:58:00\n\nPerformance test script",
    "created_at": "2013-05-22T19:58:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14423#issuecomment-182356",
    "user": "@vbraun"
}
```

Attachment [test_matrix_modn_float.py](tarball://root/attachments/some-uuid/ticket14627/test_matrix_modn_float.py) by @vbraun created at 2013-05-22 19:58:00

Performance test script



---

archive/issue_comments_182357.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-05-22T20:09:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14423#issuecomment-182357",
    "user": "@vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_182358.json:
```json
{
    "body": "Patch looks good, a few small comments/questions:\n\n* \"The expression below assumes unsigned.\" I don't think this is true any more.\n* Those pari changes (sage.libs.pari.gen.pari  => pari) are a bit out of place? It's not bad enough though to make you take it out, just curious.\n* I thought we're supposed to use .pxd in place of .pxi, but you seem to prefer .pxi here?",
    "created_at": "2013-05-23T08:40:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14423#issuecomment-182358",
    "user": "@malb"
}
```

Patch looks good, a few small comments/questions:

* "The expression below assumes unsigned." I don't think this is true any more.
* Those pari changes (sage.libs.pari.gen.pari  => pari) are a bit out of place? It's not bad enough though to make you take it out, just curious.
* I thought we're supposed to use .pxd in place of .pxi, but you seem to prefer .pxi here?



---

archive/issue_comments_182359.json:
```json
{
    "body": "I'm just following http://wiki.cython.org/FAQ#Whatisthedifferencebetweena.pxdand.pxifile.3FWhenshouldeitherbeused.3F, pxd for class declarations and pxi for include headers.\n\nThe `sage.libs.pari.gen.pari` gave me import errors after taking out some import statements. The module already imports it as `pari` on module-level so the short version should have been used from the start.",
    "created_at": "2013-05-23T09:26:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14423#issuecomment-182359",
    "user": "@vbraun"
}
```

I'm just following http://wiki.cython.org/FAQ#Whatisthedifferencebetweena.pxdand.pxifile.3FWhenshouldeitherbeused.3F, pxd for class declarations and pxi for include headers.

The `sage.libs.pari.gen.pari` gave me import errors after taking out some import statements. The module already imports it as `pari` on module-level so the short version should have been used from the start.



---

archive/issue_comments_182360.json:
```json
{
    "body": "I changed \"assumes unsigned\" -> \"assumes signed\", which is of course the whole point of the patch ;-)",
    "created_at": "2013-05-23T09:28:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14423#issuecomment-182360",
    "user": "@vbraun"
}
```

I changed "assumes unsigned" -> "assumes signed", which is of course the whole point of the patch ;-)



---

archive/issue_comments_182361.json:
```json
{
    "body": "re: pxi vs. pxd: They are concluding with \"Now that \"cimport *\" can be used, there is no reason to use .pxi files for external declarations.\" I think it would be better to use a .pxd which seems to be best practice as recommended by the Cython devs. But I am not insisting on it.\n\nIn other news: all tests passed.",
    "created_at": "2013-05-23T13:00:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14423#issuecomment-182361",
    "user": "@malb"
}
```

re: pxi vs. pxd: They are concluding with "Now that "cimport *" can be used, there is no reason to use .pxi files for external declarations." I think it would be better to use a .pxd which seems to be best practice as recommended by the Cython devs. But I am not insisting on it.

In other news: all tests passed.



---

archive/issue_comments_182362.json:
```json
{
    "body": "Attachment [trac_14627_signed_mod_int.patch](tarball://root/attachments/some-uuid/ticket14627/trac_14627_signed_mod_int.patch) by @vbraun created at 2013-05-23 13:51:09\n\nUpdated patch",
    "created_at": "2013-05-23T13:51:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14423#issuecomment-182362",
    "user": "@vbraun"
}
```

Attachment [trac_14627_signed_mod_int.patch](tarball://root/attachments/some-uuid/ticket14627/trac_14627_signed_mod_int.patch) by @vbraun created at 2013-05-23 13:51:09

Updated patch



---

archive/issue_comments_182363.json:
```json
{
    "body": "Ok, sounds good. New patch uses `mod_int.pxd` and `stdint.pxd`.",
    "created_at": "2013-05-23T13:51:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14423#issuecomment-182363",
    "user": "@vbraun"
}
```

Ok, sounds good. New patch uses `mod_int.pxd` and `stdint.pxd`.



---

archive/issue_comments_182364.json:
```json
{
    "body": "* doctests pass\n  * patch looks okay\n  * I can confirm the performance improvements",
    "created_at": "2013-05-23T15:26:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14423#issuecomment-182364",
    "user": "@malb"
}
```

* doctests pass
  * patch looks okay
  * I can confirm the performance improvements



---

archive/issue_comments_182365.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-05-23T15:26:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14423#issuecomment-182365",
    "user": "@malb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_182366.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2013-06-05T07:34:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14423#issuecomment-182366",
    "user": "@jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_182367.json:
```json
{
    "body": "This breaks badly on 32-bit systems:\n\n```\nsage -t --long devel/sage/sage/matrix/matrix2.pyx\n**********************************************************************\nFile \"devel/sage/sage/matrix/matrix2.pyx\", line 2320, in sage.matrix.matrix2.Matrix.diagonal._right_kernel_matrix_over_field\nFailed example:\n    P = result[1]; P\nExpected:\n    [       -1        -1         1         0]\n    [-zeta14^3 -zeta14^4         0         1]\nGot:\n    [         3716055149462127149669597391230365/1741122812024444137450032682964234          3716055149462127149669597391230365/1741122812024444137450032682964234                                                                              1                                                                              0]\n    [3716055149462127149669597391230365/1741122812024444137450032682964234*zeta14^3 3716055149462127149669597391230365/1741122812024444137450032682964234*zeta14^4                                                                              0                                                                              1]\n**********************************************************************\n```\n\nAnd many more failures and timeouts: [http://build.sagemath.org/sage/builders/NTU%20arando%20%28Ubuntu%2012.10%20i686%29/builds/182/steps/shell_8/logs/stdio](http://build.sagemath.org/sage/builders/NTU%20arando%20%28Ubuntu%2012.10%20i686%29/builds/182/steps/shell_8/logs/stdio)",
    "created_at": "2013-06-05T07:34:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14423#issuecomment-182367",
    "user": "@jdemeyer"
}
```

This breaks badly on 32-bit systems:

```
sage -t --long devel/sage/sage/matrix/matrix2.pyx
**********************************************************************
File "devel/sage/sage/matrix/matrix2.pyx", line 2320, in sage.matrix.matrix2.Matrix.diagonal._right_kernel_matrix_over_field
Failed example:
    P = result[1]; P
Expected:
    [       -1        -1         1         0]
    [-zeta14^3 -zeta14^4         0         1]
Got:
    [         3716055149462127149669597391230365/1741122812024444137450032682964234          3716055149462127149669597391230365/1741122812024444137450032682964234                                                                              1                                                                              0]
    [3716055149462127149669597391230365/1741122812024444137450032682964234*zeta14^3 3716055149462127149669597391230365/1741122812024444137450032682964234*zeta14^4                                                                              0                                                                              1]
**********************************************************************
```

And many more failures and timeouts: [http://build.sagemath.org/sage/builders/NTU%20arando%20%28Ubuntu%2012.10%20i686%29/builds/182/steps/shell_8/logs/stdio](http://build.sagemath.org/sage/builders/NTU%20arando%20%28Ubuntu%2012.10%20i686%29/builds/182/steps/shell_8/logs/stdio)



---

archive/issue_comments_182368.json:
```json
{
    "body": "There are warnings\n\n```\nRuntimeWarning: sig_off() without sig_on() at build/cythonized/sage/matrix/misc.c:13370\n```\n\nwhich aren't caused by this ticket, but might as well be fixed: the `sig_on()` in `misc.pyx` should be *outside* the `try/finally` block:\n\n```\nsig_on()\ntry:\n    stuff\nfinally:\n    sig_off()\n```\n",
    "created_at": "2013-06-05T07:37:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14423#issuecomment-182368",
    "user": "@jdemeyer"
}
```

There are warnings

```
RuntimeWarning: sig_off() without sig_on() at build/cythonized/sage/matrix/misc.c:13370
```

which aren't caused by this ticket, but might as well be fixed: the `sig_on()` in `misc.pyx` should be *outside* the `try/finally` block:

```
sig_on()
try:
    stuff
finally:
    sig_off()
```




---

archive/issue_comments_182369.json:
```json
{
    "body": "Updated patch",
    "created_at": "2013-07-11T16:14:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14423#issuecomment-182369",
    "user": "@vbraun"
}
```

Updated patch



---

archive/issue_comments_182370.json:
```json
{
    "body": "Attachment [trac_14627_32bit.patch](tarball://root/attachments/some-uuid/ticket14627/trac_14627_32bit.patch) by @vbraun created at 2013-07-11 16:17:17\n\nI've fixed the 32-bit error, added documentation, and also fixed Jeroen's `sig_on` branch issue.",
    "created_at": "2013-07-11T16:17:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14423#issuecomment-182370",
    "user": "@vbraun"
}
```

Attachment [trac_14627_32bit.patch](tarball://root/attachments/some-uuid/ticket14627/trac_14627_32bit.patch) by @vbraun created at 2013-07-11 16:17:17

I've fixed the 32-bit error, added documentation, and also fixed Jeroen's `sig_on` branch issue.



---

archive/issue_comments_182371.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-07-11T16:30:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14423#issuecomment-182371",
    "user": "@vbraun"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_182372.json:
```json
{
    "body": "The second patch needs review only",
    "created_at": "2013-07-11T16:30:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14423#issuecomment-182372",
    "user": "@vbraun"
}
```

The second patch needs review only



---

archive/issue_comments_182373.json:
```json
{
    "body": "The changes look good. I don't have a 32-bit machine here to test, but other than that, I'd say it's good to go. Volker, you tested it on a 32-bit system, I presume?",
    "created_at": "2013-07-12T12:37:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14423#issuecomment-182373",
    "user": "@malb"
}
```

The changes look good. I don't have a 32-bit machine here to test, but other than that, I'd say it's good to go. Volker, you tested it on a 32-bit system, I presume?



---

archive/issue_comments_182374.json:
```json
{
    "body": "Yes, of course I tested it on a 32-bit machine",
    "created_at": "2013-07-12T13:33:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14423#issuecomment-182374",
    "user": "@vbraun"
}
```

Yes, of course I tested it on a 32-bit machine



---

archive/issue_comments_182375.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-07-12T14:22:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14423#issuecomment-182375",
    "user": "@malb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_182376.json:
```json
{
    "body": "Attachment [trac_14627_more_primes.patch](tarball://root/attachments/some-uuid/ticket14627/trac_14627_more_primes.patch) by @vbraun created at 2013-07-18 12:08:25\n\nInitial patch",
    "created_at": "2013-07-18T12:08:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14423#issuecomment-182376",
    "user": "@vbraun"
}
```

Attachment [trac_14627_more_primes.patch](tarball://root/attachments/some-uuid/ticket14627/trac_14627_more_primes.patch) by @vbraun created at 2013-07-18 12:08:25

Initial patch



---

archive/issue_comments_182377.json:
```json
{
    "body": "I noticed that #10281 intentionally uses 64-bit integers on all platforms for `mod_int`, since otherwise you can run out of primes. This is checked in one #long doctest that I missed. So the `trac_14627_more_primes.patch` switches to signed `int_fast64_t` for `mod_int`, this is fast on 64-bit Linux/OSX and sub-optimal (but with enough primes) on 64-bit Windows and all 32-bit platforms.",
    "created_at": "2013-07-18T12:15:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14423#issuecomment-182377",
    "user": "@vbraun"
}
```

I noticed that #10281 intentionally uses 64-bit integers on all platforms for `mod_int`, since otherwise you can run out of primes. This is checked in one #long doctest that I missed. So the `trac_14627_more_primes.patch` switches to signed `int_fast64_t` for `mod_int`, this is fast on 64-bit Linux/OSX and sub-optimal (but with enough primes) on 64-bit Windows and all 32-bit platforms.



---

archive/issue_comments_182378.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2013-07-18T12:17:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14423#issuecomment-182378",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_182379.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-07-18T12:18:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14423#issuecomment-182379",
    "user": "@vbraun"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_182380.json:
```json
{
    "body": "`make ptestlong` passes on both 32-bit ad 64-bit now. Martin, can you review the final patch?",
    "created_at": "2013-07-18T12:18:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14423#issuecomment-182380",
    "user": "@vbraun"
}
```

`make ptestlong` passes on both 32-bit ad 64-bit now. Martin, can you review the final patch?



---

archive/issue_comments_182381.json:
```json
{
    "body": "Looks good to me",
    "created_at": "2013-07-18T13:03:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14423#issuecomment-182381",
    "user": "@malb"
}
```

Looks good to me



---

archive/issue_comments_182382.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-07-18T13:03:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14423#issuecomment-182382",
    "user": "@malb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_182383.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-08-02T14:18:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14423#issuecomment-182383",
    "user": "@jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_182384.json:
```json
{
    "body": "Could the changes in that ticket be the cause of #15220?",
    "created_at": "2013-09-24T06:06:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14423",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14423#issuecomment-182384",
    "user": "@mezzarobba"
}
```

Could the changes in that ticket be the cause of #15220?
