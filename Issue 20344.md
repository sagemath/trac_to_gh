# Issue 20344: Upgrade PARI to latest master

archive/issues_020344.json:
```json
{
    "body": "CC:  @jdemeyer @kedlaya @kiwifb\n\nSome recent fixes needed to correctly count points on hyperelliptic curves.\n\nIssue created by migration from https://trac.sagemath.org/ticket/20581\n\n",
    "created_at": "2016-05-09T22:45:28Z",
    "labels": [
        "packages: standard",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.3",
    "title": "Upgrade PARI to latest master",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20344",
    "user": "jpflori"
}
```
CC:  @jdemeyer @kedlaya @kiwifb

Some recent fixes needed to correctly count points on hyperelliptic curves.

Issue created by migration from https://trac.sagemath.org/ticket/20581





---

archive/issue_comments_280504.json:
```json
{
    "body": "`@`Jeroen: you already did the upgrade a bunch of time IIRC.\nI could try to review the ticket (which should be trivial) while I have some time this week.\n(Later than that I can not promise anything.)",
    "created_at": "2016-05-09T22:47:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280504",
    "user": "jpflori"
}
```

`@`Jeroen: you already did the upgrade a bunch of time IIRC.
I could try to review the ticket (which should be trivial) while I have some time this week.
(Later than that I can not promise anything.)



---

archive/issue_comments_280505.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-05-10T16:13:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280505",
    "user": "@jdemeyer"
}
```

New commits:



---

archive/issue_comments_280506.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-05-10T16:13:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280506",
    "user": "@jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_280507.json:
```json
{
    "body": "I see a lot of functions' signatures changed because of the addition of the const modifier.\nWas it on purpose? (IIRC Cython does not care about constness anyway.)",
    "created_at": "2016-05-11T15:23:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280507",
    "user": "jpflori"
}
```

I see a lot of functions' signatures changed because of the addition of the const modifier.
Was it on purpose? (IIRC Cython does not care about constness anyway.)



---

archive/issue_comments_280508.json:
```json
{
    "body": "Replying to [comment:7 jpflori]:\n> Was it on purpose? (IIRC Cython does not care about constness anyway.)\n\nWell, I just took the declarations from PARI and they have `const` in them. And it's true that it probably does not matter for Cython anyway.",
    "created_at": "2016-05-11T15:42:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280508",
    "user": "@jdemeyer"
}
```

Replying to [comment:7 jpflori]:
> Was it on purpose? (IIRC Cython does not care about constness anyway.)

Well, I just took the declarations from PARI and they have `const` in them. And it's true that it probably does not matter for Cython anyway.



---

archive/issue_comments_280509.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-05-11T22:34:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280509",
    "user": "jpflori"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_280510.json:
```json
{
    "body": "I'm getting failures on OSX\n\n```\nIn file included from /Users/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/libs/pari/handle_error.c:324:0:\n/Users/buildslave-sage/slave/sage_git/build/local/include/pari/paripriv.h:16:48: error: unknown type name 'ulong'\n hashtable *hashstr_import_static(hashentry *e, ulong size);\n                                                ^\nIn file included from /Users/buildslave-sage/slave/sage_git/build/local/include/pari/pari.h:39:0,\n                 from /Users/buildslave-sage/slave/sage_git/build/src/sage/libs/pari/parisage.h:3,\n                 from /Users/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/libs/pari/handle_error.c:320:\n/Users/buildslave-sage/slave/sage_git/build/local/include/pari/paripriv.h: In function 'clone_lock':\n/Users/buildslave-sage/slave/sage_git/build/local/include/pari/paripriv.h:36:25: error: 'ulong' undeclared (first use in this function)\n clone_lock(GEN C) { if (isclone(C)) ++bl_refc(C); }\n\n```\n",
    "created_at": "2016-05-19T17:27:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280510",
    "user": "@vbraun"
}
```

I'm getting failures on OSX

```
In file included from /Users/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/libs/pari/handle_error.c:324:0:
/Users/buildslave-sage/slave/sage_git/build/local/include/pari/paripriv.h:16:48: error: unknown type name 'ulong'
 hashtable *hashstr_import_static(hashentry *e, ulong size);
                                                ^
In file included from /Users/buildslave-sage/slave/sage_git/build/local/include/pari/pari.h:39:0,
                 from /Users/buildslave-sage/slave/sage_git/build/src/sage/libs/pari/parisage.h:3,
                 from /Users/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/libs/pari/handle_error.c:320:
/Users/buildslave-sage/slave/sage_git/build/local/include/pari/paripriv.h: In function 'clone_lock':
/Users/buildslave-sage/slave/sage_git/build/local/include/pari/paripriv.h:36:25: error: 'ulong' undeclared (first use in this function)
 clone_lock(GEN C) { if (isclone(C)) ++bl_refc(C); }

```




---

archive/issue_comments_280511.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-05-19T17:27:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280511",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_280512.json:
```json
{
    "body": "FLINT and PARI `ulong` mess...\nI guess that `handle_error.pxd` pulls the PARI headers and `parisage.h` which undefs `ulong` and when `handle_error.pyx` is treated and pulls in `paripriv.h` which wants `ulong` we lose...\nNot sure what the cleanest solution would be.\nMaybe `#define pari_ulong` in `parisage.h` and define/undefine `ulong` in a custom `pariprivsage.h` which pulls `paripriv.h` in (just as `parisage.h` does for `pari.h`).",
    "created_at": "2016-05-23T08:13:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280512",
    "user": "jpflori"
}
```

FLINT and PARI `ulong` mess...
I guess that `handle_error.pxd` pulls the PARI headers and `parisage.h` which undefs `ulong` and when `handle_error.pyx` is treated and pulls in `paripriv.h` which wants `ulong` we lose...
Not sure what the cleanest solution would be.
Maybe `#define pari_ulong` in `parisage.h` and define/undefine `ulong` in a custom `pariprivsage.h` which pulls `paripriv.h` in (just as `parisage.h` does for `pari.h`).



---

archive/issue_comments_280513.json:
```json
{
    "body": "I don't understand why anything would change on OS X...\n\nI do plan to investigate this, but maybe not this week.",
    "created_at": "2016-05-23T08:38:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280513",
    "user": "@jdemeyer"
}
```

I don't understand why anything would change on OS X...

I do plan to investigate this, but maybe not this week.



---

archive/issue_comments_280514.json:
```json
{
    "body": "Replying to [comment:12 jdemeyer]:\n> I don't understand why anything would change on OS X...\nYes that's a mystery as well.",
    "created_at": "2016-05-23T08:50:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280514",
    "user": "jpflori"
}
```

Replying to [comment:12 jdemeyer]:
> I don't understand why anything would change on OS X...
Yes that's a mystery as well.



---

archive/issue_comments_280515.json:
```json
{
    "body": "`@`Volker: can you post the generated C file (`handle_error.c`)?",
    "created_at": "2016-05-23T08:56:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280515",
    "user": "jpflori"
}
```

`@`Volker: can you post the generated C file (`handle_error.c`)?



---

archive/issue_comments_280516.json:
```json
{
    "body": "You have an account on the OSX buildbot, right?",
    "created_at": "2016-05-23T09:40:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280516",
    "user": "@vbraun"
}
```

You have an account on the OSX buildbot, right?



---

archive/issue_comments_280517.json:
```json
{
    "body": "Cannot remember if I have one, nor it's name...",
    "created_at": "2016-05-23T09:51:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280517",
    "user": "jpflori"
}
```

Cannot remember if I have one, nor it's name...



---

archive/issue_comments_280518.json:
```json
{
    "body": "Ok apparently not... if you send me privately your desired account name and Apple ID (for login) then I can make one.",
    "created_at": "2016-05-23T11:47:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280518",
    "user": "@vbraun"
}
```

Ok apparently not... if you send me privately your desired account name and Apple ID (for login) then I can make one.



---

archive/issue_comments_280519.json:
```json
{
    "body": "This works by accident on Linux due to this bit in `/usr/include/sys/types.h`:\n\n```\n#ifdef __USE_MISC\n/* Old compatibility names for C types.  */\ntypedef unsigned long int ulong;\ntypedef unsigned short int ushort;\ntypedef unsigned int uint;\n#endif\n```\n",
    "created_at": "2016-05-30T15:11:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280519",
    "user": "@jdemeyer"
}
```

This works by accident on Linux due to this bit in `/usr/include/sys/types.h`:

```
#ifdef __USE_MISC
/* Old compatibility names for C types.  */
typedef unsigned long int ulong;
typedef unsigned short int ushort;
typedef unsigned int uint;
#endif
```




---

archive/issue_comments_280520.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-05-30T15:25:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280520",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_280521.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-05-31T08:30:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280521",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_280522.json:
```json
{
    "body": "Is that because of typedef?",
    "created_at": "2016-05-31T08:56:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280522",
    "user": "jpflori"
}
```

Is that because of typedef?



---

archive/issue_comments_280523.json:
```json
{
    "body": "Replying to [comment:21 jpflori]:\n> Is that because of typedef?\n\nNo, the problem is that `ulong` appears also indirectly in macros. For example, the `typ()` macro in PARI uses `ulong`.",
    "created_at": "2016-05-31T09:06:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280523",
    "user": "@jdemeyer"
}
```

Replying to [comment:21 jpflori]:
> Is that because of typedef?

No, the problem is that `ulong` appears also indirectly in macros. For example, the `typ()` macro in PARI uses `ulong`.



---

archive/issue_comments_280524.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-05-31T09:10:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280524",
    "user": "@jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_280525.json:
```json
{
    "body": "Changing keywords from \"\" to \"days74\".",
    "created_at": "2016-06-01T05:46:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280525",
    "user": "@tscrim"
}
```

Changing keywords from "" to "days74".



---

archive/issue_comments_280526.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-06-15T13:17:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280526",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_280527.json:
```json
{
    "body": "Rebased on latest develop.",
    "created_at": "2016-06-15T13:17:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280527",
    "user": "@jdemeyer"
}
```

Rebased on latest develop.



---

archive/issue_comments_280528.json:
```json
{
    "body": "Note in case you intend to update this ticket to the very latest PARI version: if you do so, you can remove `build/pkgs/pari/patches/do_QXQ_eval.patch` (added in #20749, corresponding to upstream commit 6db8fba).",
    "created_at": "2016-06-15T13:31:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280528",
    "user": "@pjbruin"
}
```

Note in case you intend to update this ticket to the very latest PARI version: if you do so, you can remove `build/pkgs/pari/patches/do_QXQ_eval.patch` (added in #20749, corresponding to upstream commit 6db8fba).



---

archive/issue_comments_280529.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-06-15T15:04:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280529",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_280530.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-06-15T16:43:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280530",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_280531.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-06-15T16:44:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280531",
    "user": "@jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_280532.json:
```json
{
    "body": "Upgraded to really latest master.",
    "created_at": "2016-06-15T16:44:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280532",
    "user": "@jdemeyer"
}
```

Upgraded to really latest master.



---

archive/issue_comments_280533.json:
```json
{
    "body": "Two small patches; the second one mirrors the changes to `paridecl.h` made in upstream commit 0d28865 (split FpXQX_factor.c from FpX_factor.c).",
    "created_at": "2016-06-20T09:06:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280533",
    "user": "@pjbruin"
}
```

Two small patches; the second one mirrors the changes to `paridecl.h` made in upstream commit 0d28865 (split FpXQX_factor.c from FpX_factor.c).



---

archive/issue_comments_280534.json:
```json
{
    "body": "Looks good to me, and doctests pass on GNU/Linux x86_64.  If you are happy with the above patches and the `ulong` problem on OSX has been resolved, this can get a positive review as far as I'm concerned.",
    "created_at": "2016-06-20T09:59:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280534",
    "user": "@pjbruin"
}
```

Looks good to me, and doctests pass on GNU/Linux x86_64.  If you are happy with the above patches and the `ulong` problem on OSX has been resolved, this can get a positive review as far as I'm concerned.



---

archive/issue_comments_280535.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-06-20T10:01:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280535",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_280536.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-06-21T20:37:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280536",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_280537.json:
```json
{
    "body": "\n```\nsage -t --long src/sage/modular/dirichlet.py  # 1 doctest failed\nsage -t --long src/sage/modular/overconvergent/weightspace.py  # 2 doctests failed\n```\n",
    "created_at": "2016-06-21T20:37:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280537",
    "user": "@vbraun"
}
```


```
sage -t --long src/sage/modular/dirichlet.py  # 1 doctest failed
sage -t --long src/sage/modular/overconvergent/weightspace.py  # 2 doctests failed
```




---

archive/issue_comments_280538.json:
```json
{
    "body": "Replying to [comment:34 vbraun]:\n> {{{\n> sage -t --long src/sage/modular/dirichlet.py  # 1 doctest failed\n> sage -t --long src/sage/modular/overconvergent/weightspace.py  # 2 doctests failed\n> }}}\n\nI honestly thought those were caused by #15692 rather than this one.",
    "created_at": "2016-06-21T20:55:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280538",
    "user": "@kiwifb"
}
```

Replying to [comment:34 vbraun]:
> {{{
> sage -t --long src/sage/modular/dirichlet.py  # 1 doctest failed
> sage -t --long src/sage/modular/overconvergent/weightspace.py  # 2 doctests failed
> }}}

I honestly thought those were caused by #15692 rather than this one.



---

archive/issue_comments_280539.json:
```json
{
    "body": "maybe, let me double check...",
    "created_at": "2016-06-21T20:56:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280539",
    "user": "@vbraun"
}
```

maybe, let me double check...



---

archive/issue_comments_280540.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2016-06-21T21:44:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280540",
    "user": "@vbraun"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_280541.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-06-23T17:14:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20344#issuecomment-280541",
    "user": "@vbraun"
}
```

Resolution: fixed
