# Issue 20344: Upgrade PARI to latest master

Issue created by migration from https://trac.sagemath.org/ticket/20581

Original creator: jpflori

Original creation time: 2016-05-09 22:45:28

CC:  jdemeyer kedlaya fbissey

Some recent fixes needed to correctly count points on hyperelliptic curves.


---

Comment by jpflori created at 2016-05-09 22:47:22

`@`Jeroen: you already did the upgrade a bunch of time IIRC.
I could try to review the ticket (which should be trivial) while I have some time this week.
(Later than that I can not promise anything.)


---

Comment by jdemeyer created at 2016-05-10 16:13:37

New commits:


---

Comment by jdemeyer created at 2016-05-10 16:13:37

Changing status from new to needs_review.


---

Comment by jpflori created at 2016-05-11 15:23:13

I see a lot of functions' signatures changed because of the addition of the const modifier.
Was it on purpose? (IIRC Cython does not care about constness anyway.)


---

Comment by jdemeyer created at 2016-05-11 15:42:32

Replying to [comment:7 jpflori]:
> Was it on purpose? (IIRC Cython does not care about constness anyway.)

Well, I just took the declarations from PARI and they have `const` in them. And it's true that it probably does not matter for Cython anyway.


---

Comment by jpflori created at 2016-05-11 22:34:09

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-05-19 17:27:15

I'm getting failures on OSX

```
In file included from /Users/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/libs/pari/handle_error.c:324:0:
/Users/buildslave-sage/slave/sage_git/build/local/include/pari/paripriv.h:16:48: error: unknown type name 'ulong'
 hashtable *hashstr_import_static(hashentry *e, ulong size);
                                                ^
In file included from /Users/buildslave-sage/slave/sage_git/build/local/include/pari/pari.h:39:0,
                 from /Users/buildslave-sage/slave/sage_git/build/src/sage/libs/pari/parisage.h:3,
                 from /Users/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/libs/pari/handle_error.c:320:
/Users/buildslave-sage/slave/sage_git/build/local/include/pari/paripriv.h: In function 'clone_lock':
/Users/buildslave-sage/slave/sage_git/build/local/include/pari/paripriv.h:36:25: error: 'ulong' undeclared (first use in this function)
 clone_lock(GEN C) { if (isclone(C)) ++bl_refc(C); }

```



---

Comment by vbraun created at 2016-05-19 17:27:15

Changing status from positive_review to needs_work.


---

Comment by jpflori created at 2016-05-23 08:13:03

FLINT and PARI `ulong` mess...
I guess that `handle_error.pxd` pulls the PARI headers and `parisage.h` which undefs `ulong` and when `handle_error.pyx` is treated and pulls in `paripriv.h` which wants `ulong` we lose...
Not sure what the cleanest solution would be.
Maybe `#define pari_ulong` in `parisage.h` and define/undefine `ulong` in a custom `pariprivsage.h` which pulls `paripriv.h` in (just as `parisage.h` does for `pari.h`).


---

Comment by jdemeyer created at 2016-05-23 08:38:59

I don't understand why anything would change on OS X...

I do plan to investigate this, but maybe not this week.


---

Comment by jpflori created at 2016-05-23 08:50:47

Replying to [comment:12 jdemeyer]:
> I don't understand why anything would change on OS X...
Yes that's a mystery as well.


---

Comment by jpflori created at 2016-05-23 08:56:57

`@`Volker: can you post the generated C file (`handle_error.c`)?


---

Comment by vbraun created at 2016-05-23 09:40:01

You have an account on the OSX buildbot, right?


---

Comment by jpflori created at 2016-05-23 09:51:26

Cannot remember if I have one, nor it's name...


---

Comment by vbraun created at 2016-05-23 11:47:54

Ok apparently not... if you send me privately your desired account name and Apple ID (for login) then I can make one.


---

Comment by jdemeyer created at 2016-05-30 15:11:20

This works by accident on Linux due to this bit in `/usr/include/sys/types.h`:

```
#ifdef __USE_MISC
/* Old compatibility names for C types.  */
typedef unsigned long int ulong;
typedef unsigned short int ushort;
typedef unsigned int uint;
#endif
```



---

Comment by git created at 2016-05-30 15:25:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-05-31 08:30:57

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jpflori created at 2016-05-31 08:56:28

Is that because of typedef?


---

Comment by jdemeyer created at 2016-05-31 09:06:27

Replying to [comment:21 jpflori]:
> Is that because of typedef?

No, the problem is that `ulong` appears also indirectly in macros. For example, the `typ()` macro in PARI uses `ulong`.


---

Comment by jdemeyer created at 2016-05-31 09:10:12

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2016-06-01 05:46:40

Changing keywords from "" to "days74".


---

Comment by git created at 2016-06-15 13:17:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2016-06-15 13:17:26

Rebased on latest develop.


---

Comment by pbruin created at 2016-06-15 13:31:47

Note in case you intend to update this ticket to the very latest PARI version: if you do so, you can remove `build/pkgs/pari/patches/do_QXQ_eval.patch` (added in #20749, corresponding to upstream commit 6db8fba).


---

Comment by jdemeyer created at 2016-06-15 15:04:39

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-06-15 16:43:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2016-06-15 16:44:40

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2016-06-15 16:44:40

Upgraded to really latest master.


---

Comment by pbruin created at 2016-06-20 09:06:54

Two small patches; the second one mirrors the changes to `paridecl.h` made in upstream commit 0d28865 (split FpXQX_factor.c from FpX_factor.c).


---

Comment by pbruin created at 2016-06-20 09:59:21

Looks good to me, and doctests pass on GNU/Linux x86_64.  If you are happy with the above patches and the `ulong` problem on OSX has been resolved, this can get a positive review as far as I'm concerned.


---

Comment by jdemeyer created at 2016-06-20 10:01:38

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-06-21 20:37:34

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2016-06-21 20:37:34


```
sage -t --long src/sage/modular/dirichlet.py  # 1 doctest failed
sage -t --long src/sage/modular/overconvergent/weightspace.py  # 2 doctests failed
```



---

Comment by fbissey created at 2016-06-21 20:55:35

Replying to [comment:34 vbraun]:
> {{{
> sage -t --long src/sage/modular/dirichlet.py  # 1 doctest failed
> sage -t --long src/sage/modular/overconvergent/weightspace.py  # 2 doctests failed
> }}}

I honestly thought those were caused by #15692 rather than this one.


---

Comment by vbraun created at 2016-06-21 20:56:32

maybe, let me double check...


---

Comment by vbraun created at 2016-06-21 21:44:59

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2016-06-23 17:14:00

Resolution: fixed
