# Issue 27939: Fix few bugs in ClusterAlgebra discovered while working on #26771

archive/issues_027939.json:
```json
{
    "body": "CC:  tscrim gmoose05 stumpc5 @ebanaian drupel @kelleye\n\nKeywords: ClusterAlgebras\n\nAs pointed out by the people at #26771, `ClusterAlgebra` has few bugs.\n\n- Default arguments do not play nicely with `UniqueRepresentation`\n  \n  {{{\n    sage: A1 = ClusterAlgebra(['A',2])\n    sage: A2 = ClusterAlgebra(['A',2], cluster_variable_prefix='x')\n    sage: A1 is A2\n    False\n  }}}\n\n- `mutate_initial` keeps the same variable names; In theory this is not a\n  problem but may create confusion. For example suppose we are looking at the\n  Grassmannian of planes in a 4 dimensional vector space. Then the associate\n  cluster algebra is\n\n  {{{\n    sage: A = ClusterAlgebra( matrix(5,[0,1,-1,1,-1]), cluster_variable_names=['p13'], coefficient_names=['p12','p23','p34','p41'], scalars=QQbar); A\n    A Cluster Algebra with cluster variable p13 and coefficients p12, p23, p34, p41 over Algebraic Field\n  }}}\n\n  Swapping out `p13` from the initial seed should give `p24` or, at the very\n  least *not* `p13`. Getting `p24` requires some understanding of what the ring\n  in question really is that goes beyond the scope of this class. Currently we\n  get\n\n  {{{\n    sage: A.mutate_initial(0)\n    A Cluster Algebra with cluster variable p13 and coefficients p12, p23, p34, p41 over Algebraic Field\n  }}}\n\n- `mutate_initial` does not compute all the required F-polynomials and it does not enforce the fact that they are not rational expressions\n\n  {{{\n    sage: A1 = ClusterAlgebra(['A',[2,1],1])\n    sage: A2 = A1.mutate_initial([0,1,0])\n    sage: len(A2.g_vectors_so_far()) == len(A2.F_polynomials_so_far())\n    False\n    sage: all(parent(f) == A2._U for f in A2.F_polynomials_so_far())\n    False\n  }}}\n\n- finally `mutate_initial` does not enforce the fact that initial g-vectors\n  belong to the initial cluster but rather prepend the performed  mutation sequence\n  to all the paths already known. \n\n  {{{\n    sage: A2.find_g_vector((0,0,1))\n    [0, 1, 0]\n  }}}\n\n  This, while technically not false, may generate confusion.\n\nThis ticket deals with all these issues.\n\nIssue created by migration from https://trac.sagemath.org/ticket/28176\n\n",
    "created_at": "2019-07-11T21:06:21Z",
    "labels": [
        "PLEASE CHANGE",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.9",
    "title": "Fix few bugs in ClusterAlgebra discovered while working on #26771",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27939",
    "user": "etn40ff"
}
```
CC:  tscrim gmoose05 stumpc5 @ebanaian drupel @kelleye

Keywords: ClusterAlgebras

As pointed out by the people at #26771, `ClusterAlgebra` has few bugs.

- Default arguments do not play nicely with `UniqueRepresentation`
  
  {{{
    sage: A1 = ClusterAlgebra(['A',2])
    sage: A2 = ClusterAlgebra(['A',2], cluster_variable_prefix='x')
    sage: A1 is A2
    False
  }}}

- `mutate_initial` keeps the same variable names; In theory this is not a
  problem but may create confusion. For example suppose we are looking at the
  Grassmannian of planes in a 4 dimensional vector space. Then the associate
  cluster algebra is

  {{{
    sage: A = ClusterAlgebra( matrix(5,[0,1,-1,1,-1]), cluster_variable_names=['p13'], coefficient_names=['p12','p23','p34','p41'], scalars=QQbar); A
    A Cluster Algebra with cluster variable p13 and coefficients p12, p23, p34, p41 over Algebraic Field
  }}}

  Swapping out `p13` from the initial seed should give `p24` or, at the very
  least *not* `p13`. Getting `p24` requires some understanding of what the ring
  in question really is that goes beyond the scope of this class. Currently we
  get

  {{{
    sage: A.mutate_initial(0)
    A Cluster Algebra with cluster variable p13 and coefficients p12, p23, p34, p41 over Algebraic Field
  }}}

- `mutate_initial` does not compute all the required F-polynomials and it does not enforce the fact that they are not rational expressions

  {{{
    sage: A1 = ClusterAlgebra(['A',[2,1],1])
    sage: A2 = A1.mutate_initial([0,1,0])
    sage: len(A2.g_vectors_so_far()) == len(A2.F_polynomials_so_far())
    False
    sage: all(parent(f) == A2._U for f in A2.F_polynomials_so_far())
    False
  }}}

- finally `mutate_initial` does not enforce the fact that initial g-vectors
  belong to the initial cluster but rather prepend the performed  mutation sequence
  to all the paths already known. 

  {{{
    sage: A2.find_g_vector((0,0,1))
    [0, 1, 0]
  }}}

  This, while technically not false, may generate confusion.

This ticket deals with all these issues.

Issue created by migration from https://trac.sagemath.org/ticket/28176





---

archive/issue_comments_394611.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to algebra.",
    "created_at": "2019-07-11T21:11:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27939#issuecomment-394611",
    "user": "etn40ff"
}
```

Changing component from PLEASE CHANGE to algebra.



---

archive/issue_comments_394612.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-07-11T21:11:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27939#issuecomment-394612",
    "user": "etn40ff"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_394613.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-07-11T21:11:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27939#issuecomment-394613",
    "user": "etn40ff"
}
```

New commits:



---

archive/issue_comments_394614.json:
```json
{
    "body": "bot is not happy:\n\n```\nsage -t --long src/sage/algebras/cluster_algebra.py  # Tab character found\n```\n",
    "created_at": "2019-07-12T07:41:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27939#issuecomment-394614",
    "user": "chapoton"
}
```

bot is not happy:

```
sage -t --long src/sage/algebras/cluster_algebra.py  # Tab character found
```




---

archive/issue_comments_394615.json:
```json
{
    "body": "Oops. Fixed, sorry Fr\u00e9d\u00e9ric!\n\nWith the occasion I also got some dramatic speedup in `mutate_initial` by not\nmutating F-polynomials a quadratic number of times.\n\nAlso I changed a division into a polynomial division in `_mutated_F`; this\nenforces F-polynomials to live in the correct ambient and yields a decent\nspeedup in `mutate`.",
    "created_at": "2019-07-12T10:24:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27939#issuecomment-394615",
    "user": "etn40ff"
}
```

Oops. Fixed, sorry Frédéric!

With the occasion I also got some dramatic speedup in `mutate_initial` by not
mutating F-polynomials a quadratic number of times.

Also I changed a division into a polynomial division in `_mutated_F`; this
enforces F-polynomials to live in the correct ambient and yields a decent
speedup in `mutate`.



---

archive/issue_comments_394616.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-07-12T11:43:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27939#issuecomment-394616",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_394617.json:
```json
{
    "body": "doc does not build\n\n```\n+[dochtml] OSError: /home/chapoton/sage/local/lib/python2.7/site-packages/sage/algebras/cluster_algebra.py:docstring of sage.algebras.cluster_algebra.ClusterAlgebra.mutate_initial:4: WARNING: Content block expected for the \"WARNING\" directive; none found.\n+Makefile:2036: recipe for target 'doc-html' failed\n```\n\nand missing :: here\n\n```\n+        A faster example without recomputing F-polynomials\n```\n",
    "created_at": "2019-07-12T14:40:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27939#issuecomment-394617",
    "user": "chapoton"
}
```

doc does not build

```
+[dochtml] OSError: /home/chapoton/sage/local/lib/python2.7/site-packages/sage/algebras/cluster_algebra.py:docstring of sage.algebras.cluster_algebra.ClusterAlgebra.mutate_initial:4: WARNING: Content block expected for the "WARNING" directive; none found.
+Makefile:2036: recipe for target 'doc-html' failed
```

and missing :: here

```
+        A faster example without recomputing F-polynomials
```




---

archive/issue_comments_394618.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-07-12T15:05:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27939#issuecomment-394618",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_394619.json:
```json
{
    "body": "Replying to [comment:5 chapoton]:\n> doc does not build\n> {{{\n> +[dochtml] OSError: /home/chapoton/sage/local/lib/python2.7/site-packages/sage/algebras/cluster_algebra.py:docstring of sage.algebras.cluster_algebra.ClusterAlgebra.mutate_initial:4: WARNING: Content block expected for the \"WARNING\" directive; none found.\n> }}}\n\nI have never seen this before, is it just a missing indentation? In case it is fixed now.",
    "created_at": "2019-07-12T15:07:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27939#issuecomment-394619",
    "user": "etn40ff"
}
```

Replying to [comment:5 chapoton]:
> doc does not build
> {{{
> +[dochtml] OSError: /home/chapoton/sage/local/lib/python2.7/site-packages/sage/algebras/cluster_algebra.py:docstring of sage.algebras.cluster_algebra.ClusterAlgebra.mutate_initial:4: WARNING: Content block expected for the "WARNING" directive; none found.
> }}}

I have never seen this before, is it just a missing indentation? In case it is fixed now.



---

archive/issue_comments_394620.json:
```json
{
    "body": "Replying to [comment:7 etn40ff]:\n> Replying to [comment:5 chapoton]:\n> > doc does not build\n> > {{{\n> > +[dochtml] OSError: /home/chapoton/sage/local/lib/python2.7/site-packages/sage/algebras/cluster_algebra.py:docstring of sage.algebras.cluster_algebra.ClusterAlgebra.mutate_initial:4: WARNING: Content block expected for the \"WARNING\" directive; none found.\n> > }}}\n> \n> I have never seen this before, is it just a missing indentation? In case it is fixed now.\n\nYes, that is correct.",
    "created_at": "2019-07-12T16:06:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27939#issuecomment-394620",
    "user": "tscrim"
}
```

Replying to [comment:7 etn40ff]:
> Replying to [comment:5 chapoton]:
> > doc does not build
> > {{{
> > +[dochtml] OSError: /home/chapoton/sage/local/lib/python2.7/site-packages/sage/algebras/cluster_algebra.py:docstring of sage.algebras.cluster_algebra.ClusterAlgebra.mutate_initial:4: WARNING: Content block expected for the "WARNING" directive; none found.
> > }}}
> 
> I have never seen this before, is it just a missing indentation? In case it is fixed now.

Yes, that is correct.



---

archive/issue_comments_394621.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-07-12T17:54:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27939#issuecomment-394621",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_394622.json:
```json
{
    "body": "It would be helpful to have a comment explaining a little bit about how lines 1285 - 1287 work; without explanation, understanding it takes some non-trivial thought.",
    "created_at": "2019-07-12T22:18:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27939#issuecomment-394622",
    "user": "@kelleye"
}
```

It would be helpful to have a comment explaining a little bit about how lines 1285 - 1287 work; without explanation, understanding it takes some non-trivial thought.



---

archive/issue_comments_394623.json:
```json
{
    "body": "Done\n----\nNew commits:",
    "created_at": "2019-07-13T14:05:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27939#issuecomment-394623",
    "user": "etn40ff"
}
```

Done
----
New commits:



---

archive/issue_comments_394624.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-07-22T19:42:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27939#issuecomment-394624",
    "user": "@kelleye"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_394625.json:
```json
{
    "body": "All the changes (and additional comments, thank you!) look good to me.",
    "created_at": "2019-07-22T19:42:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27939#issuecomment-394625",
    "user": "@kelleye"
}
```

All the changes (and additional comments, thank you!) look good to me.



---

archive/issue_comments_394626.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-07-26T20:27:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27939#issuecomment-394626",
    "user": "vbraun"
}
```

Resolution: fixed
