# Issue 27939: Fix few bugs in ClusterAlgebra discovered while working on #26771

Issue created by migration from https://trac.sagemath.org/ticket/28176

Original creator: etn40ff

Original creation time: 2019-07-11 21:06:21

CC:  tscrim gmoose05 stumpc5 @ebanaian drupel @kelleye

Keywords: ClusterAlgebras

As pointed out by the people at #26771, `ClusterAlgebra` has few bugs.

- Default arguments do not play nicely with `UniqueRepresentation`
  
  {{{
    sage: A1 = ClusterAlgebra(['A',2])
    sage: A2 = ClusterAlgebra(['A',2], cluster_variable_prefix='x')
    sage: A1 is A2
    False
  }}}

- `mutate_initial` keeps the same variable names; In theory this is not a
  problem but may create confusion. For example suppose we are looking at the
  Grassmannian of planes in a 4 dimensional vector space. Then the associate
  cluster algebra is

  {{{
    sage: A = ClusterAlgebra( matrix(5,[0,1,-1,1,-1]), cluster_variable_names=['p13'], coefficient_names=['p12','p23','p34','p41'], scalars=QQbar); A
    A Cluster Algebra with cluster variable p13 and coefficients p12, p23, p34, p41 over Algebraic Field
  }}}

  Swapping out `p13` from the initial seed should give `p24` or, at the very
  least *not* `p13`. Getting `p24` requires some understanding of what the ring
  in question really is that goes beyond the scope of this class. Currently we
  get

  {{{
    sage: A.mutate_initial(0)
    A Cluster Algebra with cluster variable p13 and coefficients p12, p23, p34, p41 over Algebraic Field
  }}}

- `mutate_initial` does not compute all the required F-polynomials and it does not enforce the fact that they are not rational expressions

  {{{
    sage: A1 = ClusterAlgebra(['A',[2,1],1])
    sage: A2 = A1.mutate_initial([0,1,0])
    sage: len(A2.g_vectors_so_far()) == len(A2.F_polynomials_so_far())
    False
    sage: all(parent(f) == A2._U for f in A2.F_polynomials_so_far())
    False
  }}}

- finally `mutate_initial` does not enforce the fact that initial g-vectors
  belong to the initial cluster but rather prepend the performed  mutation sequence
  to all the paths already known. 

  {{{
    sage: A2.find_g_vector((0,0,1))
    [0, 1, 0]
  }}}

  This, while technically not false, may generate confusion.

This ticket deals with all these issues.


---

Comment by etn40ff created at 2019-07-11 21:11:23

Changing component from PLEASE CHANGE to algebra.


---

Comment by etn40ff created at 2019-07-11 21:11:23

Changing status from new to needs_review.


---

Comment by etn40ff created at 2019-07-11 21:11:23

New commits:


---

Comment by chapoton created at 2019-07-12 07:41:20

bot is not happy:

```
sage -t --long src/sage/algebras/cluster_algebra.py  # Tab character found
```



---

Comment by etn40ff created at 2019-07-12 10:24:14

Oops. Fixed, sorry Frédéric!

With the occasion I also got some dramatic speedup in `mutate_initial` by not
mutating F-polynomials a quadratic number of times.

Also I changed a division into a polynomial division in `_mutated_F`; this
enforces F-polynomials to live in the correct ambient and yields a decent
speedup in `mutate`.


---

Comment by git created at 2019-07-12 11:43:58

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2019-07-12 14:40:40

doc does not build

```
+[dochtml] OSError: /home/chapoton/sage/local/lib/python2.7/site-packages/sage/algebras/cluster_algebra.py:docstring of sage.algebras.cluster_algebra.ClusterAlgebra.mutate_initial:4: WARNING: Content block expected for the "WARNING" directive; none found.
+Makefile:2036: recipe for target 'doc-html' failed
```

and missing :: here

```
+        A faster example without recomputing F-polynomials
```



---

Comment by git created at 2019-07-12 15:05:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by etn40ff created at 2019-07-12 15:07:31

Replying to [comment:5 chapoton]:
> doc does not build
> {{{
> +[dochtml] OSError: /home/chapoton/sage/local/lib/python2.7/site-packages/sage/algebras/cluster_algebra.py:docstring of sage.algebras.cluster_algebra.ClusterAlgebra.mutate_initial:4: WARNING: Content block expected for the "WARNING" directive; none found.
> }}}

I have never seen this before, is it just a missing indentation? In case it is fixed now.


---

Comment by tscrim created at 2019-07-12 16:06:29

Replying to [comment:7 etn40ff]:
> Replying to [comment:5 chapoton]:
> > doc does not build
> > {{{
> > +[dochtml] OSError: /home/chapoton/sage/local/lib/python2.7/site-packages/sage/algebras/cluster_algebra.py:docstring of sage.algebras.cluster_algebra.ClusterAlgebra.mutate_initial:4: WARNING: Content block expected for the "WARNING" directive; none found.
> > }}}
> 
> I have never seen this before, is it just a missing indentation? In case it is fixed now.

Yes, that is correct.


---

Comment by git created at 2019-07-12 17:54:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kelleye created at 2019-07-12 22:18:20

It would be helpful to have a comment explaining a little bit about how lines 1285 - 1287 work; without explanation, understanding it takes some non-trivial thought.


---

Comment by etn40ff created at 2019-07-13 14:05:32

Done
----
New commits:


---

Comment by @kelleye created at 2019-07-22 19:42:18

Changing status from needs_review to positive_review.


---

Comment by @kelleye created at 2019-07-22 19:42:18

All the changes (and additional comments, thank you!) look good to me.


---

Comment by vbraun created at 2019-07-26 20:27:26

Resolution: fixed
