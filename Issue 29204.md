# Issue 29204: upgrade rpy2 package 2.8.2 -> 3.2.7

Issue created by migration from https://trac.sagemath.org/ticket/29441

Original creator: vdelecroix

Original creation time: 2020-03-31 20:40:11

CC:  mkoeppe charpent @timokau isuruf slelievre arojas embray dimpase

The release 3.2.7 is only Python 3 compatible

tarball: https://files.pythonhosted.org/packages/39/c0/61120f9dae06b4887426d229b68a7a5f0ca1f9cb3986319bb9484819a28d/rpy2-3.2.7.tar.gz


---

Comment by vdelecroix created at 2020-03-31 20:50:47

The `cygwin.patch` does not longer apply.


---

Comment by vdelecroix created at 2020-03-31 21:05:12

`pytest` has a lot of dependencies
- `attrs`
- `importlib-metadata`
- `more-itertools`
- `pluggy`
- `py`
- `zipp`
The easiest might be to patch `rpy2` to not depend on `pytest`. I suspect that only the test suite of `rpy2` depends on `pytest`.


---

Comment by vdelecroix created at 2020-03-31 21:14:39

Good news: tests pass on my machine!


---

Comment by mkoeppe created at 2020-03-31 21:18:16

See #28998	for pytest


---

Comment by charpent created at 2020-03-31 21:20:16

Replying to [comment:4 vdelecroix]:
> `pytest` has a lot of dependencies
> - `attrs`
> - `importlib-metadata`
> - `more-itertools`
> - `pluggy`
> - `py`
> - `zipp`

Tall order, indeed...

> The easiest might be to patch `rpy2` to not depend on `pytest`. I suspect that only the test suite of `rpy2` depends on `pytest`.

My first reaction was: No, no, no, no, no. And no.". A patched version has a very heavy price in terms of maintenance each and every update entails patch checking/upgrading, up to the point the whole mess becomes unmaintainable.

The maintenance price of the added dependencies should be considered, of course, but I suspect that it may be lower than the price of a patch to `rpy2`.


---

Comment by vdelecroix created at 2020-03-31 21:22:24

Replying to [comment:8 mkoeppe]:
> See #28998	for pytest

Thanks for the pointer. Would `pytest` be installed as a "standard" package?


---

Comment by charpent created at 2020-03-31 21:23:03

Replying to [comment:8 mkoeppe]:
> See #28998	for pytest

Dors it need much work ?


---

Comment by charpent created at 2020-03-31 21:25:56

Replying to [comment:10 vdelecroix]:
> Replying to [comment:8 mkoeppe]:
> > See #28998	for pytest
> 
> Thanks for the pointer. Would `pytest` be installed as a "standard" package?

It would have to : `r` depends on `rpy2`, which would depend on `pytest`. ISTR that you yourself stated that having a standard package depend on an optional package would be madness (and I agree...). Therefore...


---

Comment by vdelecroix created at 2020-03-31 21:26:51

New commits:


---

Comment by vdelecroix created at 2020-03-31 21:28:28

As far as tests are concerned, the design of `rpy2` is weird. Tests should be separate from the `rpy2` module (and hence the dependency of `pytest` superfluous).


---

Comment by mkoeppe created at 2020-03-31 21:37:30

Replying to [comment:9 charpent]:
> Milestone changed from sage-9.2 to sage-9.1

Was this intentional?
We definitely cannot drop py2 support for 9.1


---

Comment by vdelecroix created at 2020-03-31 21:38:44

Replying to [comment:15 mkoeppe]:
> Replying to [comment:9 charpent]:
> > Milestone changed from sage-9.2 to sage-9.1
> 
> Was this intentional?
> We definitely cannot drop py2 support for 9.1

Agreed. This was a mistake.


---

Comment by charpent created at 2020-03-31 21:40:54

Replying to [comment:14 vdelecroix]:
> As far as tests are concerned, the design of `rpy2` is weird. Tests should be separate from the `rpy2` module (and hence the dependency of `pytest` superfluous).

Replying to [comment:14 vdelecroix]:
> As far as tests are concerned, the design of `rpy2` is weird. Tests should be separate from the `rpy2` module (and hence the dependency of `pytest` superfluous).

1) Can `rpy2` use packages hypothetically installed by an hypothetical package implementing #28998 ?

2) should we instead wait for an upstream-fixed `rpy2` (supposing that upstream agrees with you...) ?


---

Comment by vdelecroix created at 2020-03-31 21:42:58

Replying to [comment:18 charpent]:
> Replying to [comment:14 vdelecroix]:
> > As far as tests are concerned, the design of `rpy2` is weird. Tests should be separate from the `rpy2` module (and hence the dependency of `pytest` superfluous).
> 
> 2) should we instead wait for an upstream-fixed `rpy2` (supposing that upstream agrees with you...) ?

YES


---

Comment by mkoeppe created at 2020-03-31 21:43:31

rpy2 should be patched so that pytest is not an actual dependency, but test-only. 

rpy2 is missing modern metadata such as requirements.txt, test-requirements.txt, tox.ini where things like this are commonly declared.


#28998 would install pytest only when SAGE_CHECK=yes.


---

Comment by mkoeppe created at 2020-03-31 21:45:01

By the way, I recommend that you add the new `upstream_url` fields to `checksum.ini`.
Makes it easier to test the ticket.


---

Comment by mkoeppe created at 2020-03-31 21:45:49

(See #29425 for an example)


---

Comment by vdelecroix created at 2020-03-31 21:47:20

Replying to [comment:20 mkoeppe]:
> Description modified (diff) 

`@`mkoeppe: Did you intentionally erase my modifications to the ticket description!?


---

Comment by git created at 2020-03-31 21:49:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-31 21:59:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-31 22:01:02

Replying to [comment:23 vdelecroix]:
> Replying to [comment:20 mkoeppe]:
> > Description modified (diff) 
> 
> `@`mkoeppe: Did you intentionally erase my modifications to the ticket description!?

No, sorry! Looks like on this ticket trac is playing funny tricks


---

Comment by git created at 2020-03-31 22:21:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2020-03-31 22:23:15

Ready for tests (especially on cygwin), but not for merging!


---

Comment by vdelecroix created at 2020-03-31 22:23:15

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-03-31 22:28:12

If you want to test cygwin via github actions, be sure to use #29403


---

Comment by vdelecroix created at 2020-04-19 21:24:34

upstream is not (totally) convinced by dropping the pytest dependency. I propose to however keep the patch in Sage (on archlinux `rpy2` does not depend on `pytest` either).

I will add a commit that still installs the test as part of `rpy2` (it did not make much sense to remove it).


---

Comment by git created at 2020-04-20 07:37:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-04-23 03:19:23

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-04-23 03:19:23

Needs rebasing


---

Comment by mkoeppe created at 2020-06-14 20:03:35

#29813 adds `pytest`


---

Comment by mkoeppe created at 2020-06-14 20:04:39

Latest rpy2 is now 3.3.3


---

Comment by git created at 2020-07-03 18:45:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-07-03 18:45:53

Rebased on 9.2.beta2


---

Comment by git created at 2020-07-03 19:03:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-03 19:08:51

Patches need updating!


---

Comment by mkoeppe created at 2020-07-03 19:55:13

https://github.com/rpy2/rpy2/pull/716


---

Comment by git created at 2020-07-04 04:41:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-04 04:43:05

Replying to [comment:18 charpent]:
> Replying to [comment:14 vdelecroix]:
> > As far as tests are concerned, the design of `rpy2` is weird. Tests should be separate from the `rpy2` module (and hence the dependency of `pytest` superfluous).
> 
> 1) Can `rpy2` use packages hypothetically installed by an hypothetical package implementing #28998 ?

Yes, this is done here on the ticket now, using #29813 instead of the larger #28998.


---

Comment by mkoeppe created at 2020-07-04 04:43:56

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-07-04 04:47:33

Build testing runs at https://github.com/mkoeppe/sage/actions/runs/157245915


---

Comment by git created at 2020-07-04 15:46:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-08 15:35:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-08 15:42:00

Replying to [comment:50 mkoeppe]:
> Build testing runs at https://github.com/mkoeppe/sage/actions/runs/157245915
> 
Some unrelated problems are in the way. For example, on `ubuntu-eoan-minimal`, 

```
  [pytest]     Retrying (Retry(total=0, connect=None, read=None, redirect=None, status=None)) after connection broken by 'SSLError("Can't connect to HTTPS URL because the SSL module is not available.")': /simple/pytest/
  [pytest]     Could not fetch URL https://pypi.org/simple/pytest/: There was a problem confirming the ssl certificate: HTTPSConnectionPool(host='pypi.org', port=443): Max 
```



---

Comment by git created at 2020-07-12 05:11:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by charpent created at 2020-07-16 13:44:48

* On Debian testing running n core i7 + 16 GB RAM
* Sage configured to use systemwide R
* Rebase on develop at 9.2.beta5


```
sage: r.sessionInfo()
---------------------------------------------------------------------------
ModuleNotFoundError                       Traceback (most recent call last)
<ipython-input-24-69f706c2bf29> in <module>()
----> 1 r.sessionInfo()

/usr/local/sage-9/local/lib/python3.7/site-packages/sage/interfaces/r.py in __call__(self, *args, **kwds)
   2001             [1] 3
   2002         """
-> 2003         return self._parent.function_call(self._name, args=list(args), kwds=kwds)
   2004 
   2005 def is_RElement(x):

/usr/local/sage-9/local/lib/python3.7/site-packages/sage/interfaces/r.py in function_call(self, function, args, kwds)
   1078         self._check_valid_function_name(function)
   1079         return self.new("%s(%s)"%(function, ",".join([s.name() for s in args] +
-> 1080                                                      [self._sage_to_r_name(key)+'='+kwds[key].name() for key in kwds ] )))
   1081 
   1082     def call(self, function_name, *args, **kwds):

/usr/local/sage-9/local/lib/python3.7/site-packages/sage/interfaces/interface.py in new(self, code)
    368 
    369     def new(self, code):
--> 370         return self(code)
    371 
    372     ###################################################################

/usr/local/sage-9/local/lib/python3.7/site-packages/sage/interfaces/interface.py in __call__(self, x, name)
    294 
    295         if isinstance(x, str):
--> 296             return cls(self, x, name=name)
    297         try:
    298             # Special methods do not and should not have an option to

/usr/local/sage-9/local/lib/python3.7/site-packages/sage/interfaces/interface.py in __init__(self, parent, value, is_name, name)
    716         else:
    717             try:
--> 718                 self._name = parent._create(value, name=name)
    719             except (TypeError, RuntimeError, ValueError) as x:
    720                 raise TypeError(x)

/usr/local/sage-9/local/lib/python3.7/site-packages/sage/interfaces/interface.py in _create(self, value, name)
    499     def _create(self, value, name=None):
    500         name = self._next_var_name() if name is None else name
--> 501         self.set(name, value)
    502         return name
    503 

/usr/local/sage-9/local/lib/python3.7/site-packages/sage/interfaces/r.py in set(self, var, value)
   1124         """
   1125         cmd = '%s <- %s'%(var,value)
-> 1126         out = self.eval(cmd)
   1127 
   1128     def get(self, var):

/usr/local/sage-9/local/lib/python3.7/site-packages/sage/interfaces/r.py in eval(self, code, *args, **kwds)
   1337         """
   1338         self._lazy_init()
-> 1339         return str(robjects.r(code)).rstrip()
   1340 
   1341 

/usr/local/sage-9/local/lib/python3.7/site-packages/sage/misc/lazy_import.pyx in sage.misc.lazy_import.LazyImport.__getattr__ (build/cythonized/sage/misc/lazy_import.c:3525)()
    319             True
    320         """
--> 321         return getattr(self.get_object(), attr)
    322 
    323     # We need to wrap all the slot methods, as they are not forwarded

/usr/local/sage-9/local/lib/python3.7/site-packages/sage/misc/lazy_import.pyx in sage.misc.lazy_import.LazyImport.get_object (build/cythonized/sage/misc/lazy_import.c:2336)()
    186         if likely(self._object is not None):
    187             return self._object
--> 188         return self._get_object()
    189 
    190     cpdef _get_object(self):

/usr/local/sage-9/local/lib/python3.7/site-packages/sage/misc/lazy_import.pyx in sage.misc.lazy_import.LazyImport._get_object (build/cythonized/sage/misc/lazy_import.c:2575)()
    218         elif self._at_startup and not startup_guard:
    219             print('Option ``at_startup=True`` for lazy import {0} not needed anymore'.format(self._name))
--> 220         self._object = getattr(__import__(self._module, {}, {}, [self._name]), self._name)
    221         name = self._as_name
    222         if self._deprecation is not None:

/usr/local/sage-9/local/lib/python3.7/site-packages/rpy2/robjects/__init__.py in <module>()
     24 
     25 from . import conversion
---> 26 from . import vectors
     27 from . import language
     28 

/usr/local/sage-9/local/lib/python3.7/site-packages/rpy2/robjects/vectors.py in <module>()
     14 import time
     15 import pytz
---> 16 import tzlocal
     17 from datetime import date, datetime, timedelta, timezone
     18 from time import struct_time, mktime, tzname

ModuleNotFoundError: No module named 'tzlocal'
```


All othetr attemps end up similarly.

==>`needs_work`


---

Comment by charpent created at 2020-07-16 13:44:48

Changing status from needs_review to needs_work.


---

Attachment

Doctest for src/sage/interfaces/r.py


---

Comment by charpent created at 2020-07-16 14:11:09

Replying to [comment:61 charpent]:
> * On Debian testing running n core i7 + 16 GB RAM
> * Sage configured to use systemwide R
> * Rebase on develop at 9.2.beta5

[ Snip... ]

BTW, `sage -t --long src/sage/interfaces/r.py` gives the enclosed `rdoctest.txt.gz`

HTH,


---

Comment by dimpase created at 2020-07-16 15:32:40

yeah, I see this error too.


---

Comment by dimpase created at 2020-07-16 15:39:09

missing dep, can be installed using pip:

```
$ ./sage --pip install tzlocal
Collecting tzlocal
  Downloading tzlocal-2.1-py2.py3-none-any.whl (16 kB)
Requirement already satisfied: pytz in ./local/lib/python3.7/site-packages (from tzlocal) (2018.7)
Installing collected packages: tzlocal
Successfully installed tzlocal-2.1
dimpase@penguin:~/sage$ ./sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.2.beta5, Release Date: 2020-07-12               │
│ Using Python 3.7.3. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: r.sessionInfo()
R version 3.5.2 (2018-12-20)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Debian GNU/Linux 10 (buster)

Matrix products: default
BLAS: /usr/lib/x86_64-linux-gnu/openblas/libblas.so.3
LAPACK: /usr/lib/x86_64-linux-gnu/openblas/liblapack.so.3

locale:
 [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
 [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
 [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
 [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
 [9] LC_ADDRESS=C               LC_TELEPHONE=C            
[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       

attached base packages:
[1] tools     stats     graphics  grDevices utils     datasets  methods  
[8] base     

loaded via a namespace (and not attached):
[1] compiler_3.5.2
```



---

Comment by charpent created at 2020-07-16 16:42:54

Replying to [comment:64 dimpase]:
> missing dep, can be installed using pip:

[ Snip... ]

Could you add the relevant commit(s) to this branch before a new test ?


---

Comment by dimpase created at 2020-07-16 17:00:03

this seems to need addition of a new pip package, no?


---

Comment by dimpase created at 2020-07-16 17:03:46

oops, the package is there, it's just not getting installed for some reason, I guess
due to something fishy in

```diff
--- a/build/pkgs/rpy2/dependencies
+++ b/build/pkgs/rpy2/dependencies
@@ -1,4 +1,4 @@
-$(PYTHON) r six | $(PYTHON_TOOLCHAIN)
+$(PYTHON) r cffi | $(PYTHON_TOOLCHAIN) pycparser $(and $(filter-out no,$(SAGE_CHECK_rpy2)), pytest tzlocal numpy)
 }}}


---

Comment by mkoeppe created at 2020-07-16 17:11:28

tzlocal is only pulled in for tests (`SAGE_CHECK=yes`). Is it needed for normal installation or at runtime as well?


---

Comment by mkoeppe created at 2020-07-16 17:12:50

In that case, we would have to add it as a normal package.


---

Comment by mkoeppe created at 2020-07-16 17:14:21

... and update package pytz to 2020.1


---

Comment by mkoeppe created at 2020-07-16 17:16:27

Looking at the traceback in comment 61, the answer seems to be "yes".

I'll prepare the pytz update first.


---

Comment by git created at 2020-07-16 17:21:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-16 17:27:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-16 17:28:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-16 17:28:37

Changing status from needs_work to needs_review.


---

Comment by git created at 2020-07-16 17:49:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-16 17:51:08

3.3.5 has a bugfix but did not backport https://github.com/rpy2/rpy2/pull/716, so we have to keep it as a patch.


---

Comment by charpent created at 2020-07-16 18:00:31

Replying to [comment:77 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[4ce8970](https://git.sagemath.org/sage.git/commit/?id=4ce897074e0570143ec4642a91bf2d846f313635)||`build/pkgs/rpy2: Update to 3.3.5`||

The mails emanating from Trac are not timely. So //please// don't update this branch just after asking for review... and //please// return state to `needs_work` before doing so.


---

Comment by mkoeppe created at 2020-07-16 18:04:19

Thanks for taking the time to test.


---

Comment by charpent created at 2020-07-16 19:58:35

* Debian testing running on core i7 + 16 GB RAM
* Sage configured to use system's R (4.0.2, as packaged by Debian)
* Rebased on 9.2.beta5 (penibly : 5 merge conflicts...)

Compiles fine. Some rough tests in the Jupyter notebook.

```
sage -t --long --warn-long 194.3 src/sage/interfaces/r.py
    [257 tests, 4.80 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 4.9 seconds
    cpu time: 4.5 seconds
    cumulative wall time: 4.8 seconds
```


`ptestlong` underway.


---

Comment by mkoeppe created at 2020-07-16 20:03:40

Replying to [comment:81 charpent]:
> * Rebased on 9.2.beta5 (penibly : 5 merge conflicts...)

Thanks for pointing this out - I've just merged 9.2.beta5 into dependency #30118


---

Comment by mkoeppe created at 2020-07-16 20:05:00

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-07-16 20:05:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-16 20:06:29

Now it's on top of 9.2.beta5.


---

Comment by mkoeppe created at 2020-07-16 20:06:34

Changing status from needs_work to needs_review.


---

Comment by charpent created at 2020-07-16 20:11:38

Replying to [comment:86 mkoeppe]:

You did it. Again...


---

Comment by mkoeppe created at 2020-07-16 20:15:44

Do you have additional ways of testing the R interface, or thoughts how we could expand the automatic tests? The big problem with R integration in Sage is that essentially there is none - just a few basic tests in `r.py`.


---

Comment by mkoeppe created at 2020-07-16 21:01:43

By the way, you can verify that your rebased tree is identical to the one from my merge by doing `git trac fetch 29441 && git reset FETCH_HEAD`.


---

Comment by mkoeppe created at 2020-07-16 21:04:59

Automatic tests (of commit 4ce897074e, together with some other upgrade tickets) run at https://github.com/mkoeppe/sage/actions/runs/171722885


---

Comment by charpent created at 2020-07-16 22:37:12

Replying to [comment:87 charpent]:
> Replying to [comment:86 mkoeppe]:
> 
> You did it. Again...

On Debian testing running on ore i7 + 16 GB RAM, after rebasing #29441 on 9.2.beta5, `ptestlong` gives 9 permanent (and no transient) failures :


```
```

| File                            | Result             | P/T | Notes            |
|---------------------------------+--------------------+-----+------------------|
| src/sage/doctest/test.py        | 23 doctests failed | P   | Ununderstandable |
| src/sage/plot/plot.py           | 1 doctest failed   | P   | Cosmetic ?       |
| src/sage/tests/cmdline.py       | 31 doctests failed | P   | Cosmetic ?       |
| src/sage/libs/ppl.pyx           | 9 doctests failed  | P   | Cosmetic ?       |
| src/sage/repl/interpreter.py    | 1 doctest failed   | P   | Cosmetic ?       |
| src/sage/rings/complex_arb.pyx  | 6 doctests failed  | P   | Known            |
| src/sage/misc/temporary_file.py | 1 doctest failed   | P   | Cosmetic ?       |
| src/sage/tests/gap_packages.py  | 1 doctest failed   | P   | Known, cosmetic  |
| src/sage/rings/real_arb.pyx     | 2 doctests failed  | P   | Known            |
FWIW, the same tests gave 3 permanent and one transient failures on 9.2.beta5 (identical to those reported for beta2 and beta4) :


```
```

| File                           | Result            | P/T |
|--------------------------------+-------------------+-----|
| src/sage/tests/parigp.py       | Timed out         | T   |
| src/sage/rings/complex_arb.pyx | 6 doctests failed | P   |
| src/sage/tests/gap_packages.py | 1 doctest failed  | P   |
| src/sage/rings/real_arb.pyx    | 2 doctests failed | P   |
Most of the "new" errors seems to be bound to a runtime redefinition of SAGE_ROOT, changing from `/usr/local/sag` to `/usr/local/sage-9` (on my system, the former is a symlink to the latter, and `/usr/local/bin/sage` is a symlink to `/usr/local/sage/sage` ; this allows for a quick switch of Sage trees...).

I upload `chkerrs.txt` which is the log of re-running failed tests.

I'll retest the latest state of this branch when I have some credible indication that it is indeed intended to be stable...


---

Attachment

Thanks for testing. We have a fix for the symlink behavior in #29446. This is unrelated to the present ticket.


---

Comment by mkoeppe created at 2020-07-16 22:42:07

In case you did not see this:

Replying to [comment:88 mkoeppe]:
> Do you have additional ways of testing the R interface, or thoughts how we could expand the automatic tests? The big problem with R integration in Sage is that essentially there is none - just a few basic tests in `r.py`.


---

Comment by mkoeppe created at 2020-07-16 22:59:34

`cygwin-standard` build succeeded at https://github.com/mkoeppe/sage/runs/879259688

`cygwin-minimal` did not get to `rpy2` because of unrelated problems


---

Comment by charpent created at 2020-07-17 07:12:53

Changing status from needs_review to positive_review.


---

Comment by charpent created at 2020-07-17 07:12:53

Replying to [comment:91 charpent]:

[ Snip... ]

> I'll retest the latest state of this branch when I have some credible indication that it is indeed intended to be stable...irmed by someone using Sage's interpreter

I now have done so, and get identical results.

My //impression// is that this upgrade doesn't bring new detectable bugs : the "new" bugs I have found seem unrelated.

==>`positive_review`.

However, I //strongly// advise a confirmation of  this review by someone using Sage's R interpreter.


---

Comment by mkoeppe created at 2020-07-17 07:20:43

Thank you.


---

Comment by vbraun created at 2020-07-22 22:38:20


```
File "src/sage/stats/r.py", line 42, in sage.stats.r.ttest
Failed example:
    a, b = ttest([1,2,3,4,5],[1,2,3,3.5,5.121]); a # abs tol 1e-12
Exception raised:
    Traceback (most recent call last):
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/interfaces/interface.py", line 331, in _coerce_from_special_method
        return (x.__getattribute__(s))(self)
      File "sage/structure/element.pyx", line 493, in sage.structure.element.Element.__getattr__ (build/cythonized/sage/structure/element.c:4644)
        return self.getattr_from_category(name)
      File "sage/structure/element.pyx", line 506, in sage.structure.element.Element.getattr_from_category (build/cythonized/sage/structure/element.c:4756)
        return getattr_from_other_class(self, cls, name)
      File "sage/cpython/getattr.pyx", line 394, in sage.cpython.getattr.getattr_from_other_class (build/cythonized/sage/cpython/getattr.c:2641)
        raise AttributeError(dummy_error_message)
    AttributeError: 'sage.rings.integer.Integer' object has no attribute '_r_'
    During handling of the above exception, another exception occurred:
    Traceback (most recent call last):
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 715, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1139, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.stats.r.ttest[0]>", line 1, in <module>
        a, b = ttest([Integer(1),Integer(2),Integer(3),Integer(4),Integer(5)],[Integer(1),Integer(2),Integer(3),RealNumber('3.5'),RealNumber('5.121')]); a # abs tol 1e-12
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/stats/r.py", line 48, in ttest
        test = myR.t_test(x,y,conf_level = conf_level, **kw)._sage_()
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/interfaces/r.py", line 2003, in __call__
        return self._parent.function_call(self._name, args=list(args), kwds=kwds)
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/interfaces/r.py", line 1077, in function_call
        args, kwds = self._convert_args_kwds(args, kwds)
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/interfaces/interface.py", line 557, in _convert_args_kwds
        args[i] = self(arg)
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/interfaces/interface.py", line 310, in __call__
        result = self._coerce_impl(x, use_special=False)
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/interfaces/r.py", line 558, in _coerce_impl
        return super(R, self)._coerce_impl(x, use_special=use_special)
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/interfaces/interface.py", line 359, in _coerce_impl
        w = self(v)
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/interfaces/interface.py", line 303, in __call__
        result = self._coerce_from_special_method(x)
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/interfaces/interface.py", line 333, in _coerce_from_special_method
        return self(x._interface_init_())
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/interfaces/interface.py", line 296, in __call__
        return cls(self, x, name=name)
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/interfaces/interface.py", line 718, in __init__
        self._name = parent._create(value, name=name)
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/interfaces/interface.py", line 501, in _create
        self.set(name, value)
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/interfaces/r.py", line 1126, in set
        out = self.eval(cmd)
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/interfaces/r.py", line 1338, in eval
        self._lazy_init()
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/interfaces/r.py", line 541, in _lazy_init
        self._r_to_sage_converter = _setup_r_to_sage_converter()
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/sage/interfaces/r.py", line 367, in _setup_r_to_sage_converter
        from rpy2.robjects.conversion import Converter
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/rpy2/robjects/__init__.py", line 19, in <module>
        from rpy2.robjects.robject import RObjectMixin, RObject
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/rpy2/robjects/robject.py", line 58, in <module>
        class RObjectMixin(object):
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/rpy2/robjects/robject.py", line 70, in RObjectMixin
        __show = _get_exported_value('methods', 'show')
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/rpy2/rinterface_lib/conversion.py", line 44, in _
        cdata = function(*args, **kwargs)
      File "/home/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/rpy2/rinterface.py", line 624, in __call__
        raise embedded.RRuntimeError(_rinterface._geterrmessage())
    rpy2.rinterface_lib.embedded.RRuntimeError: Error in dyn.load(file, DLLpath = DLLpath, ...) : 
      unable to load shared object '/home/buildbot/slave/sage_git/build/local/lib/R/library/methods/libs/methods.so':
      libR.so: cannot open shared object file: No such file or directory
```



---

Comment by vbraun created at 2020-07-22 22:38:20

Changing status from positive_review to needs_work.


---

Comment by mkoeppe created at 2020-07-22 22:39:51

on what machine


---

Comment by vbraun created at 2020-07-23 07:21:38

Doesn't appear to be machin specific, e.g. http://build.sagemath.org/#/builders/35/builds/1


---

Comment by dimpase created at 2020-07-23 07:59:29

maybe we only tested on `libR` coming from the system?


---

Comment by charpent created at 2020-07-23 16:52:29

Replying to [comment:101 dimpase]:
> maybe we only tested on `libR` coming from the system?

That's why I advised to test on a machine using Sage's R...


---

Comment by mkoeppe created at 2020-07-23 17:10:07

Replying to [comment:100 vbraun]:
> Doesn't appear to be machin specific, e.g. http://build.sagemath.org/#/builders/35/builds/1

The build log there is not helpful. rpy2 was not built in that run.


---

Comment by mkoeppe created at 2020-07-23 17:14:43

Replying to [comment:101 dimpase]:
> maybe we only tested on `libR` coming from the system?

Of course we test builds where R is built as an spkg. 
That's pretty much the point of the `-minimal` builds.


---

Comment by mkoeppe created at 2020-07-23 17:15:16

And I do see this error in a (from scratch) build for `linuxmint-19-minimal` at https://github.com/mkoeppe/sage/runs/878897239?check_suite_focus=true


---

Comment by mkoeppe created at 2020-07-23 17:24:12

Replying to [comment:102 charpent]:
> Replying to [comment:101 dimpase]:
> > maybe we only tested on `libR` coming from the system?
> 
> That's why I advised to test on a machine using Sage's R...

Yes, you were right about this. We have a systematic problem with R in Sage. I think in the long run we will have to make R an optional or experimental package (a remedy that I brought up before, during the 9.1 cycle) -- unless developers step up and take over maintenance of the R / rpy2 spkgs in Sage.


---

Comment by mkoeppe created at 2020-07-23 17:31:12

Replying to [comment:105 mkoeppe]:
> And I do see this error in a (from scratch) build for `linuxmint-19-minimal` at https://github.com/mkoeppe/sage/runs/878897239?check_suite_focus=true

```
docker run -it docker.pkg.github.com/mkoeppe/sage/sage-docker-linuxmint-19-minimal-with-targets:9.1.rc4-68125-g83dfe657f5
```



---

Comment by mkoeppe created at 2020-07-23 18:04:08


```
# ldd /sage/local/lib/R/library/methods/libs/methods.so
	linux-vdso.so.1 (0x00007ffea0df9000)
	libR.so => not found
	libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f605284e000)
	/lib64/ld-linux-x86-64.so.2 (0x00007f6052e49000)
```



---

Comment by git created at 2020-07-23 18:50:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-23 18:55:54

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mkoeppe created at 2020-07-23 18:58:22

Tests run at https://github.com/mkoeppe/sage/actions/runs/180231628


---

Comment by mkoeppe created at 2020-07-23 18:58:30

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-07-25 18:32:14

Replying to [comment:113 mkoeppe]:
> Tests run at https://github.com/mkoeppe/sage/actions/runs/180231628

Tests look all clean now, including the `-minimal` platforms that failed previously.

Needs review.


---

Comment by git created at 2020-07-25 23:54:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-07-26 22:58:46

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-07-26 22:58:46

looks ok


---

Comment by mkoeppe created at 2020-07-26 23:00:37

Thanks!


---

Comment by vbraun created at 2020-08-02 08:20:57

Resolution: fixed


---

Comment by jhpalmieri created at 2020-09-04 02:47:18

This ticket causes some warning messages to be printed to the screen during doctesting:

```
% ./sage -t src/sage/interfaces/r.py
Running doctests with ID 2020-09-03-19-46-40-e4332149.
Git branch: t/29441/54d0f9927d3bd2b1b24a1ca3b2fb9c15a1df816c
Using --optional=build,dochtml,sage
Doctesting 1 file.
R[write to console]: Warning messages:

R[write to console]: 1: 
R[write to console]: In sage10 + sage6 :
R[write to console]: 
 
R[write to console]:  longer object length is not a multiple of shorter object length

R[write to console]: 2: 
R[write to console]: In sqrt(sage10) :
R[write to console]:  NaNs produced

R[write to console]: 3: 
R[write to console]: In sqrt(sage4) :
R[write to console]:  NaNs produced

sage -t --warn-long 83.1 --random-seed=0 src/sage/interfaces/r.py
    [257 tests, 3.44 s]
----------------------------------------------------------------------
All tests passed!
```

I think these should be silenced.
