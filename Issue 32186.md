# Issue 32186: Update numpy to 1.22.x, scipy 1.8.x - requires dropping python 3.7

Issue created by migration from https://trac.sagemath.org/ticket/32423

Original creator: mkoeppe

Original creation time: 2021-08-25 19:37:46

CC:  dimpase fbissey tmonteil

These updates:
- `numpy` 1.22.0 https://numpy.org/devdocs/release/1.22.0-notes.html
- `scipy` 1.8.0 
will require us to drop python 3.7 support.

Related: 
- #30384 NEP 29
- #29756 Meta-ticket: Review of Python 3 features that sagelib should use systematically


---

Comment by arojas created at 2022-02-06 10:08:37

Untested on sage-the-distro, this works on Arch. Should be rebased after #33049 is merged I guess.
----
New commits:


---

Comment by mkoeppe created at 2022-02-06 18:48:50

Is the fix for the deprecation warning also OK for early scipy?
Then it's better to put it on a separate ticket that can be merged earlier.

(I think I would want to hold off on the scipy 1.8 upgrade for a little while - maybe it should go into Sage 9.7, not 9.6)


---

Comment by arojas created at 2022-02-13 19:00:07

Replying to [comment:8 mkoeppe]:
> Is the fix for the deprecation warning also OK for early scipy?
> Then it's better to put it on a separate ticket that can be merged earlier.

Done #33336


---

Comment by git created at 2022-02-13 19:06:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2022-03-13 14:29:00

Opened #33495 to fix test regressions with networkx 2.7


---

Comment by mkoeppe created at 2022-04-21 00:06:28

Last 10 new commits:


---

Comment by git created at 2022-04-21 00:14:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-12 18:37:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-05-12 18:39:22

Changing status from new to needs_review.


---

Comment by git created at 2022-05-13 23:05:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-14 02:48:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-05-15 05:09:59

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2022-05-15 05:09:59

scipy fails on `cygwin-standard` -
https://github.com/sagemath/sagetrac-mirror/runs/6436093618?check_suite_focus=true

```
  scipy/stats/_hypotests_pythran.cpp: At global scope:
  scipy/stats/_hypotests_pythran.cpp:256:10: error: expected identifier before numeric constant
    256 |   struct _P
        |          ^~
  scipy/stats/_hypotests_pythran.cpp:256:10: error: expected unqualified-id before numeric constant
  scipy/stats/_hypotests_pythran.cpp:584:12: error: expected nested-name-specifier before numeric constant
    584 |   typename _P::type<argument_type0>::result_type _P::operator()(argument_type0&& A) const
        |            ^~
  scipy/stats/_hypotests_pythran.cpp:584:12: error: expected unqualified-id before numeric constant
  scipy/stats/_hypotests_pythran.cpp:790:40: error: expected identifier before numeric constant
    790 | typename __pythran__hypotests_pythran::_P::type<pythonic::types::ndarray<long,pythonic::types::pshape<long,long>>>::result_type _P0(pythonic::types::ndarray<long,pythonic::types::pshape<long,long>>&& A)
        |                                        ^~
  scipy/stats/_hypotests_pythran.cpp:790:40: error: expected unqualified-id before numeric constant
  scipy/stats/_hypotests_pythran.cpp:806:40: error: expected identifier before numeric constant
    806 | typename 
```



---

Comment by mkoeppe created at 2022-05-15 05:11:54

Likely the same macro name clash as #33284


---

Comment by mkoeppe created at 2022-05-15 05:14:22

Fixed upstream in https://github.com/scipy/scipy/pull/15580


---

Comment by mkoeppe created at 2022-05-15 05:27:56

There's no backport to the 1.8.x branch yet


---

Comment by git created at 2022-05-20 16:48:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-20 16:49:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-05-20 16:51:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-05-20 16:55:47

Changing status from needs_work to needs_review.


---

Comment by git created at 2022-06-09 19:47:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-25 19:12:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-25 19:12:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-06-27 17:10:42

This appears to break 32bit platforms - for example `ubuntu-bionic-i386` (https://github.com/mkoeppe/sage/runs/7056480485?check_suite_focus=true) - numpy's build system appears to think it's building for `x86_64`


---

Comment by mkoeppe created at 2022-06-27 17:10:42

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2022-06-29 18:17:55

Same problem with numpy 1.23.0


---

Comment by mkoeppe created at 2022-06-29 18:37:59

This looks similar to https://github.com/numpy/numpy/issues/14233 - recommendation there is to upgrade binutils 2.25 or higher


---

Comment by mkoeppe created at 2022-06-29 18:40:08

However, ubuntu-bionic-i386 uses binutils 2.30


---

Comment by mkoeppe created at 2022-06-29 18:51:34

Actually it's https://github.com/numpy/numpy/issues/20736


---

Comment by mkoeppe created at 2022-06-29 19:13:21

The workaround `export NPY_DISABLE_SVML=1` works


---

Comment by git created at 2022-06-29 19:43:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-06-29 19:46:00

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-06-30 19:27:07

Fails on local-macos (2, homebrew-macos-usrlocal-standard, default, macos-latest) https://github.com/mkoeppe/sage/runs/7121386623
(tested with #33530, thus with the setuptools upgrade!)


---

Comment by mkoeppe created at 2022-06-30 20:01:42

from the log:

```
Processing /Users/runner/work/sage/sage/.tox/local-homebrew-macos-usrlocal-standard/local/var/tmp/sage/build/numpy-1.22.4/src
  Preparing metadata (setup.py): started
  Running command python setup.py egg_info
  Running from numpy source directory.
  Traceback (most recent call last):
    File "<string>", line 2, in <module>
    File "<pip-setuptools-caller>", line 34, in <module>
    File "/Users/runner/work/sage/sage/.tox/local-homebrew-macos-usrlocal-standard/local/var/tmp/sage/build/numpy-1.22.4/src/setup.py", line 92, in <module>
      raise RuntimeError("setuptools versions >= '60.0.0' require "
  RuntimeError: setuptools versions >= '60.0.0' require SETUPTOOLS_USE_DISTUTILS=stdlib in the environment
  error: subprocess-exited-with-error
  
  Ã— python setup.py egg_info did not run successfully.
```



---

Comment by mkoeppe created at 2022-06-30 20:04:25

That's from https://github.com/numpy/numpy/blob/main/setup.py#L86


---

Comment by mkoeppe created at 2022-06-30 20:11:33

We are setting `SETUPTOOLS_USE_DISTUTILS=local` on homebrew to avoid homebrew's distutils.cfg, which is still present (and broken) in pre-3.10 versions:

```
$ find /usr/local/opt/python@3.7/ -name distutils.cfg
/usr/local/opt/python@3.7//Frameworks/Python.framework/Versions/3.7/lib/python3.7/distutils/distutils.cfg
$ find /usr/local/opt/python@3.8/ -name distutils.cfg
/usr/local/opt/python@3.8//Frameworks/Python.framework/Versions/3.8/lib/python3.8/distutils/distutils.cfg
$ find /usr/local/opt/python@3.9/ -name distutils.cfg
/usr/local/opt/python@3.9//Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/distutils.cfg
$ find /usr/local/opt/python@3.10/ -name distutils.cfg
$ cat /usr/local/opt/python@3.9//Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/distutils.cfg
[install]
prefix=/usr/local
[build_ext]
include_dirs=/usr/local/include:/usr/local/opt/openssl@1.1/include:/usr/local/opt/sqlite/include
library_dirs=/usr/local/lib:/usr/local/opt/openssl@1.1/lib:/usr/local/opt/sqlite/lib
```



---

Comment by mkoeppe created at 2022-06-30 20:16:01

This code is from https://github.com/numpy/numpy/pull/20963. I'll just patch it out.


---

Comment by mkoeppe created at 2022-06-30 20:28:52

That's now https://github.com/numpy/numpy/pull/21891


---

Comment by git created at 2022-06-30 20:54:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-07-01 00:40:28

Replying to [comment:48 mkoeppe]:
> The workaround `export NPY_DISABLE_SVML=1` works

Upstream PR to make this workaround unnecessary (for i386 on x86_64): https://github.com/numpy/numpy/pull/21896


---

Comment by mkoeppe created at 2022-07-03 19:36:07

Let's get this upgrade in please


---

Comment by dimpase created at 2022-07-04 20:03:13

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2022-07-04 20:03:13

lgtm


---

Comment by mkoeppe created at 2022-07-04 21:00:21

Thanks!


---

Comment by vbraun created at 2022-07-09 22:33:45

Resolution: fixed
