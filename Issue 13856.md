# Issue 13856: Some elliptic curve functions fail since pari_curve is created with insufficient precision

archive/issues_013856.json:
```json
{
    "body": "Assignee: cremona\n\nCC:  wuthrich\n\nKeywords: pari precision\n\nThis fails on a 32-bit machine (Sage-5.6):\n\n```\nsage: EllipticCurve([0, -1, 0, -360796668980, 83414685883377400]).minimal_quadratic_twist()\n```\n\nbecause it results in pari_curve() being called on some curves with no attempt to catch insufficient precision.\n\nTwo things needs fixing:  (1) Making sure that all calls to pari_curve() deal with this precision issue properly;  (2) a better implementation of minimal_quadratic_twist(), for example if the conductor is square-free then there is no need to do so much rwork as is currently done.  Additionally, when j(E)=0 or 1728 the curve returned is a minimal twist, but not necessarily a quadratic twist, so the documentation (or function name, or something) needs correcting.\n\nIssue created by migration from https://trac.sagemath.org/ticket/14060\n\n",
    "created_at": "2013-02-05T11:56:34Z",
    "labels": [
        "elliptic curves",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.2",
    "title": "Some elliptic curve functions fail since pari_curve is created with insufficient precision",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13856",
    "user": "cremona"
}
```
Assignee: cremona

CC:  wuthrich

Keywords: pari precision

This fails on a 32-bit machine (Sage-5.6):

```
sage: EllipticCurve([0, -1, 0, -360796668980, 83414685883377400]).minimal_quadratic_twist()
```

because it results in pari_curve() being called on some curves with no attempt to catch insufficient precision.

Two things needs fixing:  (1) Making sure that all calls to pari_curve() deal with this precision issue properly;  (2) a better implementation of minimal_quadratic_twist(), for example if the conductor is square-free then there is no need to do so much rwork as is currently done.  Additionally, when j(E)=0 or 1728 the curve returned is a minimal twist, but not necessarily a quadratic twist, so the documentation (or function name, or something) needs correcting.

Issue created by migration from https://trac.sagemath.org/ticket/14060





---

archive/issue_comments_172520.json:
```json
{
    "body": "Precision issue is #13163.",
    "created_at": "2014-01-09T21:07:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13856",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13856#issuecomment-172520",
    "user": "jdemeyer"
}
```

Precision issue is #13163.



---

archive/issue_comments_172521.json:
```json
{
    "body": "I see two possibilities here:  either rename this function `minimal_twist()` and return (as it does now) a curve which may be a sextic or quartic twist when j=0 or j=1728;   or keep this name and be more restrictive for those j-invariants so that the returned curve literally is a quadratic twist.  A third possibility is to have both named functions, doing the same thing unless j=0 or j=1728.\n\nI am CC-ing Chris W since the only place where this function is used (according to `search_src()`) is in `sha_tate.py`, line 540, and whatever we do must be compatible with what is needed there!\n\nOf course this is in addition to adding one line to return self of `self.conductor().is_squarefree()`.",
    "created_at": "2014-01-11T16:21:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13856",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13856#issuecomment-172521",
    "user": "cremona"
}
```

I see two possibilities here:  either rename this function `minimal_twist()` and return (as it does now) a curve which may be a sextic or quartic twist when j=0 or j=1728;   or keep this name and be more restrictive for those j-invariants so that the returned curve literally is a quadratic twist.  A third possibility is to have both named functions, doing the same thing unless j=0 or j=1728.

I am CC-ing Chris W since the only place where this function is used (according to `search_src()`) is in `sha_tate.py`, line 540, and whatever we do must be compatible with what is needed there!

Of course this is in addition to adding one line to return self of `self.conductor().is_squarefree()`.



---

archive/issue_comments_172522.json:
```json
{
    "body": "In sha_tate and in general for p-adic L-functions we can only twist by quadratic characters (well, I can only, maybe someone else knows more). So if changing the function one has to be careful to twist only by quadratic twists for these two cm curves. But if I remember correctly, we currently exclude cm curve (which we would not have to do in fact).",
    "created_at": "2014-01-11T16:38:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13856",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13856#issuecomment-172522",
    "user": "wuthrich"
}
```

In sha_tate and in general for p-adic L-functions we can only twist by quadratic characters (well, I can only, maybe someone else knows more). So if changing the function one has to be careful to twist only by quadratic twists for these two cm curves. But if I remember correctly, we currently exclude cm curve (which we would not have to do in fact).



---

archive/issue_comments_172523.json:
```json
{
    "body": "Looking more carefully at the code (I am not embarrassed that I wrote it but could not remember) I see that for j=0 and j=1728 the curve returned is always a quadratic twist.  So the \"additionally\" part of the ticket's current description is incorrect.\n\nIf you agree with me on that (and a second opinion would be welcome!) then that just leaves the first part which I can easily implement by adding one line.",
    "created_at": "2014-01-11T17:05:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13856",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13856#issuecomment-172523",
    "user": "cremona"
}
```

Looking more carefully at the code (I am not embarrassed that I wrote it but could not remember) I see that for j=0 and j=1728 the curve returned is always a quadratic twist.  So the "additionally" part of the ticket's current description is incorrect.

If you agree with me on that (and a second opinion would be welcome!) then that just leaves the first part which I can easily implement by adding one line.



---

archive/issue_comments_172524.json:
```json
{
    "body": "We could have a minimal_twist function, too, if you wish, but I need minimal_quadratic_twist for modular symbols. If you can simplify the current function that is certainly a good thing to do.\n\nI am not sure what changes you want to make, but if you do them, I should be able to look at them and review it quickly.\n\n(from Besancon)",
    "created_at": "2014-01-11T17:17:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13856",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13856#issuecomment-172524",
    "user": "wuthrich"
}
```

We could have a minimal_twist function, too, if you wish, but I need minimal_quadratic_twist for modular symbols. If you can simplify the current function that is certainly a good thing to do.

I am not sure what changes you want to make, but if you do them, I should be able to look at them and review it quickly.

(from Besancon)



---

archive/issue_comments_172525.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-01-11T18:13:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13856",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13856#issuecomment-172525",
    "user": "cremona"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_172526.json:
```json
{
    "body": "I have implemented the small improvement (do nothing if the conductor is square-free) with a new doctest, and also expanded on the documentation in the exceptional cases j=0, 1728 to remove any confusion, with an example!\n\nI decided not to implement a new `minimal_twist()` function since \n\n```\nEllipticCurve(j=E.j_invariant())\n```\n\ndoes that.  But I could.\n----\nLast 10 new commits:",
    "created_at": "2014-01-11T18:13:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13856",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13856#issuecomment-172526",
    "user": "cremona"
}
```

I have implemented the small improvement (do nothing if the conductor is square-free) with a new doctest, and also expanded on the documentation in the exceptional cases j=0, 1728 to remove any confusion, with an example!

I decided not to implement a new `minimal_twist()` function since 

```
EllipticCurve(j=E.j_invariant())
```

does that.  But I could.
----
Last 10 new commits:



---

archive/issue_comments_172527.json:
```json
{
    "body": "There are lots of commits listed above, none of which is mine.  The relevant one, which you can see by clicking on the branch name, is dc07e494c5230bef1dd7e1a0df351194a03acb36 .",
    "created_at": "2014-01-11T18:15:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13856",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13856#issuecomment-172527",
    "user": "cremona"
}
```

There are lots of commits listed above, none of which is mine.  The relevant one, which you can see by clicking on the branch name, is dc07e494c5230bef1dd7e1a0df351194a03acb36 .



---

archive/issue_comments_172528.json:
```json
{
    "body": "the `note` field is only indented by 3 spaces, there should be 4",
    "created_at": "2014-01-12T20:25:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13856",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13856#issuecomment-172528",
    "user": "chapoton"
}
```

the `note` field is only indented by 3 spaces, there should be 4



---

archive/issue_comments_172529.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-01-23T23:19:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13856",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13856#issuecomment-172529",
    "user": "wuthrich"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_172530.json:
```json
{
    "body": "I rebased it to the 6.1.beta6 in the hope that the extra merge commits above do not show anymore (even if they are harmless. \n\nSince all test then pass for me, I give it a positive review.\n----\nNew commits:",
    "created_at": "2014-01-23T23:19:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13856",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13856#issuecomment-172530",
    "user": "wuthrich"
}
```

I rebased it to the 6.1.beta6 in the hope that the extra merge commits above do not show anymore (even if they are harmless. 

Since all test then pass for me, I give it a positive review.
----
New commits:



---

archive/issue_comments_172531.json:
```json
{
    "body": "By the way, I believe there are 4 spaces before the ..note. No ? At least the html output seems ok.",
    "created_at": "2014-01-23T23:20:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13856",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13856#issuecomment-172531",
    "user": "wuthrich"
}
```

By the way, I believe there are 4 spaces before the ..note. No ? At least the html output seems ok.



---

archive/issue_comments_172532.json:
```json
{
    "body": "Replying to [comment:12 wuthrich]:\n> By the way, I believe there are 4 spaces before the ..note. No ? At least the html output seems ok.\n\nI don't know, I thought that not warnings were produced when building the docs but have forgotten.\n\nThanks for the review!",
    "created_at": "2014-01-24T08:57:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13856",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13856#issuecomment-172532",
    "user": "cremona"
}
```

Replying to [comment:12 wuthrich]:
> By the way, I believe there are 4 spaces before the ..note. No ? At least the html output seems ok.

I don't know, I thought that not warnings were produced when building the docs but have forgotten.

Thanks for the review!



---

archive/issue_comments_172533.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-02-01T15:17:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13856",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13856#issuecomment-172533",
    "user": "vbraun"
}
```

Resolution: fixed
