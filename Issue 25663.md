# Issue 25663: Package libffi

archive/issues_025663.json:
```json
{
    "body": "CC:  embray\n\nThis is required for compiling Python 3.7\n\nIssue created by migration from https://trac.sagemath.org/ticket/25900\n\n",
    "created_at": "2018-07-22T21:03:27Z",
    "labels": [
        "packages: standard",
        "major",
        "enhancement"
    ],
    "title": "Package libffi",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25663",
    "user": "jdemeyer"
}
```
CC:  embray

This is required for compiling Python 3.7

Issue created by migration from https://trac.sagemath.org/ticket/25900





---

archive/issue_comments_361953.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-07-22T21:33:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25663#issuecomment-361953",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_361954.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-07-22T21:33:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25663#issuecomment-361954",
    "user": "jdemeyer"
}
```

New commits:



---

archive/issue_comments_361955.json:
```json
{
    "body": "ok, should be good. Tested on my machine with py2 (and py3 also). Let's ask the buildbots.",
    "created_at": "2018-07-24T18:19:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25663#issuecomment-361955",
    "user": "chapoton"
}
```

ok, should be good. Tested on my machine with py2 (and py3 also). Let's ask the buildbots.



---

archive/issue_comments_361956.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-07-24T18:19:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25663#issuecomment-361956",
    "user": "chapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_361957.json:
```json
{
    "body": "Afaik libffi has been a de facto dependency of ecl (and, therefore, Sage) for a long time. We could just document said dependency...\n\nOn a side note, the cygwin patchbot is unhappy with it",
    "created_at": "2018-08-05T10:40:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25663#issuecomment-361957",
    "user": "vbraun"
}
```

Afaik libffi has been a de facto dependency of ecl (and, therefore, Sage) for a long time. We could just document said dependency...

On a side note, the cygwin patchbot is unhappy with it



---

archive/issue_comments_361958.json:
```json
{
    "body": "The only problem with the patchbot is that it was unable to find the tarball.  Normally, with tickets that add new packages, it's supposed to be able to parse out the path to the source tarball from the ticket description, but that seems to have failed in this case.  I'll look into why.\n\nAFAIK libffi works fine on Cygwin--I have used it there plenty myself (and have even fixed some bugs in it :)",
    "created_at": "2018-08-06T14:34:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25663#issuecomment-361958",
    "user": "embray"
}
```

The only problem with the patchbot is that it was unable to find the tarball.  Normally, with tickets that add new packages, it's supposed to be able to parse out the path to the source tarball from the ticket description, but that seems to have failed in this case.  I'll look into why.

AFAIK libffi works fine on Cygwin--I have used it there plenty myself (and have even fixed some bugs in it :)



---

archive/issue_comments_361959.json:
```json
{
    "body": "Let me test on Cygwin though before setting this to positive review.",
    "created_at": "2018-08-06T14:35:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25663#issuecomment-361959",
    "user": "embray"
}
```

Let me test on Cygwin though before setting this to positive review.



---

archive/issue_comments_361960.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2018-08-06T14:35:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25663#issuecomment-361960",
    "user": "embray"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_comments_361961.json:
```json
{
    "body": "Set assignee to embray.",
    "created_at": "2018-08-06T14:35:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25663#issuecomment-361961",
    "user": "embray"
}
```

Set assignee to embray.



---

archive/issue_comments_361962.json:
```json
{
    "body": "Replying to [comment:5 vbraun]:\n> Afaik libffi has been a de facto dependency of ecl (and, therefore, Sage) for a long time. We could just document said dependency...\n\nI'm fine with adding an spkg for it.  I think there should be one as some libffi versions *do* have bugs that could theoretically affect us.\n\nBut I do think there should be a configure-time check for it to avoid needlessly installing the spkg.  I would like to start adding this for all new packages.  For now it could go directly in `configure.ac`, but if *some* version of #24919 ever gets merged then the check might be moved.",
    "created_at": "2018-08-06T14:38:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25663#issuecomment-361962",
    "user": "embray"
}
```

Replying to [comment:5 vbraun]:
> Afaik libffi has been a de facto dependency of ecl (and, therefore, Sage) for a long time. We could just document said dependency...

I'm fine with adding an spkg for it.  I think there should be one as some libffi versions *do* have bugs that could theoretically affect us.

But I do think there should be a configure-time check for it to avoid needlessly installing the spkg.  I would like to start adding this for all new packages.  For now it could go directly in `configure.ac`, but if *some* version of #24919 ever gets merged then the check might be moved.



---

archive/issue_comments_361963.json:
```json
{
    "body": "If ECL really required libffi, I'm sure that we would have noticed by now. For example, I have a system where Python 3.7 failed to build because libffi wasn't installed. But this problem did not occur for ECL.\n\nErik: this ticket had positive_review and it's a dependency for Python 3.7. So it's fine if you want to add the logic to check for a system-wide install, but please don't stall this ticket.",
    "created_at": "2018-08-06T14:44:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25663#issuecomment-361963",
    "user": "jdemeyer"
}
```

If ECL really required libffi, I'm sure that we would have noticed by now. For example, I have a system where Python 3.7 failed to build because libffi wasn't installed. But this problem did not occur for ECL.

Erik: this ticket had positive_review and it's a dependency for Python 3.7. So it's fine if you want to add the logic to check for a system-wide install, but please don't stall this ticket.



---

archive/issue_comments_361964.json:
```json
{
    "body": "I'm only stalling it to check that it actually works on Cygwin.  I'm happy to add the system check either now, or as a separate ticket.  I'd like to discuss making this required for adding any new spkgs, though since we haven't actually done that yet I won't hold this up over that.",
    "created_at": "2018-08-06T14:49:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25663#issuecomment-361964",
    "user": "embray"
}
```

I'm only stalling it to check that it actually works on Cygwin.  I'm happy to add the system check either now, or as a separate ticket.  I'd like to discuss making this required for adding any new spkgs, though since we haven't actually done that yet I won't hold this up over that.



---

archive/issue_comments_361965.json:
```json
{
    "body": "Any news?",
    "created_at": "2018-08-10T18:47:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25663#issuecomment-361965",
    "user": "jdemeyer"
}
```

Any news?



---

archive/issue_comments_361966.json:
```json
{
    "body": "I'll try it today or tomorrow--soon as I'm done testing 8.4.beta1 on my Windows build.",
    "created_at": "2018-08-16T13:29:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25663#issuecomment-361966",
    "user": "embray"
}
```

I'll try it today or tomorrow--soon as I'm done testing 8.4.beta1 on my Windows build.



---

archive/issue_comments_361967.json:
```json
{
    "body": "Odd that libffi puts its headers in `lib/libffi-3.2.1/include/`.  I found this to be the case on Cygwin and on Linux.  I guess it's not really a problem since `pkg-config` reports that location correctly, and I bet there's probably a good reason for it.  Just...odd.",
    "created_at": "2018-08-17T10:16:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25663#issuecomment-361967",
    "user": "embray"
}
```

Odd that libffi puts its headers in `lib/libffi-3.2.1/include/`.  I found this to be the case on Cygwin and on Linux.  I guess it's not really a problem since `pkg-config` reports that location correctly, and I bet there's probably a good reason for it.  Just...odd.



---

archive/issue_comments_361968.json:
```json
{
    "body": "Could you add something like:\n\n\n```diff\ndiff --git a/configure.ac b/configure.ac\nindex 5a830e5..a31b53b 100644\n--- a/configure.ac\n+++ b/configure.ac\n@@ -435,6 +435,12 @@ AC_CACHE_CHECK([for curl 7.22], [ac_cv_path_CURL], [\n     [need_to_install_curl=yes; ac_cv_path_CURL=no])])\n\n\n+# Only install libffi if needed; if found, we also check for its headers\n+# below\n+need_to_install_libffi=no\n+AC_SEARCH_LIBS([ffi_call], [ffi], [], [need_to_install_libffi=yes])\n+\n+\n ###############################################################################\n # Check header files\n ###############################################################################\n@@ -446,6 +452,12 @@ then\n     AC_CHECK_HEADER([curl/curl.h], [], [need_to_install_curl=yes])\n fi\n\n+# If libffi is installed, we need to check for the ffi.h header file too.\n+if test $need_to_install_libffi = no;\n+then\n+    AC_CHECK_HEADERS([ffi.h ffi/ffi.h], [break], [need_to_install_libffi=yes])\n+fi\n+\n # complex.h is one that might not exist on older systems.\n AC_LANG(C++)\n AC_CHECK_HEADER([complex.h],[],[\n```\n\n?\n\nOtherwise, seems fine to me.  I haven't tested this against Python 3.7 itself yet, but that has other build problems on Cygwin I need to work on.  If any further libffi-related problems come up in the context of building Python we can deal with it there.",
    "created_at": "2018-08-17T11:35:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25663#issuecomment-361968",
    "user": "embray"
}
```

Could you add something like:


```diff
diff --git a/configure.ac b/configure.ac
index 5a830e5..a31b53b 100644
--- a/configure.ac
+++ b/configure.ac
@@ -435,6 +435,12 @@ AC_CACHE_CHECK([for curl 7.22], [ac_cv_path_CURL], [
     [need_to_install_curl=yes; ac_cv_path_CURL=no])])


+# Only install libffi if needed; if found, we also check for its headers
+# below
+need_to_install_libffi=no
+AC_SEARCH_LIBS([ffi_call], [ffi], [], [need_to_install_libffi=yes])
+
+
 ###############################################################################
 # Check header files
 ###############################################################################
@@ -446,6 +452,12 @@ then
     AC_CHECK_HEADER([curl/curl.h], [], [need_to_install_curl=yes])
 fi

+# If libffi is installed, we need to check for the ffi.h header file too.
+if test $need_to_install_libffi = no;
+then
+    AC_CHECK_HEADERS([ffi.h ffi/ffi.h], [break], [need_to_install_libffi=yes])
+fi
+
 # complex.h is one that might not exist on older systems.
 AC_LANG(C++)
 AC_CHECK_HEADER([complex.h],[],[
```

?

Otherwise, seems fine to me.  I haven't tested this against Python 3.7 itself yet, but that has other build problems on Cygwin I need to work on.  If any further libffi-related problems come up in the context of building Python we can deal with it there.



---

archive/issue_comments_361969.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-12-18T14:47:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25663#issuecomment-361969",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_361970.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2018-12-18T14:48:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25663#issuecomment-361970",
    "user": "jdemeyer"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_361971.json:
```json
{
    "body": "Erik, I added the new-style configure check. Does this look correct to you?",
    "created_at": "2018-12-18T14:48:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25663#issuecomment-361971",
    "user": "jdemeyer"
}
```

Erik, I added the new-style configure check. Does this look correct to you?



---

archive/issue_comments_361972.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-12-18T14:49:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25663#issuecomment-361972",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_361973.json:
```json
{
    "body": "Retargeting some of my tickets.",
    "created_at": "2018-12-28T14:09:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25663#issuecomment-361973",
    "user": "embray"
}
```

Retargeting some of my tickets.



---

archive/issue_comments_361974.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-01-07T15:21:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25663#issuecomment-361974",
    "user": "embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_361975.json:
```json
{
    "body": "Replying to [comment:18 jdemeyer]:\n> Erik, I added the new-style configure check. Does this look correct to you?\n\nSorry, I didn't see your update before.  I haven't tested, but it looks good to me in principle.  If we need to make the check any more specific we can do that later (e.g. there could be bugs with older libffi versions, but I'm not worried about that unless it is found to actually affect someone's system).",
    "created_at": "2019-01-07T15:21:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25663#issuecomment-361975",
    "user": "embray"
}
```

Replying to [comment:18 jdemeyer]:
> Erik, I added the new-style configure check. Does this look correct to you?

Sorry, I didn't see your update before.  I haven't tested, but it looks good to me in principle.  If we need to make the check any more specific we can do that later (e.g. there could be bugs with older libffi versions, but I'm not worried about that unless it is found to actually affect someone's system).



---

archive/issue_comments_361976.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-01-23T14:18:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25663#issuecomment-361976",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_361977.json:
```json
{
    "body": "some issue arise from this ticket both on gentoo and ubuntu:\n\n```\ncp: cannot overwrite non-directory '/64bitdev/storage/sage-git_develop/sage/local/./lib64' with directory '/64bitdev/storage/sage-git_develop/sage/local/var/tmp/sage/build/libffi-3.2.1/inst/64bitdev/storage/sage-git_develop/sage/local/./lib64'\n```\n",
    "created_at": "2019-01-24T08:45:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25663#issuecomment-361977",
    "user": "chapoton"
}
```

some issue arise from this ticket both on gentoo and ubuntu:

```
cp: cannot overwrite non-directory '/64bitdev/storage/sage-git_develop/sage/local/./lib64' with directory '/64bitdev/storage/sage-git_develop/sage/local/var/tmp/sage/build/libffi-3.2.1/inst/64bitdev/storage/sage-git_develop/sage/local/./lib64'
```




---

archive/issue_comments_361978.json:
```json
{
    "body": "Changing keywords from \"\" to \"spkg-configure\".",
    "created_at": "2019-02-20T17:29:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25663#issuecomment-361978",
    "user": "embray"
}
```

Changing keywords from "" to "spkg-configure".
