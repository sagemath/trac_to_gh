# Issue 19055: Don't source sage-env in configure

Issue created by migration from https://trac.sagemath.org/ticket/19292

Original creator: jdemeyer

Original creation time: 2015-09-25 13:38:07

There is really no reason to source `sage-env` in `configure`. There are a few environment variables needed (like `SAGE_ROOT` and `SAGE_LOCAL`) but these are defined in `configure` anyway.

Also drop `$SAGE_ROOT/build/bin` from the `$PATH`.


---

Comment by jdemeyer created at 2015-09-25 13:47:30

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2015-09-25 13:47:30

New commits:


---

Comment by tscrim created at 2015-09-30 15:51:00

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2015-09-30 15:51:00

LGTM.


---

Comment by vbraun created at 2015-10-11 17:35:53

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2015-10-11 17:35:53

Here is the reason:

```
[buildslave-sage@volker-desktop build]$ make clean
make build/make/Makefile
make[1]: Entering directory '/mnt/disk/home/buildslave-sage/slave/sage_git/build'
rm -f config.log
mkdir -p logs/pkgs
ln -s logs/pkgs/config.log config.log
running CONFIG_SHELL=/bin/sh /bin/sh ./configure --no-create --no-recursion
checking for a BSD-compatible install... /usr/bin/install -c
checking whether build environment is sane... yes
checking for a thread-safe mkdir -p... /usr/bin/mkdir -p
checking for gawk... gawk
checking whether make sets $(MAKE)... yes
checking whether make supports nested variables... yes
checking whether to enable maintainer-specific portions of Makefiles... yes
checking for root user... no
checking build system type... x86_64-unknown-linux-gnu
checking host system type... x86_64-unknown-linux-gnu
checking for ar... yes
checking for m4... yes
checking for ranlib... yes
checking for strip... yes
checking for GNU or BSD tar... /usr/bin/tar
checking for GNU make... /usr/bin/make
checking for latex... yes
checking for perl... /usr/bin/perl
checking for Perl version 5.8.0 or later... yes
checking for dpkg... no
checking for dpkg-architecture... no
checking for gcc... gcc
checking whether the C compiler works... no
configure: error: in `/mnt/disk/home/buildslave-sage/slave/sage_git/build':
configure: error: C compiler cannot create executables
See `config.log' for more details
If you would like to try to build Sage anyway (to help porting),
export the variable 'SAGE_PORT' to something non-empty.
Makefile:23: recipe for target 'build/make/Makefile' failed
make[1]: *** [build/make/Makefile] Error 1
make[1]: Leaving directory '/mnt/disk/home/buildslave-sage/slave/sage_git/build'
Makefile:16: recipe for target 'clean' failed
make: *** [clean] Error 2
```

config.log:

```
[...]
configure:4259: checking whether the C compiler works
configure:4281: gcc    conftest.c  >&5
/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/libexec/gcc/x86_64-unknown-linux-gnu/4.9.2/cc1: error while loading shared 
libraries: libgmp.so.16: cannot open shared object file: No such file or directory
[...]
```



---

Comment by git created at 2015-10-11 21:30:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-10-11 21:30:20

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2015-10-11 22:19:52

Changing status from needs_review to needs_info.


---

Comment by vbraun created at 2015-10-11 22:19:52

Can you then do a "make clean" if you don't have a system-wide fortran compiler?


---

Comment by nbruin created at 2015-10-12 00:01:37

With this change in place, do we know that `sage-env` gets sourced only from bash scripts? This is relevant for #9386, where we do have a good solution using bash-isms. Writing the same functionality without relying on bash would be quite painful.


---

Comment by jdemeyer created at 2015-10-12 07:55:29

Replying to [comment:8 vbraun]:
> Can you then do a "make clean" if you don't have a system-wide fortran compiler?

The problem with the `gcc` test did not appear if you _don't_ have a C compiler. The problem was if you have a _broken_ C compiler. Apparently, having a broken C compiler is a hard error in `autoconf`.

In any case, I tested all `configure`-related tickets on `home.vbraun.cc`, simply compiling Sage. I have not yet tested `make clean` with this new version.


---

Comment by jdemeyer created at 2015-10-12 08:49:36

On `home.vbraun.cc`, I cannot reproduce the problem from [comment:5]. On which machine was that?

In any case, if you test this ticket, could you please test #19292 + #19313 together?


---

Comment by jdemeyer created at 2015-10-12 08:49:36

Changing status from needs_info to needs_review.


---

Comment by tscrim created at 2015-10-15 16:39:17

I don't feel confident enough to break my gcc (or even how to do that) to continue to review this ticket. Volker, Nils, could one of you finish the review?


---

Comment by vbraun created at 2015-10-17 08:45:37

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-10-17 19:31:17

Resolution: fixed
