# Issue 15079: Make gf2x respect SAGE_FAT_BINARY and use --libdir

Issue created by migration from Trac.

Original creator: jpflori

Original creation time: 2013-10-22 11:35:17

When SAGE_FAT_BINARY is set we should pass --disable-sse2 --disable-pclmul to configure.
We should also use --libdir so that gf2x works ok on OpenSuse and similar systems.


---

Comment by jpflori created at 2014-01-06 19:57:38

Changing keywords from "" to "spkg gf2x".


---

Comment by jpflori created at 2014-01-06 19:57:38

Changing status from new to needs_review.


---

Comment by jpflori created at 2014-01-06 19:57:38

New commits:


---

Comment by jdemeyer created at 2014-01-06 20:32:48

I'm not entirely sure how portable `ln -sf` is. I recommend changing it to a `rm -f` + `ln -s` instead.


---

Comment by git created at 2014-01-06 21:53:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2014-01-06 21:53:40

Done.


---

Comment by jdemeyer created at 2014-01-11 21:12:27

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2014-01-11 21:12:27

Given that all x86_64 processors support SSE2, why should we disable that? We should disable it for i386, but not for x86_64.

Another small comment: I don't like

```
echo "Disabling optimizations."
```

Why not make it

```
echo "Building a generic gf2x library."
```



---

Comment by jpflori created at 2014-01-11 23:10:54

For SSE2, I said the same thing to gf2x devs and they told me sse2 was not part of the x86_64.
See https://gforge.inria.fr/tracker/index.php?func=detail&aid=16566&group_id=1874&atid=6979

The other point is I was too lazy to check if the system was actually 32 or 64 bits in spkg-install.


---

Comment by jdemeyer created at 2014-01-13 10:05:11

Perhaps SSE2 is not part of the official standard, but at least all x86_64 CPUs support it, so it would say it is "de facto" standard. Also GCC will generate SSE+SSE2 code by default on x86_64, which is a very strong precedent.

Is this not just a matter of *not* replacing the symlink?


---

Comment by jdemeyer created at 2014-01-13 10:12:35

The gf2x devs are wrong: [http://www.x86-64.org/documentation/abi.pdf](http://www.x86-64.org/documentation/abi.pdf) states on p.125 that sse2 is a required processor feature.


---

Comment by jpflori created at 2014-01-13 10:15:53

Replying to [comment:7 jdemeyer]:
> Perhaps SSE2 is not part of the official standard, but at least all x86_64 CPUs support it, so it would say it is "de facto" standard. Also GCC will generate SSE+SSE2 code by default on x86_64, which is a very strong precedent.
I agree, and that's what I defended upstream, but Emmanuel didn't hear it that way...
> 
> Is this not just a matter of *not* replacing the symlink?
In fact, if SSE2 is enabled, then we don't even need to replace the symlinks.

Apart from the feedback from upstream which does not want to provide a build system with an option to disable optimizations which would build an SSE2 lib but without further optimizations on x86_64, but just one which would simply point to the generic32/64 folders (so no assembly at all whatever the platform) when enabled.

The other issue is that I did not feel the need to add a bunch of code to spkg-install tyo detect if the system targeted is 32/64 bits, x86 or sparc or whatever, and then pass the correct value to the "hwdir" var (let's say x86, x86_64 and so on depending on the system, which is what I asked for upstream but got as a response: "we'll pass generic32/64 and nothing more depending on the bit length"), when passing unconditionnaly "--disable-sse2 --disable-pclmul" would more or less do the trick (except for the fact it broke the build on x86_64...).
Indeed this would really fit in the upstream autotools project, not within our spkg-install script.
But you nearly convinced me to submit that upstream....


---

Comment by jpflori created at 2014-01-13 10:17:24

Replying to [comment:8 jdemeyer]:
> The gf2x devs are wrong: [http://www.x86-64.org/documentation/abi.pdf](http://www.x86-64.org/documentation/abi.pdf) states on p.125 that sse2 is a required processor feature.
Nice.
I'll push that upstream, but how "official" is this document?
In fact when upstream told me SSE2 was not required I was not sure what and where the official ABI could be...


---

Comment by jpflori created at 2014-01-13 10:21:18

Replying to [comment:10 jpflori]:
> Replying to [comment:8 jdemeyer]:
> > The gf2x devs are wrong: [http://www.x86-64.org/documentation/abi.pdf](http://www.x86-64.org/documentation/abi.pdf) states on p.125 that sse2 is a required processor feature.
> Nice.
> I'll push that upstream, but how "official" is this document?
> In fact when upstream told me SSE2 was not required I was not sure what and where the official ABI could be...
Hum, the about page:
* http://www.x86-64.org/about.html
makes it look more official than what the site design made me orignalmly think.


---

Comment by jdemeyer created at 2014-01-13 10:36:06

I think you should discuss the ABI thing with upstream and see what they say.


---

Comment by jpflori created at 2014-01-13 10:55:02

Replying to [comment:12 jdemeyer]:
> I think you should discuss the ABI thing with upstream and see what they say.
Sure, I'll bump the discussion there, pointing to the exact page you spotted and hopefully their position will shift.
I'll also directly provide a patch to implement what I (and apprently you) would like to see in.

In between I'll provide these changes here.


---

Comment by git created at 2014-01-13 14:44:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2014-01-13 14:45:53

Changing status from needs_work to needs_review.


---

Comment by jpflori created at 2014-01-13 14:45:53

I've tried to tweak the install script to pick up a correct generic value for hwdir depending on cpu/os.


---

Comment by jpflori created at 2014-01-13 14:48:56

Changing status from needs_review to needs_work.


---

Comment by jpflori created at 2014-01-13 14:48:56

Hum, that's not enough to prevent the use of specific optimizations flags passed to gcc...


---

Comment by git created at 2014-01-13 15:50:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2014-01-13 16:08:52

Why this?

```
All other platforms currently supported should build 32 bit by default
```

I would simply leave non-x86 platform alone.


---

Comment by jdemeyer created at 2014-01-13 16:16:47

Instead of money-patching `configure`, you should patch `configure.ac` and re-run `autoconf` and add the resulting patch.


---

Comment by jpflori created at 2014-01-13 16:18:05

Replying to [comment:18 jdemeyer]:
> Why this?
> {{{
> All other platforms currently supported should build 32 bit by default
> }}}
Because it seemed to me it was the case.
I thought of:
* Solaris/Linux on sparc* where the default is 32 bit (as per what gcc does) unless SAGE64 is passed (by the way the current filtering might be wrong on Solaris on top of x86_64...).
* ARM (only 32 bit at the moment, but not even really officially supported anyway).
* Cygwin should only be x86/x86_64 (does Windows even run on something else?) so is taken care of.
* Darwin on PPC[!64]/PowerPC (and even PPC64 in fact) which is only supported 32 bit by Sage.
* non-Darwin ppc64 (let's say POWER? system) are 64 bits.
* don"t really know on what FreeBSD can run on, but it's not officially supported, and x86/x86_64.

Hum, I forgot (linux) itanium which happens to be 64 bit (only I'd say?)...

All that to say, that my original point was to avoid to develop an overly complicated test script which shouldn't really belong within the install script imho.


---

Comment by jpflori created at 2014-01-13 16:20:21

Replying to [comment:18 jdemeyer]:
> I would simply leave non-x86 platform alone.
Indeed, this could work as gf2x is smart enough to detect what unsigned long length the compiler use and pick a correct generic* directory.


---

Comment by jpflori created at 2014-01-13 16:21:54

Replying to [comment:19 jdemeyer]:
> Instead of money-patching `configure`, you should patch `configure.ac` and re-run `autoconf` and add the resulting patch.
I'm fed up with overkill patches produced by autoreconfing and don't have access to a machine where your nice autotools spkg is installed (and even with it, autoreconfing can still be a hell sometimes).


---

Comment by git created at 2014-01-13 16:25:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2014-01-13 16:28:38

Replying to [comment:22 jpflori]:
> Replying to [comment:19 jdemeyer]:
> > Instead of money-patching `configure`, you should patch `configure.ac` and re-run `autoconf` and add the resulting patch.
> I'm fed up with overkill patches produced by autoreconfing and don't have access to a machine where your nice autotools spkg is installed (and even with it, autoreconfing can still be a hell sometimes).
Also note that is quite exactly what autoreconfing would produce (with all the bullshit removed) or so I hope.
I can provide the configure.ac corrsepondig part, which is basically upstream except for the SSE2 on x86_64 part.


---

Comment by jdemeyer created at 2014-01-14 08:11:53

Replying to [comment:24 jpflori]:
> I can provide the configure.ac corrsepondig part
Please do.


---

Comment by jdemeyer created at 2014-01-14 08:13:20

Replying to [comment:22 jpflori]:
> and even with it, autoreconfing can still be a hell sometimes.
That's usually because upstream uses a distro-specific version of autotools. For vanilla versions of autotools, the output that you get with the autotools spkg should be identical to the one in the package.


---

Comment by jpflori created at 2014-01-14 11:01:50

Replying to [comment:26 jdemeyer]:
> Replying to [comment:22 jpflori]:
> > and even with it, autoreconfing can still be a hell sometimes.
> That's usually because upstream uses a distro-specific version of autotools. For vanilla versions of autotools, the output that you get with the autotools spkg should be identical to the one in the package.
On a side note, would you consider updateing the autotools spkg and gitify it?

I'm currently crafting a proper patch, and while at it I'll aslo include the fixes for SSE2 checks.


---

Comment by git created at 2014-01-14 11:31:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2014-01-14 11:33:40

Now it seems that as acinclude.m4 is patched (before configure), autotools want to rerun some magic stuff.
Should we manually touch Makefiles?


---

Comment by jdemeyer created at 2014-01-14 12:14:34

Replying to [comment:30 jpflori]:
> Should we manually touch Makefiles?
Sure, why not?


---

Comment by jpflori created at 2014-01-14 13:41:46

Replying to [comment:31 jdemeyer]:
> Replying to [comment:30 jpflori]:
> > Should we manually touch Makefiles?
> Sure, why not?
Because:
* it's more work,
* it's a pain to maintain as it will be additional code within spkg-install (unless I introduce empty chunks touching these Makefiles in the same patch file touching acinclude.m4 but it feels hackish),
* I'm lazy :)


---

Comment by git created at 2014-01-14 14:11:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2014-01-14 14:12:09

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2014-01-14 14:58:54

I'm confused because it seems that you're solving the same problem twice:
 1. You supply the `hwdir` option to configure
 1. You supply the `--disable-hardware-specific-code` option to configure

Wouldn't either of these two work by itself?

A more serious issue is that you should not assume that SSE2 code can be _compiled_ properly, the compiler and assembler need to support it. Hardware support and software support are orthogonal. On `x86_64`, you may assume hardware support but you still need `CHECK_SSE2_SUPPORT()` to check for software support.


---

Comment by jdemeyer created at 2014-01-14 14:59:01

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2014-01-14 15:07:10

Hang on, working on a patch...


---

Comment by jpflori created at 2014-01-14 15:09:55

Replying to [comment:35 jdemeyer]:
> I'm confused because it seems that you're solving the same problem twice:
>  1. You supply the `hwdir` option to configure
>  1. You supply the `--disable-hardware-specific-code` option to configure
> 
> Wouldn't either of these two work by itself?
Not right now.
With "--disable-hardware-specific-code" you only use the generic32, generic64 targets.
With only hwdir set, the configure script still checks whether SSE2 and pclmul are supported and can add the corresponding flags to CFLAGS.
> 
> A more serious issue is that you should not assume that SSE2 code can be _compiled_ properly, the compiler and assembler need to support it. Hardware support and software support are orthogonal. On `x86_64`, you may assume hardware support but you still need `CHECK_SSE2_SUPPORT()` to check for software support.
I agree with the hardware/software dichotomy.
The problem is that the CHECK_SSE2_SUPPORT macro does not only checks for SSE2 support but can add things to CFLAGS (for example on 32 bits where -msse2 is needed)... so we cannot just call it unconditionally and that's why it is not called upstream when "--disable-hardware-specific-code" is passed, and the upstream choice to only use generic32/64 seems the right one.

If we want to use the x86_64 hwdir (with sse2) for sage generic builds, we should still pass "--disable-hardware-specific-code" to ensure pclmul is not used, nor sse2 on x86, but still call CHECK_SSE2_SUPPORT() on x86_64 and if that succeeds, set hwdir to x86_64.

The other solution is to modify the symlinks as before so that the x86_64 does not require sse2 (but could still use plain assembly).


---

Comment by jdemeyer created at 2014-01-14 15:56:13

Did upstream accept your `--disable-hardware-specific-code` patch?


---

Comment by jdemeyer created at 2014-01-14 15:58:40

Simplified version of the patches, seems to work (at first sight).


---

Comment by jdemeyer created at 2014-01-14 15:58:40

Changing status from needs_work to needs_review.


---

Comment by jpflori created at 2014-01-14 15:58:49

Replying to [comment:39 jdemeyer]:
> Did upstream accept your `--disable-hardware-specific-code` patch?
Hummm, this patch is upstream (see commit numbers in SPKG.txt, 162 ands 167 IIRC). 
Only the x86_64 part which assumes SSE2 support is mine.


---

Comment by jdemeyer created at 2014-01-14 16:02:28

I didn't realize the patch was upstream, so perhaps I shouldn't have changed it. Anyway, I'm going to leave this for today...
----
New commits:


---

Comment by jpflori created at 2014-01-14 16:07:07

In fact I'm happier with your patch than with what upstream provided, so you could even transfer it upstream.

And note that your patch touch configure.ac after configure.


---

Comment by jdemeyer created at 2014-01-14 16:08:11

About the patch order: you're touching `configure` anyway...


---

Comment by jpflori created at 2014-01-14 16:11:14

Oops, I mistakenly changed the branch name.

About the patch order: I'd say your patch is the last one so configure.ac will have a more recent timestamp than configure which is what we want to avoid, isn't it? (ok in real life I don't know what granularity timestamps have, so if it is one second, timestamps should be the same).
----
New commits:


---

Comment by jdemeyer created at 2014-01-14 17:41:53

For the autotools package: see #15123.


---

Comment by jpflori created at 2014-01-15 22:00:57

Your branch fails on ppc64.
In fact mine does as well in a similar way but only when SAGE_FAT_BINARY=yes..
Apparently the tuning process tries to build sse2 code.

And this won't work if the compiler does not support SSE2:

```
++ CHECK_SSE2_SUPPORT()
++ if test x$enable_hardware_specific_code = xyes; then
++ CHECK_PCLMUL_SUPPORT()
++ fi
++ if test x$gf2x_cv_cc_supports_pclmul != xyes ; then
+ hwdir=x86_64
```

because the x86_64 dir cannot be used without sse2 support (and that's why you could and still can not build on x86_64 with --disable-sse2).


---

Comment by jpflori created at 2014-01-15 22:07:36

The matter is surely that

```
AM_CONDITIONAL([GF2X_SSE2_AVAILABLE],[test "x$gf2x_cv_cc_supports_sse2" != xno])
AM_CONDITIONAL([GF2X_PCLMUL_AVAILABLE],[test "x$gf2x_cv_cc_supports_pclmul" != xno])
```

behaves wrongly because the _supports_ vars are left undefined.


---

Comment by jdemeyer created at 2014-01-15 22:10:54

Yes, the `!= xno` should be replaced by `= xyes` I guess.


---

Comment by jpflori created at 2014-01-15 22:12:34

A better and more flexible solution could be to decorrelate the sse2/pclmul tests and the definitions of HAVE_*_SUPPORT.
Just as 

```
AM_CONDITIONAL([GF2X_PCLMUL_AVAILABLE],[test "x$gf2x_cv_cc_supports_pclmul" != xno])
```

which is in configure.ac, the following which is in acinclude.m4 within the SSE2 support macro could be in configure.ac.

```
 if test "$gf2x_cv_cc_supports_sse2" != "no" ;then
  AC_DEFINE([HAVE_SSE2_SUPPORT],[1],[Define if sse-2 code as present in the source tree is supported by the compiler])
 fi
```



---

Comment by jpflori created at 2014-01-15 22:13:34

Replying to [comment:50 jdemeyer]:
> Yes, the `!= xno` should be replaced by `= xyes` I guess.
That would also do the trick.


---

Comment by jpflori created at 2014-01-16 10:43:53

Replying to [comment:46 jpflori]:
> About the patch order: I'd say your patch is the last one so configure.ac will have a more recent timestamp than configure which is what we want to avoid, isn't it? (ok in real life I don't know what granularity timestamps have, so if it is one second, timestamps should be the same).

Could you clarify this as I'm apparently mistaken of why configure.ac should usually be patched before configure?


---

Comment by jpflori created at 2014-01-28 18:16:34

I've implemented the changes suggested above.
----
New commits:


---

Comment by jpflori created at 2014-03-30 14:28:40

Jeroen, any chance you could review this one?


---

Comment by emassop created at 2014-06-16 14:23:55

Changing status from needs_review to needs_work.


---

Comment by emassop created at 2014-06-16 14:23:55

Replying to [comment:52 jpflori]:
> Replying to [comment:50 jdemeyer]:
> > Yes, the `!= xno` should be replaced by `= xyes` I guess.
> That would also do the trick.

Not quite: $gf2x_cv_cc_supports_sse2 can be "requires -msse2", and $gf2x_cv_cc_supports_pclmul can be "requires -mpclmul".

Seems more sane to me to run CHECK_SSE2_SUPPORT and CHECK_PCLMUL_SUPPORT always, so that the case  where gf2x_cv_cc_supports_sse2/pclmul is undefined does not occur, with enable_sse2=no and enable_pclmul=no as appropriate.


---

Comment by emassop created at 2014-06-19 09:03:34

Changing status from needs_work to needs_review.


---

Comment by emassop created at 2014-06-19 09:03:34

By seperating enabling of sse2/pclmul support from checking for support, configure can now run CHECK_(SSE2|PCLMUL)_SUPPORT always, avoiding the case where $gfx_cv_cc_support_(sse|pclmul) is not defined.

I'm afraid the patches are all different again. I imported upstream [svn](https://github.com/nesciens/gf2x/tree/svn) and the upstream [tarballs](https://github.com/nesciens/gf2x/tree/tarballs) into [a git repository](https://github.com/nesciens/gf2x), then applied the changes in several topic branches ([cygwin](https://github.com/nesciens/gf2x/tree/cygwin), [hardware-specific](https://github.com/nesciens/gf2x/tree/hardware-specific), [sse2](https://github.com/nesciens/gf2x/tree/sse2), and [tr](https://github.com/nesciens/gf2x/tree/tr)), merge --squash'ed those branches into [single commits](https://github.com/nesciens/gf2x/commits/sage), updated autotooled files (running autoreconf and reverse applying autoreconf's effect on upstream tarball), and finally ran git format-patch to obtain the patch series.


---

Comment by jpflori created at 2014-06-19 14:06:19

It's not so easy to see what the last commit actually does and unfortunately I have no time to play around applying different sets of patches to the src we distribute, diff the result and play with strange archs, compilers.

So my question is: what dirs will be used on x86_64 when the compiler support emitting sse2 instructions and when it does not and when the blabla-hardware-blabla flag is passed?


---

Comment by emassop created at 2014-06-19 17:33:27

Changing status from needs_review to needs_work.


---

Comment by emassop created at 2014-06-19 17:33:27

With --enable-hardware-specific-code (the default), it depends on whether code with sse2/pclmul can be *compiled and executed*.

|cpu   |execute sse2 |execute pclmul |dir          |
|:------:|:-------------:|:---------------:|:-------------:|
|x86_64  |yes            |yes              |x86_64_pclmul  |
|x86_64  |no             |yes              |x86_64_pclmul  |
|x86_64  |yes            |no               |x86_64         |
|x86_64  |no             |no               |generic64      |
With --disable-hardware-specific-code: generic64.

Hmm, according to the discussion above that latter should be x86_64 instead of generic64, right? I'll fiddle with this some more.

I'm thinking of having the options --enable-sse2 and --enable-pclmul with values "no"/"hostcpu"/"native"/"yes", with as default the value of --enable-hardware-specific-code which would itself defaults to "native". Value "hostcpu" would enable minimally for this $host_cpu (for x86_64 this would be sse2 yes and pclmul no). Value "native" would try to compile and execute. Having calculated the final values for --enable-sse2 and --enable-pclmul, sse2 and pclmul would be enabled based on these values. Configure would error out if the compiler lacks support.

The default directory would be selected based on $host_cpu and whether sse2 and pclmul are enabled. When the directory is forced, insufficient sse2/pclmul might be enabled and configure would error out.


---

Comment by jpflori created at 2014-06-19 21:47:53

That's basically upstream choice: use generic when the hardware flag is passed.
From my discussion with Emmanuel, it's basically because they don't care.
I (and Jeroen?) found it disappointing because the x86_64 spec includes sse2 and quickly and easily came up with our patches which on x86_64 tested if the compiler supports sse2 and if so use the x86_64 folder.
(Note that this folder uses sse2 instruction, so you cannot use it if the compiler does not support sse2.)


---

Comment by jpflori created at 2014-11-12 10:03:30

I'm basically ok with Erik last changes.

I'll just clean up the git branch to current standards and give it positive review.


---

Comment by jpflori created at 2014-11-12 10:15:45

New commits:


---

Comment by jpflori created at 2014-11-12 10:15:45

Changing status from needs_work to needs_review.


---

Comment by jpflori created at 2014-11-12 10:16:40

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-11-14 21:01:47

Resolution: fixed
