# Issue 27953: Allow different versions of python modules depending on the python version used

archive/issues_027953.json:
```json
{
    "body": "CC:  vdelecroix @timokau fbissey embray jdemeyer chapoton vbraun\n\nSee https://groups.google.com/forum/#!topic/sage-packaging/i9VosTO9-cM for details.\n\nUntil python2 is dropped, many packages which have dropped python 2 support upstream (ipython, sphinx, scipy, networkx, matplotlib...) are stuck to old, unmaintained versions in sage. This will pose a particular problem for distros once Sage defaults to python 3, since those distros will probably be carrying newer versions of these dependencies and sage will have to be heavily patched to work with them.\n\nThe aim of this ticket is to allow different versions for python2/python3 packages, so the python3 versions can be kept up to date in sage itself and the relevant patches can be upstreamed.\n\nIssue created by migration from https://trac.sagemath.org/ticket/28190\n\n",
    "created_at": "2019-07-13T18:57:20Z",
    "labels": [
        "packages: standard",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Allow different versions of python modules depending on the python version used",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27953",
    "user": "arojas"
}
```
CC:  vdelecroix @timokau fbissey embray jdemeyer chapoton vbraun

See https://groups.google.com/forum/#!topic/sage-packaging/i9VosTO9-cM for details.

Until python2 is dropped, many packages which have dropped python 2 support upstream (ipython, sphinx, scipy, networkx, matplotlib...) are stuck to old, unmaintained versions in sage. This will pose a particular problem for distros once Sage defaults to python 3, since those distros will probably be carrying newer versions of these dependencies and sage will have to be heavily patched to work with them.

The aim of this ticket is to allow different versions for python2/python3 packages, so the python3 versions can be kept up to date in sage itself and the relevant patches can be upstreamed.

Issue created by migration from https://trac.sagemath.org/ticket/28190





---

archive/issue_comments_394885.json:
```json
{
    "body": "Do you have ideas about how to implement this? Maybe a directory `build/pkgs/python2-packages/` and if building with Python 2, first look there for the directory, and if that fails, look in `build/pkgs`? Or instead, within `build/pkgs/sphinx/` (for example), have a `python2` directory with py2 build information. In any case, I think that if there is a default setting, it should be Python 3.",
    "created_at": "2019-07-15T02:04:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27953#issuecomment-394885",
    "user": "jhpalmieri"
}
```

Do you have ideas about how to implement this? Maybe a directory `build/pkgs/python2-packages/` and if building with Python 2, first look there for the directory, and if that fails, look in `build/pkgs`? Or instead, within `build/pkgs/sphinx/` (for example), have a `python2` directory with py2 build information. In any case, I think that if there is a default setting, it should be Python 3.



---

archive/issue_comments_394886.json:
```json
{
    "body": "Perhaps it would be simpler to keep the python2 and python3 versions as separate pkgs? (build/pkgs/sphinx vs build/pkgs/python2-sphinx)",
    "created_at": "2019-07-15T06:52:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27953#issuecomment-394886",
    "user": "arojas"
}
```

Perhaps it would be simpler to keep the python2 and python3 versions as separate pkgs? (build/pkgs/sphinx vs build/pkgs/python2-sphinx)



---

archive/issue_comments_394887.json:
```json
{
    "body": "Replying to [comment:5 arojas]:\n> Perhaps it would be simpler to keep the python2 and python3 versions as separate pkgs? (build/pkgs/sphinx vs build/pkgs/python2-sphinx)\n\n+1\n\nIt will also be simpler to remove the `python2-*` repos when the life of Python2 terminates.",
    "created_at": "2019-07-15T07:04:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27953#issuecomment-394887",
    "user": "vdelecroix"
}
```

Replying to [comment:5 arojas]:
> Perhaps it would be simpler to keep the python2 and python3 versions as separate pkgs? (build/pkgs/sphinx vs build/pkgs/python2-sphinx)

+1

It will also be simpler to remove the `python2-*` repos when the life of Python2 terminates.



---

archive/issue_comments_394888.json:
```json
{
    "body": "That follows some model of binary distros, and I am OK with that. Implementation will have some kinks as it relies on the relationship between the folder name, the name of the package for dependencies and the name of the source tarball. I would say the latest is the hardest bit to implement - dependencies not so much, it is just tedious work.",
    "created_at": "2019-07-15T07:48:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27953#issuecomment-394888",
    "user": "fbissey"
}
```

That follows some model of binary distros, and I am OK with that. Implementation will have some kinks as it relies on the relationship between the folder name, the name of the package for dependencies and the name of the source tarball. I would say the latest is the hardest bit to implement - dependencies not so much, it is just tedious work.



---

archive/issue_comments_394889.json:
```json
{
    "body": "Who is going to take care of that ?\n\n* I would suggest not to change the name of the packages, not to duplicate.\n\n* Rather have (when required) inside build/pkg folders some new files `checksums-legacy.ini` and `package-version-legacy.txt`\n\n* Change the script in the appropriate place (where ?) so that it chooses the version to install according to the python version.\n\nErik, Jeroen : your opinions on the problem, please ?",
    "created_at": "2019-07-17T11:38:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27953#issuecomment-394889",
    "user": "chapoton"
}
```

Who is going to take care of that ?

* I would suggest not to change the name of the packages, not to duplicate.

* Rather have (when required) inside build/pkg folders some new files `checksums-legacy.ini` and `package-version-legacy.txt`

* Change the script in the appropriate place (where ?) so that it chooses the version to install according to the python version.

Erik, Jeroen : your opinions on the problem, please ?



---

archive/issue_comments_394890.json:
```json
{
    "body": "as a kind of provocation, here is a sketch of tentative..\n----\nNew commits:",
    "created_at": "2019-07-17T12:27:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27953#issuecomment-394890",
    "user": "chapoton"
}
```

as a kind of provocation, here is a sketch of tentative..
----
New commits:



---

archive/issue_comments_394891.json:
```json
{
    "body": "Let's start by analyzing the problem and possible solutions before discussing implementation details.\n\nFor a given package, let V2 be the latest version supporting Python 2 and let V3 be the latest version supporting Python 3. There are several possibilities (assuming obviously that V3 >= V2):\n\n(A) V2 == V3: the package continues to support Python 2.\n\n(B) V2 < V3 but the versions are compatible: the functionality that Sage uses works the same way with both versions.\n\n(C) V2 and V3 are incompatible.\n\nIn case (A), nothing need to be done, so we don't need to discuss this further. In case (B), it doesn't really matter what we do: even if a distro uses a different version from Sage, there is no problem. So we really need to worry only about case (C). So first of all a serious question: are there packages where (C) currently applies? If not, we're solving a non-problem.\n\nFor (C), I see three possible solutions:\n\n(i) continue using V2 in Sage and leave it up to the distros to deal with that.\n\n(ii) use V2 when compiling with Python 2 and V3 when compiling with Python 3.\n\n(iii) use V3 and drop support for Python 2 in Sage completely.\n\nThis ticket proposes (ii) but I'm not convinced that this is what we should do. It means that code in the Sage library needs to deal with supporting two incompatible versions of a package. That will complicate the code and increase chances of breakage.\n\nIf we can wait, maybe (iii) is actually a viable option: Python 2 is officially unsupported half a year from now. If Sage fully works under Python 3 by then, maybe we can drop Python 2 support at that time.",
    "created_at": "2019-07-17T12:45:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27953#issuecomment-394891",
    "user": "jdemeyer"
}
```

Let's start by analyzing the problem and possible solutions before discussing implementation details.

For a given package, let V2 be the latest version supporting Python 2 and let V3 be the latest version supporting Python 3. There are several possibilities (assuming obviously that V3 >= V2):

(A) V2 == V3: the package continues to support Python 2.

(B) V2 < V3 but the versions are compatible: the functionality that Sage uses works the same way with both versions.

(C) V2 and V3 are incompatible.

In case (A), nothing need to be done, so we don't need to discuss this further. In case (B), it doesn't really matter what we do: even if a distro uses a different version from Sage, there is no problem. So we really need to worry only about case (C). So first of all a serious question: are there packages where (C) currently applies? If not, we're solving a non-problem.

For (C), I see three possible solutions:

(i) continue using V2 in Sage and leave it up to the distros to deal with that.

(ii) use V2 when compiling with Python 2 and V3 when compiling with Python 3.

(iii) use V3 and drop support for Python 2 in Sage completely.

This ticket proposes (ii) but I'm not convinced that this is what we should do. It means that code in the Sage library needs to deal with supporting two incompatible versions of a package. That will complicate the code and increase chances of breakage.

If we can wait, maybe (iii) is actually a viable option: Python 2 is officially unsupported half a year from now. If Sage fully works under Python 3 by then, maybe we can drop Python 2 support at that time.



---

archive/issue_comments_394892.json:
```json
{
    "body": "Replying to [comment:10 jdemeyer]:\n> So first of all a serious question: are there packages where (C) currently applies? If not, we're solving a non-problem.\n\nYes (see the linked sage-packaging post)\n\n> If we can wait, maybe (iii) is actually a viable option: Python 2 is officially unsupported half a year from now. If Sage fully works under Python 3 by then, maybe we can drop Python 2 support at that time.\n\nThat would be a solution, but would you really consider going from defaulting to python2 to completely dropping it without any deprecation period?",
    "created_at": "2019-07-17T12:52:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27953#issuecomment-394892",
    "user": "arojas"
}
```

Replying to [comment:10 jdemeyer]:
> So first of all a serious question: are there packages where (C) currently applies? If not, we're solving a non-problem.

Yes (see the linked sage-packaging post)

> If we can wait, maybe (iii) is actually a viable option: Python 2 is officially unsupported half a year from now. If Sage fully works under Python 3 by then, maybe we can drop Python 2 support at that time.

That would be a solution, but would you really consider going from defaulting to python2 to completely dropping it without any deprecation period?



---

archive/issue_comments_394893.json:
```json
{
    "body": "Replying to [comment:11 arojas]:\n> would you really consider going from defaulting to python2 to completely dropping it without any deprecation period?\n\nWhat would that deprecation mean in practice?\n\nFrom the user's point of view, Sage uses either Python 2 or Python 3 (whatever we default to at installation time), so there is going to be a sudden break anyway sooner or later. Once you're defaulting to Python 3, I don't know if we should still put effort in supporting Python 2.",
    "created_at": "2019-07-17T12:58:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27953#issuecomment-394893",
    "user": "jdemeyer"
}
```

Replying to [comment:11 arojas]:
> would you really consider going from defaulting to python2 to completely dropping it without any deprecation period?

What would that deprecation mean in practice?

From the user's point of view, Sage uses either Python 2 or Python 3 (whatever we default to at installation time), so there is going to be a sudden break anyway sooner or later. Once you're defaulting to Python 3, I don't know if we should still put effort in supporting Python 2.



---

archive/issue_comments_394894.json:
```json
{
    "body": "As mentioned by Samuel on the mailing list, there is a distinct situation where we might want to upgrade packages to Python3 before the transition py2 -> py3: the jupyter notebook. It is not exactly covered by the ticket description.\n\nMore concretely, we could\n- python3 install the modules: `jupyter_core`, `jupyter_client`, `traitlets`, `decorator`, `enum34`, `pyzmq`, `dateutil`\n- remove python2 installation of `jupyter_core` and `jupyter_client` (and dead dependencies)\n- run the jupyter notebook under python3\n\nQuestion: would that really be useful?",
    "created_at": "2019-07-17T13:40:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27953#issuecomment-394894",
    "user": "vdelecroix"
}
```

As mentioned by Samuel on the mailing list, there is a distinct situation where we might want to upgrade packages to Python3 before the transition py2 -> py3: the jupyter notebook. It is not exactly covered by the ticket description.

More concretely, we could
- python3 install the modules: `jupyter_core`, `jupyter_client`, `traitlets`, `decorator`, `enum34`, `pyzmq`, `dateutil`
- remove python2 installation of `jupyter_core` and `jupyter_client` (and dead dependencies)
- run the jupyter notebook under python3

Question: would that really be useful?



---

archive/issue_comments_394895.json:
```json
{
    "body": "Replying to [comment:12 jdemeyer]:\n> Replying to [comment:11 arojas]:\n> > would you really consider going from defaulting to python2 to completely dropping it without any deprecation period?\n> \n> What would that deprecation mean in practice?\n> \n> From the user's point of view, Sage uses either Python 2 or Python 3 (whatever we default to at installation time), so there is going to be a sudden break anyway sooner or later. Once you're defaulting to Python 3, I don't know if we should still put effort in supporting Python 2.\n\n+1 on that point. If users don't want to migrate right away, they can continue using an older sage version. That may have security implications of course, but since some dependencies won't receive any updates anyway those implications are there either way.\n\nThere is little point to the \"python2 deadline\" if half of the projects decide \"just a little longer\".",
    "created_at": "2019-07-17T14:28:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27953#issuecomment-394895",
    "user": "@timokau"
}
```

Replying to [comment:12 jdemeyer]:
> Replying to [comment:11 arojas]:
> > would you really consider going from defaulting to python2 to completely dropping it without any deprecation period?
> 
> What would that deprecation mean in practice?
> 
> From the user's point of view, Sage uses either Python 2 or Python 3 (whatever we default to at installation time), so there is going to be a sudden break anyway sooner or later. Once you're defaulting to Python 3, I don't know if we should still put effort in supporting Python 2.

+1 on that point. If users don't want to migrate right away, they can continue using an older sage version. That may have security implications of course, but since some dependencies won't receive any updates anyway those implications are there either way.

There is little point to the "python2 deadline" if half of the projects decide "just a little longer".



---

archive/issue_comments_394896.json:
```json
{
    "body": "Replying to [comment:10 jdemeyer]:\n> This ticket proposes (ii) but I'm not convinced that this is what we should do. It means that code in the Sage library needs to deal with supporting two incompatible versions of a package. That will complicate the code and increase chances of breakage.\n\nI don't think that's such a problem.  Yes, it's annoying.  But with care, it can be done fairly cleanly, and *explicitly* supporting multiple versions of a depdency can be *more* stable.\n\nE.g. in Astropy we support something like 4 different Numpy versions, all of which occasionally need different version-specific worksarounds or features.  This is usually done explicitly in the code with pre-defined constants like `if NUMPY_LT_1_11: ...`.",
    "created_at": "2019-08-13T11:41:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27953#issuecomment-394896",
    "user": "embray"
}
```

Replying to [comment:10 jdemeyer]:
> This ticket proposes (ii) but I'm not convinced that this is what we should do. It means that code in the Sage library needs to deal with supporting two incompatible versions of a package. That will complicate the code and increase chances of breakage.

I don't think that's such a problem.  Yes, it's annoying.  But with care, it can be done fairly cleanly, and *explicitly* supporting multiple versions of a depdency can be *more* stable.

E.g. in Astropy we support something like 4 different Numpy versions, all of which occasionally need different version-specific worksarounds or features.  This is usually done explicitly in the code with pre-defined constants like `if NUMPY_LT_1_11: ...`.



---

archive/issue_comments_394897.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2019-12-30T14:48:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27953#issuecomment-394897",
    "user": "embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_394898.json:
```json
{
    "body": "Now that 9.0 is out, what is the plan for this? Is python2 going to be dropped for 9.1? My current ipython 7 patch is almost 5000 LOC and getting harder to maintain, it would be nice to upstream it. Also, updating to python 3.8 would be more complicated if python2 support is to be kept, see #27754#comment:55",
    "created_at": "2020-01-05T19:23:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27953#issuecomment-394898",
    "user": "arojas"
}
```

Now that 9.0 is out, what is the plan for this? Is python2 going to be dropped for 9.1? My current ipython 7 patch is almost 5000 LOC and getting harder to maintain, it would be nice to upstream it. Also, updating to python 3.8 would be more complicated if python2 support is to be kept, see #27754#comment:55



---

archive/issue_comments_394899.json:
```json
{
    "body": "I don't think there should be a rush to upgrade to Python 3.8.  With the first Python 3-based release just out, let's give it a little breathing room for things to shake out, as I'm sure it will still be a rocky transition for some users at first (hopefully not too much so though).",
    "created_at": "2020-01-06T13:26:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27953#issuecomment-394899",
    "user": "embray"
}
```

I don't think there should be a rush to upgrade to Python 3.8.  With the first Python 3-based release just out, let's give it a little breathing room for things to shake out, as I'm sure it will still be a rocky transition for some users at first (hopefully not too much so though).



---

archive/issue_comments_394900.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-03-31T14:48:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27953#issuecomment-394900",
    "user": "mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_394901.json:
```json
{
    "body": "It seems we are dropping Python2 support after 9.1. See #29141 for the reference to the discussion on sage-devel.\n\nI propose to close this ticket, in favor of #28000: Remove python 2 support",
    "created_at": "2020-03-31T14:48:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27953#issuecomment-394901",
    "user": "mkoeppe"
}
```

It seems we are dropping Python2 support after 9.1. See #29141 for the reference to the discussion on sage-devel.

I propose to close this ticket, in favor of #28000: Remove python 2 support



---

archive/issue_comments_394902.json:
```json
{
    "body": "I agree, let us move forward.",
    "created_at": "2020-03-31T18:05:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27953#issuecomment-394902",
    "user": "chapoton"
}
```

I agree, let us move forward.



---

archive/issue_comments_394903.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2020-03-31T18:05:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27953#issuecomment-394903",
    "user": "chapoton"
}
```

Resolution: invalid
