# Issue 33886: Fast initialization for edge connectivity

Issue created by migration from https://trac.sagemath.org/ticket/34123

Original creator: @enjeck

Original creation time: 2022-07-06 14:34:59

Related to #33839


---

Comment by @enjeck created at 2022-07-06 15:03:04

New commits:


---

Comment by dcoudert created at 2022-07-08 15:43:48

Can you add more comments to better explain the steps.

You define `visited` as a list. Be aware that with lists, a test like `v in visited` requires linear time (in the size of the list). You should use a set instead as testing membership to a set requires constant time.


---

Comment by dcoudert created at 2022-07-08 15:43:48

Changing keywords from "" to "GSoC2022".


---

Comment by @enjeck created at 2022-07-08 15:48:56

Yeah, I can add more comments. Right, I should be using a set, totally missed that. 

By the way, I had been trying to make this ticket's diffs show just my commits, excluding yours from #33839, but I haven't figured out how yet.


---

Comment by dcoudert created at 2022-07-08 16:20:48

> By the way, I had been trying to make this ticket's diffs show just my commits, excluding yours from #33839, but I haven't figured out how yet. 
I don't know if it's possible to do that. At least, when #33839 will be merged, it will remain only the diff.


---

Comment by git created at 2022-07-26 06:20:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @enjeck created at 2022-07-26 06:29:57

I'm not sure where I'm going wrong. My DFS initialization is not fast. In fact, it's slower than the implementation without it. 

Here are the results of some tests carried out on complete digraphs:

**Without initialization**

_300 vertices_
CPU times: user 648 ms, sys: 0 ns, total: 648 ms
Wall time: 646 ms
299

_500 vertices_
CPU times: user 3.53 s, sys: 8 ms, total: 3.54 s
Wall time: 3.54 s
499

_1000 vertices_
CPU times: user 29.7 s, sys: 27.2 ms, total: 29.7 s
Wall time: 29.8 s
999

**Mine, with initialization**

_300 vertices_
CPU times: user 844 ms, sys: 0 ns, total: 844 ms
Wall time: 841 ms
299

_500 vertices_
CPU times: user 3.85 s, sys: 7.46 ms, total: 3.85 s
Wall time: 3.84 s
499

_1000 vertices_
CPU times: user 31.1 s, sys: 3.45 ms, total: 31.1 s
Wall time: 31.2 s
999


---

Comment by @enjeck created at 2022-07-26 06:30:44

I'm obviously missing something. Not sure what :/


---

Comment by git created at 2022-07-26 06:33:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2022-07-26 07:11:05

Could be because your method is recursive. Can you try a non-recursive DFS ?

Also, have you checked that your method is valid with other types of graphs ?


---

Comment by @enjeck created at 2022-07-26 10:57:51

> Could be because your method is recursive. Can you try a non-recursive DFS ? 

Okay. I'll try to implement an iterative version. 

> Also, have you checked that your method is valid with other types of graphs ? 

Just did. It works on the Peterson graph, fails on Regular graphs. I get the error message " _ValueError: did not find the right edge_". 

I'll try to fix this and do more extensive testing


---

Comment by git created at 2022-08-02 09:35:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @enjeck created at 2022-08-02 09:39:32

My latest commit removed the G_minus_T function, and instead updates the current k-1 intersection inline. I expected this to speed up the code a little bit, but that doesn't happen. Instead, it's slower than before. I'm confused

**Test results, which are slower than that reported earlier**:

_500 vertices_ CPU times: user 5.83 s, sys: 4.03 ms, total: 5.84 s Wall time: 5.84 s 499

_1000 vertices_ CPU times: user 53.4 s, sys: 158 ms, total: 53.5 s Wall time: 54.1 s 999


---

Comment by @enjeck created at 2022-08-02 09:46:47

Also, I haven't yet figured out how to get the code to work on regular graphs. The " ValueError?: did not find the right edge" error stems from the fundamental cycle step, and is linked to the my_depths, my_parent and my_parent_edge vectors. I attempt to fix this by updating these vectors while doing the initalization DFS, _compute_dfs_tree()_. But this leads to an infinite loop in some other DFS call, _update_parents_dfs()_.


---

Comment by dcoudert created at 2022-08-02 09:58:19

You never set any edge in `T` to `True`...


---

Comment by git created at 2022-08-02 12:52:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @enjeck created at 2022-08-02 12:55:12

Somehow, the code is even slower:

''
500 vertices''
CPU times: user 7.47 s, sys: 31.5 ms, total: 7.5 s
Wall time: 7.53 s
499

_1000 vertices_
CPU times: user 1min 8s, sys: 71.9 ms, total: 1min 8s
Wall time: 1min 10s
999

I'll get to the bottom of this!


---

Comment by git created at 2022-08-08 13:15:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-21 20:24:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @enjeck created at 2022-08-21 21:16:13

After extensive testing, I can confirm that the code now works all graphs. Its speed matches the initial version for some graphs, and it's a bit faster for others.


---

Comment by @enjeck created at 2022-08-21 21:17:04

The speedup is noticeable when I tested on complete digraphs:

**Without initialization**

_1500 vertices:_

CPU times: user 1min 37s, sys: 28.2 ms, total: 1min 37s Wall time: 1min 38s 1499

CPU times: user 1min 37s, sys: 33.8 ms, total: 1min 37s Wall time: 1min 37s 1499

_2000 vertices:_

CPU times: user 4min 13s, sys: 86.5 ms, total: 4min 13s Wall time: 4min 14s 1999

CPU times: user 4min 16s, sys: 87.1 ms, total: 4min 17s Wall time: 4min 17s 1999


**Mine, with initialization**

''
1500 vertices:''

CPU times: user 1min 12s, sys: 67.5 ms, total: 1min 13s Wall time: 1min 13s 1499

CPU times: user 1min 21s, sys: 104 ms, total: 1min 21s Wall time: 1min 21s 1499

''2000 vertices:
''

CPU times: user 2min 48s, sys: 95.7 ms, total: 2min 48s Wall time: 2min 48s 1999

CPU times: user 2min 51s, sys: 176 ms, total: 2min 51s Wall time: 2min 52s 1999


---

Comment by @enjeck created at 2022-08-21 21:28:03

On a random semi-complete digraph with 1000 vertices, it's over 2 times faster

**
Without initialization**

CPU times: user 23.7 s, sys: 3.93 ms, total: 23.7 s Wall time: 23.7 s 619

CPU times: user 23.8 s, sys: 0 ns, total: 23.8 s Wall time: 23.9 s 615

CPU times: user 24.4 s, sys: 3.98 ms, total: 24.4 s Wall time: 24.5 s 603


**Mine, with initialization:**

CPU times: user 9.99 s, sys: 0 ns, total: 9.99 s Wall time: 10 s 616

CPU times: user 9.26 s, sys: 7.97 ms, total: 9.27 s Wall time: 9.32 s 595

CPU times: user 9.76 s, sys: 36 ms, total: 9.8 s Wall time: 9.83 s 609


---

Comment by @enjeck created at 2022-08-21 21:29:23

On other digraphs like the Peterson graph and regular graphs, it's not any faster


---

Comment by @enjeck created at 2022-08-21 21:35:23

I'm not seeing the 9x speedups as mentioned in the paper. I'm obviously missing something. Not sure what it is yet :/


---

Comment by dcoudert created at 2022-08-22 06:32:01

You should do the following:
- add an optional parameter to decide if yes/no we use the DFS method. This will ease comparison
- make a non recursive version of the DFS. It should be faster.


---

Comment by git created at 2022-09-03 20:26:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @enjeck created at 2022-09-03 20:31:38

This iterative version works on most graphs, but fails on the Rome99 graph (https://github.com/sakiskef/PackingArborescencesAlgorithms/blob/main/rome99.new.txt-EC2). I get an infinite loop, same issue I had faced weeks ago. In the cases where it works, this non-recursive code is not any faster than the recursive one, so I don't know if it's worth spending time trying to fix the bug.


---

Comment by dcoudert created at 2022-09-04 11:35:28

I changed the non-recursive version. One of the difficulty was to ensure that an edge is selected before starting to process it's head.

I also did various edits in the code (coding style) and changed a few names.

I added another parameter to choose between the recursive and non-recursive versions. We will have to remove it later.

In some cases (e.g., rome), the non-recursive version is faster, but on complete graphs it is slower. I don't know why. At least it is correct and robust.
----
New commits:


---

Comment by dcoudert created at 2022-09-04 11:36:00

and I changed the branch name to get something in public ;)


---

Comment by git created at 2022-09-04 14:33:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @enjeck created at 2022-09-04 22:30:22

Nice. Thanks! What next for this ticket?


---

Comment by dcoudert created at 2022-09-05 15:22:05

- Further tests. I got the same results for all combinations of parameters so far.
- Document the input parameter `dfs` with a link to reference `[GKLP2021]_`. May be we should choose a better name for the parameter like `dfs_preprocessing` or `use_preprocessing` ?
- Decide if we keep both the recursive and the non recursive versions or if we keep only one (and which one).


---

Comment by @enjeck created at 2022-09-06 05:15:15

> Further tests. I got the same results for all combinations of parameters so far. 

Further tests to ensure it works? Or for the speed?

> Document the input parameter dfs with a link to reference [GKLP2021]_. May be we should choose a better name for the parameter like dfs_preprocessing or use_preprocessing ? 

`dfs_preprocessing` sounds good to me.


---

Comment by git created at 2022-09-12 05:41:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2022-09-12 06:04:39

Well, 2000 is too much / long for a doctest. 10 should be enough.


---

Comment by git created at 2022-09-12 06:28:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2022-09-14 16:55:47

There is a failing doctest. Can you check what's going on ?

```
sage -t --warn-long 24.4 --random-seed=248224767818260445092579663881809139950 src/sage/graphs/edge_connectivity.pyx
**********************************************************************
File "src/sage/graphs/edge_connectivity.pyx", line 97, in sage.graphs.edge_connectivity.GabowEdgeConnectivity
Failed example:
    GabowEdgeConnectivity(D).edge_connectivity()
Expected:
    4
Got:
    5
```


Also, please add a doctest on some random graph (e.g. `RandomBarabasiAlbert(100, 2)`) and the different possible combinations of parameters.


---

Comment by @enjeck created at 2022-09-14 19:53:44

The failed doctests stems from the digraph with loops: `D = digraphs.Complete(5, loops=True)`. I checked, and for both the recursive and non-recursive code, a looped complete digraph with `n` vertices yields an edge connectivity of `n` instead of `n-1`. 

I wonder if this problem can be easily fixed by removing or ignoring loops during processing, or if the issue goes deeper than that.


---

Comment by dcoudert created at 2022-09-15 06:35:48

Indeed, the easiest way should be to remove loops during the initialization of data structures. Can you check how to do that smartly ?


---

Comment by @enjeck created at 2022-09-21 06:11:42

`@`David, I tried out the approach we discussed for removing loops, but it didn't work. I think I'm starting to figure out why

Remember that I said using [.remove_loops()](https://doc.sagemath.org/html/en/reference/graphs/sage/graphs/generic_graph.html#sage.graphs.generic_graph.GenericGraph.remove_loops) worked, but was too expensive? Not quite. I noticed that it mattered where exactly I called .remove_loops(). If I called it before setting `max_ec`, then the code worked correctly. Otherwise, it failed. For a complete looped digraph, `max_ec` is 5, while `max_ec` is 2 for its unlooped counterpart. 

So, it seems that the accuracy of results depends on `max_ec`. Which shouldn't be the case! I'll investigate this further.


---

Comment by dcoudert created at 2022-09-21 07:15:17

move the initialization of `max_ec` after the call `self.build_graph_data_structure()`. Instead of using `G.out_degree_iterator()` you must get degrees from the size of out-neighborhoods in `g_out`  (responsabilités. in `g_in`).


---

Comment by @enjeck created at 2022-09-24 18:55:08

> Instead of using G.out_degree_iterator() you must get degrees from the size of out-neighborhoods in g_out (responsabilités. in g_in). 

Sorry, I don't understand what I'm supposed to do here. I've tried moving `max_ec`, but that on its own doesn't work


---

Comment by git created at 2022-09-25 06:52:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2022-09-25 06:54:13

Check last commit and test it.


---

Comment by git created at 2022-09-25 16:13:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2022-09-28 13:03:23

Changing status from new to needs_review.


---

Comment by git created at 2022-10-01 08:32:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-10-01 08:37:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2022-10-01 08:37:45

I did some minor review edits. Do you agree with these changes ?


---

Comment by @enjeck created at 2022-10-01 09:01:29

Looks good to me!


---

Comment by dcoudert created at 2022-10-01 09:19:36

Changing status from needs_review to positive_review.


---

Comment by dcoudert created at 2022-10-01 09:19:36

So then.


---

Comment by vbraun created at 2022-10-11 23:03:03

See patchbot:

```
[sagemath_doc_html-none] OSError: docstring of sage.graphs.edge_connectivity.GabowEdgeConnectivity:19: WARNING: Literal block expected; none found.
```



---

Comment by vbraun created at 2022-10-11 23:03:03

Changing status from positive_review to needs_work.


---

Comment by @enjeck created at 2022-10-12 03:42:48

Hmm. This is weird. I've checked, and can't seem to find where the error is stemming from. I even tried looking up other tickets where this error showed up (e.g #33971#comment:21) to see how they fixed it, but that doesn't help me here :/


---

Comment by dcoudert created at 2022-10-12 08:59:48

can you revert this change

```diff
-    EXAMPLES:
+    EXAMPLES::
```



---

Comment by git created at 2022-10-12 18:24:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2022-10-12 18:26:34

Changing status from needs_work to needs_review.


---

Comment by dcoudert created at 2022-10-12 18:26:34

This should fix the issue. Let's wait to know if the patchbot is happy or not.


---

Comment by git created at 2022-10-15 06:06:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2022-10-15 06:09:45

The docbuild issue is now fixed but the patchbot has reported an error on the doctests using `graphs.RandomBarabasiAlbert(100, 2)`. This is due to the fact that this graph is built starting from a tree, and so there is non zero probability to get a vertex of degree 1 when the graph is small. This is now fixed.


---

Comment by dcoudert created at 2022-10-15 15:22:55

The patchbot is now happy.


---

Comment by dcoudert created at 2022-10-15 15:22:55

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-10-17 22:43:40

Resolution: fixed
