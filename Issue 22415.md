# Issue 22415: Add a plain-text config file that feeds into sage.env

archive/issues_022415.json:
```json
{
    "body": "CC:  fbissey jdemeyer mkoeppe @timokau\n\nIssues like #22628 remind me of an idea I've had before for improving the situation with the otherwise difficult to maintain and unwieldy `sage.env` module.\n\nISTM that almsot all the data in that file could be read from a plain text file format (either an ini-like file or JSON, for example).  Furthermore, this file could be generated, or updated, at install time for spkgs (including Sage itself).  This would help make the growing number of (sometimes contentious) spkg-specific variables (`CONWAY_POLYNOMIALS_DATA_DIR`, `GRAPHS_DATA_DIR`, `GAP_ROOT_DIR`, `SINGULAR_SO`, etc.) more manageable.\n\nIf each spkg is allowed its own \"section\" in this config file, the installers for those spkgs could be allowed to manage the data in that section as well, which is sometimes platform-specific.  It is also data that is usually more accessible at install-time of that package than it is to Sage at runtime.  For example, #22628 raises a tricky issue about how to set `SINGULAR_SO`.  If the correct path to `SINGULAR_SO` were written to a config file at install time, that would push all platform-specific logic about how to set that path to the `spkg-install` script, and out of `sage.env`.  For system packagers, such as for Gentoo or Debian, they would be free to write whatever they want in this config file, and it would free them having to do as much patching to `sage.env` and possibly other files.\n\nI have some idea how this might work, so I'm willing to cook up a prototype if it doesn't sound like a terrible idea.\n\nIssue created by migration from https://trac.sagemath.org/ticket/22652\n\n",
    "created_at": "2017-03-20T10:32:38Z",
    "labels": [
        "porting",
        "major",
        "enhancement"
    ],
    "title": "Add a plain-text config file that feeds into sage.env",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22415",
    "user": "embray"
}
```
CC:  fbissey jdemeyer mkoeppe @timokau

Issues like #22628 remind me of an idea I've had before for improving the situation with the otherwise difficult to maintain and unwieldy `sage.env` module.

ISTM that almsot all the data in that file could be read from a plain text file format (either an ini-like file or JSON, for example).  Furthermore, this file could be generated, or updated, at install time for spkgs (including Sage itself).  This would help make the growing number of (sometimes contentious) spkg-specific variables (`CONWAY_POLYNOMIALS_DATA_DIR`, `GRAPHS_DATA_DIR`, `GAP_ROOT_DIR`, `SINGULAR_SO`, etc.) more manageable.

If each spkg is allowed its own "section" in this config file, the installers for those spkgs could be allowed to manage the data in that section as well, which is sometimes platform-specific.  It is also data that is usually more accessible at install-time of that package than it is to Sage at runtime.  For example, #22628 raises a tricky issue about how to set `SINGULAR_SO`.  If the correct path to `SINGULAR_SO` were written to a config file at install time, that would push all platform-specific logic about how to set that path to the `spkg-install` script, and out of `sage.env`.  For system packagers, such as for Gentoo or Debian, they would be free to write whatever they want in this config file, and it would free them having to do as much patching to `sage.env` and possibly other files.

I have some idea how this might work, so I'm willing to cook up a prototype if it doesn't sound like a terrible idea.

Issue created by migration from https://trac.sagemath.org/ticket/22652





---

archive/issue_comments_312213.json:
```json
{
    "body": "Instead of *one file*, having *one directory* where each package can write a file seems like a much better idea. Think of `pkgconfig`: we don't have one `pkgconfig` file, we have a directory `local/lib/pkgconfig` with one file per package.\n\nIt's not clear to me if you plan to change only the Python module `sage.env` or also the shell script `src/bin/sage-env`. Ideally, your idea should also reduce duplication/complexity in `sage-env`.\n\nI'm adding #21479 as dependency because of potential conflicts.",
    "created_at": "2017-03-20T10:45:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22415#issuecomment-312213",
    "user": "jdemeyer"
}
```

Instead of *one file*, having *one directory* where each package can write a file seems like a much better idea. Think of `pkgconfig`: we don't have one `pkgconfig` file, we have a directory `local/lib/pkgconfig` with one file per package.

It's not clear to me if you plan to change only the Python module `sage.env` or also the shell script `src/bin/sage-env`. Ideally, your idea should also reduce duplication/complexity in `sage-env`.

I'm adding #21479 as dependency because of potential conflicts.



---

archive/issue_comments_312214.json:
```json
{
    "body": "I agree--one file per package sounds better, and will also have fewer problems in parallel builds.\n\nI need to take a closer look but my hope is that such a config file could reduce complexity in *both* `sage-env` and `sage.env`.\n\nThe only thing with `sage-env` is that it should be easy to read/parse the file without, say, invoking a Python interpreter.  That's another good argument for one per-package config files, as that would reduce the complexity of the format.  Probably a `<key>=<value>` format would be good enough.",
    "created_at": "2017-03-20T10:52:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22415#issuecomment-312214",
    "user": "embray"
}
```

I agree--one file per package sounds better, and will also have fewer problems in parallel builds.

I need to take a closer look but my hope is that such a config file could reduce complexity in *both* `sage-env` and `sage.env`.

The only thing with `sage-env` is that it should be easy to read/parse the file without, say, invoking a Python interpreter.  That's another good argument for one per-package config files, as that would reduce the complexity of the format.  Probably a `<key>=<value>` format would be good enough.



---

archive/issue_comments_312215.json:
```json
{
    "body": "I would concur with Jeroen for a design with a directory but I am thinking of something like `/etc/{env.d,profile.d,sudoers.d}` and the list goes on. \n\nBonus point if both `sage-env` and `env.py` can feed from it avoiding duplication.",
    "created_at": "2017-03-20T10:54:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22415#issuecomment-312215",
    "user": "fbissey"
}
```

I would concur with Jeroen for a design with a directory but I am thinking of something like `/etc/{env.d,profile.d,sudoers.d}` and the list goes on. 

Bonus point if both `sage-env` and `env.py` can feed from it avoiding duplication.



---

archive/issue_comments_312216.json:
```json
{
    "body": "To be clear, I would still allow all these options to be read from environment variables too, and environment variables would override config files.  But this might also reduce the number of environment variables that need to be set.\n\nAnother possible advantage is the ability for per-user config files that override the globals, but I would leave that as a separate task.",
    "created_at": "2017-03-20T11:05:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22415#issuecomment-312216",
    "user": "embray"
}
```

To be clear, I would still allow all these options to be read from environment variables too, and environment variables would override config files.  But this might also reduce the number of environment variables that need to be set.

Another possible advantage is the ability for per-user config files that override the globals, but I would leave that as a separate task.



---

archive/issue_comments_312217.json:
```json
{
    "body": "See also #15087.",
    "created_at": "2017-03-20T21:11:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22415#issuecomment-312217",
    "user": "mkoeppe"
}
```

See also #15087.



---

archive/issue_comments_312218.json:
```json
{
    "body": "#15087 appears to be much more limited in scope and is slightly different, though not incompatible with this idea.  #15087 is specifically for modifying the environment, but I'm hoping with this to actually modify the environment *less*, since options can instead be read from a config file.  Good to know it exists though.",
    "created_at": "2017-03-21T09:44:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22415#issuecomment-312218",
    "user": "embray"
}
```

#15087 appears to be much more limited in scope and is slightly different, though not incompatible with this idea.  #15087 is specifically for modifying the environment, but I'm hoping with this to actually modify the environment *less*, since options can instead be read from a config file.  Good to know it exists though.



---

archive/issue_comments_312219.json:
```json
{
    "body": "One thing I'm struggling with a bit on this is, if this is implemented, what the upgrade path should look like.\n\nThe idea is to generate these config files at build time.  So how will they be generated for packages that are already built?  Maybe I should just increase the patch levels on those packages?  I think the only packages that might get their own config files are currently:\n\n* conway_polynomials\n* graphs\n* elliptic_curves\n* polytopes_db\n* gap\n* thebe\n* singular\n\nplus sagelib itself.  Any others?  I determined this (rough) list based on those packages that require any settings in `sage.env`.\n\nThere are also packages that require special environment variables to be set in `sage-env`.  Those include:\n\n* jupyter\n* matplotlib\n* r\n* maxima\n* ecl\n* ncurses\n\nThis might be a job for #15087 like functionality.",
    "created_at": "2017-03-21T09:56:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22415#issuecomment-312219",
    "user": "embray"
}
```

One thing I'm struggling with a bit on this is, if this is implemented, what the upgrade path should look like.

The idea is to generate these config files at build time.  So how will they be generated for packages that are already built?  Maybe I should just increase the patch levels on those packages?  I think the only packages that might get their own config files are currently:

* conway_polynomials
* graphs
* elliptic_curves
* polytopes_db
* gap
* thebe
* singular

plus sagelib itself.  Any others?  I determined this (rough) list based on those packages that require any settings in `sage.env`.

There are also packages that require special environment variables to be set in `sage-env`.  Those include:

* jupyter
* matplotlib
* r
* maxima
* ecl
* ncurses

This might be a job for #15087 like functionality.



---

archive/issue_comments_312220.json:
```json
{
    "body": "Replying to [comment:8 embray]:\n> Maybe I should just increase the patch levels on those packages?\n\nYes.",
    "created_at": "2017-03-21T09:58:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22415#issuecomment-312220",
    "user": "jdemeyer"
}
```

Replying to [comment:8 embray]:
> Maybe I should just increase the patch levels on those packages?

Yes.



---

archive/issue_comments_312221.json:
```json
{
    "body": "Replying to [comment:7 embray]:\n> #15087 appears to be much more limited in scope and is slightly different, though not incompatible with this idea.  #15087 is specifically for modifying the environment, but I'm hoping with this to actually modify the environment *less*, since options can instead be read from a config file.  Good to know it exists though.\n\nI don't see any difference between #15087 and this ticket, except that #15087 might be slightly more focused on the shell, while ticket is slightly more focused on the Sage library.",
    "created_at": "2017-03-21T10:00:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22415#issuecomment-312221",
    "user": "jdemeyer"
}
```

Replying to [comment:7 embray]:
> #15087 appears to be much more limited in scope and is slightly different, though not incompatible with this idea.  #15087 is specifically for modifying the environment, but I'm hoping with this to actually modify the environment *less*, since options can instead be read from a config file.  Good to know it exists though.

I don't see any difference between #15087 and this ticket, except that #15087 might be slightly more focused on the shell, while ticket is slightly more focused on the Sage library.



---

archive/issue_comments_312222.json:
```json
{
    "body": "I agree, that's the only difference. But it is a substantive one. We have two cases here: settings that must be reflected in the environment, and settings that would only be read by the Sage library, and *not* set as environment variables.  Some packages could have settings that fall into both categories too (though I don't think there are any such examples currently).\n\nIt might be possible to kill two birds with one stone here, but there needs to be a way to make this distinction.",
    "created_at": "2017-03-21T12:43:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22415#issuecomment-312222",
    "user": "embray"
}
```

I agree, that's the only difference. But it is a substantive one. We have two cases here: settings that must be reflected in the environment, and settings that would only be read by the Sage library, and *not* set as environment variables.  Some packages could have settings that fall into both categories too (though I don't think there are any such examples currently).

It might be possible to kill two birds with one stone here, but there needs to be a way to make this distinction.



---

archive/issue_comments_312223.json:
```json
{
    "body": "Maybe a simple way to kill two birds: Just a simple script that sets variables and possibly exports them.  If the line starts with export then naturally it will set an environment variable when sourced.  Otherwise it will just set a shell variable but not export it to the environment.  When `sage.env` reads these files it can parse it the same way.",
    "created_at": "2017-08-25T10:28:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22415#issuecomment-312223",
    "user": "embray"
}
```

Maybe a simple way to kill two birds: Just a simple script that sets variables and possibly exports them.  If the line starts with export then naturally it will set an environment variable when sourced.  Otherwise it will just set a shell variable but not export it to the environment.  When `sage.env` reads these files it can parse it the same way.



---

archive/issue_comments_312224.json:
```json
{
    "body": "Replying to [comment:12 embray]:\n> Maybe a simple way to kill two birds: Just a simple script that sets variables and possibly exports them.  If the line starts with export then naturally it will set an environment variable when sourced.  Otherwise it will just set a shell variable but not export it to the environment.  When `sage.env` reads these files it can parse it the same way.\n\nThis sounds like a good solution. Note `src/bin/sage-env-config` is already in a simple format, and we should keep it in this form (see discussion on #22646).",
    "created_at": "2017-08-29T19:41:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22415#issuecomment-312224",
    "user": "mkoeppe"
}
```

Replying to [comment:12 embray]:
> Maybe a simple way to kill two birds: Just a simple script that sets variables and possibly exports them.  If the line starts with export then naturally it will set an environment variable when sourced.  Otherwise it will just set a shell variable but not export it to the environment.  When `sage.env` reads these files it can parse it the same way.

This sounds like a good solution. Note `src/bin/sage-env-config` is already in a simple format, and we should keep it in this form (see discussion on #22646).



---

archive/issue_comments_312225.json:
```json
{
    "body": "I nearly forgot, I was working on implementing this last week.  I think it was working, but I wasn't sure because there were some test failures (but it seems these failures are unrelated).",
    "created_at": "2017-08-30T08:59:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22415#issuecomment-312225",
    "user": "embray"
}
```

I nearly forgot, I was working on implementing this last week.  I think it was working, but I wasn't sure because there were some test failures (but it seems these failures are unrelated).



---

archive/issue_comments_312226.json:
```json
{
    "body": "I'm reconsidering this now that I've gotten a little deeper into implementation.  There are some cases that are somewhat non-trivial, such as the environment settings for R (which, for consistency's sake, would be nice to move entirely to its own file).\n\nA related, but alternative approach I'm considering is that rather than sourcing these files directly, they should be executable scripts that do nothing but print out the environment variables that they should set.  So, for example, rather than `source $SAGE_LOCAL/etc/sage/env.d/pkgname.sh`, one would `eval `$SAGE_LOAL/etc/sage/env.d/pkgname.sh``.  Or something like that.",
    "created_at": "2017-08-30T10:56:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22415#issuecomment-312226",
    "user": "embray"
}
```

I'm reconsidering this now that I've gotten a little deeper into implementation.  There are some cases that are somewhat non-trivial, such as the environment settings for R (which, for consistency's sake, would be nice to move entirely to its own file).

A related, but alternative approach I'm considering is that rather than sourcing these files directly, they should be executable scripts that do nothing but print out the environment variables that they should set.  So, for example, rather than `source $SAGE_LOCAL/etc/sage/env.d/pkgname.sh`, one would `eval `$SAGE_LOAL/etc/sage/env.d/pkgname.sh``.  Or something like that.



---

archive/issue_comments_312227.json:
```json
{
    "body": "[ Deleted this comment which was meant for #26968. ]",
    "created_at": "2019-01-18T15:52:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22415#issuecomment-312227",
    "user": "@timokau"
}
```

[ Deleted this comment which was meant for #26968. ]



---

archive/issue_comments_312228.json:
```json
{
    "body": "My last comment was intended for #26968. Sorry for the mixup.",
    "created_at": "2019-01-18T17:41:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22415#issuecomment-312228",
    "user": "@timokau"
}
```

My last comment was intended for #26968. Sorry for the mixup.



---

archive/issue_comments_312229.json:
```json
{
    "body": "Instead of a plain-text config file, in #29022 I generate a Python module.\n\nThe issue with the library dir configuration (`SINGULAR_SO`) mentioned in the ticket description has again come up in #29013 (venv).\nIt should indeed be fixed by just writing out the configured library path to the new configuration file.",
    "created_at": "2020-01-15T23:35:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22415",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22415#issuecomment-312229",
    "user": "mkoeppe"
}
```

Instead of a plain-text config file, in #29022 I generate a Python module.

The issue with the library dir configuration (`SINGULAR_SO`) mentioned in the ticket description has again come up in #29013 (venv).
It should indeed be fixed by just writing out the configured library path to the new configuration file.
