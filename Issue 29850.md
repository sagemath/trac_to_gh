# Issue 29850: crash in JacobianMorphism_divisor_class_field.__init__ when variable is not calledÂ x

archive/issues_029850.json:
```json
{
    "body": "CC:  @alexjbest @kedlaya @slel\n\nKeywords: hyperelliptic jacobian\n\nThe following code:\n\n\n```python\nR.<v> = QQ[]\nC = HyperellipticCurve(v**3-1)\nJ = C.jacobian()\nD = J(v-1,0)\n```\n\n\ncrashes on sage version 9.1 and the current `develop` branch with the exception:\n\n\n```\nTraceback (most recent call last):\n  File \"./mfe.sage.py\", line 10, in <module>\n    D = J(v-_sage_const_1 ,_sage_const_0 )\n  File \"sage/schemes/generic/scheme.py\", line 265, in __call__\n    return self.point(args)\n  File \"sage/schemes/hyperelliptic_curves/jacobian_generic.py\", line 147, in point\n    return self(self.base_ring())(mumford)\n  File \"schemes/hyperelliptic_curves/jacobian_homset.py\", line 149, in __call__\n    return JacobianMorphism_divisor_class_field(self, (P1, P2))\n  File \"sage/schemes/hyperelliptic_curves/jacobian_morphism.py\", line 386, in __init__\n    if not (b**2 + h*b - f)%a == 0:\n  File \"sage/structure/element.pyx\", line 1517, in sage.structure.element.Element.__mul__ (build/cythonized/sage/structure/element.c:12231)\n  File \"sage/structure/coerce.pyx\", line 1255, in sage.structure.coerce.CoercionModel.bin_op (build/cythonized/sage/structure/coerce.c:11275)\nTypeError: unsupported operand parent(s) for *: 'Univariate Polynomial Ring in v over Rational Field' and 'Univariate Polynomial Ring in x over Rational Field'\n```\n\n\nThe reason is that the code uses `x` internally and doesn't expect the input to come from a \"different\" univariate polynomial ring, hence the exception. The error does not occur when `v` is replaced by `x` in the example above.\n\nThe proposed patch explicitly casts the given polynomials to the parent ring of the curve's defining polynomials.\n\nIssue created by migration from https://trac.sagemath.org/ticket/30087\n\n",
    "created_at": "2020-07-08T01:45:00Z",
    "labels": [
        "component: algebraic geometry",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "crash in JacobianMorphism_divisor_class_field.__init__ when variable is not called\u00a0x",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29850",
    "user": "https://github.com/yyyyx4"
}
```
CC:  @alexjbest @kedlaya @slel

Keywords: hyperelliptic jacobian

The following code:


```python
R.<v> = QQ[]
C = HyperellipticCurve(v**3-1)
J = C.jacobian()
D = J(v-1,0)
```


crashes on sage version 9.1 and the current `develop` branch with the exception:


```
Traceback (most recent call last):
  File "./mfe.sage.py", line 10, in <module>
    D = J(v-_sage_const_1 ,_sage_const_0 )
  File "sage/schemes/generic/scheme.py", line 265, in __call__
    return self.point(args)
  File "sage/schemes/hyperelliptic_curves/jacobian_generic.py", line 147, in point
    return self(self.base_ring())(mumford)
  File "schemes/hyperelliptic_curves/jacobian_homset.py", line 149, in __call__
    return JacobianMorphism_divisor_class_field(self, (P1, P2))
  File "sage/schemes/hyperelliptic_curves/jacobian_morphism.py", line 386, in __init__
    if not (b**2 + h*b - f)%a == 0:
  File "sage/structure/element.pyx", line 1517, in sage.structure.element.Element.__mul__ (build/cythonized/sage/structure/element.c:12231)
  File "sage/structure/coerce.pyx", line 1255, in sage.structure.coerce.CoercionModel.bin_op (build/cythonized/sage/structure/coerce.c:11275)
TypeError: unsupported operand parent(s) for *: 'Univariate Polynomial Ring in v over Rational Field' and 'Univariate Polynomial Ring in x over Rational Field'
```


The reason is that the code uses `x` internally and doesn't expect the input to come from a "different" univariate polynomial ring, hence the exception. The error does not occur when `v` is replaced by `x` in the example above.

The proposed patch explicitly casts the given polynomials to the parent ring of the curve's defining polynomials.

Issue created by migration from https://trac.sagemath.org/ticket/30087





---

archive/issue_comments_423520.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-08T01:49:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29850#issuecomment-423520",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_423521.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-08T02:13:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29850#issuecomment-423521",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_423522.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-07-08T09:19:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29850#issuecomment-423522",
    "user": "https://github.com/yyyyx4"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_423523.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-08-13T21:25:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29850#issuecomment-423523",
    "user": "https://github.com/mwageringel"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_423524.json:
```json
{
    "body": "Thank you for reporting this. It seems the current branch introduces a few test failures, which I do not know how to solve myself. Someone familiar with schemes, please take a look.\n\nYou can run the tests on individual files and folders like this:\n\n```\n./sage -t -l src/sage/schemes/hyperelliptic_curves/jacobian_morphism.py\n```\n\n\nMoreover, please add your full name to the Authors field of this ticket. Otherwise, the automatic patchbot does not run the tests for this ticket.\n\nAlso, it seems the result of this line is not used anymore with your changes:\n\n```\npolys = cantor_reduction(a, b, f, h, genus)\n```\n",
    "created_at": "2020-08-13T21:25:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29850#issuecomment-423524",
    "user": "https://github.com/mwageringel"
}
```

Thank you for reporting this. It seems the current branch introduces a few test failures, which I do not know how to solve myself. Someone familiar with schemes, please take a look.

You can run the tests on individual files and folders like this:

```
./sage -t -l src/sage/schemes/hyperelliptic_curves/jacobian_morphism.py
```


Moreover, please add your full name to the Authors field of this ticket. Otherwise, the automatic patchbot does not run the tests for this ticket.

Also, it seems the result of this line is not used anymore with your changes:

```
polys = cantor_reduction(a, b, f, h, genus)
```




---

archive/issue_comments_423525.json:
```json
{
    "body": "The doctest failures are coming from the fact that a Jacobian can be constructed with a different base field than the underlying curve, so taking the base ring from the curve itself is creating errors.\n\nThe path of least resistance is to create a `HyperellipticCurve` with custom variables:\n\n```\nsage: R.<v> = QQ[]                                                              \nsage: C = HyperellipticCurve(v**3-1,0, 'v,y')                                   \nsage: J = C.jacobian()                                                          \nsage: D = J(v-1, 0); D\n(v - 1, y)\n```\n\nGiven this, I'm not even sure this should be considered a bug in the first place. Maybe a better fix would be to edit some docstrings to better document the existing behavior.",
    "created_at": "2020-08-15T19:25:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29850#issuecomment-423525",
    "user": "https://github.com/kedlaya"
}
```

The doctest failures are coming from the fact that a Jacobian can be constructed with a different base field than the underlying curve, so taking the base ring from the curve itself is creating errors.

The path of least resistance is to create a `HyperellipticCurve` with custom variables:

```
sage: R.<v> = QQ[]                                                              
sage: C = HyperellipticCurve(v**3-1,0, 'v,y')                                   
sage: J = C.jacobian()                                                          
sage: D = J(v-1, 0); D
(v - 1, y)
```

Given this, I'm not even sure this should be considered a bug in the first place. Maybe a better fix would be to edit some docstrings to better document the existing behavior.



---

archive/issue_comments_423526.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29850#issuecomment-423526",
    "user": "https://github.com/mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_423527.json:
```json
{
    "body": "Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29850#issuecomment-423527",
    "user": "https://github.com/mkoeppe"
}
```

Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_comments_423528.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-07-28T07:49:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29850#issuecomment-423528",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_423529.json:
```json
{
    "body": "Thanks for the feedback, and sorry about the test failures.\n\nI updated the patch to convert everything to the jacobian's internal polynomial ring when constructing divisors. Since the jacobian's polynomial ring is in turn based on the curve's polynomial ring, this should make everything use the same names consistently (the ones passed in `names=` when constructing the curve, or `x,y` by default), which makes the coercions between \"curve polynomials\" and \"jacobian polynomials\" in the divisor arithmetic work automatically.",
    "created_at": "2021-07-28T08:03:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29850#issuecomment-423529",
    "user": "https://github.com/yyyyx4"
}
```

Thanks for the feedback, and sorry about the test failures.

I updated the patch to convert everything to the jacobian's internal polynomial ring when constructing divisors. Since the jacobian's polynomial ring is in turn based on the curve's polynomial ring, this should make everything use the same names consistently (the ones passed in `names=` when constructing the curve, or `x,y` by default), which makes the coercions between "curve polynomials" and "jacobian polynomials" in the divisor arithmetic work automatically.



---

archive/issue_comments_423530.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-07-28T08:03:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29850#issuecomment-423530",
    "user": "https://github.com/yyyyx4"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_423531.json:
```json
{
    "body": "Replying to [comment:6 kedlaya]:\n> The doctest failures are coming from the fact that a Jacobian can be constructed with a different base field than the underlying curve, so taking the base ring from the curve itself is creating errors.\n> \n> The path of least resistance is to create a `HyperellipticCurve` with custom variables:\n> {{{\n> sage: R.<v> = QQ[]                                                              \n> sage: C = HyperellipticCurve(v**3-1,0, 'v,y')                                   \n> sage: J = C.jacobian()                                                          \n> sage: D = J(v-1, 0); D\n> (v - 1, y)\n> }}}\n> Given this, I'm not even sure this should be considered a bug in the first place. Maybe a better fix would be to edit some docstrings to better document the existing behavior.\n\nGiven that a hyperelliptic curve can be constructed from a univariate polynomial, I think the \"custom names\" option for hyperelliptic curves is problematic: it requires the user to repeat elements, where this wouldn't really be required. The `u` or `x` can be read off from the parent of the passed-in univariate polynomial. If it is required to come up with a name for the other variable (like `y`) we may have a bit of a problem, because the system can't choose itself very well. Particularly, for `HyperellipticCurve(y^5+y+1)` we would have a problem, since you probably do not want to name the other variable `y` as well. So perhaps there should be an option to give the name of the second variable (only) ?\n\nCurrently, the interface creates unnecessary ambiguity: what would `HyperellipticCurve(x^5+x+1,'y,x')` be?",
    "created_at": "2021-07-28T17:05:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29850#issuecomment-423531",
    "user": "https://github.com/nbruin"
}
```

Replying to [comment:6 kedlaya]:
> The doctest failures are coming from the fact that a Jacobian can be constructed with a different base field than the underlying curve, so taking the base ring from the curve itself is creating errors.
> 
> The path of least resistance is to create a `HyperellipticCurve` with custom variables:
> {{{
> sage: R.<v> = QQ[]                                                              
> sage: C = HyperellipticCurve(v**3-1,0, 'v,y')                                   
> sage: J = C.jacobian()                                                          
> sage: D = J(v-1, 0); D
> (v - 1, y)
> }}}
> Given this, I'm not even sure this should be considered a bug in the first place. Maybe a better fix would be to edit some docstrings to better document the existing behavior.

Given that a hyperelliptic curve can be constructed from a univariate polynomial, I think the "custom names" option for hyperelliptic curves is problematic: it requires the user to repeat elements, where this wouldn't really be required. The `u` or `x` can be read off from the parent of the passed-in univariate polynomial. If it is required to come up with a name for the other variable (like `y`) we may have a bit of a problem, because the system can't choose itself very well. Particularly, for `HyperellipticCurve(y^5+y+1)` we would have a problem, since you probably do not want to name the other variable `y` as well. So perhaps there should be an option to give the name of the second variable (only) ?

Currently, the interface creates unnecessary ambiguity: what would `HyperellipticCurve(x^5+x+1,'y,x')` be?



---

archive/issue_comments_423532.json:
```json
{
    "body": "+1 to an optional argument to name the second variable.",
    "created_at": "2021-08-01T18:33:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29850#issuecomment-423532",
    "user": "https://github.com/kedlaya"
}
```

+1 to an optional argument to name the second variable.



---

archive/issue_comments_423533.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-03T05:30:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29850#issuecomment-423533",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_423534.json:
```json
{
    "body": "Replying to [comment:14 kedlaya]:\n> +1 to an optional argument to name the second variable.\n\nDone.\n\nReplying to [comment:13 nbruin]:\n> Currently, the interface creates unnecessary ambiguity: what would `HyperellipticCurve(x^5+x+1,'y,x')` be?\n\nThis should clearly be (and already is) `x^2 = y^5 + y + 1`: The meaning of `names=` is to forget about the original variables of `f` and `h` and use the given names instead.",
    "created_at": "2021-08-03T05:32:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29850#issuecomment-423534",
    "user": "https://github.com/yyyyx4"
}
```

Replying to [comment:14 kedlaya]:
> +1 to an optional argument to name the second variable.

Done.

Replying to [comment:13 nbruin]:
> Currently, the interface creates unnecessary ambiguity: what would `HyperellipticCurve(x^5+x+1,'y,x')` be?

This should clearly be (and already is) `x^2 = y^5 + y + 1`: The meaning of `names=` is to forget about the original variables of `f` and `h` and use the given names instead.



---

archive/issue_comments_423535.json:
```json
{
    "body": "Another possibility would be to allow `names=[None, 'z']`\nto specify the second name only.",
    "created_at": "2021-08-03T07:55:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29850#issuecomment-423535",
    "user": "https://github.com/slel"
}
```

Another possibility would be to allow `names=[None, 'z']`
to specify the second name only.



---

archive/issue_comments_423536.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-05T09:06:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29850#issuecomment-423536",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_423537.json:
```json
{
    "body": "Replying to [comment:17 slelievre]:\n> Another possibility would be to allow `names=[None, 'z']`\n> to specify the second name only.\n\nThanks for the suggestion. I agree that the interface is cleaner without the redundancy of having two different arguments.",
    "created_at": "2021-08-05T09:09:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29850#issuecomment-423537",
    "user": "https://github.com/yyyyx4"
}
```

Replying to [comment:17 slelievre]:
> Another possibility would be to allow `names=[None, 'z']`
> to specify the second name only.

Thanks for the suggestion. I agree that the interface is cleaner without the redundancy of having two different arguments.



---

archive/issue_comments_423538.json:
```json
{
    "body": "Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.",
    "created_at": "2021-12-18T19:53:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29850#issuecomment-423538",
    "user": "https://github.com/mkoeppe"
}
```

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.



---

archive/issue_comments_423539.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-10-17T15:48:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29850#issuecomment-423539",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:
