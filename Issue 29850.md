# Issue 29850: crash in JacobianMorphism_divisor_class_field.__init__ when variable is not calledÂ x

Issue created by migration from https://trac.sagemath.org/ticket/30087

Original creator: lorenz

Original creation time: 2020-07-08 01:45:00

CC:  alexjbest kedlaya slelievre

Keywords: hyperelliptic jacobian

The following code:


```python
R.<v> = QQ[]
C = HyperellipticCurve(v**3-1)
J = C.jacobian()
D = J(v-1,0)
```


crashes on sage version 9.1 and the current `develop` branch with the exception:


```
Traceback (most recent call last):
  File "./mfe.sage.py", line 10, in <module>
    D = J(v-_sage_const_1 ,_sage_const_0 )
  File "sage/schemes/generic/scheme.py", line 265, in __call__
    return self.point(args)
  File "sage/schemes/hyperelliptic_curves/jacobian_generic.py", line 147, in point
    return self(self.base_ring())(mumford)
  File "schemes/hyperelliptic_curves/jacobian_homset.py", line 149, in __call__
    return JacobianMorphism_divisor_class_field(self, (P1, P2))
  File "sage/schemes/hyperelliptic_curves/jacobian_morphism.py", line 386, in __init__
    if not (b**2 + h*b - f)%a == 0:
  File "sage/structure/element.pyx", line 1517, in sage.structure.element.Element.__mul__ (build/cythonized/sage/structure/element.c:12231)
  File "sage/structure/coerce.pyx", line 1255, in sage.structure.coerce.CoercionModel.bin_op (build/cythonized/sage/structure/coerce.c:11275)
TypeError: unsupported operand parent(s) for *: 'Univariate Polynomial Ring in v over Rational Field' and 'Univariate Polynomial Ring in x over Rational Field'
```


The reason is that the code uses `x` internally and doesn't expect the input to come from a "different" univariate polynomial ring, hence the exception. The error does not occur when `v` is replaced by `x` in the example above.

The proposed patch explicitly casts the given polynomials to the parent ring of the curve's defining polynomials.


---

Comment by git created at 2020-07-08 01:49:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-08 02:13:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lorenz created at 2020-07-08 09:19:39

Changing status from new to needs_review.


---

Comment by @mwageringel created at 2020-08-13 21:25:23

Changing status from needs_review to needs_work.


---

Comment by @mwageringel created at 2020-08-13 21:25:23

Thank you for reporting this. It seems the current branch introduces a few test failures, which I do not know how to solve myself. Someone familiar with schemes, please take a look.

You can run the tests on individual files and folders like this:

```
./sage -t -l src/sage/schemes/hyperelliptic_curves/jacobian_morphism.py
```


Moreover, please add your full name to the Authors field of this ticket. Otherwise, the automatic patchbot does not run the tests for this ticket.

Also, it seems the result of this line is not used anymore with your changes:

```
polys = cantor_reduction(a, b, f, h, genus)
```



---

Comment by kedlaya created at 2020-08-15 19:25:39

The doctest failures are coming from the fact that a Jacobian can be constructed with a different base field than the underlying curve, so taking the base ring from the curve itself is creating errors.

The path of least resistance is to create a `HyperellipticCurve` with custom variables:

```
sage: R.<v> = QQ[]                                                              
sage: C = HyperellipticCurve(v**3-1,0, 'v,y')                                   
sage: J = C.jacobian()                                                          
sage: D = J(v-1, 0); D
(v - 1, y)
```

Given this, I'm not even sure this should be considered a bug in the first place. Maybe a better fix would be to edit some docstrings to better document the existing behavior.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by git created at 2021-07-28 07:49:44

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by lorenz created at 2021-07-28 08:03:18

Thanks for the feedback, and sorry about the test failures.

I updated the patch to convert everything to the jacobian's internal polynomial ring when constructing divisors. Since the jacobian's polynomial ring is in turn based on the curve's polynomial ring, this should make everything use the same names consistently (the ones passed in `names=` when constructing the curve, or `x,y` by default), which makes the coercions between "curve polynomials" and "jacobian polynomials" in the divisor arithmetic work automatically.


---

Comment by lorenz created at 2021-07-28 08:03:59

Changing status from needs_work to needs_review.


---

Comment by nbruin created at 2021-07-28 17:05:07

Replying to [comment:6 kedlaya]:
> The doctest failures are coming from the fact that a Jacobian can be constructed with a different base field than the underlying curve, so taking the base ring from the curve itself is creating errors.
> 
> The path of least resistance is to create a `HyperellipticCurve` with custom variables:
> {{{
> sage: R.<v> = QQ[]                                                              
> sage: C = HyperellipticCurve(v**3-1,0, 'v,y')                                   
> sage: J = C.jacobian()                                                          
> sage: D = J(v-1, 0); D
> (v - 1, y)
> }}}
> Given this, I'm not even sure this should be considered a bug in the first place. Maybe a better fix would be to edit some docstrings to better document the existing behavior.

Given that a hyperelliptic curve can be constructed from a univariate polynomial, I think the "custom names" option for hyperelliptic curves is problematic: it requires the user to repeat elements, where this wouldn't really be required. The `u` or `x` can be read off from the parent of the passed-in univariate polynomial. If it is required to come up with a name for the other variable (like `y`) we may have a bit of a problem, because the system can't choose itself very well. Particularly, for `HyperellipticCurve(y^5+y+1)` we would have a problem, since you probably do not want to name the other variable `y` as well. So perhaps there should be an option to give the name of the second variable (only) ?

Currently, the interface creates unnecessary ambiguity: what would `HyperellipticCurve(x^5+x+1,'y,x')` be?


---

Comment by kedlaya created at 2021-08-01 18:33:13

+1 to an optional argument to name the second variable.


---

Comment by git created at 2021-08-03 05:30:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lorenz created at 2021-08-03 05:32:38

Replying to [comment:14 kedlaya]:
> +1 to an optional argument to name the second variable.

Done.

Replying to [comment:13 nbruin]:
> Currently, the interface creates unnecessary ambiguity: what would `HyperellipticCurve(x^5+x+1,'y,x')` be?

This should clearly be (and already is) `x^2 = y^5 + y + 1`: The meaning of `names=` is to forget about the original variables of `f` and `h` and use the given names instead.


---

Comment by slelievre created at 2021-08-03 07:55:09

Another possibility would be to allow `names=[None, 'z']`
to specify the second name only.


---

Comment by git created at 2021-08-05 09:06:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lorenz created at 2021-08-05 09:09:04

Replying to [comment:17 slelievre]:
> Another possibility would be to allow `names=[None, 'z']`
> to specify the second name only.

Thanks for the suggestion. I agree that the interface is cleaner without the redundancy of having two different arguments.


---

Comment by mkoeppe created at 2021-12-18 19:53:12

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.


---

Comment by git created at 2022-10-17 15:48:16

Branch pushed to git repo; I updated commit sha1. New commits:
