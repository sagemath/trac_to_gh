# Issue 25010: py3: float.__str__ differences

Issue created by migration from https://trac.sagemath.org/ticket/25247

Original creator: embray

Original creation time: 2018-04-25 10:01:51

I've mentioned this in a few places before, but there wasn't a ticket for it:

In Python 2, `float.__str__` and `float.__repr__` are different (with only the latter showing 17 significant digits, while the former is arbitrarily truncated to 12:


```python
>>> str(2.0/3)
'0.666666666667'
>>> repr(2.0/3)
'0.6666666666666666'
```


Whereas on Python 3 `float.__str__` and `float.__repr__` are the same (exactly, in all cases):


```python
>>> str(2.0/3)
'0.6666666666666666'
>>> repr(2.0/3)
'0.6666666666666666'
```


For once StackOverflow provides good background: https://stackoverflow.com/a/25899600/982257

In fact the new `float.__repr__` has been backported to Python 2, but it keeps the old `float.__str__`.

A result of this is that in Python 3 any tests where `float.__str__` is used gives different results, and we need to decide how best to handle that difference.

My personal preference would be to wherever possible in Sage (e.g. in `RealDoubleElement` and the like) to always use the `repr()` where it currently uses `str()`.  The [new repr algorithm](https://bugs.python.org/issue1580) is quite a bit nicer.

This would obviously be a backwards-incompatible change in some ways, but would there be much harm?


---

Comment by jdemeyer created at 2018-04-25 10:43:25

Replying to [ticket:25247 embray]:
> My personal preference would be to wherever possible in Sage (e.g. in `RealDoubleElement` and the like) to always use the `repr()` where it currently uses `str()`.

Fine for me.

> This would obviously be a backwards-incompatible change in some ways, but would there be much harm?

It's unlikely to break code, but it might break some doctests (but probably not too much since doctests typically use `repr()` and that will not change).


---

Comment by tscrim created at 2018-04-25 12:12:57

My thoughts are the same as Jeroen's.


---

Comment by embray created at 2018-04-26 13:02:56

Just by a quick scan of the current test failures on Python 3 it will actually break a _lot_ of doctests in Sage, but that's the point :)

It could also break any doctests in any third-party packages that relying on the `str()` representation of floats anywhere.  It should certainly be documented as a backwards-incompatible change, albeit one that should cause only minor disruption if any.


---

Comment by jdemeyer created at 2018-04-26 13:56:09

Replying to [comment:3 embray]:
> It should certainly be documented as a backwards-incompatible change

Since when do we document changes :-)


---

Comment by embray created at 2018-04-26 14:05:49

Oh, right...


---

Comment by embray created at 2018-04-28 22:52:04

I think this will actually cover most cases.  It seems there were fewer impacted doctests than I thought, I guess maybe since MPFR is used more pervasively than `RealDoubleElement`.

I'm pretty sure there are some other doctests (e.g. that explicitly call `str()` on some float value) that might need updating, but not many.  I'll check the Python 3 test results and see if there are more I'm missing.
----
New commits:


---

Comment by chapoton created at 2018-06-13 16:08:28

Is this needing rewiew ??


---

Comment by chapoton created at 2018-06-14 13:33:07

green bot..


---

Comment by jdemeyer created at 2018-06-14 13:54:52

Wouldn't it be better to just remove `double_str` completely?


---

Comment by jdemeyer created at 2018-06-14 13:55:29

And you can probably remove `__str__` too.


---

Comment by embray created at 2018-06-22 14:38:20

I guess I kept it for backwards compatibility since it is used in at least one other module (though that usage should also be replaced with `double_repr`).

How strong of an "API" guarantee do we make with `cdef` functions exported via a `.pxd`?


---

Comment by git created at 2018-06-22 14:41:47

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-06-22 14:42:09

Changing status from new to needs_review.


---

Comment by embray created at 2018-06-22 14:42:09

Rebased and removed `double_str` and a couple `__str__`.


---

Comment by chapoton created at 2018-06-22 17:29:32

Looks good. Jeroen, do you agree ?


---

Comment by jdemeyer created at 2018-06-22 20:21:07

I haven't really looked closely, so my opinion is neutral. If you think it's good, you can set this to positive review.


---

Comment by chapoton created at 2018-06-23 07:20:36

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2018-06-23 07:20:36

Then I will give a positive review.


---

Comment by vbraun created at 2018-06-24 19:52:31

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2018-06-24 19:52:31

On 32-bit:

```
File "src/sage/plot/plot3d/base.pyx", line 1740, in sage.plot.plot3d.base.Graphics3d.stl_ascii_string
Failed example:
    astl.splitlines()[:7]
Expected:
    ['solid surface',
    'facet normal 0.9733285267845754 -0.16222142113076257 -0.16222142113076257',
    '    outer loop',
    '        vertex 2.94871794872 -0.384615384615 -0.39358974359',
    '        vertex 2.95021367521 -0.384615384615 -0.384615384615',
    '        vertex 2.94871794872 -0.39358974359 -0.384615384615',
    '    endloop']
Got:
    ['solid surface',
     'facet normal 0.9733285267845758 -0.16222142113076066 -0.16222142113076066',
     '    outer loop',
     '        vertex 2.94871794872 -0.384615384615 -0.39358974359',
     '        vertex 2.95021367521 -0.384615384615 -0.384615384615',
     '        vertex 2.94871794872 -0.39358974359 -0.384615384615',
     '    endloop']
**********************************************************************
1 item had failures:
   1 of  10 in sage.plot.plot3d.base.Graphics3d.stl_ascii_string
    [337 tests, 1 failure, 46.41 s]
----------------------------------------------------------------------
sage -t --long src/sage/plot/plot3d/base.pyx  # 1 doctest failed
```



---

Comment by embray created at 2018-06-25 08:12:31

Any suggestions for fixing that?  Would an `# abstol` flag be sufficient?  I have no way of testing this.


---

Comment by git created at 2018-06-25 09:13:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-06-25 09:13:34

How's this?


---

Comment by embray created at 2018-06-25 09:13:34

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2018-06-26 05:13:56

arando patchbot is 32 bits, and has given a green light

so let us try again


---

Comment by chapoton created at 2018-06-26 05:13:56

Changing status from needs_review to positive_review.


---

Comment by tmonteil created at 2018-06-26 14:43:49

I launched a 32bit VM on this.


---

Comment by tmonteil created at 2018-06-26 21:52:06

Apparently it is happy too.


---

Comment by embray created at 2018-06-27 14:02:26

Thanks!


---

Comment by vbraun created at 2018-06-29 22:34:00

Resolution: fixed
