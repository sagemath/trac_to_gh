# Issue 25010: py3: float.__str__ differences

archive/issues_025010.json:
```json
{
    "body": "I've mentioned this in a few places before, but there wasn't a ticket for it:\n\nIn Python 2, `float.__str__` and `float.__repr__` are different (with only the latter showing 17 significant digits, while the former is arbitrarily truncated to 12:\n\n\n```python\n>>> str(2.0/3)\n'0.666666666667'\n>>> repr(2.0/3)\n'0.6666666666666666'\n```\n\n\nWhereas on Python 3 `float.__str__` and `float.__repr__` are the same (exactly, in all cases):\n\n\n```python\n>>> str(2.0/3)\n'0.6666666666666666'\n>>> repr(2.0/3)\n'0.6666666666666666'\n```\n\n\nFor once StackOverflow provides good background: https://stackoverflow.com/a/25899600/982257\n\nIn fact the new `float.__repr__` has been backported to Python 2, but it keeps the old `float.__str__`.\n\nA result of this is that in Python 3 any tests where `float.__str__` is used gives different results, and we need to decide how best to handle that difference.\n\nMy personal preference would be to wherever possible in Sage (e.g. in `RealDoubleElement` and the like) to always use the `repr()` where it currently uses `str()`.  The [new repr algorithm](https://bugs.python.org/issue1580) is quite a bit nicer.\n\nThis would obviously be a backwards-incompatible change in some ways, but would there be much harm?\n\nIssue created by migration from https://trac.sagemath.org/ticket/25247\n\n",
    "created_at": "2018-04-25T10:01:51Z",
    "labels": [
        "python3",
        "major",
        "bug"
    ],
    "title": "py3: float.__str__ differences",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25010",
    "user": "embray"
}
```
I've mentioned this in a few places before, but there wasn't a ticket for it:

In Python 2, `float.__str__` and `float.__repr__` are different (with only the latter showing 17 significant digits, while the former is arbitrarily truncated to 12:


```python
>>> str(2.0/3)
'0.666666666667'
>>> repr(2.0/3)
'0.6666666666666666'
```


Whereas on Python 3 `float.__str__` and `float.__repr__` are the same (exactly, in all cases):


```python
>>> str(2.0/3)
'0.6666666666666666'
>>> repr(2.0/3)
'0.6666666666666666'
```


For once StackOverflow provides good background: https://stackoverflow.com/a/25899600/982257

In fact the new `float.__repr__` has been backported to Python 2, but it keeps the old `float.__str__`.

A result of this is that in Python 3 any tests where `float.__str__` is used gives different results, and we need to decide how best to handle that difference.

My personal preference would be to wherever possible in Sage (e.g. in `RealDoubleElement` and the like) to always use the `repr()` where it currently uses `str()`.  The [new repr algorithm](https://bugs.python.org/issue1580) is quite a bit nicer.

This would obviously be a backwards-incompatible change in some ways, but would there be much harm?

Issue created by migration from https://trac.sagemath.org/ticket/25247





---

archive/issue_comments_351904.json:
```json
{
    "body": "Replying to [ticket:25247 embray]:\n> My personal preference would be to wherever possible in Sage (e.g. in `RealDoubleElement` and the like) to always use the `repr()` where it currently uses `str()`.\n\nFine for me.\n\n> This would obviously be a backwards-incompatible change in some ways, but would there be much harm?\n\nIt's unlikely to break code, but it might break some doctests (but probably not too much since doctests typically use `repr()` and that will not change).",
    "created_at": "2018-04-25T10:43:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25010#issuecomment-351904",
    "user": "jdemeyer"
}
```

Replying to [ticket:25247 embray]:
> My personal preference would be to wherever possible in Sage (e.g. in `RealDoubleElement` and the like) to always use the `repr()` where it currently uses `str()`.

Fine for me.

> This would obviously be a backwards-incompatible change in some ways, but would there be much harm?

It's unlikely to break code, but it might break some doctests (but probably not too much since doctests typically use `repr()` and that will not change).



---

archive/issue_comments_351905.json:
```json
{
    "body": "My thoughts are the same as Jeroen's.",
    "created_at": "2018-04-25T12:12:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25010#issuecomment-351905",
    "user": "tscrim"
}
```

My thoughts are the same as Jeroen's.



---

archive/issue_comments_351906.json:
```json
{
    "body": "Just by a quick scan of the current test failures on Python 3 it will actually break a *lot* of doctests in Sage, but that's the point :)\n\nIt could also break any doctests in any third-party packages that relying on the `str()` representation of floats anywhere.  It should certainly be documented as a backwards-incompatible change, albeit one that should cause only minor disruption if any.",
    "created_at": "2018-04-26T13:02:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25010#issuecomment-351906",
    "user": "embray"
}
```

Just by a quick scan of the current test failures on Python 3 it will actually break a *lot* of doctests in Sage, but that's the point :)

It could also break any doctests in any third-party packages that relying on the `str()` representation of floats anywhere.  It should certainly be documented as a backwards-incompatible change, albeit one that should cause only minor disruption if any.



---

archive/issue_comments_351907.json:
```json
{
    "body": "Replying to [comment:3 embray]:\n> It should certainly be documented as a backwards-incompatible change\n\nSince when do we document changes :-)",
    "created_at": "2018-04-26T13:56:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25010#issuecomment-351907",
    "user": "jdemeyer"
}
```

Replying to [comment:3 embray]:
> It should certainly be documented as a backwards-incompatible change

Since when do we document changes :-)



---

archive/issue_comments_351908.json:
```json
{
    "body": "Oh, right...",
    "created_at": "2018-04-26T14:05:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25010#issuecomment-351908",
    "user": "embray"
}
```

Oh, right...



---

archive/issue_comments_351909.json:
```json
{
    "body": "I think this will actually cover most cases.  It seems there were fewer impacted doctests than I thought, I guess maybe since MPFR is used more pervasively than `RealDoubleElement`.\n\nI'm pretty sure there are some other doctests (e.g. that explicitly call `str()` on some float value) that might need updating, but not many.  I'll check the Python 3 test results and see if there are more I'm missing.\n----\nNew commits:",
    "created_at": "2018-04-28T22:52:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25010#issuecomment-351909",
    "user": "embray"
}
```

I think this will actually cover most cases.  It seems there were fewer impacted doctests than I thought, I guess maybe since MPFR is used more pervasively than `RealDoubleElement`.

I'm pretty sure there are some other doctests (e.g. that explicitly call `str()` on some float value) that might need updating, but not many.  I'll check the Python 3 test results and see if there are more I'm missing.
----
New commits:



---

archive/issue_comments_351910.json:
```json
{
    "body": "Is this needing rewiew ??",
    "created_at": "2018-06-13T16:08:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25010#issuecomment-351910",
    "user": "chapoton"
}
```

Is this needing rewiew ??



---

archive/issue_comments_351911.json:
```json
{
    "body": "green bot..",
    "created_at": "2018-06-14T13:33:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25010#issuecomment-351911",
    "user": "chapoton"
}
```

green bot..



---

archive/issue_comments_351912.json:
```json
{
    "body": "Wouldn't it be better to just remove `double_str` completely?",
    "created_at": "2018-06-14T13:54:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25010#issuecomment-351912",
    "user": "jdemeyer"
}
```

Wouldn't it be better to just remove `double_str` completely?



---

archive/issue_comments_351913.json:
```json
{
    "body": "And you can probably remove `__str__` too.",
    "created_at": "2018-06-14T13:55:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25010#issuecomment-351913",
    "user": "jdemeyer"
}
```

And you can probably remove `__str__` too.



---

archive/issue_comments_351914.json:
```json
{
    "body": "I guess I kept it for backwards compatibility since it is used in at least one other module (though that usage should also be replaced with `double_repr`).\n\nHow strong of an \"API\" guarantee do we make with `cdef` functions exported via a `.pxd`?",
    "created_at": "2018-06-22T14:38:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25010#issuecomment-351914",
    "user": "embray"
}
```

I guess I kept it for backwards compatibility since it is used in at least one other module (though that usage should also be replaced with `double_repr`).

How strong of an "API" guarantee do we make with `cdef` functions exported via a `.pxd`?



---

archive/issue_comments_351915.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-06-22T14:41:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25010#issuecomment-351915",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_351916.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-06-22T14:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25010#issuecomment-351916",
    "user": "embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_351917.json:
```json
{
    "body": "Rebased and removed `double_str` and a couple `__str__`.",
    "created_at": "2018-06-22T14:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25010#issuecomment-351917",
    "user": "embray"
}
```

Rebased and removed `double_str` and a couple `__str__`.



---

archive/issue_comments_351918.json:
```json
{
    "body": "Looks good. Jeroen, do you agree ?",
    "created_at": "2018-06-22T17:29:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25010#issuecomment-351918",
    "user": "chapoton"
}
```

Looks good. Jeroen, do you agree ?



---

archive/issue_comments_351919.json:
```json
{
    "body": "I haven't really looked closely, so my opinion is neutral. If you think it's good, you can set this to positive review.",
    "created_at": "2018-06-22T20:21:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25010#issuecomment-351919",
    "user": "jdemeyer"
}
```

I haven't really looked closely, so my opinion is neutral. If you think it's good, you can set this to positive review.



---

archive/issue_comments_351920.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-06-23T07:20:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25010#issuecomment-351920",
    "user": "chapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_351921.json:
```json
{
    "body": "Then I will give a positive review.",
    "created_at": "2018-06-23T07:20:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25010#issuecomment-351921",
    "user": "chapoton"
}
```

Then I will give a positive review.



---

archive/issue_comments_351922.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-06-24T19:52:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25010#issuecomment-351922",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_351923.json:
```json
{
    "body": "On 32-bit:\n\n```\nFile \"src/sage/plot/plot3d/base.pyx\", line 1740, in sage.plot.plot3d.base.Graphics3d.stl_ascii_string\nFailed example:\n    astl.splitlines()[:7]\nExpected:\n    ['solid surface',\n    'facet normal 0.9733285267845754 -0.16222142113076257 -0.16222142113076257',\n    '    outer loop',\n    '        vertex 2.94871794872 -0.384615384615 -0.39358974359',\n    '        vertex 2.95021367521 -0.384615384615 -0.384615384615',\n    '        vertex 2.94871794872 -0.39358974359 -0.384615384615',\n    '    endloop']\nGot:\n    ['solid surface',\n     'facet normal 0.9733285267845758 -0.16222142113076066 -0.16222142113076066',\n     '    outer loop',\n     '        vertex 2.94871794872 -0.384615384615 -0.39358974359',\n     '        vertex 2.95021367521 -0.384615384615 -0.384615384615',\n     '        vertex 2.94871794872 -0.39358974359 -0.384615384615',\n     '    endloop']\n**********************************************************************\n1 item had failures:\n   1 of  10 in sage.plot.plot3d.base.Graphics3d.stl_ascii_string\n    [337 tests, 1 failure, 46.41 s]\n----------------------------------------------------------------------\nsage -t --long src/sage/plot/plot3d/base.pyx  # 1 doctest failed\n```\n",
    "created_at": "2018-06-24T19:52:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25010#issuecomment-351923",
    "user": "vbraun"
}
```

On 32-bit:

```
File "src/sage/plot/plot3d/base.pyx", line 1740, in sage.plot.plot3d.base.Graphics3d.stl_ascii_string
Failed example:
    astl.splitlines()[:7]
Expected:
    ['solid surface',
    'facet normal 0.9733285267845754 -0.16222142113076257 -0.16222142113076257',
    '    outer loop',
    '        vertex 2.94871794872 -0.384615384615 -0.39358974359',
    '        vertex 2.95021367521 -0.384615384615 -0.384615384615',
    '        vertex 2.94871794872 -0.39358974359 -0.384615384615',
    '    endloop']
Got:
    ['solid surface',
     'facet normal 0.9733285267845758 -0.16222142113076066 -0.16222142113076066',
     '    outer loop',
     '        vertex 2.94871794872 -0.384615384615 -0.39358974359',
     '        vertex 2.95021367521 -0.384615384615 -0.384615384615',
     '        vertex 2.94871794872 -0.39358974359 -0.384615384615',
     '    endloop']
**********************************************************************
1 item had failures:
   1 of  10 in sage.plot.plot3d.base.Graphics3d.stl_ascii_string
    [337 tests, 1 failure, 46.41 s]
----------------------------------------------------------------------
sage -t --long src/sage/plot/plot3d/base.pyx  # 1 doctest failed
```




---

archive/issue_comments_351924.json:
```json
{
    "body": "Any suggestions for fixing that?  Would an `# abstol` flag be sufficient?  I have no way of testing this.",
    "created_at": "2018-06-25T08:12:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25010#issuecomment-351924",
    "user": "embray"
}
```

Any suggestions for fixing that?  Would an `# abstol` flag be sufficient?  I have no way of testing this.



---

archive/issue_comments_351925.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-25T09:13:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25010#issuecomment-351925",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_351926.json:
```json
{
    "body": "How's this?",
    "created_at": "2018-06-25T09:13:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25010#issuecomment-351926",
    "user": "embray"
}
```

How's this?



---

archive/issue_comments_351927.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-06-25T09:13:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25010#issuecomment-351927",
    "user": "embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_351928.json:
```json
{
    "body": "arando patchbot is 32 bits, and has given a green light\n\nso let us try again",
    "created_at": "2018-06-26T05:13:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25010#issuecomment-351928",
    "user": "chapoton"
}
```

arando patchbot is 32 bits, and has given a green light

so let us try again



---

archive/issue_comments_351929.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-06-26T05:13:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25010#issuecomment-351929",
    "user": "chapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_351930.json:
```json
{
    "body": "I launched a 32bit VM on this.",
    "created_at": "2018-06-26T14:43:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25010#issuecomment-351930",
    "user": "tmonteil"
}
```

I launched a 32bit VM on this.



---

archive/issue_comments_351931.json:
```json
{
    "body": "Apparently it is happy too.",
    "created_at": "2018-06-26T21:52:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25010#issuecomment-351931",
    "user": "tmonteil"
}
```

Apparently it is happy too.



---

archive/issue_comments_351932.json:
```json
{
    "body": "Thanks!",
    "created_at": "2018-06-27T14:02:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25010#issuecomment-351932",
    "user": "embray"
}
```

Thanks!



---

archive/issue_comments_351933.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-06-29T22:34:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25010#issuecomment-351933",
    "user": "vbraun"
}
```

Resolution: fixed
