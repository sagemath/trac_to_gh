# Issue 31612: Shadowing Fricas function names leads to results un-backtranslatable to Sage.

archive/issues_031612.json:
```json
{
    "body": "CC:  @mwhansen @mantepse @slel @fchapoton @tscrim\n\nKeywords: symbolic fricas interface\n\nMotivation : this ask.sagemath [question](https://ask.sagemath.org/question/57235/are-these-integrate-interface-issues-with-fricas-known/).\n\nContemplate :\n\n```\nsage: var('x d b c a D C A B')\n(x, d, b, c, a, D, C, A, B)\nsage: foo = (b*x + a)^2*(D*x^3 + C*x^2 + B*x + A)/(d*x + c)\nsage: integrate(foo, x, algorithm=\"fricas\")\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n```\n    \nBandwidth savings : Snip...\n\n```\nTypeError: unsupported operand parent(s) for *: 'Integer Ring' and '<class 'function'>'\n```\n\nBut :\n\n```\nsage: var(\"capitalD\")\ncapitalD\nsage: integrate(foo.subs({D:capitalD}), x, algorithm=\"fricas\").subs({capitalD:D})\n1/60*(12*D*b^2*d^5*x^5 - 15*(D*b^2*c*d^4 - (2*D*a*b + C*b^2)*d^5)*x^4 + 20*(D*b^2*c^2*d^3 + (D*a^2 + 2*C*a*b + B*b^2)*d^5 - (2*D*a*b*c + C*b^2*c)*d^4)*x^3 - 30*(D*b^2*c^3*d^2 - (C*a^2 + 2*B*a*b + A*b^2)*d^5 + (D*a^2*c + (2*C*a*b + B*b^2)*c)*d^4 - (2*D*a*b*c^2 + C*b^2*c^2)*d^3)*x^2 + 60*(D*b^2*c^4*d - (C*a^2 + 2*B*a*b + A*b^2)*c*d^4 + (B*a^2 + 2*A*a*b)*d^5 + (D*a^2*c^2 + (2*C*a*b + B*b^2)*c^2)*d^3 - (2*D*a*b*c^3 + C*b^2*c^3)*d^2)*x - 60*(D*b^2*c^5 - A*a^2*d^5 - (C*a^2 + 2*B*a*b + A*b^2)*c^2*d^3 + (B*a^2 + 2*A*a*b)*c*d^4 + (D*a^2*c^3 + (2*C*a*b + B*b^2)*c^3)*d^2 - (2*D*a*b*c^4 + C*b^2*c^4)*d)*log(d*x + c))/d^6\n```\n\nThe cherry on the pie :\n\n```\nsage: bool(integrate(foo.subs({D:capitalD}), x, algorithm=\"fricas\").diff(x).subs({capitalD:D})==foo)\nTrue\n```\n\n\nThe use of the variable `D` shadows the Fricas function `D`, which is //not// a problem for Fricas, but is not known to the `fricas._sage_()` method, which uses hardcoded equivalences for categorizing syntactic trees' atoms.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/31849\n\n",
    "created_at": "2021-05-23T13:22:04Z",
    "labels": [
        "component: interfaces",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "Shadowing Fricas function names leads to results un-backtranslatable to Sage.",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31612",
    "user": "https://github.com/EmmanuelCharpentier"
}
```
CC:  @mwhansen @mantepse @slel @fchapoton @tscrim

Keywords: symbolic fricas interface

Motivation : this ask.sagemath [question](https://ask.sagemath.org/question/57235/are-these-integrate-interface-issues-with-fricas-known/).

Contemplate :

```
sage: var('x d b c a D C A B')
(x, d, b, c, a, D, C, A, B)
sage: foo = (b*x + a)^2*(D*x^3 + C*x^2 + B*x + A)/(d*x + c)
sage: integrate(foo, x, algorithm="fricas")
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
```
    
Bandwidth savings : Snip...

```
TypeError: unsupported operand parent(s) for *: 'Integer Ring' and '<class 'function'>'
```

But :

```
sage: var("capitalD")
capitalD
sage: integrate(foo.subs({D:capitalD}), x, algorithm="fricas").subs({capitalD:D})
1/60*(12*D*b^2*d^5*x^5 - 15*(D*b^2*c*d^4 - (2*D*a*b + C*b^2)*d^5)*x^4 + 20*(D*b^2*c^2*d^3 + (D*a^2 + 2*C*a*b + B*b^2)*d^5 - (2*D*a*b*c + C*b^2*c)*d^4)*x^3 - 30*(D*b^2*c^3*d^2 - (C*a^2 + 2*B*a*b + A*b^2)*d^5 + (D*a^2*c + (2*C*a*b + B*b^2)*c)*d^4 - (2*D*a*b*c^2 + C*b^2*c^2)*d^3)*x^2 + 60*(D*b^2*c^4*d - (C*a^2 + 2*B*a*b + A*b^2)*c*d^4 + (B*a^2 + 2*A*a*b)*d^5 + (D*a^2*c^2 + (2*C*a*b + B*b^2)*c^2)*d^3 - (2*D*a*b*c^3 + C*b^2*c^3)*d^2)*x - 60*(D*b^2*c^5 - A*a^2*d^5 - (C*a^2 + 2*B*a*b + A*b^2)*c^2*d^3 + (B*a^2 + 2*A*a*b)*c*d^4 + (D*a^2*c^3 + (2*C*a*b + B*b^2)*c^3)*d^2 - (2*D*a*b*c^4 + C*b^2*c^4)*d)*log(d*x + c))/d^6
```

The cherry on the pie :

```
sage: bool(integrate(foo.subs({D:capitalD}), x, algorithm="fricas").diff(x).subs({capitalD:D})==foo)
True
```


The use of the variable `D` shadows the Fricas function `D`, which is //not// a problem for Fricas, but is not known to the `fricas._sage_()` method, which uses hardcoded equivalences for categorizing syntactic trees' atoms.


Issue created by migration from https://trac.sagemath.org/ticket/31849





---

archive/issue_comments_451009.json:
```json
{
    "body": "There are similar problems with other interfaces as well, such as Giac #30133.",
    "created_at": "2021-05-23T16:06:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31612",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31612#issuecomment-451009",
    "user": "https://github.com/mwageringel"
}
```

There are similar problems with other interfaces as well, such as Giac #30133.



---

archive/issue_comments_451010.json:
```json
{
    "body": "I think the problem is here:\n\n```\n    @staticmethod\n    def _parse_other(s, start=0, make_fun=False):\n        \"\"\"\n...\n        This function uses the symbol table to translate symbols\n        which are not function calls.  At least ``%pi`` is an\n        example showing that this may be necessary::\n\n            sage: FriCASElement._parse_other(\"%pi\")\n            (pi, 2)\n\n        \"\"\"\n        a = start\n        b = len(s)\n        while a < b and s[a] not in FriCASElement._WHITESPACE and s[a] != FriCASElement._RIGHTBRACKET:\n            a += 1\n\n        e = s[start:a]\n        if make_fun:\n            try:\n                e = symbol_table[\"fricas\"][e]\n            except KeyError:\n                e = function(e)\n        else:\n            try:\n                e = ZZ(e)\n            except TypeError:\n                try:\n                    e = float(e)\n                except ValueError:\n                    try:\n                       e = symbol_table[\"fricas\"][e]\n                    except KeyError:\n                        e = var(e.replace(\"%\", \"_\"))\n        return e, a - 1\n```\n\n\nIn line -4, we check whether `e` is in the symbol table, because it might be a constant like `%pi` or `%i` or `infinity`.  I guess the easiest way out is to check for these explicitely.  I am not sure whether we should remove constants from the symbol table entirely, but it may be less confusing to do so.",
    "created_at": "2021-05-24T12:09:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31612",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31612#issuecomment-451010",
    "user": "https://github.com/mantepse"
}
```

I think the problem is here:

```
    @staticmethod
    def _parse_other(s, start=0, make_fun=False):
        """
...
        This function uses the symbol table to translate symbols
        which are not function calls.  At least ``%pi`` is an
        example showing that this may be necessary::

            sage: FriCASElement._parse_other("%pi")
            (pi, 2)

        """
        a = start
        b = len(s)
        while a < b and s[a] not in FriCASElement._WHITESPACE and s[a] != FriCASElement._RIGHTBRACKET:
            a += 1

        e = s[start:a]
        if make_fun:
            try:
                e = symbol_table["fricas"][e]
            except KeyError:
                e = function(e)
        else:
            try:
                e = ZZ(e)
            except TypeError:
                try:
                    e = float(e)
                except ValueError:
                    try:
                       e = symbol_table["fricas"][e]
                    except KeyError:
                        e = var(e.replace("%", "_"))
        return e, a - 1
```


In line -4, we check whether `e` is in the symbol table, because it might be a constant like `%pi` or `%i` or `infinity`.  I guess the easiest way out is to check for these explicitely.  I am not sure whether we should remove constants from the symbol table entirely, but it may be less confusing to do so.



---

archive/issue_comments_451011.json:
```json
{
    "body": "It might make sense to move the imports and the `register_symbol` statements from `_sage_expression` and `_parse_other` to module level, but I don't know what's best practice for that.\n----\nNew commits:",
    "created_at": "2021-05-24T13:24:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31612",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31612#issuecomment-451011",
    "user": "https://github.com/mantepse"
}
```

It might make sense to move the imports and the `register_symbol` statements from `_sage_expression` and `_parse_other` to module level, but I don't know what's best practice for that.
----
New commits:



---

archive/issue_comments_451012.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-05-24T13:24:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31612",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31612#issuecomment-451012",
    "user": "https://github.com/mantepse"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_451013.json:
```json
{
    "body": "Changing cc list, guessing the intention was to cc `@`mhansen, who was involved\nin past FriCAS-related tickets such as #6318, #6517, #9258, #9354, rather than `@`dmhansen, who contributed Weil pairings in #4964.",
    "created_at": "2021-05-24T13:49:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31612",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31612#issuecomment-451013",
    "user": "https://github.com/slel"
}
```

Changing cc list, guessing the intention was to cc `@`mhansen, who was involved
in past FriCAS-related tickets such as #6318, #6517, #9258, #9354, rather than `@`dmhansen, who contributed Weil pairings in #4964.



---

archive/issue_comments_451014.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-21T17:42:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31612",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31612#issuecomment-451014",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_451015.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-21T17:45:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31612",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31612#issuecomment-451015",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_451016.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-22T08:53:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31612",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31612#issuecomment-451016",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_451017.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-22T12:03:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31612",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31612#issuecomment-451017",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_451018.json:
```json
{
    "body": "Emmanuel, could you have a look, please?",
    "created_at": "2021-06-23T14:30:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31612",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31612#issuecomment-451018",
    "user": "https://github.com/mantepse"
}
```

Emmanuel, could you have a look, please?



---

archive/issue_comments_451019.json:
```json
{
    "body": "Frederic, do you have a minute for this one?",
    "created_at": "2021-06-24T11:12:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31612",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31612#issuecomment-451019",
    "user": "https://github.com/mantepse"
}
```

Frederic, do you have a minute for this one?



---

archive/issue_comments_451020.json:
```json
{
    "body": "Travis, could you have a quick look, please?  I think it would be good to have this in the next release.",
    "created_at": "2021-06-30T14:57:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31612",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31612#issuecomment-451020",
    "user": "https://github.com/mantepse"
}
```

Travis, could you have a quick look, please?  I think it would be good to have this in the next release.



---

archive/issue_comments_451021.json:
```json
{
    "body": "Do we always want to continually recreate the `constants` dict? Wouldn't it make more sense to be created at the module level?\n\nAlso, could you revert this change as the line ends after `\"\"\"` is Sage's convention:\n\n```diff\ndiff --git a/src/sage/interfaces/fricas.py b/src/sage/interfaces/fricas.py\nindex a73330e..faac5e2 100644\n--- a/src/sage/interfaces/fricas.py\n+++ b/src/sage/interfaces/fricas.py\n@@ -1281,8 +1281,7 @@ class FriCASElement(ExpectElement):\n \n     @staticmethod\n     def _parse_other(s, start=0, make_fun=False):\n-        \"\"\"\n-        Parse the initial part of a string, assuming that it is an\n+        \"\"\"Parse the initial part of a string, assuming that it is an\n         atom, but not a string.\n \n         Symbols and numbers must not contain ``FriCASElement._WHITESPACE`` and\n```\n",
    "created_at": "2021-06-30T23:45:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31612",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31612#issuecomment-451021",
    "user": "https://github.com/tscrim"
}
```

Do we always want to continually recreate the `constants` dict? Wouldn't it make more sense to be created at the module level?

Also, could you revert this change as the line ends after `"""` is Sage's convention:

```diff
diff --git a/src/sage/interfaces/fricas.py b/src/sage/interfaces/fricas.py
index a73330e..faac5e2 100644
--- a/src/sage/interfaces/fricas.py
+++ b/src/sage/interfaces/fricas.py
@@ -1281,8 +1281,7 @@ class FriCASElement(ExpectElement):
 
     @staticmethod
     def _parse_other(s, start=0, make_fun=False):
-        """
-        Parse the initial part of a string, assuming that it is an
+        """Parse the initial part of a string, assuming that it is an
         atom, but not a string.
 
         Symbols and numbers must not contain ``FriCASElement._WHITESPACE`` and
```




---

archive/issue_comments_451022.json:
```json
{
    "body": "Would the following at module level be OK?  (It works, but I am not sure about coding style.)\n\nThere is also a warning: \"resolving lazy import infinity during startup\"\n\n\n```\nlazy_import('sage.symbolic.constants', [\"I\", \"e\", \"pi\"])\nlazy_import('sage.rings.infinity', [\"infinity\"])\n\nFRICAS_CONSTANTS = {'%i': I,\n                    '%e': e,\n                    '%pi': pi,\n                    'infinity': infinity,\n                    'plusInfinity': infinity,\n                    'minusInfinity': -infinity}\n```\n",
    "created_at": "2021-07-01T09:25:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31612",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31612#issuecomment-451022",
    "user": "https://github.com/mantepse"
}
```

Would the following at module level be OK?  (It works, but I am not sure about coding style.)

There is also a warning: "resolving lazy import infinity during startup"


```
lazy_import('sage.symbolic.constants', ["I", "e", "pi"])
lazy_import('sage.rings.infinity', ["infinity"])

FRICAS_CONSTANTS = {'%i': I,
                    '%e': e,
                    '%pi': pi,
                    'infinity': infinity,
                    'plusInfinity': infinity,
                    'minusInfinity': -infinity}
```




---

archive/issue_comments_451023.json:
```json
{
    "body": "Yes, that would be good. Although you don't need to lazily import `infinity` here because it is already imported globally at startup.",
    "created_at": "2021-07-02T02:21:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31612",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31612#issuecomment-451023",
    "user": "https://github.com/tscrim"
}
```

Yes, that would be good. Although you don't need to lazily import `infinity` here because it is already imported globally at startup.



---

archive/issue_comments_451024.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-02T10:47:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31612",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31612#issuecomment-451024",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_451025.json:
```json
{
    "body": "Done!  (I would have liked to do the same with the long sequence of `register_symbol` statements in `_sage_expression`. This failed because of a circular dependency caused by `register_symbol(pi, {'fricas': 'pi'})`.  Possibly I could move them into a class method, which I call from `FriCAS.__init__`?",
    "created_at": "2021-07-02T10:50:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31612",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31612#issuecomment-451025",
    "user": "https://github.com/mantepse"
}
```

Done!  (I would have liked to do the same with the long sequence of `register_symbol` statements in `_sage_expression`. This failed because of a circular dependency caused by `register_symbol(pi, {'fricas': 'pi'})`.  Possibly I could move them into a class method, which I call from `FriCAS.__init__`?



---

archive/issue_comments_451026.json:
```json
{
    "body": "Thank you.\n\nI don't immediately know what would cause that circular import. Of course, the ideal thing would be to remove the circular import, but if that is not feasible, your solution of doing something in the `__init__` is much better than doing this in something that is repeatedly called.\n\nAre you going to do that on this ticket or a separate one?",
    "created_at": "2021-07-03T01:40:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31612",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31612#issuecomment-451026",
    "user": "https://github.com/tscrim"
}
```

Thank you.

I don't immediately know what would cause that circular import. Of course, the ideal thing would be to remove the circular import, but if that is not feasible, your solution of doing something in the `__init__` is much better than doing this in something that is repeatedly called.

Are you going to do that on this ticket or a separate one?



---

archive/issue_comments_451027.json:
```json
{
    "body": "I think it is better to do this in a separate ticket, because doing so I discovered a bug in the `rootOf` translation.\n\nI opened #32133 for the translation, and I'll do the move there as a first step.",
    "created_at": "2021-07-05T09:54:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31612",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31612#issuecomment-451027",
    "user": "https://github.com/mantepse"
}
```

I think it is better to do this in a separate ticket, because doing so I discovered a bug in the `rootOf` translation.

I opened #32133 for the translation, and I'll do the move there as a first step.



---

archive/issue_comments_451028.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-07-05T13:06:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31612",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31612#issuecomment-451028",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_451029.json:
```json
{
    "body": "Okay, positive review.",
    "created_at": "2021-07-05T13:06:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31612",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31612#issuecomment-451029",
    "user": "https://github.com/tscrim"
}
```

Okay, positive review.



---

archive/issue_comments_451030.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-07-09T20:23:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31612",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31612#issuecomment-451030",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
