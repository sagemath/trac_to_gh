# Issue 15366: "immutable=True" for Graph/Digraph __init__ and copy()

Issue created by migration from Trac.

Original creator: ncohen

Original creation time: 2013-12-28 23:54:32

CC:  simonking

As promised on #15278, this ticket adds an 'immutable' keyword to the constructors of Graph/Digraph, and in 'copy()' too.

While I was at it, I tried to clean a bit the 'copy()' method, which now systematically checks its input. It should deal with every situation `:-P`

And I think I will have to clean the constructors of Graph/Digraph too at some point.

Nathann


---

Comment by ncohen created at 2013-12-28 23:59:53

Changing status from new to needs_review.


---

Comment by git created at 2013-12-29 00:08:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2013-12-29 11:14:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2013-12-29 15:43:34

What do you think ? `:-)`

Nathann


---

Comment by git created at 2013-12-29 15:44:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2013-12-29 16:08:07

The commit looks good, except for the spaces in front of colons and question marks... Do you add this space in your smileys, too? ` :- ?` ` ; -)`

I think we agreed that we'll use a _new_ ticket to fix sage.combinat's hack with `_immutable=True` and our counter-hack with type-checking immutability. Of course, I first want to see if the tests pass before giving a positive review.


---

Comment by ncohen created at 2013-12-29 16:13:03

Yoooooo !

> The commit looks good, except for the spaces in front of colons and question marks... Do you add this space in your smileys, too? ` :- ?` ` ; -)`

Argggggg `T_T`

Well right now I'm trying to read a spanish book (even though I don't speak a word of it)... At least I don't put their weird reversed question marks in the code `:-PPP`

> I think we agreed that we'll use a _new_ ticket to fix sage.combinat's hack with `_immutable=True` and our counter-hack with type-checking immutability. Of course, I first want to see if the tests pass before giving a positive review.

Yepyepyep, sounds right.

Nathann


---

Comment by SimonKing created at 2013-12-29 19:15:11

All tests pass, but I think I'll add a review commit, a bit later.


---

Comment by SimonKing created at 2014-01-03 10:05:20

Things that need to be done (in a review commit): In some place you explain the `immutable=...` optional argument, but in the example you use `data_structure=...` only. In some other place, you do this change:

```diff
     If the ``data_structure`` is equal to ``"static_sparse"``, then an
     immutable graph results. Note that this does not use the NetworkX data
     structure::
 
-          sage: G_imm = Graph(g, data_structure="static_sparse")
-          sage: H_imm = Graph(g, data_structure="static_sparse")
+          sage: G_imm = Graph(g, immutable=True)
+          sage: H_imm = Graph(g, immutable=True)
           sage: G_imm == H_imm == G == H
           True
```

Hence, the text is about data_structure, but you remove it from the test.


---

Comment by ncohen created at 2014-01-03 10:15:17

"that need to be done" : will that be your review commit, or do you want me to do that ?

Nathann


---

Comment by SimonKing created at 2014-01-03 10:20:56

Replying to [comment:11 ncohen]:
> "that need to be done" : will that be your review commit, or do you want me to do that ?

I wrote "that need to be done (in a review commit)". Hence, I'll do it.


---

Comment by ncohen created at 2014-01-03 10:22:29

Oops sorry. I missed that, in my eagerness to see these patches in Sage `^^;`

Nathann


---

Comment by SimonKing created at 2014-01-03 10:28:44

There is a naked `NotImplementedError`:

```
            sage: g = DiGraph(graphs.PetersenGraph(), immutable=True)
            sage: g.add_edge("Hey", "Heyyyyyyy")
            Traceback (most recent call last):
            ...
            NotImplementedError:
```

Should we care?


---

Comment by SimonKing created at 2014-01-03 10:32:30


```
            sage: g = graphs.PetersenGraph()
            sage: g = DiGraph(g.edges(),immutable=False)
            sage: g.add_edge("Hey", "Heyyyyyyy")
            sage: {g:1}[g]
            TypeError: This graph is mutable, and thus not hashable. Create an immutable copy by `g.copy(data_structure='static_sparse')`
```

Should the error message mention the other (more intuitive) possibility `g.copy(immutable=True)`?


---

Comment by ncohen created at 2014-01-03 10:37:13

Hmmmm... We could add an empty function for `add_edge` in the backend indeed. Depending on where the immutable graph comes from, the user may not have any idea of why this function is not implemented. Something like what `add_vertex` does.

Yes to your other comment about the exception raised by `__hash__`.

Nathann


---

Comment by SimonKing created at 2014-01-03 10:39:32

Since I want this to get over with and since my family plans to have an excursion today, I prefer to only fix the error message raised by `__hash__`, but leave the `NotImplementedError` as it is.


---

Comment by ncohen created at 2014-01-03 10:41:31

Ahahahah. Okay no prob. I'll fix that later in another patch `;-)`

Nathann


---

Comment by SimonKing created at 2014-01-03 11:20:50

Changing status from needs_review to positive_review.


---

Comment by SimonKing created at 2014-01-03 11:20:50

I have added a review commit and run all tests in src/sage/graphs without error. Positive review (unless your aren't happy with my review commit or find that surprisingly the new error message appears in other parts of Sage too).
----
New commits:


---

Comment by ncohen created at 2014-01-03 11:23:20

NOnono that' s great ! Thanks  `:-)` 

Nathann


---

Comment by vbraun created at 2014-01-05 00:32:08

Resolution: fixed
