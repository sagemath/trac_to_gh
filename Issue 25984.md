# Issue 25984: Enable hash for FreeMonoid_class

Issue created by migration from https://trac.sagemath.org/ticket/26221

Original creator: jhpalmieri

Original creation time: 2018-09-08 06:03:18

As in #26162 and other tickets, removing `__eq__` does the job.

Without this change, there are Python 3 doctest failures in `sage/algebras/lie_algebras`, among other places. For example,

```
File "src/sage/algebras/lie_algebras/lie_algebra.py", line 1402, in sage.algebras.lie_algebras.lie_algebra.LiftMorphismToAssociative.preimage
Failed example:
    L = LieAlgebra(associative=R)
Exception raised:
    Traceback (most recent call last):
      File "sage/misc/cachefunc.pyx", line 1000, in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6175)
        return self.cache[k]
      File "sage/misc/weak_dict.pyx", line 706, in sage.misc.weak_dict.WeakValueDictionary.__getitem__ (build/cythonized/sage/misc/weak_dict.c:3538)
        cdef PyObject* wr = PyDict_GetItemWithError(self, k)
    TypeError: unhashable type: 'FreeMonoid_class_with_category'

...
```



---

Comment by jhpalmieri created at 2018-09-08 06:04:37

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2018-09-08 06:04:37

New commits:


---

Comment by tscrim created at 2018-09-08 11:06:05

Changing status from needs_review to needs_work.


---

Comment by tscrim created at 2018-09-08 11:06:05

Doctest failures (see patchbots):

```
sage -t --long src/sage/crypto/classical.py  # 8 doctests failed
sage -t --long src/sage/crypto/classical_cipher.py  # 5 doctests failed
```

The issue comes from the fact that `StringMonoid_class` inherits from `FreeMonoid_class`, but because the `FreeMonoid_class` uses `UniqueFactory`, it does not have `UniqueRepresentation` behavior inherited. Moreover, all of the subclasses of `StringMonoid_class` have their own hand-rolled caches. The proper thing to do would be to rename `FreeMonoid_class` -> `FreeMonoid` and have it inherit from `UniqueRepresentation` and get rid of all of those custom caches. It is a bit of work, but it will be a good improvement to the code.


---

Comment by jhpalmieri created at 2018-09-08 22:41:07

I think I would prefer to keep `FreeMonoid` as a function, since it forks depending on whether the monoid is abelian or not, but I can try to work on having `FreeMonoid_class` inherit from `UniqueRepresentation`.


---

Comment by tscrim created at 2018-09-08 22:44:23

Replying to [comment:4 jhpalmieri]:
> I think I would prefer to keep `FreeMonoid` as a function, since it forks depending on whether the monoid is abelian or not, but I can try to work on having `FreeMonoid_class` inherit from `UniqueRepresentation`.

You can absorb this behavior into the `__classcall_private__`, but perhaps considering the documentation, it might be better to actually keep it separate. I don't have a particularly strong opinion either way.


---

Comment by git created at 2018-09-09 01:05:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2018-09-09 01:06:05

Okay, here is a branch using `UniqueRepresentation`, but I'm confused by

> Moreover, all of the subclasses of StringMonoid_class have their own hand-rolled caches.

Can you clarify?


---

Comment by jhpalmieri created at 2018-09-09 01:06:05

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2018-09-09 01:15:09

Replying to [comment:7 jhpalmieri]:
> Okay, here is a branch using `UniqueRepresentation`, but I'm confused by

Great, thank you. Small detail: the doc from `__classcall_private__` should almost entirely be moved into the class-level doc so it is visible under `FreeMonoid?` and in the html docs.

> > Moreover, all of the subclasses of StringMonoid_class have their own hand-rolled caches.
> 
> Can you clarify?

See the `_cache` module variable and `def BinaryStrings()` in `string_monoid.py`. So they are double-caching with your current changes.


---

Comment by git created at 2018-09-09 01:18:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-09 01:57:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2018-09-09 02:02:02

Okay, how about this? (Independently, I realized the same thing about the docstrings, which is why I made that change almost immediately after your comment.) I also thought about just renaming `BinaryStringMonoid -> BinaryStrings`, but both are used in different parts of the Sage library, so I left it as is.


---

Comment by tscrim created at 2018-09-09 09:19:41

The docstrings still will not show in the `?` and html doc if they are in the `__init__` because there is already a class-level doc. I would rather have it in the class-level doc so we can use the `__init__` to discuss implementation details. You also should be able to just call the `index_set` as `n` in the `__init__`.

I am okay with leaving the alias for now, but it should really be uniformized at some point. Yet, I've already asked quite a lot from you on this ticket.


---

Comment by git created at 2018-09-09 20:22:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2018-09-09 20:23:51

Okay, how about this?


---

Comment by tscrim created at 2018-09-09 22:44:49

Yep. LGTM. Thank you.


---

Comment by tscrim created at 2018-09-09 22:44:49

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-09-11 21:40:54

Resolution: fixed
