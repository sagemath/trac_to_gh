# Issue 25984: Enable hash for FreeMonoid_class

archive/issues_025984.json:
```json
{
    "body": "As in #26162 and other tickets, removing `__eq__` does the job. Also:\n\n- use `UniqueRepresentation` instead of `UniqueFactory` for constructing instances of `FreeMonoid`.\n- clean up caching of subclasses: no need to do this by hand, since they will now inherit from `UniqueRepresentation`.\n\nWithout this change, there are Python 3 doctest failures in `sage/algebras/lie_algebras`, among other places. For example,\n\n```\nFile \"src/sage/algebras/lie_algebras/lie_algebra.py\", line 1402, in sage.algebras.lie_algebras.lie_algebra.LiftMorphismToAssociative.preimage\nFailed example:\n    L = LieAlgebra(associative=R)\nException raised:\n    Traceback (most recent call last):\n      File \"sage/misc/cachefunc.pyx\", line 1000, in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6175)\n        return self.cache[k]\n      File \"sage/misc/weak_dict.pyx\", line 706, in sage.misc.weak_dict.WeakValueDictionary.__getitem__ (build/cythonized/sage/misc/weak_dict.c:3538)\n        cdef PyObject* wr = PyDict_GetItemWithError(self, k)\n    TypeError: unhashable type: 'FreeMonoid_class_with_category'\n\n...\n```\n\nPart of #24551.\n\nIssue created by migration from https://trac.sagemath.org/ticket/26221\n\n",
    "closed_at": "2018-09-11T21:40:54Z",
    "created_at": "2018-09-08T06:03:18Z",
    "labels": [
        "component: python3",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.4",
    "title": "Enable hash for FreeMonoid_class",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25984",
    "user": "https://github.com/jhpalmieri"
}
```
As in #26162 and other tickets, removing `__eq__` does the job. Also:

- use `UniqueRepresentation` instead of `UniqueFactory` for constructing instances of `FreeMonoid`.
- clean up caching of subclasses: no need to do this by hand, since they will now inherit from `UniqueRepresentation`.

Without this change, there are Python 3 doctest failures in `sage/algebras/lie_algebras`, among other places. For example,

```
File "src/sage/algebras/lie_algebras/lie_algebra.py", line 1402, in sage.algebras.lie_algebras.lie_algebra.LiftMorphismToAssociative.preimage
Failed example:
    L = LieAlgebra(associative=R)
Exception raised:
    Traceback (most recent call last):
      File "sage/misc/cachefunc.pyx", line 1000, in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6175)
        return self.cache[k]
      File "sage/misc/weak_dict.pyx", line 706, in sage.misc.weak_dict.WeakValueDictionary.__getitem__ (build/cythonized/sage/misc/weak_dict.c:3538)
        cdef PyObject* wr = PyDict_GetItemWithError(self, k)
    TypeError: unhashable type: 'FreeMonoid_class_with_category'

...
```

Part of #24551.

Issue created by migration from https://trac.sagemath.org/ticket/26221





---

archive/issue_comments_366005.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-09-08T06:04:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25984#issuecomment-366005",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_366006.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-09-08T06:04:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25984#issuecomment-366006",
    "user": "https://github.com/jhpalmieri"
}
```

New commits:



---

archive/issue_comments_366007.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-09-08T11:06:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25984#issuecomment-366007",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_366008.json:
```json
{
    "body": "Doctest failures (see patchbots):\n\n```\nsage -t --long src/sage/crypto/classical.py  # 8 doctests failed\nsage -t --long src/sage/crypto/classical_cipher.py  # 5 doctests failed\n```\nThe issue comes from the fact that `StringMonoid_class` inherits from `FreeMonoid_class`, but because the `FreeMonoid_class` uses `UniqueFactory`, it does not have `UniqueRepresentation` behavior inherited. Moreover, all of the subclasses of `StringMonoid_class` have their own hand-rolled caches. The proper thing to do would be to rename `FreeMonoid_class` -> `FreeMonoid` and have it inherit from `UniqueRepresentation` and get rid of all of those custom caches. It is a bit of work, but it will be a good improvement to the code.",
    "created_at": "2018-09-08T11:06:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25984#issuecomment-366008",
    "user": "https://github.com/tscrim"
}
```

Doctest failures (see patchbots):

```
sage -t --long src/sage/crypto/classical.py  # 8 doctests failed
sage -t --long src/sage/crypto/classical_cipher.py  # 5 doctests failed
```
The issue comes from the fact that `StringMonoid_class` inherits from `FreeMonoid_class`, but because the `FreeMonoid_class` uses `UniqueFactory`, it does not have `UniqueRepresentation` behavior inherited. Moreover, all of the subclasses of `StringMonoid_class` have their own hand-rolled caches. The proper thing to do would be to rename `FreeMonoid_class` -> `FreeMonoid` and have it inherit from `UniqueRepresentation` and get rid of all of those custom caches. It is a bit of work, but it will be a good improvement to the code.



---

archive/issue_comments_366009.json:
```json
{
    "body": "I think I would prefer to keep `FreeMonoid` as a function, since it forks depending on whether the monoid is abelian or not, but I can try to work on having `FreeMonoid_class` inherit from `UniqueRepresentation`.",
    "created_at": "2018-09-08T22:41:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25984#issuecomment-366009",
    "user": "https://github.com/jhpalmieri"
}
```

I think I would prefer to keep `FreeMonoid` as a function, since it forks depending on whether the monoid is abelian or not, but I can try to work on having `FreeMonoid_class` inherit from `UniqueRepresentation`.



---

archive/issue_comments_366010.json:
```json
{
    "body": "Replying to [comment:4 jhpalmieri]:\n> I think I would prefer to keep `FreeMonoid` as a function, since it forks depending on whether the monoid is abelian or not, but I can try to work on having `FreeMonoid_class` inherit from `UniqueRepresentation`.\n\n\nYou can absorb this behavior into the `__classcall_private__`, but perhaps considering the documentation, it might be better to actually keep it separate. I don't have a particularly strong opinion either way.",
    "created_at": "2018-09-08T22:44:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25984#issuecomment-366010",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:4 jhpalmieri]:
> I think I would prefer to keep `FreeMonoid` as a function, since it forks depending on whether the monoid is abelian or not, but I can try to work on having `FreeMonoid_class` inherit from `UniqueRepresentation`.


You can absorb this behavior into the `__classcall_private__`, but perhaps considering the documentation, it might be better to actually keep it separate. I don't have a particularly strong opinion either way.



---

archive/issue_comments_366011.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-09-09T01:05:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25984#issuecomment-366011",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_366012.json:
```json
{
    "body": "Okay, here is a branch using `UniqueRepresentation`, but I'm confused by\n\n> Moreover, all of the subclasses of StringMonoid_class have their own hand-rolled caches.\n\n\nCan you clarify?",
    "created_at": "2018-09-09T01:06:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25984#issuecomment-366012",
    "user": "https://github.com/jhpalmieri"
}
```

Okay, here is a branch using `UniqueRepresentation`, but I'm confused by

> Moreover, all of the subclasses of StringMonoid_class have their own hand-rolled caches.


Can you clarify?



---

archive/issue_comments_366013.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-09-09T01:06:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25984#issuecomment-366013",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_366014.json:
```json
{
    "body": "Replying to [comment:7 jhpalmieri]:\n> Okay, here is a branch using `UniqueRepresentation`, but I'm confused by\n\n\nGreat, thank you. Small detail: the doc from `__classcall_private__` should almost entirely be moved into the class-level doc so it is visible under `FreeMonoid?` and in the html docs.\n\n> > Moreover, all of the subclasses of StringMonoid_class have their own hand-rolled caches.\n\n> \n> Can you clarify?\n\n\nSee the `_cache` module variable and `def BinaryStrings()` in `string_monoid.py`. So they are double-caching with your current changes.",
    "created_at": "2018-09-09T01:15:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25984#issuecomment-366014",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:7 jhpalmieri]:
> Okay, here is a branch using `UniqueRepresentation`, but I'm confused by


Great, thank you. Small detail: the doc from `__classcall_private__` should almost entirely be moved into the class-level doc so it is visible under `FreeMonoid?` and in the html docs.

> > Moreover, all of the subclasses of StringMonoid_class have their own hand-rolled caches.

> 
> Can you clarify?


See the `_cache` module variable and `def BinaryStrings()` in `string_monoid.py`. So they are double-caching with your current changes.



---

archive/issue_comments_366015.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-09-09T01:18:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25984#issuecomment-366015",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_366016.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-09-09T01:57:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25984#issuecomment-366016",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_366017.json:
```json
{
    "body": "Okay, how about this? (Independently, I realized the same thing about the docstrings, which is why I made that change almost immediately after your comment.) I also thought about just renaming `BinaryStringMonoid -> BinaryStrings`, but both are used in different parts of the Sage library, so I left it as is.",
    "created_at": "2018-09-09T02:02:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25984#issuecomment-366017",
    "user": "https://github.com/jhpalmieri"
}
```

Okay, how about this? (Independently, I realized the same thing about the docstrings, which is why I made that change almost immediately after your comment.) I also thought about just renaming `BinaryStringMonoid -> BinaryStrings`, but both are used in different parts of the Sage library, so I left it as is.



---

archive/issue_comments_366018.json:
```json
{
    "body": "The docstrings still will not show in the `?` and html doc if they are in the `__init__` because there is already a class-level doc. I would rather have it in the class-level doc so we can use the `__init__` to discuss implementation details. You also should be able to just call the `index_set` as `n` in the `__init__`.\n\nI am okay with leaving the alias for now, but it should really be uniformized at some point. Yet, I've already asked quite a lot from you on this ticket.",
    "created_at": "2018-09-09T09:19:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25984#issuecomment-366018",
    "user": "https://github.com/tscrim"
}
```

The docstrings still will not show in the `?` and html doc if they are in the `__init__` because there is already a class-level doc. I would rather have it in the class-level doc so we can use the `__init__` to discuss implementation details. You also should be able to just call the `index_set` as `n` in the `__init__`.

I am okay with leaving the alias for now, but it should really be uniformized at some point. Yet, I've already asked quite a lot from you on this ticket.



---

archive/issue_comments_366019.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-09-09T20:22:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25984#issuecomment-366019",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_366020.json:
```json
{
    "body": "Okay, how about this?",
    "created_at": "2018-09-09T20:23:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25984#issuecomment-366020",
    "user": "https://github.com/jhpalmieri"
}
```

Okay, how about this?



---

archive/issue_comments_366021.json:
```json
{
    "body": "Yep. LGTM. Thank you.",
    "created_at": "2018-09-09T22:44:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25984#issuecomment-366021",
    "user": "https://github.com/tscrim"
}
```

Yep. LGTM. Thank you.



---

archive/issue_comments_366022.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-09-09T22:44:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25984#issuecomment-366022",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_065286.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-09-11T21:40:54Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/25984",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25984#event-65286"
}
```



---

archive/issue_comments_366023.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-09-11T21:40:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25984#issuecomment-366023",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
