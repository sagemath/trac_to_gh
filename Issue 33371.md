# Issue 33371: (gitpod): Building documentation is broken

Issue created by migration from https://trac.sagemath.org/ticket/33608

Original creator: @tobiasdiez

Original creation time: 2022-03-30 20:12:45

CC:  klee strogdon â€‹schilly mkoeppe

Building the documentation on gitpod is currently broken and fails with the following error messages:

$ ./sage --docbuild tutorial html

```
/home/gitpod/sage-local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage_docbuild/__init__.py:193: DeprecationWarning: sage_makedirs is deprecated; use os.makedirs(..., exist_ok=True) instead
See https://trac.sagemath.org/32987 for details.
  sage_makedirs(d)
/home/gitpod/sage-local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage_docbuild/__init__.py:210: DeprecationWarning: sage_makedirs is deprecated; use os.makedirs(..., exist_ok=True) instead
See https://trac.sagemath.org/32987 for details.
  sage_makedirs(d)
[tutorial ] building [html]: targets for 23 source files that are out of date
[tutorial ] updating environment: [new config] 23 added, 0 changed, 0 removed
[tutorial ] Merging environment/index files...
[tutorial ] ... done (0 todos, 23 index, 17 citations, 0 modules)
[tutorial ] /home/gitpod/sage-local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage_docbuild/ext/multidocs.py:234: DeprecationWarning: sage_makedirs is deprecated; use os.makedirs(..., exist_ok=True) instead
[tutorial ] See https://trac.sagemath.org/32987 for details.
[tutorial ]   sage_makedirs(citedir)
[tutorial ] /workspace/sagetrac-mirror/src/doc/en/tutorial/tour_numtheory.rst:129: WARNING: undefined label: sage.rings.padics.tutorial
[tutorial ] Merging js index files...
[tutorial ] ... done (2488 js index entries)
[tutorial ] dumping search index in English (code: en)... done
[tutorial ] The HTML pages are in ../../home/gitpod/sage-local/share/doc/sage/html/en/tutorial.
Error building the documentation.
Traceback (most recent call last):
  File "/usr/lib/python3.8/runpy.py", line 194, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/usr/lib/python3.8/runpy.py", line 87, in _run_code
    exec(code, run_globals)
  File "/home/gitpod/sage-local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage_docbuild/__main__.py", line 2, in <module>
    main()
  File "/home/gitpod/sage-local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage_docbuild/__init__.py", line 1732, in main
    builder()
  File "/home/gitpod/sage-local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage_docbuild/__init__.py", line 137, in f
    runsphinx()
  File "/home/gitpod/sage-local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage_docbuild/sphinxbuild.py", line 323, in runsphinx
    sys.stderr.raise_errors()
  File "/home/gitpod/sage-local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage_docbuild/sphinxbuild.py", line 258, in raise_errors
    raise OSError(self._error)
OSError: /workspace/sagetrac-mirror/src/doc/en/tutorial/tour_numtheory.rst:129: WARNING: undefined label: sage.rings.padics.tutorial
```


$ ./sage --docbuild reference html

```
/home/gitpod/sage-local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage_docbuild/__init__.py:210: DeprecationWarning: sage_makedirs is deprecated; use os.makedirs(..., exist_ok=True) instead
See https://trac.sagemath.org/32987 for details.
  sage_makedirs(d)
/home/gitpod/sage-local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage_docbuild/__init__.py:193: DeprecationWarning: sage_makedirs is deprecated; use os.makedirs(..., exist_ok=True) instead
See https://trac.sagemath.org/32987 for details.
  sage_makedirs(d)
[reference] building [html]: targets for 1 source files that are out of date
[reference] updating environment: [new config] 1 added, 0 changed, 0 removed
[reference] /home/gitpod/sage-local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage_docbuild/ext/multidocs.py:234: DeprecationWarning: sage_makedirs is deprecated; use os.makedirs(..., exist_ok=True) instead
[reference] See https://trac.sagemath.org/32987 for details.
[reference]   sage_makedirs(citedir)
[reference] loading cross citations... looking for now-outdated files... none found
[reference] dumping search index in English (code: en)... done
[reference] The HTML pages are in ../../home/gitpod/sage-local/share/doc/sage/html/en/reference/references.
[reference] Extension error (matplotlib.sphinxext.plot_directive):
[reference] Handler <function _copy_css_file at 0x7f703839a160> for event 'build-finished' threw an exception (exception: [Errno 17] File exists: '/home/gitpod/sage-local/share/doc/sage/html/en/reference/references/_static')
Build finished. The built documents can be found in /home/gitpod/sage-local/share/doc/sage/html/en/reference/references
/home/gitpod/sage-local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage_docbuild/__init__.py:210: DeprecationWarning: sage_makedirs is deprecated; use os.makedirs(..., exist_ok=True) instead
See https://trac.sagemath.org/32987 for details.
  sage_makedirs(d)
/home/gitpod/sage-local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage_docbuild/__init__.py:193: DeprecationWarning: sage_makedirs is deprecated; use os.makedirs(..., exist_ok=True) instead
See https://trac.sagemath.org/32987 for details.
  sage_makedirs(d)
[spkg     ] WARNING: failed to reach any of the inventories with the following issues:
[spkg     ] intersphinx inventory '/home/gitpod/sage-local/share/doc/sage/inventory/en/reference/objects.inv' not fetchable due to <class 'FileNotFoundError'>: [Errno 2] No such file or directory: '/home/gitpod/sage-local/share/doc/sage/inventory/en/reference/objects.inv'
[spkg     ] WARNING: failed to reach any of the inventories with the following issues:
[spkg     ] intersphinx inventory '/home/gitpod/sage-local/share/doc/sage/inventory/en/reference/references/objects.inv' not fetchable due to <class 'FileNotFoundError'>: [Errno 2] No such file or directory: '/home/gitpod/sage-local/share/doc/sage/inventory/en/reference/references/objects.inv'
[spkg     ] building [html]: targets for 359 source files that are out of date
[spkg     ] updating environment: [new config] 359 added, 0 changed, 0 removed
[spkg     ] /home/gitpod/sage-local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage_docbuild/ext/multidocs.py:234: DeprecationWarning: sage_makedirs is deprecated; use os.makedirs(..., exist_ok=True) instead
[spkg     ] See https://trac.sagemath.org/32987 for details.
[spkg     ]   sage_makedirs(citedir)
[spkg     ] loading cross citations... looking for now-outdated files... none found
[spkg     ] dumping search index in English (code: en)... done
[spkg     ] The HTML pages are in ../../home/gitpod/sage-local/share/doc/sage/html/en/reference/spkg.
[spkg     ] Extension error (matplotlib.sphinxext.plot_directive):
[spkg     ] Handler <function _copy_css_file at 0x7f703841c280> for event 'build-finished' threw an exception (exception: [Errno 17] File exists: '/home/gitpod/sage-local/share/doc/sage/html/en/reference/spkg/_static')
Error building the documentation.
Traceback (most recent call last):
  File "/usr/lib/python3.8/runpy.py", line 194, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/usr/lib/python3.8/runpy.py", line 87, in _run_code
    exec(code, run_globals)
  File "/home/gitpod/sage-local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage_docbuild/__main__.py", line 2, in <module>
    main()
  File "/home/gitpod/sage-local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage_docbuild/__init__.py", line 1732, in main
    builder()
  File "/home/gitpod/sage-local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage_docbuild/__init__.py", line 537, in _wrapper
    self._build_everything_except_bibliography(format, *args, **kwds)
  File "/home/gitpod/sage-local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage_docbuild/__init__.py", line 521, in _build_everything_except_bibliography
    build_many(build_ref_doc, non_references)
  File "/home/gitpod/sage-local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage_docbuild/__init__.py", line 299, in build_many
    _build_many(target, args, processes=processes)
  File "/home/gitpod/sage-local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage_docbuild/utils.py", line 289, in build_many
    raise worker_exc.original_exception
OSError: WARNING: failed to reach any of the inventories with the following issues:

    Note: incremental documentation builds sometimes cause spurious
    error messages. To be certain that these are real errors, run
    "make doc-clean doc-uninstall" first and try again.
```


(not sure if these issues are specific to gitpod)

To reproduce:
- Go to https://gitpod.io/#https://github.com/sagemath/sagetrac-mirror/tree/develop (or if that works https://gitpod.io#snapshot/d3ce0749-4d92-44ff-bb06-04626d4e3b2c, in which case you don't need to wait for the build)
- Wait until the build of sagelib completes (takes about 30mins)
- Run above commands


---

Comment by klee created at 2022-03-31 00:10:48

This is not specific to gitpod. I am experiencing it too. It seem to have been introduced in beta6. 

I guess that the following happens. plot_directive extension writes its own css files into _static directory for each sphinx project. In our case, _static is a symlink to ../static directory, which is shared with all projects. Hence when plot_directive attempts to write again, _static (or ../static) directory already has the files, which triggers "File exists" error.

What I don't understand why this mechanism was no problem before, but now it is...


---

Comment by strogdon created at 2022-03-31 00:57:27

Are

```
$ ./sage --docbuild tutorial html
```

and

```
$ ./sage --docbuild reference html
```

supposed to fail after a normal `sagelib-9.6.beta6` build without doing anything else? If so, I don't see this here. Everything works.


---

Comment by strogdon created at 2022-03-31 01:05:36

I must add that I have the `html` docs installed. Does one have to do a `make doc-clean doc-uninstall` first?


---

Comment by klee created at 2022-03-31 02:19:53

Replying to [comment:3 strogdon]:
> I must add that I have the `html` docs installed. Does one have to do a `make doc-clean doc-uninstall` first?

Yes. This is also strange...


---

Comment by klee created at 2022-03-31 05:38:03

In beta6, python3 was upgraded:

```
26574b0f82 Trac #33512: Update python3 to 3.10.3
```

If you build sage with python 3.10.3, there are no more those errors. So this might be some incompatibility in python system library and packages...


---

Comment by klee created at 2022-03-31 07:10:15

Replying to [comment:5 klee]:
> In beta6, python3 was upgraded:
> {{{
> 26574b0f82 Trac #33512: Update python3 to 3.10.3
> }}}
> If you build sage with python 3.10.3, there are no more those errors. So this might be some incompatibility in python system library and packages... 

This may be wrong. In another build, I see those errors back even with python 3.10.3. I am utterly confused.


---

Comment by klee created at 2022-03-31 14:15:50

Symlinks pointing to a non-existing directory broke documentation building. These symlinks were no problem before. But some obscure changes in Sage 9.6.beta6 (possibly merge of python 3.10.3) now makes them problematic.


---

Comment by git created at 2022-03-31 14:16:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-03-31 14:16:52

New commits:


---

Comment by klee created at 2022-03-31 14:16:52

Changing priority from major to critical.


---

Comment by klee created at 2022-03-31 14:17:07

Changing status from new to needs_review.


---

Comment by strogdon created at 2022-03-31 15:54:49

I don't want to get off topic, but since we're talking about symlinks, without this branch a fresh build of the `html` docs gives errors like

```
[reference] Handler <function _copy_css_file at 0x7f6177a57880> for event 'build-finished' threw an exception (exception: [Errno 17] File exists: '/local/sage-git/sage/local/share/doc/sage/html/en/reference/references/_static')
```

There are 156 of these errors and the referenced `_static` files are symlinks to an actual `_static` folder, i.e.

```
/local/sage-git/sage/local/share/doc/sage/html/en/reference/references/_static -> ../_static
```



---

Comment by @tobiasdiez created at 2022-03-31 16:10:08

With this branch (on gitpod), I now get somewhat similar errors as reported by `@`strogdon (but for the inventories and not static files):

```
[tensor_fr] WARNING: failed to reach any of the inventories with the following issues:
[tensor_fr] intersphinx inventory '/home/gitpod/sage-local/share/doc/sage/inventory/en/reference/objects.inv' not fetchable due to <class 'FileNotFoundError'>: [Errno 2] No such file or directory: '/home/gitpod/sage-local/share/doc/sage/inventory/en/reference/objects.inv'
[tensor_fr] WARNING: failed to reach any of the inventories with the following issues:
[tensor_fr] intersphinx inventory '/home/gitpod/sage-local/share/doc/sage/inventory/en/reference/references/objects.inv' not fetchable due to <class 'FileNotFoundError'>: [Errno 2] No such file or directory: '/home/gitpod/sage-local/share/doc/sage/inventory/en/reference/references/objects.inv'
```


Also the issue for building the tutorial still persist.


---

Comment by strogdon created at 2022-03-31 17:30:26

Changing status from needs_review to needs_work.


---

Comment by strogdon created at 2022-03-31 17:30:26

With this branch after

```
make doc-clean doc-uninstall
```

both

```
./sage --docbuild tutorial html
```

and

```
./sage --docbuild reference html
```

fail as in the Description. Is `--docbuild` supposed to work out of the box in this way without doing something else?


---

Comment by strogdon created at 2022-03-31 18:42:56

Not related to this issue but I'm unable to start a new `SageMath` jupyter notebook. Before opening a new issue I wanted to make sure others are seeing this.

```
./sage -n jupyter
```

select `New -> [SageMath](SageMath) 9.6.beta6` and nothing happens. In the terminal

```
[I 12:39:27.730 NotebookApp] Creating new notebook in
```

with nothing else.


---

Comment by klee created at 2022-04-01 00:26:44

Replying to [comment:15 strogdon]:
> With this branch after
> {{{
> make doc-clean doc-uninstall
> }}}
> both
> {{{
> ./sage --docbuild tutorial html
> }}}
> and
> {{{
> ./sage --docbuild reference html
> }}}
> fail as in the Description. Is `--docbuild` supposed to work out of the box in this way without doing something else? 

No. You must successfully build the docoumentation from scratch first, which means

```
make doc-clean; make doc-uninstall; make
```



---

Comment by klee created at 2022-04-01 00:27:59

Changing status from needs_work to needs_review.


---

Comment by klee created at 2022-04-01 00:29:40

Replying to [comment:14 gh-tobiasdiez]:
> With this branch (on gitpod), I now get somewhat similar errors as reported by `@`strogdon (but for the inventories and not static files):
> {{{
> [tensor_fr] WARNING: failed to reach any of the inventories with the following issues:
> [tensor_fr] intersphinx inventory '/home/gitpod/sage-local/share/doc/sage/inventory/en/reference/objects.inv' not fetchable due to <class 'FileNotFoundError'>: [Errno 2] No such file or directory: '/home/gitpod/sage-local/share/doc/sage/inventory/en/reference/objects.inv'
> [tensor_fr] WARNING: failed to reach any of the inventories with the following issues:
> [tensor_fr] intersphinx inventory '/home/gitpod/sage-local/share/doc/sage/inventory/en/reference/references/objects.inv' not fetchable due to <class 'FileNotFoundError'>: [Errno 2] No such file or directory: '/home/gitpod/sage-local/share/doc/sage/inventory/en/reference/references/objects.inv'
> }}}
> 
> Also the issue for building the tutorial still persist.

Is this a documentation building from scratch?


---

Comment by strogdon created at 2022-04-01 03:29:32

Replying to [comment:17 klee]:
> Replying to [comment:15 strogdon]:
> > With this branch after
> > {{{
> > make doc-clean doc-uninstall
> > }}}
> > both
> > {{{
> > ./sage --docbuild tutorial html
> > }}}
> > and
> > {{{
> > ./sage --docbuild reference html
> > }}}
> > fail as in the Description. Is `--docbuild` supposed to work out of the box in this way without doing something else? 
> 
> No. You must successfully build the docoumentation from scratch first, which means
> {{{
> make doc-clean; make doc-uninstall; make
> }}} 
> 
>  
OK, then I do not have this issue. From the `develop` branch w/o this ticket and after successfully building the documentation:

```
$ ./sage --docbuild tutorial html
[tutorial ] Merging environment/index files...
[tutorial ] ... done (0 todos, 23 index, 17 citations, 0 modules)
[tutorial ] no targets are out of date.
[tutorial ] The HTML pages are in local/share/doc/sage/html/en/tutorial.
Build finished. The built documents can be found in /local/sage-git/sage/local/share/doc/sage/html/en/tutorial
```

and

```
$ ./sage --docbuild reference html
[reference] no targets are out of date.
[reference] The HTML pages are in local/share/doc/sage/html/en/reference/references.
Build finished. The built documents can be found in /local/sage-git/sage/local/share/doc/sage/html/en/reference/references
[spkg     ] no targets are out of date.
[spkg     ] The HTML pages are in local/share/doc/sage/html/en/reference/spkg.
Build finished. The built documents can be found in /local/sage-git/sage/local/share/doc/sage/html/en/reference/spkg

...

[reference] no targets are out of date.
[reference] The HTML pages are in local/share/doc/sage/html/en/reference.
Build finished. The built documents can be found in /local/sage-git/sage/local/share/doc/sage/html/en/reference
```


I only see the `issue` if the documentation is not built first.


---

Comment by @tobiasdiez created at 2022-04-01 15:39:30

I should have tested it with

```
make doc-clean; make doc-uninstall; make
```

in the first place, since the first issue I mentioned earlier is fixed by it.

Running this command on `develop` leads to the issues with `_static`, and with this branch these issues are fixed. Thus, lets get this in.


---

Comment by @tobiasdiez created at 2022-04-01 15:39:30

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2022-04-01 19:07:12

If the documentation has not been built, then (for example) `./sage --docbuild tutorial html` fails. I think this used to work, but I'm not sure and if it did, I don't know how long ago. Is there a ticket for this issue?


---

Comment by klee created at 2022-04-02 01:51:30

Replying to [comment:22 jhpalmieri]:
> If the documentation has not been built, then (for example) `./sage --docbuild tutorial html` fails. I think this used to work, but I'm not sure and if it did, I don't know how long ago. Is there a ticket for this issue?

Perhaps no. It could have worked before. But when I try that now, it fails because the reference manual is not yet built. Hence I am not sure whether building an individual document from source without building the whole documentation is something we do efforts to support.


---

Comment by vbraun created at 2022-04-03 11:14:00

Resolution: fixed


---

Comment by @collares created at 2022-09-05 16:19:27

Replying to [comment:13 Steven Trogdon]:
> I don't want to get off topic, but since we're talking about symlinks, without this branch a fresh build of the `html` docs gives errors like
> {{{
> [reference] Handler <function _copy_css_file at 0x7f6177a57880> for event 'build-finished' threw an exception (exception: [Errno 17] File exists: '/local/sage-git/sage/local/share/doc/sage/html/en/reference/references/_static')
> }}}
> There are 156 of these errors and the referenced `_static` files are symlinks to an actual `_static` folder, i.e.
> {{{
> /local/sage-git/sage/local/share/doc/sage/html/en/reference/references/_static -> ../_static
> }}}

This may be fixed by https://github.com/matplotlib/matplotlib/pull/23805
