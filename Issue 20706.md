# Issue 20706: Update a missing important speed improvement for subword complexes

Issue created by migration from https://trac.sagemath.org/ticket/20943

Original creator: stumpc5

Original creation time: 2016-07-05 18:33:21

CC:  tscrim chapoton nthiery

Keywords: reflection group, coxeter group, subword complex, days80

The method ``_flip_c`` currently uses

```
nr_ref = len(W.long_element(as_word=True))
```

which drastically slows down computations (here: the construction of cluster complexes using subword complexes through the greedy flip algorithm).


---

Comment by stumpc5 created at 2016-07-05 18:35:13

I will provide code in a minute; any suggestions how to properly do get the number of reflections in the fastest way for `WeylGroups` or `CoxeterGroups`? Currently, it uses the definition of the degrees, but that is too slow given that it should and can be fast.


---

Comment by stumpc5 created at 2016-07-05 18:44:34

For Weyl groups, I get

```
sage: W = WeylGroup(['E',7])
sage: %timeit len(W.long_element(as_word=True))
10 loops, best of 3: 98.6 ms per loop
sage: %timeit W.number_of_reflections()
1 loop, best of 3: 208 ms per loop
```

and for Coxeter groups, I get

```
sage: W = CoxeterGroup(['E',7])
sage: %timeit len(W.long_element(as_word=True))
1 loop, best of 3: 206 ms per loop
sage: %timeit W.number_of_reflections()
1 loop, best of 3: 378 ms per loop
```

so I leave the current implementation for those (though this is not as clean as it should be).


---

Comment by stumpc5 created at 2016-07-05 18:58:22


```
sage: W = ReflectionGroup(['A',6]); c = list(W.index_set())
sage: Q = c+W.w0.coxeter_sorting_word(c)
sage: %time S = SubwordComplex(Q,W.w0,algorithm="greedy")
```

with the fix, I get

```
CPU times: user 222 ms, sys: 16.1 ms, total: 238 ms
Wall time: 248 ms
```

and without the fix, I get

```
CPU times: user 1.35 s, sys: 37.7 ms, total: 1.39 s
Wall time: 1.4 s
```

For types E, it becomes obviously much worse.


---

Comment by stumpc5 created at 2016-07-05 19:16:35

I tried to push and to set the branch by hand, but I am not sure it actually worked...


---

Comment by stumpc5 created at 2016-07-05 19:17:39

Changing status from new to needs_review.


---

Comment by chapoton created at 2016-07-06 09:55:28

Sorry, but I do not understand the logic of your change.

What is this attribute `__number_of_reflections` ? Does it exist only in the complex reflection group implementation ?

One should also replace the default code for `number_of_reflections` by the faster

```
from sage.rings.all import ZZ
return ZZ.sum(self.degrees() - 1)
```

that avoid to use rank.
----
New commits:


---

Comment by chapoton created at 2016-07-06 10:05:43

the doctests are missing the `# optional`


---

Comment by stumpc5 created at 2016-07-06 12:01:39

Okay, I guess you are right. I should and will do it properly:

1. make the method `ReflectionGroup.number_of_reflections` use the attribute `ReflectionGroup._number_of_reflections` instead of recomputing it,

2. make this flip code use the method instead of the attribute for `ReflectionGroup` and also use this attribute for `WeylGroup` and `CoxeterGroup`, and finally

3. make `WeylGroup` and `CoxeterGroup` compute the number of reflections in the fastest possible way.


---

Comment by git created at 2016-07-06 12:10:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-07-06 12:14:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-07-06 12:20:13

ok. Looks much better.

Have you re-done the timings to compare the new "number_of_reflections"
with the previously used len of the longest word ?


---

Comment by git created at 2016-07-06 12:22:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by stumpc5 created at 2016-07-06 12:25:44

The timings should still be the old as the change

```
-            return ZZ.sum(self.degrees()) - self.rank()
+            return ZZ.sum(deg-1 for deg in self.degrees())
```

should not make any difference... (just checked, no change there). It would be better if we either do a speed improvement of the `degrees` method for `WeylGroup` and `CoxeterGroup`, or make `number_of_reflections` there use the length of the longest element there instead.


---

Comment by stumpc5 created at 2016-07-06 12:26:27

But I think that should go into a different ticket.


---

Comment by chapoton created at 2016-07-06 12:29:17

Replying to [comment:15 stumpc5]:
> But I think that should go into a different ticket.

ok, indeed.


---

Comment by chapoton created at 2016-07-06 12:31:41

An idea: why not make `number_of_reflection` a `cached_method` in all cases?


---

Comment by stumpc5 created at 2016-07-06 12:34:10

That is now #20956.


---

Comment by stumpc5 created at 2016-07-06 12:36:08

Replying to [comment:17 chapoton]:
> An idea: why not make `number_of_reflection` a `cached_method` in all cases?

Why not, we could also do that. Maybe that's even the "right" solution, as the caching doesn't take any memory while avoids recomputing a bigger computation again and again.


---

Comment by stumpc5 created at 2016-07-06 12:36:35

If you do not object, I would add this here to this ticket and make the other a duplicate.


---

Comment by git created at 2016-07-06 12:43:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-07-06 12:45:19

ok, then you can get rid of the attribute and the method in reflection_group_complex


---

Comment by stumpc5 created at 2016-07-06 12:57:54

Replying to [comment:22 chapoton]:
> ok, then you can get rid of the attribute and the method in reflection_group_complex

Out of curiosity: is it faster to use a cached method, or to use an attribute? Or is that difference never important?


---

Comment by chapoton created at 2016-07-06 13:01:30

I do not know, sorry. I guess both are fast enough for our purposes, but we can aim
for simplicity for the moment, maybe ?


---

Comment by git created at 2016-07-06 13:04:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-07-06 13:20:48

ok, let it be.


---

Comment by chapoton created at 2016-07-06 13:20:48

Changing status from needs_review to positive_review.


---

Comment by stumpc5 created at 2016-07-06 13:21:50

Replying to [comment:26 chapoton]:
> ok, let it be.

thanks!


---

Comment by tscrim created at 2016-07-06 21:09:34

Just FYI - calling a ``@`cached_method` is ~10% slower than a (Python) attribute lookup:

```python
sage: class Foo(object):
....:     def __init__(self, x):
....:         self.x = x
....:         self._y = x
....:     @cached_method
....:     def y(self):
....:         return self._y
....:     
sage: F = Foo(5)
sage: %timeit F.x
The slowest run took 73.41 times longer than the fastest. This could mean that an intermediate result is being cached.
10000000 loops, best of 3: 42.2 ns per loop
sage: %timeit F.y()
The slowest run took 2799.35 times longer than the fastest. This could mean that an intermediate result is being cached.
10000000 loops, best of 3: 57.1 ns per loop
```

However, it is better code (IMO) to use the cached method mechanism, and it makes it easier to change/override it.


---

Comment by vbraun created at 2016-07-08 07:09:49

Resolution: fixed
