# Issue 23047: Testing padic_base_leaves.py takes a VERY long time

Issue created by migration from https://trac.sagemath.org/ticket/23284

Original creator: jdemeyer

Original creation time: 2017-06-20 12:13:16

CC:  roed saraedum

On my laptop, doing the long doctests of `src/sage/rings/padics/padic_base_leaves.py` takes about 1300 seconds, which is a *huge* amount of time.

Some of these tests are quite old, so either this is a regression or something else is wrong...


---

Comment by chapoton created at 2017-06-20 14:14:41

For me, on a Dell Optiplex 9020.

```
lINE 242: Test ran for 65.62 s
LINE 243 : Test ran for 105.39 s
```

[191 tests, 304.13 s]

With many slow `TestSuite(R).run()`

**EDIT** forgot to say, on 8.0.b11


---

Comment by jdemeyer created at 2017-06-20 14:56:33

The main thing to check is whether this is a regression or not. I plan to test some older versions of Sage.


---

Comment by tscrim created at 2017-06-21 01:37:32

Could there be something in there which calls the optional spkg `normaliz`? It does not like to be run in parallel because of its own parallelization. I ran across this and have a post about it on [sage-devel](https://groups.google.com/forum/#!searchin/sage-devel/normaliz$20doctest%7Csort:relevance/sage-devel/8eTF_yP_maQ/yvl5s61NAAAJ).


---

Comment by roed created at 2017-06-24 01:20:06

I understand where some of these changes are coming from. I'll take a look next week (no internet over the weekend).


---

Comment by kcrisman created at 2017-06-25 03:16:14

Yikes, 343 seconds on my Mac laptop too (with nothing else going on).


---

Comment by jdemeyer created at 2017-06-26 15:07:42

I investigated the first regression and it is due to MPIR-3.0.0: #23327

I will change this ticket to be only about the second issue: the large absolute time taken by testing `padic_base_leaves.py`


---

Comment by git created at 2017-06-28 07:04:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2017-06-28 07:05:45

These changes drop the long tests from `256s` to `37s`.


---

Comment by roed created at 2017-06-28 07:05:45

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2017-06-28 13:18:24

How are the changes in `src/sage/misc/sage_unittest.py` related to this ticket? If they are not, please create a new ticket for that change.


---

Comment by jdemeyer created at 2017-06-28 13:27:16

Some more tests should be marked `# long time`, in particular on lines 244, 246, 336, 431.


---

Comment by jdemeyer created at 2017-06-28 13:27:21

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-06-28 13:31:41

Why do you need separate runs of `TestSuite` here?

```
sage: TestSuite(R).run()
sage: TestSuite(R).run(elements = [R.random_element() for i in range(2^10)], max_runs = 2^12, skip='_test_metric') # long time
sage: R._test_metric(elements = [R.random_element() for i in range(2^3)]) # long time
```


Why is `TestSuite(R).run()` not sufficient?

(This is just a question, there might be a good reason)


---

Comment by kcrisman created at 2017-06-28 15:27:16


```
Doctesting 1 file.
sage -t --long src/sage/rings/padics/padic_base_leaves.py
    [209 tests, 49.45 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 49.6 seconds
    cpu time: 44.5 seconds
    cumulative wall time: 49.5 seconds
```



---

Comment by git created at 2017-06-28 17:45:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2017-06-28 17:46:40

Replying to [comment:16 jdemeyer]:
> How are the changes in `src/sage/misc/sage_unittest.py` related to this ticket? If they are not, please create a new ticket for that change.

They got accidentally included. I've removed them.


---

Comment by roed created at 2017-06-28 17:47:46

Replying to [comment:19 jdemeyer]:
> Why do you need separate runs of `TestSuite` here?
> {{{
> sage: TestSuite(R).run()
> sage: TestSuite(R).run(elements = [R.random_element() for i in range(2^10)], max_runs = 2^12, skip='_test_metric') # long time
> sage: R._test_metric(elements = [R.random_element() for i in range(2^3)]) # long time
> }}}
> 
> Why is `TestSuite(R).run()` not sufficient?
> 
> (This is just a question, there might be a good reason)

Just want tests with random elements, not just the ones returned by `some_elements`, which may not reveal problems.


---

Comment by roed created at 2017-06-28 17:48:20

Changing status from needs_work to needs_review.


---

Comment by roed created at 2017-06-28 17:48:20

I've added a few `# long time` tags.


---

Comment by vbraun created at 2017-06-28 19:44:09

Changing priority from blocker to major.


---

Comment by jdemeyer created at 2017-06-28 20:38:57

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2017-06-28 20:38:57

Blocker or not, it would be good to merge this quickly.


---

Comment by roed created at 2017-06-28 22:30:29

Replying to [comment:16 jdemeyer]:
> How are the changes in `src/sage/misc/sage_unittest.py` related to this ticket? If they are not, please create a new ticket for that change.

This is now #23335.  I'd be interested in feedback on the interface there.


---

Comment by vbraun created at 2017-07-02 17:16:30

Resolution: fixed
