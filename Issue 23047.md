# Issue 23047: Testing padic_base_leaves.py takes a VERY long time

archive/issues_023047.json:
```json
{
    "body": "CC:  roed saraedum\n\nOn my laptop, doing the long doctests of `src/sage/rings/padics/padic_base_leaves.py` takes about 1300 seconds, which is a **huge** amount of time.\n\nSome of these tests are quite old, so either this is a regression or something else is wrong...\n\nIssue created by migration from https://trac.sagemath.org/ticket/23284\n\n",
    "created_at": "2017-06-20T12:13:16Z",
    "labels": [
        "padics",
        "blocker",
        "bug"
    ],
    "title": "Testing padic_base_leaves.py takes a VERY long time",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23047",
    "user": "jdemeyer"
}
```
CC:  roed saraedum

On my laptop, doing the long doctests of `src/sage/rings/padics/padic_base_leaves.py` takes about 1300 seconds, which is a **huge** amount of time.

Some of these tests are quite old, so either this is a regression or something else is wrong...

Issue created by migration from https://trac.sagemath.org/ticket/23284





---

archive/issue_comments_322303.json:
```json
{
    "body": "For me, on a Dell Optiplex 9020.\n\n```\nlINE 242: Test ran for 65.62 s\nLINE 243 : Test ran for 105.39 s\n```\n\n[191 tests, 304.13 s]\n\nWith many slow `TestSuite(R).run()`\n\n**EDIT** forgot to say, on 8.0.b11",
    "created_at": "2017-06-20T14:14:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23047#issuecomment-322303",
    "user": "chapoton"
}
```

For me, on a Dell Optiplex 9020.

```
lINE 242: Test ran for 65.62 s
LINE 243 : Test ran for 105.39 s
```

[191 tests, 304.13 s]

With many slow `TestSuite(R).run()`

**EDIT** forgot to say, on 8.0.b11



---

archive/issue_comments_322304.json:
```json
{
    "body": "The main thing to check is whether this is a regression or not. I plan to test some older versions of Sage.",
    "created_at": "2017-06-20T14:56:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23047#issuecomment-322304",
    "user": "jdemeyer"
}
```

The main thing to check is whether this is a regression or not. I plan to test some older versions of Sage.



---

archive/issue_comments_322305.json:
```json
{
    "body": "Could there be something in there which calls the optional spkg `normaliz`? It does not like to be run in parallel because of its own parallelization. I ran across this and have a post about it on [sage-devel](https://groups.google.com/forum/#!searchin/sage-devel/normaliz$20doctest%7Csort:relevance/sage-devel/8eTF_yP_maQ/yvl5s61NAAAJ).",
    "created_at": "2017-06-21T01:37:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23047#issuecomment-322305",
    "user": "tscrim"
}
```

Could there be something in there which calls the optional spkg `normaliz`? It does not like to be run in parallel because of its own parallelization. I ran across this and have a post about it on [sage-devel](https://groups.google.com/forum/#!searchin/sage-devel/normaliz$20doctest%7Csort:relevance/sage-devel/8eTF_yP_maQ/yvl5s61NAAAJ).



---

archive/issue_comments_322306.json:
```json
{
    "body": "I understand where some of these changes are coming from. I'll take a look next week (no internet over the weekend).",
    "created_at": "2017-06-24T01:20:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23047#issuecomment-322306",
    "user": "roed"
}
```

I understand where some of these changes are coming from. I'll take a look next week (no internet over the weekend).



---

archive/issue_comments_322307.json:
```json
{
    "body": "Yikes, 343 seconds on my Mac laptop too (with nothing else going on).",
    "created_at": "2017-06-25T03:16:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23047#issuecomment-322307",
    "user": "kcrisman"
}
```

Yikes, 343 seconds on my Mac laptop too (with nothing else going on).



---

archive/issue_comments_322308.json:
```json
{
    "body": "I investigated the first regression and it is due to MPIR-3.0.0: #23327\n\nI will change this ticket to be only about the second issue: the large absolute time taken by testing `padic_base_leaves.py`",
    "created_at": "2017-06-26T15:07:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23047#issuecomment-322308",
    "user": "jdemeyer"
}
```

I investigated the first regression and it is due to MPIR-3.0.0: #23327

I will change this ticket to be only about the second issue: the large absolute time taken by testing `padic_base_leaves.py`



---

archive/issue_comments_322309.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-06-28T07:04:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23047#issuecomment-322309",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_322310.json:
```json
{
    "body": "These changes drop the long tests from `256s` to `37s`.",
    "created_at": "2017-06-28T07:05:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23047#issuecomment-322310",
    "user": "roed"
}
```

These changes drop the long tests from `256s` to `37s`.



---

archive/issue_comments_322311.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-06-28T07:05:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23047#issuecomment-322311",
    "user": "roed"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_322312.json:
```json
{
    "body": "How are the changes in `src/sage/misc/sage_unittest.py` related to this ticket? If they are not, please create a new ticket for that change.",
    "created_at": "2017-06-28T13:18:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23047#issuecomment-322312",
    "user": "jdemeyer"
}
```

How are the changes in `src/sage/misc/sage_unittest.py` related to this ticket? If they are not, please create a new ticket for that change.



---

archive/issue_comments_322313.json:
```json
{
    "body": "Some more tests should be marked `# long time`, in particular on lines 244, 246, 336, 431.",
    "created_at": "2017-06-28T13:27:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23047#issuecomment-322313",
    "user": "jdemeyer"
}
```

Some more tests should be marked `# long time`, in particular on lines 244, 246, 336, 431.



---

archive/issue_comments_322314.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-06-28T13:27:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23047#issuecomment-322314",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_322315.json:
```json
{
    "body": "Why do you need separate runs of `TestSuite` here?\n\n```\nsage: TestSuite(R).run()\nsage: TestSuite(R).run(elements = [R.random_element() for i in range(2^10)], max_runs = 2^12, skip='_test_metric') # long time\nsage: R._test_metric(elements = [R.random_element() for i in range(2^3)]) # long time\n```\n\n\nWhy is `TestSuite(R).run()` not sufficient?\n\n(This is just a question, there might be a good reason)",
    "created_at": "2017-06-28T13:31:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23047#issuecomment-322315",
    "user": "jdemeyer"
}
```

Why do you need separate runs of `TestSuite` here?

```
sage: TestSuite(R).run()
sage: TestSuite(R).run(elements = [R.random_element() for i in range(2^10)], max_runs = 2^12, skip='_test_metric') # long time
sage: R._test_metric(elements = [R.random_element() for i in range(2^3)]) # long time
```


Why is `TestSuite(R).run()` not sufficient?

(This is just a question, there might be a good reason)



---

archive/issue_comments_322316.json:
```json
{
    "body": "\n```\nDoctesting 1 file.\nsage -t --long src/sage/rings/padics/padic_base_leaves.py\n    [209 tests, 49.45 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 49.6 seconds\n    cpu time: 44.5 seconds\n    cumulative wall time: 49.5 seconds\n```\n",
    "created_at": "2017-06-28T15:27:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23047#issuecomment-322316",
    "user": "kcrisman"
}
```


```
Doctesting 1 file.
sage -t --long src/sage/rings/padics/padic_base_leaves.py
    [209 tests, 49.45 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 49.6 seconds
    cpu time: 44.5 seconds
    cumulative wall time: 49.5 seconds
```




---

archive/issue_comments_322317.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-06-28T17:45:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23047#issuecomment-322317",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_322318.json:
```json
{
    "body": "Replying to [comment:16 jdemeyer]:\n> How are the changes in `src/sage/misc/sage_unittest.py` related to this ticket? If they are not, please create a new ticket for that change.\n\nThey got accidentally included. I've removed them.",
    "created_at": "2017-06-28T17:46:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23047#issuecomment-322318",
    "user": "roed"
}
```

Replying to [comment:16 jdemeyer]:
> How are the changes in `src/sage/misc/sage_unittest.py` related to this ticket? If they are not, please create a new ticket for that change.

They got accidentally included. I've removed them.



---

archive/issue_comments_322319.json:
```json
{
    "body": "Replying to [comment:19 jdemeyer]:\n> Why do you need separate runs of `TestSuite` here?\n> {{{\n> sage: TestSuite(R).run()\n> sage: TestSuite(R).run(elements = [R.random_element() for i in range(2^10)], max_runs = 2^12, skip='_test_metric') # long time\n> sage: R._test_metric(elements = [R.random_element() for i in range(2^3)]) # long time\n> }}}\n> \n> Why is `TestSuite(R).run()` not sufficient?\n> \n> (This is just a question, there might be a good reason)\n\nJust want tests with random elements, not just the ones returned by `some_elements`, which may not reveal problems.",
    "created_at": "2017-06-28T17:47:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23047#issuecomment-322319",
    "user": "roed"
}
```

Replying to [comment:19 jdemeyer]:
> Why do you need separate runs of `TestSuite` here?
> {{{
> sage: TestSuite(R).run()
> sage: TestSuite(R).run(elements = [R.random_element() for i in range(2^10)], max_runs = 2^12, skip='_test_metric') # long time
> sage: R._test_metric(elements = [R.random_element() for i in range(2^3)]) # long time
> }}}
> 
> Why is `TestSuite(R).run()` not sufficient?
> 
> (This is just a question, there might be a good reason)

Just want tests with random elements, not just the ones returned by `some_elements`, which may not reveal problems.



---

archive/issue_comments_322320.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-06-28T17:48:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23047#issuecomment-322320",
    "user": "roed"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_322321.json:
```json
{
    "body": "I've added a few `# long time` tags.",
    "created_at": "2017-06-28T17:48:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23047#issuecomment-322321",
    "user": "roed"
}
```

I've added a few `# long time` tags.



---

archive/issue_comments_322322.json:
```json
{
    "body": "Changing priority from blocker to major.",
    "created_at": "2017-06-28T19:44:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23047#issuecomment-322322",
    "user": "vbraun"
}
```

Changing priority from blocker to major.



---

archive/issue_comments_322323.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-06-28T20:38:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23047#issuecomment-322323",
    "user": "jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_322324.json:
```json
{
    "body": "Blocker or not, it would be good to merge this quickly.",
    "created_at": "2017-06-28T20:38:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23047#issuecomment-322324",
    "user": "jdemeyer"
}
```

Blocker or not, it would be good to merge this quickly.



---

archive/issue_comments_322325.json:
```json
{
    "body": "Replying to [comment:16 jdemeyer]:\n> How are the changes in `src/sage/misc/sage_unittest.py` related to this ticket? If they are not, please create a new ticket for that change.\n\nThis is now #23335.  I'd be interested in feedback on the interface there.",
    "created_at": "2017-06-28T22:30:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23047#issuecomment-322325",
    "user": "roed"
}
```

Replying to [comment:16 jdemeyer]:
> How are the changes in `src/sage/misc/sage_unittest.py` related to this ticket? If they are not, please create a new ticket for that change.

This is now #23335.  I'd be interested in feedback on the interface there.



---

archive/issue_comments_322326.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-07-02T17:16:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23047#issuecomment-322326",
    "user": "vbraun"
}
```

Resolution: fixed
