# Issue 29802: Implement weighted version of 2Dsweep and DiFUB

Issue created by migration from https://trac.sagemath.org/ticket/30039

Original creator: @vipul79321

Original creation time: 2020-07-01 12:59:19

CC:  dcoudert

Keywords: gsoc2020

This ticket aims to implement weighted version of `2Dsweep` and `DiFUB`


---

Comment by @vipul79321 created at 2020-07-01 13:00:29

Changing status from new to needs_review.


---

Comment by git created at 2020-07-01 13:01:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @vipul79321 created at 2020-07-01 13:09:18

Replying to [comment:2 git]:
> ||[2d53b3e](https://git.sagemath.org/sage.git/commit/?id=2d53b3edca6ef352aeaf12b4ff1221ac6b18f534)||` weighted 2Dsweep added`||

Hello David, 

I have added weighted version of `2Dsweep` and wrapper method for `diameter` computation similar to in `distances_all_pairs.pyx`. Its not final yet, I just wanted to keep you updated with how I have decided to organize it.

Kindly take a look at it. Any suggestions will be helpful.

I will hopefully complete the weighted version of `DiFUB` by tomorrow.

Vipul


---

Comment by dcoudert created at 2020-07-01 15:41:28

You don't compute distances from antipodes...


---

Comment by @vipul79321 created at 2020-07-01 17:22:10

Replying to [comment:4 dcoudert]:
> You don't compute distances from antipodes...
> 
> 
I didnt quite understand what you are saying, are you suggesting to stop 2Dsweep after 2nd step. But i would like to mention that we have followed the same steps in unweighted version of 2Dsweep. 

Sorry to bother you.. But can you please expalin you are saying.


---

Comment by dcoudert created at 2020-07-01 17:41:28

I missed these lines

```
+    source_1 = antipode_1
+    source_2 = antipode_2
```

so it's ok.


---

Comment by git created at 2020-07-02 13:42:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @vipul79321 created at 2020-07-02 13:43:40

Replying to [comment:7 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[867a0a8](https://git.sagemath.org/sage.git/commit/?id=867a0a8dd653dc70b0280ec1f8532a781ece1a95)||`weighted difub added and exposed in digraph.py`||

P.S. - I have made the changes in `eccentricity` method in `digraph.py` similar to `graph.py`


---

Comment by dcoudert created at 2020-07-02 15:36:37


```diff
-    Returns lower bound on the diamter of weighted digraph using the weighted
-    version of the algorithm proposed in [Broder2000]_.
+    Return a lower bound on the diameter of `G`.
+    
+    This method implements the weighted version of the algorithm proposed
+    in [Broder2000]_ to compute a lower bound of the weighted digraph `G`.
```


This should work and be slightly faster (ok, minor improvement)

```diff
-        order_1.push_back(pair[double, v_index](distances[v], v))
+        order_1.emplace_back(distances[v], v)
```



```diff
-            computed diameter. They also works with negative weight, if there is
+            computed diameter. They also work with negative weight, if there is
```


The documentation you added in `digraph.py` suggests that we don't have a basic method for weighted digraphs, but we do.

In the comparison of methods, you can compare DiFUB with any exact algorithm based on eccentricity.


---

Comment by git created at 2020-07-03 11:12:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @vipul79321 created at 2020-07-03 11:14:16

Replying to [comment:9 dcoudert]:
> 

> This should work and be slightly faster (ok, minor improvement)
> {{{#!diff
> -        order_1.push_back(pair[double, v_index](distances[v], v))
> +        order_1.emplace_back(distances[v], v)
> }}}
> 
This threw an error, so I kept the previous version.

> The documentation you added in `digraph.py` suggests that we don't have a basic method for weighted digraphs, but we do.
> 
I have made changes for that, but i am not sure are those changes sufficient?

> In the comparison of methods, you can compare DiFUB with any exact algorithm based on eccentricity.

Done.


---

Comment by dcoudert created at 2020-07-03 11:15:05

have also a look at the errors reported by the patchbot.


---

Comment by git created at 2020-07-05 17:09:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @vipul79321 created at 2020-07-05 17:09:28

Replying to [comment:12 dcoudert]:
> have also a look at the errors reported by the patchbot.
Done


---

Comment by dcoudert created at 2020-07-05 17:23:45

actually, one of these issue should be fixed in #29422, right ?


---

Comment by @vipul79321 created at 2020-07-05 17:28:17

Replying to [comment:15 dcoudert]:
> actually, one of these issue should be fixed in #29422, right ?
Yeah, i will do the same update there too.


---

Comment by dcoudert created at 2020-07-08 07:37:24

While running doctests on the graph module, I get the following error.

```
sage -t src/sage/graphs/base/boost_graph.pyx
**********************************************************************
File "src/sage/graphs/base/boost_graph.pyx", line 2121, in sage.graphs.base.boost_graph.?
Failed example:
    diameter(G, algorithm='DiFUB', weight_function=lambda e:e[2])
Expected:
    2.0
Got:
    Traceback (most recent call last):
      File "sage/graphs/base/boost_graph.pyx", line 1869, in sage.graphs.base.boost_graph.diameter_lower_bound_2Dsweep (build/cythonized/sage/graphs/base/boost_graph.cpp:20737)
    cysignals.signals.SignalError: Segmentation fault
    Exception ignored in: 'sage.graphs.base.boost_graph.diameter_DiFUB'
    Traceback (most recent call last):
      File "sage/graphs/base/boost_graph.pyx", line 1869, in sage.graphs.base.boost_graph.diameter_lower_bound_2Dsweep (build/cythonized/sage/graphs/base/boost_graph.cpp:20737)
    cysignals.signals.SignalError: Segmentation fault
    0.0
```


Also, you could add specific doctests for `2Dsweep` and `DiFUB`.


---

Comment by @vipul79321 created at 2020-07-08 07:57:44

Replying to [comment:17 dcoudert]:
> While running doctests on the graph module, I get the following error.
> {{{
> sage -t src/sage/graphs/base/boost_graph.pyx
> **********************************************************************
> File "src/sage/graphs/base/boost_graph.pyx", line 2121, in sage.graphs.base.boost_graph.?
> Failed example:
>     diameter(G, algorithm='DiFUB', weight_function=lambda e:e[2])
> Expected:
>     2.0
> Got:
>     Traceback (most recent call last):
>       File "sage/graphs/base/boost_graph.pyx", line 1869, in sage.graphs.base.boost_graph.diameter_lower_bound_2Dsweep (build/cythonized/sage/graphs/base/boost_graph.cpp:20737)
>     cysignals.signals.SignalError: Segmentation fault
>     Exception ignored in: 'sage.graphs.base.boost_graph.diameter_DiFUB'
>     Traceback (most recent call last):
>       File "sage/graphs/base/boost_graph.pyx", line 1869, in sage.graphs.base.boost_graph.diameter_lower_bound_2Dsweep (build/cythonized/sage/graphs/base/boost_graph.cpp:20737)
>     cysignals.signals.SignalError: Segmentation fault
>     0.0
> }}}
> 
That's weird, when ran doctest on my system it passed with no error. I have checked it again. Still no problem.


```
sage: from sage.graphs.base.boost_graph import diameter
sage: G = DiGraph([(0,1,2), (1,0,-1)])
sage: diameter(G, algorithm='DiFUB')
1.0
sage: diameter(G, algorithm='DiFUB', weight_function=lambda e:e[2])
2.0
```


----


```
vipul@vipul-Predator-G3-572:~/sage$ ./sage -t src/sage/graphs/base/boost_graph.pyx
Running doctests with ID 2020-07-08-13-24-51-0d1b09f6.
Git branch: weighted_difub
Using --optional=build,dochtml,memlimit,python_openid,sage,speaklater
Doctesting 1 file.
sage -t --warn-long 45.7 src/sage/graphs/base/boost_graph.pyx
    [135 tests, 0.37 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 0.4 seconds
    cpu time: 0.4 seconds
    cumulative wall time: 0.4 seconds
```



P.S - I am currently on latest beta release.


---

Comment by @vipul79321 created at 2020-07-08 07:59:49

Replying to [comment:17 dcoudert]:
> While running doctests on the graph module, I get the following error.
> {{{
> sage -t src/sage/graphs/base/boost_graph.pyx
> **********************************************************************
> File "src/sage/graphs/base/boost_graph.pyx", line 2121, in sage.graphs.base.boost_graph.?
> Failed example:
>     diameter(G, algorithm='DiFUB', weight_function=lambda e:e[2])
> Expected:
>     2.0
> Got:
>     Traceback (most recent call last):
>       File "sage/graphs/base/boost_graph.pyx", line 1869, in sage.graphs.base.boost_graph.diameter_lower_bound_2Dsweep (build/cythonized/sage/graphs/base/boost_graph.cpp:20737)
>     cysignals.signals.SignalError: Segmentation fault
>     Exception ignored in: 'sage.graphs.base.boost_graph.diameter_DiFUB'
> }}}

One more thing, I would like to ask is why the execption is being ignored. Why it is not raising exception in that method itself.

> Also, you could add specific doctests for `2Dsweep` and `DiFUB`.

Ok


---

Comment by dcoudert created at 2020-07-08 08:20:55

This is due to default value of `antipode_2` in `2Dsweep`. Indeed, to find the antipode, you initialize `LB_2 = 0`. But with this graph, the eccentricity of vertex 1 is -1. So `antipode_2` stays at the default value (depends on the system).

If I change the weights, I can get the error with `antipode_1`

```
sage: G = DiGraph([(0,1,-1), (1,0,2)])
sage: diameter(G, algorithm='2Dsweep', weight_function=lambda e:e[2])
---------------------------------------------------------------------------
SignalError                               Traceback (most recent call last)
<ipython-input-6-283ef9f979bc> in <module>()
----> 1 diameter(G, algorithm='2Dsweep', weight_function=lambda e:e[Integer(2)])

/Users/dcoudert/sage/local/lib/python3.7/site-packages/sage/graphs/base/boost_graph.pyx in sage.graphs.base.boost_graph.diameter (build/cythonized/sage/graphs/base/boost_graph.cpp:23444)()
   2077     return LB
   2078 
-> 2079 cpdef diameter(G, algorithm=None, source=None,
   2080                weight_function=None, check_weight=True):
   2081     r"""

/Users/dcoudert/sage/local/lib/python3.7/site-packages/sage/graphs/base/boost_graph.pyx in sage.graphs.base.boost_graph.diameter (build/cythonized/sage/graphs/base/boost_graph.cpp:23145)()
   2188 
   2189     if algorithm == '2Dsweep':
-> 2190         LB = diameter_lower_bound_2Dsweep(g_boost, rev_g_boost,
   2191                                             isource, algo)[0]
   2192 

/Users/dcoudert/sage/local/lib/python3.7/site-packages/sage/graphs/base/boost_graph.pyx in sage.graphs.base.boost_graph.diameter_lower_bound_2Dsweep (build/cythonized/sage/graphs/base/boost_graph.cpp:20568)()
   1847     # maximum backward distance. LB_1 will be Backward eccentricity of source_1.
   1848     if algorithm == 'Bellman-Ford':
-> 1849         sig_on()
   1850         result_1 = rev_g_boost.bellman_ford_shortest_paths(source_1)
   1851         sig_off()

SignalError: Segmentation fault
```



---

Comment by git created at 2020-07-09 05:43:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @vipul79321 created at 2020-07-09 05:46:10

Replying to [comment:21 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:

> ||[e9a4520](https://git.sagemath.org/sage.git/commit/?id=e9a452008ac35064258f7889851d72ac640eb083)||`Fixed segmentation fault in 2dsweep`||

I have added equality while looking for antipode. So that atleast one vertex will be made antipode and i think it will solve it.

Please check that it works (because i am unable to confirm it).

Vipul


---

Comment by git created at 2020-07-09 13:41:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2020-07-09 13:42:03

check that.


---

Comment by git created at 2020-07-10 05:32:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @vipul79321 created at 2020-07-10 05:35:05


```
sage: G = DiGraph([(0,1,-2), (1,0,1)])
sage: G.diameter(by_weight=True)
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
/home/vipul/sage/local/lib/python3.7/site-packages/sage/graphs/base/boost_graph.pyx in sage.graphs.base.boost_graph.diameter_lower_bound_2Dsweep (build/cythonized/sage/graphs/base/boost_graph.cpp:22068)()
   2012         sig_off()
   2013     if not result_1.distances.size():
-> 2014         raise ValueError("the graph contains a negative cycle")
   2015 
   2016     LB_1 = -sys.float_info.max

ValueError: the graph contains a negative cycle
Exception ignored in: 'sage.graphs.base.boost_graph.diameter_DiFUB'
Traceback (most recent call last):
  File "sage/graphs/base/boost_graph.pyx", line 2014, in sage.graphs.base.boost_graph.diameter_lower_bound_2Dsweep (build/cythonized/sage/graphs/base/boost_graph.cpp:22068)
ValueError: the graph contains a negative cycle
0.0

```


Is there anyway we can properly get an error and not printing 0.0 ?


---

Comment by dcoudert created at 2020-07-10 07:14:36

I don't understand why the 0.0 is printed. It should not be the case. I don't understand either why it is written that an exception is ignored in `DiFUB`. Which one ? the issue occurs in `2Dsweep`. Have you localized when is 0.0 returned ?


---

Comment by @vipul79321 created at 2020-07-10 16:37:10

Replying to [comment:27 dcoudert]:
>Have you localized when is 0.0 returned ?
It will occur only via `DiFUB` and this will occur only when there is an error raised in `2DSweep`.

I am also unable to understand it properly since it is receiving error, instead of terminating right then, it is ignoring it and sending garbage value stored in LB(on my system it is 0.0) without executing remaining part of code.

I am guessing if you run this example on your system you might encounter different value than 0.0(as it has previously happened in case of antipode).


---

Comment by git created at 2020-07-11 13:17:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2020-07-11 13:20:54

got it ! the error was not correctly transmitted to caller method. So the solution was:

```diff
-                           str algorithm):
+                           str algorithm) except? -1:
```

See https://cython.readthedocs.io/en/latest/src/userguide/language_basics.html#error-return-values for more details. 

On the way, I fixed some compilation warnings (got bored of them).


---

Comment by git created at 2020-07-12 10:46:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @vipul79321 created at 2020-07-12 10:48:49

Replying to [comment:30 dcoudert]:
> got it ! the error was not correctly transmitted to caller method. So the solution was:
> {{{#!diff
> -                           str algorithm):
> +                           str algorithm) except? -1:
> }}}
> See https://cython.readthedocs.io/en/latest/src/userguide/language_basics.html#error-return-values for more details. 
Ok.
> 
> On the way, I fixed some compilation warnings (got bored of them).
Well, that's some relief to eyes. 

I have added a doctest for `DiFUB` and I think there is nothing more to do.


---

Comment by dcoudert created at 2020-07-12 12:58:38

Changing status from needs_review to positive_review.


---

Comment by dcoudert created at 2020-07-12 12:58:38

LGTM. Successfully tested over 9.2.beta5.


---

Comment by dcoudert created at 2020-07-15 12:09:56

Changing status from positive_review to needs_work.


---

Comment by dcoudert created at 2020-07-15 12:09:56

a small edit is needed.


---

Comment by git created at 2020-07-15 12:11:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2020-07-15 12:13:20

Changing status from needs_work to positive_review.


---

Comment by dcoudert created at 2020-07-15 12:13:20

small modification to use `.edges` instead of `edge_iterator` (see #30145).


---

Comment by vbraun created at 2020-07-15 22:59:27

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2020-07-15 22:59:27

Merge conflict


---

Comment by git created at 2020-07-27 16:15:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @vipul79321 created at 2020-07-27 16:16:39

Replying to [comment:39 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[7bcd9db](https://git.sagemath.org/sage.git/commit/?id=7bcd9db9dd80f8902a6bc938b34486a6801ac7c0)||`merge conflict fixed`||

Solved merge conflict in `boost_graph.pyx`.


---

Comment by @vipul79321 created at 2020-07-27 16:16:39

Changing status from needs_work to needs_review.


---

Comment by dcoudert created at 2020-07-27 21:03:41

Changing status from needs_review to positive_review.


---

Comment by dcoudert created at 2020-07-27 21:03:41

LGTM.


---

Comment by vbraun created at 2020-08-02 08:20:46

Resolution: fixed
