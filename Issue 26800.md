# Issue 26800: neighbors of a nonexistent vertex

Issue created by migration from https://trac.sagemath.org/ticket/27037

Original creator: @jfraymond

Original creation time: 2019-01-10 11:00:02

CC:  bruno

Keywords: neighbor neighbor_iterator LookupError

The neighbor_iterator method does not give a correct error message when given a vertex that does not belong to the graph.
\\

sage: g = Graph()\\

sage: list(g.neighbor_iterator(123))\\

LookupError: vertex (-1) is not a vertex of the graph\\


The issue is that '-1' is not the name of the vertex that we tried to
delete.


---

Comment by @jfraymond created at 2019-01-11 16:57:32

It is fixed.
I could not use check_vertex (because it does not exist for the object we have at this point), so I used a condition on has_vertex.

Now we have

```
sage: g.neighbors(-41)
LookupError                               Traceback (most recent call last)
...
LookupError: vertex (-41) is not a vertex of the graph
```

(same for neighbor_iterator, and also for digraphs)
----
New commits:


---

Comment by @jfraymond created at 2019-01-11 16:58:58

Changing status from new to needs_review.


---

Comment by dcoudert created at 2019-01-12 13:25:57

Thank you for this patch. 
I agree with your proposal. We can unfortunately not avoid calling twice `get_vertex` (`has_vertex` calls `get_vertex`).

Could you create `TESTS::` blocks for the doctests you have added?


---

Comment by tscrim created at 2019-01-13 17:19:44

We need to run some timings on this change. I am generally -1 on changes that are essentially cosmetic that result in a speed drop, more so in backend functions. My guess is the `-1` comes from the exception being propagated up via Cython, but I have not looked into it. This might not have a real change in timings, but I think it is worthwhile to check.


---

Comment by @jfraymond created at 2019-01-14 11:30:22

Thanks for your answers.

`@`dcoudert: Ah, I did not see that `has_vertex` calls `get_vertex`. It is possible to avoid calling twice `get_vertex` by doing the same check as in `has_vertex`:

```python
def iterator_in_nbrs(self, v):
    cdef int v_int = self.get_vertex(v)
    if not (v_int != -1 and bitset_in((<CGraph>self._cg).active_vertices, v_int)):
        # condition copied directly from has_vertex
        raise LookupError("vertex ({0}) is not a vertex of the graph".format(v))

    # rest of the function as before
```

Is it OK to use this conditional rather that calling `has_vertex`? (On the one hand we avoid a call to `get_vertex` but on the other hand if `has_vertex` changes in the future, nobody will think of updating the conditional here.)\\
Yes, I will create `TESTS::` blocks.

`@`tscrim: I compared the timings for the following code, with two cases depending whether the vertex exists in the graph.

```python
def t1(h):
    for i in range(50):
        try:
            l = h.neighbors(i)
        except LookupError:
            pass
```


I get the following results.\\
'Old' version (before this patch):

```
sage: g = Graph()
sage: %timeit t1(g)
10000 loops, best of 3: 107 µs per loop
sage: g.add_vertices(range(50))
sage: %timeit t1(g)
10000 loops, best of 3: 49.5 µs per loop
```


This patch:

```
sage: g = Graph()
sage: %timeit t1(g)
10000 loops, best of 3: 95.3 µs per loop
sage: g.add_vertices(range(50))
sage: %timeit t1(g)
10000 loops, best of 3: 52.3 µs per loop
```


The version with only one call to `get_vertex` mentioned earlier in this message:

```
sage: g = Graph()
sage: %timeit t1(g)
10000 loops, best of 3: 92.1 µs per loop
sage: g.add_vertices(range(50))
sage: %timeit t1(g)
10000 loops, best of 3: 48.5 µs per loop
```



---

Comment by tscrim created at 2019-01-14 20:09:47

From your timings, we get ~7-8% slowdown with this ticket on a more practical test. I think generally people will be looking up neighbors of vertices in the graph. So I think the first part of that test is not as important as the second.

I think what you should do is check you mentioned above. One other option is to make the actual check an `cdef inline` function to avoid some code duplication. However, I suspect it is sufficient to simply check `v_int != -1`.


---

Comment by dcoudert created at 2019-01-15 12:41:59

It is not sufficient to check `v_int != -1`. Indeed, `get_vertex()` can return a value different from `-1` even if the requested vertex is not in the graph. See e.g., #22374#comment:12

An option could be to add a method that, given the internal value associated to a vertex (i.e., the value returned by `get_vertex()`), check if it corresponds to an active vertex of the graph.

Another option could be to expand method `get_vertex()` with a parameter like `check_active` (default to `False`) that would raise an error if the vertex is not active.

The first option should avoid to slowdown the code.


---

Comment by embray created at 2019-01-15 18:15:21

Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.


---

Comment by git created at 2019-01-22 16:25:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @jfraymond created at 2019-01-22 16:32:02

I used the check as in `has_vertex`, i.e. `v_int != -1 and bitset_in((<CGraph>self._cg).active_vertices, v_int)`.
This does not make the code slower, according to the timings above.


---

Comment by tscrim created at 2019-01-23 00:41:01

I am happy with it. David?


---

Comment by dcoudert created at 2019-01-23 08:42:39

I agree with these changes. I don't see yet a smarter way to do it.


---

Comment by dcoudert created at 2019-01-23 08:42:39

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-01-28 19:20:12

Resolution: fixed
