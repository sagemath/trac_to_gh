# Issue 11773: Throw exception instead of printing error in c_graph.pyx

Issue created by migration from Trac.

Original creator: kini

Original creation time: 2011-10-24 06:23:54

Assignee: jason, ncohen, rlm

CC:  rlm

Keywords: cython exception cpdef print c_graph

The following text currently occurs in `$SAGE_ROOT/devel/sage/sage/graphs/base/c_graph.pyx`:


```python
        # The following is due to a hard to reproduce bug in Cython where except,
        # cpdef, and classes don't play well together:
        print "Not Implemented!"
        # raise NotImplementedError() ... results in:
        # Exception exceptions.NotImplementedError: NotImplementedError() in 'sage.graphs.base.c_graph.CGraph.has_arc' ignored
        # False
```


These lines were written by Robert Miller in 2009. This ticket is just to keep track of this, since it should eventually be done properly once the Cython bug is gone.


---

Comment by kini created at 2011-10-24 06:53:59

CCing rlm as he is the most likely to know more about this.

By the way, the "exception ignored" message appears to be showing up on `stderr` rather than `stdout`.


---

Comment by jdemeyer created at 2011-11-03 16:14:43

Milestone sage-4.7.3 deleted


---

Comment by jdemeyer created at 2014-09-26 13:37:35

New commits:


---

Comment by jdemeyer created at 2014-09-26 13:37:35

Changing status from new to needs_review.


---

Comment by ncohen created at 2014-10-16 06:20:58

Changing status from needs_review to needs_work.


---

Comment by ncohen created at 2014-10-16 06:20:58

`O_o`

I had not noticed this patch. Could you rebase it ? There is a merge conflict.

Also it may be in conflict with a `needs_review` patch I just wrote (#17163), but nothing complicated in sight.

Nathann


---

Comment by ncohen created at 2014-10-16 06:24:49

`O_o`

Why would you do that ? `O_o`


```diff
-        raise ValueError("Thou shalt not add a vertex to an immutable graph")
+        self.add_vertex_unsafe(k)
```



---

Comment by jdemeyer created at 2014-10-16 06:38:40

Replying to [comment:10 ncohen]:
> Why would you do that ? `O_o`
> 
> {{{
> #!diff
> -        raise ValueError("Thou shalt not add a vertex to an immutable graph")
> +        self.add_vertex_unsafe(k)
> }}}
Throwing the same exception in 2 different places seemed a bit stupid. And it allows to actually test the `add_vertex_unsafe` method.


---

Comment by jdemeyer created at 2014-10-16 06:40:02

Replying to [comment:9 ncohen]:
> `O_o`
> 
> I had not noticed this patch.
If you're interested, there is a similar patch needing review at #16233.


---

Comment by ncohen created at 2014-10-16 06:42:09

> Throwing the same exception in 2 different places seemed a bit stupid. And it allows to actually test the `add_vertex_unsafe` method.

Come on, leave it as it is. What is the point ? Keep it simple: this thing is not implemented because the class is immutable, let it return an exception.

Nathann


---

Comment by jdemeyer created at 2014-10-16 06:48:58

Replying to [comment:13 ncohen]:
> Come on, leave it as it is. What is the point ?
Like I said: it allows to actually test the `add_vertex_unsafe` method, which is otherwise untested.

> Keep it simple: this thing is not implemented because the class is immutable, let it return an exception.
My code is equally simple and does exactly the same thing, so why not?


---

Comment by git created at 2014-10-16 09:06:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2014-10-16 09:08:19

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2014-10-16 09:13:30

How does "except -1" work when the return type is bint ?

Also, won't this cause that some calls which are currently C calls will become Python calls ?


```diff
 cdef class StaticSparseCGraph(CGraph):
     cdef short_digraph g
     cdef short_digraph g_rev
     cdef bint _directed
 
-    cpdef bint has_vertex(self, int n)
-    cdef int add_vertex_unsafe(self, int k)
-    cdef int del_vertex_unsafe(self, int v)
-    cpdef list verts(self)
-    cdef int has_arc_unsafe(self, int u, int v)
-    cpdef bint has_arc(self, int u, int v)
-    cdef int out_neighbors_unsafe(self, int u, int *neighbors, int size) except? -2
-    cpdef list out_neighbors(self, int u)
     cpdef int out_degree(self, int u) except -1
-    cdef int in_neighbors_unsafe(self, int u, int *neighbors, int size) except? -2
-    cpdef list in_neighbors(self, int u)
     cpdef int in_degree(self, int u) except -1
```


Nathann


---

Comment by jdemeyer created at 2014-10-16 09:20:56

Replying to [comment:17 ncohen]:
> How does "except -1" work when the return type is bint ?
The actual type is a C `int`. The return values mean the following:

* 0 => `False`
* 1 => `True`
* -1 => exception


---

Comment by jdemeyer created at 2014-10-16 09:21:43

Replying to [comment:17 ncohen]:
> How does "except -1" work when the return type is bint ?
> 
> Also, won't this cause that some calls which are currently C calls will become Python calls ?
No, there are already declared in the child class `CGraph`, no point to repeat them.


---

Comment by ncohen created at 2014-10-16 09:25:55

Okay, then as soon as I am done building the latest beta I will run all tests on your patch, should be done soon.

Nathann


---

Comment by ncohen created at 2014-10-16 11:14:58

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-10-16 21:10:17

Resolution: fixed
