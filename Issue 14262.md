# Issue 14262: issue with type in doctests

archive/issues_014262.json:
```json
{
    "body": "Assignee: @roed314\n\nCC:  simonking\n\nas mentioned on https://groups.google.com/forum/?hl=fr&fromgroups=#!topic/sage-devel/wuwWfhWnbCg, there is an issue with `type` in doctests. When using `type` in an interactive session we get for example:\n\n```\n----------------------------------------------------------------------\n----------------------------------------------------------------------\nsage: type(ZZ)\nsage.rings.integer_ring.IntegerRing_class\n```\n\nHowever, when we put that in a doctest, we get an error:\n\n```\ntarte% cat /tmp/a.py\ndef test():\n    \"\"\"\n    EXAMPLE::\n| Sage Version 5.8, Release Date: 2013-03-15                         |\n| Type \"notebook()\" for the browser-based notebook interface.        |\n| Type \"help()\" for help.                                            |\n        sage: type(ZZ)\n        sage.rings.integer_ring.IntegerRing_class\n    \"\"\"\n    pass\ntarte% /localdisk/tmp/sage-5.8/sage -t /tmp/a.py\nsage -t  \"/tmp/a.py\"                                        \n**********************************************************************\nFile \"/tmp/a.py\", line 5:\n    sage: type(ZZ)\nExpected:\n    sage.rings.integer_ring.IntegerRing_class\nGot:\n    <type 'sage.rings.integer_ring.IntegerRing_class'>\n**********************************************************************\n1 items had failures:\n   1 of   4 in __main__.example_0\n***Test Failed*** 1 failures.\nFor whitespace errors, see the file /users/caramel/zimmerma/.sage//tmp/a_11238.py\n         [2.1 s]\n \n----------------------------------------------------------------------\nThe following tests failed:\n\n\n        sage -t  \"/tmp/a.py\"\nTotal time for all tests: 2.2 seconds\n```\n\nA workaround is to put `print type(...)` in the doctest, but this prints the form `<type 'sage.rings.integer_ring.IntegerRing_class'>` which is not so nice...\n\nIssue created by migration from https://trac.sagemath.org/ticket/14466\n\n",
    "created_at": "2013-04-19T09:29:55Z",
    "labels": [
        "component: doctest framework",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.10",
    "title": "issue with type in doctests",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14262",
    "user": "https://github.com/zimmermann6"
}
```
Assignee: @roed314

CC:  simonking

as mentioned on https://groups.google.com/forum/?hl=fr&fromgroups=#!topic/sage-devel/wuwWfhWnbCg, there is an issue with `type` in doctests. When using `type` in an interactive session we get for example:

```
----------------------------------------------------------------------
----------------------------------------------------------------------
sage: type(ZZ)
sage.rings.integer_ring.IntegerRing_class
```

However, when we put that in a doctest, we get an error:

```
tarte% cat /tmp/a.py
def test():
    """
    EXAMPLE::
| Sage Version 5.8, Release Date: 2013-03-15                         |
| Type "notebook()" for the browser-based notebook interface.        |
| Type "help()" for help.                                            |
        sage: type(ZZ)
        sage.rings.integer_ring.IntegerRing_class
    """
    pass
tarte% /localdisk/tmp/sage-5.8/sage -t /tmp/a.py
sage -t  "/tmp/a.py"                                        
**********************************************************************
File "/tmp/a.py", line 5:
    sage: type(ZZ)
Expected:
    sage.rings.integer_ring.IntegerRing_class
Got:
    <type 'sage.rings.integer_ring.IntegerRing_class'>
**********************************************************************
1 items had failures:
   1 of   4 in __main__.example_0
***Test Failed*** 1 failures.
For whitespace errors, see the file /users/caramel/zimmerma/.sage//tmp/a_11238.py
         [2.1 s]
 
----------------------------------------------------------------------
The following tests failed:


        sage -t  "/tmp/a.py"
Total time for all tests: 2.2 seconds
```

A workaround is to put `print type(...)` in the doctest, but this prints the form `<type 'sage.rings.integer_ring.IntegerRing_class'>` which is not so nice...

Issue created by migration from https://trac.sagemath.org/ticket/14466





---

archive/issue_comments_179241.json:
```json
{
    "body": "There's a better workaround described in that thread: special case `type` in `sage.misc.displayhook.format_obj`.",
    "created_at": "2013-04-19T09:39:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14262#issuecomment-179241",
    "user": "https://github.com/roed314"
}
```

There's a better workaround described in that thread: special case `type` in `sage.misc.displayhook.format_obj`.



---

archive/issue_comments_179242.json:
```json
{
    "body": "David, yes, however this workaround describes how to get `<type ...>` in the interactive session.\n\nWe want the opposite: get `sage.rings.integer_ring.IntegerRing_class` in the doctest, like the user gets in her/his interactive session.\n\nPaul",
    "created_at": "2013-04-19T09:48:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14262#issuecomment-179242",
    "user": "https://github.com/zimmermann6"
}
```

David, yes, however this workaround describes how to get `<type ...>` in the interactive session.

We want the opposite: get `sage.rings.integer_ring.IntegerRing_class` in the doctest, like the user gets in her/his interactive session.

Paul



---

archive/issue_comments_179243.json:
```json
{
    "body": "I think that's a bad idea, since it means we have to change the result of a lot of doctests throughout Sage.  Why not change both to be backward compatible?",
    "created_at": "2013-04-19T09:51:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14262#issuecomment-179243",
    "user": "https://github.com/roed314"
}
```

I think that's a bad idea, since it means we have to change the result of a lot of doctests throughout Sage.  Why not change both to be backward compatible?



---

archive/issue_comments_179244.json:
```json
{
    "body": "David, maybe I should explain the context: in our book in french about Sage, we give examples of Sage code that are both printed in the book, and also used to generate doctests (to ensure those\nexamples will still run with future versions of Sage).\n\nThus we want that the result \"Got\" in doctests matches what we get in an interactive session.\nIf this means we should add a special instruction at the beginning of **our** doctests, it is fine for us. No need to change all Sage doctests.\n\nPaul",
    "created_at": "2013-04-19T09:58:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14262#issuecomment-179244",
    "user": "https://github.com/zimmermann6"
}
```

David, maybe I should explain the context: in our book in french about Sage, we give examples of Sage code that are both printed in the book, and also used to generate doctests (to ensure those
examples will still run with future versions of Sage).

Thus we want that the result "Got" in doctests matches what we get in an interactive session.
If this means we should add a special instruction at the beginning of **our** doctests, it is fine for us. No need to change all Sage doctests.

Paul



---

archive/issue_comments_179245.json:
```json
{
    "body": "Yeah, that sounds feasible.  You could have a switch in the first few lines of the file that changes it to interactive mode?  Another possibility would be to special case this comparison in the `check_output()` function.\n\nI'm going to sleep now and won't be online much in the next couple days.",
    "created_at": "2013-04-19T10:20:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14262#issuecomment-179245",
    "user": "https://github.com/roed314"
}
```

Yeah, that sounds feasible.  You could have a switch in the first few lines of the file that changes it to interactive mode?  Another possibility would be to special case this comparison in the `check_output()` function.

I'm going to sleep now and won't be online much in the next couple days.



---

archive/issue_comments_179246.json:
```json
{
    "body": "Replying to [comment:4 zimmerma]:\n> David, maybe I should explain the context: in our book in french about Sage, we give examples of Sage code that are both printed in the book, and also used to generate doctests (to ensure those\n> examples will still run with future versions of Sage).\n\nDo you mean that book has already been printed? I'd say you can just update the book (immediately for the online version; in the next edition for a printed version, if that exists) to work correctly.\n\nI think we've had a very small window where the new IPython has been printing different `type` representations.\n\nIt's pretty clear to me that we want to ensure that our doctests test the same output as produced by an interactive session (they are documentation as well as tests!).\n\nThe string `<type '...'>` is the straight `str` of a type. Changing the doctest framework to test against anything else in a robust way means that we'd have to change the doctest framework so that any return value gets passed through the same print hooks that IPython offers.\n\nThe alternative seems much easier: Change IPython to (mostly) just produce the straight `str` or `repr`. \n\n> Thus we want that the result \"Got\" in doctests matches what we get in an interactive session.\n\nWhich we can accomplish by ensuring that the interactive session does give the same result as it did a while ago. Are you particularly married to this new, modified interactive result we're getting due to the IPython upgrade?\n\n**EDIT:** In fact, in [the latest version 1.0.9](http://purple.lateralis.org/sagebook-r1014.pdf), your book on page 47 has\n\n```\nsage: o = 12/35\nsage: type(o)\n<type 'sage.rings.rational.Rational'>\n```\n\nso I think you *do* want to go back to the old printing. We can easily do so by catching `type` objects in `sage.misc.displayhook.format_obj`. That unifies our printing again.\n\nAn additional reason to do so is that printing a type in the notebook still gives the normal `<type '...'>` result as well. I think that really shows that we don't want the special `IPython` behaviour in sage (doctest and notebook outvote IPython in my opinion).",
    "created_at": "2013-04-19T19:42:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14262#issuecomment-179246",
    "user": "https://github.com/nbruin"
}
```

Replying to [comment:4 zimmerma]:
> David, maybe I should explain the context: in our book in french about Sage, we give examples of Sage code that are both printed in the book, and also used to generate doctests (to ensure those
> examples will still run with future versions of Sage).

Do you mean that book has already been printed? I'd say you can just update the book (immediately for the online version; in the next edition for a printed version, if that exists) to work correctly.

I think we've had a very small window where the new IPython has been printing different `type` representations.

It's pretty clear to me that we want to ensure that our doctests test the same output as produced by an interactive session (they are documentation as well as tests!).

The string `<type '...'>` is the straight `str` of a type. Changing the doctest framework to test against anything else in a robust way means that we'd have to change the doctest framework so that any return value gets passed through the same print hooks that IPython offers.

The alternative seems much easier: Change IPython to (mostly) just produce the straight `str` or `repr`. 

> Thus we want that the result "Got" in doctests matches what we get in an interactive session.

Which we can accomplish by ensuring that the interactive session does give the same result as it did a while ago. Are you particularly married to this new, modified interactive result we're getting due to the IPython upgrade?

**EDIT:** In fact, in [the latest version 1.0.9](http://purple.lateralis.org/sagebook-r1014.pdf), your book on page 47 has

```
sage: o = 12/35
sage: type(o)
<type 'sage.rings.rational.Rational'>
```

so I think you *do* want to go back to the old printing. We can easily do so by catching `type` objects in `sage.misc.displayhook.format_obj`. That unifies our printing again.

An additional reason to do so is that printing a type in the notebook still gives the normal `<type '...'>` result as well. I think that really shows that we don't want the special `IPython` behaviour in sage (doctest and notebook outvote IPython in my opinion).



---

archive/issue_comments_179247.json:
```json
{
    "body": "Initial patch",
    "created_at": "2013-04-20T18:53:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14262#issuecomment-179247",
    "user": "https://github.com/vbraun"
}
```

Initial patch



---

archive/issue_comments_179248.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-04-20T18:53:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14262#issuecomment-179248",
    "user": "https://github.com/vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_179249.json:
```json
{
    "body": "Attachment [trac_14466_fix_type_repr.patch](tarball://root/attachments/some-uuid/ticket14466/trac_14466_fix_type_repr.patch) by @vbraun created at 2013-04-20 18:53:52",
    "created_at": "2013-04-20T18:53:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14262#issuecomment-179249",
    "user": "https://github.com/vbraun"
}
```

Attachment [trac_14466_fix_type_repr.patch](tarball://root/attachments/some-uuid/ticket14466/trac_14466_fix_type_repr.patch) by @vbraun created at 2013-04-20 18:53:52



---

archive/issue_comments_179250.json:
```json
{
    "body": "Anybody wants to review this trivial patch?",
    "created_at": "2013-04-26T16:23:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14262#issuecomment-179250",
    "user": "https://github.com/vbraun"
}
```

Anybody wants to review this trivial patch?



---

archive/issue_comments_179251.json:
```json
{
    "body": "Attachment [trac_14466-nb.patch](tarball://root/attachments/some-uuid/ticket14466/trac_14466-nb.patch) by @nbruin created at 2013-04-26 19:25:45\n\ninclude doctest",
    "created_at": "2013-04-26T19:25:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14262#issuecomment-179251",
    "user": "https://github.com/nbruin"
}
```

Attachment [trac_14466-nb.patch](tarball://root/attachments/some-uuid/ticket14466/trac_14466-nb.patch) by @nbruin created at 2013-04-26 19:25:45

include doctest



---

archive/issue_comments_179252.json:
```json
{
    "body": "Turns out we can doctest this behaviour! See new patch. Also: if you compare `print str('a')` and `print repr('a')` you see that the latter is closer to what happens in the shell (not that it seems to matter for type objects)\n\nOtherwise: of course a trivial patch (once you've dug out where to make the trivial change ...)",
    "created_at": "2013-04-26T19:29:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14262#issuecomment-179252",
    "user": "https://github.com/nbruin"
}
```

Turns out we can doctest this behaviour! See new patch. Also: if you compare `print str('a')` and `print repr('a')` you see that the latter is closer to what happens in the shell (not that it seems to matter for type objects)

Otherwise: of course a trivial patch (once you've dug out where to make the trivial change ...)



---

archive/issue_comments_179253.json:
```json
{
    "body": "patchbot apply trac_14466-nb.patch\n\nso that we can see if this patch passes (Volker's does)",
    "created_at": "2013-04-26T19:30:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14262#issuecomment-179253",
    "user": "https://github.com/nbruin"
}
```

patchbot apply trac_14466-nb.patch

so that we can see if this patch passes (Volker's does)



---

archive/issue_comments_179254.json:
```json
{
    "body": "Looks good to me.",
    "created_at": "2013-04-27T08:35:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14262#issuecomment-179254",
    "user": "https://github.com/vbraun"
}
```

Looks good to me.



---

archive/issue_comments_179255.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-04-27T08:35:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14262#issuecomment-179255",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_179256.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-04-30T09:40:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14262#issuecomment-179256",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_179257.json:
```json
{
    "body": "Nils managed to generate this commit message in Sage's hg log:\n\n```\nchangeset:   18302:4c8dabfafa75\nuser:        Nils Bruin <nbruin@sfu.ca>\ndate:        Fri Apr 26 12:23:15 2013 -0700\nsummary:     Trac #14466: diff --git a/sage/misc/displayhook.py b/sage/misc/displayhook.py\n```\n",
    "created_at": "2013-05-02T12:27:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14262#issuecomment-179257",
    "user": "https://github.com/vbraun"
}
```

Nils managed to generate this commit message in Sage's hg log:

```
changeset:   18302:4c8dabfafa75
user:        Nils Bruin <nbruin@sfu.ca>
date:        Fri Apr 26 12:23:15 2013 -0700
summary:     Trac #14466: diff --git a/sage/misc/displayhook.py b/sage/misc/displayhook.py
```




---

archive/issue_comments_179258.json:
```json
{
    "body": "There is also\n\n```\nchangeset:   17832:42bc6caf1f2f\nuser:        Martin Raum <Martin.Raum@rwth-aachen.de>\ndate:        Tue Feb 19 10:32:37 2013 +0000\nsummary:     Trac #13531: diff --git a/sage/quadratic_forms/quadratic_form__automorphisms.py b/sage/quadratic_forms/quadratic_form__automorphisms.py\n```\n\n\nMerger script fixed such that this won't happen again, but rewriting history to fix the bad messages is probably a bad idea.",
    "created_at": "2013-05-02T13:12:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14262#issuecomment-179258",
    "user": "https://github.com/jdemeyer"
}
```

There is also

```
changeset:   17832:42bc6caf1f2f
user:        Martin Raum <Martin.Raum@rwth-aachen.de>
date:        Tue Feb 19 10:32:37 2013 +0000
summary:     Trac #13531: diff --git a/sage/quadratic_forms/quadratic_form__automorphisms.py b/sage/quadratic_forms/quadratic_form__automorphisms.py
```


Merger script fixed such that this won't happen again, but rewriting history to fix the bad messages is probably a bad idea.
