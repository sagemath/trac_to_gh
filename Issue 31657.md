# Issue 31657: Refine categories of Chart objects, add method codomain

Issue created by migration from https://trac.sagemath.org/ticket/31894

Original creator: mkoeppe

Original creation time: 2021-06-02 02:05:04

CC:  egourgoulhon tscrim @mjungmath


```
sage: M = Manifold(2, 'R^2', structure='topological')
sage: c_cart.<x,y> = M.chart() # Cartesian coordinates on R^2
sage: c_cart.category()
Category of objects
```

A `Chart` instance is a continuous map from its domain to `R^n`. This should be reflected in the category


---

Comment by mkoeppe created at 2021-06-03 21:55:08

Here is an attempt; but there is a metaclass conflict between `Map` and `UniqueRepresentation` that I don't know how to resolve
----
New commits:


---

Comment by git created at 2021-06-20 03:31:38

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-06-24 18:36:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-12 21:28:55

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2021-07-12 23:04:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-12 23:06:11

This is almost ready, except that a `Chart` does not have the correct element class of the Homset, so some `_test_category` tests are failing. Help with this would be very welcome.


---

Comment by tscrim created at 2021-07-12 23:11:11

We generally skip `_test_category` for `Homset` subclasses IIRC. They can often have multiple classes that are all elements because we need different implementations based on input types. We currently don't have a good system for dealing with parents with multiple element classes. `:/`


---

Comment by git created at 2021-07-13 01:01:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-13 01:06:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-13 01:07:00

Replying to [comment:17 tscrim]:
> We generally skip `_test_category` for `Homset` subclasses IIRC. They can often have multiple classes that are all elements because we need different implementations based on input types.

Thanks, that's a simple solution. Ready for review then


---

Comment by mkoeppe created at 2021-07-13 01:07:00

Changing status from new to needs_review.


---

Comment by git created at 2021-07-13 04:16:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-13 06:47:45

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-07-13 07:39:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mjungmath created at 2021-07-13 10:18:44

Why is a periodic chart considered non-surjective but injective? Isn't it exactly the opposite?

Besides, Travis suggested that periodic charts could be considered being proper charts but glued together [#31324`@`comment:25](https://trac.sagemath.org/ticket/31324#comment:25). Maybe we can somehow incorporate this here?


---

Comment by mkoeppe created at 2021-07-13 16:04:48

I have two possible variants:

- as of [acdb6a7](https://git.sagemath.org/sage.git/commit/?id=acdb6a72596070154f7a724ede91758c1fd11159), the codomain of the `Chart` is a fundamental cell of the periodic coordinate space. Presumably the user declares the periodic coordinates in a way that the computed coordinates always lie in the fundamental domain. Corestricted like this, the chart is bijective, with a bijective `ChartInverse` as its inverse. But it does not capture the fact that one is also allowed to use coordinates outside of the fundamental domain to construct a point.

- with [243fcfd](https://git.sagemath.org/sage.git/commit/?id=243fcfda7112c8372e2cbfab058aba5335b0aff5) + work in progress (not on the branch yet), the `ChartInverse` is a surjection from the full coordinate space to the chart's domain, and `Chart` is a section map of the `ChartInverse`.

I don't know which of the two you would find preferable and also cannot speak to Travis' suggestion regarding possible changes to the design.


---

Comment by git created at 2021-07-13 17:37:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-13 17:38:17

Here's a more complete version of the second variant.


---

Comment by mkoeppe created at 2021-07-13 17:38:26

Changing status from needs_work to needs_info.


---

Comment by @mjungmath created at 2021-07-13 20:18:23

I like the second variant. It better reflects the situation and what periodic charts actually are.

Then it also makes sense that periodic charts (as maps from a manifold subset into a subset of R^n) are injective but non-surjective.


---

Comment by @mjungmath created at 2021-07-13 20:21:37

But then we have to make a choice, right? The current situation is as follows (for example):


```
sage: S1 = manifolds.Sphere(1)
sage: spher = S1.spherical_coordinates()
sage: p = S1.point((pi,))
sage: q = S1.point((-pi,))
sage: spher(p)
(pi,)
sage: spher(q)
(-pi,)
```


At current stage, this is not a well-defined map.


---

Comment by mkoeppe created at 2021-07-13 20:47:05

That's right, there's currently no code to normalize the coordinates


---

Comment by mkoeppe created at 2021-07-13 20:49:08

It would all be easier if we had an implementation of `RR/ZZ` in Sage...


---

Comment by @mjungmath created at 2021-07-13 20:53:34

Replying to [comment:32 mkoeppe]:
> It would all be easier if we had an implementation of `RR/ZZ` in Sage...
...or even better topological quotient spaces.


---

Comment by mkoeppe created at 2021-07-13 21:23:59

OK, `QQ/ZZ` exists (`sage.groups.additive_abelian.qmodnz`), and we also have at least two incompatible implementations of lattices and their quotients in `sage.geometry.toric_lattice` and `sage.modules.free_module_integer`.  Perhaps also something in `sage.schemes` somewhere


---

Comment by @mjungmath created at 2021-07-14 12:52:22

What about abstract quotients in the spirit of #31644 and/or #31691?


---

Comment by mkoeppe created at 2021-07-14 16:06:00

Well, I have #32012 (Quotient of polyhedron or convex set by a lattice) but one has to be careful that things remain concrete enough to be useful, as the main point of the ticket is to make things more "composable".


---

Comment by @mjungmath created at 2021-07-15 17:24:58

Periodic charts are always defined via (connected) intervals, aren't they? W.l.o.g. we can always choose the minimum/maximum the chart maps to? Alternatively, we can make a chart a bijection onto (cross products of) half-open intervals? Please correct me if I'm wrong.


---

Comment by egourgoulhon created at 2021-07-18 17:09:37

Replying to [comment:29 gh-mjungmath]:
> I like the second variant. It better reflects the situation and what periodic charts actually are.
+1


---

Comment by egourgoulhon created at 2021-07-18 17:12:25

Replying to [comment:37 gh-mjungmath]:
> Periodic charts are always defined via (connected) intervals, aren't they?

Yes I think so.

> W.l.o.g. we can always choose the minimum/maximum the chart maps to? 

What do you mean?


---

Comment by egourgoulhon created at 2021-07-18 17:23:43

Just a word of context about periodic charts: they have been introduced because they are useful when computing a geodesic with some [numerical integrator](https://doc.sagemath.org/html/en/reference/manifolds/sage/manifolds/differentiable/integrated_curve.html). Typically, when the geodesic is an orbit around some center, the azimuthal coordinate returned by the integrator increases without any bound, instead of being confined to [0, 2\pi). Here are some [examples in Kerr spacetime](https://nbviewer.jupyter.org/github/egourgoulhon/BHLectures/blob/master/sage/Kerr_geod_plots.ipynb).


---

Comment by mkoeppe created at 2021-07-18 17:35:59

Replying to [comment:38 egourgoulhon]:
> Replying to [comment:29 gh-mjungmath]:
> > I like the second variant. It better reflects the situation and what periodic charts actually are.
> +1

OK, then it just remains to make it well-defined (comment:30, comment:31)


---

Comment by mkoeppe created at 2021-07-18 19:07:49

Should `ManifoldPoint.add_coordinates` canonicalize the coordinates?
Or should `ManifoldPoint.coordinates` do this?


---

Comment by @mjungmath created at 2021-07-18 19:21:19

Replying to [comment:40 egourgoulhon]:
> Just a word of context about periodic charts: they have been introduced because they are useful when computing a geodesic with some [numerical integrator](https://doc.sagemath.org/html/en/reference/manifolds/sage/manifolds/differentiable/integrated_curve.html). Typically, when the geodesic is an orbit around some center, the azimuthal coordinate returned by the integrator increases without any bound, instead of being confined to [0, 2\pi). Here are some [examples in Kerr spacetime](https://nbviewer.jupyter.org/github/egourgoulhon/BHLectures/blob/master/sage/Kerr_geod_plots.ipynb).

I'm sorry. What is the punchline here?


---

Comment by @mjungmath created at 2021-07-18 19:37:38

Just forget what I just said. It didn't make sense. Sorry.


---

Comment by @mjungmath created at 2021-07-18 19:45:27

Replying to [comment:39 egourgoulhon]:
> > W.l.o.g. we can always choose the minimum/maximum the chart maps to? 
> 
> What do you mean? 

What we can do is that the user has to state the fundamental domain (which currently happens up to boundary only). Or _we_ provide which boundary component belongs to the fundamental domain (I opt for the lower bound). Then it is clear which points the section map has to map to.

For the 1-sphere this could be for example the clopen interval `[-pi,pi)`. Then it becomes clear that the point on the 1-sphere determined by `pi` is mapped to `-pi` via the (section) chart. Similarly then for any other point.

The only obstruction I see right now is that the symbolic ring doesn't provide any modulo operation in the spirit of `x - y*floor(x/y)`. Or does it?


---

Comment by mkoeppe created at 2021-07-18 23:35:59

Replying to [comment:47 gh-mjungmath]:
> the symbolic ring doesn't provide any modulo operation in the spirit of `x - y*floor(x/y)`.

That's right - this is #25644


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by git created at 2021-07-19 02:15:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2021-07-19 07:26:47

Replying to [comment:45 gh-mjungmath]:
> Replying to [comment:40 egourgoulhon]:
> > Just a word of context about periodic charts: they have been introduced because they are useful when computing a geodesic with some [numerical integrator](https://doc.sagemath.org/html/en/reference/manifolds/sage/manifolds/differentiable/integrated_curve.html). Typically, when the geodesic is an orbit around some center, the azimuthal coordinate returned by the integrator increases without any bound, instead of being confined to [0, 2\pi). Here are some [examples in Kerr spacetime](https://nbviewer.jupyter.org/github/egourgoulhon/BHLectures/blob/master/sage/Kerr_geod_plots.ipynb).
> 
> I'm sorry. What is the punchline here?

Periodic charts are useful in practice. Otherwise, we could have lived without them, sticking to the standard definition of a chart on a manifold.


---

Comment by @mjungmath created at 2021-07-19 09:28:34

I guess then, this ticket depends on #25644...


---

Comment by @mjungmath created at 2021-07-19 09:38:06

Replying to [comment:51 egourgoulhon]:
> > I'm sorry. What is the punchline here?
> 
> Periodic charts are useful in practice. Otherwise, we could have lived without them, sticking to the standard definition of a chart on a manifold. 

Thank you. It's clear now. It was my fault yesterday...
