# Issue 21341: Problem with fflas.h on Cygwin since #17635

archive/issues_021341.json:
```json
{
    "body": "CC:  @ClementPernet\n\nI first noticed this problem [here](https://trac.sagemath.org/ticket/17635#comment:241)\n\nCompiling any Cython modules that include `fflas.h` either directly, on indirectly through ffpack, linbox, etc. fail to compile on Cygwin (and hypothetically other platforms).\n\nThis is due to the following lines in, of all places, `pyport.h` (which is included by `Python.h`):\n\n\n```\n#if defined(HAVE_OPENPTY) || defined(HAVE_FORKPTY)\n#if !defined(HAVE_PTY_H) && !defined(HAVE_LIBUTIL_H) && !defined(HAVE_UTIL_H)\n/* BSDI does not supply a prototype for the 'openpty' and 'forkpty'\n   functions, even though they are included in libutil. */\n#include <termios.h>\nextern int openpty(int *, int *, char *, struct termios *, struct winsize *);\nextern pid_t forkpty(int *, char *, struct termios *, struct winsize *);\n#endif /* !defined(HAVE_PTY_H) && !defined(HAVE_LIBUTIL_H) */\n#endif /* defined(HAVE_OPENPTY) || defined(HAVE_FORKPTY) */\n```\n\n\nCygwin does not have (for whatever reason) `HAVE_PTY_H` or `HAVE_LIBUTIL_H` defined (even though pty.h *does* exist on Cygwin--this might be a bug in Python's configure.ac).\n\nThis results in `Python.h` including `termios.h` which [defines](http://man7.org/linux/man-pages/man3/termios.3.html) several macros for baud rates with names like `B0`, ..., `B230400`.  This ends up breaking `fflas-ffpack/fflas/fflas_igemm/igemm_kernels.inl`, which is included (indirectly) from `fflas.h`, because it contains a variable named \"`B0`\" which is replaced by the macro in `termios.h`\n\nIssue created by migration from https://trac.sagemath.org/ticket/21578\n\n",
    "created_at": "2016-09-23T15:39:12Z",
    "labels": [
        "component: porting: cygwin",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.4",
    "title": "Problem with fflas.h on Cygwin since #17635",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21341",
    "user": "https://github.com/embray"
}
```
CC:  @ClementPernet

I first noticed this problem [here](https://trac.sagemath.org/ticket/17635#comment:241)

Compiling any Cython modules that include `fflas.h` either directly, on indirectly through ffpack, linbox, etc. fail to compile on Cygwin (and hypothetically other platforms).

This is due to the following lines in, of all places, `pyport.h` (which is included by `Python.h`):


```
#if defined(HAVE_OPENPTY) || defined(HAVE_FORKPTY)
#if !defined(HAVE_PTY_H) && !defined(HAVE_LIBUTIL_H) && !defined(HAVE_UTIL_H)
/* BSDI does not supply a prototype for the 'openpty' and 'forkpty'
   functions, even though they are included in libutil. */
#include <termios.h>
extern int openpty(int *, int *, char *, struct termios *, struct winsize *);
extern pid_t forkpty(int *, char *, struct termios *, struct winsize *);
#endif /* !defined(HAVE_PTY_H) && !defined(HAVE_LIBUTIL_H) */
#endif /* defined(HAVE_OPENPTY) || defined(HAVE_FORKPTY) */
```


Cygwin does not have (for whatever reason) `HAVE_PTY_H` or `HAVE_LIBUTIL_H` defined (even though pty.h *does* exist on Cygwin--this might be a bug in Python's configure.ac).

This results in `Python.h` including `termios.h` which [defines](http://man7.org/linux/man-pages/man3/termios.3.html) several macros for baud rates with names like `B0`, ..., `B230400`.  This ends up breaking `fflas-ffpack/fflas/fflas_igemm/igemm_kernels.inl`, which is included (indirectly) from `fflas.h`, because it contains a variable named "`B0`" which is replaced by the macro in `termios.h`

Issue created by migration from https://trac.sagemath.org/ticket/21578





---

archive/issue_comments_295773.json:
```json
{
    "body": "First attempt at a workaround.  For now I was going for a patch that changed the fewest lines, though a simpler change might just be to use different variable names...\n----\nNew commits:",
    "created_at": "2016-09-23T16:06:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21341#issuecomment-295773",
    "user": "https://github.com/embray"
}
```

First attempt at a workaround.  For now I was going for a patch that changed the fewest lines, though a simpler change might just be to use different variable names...
----
New commits:



---

archive/issue_comments_295774.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-09-23T16:06:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21341#issuecomment-295774",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_295775.json:
```json
{
    "body": "Just `#undef B0` would work too.\n\nIn any case, this needs to be reported upstream.",
    "created_at": "2016-09-23T18:48:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21341#issuecomment-295775",
    "user": "https://github.com/jdemeyer"
}
```

Just `#undef B0` would work too.

In any case, this needs to be reported upstream.



---

archive/issue_comments_295776.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-09-23T18:49:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21341#issuecomment-295776",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_295777.json:
```json
{
    "body": "True, the `#ifdef` is superfluous I guess but for now it doesn't matter.",
    "created_at": "2016-09-26T11:14:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21341#issuecomment-295777",
    "user": "https://github.com/embray"
}
```

True, the `#ifdef` is superfluous I guess but for now it doesn't matter.



---

archive/issue_comments_295778.json:
```json
{
    "body": "What a pain to have B0 defined!\nI've fixed upstream fflas-ffpack, by renaming `B0` into `B_0` (and other variables in the same way, for consistency): [https://github.com/linbox-team/fflas-ffpack/commit/346498a71b2759f5913ba8c4c2fe025bbf8b3faa](https://github.com/linbox-team/fflas-ffpack/commit/346498a71b2759f5913ba8c4c2fe025bbf8b3faa)",
    "created_at": "2016-09-26T13:40:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21341#issuecomment-295778",
    "user": "https://github.com/ClementPernet"
}
```

What a pain to have B0 defined!
I've fixed upstream fflas-ffpack, by renaming `B0` into `B_0` (and other variables in the same way, for consistency): [https://github.com/linbox-team/fflas-ffpack/commit/346498a71b2759f5913ba8c4c2fe025bbf8b3faa](https://github.com/linbox-team/fflas-ffpack/commit/346498a71b2759f5913ba8c4c2fe025bbf8b3faa)



---

archive/issue_comments_295779.json:
```json
{
    "body": "Thanks!  In that case I'll update the patch in this ticket to do the same.",
    "created_at": "2016-09-26T15:46:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21341#issuecomment-295779",
    "user": "https://github.com/embray"
}
```

Thanks!  In that case I'll update the patch in this ticket to do the same.



---

archive/issue_comments_295780.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-09-26T15:46:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21341#issuecomment-295780",
    "user": "https://github.com/embray"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_295781.json:
```json
{
    "body": "(Though depending on the speed at which other Cygwin issues get resolved, this may become a moot point if we do another fflas-ffpack update before Cygwin is at 100% again :)",
    "created_at": "2016-09-26T15:48:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21341#issuecomment-295781",
    "user": "https://github.com/embray"
}
```

(Though depending on the speed at which other Cygwin issues get resolved, this may become a moot point if we do another fflas-ffpack update before Cygwin is at 100% again :)



---

archive/issue_comments_295782.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-28T06:37:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21341#issuecomment-295782",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_295783.json:
```json
{
    "body": "Updated patch to mirror the upstream fix.",
    "created_at": "2016-09-28T06:38:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21341#issuecomment-295783",
    "user": "https://github.com/embray"
}
```

Updated patch to mirror the upstream fix.



---

archive/issue_comments_295784.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-09-28T06:38:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21341#issuecomment-295784",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_295785.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-09-28T07:31:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21341#issuecomment-295785",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_020194.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-10-05T06:52:41Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21341",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21341#event-20194"
}
```



---

archive/issue_comments_295786.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-10-05T06:52:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21341#issuecomment-295786",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
