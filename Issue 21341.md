# Issue 21341: Problem with fflas.h on Cygwin since #17635

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2016-09-23 15:39:12

CC:  cpernet

I first noticed this problem [here](https://trac.sagemath.org/ticket/17635#comment:241)

Compiling any Cython modules that include `fflas.h` either directly, on indirectly through ffpack, linbox, etc. fail to compile on Cygwin (and hypothetically other platforms).

This is due to the following lines in, of all places, `pyport.h` (which is included by `Python.h`):


```
#if defined(HAVE_OPENPTY) || defined(HAVE_FORKPTY)
#if !defined(HAVE_PTY_H) && !defined(HAVE_LIBUTIL_H) && !defined(HAVE_UTIL_H)
/* BSDI does not supply a prototype for the 'openpty' and 'forkpty'
   functions, even though they are included in libutil. */
#include <termios.h>
extern int openpty(int *, int *, char *, struct termios *, struct winsize *);
extern pid_t forkpty(int *, char *, struct termios *, struct winsize *);
#endif /* !defined(HAVE_PTY_H) && !defined(HAVE_LIBUTIL_H) */
#endif /* defined(HAVE_OPENPTY) || defined(HAVE_FORKPTY) */
```


Cygwin does not have (for whatever reason) `HAVE_PTY_H` or `HAVE_LIBUTIL_H` defined (even though pty.h _does_ exist on Cygwin--this might be a bug in Python's configure.ac).

This results in `Python.h` including `termios.h` which [defines](http://man7.org/linux/man-pages/man3/termios.3.html) several macros for baud rates with names like `B0`, ..., `B230400`.  This ends up breaking `fflas-ffpack/fflas/fflas_igemm/igemm_kernels.inl`, which is included (indirectly) from `fflas.h`, because it contains a variable named "`B0`" which is replaced by the macro in `termios.h`


---

Comment by embray created at 2016-09-23 16:06:09

First attempt at a workaround.  For now I was going for a patch that changed the fewest lines, though a simpler change might just be to use different variable names...
----
New commits:


---

Comment by embray created at 2016-09-23 16:06:09

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2016-09-23 18:48:55

Just `#undef B0` would work too.

In any case, this needs to be reported upstream.


---

Comment by jdemeyer created at 2016-09-23 18:49:06

Changing status from needs_review to positive_review.


---

Comment by embray created at 2016-09-26 11:14:15

True, the `#ifdef` is superfluous I guess but for now it doesn't matter.


---

Comment by cpernet created at 2016-09-26 13:40:26

What a pain to have B0 defined!
I've fixed upstream fflas-ffpack, by renaming `B0` into `B_0` (and other variables in the same way, for consistency): [https://github.com/linbox-team/fflas-ffpack/commit/346498a71b2759f5913ba8c4c2fe025bbf8b3faa](https://github.com/linbox-team/fflas-ffpack/commit/346498a71b2759f5913ba8c4c2fe025bbf8b3faa)


---

Comment by embray created at 2016-09-26 15:46:39

Thanks!  In that case I'll update the patch in this ticket to do the same.


---

Comment by embray created at 2016-09-26 15:46:39

Changing status from positive_review to needs_work.


---

Comment by embray created at 2016-09-26 15:48:18

(Though depending on the speed at which other Cygwin issues get resolved, this may become a moot point if we do another fflas-ffpack update before Cygwin is at 100% again :)


---

Comment by git created at 2016-09-28 06:37:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2016-09-28 06:38:34

Updated patch to mirror the upstream fix.


---

Comment by embray created at 2016-09-28 06:38:34

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2016-09-28 07:31:13

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-10-05 06:52:41

Resolution: fixed
