# Issue 22623: ticket #22840 causes breakage with some linkers when the order is important.

Issue created by migration from Trac.

Original creator: fbissey

Original creation time: 2017-04-24 04:01:20

CC:  dimpase jmantysalo tscrim strogdon

After #22840 was merged and released as part of 8.0.beta3 users of ubuntu 16.04.4 started to complain that `lcalc` couldn't be built

```
g++ -O3   -ffast-math -fPIC   -I../include -L/home/travis/sage-build/local/lib -Wl,-rpath,/home/travis/sage-build/local/lib  -L/home/travis/sage-build/local/lib -lpari -lgmp -L/home/travis/sage-build/local/lib -lpari -lgmp Lglobals.o Lgamma.o Lriemannsiegel.o Lriemannsiegel_blfi.o Ldokchitser.o Lcommandline_globals.o Lcommandline_misc.o Lcommandline_numbertheory.o Lcommandline_values_zeros.o Lcommandline_elliptic.o Lcommandline_twist.o Lcommandline.o cmdline.o -o lcalc 
Lcommandline_elliptic.o: In function `cxcompotor.constprop.52':
Lcommandline_elliptic.cc:(.text+0x44): undefined reference to `pari_err'
Lcommandline_elliptic.cc:(.text+0x63): undefined reference to `avma'
Lcommandline_elliptic.cc:(.text+0x6a): undefined reference to `pari_mainstack'
Lcommandline_elliptic.cc:(.text+0xa3): undefined reference to `affir'
Lcommandline_elliptic.cc:(.text+0xc3): undefined reference to `avma'
...
...
Lcommandline_elliptic.cc:(.text+0x1289): undefined reference to `new_chunk_resize'
Lcommandline.o: In function `main':
Lcommandline.cc:(.text.startup+0x8d5): undefined reference to `pari_init'
Lcommandline.cc:(.text.startup+0x14ba): undefined reference to `paristack_setsize'
collect2: error: ld returned 1 exit status
```

This is a perfect example were the libraries need to be after the objects needed them in some linkers.


---

Comment by fbissey created at 2017-04-24 04:02:48

Dima, I will move LDFLAGS after the objects file in those makefiles. If this isn't working for you we'll have to do some split between flags proper and `LIBS`.


---

Comment by fbissey created at 2017-04-24 04:43:25

I think only `lcalc` has an issue but looking closer I think LDFLAGS should be separated from "`PARI_LIBS`". Can you tell me what's in your LDFLAGS on freeBSD?


---

Comment by jmantysalo created at 2017-04-24 06:17:05

Cc'ing myself. Got same error on two different Ubuntu 16.04 LTS machines.


---

Comment by fbissey created at 2017-04-24 07:25:13

Changing status from new to needs_info.


---

Comment by fbissey created at 2017-04-24 07:25:13

OK here is a quick branch to test and give feedback on. But I am waiting for comments from Dima on freeBSD before putting to review #22840 was motivated by linking issues on freeBSD and I don't want to go backwards on that.
----
New commits:


---

Comment by dimpase created at 2017-04-24 07:44:34

On FreeBSD I have
`LDFLAGS=-L/usr/home/dima/Sage/sage/local/lib -Wl,--add-needed -lm`

And this is the (working) command in question:

```
clang++-devel -fPIC -pipe -O3   -ffast-math -fPIC   -I../include -L/usr/home/dima/Sage/sage/local/lib -Wl,-rpath,/usr/home/dima/Sage/
sage/local/lib -L/usr/home/dima/Sage/sage/local/lib -Wl,--add-needed -lm -L/usr/home/dima/Sage/sage/local/lib -lpari -lgmp -L/usr/hom
e/dima/Sage/sage/local/lib -lpari -lgmp Lglobals.o Lgamma.o Lriemannsiegel.o Lriemannsiegel_blfi.o Ldokchitser.o Lcommandline_globals
.o Lcommandline_misc.o Lcommandline_numbertheory.o Lcommandline_values_zeros.o Lcommandline_elliptic.o Lcommandline_twist.o Lcommandl
ine.o cmdline.o -o lcalc 
```



---

Comment by dimpase created at 2017-04-24 07:46:54

Strangely, patchbots (one of then Ubuntu 16.04) had no problem with #22840.


---

Comment by fbissey created at 2017-04-24 08:19:25

OK, `-Wl,--add-needed` probably shield you from a lot of stuff. In any case it should work with this branch. You guys can start trashing it, it was a quicky so there may be a mistake or two lurking.


---

Comment by fbissey created at 2017-04-24 08:19:25

Changing status from needs_info to needs_review.


---

Comment by dimpase created at 2017-04-24 08:27:53

`--add-needed` is necessary for the extra `libm` we install on FreeBSD, and which is linked to the "real" `libm`.

By the way, 

```
-+	$(MAKE) libLfunction$(LIBEXT)
-+	$(MAKE) lcalc$(EXEEXT)
++	$(MAKE) libLfunction.so
++	$(MAKE) lcalc
```

looks too optimistic for OSX, don't we get `.dynlib` rather than `.so`, and too optimistic for Cygwin, where we get `.exe` for executables.


---

Comment by fbissey created at 2017-04-24 08:53:39

Thanks, I missed these. I should have had a look at a diff of the patch. Correcting shortly.


---

Comment by git created at 2017-04-24 09:05:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2017-04-24 09:08:31

OK, so for the review I am expecting testing from Dima on freeBSD, someone on ubuntu 16.04.4 and Steve Trogdon on Gentoo with `--as-needed` in LDFLAGS.


---

Comment by dimpase created at 2017-04-24 09:18:56


```
-+	rm -f *.o lcalc libLfunction$(LIBEXT) example_programs/example
++	rm -f *.o lcalc$(EXEEXT) libLfunction$(LIBEXT) example_programs/example
```

should be `example_programs/example$(EXEEXT)` at the 2nd line


---

Comment by fbissey created at 2017-04-24 09:26:16

Replying to [comment:13 dimpase]:
> {{{
> -+	rm -f *.o lcalc libLfunction$(LIBEXT) example_programs/example
> ++	rm -f *.o lcalc$(EXEEXT) libLfunction$(LIBEXT) example_programs/example
> }}}
> should be `example_programs/example$(EXEEXT)` at the 2nd line

If you look at the original Makefile.patch you will note that `$(EXEEXT)` has never been appended to `example` neither here or the earlier rule to build it. Neither did you in your patch revision. Nothing in spkg-install or spkg-build will ever call that target, it has only been amended for some measure of consistency but someone (probably working on cygwin) didn't see the point in adding that bit.


---

Comment by dimpase created at 2017-04-24 09:35:12

Replying to [comment:14 fbissey]:
> Replying to [comment:13 dimpase]:
> > {{{
> > -+	rm -f *.o lcalc libLfunction$(LIBEXT) example_programs/example
> > ++	rm -f *.o lcalc$(EXEEXT) libLfunction$(LIBEXT) example_programs/example
> > }}}
> > should be `example_programs/example$(EXEEXT)` at the 2nd line
> 
> If you look at the original Makefile.patch you will note that `$(EXEEXT)` has never been appended to `example` neither here or the earlier rule to build it. Neither did you in your patch revision. Nothing in spkg-install or spkg-build will ever call that target, it has only been amended for some measure of consistency but someone (probably working on cygwin) didn't see the point in adding that bit.

I think on Windows you'd get `.exe` appended to an executable even if `-o ...` does not mention it. And then you need to remove the file with the `.exe` extension.


---

Comment by git created at 2017-04-24 10:10:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2017-04-24 10:11:41

OK things are more consistent now.


---

Comment by egourgoulhon created at 2017-04-24 11:20:25

Replying to [comment:12 fbissey]:
> OK, so for the review I am expecting testing from Dima on freeBSD, someone on ubuntu 16.04.4 
I confirm that pulling the ticket branch in Sage 8.0.beta3 sources (from a fresh git clone) yields a successful built on Ubuntu 16.04 (it failed otherwise).


---

Comment by dimpase created at 2017-04-24 13:08:44

OK, this works on FreeBSD.


---

Comment by tscrim created at 2017-04-24 13:30:42

Worked for me on linux. I'm going to try on Cygwin in a minute.


---

Comment by strogdon created at 2017-04-24 14:39:22

Builds here on Gentoo with `LDFLAGS=-Wl,-O1 -Wl,--as-needed` with a slightly different ordering of linked libs

```
g++ -O3   -ffast-math -fPIC   -I../include -L/64bitdev/storage/sage-git_develop/sage/local/lib -Wl,-rpath,/64bitdev/storage/sage-git_develop/sage/local/lib -Wl,-O1 -Wl,--as-needed Lglobals.o Lgamma.o Lriemannsiegel.o Lriemannsiegel_blfi.o Ldokchitser.o Lcommandline_globals.o Lcommandline_misc.o Lcommandline_numbertheory.o Lcommandline_values_zeros.o Lcommandline_elliptic.o Lcommandline_twist.o Lcommandline.o cmdline.o -o lcalc -L/64bitdev/storage/sage-git_develop/sage/local/lib -lpari -lgmp -lm
```



---

Comment by strogdon created at 2017-04-24 16:30:11

Replying to [comment:21 strogdon]:
> Builds here on Gentoo with `LDFLAGS=-Wl,-O1 -Wl,--as-needed` with a slightly different ordering of linked libs
> {{{
> g++ -O3   -ffast-math -fPIC   -I../include -L/64bitdev/storage/sage-git_develop/sage/local/lib -Wl,-rpath,/64bitdev/storage/sage-git_develop/sage/local/lib -Wl,-O1 -Wl,--as-needed Lglobals.o Lgamma.o Lriemannsiegel.o Lriemannsiegel_blfi.o Ldokchitser.o Lcommandline_globals.o Lcommandline_misc.o Lcommandline_numbertheory.o Lcommandline_values_zeros.o Lcommandline_elliptic.o Lcommandline_twist.o Lcommandline.o cmdline.o -o lcalc -L/64bitdev/storage/sage-git_develop/sage/local/lib -lpari -lgmp -lm
> }}}
I'm curious about the `-L/64bitdev/storage/sage-git_develop/sage/local/lib -lpari -lgmp -lm` that appears above. In particular the `-lm` that wasn't present when it failed. I have no `libm.so` under `64bitdev/storage/sage-git_develop/sage/local/lib`. I don't think it's needed. But why does it appear?


---

Comment by strogdon created at 2017-04-24 16:48:19

I see, the `-lm` is now in the Makefile. Is it needed?


---

Comment by tscrim created at 2017-04-24 16:54:14

This built for me without problems on Cygwin.


---

Comment by fbissey created at 2017-04-24 18:36:54

Replying to [comment:23 strogdon]:
> I see, the `-lm` is now in the Makefile. Is it needed?

Possibly not, I am just not taking chances in case someone has a system with somewhat broken dynamic libraries. Both pari and gmp use libm.


---

Comment by fbissey created at 2017-04-24 22:06:58

I think that's enough reviews :)


---

Comment by fbissey created at 2017-04-24 22:06:58

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2017-04-25 04:33:09

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2017-04-25 04:33:09

Don't forget to bump the patchlevel (you can set this back to positive_review after you did that).


---

Comment by git created at 2017-04-25 05:35:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2017-04-25 05:35:42

Changing status from needs_work to positive_review.


---

Comment by jpflori created at 2017-04-25 11:44:49

Is there still an upstream for lcalc where to forward our patches?


---

Comment by vbraun created at 2017-04-27 20:11:58

Resolution: fixed
