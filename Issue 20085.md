# Issue 20085: use SAGE_BANNER to propose a bare banner with no utf8

Issue created by migration from Trac.

Original creator: chapoton

Original creation time: 2016-03-30 15:23:07

CC:  nthiery embray jdemeyer

The pretty colored banner for sage uses utf8, and this
poses problem for the docker patchbot.

Let us use SAGE_BANNER to propose a shorten banner when needed.


---

Comment by chapoton created at 2016-03-30 15:34:43

Changing status from new to needs_review.


---

Comment by chapoton created at 2016-03-30 15:34:43

setting SAGE_BANNER to "bare" should give the expected result
----
New commits:


---

Comment by jdemeyer created at 2016-03-31 08:42:57

Changing component from PLEASE CHANGE to user interface.


---

Comment by jdemeyer created at 2016-03-31 08:42:57

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2016-03-31 08:42:57

Can you use consistent indentation?


---

Comment by jdemeyer created at 2016-03-31 08:42:57

Changing type from PLEASE CHANGE to enhancement.


---

Comment by git created at 2016-03-31 08:46:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-03-31 08:47:17

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2016-03-31 09:00:52

I am adding a commit to make the bare and full banners more consistent...


---

Comment by jdemeyer created at 2016-03-31 09:00:52

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2016-03-31 09:03:41

oh well, bare means "without bells and dingles"

all what is needed to have the tests pass in the docker container is that it contains the text of VERSION.txt


---

Comment by jdemeyer created at 2016-03-31 09:08:29

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2016-03-31 09:08:29

New commits:


---

Comment by jdemeyer created at 2016-03-31 09:10:07

Running full doctests now with `SAGE_BANNER=bare`...


---

Comment by git created at 2016-03-31 10:11:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-03-31 12:03:53

Doctests pass: positive_review from my part.


---

Comment by chapoton created at 2016-03-31 12:05:36

ok, let it be


---

Comment by chapoton created at 2016-03-31 12:05:36

Changing status from needs_review to positive_review.


---

Comment by embray created at 2016-03-31 12:07:31

Out of curiosity, in what context did this come up?  I reported the following issue upstream to Docker: https://github.com/docker/docker/issues/21323  But AFAICT this only affects the Docker client on Windows.


---

Comment by chapoton created at 2016-03-31 12:09:10

`@`embray

This was just to help *you* to make the sage-patchbot docker container work.


---

Comment by embray created at 2016-03-31 12:21:35

I just haven't had this problem specifically since I'm not trying to run the sage-patchbot container on Windows.  In the meantime I just disabled the SAGE_BANNER for the docker images in [sagemath/docker-images`@`2c90e030 ](https://github.com/sagemath/docker-images/commit/2c90e030305d09f50dcd547f39ef8e5bac4bb628#diff-f5f0fb89d617ccbbde8261257e6dd358). So I was just curious how this came about since I wasn't explicitly asking for it (not that I'm against it).


---

Comment by chapoton created at 2016-03-31 12:26:54

This is the disabling of the banner that causes some failing doctests:

http://patchbot.sagemath.org/log/0/Ubuntu/15.10/x86_64/3.13.0-43-generic/62744a2b1a07/2016-03-28%2022:18:21

the other failing doctest is in sagedev, but not yet understood.

SO PLEASE, once the next release is out, use SAGE_BANNER=bare instead of "no"


---

Comment by embray created at 2016-03-31 12:28:21

Ah, I see. Though maybe those tests should check the actual value of the environment variable and skip if it's different, or just set it explicitly beforehand.


---

Comment by vbraun created at 2016-03-31 21:19:04

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2016-03-31 21:19:04


```
sage -t --long src/sage/tests/cmdline.py
**********************************************************************
File "src/sage/tests/cmdline.py", line 106, in sage.tests.cmdline.test_executable
Failed example:
    out.find(version()) >= 0
Expected:
    True
Got:
    False
**********************************************************************
File "src/sage/tests/cmdline.py", line 114, in sage.tests.cmdline.test_executable
Failed example:
    out.find(version()) >= 0
Expected:
    True
Got:
    False
**********************************************************************
1 item had failures:
   2 of 235 in sage.tests.cmdline.test_executable
    [234 tests, 2 failures, 63.86 s]
```



---

Comment by chapoton created at 2016-04-01 07:36:06

Hum, I think this just needs a banner and VERSION.txt refreshment to work.

So this is a rather special kind of ticket. Maybe to merge just before a beta release ?


---

Comment by jdemeyer created at 2016-04-01 08:31:01

I guess this is yet another "the bug is not in the ticket but in the buildbot".


---

Comment by jdemeyer created at 2016-04-01 08:31:01

Changing status from needs_work to positive_review.


---

Comment by git created at 2016-04-01 08:40:03

Changing status from positive_review to needs_review.


---

Comment by git created at 2016-04-01 08:40:03

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by jdemeyer created at 2016-04-01 08:41:40

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2016-04-01 08:42:14

The last commit isn't really needed, it's just to make the buildbot happy.


---

Comment by embray created at 2016-04-01 12:03:13

I still think that if a test is expecting something particular about the environment that it should set that environment for the test.  For example something like

```diff
diff --git a/src/sage/tests/cmdline.py b/src/sage/tests/cmdline.py
index 534436d..1d0395e 100644
--- a/src/sage/tests/cmdline.py
+++ b/src/sage/tests/cmdline.py
`@``@` -57,7 +57,7 `@``@` from subprocess import *
 import os, select
 
 
-def test_executable(args, input="", timeout=100.0, **kwds):
+def test_executable(args, input="", timeout=100.0, env={}, **kwds):
     r"""
     Run the program defined by ``args`` using the string ``input`` on
     the standard input.
`@``@` -102,7 +102,7 `@``@` def test_executable(args, input="", timeout=100.0, **kwds):
 
     Run Sage itself with various options::
 
-        sage: (out, err, ret) = test_executable(["sage"])
+        sage: (out, err, ret) = test_executable(["sage"], env={'SAGE_BANNER': 'bare'})
         sage: out.find(version()) >= 0
         True
         sage: err
`@``@` -110,7 +110,7 `@``@` def test_executable(args, input="", timeout=100.0, **kwds):
         sage: ret
         0
 
-        sage: (out, err, ret) = test_executable(["sage"], "3^33\n")
+        sage: (out, err, ret) = test_executable(["sage"], "3^33\n", env={'SAGE_BANNER': 'bare'})
         sage: out.find(version()) >= 0
         True
         sage: out.find("5559060566555523") >= 0
`@``@` -120,7 +120,7 `@``@` def test_executable(args, input="", timeout=100.0, **kwds):
         sage: ret
         0
 
-        sage: (out, err, ret) = test_executable(["sage", "-q"], "3^33\n")
+        sage: (out, err, ret) = test_executable(["sage", "-q"], "3^33\n", env={'SAGE_BANNER': 'bare'})
         sage: out.find(version()) >= 0
         False
         sage: out.find("5559060566555523") >= 0
`@``@` -728,6 +728,9 `@``@` def test_executable(args, input="", timeout=100.0, **kwds):
         del pexpect_env["TERM"]
     except KeyError:
         pass
+
+    pexpect_env.update(env)
+
     p = Popen(args, stdin=PIPE, stdout=PIPE, stderr=PIPE, env=pexpect_env, **kwds)
     if input:
         p.stdin.write(input)

```



---

Comment by vbraun created at 2016-04-01 15:10:59

Resolution: fixed


---

Comment by embray created at 2016-04-04 09:07:08

Incidentally, the patchbot has its own unicode banner that is causing Docker client to crash: https://github.com/robertwb/sage-patchbot/blob/master/src/patchbot.py#L455  I will open a separate issue.


---

Comment by embray created at 2016-04-04 21:13:51

I have submitted an issue regarding the patchbot's banner to https://github.com/robertwb/sage-patchbot/pull/78
