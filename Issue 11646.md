# Issue 11646: sage <script> does not run sage-cleaner

archive/issues_011646.json:
```json
{
    "body": "When you are running a long computation, you are probably putting your sage program in a `script.sage` file and then run `sage script.sage` in a screen'ed terminal. In that case, `sage-cleaner` is not run. So if you use `@`parallel, each fork creates a new subdirectory `$DOT_SAGE/temp/hostname/pid` that is not being cleaned up. This can easily reach a limit of the file system, for example ext2/ext3 are limited to 2<sup>15</sup>  subdirectories per directory.\n\nA typical error message then looks like\n\n```\n[Errno 31] Too many links: '/home/vbraun/.sage//temp/hostname/26457/'\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/11818\n\n",
    "created_at": "2011-09-20T16:51:47Z",
    "labels": [
        "scripts",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.7.2",
    "title": "sage <script> does not run sage-cleaner",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11646",
    "user": "@vbraun"
}
```
When you are running a long computation, you are probably putting your sage program in a `script.sage` file and then run `sage script.sage` in a screen'ed terminal. In that case, `sage-cleaner` is not run. So if you use `@`parallel, each fork creates a new subdirectory `$DOT_SAGE/temp/hostname/pid` that is not being cleaned up. This can easily reach a limit of the file system, for example ext2/ext3 are limited to 2<sup>15</sup>  subdirectories per directory.

A typical error message then looks like

```
[Errno 31] Too many links: '/home/vbraun/.sage//temp/hostname/26457/'
```


Issue created by migration from https://trac.sagemath.org/ticket/11818





---

archive/issue_comments_131637.json:
```json
{
    "body": "Steps to reproduce:\n\n```sh\n[vbraun@volker-desktop ~]$ ls ~/.sage/temp/volker_desktop.stp.dias.ie/ | wc\n      0       0       0\n[vbraun@volker-desktop ~]$ cat > script.sage <<EOF\n@parallel(verbose=True)\ndef f(i):\n    return i\n\nlist(f(range(0,100)))\nEOF\n[vbraun@volker-desktop ~]$ sage script.sage\n[vbraun@volker-desktop ~]$ ls ~/.sage/temp/volker_desktop.stp.dias.ie/ | wc\n    101     101     505\n```\n",
    "created_at": "2011-09-20T16:59:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11646#issuecomment-131637",
    "user": "@vbraun"
}
```

Steps to reproduce:

```sh
[vbraun@volker-desktop ~]$ ls ~/.sage/temp/volker_desktop.stp.dias.ie/ | wc
      0       0       0
[vbraun@volker-desktop ~]$ cat > script.sage <<EOF
@parallel(verbose=True)
def f(i):
    return i

list(f(range(0,100)))
EOF
[vbraun@volker-desktop ~]$ sage script.sage
[vbraun@volker-desktop ~]$ ls ~/.sage/temp/volker_desktop.stp.dias.ie/ | wc
    101     101     505
```




---

archive/issue_comments_131638.json:
```json
{
    "body": "Is a change like this good enough?\n\n```diff\ndiff --git a/sage-sage b/sage-sage\n--- a/sage-sage\n+++ b/sage-sage\n@@ -1021,6 +1021,7 @@ if [ $# -ge 1 ]; then\n        exit $?\n    fi\n    cd \"$SAGE_LOCAL/bin/\"\n+   SAGE_BANNER=\"no\" sage_setup\n    sage-run \"$CUR\" \"$@\"\n    exit $?\n fi\n```\n",
    "created_at": "2011-09-20T17:59:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11646#issuecomment-131638",
    "user": "@jhpalmieri"
}
```

Is a change like this good enough?

```diff
diff --git a/sage-sage b/sage-sage
--- a/sage-sage
+++ b/sage-sage
@@ -1021,6 +1021,7 @@ if [ $# -ge 1 ]; then
        exit $?
    fi
    cd "$SAGE_LOCAL/bin/"
+   SAGE_BANNER="no" sage_setup
    sage-run "$CUR" "$@"
    exit $?
 fi
```




---

archive/issue_comments_131639.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-09-20T19:52:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11646#issuecomment-131639",
    "user": "@vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_131640.json:
```json
{
    "body": "Yes, that is it!",
    "created_at": "2011-09-20T19:52:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11646#issuecomment-131640",
    "user": "@vbraun"
}
```

Yes, that is it!



---

archive/issue_comments_131641.json:
```json
{
    "body": "John's patch",
    "created_at": "2011-09-20T19:55:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11646#issuecomment-131641",
    "user": "@vbraun"
}
```

John's patch



---

archive/issue_comments_131642.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-09-20T19:55:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11646#issuecomment-131642",
    "user": "@vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_131643.json:
```json
{
    "body": "Attachment [trac_11818_run_sage_setup.patch](tarball://root/attachments/some-uuid/ticket11818/trac_11818_run_sage_setup.patch) by @vbraun created at 2011-09-20 19:55:41\n\nI am giving this positive review :-)",
    "created_at": "2011-09-20T19:55:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11646#issuecomment-131643",
    "user": "@vbraun"
}
```

Attachment [trac_11818_run_sage_setup.patch](tarball://root/attachments/some-uuid/ticket11818/trac_11818_run_sage_setup.patch) by @vbraun created at 2011-09-20 19:55:41

I am giving this positive review :-)



---

archive/issue_comments_131644.json:
```json
{
    "body": "I'll see if I can include this patch bomb into Sage 4.7.2.alpha3...",
    "created_at": "2011-09-20T20:34:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11646#issuecomment-131644",
    "user": "@nexttime"
}
```

I'll see if I can include this patch bomb into Sage 4.7.2.alpha3...



---

archive/issue_comments_131645.json:
```json
{
    "body": "P.S.:\n\nSome doctest in `sage/parallel/*` analoguous to what Volker did wouldn't be bad.",
    "created_at": "2011-09-20T20:37:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11646#issuecomment-131645",
    "user": "@nexttime"
}
```

P.S.:

Some doctest in `sage/parallel/*` analoguous to what Volker did wouldn't be bad.



---

archive/issue_comments_131646.json:
```json
{
    "body": "But during parallel doctests there should be a large and fluctuating number of directories in the temp dir. So I don't see an easy way of testing this...",
    "created_at": "2011-09-20T20:40:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11646#issuecomment-131646",
    "user": "@vbraun"
}
```

But during parallel doctests there should be a large and fluctuating number of directories in the temp dir. So I don't see an easy way of testing this...



---

archive/issue_comments_131647.json:
```json
{
    "body": "Replying to [comment:8 leif]:\n> P.S.:\n> \n> Some doctest in `sage/parallel/*` analoguous to what Volker did wouldn't be bad.\n\n... which perhaps isn't *that* easy.",
    "created_at": "2011-09-20T20:42:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11646#issuecomment-131647",
    "user": "@nexttime"
}
```

Replying to [comment:8 leif]:
> P.S.:
> 
> Some doctest in `sage/parallel/*` analoguous to what Volker did wouldn't be bad.

... which perhaps isn't *that* easy.



---

archive/issue_comments_131648.json:
```json
{
    "body": "I had an idea how to doctest this, but it passes doctests regardless of whether the patch here has been applied.  I'll post it here in case you have any suggestions.",
    "created_at": "2011-09-20T21:11:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11646#issuecomment-131648",
    "user": "@jhpalmieri"
}
```

I had an idea how to doctest this, but it passes doctests regardless of whether the patch here has been applied.  I'll post it here in case you have any suggestions.



---

archive/issue_comments_131649.json:
```json
{
    "body": "for Sage library, but currently not working properly",
    "created_at": "2011-09-20T21:12:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11646#issuecomment-131649",
    "user": "@jhpalmieri"
}
```

for Sage library, but currently not working properly



---

archive/issue_comments_131650.json:
```json
{
    "body": "Attachment [trac_11818-experimental.patch](tarball://root/attachments/some-uuid/ticket11818/trac_11818-experimental.patch) by @vbraun created at 2011-09-20 21:17:39\n\nWhen you are doctesting this, the sage-cleaner was already started by the doctesting process. In a single-threaded doctest you could kill the sage-cleaner and check that it is being restarted, but with parallel testing that would just be a race condition.",
    "created_at": "2011-09-20T21:17:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11646#issuecomment-131650",
    "user": "@vbraun"
}
```

Attachment [trac_11818-experimental.patch](tarball://root/attachments/some-uuid/ticket11818/trac_11818-experimental.patch) by @vbraun created at 2011-09-20 21:17:39

When you are doctesting this, the sage-cleaner was already started by the doctesting process. In a single-threaded doctest you could kill the sage-cleaner and check that it is being restarted, but with parallel testing that would just be a race condition.



---

archive/issue_comments_131651.json:
```json
{
    "body": "Replying to [comment:12 vbraun]:\n> When you are doctesting this, the sage-cleaner was already started by the doctesting process.\n\nRight, I was just coming to the same conclusion, although I'm not sure where sage-cleaner is actually started when you run \"sage -t FILE\".\n\nIn any case, it looks difficult, or at least annoying, to test this from within Sage's doctesting framework.",
    "created_at": "2011-09-20T21:26:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11646#issuecomment-131651",
    "user": "@jhpalmieri"
}
```

Replying to [comment:12 vbraun]:
> When you are doctesting this, the sage-cleaner was already started by the doctesting process.

Right, I was just coming to the same conclusion, although I'm not sure where sage-cleaner is actually started when you run "sage -t FILE".

In any case, it looks difficult, or at least annoying, to test this from within Sage's doctesting framework.



---

archive/issue_comments_131652.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-09-27T17:39:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11646#issuecomment-131652",
    "user": "@nexttime"
}
```

Resolution: fixed
