# Issue 11646: sage <script> does not run sage-cleaner

Issue created by migration from Trac.

Original creator: vbraun

Original creation time: 2011-09-20 16:51:47

When you are running a long computation, you are probably putting your sage program in a `script.sage` file and then run `sage script.sage` in a screen'ed terminal. In that case, `sage-cleaner` is not run. So if you use `@`parallel, each fork creates a new subdirectory `$DOT_SAGE/temp/hostname/pid` that is not being cleaned up. This can easily reach a limit of the file system, for example ext2/ext3 are limited to 2<sup>15</sup>  subdirectories per directory.

A typical error message then looks like

```
[Errno 31] Too many links: '/home/vbraun/.sage//temp/hostname/26457/'
```



---

Comment by vbraun created at 2011-09-20 16:59:25

Steps to reproduce:

```sh
[vbraun`@`volker-desktop ~]$ ls ~/.sage/temp/volker_desktop.stp.dias.ie/ | wc
      0       0       0
[vbraun`@`volker-desktop ~]$ cat > script.sage <<EOF
`@`parallel(verbose=True)
def f(i):
    return i

list(f(range(0,100)))
EOF
[vbraun`@`volker-desktop ~]$ sage script.sage
[vbraun`@`volker-desktop ~]$ ls ~/.sage/temp/volker_desktop.stp.dias.ie/ | wc
    101     101     505
```



---

Comment by jhpalmieri created at 2011-09-20 17:59:54

Is a change like this good enough?

```diff
diff --git a/sage-sage b/sage-sage
--- a/sage-sage
+++ b/sage-sage
`@``@` -1021,6 +1021,7 `@``@` if [ $# -ge 1 ]; then
        exit $?
    fi
    cd "$SAGE_LOCAL/bin/"
+   SAGE_BANNER="no" sage_setup
    sage-run "$CUR" "$`@`"
    exit $?
 fi
```



---

Comment by vbraun created at 2011-09-20 19:52:58

Changing status from new to needs_review.


---

Comment by vbraun created at 2011-09-20 19:52:58

Yes, that is it!


---

Comment by vbraun created at 2011-09-20 19:55:11

John's patch


---

Comment by vbraun created at 2011-09-20 19:55:41

Changing status from needs_review to positive_review.


---

Attachment

I am giving this positive review :-)


---

Comment by leif created at 2011-09-20 20:34:01

I'll see if I can include this patch bomb into Sage 4.7.2.alpha3...


---

Comment by leif created at 2011-09-20 20:37:39

P.S.:

Some doctest in `sage/parallel/*` analoguous to what Volker did wouldn't be bad.


---

Comment by vbraun created at 2011-09-20 20:40:02

But during parallel doctests there should be a large and fluctuating number of directories in the temp dir. So I don't see an easy way of testing this...


---

Comment by leif created at 2011-09-20 20:42:12

Replying to [comment:8 leif]:
> P.S.:
> 
> Some doctest in `sage/parallel/*` analoguous to what Volker did wouldn't be bad.

... which perhaps isn't _that_ easy.


---

Comment by jhpalmieri created at 2011-09-20 21:11:38

I had an idea how to doctest this, but it passes doctests regardless of whether the patch here has been applied.  I'll post it here in case you have any suggestions.


---

Comment by jhpalmieri created at 2011-09-20 21:12:30

for Sage library, but currently not working properly


---

Attachment

When you are doctesting this, the sage-cleaner was already started by the doctesting process. In a single-threaded doctest you could kill the sage-cleaner and check that it is being restarted, but with parallel testing that would just be a race condition.


---

Comment by jhpalmieri created at 2011-09-20 21:26:48

Replying to [comment:12 vbraun]:
> When you are doctesting this, the sage-cleaner was already started by the doctesting process.

Right, I was just coming to the same conclusion, although I'm not sure where sage-cleaner is actually started when you run "sage -t FILE".

In any case, it looks difficult, or at least annoying, to test this from within Sage's doctesting framework.


---

Comment by leif created at 2011-09-27 17:39:01

Resolution: fixed
