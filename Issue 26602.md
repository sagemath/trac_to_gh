# Issue 26602: RealLazyField: converting constants in an expression to float

Issue created by migration from https://trac.sagemath.org/ticket/26839

Original creator: wphooper

Original creation time: 2018-12-05 19:11:49

CC:  vdelecroix

Keywords: RealLazyField

`RealLazyField` exhibits the following bug on 8.4 stable and on development branch:


```
sage: float(sin(RLF.pi()))

---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-1-750e6734ef1c> in <module>()
----> 1 float(sin(RLF.pi()))

/home/pat/Software/Sage/sage-git/sage/local/lib/python2.7/site-packages/sage/rings/real_lazy.pyx in sage.rings.real_lazy.LazyNamedUnop.__float__ (build/cythonized/sage/rings/real_lazy.c:16203)()
   1404             0.8414709848078965
   1405         """
-> 1406         return self.eval(float)
   1407 
   1408     def __call__(self, *args):

/home/pat/Software/Sage/sage-git/sage/local/lib/python2.7/site-packages/sage/rings/real_lazy.pyx in sage.rings.real_lazy.LazyNamedUnop.eval (build/cythonized/sage/rings/real_lazy.c:15520)()
   1348             2.0
   1349         """
-> 1350         arg = self._arg.eval(R)
   1351         cdef bint has_extra_args = self._extra_args is not None and len(self._extra_args) > 0
   1352         if type(R) is type:

/home/pat/Software/Sage/sage-git/sage/local/lib/python2.7/site-packages/sage/rings/real_lazy.pyx in sage.rings.real_lazy.LazyConstant.eval (build/cythonized/sage/rings/real_lazy.c:16924)()
   1490                 else:
   1491                     raise TypeError("The complex constant I is not in this real field.")
-> 1492         f = getattr(R, self._name)
   1493         if self._extra_args is None:
   1494             return f()

AttributeError: type object 'float' has no attribute 'pi'
```


The same issue appears with RDF replacing float.

Vincent noted that the following works fine:


```
sage: (sin(RLF.pi())).eval(RDF)
 1.2246467991473515e-16
```


On the other hand I get:

```
sage: (sin(RLF.pi())).eval(float)

---------------------------------------------------------------------------
AttributeError...
```




---

Comment by vdelecroix created at 2018-12-06 17:44:05

This is already visible without the `sin`

```
sage: RLF.pi().eval(float)
AttributeError                            Traceback (most recent call last)
.../sage/rings/real_lazy.pyx
in sage.rings.real_lazy.LazyConstant.eval
(build/cythonized/sage/rings/real_lazy.c:16446)()
   1467         self._is_special = name in ['e', 'I']
   1468 
-> 1469     cpdef eval(self, R):
   1470         """
   1471         Convert ``self`` into an element of ``R``.

...sage/rings/real_lazy.pyx
in sage.rings.real_lazy.LazyConstant.eval
(build/cythonized/sage/rings/real_lazy.c:16329)()
   1490                 else:
   1491                     raise TypeError("The complex constant I is not in this real field.")
-> 1492         f = getattr(R, self._name)
   1493         if self._extra_args is None:
   1494             return f()

AttributeError: type object 'float' has no attribute 'pi'
```



---

Comment by vdelecroix created at 2018-12-06 17:59:47

New commits:


---

Comment by vdelecroix created at 2018-12-06 17:59:47

Changing status from new to needs_review.


---

Comment by git created at 2018-12-07 07:05:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2018-12-11 12:36:09

Pat, can you make the review?


---

Comment by slabbe created at 2018-12-11 14:58:59

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-12-23 10:12:35

There are some numerical noise issues, see patchbot.


---

Comment by vbraun created at 2018-12-23 10:12:35

Changing status from positive_review to needs_work.


---

Comment by slabbe created at 2018-12-31 13:01:06

Indeed:

```
----------------------------------------------------------------------
sage -t --long src/sage/rings/real_lazy.pyx  # 1 doctest failed
----------------------------------------------------------------------
```


For reference, I am copying the failure below:


```
Only doctesting files that failed last test.
Doctesting 2 files using 8 threads.
sage -t --long src/sage/rings/real_lazy.pxd
    [0 tests, 0.00 s]
sage -t --long src/sage/rings/real_lazy.pyx
**********************************************************************
File "src/sage/rings/real_lazy.pyx", line 1495, in sage.rings.real_lazy.LazyConstant.eval
Failed example:
    RLF.pi().eval(RealBallField(128))
Expected:
    [3.1415926535897932384626433832795028842 +/- 1.65e-38]
Got:
    [3.1415926535897932384626433832795028842 +/- 1.06e-38]
**********************************************************************
1 item had failures:
   1 of  12 in sage.rings.real_lazy.LazyConstant.eval
    [285 tests, 1 failure, 0.56 s]
----------------------------------------------------------------------
sage -t --long src/sage/rings/real_lazy.pyx  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by slabbe created at 2018-12-31 13:08:19

On my laptop running 8.5.beta4, I get radius `1.65e-38` with 128 and `1.06e-38` with 129.


```
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 8.5.beta4, Release Date: 2018-11-18               │
│ Using Python 2.7.15. Type "help()" for help.                       │
└────────────────────────────────────────────────────────────────────┘
sage: RLF.pi().eval(RealBallField(127))
[3.1415926535897932384626433832795028842 +/- 4.00e-38]
sage: RLF.pi().eval(RealBallField(128))
[3.1415926535897932384626433832795028842 +/- 1.65e-38]
sage: RLF.pi().eval(RealBallField(129))
[3.1415926535897932384626433832795028842 +/- 1.06e-38]
sage: RLF.pi().eval(RealBallField(130))
[3.14159265358979323846264338327950288420 +/- 7.66e-39]
```


On another machine running more recent 8.5.rc0, I get the failure:


```
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 8.5.rc0, Release Date: 2018-12-10                 │
│ Using Python 2.7.15. Type "help()" for help.                       │
└────────────────────────────────────────────────────────────────────┘
sage: RLF.pi().eval(RealBallField(127))
[3.1415926535897932384626433832795028842 +/- 1.88e-38]
sage: RLF.pi().eval(RealBallField(128))
[3.1415926535897932384626433832795028842 +/- 1.06e-38]
sage: RLF.pi().eval(RealBallField(129))
[3.14159265358979323846264338327950288420 +/- 7.66e-39]
sage: RLF.pi().eval(RealBallField(130))
[3.14159265358979323846264338327950288420 +/- 3.25e-39]
```


Finally, running Sage with Python 3, I get the failure too:


```
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 8.5, Release Date: 2018-12-22                     │
│ Using Python 3.6.6. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
AA.options.display_format = 'radical'
sage: RLF.pi().eval(RealBallField(127))
[3.1415926535897932384626433832795028842 +/- 1.88e-38]
sage: RLF.pi().eval(RealBallField(128))
[3.1415926535897932384626433832795028842 +/- 1.06e-38]
sage: RLF.pi().eval(RealBallField(129))
[3.14159265358979323846264338327950288420 +/- 7.66e-39]
sage: RLF.pi().eval(RealBallField(130))
[3.14159265358979323846264338327950288420 +/- 3.25e-39]
```


Did the version of `RealBallField` changed between 8.5.beta4 and 8.5.rc0?


---

Comment by vdelecroix created at 2018-12-31 13:18:16

#24369 ?


---

Comment by vdelecroix created at 2018-12-31 13:19:26

#26360: Upgrade arb to 2.15.1 ?


---

Comment by slabbe created at 2018-12-31 13:21:07

When I reviewed this ticket (no failures), I was using `8.5.beta6`.


---

Comment by slabbe created at 2018-12-31 13:25:11

Replying to [comment:10 vdelecroix]:
> #26360: Upgrade arb to 2.15.1 ?

Looks like it, merged in 8.5.rc0 which is just between 8.5.beta6 and 8.5.


---

Comment by git created at 2018-12-31 13:30:20

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2018-12-31 13:30:36

Changing status from needs_work to needs_review.


---

Comment by slabbe created at 2018-12-31 13:31:09

Note that all doctests were fixed as follows in #26360:


```diff
-            [1.333333333333333 +/- 5.37e-16]
+            [1.333333333333333 +/- ...e-16]
```


Do you want to do the same here?


---

Comment by vdelecroix created at 2018-12-31 13:35:33

I don't think it was a good move. Tracking arb enclosure regression/improvement is worth the trouble (see eg https://github.com/fredrik-johansson/arb/issues/227).


---

Comment by slabbe created at 2018-12-31 14:00:45

Changing status from needs_review to positive_review.


---

Comment by slabbe created at 2018-12-31 14:00:45

ok


---

Comment by vbraun created at 2019-01-23 14:17:50

Resolution: fixed
