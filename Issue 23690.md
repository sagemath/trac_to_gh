# Issue 23690: discrete log takes a huge amount of time in some cases

Issue created by migration from https://trac.sagemath.org/ticket/23927

Original creator: zimmerma

Original creation time: 2017-09-25 13:26:33

CC:  cremona jdemeyer

for some inputs, the discrete log can take a huge amount of time, whereas for other similar inputs it takes negligible time. Here is a first example that takes negligible time (with Sage 8.0):

```
sage: time mod(17,10^15+37).log(3)
CPU times: user 48 ms, sys: 0 ns, total: 48 ms
Wall time: 53.3 ms
502952226729022
```

Now consider this other computation modulo a very near prime:

```
sage: time mod(17,10^15+56719).log(3)
CPU times: user 1min 3s, sys: 1.42 s, total: 1min 5s
Wall time: 1min 6s
420536002305675
```

If we directly call the Pari/GP discrete log function, it is much faster:

```
sage: time gp.znlog(17,mod(3,10^15+56719))
CPU times: user 16 ms, sys: 4 ms, total: 20 ms
Wall time: 130 ms
420536002305675
```

Why don't we call the Pari/GP function?


---

Comment by mderickx created at 2017-09-25 17:20:27

Hi,

I just looked at the source code, and it seems that this happens because 3 is not a generator of  `Integers(10^15+56719)`, sage already calls pari, but falls back to a generic implementation if the base is not a generator of the unit group. 

```
sage: time mod(17,10^15+56719).log(7)
CPU times: user 45.3 ms, sys: 786 Âµs, total: 46.1 ms
Wall time: 46.2 ms
502331130239286
```

This might stem from a time where pari could not handle this case yet. I'm writing a patch that should fix this.


Note that the running time is not really the worst thing, the memory usage of python reaches a peak of about 4GB during the execution of
`mod(17,10^15+56719).log(3)`.


---

Comment by mderickx created at 2017-09-25 19:46:10

Here a fix, it passes all doctests in `src/sage/rings` for me, I leave the rest to the patchbot.
----
New commits:


---

Comment by mderickx created at 2017-09-25 19:46:10

Changing status from new to needs_review.


---

Comment by mderickx created at 2017-09-25 19:51:14

The added doctest to check that this tickets is fixed should take about 0.3 seconds with the patch. It tests that this ticket is fixed because it does not return within the standard doctest timeout setting without the fix.


---

Comment by zimmerma created at 2017-09-26 07:21:34

Changing status from needs_review to needs_work.


---

Comment by zimmerma created at 2017-09-26 07:21:34

I see some failures in the patchbot doctests. Needs work?


---

Comment by git created at 2017-09-26 13:39:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mderickx created at 2017-09-26 13:42:13

It seems to me only one failure was due to this ticket, and I fixed that one. 
I created #23930 for one of the other doctest failures.
----
New commits:


---

Comment by mderickx created at 2017-09-26 13:42:13

Changing status from needs_work to needs_review.


---

Comment by mderickx created at 2017-09-26 14:54:37

Ok, all the doctest failures that were not due to this ticket are now listed at the meta ticket for known patchbot failures #23832 .


---

Comment by zimmerma created at 2017-09-27 08:51:38

Changing status from needs_review to positive_review.


---

Comment by zimmerma created at 2017-09-27 08:51:38

seems good to me: positive review. Thanks!


---

Comment by vbraun created at 2017-10-01 00:18:47

Resolution: fixed
