# Issue 27664: building libgd must fail if it does not get all of its dependencies

archive/issues_027664.json:
```json
{
    "body": "CC:  enriqueartal\n\nWe get errors like libpng not being linked to libgd, and then oops, \nthings get broken.\n\nIssue created by migration from https://trac.sagemath.org/ticket/27901\n\n",
    "created_at": "2019-05-30T22:01:12Z",
    "labels": [
        "build",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "building libgd must fail if it does not get all of its dependencies",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27664",
    "user": "dimpase"
}
```
CC:  enriqueartal

We get errors like libpng not being linked to libgd, and then oops, 
things get broken.

Issue created by migration from https://trac.sagemath.org/ticket/27901





---

archive/issue_comments_390573.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2019-05-31T12:51:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27664#issuecomment-390573",
    "user": "embray"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_390574.json:
```json
{
    "body": "Perhaps purely out of personal interest I'm moving this up to blocker.",
    "created_at": "2019-05-31T12:51:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27664#issuecomment-390574",
    "user": "embray"
}
```

Perhaps purely out of personal interest I'm moving this up to blocker.



---

archive/issue_comments_390575.json:
```json
{
    "body": "Changing keywords from \"\" to \"libgd libpng cygwin macos\".",
    "created_at": "2019-05-31T12:51:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27664#issuecomment-390575",
    "user": "embray"
}
```

Changing keywords from "" to "libgd libpng cygwin macos".



---

archive/issue_comments_390576.json:
```json
{
    "body": "Okay, at least as described this is not the problem I'm having.  Upon rebuilding libgd I get the following configuration:\n\n\n```\n[libgd-2.1.1.1.p1] ** Configuration summary for libgd ..:\n[libgd-2.1.1.1.p1]\n[libgd-2.1.1.1.p1]    Support for Zlib:                 yes\n[libgd-2.1.1.1.p1]    Support for PNG library:          yes\n[libgd-2.1.1.1.p1]    Support for JPEG library:         no\n[libgd-2.1.1.1.p1]    Support for VPX library:          yes\n[libgd-2.1.1.1.p1]    Support for TIFF library:         yes\n[libgd-2.1.1.1.p1]    Support for Freetype 2.x library: yes\n[libgd-2.1.1.1.p1]    Support for Fontconfig library:   no\n[libgd-2.1.1.1.p1]    Support for Xpm library:          no\n[libgd-2.1.1.1.p1]    Support for pthreads:             yes\n```\n\n\nI assume we don't care about JPEG?",
    "created_at": "2019-05-31T13:36:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27664#issuecomment-390576",
    "user": "embray"
}
```

Okay, at least as described this is not the problem I'm having.  Upon rebuilding libgd I get the following configuration:


```
[libgd-2.1.1.1.p1] ** Configuration summary for libgd ..:
[libgd-2.1.1.1.p1]
[libgd-2.1.1.1.p1]    Support for Zlib:                 yes
[libgd-2.1.1.1.p1]    Support for PNG library:          yes
[libgd-2.1.1.1.p1]    Support for JPEG library:         no
[libgd-2.1.1.1.p1]    Support for VPX library:          yes
[libgd-2.1.1.1.p1]    Support for TIFF library:         yes
[libgd-2.1.1.1.p1]    Support for Freetype 2.x library: yes
[libgd-2.1.1.1.p1]    Support for Fontconfig library:   no
[libgd-2.1.1.1.p1]    Support for Xpm library:          no
[libgd-2.1.1.1.p1]    Support for pthreads:             yes
```


I assume we don't care about JPEG?



---

archive/issue_comments_390577.json:
```json
{
    "body": "I got curious about what we actually *use* libgd for in the first place.  Apparently it is only used in some little-used(??  I see no use within Sage itself...) to bitmap matrices in Z_2 to a PNG image.  Maybe sometimes interesting to look at, but does anyone use this?  And is there any reason we explicitly need this library to do it efficiently?\n\nIt really looks like the only thing it's used for.  Apparently there is also some support for unpickling a matrix from such a PNG image.  Weird.",
    "created_at": "2019-05-31T13:52:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27664#issuecomment-390577",
    "user": "embray"
}
```

I got curious about what we actually *use* libgd for in the first place.  Apparently it is only used in some little-used(??  I see no use within Sage itself...) to bitmap matrices in Z_2 to a PNG image.  Maybe sometimes interesting to look at, but does anyone use this?  And is there any reason we explicitly need this library to do it efficiently?

It really looks like the only thing it's used for.  Apparently there is also some support for unpickling a matrix from such a PNG image.  Weird.



---

archive/issue_comments_390578.json:
```json
{
    "body": "So in my case I have a libgd that *is* compiled with PNG support, and linked against the libpng16 in Sage, at least presumably, and it still fails to load.\n\nIf, out of curiosity, I manually comment out all the parts of matrix_mod2_dense.pyx that use libgd, and remove its requirement from the link flags for that module, it imports fine.  So there is definitely *something* about the libgd requirement that is blowing up, but I can't figure out easily what it is for some reason.\n\nI'm trying now with rebuilding libpng (and in turn all its dependents of which there are many) in the off chance that can tell me anything...",
    "created_at": "2019-05-31T14:14:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27664#issuecomment-390578",
    "user": "embray"
}
```

So in my case I have a libgd that *is* compiled with PNG support, and linked against the libpng16 in Sage, at least presumably, and it still fails to load.

If, out of curiosity, I manually comment out all the parts of matrix_mod2_dense.pyx that use libgd, and remove its requirement from the link flags for that module, it imports fine.  So there is definitely *something* about the libgd requirement that is blowing up, but I can't figure out easily what it is for some reason.

I'm trying now with rebuilding libpng (and in turn all its dependents of which there are many) in the off chance that can tell me anything...



---

archive/issue_comments_390579.json:
```json
{
    "body": "Still having some very bizarre problems related to loading `matrix_mod2_dense.dll`, and in turn `cyggd-3.dll`.  I can't make heads or tails out of it.  I've tried going back to older versions, even back to 8.7 final (which always worked) I'm still getting the problem.\n\nI even hypothesized whether it was a problem with using some of the system libraries for xz, bz2, or more likely zlib, but even disabling those (and building them in Sage) didn't make the problem go away.\n\nMeanwhile, I have a build of Sage in another directory where I experimented with using the system libgd (#27825) and it works!  No problem.\n\nAt the very least that's a point in favor of moving forward on #27825.  But this is still very fishy and I need to get to the bottom of it.  It turns out I will likely need to use WinDBG to have any hope of seeing what's going wrong here.",
    "created_at": "2019-06-07T17:30:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27664#issuecomment-390579",
    "user": "embray"
}
```

Still having some very bizarre problems related to loading `matrix_mod2_dense.dll`, and in turn `cyggd-3.dll`.  I can't make heads or tails out of it.  I've tried going back to older versions, even back to 8.7 final (which always worked) I'm still getting the problem.

I even hypothesized whether it was a problem with using some of the system libraries for xz, bz2, or more likely zlib, but even disabling those (and building them in Sage) didn't make the problem go away.

Meanwhile, I have a build of Sage in another directory where I experimented with using the system libgd (#27825) and it works!  No problem.

At the very least that's a point in favor of moving forward on #27825.  But this is still very fishy and I need to get to the bottom of it.  It turns out I will likely need to use WinDBG to have any hope of seeing what's going wrong here.



---

archive/issue_comments_390580.json:
```json
{
    "body": "The Cygwin problem I was discussing here is fixed by #27970, ironically due to libgd using too many (more than necessary) of its possible dependencies.",
    "created_at": "2019-06-11T20:34:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27664#issuecomment-390580",
    "user": "embray"
}
```

The Cygwin problem I was discussing here is fixed by #27970, ironically due to libgd using too many (more than necessary) of its possible dependencies.



---

archive/issue_comments_390581.json:
```json
{
    "body": "Moving open critical and blocker issues to the next release milestone (optimistically).",
    "created_at": "2019-07-03T11:39:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27664#issuecomment-390581",
    "user": "embray"
}
```

Moving open critical and blocker issues to the next release milestone (optimistically).



---

archive/issue_comments_390582.json:
```json
{
    "body": "Any progress here? This doesn't seem to be affecting a lot of users, I don't think it should be a blocker. But if a fix materializes real soon then I'm open to merging it...",
    "created_at": "2019-09-15T12:13:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27664#issuecomment-390582",
    "user": "vbraun"
}
```

Any progress here? This doesn't seem to be affecting a lot of users, I don't think it should be a blocker. But if a fix materializes real soon then I'm open to merging it...



---

archive/issue_comments_390583.json:
```json
{
    "body": "Changing priority from blocker to major.",
    "created_at": "2019-09-15T12:25:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27664#issuecomment-390583",
    "user": "dimpase"
}
```

Changing priority from blocker to major.



---

archive/issue_comments_390584.json:
```json
{
    "body": "We should check, somehow, (in the `spkg-build`/`spkg-install` for libgd?) that it properly detected and built with libpng support.  Other than PNG I don't think we care about any of the other dependencies.",
    "created_at": "2019-09-18T11:14:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27664#issuecomment-390584",
    "user": "embray"
}
```

We should check, somehow, (in the `spkg-build`/`spkg-install` for libgd?) that it properly detected and built with libpng support.  Other than PNG I don't think we care about any of the other dependencies.



---

archive/issue_comments_390585.json:
```json
{
    "body": "hmm, do you mean \"check in `spkg-configure.m4` of `libgd`\"?",
    "created_at": "2019-09-18T20:31:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27664#issuecomment-390585",
    "user": "dimpase"
}
```

hmm, do you mean "check in `spkg-configure.m4` of `libgd`"?



---

archive/issue_comments_390586.json:
```json
{
    "body": "Workaround for the\n\n```\n[...]\n/usr/bin/ld: /usr/lib64/libvmaf.so.0: undefined reference to `std::__throw_bad_array_new_length()@GLIBCXX_3.4.29'\ncollect2: error: ld returned 1 exit status\nmake[2]: *** [Makefile:831: gdcmpgif] Error 1\nmake[2]: Leaving directory '/home/release/Sage/local/var/tmp/sage/build/libgd-2.3.2/src/src'\nmake[1]: *** [Makefile:644: all] Error 2\nmake[1]: Leaving directory '/home/release/Sage/local/var/tmp/sage/build/libgd-2.3.2/src/src'\nmake: *** [Makefile:426: all-recursive] Error 1\n********************************************************************************************************************************************************************\nError building libgd-2.3.2\n********************************************************************************************************************************************************************\n```\n\non Fedora 34 is to set\n\n```\nLIBGD_CONFIGURE=--without-avif\n```\n",
    "created_at": "2021-05-29T23:39:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27664#issuecomment-390586",
    "user": "vbraun"
}
```

Workaround for the

```
[...]
/usr/bin/ld: /usr/lib64/libvmaf.so.0: undefined reference to `std::__throw_bad_array_new_length()@GLIBCXX_3.4.29'
collect2: error: ld returned 1 exit status
make[2]: *** [Makefile:831: gdcmpgif] Error 1
make[2]: Leaving directory '/home/release/Sage/local/var/tmp/sage/build/libgd-2.3.2/src/src'
make[1]: *** [Makefile:644: all] Error 2
make[1]: Leaving directory '/home/release/Sage/local/var/tmp/sage/build/libgd-2.3.2/src/src'
make: *** [Makefile:426: all-recursive] Error 1
********************************************************************************************************************************************************************
Error building libgd-2.3.2
********************************************************************************************************************************************************************
```

on Fedora 34 is to set

```
LIBGD_CONFIGURE=--without-avif
```




---

archive/issue_comments_390587.json:
```json
{
    "body": "Confirmed, sage 9.4.beta0 compiles with that option. I declared it using `export LIBGD_CONFIGURE=--without-avif`",
    "created_at": "2021-05-30T08:35:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27664#issuecomment-390587",
    "user": "enriqueartal"
}
```

Confirmed, sage 9.4.beta0 compiles with that option. I declared it using `export LIBGD_CONFIGURE=--without-avif`



---

archive/issue_comments_390588.json:
```json
{
    "body": "I've made a patch at #31879",
    "created_at": "2021-05-30T17:04:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27664#issuecomment-390588",
    "user": "vbraun"
}
```

I've made a patch at #31879
