# Issue 24143: sympy misbehavoir with gmpy2 installed

archive/issues_024143.json:
```json
{
    "body": "CC:  @jdemeyer @kiwifb\n\nWith gmpy2 installed, the following gets wrong\n\n```\nsage: from sympy.polys import CRootOf, Poly\nsage: p = Poly((x^2 - 2.0)._sympy_())\nsage: cr = CRootOf(p, 1)\nTypeError                                 Traceback (most recent call last)\n<ipython-input-12-bec020a04b58> in <module>()\n----> 1 cr = CRootOf(p, Integer(1))\n\n/opt/sage/local/lib/python2.7/site-packages/sympy/polys/rootoftools.pyc in __new__(cls, f, x, index, radicals, expand)\n    137 \n    138         if not dom.is_Exact:\n--> 139             poly = poly.to_exact()\n    140 \n    141         roots = cls._roots_trivial(poly, radicals)\n\n/opt/sage/local/lib/python2.7/site-packages/sympy/polys/polytools.pyc in to_exact(f)\n    729         \"\"\"\n    730         if hasattr(f.rep, 'to_exact'):\n--> 731             result = f.rep.to_exact()\n    732         else:  # pragma: no cover\n    733             raise OperationNotSupported(f, 'to_exact')\n\n/opt/sage/local/lib/python2.7/site-packages/sympy/polys/polyclasses.pyc in to_exact(f)\n    274     def to_exact(f):\n    275         \"\"\"Make the ground domain exact. \"\"\"\n--> 276         return f.convert(f.dom.get_exact())\n    277 \n    278     def convert(f, dom):\n\n/opt/sage/local/lib/python2.7/site-packages/sympy/polys/polyclasses.pyc in convert(f, dom)\n    281             return f\n    282         else:\n--> 283             return DMP(dmp_convert(f.rep, f.lev, f.dom, dom), dom, f.lev)\n    284 \n    285     def slice(f, m, n, j=0):\n\n/opt/sage/local/lib/python2.7/site-packages/sympy/polys/densebasic.pyc in dmp_convert(f, u, K0, K1)\n    562     \"\"\"\n    563     if not u:\n--> 564         return dup_convert(f, K0, K1)\n    565     if K0 is not None and K0 == K1:\n    566         return f\n\n/opt/sage/local/lib/python2.7/site-packages/sympy/polys/densebasic.pyc in dup_convert(f, K0, K1)\n    539         return f\n    540     else:\n--> 541         return dup_strip([ K1.convert(c, K0) for c in f ])\n    542 \n    543 \n\n/opt/sage/local/lib/python2.7/site-packages/sympy/polys/domains/domain.pyc in convert(self, element, base)\n    107         \"\"\"Convert ``element`` to ``self.dtype``. \"\"\"\n    108         if base is not None:\n--> 109             return self.convert_from(element, base)\n    110 \n    111         if self.of_type(element):\n\n/opt/sage/local/lib/python2.7/site-packages/sympy/polys/domains/domain.pyc in convert_from(self, element, base)\n     97 \n     98         if _convert is not None:\n---> 99             result = _convert(element, base)\n    100 \n    101             if result is not None:\n\n/opt/sage/local/lib/python2.7/site-packages/sympy/polys/domains/gmpyrationalfield.pyc in from_RealField(K1, a, K0)\n     63     def from_RealField(K1, a, K0):\n     64         \"\"\"Convert a mpmath `mpf` object to `dtype`. \"\"\"\n---> 65         return GMPYRational(*K0.to_rational(a))\n     66 \n     67     def exquo(self, a, b):\n\nTypeError: mpq() requires numeric or string argument\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/24380\n\n",
    "created_at": "2017-12-15T11:37:49Z",
    "labels": [
        "component: packages: standard",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "sympy misbehavoir with gmpy2 installed",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24143",
    "user": "https://github.com/videlec"
}
```
CC:  @jdemeyer @kiwifb

With gmpy2 installed, the following gets wrong

```
sage: from sympy.polys import CRootOf, Poly
sage: p = Poly((x^2 - 2.0)._sympy_())
sage: cr = CRootOf(p, 1)
TypeError                                 Traceback (most recent call last)
<ipython-input-12-bec020a04b58> in <module>()
----> 1 cr = CRootOf(p, Integer(1))

/opt/sage/local/lib/python2.7/site-packages/sympy/polys/rootoftools.pyc in __new__(cls, f, x, index, radicals, expand)
    137 
    138         if not dom.is_Exact:
--> 139             poly = poly.to_exact()
    140 
    141         roots = cls._roots_trivial(poly, radicals)

/opt/sage/local/lib/python2.7/site-packages/sympy/polys/polytools.pyc in to_exact(f)
    729         """
    730         if hasattr(f.rep, 'to_exact'):
--> 731             result = f.rep.to_exact()
    732         else:  # pragma: no cover
    733             raise OperationNotSupported(f, 'to_exact')

/opt/sage/local/lib/python2.7/site-packages/sympy/polys/polyclasses.pyc in to_exact(f)
    274     def to_exact(f):
    275         """Make the ground domain exact. """
--> 276         return f.convert(f.dom.get_exact())
    277 
    278     def convert(f, dom):

/opt/sage/local/lib/python2.7/site-packages/sympy/polys/polyclasses.pyc in convert(f, dom)
    281             return f
    282         else:
--> 283             return DMP(dmp_convert(f.rep, f.lev, f.dom, dom), dom, f.lev)
    284 
    285     def slice(f, m, n, j=0):

/opt/sage/local/lib/python2.7/site-packages/sympy/polys/densebasic.pyc in dmp_convert(f, u, K0, K1)
    562     """
    563     if not u:
--> 564         return dup_convert(f, K0, K1)
    565     if K0 is not None and K0 == K1:
    566         return f

/opt/sage/local/lib/python2.7/site-packages/sympy/polys/densebasic.pyc in dup_convert(f, K0, K1)
    539         return f
    540     else:
--> 541         return dup_strip([ K1.convert(c, K0) for c in f ])
    542 
    543 

/opt/sage/local/lib/python2.7/site-packages/sympy/polys/domains/domain.pyc in convert(self, element, base)
    107         """Convert ``element`` to ``self.dtype``. """
    108         if base is not None:
--> 109             return self.convert_from(element, base)
    110 
    111         if self.of_type(element):

/opt/sage/local/lib/python2.7/site-packages/sympy/polys/domains/domain.pyc in convert_from(self, element, base)
     97 
     98         if _convert is not None:
---> 99             result = _convert(element, base)
    100 
    101             if result is not None:

/opt/sage/local/lib/python2.7/site-packages/sympy/polys/domains/gmpyrationalfield.pyc in from_RealField(K1, a, K0)
     63     def from_RealField(K1, a, K0):
     64         """Convert a mpmath `mpf` object to `dtype`. """
---> 65         return GMPYRational(*K0.to_rational(a))
     66 
     67     def exquo(self, a, b):

TypeError: mpq() requires numeric or string argument
```


Issue created by migration from https://trac.sagemath.org/ticket/24380





---

archive/issue_comments_338049.json:
```json
{
    "body": "Updating sympy to the development version makes it working\n\n```\nsage: import sympy, sympy.polys\nsage: sympy.__version__\n'1.1.2.dev'\nsage: x = sympy.Symbol('x')\nsage: p = sympy.polys.Poly(x**2 - 2.0)\nsage: p\nPoly(1.0*x**2 - 2.0, x, domain='RR')\nsage: p.coeffs()\n[1.00000000000000, -2.00000000000000]\nsage: map(type,p.coeffs())\n[<class 'sympy.core.numbers.Float'>, <class 'sympy.core.numbers.Float'>]\n```\n",
    "created_at": "2017-12-15T13:53:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24143",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24143#issuecomment-338049",
    "user": "https://github.com/videlec"
}
```

Updating sympy to the development version makes it working

```
sage: import sympy, sympy.polys
sage: sympy.__version__
'1.1.2.dev'
sage: x = sympy.Symbol('x')
sage: p = sympy.polys.Poly(x**2 - 2.0)
sage: p
Poly(1.0*x**2 - 2.0, x, domain='RR')
sage: p.coeffs()
[1.00000000000000, -2.00000000000000]
sage: map(type,p.coeffs())
[<class 'sympy.core.numbers.Float'>, <class 'sympy.core.numbers.Float'>]
```




---

archive/issue_comments_338050.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-12-15T14:07:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24143",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24143#issuecomment-338050",
    "user": "https://github.com/videlec"
}
```

New commits:



---

archive/issue_comments_338051.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-12-15T14:07:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24143",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24143#issuecomment-338051",
    "user": "https://github.com/videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_338052.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-12-15T14:07:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24143",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24143#issuecomment-338052",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_338053.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-12-15T14:11:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24143",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24143#issuecomment-338053",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_338054.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-12-16T08:57:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24143",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24143#issuecomment-338054",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_338055.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-12-17T07:05:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24143",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24143#issuecomment-338055",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_338056.json:
```json
{
    "body": "LGTM.",
    "created_at": "2017-12-17T07:05:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24143",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24143#issuecomment-338056",
    "user": "https://github.com/rwst"
}
```

LGTM.



---

archive/issue_comments_338057.json:
```json
{
    "body": "Not changing the status, but would you mind adding upstream info about this? Issues number and/or PR number.",
    "created_at": "2017-12-17T20:46:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24143",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24143#issuecomment-338057",
    "user": "https://github.com/kiwifb"
}
```

Not changing the status, but would you mind adding upstream info about this? Issues number and/or PR number.



---

archive/issue_comments_338058.json:
```json
{
    "body": "OK, found it myself and added to description for future reference.",
    "created_at": "2017-12-17T20:59:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24143",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24143#issuecomment-338058",
    "user": "https://github.com/kiwifb"
}
```

OK, found it myself and added to description for future reference.



---

archive/issue_comments_338059.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-12-18T19:39:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24143",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24143#issuecomment-338059",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_061643.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-12-18T19:39:09Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24143",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24143#event-61643"
}
```
