# Issue 24143: sympy misbehavoir with gmpy2 installed

Issue created by migration from https://trac.sagemath.org/ticket/24380

Original creator: vdelecroix

Original creation time: 2017-12-15 11:37:49

CC:  jdemeyer fbissey

With gmpy2 installed, the following gets wrong

```
sage: from sympy.polys import CRootOf, Poly
sage: p = Poly((x^2 - 2.0)._sympy_())
sage: cr = CRootOf(p, 1)
TypeError                                 Traceback (most recent call last)
<ipython-input-12-bec020a04b58> in <module>()
----> 1 cr = CRootOf(p, Integer(1))

/opt/sage/local/lib/python2.7/site-packages/sympy/polys/rootoftools.pyc in __new__(cls, f, x, index, radicals, expand)
    137 
    138         if not dom.is_Exact:
--> 139             poly = poly.to_exact()
    140 
    141         roots = cls._roots_trivial(poly, radicals)

/opt/sage/local/lib/python2.7/site-packages/sympy/polys/polytools.pyc in to_exact(f)
    729         """
    730         if hasattr(f.rep, 'to_exact'):
--> 731             result = f.rep.to_exact()
    732         else:  # pragma: no cover
    733             raise OperationNotSupported(f, 'to_exact')

/opt/sage/local/lib/python2.7/site-packages/sympy/polys/polyclasses.pyc in to_exact(f)
    274     def to_exact(f):
    275         """Make the ground domain exact. """
--> 276         return f.convert(f.dom.get_exact())
    277 
    278     def convert(f, dom):

/opt/sage/local/lib/python2.7/site-packages/sympy/polys/polyclasses.pyc in convert(f, dom)
    281             return f
    282         else:
--> 283             return DMP(dmp_convert(f.rep, f.lev, f.dom, dom), dom, f.lev)
    284 
    285     def slice(f, m, n, j=0):

/opt/sage/local/lib/python2.7/site-packages/sympy/polys/densebasic.pyc in dmp_convert(f, u, K0, K1)
    562     """
    563     if not u:
--> 564         return dup_convert(f, K0, K1)
    565     if K0 is not None and K0 == K1:
    566         return f

/opt/sage/local/lib/python2.7/site-packages/sympy/polys/densebasic.pyc in dup_convert(f, K0, K1)
    539         return f
    540     else:
--> 541         return dup_strip([ K1.convert(c, K0) for c in f ])
    542 
    543 

/opt/sage/local/lib/python2.7/site-packages/sympy/polys/domains/domain.pyc in convert(self, element, base)
    107         """Convert ``element`` to ``self.dtype``. """
    108         if base is not None:
--> 109             return self.convert_from(element, base)
    110 
    111         if self.of_type(element):

/opt/sage/local/lib/python2.7/site-packages/sympy/polys/domains/domain.pyc in convert_from(self, element, base)
     97 
     98         if _convert is not None:
---> 99             result = _convert(element, base)
    100 
    101             if result is not None:

/opt/sage/local/lib/python2.7/site-packages/sympy/polys/domains/gmpyrationalfield.pyc in from_RealField(K1, a, K0)
     63     def from_RealField(K1, a, K0):
     64         """Convert a mpmath `mpf` object to `dtype`. """
---> 65         return GMPYRational(*K0.to_rational(a))
     66 
     67     def exquo(self, a, b):

TypeError: mpq() requires numeric or string argument
```



---

Comment by vdelecroix created at 2017-12-15 13:53:22

Updating sympy to the development version makes it working

```
sage: import sympy, sympy.polys
sage: sympy.__version__
'1.1.2.dev'
sage: x = sympy.Symbol('x')
sage: p = sympy.polys.Poly(x**2 - 2.0)
sage: p
Poly(1.0*x**2 - 2.0, x, domain='RR')
sage: p.coeffs()
[1.00000000000000, -2.00000000000000]
sage: map(type,p.coeffs())
[<class 'sympy.core.numbers.Float'>, <class 'sympy.core.numbers.Float'>]
```



---

Comment by vdelecroix created at 2017-12-15 14:07:25

New commits:


---

Comment by vdelecroix created at 2017-12-15 14:07:25

Changing status from new to needs_review.


---

Comment by git created at 2017-12-15 14:07:45

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-12-15 14:11:40

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-12-16 08:57:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2017-12-17 07:05:30

Changing status from needs_review to positive_review.


---

Comment by rws created at 2017-12-17 07:05:30

LGTM.


---

Comment by fbissey created at 2017-12-17 20:46:31

Not changing the status, but would you mind adding upstream info about this? Issues number and/or PR number.


---

Comment by fbissey created at 2017-12-17 20:59:31

OK, found it myself and added to description for future reference.


---

Comment by vbraun created at 2017-12-18 19:39:09

Resolution: fixed
