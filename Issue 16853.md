# Issue 16853: Add missing fmpz_init() statements after #16803

archive/issues_016853.json:
```json
{
    "body": "CC:  @vbraun @mmasdeu @williamstein simonking\n\nThe code from #16803 is missing `fmpz_init()`/`fmpz_clear()` in several places. This can cause random segfaults, as witnessed for example in #16938.\n\nIssue created by migration from https://trac.sagemath.org/ticket/17090\n\n",
    "created_at": "2014-10-02T13:59:57Z",
    "labels": [
        "linear algebra",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "Add missing fmpz_init() statements after #16803",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16853",
    "user": "@jdemeyer"
}
```
CC:  @vbraun @mmasdeu @williamstein simonking

The code from #16803 is missing `fmpz_init()`/`fmpz_clear()` in several places. This can cause random segfaults, as witnessed for example in #16938.

Issue created by migration from https://trac.sagemath.org/ticket/17090





---

archive/issue_comments_223079.json:
```json
{
    "body": "Flint has a `--enable-assert` configure switch to turn on assertions which should be handy for debugging.",
    "created_at": "2014-10-02T14:14:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223079",
    "user": "@vbraun"
}
```

Flint has a `--enable-assert` configure switch to turn on assertions which should be handy for debugging.



---

archive/issue_comments_223080.json:
```json
{
    "body": "Replying to [comment:3 vbraun]:\n> Flint has a `--enable-assert` configure switch to turn on assertions which should be handy for debugging.\n\n... which should become part of #16938, right?",
    "created_at": "2014-10-02T14:20:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223080",
    "user": "@simon-king-jena"
}
```

Replying to [comment:3 vbraun]:
> Flint has a `--enable-assert` configure switch to turn on assertions which should be handy for debugging.

... which should become part of #16938, right?



---

archive/issue_comments_223081.json:
```json
{
    "body": "I'd prefer to add it here, there is already too much going on at  #16938",
    "created_at": "2014-10-02T14:38:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223081",
    "user": "@vbraun"
}
```

I'd prefer to add it here, there is already too much going on at  #16938



---

archive/issue_comments_223082.json:
```json
{
    "body": "Turns out assertions aren't used that much in flint, I still can't reproduce the crash. \n----\nNew commits:",
    "created_at": "2014-10-02T14:47:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223082",
    "user": "@vbraun"
}
```

Turns out assertions aren't used that much in flint, I still can't reproduce the crash. 
----
New commits:



---

archive/issue_comments_223083.json:
```json
{
    "body": "The problem is that an assertion won't help against uninitialized variables.",
    "created_at": "2014-10-02T15:15:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223083",
    "user": "@jdemeyer"
}
```

The problem is that an assertion won't help against uninitialized variables.



---

archive/issue_comments_223084.json:
```json
{
    "body": "Replying to [comment:9 jdemeyer]:\n> The problem is that an assertion won't help against uninitialized variables.\n\nAnd I thought a debug version would have a paranoid memory management, so that the use of uninitialised variables would result in an immediate abort.",
    "created_at": "2014-10-02T15:21:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223084",
    "user": "@simon-king-jena"
}
```

Replying to [comment:9 jdemeyer]:
> The problem is that an assertion won't help against uninitialized variables.

And I thought a debug version would have a paranoid memory management, so that the use of uninitialised variables would result in an immediate abort.



---

archive/issue_comments_223085.json:
```json
{
    "body": "Why not building a static library, by the way?",
    "created_at": "2014-10-02T15:23:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223085",
    "user": "@simon-king-jena"
}
```

Why not building a static library, by the way?



---

archive/issue_comments_223086.json:
```json
{
    "body": "Because static libraries suck. If you rebuild flint with debugging, is Sage going to use the new shared library or have the old static library compiled in?",
    "created_at": "2014-10-02T15:27:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223086",
    "user": "@vbraun"
}
```

Because static libraries suck. If you rebuild flint with debugging, is Sage going to use the new shared library or have the old static library compiled in?



---

archive/issue_comments_223087.json:
```json
{
    "body": "And yes, I had hoped that flint had some mechanism to ensure that `*_init` is called, but no such luck.",
    "created_at": "2014-10-02T15:28:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223087",
    "user": "@vbraun"
}
```

And yes, I had hoped that flint had some mechanism to ensure that `*_init` is called, but no such luck.



---

archive/issue_comments_223088.json:
```json
{
    "body": "This should fix the problem, but I haven't tested it wth #16938.\n----\nNew commits:",
    "created_at": "2014-10-02T15:32:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223088",
    "user": "@jdemeyer"
}
```

This should fix the problem, but I haven't tested it wth #16938.
----
New commits:



---

archive/issue_comments_223089.json:
```json
{
    "body": "Concerning\n\n```\n+ fmpz_init(z)\n+ fmpz_set_mpz(z, x.value)\n```\n\nIs there no `fmpz_init_set`? I know that there is a combined init-set function for `mpz`, but I don't know about `fmpz`.",
    "created_at": "2014-10-02T17:33:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223089",
    "user": "@simon-king-jena"
}
```

Concerning

```
+ fmpz_init(z)
+ fmpz_set_mpz(z, x.value)
```

Is there no `fmpz_init_set`? I know that there is a combined init-set function for `mpz`, but I don't know about `fmpz`.



---

archive/issue_comments_223090.json:
```json
{
    "body": "There is:\n\n```\n$ grep fmpz_init_set flint-2.4.3/fmpz.h \nvoid fmpz_init_set(fmpz_t f, const fmpz_t g)\nvoid fmpz_init_set_ui(fmpz_t f, ulong g)\nvoid fmpz_init_set_readonly(fmpz_t f, const mpz_t z);\n```\n",
    "created_at": "2014-10-02T17:44:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223090",
    "user": "@vbraun"
}
```

There is:

```
$ grep fmpz_init_set flint-2.4.3/fmpz.h 
void fmpz_init_set(fmpz_t f, const fmpz_t g)
void fmpz_init_set_ui(fmpz_t f, ulong g)
void fmpz_init_set_readonly(fmpz_t f, const mpz_t z);
```




---

archive/issue_comments_223091.json:
```json
{
    "body": "Replying to [comment:17 vbraun]:\n> There is:\n> {{{\n> $ grep fmpz_init_set flint-2.4.3/fmpz.h \n> void fmpz_init_set(fmpz_t f, const fmpz_t g)\n> void fmpz_init_set_ui(fmpz_t f, ulong g)\n> void fmpz_init_set_readonly(fmpz_t f, const mpz_t z);\n> }}}\n\nI think it should be used.",
    "created_at": "2014-10-02T17:51:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223091",
    "user": "@simon-king-jena"
}
```

Replying to [comment:17 vbraun]:
> There is:
> {{{
> $ grep fmpz_init_set flint-2.4.3/fmpz.h 
> void fmpz_init_set(fmpz_t f, const fmpz_t g)
> void fmpz_init_set_ui(fmpz_t f, ulong g)
> void fmpz_init_set_readonly(fmpz_t f, const mpz_t z);
> }}}

I think it should be used.



---

archive/issue_comments_223092.json:
```json
{
    "body": "This branch fixes all valgrind warnings from `matrix_integer_dense` (when running `benchmark_hnf`)",
    "created_at": "2014-10-02T19:32:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223092",
    "user": "@vbraun"
}
```

This branch fixes all valgrind warnings from `matrix_integer_dense` (when running `benchmark_hnf`)



---

archive/issue_comments_223093.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-10-02T20:30:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223093",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_223094.json:
```json
{
    "body": "Replying to [comment:18 SimonKing]:\n> I think it should be used.\nDone",
    "created_at": "2014-10-02T20:33:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223094",
    "user": "@jdemeyer"
}
```

Replying to [comment:18 SimonKing]:
> I think it should be used.
Done



---

archive/issue_comments_223095.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-10-02T20:33:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223095",
    "user": "@jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_223096.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-10-02T21:04:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223096",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_223097.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-10-02T21:19:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223097",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_223098.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-10-02T21:35:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223098",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_223099.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-10-02T21:52:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223099",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_223100.json:
```json
{
    "body": "Why did you delete the following functions: \n\n```\n_multiply_linbox\n_multiply_multi_modular\n_det_pari\n```\n",
    "created_at": "2014-10-02T22:20:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223100",
    "user": "@williamstein"
}
```

Why did you delete the following functions: 

```
_multiply_linbox
_multiply_multi_modular
_det_pari
```




---

archive/issue_comments_223101.json:
```json
{
    "body": "Replying to [comment:29 was]:\n> Why did you delete the following functions: \n> {{{\n> _multiply_linbox\n> _multiply_multi_modular\n> }}}\nThese were simply unused. If you think we should keep them \"for reference\", there is always the git log.\n\nAnd `_det_pari` was copied in #16803, I just deleted one of the two copies.",
    "created_at": "2014-10-03T05:27:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223101",
    "user": "@jdemeyer"
}
```

Replying to [comment:29 was]:
> Why did you delete the following functions: 
> {{{
> _multiply_linbox
> _multiply_multi_modular
> }}}
These were simply unused. If you think we should keep them "for reference", there is always the git log.

And `_det_pari` was copied in #16803, I just deleted one of the two copies.



---

archive/issue_comments_223102.json:
```json
{
    "body": "Replying to [comment:30 jdemeyer]:\n\n\n> Replying to [comment:29 was]:\n> \n> > Why did you delete the following functions: \n> > {{{\n> > _multiply_linbox\n> > _multiply_multi_modular\n> > }}}\n> > \n> These were simply unused. If you think we should keep them \"for reference\", there is always the git log.\n\nI'm against removing them.   Just because they aren't explicitly used elsewhere in Sage, doesn't mean they aren't useful to have.  For example, \n\n- I used them in testing the original patch (having multiple ways of computing products in order to compare) that this is following up on.\n \n- At one time Linbox was the fastest for multiplying matrices (at least in 2007, when Clement Pernet was my postdoc at UW).   Now it's terrible, at least as it is built in Sage.  Having the function _multiply_linbox makes it easier to test the speed of linbox versus flint (or multimodular) at any point.  If you remove it, then suddenly this becomes more difficult.    It's entirely plausible that linbox could again become faster than FLINT, and it would be more difficult to know without this function.\n\n- I personally don't trust FLINT, and having an easy alternative to test (or swap out for) matrix multiplication makes me happier.   I remember clearly times in the past when FLINT gave flat out wrong answers when multiplying large polynomials (burried deep in some p-adic cohomology calculations), and -- when tracking this down -- being able to instrument things so we could easily run the whole big computation with either FLINT or PARI was critical.",
    "created_at": "2014-10-03T06:17:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223102",
    "user": "@williamstein"
}
```

Replying to [comment:30 jdemeyer]:


> Replying to [comment:29 was]:
> 
> > Why did you delete the following functions: 
> > {{{
> > _multiply_linbox
> > _multiply_multi_modular
> > }}}
> > 
> These were simply unused. If you think we should keep them "for reference", there is always the git log.

I'm against removing them.   Just because they aren't explicitly used elsewhere in Sage, doesn't mean they aren't useful to have.  For example, 

- I used them in testing the original patch (having multiple ways of computing products in order to compare) that this is following up on.
 
- At one time Linbox was the fastest for multiplying matrices (at least in 2007, when Clement Pernet was my postdoc at UW).   Now it's terrible, at least as it is built in Sage.  Having the function _multiply_linbox makes it easier to test the speed of linbox versus flint (or multimodular) at any point.  If you remove it, then suddenly this becomes more difficult.    It's entirely plausible that linbox could again become faster than FLINT, and it would be more difficult to know without this function.

- I personally don't trust FLINT, and having an easy alternative to test (or swap out for) matrix multiplication makes me happier.   I remember clearly times in the past when FLINT gave flat out wrong answers when multiplying large polynomials (burried deep in some p-adic cohomology calculations), and -- when tracking this down -- being able to instrument things so we could easily run the whole big computation with either FLINT or PARI was critical.



---

archive/issue_comments_223103.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-10-03T07:19:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223103",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_223104.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-10-03T08:02:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223104",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_223105.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-10-03T09:14:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223105",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_223106.json:
```json
{
    "body": "I am going to leave this branch alone for now, please review! There is another follow-up at #17094.",
    "created_at": "2014-10-03T09:21:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223106",
    "user": "@jdemeyer"
}
```

I am going to leave this branch alone for now, please review! There is another follow-up at #17094.



---

archive/issue_comments_223107.json:
```json
{
    "body": "Replying to [comment:29 was]:\n> Why did you delete the following functions: \n> {{{\n> _multiply_linbox\n> }}}\n\nHere's a better reason: it's broken!\n\n```\nsage: A = identity_matrix(ZZ,3)\nsage: A._multiply_linbox(A)\n[0 0 0]\n[0 0 0]\n[0 0 0]\n```\n\n\nFixing this at #17094...",
    "created_at": "2014-10-03T13:11:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223107",
    "user": "@jdemeyer"
}
```

Replying to [comment:29 was]:
> Why did you delete the following functions: 
> {{{
> _multiply_linbox
> }}}

Here's a better reason: it's broken!

```
sage: A = identity_matrix(ZZ,3)
sage: A._multiply_linbox(A)
[0 0 0]
[0 0 0]
[0 0 0]
```


Fixing this at #17094...



---

archive/issue_comments_223108.json:
```json
{
    "body": "Replying to [comment:13 vbraun]:\n> And yes, I had hoped that flint had some mechanism to ensure that `*_init` is called, but no such luck.\nIn C, this simply cannot be done. A variable on the stack starts out in a totally unpredictable state.",
    "created_at": "2014-10-03T15:17:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223108",
    "user": "@jdemeyer"
}
```

Replying to [comment:13 vbraun]:
> And yes, I had hoped that flint had some mechanism to ensure that `*_init` is called, but no such luck.
In C, this simply cannot be done. A variable on the stack starts out in a totally unpredictable state.



---

archive/issue_comments_223109.json:
```json
{
    "body": "Replying to [comment:37 jdemeyer]:\n> In C, this simply cannot be done. A variable on the stack starts out in a totally unpredictable state.\n\nThats of course, strictly speaking, true. But I would be happy to take my chances with a padding int being initialized to `0xdeadbeef` and having a random, but usually different, value if it was not initialized.",
    "created_at": "2014-10-03T15:24:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223109",
    "user": "@vbraun"
}
```

Replying to [comment:37 jdemeyer]:
> In C, this simply cannot be done. A variable on the stack starts out in a totally unpredictable state.

Thats of course, strictly speaking, true. But I would be happy to take my chances with a padding int being initialized to `0xdeadbeef` and having a random, but usually different, value if it was not initialized.



---

archive/issue_comments_223110.json:
```json
{
    "body": "Replying to [comment:38 vbraun]:\n> But I would be happy to take my chances with a padding int being initialized to `0xdeadbeef`\n...if you take care to clear out that `0xdeadbeef` after use and assume that the compiler doesn't optimize that clearing away, I guess it would work.",
    "created_at": "2014-10-03T15:31:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223110",
    "user": "@jdemeyer"
}
```

Replying to [comment:38 vbraun]:
> But I would be happy to take my chances with a padding int being initialized to `0xdeadbeef`
...if you take care to clear out that `0xdeadbeef` after use and assume that the compiler doesn't optimize that clearing away, I guess it would work.



---

archive/issue_comments_223111.json:
```json
{
    "body": "Looks good to me!",
    "created_at": "2014-10-03T22:34:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223111",
    "user": "@vbraun"
}
```

Looks good to me!



---

archive/issue_comments_223112.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-10-03T22:34:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223112",
    "user": "@vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_223113.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-10-05T22:39:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16853#issuecomment-223113",
    "user": "@vbraun"
}
```

Resolution: fixed
