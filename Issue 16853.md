# Issue 16853: Add missing fmpz_init() statements after #16803

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2014-10-02 13:59:57

CC:  vbraun mmasdeu was simonking

The code from #16803 is missing `fmpz_init()`/`fmpz_clear()` in several places. This can cause random segfaults, as witnessed for example in #16938.


---

Comment by vbraun created at 2014-10-02 14:14:45

Flint has a `--enable-assert` configure switch to turn on assertions which should be handy for debugging.


---

Comment by SimonKing created at 2014-10-02 14:20:11

Replying to [comment:3 vbraun]:
> Flint has a `--enable-assert` configure switch to turn on assertions which should be handy for debugging.

... which should become part of #16938, right?


---

Comment by vbraun created at 2014-10-02 14:38:15

I'd prefer to add it here, there is already too much going on at  #16938


---

Comment by vbraun created at 2014-10-02 14:47:03

Turns out assertions aren't used that much in flint, I still can't reproduce the crash. 
----
New commits:


---

Comment by jdemeyer created at 2014-10-02 15:15:06

The problem is that an assertion won't help against uninitialized variables.


---

Comment by SimonKing created at 2014-10-02 15:21:59

Replying to [comment:9 jdemeyer]:
> The problem is that an assertion won't help against uninitialized variables.

And I thought a debug version would have a paranoid memory management, so that the use of uninitialised variables would result in an immediate abort.


---

Comment by SimonKing created at 2014-10-02 15:23:15

Why not building a static library, by the way?


---

Comment by vbraun created at 2014-10-02 15:27:45

Because static libraries suck. If you rebuild flint with debugging, is Sage going to use the new shared library or have the old static library compiled in?


---

Comment by vbraun created at 2014-10-02 15:28:42

And yes, I had hoped that flint had some mechanism to ensure that `*_init` is called, but no such luck.


---

Comment by jdemeyer created at 2014-10-02 15:32:11

This should fix the problem, but I haven't tested it wth #16938.
----
New commits:


---

Comment by SimonKing created at 2014-10-02 17:33:14

Concerning

```
+ fmpz_init(z)
+ fmpz_set_mpz(z, x.value)
```

Is there no `fmpz_init_set`? I know that there is a combined init-set function for `mpz`, but I don't know about `fmpz`.


---

Comment by vbraun created at 2014-10-02 17:44:14

There is:

```
$ grep fmpz_init_set flint-2.4.3/fmpz.h 
void fmpz_init_set(fmpz_t f, const fmpz_t g)
void fmpz_init_set_ui(fmpz_t f, ulong g)
void fmpz_init_set_readonly(fmpz_t f, const mpz_t z);
```



---

Comment by SimonKing created at 2014-10-02 17:51:07

Replying to [comment:17 vbraun]:
> There is:
> {{{
> $ grep fmpz_init_set flint-2.4.3/fmpz.h 
> void fmpz_init_set(fmpz_t f, const fmpz_t g)
> void fmpz_init_set_ui(fmpz_t f, ulong g)
> void fmpz_init_set_readonly(fmpz_t f, const mpz_t z);
> }}}

I think it should be used.


---

Comment by vbraun created at 2014-10-02 19:32:02

This branch fixes all valgrind warnings from `matrix_integer_dense` (when running `benchmark_hnf`)


---

Comment by git created at 2014-10-02 20:30:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2014-10-02 20:33:05

Replying to [comment:18 SimonKing]:
> I think it should be used.
Done


---

Comment by jdemeyer created at 2014-10-02 20:33:05

Changing status from new to needs_review.


---

Comment by git created at 2014-10-02 21:04:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-10-02 21:19:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-10-02 21:35:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-10-02 21:52:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by was created at 2014-10-02 22:20:38

Why did you delete the following functions: 

```
_multiply_linbox
_multiply_multi_modular
_det_pari
```



---

Comment by jdemeyer created at 2014-10-03 05:27:43

Replying to [comment:29 was]:
> Why did you delete the following functions: 
> {{{
> _multiply_linbox
> _multiply_multi_modular
> }}}
These were simply unused. If you think we should keep them "for reference", there is always the git log.

And `_det_pari` was copied in #16803, I just deleted one of the two copies.


---

Comment by was created at 2014-10-03 06:17:08

Replying to [comment:30 jdemeyer]:


> Replying to [comment:29 was]:
> 
> > Why did you delete the following functions: 
> > {{{
> > _multiply_linbox
> > _multiply_multi_modular
> > }}}
> > 
> These were simply unused. If you think we should keep them "for reference", there is always the git log.

I'm against removing them.   Just because they aren't explicitly used elsewhere in Sage, doesn't mean they aren't useful to have.  For example, 

 - I used them in testing the original patch (having multiple ways of computing products in order to compare) that this is following up on.
 
- At one time Linbox was the fastest for multiplying matrices (at least in 2007, when Clement Pernet was my postdoc at UW).   Now it's terrible, at least as it is built in Sage.  Having the function _multiply_linbox makes it easier to test the speed of linbox versus flint (or multimodular) at any point.  If you remove it, then suddenly this becomes more difficult.    It's entirely plausible that linbox could again become faster than FLINT, and it would be more difficult to know without this function.

- I personally don't trust FLINT, and having an easy alternative to test (or swap out for) matrix multiplication makes me happier.   I remember clearly times in the past when FLINT gave flat out wrong answers when multiplying large polynomials (burried deep in some p-adic cohomology calculations), and -- when tracking this down -- being able to instrument things so we could easily run the whole big computation with either FLINT or PARI was critical.


---

Comment by git created at 2014-10-03 07:19:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-10-03 08:02:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-10-03 09:14:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2014-10-03 09:21:02

I am going to leave this branch alone for now, please review! There is another follow-up at #17094.


---

Comment by jdemeyer created at 2014-10-03 13:11:36

Replying to [comment:29 was]:
> Why did you delete the following functions: 
> {{{
> _multiply_linbox
> }}}

Here's a better reason: it's broken!

```
sage: A = identity_matrix(ZZ,3)
sage: A._multiply_linbox(A)
[0 0 0]
[0 0 0]
[0 0 0]
```


Fixing this at #17094...


---

Comment by jdemeyer created at 2014-10-03 15:17:37

Replying to [comment:13 vbraun]:
> And yes, I had hoped that flint had some mechanism to ensure that `*_init` is called, but no such luck.
In C, this simply cannot be done. A variable on the stack starts out in a totally unpredictable state.


---

Comment by vbraun created at 2014-10-03 15:24:19

Replying to [comment:37 jdemeyer]:
> In C, this simply cannot be done. A variable on the stack starts out in a totally unpredictable state.

Thats of course, strictly speaking, true. But I would be happy to take my chances with a padding int being initialized to `0xdeadbeef` and having a random, but usually different, value if it was not initialized.


---

Comment by jdemeyer created at 2014-10-03 15:31:42

Replying to [comment:38 vbraun]:
> But I would be happy to take my chances with a padding int being initialized to `0xdeadbeef`
...if you take care to clear out that `0xdeadbeef` after use and assume that the compiler doesn't optimize that clearing away, I guess it would work.


---

Comment by vbraun created at 2014-10-03 22:34:42

Looks good to me!


---

Comment by vbraun created at 2014-10-03 22:34:42

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-10-05 22:39:18

Resolution: fixed
