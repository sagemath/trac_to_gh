# Issue 20244: Extract source tarballs using more restrictive permissions on directories

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2016-04-21 14:38:13

This is the lowest-hanging fruit in addressing the issues I raised in [this comment](http://trac.sagemath.org/ticket/20218#comment:16).

It changes `sage-uncompress-spkg` to apply mode 700 to all directories extracted from tarballs.  Original permissions are preserved for plain files.  Are there any odd packages this would cause an issue for?

This doesn't apply to zipfiles since they do not contain permission information, though in principle we could modify zipfiles to use the same policy wrt directories. I don't think it matters much though.


---

Comment by embray created at 2016-04-21 14:38:25

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2016-04-21 15:09:55

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2016-04-21 15:09:55

Instead of ignoring permissions for dirs, would it be possible to simply apply the user's umask on everything which gets extracted (files and directories). This would mean changing `tarinfo.mode` to `tarinfo.mode & CURRENT_UMASK`.


---

Comment by embray created at 2016-04-21 15:17:53

That was my first thought actually. I'd be fine with that too--this was just infinitesimally simpler :)


---

Comment by embray created at 2016-04-21 15:19:11

Perhaps one reason _not_ to prefer that is that if the umask is set to something useless then then applying it would be no less "safe".  As it is this is only "unsafe" in the context of moving the extracted directory to someplace like /tmp.  But it seems more reliable not to rely on the user's umask.


---

Comment by jdemeyer created at 2016-04-21 15:26:33

Replying to [comment:4 embray]:
> Perhaps one reason _not_ to prefer that is that if the umask is set to something useless then then applying it would be no less "safe".

I would say that the `umask` _defines_ what is safe. It is the thing which determines which permissions the user wants.


---

Comment by novoselt created at 2016-04-21 17:16:08

0700 would break the cell server which uses a separate worker account and in general would not work for multiuser setup. Or am I missing the point? It also seems to me that using `umask` is just the right way for defaults in any case. Those who are not happy with `umask` can either adjust it or set some restrictive permission on a containing directory.


---

Comment by jdemeyer created at 2016-04-21 20:38:39

I agree that building with too restrictive permissions could give problems. Some installation scripts probably just copy the directory over without changing the permissions. So `0700` is certainly too restrictive for that to work.


---

Comment by embray created at 2016-04-22 13:39:04

Okay then, umask it is.  I'll update this next week.


---

Comment by git created at 2016-04-27 14:05:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2016-04-27 14:05:48

As discussed, now the customized `TarFile` subclass merely applies the user's umask to all extracted files.


---

Comment by embray created at 2016-04-27 14:12:22

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2016-05-13 15:00:19

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-05-22 21:09:44

Resolution: fixed
