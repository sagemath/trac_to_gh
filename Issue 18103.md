# Issue 18103: Memory issues while testing

archive/issues_018103.json:
```json
{
    "body": "CC:  @jdemeyer\n\nSee https://groups.google.com/d/topic/sage-devel/ydDfHsCxpAc/discussion\n\nIssue created by migration from https://trac.sagemath.org/ticket/18340\n\n",
    "created_at": "2015-04-29T22:17:28Z",
    "labels": [
        "component: please change",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.7",
    "title": "Memory issues while testing",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18103",
    "user": "https://github.com/novoselt"
}
```
CC:  @jdemeyer

See https://groups.google.com/d/topic/sage-devel/ydDfHsCxpAc/discussion

Issue created by migration from https://trac.sagemath.org/ticket/18340





---

archive/issue_comments_243654.json:
```json
{
    "body": "This has also been reported on sage-release; it happens presumably since the last update of PARI.",
    "created_at": "2015-04-30T00:10:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243654",
    "user": "https://github.com/nexttime"
}
```

This has also been reported on sage-release; it happens presumably since the last update of PARI.



---

archive/issue_comments_243655.json:
```json
{
    "body": "Changing keywords from \"\" to \"PARI gp ptestlong doctesting\".",
    "created_at": "2015-04-30T00:10:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243655",
    "user": "https://github.com/nexttime"
}
```

Changing keywords from "" to "PARI gp ptestlong doctesting".



---

archive/issue_comments_243656.json:
```json
{
    "body": "For me, on one machine it happens each time I run `make ptestlong` unless I delete `~/.sage/timings*` before doing so.  (Deleting these files \"disables\" the IMHO useless and rather counter-productive *sorting of doctests by previous runtime*.)\n\nJohn C. reported it happened to him even with `make testlong`, i.e., without testing in parallel.",
    "created_at": "2015-04-30T00:22:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243656",
    "user": "https://github.com/nexttime"
}
```

For me, on one machine it happens each time I run `make ptestlong` unless I delete `~/.sage/timings*` before doing so.  (Deleting these files "disables" the IMHO useless and rather counter-productive *sorting of doctests by previous runtime*.)

John C. reported it happened to him even with `make testlong`, i.e., without testing in parallel.



---

archive/issue_comments_243657.json:
```json
{
    "body": "Ooops, GB, not MB... 8)",
    "created_at": "2015-04-30T00:27:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243657",
    "user": "https://github.com/nexttime"
}
```

Ooops, GB, not MB... 8)



---

archive/issue_comments_243658.json:
```json
{
    "body": "Changing keywords from \"PARI gp ptestlong doctesting\" to \"PARI gp ptestlong doctesting lseries_ell.py\".",
    "created_at": "2015-04-30T00:44:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243658",
    "user": "https://github.com/nexttime"
}
```

Changing keywords from "PARI gp ptestlong doctesting" to "PARI gp ptestlong doctesting lseries_ell.py".



---

archive/issue_comments_243659.json:
```json
{
    "body": "Why don't we always limit doctesting by some sensible number (4GB per process seems fine to me) and report failed tests if it is triggered? It is one thing when my old laptop get unresponsive with a new version of Sage, it is a completely different story when \"my\" server goes down which is used by several researches and hundreds of students.",
    "created_at": "2015-04-30T00:56:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243659",
    "user": "https://github.com/novoselt"
}
```

Why don't we always limit doctesting by some sensible number (4GB per process seems fine to me) and report failed tests if it is triggered? It is one thing when my old laptop get unresponsive with a new version of Sage, it is a completely different story when "my" server goes down which is used by several researches and hundreds of students.



---

archive/issue_comments_243660.json:
```json
{
    "body": "Well, whether `ulimit` works depends on the OS AFAIK.\n\nAnd as I said, I do not even get a \"Killed\" from Sage; the doctest passes even though its child process got killed.\n\nI haven't yet been able to reproduce this other than by running `make ptestlong`;  `./sage -tp --long --warn-long 0.0001 src/sage/schemes/elliptic_curves/` for example doesn't show the behaviour even on an already loaded machine.",
    "created_at": "2015-04-30T01:20:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243660",
    "user": "https://github.com/nexttime"
}
```

Well, whether `ulimit` works depends on the OS AFAIK.

And as I said, I do not even get a "Killed" from Sage; the doctest passes even though its child process got killed.

I haven't yet been able to reproduce this other than by running `make ptestlong`;  `./sage -tp --long --warn-long 0.0001 src/sage/schemes/elliptic_curves/` for example doesn't show the behaviour even on an already loaded machine.



---

archive/issue_comments_243661.json:
```json
{
    "body": "Replying to [comment:6 leif]:\n> I haven't yet been able to reproduce this other than by running `make ptestlong`;  `./sage -tp --long --warn-long 0.0001 src/sage/schemes/elliptic_curves/` for example doesn't show the behaviour even on an already loaded machine.\n\nVaguely thought of that already, and we indeed need (GNU) `make`, and a sufficiently old one:\n\n```sh\necho \"WARNING:  'gp' may eat up up to ~16GB with the following\"\n(ulimit -v 16000000; printf \"all:\\n\\t./sage -t --long src/sage/schemes/elliptic_curves/lseries_ell.py\\n\" | make -f -)\n```\n\n\nWith `make` 3.81, `gp` runs amok; with `make` 4.1, everything's fine.\n\n(We had a similar issue with ECL and/or GAP quite a while ago IIRC, and the `make` version without issues was 3.82 and later I think.)",
    "created_at": "2015-04-30T02:38:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243661",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:6 leif]:
> I haven't yet been able to reproduce this other than by running `make ptestlong`;  `./sage -tp --long --warn-long 0.0001 src/sage/schemes/elliptic_curves/` for example doesn't show the behaviour even on an already loaded machine.

Vaguely thought of that already, and we indeed need (GNU) `make`, and a sufficiently old one:

```sh
echo "WARNING:  'gp' may eat up up to ~16GB with the following"
(ulimit -v 16000000; printf "all:\n\t./sage -t --long src/sage/schemes/elliptic_curves/lseries_ell.py\n" | make -f -)
```


With `make` 3.81, `gp` runs amok; with `make` 4.1, everything's fine.

(We had a similar issue with ECL and/or GAP quite a while ago IIRC, and the `make` version without issues was 3.82 and later I think.)



---

archive/issue_comments_243662.json:
```json
{
    "body": "\n```\nnovoselt@sagenb:~$ make --version\nGNU Make 3.81\nCopyright (C) 2006  Free Software Foundation, Inc.\nThis is free software; see the source for copying conditions.\nThere is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A\nPARTICULAR PURPOSE.\n\nThis program built for x86_64-pc-linux-gnu\n```\n\nECL fails some tests on this machine unless I compile with some flags for Bulldozer... I guess updating to jessie may help, but I can't risk breaking things right before the term starts.",
    "created_at": "2015-04-30T02:45:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243662",
    "user": "https://github.com/novoselt"
}
```


```
novoselt@sagenb:~$ make --version
GNU Make 3.81
Copyright (C) 2006  Free Software Foundation, Inc.
This is free software; see the source for copying conditions.
There is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A
PARTICULAR PURPOSE.

This program built for x86_64-pc-linux-gnu
```

ECL fails some tests on this machine unless I compile with some flags for Bulldozer... I guess updating to jessie may help, but I can't risk breaking things right before the term starts.



---

archive/issue_comments_243663.json:
```json
{
    "body": "In case it's really GNU make's fault: [https://savannah.gnu.org/bugs/?22010](https://savannah.gnu.org/bugs/?22010)\n\nFixed in 3.82, as I guessed.\n\nNote that not just Ubuntu 10.04, but also 12.04 and even 14.04!!! (just checked and couldn't believe) still come with the dead old and broken version 3.81 of 2006.",
    "created_at": "2015-04-30T03:16:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243663",
    "user": "https://github.com/nexttime"
}
```

In case it's really GNU make's fault: [https://savannah.gnu.org/bugs/?22010](https://savannah.gnu.org/bugs/?22010)

Fixed in 3.82, as I guessed.

Note that not just Ubuntu 10.04, but also 12.04 and even 14.04!!! (just checked and couldn't believe) still come with the dead old and broken version 3.81 of 2006.



---

archive/issue_comments_243664.json:
```json
{
    "body": "Replying to [comment:8 novoselt]:\n> {{{\n> novoselt`@`sagenb:~$ make --version\n> GNU Make 3.81\n> Copyright (C) 2006  Free Software Foundation, Inc.\n> This is free software; see the source for copying conditions.\n> There is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A\n> PARTICULAR PURPOSE.\n> \n> This program built for x86_64-pc-linux-gnu\n> }}}\n> ECL fails some tests on this machine unless I compile with some flags for Bulldozer... I guess updating to jessie may help, but I can't risk breaking things right before the term starts.\n\nWell, just grab some newer version (3.82, 4.0 or 4.1) from [http://ftp.gnu.org/gnu/make/](http://ftp.gnu.org/gnu/make/), untar it, and run `configure && make && sudo make install` (by default into `/usr/local`).",
    "created_at": "2015-04-30T03:22:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243664",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:8 novoselt]:
> {{{
> novoselt`@`sagenb:~$ make --version
> GNU Make 3.81
> Copyright (C) 2006  Free Software Foundation, Inc.
> This is free software; see the source for copying conditions.
> There is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A
> PARTICULAR PURPOSE.
> 
> This program built for x86_64-pc-linux-gnu
> }}}
> ECL fails some tests on this machine unless I compile with some flags for Bulldozer... I guess updating to jessie may help, but I can't risk breaking things right before the term starts.

Well, just grab some newer version (3.82, 4.0 or 4.1) from [http://ftp.gnu.org/gnu/make/](http://ftp.gnu.org/gnu/make/), untar it, and run `configure && make && sudo make install` (by default into `/usr/local`).



---

archive/issue_comments_243665.json:
```json
{
    "body": "Replying to [comment:9 leif]:\n> In case it's really GNU make's fault: [https://savannah.gnu.org/bugs/?22010](https://savannah.gnu.org/bugs/?22010)\n\nHmmm, I'm still not sure whether it's really this.  Ubuntu apparently patched their `make`, as it does **not** touch the resource limits, while my GNU make 4.1 limits the stack size to 8MB (soft):\n\n```sh\nfor make in /usr/local/bin/make /usr/bin/make; do $make --version | head -1; printf \"all:\\n\\t: ; ulimit -sH\\n\\t: ; ulimit -sS\\n\" | $make -f -; done\nGNU Make 4.1\n: ; ulimit -sH\nunlimited\n: ; ulimit -sS\n8192\nGNU Make 3.81\n: ; ulimit -sH\nunlimited\n: ; ulimit -sS\nunlimited\n```\n\n\nAnother cause could be GNU make 3.81 messing up file descriptors somehow.",
    "created_at": "2015-04-30T04:07:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243665",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:9 leif]:
> In case it's really GNU make's fault: [https://savannah.gnu.org/bugs/?22010](https://savannah.gnu.org/bugs/?22010)

Hmmm, I'm still not sure whether it's really this.  Ubuntu apparently patched their `make`, as it does **not** touch the resource limits, while my GNU make 4.1 limits the stack size to 8MB (soft):

```sh
for make in /usr/local/bin/make /usr/bin/make; do $make --version | head -1; printf "all:\n\t: ; ulimit -sH\n\t: ; ulimit -sS\n" | $make -f -; done
GNU Make 4.1
: ; ulimit -sH
unlimited
: ; ulimit -sS
8192
GNU Make 3.81
: ; ulimit -sH
unlimited
: ; ulimit -sS
unlimited
```


Another cause could be GNU make 3.81 messing up file descriptors somehow.



---

archive/issue_comments_243666.json:
```json
{
    "body": "Replying to [comment:10 leif]:\n> Well, just grab some newer version (3.82, 4.0 or 4.1) from [http://ftp.gnu.org/gnu/make/](http://ftp.gnu.org/gnu/make/), untar it, and run `configure && make && sudo make install` (by default into `/usr/local`).\n\nAlternatively, I can just not test Sage. But it does not fix the issue for other users. If it is a bug in `make`, but it is a widely adopted version, it still makes sense to work around it. Wheezy is likely to be around for another 3 years.",
    "created_at": "2015-04-30T04:23:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243666",
    "user": "https://github.com/novoselt"
}
```

Replying to [comment:10 leif]:
> Well, just grab some newer version (3.82, 4.0 or 4.1) from [http://ftp.gnu.org/gnu/make/](http://ftp.gnu.org/gnu/make/), untar it, and run `configure && make && sudo make install` (by default into `/usr/local`).

Alternatively, I can just not test Sage. But it does not fix the issue for other users. If it is a bug in `make`, but it is a widely adopted version, it still makes sense to work around it. Wheezy is likely to be around for another 3 years.



---

archive/issue_comments_243667.json:
```json
{
    "body": "Replying to [comment:11 leif]:\n> Replying to [comment:9 leif]:\n> > In case it's really GNU make's fault: [https://savannah.gnu.org/bugs/?22010](https://savannah.gnu.org/bugs/?22010)\n> \n> Hmmm, I'm still not sure whether it's really this.  Ubuntu apparently patched their `make`, as it does **not** touch the resource limits, while my GNU make 4.1 limits the stack size to 8MB (soft):\n> {{{\n> #!sh\n> for make in /usr/local/bin/make /usr/bin/make; do $make --version | head -1; printf \"all:\\n\\t: ; ulimit -sH\\n\\t: ; ulimit -sS\\n\" | $make -f -; done\n> GNU Make 4.1\n> : ; ulimit -sH\n> unlimited\n> : ; ulimit -sS\n> 8192\n> GNU Make 3.81\n> : ; ulimit -sH\n> unlimited\n> : ; ulimit -sS\n> unlimited\n> }}}\n\nWhat is the `ulimit -s` outside of `make`? I get\n\n```\njdemeyer@tamiyo:~$ ulimit -s\n8192\n```\n\nso if `make` changes that to `unlimited`, that's [https://savannah.gnu.org/bugs/?22010](https://savannah.gnu.org/bugs/?22010) indeed.",
    "created_at": "2015-04-30T05:35:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243667",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:11 leif]:
> Replying to [comment:9 leif]:
> > In case it's really GNU make's fault: [https://savannah.gnu.org/bugs/?22010](https://savannah.gnu.org/bugs/?22010)
> 
> Hmmm, I'm still not sure whether it's really this.  Ubuntu apparently patched their `make`, as it does **not** touch the resource limits, while my GNU make 4.1 limits the stack size to 8MB (soft):
> {{{
> #!sh
> for make in /usr/local/bin/make /usr/bin/make; do $make --version | head -1; printf "all:\n\t: ; ulimit -sH\n\t: ; ulimit -sS\n" | $make -f -; done
> GNU Make 4.1
> : ; ulimit -sH
> unlimited
> : ; ulimit -sS
> 8192
> GNU Make 3.81
> : ; ulimit -sH
> unlimited
> : ; ulimit -sS
> unlimited
> }}}

What is the `ulimit -s` outside of `make`? I get

```
jdemeyer@tamiyo:~$ ulimit -s
8192
```

so if `make` changes that to `unlimited`, that's [https://savannah.gnu.org/bugs/?22010](https://savannah.gnu.org/bugs/?22010) indeed.



---

archive/issue_comments_243668.json:
```json
{
    "body": "Replying to [comment:12 novoselt]:\n> If it is a bug in `make`, but it is a widely adopted version, it still makes sense to work around it. Wheezy is likely to be around for another 3 years.\nThe fixed version of GNU `make` has been released almost 5 years ago. There is really no excuse for still using `make` 3.81. Like leif said, you can easily install that manually outside of the distro.",
    "created_at": "2015-04-30T05:38:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243668",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:12 novoselt]:
> If it is a bug in `make`, but it is a widely adopted version, it still makes sense to work around it. Wheezy is likely to be around for another 3 years.
The fixed version of GNU `make` has been released almost 5 years ago. There is really no excuse for still using `make` 3.81. Like leif said, you can easily install that manually outside of the distro.



---

archive/issue_comments_243669.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to packages: standard.",
    "created_at": "2015-04-30T08:03:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243669",
    "user": "https://github.com/jdemeyer"
}
```

Changing component from PLEASE CHANGE to packages: standard.



---

archive/issue_comments_243670.json:
```json
{
    "body": "I can confirm the issue.",
    "created_at": "2015-04-30T08:03:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243670",
    "user": "https://github.com/jdemeyer"
}
```

I can confirm the issue.



---

archive/issue_comments_243671.json:
```json
{
    "body": "I'm now trying to see why `gp` uses so much stack memory.",
    "created_at": "2015-04-30T08:15:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243671",
    "user": "https://github.com/jdemeyer"
}
```

I'm now trying to see why `gp` uses so much stack memory.



---

archive/issue_comments_243672.json:
```json
{
    "body": "OK, this is my analysis: at some point, the dokchitser `gp` script is really trying to compute a vector of length `348804762364674`. This obviously fails with a PARI stack overflow (this \"stack\" has nothing to do with the `ulimit -s` stack). As a result, Sage tries to increase `gp`'s memory with the `allocatemem()` command. But since this vector is really too big, it fails no matter how much memory is allocated. At some point, allocating more memory from the system fails and it seems that PARI/GP does not gracefully handle this out-of-memory condition.\n\nThe solution: upgrade PARI/GP.",
    "created_at": "2015-04-30T08:59:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243672",
    "user": "https://github.com/jdemeyer"
}
```

OK, this is my analysis: at some point, the dokchitser `gp` script is really trying to compute a vector of length `348804762364674`. This obviously fails with a PARI stack overflow (this "stack" has nothing to do with the `ulimit -s` stack). As a result, Sage tries to increase `gp`'s memory with the `allocatemem()` command. But since this vector is really too big, it fails no matter how much memory is allocated. At some point, allocating more memory from the system fails and it seems that PARI/GP does not gracefully handle this out-of-memory condition.

The solution: upgrade PARI/GP.



---

archive/issue_comments_243673.json:
```json
{
    "body": "This fixes the issue, currently running `make ptestlong`.\n----\nNew commits:",
    "created_at": "2015-04-30T09:58:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243673",
    "user": "https://github.com/jdemeyer"
}
```

This fixes the issue, currently running `make ptestlong`.
----
New commits:



---

archive/issue_comments_243674.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-04-30T09:58:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243674",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_243675.json:
```json
{
    "body": "This is **not** floating point noise\n\n```diff\n sage: pari('intnum(x=0,13,sin(x)+sin(x^2) + x)')\n- 85.1885681951527\n+ 84.1818153922297\n```\n\nThe value of the integral computed with gsl is\n\n```\nsage: numerical_integral(sin(x)+sin(x^2)+x,0,13)\n(85.18856819515268, 1.3572929447036586e-09)\n```\n\nSo Pari was right up to 10<sup>-11</sup> and now it gets down to 10<sup>-4</sup>. This is not acceptable.",
    "created_at": "2015-04-30T10:08:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243675",
    "user": "https://github.com/videlec"
}
```

This is **not** floating point noise

```diff
 sage: pari('intnum(x=0,13,sin(x)+sin(x^2) + x)')
- 85.1885681951527
+ 84.1818153922297
```

The value of the integral computed with gsl is

```
sage: numerical_integral(sin(x)+sin(x^2)+x,0,13)
(85.18856819515268, 1.3572929447036586e-09)
```

So Pari was right up to 10<sup>-11</sup> and now it gets down to 10<sup>-4</sup>. This is not acceptable.



---

archive/issue_comments_243676.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-30T10:08:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243676",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_243677.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-04-30T10:15:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243677",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_243678.json:
```json
{
    "body": "Replying to [comment:21 vdelecroix]:\n> This is **not** floating point noise\n> {{{#!diff\n>  sage: pari('intnum(x=0,13,sin(x)+sin(x^2) + x)')\n> - 85.1885681951527\n> + 84.1818153922297\n> }}}\n> The value of the integral computed with gsl is\n> {{{\n> sage: numerical_integral(sin(x)+sin(x^2)+x,0,13)\n> (85.18856819515268, 1.3572929447036586e-09)\n> }}}\n> So Pari was right up to 10<sup>-11</sup> and now it gets down to 10<sup>-4</sup>. This is not acceptable.\nIt's much worse. Note the `85` became `84`.",
    "created_at": "2015-04-30T10:16:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243678",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:21 vdelecroix]:
> This is **not** floating point noise
> {{{#!diff
>  sage: pari('intnum(x=0,13,sin(x)+sin(x^2) + x)')
> - 85.1885681951527
> + 84.1818153922297
> }}}
> The value of the integral computed with gsl is
> {{{
> sage: numerical_integral(sin(x)+sin(x^2)+x,0,13)
> (85.18856819515268, 1.3572929447036586e-09)
> }}}
> So Pari was right up to 10<sup>-11</sup> and now it gets down to 10<sup>-4</sup>. This is not acceptable.
It's much worse. Note the `85` became `84`.



---

archive/issue_comments_243679.json:
```json
{
    "body": "Replying to [comment:24 jdemeyer]:\n> Replying to [comment:21 vdelecroix]:\n> > This is **not** floating point noise\n> > {{{#!diff\n> >  sage: pari('intnum(x=0,13,sin(x)+sin(x^2) + x)')\n> > - 85.1885681951527\n> > + 84.1818153922297\n> > }}}\n> > The value of the integral computed with gsl is\n> > {{{\n> > sage: numerical_integral(sin(x)+sin(x^2)+x,0,13)\n> > (85.18856819515268, 1.3572929447036586e-09)\n> > }}}\n> > So Pari was right up to 10<sup>-11</sup> and now it gets down to 10<sup>-4</sup>. This is not acceptable.\n> It's much worse. Note the `85` became `84`.\n\nIndeed! I can confirm the behavior on the freshly compiled pari master `development 17795-d04cdd3`.",
    "created_at": "2015-04-30T10:22:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243679",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:24 jdemeyer]:
> Replying to [comment:21 vdelecroix]:
> > This is **not** floating point noise
> > {{{#!diff
> >  sage: pari('intnum(x=0,13,sin(x)+sin(x^2) + x)')
> > - 85.1885681951527
> > + 84.1818153922297
> > }}}
> > The value of the integral computed with gsl is
> > {{{
> > sage: numerical_integral(sin(x)+sin(x^2)+x,0,13)
> > (85.18856819515268, 1.3572929447036586e-09)
> > }}}
> > So Pari was right up to 10<sup>-11</sup> and now it gets down to 10<sup>-4</sup>. This is not acceptable.
> It's much worse. Note the `85` became `84`.

Indeed! I can confirm the behavior on the freshly compiled pari master `development 17795-d04cdd3`.



---

archive/issue_comments_243680.json:
```json
{
    "body": "Replying to [comment:25 vdelecroix]:\n> Replying to [comment:24 jdemeyer]:\n> > Replying to [comment:21 vdelecroix]:\n> > > This is **not** floating point noise\n> > > {{{#!diff\n> > >  sage: pari('intnum(x=0,13,sin(x)+sin(x^2) + x)')\n> > > - 85.1885681951527\n> > > + 84.1818153922297\n> > > }}}\n> > > The value of the integral computed with gsl is\n> > > {{{\n> > > sage: numerical_integral(sin(x)+sin(x^2)+x,0,13)\n> > > (85.18856819515268, 1.3572929447036586e-09)\n> > > }}}\n> > > So Pari was right up to 10<sup>-11</sup> and now it gets down to 10<sup>-4</sup>. This is not acceptable.\n> > It's much worse. Note the `85` became `84`.\n> \n> Indeed! I can confirm the behavior on the freshly compiled pari master `development 17795-d04cdd3`.\n\nThis is rather disjoint from this ticket, I opened #18342 to track the issue.",
    "created_at": "2015-04-30T10:27:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243680",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:25 vdelecroix]:
> Replying to [comment:24 jdemeyer]:
> > Replying to [comment:21 vdelecroix]:
> > > This is **not** floating point noise
> > > {{{#!diff
> > >  sage: pari('intnum(x=0,13,sin(x)+sin(x^2) + x)')
> > > - 85.1885681951527
> > > + 84.1818153922297
> > > }}}
> > > The value of the integral computed with gsl is
> > > {{{
> > > sage: numerical_integral(sin(x)+sin(x^2)+x,0,13)
> > > (85.18856819515268, 1.3572929447036586e-09)
> > > }}}
> > > So Pari was right up to 10<sup>-11</sup> and now it gets down to 10<sup>-4</sup>. This is not acceptable.
> > It's much worse. Note the `85` became `84`.
> 
> Indeed! I can confirm the behavior on the freshly compiled pari master `development 17795-d04cdd3`.

This is rather disjoint from this ticket, I opened #18342 to track the issue.



---

archive/issue_comments_243681.json:
```json
{
    "body": "There are also doctest failures in `src/sage/calculus/calculus.py` due to this.",
    "created_at": "2015-04-30T11:42:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243681",
    "user": "https://github.com/jdemeyer"
}
```

There are also doctest failures in `src/sage/calculus/calculus.py` due to this.



---

archive/issue_comments_243682.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-30T11:43:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243682",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_243683.json:
```json
{
    "body": "Replying to [comment:13 jdemeyer]:\n> What is the `ulimit -s` outside of `make`? I get\n> {{{\n> jdemeyer`@`tamiyo:~$ ulimit -s\n> 8192\n> }}}\n> so if `make` changes that to `unlimited`, that's [https://savannah.gnu.org/bugs/?22010](https://savannah.gnu.org/bugs/?22010) indeed.\n\nYep, missed that:  Outside of `make`, the stack size is (already) soft-limited to 8MB, which GNU make 3.81 in the distros resets to `unlimited`.\n\nThe original bug report was actually about the opposite:  Changing it from `unlimited` to some huge value.\n\nBut the real bug is that (the old) `make` touches the resource limits of (non-`make`) subprocesses at all.",
    "created_at": "2015-04-30T13:46:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243683",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:13 jdemeyer]:
> What is the `ulimit -s` outside of `make`? I get
> {{{
> jdemeyer`@`tamiyo:~$ ulimit -s
> 8192
> }}}
> so if `make` changes that to `unlimited`, that's [https://savannah.gnu.org/bugs/?22010](https://savannah.gnu.org/bugs/?22010) indeed.

Yep, missed that:  Outside of `make`, the stack size is (already) soft-limited to 8MB, which GNU make 3.81 in the distros resets to `unlimited`.

The original bug report was actually about the opposite:  Changing it from `unlimited` to some huge value.

But the real bug is that (the old) `make` touches the resource limits of (non-`make`) subprocesses at all.



---

archive/issue_comments_243684.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-05-02T06:35:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243684",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_243685.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-05-02T06:36:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243685",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_243686.json:
```json
{
    "body": "But *\"PARI/GP does not gracefully handle out-of-memory\"* is *\"Fixed upstream, but not in a stable release\"*, right?",
    "created_at": "2015-05-02T15:37:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243686",
    "user": "https://github.com/nexttime"
}
```

But *"PARI/GP does not gracefully handle out-of-memory"* is *"Fixed upstream, but not in a stable release"*, right?



---

archive/issue_comments_243687.json:
```json
{
    "body": "Using bzip2 would save 0.5 MB... (2.9 MB vs. 3.4 MB)",
    "created_at": "2015-05-02T16:57:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243687",
    "user": "https://github.com/nexttime"
}
```

Using bzip2 would save 0.5 MB... (2.9 MB vs. 3.4 MB)



---

archive/issue_comments_243688.json:
```json
{
    "body": "With Sage 6.7.beta3 and GCC 5.1.0 on Linux x86_64, PARI and eclib pass their test suites (Lcalc no longer has one), and ptestlong passes modulo one unrelated test (I already reported for 6.7.beta3 on sage-release).\n\nAlso\n\n```sh\n(ulimit -s unlimited; ./sage -t --long src/sage/schemes/elliptic_curves/lseries_ell.py)\n```\n\nworks as expected.\n\nHaven't looked very closely at the patches though.\n\nThe changed behaviour of PARI's `intnum()` should IMHO be documented, on #18342, where also the doctest could be changed (not just its output).",
    "created_at": "2015-05-02T17:19:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243688",
    "user": "https://github.com/nexttime"
}
```

With Sage 6.7.beta3 and GCC 5.1.0 on Linux x86_64, PARI and eclib pass their test suites (Lcalc no longer has one), and ptestlong passes modulo one unrelated test (I already reported for 6.7.beta3 on sage-release).

Also

```sh
(ulimit -s unlimited; ./sage -t --long src/sage/schemes/elliptic_curves/lseries_ell.py)
```

works as expected.

Haven't looked very closely at the patches though.

The changed behaviour of PARI's `intnum()` should IMHO be documented, on #18342, where also the doctest could be changed (not just its output).



---

archive/issue_comments_243689.json:
```json
{
    "body": "P.S.:\n\nThese aren't new, i.e., no regression:\n\n```\n../src/modules/mpqs.c:376:16: warning: array subscript is above array bounds [-Warray-bounds]\n../src/modules/mpqs.c:378:22: warning: array subscript is above array bounds [-Warray-bounds]\n../src/modules/mpqs.c:380:24: warning: array subscript is above array bounds [-Warray-bounds]\n../src/modules/mpqs.c:380:24: warning: array subscript is above array bounds [-Warray-bounds]\n../src/modules/mpqs.c:381:14: warning: array subscript is above array bounds [-Warray-bounds]\n```\n",
    "created_at": "2015-05-02T17:24:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243689",
    "user": "https://github.com/nexttime"
}
```

P.S.:

These aren't new, i.e., no regression:

```
../src/modules/mpqs.c:376:16: warning: array subscript is above array bounds [-Warray-bounds]
../src/modules/mpqs.c:378:22: warning: array subscript is above array bounds [-Warray-bounds]
../src/modules/mpqs.c:380:24: warning: array subscript is above array bounds [-Warray-bounds]
../src/modules/mpqs.c:380:24: warning: array subscript is above array bounds [-Warray-bounds]
../src/modules/mpqs.c:381:14: warning: array subscript is above array bounds [-Warray-bounds]
```




---

archive/issue_comments_243690.json:
```json
{
    "body": "Ok, patches look reasonable as well.",
    "created_at": "2015-05-02T17:38:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243690",
    "user": "https://github.com/nexttime"
}
```

Ok, patches look reasonable as well.



---

archive/issue_comments_243691.json:
```json
{
    "body": "Just triggered a build on a (slow) x86 machine; this will presumably take at least half a day...",
    "created_at": "2015-05-02T21:49:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243691",
    "user": "https://github.com/nexttime"
}
```

Just triggered a build on a (slow) x86 machine; this will presumably take at least half a day...



---

archive/issue_comments_243692.json:
```json
{
    "body": "Looks good to me -- all tests pass (64 bit).  If Leif's test passes OK on a 32-bit machine let's approve this.  Thanks, Jeroen.",
    "created_at": "2015-05-03T10:13:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243692",
    "user": "https://github.com/JohnCremona"
}
```

Looks good to me -- all tests pass (64 bit).  If Leif's test passes OK on a 32-bit machine let's approve this.  Thanks, Jeroen.



---

archive/issue_comments_243693.json:
```json
{
    "body": "Replying to [comment:39 leif]:\n> Just triggered a build on a (slow) x86 machine; this will presumably take at least half a day...\n\nThat was probably an estimate for a few releases ago; the last test run is still in progress...",
    "created_at": "2015-05-03T22:09:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243693",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:39 leif]:
> Just triggered a build on a (slow) x86 machine; this will presumably take at least half a day...

That was probably an estimate for a few releases ago; the last test run is still in progress...



---

archive/issue_comments_243694.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-05-04T06:00:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243694",
    "user": "https://github.com/nexttime"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_243695.json:
```json
{
    "body": "Replying to [comment:41 leif]:\n> Replying to [comment:39 leif]:\n> > Just triggered a build on a (slow) x86 machine; this will presumably take at least half a day...\n> \n> That was probably an estimate for a few releases ago; the last test run is still in progress...\n\nIt finally finished without errors.  (This was on a Pentium4 Prescott, Ubuntu 10.04.4, FSF GCC 4.8.2 with `-O3`, native build, FWIW.)\n\n\n\n\nI haven't tested building with FLTK, but it looks as if PARI's \"configure\" would meanwhile work.",
    "created_at": "2015-05-04T06:00:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243695",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:41 leif]:
> Replying to [comment:39 leif]:
> > Just triggered a build on a (slow) x86 machine; this will presumably take at least half a day...
> 
> That was probably an estimate for a few releases ago; the last test run is still in progress...

It finally finished without errors.  (This was on a Pentium4 Prescott, Ubuntu 10.04.4, FSF GCC 4.8.2 with `-O3`, native build, FWIW.)




I haven't tested building with FLTK, but it looks as if PARI's "configure" would meanwhile work.



---

archive/issue_comments_243696.json:
```json
{
    "body": "Ooops, just noticed `get_fltk.patch` should then also get removed from `patches/README.txt`, but that's really a minor issue.",
    "created_at": "2015-05-04T06:10:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243696",
    "user": "https://github.com/nexttime"
}
```

Ooops, just noticed `get_fltk.patch` should then also get removed from `patches/README.txt`, but that's really a minor issue.



---

archive/issue_comments_243697.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2015-05-04T06:44:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243697",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_243698.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2015-05-04T06:44:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243698",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_243699.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-05-04T06:48:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243699",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_017363.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-05-04T19:04:39Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18103#event-17363"
}
```



---

archive/issue_comments_243700.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-05-04T19:04:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18103#issuecomment-243700",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
