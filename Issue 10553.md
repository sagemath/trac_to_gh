# Issue 10553: Trouble with deepcopy of vectorspaces where the inner product matrix is specified

Issue created by migration from https://trac.sagemath.org/ticket/10606

Original creator: jonhanke

Original creation time: 2011-01-12 20:35:19

Assignee: jason, was

CC:  was jonhanke

Keywords: copy, vectorspace

There are some serious problems using deepcopy on vectorspaces where the inner_product_matrix is specified.  This fails over GF(p) for large primes, and over RR.

Please see also Ticket #10577 for a related problem over GF(2).


```
sage: V = VectorSpace(GF(46337), 2, inner_product_matrix=DiagonalMatrix(ZZ, [1,1]))
sage: deepcopy(V)
Ambient quadratic space of dimension 2 over Finite Field of size 46337
Inner product matrix:
[1 0]
[0 1]
sage: 
sage: V = VectorSpace(GF(46349), 2, inner_product_matrix=DiagonalMatrix(ZZ, [1,1]))
sage: deepcopy(V)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)

/Users/jonhanke/Documents/SAGE/sage-4.6/<ipython console> in <module>()

/Users/jonhanke/Documents/SAGE/sage-4.6/local/lib/python/copy.pyc in deepcopy(x, memo, _nil)
    187                             raise Error(
    188                                 "un(deep)copyable object of type %s" % cls)
--> 189                 y = _reconstruct(x, rv, 1, memo)
    190 
    191     memo[d] = y

/Users/jonhanke/Documents/SAGE/sage-4.6/local/lib/python/copy.pyc in _reconstruct(x, info, deep, memo)
    320         dictiter = None
    321     if deep:
--> 322         args = deepcopy(args, memo)
    323     y = callable(*args)
    324     memo[id(x)] = y

/Users/jonhanke/Documents/SAGE/sage-4.6/local/lib/python/copy.pyc in deepcopy(x, memo, _nil)
    160     copier = _deepcopy_dispatch.get(cls)
    161     if copier:
--> 162         y = copier(x, memo)
    163     else:
    164         try:

/Users/jonhanke/Documents/SAGE/sage-4.6/local/lib/python/copy.pyc in _deepcopy_tuple(x, memo)
    233     y = []
    234     for a in x:
--> 235         y.append(deepcopy(a, memo))
    236     d = id(x)
    237     try:

/Users/jonhanke/Documents/SAGE/sage-4.6/local/lib/python/copy.pyc in deepcopy(x, memo, _nil)
    160     copier = _deepcopy_dispatch.get(cls)
    161     if copier:
--> 162         y = copier(x, memo)
    163     else:
    164         try:

/Users/jonhanke/Documents/SAGE/sage-4.6/local/lib/python/copy.pyc in _deepcopy_tuple(x, memo)
    233     y = []
    234     for a in x:
--> 235         y.append(deepcopy(a, memo))
    236     d = id(x)
    237     try:

/Users/jonhanke/Documents/SAGE/sage-4.6/local/lib/python/copy.pyc in deepcopy(x, memo, _nil)
    171             copier = getattr(x, "__deepcopy__", None)
    172             if copier:
--> 173                 y = copier(memo)
    174             else:
    175                 reductor = dispatch_table.get(cls)

TypeError: __deepcopy__() takes no arguments (1 given)
```





---

Comment by chapoton created at 2018-03-10 07:44:53

Works in 8.2.b7


---

Comment by chapoton created at 2018-03-10 07:44:53

Changing status from new to needs_review.


---

Comment by sbrandhorst created at 2018-03-20 11:12:21

Shouldn't we add a doctest to show the bug is fixed?


---

Comment by tscrim created at 2018-05-05 23:41:43

Replying to [comment:6 sbrandhorst]:
> Shouldn't we add a doctest to show the bug is fixed?

Feel free to add one.


---

Comment by chapoton created at 2018-05-06 06:19:05

doctest added, please review
----
New commits:


---

Comment by tscrim created at 2018-05-06 08:09:12

LGTM.


---

Comment by tscrim created at 2018-05-06 08:09:12

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2018-05-06 08:13:10

Changing priority from critical to minor.


---

Comment by chapoton created at 2018-05-06 10:07:46

there is a typo Z Z


---

Comment by chapoton created at 2018-05-06 10:07:46

Changing status from positive_review to needs_work.


---

Comment by git created at 2018-05-06 10:10:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-05-06 10:10:58

Changing status from needs_work to positive_review.


---

Comment by chapoton created at 2018-05-06 10:10:58

corrected and tested. I am setting back to positive


---

Comment by chapoton created at 2018-05-06 15:25:45

pyflakes plugin is not happy


---

Comment by chapoton created at 2018-05-06 15:25:45

Changing status from positive_review to needs_work.


---

Comment by git created at 2018-05-06 15:27:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-05-06 15:27:53

Changing status from needs_work to positive_review.


---

Comment by chapoton created at 2018-05-06 15:27:53

done, setting back to positive


---

Comment by vbraun created at 2018-05-15 22:33:08

Resolution: fixed
