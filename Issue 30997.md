# Issue 30997: multiplication of matrix with zero columns or rows fails

archive/issues_030997.json:
```json
{
    "body": "Keywords: coercion\n\nFor matrices with zero columns or rows and different base rings (at least when double fields are involved), multiplication fails:\n\n```\nsage: matrix.identity(QQ, 4) * matrix(RDF, 4, 0)\n...\nValueError: matrix is immutable; please change a copy instead (i.e., use copy(M) to change a copy of M).\n\nsage: matrix.identity(RDF, 4) * matrix(QQ, 4, 0)\n...\nValueError: matrix is immutable; please change a copy instead (i.e., use copy(M) to change a copy of M).\n\nsage: matrix(QQ, 0, 4) * matrix.identity(RDF, 4)\n...\nValueError: matrix is immutable; please change a copy instead (i.e., use copy(M) to change a copy of M).\n```\n\n\nUsing `copy()`, as suggested, does not work.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31234\n\n",
    "created_at": "2021-01-13T20:45:40Z",
    "labels": [
        "linear algebra",
        "major",
        "bug"
    ],
    "title": "multiplication of matrix with zero columns or rows fails",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30997",
    "user": "@mwageringel"
}
```
Keywords: coercion

For matrices with zero columns or rows and different base rings (at least when double fields are involved), multiplication fails:

```
sage: matrix.identity(QQ, 4) * matrix(RDF, 4, 0)
...
ValueError: matrix is immutable; please change a copy instead (i.e., use copy(M) to change a copy of M).

sage: matrix.identity(RDF, 4) * matrix(QQ, 4, 0)
...
ValueError: matrix is immutable; please change a copy instead (i.e., use copy(M) to change a copy of M).

sage: matrix(QQ, 0, 4) * matrix.identity(RDF, 4)
...
ValueError: matrix is immutable; please change a copy instead (i.e., use copy(M) to change a copy of M).
```


Using `copy()`, as suggested, does not work.

Issue created by migration from https://trac.sagemath.org/ticket/31234





---

archive/issue_comments_442676.json:
```json
{
    "body": "At least one issue in `change_ring` about subdivisions:\n\n\n```\nsage: A = matrix.identity(QQ, 4)                                                \nsage: A._subdivisions                                                           \nsage: A2 = A.change_ring(RDF)                                                     \nsage: A2._subdivisions                                                          \n( [ 0, 4 ], [ 0, 4 ] )\n```\n\n\ncoming from here\n\n```\nsage: A = matrix.identity(QQ, 4)                                             \nsage: A._subdivisions\nsage: A.subdivide(A.subdivisions())                                             \nsage: A._subdivisions                                                           \n( [ 0, 4 ], [ 0, 4 ] )\n```\n",
    "created_at": "2021-01-14T09:53:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30997#issuecomment-442676",
    "user": "chapoton"
}
```

At least one issue in `change_ring` about subdivisions:


```
sage: A = matrix.identity(QQ, 4)                                                
sage: A._subdivisions                                                           
sage: A2 = A.change_ring(RDF)                                                     
sage: A2._subdivisions                                                          
( [ 0, 4 ], [ 0, 4 ] )
```


coming from here

```
sage: A = matrix.identity(QQ, 4)                                             
sage: A._subdivisions
sage: A.subdivide(A.subdivisions())                                             
sage: A._subdivisions                                                           
( [ 0, 4 ], [ 0, 4 ] )
```




---

archive/issue_comments_442677.json:
```json
{
    "body": "I have found the problem. In `matrix_double_dense.pyx`, the corresponding `_matrix_times_matrix_` has the following:\n\n```\n        if self._nrows == 0 or self._ncols == 0 or right._nrows == 0 or right._ncols == 0:\n            return self.matrix_space(self._nrows, right._ncols).zero_matrix()\n```\n\nSo the result is the *immutable* zero matrix. Compare:\n\n```\nsage: matrix.identity(RDF, 4) * matrix(RDF, 4, 0)\n[]\nsage: _.is_mutable()\nFalse\nsage: matrix.identity(QQ, 4) * matrix(QQ, 4, 0)\n[]\nsage: _.is_mutable()\nTrue\n```\n\nI think the most consistent thing is to return an immutable matrix. So that is what I changed it to.\n----\nNew commits:",
    "created_at": "2021-01-15T09:25:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30997#issuecomment-442677",
    "user": "tscrim"
}
```

I have found the problem. In `matrix_double_dense.pyx`, the corresponding `_matrix_times_matrix_` has the following:

```
        if self._nrows == 0 or self._ncols == 0 or right._nrows == 0 or right._ncols == 0:
            return self.matrix_space(self._nrows, right._ncols).zero_matrix()
```

So the result is the *immutable* zero matrix. Compare:

```
sage: matrix.identity(RDF, 4) * matrix(RDF, 4, 0)
[]
sage: _.is_mutable()
False
sage: matrix.identity(QQ, 4) * matrix(QQ, 4, 0)
[]
sage: _.is_mutable()
True
```

I think the most consistent thing is to return an immutable matrix. So that is what I changed it to.
----
New commits:



---

archive/issue_comments_442678.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-01-15T09:25:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30997#issuecomment-442678",
    "user": "tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_442679.json:
```json
{
    "body": "maybe we can also take the opportunity to fix the un-necessary subdivision ?",
    "created_at": "2021-01-15T13:36:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30997#issuecomment-442679",
    "user": "chapoton"
}
```

maybe we can also take the opportunity to fix the un-necessary subdivision ?



---

archive/issue_comments_442680.json:
```json
{
    "body": "Replying to [comment:1 chapoton]:\n> {{{\n> sage: A = matrix.identity(QQ, 4)                                             \n> sage: A._subdivisions\n> sage: A.subdivide(A.subdivisions())                                             \n> sage: A._subdivisions                                                           \n> ( [ 0, 4 ], [ 0, 4 ] )\n> }}}\n\nIt looks like this is not a problem.\n\n\n```\nsage: A = matrix.identity(QQ, 4)\nsage: A.subdivisions()\n([], [])\nsage: A.subdivide(A.subdivisions())\nsage: A.subdivisions()\n([], [])\n```\n\n\nI assume that `A._subdivisions` contains `[0, 4]` just because it makes it more conventient to work with, internally.",
    "created_at": "2021-01-16T10:37:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30997#issuecomment-442680",
    "user": "@mwageringel"
}
```

Replying to [comment:1 chapoton]:
> {{{
> sage: A = matrix.identity(QQ, 4)                                             
> sage: A._subdivisions
> sage: A.subdivide(A.subdivisions())                                             
> sage: A._subdivisions                                                           
> ( [ 0, 4 ], [ 0, 4 ] )
> }}}

It looks like this is not a problem.


```
sage: A = matrix.identity(QQ, 4)
sage: A.subdivisions()
([], [])
sage: A.subdivide(A.subdivisions())
sage: A.subdivisions()
([], [])
```


I assume that `A._subdivisions` contains `[0, 4]` just because it makes it more conventient to work with, internally.



---

archive/issue_comments_442681.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-16T10:37:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30997#issuecomment-442681",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_442682.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-01-16T10:40:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30997#issuecomment-442682",
    "user": "@mwageringel"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_442683.json:
```json
{
    "body": "Replying to [comment:2 tscrim]:\n> I think the most consistent thing is to return an immutable matrix. So that is what I changed it to.\n\nThank you for the fix. I have removed some trailing whitespace. Other than that, this looks good to me, so I am setting this to positive.",
    "created_at": "2021-01-16T10:40:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30997#issuecomment-442683",
    "user": "@mwageringel"
}
```

Replying to [comment:2 tscrim]:
> I think the most consistent thing is to return an immutable matrix. So that is what I changed it to.

Thank you for the fix. I have removed some trailing whitespace. Other than that, this looks good to me, so I am setting this to positive.



---

archive/issue_comments_442684.json:
```json
{
    "body": "Replying to [comment:3 chapoton]:\n> maybe we can also take the opportunity to fix the un-necessary subdivision ?\n\nI agree that this should be fixed as well. However, I think it is best as a separate ticket, which is now #31254.",
    "created_at": "2021-01-17T01:33:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30997#issuecomment-442684",
    "user": "tscrim"
}
```

Replying to [comment:3 chapoton]:
> maybe we can also take the opportunity to fix the un-necessary subdivision ?

I agree that this should be fixed as well. However, I think it is best as a separate ticket, which is now #31254.



---

archive/issue_comments_442685.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-01-24T10:37:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30997#issuecomment-442685",
    "user": "vbraun"
}
```

Resolution: fixed
