# Issue 30997: multiplication of matrix with zero columns or rows fails

Issue created by migration from https://trac.sagemath.org/ticket/31234

Original creator: @mwageringel

Original creation time: 2021-01-13 20:45:40

Keywords: coercion

For matrices with zero columns or rows and different base rings (at least when double fields are involved), multiplication fails:

```
sage: matrix.identity(QQ, 4) * matrix(RDF, 4, 0)
...
ValueError: matrix is immutable; please change a copy instead (i.e., use copy(M) to change a copy of M).

sage: matrix.identity(RDF, 4) * matrix(QQ, 4, 0)
...
ValueError: matrix is immutable; please change a copy instead (i.e., use copy(M) to change a copy of M).

sage: matrix(QQ, 0, 4) * matrix.identity(RDF, 4)
...
ValueError: matrix is immutable; please change a copy instead (i.e., use copy(M) to change a copy of M).
```


Using `copy()`, as suggested, does not work.


---

Comment by chapoton created at 2021-01-14 09:53:48

At least one issue in `change_ring` about subdivisions:


```
sage: A = matrix.identity(QQ, 4)                                                
sage: A._subdivisions                                                           
sage: A2 = A.change_ring(RDF)                                                     
sage: A2._subdivisions                                                          
( [ 0, 4 ], [ 0, 4 ] )
```


coming from here

```
sage: A = matrix.identity(QQ, 4)                                             
sage: A._subdivisions
sage: A.subdivide(A.subdivisions())                                             
sage: A._subdivisions                                                           
( [ 0, 4 ], [ 0, 4 ] )
```



---

Comment by tscrim created at 2021-01-15 09:25:56

I have found the problem. In `matrix_double_dense.pyx`, the corresponding `_matrix_times_matrix_` has the following:

```
        if self._nrows == 0 or self._ncols == 0 or right._nrows == 0 or right._ncols == 0:
            return self.matrix_space(self._nrows, right._ncols).zero_matrix()
```

So the result is the _immutable_ zero matrix. Compare:

```
sage: matrix.identity(RDF, 4) * matrix(RDF, 4, 0)
[]
sage: _.is_mutable()
False
sage: matrix.identity(QQ, 4) * matrix(QQ, 4, 0)
[]
sage: _.is_mutable()
True
```

I think the most consistent thing is to return an immutable matrix. So that is what I changed it to.
----
New commits:


---

Comment by tscrim created at 2021-01-15 09:25:56

Changing status from new to needs_review.


---

Comment by chapoton created at 2021-01-15 13:36:01

maybe we can also take the opportunity to fix the un-necessary subdivision ?


---

Comment by @mwageringel created at 2021-01-16 10:37:00

Replying to [comment:1 chapoton]:
> {{{
> sage: A = matrix.identity(QQ, 4)                                             
> sage: A._subdivisions
> sage: A.subdivide(A.subdivisions())                                             
> sage: A._subdivisions                                                           
> ( [ 0, 4 ], [ 0, 4 ] )
> }}}

It looks like this is not a problem.


```
sage: A = matrix.identity(QQ, 4)
sage: A.subdivisions()
([], [])
sage: A.subdivide(A.subdivisions())
sage: A.subdivisions()
([], [])
```


I assume that `A._subdivisions` contains `[0, 4]` just because it makes it more conventient to work with, internally.


---

Comment by git created at 2021-01-16 10:37:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mwageringel created at 2021-01-16 10:40:20

Changing status from needs_review to positive_review.


---

Comment by @mwageringel created at 2021-01-16 10:40:20

Replying to [comment:2 tscrim]:
> I think the most consistent thing is to return an immutable matrix. So that is what I changed it to.

Thank you for the fix. I have removed some trailing whitespace. Other than that, this looks good to me, so I am setting this to positive.


---

Comment by tscrim created at 2021-01-17 01:33:28

Replying to [comment:3 chapoton]:
> maybe we can also take the opportunity to fix the un-necessary subdivision ?

I agree that this should be fixed as well. However, I think it is best as a separate ticket, which is now #31254.


---

Comment by vbraun created at 2021-01-24 10:37:07

Resolution: fixed
