# Issue 24403: Avoid order computation in EllipticCurveIsogeny function

archive/issues_024403.json:
```json
{
    "body": "Keywords: elliptic curve, isogeny\n\nWhen computing the points in the kernel set of the isogeny, it is unnecessary and slow to perform the computation of P.order(): slow because computing the order requires factoring the order of E in many cases, and unnecessary because the preceding code block checks that P has finite order, and in the finite order case we can just compute all multiples of P until we get the identity since we need to compute all of these points anyway in order to list the kernel set. For curves of cryptographic size and kernels of small order, we have measured that eliminating the P.order() computation makes the EllipticCurveIsogeny function run 200 times faster.\n\nI (David) discussed this problem with William Stein and Kevin Lui at JMM 2017, and Kevin identified the source of the problem, but seems to have never checked in a fix.\n\nIssue created by migration from https://trac.sagemath.org/ticket/24640\n\n",
    "created_at": "2018-02-01T18:07:03Z",
    "labels": [
        "component: elliptic curves"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Avoid order computation in EllipticCurveIsogeny function",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24403",
    "user": "https://trac.sagemath.org/admin/accounts/users/m3vandyk"
}
```
Keywords: elliptic curve, isogeny

When computing the points in the kernel set of the isogeny, it is unnecessary and slow to perform the computation of P.order(): slow because computing the order requires factoring the order of E in many cases, and unnecessary because the preceding code block checks that P has finite order, and in the finite order case we can just compute all multiples of P until we get the identity since we need to compute all of these points anyway in order to list the kernel set. For curves of cryptographic size and kernels of small order, we have measured that eliminating the P.order() computation makes the EllipticCurveIsogeny function run 200 times faster.

I (David) discussed this problem with William Stein and Kevin Lui at JMM 2017, and Kevin identified the source of the problem, but seems to have never checked in a fix.

Issue created by migration from https://trac.sagemath.org/ticket/24640





---

archive/issue_comments_341491.json:
```json
{
    "body": "This is related to ticket #22161, although our proposed fix is different from Kevin's. (I wasn't sure how to deal with tickets that already have a branch.)\n\nBasically, I am convinced that you never want to compute the group order or even the point order separately, ever. You should just always list all the multiples of P until you repeat back to where you started. In any other context, this would be a **slow** way to compute the point order, but in this context, it's a **free** computation, since you need the entire list of points anyway in order to apply Velu's formulas.",
    "created_at": "2018-02-02T02:55:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24403",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24403#issuecomment-341491",
    "user": "https://github.com/davidjao"
}
```

This is related to ticket #22161, although our proposed fix is different from Kevin's. (I wasn't sure how to deal with tickets that already have a branch.)

Basically, I am convinced that you never want to compute the group order or even the point order separately, ever. You should just always list all the multiples of P until you repeat back to where you started. In any other context, this would be a **slow** way to compute the point order, but in this context, it's a **free** computation, since you need the entire list of points anyway in order to apply Velu's formulas.



---

archive/issue_comments_341492.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-04T19:32:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24403",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24403#issuecomment-341492",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_341493.json:
```json
{
    "body": "Can you add an example demonstrating the speedup?",
    "created_at": "2018-02-04T23:44:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24403",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24403#issuecomment-341493",
    "user": "https://github.com/kevinywlui"
}
```

Can you add an example demonstrating the speedup?



---

archive/issue_comments_341494.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-05T19:31:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24403",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24403#issuecomment-341494",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_341495.json:
```json
{
    "body": "We added a doctest demonstrating the speedup. The test takes around a minute; we can try to think of ways to make it faster. Without our changes, the same test takes practically forever.",
    "created_at": "2018-02-05T19:34:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24403",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24403#issuecomment-341495",
    "user": "https://trac.sagemath.org/admin/accounts/users/m3vandyk"
}
```

We added a doctest demonstrating the speedup. The test takes around a minute; we can try to think of ways to make it faster. Without our changes, the same test takes practically forever.



---

archive/issue_comments_341496.json:
```json
{
    "body": "I changed a few small things:\n\n1) Fixed a line in doctest so that it works with sphnix.\n\n2) Removed the multiples import and removed list.\n\nIs there a smaller example? The current one take me about 75s \n\n```\nsage -t --warn-long ell_curve_isogeny.py\n**********************************************************************\nFile \"ell_curve_isogeny.py\", line 726, in sage.schemes.elliptic_curves.ell_curve_isogeny.EllipticCurveIsogeny\nWarning, slow doctest:\n    phi_v = EllipticCurveIsogeny(EK, P_list); phi_v\nTest ran for 1.72 s\n**********************************************************************\nFile \"ell_curve_isogeny.py\", line 838, in sage.schemes.elliptic_curves.ell_curve_isogeny.EllipticCurveIsogeny\nWarning, slow doctest:\n    iso2 = EL.isogenies_prime_degree(2); len(iso2)\nTest ran for 7.27 s\n**********************************************************************\nFile \"ell_curve_isogeny.py\", line 840, in sage.schemes.elliptic_curves.ell_curve_isogeny.EllipticCurveIsogeny\nWarning, slow doctest:\n    iso3 = EL.isogenies_prime_degree(3); len(iso3)\nTest ran for 9.97 s\n**********************************************************************\nFile \"ell_curve_isogeny.py\", line 852, in sage.schemes.elliptic_curves.ell_curve_isogeny.EllipticCurveIsogeny\nWarning, slow doctest:\n    duals = [phi.dual() for phi in isogs]\nTest ran for 1.46 s\n**********************************************************************\nFile \"ell_curve_isogeny.py\", line 1860, in sage.schemes.elliptic_curves.ell_curve_isogeny.EllipticCurveIsogeny.__init_from_kernel_list\nWarning, slow doctest:\n    p=12*next_prime(2**516)*next_prime(2**543)-1\nTest ran for 1.31 s\n**********************************************************************\nFile \"ell_curve_isogeny.py\", line 1861, in sage.schemes.elliptic_curves.ell_curve_isogeny.EllipticCurveIsogeny.__init_from_kernel_list\nWarning, slow doctest:\n    E=EllipticCurve([GF(p)(1),GF(p)(0)])\nTest ran for 11.81 s\n**********************************************************************\nFile \"ell_curve_isogeny.py\", line 1862, in sage.schemes.elliptic_curves.ell_curve_isogeny.EllipticCurveIsogeny.__init_from_kernel_list\nWarning, slow doctest:\n    P=E(0).division_points(3)[1]\nTest ran for 15.41 s\n    [986 tests, 60.69 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 60.9 seconds\n    cpu time: 54.9 seconds\n    cumulative wall time: 60.7 seconds\n```\n\n----\nNew commits:",
    "created_at": "2018-02-06T05:03:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24403",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24403#issuecomment-341496",
    "user": "https://github.com/kevinywlui"
}
```

I changed a few small things:

1) Fixed a line in doctest so that it works with sphnix.

2) Removed the multiples import and removed list.

Is there a smaller example? The current one take me about 75s 

```
sage -t --warn-long ell_curve_isogeny.py
**********************************************************************
File "ell_curve_isogeny.py", line 726, in sage.schemes.elliptic_curves.ell_curve_isogeny.EllipticCurveIsogeny
Warning, slow doctest:
    phi_v = EllipticCurveIsogeny(EK, P_list); phi_v
Test ran for 1.72 s
**********************************************************************
File "ell_curve_isogeny.py", line 838, in sage.schemes.elliptic_curves.ell_curve_isogeny.EllipticCurveIsogeny
Warning, slow doctest:
    iso2 = EL.isogenies_prime_degree(2); len(iso2)
Test ran for 7.27 s
**********************************************************************
File "ell_curve_isogeny.py", line 840, in sage.schemes.elliptic_curves.ell_curve_isogeny.EllipticCurveIsogeny
Warning, slow doctest:
    iso3 = EL.isogenies_prime_degree(3); len(iso3)
Test ran for 9.97 s
**********************************************************************
File "ell_curve_isogeny.py", line 852, in sage.schemes.elliptic_curves.ell_curve_isogeny.EllipticCurveIsogeny
Warning, slow doctest:
    duals = [phi.dual() for phi in isogs]
Test ran for 1.46 s
**********************************************************************
File "ell_curve_isogeny.py", line 1860, in sage.schemes.elliptic_curves.ell_curve_isogeny.EllipticCurveIsogeny.__init_from_kernel_list
Warning, slow doctest:
    p=12*next_prime(2**516)*next_prime(2**543)-1
Test ran for 1.31 s
**********************************************************************
File "ell_curve_isogeny.py", line 1861, in sage.schemes.elliptic_curves.ell_curve_isogeny.EllipticCurveIsogeny.__init_from_kernel_list
Warning, slow doctest:
    E=EllipticCurve([GF(p)(1),GF(p)(0)])
Test ran for 11.81 s
**********************************************************************
File "ell_curve_isogeny.py", line 1862, in sage.schemes.elliptic_curves.ell_curve_isogeny.EllipticCurveIsogeny.__init_from_kernel_list
Warning, slow doctest:
    P=E(0).division_points(3)[1]
Test ran for 15.41 s
    [986 tests, 60.69 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 60.9 seconds
    cpu time: 54.9 seconds
    cumulative wall time: 60.7 seconds
```

----
New commits:



---

archive/issue_comments_341497.json:
```json
{
    "body": "Thanks Kevin! Here's a smaller example that takes under 2 seconds with the patch, and still takes a very long time without the patch. (Hopefully integer factorization algorithms in the future will not improve to the point where the second part of the previous sentence becomes false.) I also added a speed optimization in the field creation step to help things along.\n\n```\np = 12 * next_prime(2^246) * next_prime(2^247) - 1\nF = FiniteField(p, proof=False)\nE = EllipticCurve([F(1), F(0)])\nP = E(0).division_points(3)[1]\nEllipticCurveIsogeny(E, P)\n```\n",
    "created_at": "2018-02-06T05:16:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24403",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24403#issuecomment-341497",
    "user": "https://github.com/davidjao"
}
```

Thanks Kevin! Here's a smaller example that takes under 2 seconds with the patch, and still takes a very long time without the patch. (Hopefully integer factorization algorithms in the future will not improve to the point where the second part of the previous sentence becomes false.) I also added a speed optimization in the field creation step to help things along.

```
p = 12 * next_prime(2^246) * next_prime(2^247) - 1
F = FiniteField(p, proof=False)
E = EllipticCurve([F(1), F(0)])
P = E(0).division_points(3)[1]
EllipticCurveIsogeny(E, P)
```




---

archive/issue_comments_341498.json:
```json
{
    "body": "We have updated our branch to include the faster doctest.\n----\nNew commits:",
    "created_at": "2018-02-06T19:18:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24403",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24403#issuecomment-341498",
    "user": "https://trac.sagemath.org/admin/accounts/users/m3vandyk"
}
```

We have updated our branch to include the faster doctest.
----
New commits:



---

archive/issue_comments_341499.json:
```json
{
    "body": "Sorry to bug you again. But is there a even smaller example? I think the doctests are suppose to take under a second. Alternatively, you can flag it as a long test.\n\nhttp://doc.sagemath.org/html/en/developer/doctesting.html#run-long-doctests\n\nAs a side question, how are you able to come up with these primes?\n\nAfter this, it should be go to go. Can you set the ticket as 'need review'? and I can give it a positive review.",
    "created_at": "2018-02-07T00:37:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24403",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24403#issuecomment-341499",
    "user": "https://github.com/kevinywlui"
}
```

Sorry to bug you again. But is there a even smaller example? I think the doctests are suppose to take under a second. Alternatively, you can flag it as a long test.

http://doc.sagemath.org/html/en/developer/doctesting.html#run-long-doctests

As a side question, how are you able to come up with these primes?

After this, it should be go to go. Can you set the ticket as 'need review'? and I can give it a positive review.



---

archive/issue_comments_341500.json:
```json
{
    "body": "You just pick random exponents until the resulting p is a prime. What you want is:\n\n* p is not too large (so that the test runs fast)\n* factoring p+1 takes a long time (so that the test demonstrates the need for avoiding factoring p+1)\n\nHowever, I'm worried that if p is too small then improvements in future factoring technology will render the second point false while still not invalidating the main conclusion that factoring is too slow and should be avoided in general. I think the lowest we should go is (180, 194). This runs in under 1 second on my machine.\n\nThe full test is then:\n\n\n```\np = 12 * next_prime(2^180) * next_prime(2^194) - 1\nF = FiniteField(p, proof=False)\nE = EllipticCurve([F(1), F(0)])\nP = E(0).division_points(3)[1]\nEllipticCurveIsogeny(E, P)\n```\n",
    "created_at": "2018-02-07T01:39:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24403",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24403#issuecomment-341500",
    "user": "https://github.com/davidjao"
}
```

You just pick random exponents until the resulting p is a prime. What you want is:

* p is not too large (so that the test runs fast)
* factoring p+1 takes a long time (so that the test demonstrates the need for avoiding factoring p+1)

However, I'm worried that if p is too small then improvements in future factoring technology will render the second point false while still not invalidating the main conclusion that factoring is too slow and should be avoided in general. I think the lowest we should go is (180, 194). This runs in under 1 second on my machine.

The full test is then:


```
p = 12 * next_prime(2^180) * next_prime(2^194) - 1
F = FiniteField(p, proof=False)
E = EllipticCurve([F(1), F(0)])
P = E(0).division_points(3)[1]
EllipticCurveIsogeny(E, P)
```




---

archive/issue_comments_341501.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-07T14:02:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24403",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24403#issuecomment-341501",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_341502.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-02-07T14:08:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24403",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24403#issuecomment-341502",
    "user": "https://trac.sagemath.org/admin/accounts/users/m3vandyk"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_341503.json:
```json
{
    "body": "I have changed the status to 'needs review' and the branch has been updated to include the faster doctest. The doctest runs in under 1 second on my machine as well.",
    "created_at": "2018-02-07T14:08:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24403",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24403#issuecomment-341503",
    "user": "https://trac.sagemath.org/admin/accounts/users/m3vandyk"
}
```

I have changed the status to 'needs review' and the branch has been updated to include the faster doctest. The doctest runs in under 1 second on my machine as well.



---

archive/issue_comments_341504.json:
```json
{
    "body": "I made a small aesthetic change which was to fix some trailing spaces.\n\nI only made trivial code changes to this ticket so I hope it's okay that I'm the reviewer and am giving it a positive review.\n----\nNew commits:",
    "created_at": "2018-02-08T02:01:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24403",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24403#issuecomment-341504",
    "user": "https://github.com/kevinywlui"
}
```

I made a small aesthetic change which was to fix some trailing spaces.

I only made trivial code changes to this ticket so I hope it's okay that I'm the reviewer and am giving it a positive review.
----
New commits:



---

archive/issue_comments_341505.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-02-08T02:02:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24403",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24403#issuecomment-341505",
    "user": "https://github.com/kevinywlui"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_341506.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-02-08T03:37:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24403",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24403#issuecomment-341506",
    "user": "https://github.com/tscrim"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_341507.json:
```json
{
    "body": "Reviewer name missing.",
    "created_at": "2018-02-08T03:37:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24403",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24403#issuecomment-341507",
    "user": "https://github.com/tscrim"
}
```

Reviewer name missing.



---

archive/issue_comments_341508.json:
```json
{
    "body": "Opps. Sorry!",
    "created_at": "2018-02-08T04:39:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24403",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24403#issuecomment-341508",
    "user": "https://github.com/kevinywlui"
}
```

Opps. Sorry!



---

archive/issue_comments_341509.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2018-02-08T04:39:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24403",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24403#issuecomment-341509",
    "user": "https://github.com/kevinywlui"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_events_022785.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-02-09T23:47:26Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24403",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24403#event-22785"
}
```



---

archive/issue_comments_341510.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-02-09T23:47:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24403",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24403#issuecomment-341510",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
