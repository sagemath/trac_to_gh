# Issue 29064: sage-spkg: Add an option -w for warning only if spkg-check fails

Issue created by migration from https://trac.sagemath.org/ticket/29301

Original creator: mkoeppe

Original creation time: 2020-03-09 01:54:37

CC:  dimpase jhpalmieri

This would be useful for automated builds using `make -k SAGE_SPKG="sage-spkg -w"`


---

Comment by mkoeppe created at 2020-03-12 21:46:00

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-03-12 21:46:00

New commits:


---

Comment by jhpalmieri created at 2020-03-12 22:58:52

If you set `SAGE_CHECK=warn`, it doesn't behave just like passing the `-w` flag to `sage-spkg`: the latter sets `SAGE_CHECK_PACKAGES=x`, while the former does not. Therefore the default setting `SAGE_CHECK_PACKAGES='!python2,!python3'` gets used with the former.

What is the intent?

(Aside: should flags like `-c` and now `-w` also have corresponding Makefile targets? We shouldn't have to set environment variables to do this.)


---

Comment by mkoeppe created at 2020-03-12 23:07:15

Replying to [comment:4 jhpalmieri]:
> If you set `SAGE_CHECK=warn`, it doesn't behave just like passing the `-w` flag to `sage-spkg`: the latter sets `SAGE_CHECK_PACKAGES=x`, while the former does not. Therefore the default setting `SAGE_CHECK_PACKAGES='!python2,!python3'` gets used with the former.
> 
> What is the intent?

I set SAGE_CHECK=warn to enable this behavior as a default for all packages. I don't see why the default `SAGE_CHECK_PACKAGES='!python2,!python3'` should not apply. In my test scripts, I set `SAGE_CHECK_PACKAGES` to more exclusions (for example, ppl has a testsuite that takes very long.)

> (Aside: should flags like `-c` and now `-w` also have corresponding Makefile targets? We shouldn't have to set environment variables to do this.)

Makefile targets, I don't think. We could make it `configure` options though. (In some follow-up ticket.)


---

Comment by jhpalmieri created at 2020-03-12 23:21:06

I think that if `SAGE_CHECK=warn` and if `SAGE_CHECK_PACKAGES` is empty, then everything should be tested, even Python. (The reason for skipping Python is not because it takes a long time, but rather to avoid `make` stopping when Python's tests fail.) Otherwise, do I need to set `SAGE_CHECK_PACKAGES` to some artificial setting to test all packages, including Python?

If `SAGE_CHECK_PACKAGES` is not empty, then setting `SAGE_CHECK=warn` should not affect that.

Re Makefile targets vs. configure: it feels more standard to have `make check` or similar, rather than have it be a configure option. Not to be done on this ticket, either way.


---

Comment by git created at 2020-03-12 23:31:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-12 23:32:38

Is this doing what you have in mind?


---

Comment by jhpalmieri created at 2020-03-13 00:05:51

At first glance it looks good, but I have to test it. Ideally if I run `make` with `SAGE_CHECK=warn`, then there would be summary information at the end. ("The build succeeded but the following packages failed their test suites: ...") Any ideas how to do that?


---

Comment by mkoeppe created at 2020-03-13 00:42:32

Well, the code for the summary "The following package(s) may have failed to build..." is currently only run on failure.
I suppose we could run it on success too if `SAGE_CHECK=warn`...


---

Comment by dimpase created at 2020-03-24 17:38:25

OK, seems to work


---

Comment by dimpase created at 2020-03-24 17:38:25

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-03-24 17:43:32

Thanks! Further refinements can be done on a follow-up ticket.


---

Comment by jhpalmieri created at 2020-03-24 21:38:00

Followup at #29402.


---

Comment by vbraun created at 2020-03-29 00:24:02

Resolution: fixed
