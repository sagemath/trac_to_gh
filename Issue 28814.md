# Issue 28814: Paths configured in installed numpy site.cfg [DEFAULT/ALL] do not affect scipy

Issue created by migration from https://trac.sagemath.org/ticket/29051

Original creator: mkoeppe

Original creation time: 2020-01-20 14:37:57

CC:  fbissey dimpase @mwageringel vbraun

This is from #27824 comments 60, 61, 62, 68. Observed on Ubuntu with system BLAS, after #29025, which makes numpy find BLAS. https://trac.sagemath.org/attachment/ticket/27824/Dockerfile-ubuntu-minimal



Previous related tickets:
- #20157: make numpy and scipy use `pkg-config` to find `blas/lapack`
- #22047: Scipy fails to build with ATLAS
- #29025: numpy: `site.cfg` needs a `[DEFAULT]` section

-------

References:

scipy/setup.py at master · scipy/scipy
https://github.com/scipy/scipy/blob/master/scipy/setup.py

numpy/system_info.py at master · numpy/numpy
https://github.com/numpy/numpy/blob/master/numpy/distutils/system_info.py

python - How to check BLAS/LAPACK linkage in NumPy and SciPy? - Stack Overflow
https://stackoverflow.com/questions/9000164/how-to-check-blas-lapack-linkage-in-numpy-and-scipy


---

Comment by dimpase created at 2020-01-24 23:03:19

I now see this on Arch on #29071 (with openblas from the system)


---

Comment by dimpase created at 2020-01-25 09:28:01

#29025 broke buidling scipy with system's OpenBLAS. I'm now looking into how to tweak  
`numpy/distutils/site.cfg` to make it work, but it is not obvious. Probably there are more bugs there (in numpy).


---

Comment by dimpase created at 2020-01-25 09:28:01

Changing priority from major to blocker.


---

Comment by fbissey created at 2020-01-25 09:49:24

Something that weirded me a bit in #29025. Why keep the `[ALL]` section at all? I cannot be sure that's the root cause but I would start by cleaning that.


---

Comment by dimpase created at 2020-01-25 10:31:14

it's a bloody mess, if you read the numpy issue linked at #29025 - some numpy config functions use `[ALL]` section.

Removing `[DEFAULT]` section allows the build with system OpenBLAS to work again,
so there is clearly something amiss. I messed up while testing #29025 and so it went through.


---

Comment by dimpase created at 2020-01-25 13:02:10

Should we just revert  #29025 ?
(at the moment it's not needed anywhere expect in not yet ready tickers)

I don't see an easy fix for it, without digging into numpy mess.


---

Comment by mkoeppe created at 2020-01-25 13:33:10

After reverting, is [ALL] needed?


---

Comment by dimpase created at 2020-01-25 19:45:08

No, [ALL] with just paths in it has no effect, according to numpy people.
So it should be removed.

What was the orginal need for [DEFAULT] in #29025 ?


---

Comment by dimpase created at 2020-01-25 19:46:51


```
[blas]
libraries  = openblas
[lapack]
libraries  = openblas
```

seems to work just as well.


---

Comment by fbissey created at 2020-01-25 20:27:39

If we did the work properly with the like of `CPATH` and `LIBRARY_PATH` we should be able to drop `[ALL]`/`[DEFAULT]` completely. These section just define additional default paths for headers and libraries to be used in numpy.


---

Comment by dimpase created at 2020-01-26 09:50:14

New commits:


---

Comment by dimpase created at 2020-01-26 09:50:14

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-01-26 11:12:54

Replying to [comment:10 fbissey]:
> If we did the work properly with the like of `CPATH` and `LIBRARY_PATH` we should be able to drop `[ALL]`/`[DEFAULT]` completely. These section just define additional default paths for headers and libraries to be used in numpy.

IMHO all these paths are better set up per library-specific section (`[blas]` etc.)
than via "globals" like `LIBRARY_PATH`.


---

Attachment


---

Attachment

Thanks to Dima (and #29071 and the branch here), I got Sage compile up to numpy. It ends up with some linking trouble. See
- [config.log](https://trac.sagemath.org/raw-attachment/ticket/29051/vdelecroix-config.log)
- [numpy-1.16.1.log](https://trac.sagemath.org/raw-attachment/ticket/29051/vdelecroix-numpy-1.16.1.log)


---

Comment by dimpase created at 2020-01-26 15:10:07

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2020-01-26 15:10:07

Replying to [comment:13 vdelecroix]:
> Thanks to Dima (and #29071 and the branch here), I got Sage compile up to numpy. It ends up with some linking trouble. See
> - [config.log](https://trac.sagemath.org/raw-attachment/ticket/29051/vdelecroix-config.log)
> - [numpy-1.16.1.log](https://trac.sagemath.org/raw-attachment/ticket/29051/vdelecroix-numpy-1.16.1.log)

thanks, it's the same Arch-specific issue again - more precisely, numpy does not know about cblas. Testing on Debian wasn't enough.


---

Comment by git created at 2020-01-26 16:02:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-01-26 16:11:55

the commit at comment:15 fixes the latest problem.
I've also left a comment on this here: https://github.com/numpy/numpy/pull/15338#issuecomment-578516788


---

Comment by dimpase created at 2020-01-26 16:11:55

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-01-26 16:45:27

Testing at https://github.com/mkoeppe/sage/actions?query=workflow%3A%22Run+SAGE_ROOT%2Ftox.ini%22
with #29053


---

Comment by vdelecroix created at 2020-01-26 17:16:27

At `​dba7aef`, success for me!


---

Comment by mkoeppe created at 2020-01-27 14:51:57

Errors on various platforms tested at https://github.com/mkoeppe/sage/actions/runs/31716135. Examples:

- archlinux-latest-standard at https://github.com/mkoeppe/sage/runs/410329835:
  configure finds system openblas, then installing R from source fails with openblas-related errors

- ubuntu-bionic-minimal
   builds openblas from source, then installing R from source fails with openblas-related errors

- fedora-32-standard
   configure fails to detect openblas, error building openblas from source


---

Comment by mkoeppe created at 2020-01-27 14:51:57

Changing status from needs_review to needs_work.


---

Comment by fbissey created at 2020-01-27 19:18:40

Replying to [comment:19 mkoeppe]:
> Errors on various platforms tested at https://github.com/mkoeppe/sage/actions/runs/31716135. Examples:
> 
> - archlinux-latest-standard at https://github.com/mkoeppe/sage/runs/410329835:
>   configure finds system openblas, then installing R from source fails with openblas-related errors
> 
> - ubuntu-bionic-minimal
>    builds openblas from source, then installing R from source fails with openblas-related errors
> 
> - fedora-32-standard
>    configure fails to detect openblas, error building openblas from source
> 

I'll be honest. None of these failures can be a result of this ticket. May be the git branch needs rebasing to include some fix for those separate issues.


---

Comment by mkoeppe created at 2020-01-27 19:54:00

Changing status from needs_work to positive_review.


---

Comment by mkoeppe created at 2020-01-27 19:54:00

Yes, this fix should definitely go into the next beta.


---

Comment by mkoeppe created at 2020-01-27 19:59:36

Follow-up for the other build issues related to BLAS at #29088.


---

Comment by fbissey created at 2020-01-27 20:04:44

Replying to [comment:21 mkoeppe]:
> Yes, this fix should definitely go into the next beta.

Note that Volker silently released 9.1.beta2 yesterday. Should ping him to make a proper announcement.


---

Comment by jhpalmieri created at 2020-01-27 21:01:51

I just downloaded the 9.1.beta2 tarball today, and on an Ubuntu virtual machine it fails on `scipy`, complaining about `blas`:

```
    Traceback (most recent call last):
      File "<string>", line 1, in <module>
      File "/tmp/pip-req-build-7agkks4g/setup.py", line 492, in <module>
        setup_package()
      File "/tmp/pip-req-build-7agkks4g/setup.py", line 488, in setup_package
        setup(**metadata)
      File "/home/john/Sage/sage-9.1.beta2/local/lib/python3.7/site-packages/numpy/distutils/core.py", line 137, in setup
        config = configuration()
      File "/tmp/pip-req-build-7agkks4g/setup.py", line 395, in configuration
        raise NotFoundError(msg)
    numpy.distutils.system_info.NotFoundError: No lapack/blas resources found.
```

The main Sage `config.log` file says

```
configure:22549: result:     openblas-0.3.6.p0 will not be installed (configure check)
```

Am I doing something wrong?


---

Comment by fbissey created at 2020-01-27 21:05:02

Replying to [comment:24 jhpalmieri]:
> Am I doing something wrong?

No you are not. This ticket is supposed to deal with the stuff you just experienced. But this ticket is not included in 9.1.beta2, so it is effectively broken for external openblas.


---

Comment by jhpalmieri created at 2020-01-27 21:09:51

Replying to [comment:25 fbissey]:
> Replying to [comment:24 jhpalmieri]:
> > Am I doing something wrong?
> 
> No you are not. This ticket is supposed to deal with the stuff you just experienced. But this ticket is not included in 9.1.beta2, so it is effectively broken for external openblas.

I just realized that, too. When I merge this, `acipy` builds.


---

Comment by mkoeppe created at 2020-01-28 16:23:26

Follow-up = #29071.


---

Comment by vbraun created at 2020-01-31 00:23:37

Resolution: fixed
