# Issue 23282: SAGE_FAT_BINARY fails on Debian 9 64-bit

archive/issues_023282.json:
```json
{
    "body": "CC:  wbhart slelievre dunfield mkoeppe @kliem\n\nWhen building ecm there are lots of errors of the form\n\n```\n[ecm-7.0.4.p0] /home/buildbot/slave/binary_pkg/build/source/SageMath/jc4b6yulaujayb9sr94ia88eourzeqip0oidmas391yaj2/local/lib/libgmp.a(fat_entry.o): In function `__gmpn_mod_34lsub1':\n[ecm-7.0.4.p0] /home/buildbot/slave/binary_pkg/build/source/SageMath/jc4b6yulaujayb9sr94ia88eourzeqip0oidmas391yaj2/local/var/tmp/sage/build/mpir-3.0.0.p0/src/mpn/tmp-fat_entry.s:202: multiple definition of `__gmpn_mod_34lsub1'\n[ecm-7.0.4.p0] ./.libs/libecm.a(libecm_la-schoen_strass.o):/home/buildbot/slave/binary_pkg/build/source/SageMath/jc4b6yulaujayb9sr94ia88eourzeqip0oidmas391yaj2/local/var/tmp/sage/build/ecm-7.0.4.p0/src/schoen_strass.c:61: first defined here\n[ecm-7.0.4.p0] /usr/bin/ld: /home/buildbot/slave/binary_pkg/build/source/SageMath/jc4b6yulaujayb9sr94ia88eourzeqip0oidmas391yaj2/local/lib/libgmp.a(fat_entry.o): relocation R_X86_64_32S against symbol `__gmpn_cpuvec' can not be used when making a shared object; recompile with -fPIC\n[ecm-7.0.4.p0] /usr/bin/ld: final link failed: Nonrepresentable section on output\n[ecm-7.0.4.p0] collect2: error: ld returned 1 exit status\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/23519\n\n",
    "created_at": "2017-07-22T16:28:06Z",
    "labels": [
        "build",
        "major",
        "bug"
    ],
    "title": "SAGE_FAT_BINARY fails on Debian 9 64-bit",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23282",
    "user": "vbraun"
}
```
CC:  wbhart slelievre dunfield mkoeppe @kliem

When building ecm there are lots of errors of the form

```
[ecm-7.0.4.p0] /home/buildbot/slave/binary_pkg/build/source/SageMath/jc4b6yulaujayb9sr94ia88eourzeqip0oidmas391yaj2/local/lib/libgmp.a(fat_entry.o): In function `__gmpn_mod_34lsub1':
[ecm-7.0.4.p0] /home/buildbot/slave/binary_pkg/build/source/SageMath/jc4b6yulaujayb9sr94ia88eourzeqip0oidmas391yaj2/local/var/tmp/sage/build/mpir-3.0.0.p0/src/mpn/tmp-fat_entry.s:202: multiple definition of `__gmpn_mod_34lsub1'
[ecm-7.0.4.p0] ./.libs/libecm.a(libecm_la-schoen_strass.o):/home/buildbot/slave/binary_pkg/build/source/SageMath/jc4b6yulaujayb9sr94ia88eourzeqip0oidmas391yaj2/local/var/tmp/sage/build/ecm-7.0.4.p0/src/schoen_strass.c:61: first defined here
[ecm-7.0.4.p0] /usr/bin/ld: /home/buildbot/slave/binary_pkg/build/source/SageMath/jc4b6yulaujayb9sr94ia88eourzeqip0oidmas391yaj2/local/lib/libgmp.a(fat_entry.o): relocation R_X86_64_32S against symbol `__gmpn_cpuvec' can not be used when making a shared object; recompile with -fPIC
[ecm-7.0.4.p0] /usr/bin/ld: final link failed: Nonrepresentable section on output
[ecm-7.0.4.p0] collect2: error: ld returned 1 exit status
```


Issue created by migration from https://trac.sagemath.org/ticket/23519





---

archive/issue_comments_325863.json:
```json
{
    "body": "`__gmpn_cpuvec` in `libgmp.a`... possibly related to our recent MPIR upgrade?",
    "created_at": "2017-08-07T21:19:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23282#issuecomment-325863",
    "user": "vdelecroix"
}
```

`__gmpn_cpuvec` in `libgmp.a`... possibly related to our recent MPIR upgrade?



---

archive/issue_comments_325864.json:
```json
{
    "body": "It says to rebuild `libgmp.a` with `-fPIC`.  My personal feeling is that insisting on linking `ecm` against `libgmp.a` for a little bit of performance is misguided at best.",
    "created_at": "2017-08-07T23:46:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23282#issuecomment-325864",
    "user": "fbissey"
}
```

It says to rebuild `libgmp.a` with `-fPIC`.  My personal feeling is that insisting on linking `ecm` against `libgmp.a` for a little bit of performance is misguided at best.



---

archive/issue_comments_325865.json:
```json
{
    "body": "Two sage-devel postings about this:\n\nhttps://groups.google.com/d/msg/sage-devel/Jl071EqambM/yr4_RvjbBQAJ\n\nhttps://groups.google.com/d/msg/sage-devel/W9iVNPsIJVA/3EQO__OxAwAJ\n\nSeems some of this was already known in mpir and ecm:\n\n\n\n```\n(sage-sh) jan@muizenberg:sage-8.0$ grep SAGE_FAT_BINARY build/pkgs/*/spkg-install|grep not\nbuild/pkgs/ecm/spkg-install:    echo >&2 \"Warning: SAGE_FAT_BINARY is currently not really supported by this package.\"\nbuild/pkgs/mpir/spkg-install:            echo \"Cannot build with SAGE_FAT_BINARY=yes.\"\n(sage-sh) jan@muizenberg:sage-8.0$\n```\n",
    "created_at": "2017-09-21T06:56:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23282#issuecomment-325865",
    "user": "pipedream"
}
```

Two sage-devel postings about this:

https://groups.google.com/d/msg/sage-devel/Jl071EqambM/yr4_RvjbBQAJ

https://groups.google.com/d/msg/sage-devel/W9iVNPsIJVA/3EQO__OxAwAJ

Seems some of this was already known in mpir and ecm:



```
(sage-sh) jan@muizenberg:sage-8.0$ grep SAGE_FAT_BINARY build/pkgs/*/spkg-install|grep not
build/pkgs/ecm/spkg-install:    echo >&2 "Warning: SAGE_FAT_BINARY is currently not really supported by this package."
build/pkgs/mpir/spkg-install:            echo "Cannot build with SAGE_FAT_BINARY=yes."
(sage-sh) jan@muizenberg:sage-8.0$
```




---

archive/issue_comments_325866.json:
```json
{
    "body": "This is possibly gcc 6.2 related:\nhttps://mail.coreboot.org/pipermail/coreboot/2016-December/082739.html\n\nAnd a possible solution is Build GMP `--with-pic`, (only) if GCC defaults to `-pie` (preferred solution from reading the rest of above thread to the end).\n\nUPDATE: --with-pic did not work for me; trying now with CFLAGS=\"-fPIC\"\n\nUPDATE2:\nexport CFLAGS=\"--with-pic\"; ./sage -f mpir; make # failed to build\nexport CFLAGS=\"-fPIC\"; ./sage -f mpir; make # completed build (well most packages except doc-html eventually failed to build with OSError: [Errno 12] Cannot allocate memory in a 4G Virtual Machine.\n\nUPDATE 3: From scratch start with\nexport CFLAGS=\"-fPIC\" CXXFLAGS=\"-fPIC\" SAGE_FAT_BINARY=yes\nmake # ecm failed to build",
    "created_at": "2017-09-21T07:21:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23282#issuecomment-325866",
    "user": "pipedream"
}
```

This is possibly gcc 6.2 related:
https://mail.coreboot.org/pipermail/coreboot/2016-December/082739.html

And a possible solution is Build GMP `--with-pic`, (only) if GCC defaults to `-pie` (preferred solution from reading the rest of above thread to the end).

UPDATE: --with-pic did not work for me; trying now with CFLAGS="-fPIC"

UPDATE2:
export CFLAGS="--with-pic"; ./sage -f mpir; make # failed to build
export CFLAGS="-fPIC"; ./sage -f mpir; make # completed build (well most packages except doc-html eventually failed to build with OSError: [Errno 12] Cannot allocate memory in a 4G Virtual Machine.

UPDATE 3: From scratch start with
export CFLAGS="-fPIC" CXXFLAGS="-fPIC" SAGE_FAT_BINARY=yes
make # ecm failed to build



---

archive/issue_comments_325867.json:
```json
{
    "body": "It seems a binary successfully built on sage 8.1 on Debian 9. Not sure what changed and whether this can be closed.",
    "created_at": "2018-01-01T14:43:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23282#issuecomment-325867",
    "user": "pipedream"
}
```

It seems a binary successfully built on sage 8.1 on Debian 9. Not sure what changed and whether this can be closed.



---

archive/issue_comments_325868.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-01-01T21:25:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23282#issuecomment-325868",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_325869.json:
```json
{
    "body": "Resolution changed from fixed to ",
    "created_at": "2018-04-29T11:24:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23282#issuecomment-325869",
    "user": "embray"
}
```

Resolution changed from fixed to 



---

archive/issue_comments_325870.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2018-04-29T11:24:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23282#issuecomment-325870",
    "user": "embray"
}
```

Changing status from closed to new.



---

archive/issue_comments_325871.json:
```json
{
    "body": "This is still an issue, per mailing list discussion at https://groups.google.com/d/msg/sage-devel/isGlUdvsYo8/Ldy5wVFKAAAJ",
    "created_at": "2018-04-29T11:24:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23282#issuecomment-325871",
    "user": "embray"
}
```

This is still an issue, per mailing list discussion at https://groups.google.com/d/msg/sage-devel/isGlUdvsYo8/Ldy5wVFKAAAJ



---

archive/issue_comments_325872.json:
```json
{
    "body": "I added `--with-pic` to the MPIR build when using `SAGE_FAT_BINARY=yes` (just for 64-bit) and it seems to be happy with that.",
    "created_at": "2018-04-29T15:41:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23282#issuecomment-325872",
    "user": "embray"
}
```

I added `--with-pic` to the MPIR build when using `SAGE_FAT_BINARY=yes` (just for 64-bit) and it seems to be happy with that.



---

archive/issue_comments_325873.json:
```json
{
    "body": "I'm seeing this with Ubuntu 18.04.3 (the latest 18.04 on DockerHub).  I'm working around it sadly by building sage twice, once after deleting `libgmp.a`.   Search for the word \"stupid\" in https://github.com/sagemathinc/cocalc-docker/blob/master/scripts/install_sage.sh",
    "created_at": "2020-05-13T20:57:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23282#issuecomment-325873",
    "user": "was"
}
```

I'm seeing this with Ubuntu 18.04.3 (the latest 18.04 on DockerHub).  I'm working around it sadly by building sage twice, once after deleting `libgmp.a`.   Search for the word "stupid" in https://github.com/sagemathinc/cocalc-docker/blob/master/scripts/install_sage.sh



---

archive/issue_comments_325874.json:
```json
{
    "body": "See also: #28890 Install fewer static libraries",
    "created_at": "2020-05-13T21:45:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23282#issuecomment-325874",
    "user": "mkoeppe"
}
```

See also: #28890 Install fewer static libraries



---

archive/issue_comments_325875.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-09-25T19:33:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23282#issuecomment-325875",
    "user": "mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_325876.json:
```json
{
    "body": "Likely outdated after #28890",
    "created_at": "2021-09-25T19:33:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23282#issuecomment-325876",
    "user": "mkoeppe"
}
```

Likely outdated after #28890
