# Issue 13452: cached functions cannot be used as evalf

archive/issues_013452.json:
```json
{
    "body": "Assignee: @jasongrout\n\nAn error occurs when trying to use a cached function as the `evalf_func` argument to function. The error seems to be that some part of sage assumes that it can compute a hash value using `evalf_func`'s `func_code` attribute, which a cached function object doesn't have.\n\n\n```\nsage: def evalf(self, x, parent=complex):\n....:     return 20\n....: \nsage: f = function('f', evalf_func=evalf)\nsage: @cached_function\n....: def evalg(self, x, parent=complex):\n....:     return 30\n....: \nsage: g = function('g', evalf_func=evalg)\nException AttributeError: \"'sage.misc.cachefunc.CachedFunction' object has no attribute 'func_code'\" in 'sage.symbolic.function.SymbolicFunction._hash_' ignored\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/13656\n\n",
    "created_at": "2012-10-26T15:35:39Z",
    "labels": [
        "misc",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "cached functions cannot be used as evalf",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13452",
    "user": "@tkluck"
}
```
Assignee: @jasongrout

An error occurs when trying to use a cached function as the `evalf_func` argument to function. The error seems to be that some part of sage assumes that it can compute a hash value using `evalf_func`'s `func_code` attribute, which a cached function object doesn't have.


```
sage: def evalf(self, x, parent=complex):
....:     return 20
....: 
sage: f = function('f', evalf_func=evalf)
sage: @cached_function
....: def evalg(self, x, parent=complex):
....:     return 30
....: 
sage: g = function('g', evalf_func=evalg)
Exception AttributeError: "'sage.misc.cachefunc.CachedFunction' object has no attribute 'func_code'" in 'sage.symbolic.function.SymbolicFunction._hash_' ignored
```


Issue created by migration from https://trac.sagemath.org/ticket/13656





---

archive/issue_comments_165881.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-10-26T15:51:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13452",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13452#issuecomment-165881",
    "user": "@tkluck"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_165882.json:
```json
{
    "body": "I've attached a simple patch that lets cached functions expose its underlying function's attributes. Maybe that's overkill?",
    "created_at": "2012-10-26T15:51:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13452",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13452#issuecomment-165882",
    "user": "@tkluck"
}
```

I've attached a simple patch that lets cached functions expose its underlying function's attributes. Maybe that's overkill?



---

archive/issue_comments_165883.json:
```json
{
    "body": "a preliminary fix",
    "created_at": "2012-10-26T15:52:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13452",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13452#issuecomment-165883",
    "user": "@tkluck"
}
```

a preliminary fix



---

archive/issue_comments_165884.json:
```json
{
    "body": "Attachment [trac_13656_allow_to_hash_symfunctions_even_with_cached_methods.patch](tarball://root/attachments/some-uuid/ticket13656/trac_13656_allow_to_hash_symfunctions_even_with_cached_methods.patch) by @tscrim created at 2013-01-31 20:08:56\n\nI don't think it's overkill, but I'm not an expert. However your patch will need to have docstrings and tests in each of the methods, and it will need to have a test showing that `:trac:`13656`` was fixed. Also you'll need to fill in your real name as the author here.\n\nBest,\n\nTravis",
    "created_at": "2013-01-31T20:08:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13452",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13452#issuecomment-165884",
    "user": "@tscrim"
}
```

Attachment [trac_13656_allow_to_hash_symfunctions_even_with_cached_methods.patch](tarball://root/attachments/some-uuid/ticket13656/trac_13656_allow_to_hash_symfunctions_even_with_cached_methods.patch) by @tscrim created at 2013-01-31 20:08:56

I don't think it's overkill, but I'm not an expert. However your patch will need to have docstrings and tests in each of the methods, and it will need to have a test showing that `:trac:`13656`` was fixed. Also you'll need to fill in your real name as the author here.

Best,

Travis



---

archive/issue_comments_165885.json:
```json
{
    "body": "Thinking about this some more, I think this is not the solution. That hash function should not make any assumptions about `evalf_func` (except that it is callable). So I'm fixing this at the wrong place here.\n\nI'll try to find out where this hashing is done and how to fix it.",
    "created_at": "2013-03-11T15:55:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13452",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13452#issuecomment-165885",
    "user": "@tkluck"
}
```

Thinking about this some more, I think this is not the solution. That hash function should not make any assumptions about `evalf_func` (except that it is callable). So I'm fixing this at the wrong place here.

I'll try to find out where this hashing is done and how to fix it.



---

archive/issue_comments_165886.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2014-02-12T19:58:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13452",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13452#issuecomment-165886",
    "user": "@rwst"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_165887.json:
```json
{
    "body": "Replying to [comment:3 tkluck]:\n> Thinking about this some more, I think this is not the solution. That hash function should not make any assumptions about `evalf_func` (except that it is callable). So I'm fixing this at the wrong place here.\n> \n> I'll try to find out where this hashing is done and how to fix it.\nThe error itself is also strange: there is a python exception that gets *ignored*. That can happen in _dealloc_ code, or it could be happening in a cython routine that has no way of reporting back an error condition. That could point to a missing \"except\" clause in a declaration.\n\nIn fact, you do end up with an object. It just doesn't work properly:\n\n```\nsage: f(1).n()\n20\nsage: g(1).n()\nKeyError: 'x'\n```\n",
    "created_at": "2014-02-13T01:33:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13452",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13452#issuecomment-165887",
    "user": "@nbruin"
}
```

Replying to [comment:3 tkluck]:
> Thinking about this some more, I think this is not the solution. That hash function should not make any assumptions about `evalf_func` (except that it is callable). So I'm fixing this at the wrong place here.
> 
> I'll try to find out where this hashing is done and how to fix it.
The error itself is also strange: there is a python exception that gets *ignored*. That can happen in _dealloc_ code, or it could be happening in a cython routine that has no way of reporting back an error condition. That could point to a missing "except" clause in a declaration.

In fact, you do end up with an object. It just doesn't work properly:

```
sage: f(1).n()
20
sage: g(1).n()
KeyError: 'x'
```




---

archive/issue_comments_165888.json:
```json
{
    "body": "Replying to [comment:7 nbruin]:\n> That could point to a missing \"except\" clause in a declaration.\n\nIndeed, in `function.pyx`, line 998 we have\n\n```\n    cdef long _hash_(self) except -1:\n```\n\nbut the corresponding line in `function.pxd`, line 40 is\n\n```\n    cdef long _hash_(self)\n```\n\nApparently the `pxd` declaration gets precedence and as a result cython doesn't have an opportunity to report an error, hence the \"ignored\". I'll check on the cython list if that is appropriate behaviour.\n\nThe fix in the mean time is to include the `except -1` in the `.pxd` file as well.",
    "created_at": "2014-02-13T03:44:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13452",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13452#issuecomment-165888",
    "user": "@nbruin"
}
```

Replying to [comment:7 nbruin]:
> That could point to a missing "except" clause in a declaration.

Indeed, in `function.pyx`, line 998 we have

```
    cdef long _hash_(self) except -1:
```

but the corresponding line in `function.pxd`, line 40 is

```
    cdef long _hash_(self)
```

Apparently the `pxd` declaration gets precedence and as a result cython doesn't have an opportunity to report an error, hence the "ignored". I'll check on the cython list if that is appropriate behaviour.

The fix in the mean time is to include the `except -1` in the `.pxd` file as well.
