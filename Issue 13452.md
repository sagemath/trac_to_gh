# Issue 13452: cached functions cannot be used as evalf

Issue created by migration from Trac.

Original creator: tkluck

Original creation time: 2012-10-26 15:35:39

Assignee: jason

An error occurs when trying to use a cached function as the `evalf_func` argument to function. The error seems to be that some part of sage assumes that it can compute a hash value using `evalf_func`'s `func_code` attribute, which a cached function object doesn't have.


```
sage: def evalf(self, x, parent=complex):
....:     return 20
....: 
sage: f = function('f', evalf_func=evalf)
sage: `@`cached_function
....: def evalg(self, x, parent=complex):
....:     return 30
....: 
sage: g = function('g', evalf_func=evalg)
Exception AttributeError: "'sage.misc.cachefunc.CachedFunction' object has no attribute 'func_code'" in 'sage.symbolic.function.SymbolicFunction._hash_' ignored
```



---

Comment by tkluck created at 2012-10-26 15:51:52

Changing status from new to needs_review.


---

Comment by tkluck created at 2012-10-26 15:51:52

I've attached a simple patch that lets cached functions expose its underlying function's attributes. Maybe that's overkill?


---

Comment by tkluck created at 2012-10-26 15:52:58

a preliminary fix


---

Attachment

I don't think it's overkill, but I'm not an expert. However your patch will need to have docstrings and tests in each of the methods, and it will need to have a test showing that `:trac:`13656`` was fixed. Also you'll need to fill in your real name as the author here.

Best,

Travis


---

Comment by tkluck created at 2013-03-11 15:55:08

Thinking about this some more, I think this is not the solution. That hash function should not make any assumptions about `evalf_func` (except that it is callable). So I'm fixing this at the wrong place here.

I'll try to find out where this hashing is done and how to fix it.


---

Comment by rws created at 2014-02-12 19:58:39

Changing status from needs_review to needs_info.


---

Comment by nbruin created at 2014-02-13 01:33:22

Replying to [comment:3 tkluck]:
> Thinking about this some more, I think this is not the solution. That hash function should not make any assumptions about `evalf_func` (except that it is callable). So I'm fixing this at the wrong place here.
> 
> I'll try to find out where this hashing is done and how to fix it.
The error itself is also strange: there is a python exception that gets _ignored_. That can happen in _dealloc_ code, or it could be happening in a cython routine that has no way of reporting back an error condition. That could point to a missing "except" clause in a declaration.

In fact, you do end up with an object. It just doesn't work properly:

```
sage: f(1).n()
20
sage: g(1).n()
KeyError: 'x'
```



---

Comment by nbruin created at 2014-02-13 03:44:00

Replying to [comment:7 nbruin]:
> That could point to a missing "except" clause in a declaration.

Indeed, in `function.pyx`, line 998 we have

```
    cdef long _hash_(self) except -1:
```

but the corresponding line in `function.pxd`, line 40 is

```
    cdef long _hash_(self)
```

Apparently the `pxd` declaration gets precedence and as a result cython doesn't have an opportunity to report an error, hence the "ignored". I'll check on the cython list if that is appropriate behaviour.

The fix in the mean time is to include the `except -1` in the `.pxd` file as well.
