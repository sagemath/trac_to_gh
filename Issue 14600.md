# Issue 14600: transition to using install program

Issue created by migration from Trac.

Original creator: felixs

Original creation time: 2013-06-22 08:38:09

Assignee: tbd

CC:  leif jondo

Keywords: spkg-install filelist destdir

To keep track of installed files, it's probably most convenient to use a unified install program within all spkg-install scripts, like the one included within #14796.

For transitional purposes, the non-#14796 build-system should provide an install program within $PATH. I propose to place it as `sage-dist-install` into `$SAGE_SRC/bin`. It should just ignore -F <filelist> for now.

(NB: This won't work for python-distutils packages, as they are baking their own cakes again)


---

Attachment


---

Comment by vbraun created at 2013-06-23 15:44:01

Python distutils at least encapsulates the file operations in `distutils.file_utils`, so it would be a finite task to hook into that as well.

The alternative is to serialize the install phase and diff the `SAGE_ROOT` tree before and after.

Yet another possibility is to use separate install trees for each spkg in "sage-the-distribution", as in Nix or Stow.


---

Comment by felixs created at 2013-06-23 16:06:23

Replying to [comment:2 vbraun]:
> Python distutils at least encapsulates the file operations in `distutils.file_utils`, so it would be a finite task to hook into that as well.

For example. but i have no idea how to "hook into that" yet without patching distutils. is there any python magic you have in mind?

> The alternative is to serialize the install phase and diff the `SAGE_ROOT` tree before and after.

Won't give me DESTDIR. serialization is one of the uglier hacks (no way). diff takes quadratic time (even less way).

> Yet another possibility is to use separate install trees for each spkg in "sage-the-distribution", as in Nix or Stow.

Just complicates the issue. better is supporting no "install" at all (like sage-doc currently does).


---

Comment by leif created at 2013-06-23 16:51:10

Replying to [comment:3 felixs]:
> Replying to [comment:2 vbraun]:
> > Python distutils at least encapsulates the file operations in `distutils.file_utils`, so it would be a finite task to hook into that as well.
> 
> For example. but i have no idea how to "hook into that" yet without patching distutils. is there any python magic you have in mind?

You can patch it (Python / setuptools / whatever), but you don't necessarily have to, as most Python objects are mutable, including functions / methods, i.e., you can overwrite them... :-)


```
In [1]: import distutils.file_util

In [2]: def foo(s,t): print "Hello"
   ...: 

In [3]: distutils.file_util.copy_file=foo

In [4]: distutils.file_util.copy_file("bar","baz")
Hello
```



And you could e.g. do so in an spkg's `setup.py`, to use some alternate implementation (provided elsewhere).


---

Comment by felixs created at 2013-06-23 17:21:57

Replying to [comment:4 leif]:

> You can patch it (Python / setuptools / whatever), but you don't necessarily have to,

I dont *want* to. I'd just patch upstream if it's completely hosed.

> as most Python objects are mutable, including functions / methods, i.e., you can overwrite them... :-)
> 
>...
> 
> 
> And you could e.g. do so in an spkg's `setup.py`, to use some alternate implementation (provided elsewhere). 

I don't quite understand. Are you proposing to patch the upstream package? (this would be worse, as it involves more than just distutils patching).

I need something of the kind

```
setup.py install USEMYOWNFILEUTIL
```

or

```
IMPORTPATH=myhackedfileutil_path setup.py install
```

within spkg-install. is this even possible?


---

Comment by leif created at 2013-06-23 17:33:02

Replying to [comment:5 felixs]:
> Replying to [comment:4 leif]:
> > as most Python objects are mutable, including functions / methods, i.e., you can overwrite them... :-)
> > And you could e.g. do so in an spkg's `setup.py`, to use some alternate implementation (provided elsewhere). 
> 
> I don't quite understand. Are you proposing to patch the upstream package? (this would be worse, as it involves more than just distutils patching).
> 
> I need something of the kind
> {{{
> setup.py install USEMYOWNFILEUTIL
> }}}
> or
> {{{
> IMPORTPATH=myhackedfileutil_path setup.py install
> }}}
> within spkg-install. is this even possible?

Sure, I was just writing a post scriptum:

And in the latter case, you wouldn't even have to patch / modify the spkg's / upstream's `setup.py`, but just `spkg-install` (or whatever that will become), as you can also do things like

```sh
python <<EOF
# Do some stuff, e.g. modifying distutils.file_util.*
# (preferably importing an alternate implementation located elsewhere)
import sys
sys.argv = ["setup.py", "install"]
execfile("setup.py")
EOF
```


Or just create a (shell) script that does similar, and call that instead of doing `python setup.py install`.


---

Comment by leif created at 2013-06-23 17:45:57

P.P.S.:

Of course, as is that relies on upstream *only* using distutils (at least to copy / install files), just like your custom `[sage-dist-]install` mechanism relies on upstream respecting autotools' conventions (and _exclusively_ using `install[-sh]`) for such purposes.


---

Comment by leif created at 2013-06-23 18:22:28

... but you may have to wrap `python` for some packages that use _both_ (e.g.) autotools _and_ Python's distutils (some support setting `PYTHON`).

Still, uninstalling an spkg by (just) removing the files it added (probably restoring those it deleted or modified, too) can easily break a Sage installation, but I guess you're aware of the pitfalls (that aren't specific to Sage)...


---

Attachment

Thanks Leif, I wasn't aware of that overriding possibility.

Replying to [comment:7 leif]:
> 
> Of course, as is that relies on upstream *only* using distutils (at least to copy / install files), just like your custom `[sage-dist-]install` mechanism relies on upstream respecting autotools' conventions (and _exclusively_ using `install[-sh]`) for such purposes.

.. and lets see what else `copy_file` is abused for. But I think, this approach will finally cut it.

autotools uses $(INSTALL), which can be overriden with anything. also others, otherwise broken make based build systems use $(INSTALL) and $(INSTALLDIRS).


---

Comment by leif created at 2013-06-23 19:52:46

Replying to [comment:9 felixs]:
> .. and lets see what else `copy_file` is abused for. But I think, this approach will finally cut it.


Note that your replacement (or wrapper) function will of course finally have to mimic the full behaviour of the original one, i.e., has to take the same optional arguments (with the same default values), and has to return a tuple.


---

Comment by felixs created at 2013-06-23 20:04:56

Replying to [comment:10 leif]:
> Note that your replacement (or wrapper) function will of course finally have to mimic the full behaviour of the original one, i.e., has to take the same optional arguments (with the same default values), and has to return a tuple.

It is supposed to call the original function after it's done with file listing.
I'd expect that

```
def B(*args, **kwds): return B(args, kwds)
```

works, except for the default values...


---

Comment by leif created at 2013-06-23 20:11:40

Replying to [comment:11 felixs]:
> It is supposed to call the original function after it's done with file listing.
> I'd expect that
> {{{
> def B(*args, **kwds): return B(args, kwds)
> }}}
> works, except for the default values...

... and infinite recursion. ;-)


---

Comment by felixs created at 2013-06-23 20:14:42

Replying to [comment:12 leif]:
> ... and infinite recursion. ;-)

that was typed to fast, also some asterisks are missing. as it seems it even does the right thing wrt default values...


---

Comment by felixs created at 2013-06-23 20:52:09

And indeed, `setup.py install` takes `--record <filename>`. I should have tried to patch distutils right away.... :)


---

Comment by leif created at 2013-06-23 21:35:50

It _may_ make sense to wrap the whole ` distutils.core.setup()` function [too]...

(depending on what else you intend to do)


---

Comment by felixs created at 2013-06-30 09:15:20

There is now `sage-dist-install`, `sage-dist-make`, `spkg.mk` and `sage-setup.py` within my WIP branch on github.

With these, most spkg-install scripts can be augmented to support both the #14796 build system (together with #14792) as well as the current one.

Please have a look whether this could break anything.


---

Comment by felixs created at 2013-08-28 15:28:27

This is now in git. It works for all packages I have tried with.


---

Comment by felixs created at 2013-09-03 08:17:27

Changing status from new to needs_review.


---

Comment by git created at 2013-09-08 09:00:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2013-12-19 12:27:06

Needs to be rebased.


---

Comment by jdemeyer created at 2013-12-19 12:27:06

Changing status from needs_review to needs_work.


---

Comment by embray created at 2018-04-04 08:58:34

This was in a way trying to do what is now accomplished (in spirit--not so much in the details) by some combination of #23160 an #22509.  I don't think this particular approach really fits in with what we're doing now.  But thank you Felix for your early pioneering work on trying to fix Sage's build system...


---

Comment by embray created at 2018-04-04 08:58:34

Resolution: wontfix
