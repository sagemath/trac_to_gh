# Issue 23668: Avoid _element_constructor in Homset

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2017-09-20 09:52:27

`Homset._generic_convert_map` uses `self._element_constructor`.

Ideally, we would get rid of `_generic_convert_map` completely.


---

Comment by git created at 2017-09-20 10:33:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-09-20 10:34:04

Changing status from new to needs_review.


---

Comment by git created at 2017-09-20 14:27:41

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tscrim created at 2017-09-20 17:47:43

I'm not sure about changing `__call__` to `_element_constructor_` here as it could cause a speed regression because of having to go through the coercion framework. Have you run any timings? Homsets often do not follow the usual rule of having a `Element` attribute, which may have misbehaviors because of that.

Also, because it would now pass through the coercion framework, some things are unnecessary, such as `if x.parent() is self:`. I'm also not sure how much the input may have changed by the time it reaches `_element_constructor_`. I can do some investigation.


---

Comment by jdemeyer created at 2017-09-20 21:24:29

Replying to [comment:5 tscrim]:
> Have you run any timings?

No, but I guess I should...


---

Comment by tscrim created at 2017-09-21 04:46:21

Replying to [comment:6 jdemeyer]:
> Replying to [comment:5 tscrim]:
> > Have you run any timings?
> 
> No, but I guess I should...

I will also run some timings, but I won't be able to get to that until tomorrow.


---

Comment by git created at 2017-09-21 10:21:59

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-09-21 10:34:17

*Trivial conversion*:

_Before_:

```
sage: H = End(FreeGroup('x,y')); f = H.identity(); timeit('H(f)', number=20, repeat=100000)
20 loops, best of 100000: 489 ns per loop
```


_After_:

```
sage: H = End(FreeGroup('x,y')); f = H.identity(); timeit('H(f)', number=20, repeat=100000)
20 loops, best of 100000: 95.4 ns per loop
```


*Non-trivial conversion*:

_Before_:

```
sage: H = End(FreeGroup('x,y')); f = lambda x:x; timeit('H(f)', number=20, repeat=10000)
20 loops, best of 10000: 2.55 µs per loop
```


_After_:

```
sage: H = End(FreeGroup('x,y')); f = lambda x:x; timeit('H(f)', number=20, repeat=10000)
20 loops, best of 10000: 3.4 µs per loop
```



---

Comment by jdemeyer created at 2017-09-21 11:42:18

Interestingly, I traced the speed difference of the "non-trivial conversion" above to the call

```
R = parent(x)
```


Apparently, asking for the parent of non-numeric types is very slow.


---

Comment by jdemeyer created at 2017-09-21 12:16:25

See #23912 for the slowness of `parent()`.


---

Comment by tscrim created at 2017-09-21 17:40:31

My timings.

Before

```
sage: H = End(FreeGroup('x,y')); f = H.identity(); timeit('H(f)', number=20, repeat=100000)
20 loops, best of 100000: 393 ns per loop
sage: H = End(FreeGroup('x,y')); f = lambda x:x; timeit('H(f)', number=20, repeat=10000)
20 loops, best of 10000: 1.85 µs per loop
```

Just #23905

```
sage: H = End(FreeGroup('x,y')); f = H.identity(); timeit('H(f)', number=20, repeat=100000)
20 loops, best of 100000: 47.7 ns per loop
sage: H = End(FreeGroup('x,y')); f = lambda x:x; timeit('H(f)', number=20, repeat=10000)
20 loops, best of 10000: 2.35 µs per loop
```

Both #23905 and #23912:

```
sage: H = End(FreeGroup('x,y')); f = H.identity(); timeit('H(f)', number=20, repeat=100000)
20 loops, best of 100000: 47.7 ns per loop
sage: H = End(FreeGroup('x,y')); f = lambda x:x; timeit('H(f)', number=20, repeat=10000)
20 loops, best of 10000: 1.65 µs per loop
```


So LGTM. I'm putting #23912 as a dependency just because I feel we should not merge this without #23912 to avoid the speed regression.


---

Comment by tscrim created at 2017-09-21 17:40:31

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-10-15 09:22:43

Resolution: fixed
