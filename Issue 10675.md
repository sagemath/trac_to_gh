# Issue 10675: insecure temp file in testcc.sh, testcxx.sh

Issue created by migration from https://trac.sagemath.org/ticket/10738

Original creator: vbraun

Original creation time: 2011-02-03 18:57:44

CC:  drkirkby pjeremy jdemeyer

By preparing a suitable symlink, this lets a local attacker at least delete any user file:

```
[...]
TESTFILE=/tmp/hkldfz-test-for-c-compiler-6sokljkhsdhfdf.$$.c
cat >$TESTFILE <<"E*O*F"
[...]
```

Is there any reason for not using mktemp?

Low priority because that is only called during compile time...


---

Comment by drkirkby created at 2011-02-03 19:39:14

`mktemp` is not POSIX, so how (if at all) it is implemented on a platform is anyone's guess. I know it's implemented differently on Solaris to Linux, but it may well not exist on AIX, HP-UX or any other POSIX system. So let's forget about `mktemp` using such a command. 

I fail to see how one could use this script to delete a file that one could not delete with rm. The write would fail unless one had write access to the file one wished to delete. 

So unless I'm missing something, this has absolutely zero security risk. 

I've cc'ed a couple of others for their opinion. 


Dave


---

Comment by vbraun created at 2011-02-03 19:52:39

1. Naughtyuser creates symlink `/tmp/tmp/hkldfz-test-for-c-compiler-6sokljkhsdhfdf.$$.c` -> `/home/gooduser/valuabledocument.tex` (replace $$ with pid, often the next pid is easy to guess).
  1. Gooduser runs `testcc.sh`
  1. Gooduser notices that `/home/gooduser/valuabledocument.tex` has been overwritten.

Gooduser could, of course, have always used rm to delete his documents but Naughtyuser does not have the permissions to delete another user's file.


---

Comment by jdemeyer created at 2011-02-03 20:34:34

`mktemp`(1) doesn't allow for extensions like `.c`


```
TESTFILE=/tmp/hkldfz-test-for-c-compiler-6sokljkhsdhfdf.$$.c
rm -f $TESTFILE
cat >$TESTFILE <<"E*O*F"
```

would be harder (but not impossible) to exploit.


---

Comment by vbraun created at 2011-02-03 20:54:40

I guess the options are 
  1. rewrite mktemp in portable shell script
  1. put the temporary file in `$SAGE_LOCAL/spkg/build` (which is writable at compile time). 
  2. make testcc/testcxx a binary, either its own spkg or part of the compiler wrapper, say.


---

Comment by jdemeyer created at 2011-02-03 21:29:29

Where is `testcc.sh` used?  Probably, the functionality of `testcc.sh` should be incorporated in gccwrapper.


---

Comment by drkirkby created at 2011-02-03 21:48:45

Replying to [comment:4 vbraun]:
> I guess the options are 
>   1. rewrite mktemp in portable shell script
>   1. put the temporary file in `$SAGE_LOCAL/spkg/build` (which is writable at compile time). 
>   2. make testcc/testcxx a binary, either its own spkg or part of the compiler wrapper, say.

Of the three options, the second seems the best to me. 

Dave


---

Comment by drkirkby created at 2011-02-03 21:55:09

Just to clarify, I think the best option would be to put the temporary file in $SAGE_LOCAL/spkg/build (which is writable at compile time). 

The scripts are used in a couple of spkg_install scripts, but it is not used much. The idea would be to use it more if a port to the Sun compiler was done.


---

Comment by vbraun created at 2011-02-04 00:41:59

I agree with Dave that currently the best (easiest) option is to just put the temporary file in a location that only the user compiling Sage can write to. 

In the long run, we should have some common configuration options that are detected once and then used by every spkg. With canonical names for different supported C/Fortran compilers, linkers, OSes, architectures. When I rewrote the ATLAS configuration (#10226) I had that in the back of my mind and split all the detection code in a `configuration.py` module.


---

Comment by drkirkby created at 2011-02-05 00:43:16

Replying to [comment:5 jdemeyer]:
> Where is `testcc.sh` used?  Probably, the functionality of `testcc.sh` should be incorporated in gccwrapper.

If that does get merged, can we at least rename it to "compilerwrapper" or something similar.


---

Comment by vbraun created at 2011-02-05 00:52:03

Replying to [comment:9 drkirkby]:
> If that does get merged, can we at least rename it to "compilerwrapper" or something similar. 

I did that already yesterday in response to your feedback, see #10572.


---

Comment by vbraun created at 2012-10-08 12:51:29

Changing status from new to needs_review.


---

Comment by drkirkby created at 2012-10-18 00:27:29

Since it is not a compiler wrapper, I fail to see why it should be renamed to "compilerwrapper" I can think of better names than the current one, as it does not actually aim to test the compiler, but rather determine what compiler is in use. So whilst long-winded, perhaps "determine-c-compiler.sh" is more appropriate. 

dave


---

Comment by jdemeyer created at 2012-10-18 12:49:31

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-10-18 12:49:31

positive_review if you add

```
mkdir -p "$SAGE_ROOT/spkg/build"
```

statements.


---

Attachment

Updated patch


---

Comment by vbraun created at 2012-10-18 13:42:08

Dave, nobody wanted to rename this script to "compilerwrapper". I don't blame you for not remembering our discussion on the ticket though, it has been almost two years :-)

I've added the mkdir.


---

Comment by vbraun created at 2012-10-18 13:42:08

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2012-10-18 19:09:18

Resolution: fixed
