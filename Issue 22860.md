# Issue 22860: Tests leave a ton of compiled lips DLLs from ECL in /tmp

archive/issues_022860.json:
```json
{
    "body": "Keywords: windows cygwin ecl\n\nI noticed a while ago that my `/tmp` directory was filling up often, and it seems to be that every time I run the Sage tests I'm left with ~650 temp DLLs generated by ECL totaling around 8 GB.  This is even with a fully successful test run.\n\nNot sure exactly what invokes the creation of these DLLs or why there are so many and not being deleted, but presumably this isn't just limited to the test suite.\n\nIssue created by migration from https://trac.sagemath.org/ticket/23097\n\n",
    "created_at": "2017-05-29T14:29:41Z",
    "labels": [
        "component: porting: cygwin",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "Tests leave a ton of compiled lips DLLs from ECL in /tmp",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22860",
    "user": "https://github.com/embray"
}
```
Keywords: windows cygwin ecl

I noticed a while ago that my `/tmp` directory was filling up often, and it seems to be that every time I run the Sage tests I'm left with ~650 temp DLLs generated by ECL totaling around 8 GB.  This is even with a fully successful test run.

Not sure exactly what invokes the creation of these DLLs or why there are so many and not being deleted, but presumably this isn't just limited to the test suite.

Issue created by migration from https://trac.sagemath.org/ticket/23097





---

archive/issue_comments_319269.json:
```json
{
    "body": "Changing keywords from \"windows cygwin ecl\" to \"windows cygwin ecl maxima\".",
    "created_at": "2017-05-29T14:39:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22860#issuecomment-319269",
    "user": "https://github.com/embray"
}
```

Changing keywords from "windows cygwin ecl" to "windows cygwin ecl maxima".



---

archive/issue_comments_319270.json:
```json
{
    "body": "I see--these temp files get created by ECL on !Windows/Cygwin when loading a compiled module and force_reload feature is enabled.  In order for this to work on Windows a copy of the module needs to be made and loaded, since Windows does not allow loading the same DLL more than once in the same process.  ECL takes care to clean this up during proper shutdown with an `atexit()` handler, but if the test suite is just killing processes that may prevent the handler from being run.",
    "created_at": "2017-05-29T15:38:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22860#issuecomment-319270",
    "user": "https://github.com/embray"
}
```

I see--these temp files get created by ECL on !Windows/Cygwin when loading a compiled module and force_reload feature is enabled.  In order for this to work on Windows a copy of the module needs to be made and loaded, since Windows does not allow loading the same DLL more than once in the same process.  ECL takes care to clean this up during proper shutdown with an `atexit()` handler, but if the test suite is just killing processes that may prevent the handler from being run.



---

archive/issue_comments_319271.json:
```json
{
    "body": "I'm trying to decide what would be best to do about this.  There are a few possibilities, none of which are ideal:\n\na) Patch ECL so that it handles more exit signals (SIGTERM, SIGHUP, etc.) to shut down cleanly / delete temp files.  This won't help for SIGKILL, but in most cases (during the tests) I think the maxima processes are just being SIGTERM'd (but this needs to be confirmed).  So that would fix most issues.  Actually, this should probably be done regardless--there's no reason ECL couldn't shutdown more cleanly on signals.\n\nb) Do the cleanup from Sage.  This has the advantage that it can even handle an unclean shutdown of ECL.  The only problem is I don't see an obvious way to get a list of temp files created by a given ECL process.  If there is only one ECL, no problem.  But it shouldn't clean up temp files used by another ECL.  Granted, for the limited case on Windows, which is the only place this applies, trying to delete temp DLLs still in use by a process should fail, so it might work just to clean all `ecl*.dll` from `/tmp`...",
    "created_at": "2017-06-01T14:25:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22860#issuecomment-319271",
    "user": "https://github.com/embray"
}
```

I'm trying to decide what would be best to do about this.  There are a few possibilities, none of which are ideal:

a) Patch ECL so that it handles more exit signals (SIGTERM, SIGHUP, etc.) to shut down cleanly / delete temp files.  This won't help for SIGKILL, but in most cases (during the tests) I think the maxima processes are just being SIGTERM'd (but this needs to be confirmed).  So that would fix most issues.  Actually, this should probably be done regardless--there's no reason ECL couldn't shutdown more cleanly on signals.

b) Do the cleanup from Sage.  This has the advantage that it can even handle an unclean shutdown of ECL.  The only problem is I don't see an obvious way to get a list of temp files created by a given ECL process.  If there is only one ECL, no problem.  But it shouldn't clean up temp files used by another ECL.  Granted, for the limited case on Windows, which is the only place this applies, trying to delete temp DLLs still in use by a process should fail, so it might work just to clean all `ecl*.dll` from `/tmp`...



---

archive/issue_comments_319272.json:
```json
{
    "body": "Reported upstream to ECL since I feel this should be fixed there.  Haven't attempted a fix myself yet.",
    "created_at": "2017-06-09T08:32:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22860#issuecomment-319272",
    "user": "https://github.com/embray"
}
```

Reported upstream to ECL since I feel this should be fixed there.  Haven't attempted a fix myself yet.



---

archive/issue_comments_319273.json:
```json
{
    "body": "I haven't attempted to patch ECL for this yet; its signal handling code is a bit complex and I think I need to understand it better before doing so.\n\nHowever, this provides a workaround that I think is worth having with or without a patch to ECL for this: This ensures that when ECL and/or Maxima are called from Sage, rather than writing temp files to `/tmp` it uses `SAGE_TMP`.  This way an individual Sage session can take responsibility for cleaning up any temp files created by ECL/Maxima processes it spawns (or that it creates through the `sage.libs.ecl` interface).\n\nAs far as I'm concerned this solves the problem from Sage's end.\n----\nNew commits:",
    "created_at": "2017-06-19T15:54:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22860#issuecomment-319273",
    "user": "https://github.com/embray"
}
```

I haven't attempted to patch ECL for this yet; its signal handling code is a bit complex and I think I need to understand it better before doing so.

However, this provides a workaround that I think is worth having with or without a patch to ECL for this: This ensures that when ECL and/or Maxima are called from Sage, rather than writing temp files to `/tmp` it uses `SAGE_TMP`.  This way an individual Sage session can take responsibility for cleaning up any temp files created by ECL/Maxima processes it spawns (or that it creates through the `sage.libs.ecl` interface).

As far as I'm concerned this solves the problem from Sage's end.
----
New commits:



---

archive/issue_comments_319274.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-06-19T15:54:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22860#issuecomment-319274",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_319275.json:
```json
{
    "body": "Reviewers set to Emmanuel Charpentier (revert)\n    Status changed from needs_review to positive_review\n\nOn a Virtulbox running Windows10 professional, I compiled 8.0.rc0 + #21399 + #23359 (as suggested in \u200bthe Wiki) + #21233 + #23097 (present ticket) with the options :\n\nexport PREREQ_OPTIONS=--with-blas=atlas\nexport SAGE_ATLAS_LIB=/usr/lib\nexport MAKE=\"make -j4\"\n\nThis passes ptestlong with no failures.\n\n==> positive_review\n\nNote : I have no advice on the contents of the patches (I do not know Cygwin well enough to undetstand what they are supposed to do) ; I just checked that this leads to a functional Sage.",
    "created_at": "2017-07-01T06:03:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22860#issuecomment-319275",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Reviewers set to Emmanuel Charpentier (revert)
    Status changed from needs_review to positive_review

On a Virtulbox running Windows10 professional, I compiled 8.0.rc0 + #21399 + #23359 (as suggested in â€‹the Wiki) + #21233 + #23097 (present ticket) with the options :

export PREREQ_OPTIONS=--with-blas=atlas
export SAGE_ATLAS_LIB=/usr/lib
export MAKE="make -j4"

This passes ptestlong with no failures.

==> positive_review

Note : I have no advice on the contents of the patches (I do not know Cygwin well enough to undetstand what they are supposed to do) ; I just checked that this leads to a functional Sage.



---

archive/issue_comments_319276.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-07-01T06:03:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22860#issuecomment-319276",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_319277.json:
```json
{
    "body": "For what it's worth, the ECL developers decided this is a \"wontfix\" after all.  I'm not entirely sure I agree but not gonna fight them on it.",
    "created_at": "2017-07-03T11:48:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22860#issuecomment-319277",
    "user": "https://github.com/embray"
}
```

For what it's worth, the ECL developers decided this is a "wontfix" after all.  I'm not entirely sure I agree but not gonna fight them on it.



---

archive/issue_comments_319278.json:
```json
{
    "body": "milestone ?",
    "created_at": "2017-07-10T12:39:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22860#issuecomment-319278",
    "user": "https://github.com/fchapoton"
}
```

milestone ?



---

archive/issue_events_059754.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-07-10T14:38:32Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22860",
    "milestone": "sage-8.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22860#event-59754"
}
```



---

archive/issue_comments_319279.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2017-07-10T14:39:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22860#issuecomment-319279",
    "user": "https://github.com/embray"
}
```

Changing priority from major to critical.



---

archive/issue_comments_319280.json:
```json
{
    "body": "Not sure why the milestone was missing from this.  This is actually pretty critical to have :/",
    "created_at": "2017-07-10T14:39:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22860#issuecomment-319280",
    "user": "https://github.com/embray"
}
```

Not sure why the milestone was missing from this.  This is actually pretty critical to have :/



---

archive/issue_comments_319281.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-07-26T22:13:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22860#issuecomment-319281",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_059755.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-07-26T22:13:54Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/22860",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22860#event-59755"
}
```
