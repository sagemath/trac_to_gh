# Issue 22860: Tests leave a ton of compiled lips DLLs from ECL in /tmp

Issue created by migration from https://trac.sagemath.org/ticket/23097

Original creator: embray

Original creation time: 2017-05-29 14:29:41

Keywords: windows cygwin ecl

I noticed a while ago that my `/tmp` directory was filling up often, and it seems to be that every time I run the Sage tests I'm left with ~650 temp DLLs generated by ECL totaling around 8 GB.  This is even with a fully successful test run.

Not sure exactly what invokes the creation of these DLLs or why there are so many and not being deleted, but presumably this isn't just limited to the test suite.


---

Comment by embray created at 2017-05-29 14:39:30

Changing keywords from "windows cygwin ecl" to "windows cygwin ecl maxima".


---

Comment by embray created at 2017-05-29 15:38:51

I see--these temp files get created by ECL on !Windows/Cygwin when loading a compiled module and force_reload feature is enabled.  In order for this to work on Windows a copy of the module needs to be made and loaded, since Windows does not allow loading the same DLL more than once in the same process.  ECL takes care to clean this up during proper shutdown with an `atexit()` handler, but if the test suite is just killing processes that may prevent the handler from being run.


---

Comment by embray created at 2017-06-01 14:25:26

I'm trying to decide what would be best to do about this.  There are a few possibilities, none of which are ideal:

a) Patch ECL so that it handles more exit signals (SIGTERM, SIGHUP, etc.) to shut down cleanly / delete temp files.  This won't help for SIGKILL, but in most cases (during the tests) I think the maxima processes are just being SIGTERM'd (but this needs to be confirmed).  So that would fix most issues.  Actually, this should probably be done regardless--there's no reason ECL couldn't shutdown more cleanly on signals.

b) Do the cleanup from Sage.  This has the advantage that it can even handle an unclean shutdown of ECL.  The only problem is I don't see an obvious way to get a list of temp files created by a given ECL process.  If there is only one ECL, no problem.  But it shouldn't clean up temp files used by another ECL.  Granted, for the limited case on Windows, which is the only place this applies, trying to delete temp DLLs still in use by a process should fail, so it might work just to clean all `ecl*.dll` from `/tmp`...


---

Comment by embray created at 2017-06-09 08:32:04

Reported upstream to ECL since I feel this should be fixed there.  Haven't attempted a fix myself yet.


---

Comment by embray created at 2017-06-19 15:54:27

I haven't attempted to patch ECL for this yet; its signal handling code is a bit complex and I think I need to understand it better before doing so.

However, this provides a workaround that I think is worth having with or without a patch to ECL for this: This ensures that when ECL and/or Maxima are called from Sage, rather than writing temp files to `/tmp` it uses `SAGE_TMP`.  This way an individual Sage session can take responsibility for cleaning up any temp files created by ECL/Maxima processes it spawns (or that it creates through the `sage.libs.ecl` interface).

As far as I'm concerned this solves the problem from Sage's end.
----
New commits:


---

Comment by embray created at 2017-06-19 15:54:36

Changing status from new to needs_review.


---

Comment by charpent created at 2017-07-01 06:03:31

Reviewers set to Emmanuel Charpentier (revert)
    Status changed from needs_review to positive_review

On a Virtulbox running Windows10 professional, I compiled 8.0.rc0 + #21399 + #23359 (as suggested in â€‹the Wiki) + #21233 + #23097 (present ticket) with the options :

export PREREQ_OPTIONS=--with-blas=atlas
export SAGE_ATLAS_LIB=/usr/lib
export MAKE="make -j4"

This passes ptestlong with no failures.

==> positive_review

Note : I have no advice on the contents of the patches (I do not know Cygwin well enough to undetstand what they are supposed to do) ; I just checked that this leads to a functional Sage.


---

Comment by charpent created at 2017-07-01 06:03:31

Changing status from needs_review to positive_review.


---

Comment by embray created at 2017-07-03 11:48:55

For what it's worth, the ECL developers decided this is a "wontfix" after all.  I'm not entirely sure I agree but not gonna fight them on it.


---

Comment by chapoton created at 2017-07-10 12:39:44

milestone ?


---

Comment by embray created at 2017-07-10 14:39:12

Changing priority from major to critical.


---

Comment by embray created at 2017-07-10 14:39:12

Not sure why the milestone was missing from this.  This is actually pretty critical to have :/


---

Comment by vbraun created at 2017-07-26 22:13:54

Resolution: fixed
