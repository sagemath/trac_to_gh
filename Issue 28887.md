# Issue 28887: Add script packages build/pkgs/PREREQ, build/pkgs/TOOLCHAIN, build/pkgs/BOOTSTRAP

Issue created by migration from https://trac.sagemath.org/ticket/29124

Original creator: mkoeppe

Original creation time: 2020-01-31 18:39:33

CC:  dimpase egourgoulhon jhpalmieri fbissey @tobiasdiez slabbe slelievre @kliem

As a follow-up to #29053.

- `build/pkgs/PREREQ/distros/debian.txt` etc. - would record the minimal requirements (system packages) for installing from source. (to replace #29053's file build/pkgs/debian.txt)
- `build/pkgs/BOOTSTRAP/distros/debian.txt` etc. - would record the additional requirements for running `./bootstrap` (autotools and such)
- `build/pkgs/TOOLCHAIN/deps` - to replace some special Makefile targets currently in `build/make/deps`.


---

Comment by mkoeppe created at 2020-04-15 19:26:31

for example on `fedora-26-standard` sagetex testsuite fails:

```
! LaTeX Error: File `makecmds.sty' not found.

Type X to quit or <RETURN> to proceed,
or enter new name. (Default extension: sty)

Enter file name: 
! Emergency stop.
<read *> 
         
l.78 \RequirePackage
                    {ifpdf}^^M
```



---

Comment by mkoeppe created at 2020-04-16 15:43:22

Installation manual also recommends Tcl/Tk - what are they used for in Sage?
http://doc.sagemath.org/html/en/installation/source.html#tcl-tk
----
New commits:


---

Comment by mkoeppe created at 2020-11-23 07:55:17

Best done on top of #30951


---

Comment by git created at 2020-11-24 05:15:44

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-11-24 05:37:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-11-24 05:58:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-11-24 05:59:19

Changing status from new to needs_review.


---

Comment by @tobiasdiez created at 2020-11-24 10:07:38

I'm not sure about the naming of the `local-` environments. Why should I expect as a developer that `local-sudo` installs system packages? What about `local-system-packages-ubuntu` (for root) and `local-sudo-system-packages-ubuntu` (for sudo)?


---

Comment by git created at 2020-11-24 18:14:29

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-11-24 18:16:20

I have taken out the addition of the `local-root` environments to keep this ticket more narrowly focused. Let's return to this in #30944.


---

Comment by git created at 2020-11-24 18:48:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-11-25 22:18:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-11-26 19:29:14

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-11-26 20:12:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-11-26 20:13:14

Changing status from needs_work to needs_review.


---

Comment by git created at 2020-11-26 20:19:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2020-11-30 08:30:31

Am I right to think that only the last two commits of the branch should be reviewed here?


---

Comment by mkoeppe created at 2020-11-30 16:41:05

No, there are actually a few more commits earlier that don't come from the merged dependencies


---

Comment by slabbe created at 2020-11-30 17:32:57

Ok. Then, could the branch be rebased on top of the dependencies, to make the changes made by this ticket consecutive and easier to read (during the review and/or after).


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Changing keywords from "" to "sd111".


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111


---

Comment by git created at 2020-12-06 21:41:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-12-06 21:42:31

Rebased on top of #30947 and current beta


---

Comment by slabbe created at 2020-12-06 22:03:56

Thank you. I do have lots of other todos this week, but I hope to be able to review few tickets during the week. I will start with this one and the other ones you put me in cc.


---

Comment by slabbe created at 2020-12-09 09:54:31

I am not sure if commit `a9bd145` works because I still see underscore packages listed in the list of SPKGs which did not find equivalent system packages during the run of `./configure`:


```
    notice: the following SPKGs did not find equivalent system packages:

        _recommended boost coxeter3 gp2c igraph isl libsemigroups pari_elldata pari_galpol pari_nftables pari_seadata
        
checking for the package system in use... debian
configure:

    hint: installing the following system packages, if not
    already present, is recommended and may avoid having to
    build them (though some may have to be built anyway):

      $ sudo apt-get update 
      $ sudo apt-get install  texlive-latex-extra texlive-xetex latexmk pandoc dvipng default-jdk ffmpeg libavdevice-dev libboost-dev pari-gp2c libigraph-dev libisl-dev

    After installation, re-run configure using:

      $ ./config.status --recheck && ./config.status
```



---

Comment by slabbe created at 2020-12-09 10:35:21

Changing status from needs_review to needs_work.


---

Comment by slabbe created at 2020-12-09 10:35:21

Ok, I see, the goal of commit `a9bd145` was to remove `_recommended` elsewhere in the log:

config.log on 9.3.beta3:


```
## ----------------------------------------------------------------------- ##
## Build status for each package:                                          ##
## ----------------------------------------------------------------------- ##
4ti2-1.6.7.p0:                               does not support check for system package; optional, will be installed as an SPKG
_recommended-none:                           no suitable system package; optional, use "./configure --enable-_recommended" to install
alabaster-0.7.12:                            does not support check for system package; will be installed as an SPKG
```


config.log with this branch on top of 9.3.beta3:


```
## ----------------------------------------------------------------------- ##
## Build status for each package:                                          ##
## ----------------------------------------------------------------------- ##
4ti2-1.6.7.p0:                               does not support check for system package; optional, will be installed as an SPKG
_bootstrap-none:                             does not support check for system package; optional, use "./configure --enable-_bootstrap" to install
_prereq-none:                                does not support check for system package; will be installed as an SPKG
_recommended-none:                           no suitable system package; optional, use "./configure --enable-_recommended" to install
alabaster-0.7.12:                            does not support check for system package; will be installed as an SPKG
```


config.log with this branch on top of 9.3.beta3 (after running make first):


```
## ----------------------------------------------------------------------- ##
## Build status for each package:                                          ##
## ----------------------------------------------------------------------- ##
4ti2-1.6.7.p0:                               does not support check for system package; optional, will be installed as an SPKG
alabaster-0.7.12:                            does not support check for system package; will be installed as an SPKG
appnope-0.1.0.p0:                            does not support check for system package; will be installed as an SPKG
```


Still, I would suggest to also remove it from the list ` notice: the following SPKGs did not find equivalent system packages:`.


---

Comment by git created at 2020-12-10 05:40:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-10 05:41:55

Merged new version of #30947


---

Comment by mkoeppe created at 2020-12-10 06:02:18

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-12-10 06:02:18

Replying to [comment:40 slabbe]:
> Still, I would suggest to also remove it from the list ` notice: the following SPKGs did not find equivalent system packages:`.

I agree it's not pretty.  But all of the SPKGs listed there expand/transform to system packages that are suggested to be installed.  Without the `_recommended`, it will be a mystery where some of the suggested system packages are coming from.  So I think it's better to keep it there.


---

Comment by slabbe created at 2020-12-10 21:29:52

Ok. works for me.


---

Comment by slabbe created at 2020-12-10 21:29:52

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-12-10 21:56:39

Thank you!


---

Comment by vbraun created at 2020-12-13 20:43:13

Merge conflict


---

Comment by vbraun created at 2020-12-13 20:43:13

Changing status from positive_review to needs_work.


---

Comment by git created at 2020-12-13 20:56:32

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mkoeppe created at 2020-12-13 20:59:19

Changing status from needs_work to positive_review.


---

Comment by mkoeppe created at 2020-12-13 20:59:19

Merged #30375 in the hope to resolve merge conflicts


---

Comment by git created at 2020-12-15 00:59:21

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2020-12-15 00:59:21

Changing status from positive_review to needs_review.


---

Comment by mkoeppe created at 2020-12-15 00:59:50

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-12-15 00:59:50

Merged current beta


---

Comment by vbraun created at 2020-12-21 23:35:07

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2020-12-21 23:35:07


```
**********************************************************************
File "src/sage/misc/package.py", line 427, in sage.misc.package.standard_packages
Failed example:
    installed[0], installed[-1]  # optional - build
Expected:
    ('alabaster', 'zn_poly')
Got:
    ('_prereq', 'zn_poly')
**********************************************************************
1 item had failures:
   1 of   4 in sage.misc.package.standard_packages
    [49 tests, 1 failure, 3.31 s]
----------------------------------------------------------------------
```



---

Comment by git created at 2020-12-22 01:25:08

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mkoeppe created at 2020-12-22 01:25:32

Merged #30940, which makes these doctests more robust


---

Comment by mkoeppe created at 2020-12-22 06:13:51

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-12-29 00:15:37

Changing priority from major to critical.


---

Comment by git created at 2020-12-29 19:08:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-29 19:12:14

The last commit fixes the issue observed in #29124:

  moved the files build/pkgs/*.txt to new locations but forgot to update the CI scripts for Cygwin, which had led to failures like this (https://github.com/mkoeppe/sage/runs/1561097256):

```
sed: can't read ./build/pkgs/cygwin.txt: No such file or directory
sed: can't read ./build/pkgs/cygwin-bootstrap.txt: No such file or directory
Chocolatey v0.10.15
Package name is required. Please pass at least one package name to install.
Error: Process completed with exit code 1.
```



---

Comment by git created at 2021-01-02 20:46:05

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mkoeppe created at 2021-01-02 20:48:36

Still needs review


---

Comment by dimpase created at 2021-01-03 09:52:14

./bootstrap is getting very slow - 3 times slower than ./configure, over 60 sec on a relatively fast machine!


---

Comment by dimpase created at 2021-01-03 15:23:34

On this branch I'm getting

```
sage -t --warn-long 53.2 --random-seed=0 src/sage/tests/cmdline.py
**********************************************************************
File "src/sage/tests/cmdline.py", line 219, in sage.tests.cmdline.test_executable
Failed example:
    print(out)  # optional - build
Expected:
    Found local metadata for sqlite-...
    SQLite
    ======
    ...
    SQLite is a software library that implements a self-contained,
    serverless, zero-configuration, transactional SQL database engine.
    ...
Got:
    sqlite: An SQL database engine
    ==============================
    <BLANKLINE>
    Description
    -----------
    <BLANKLINE>
    SQLite is a software library that implements a self-contained,
    serverless, zero-configur
...
```

and  one more similar failure in this file.
Not sure whether it's coming from this ticket, or one of dependencies.


---

Comment by dimpase created at 2021-01-03 15:23:34

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-01-03 19:03:40

Thanks for catching this. It's coming from #29655


---

Comment by git created at 2021-01-03 19:18:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-01-03 19:18:21

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2021-01-04 10:57:11

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2021-01-04 10:57:11

hmm, now I see

```
File "src/sage/tests/cmdline.py", line 219, in sage.tests.cmdline.test_executable
Failed example:
    print(out)  # optional - build
Expected:
    SQLite
    ======
    ...
    SQLite is a software library that implements a self-contained,
    serverless, zero-configuration, transactional SQL database engine.
    ...
Got:
    sqlite: An SQL database engine
    ==============================
    <BLANKLINE>
    Description
    -----------
    <BLANKLINE>
    SQLite is a software library that implements a self-contained,
    serverless, zero-configuration, transactional SQL database engine.
    <BLANKLINE>
...
```

(and the same in line 232)

So more changes of these test outputs are needed.

The different heading (`sqlite: An SQL database engine`) comes from `src/doc/en/reference/spkg/sqlite.rst`, as far as me and grep can tell.


---

Comment by git created at 2021-01-04 17:20:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-01-04 17:21:00

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2021-01-04 18:43:09

OK, good.


---

Comment by dimpase created at 2021-01-04 18:43:09

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-01-05 06:35:50

Thanks!


---

Comment by vbraun created at 2021-01-24 10:38:15

Resolution: fixed
