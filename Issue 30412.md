# Issue 30412: Reimplement "sage -p SPKG" as "make SPKG-no-deps"

Issue created by migration from https://trac.sagemath.org/ticket/30649

Original creator: mkoeppe

Original creation time: 2020-09-24 02:57:53

CC:  jhpalmieri mjo @kliem vbraun

Making this change will allow us to remove the last use of `SAGE_LOGS` from `src/`.


---

Comment by mkoeppe created at 2021-01-19 21:05:36

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-01-19 21:05:36

New commits:


---

Comment by jhpalmieri created at 2021-01-19 23:56:03

I think that this does not behave according to the documentation: "Options are the same as for the -i command." For example `./sage -p -c bzip2` does not run the test suite, and `./sage -p -s biopython` does not preserve the build directory.


---

Comment by jhpalmieri created at 2021-01-19 23:56:03

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-01-20 00:23:22

You are right, this needs more thought


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by mkoeppe created at 2021-10-24 18:39:05

Changing priority from minor to major.


---

Comment by git created at 2021-10-24 19:35:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-10-24 19:44:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-10-24 19:44:51

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2021-11-02 04:49:03

The code looks simple and it works for me. `./sage -p -s ...` and `./sage -p -c ...` work. One possible issue I can see is the one mentioned in the description: users may need to use `./bootstrap` and/or `./configure` first. But I think this is okay.

One real issue: `src/sage/tests/cmdline.py` fails doctests. I think the test is kind of stupid, though (the second one):

```
    Test ``sage --info [packages]`` and the equivalent
    ``sage -p --info --info [packages]`` (the doubling of ``--info``
    is intentional, that option should be idempotent)::
```

Why do we care whether `./sage -p --info --info PKG` works? `./sage --info --info PKG` doesn't work, so why should we care whether it works if we insert `-p`?


---

Comment by mkoeppe created at 2021-11-04 01:52:06

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-11-05 05:04:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-11-05 05:06:25

I've cleaned this up a bit more, it's now all in `build/bin/sage-site`.
Needs a bit more work though


---

Comment by jhpalmieri created at 2022-01-05 23:45:48

Maybe this will resolve #22062: currently `sage -p --info sqlite` writes info to a log file as well as printing on the screen, and I think it should just print to the screen.


---

Comment by jhpalmieri created at 2022-02-13 17:12:01

What work needs to be done here? This does indeed resolve #22062 because it disables the use of `sage -p --arg`.


---

Comment by git created at 2022-02-13 17:40:50

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-02-13 17:41:04

Rebased on current beta.


---

Comment by mkoeppe created at 2022-02-13 17:41:41

I unfortunately don't recall what I meant in comment:19


---

Comment by git created at 2022-02-13 17:46:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2022-02-14 22:40:08

A (stupid) doctest fails, and we could just delete it:

```diff
diff --git a/src/sage/tests/cmdline.py b/src/sage/tests/cmdline.py
index 681ff703e2..fccba3f12f 100644
--- a/src/sage/tests/cmdline.py
+++ b/src/sage/tests/cmdline.py
@@ -210,9 +210,7 @@ def test_executable(args, input="", timeout=100.0, pydebug_ignore_warnings=False
         sage: ret  # optional - sage_spkg
         0
 
-    Test ``sage --info [packages]`` and the equivalent
-    ``sage -p --info --info [packages]`` (the doubling of ``--info``
-    is intentional, that option should be idempotent)::
+    Test ``sage --info [packages]``::
 
         sage: out, err, ret = test_executable(["sage", "--info", "sqlite"])  # optional - sage_spkg
         sage: print(out)  # optional - sage_spkg
@@ -225,17 +223,6 @@ def test_executable(args, input="", timeout=100.0, pydebug_ignore_warnings=False
         sage: ret  # optional - sage_spkg
         0
 
-        sage: out, err, ret = test_executable(["sage", "-p", "--info", "--info", "sqlite"])  # optional - sage_spkg
-        sage: print(out)  # optional - sage_spkg
-        sqlite...
-        SQLite is a software library that implements a self-contained,
-        serverless, zero-configuration, transactional SQL database engine.
-        ...
-        sage: err  # optional - sage_spkg
-        ''
-        sage: ret  # optional - sage_spkg
-        0
-
     Test ``sage-run`` on a Python file, both with an absolute and with a relative path::
 
         sage: dir = tmp_dir(); name = 'python_test_file.py'
```

Unless there is some script somewhere that routinely produces commands like `sage --info --info ...`?


---

Comment by mkoeppe created at 2022-02-15 05:34:20

Yes, I'm in favor of deleting this nonsensical test


---

Comment by jhpalmieri created at 2022-02-15 22:44:59

The issues in comment:6 have been fixed.
----
New commits:


---

Comment by jhpalmieri created at 2022-02-19 22:10:23

Any ideas on what else needs to be done with this?
----
New commits:


---

Comment by mkoeppe created at 2022-02-19 22:40:48

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-02-19 22:40:48

I think it is ready


---

Comment by jhpalmieri created at 2022-02-20 01:11:47

The change from comment:30 and comment:31 seems to have been lost, and I am getting an error when I try to push. I don't want to mess up the rest of the branch, so it might be better if you do it:

```diff
diff --git a/src/sage/tests/cmdline.py b/src/sage/tests/cmdline.py
index 681ff703e25..fccba3f12fb 100644
--- a/src/sage/tests/cmdline.py
+++ b/src/sage/tests/cmdline.py
@@ -210,9 +210,7 @@ def test_executable(args, input="", timeout=100.0, pydebug_ignore_warnings=False
         sage: ret  # optional - sage_spkg
         0
 
-    Test ``sage --info [packages]`` and the equivalent
-    ``sage -p --info --info [packages]`` (the doubling of ``--info``
-    is intentional, that option should be idempotent)::
+    Test ``sage --info [packages]``::
 
         sage: out, err, ret = test_executable(["sage", "--info", "sqlite"])  # optional - sage_spkg
         sage: print(out)  # optional - sage_spkg
@@ -225,17 +223,6 @@ def test_executable(args, input="", timeout=100.0, pydebug_ignore_warnings=False
         sage: ret  # optional - sage_spkg
         0
 
-        sage: out, err, ret = test_executable(["sage", "-p", "--info", "--info", "sqlite"])  # optional - sage_spkg
-        sage: print(out)  # optional - sage_spkg
-        sqlite...
-        SQLite is a software library that implements a self-contained,
-        serverless, zero-configuration, transactional SQL database engine.
-        ...
-        sage: err  # optional - sage_spkg
-        ''
-        sage: ret  # optional - sage_spkg
-        0
-
     Test ``sage-run`` on a Python file, both with an absolute and with a relative path::
 
         sage: dir = tmp_dir(); name = 'python_test_file.py'
```



---

Comment by git created at 2022-02-20 01:13:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-20 01:14:07

Sorry for dropping this! Here it is


---

Comment by jhpalmieri created at 2022-02-20 04:58:47

I propose the following two changes (the first one because this is already in `sage-site` and the option is handled twenty lines later, the second is just a typo not related to the changes here but one that you see when you run `./sage -p`):

```diff
diff --git a/build/bin/sage-site b/build/bin/sage-site
index 78848c389e..f7164503b7 100755
--- a/build/bin/sage-site
+++ b/build/bin/sage-site
@@ -129,7 +129,7 @@ if [ "$1" = '-standard' -o "$1" = "--standard" ]; then
 fi
 
 if [ "$1" = '-p' ]; then
-    # If there are no further arguments, display usage help (via an option handled by sage-site)
+    # If there are no further arguments, display usage help
     if [ $# -eq 1 ]; then
         set -- --info
     else
diff --git a/build/bin/sage-spkg b/build/bin/sage-spkg
index 1af55f6671..4478bc7f2d 100755
--- a/build/bin/sage-spkg
+++ b/build/bin/sage-spkg
@@ -99,7 +99,7 @@ Options:
    -y: automatically reply "y" for all prompts regarding
        experimental and old-style packages; warning: there
        is no guarantee that these packages will build correctly;
-       use at your own risk"
+       use at your own risk
    -n: automatically reply "n" for all prompts regarding
        experimental and old-style packages
    -o: allow fetching the package from its upstream URL
```

Also for a future ticket: should `./sage -i` and `./sage -p` (with no further arguments) behave similarly? `./sage -i` builds some stuff, while `./sage -p` just prints a usage message and exits.


---

Comment by git created at 2022-02-20 19:06:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-20 19:11:16

Replying to [comment:39 jhpalmieri]:
> should `./sage -i` and `./sage -p` (with no further arguments) behave similarly? `./sage -i` builds some stuff, while `./sage -p` just prints a usage message and exits.

I suppose `sage -p` could be reduced to just saying "Nothing to do." instead of showing usage.


---

Comment by mkoeppe created at 2022-02-20 19:15:18

And it's not clear if `sage -i` running `make all-build` is really useful, so we could consider changing this behavior too.

But as you say, that would be a future ticket.


---

Comment by jhpalmieri created at 2022-02-20 21:41:11

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2022-02-20 21:41:11

Looks good to me. It has some advantages that I didn't expect. Without this branch:

```
% ./sage -p pytest
Error: Installing old-style SPKGs is no longer supported
```

whereas with this branch, `./sage -p pytest` works fine (although it says "Successfully installed iniconfig-1.1.1 pytest-7.0.1" so it is still doing some dependency checking — probably `pip` or similar, not Sage's build system).


---

Comment by mkoeppe created at 2022-02-20 22:27:19

Thanks!


---

Comment by vbraun created at 2022-02-21 21:56:19

Resolution: fixed
