# Issue 29171: Fix build errors with pplpy on macos with system python3

archive/issues_029171.json:
```json
{
    "body": "CC:  dimpase vdelecroix fbissey @mwageringel embray jhpalmieri vbraun\n\nhttps://github.com/mkoeppe/sage/runs/531095486\n\npplpy:\n\n```\n    g++ -sdk macosx clang -bundle -undefined dynamic_lookup -L/Users/runner/runners/2.165.2/work/sage/sage/.tox/local-homebrew-macos-standard/local/lib -Wl,-rpath,/Users/runner/runners/2.165.2/work/sage/sage/.tox/local-homebrew-macos-standard/local/lib -L/Users/runner/runners/2.165.2/work/sage/sage/.tox/local-homebrew-macos-standard/homebrew/opt/readline/lib -L/Users/runner/runners/2.165.2/work/sage/sage/.tox/local-homebrew-macos-standard/homebrew/lib -I/Users/runner/runners/2.165.2/work/sage/sage/.tox/local-homebrew-macos-standard/homebrew/opt/readline/include -I/Users/runner/runners/2.165.2/work/sage/sage/.tox/local-homebrew-macos-standard/homebrew/include build/temp.macosx-10.14-x86_64-3.7/ppl/linear_algebra.o build/temp.macosx-10.14-x86_64-3.7/ppl/ppl_shim.o -lgmp -lgmpxx -lppl -lm -o build/lib.macosx-10.14-x86_64-3.7/ppl/linear_algebra.cpython-37m-darwin.so\n    clang: error: unknown argument: '-sdk'\n    clang: error: no such file or directory: 'macosx'\n    clang: error: no such file or directory: 'clang'\n    error: command 'g++' failed with exit status 1\n    Running setup.py install for pplpy: finished with status 'error'\nCleaning up...\n```\n\n\n(broken out from #29404)\n\nIssue created by migration from https://trac.sagemath.org/ticket/29408\n\n",
    "created_at": "2020-03-26T02:10:44Z",
    "labels": [
        "packages: standard",
        "major",
        "bug"
    ],
    "title": "Fix build errors with pplpy on macos with system python3",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29171",
    "user": "mkoeppe"
}
```
CC:  dimpase vdelecroix fbissey @mwageringel embray jhpalmieri vbraun

https://github.com/mkoeppe/sage/runs/531095486

pplpy:

```
    g++ -sdk macosx clang -bundle -undefined dynamic_lookup -L/Users/runner/runners/2.165.2/work/sage/sage/.tox/local-homebrew-macos-standard/local/lib -Wl,-rpath,/Users/runner/runners/2.165.2/work/sage/sage/.tox/local-homebrew-macos-standard/local/lib -L/Users/runner/runners/2.165.2/work/sage/sage/.tox/local-homebrew-macos-standard/homebrew/opt/readline/lib -L/Users/runner/runners/2.165.2/work/sage/sage/.tox/local-homebrew-macos-standard/homebrew/lib -I/Users/runner/runners/2.165.2/work/sage/sage/.tox/local-homebrew-macos-standard/homebrew/opt/readline/include -I/Users/runner/runners/2.165.2/work/sage/sage/.tox/local-homebrew-macos-standard/homebrew/include build/temp.macosx-10.14-x86_64-3.7/ppl/linear_algebra.o build/temp.macosx-10.14-x86_64-3.7/ppl/ppl_shim.o -lgmp -lgmpxx -lppl -lm -o build/lib.macosx-10.14-x86_64-3.7/ppl/linear_algebra.cpython-37m-darwin.so
    clang: error: unknown argument: '-sdk'
    clang: error: no such file or directory: 'macosx'
    clang: error: no such file or directory: 'clang'
    error: command 'g++' failed with exit status 1
    Running setup.py install for pplpy: finished with status 'error'
Cleaning up...
```


(broken out from #29404)

Issue created by migration from https://trac.sagemath.org/ticket/29408





---

archive/issue_comments_413152.json:
```json
{
    "body": "this needs details on the Python (system MacOS? Homebrew? CPython package?) and on clang (XCode? Homebrew? Other (e.g. conda?))",
    "created_at": "2020-03-26T02:26:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413152",
    "user": "dimpase"
}
```

this needs details on the Python (system MacOS? Homebrew? CPython package?) and on clang (XCode? Homebrew? Other (e.g. conda?))



---

archive/issue_comments_413153.json:
```json
{
    "body": "what I gather from these links is that Pythons in MacOS are not Homebrew ones.",
    "created_at": "2020-03-26T03:26:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413153",
    "user": "dimpase"
}
```

what I gather from these links is that Pythons in MacOS are not Homebrew ones.



---

archive/issue_comments_413154.json:
```json
{
    "body": "Replying to [comment:3 dimpase]:\n> what I gather from these links is that Pythons in MacOS are not Homebrew ones.\nThat's right, this is system python3 from `/usr/bin`",
    "created_at": "2020-03-27T14:57:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413154",
    "user": "mkoeppe"
}
```

Replying to [comment:3 dimpase]:
> what I gather from these links is that Pythons in MacOS are not Homebrew ones.
That's right, this is system python3 from `/usr/bin`



---

archive/issue_comments_413155.json:
```json
{
    "body": "Something seems to get very confused about values from sysconfig as it tries to replace `xcrun` by `g++`.\n\n\n```\n>>> for k, v in sysconfig.get_config_vars().items():\n...     if isinstance(v, str) and 'sdk' in v:\n...         print(k, v)\n... \nBLDSHARED xcrun -sdk macosx clang     -bundle -undefined dynamic_lookup \nCC xcrun -sdk macosx clang    -arch x86_64 \nCONFIG_ARGS '-C' '--host=x86_64-apple-darwin' '--build=x86_64-apple-darwin' '--enable-framework=/Applications/Xcode.app/Contents/Developer/Library/Frameworks' '--with-framework-name=Python3' '--with-openssl=/BuildRoot/Library/Caches/com.apple.xbs/Binaries/python3/install/TempContent/Root/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.7' '--enable-ipv6' '--prefix=/Applications/Xcode.app/Contents/Developer/usr' '--with-pymalloc' 'PYTHON_FOR_BUILD=DYLD_FRAMEWORK_PATH=/BuildRoot/Library/Caches/com.apple.xbs/Binaries/python3/install/TempContent/Objects/host /BuildRoot/Library/Caches/com.apple.xbs/Binaries/python3/install/TempContent/Objects/host/python.exe' 'CC=xcrun -sdk macosx clang    -arch x86_64' 'CXX=xcrun -sdk macosx clang++  -arch x86_64' 'CPP=xcrun -sdk macosx clang -E -arch x86_64' 'CFLAGS=-iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.7/Headers' 'CPPFLAGS=-iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.7/Headers' 'LIBS=-lSystem' 'LDFLAGS=' 'OBJROOT=/BuildRoot/Library/Caches/com.apple.xbs/Binaries/python3/install/TempContent/Objects' 'SDKROOT=/BuildRoot/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.15.Internal.sdk' 'build_alias=x86_64-apple-darwin' 'host_alias=x86_64-apple-darwin'\nCXX xcrun -sdk macosx clang++  -arch x86_64 \nLDCXXSHARED xcrun -sdk macosx clang++  -arch x86_64 -bundle -undefined dynamic_lookup\nLDSHARED xcrun -sdk macosx clang     -bundle -undefined dynamic_lookup \nLINKCC xcrun -sdk macosx clang    -arch x86_64\nMAINCC xcrun -sdk macosx clang    -arch x86_64\nSDKROOT /BuildRoot/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.15.Internal.sdk\n_OSX_SUPPORT_INITIAL_BLDSHARED xcrun -sdk macosx clang    -arch x86_64 -bundle -undefined dynamic_lookup\n_OSX_SUPPORT_INITIAL_LDSHARED xcrun -sdk macosx clang    -arch x86_64 -bundle -undefined dynamic_lookup\n_OSX_SUPPORT_INITIAL_CC xcrun -sdk macosx clang    -arch x86_64\n_OSX_SUPPORT_INITIAL_CXX xcrun -sdk macosx clang++  -arch x86_64\n```\n",
    "created_at": "2020-03-27T19:54:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413155",
    "user": "mkoeppe"
}
```

Something seems to get very confused about values from sysconfig as it tries to replace `xcrun` by `g++`.


```
>>> for k, v in sysconfig.get_config_vars().items():
...     if isinstance(v, str) and 'sdk' in v:
...         print(k, v)
... 
BLDSHARED xcrun -sdk macosx clang     -bundle -undefined dynamic_lookup 
CC xcrun -sdk macosx clang    -arch x86_64 
CONFIG_ARGS '-C' '--host=x86_64-apple-darwin' '--build=x86_64-apple-darwin' '--enable-framework=/Applications/Xcode.app/Contents/Developer/Library/Frameworks' '--with-framework-name=Python3' '--with-openssl=/BuildRoot/Library/Caches/com.apple.xbs/Binaries/python3/install/TempContent/Root/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.7' '--enable-ipv6' '--prefix=/Applications/Xcode.app/Contents/Developer/usr' '--with-pymalloc' 'PYTHON_FOR_BUILD=DYLD_FRAMEWORK_PATH=/BuildRoot/Library/Caches/com.apple.xbs/Binaries/python3/install/TempContent/Objects/host /BuildRoot/Library/Caches/com.apple.xbs/Binaries/python3/install/TempContent/Objects/host/python.exe' 'CC=xcrun -sdk macosx clang    -arch x86_64' 'CXX=xcrun -sdk macosx clang++  -arch x86_64' 'CPP=xcrun -sdk macosx clang -E -arch x86_64' 'CFLAGS=-iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.7/Headers' 'CPPFLAGS=-iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.7/Headers' 'LIBS=-lSystem' 'LDFLAGS=' 'OBJROOT=/BuildRoot/Library/Caches/com.apple.xbs/Binaries/python3/install/TempContent/Objects' 'SDKROOT=/BuildRoot/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.15.Internal.sdk' 'build_alias=x86_64-apple-darwin' 'host_alias=x86_64-apple-darwin'
CXX xcrun -sdk macosx clang++  -arch x86_64 
LDCXXSHARED xcrun -sdk macosx clang++  -arch x86_64 -bundle -undefined dynamic_lookup
LDSHARED xcrun -sdk macosx clang     -bundle -undefined dynamic_lookup 
LINKCC xcrun -sdk macosx clang    -arch x86_64
MAINCC xcrun -sdk macosx clang    -arch x86_64
SDKROOT /BuildRoot/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.15.Internal.sdk
_OSX_SUPPORT_INITIAL_BLDSHARED xcrun -sdk macosx clang    -arch x86_64 -bundle -undefined dynamic_lookup
_OSX_SUPPORT_INITIAL_LDSHARED xcrun -sdk macosx clang    -arch x86_64 -bundle -undefined dynamic_lookup
_OSX_SUPPORT_INITIAL_CC xcrun -sdk macosx clang    -arch x86_64
_OSX_SUPPORT_INITIAL_CXX xcrun -sdk macosx clang++  -arch x86_64
```




---

archive/issue_comments_413156.json:
```json
{
    "body": "It is caused by bizarre code in `distutils.unixccompiler.UnixCCompiler.link`.",
    "created_at": "2020-03-27T20:36:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413156",
    "user": "mkoeppe"
}
```

It is caused by bizarre code in `distutils.unixccompiler.UnixCCompiler.link`.



---

archive/issue_comments_413157.json:
```json
{
    "body": "https://github.com/python/cpython/blob/master/Lib/distutils/unixccompiler.py#L180\nwith \n\n```\n(Pdb) p self.linker_so\n['xcrun', '-sdk', 'macosx', 'clang', '-bundle', '-undefined', 'dynamic_lookup', '-L/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-macos-standard/local/lib', '-Wl,-rpath,/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-macos-standard/local/lib', '-L/usr/local/opt/readline/lib', '-L/usr/local/lib', '-I/usr/local/opt/readline/include', '-I/usr/local/include']\n(Pdb) p self.compiler_cxx\n['g++', '-std=gnu++11']\n```\n",
    "created_at": "2020-03-27T20:38:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413157",
    "user": "mkoeppe"
}
```

https://github.com/python/cpython/blob/master/Lib/distutils/unixccompiler.py#L180
with 

```
(Pdb) p self.linker_so
['xcrun', '-sdk', 'macosx', 'clang', '-bundle', '-undefined', 'dynamic_lookup', '-L/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-macos-standard/local/lib', '-Wl,-rpath,/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-macos-standard/local/lib', '-L/usr/local/opt/readline/lib', '-L/usr/local/lib', '-I/usr/local/opt/readline/include', '-I/usr/local/include']
(Pdb) p self.compiler_cxx
['g++', '-std=gnu++11']
```




---

archive/issue_comments_413158.json:
```json
{
    "body": "Yes, my head hurts when I look at that file. I am fairly sure distros all over have patches for some aspects of it.\n\nFrom the line it expect some behavior from xcode.",
    "created_at": "2020-03-27T20:40:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413158",
    "user": "fbissey"
}
```

Yes, my head hurts when I look at that file. I am fairly sure distros all over have patches for some aspects of it.

From the line it expect some behavior from xcode.



---

archive/issue_comments_413159.json:
```json
{
    "body": "Hum\n\n```\nfbissey@itsv-frb15 ~ % xcrun --help\nUsage: xcrun [options] <tool name> ... arguments ...\n\nFind and execute the named command line tool from the active developer\ndirectory.\n\nThe active developer directory can be set using `xcode-select`, or via the\nDEVELOPER_DIR environment variable. See the xcrun and xcode-select manual\npages for more information.\n\nOptions:\n  -h, --help                  show this help message and exit\n  --version                   show the xcrun version\n  -v, --verbose               show verbose logging output\n  --sdk <sdk name>            find the tool for the given SDK name\n  --toolchain <name>          find the tool for the given toolchain\n  -l, --log                   show commands to be executed (with --run)\n  -f, --find                  only find and print the tool path\n  -r, --run                   find and execute the tool (the default behavior)\n  -n, --no-cache              do not use the lookup cache\n  -k, --kill-cache            invalidate all existing cache entries\n  --show-sdk-path             show selected SDK install path\n  --show-sdk-version          show selected SDK version\n  --show-sdk-build-version    show selected SDK build version\n  --show-sdk-platform-path    show selected SDK platform path\n  --show-sdk-platform-version show selected SDK platform version\n```\n\nIs it just a stupid `--` versus `-`?",
    "created_at": "2020-03-27T20:42:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413159",
    "user": "fbissey"
}
```

Hum

```
fbissey@itsv-frb15 ~ % xcrun --help
Usage: xcrun [options] <tool name> ... arguments ...

Find and execute the named command line tool from the active developer
directory.

The active developer directory can be set using `xcode-select`, or via the
DEVELOPER_DIR environment variable. See the xcrun and xcode-select manual
pages for more information.

Options:
  -h, --help                  show this help message and exit
  --version                   show the xcrun version
  -v, --verbose               show verbose logging output
  --sdk <sdk name>            find the tool for the given SDK name
  --toolchain <name>          find the tool for the given toolchain
  -l, --log                   show commands to be executed (with --run)
  -f, --find                  only find and print the tool path
  -r, --run                   find and execute the tool (the default behavior)
  -n, --no-cache              do not use the lookup cache
  -k, --kill-cache            invalidate all existing cache entries
  --show-sdk-path             show selected SDK install path
  --show-sdk-version          show selected SDK version
  --show-sdk-build-version    show selected SDK build version
  --show-sdk-platform-path    show selected SDK platform path
  --show-sdk-platform-version show selected SDK platform version
```

Is it just a stupid `--` versus `-`?



---

archive/issue_comments_413160.json:
```json
{
    "body": "No, the linked code is really replacing \"xcrun\" by \"g++\".",
    "created_at": "2020-03-27T20:51:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413160",
    "user": "mkoeppe"
}
```

No, the linked code is really replacing "xcrun" by "g++".



---

archive/issue_comments_413161.json:
```json
{
    "body": "More context, more fun at https://github.com/python/cpython/blob/master/Lib/_osx_support.py",
    "created_at": "2020-03-27T20:51:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413161",
    "user": "mkoeppe"
}
```

More context, more fun at https://github.com/python/cpython/blob/master/Lib/_osx_support.py



---

archive/issue_comments_413162.json:
```json
{
    "body": "Each of `xcrun -sdk macosx clang`, `g++`, and `xcrun -sdk macosx clang++`  make sense.\nBut the code tries to mix the first two to get the third, and gets `g++  -sdk macosx clang`, which makes no sense, obviously.",
    "created_at": "2020-03-27T20:57:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413162",
    "user": "mkoeppe"
}
```

Each of `xcrun -sdk macosx clang`, `g++`, and `xcrun -sdk macosx clang++`  make sense.
But the code tries to mix the first two to get the third, and gets `g++  -sdk macosx clang`, which makes no sense, obviously.



---

archive/issue_comments_413163.json:
```json
{
    "body": "Google search for LDCXXSHARED distutils brings up various things\n\nhttps://www.google.com/search?safe=off&sxsrf=ALeKk01RyL6O3kSKx0-W2ZRb3O8N8Pdg-A:1585342860000&q=LDCXXSHARED+distutils&nfpr=1&sa=X&ved=2ahUKEwiSrZGwxrvoAhWkl3IEHZtFCmEQvgUoAXoECAwQKA&biw=875&bih=862",
    "created_at": "2020-03-27T21:02:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413163",
    "user": "mkoeppe"
}
```

Google search for LDCXXSHARED distutils brings up various things

https://www.google.com/search?safe=off&sxsrf=ALeKk01RyL6O3kSKx0-W2ZRb3O8N8Pdg-A:1585342860000&q=LDCXXSHARED+distutils&nfpr=1&sa=X&ved=2ahUKEwiSrZGwxrvoAhWkl3IEHZtFCmEQvgUoAXoECAwQKA&biw=875&bih=862



---

archive/issue_comments_413164.json:
```json
{
    "body": "It's an existing Python issue: https://bugs.python.org/issue8027",
    "created_at": "2020-03-27T21:07:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413164",
    "user": "mkoeppe"
}
```

It's an existing Python issue: https://bugs.python.org/issue8027



---

archive/issue_comments_413165.json:
```json
{
    "body": "More precisely, this one: https://bugs.python.org/issue1222585",
    "created_at": "2020-03-27T21:11:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413165",
    "user": "mkoeppe"
}
```

More precisely, this one: https://bugs.python.org/issue1222585



---

archive/issue_comments_413166.json:
```json
{
    "body": "... open since 2005",
    "created_at": "2020-03-27T21:11:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413166",
    "user": "mkoeppe"
}
```

... open since 2005



---

archive/issue_comments_413167.json:
```json
{
    "body": "Related previous issue: #17484",
    "created_at": "2020-03-27T21:16:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413167",
    "user": "mkoeppe"
}
```

Related previous issue: #17484



---

archive/issue_comments_413168.json:
```json
{
    "body": "Replying to [comment:19 mkoeppe]:\n> ... open since 2005\n\nUpstream python does have a bad history of compiler/linker support (especially differentiation between C and C++ actually).",
    "created_at": "2020-03-27T21:18:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413168",
    "user": "fbissey"
}
```

Replying to [comment:19 mkoeppe]:
> ... open since 2005

Upstream python does have a bad history of compiler/linker support (especially differentiation between C and C++ actually).



---

archive/issue_comments_413169.json:
```json
{
    "body": "A simple workaround is to clear the CXX environment variable before we call the installation.\nThen it will build the extension using the compiler configured in python's sysconfig.",
    "created_at": "2020-03-27T21:21:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413169",
    "user": "mkoeppe"
}
```

A simple workaround is to clear the CXX environment variable before we call the installation.
Then it will build the extension using the compiler configured in python's sysconfig.



---

archive/issue_comments_413170.json:
```json
{
    "body": "Hum, OK but only for OSX. The problem is that we set CXX as a c++11 compiler which means CXX may actually be `g++ -std=c++11` (or `gnu++11` actually) in most case. On OS X, clang++ is c++11 at least by default so we can afford that. On other platforms, we would run into troubles.\n\nWhy does CXX includes `-std=c++11` rather than it being a separate CPPFLAGS? Because CXX as a whole is defined as a c++11 compiler.",
    "created_at": "2020-03-27T21:27:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413170",
    "user": "fbissey"
}
```

Hum, OK but only for OSX. The problem is that we set CXX as a c++11 compiler which means CXX may actually be `g++ -std=c++11` (or `gnu++11` actually) in most case. On OS X, clang++ is c++11 at least by default so we can afford that. On other platforms, we would run into troubles.

Why does CXX includes `-std=c++11` rather than it being a separate CPPFLAGS? Because CXX as a whole is defined as a c++11 compiler.



---

archive/issue_comments_413171.json:
```json
{
    "body": "Our own python3 has `g++ -std=c++11` in its sysconfig CXX in that case.\n\nBut you are right, for a system python3, we would not be able to assume that the sysconfig CXX is a C++11 compiler.",
    "created_at": "2020-03-27T22:22:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413171",
    "user": "mkoeppe"
}
```

Our own python3 has `g++ -std=c++11` in its sysconfig CXX in that case.

But you are right, for a system python3, we would not be able to assume that the sysconfig CXX is a C++11 compiler.



---

archive/issue_comments_413172.json:
```json
{
    "body": "So I guess this needs to be figured out at configure time.",
    "created_at": "2020-03-27T22:22:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413172",
    "user": "mkoeppe"
}
```

So I guess this needs to be figured out at configure time.



---

archive/issue_comments_413173.json:
```json
{
    "body": "A different workaround is to set `LDSHARED=\"$CXX -bundle -undefined dynamic_lookup\"`.",
    "created_at": "2020-03-27T22:44:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413173",
    "user": "mkoeppe"
}
```

A different workaround is to set `LDSHARED="$CXX -bundle -undefined dynamic_lookup"`.



---

archive/issue_comments_413174.json:
```json
{
    "body": "That sounds interesting! And it avoids the c++11 mess.",
    "created_at": "2020-03-27T22:46:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413174",
    "user": "fbissey"
}
```

That sounds interesting! And it avoids the c++11 mess.



---

archive/issue_comments_413175.json:
```json
{
    "body": "So, a macOS-specific workaround for all Python packages that use C++ extensions?",
    "created_at": "2020-03-27T22:54:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413175",
    "user": "mkoeppe"
}
```

So, a macOS-specific workaround for all Python packages that use C++ extensions?



---

archive/issue_comments_413176.json:
```json
{
    "body": "Unfortunately, pretty much.",
    "created_at": "2020-03-27T22:56:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413176",
    "user": "fbissey"
}
```

Unfortunately, pretty much.



---

archive/issue_comments_413177.json:
```json
{
    "body": "Interesting is also this test:\nhttps://github.com/python/cpython/blob/e42b705188271da108de42b55d9344642170aa2b/Lib/distutils/tests/test_unixccompiler.py#L105\nwhich corresponds to https://bugs.python.org/issue18080. \nThe code added in this issue is unfortunately made ineffective by the fact that in Apple's installation, `cc = \"xcrun -sdk macosx clang    -arch x86_64 \"` and `ldshared = \"xcrun -sdk macosx clang     -bundle -undefined dynamic_lookup \"`, i.e., `ldshared.startswith(cc)` is False.",
    "created_at": "2020-03-27T23:23:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413177",
    "user": "mkoeppe"
}
```

Interesting is also this test:
https://github.com/python/cpython/blob/e42b705188271da108de42b55d9344642170aa2b/Lib/distutils/tests/test_unixccompiler.py#L105
which corresponds to https://bugs.python.org/issue18080. 
The code added in this issue is unfortunately made ineffective by the fact that in Apple's installation, `cc = "xcrun -sdk macosx clang    -arch x86_64 "` and `ldshared = "xcrun -sdk macosx clang     -bundle -undefined dynamic_lookup "`, i.e., `ldshared.startswith(cc)` is False.



---

archive/issue_comments_413178.json:
```json
{
    "body": "A candidate for a portable solution, to be applied to all Python packages that build C++ extensions would be:\n\n```\nLDSHARED=$(/usr/bin/python -c 'import sysconfig; print(sysconfig.get_config_var(\"LDCXXSHARED\"))')\n```\n",
    "created_at": "2020-03-27T23:29:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413178",
    "user": "mkoeppe"
}
```

A candidate for a portable solution, to be applied to all Python packages that build C++ extensions would be:

```
LDSHARED=$(/usr/bin/python -c 'import sysconfig; print(sysconfig.get_config_var("LDCXXSHARED"))')
```




---

archive/issue_comments_413179.json:
```json
{
    "body": "With this, packages would still compile with CXX (which would include the C++11 flags if needed), but link with the C++ linker known to sysconfig.",
    "created_at": "2020-03-27T23:30:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413179",
    "user": "mkoeppe"
}
```

With this, packages would still compile with CXX (which would include the C++11 flags if needed), but link with the C++ linker known to sysconfig.



---

archive/issue_comments_413180.json:
```json
{
    "body": "Replying to [comment:31 mkoeppe]:\n> A candidate for a portable solution, to be applied to all Python packages that build C++ extensions would be:\n> {{{\n> LDSHARED=$(/usr/bin/python -c 'import sysconfig; print(sysconfig.get_config_var(\"LDCXXSHARED\"))')\n> }}}\n\nI don't like the `/usr/bin/python` bit, but I am sure we can replace that by something appropriate. That sounds like a good idea and now it needs to be tested.",
    "created_at": "2020-03-27T23:53:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413180",
    "user": "fbissey"
}
```

Replying to [comment:31 mkoeppe]:
> A candidate for a portable solution, to be applied to all Python packages that build C++ extensions would be:
> {{{
> LDSHARED=$(/usr/bin/python -c 'import sysconfig; print(sysconfig.get_config_var("LDCXXSHARED"))')
> }}}

I don't like the `/usr/bin/python` bit, but I am sure we can replace that by something appropriate. That sounds like a good idea and now it needs to be tested.



---

archive/issue_comments_413181.json:
```json
{
    "body": "Right, of course it would be `LDSHARED=$(sage-python23 -c 'import sysconfig; print(sysconfig.get_config_var(\"LDCXXSHARED\"))').`",
    "created_at": "2020-03-27T23:56:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413181",
    "user": "mkoeppe"
}
```

Right, of course it would be `LDSHARED=$(sage-python23 -c 'import sysconfig; print(sysconfig.get_config_var("LDCXXSHARED"))').`



---

archive/issue_comments_413182.json:
```json
{
    "body": "This did not work after all, but I have found a solution that seems to work and is reasonably clean.\n----\nNew commits:",
    "created_at": "2020-03-28T03:05:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413182",
    "user": "mkoeppe"
}
```

This did not work after all, but I have found a solution that seems to work and is reasonably clean.
----
New commits:



---

archive/issue_comments_413183.json:
```json
{
    "body": "Setting this unconditionally in `sage-env` rather than in package build scripts -- to make sure that these settings are in place even when a user does a `sage -pip install` of some random package.",
    "created_at": "2020-03-28T03:06:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413183",
    "user": "mkoeppe"
}
```

Setting this unconditionally in `sage-env` rather than in package build scripts -- to make sure that these settings are in place even when a user does a `sage -pip install` of some random package.



---

archive/issue_comments_413184.json:
```json
{
    "body": "Looks OK to me. I guess you have some bots testing it out.",
    "created_at": "2020-03-28T03:09:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413184",
    "user": "fbissey"
}
```

Looks OK to me. I guess you have some bots testing it out.



---

archive/issue_comments_413185.json:
```json
{
    "body": "Tests run at https://github.com/mkoeppe/sage/actions/runs/65083365",
    "created_at": "2020-03-28T03:42:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413185",
    "user": "mkoeppe"
}
```

Tests run at https://github.com/mkoeppe/sage/actions/runs/65083365



---

archive/issue_comments_413186.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-03-28T03:42:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413186",
    "user": "mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_413187.json:
```json
{
    "body": "This breaks matplotlib via numpy unfortunately",
    "created_at": "2020-03-28T14:30:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413187",
    "user": "mkoeppe"
}
```

This breaks matplotlib via numpy unfortunately



---

archive/issue_comments_413188.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-03-28T14:30:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413188",
    "user": "mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_413189.json:
```json
{
    "body": "\n```\n        from numpy.core._multiarray_umath import (\n    ImportError: /sage/local/lib/python3.7/site-packages/numpy/core/_multiarray_umath.cpython-37m-x86_64-linux-gnu.so: undefined symbol: __cpu_model\n\n```\n",
    "created_at": "2020-03-28T14:30:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413189",
    "user": "mkoeppe"
}
```


```
        from numpy.core._multiarray_umath import (
    ImportError: /sage/local/lib/python3.7/site-packages/numpy/core/_multiarray_umath.cpython-37m-x86_64-linux-gnu.so: undefined symbol: __cpu_model

```




---

archive/issue_comments_413190.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-28T14:42:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413190",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_413191.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-03-28T15:09:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413191",
    "user": "mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_413192.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-03-28T15:24:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413192",
    "user": "isuruf"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_413193.json:
```json
{
    "body": "This is dropping `-pthread` on linux.",
    "created_at": "2020-03-28T15:24:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413193",
    "user": "isuruf"
}
```

This is dropping `-pthread` on linux.



---

archive/issue_comments_413194.json:
```json
{
    "body": "Original issue is because the logic at https://github.com/python/cpython/blob/8510f430781118d9b603c3a2f06945d6ebc5fe42/Lib/distutils/sysconfig.py#L204-L205 doesn't get triggered with,\n\n```\nCC xcrun -sdk macosx clang    -arch x86_64\nLDSHARED xcrun -sdk macosx clang     -bundle -undefined dynamic_lookup\n```\n",
    "created_at": "2020-03-28T15:38:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413194",
    "user": "isuruf"
}
```

Original issue is because the logic at https://github.com/python/cpython/blob/8510f430781118d9b603c3a2f06945d6ebc5fe42/Lib/distutils/sysconfig.py#L204-L205 doesn't get triggered with,

```
CC xcrun -sdk macosx clang    -arch x86_64
LDSHARED xcrun -sdk macosx clang     -bundle -undefined dynamic_lookup
```




---

archive/issue_comments_413195.json:
```json
{
    "body": "Help with this ticket is welcome!",
    "created_at": "2020-03-28T16:21:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413195",
    "user": "mkoeppe"
}
```

Help with this ticket is welcome!



---

archive/issue_comments_413196.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2020-03-29T14:39:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413196",
    "user": "mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_413197.json:
```json
{
    "body": "Replying to [comment:47 isuruf]:\n> Original issue is because the logic at https://github.com/python/cpython/blob/8510f430781118d9b603c3a2f06945d6ebc5fe42/Lib/distutils/sysconfig.py#L204-L205 doesn't get triggered with,\n> {{{\n> CC xcrun -sdk macosx clang    -arch x86_64\n> LDSHARED xcrun -sdk macosx clang     -bundle -undefined dynamic_lookup\n> }}}\n\nI don't quite understand this comment. Should it be `CC=...` etc? \nAnyhow, we can propose an upstream patch...",
    "created_at": "2020-03-30T15:16:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413197",
    "user": "dimpase"
}
```

Replying to [comment:47 isuruf]:
> Original issue is because the logic at https://github.com/python/cpython/blob/8510f430781118d9b603c3a2f06945d6ebc5fe42/Lib/distutils/sysconfig.py#L204-L205 doesn't get triggered with,
> {{{
> CC xcrun -sdk macosx clang    -arch x86_64
> LDSHARED xcrun -sdk macosx clang     -bundle -undefined dynamic_lookup
> }}}

I don't quite understand this comment. Should it be `CC=...` etc? 
Anyhow, we can propose an upstream patch...



---

archive/issue_comments_413198.json:
```json
{
    "body": "https://github.com/python/cpython/blob/8510f430781118d9b603c3a2f06945d6ebc5fe42/Lib/distutils/sysconfig.py#L204-L205 checks that `LDSHARED` starts with the old `CC` and if so, old `CC` is replaced with the new `CC`.\n\nIf `LDSHARED` was `xcrun -sdk macosx clang     -arch x86_64 -bundle -undefined dynamic_lookup`, then setting `CC=clang` would give you, `clang -bundle -undefined dynamic_lookup`, but at the moment it is not.",
    "created_at": "2020-03-30T15:19:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413198",
    "user": "isuruf"
}
```

https://github.com/python/cpython/blob/8510f430781118d9b603c3a2f06945d6ebc5fe42/Lib/distutils/sysconfig.py#L204-L205 checks that `LDSHARED` starts with the old `CC` and if so, old `CC` is replaced with the new `CC`.

If `LDSHARED` was `xcrun -sdk macosx clang     -arch x86_64 -bundle -undefined dynamic_lookup`, then setting `CC=clang` would give you, `clang -bundle -undefined dynamic_lookup`, but at the moment it is not.



---

archive/issue_comments_413199.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-04-01T03:01:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413199",
    "user": "isuruf"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_413200.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-04-01T03:01:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413200",
    "user": "isuruf"
}
```

New commits:



---

archive/issue_comments_413201.json:
```json
{
    "body": "Fails on ubuntu-xenial-standard (https://github.com/mkoeppe/sage/runs/552215553):\n\n```\n  ImportError: /sage/local/lib/python3.7/site-packages/numpy/core/_multiarray_umath.cpython-37m-x86_64-linux-gnu.so: undefined symbol: __cpu_model\n```\n",
    "created_at": "2020-04-02T00:49:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413201",
    "user": "mkoeppe"
}
```

Fails on ubuntu-xenial-standard (https://github.com/mkoeppe/sage/runs/552215553):

```
  ImportError: /sage/local/lib/python3.7/site-packages/numpy/core/_multiarray_umath.cpython-37m-x86_64-linux-gnu.so: undefined symbol: __cpu_model
```




---

archive/issue_comments_413202.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-04-02T00:50:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413202",
    "user": "mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_413203.json:
```json
{
    "body": "It looks like on ubuntu, `LDSHARED` has `-Wl,-Bsymbolic-functions` which we need to include.\nShall we only set `LDSHARED` in OSX?",
    "created_at": "2020-04-02T01:22:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413203",
    "user": "isuruf"
}
```

It looks like on ubuntu, `LDSHARED` has `-Wl,-Bsymbolic-functions` which we need to include.
Shall we only set `LDSHARED` in OSX?



---

archive/issue_comments_413204.json:
```json
{
    "body": "Replying to [comment:57 isuruf]:\n> Shall we only set `LDSHARED` in OSX?\n\nProbably better, yes",
    "created_at": "2020-04-02T01:43:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413204",
    "user": "mkoeppe"
}
```

Replying to [comment:57 isuruf]:
> Shall we only set `LDSHARED` in OSX?

Probably better, yes



---

archive/issue_comments_413205.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-02T03:03:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413205",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_413206.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-04-02T03:03:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413206",
    "user": "isuruf"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_413207.json:
```json
{
    "body": "rebased on 9.1.beta9\n----\nNew commits:",
    "created_at": "2020-04-02T12:17:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413207",
    "user": "mkoeppe"
}
```

rebased on 9.1.beta9
----
New commits:



---

archive/issue_comments_413208.json:
```json
{
    "body": "On `local-homebrew-macos-python3_pythonorg-minimal`(https://github.com/mkoeppe/sage/runs/557674691):\n\n\n```\nsage -t src/sage/repl/ipython_extension.py\n**********************************************************************\nFile \"src/sage/repl/ipython_extension.py\", line 385, in sage.repl.ipython_extension.SageMagics.fortran\nFailed example:\n...\nRuntimeError: failed to compile Fortran code:\n    b'Could not locate executable g++ -std=gnu++11 -pthread -bundle -undefined dynamic_lookup\\nIn file included from \n```\n",
    "created_at": "2020-04-03T17:36:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413208",
    "user": "mkoeppe"
}
```

On `local-homebrew-macos-python3_pythonorg-minimal`(https://github.com/mkoeppe/sage/runs/557674691):


```
sage -t src/sage/repl/ipython_extension.py
**********************************************************************
File "src/sage/repl/ipython_extension.py", line 385, in sage.repl.ipython_extension.SageMagics.fortran
Failed example:
...
RuntimeError: failed to compile Fortran code:
    b'Could not locate executable g++ -std=gnu++11 -pthread -bundle -undefined dynamic_lookup\nIn file included from 
```




---

archive/issue_comments_413209.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-04-03T17:37:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413209",
    "user": "mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_413210.json:
```json
{
    "body": "Also \n\n```\nsage -t src/sage/interfaces/gap.py  # 1 doctest failed\nsage -t src/sage/misc/inline_fortran.py  # 3 doctests failed\nsage -t src/sage/misc/persist.pyx  # 2 doctests failed\n```\n",
    "created_at": "2020-04-03T17:38:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413210",
    "user": "mkoeppe"
}
```

Also 

```
sage -t src/sage/interfaces/gap.py  # 1 doctest failed
sage -t src/sage/misc/inline_fortran.py  # 3 doctests failed
sage -t src/sage/misc/persist.pyx  # 2 doctests failed
```




---

archive/issue_comments_413211.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-04-09T03:50:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413211",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_413212.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-04-09T03:52:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413212",
    "user": "mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_413213.json:
```json
{
    "body": "Started again from scratch. Turns out I broke it 4 years ago in #21175 by setting `ARCHFLAGS`. This interacts in a bizarre way with the bizarre code discussed above.",
    "created_at": "2020-04-09T03:52:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413213",
    "user": "mkoeppe"
}
```

Started again from scratch. Turns out I broke it 4 years ago in #21175 by setting `ARCHFLAGS`. This interacts in a bizarre way with the bizarre code discussed above.



---

archive/issue_comments_413214.json:
```json
{
    "body": "Tests run in https://github.com/mkoeppe/sage/actions/runs/73955490",
    "created_at": "2020-04-09T03:58:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413214",
    "user": "mkoeppe"
}
```

Tests run in https://github.com/mkoeppe/sage/actions/runs/73955490



---

archive/issue_comments_413215.json:
```json
{
    "body": "This works for me, but I don't understand the changes in `build/pkgs/python3/spkg-configure.m4`.",
    "created_at": "2020-04-09T23:29:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413215",
    "user": "jhpalmieri"
}
```

This works for me, but I don't understand the changes in `build/pkgs/python3/spkg-configure.m4`.



---

archive/issue_comments_413216.json:
```json
{
    "body": "So if someone else wants to review it, I am happy to give some fraction of a positive review.",
    "created_at": "2020-04-09T23:31:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413216",
    "user": "jhpalmieri"
}
```

So if someone else wants to review it, I am happy to give some fraction of a positive review.



---

archive/issue_comments_413217.json:
```json
{
    "body": "Replying to [comment:70 jhpalmieri]:\n> I don't understand the changes in `build/pkgs/python3/spkg-configure.m4`.\n\nThere was already a test that the system python (in the venv) is able to build a C extension.\nThe change tightens this check by imposing the configured `CC` (and `CXX`) values -- because this is what the actual build will be running.\nIt also adds the same test for building a C++ 11 extension.",
    "created_at": "2020-04-09T23:35:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413217",
    "user": "mkoeppe"
}
```

Replying to [comment:70 jhpalmieri]:
> I don't understand the changes in `build/pkgs/python3/spkg-configure.m4`.

There was already a test that the system python (in the venv) is able to build a C extension.
The change tightens this check by imposing the configured `CC` (and `CXX`) values -- because this is what the actual build will be running.
It also adds the same test for building a C++ 11 extension.



---

archive/issue_comments_413218.json:
```json
{
    "body": "Replying to [comment:71 jhpalmieri]:\n> some fraction of a positive review.\n100% thanks already",
    "created_at": "2020-04-09T23:36:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413218",
    "user": "mkoeppe"
}
```

Replying to [comment:71 jhpalmieri]:
> some fraction of a positive review.
100% thanks already



---

archive/issue_comments_413219.json:
```json
{
    "body": "Let's also get this one into the next beta please",
    "created_at": "2020-04-12T00:55:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413219",
    "user": "mkoeppe"
}
```

Let's also get this one into the next beta please



---

archive/issue_comments_413220.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2020-04-12T16:59:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413220",
    "user": "mkoeppe"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_413221.json:
```json
{
    "body": "Okay, let's merge it. I can't get polymake to build with or without these changes, and the changes make sense.\n\nRe polymake, here is the error:\n\n```\nninja: Entering directory `build/Opt'\n[1/1] GENERATE /Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-9.1.beta9/local/var/tmp/sage/build/polymake-3.4/src/build/targets.ninja\nFAILED: /Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-9.1.beta9/local/var/tmp/sage/build/polymake-3.4/src/build/targets.ninja \n/usr/bin/perl /Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-9.1.beta9/local/var/tmp/sage/build/polymake-3.4/src/support/generate_ninja_targets.pl /Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-9.1.beta9/local/var/tmp/sage/build/polymake-3.4/src/build/targets.ninja /Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-9.1.beta9/local/var/tmp/sage/build/polymake-3.4/src /Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-9.1.beta9/local/var/tmp/sage/build/polymake-3.4/src/build/config.ninja\nCan't locate JSON.pm in @INC (you may need to install the JSON module) (@INC contains: /Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-9.1.beta9/local/lib/perl5/darwin-thread-multi-2level /Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-9.1.beta9/local/lib/perl5 /Library/Perl/5.18/darwin-thread-multi-2level /Library/Perl/5.18 /Network/Library/Perl/5.18/darwin-thread-multi-2level /Network/Library/Perl/5.18 /Library/Perl/Updates/5.18.4 /System/Library/Perl/5.18/darwin-thread-multi-2level /System/Library/Perl/5.18 /System/Library/Perl/Extras/5.18/darwin-thread-multi-2level /System/Library/Perl/Extras/5.18 .) at /Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-9.1.beta9/local/var/tmp/sage/build/polymake-3.4/src/support/generate_cpperl_modules.pl line 22.\nBEGIN failed--compilation aborted at /Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-9.1.beta9/local/var/tmp/sage/build/polymake-3.4/src/support/generate_cpperl_modules.pl line 22.\nninja: error: rebuilding 'build.ninja': subcommand failed\nmake[2]: *** [all] Error 1\n```\n\nIt's probably the old problem of not having the right perl modules present and Sage's polymake build system failing to recognize that. The instructions in polymake's SPKG.txt are no longer valid.\n\nIn any case, the polymake problems should be dealt with at #29054.",
    "created_at": "2020-04-12T21:02:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413221",
    "user": "jhpalmieri"
}
```

Okay, let's merge it. I can't get polymake to build with or without these changes, and the changes make sense.

Re polymake, here is the error:

```
ninja: Entering directory `build/Opt'
[1/1] GENERATE /Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-9.1.beta9/local/var/tmp/sage/build/polymake-3.4/src/build/targets.ninja
FAILED: /Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-9.1.beta9/local/var/tmp/sage/build/polymake-3.4/src/build/targets.ninja 
/usr/bin/perl /Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-9.1.beta9/local/var/tmp/sage/build/polymake-3.4/src/support/generate_ninja_targets.pl /Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-9.1.beta9/local/var/tmp/sage/build/polymake-3.4/src/build/targets.ninja /Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-9.1.beta9/local/var/tmp/sage/build/polymake-3.4/src /Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-9.1.beta9/local/var/tmp/sage/build/polymake-3.4/src/build/config.ninja
Can't locate JSON.pm in @INC (you may need to install the JSON module) (@INC contains: /Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-9.1.beta9/local/lib/perl5/darwin-thread-multi-2level /Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-9.1.beta9/local/lib/perl5 /Library/Perl/5.18/darwin-thread-multi-2level /Library/Perl/5.18 /Network/Library/Perl/5.18/darwin-thread-multi-2level /Network/Library/Perl/5.18 /Library/Perl/Updates/5.18.4 /System/Library/Perl/5.18/darwin-thread-multi-2level /System/Library/Perl/5.18 /System/Library/Perl/Extras/5.18/darwin-thread-multi-2level /System/Library/Perl/Extras/5.18 .) at /Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-9.1.beta9/local/var/tmp/sage/build/polymake-3.4/src/support/generate_cpperl_modules.pl line 22.
BEGIN failed--compilation aborted at /Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-9.1.beta9/local/var/tmp/sage/build/polymake-3.4/src/support/generate_cpperl_modules.pl line 22.
ninja: error: rebuilding 'build.ninja': subcommand failed
make[2]: *** [all] Error 1
```

It's probably the old problem of not having the right perl modules present and Sage's polymake build system failing to recognize that. The instructions in polymake's SPKG.txt are no longer valid.

In any case, the polymake problems should be dealt with at #29054.



---

archive/issue_comments_413222.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-04-12T21:02:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413222",
    "user": "jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_413223.json:
```json
{
    "body": "Thanks. Yes, polymake will take more work.",
    "created_at": "2020-04-12T21:03:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413223",
    "user": "mkoeppe"
}
```

Thanks. Yes, polymake will take more work.



---

archive/issue_comments_413224.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-04-15T22:13:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29171",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29171#issuecomment-413224",
    "user": "vbraun"
}
```

Resolution: fixed
