# Issue 29171: Fix build errors with pplpy on macos with system python3

Issue created by migration from https://trac.sagemath.org/ticket/29408

Original creator: mkoeppe

Original creation time: 2020-03-26 02:10:44

CC:  dimpase vdelecroix fbissey @mwageringel embray jhpalmieri vbraun

https://github.com/mkoeppe/sage/runs/531095486

pplpy:

```
    g++ -sdk macosx clang -bundle -undefined dynamic_lookup -L/Users/runner/runners/2.165.2/work/sage/sage/.tox/local-homebrew-macos-standard/local/lib -Wl,-rpath,/Users/runner/runners/2.165.2/work/sage/sage/.tox/local-homebrew-macos-standard/local/lib -L/Users/runner/runners/2.165.2/work/sage/sage/.tox/local-homebrew-macos-standard/homebrew/opt/readline/lib -L/Users/runner/runners/2.165.2/work/sage/sage/.tox/local-homebrew-macos-standard/homebrew/lib -I/Users/runner/runners/2.165.2/work/sage/sage/.tox/local-homebrew-macos-standard/homebrew/opt/readline/include -I/Users/runner/runners/2.165.2/work/sage/sage/.tox/local-homebrew-macos-standard/homebrew/include build/temp.macosx-10.14-x86_64-3.7/ppl/linear_algebra.o build/temp.macosx-10.14-x86_64-3.7/ppl/ppl_shim.o -lgmp -lgmpxx -lppl -lm -o build/lib.macosx-10.14-x86_64-3.7/ppl/linear_algebra.cpython-37m-darwin.so
    clang: error: unknown argument: '-sdk'
    clang: error: no such file or directory: 'macosx'
    clang: error: no such file or directory: 'clang'
    error: command 'g++' failed with exit status 1
    Running setup.py install for pplpy: finished with status 'error'
Cleaning up...
```


(broken out from #29404)


---

Comment by dimpase created at 2020-03-26 02:26:37

this needs details on the Python (system MacOS? Homebrew? CPython package?) and on clang (XCode? Homebrew? Other (e.g. conda?))


---

Comment by dimpase created at 2020-03-26 03:26:39

what I gather from these links is that Pythons in MacOS are not Homebrew ones.


---

Comment by mkoeppe created at 2020-03-27 14:57:56

Replying to [comment:3 dimpase]:
> what I gather from these links is that Pythons in MacOS are not Homebrew ones.
That's right, this is system python3 from `/usr/bin`


---

Comment by mkoeppe created at 2020-03-27 19:54:57

Something seems to get very confused about values from sysconfig as it tries to replace `xcrun` by `g++`.


```
>>> for k, v in sysconfig.get_config_vars().items():
...     if isinstance(v, str) and 'sdk' in v:
...         print(k, v)
... 
BLDSHARED xcrun -sdk macosx clang     -bundle -undefined dynamic_lookup 
CC xcrun -sdk macosx clang    -arch x86_64 
CONFIG_ARGS '-C' '--host=x86_64-apple-darwin' '--build=x86_64-apple-darwin' '--enable-framework=/Applications/Xcode.app/Contents/Developer/Library/Frameworks' '--with-framework-name=Python3' '--with-openssl=/BuildRoot/Library/Caches/com.apple.xbs/Binaries/python3/install/TempContent/Root/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.7' '--enable-ipv6' '--prefix=/Applications/Xcode.app/Contents/Developer/usr' '--with-pymalloc' 'PYTHON_FOR_BUILD=DYLD_FRAMEWORK_PATH=/BuildRoot/Library/Caches/com.apple.xbs/Binaries/python3/install/TempContent/Objects/host /BuildRoot/Library/Caches/com.apple.xbs/Binaries/python3/install/TempContent/Objects/host/python.exe' 'CC=xcrun -sdk macosx clang    -arch x86_64' 'CXX=xcrun -sdk macosx clang++  -arch x86_64' 'CPP=xcrun -sdk macosx clang -E -arch x86_64' 'CFLAGS=-iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.7/Headers' 'CPPFLAGS=-iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.7/Headers' 'LIBS=-lSystem' 'LDFLAGS=' 'OBJROOT=/BuildRoot/Library/Caches/com.apple.xbs/Binaries/python3/install/TempContent/Objects' 'SDKROOT=/BuildRoot/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.15.Internal.sdk' 'build_alias=x86_64-apple-darwin' 'host_alias=x86_64-apple-darwin'
CXX xcrun -sdk macosx clang++  -arch x86_64 
LDCXXSHARED xcrun -sdk macosx clang++  -arch x86_64 -bundle -undefined dynamic_lookup
LDSHARED xcrun -sdk macosx clang     -bundle -undefined dynamic_lookup 
LINKCC xcrun -sdk macosx clang    -arch x86_64
MAINCC xcrun -sdk macosx clang    -arch x86_64
SDKROOT /BuildRoot/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.15.Internal.sdk
_OSX_SUPPORT_INITIAL_BLDSHARED xcrun -sdk macosx clang    -arch x86_64 -bundle -undefined dynamic_lookup
_OSX_SUPPORT_INITIAL_LDSHARED xcrun -sdk macosx clang    -arch x86_64 -bundle -undefined dynamic_lookup
_OSX_SUPPORT_INITIAL_CC xcrun -sdk macosx clang    -arch x86_64
_OSX_SUPPORT_INITIAL_CXX xcrun -sdk macosx clang++  -arch x86_64
```



---

Comment by mkoeppe created at 2020-03-27 20:36:31

It is caused by bizarre code in `distutils.unixccompiler.UnixCCompiler.link`.


---

Comment by mkoeppe created at 2020-03-27 20:38:56

https://github.com/python/cpython/blob/master/Lib/distutils/unixccompiler.py#L180
with 

```
(Pdb) p self.linker_so
['xcrun', '-sdk', 'macosx', 'clang', '-bundle', '-undefined', 'dynamic_lookup', '-L/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-macos-standard/local/lib', '-Wl,-rpath,/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/.tox/local-homebrew-macos-standard/local/lib', '-L/usr/local/opt/readline/lib', '-L/usr/local/lib', '-I/usr/local/opt/readline/include', '-I/usr/local/include']
(Pdb) p self.compiler_cxx
['g++', '-std=gnu++11']
```



---

Comment by fbissey created at 2020-03-27 20:40:41

Yes, my head hurts when I look at that file. I am fairly sure distros all over have patches for some aspects of it.

From the line it expect some behavior from xcode.


---

Comment by fbissey created at 2020-03-27 20:42:12

Hum

```
fbissey@itsv-frb15 ~ % xcrun --help
Usage: xcrun [options] <tool name> ... arguments ...

Find and execute the named command line tool from the active developer
directory.

The active developer directory can be set using `xcode-select`, or via the
DEVELOPER_DIR environment variable. See the xcrun and xcode-select manual
pages for more information.

Options:
  -h, --help                  show this help message and exit
  --version                   show the xcrun version
  -v, --verbose               show verbose logging output
  --sdk <sdk name>            find the tool for the given SDK name
  --toolchain <name>          find the tool for the given toolchain
  -l, --log                   show commands to be executed (with --run)
  -f, --find                  only find and print the tool path
  -r, --run                   find and execute the tool (the default behavior)
  -n, --no-cache              do not use the lookup cache
  -k, --kill-cache            invalidate all existing cache entries
  --show-sdk-path             show selected SDK install path
  --show-sdk-version          show selected SDK version
  --show-sdk-build-version    show selected SDK build version
  --show-sdk-platform-path    show selected SDK platform path
  --show-sdk-platform-version show selected SDK platform version
```

Is it just a stupid `--` versus `-`?


---

Comment by mkoeppe created at 2020-03-27 20:51:17

No, the linked code is really replacing "xcrun" by "g++".


---

Comment by mkoeppe created at 2020-03-27 20:51:43

More context, more fun at https://github.com/python/cpython/blob/master/Lib/_osx_support.py


---

Comment by mkoeppe created at 2020-03-27 20:57:53

Each of `xcrun -sdk macosx clang`, `g++`, and `xcrun -sdk macosx clang++`  make sense.
But the code tries to mix the first two to get the third, and gets `g++  -sdk macosx clang`, which makes no sense, obviously.


---

Comment by mkoeppe created at 2020-03-27 21:02:23

Google search for LDCXXSHARED distutils brings up various things

https://www.google.com/search?safe=off&sxsrf=ALeKk01RyL6O3kSKx0-W2ZRb3O8N8Pdg-A:1585342860000&q=LDCXXSHARED+distutils&nfpr=1&sa=X&ved=2ahUKEwiSrZGwxrvoAhWkl3IEHZtFCmEQvgUoAXoECAwQKA&biw=875&bih=862


---

Comment by mkoeppe created at 2020-03-27 21:07:59

It's an existing Python issue: https://bugs.python.org/issue8027


---

Comment by mkoeppe created at 2020-03-27 21:11:27

More precisely, this one: https://bugs.python.org/issue1222585


---

Comment by mkoeppe created at 2020-03-27 21:11:50

... open since 2005


---

Comment by mkoeppe created at 2020-03-27 21:16:31

Related previous issue: #17484


---

Comment by fbissey created at 2020-03-27 21:18:50

Replying to [comment:19 mkoeppe]:
> ... open since 2005

Upstream python does have a bad history of compiler/linker support (especially differentiation between C and C++ actually).


---

Comment by mkoeppe created at 2020-03-27 21:21:54

A simple workaround is to clear the CXX environment variable before we call the installation.
Then it will build the extension using the compiler configured in python's sysconfig.


---

Comment by fbissey created at 2020-03-27 21:27:38

Hum, OK but only for OSX. The problem is that we set CXX as a c++11 compiler which means CXX may actually be `g++ -std=c++11` (or `gnu++11` actually) in most case. On OS X, clang++ is c++11 at least by default so we can afford that. On other platforms, we would run into troubles.

Why does CXX includes `-std=c++11` rather than it being a separate CPPFLAGS? Because CXX as a whole is defined as a c++11 compiler.


---

Comment by mkoeppe created at 2020-03-27 22:22:19

Our own python3 has `g++ -std=c++11` in its sysconfig CXX in that case.

But you are right, for a system python3, we would not be able to assume that the sysconfig CXX is a C++11 compiler.


---

Comment by mkoeppe created at 2020-03-27 22:22:55

So I guess this needs to be figured out at configure time.


---

Comment by mkoeppe created at 2020-03-27 22:44:32

A different workaround is to set `LDSHARED="$CXX -bundle -undefined dynamic_lookup"`.


---

Comment by fbissey created at 2020-03-27 22:46:20

That sounds interesting! And it avoids the c++11 mess.


---

Comment by mkoeppe created at 2020-03-27 22:54:49

So, a macOS-specific workaround for all Python packages that use C++ extensions?


---

Comment by fbissey created at 2020-03-27 22:56:36

Unfortunately, pretty much.


---

Comment by mkoeppe created at 2020-03-27 23:23:47

Interesting is also this test:
https://github.com/python/cpython/blob/e42b705188271da108de42b55d9344642170aa2b/Lib/distutils/tests/test_unixccompiler.py#L105
which corresponds to https://bugs.python.org/issue18080. 
The code added in this issue is unfortunately made ineffective by the fact that in Apple's installation, `cc = "xcrun -sdk macosx clang    -arch x86_64 "` and `ldshared = "xcrun -sdk macosx clang     -bundle -undefined dynamic_lookup "`, i.e., `ldshared.startswith(cc)` is False.


---

Comment by mkoeppe created at 2020-03-27 23:29:02

A candidate for a portable solution, to be applied to all Python packages that build C++ extensions would be:

```
LDSHARED=$(/usr/bin/python -c 'import sysconfig; print(sysconfig.get_config_var("LDCXXSHARED"))')
```



---

Comment by mkoeppe created at 2020-03-27 23:30:56

With this, packages would still compile with CXX (which would include the C++11 flags if needed), but link with the C++ linker known to sysconfig.


---

Comment by fbissey created at 2020-03-27 23:53:56

Replying to [comment:31 mkoeppe]:
> A candidate for a portable solution, to be applied to all Python packages that build C++ extensions would be:
> {{{
> LDSHARED=$(/usr/bin/python -c 'import sysconfig; print(sysconfig.get_config_var("LDCXXSHARED"))')
> }}}

I don't like the `/usr/bin/python` bit, but I am sure we can replace that by something appropriate. That sounds like a good idea and now it needs to be tested.


---

Comment by mkoeppe created at 2020-03-27 23:56:55

Right, of course it would be `LDSHARED=$(sage-python23 -c 'import sysconfig; print(sysconfig.get_config_var("LDCXXSHARED"))').`


---

Comment by mkoeppe created at 2020-03-28 03:05:39

This did not work after all, but I have found a solution that seems to work and is reasonably clean.
----
New commits:


---

Comment by mkoeppe created at 2020-03-28 03:06:34

Setting this unconditionally in `sage-env` rather than in package build scripts -- to make sure that these settings are in place even when a user does a `sage -pip install` of some random package.


---

Comment by fbissey created at 2020-03-28 03:09:06

Looks OK to me. I guess you have some bots testing it out.


---

Comment by mkoeppe created at 2020-03-28 03:42:29

Tests run at https://github.com/mkoeppe/sage/actions/runs/65083365


---

Comment by mkoeppe created at 2020-03-28 03:42:46

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-03-28 14:30:23

This breaks matplotlib via numpy unfortunately


---

Comment by mkoeppe created at 2020-03-28 14:30:23

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-03-28 14:30:58


```
        from numpy.core._multiarray_umath import (
    ImportError: /sage/local/lib/python3.7/site-packages/numpy/core/_multiarray_umath.cpython-37m-x86_64-linux-gnu.so: undefined symbol: __cpu_model

```



---

Comment by git created at 2020-03-28 14:42:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-28 15:09:34

Changing status from needs_work to needs_review.


---

Comment by isuruf created at 2020-03-28 15:24:23

Changing status from needs_review to needs_work.


---

Comment by isuruf created at 2020-03-28 15:24:23

This is dropping `-pthread` on linux.


---

Comment by isuruf created at 2020-03-28 15:38:10

Original issue is because the logic at https://github.com/python/cpython/blob/8510f430781118d9b603c3a2f06945d6ebc5fe42/Lib/distutils/sysconfig.py#L204-L205 doesn't get triggered with,

```
CC xcrun -sdk macosx clang    -arch x86_64
LDSHARED xcrun -sdk macosx clang     -bundle -undefined dynamic_lookup
```



---

Comment by mkoeppe created at 2020-03-28 16:21:33

Help with this ticket is welcome!


---

Comment by mkoeppe created at 2020-03-29 14:39:34

Changing priority from major to critical.


---

Comment by dimpase created at 2020-03-30 15:16:16

Replying to [comment:47 isuruf]:
> Original issue is because the logic at https://github.com/python/cpython/blob/8510f430781118d9b603c3a2f06945d6ebc5fe42/Lib/distutils/sysconfig.py#L204-L205 doesn't get triggered with,
> {{{
> CC xcrun -sdk macosx clang    -arch x86_64
> LDSHARED xcrun -sdk macosx clang     -bundle -undefined dynamic_lookup
> }}}

I don't quite understand this comment. Should it be `CC=...` etc? 
Anyhow, we can propose an upstream patch...


---

Comment by isuruf created at 2020-03-30 15:19:06

https://github.com/python/cpython/blob/8510f430781118d9b603c3a2f06945d6ebc5fe42/Lib/distutils/sysconfig.py#L204-L205 checks that `LDSHARED` starts with the old `CC` and if so, old `CC` is replaced with the new `CC`.

If `LDSHARED` was `xcrun -sdk macosx clang     -arch x86_64 -bundle -undefined dynamic_lookup`, then setting `CC=clang` would give you, `clang -bundle -undefined dynamic_lookup`, but at the moment it is not.


---

Comment by isuruf created at 2020-04-01 03:01:50

Changing status from needs_work to needs_review.


---

Comment by isuruf created at 2020-04-01 03:01:50

New commits:


---

Comment by mkoeppe created at 2020-04-02 00:49:56

Fails on ubuntu-xenial-standard (https://github.com/mkoeppe/sage/runs/552215553):

```
  ImportError: /sage/local/lib/python3.7/site-packages/numpy/core/_multiarray_umath.cpython-37m-x86_64-linux-gnu.so: undefined symbol: __cpu_model
```



---

Comment by mkoeppe created at 2020-04-02 00:50:04

Changing status from needs_review to needs_work.


---

Comment by isuruf created at 2020-04-02 01:22:02

It looks like on ubuntu, `LDSHARED` has `-Wl,-Bsymbolic-functions` which we need to include.
Shall we only set `LDSHARED` in OSX?


---

Comment by mkoeppe created at 2020-04-02 01:43:50

Replying to [comment:57 isuruf]:
> Shall we only set `LDSHARED` in OSX?

Probably better, yes


---

Comment by git created at 2020-04-02 03:03:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by isuruf created at 2020-04-02 03:03:31

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-04-02 12:17:14

rebased on 9.1.beta9
----
New commits:


---

Comment by mkoeppe created at 2020-04-03 17:36:53

On `local-homebrew-macos-python3_pythonorg-minimal`(https://github.com/mkoeppe/sage/runs/557674691):


```
sage -t src/sage/repl/ipython_extension.py
**********************************************************************
File "src/sage/repl/ipython_extension.py", line 385, in sage.repl.ipython_extension.SageMagics.fortran
Failed example:
...
RuntimeError: failed to compile Fortran code:
    b'Could not locate executable g++ -std=gnu++11 -pthread -bundle -undefined dynamic_lookup\nIn file included from 
```



---

Comment by mkoeppe created at 2020-04-03 17:37:03

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-04-03 17:38:01

Also 

```
sage -t src/sage/interfaces/gap.py  # 1 doctest failed
sage -t src/sage/misc/inline_fortran.py  # 3 doctests failed
sage -t src/sage/misc/persist.pyx  # 2 doctests failed
```



---

Comment by git created at 2020-04-09 03:50:27

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-04-09 03:52:02

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-04-09 03:52:02

Started again from scratch. Turns out I broke it 4 years ago in #21175 by setting `ARCHFLAGS`. This interacts in a bizarre way with the bizarre code discussed above.


---

Comment by mkoeppe created at 2020-04-09 03:58:32

Tests run in https://github.com/mkoeppe/sage/actions/runs/73955490


---

Comment by jhpalmieri created at 2020-04-09 23:29:55

This works for me, but I don't understand the changes in `build/pkgs/python3/spkg-configure.m4`.


---

Comment by jhpalmieri created at 2020-04-09 23:31:19

So if someone else wants to review it, I am happy to give some fraction of a positive review.


---

Comment by mkoeppe created at 2020-04-09 23:35:28

Replying to [comment:70 jhpalmieri]:
> I don't understand the changes in `build/pkgs/python3/spkg-configure.m4`.

There was already a test that the system python (in the venv) is able to build a C extension.
The change tightens this check by imposing the configured `CC` (and `CXX`) values -- because this is what the actual build will be running.
It also adds the same test for building a C++ 11 extension.


---

Comment by mkoeppe created at 2020-04-09 23:36:02

Replying to [comment:71 jhpalmieri]:
> some fraction of a positive review.
100% thanks already


---

Comment by mkoeppe created at 2020-04-12 00:55:56

Let's also get this one into the next beta please


---

Comment by mkoeppe created at 2020-04-12 16:59:49

Changing priority from critical to blocker.


---

Comment by jhpalmieri created at 2020-04-12 21:02:13

Okay, let's merge it. I can't get polymake to build with or without these changes, and the changes make sense.

Re polymake, here is the error:

```
ninja: Entering directory `build/Opt'
[1/1] GENERATE /Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-9.1.beta9/local/var/tmp/sage/build/polymake-3.4/src/build/targets.ninja
FAILED: /Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-9.1.beta9/local/var/tmp/sage/build/polymake-3.4/src/build/targets.ninja 
/usr/bin/perl /Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-9.1.beta9/local/var/tmp/sage/build/polymake-3.4/src/support/generate_ninja_targets.pl /Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-9.1.beta9/local/var/tmp/sage/build/polymake-3.4/src/build/targets.ninja /Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-9.1.beta9/local/var/tmp/sage/build/polymake-3.4/src /Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-9.1.beta9/local/var/tmp/sage/build/polymake-3.4/src/build/config.ninja
Can't locate JSON.pm in @INC (you may need to install the JSON module) (@INC contains: /Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-9.1.beta9/local/lib/perl5/darwin-thread-multi-2level /Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-9.1.beta9/local/lib/perl5 /Library/Perl/5.18/darwin-thread-multi-2level /Library/Perl/5.18 /Network/Library/Perl/5.18/darwin-thread-multi-2level /Network/Library/Perl/5.18 /Library/Perl/Updates/5.18.4 /System/Library/Perl/5.18/darwin-thread-multi-2level /System/Library/Perl/5.18 /System/Library/Perl/Extras/5.18/darwin-thread-multi-2level /System/Library/Perl/Extras/5.18 .) at /Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-9.1.beta9/local/var/tmp/sage/build/polymake-3.4/src/support/generate_cpperl_modules.pl line 22.
BEGIN failed--compilation aborted at /Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-9.1.beta9/local/var/tmp/sage/build/polymake-3.4/src/support/generate_cpperl_modules.pl line 22.
ninja: error: rebuilding 'build.ninja': subcommand failed
make[2]: *** [all] Error 1
```

It's probably the old problem of not having the right perl modules present and Sage's polymake build system failing to recognize that. The instructions in polymake's SPKG.txt are no longer valid.

In any case, the polymake problems should be dealt with at #29054.


---

Comment by jhpalmieri created at 2020-04-12 21:02:13

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-04-12 21:03:59

Thanks. Yes, polymake will take more work.


---

Comment by vbraun created at 2020-04-15 22:13:18

Resolution: fixed
