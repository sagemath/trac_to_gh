# Issue 28112: Problem with SAGE_INC in module_list.py when using system packages

Issue created by migration from https://trac.sagemath.org/ticket/28349

Original creator: embray

Original creation time: 2019-08-13 14:45:56

CC:  dimpase

I noticed in a recent build of Sage on a Debian buster VM, using many system packages, a problem:

Every time I try to re-build, whether I run `make build`, `sage -b`, etc. two Python modules get recompiled (from their Cython-generated C sources, though Cython itself is not being re-run). Specifically,

src/build/cythonized/sage/modules/vector_mod2_dense.c
src/build/cythonized/sage/matrix/matrix_mod2_dense.c

One of the things that these two modules have in common, and unique from other modules (as listed in src/module_list.py) is their dependency on `SAGE_INC + '/png.h'`.  But since I'm using the system libpng, this file does not exist, so those modules constantly get rebuilt.

I'm not really sure the best thing to do about this right now.  Maybe we should only add those headers to the `depends` list if they actually exist (and just assume that system headers won't be updated often...)


---

Comment by dimpase created at 2019-08-13 15:42:43

good catch. I noticed this too, and was wondering what it is...


---

Comment by jdemeyer created at 2019-08-14 08:24:06

This file doesn't actually depend on `png.h` in any way that I can see, so we should just drop that dependency (regardless of whether it fixes the issue on this ticket).


---

Comment by embray created at 2019-08-14 08:40:28

New commits:


---

Comment by embray created at 2019-08-14 08:41:54

Replying to [comment:3 jdemeyer]:
> This file doesn't actually depend on `png.h` in any way that I can see, so we should just drop that dependency (regardless of whether it fixes the issue on this ticket).

It does depend indirectly through gd.h, which it does depend on directly.  But I agree it's a bit odd to include png.h in that list explicitly.


---

Comment by embray created at 2019-08-14 08:43:11

Sorry--pressed submit without seeing you had added to this.  Maybe you were going to change something?

Nevertheless, the problem is still more general than png.h.  It would be better not to use `SAGE_INC` in this way (e.g. the same problem applies for m4ri, I just don't have a system package for that yet).


---

Comment by dimpase created at 2019-08-14 08:45:20


```
+from sage.env import SAGE_LOCAL, SAGE_INC
```

would surely be inconvenient for distributions that don't use `sage.env`.


---

Comment by embray created at 2019-08-14 08:49:04

Apparently in the `depends = ['png.h]` traces back to #5265, and didn't really make sense then either.  When vector_mod2_dense was added it was just carried over as cargo cult.
----
New commits:


---

Comment by jdemeyer created at 2019-08-14 08:50:17

New commits:


---

Comment by embray created at 2019-08-14 08:51:22

Heh, perhaps we can merge these two fixes?  I think Jeroen's branch makes sense in its own right.


---

Comment by jdemeyer created at 2019-08-14 08:51:55

I created #28352 with my fix.


---

Comment by jdemeyer created at 2019-08-14 08:52:32

Replying to [comment:6 embray]:
> It does depend indirectly through gd.h, which it does depend on directly.

My `gd.h` does not depend on `png.h`


---

Comment by jdemeyer created at 2019-08-14 08:53:41

The `gd` library does depend on the `png` library, but that's independent of the header files.


---

Comment by fbissey created at 2019-08-14 09:20:06

Replying to [comment:8 dimpase]:
> {{{
> +from sage.env import SAGE_LOCAL, SAGE_INC
> }}}
> would surely be inconvenient for distributions that don't use `sage.env`.

Some of us are phasing out `sage-env` but we do love `sage.env`.


---

Comment by embray created at 2019-12-30 14:48:17

Ticket retargeted after milestone closed


---

Comment by mkoeppe created at 2020-04-27 23:55:52

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-04-27 23:55:52

If I'm not mistaken, this was fixed by #28352?


---

Comment by dimpase created at 2020-04-28 02:46:52

this one has been fixed, but similar problems pop up elsewhere, e.g. I saw similar parasite rebuilds with
the branch of #29369 (currently disabled) - apparently 

```
    Extension('sage.rings.polynomial.pbori',
              sources = ['sage/rings/polynomial/pbori.pyx'],
              libraries=['brial', 'brial_groebner'] + m4ri_libs + png_libs,
              library_dirs = m4ri_library_dirs + png_library_dirs,
              include_dirs = m4ri_include_dirs + png_include_dirs,
              depends = [SAGE_INC + "/polybori/" + hd + ".h" for hd in ["polybori", "config"]],
              extra_compile_args = m4ri_extra_compile_args),
```

is to blame


---

Comment by dimpase created at 2020-04-28 02:49:42

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2020-06-04 18:50:11

Resolution: duplicate
