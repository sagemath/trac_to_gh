# Issue 28112: Problem with SAGE_INC in module_list.py when using system packages

archive/issues_028112.json:
```json
{
    "body": "CC:  @dimpase\n\nI noticed in a recent build of Sage on a Debian buster VM, using many system packages, a problem:\n\nEvery time I try to re-build, whether I run `make build`, `sage -b`, etc. two Python modules get recompiled (from their Cython-generated C sources, though Cython itself is not being re-run). Specifically,\n\nsrc/build/cythonized/sage/modules/vector_mod2_dense.c\nsrc/build/cythonized/sage/matrix/matrix_mod2_dense.c\n\nOne of the things that these two modules have in common, and unique from other modules (as listed in src/module_list.py) is their dependency on `SAGE_INC + '/png.h'`.  But since I'm using the system libpng, this file does not exist, so those modules constantly get rebuilt.\n\nI'm not really sure the best thing to do about this right now.  Maybe we should only add those headers to the `depends` list if they actually exist (and just assume that system headers won't be updated often...)\n\nIssue created by migration from https://trac.sagemath.org/ticket/28349\n\n",
    "created_at": "2019-08-13T14:45:56Z",
    "labels": [
        "component: build",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Problem with SAGE_INC in module_list.py when using system packages",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28112",
    "user": "https://github.com/embray"
}
```
CC:  @dimpase

I noticed in a recent build of Sage on a Debian buster VM, using many system packages, a problem:

Every time I try to re-build, whether I run `make build`, `sage -b`, etc. two Python modules get recompiled (from their Cython-generated C sources, though Cython itself is not being re-run). Specifically,

src/build/cythonized/sage/modules/vector_mod2_dense.c
src/build/cythonized/sage/matrix/matrix_mod2_dense.c

One of the things that these two modules have in common, and unique from other modules (as listed in src/module_list.py) is their dependency on `SAGE_INC + '/png.h'`.  But since I'm using the system libpng, this file does not exist, so those modules constantly get rebuilt.

I'm not really sure the best thing to do about this right now.  Maybe we should only add those headers to the `depends` list if they actually exist (and just assume that system headers won't be updated often...)

Issue created by migration from https://trac.sagemath.org/ticket/28349





---

archive/issue_comments_396711.json:
```json
{
    "body": "good catch. I noticed this too, and was wondering what it is...",
    "created_at": "2019-08-13T15:42:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28112#issuecomment-396711",
    "user": "https://github.com/dimpase"
}
```

good catch. I noticed this too, and was wondering what it is...



---

archive/issue_comments_396712.json:
```json
{
    "body": "This file doesn't actually depend on `png.h` in any way that I can see, so we should just drop that dependency (regardless of whether it fixes the issue on this ticket).",
    "created_at": "2019-08-14T08:24:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28112#issuecomment-396712",
    "user": "https://github.com/jdemeyer"
}
```

This file doesn't actually depend on `png.h` in any way that I can see, so we should just drop that dependency (regardless of whether it fixes the issue on this ticket).



---

archive/issue_comments_396713.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-08-14T08:40:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28112#issuecomment-396713",
    "user": "https://github.com/embray"
}
```

New commits:



---

archive/issue_comments_396714.json:
```json
{
    "body": "Replying to [comment:3 jdemeyer]:\n> This file doesn't actually depend on `png.h` in any way that I can see, so we should just drop that dependency (regardless of whether it fixes the issue on this ticket).\n\nIt does depend indirectly through gd.h, which it does depend on directly.  But I agree it's a bit odd to include png.h in that list explicitly.",
    "created_at": "2019-08-14T08:41:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28112#issuecomment-396714",
    "user": "https://github.com/embray"
}
```

Replying to [comment:3 jdemeyer]:
> This file doesn't actually depend on `png.h` in any way that I can see, so we should just drop that dependency (regardless of whether it fixes the issue on this ticket).

It does depend indirectly through gd.h, which it does depend on directly.  But I agree it's a bit odd to include png.h in that list explicitly.



---

archive/issue_comments_396715.json:
```json
{
    "body": "Sorry--pressed submit without seeing you had added to this.  Maybe you were going to change something?\n\nNevertheless, the problem is still more general than png.h.  It would be better not to use `SAGE_INC` in this way (e.g. the same problem applies for m4ri, I just don't have a system package for that yet).",
    "created_at": "2019-08-14T08:43:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28112#issuecomment-396715",
    "user": "https://github.com/embray"
}
```

Sorry--pressed submit without seeing you had added to this.  Maybe you were going to change something?

Nevertheless, the problem is still more general than png.h.  It would be better not to use `SAGE_INC` in this way (e.g. the same problem applies for m4ri, I just don't have a system package for that yet).



---

archive/issue_comments_396716.json:
```json
{
    "body": "\n```\n+from sage.env import SAGE_LOCAL, SAGE_INC\n```\n\nwould surely be inconvenient for distributions that don't use `sage.env`.",
    "created_at": "2019-08-14T08:45:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28112#issuecomment-396716",
    "user": "https://github.com/dimpase"
}
```


```
+from sage.env import SAGE_LOCAL, SAGE_INC
```

would surely be inconvenient for distributions that don't use `sage.env`.



---

archive/issue_comments_396717.json:
```json
{
    "body": "Apparently in the `depends = ['png.h]` traces back to #5265, and didn't really make sense then either.  When vector_mod2_dense was added it was just carried over as cargo cult.\n----\nNew commits:",
    "created_at": "2019-08-14T08:49:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28112#issuecomment-396717",
    "user": "https://github.com/embray"
}
```

Apparently in the `depends = ['png.h]` traces back to #5265, and didn't really make sense then either.  When vector_mod2_dense was added it was just carried over as cargo cult.
----
New commits:



---

archive/issue_comments_396718.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-08-14T08:50:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28112#issuecomment-396718",
    "user": "https://github.com/jdemeyer"
}
```

New commits:



---

archive/issue_comments_396719.json:
```json
{
    "body": "Heh, perhaps we can merge these two fixes?  I think Jeroen's branch makes sense in its own right.",
    "created_at": "2019-08-14T08:51:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28112#issuecomment-396719",
    "user": "https://github.com/embray"
}
```

Heh, perhaps we can merge these two fixes?  I think Jeroen's branch makes sense in its own right.



---

archive/issue_comments_396720.json:
```json
{
    "body": "I created #28352 with my fix.",
    "created_at": "2019-08-14T08:51:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28112#issuecomment-396720",
    "user": "https://github.com/jdemeyer"
}
```

I created #28352 with my fix.



---

archive/issue_comments_396721.json:
```json
{
    "body": "Replying to [comment:6 embray]:\n> It does depend indirectly through gd.h, which it does depend on directly.\n\nMy `gd.h` does not depend on `png.h`",
    "created_at": "2019-08-14T08:52:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28112#issuecomment-396721",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:6 embray]:
> It does depend indirectly through gd.h, which it does depend on directly.

My `gd.h` does not depend on `png.h`



---

archive/issue_comments_396722.json:
```json
{
    "body": "The `gd` library does depend on the `png` library, but that's independent of the header files.",
    "created_at": "2019-08-14T08:53:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28112#issuecomment-396722",
    "user": "https://github.com/jdemeyer"
}
```

The `gd` library does depend on the `png` library, but that's independent of the header files.



---

archive/issue_comments_396723.json:
```json
{
    "body": "Replying to [comment:8 dimpase]:\n> {{{\n> +from sage.env import SAGE_LOCAL, SAGE_INC\n> }}}\n> would surely be inconvenient for distributions that don't use `sage.env`.\n\nSome of us are phasing out `sage-env` but we do love `sage.env`.",
    "created_at": "2019-08-14T09:20:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28112#issuecomment-396723",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:8 dimpase]:
> {{{
> +from sage.env import SAGE_LOCAL, SAGE_INC
> }}}
> would surely be inconvenient for distributions that don't use `sage.env`.

Some of us are phasing out `sage-env` but we do love `sage.env`.



---

archive/issue_comments_396724.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2019-12-30T14:48:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28112#issuecomment-396724",
    "user": "https://github.com/embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_396725.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-04-27T23:55:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28112#issuecomment-396725",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_396726.json:
```json
{
    "body": "If I'm not mistaken, this was fixed by #28352?",
    "created_at": "2020-04-27T23:55:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28112#issuecomment-396726",
    "user": "https://github.com/mkoeppe"
}
```

If I'm not mistaken, this was fixed by #28352?



---

archive/issue_comments_396727.json:
```json
{
    "body": "this one has been fixed, but similar problems pop up elsewhere, e.g. I saw similar parasite rebuilds with\nthe branch of #29369 (currently disabled) - apparently \n\n```\n    Extension('sage.rings.polynomial.pbori',\n              sources = ['sage/rings/polynomial/pbori.pyx'],\n              libraries=['brial', 'brial_groebner'] + m4ri_libs + png_libs,\n              library_dirs = m4ri_library_dirs + png_library_dirs,\n              include_dirs = m4ri_include_dirs + png_include_dirs,\n              depends = [SAGE_INC + \"/polybori/\" + hd + \".h\" for hd in [\"polybori\", \"config\"]],\n              extra_compile_args = m4ri_extra_compile_args),\n```\n\nis to blame",
    "created_at": "2020-04-28T02:46:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28112#issuecomment-396727",
    "user": "https://github.com/dimpase"
}
```

this one has been fixed, but similar problems pop up elsewhere, e.g. I saw similar parasite rebuilds with
the branch of #29369 (currently disabled) - apparently 

```
    Extension('sage.rings.polynomial.pbori',
              sources = ['sage/rings/polynomial/pbori.pyx'],
              libraries=['brial', 'brial_groebner'] + m4ri_libs + png_libs,
              library_dirs = m4ri_library_dirs + png_library_dirs,
              include_dirs = m4ri_include_dirs + png_include_dirs,
              depends = [SAGE_INC + "/polybori/" + hd + ".h" for hd in ["polybori", "config"]],
              extra_compile_args = m4ri_extra_compile_args),
```

is to blame



---

archive/issue_comments_396728.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-04-28T02:49:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28112#issuecomment-396728",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_026054.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2020-06-04T18:50:11Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28112",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28112#event-26054"
}
```



---

archive/issue_comments_396729.json:
```json
{
    "body": "Resolution: duplicate",
    "created_at": "2020-06-04T18:50:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28112#issuecomment-396729",
    "user": "https://github.com/fchapoton"
}
```

Resolution: duplicate
