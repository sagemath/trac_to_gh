# Issue 21458: fix import of numpy import_array in sage/finance/time_series.pyx

Issue created by migration from https://trac.sagemath.org/ticket/21695

Original creator: fbissey

Original creation time: 2016-10-13 09:40:45

Clang rejects the following in `sage/finance/time_series.pyx`

```
[sagelib-7.4.rc0] [  1/386] clang -fno-strict-aliasing -I/Users/fbissey/build/sage/local/var/tmp/sage/build/python2-2.7.10.p2/include -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -I/Users/fbissey/build/sage/local/lib/python2.7/site-packages/cysignals -I/Users/fbissey/build/sage/local/include -I/Users/fbissey/build/sage/local/include/python2.7 -I/Users/fbissey/build/sage/local/lib/python2.7/site-packages/numpy/core/include -I/Users/fbissey/build/sage/src -I/Users/fbissey/build/sage/src/sage/ext -I/Users/fbissey/build/sage/src/build/cythonized -I/Users/fbissey/build/sage/src/build/cythonized/sage/ext -I/Users/fbissey/build/sage/local/include/python2.7 -c /Users/fbissey/build/sage/src/build/cythonized/sage/finance/time_series.c -o build/temp.macosx-10.9-x86_64-2.7/Users/fbissey/build/sage/src/build/cythonized/sage/finance/time_series.o -fno-strict-aliasing
[sagelib-7.4.rc0] In file included from /Users/fbissey/build/sage/src/build/cythonized/sage/finance/time_series.c:317:
[sagelib-7.4.rc0] In file included from /Users/fbissey/build/sage/local/lib/python2.7/site-packages/numpy/core/include/numpy/arrayobject.h:4:
[sagelib-7.4.rc0] In file included from /Users/fbissey/build/sage/local/lib/python2.7/site-packages/numpy/core/include/numpy/ndarrayobject.h:18:
[sagelib-7.4.rc0] In file included from /Users/fbissey/build/sage/local/lib/python2.7/site-packages/numpy/core/include/numpy/ndarraytypes.h:1777:
[sagelib-7.4.rc0] /Users/fbissey/build/sage/local/lib/python2.7/site-packages/numpy/core/include/numpy/npy_1_7_deprecated_api.h:15:2: warning: "Using deprecated NumPy API, disable it by "          "#defining NPY_NO_DEPRECATED_API NPY_1_7_API_VERSION" [-W#warnings]
[sagelib-7.4.rc0] #warning "Using deprecated NumPy API, disable it by " \
[sagelib-7.4.rc0]  ^
[sagelib-7.4.rc0] /Users/fbissey/build/sage/src/build/cythonized/sage/finance/time_series.c:15252:3: error: non-void function '__pyx_pf_4sage_7finance_11time_series_10TimeSeries_106numpy' should return a value [-Wreturn-type]
[sagelib-7.4.rc0]   import_array();
[sagelib-7.4.rc0]   ^
[sagelib-7.4.rc0] /Users/fbissey/build/sage/local/lib/python2.7/site-packages/numpy/core/include/numpy/__multiarray_api.h:1532:144: note: expanded from macro 'import_array'
[sagelib-7.4.rc0] #define import_array() {if (_import_array() < 0) {PyErr_Print(); PyErr_SetString(PyExc_ImportError, "numpy.core.multiarray failed to import"); return NUMPY_IMPORT_ARRAY_RETVAL; } }
[sagelib-7.4.rc0]                                                                                                                                                ^
[sagelib-7.4.rc0] 1 warning and 1 error generated.
```

This is because because `import_array` needs to be called from a function of type void. In cython code that only happens when called from the top of the `pxy` file not from a `cdef`ining function.


---

Comment by fbissey created at 2016-10-13 09:53:20

New commits:


---

Comment by fbissey created at 2016-10-13 09:53:20

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2016-10-13 12:30:19

Changing component from porting to cython.


---

Comment by jdemeyer created at 2016-10-13 12:30:19

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2016-10-13 12:30:19

I don't quite understand the problem here. Why would something "need to be called from a function of type void"? What does that even mean?


---

Comment by jdemeyer created at 2016-10-13 12:35:40

Also, is this something that would need to be reported upstream to either `cython` or `numpy`?


---

Comment by jdemeyer created at 2016-10-13 13:31:40

OK, I am looking at this. It seems to me that this should be fixed upstream in Cython.


---

Comment by jdemeyer created at 2016-10-13 13:46:51

Changing status from needs_info to needs_work.


---

Comment by jdemeyer created at 2016-10-13 13:46:51

I don't think that `import_array()` is meant to used the way we are using it.


---

Comment by jdemeyer created at 2016-10-13 14:59:07

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2016-10-13 14:59:07

I think this is a much more structural fix.
----
New commits:


---

Comment by fbissey created at 2016-10-13 18:56:43

OK I was basing my conclusion from the fact that `import_array`  is defined in numpy by

```
#if PY_VERSION_HEX >= 0x03000000
#define NUMPY_IMPORT_ARRAY_RETVAL NULL
#else
#define NUMPY_IMPORT_ARRAY_RETVAL
#endif

#define import_array() {if (_import_array() < 0) {PyErr_Print(); PyErr_SetString(PyExc_ImportError, "numpy.core.multiarray failed to import"); return NUMPY_IMPORT_ARRAY_RETVAL; } }
```

which means that in `python2.7` in case of exception you will get `return ;` without any values which clang doesn't like. Of course if you can fix it in cython, I am all for it. There are two other places in sage that does use `import_array` and they do the way of my initial patch and it compiled. So, I guess I was being practical about it.


---

Comment by fbissey created at 2016-10-13 21:03:46

Works beautifully. Thanks Jeroen, hopefully upstream cython will accept it.


---

Comment by fbissey created at 2016-10-13 21:03:46

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2016-10-18 07:41:54

Given that Cython is planning a release of 0.25 very soon, I would rather just upgrade: #20596.


---

Comment by fbissey created at 2016-10-18 07:43:55

Fine so long as it is part of 0.25. I am still wondering about the mysterious pynac stuff anyway.


---

Comment by jdemeyer created at 2016-10-18 07:56:30

Replying to [comment:13 fbissey]:
> Fine so long as it is part of 0.25.

The patch is in Cython 0.25b1


---

Comment by vbraun created at 2017-01-21 18:03:11

Resolution: invalid
