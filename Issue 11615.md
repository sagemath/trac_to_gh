# Issue 11615: empty graphics objects

Issue created by migration from https://trac.sagemath.org/ticket/11787

Original creator: jason

Original creation time: 2011-09-11 03:04:54

Assignee: jason, was

CC:  kcrisman ppurka

#7570 should have been implemented by doing a len()==0 test, rather than a direct comparison to empty lists/dicts/etc.  That allows things like numpy arrays, etc.

I guess technically, numpy arrays aren't documented as being supported by list_plot, for example, so this might technically be an enhancement.


---

Comment by jason created at 2011-09-11 03:07:45

S


---

Comment by ppurka created at 2012-11-23 13:41:28

Changing status from new to needs_review.


---

Comment by ppurka created at 2012-11-23 13:41:28

Added patch to use numpy arrays. I am not happy with having to use len() but I don't know of a better way or non-ugly way to _not_ traverse the whole list of input data. Hopefully, the impact to the running time is not too high for large input lists or tuples.

The alternative to checking `len(data) == 0` was something like the following (let's say we are calling `list_plot(data)`):

```python
import collections
if not isinstance(data, collections.Iterable):
    raise TypeError
if isinstance(data, dict) and not data:
    return Graphics()
if not isinstance(data, dict): # check that data is not a dict, to avoid KeyError
    try:
        a = data[0]
    except IndexError: # this means we have an iterable with no items
        return Graphics()
```


If you would like me to patch up with this ugly kludge of a code instead of the simple `len(data) == 0`, then let me know - I will put up a new patch. :)

_EDIT:_ forgot to check for dict before `try`.


---

Comment by lftabera created at 2013-03-07 19:01:58

This will not work, the elements of the array might be arrays


```
sage: var('x,y')
(x, y)
sage: x1=y  
sage: y1=-x
sage: A=desolve_odeint([x1,y1],[-0.5,0.3],srange(0,1,0.01),[x,y])
sage: list_plot(A,plotjoined=True)
TypeError                                 Traceback (most recent call last)
...
TypeError: unable to coerce to a ComplexNumber: <type 'numpy.ndarray'>
```


Th erecommended way for lists tuples etc. would have been


```
if not data:
   return Grpahics()
}}

But this does not work with ndarrays. len is O(1) for these types.


---

Comment by ppurka created at 2013-03-08 12:12:00

Changing status from needs_review to needs_work.


---

Comment by ppurka created at 2013-03-08 12:12:00

`@`lftabera Thanks for looking into this. I will put up an updated patch to take care of ndarrays.


---

Comment by ppurka created at 2013-03-09 11:31:17

Apply to devel/sage


---

Comment by ppurka created at 2013-03-09 11:35:58

Changing status from needs_work to needs_review.


---

Attachment

Updated the patch to take care of ndarrays of ndarrays, or even lists of ndarrays. The following are the tests on a corei5 `@` 2.5GHz.

There is probably a very minor but insignificant slowdown. The tests of plot.py without this patch takes 220.4s and with this patch takes 223.3s, i.e., 3 seconds more. Given that two more plots are introduced in the doctest, I believe there is no perceptible slowdown to the `list_plot` code.

```
...sage-5.8.beta4/devel/sage» ../../sage -t -long sage/plot/plot.py  ## WITH PATCH
sage -t -long "devel/sage-main/sage/plot/plot.py"
	 [223.3 s]
 
----------------------------------------------------------------------
All tests passed!
Total time for all tests: 223.4 seconds
...sage-5.8.beta4/devel/sage» hg qser
trac_10508_doctest.patch
trac_10508_update_atlas_docs.patch
trac_11787-allow_numpy_arrays.patch
...sage-5.8.beta4/devel/sage» hg qpop trac_10508_update_atlas_docs.patch
abort: local changes found, refresh first
...8.beta4/devel/sage [255] » hg qref
...sage-5.8.beta4/devel/sage» hg qpop trac_10508_update_atlas_docs.patch
popping trac_11787-allow_numpy_arrays.patch
now at: trac_10508_update_atlas_docs.patch
...sage-5.8.beta4/devel/sage» ../../sage -b >& /dev/null 
...sage-5.8.beta4/devel/sage» ../../sage -t -long sage/plot/plot.py   ## WITHOUT PATCH
sage -t -long "devel/sage-main/sage/plot/plot.py"
	 [220.4 s]
 
----------------------------------------------------------------------
All tests passed!
Total time for all tests: 220.4 seconds
```



---

Comment by lftabera created at 2013-03-26 15:25:01

Changing status from needs_review to needs_work.


---

Comment by lftabera created at 2013-03-26 15:25:01

The following test now provides an empty graphics

list_plot([1, I, pi + I/2, CC(.25, .25)])

I would try to avoid, if possible, the import of ndarray and testing for lists, tuples etc. It seems that line and plot can deal with ndarrays and ndarrays of ndarrays without problem.


---

Comment by ppurka created at 2013-03-26 16:17:33

Replying to [comment:8 lftabera]:
> The following test now provides an empty graphics
> 
> list_plot([1, I, pi + I/2, CC(.25, .25)])

Yikes! I learn something new everyday. I tried to avoid creating yet another list internally in the function by using `enumerate`. But this is an iterator and it runs through to the end of the list on one of the calls to `line` or `point`. And then if an exception is raised from those functions, then the list appears empty while trying the CC plots.

> 
> I would try to avoid, if possible, the import of ndarray and testing for lists, tuples etc. It seems that line and plot can deal with ndarrays and ndarrays of ndarrays without problem.

Indeed line and point can handle ndarrays. But the main problem is to detect when an empty array is passed in. Both those functions can not handle an empty numpy array. All this error checking was just to handle empty arrays :-|

```
sage: line(np.array([]))
...
ValueError: there must be at least 2 points

sage: line([])  # this is fine
sage: point([]) # this is fine

sage: point(np.array([]))
...
AttributeError: 'int' object has no attribute '_set_extra_kwds'
```



---

Comment by ppurka created at 2013-03-26 16:25:14

Oh I see what you mean. I should remove the checks for numpy. You have raised some very good points.


---

Comment by ppurka created at 2013-04-19 16:02:37

Hello, I finally got some time to look at this ticket again. This time it doesn't import numpy and the main changes are in the functions line and point, along with their 3D versions.

It passes all doctests in sage/plot. Unfortunately, patchbot is down now. :(

Patchbot apply trac_11787-allow_numpy_arrays.2.patch


---

Comment by ppurka created at 2013-04-19 16:02:37

Changing status from needs_work to needs_review.


---

Comment by lftabera created at 2013-05-10 08:09:25

Changing status from needs_review to needs_work.


---

Comment by lftabera created at 2013-05-10 08:09:25

doctest fails on sage/schemes/elliptic_curves/heegner.py using sage 5.10.beta2, please check that your code is correct of if there is a bug in the mentioned file.


---

Comment by ppurka created at 2013-05-10 08:29:07

It seems to be an undocumented "feature" of the `point` function. Strictly speaking, the point function has no direct support for plotting a complex number. This is what the `heegner` function does - it passes a complex number to point. Surprising that it worked all these years.


---

Attachment

Apply after previous file.


---

Comment by ppurka created at 2013-05-10 08:50:15

Added a patch to heegner.

Patchbot apply trac_11787-allow_numpy_arrays.2.patch trac_11787-heegner.patch


---

Comment by ppurka created at 2013-05-10 08:50:15

Changing status from needs_work to needs_review.


---

Comment by lftabera created at 2013-05-10 09:37:27

I do not convinced with this solution. While it is not documented, it is a nice side feature that CDF can be ploted. I have the gut that there should be another solution. The problem here is with ndarray not behaving as nice python objects. 

One idea is to check first if data is a dictionary and, if not, just simply perform data=list(data). This would simplify the code a lot.


---

Comment by lftabera created at 2013-05-10 09:39:02

Changing status from needs_review to needs_info.


---

Comment by ppurka created at 2013-05-10 10:00:04

I don't understand. This bug has nothing to do with numpy. It is using a misfeature and unintended use of points. There are other places in the heegner file where complex points are plotted correctly by using the proper conversion to a tuple containing the real part and the imaginary part separately.


---

Comment by lftabera created at 2013-05-10 10:19:46

I do not agree, if point2d expect lists, it should work with objects that can be interpreted as lists. We should not asks the user to pass strictly lists to the method. http://en.wikipedia.org/wiki/Duck_typing

In my opinion, line 377 of sage/plot/point.py should read:

`if not points:`

And line 2848 of heegner should read

`return point([CDF(self.tau())], **kwds)`

or maybe

`return point(list(CDF(self.tau())), **kwds)`

In order not to fail on CDF(0.0)


---

Comment by ppurka created at 2013-05-10 10:32:58

That's not correct. point2d can be passed any iterable that consists of a tuple or list of two coordinates. There is only one exception where you can pass a single tuple or a single list consisting of two coordinates.


---

Comment by lftabera created at 2013-05-10 10:53:55

Well, as point2d has incomplete documentation, it does not specify its input and this is argueable. 

From the python style guide www.python.org/dev/peps/pep-0008


```
For sequences, (strings, lists, tuples), use the fact that empty sequences are false.

Yes: if not seq:
     if seq:

No: if len(seq)
    if not len(seq)
```



---

Comment by ppurka created at 2013-05-10 11:03:32

Replying to [comment:20 lftabera]:
> {{{
> For sequences, (strings, lists, tuples), use the fact that empty sequences are false.
> 
> Yes: if not seq:
>      if seq:
> 
> No: if len(seq)
>     if not len(seq)
> }}}

This thing doesn't work with numpy arrays. That's why I am using `len` and that's why I had to write the ugly patch earlier.

The documentation of point2d is clear enough with regard to its input:

```
Point takes either a single tuple of coordinates or a list of tuples.
```

But the way the function is written you can pass it either a list of tuples/list or a tuple of tuples/list, or with this patch a numpy array.

EDIT: I wrote in comment:19 that point2d takes any iterable. This is incorrect. It takes in any list or tuple only.


---

Comment by kcrisman created at 2013-05-10 13:07:02

Just FYI, #8082 added correct plotting of complex points.  Perhaps the input documentation needs to be updated, but there is an example in the documentation of it being used.  Note also #9982 and #4838.


---

Comment by ppurka created at 2013-05-10 16:56:18

Replying to [comment:22 kcrisman]:
> Just FYI, #8082 added correct plotting of complex points.  Perhaps the input documentation needs to be updated, but there is an example in the documentation of it being used.  Note also #9982 and #4838.
Unfortunately, neither #8082 nor #4348 adds any documentation about plotting complex numbers directly via points. Plotting them via `plot` or `list_plot` is of course well documented.

<Edited out>

Since the patch here does not break the code which deals with more than one instance of complex numbers, I suggest that we proceed with the patches here and deal with complex numbers in `point` or `line` in #9982. The following _undocumented_ behavior is broken with this ticket

```
point(CC(I))
```

but the following works

```
point([CC(I)])
point([CC(I), CC(1)])
```



---

Comment by ppurka created at 2013-05-13 11:19:57

I think I must have been very tired the other day to write that `xydata_from_point_list` was "incomplete". The output is just fine. `:-S`.

I will check if the behaviour of `point(CC(I))` can be fixed easily; otherwise I would like to postpone fixing that and the documentation of `point` to #9982.


---

Comment by ppurka created at 2013-05-24 09:52:08

Changing status from needs_info to needs_review.


---

Comment by ppurka created at 2013-05-24 09:52:08

I updated the numpy patch to take care of complex numbers. It works in the cases where it used to work. See #9982 for the cases where it doesn't work.

Patchbot apply trac_11787-allow_numpy_arrays.2.patch

_Edit:_
1. for reviewing, the diff between the previous and this numpy patch can be [seen here](https://github.com/ppurka/sage-patches/commit/eb0e8ecb81deff15735d656f2c73fc83d3e8c45b).
2. the heegner patch is not needed any more.


---

Comment by ppurka created at 2013-05-24 11:40:04

Updated to remove all use of len()


---

Attachment

I removed the final use of len(). The diff to previous upload can be [seen here](https://github.com/ppurka/sage-patches/commit/e81459e3905962931e7b45b2880d176ad3094cf2).


---

Comment by lftabera created at 2013-12-21 12:07:01

Code looks good to me, does not import numpy by default, works on the examples I have tried, doc looks good. 

There are still some rough edges with line/plot but nothing to do with this ticket.


---

Comment by lftabera created at 2013-12-21 12:07:01

Changing status from needs_review to positive_review.


---

Comment by git created at 2013-12-21 12:07:39

Changing status from positive_review to needs_review.


---

Comment by git created at 2013-12-21 12:07:39

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by lftabera created at 2013-12-21 12:09:10

Changing status from needs_review to positive_review.


---

Comment by ppurka created at 2013-12-21 13:28:40

Replying to [comment:28 lftabera]:
> Code looks good to me, does not import numpy by default, works on the examples I have tried, doc looks good. 

Thanks for the review and for converting it to a git commit!

> There are still some rough edges with line/plot but nothing to do with this ticket.

Can you open a ticket with the bad examples that you have?


---

Comment by vbraun created at 2013-12-21 18:43:51

Resolution: fixed


---

Comment by kcrisman created at 2014-05-28 00:09:54

See #16378 for a problem this seems to have caused.
