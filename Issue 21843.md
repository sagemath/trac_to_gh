# Issue 21843: Refactoring of sage_setup.docbuild

Issue created by migration from https://trac.sagemath.org/ticket/22080

Original creator: embray

Original creation time: 2016-12-20 14:33:48

CC:  jhpalmieri

Keywords: docbuild

I found it possibly desirable to split up the `sage_setup.docbuild.__init__` module a bit, as it was getting a bit long and difficult to reason about.  As to exactly what was moved where, this is highly subjective and open to debate.  But I do think that overall this makes the code easier to understand.

I had a couple additional motivations for this:

It is with an eye toward #6389.  I think organizing the code more clearly will make it easier to implement this--in fact I don't think there's a lot left to do except to replace every reference to `SAGE_DOC_SRC` with a reference to a source directory option.  #21732 may play a role here as well.

Speaking of #21732, I have some ideas for how to use this to further reduce runtime dependency on sage_setup.


---

Comment by embray created at 2016-12-20 14:33:58

Changing status from new to needs_review.


---

Comment by embray created at 2016-12-20 14:49:00

There are a few more changes I need to add after actually testing this for use with #21732


---

Comment by embray created at 2016-12-20 14:49:00

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-12-21 15:15:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2016-12-21 15:15:52

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-01-04 12:27:27

According to the patchbot, the documentation doesn't actually build with this patch.


---

Comment by jdemeyer created at 2017-01-04 12:27:27

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-01-04 12:30:37

Question: is this patch supposed to make any functional changes or is it really just a reorganisation?


---

Comment by embray created at 2017-01-04 13:43:10

Hmm, the error I see in the buildbot is:


```
cd ../.. && sage-logger -p './sage --docbuild --no-pdf-links all html ' logs/dochtml.log
[dochtml] 
[dochtml] Building reference manual, first pass.
[dochtml] 
[dochtml] Error building the documentation.
[dochtml] Traceback (most recent call last):
[dochtml]   File "/home/vdelecro/sage_patchbot/local/lib/python/runpy.py", line 174, in _run_module_as_main
[dochtml]     "__main__", fname, loader, pkg_name)
[dochtml]   File "/home/vdelecro/sage_patchbot/local/lib/python/runpy.py", line 72, in _run_code
[dochtml]     exec code in run_globals
[dochtml]   File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage_setup/docbuild/__main__.py", line 2, in <module>
[dochtml]     main()
[dochtml]   File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage_setup/docbuild/main.py", line 274, in main
[dochtml]     builder()
[dochtml]   File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage_setup/docbuild/builders/__init__.py", line 115, in _wrapper
[dochtml]     getattr(get_builder(document), 'inventory')(*args, **kwds)
[dochtml]   File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage_setup/docbuild/builders/reference.py", line 105, in _wrapper
[dochtml]     build_many(self._build_ref_doc, L)
[dochtml]   File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage_setup/docbuild/builders/__init__.py", line 182, in build_many
[dochtml]     ret = x.get(99999)
[dochtml]   File "/home/vdelecro/sage_patchbot/local/lib/python/multiprocessing/pool.py", line 567, in get
[dochtml]     raise self._value
[dochtml] PicklingError: Can't pickle <type 'function'>: attribute lookup __builtin__.function failed
Makefile:1121: recipe for target 'doc-html' failed
make[1]: *** [doc-html] Error 1
```


I don't remember ever getting anything like that in testing, but I'll have to try it again.  It's possible I made some other minor changes after testing and then forgot to re-test.  I don't remember.

Anyways, to answer your question yes this is just a reorganization and does not (modulo bugs) make any changes in functionality.


---

Comment by jdemeyer created at 2017-01-05 13:37:45

Replying to [comment:7 embray]:
> `[dochtml] PicklingError: Can't pickle <type 'function'>: attribute lookup __builtin__.function failed`

This is almost certainly due to docbuilding in parallel. Remember that single-process and multi-process docbuilding now take a different code path.


---

Comment by embray created at 2017-01-06 12:47:43

Right, that could be why I did't get it.  Though I thought docbuilding was in parallel by default.  I was testing this on Linux too.  Oh well, no matter.  It's a simple fix.


---

Comment by jdemeyer created at 2017-01-06 13:23:43

Replying to [comment:9 embray]:
> Though I thought docbuilding was in parallel by default.

No, it's serial by default. But the patchbots all build in parallel.


---

Comment by embray created at 2017-01-06 13:32:30

Ah, okay. That explains it then.


---

Comment by git created at 2017-05-19 10:35:09

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2017-05-19 10:35:50

Rebased (incorporating updates to `sage_setup.docbuild` since the last version of this), and fixed the remaining issues as far as I can tell.


---

Comment by embray created at 2017-05-19 10:35:56

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-05-22 09:23:36

1. Why this?

```
try:
    from sage.interfaces.gap import set_gap_memory_pool_size
    set_gap_memory_pool_size(80 * 1024 * 1024)
except ImportError:
    pass
```

If you really want this to work without Sage, I would prefer to see

```
try:
    import sage
except ImportError:
    pass
else:
    from sage.interfaces.gap import set_gap_memory_pool_size
    set_gap_memory_pool_size(80 * 1024 * 1024)
```


2. All functions in `src/sage_setup/docbuild/__init__.py` lack doctests. I know that the original functions didn't have doctests either, but since you changed the implementation, I think it's valid to ask for doctests. For `get_builder()`, it would be very good to have examples for various cases: just from reading the docstring, it's not totally clear what it does.

3. In `get_builder`, can you use the `traceback` module to format the exceptions?


---

Comment by embray created at 2017-05-22 09:34:15

For 1), it's possible `import sage` works, but it's not fully built or fully working.  The point is that this code has to be there when using Sage _for some reason_ that I don't know, but this module should work fine without Sage as well.


---

Comment by jdemeyer created at 2017-05-22 10:05:58

For easier reviewing, I squashed this branch and made it into 2 commits: one which literally just moves code around and one which makes further changes.
----
New commits:


---

Comment by jdemeyer created at 2017-05-22 10:13:39

Replying to [comment:17 embray]:
> For 1), it's possible `import sage` works, but it's not fully built or fully working.

If that's the case, that's a bug and we want to know about it. Hiding a bug inside an `except` statement is not good style.

Do you plan to use the docbuilder outside of Sage? If not, there is no reason for the `try`/`except`.


---

Comment by jdemeyer created at 2017-05-22 10:18:04

`pyflakes` complains about a few things:

```
docbuild/main.py:267: local variable 'C' is assigned to but never used
docbuild/builders/docbuilder.py:111: undefined name 'logger'
docbuild/builders/reference.py:625: undefined name 'SAGE_SRC'
docbuild/builders/singlefile.py:5: 're' imported but unused
```

The undefined names are surely bugs.


---

Comment by jdemeyer created at 2017-05-22 10:35:27

Let me say that I honestly want to move forward with this ticket. It would a pity to have this ticket stalled again. So even if I disagree with a minor thing, I might accept it anyway.


---

Comment by embray created at 2017-05-22 12:07:44

Replying to [comment:20 jdemeyer]:
> Replying to [comment:17 embray]:
> > For 1), it's possible `import sage` works, but it's not fully built or fully working.
> 
> If that's the case, that's a bug and we want to know about it. Hiding a bug inside an `except` statement is not good style.

That depends.  It's not necessarily hiding a "bug" in this case.  That said, I don't remember the exact reason it was needed so changing this _might_ be fine.  I just don't see why it matters.

> Do you plan to use the docbuilder outside of Sage? If not, there is no reason for the `try`/`except`.

Yes, that's part of the point of this refactoring, as well as #21732.  I don't _personally_ plan to use it, but it should be made more independent of Sage.


---

Comment by embray created at 2017-05-22 12:09:03

Replying to [comment:22 jdemeyer]:
> Let me say that I honestly want to move forward with this ticket. It would a pity to have this ticket stalled again. So even if I disagree with a minor thing, I might accept it anyway.

That's fine, and I agree with your other comments.  I'm not sure what you want me to do now that you've switched it to your branch though.


---

Comment by jdemeyer created at 2017-05-23 07:57:55

Replying to [comment:24 embray]:
> That's fine, and I agree with your other comments.  I'm not sure what you want me to do now that you've switched it to your branch though.

Preferably, you continue your work on top of my branch.


---

Comment by jdemeyer created at 2017-05-27 10:39:58

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2022-07-09 19:56:38

outdated, should close


---

Comment by mkoeppe created at 2022-07-09 19:56:38

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2022-07-09 22:59:52

Sure.


---

Comment by jhpalmieri created at 2022-07-09 22:59:52

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-08-02 06:31:03

Resolution: invalid
