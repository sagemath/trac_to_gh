# Issue 20927: string formatter for lazy lists and small bug fixes

Issue created by migration from https://trac.sagemath.org/ticket/21164

Original creator: dkrenn

Original creation time: 2016-08-04 07:47:45

CC:  mantepse vdelecroix

This ticket arises from #19895 and implements the following parts:

- Simplify code in `__repr__` and allow customization.

- Minor improvement of documentation

- A couple of smaller bug fixes (correcting/updating the parameter stop when using slices)

- Various smaller code improvements and simplifications.


---

Comment by dkrenn created at 2016-08-04 07:53:49

New commits:


---

Comment by dkrenn created at 2016-08-04 07:53:49

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2016-08-04 19:05:42

Why this change

```diff
-    cdef int update_cache_up_to(self, Py_ssize_t i) except -1
+    cpdef int update_cache_up_to(self, Py_ssize_t i) except -1
```



---

Comment by vdelecroix created at 2016-08-04 19:05:42

Changing status from needs_review to needs_info.


---

Comment by vdelecroix created at 2016-08-04 19:06:50

Changing status from needs_info to needs_work.


---

Comment by vdelecroix created at 2016-08-04 19:06:50

You should put doctests in `str` (testing *all* options).


---

Comment by dkrenn created at 2016-08-05 12:26:24

Replying to [comment:3 vdelecroix]:
> Why this change
> {{{#!diff
> -    cdef int update_cache_up_to(self, Py_ssize_t i) except -1
> +    cpdef int update_cache_up_to(self, Py_ssize_t i) except -1
> }}}

When creating a customized class (inherited from lazy_list) in my projects, then update_cache_up_to is what I override (as I have some other way of getting new values). AFAICS this makes troubles as my code is in pure Python and not Cython, so I need an interface.


---

Comment by git created at 2016-08-05 12:47:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2016-08-05 12:48:37

Changing status from needs_work to needs_review.


---

Comment by dkrenn created at 2016-08-05 12:48:37

Replying to [comment:4 vdelecroix]:
> You should put doctests in `str` (testing *all* options).

Sorry; somehow I forgot :) Now added.


---

Comment by vdelecroix created at 2016-08-05 15:04:09

- The function `update_cache_up_to` was not intended to be a public method. That is, you might want to override it but I do not see the point in actually using it directly. Is there a use case for calling it? Otherwise it might better be `_update_cache_up_to`.

- Why did you changed the following?

```
-        i = self.start + i*self.step
-        if self._fit(i):
+        cdef Py_ssize_t n = self.start + i*self.step
+        if self._fit(n):
```

  If that's just a matter of personal opinion about writing code, then do not change it.

- I do not like the copy in

```
+    elif isinstance(data, lazy_list_generic):
+        l = lazy_list_generic()
+        l.master = data
+        l.cache = data._get_cache_()
```

  why not

```
elif isinstance(data, lazy_list_generic):
    return data
```

  This is the behavior for tuples

```
sage: t = (1,2)
sage: tuple(t) is t
True
```

  And I like this behavior since if you have an attribute `_data` in your object that is supposed to be a lazy list then you just have to do `my_object._data = lazy_list(data)` instead of first checking whether it is already a lazy list with `isinstance`.


---

Comment by vdelecroix created at 2016-08-05 15:04:09

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-08-08 15:01:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2016-08-08 15:05:38

Changing status from needs_work to needs_review.


---

Comment by dkrenn created at 2016-08-08 15:05:38

Replying to [comment:8 vdelecroix]:
> - The function `update_cache_up_to` was not intended to be a public method. That is, you might want to override it but I do not see the point in actually using it directly. Is there a use case for calling it? 

Actually, no, there is no need to call it directly. It's simply about the overriding in Python (vs. Cython).

> Otherwise it might better be `_update_cache_up_to`.

I completely agree that it should be private. Thus, changed.

> - Why did you changed the following?
> {{{
> -        i = self.start + i*self.step
> -        if self._fit(i):
> +        cdef Py_ssize_t n = self.start + i*self.step
> +        if self._fit(n):
> }}}
>   If that's just a matter of personal opinion about writing code, then do not change it.

Initially I thought it improves the readability of the code (which is one of Python's goals). However, looking at the code again, I do not have a strong preference for the original or the changed code. Thus I've reverted this change.

> - I do not like the copy in
> {{{
> +    elif isinstance(data, lazy_list_generic):
> +        l = lazy_list_generic()
> +        l.master = data
> +        l.cache = data._get_cache_()
> }}}
>   why not
> {{{
> elif isinstance(data, lazy_list_generic):
>     return data
> }}}
>   This is the behavior for tuples
> {{{
> sage: t = (1,2)
> sage: tuple(t) is t
> True
> }}}
>   And I like this behavior since if you have an attribute `_data` in your object that is supposed to be a lazy list then you just have to do `my_object._data = lazy_list(data)` instead of first checking whether it is already a lazy list with `isinstance`.

I haven't thought about this before. It is for sure a behavior we'd like to have. Thus happily changed :)

Best

Daniel


---

Comment by vdelecroix created at 2016-08-08 23:26:32

Some more remarks

- In the module documentation, it is written

```
You can also create extension type inheriting from :class:`lazy_list_generic`
```

  but with your modifications, Python class can also inherit from `lazy_list_generic`. It should be updated.

- This example is misleading

```
+    Lazy lists created from each other share their cache::
+
+        sage: C = lazy_list(count())
+        sage: C[4]
+        4
+        sage: D = lazy_list(C)
+        sage: ...
```

  you would better say that the lazy list are unmodified and test something like

```
    sage: C is D
    True
```


- The following change makes things slower

```
-        cdef lazy_list_from_iterator l = lazy_list_from_iterator.__new__(lazy_list_from_iterator)
-        l.cache = self[:]
-        l.start = 0
-        l.stop = PY_SSIZE_T_MAX
-        l.step = 1
-        l.iterator = iter(other)
-        return l
+        return lazy_list_from_iterator(iter(other), cache=self[:])
```

  With your branch

```
sage: ll = lazy_list(count())
sage: l = [0,1,2]
sage: %timeit l + ll
1000000 loops, best of 3: 456 ns per loop
```

  versus on develop

```
sage: %timeit l + ll
1000000 loops, best of 3: 189 ns per loop
```

  (the main reason is that the call to the constructor `__init__` is avoided in the previous version)

- In `str` would be nice to explain what the argument are actually used for... `- ``name`` -- (default: ``'lazy list'``) a string` is pretty cryptic. Though it is quite clear within the example.


---

Comment by vdelecroix created at 2016-08-08 23:26:32

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-08-09 07:44:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2016-08-09 07:46:02

Replying to [comment:11 vdelecroix]:
> - In the module documentation, it is written
> {{{
> You can also create extension type inheriting from :class:`lazy_list_generic`
> }}}
>   but with your modifications, Python class can also inherit from `lazy_list_generic`. It should be updated.

Done.

> - This example is misleading
> {{{
> +    Lazy lists created from each other share their cache::
> +
> +        sage: C = lazy_list(count())
> +        sage: C[4]
> +        4
> +        sage: D = lazy_list(C)
> +        sage: ...
> }}}

Indeed it is.

>   you would better say that the lazy list are unmodified and test something like
> {{{
>     sage: C is D
>     True
> }}}

Example rewritten.

> - The following change makes things slower
> {{{
> -        cdef lazy_list_from_iterator l = lazy_list_from_iterator.__new__(lazy_list_from_iterator)
> -        l.cache = self[:]
> -        l.start = 0
> -        l.stop = PY_SSIZE_T_MAX
> -        l.step = 1
> -        l.iterator = iter(other)
> -        return l
> +        return lazy_list_from_iterator(iter(other), cache=self[:])
> }}}
>   With your branch
> {{{
> sage: ll = lazy_list(count())
> sage: l = [0,1,2]
> sage: %timeit l + ll
> 1000000 loops, best of 3: 456 ns per loop
> }}}
>   versus on develop
> {{{
> sage: %timeit l + ll
> 1000000 loops, best of 3: 189 ns per loop
> }}}
>   (the main reason is that the call to the constructor `__init__` is avoided in the previous version)

I wasn't aware of this at all. If so, I wouldn't have changed it. Reverted.

> - In `str` would be nice to explain what the argument are actually used for... `- ``name`` -- (default: ``'lazy list'``) a string` is pretty cryptic. Though it is quite clear within the example.

Docstring extended.


---

Comment by dkrenn created at 2016-08-09 07:46:02

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2016-08-09 14:01:57

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2016-08-09 14:01:57

All right. Let it go! Thanks.


---

Comment by dkrenn created at 2016-08-10 11:06:46

Replying to [comment:14 vdelecroix]:
> All right. Let it go! Thanks.

Good :)

However, I am working parallely on the implementation of k-regular sequences (no ticket yet; but this was one motivation for this ticket here). I will use our new lazy_list-formatting method there, but it turns out, that this makes some troubles as it is now. Therefore, I propose (on #21200, as this ticket is already positive) to not having a method `str` as we have added it here at this ticket, but rather having a `lazy_list_formatter` as a function outside the class (i.e. unbound).


---

Comment by vbraun created at 2016-08-12 23:34:20


```
sage -t --long src/sage/misc/lazy_list.pyx
**********************************************************************
File "src/sage/misc/lazy_list.pyx", line 922, in sage.misc.lazy_list.lazy_list_generic._update_cache_up_to
Failed example:
    L._info()
Expected:
    cache length 5
    start        2
    stop         9223372036854775807
    step         1
Got:
    cache length 5
    start        2
    stop         2147483647
    step         1
**********************************************************************
File "src/sage/misc/lazy_list.pyx", line 1029, in sage.misc.lazy_list.lazy_list_from_iterator._update_cache_up_to
Failed example:
    L._info()
Expected:
    cache length 5
    start        2
    stop         9223372036854775807
    step         1
Got:
    cache length 5
    start        2
    stop         2147483647
    step         1
**********************************************************************
File "src/sage/misc/lazy_list.pyx", line 1113, in sage.misc.lazy_list.lazy_list_from_function._update_cache_up_to
Failed example:
    L._info()
Expected:
    cache length 5
    start        2
    stop         9223372036854775807
    step         1
Got:
    cache length 5
    start        2
    stop         2147483647
    step         1
**********************************************************************
File "src/sage/misc/lazy_list.pyx", line 1192, in sage.misc.lazy_list.lazy_list_from_update_function._update_cache_up_to
Failed example:
    L._info()
Expected:
    cache length 7
    start        2
    stop         9223372036854775807
    step         1
Got:
    cache length 7
    start        2
    stop         2147483647
    step         1
**********************************************************************
4 items had failures:
   1 of   5 in sage.misc.lazy_list.lazy_list_from_function._update_cache_up_to
   1 of   5 in sage.misc.lazy_list.lazy_list_from_iterator._update_cache_up_to
   1 of   6 in sage.misc.lazy_list.lazy_list_from_update_function._update_cache_up_to
   1 of   5 in sage.misc.lazy_list.lazy_list_generic._update_cache_up_to
    [239 tests, 4 failures, 0.27 s]
```



---

Comment by vbraun created at 2016-08-12 23:34:20

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2016-08-12 23:34:36

(on 32-bit)


---

Comment by git created at 2016-08-16 08:02:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2016-08-16 08:03:42

Changing status from needs_work to needs_review.


---

Comment by dkrenn created at 2016-08-16 08:03:42

Replying to [comment:16 vbraun]:
> {{{
> sage -t --long src/sage/misc/lazy_list.pyx
> **********************************************************************
> File "src/sage/misc/lazy_list.pyx", line 922, in sage.misc.lazy_list.lazy_list_generic._update_cache_up_to
> Failed example:
>     L._info()
> Expected:
>     cache length 5
>     start        2
>     stop         9223372036854775807
>     step         1
> Got:
>     cache length 5
>     start        2
>     stop         2147483647
>     step         1
> [...]
> }}}

Fixed.


---

Comment by vdelecroix created at 2016-08-16 12:59:07

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-08-19 22:45:02

Resolution: fixed
