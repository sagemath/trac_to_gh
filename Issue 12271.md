# Issue 12271: the sage library doesn't respect global CC and CXX flags

archive/issues_012271.json:
```json
{
    "body": "Assignee: GeorgSWeber\n\nNeeded so we can build with clang.\n\nIssue created by migration from https://trac.sagemath.org/ticket/12443\n\n",
    "created_at": "2012-02-04T20:43:35Z",
    "labels": [
        "build",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "the sage library doesn't respect global CC and CXX flags",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12271",
    "user": "@ohanar"
}
```
Assignee: GeorgSWeber

Needed so we can build with clang.

Issue created by migration from https://trac.sagemath.org/ticket/12443





---

archive/issue_comments_144145.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-02-04T20:48:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12271#issuecomment-144145",
    "user": "@ohanar"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_144146.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-02-06T16:09:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12271#issuecomment-144146",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_144147.json:
```json
{
    "body": "This will break if `$CC` includes arguments:\n\n```\ncompilerinclude = Popen([os.environ['CC'], '--print-file-name=include'], stdout=PIPE)\n```\n\n\nWhat's the point of the `use_gnu`, `use_sun` stuff??  What does \"tools\" do anyway?",
    "created_at": "2012-02-06T16:09:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12271#issuecomment-144147",
    "user": "@jdemeyer"
}
```

This will break if `$CC` includes arguments:

```
compilerinclude = Popen([os.environ['CC'], '--print-file-name=include'], stdout=PIPE)
```


What's the point of the `use_gnu`, `use_sun` stuff??  What does "tools" do anyway?



---

archive/issue_comments_144148.json:
```json
{
    "body": "Replying to [comment:2 jdemeyer]:\n> This will break if `$CC` includes arguments:\n\n```\ncompilerinclude = Popen([os.environ['CC'], '--print-file-name=include'], stdout=PIPE)\n```\n\nTrue, thankfully this is a trivial fix if we assume there are no spaces in compiler path.\n> What's the point of the `use_gnu`, `use_sun` stuff??  What does \"tools\" do anyway?\nBy default scons searches the system and to set up its environment, if you specify tools it skips this search and just sets stuff up with the given tools. Currently all this does is speed up the configuring process, but this can be used to make sage respect the CC, CXX, LD, AR,... variables.",
    "created_at": "2012-02-06T21:44:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12271#issuecomment-144148",
    "user": "@ohanar"
}
```

Replying to [comment:2 jdemeyer]:
> This will break if `$CC` includes arguments:

```
compilerinclude = Popen([os.environ['CC'], '--print-file-name=include'], stdout=PIPE)
```

True, thankfully this is a trivial fix if we assume there are no spaces in compiler path.
> What's the point of the `use_gnu`, `use_sun` stuff??  What does "tools" do anyway?
By default scons searches the system and to set up its environment, if you specify tools it skips this search and just sets stuff up with the given tools. Currently all this does is speed up the configuring process, but this can be used to make sage respect the CC, CXX, LD, AR,... variables.



---

archive/issue_comments_144149.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-02-07T00:19:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12271#issuecomment-144149",
    "user": "@ohanar"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_144150.json:
```json
{
    "body": "The SConstruct file doesn't work.  First make a symbolic link \"gplusplus\" to \"g++\".  Then:\n\n```\njdemeyer@arcanis:/usr/local/src/sage-5.0.beta1$ gplusplus --version\ngplusplus (GCC) 4.6.3 20120123 (prerelease)\nCopyright (C) 2011 Free Software Foundation, Inc.\nThis is free software; see the source for copying conditions.  There is NO\nwarranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n\njdemeyer@arcanis:/usr/local/src/sage-5.0.beta1$ CXX=\"gplusplus\" ./sage -b\n\n----------------------------------------------------------\nsage: Building and installing modified Sage library files.\n\n\nInstalling c_lib\nAttributeError: SConsEnvironment instance has no attribute 'SharedLibrary':\n  File \"/usr/local/src/sage-5.0.beta1/devel/sage-main/c_lib/SConstruct\", line 138:\n    lib = env.SharedLibrary( \"csage\", [ \"src/\" + x for x in srcFiles ],\nERROR: There was an error building c_lib.\n\n```\n\n\nSo, I think\n\n```\n# the following two lines should probably be replaced with a better test\n```\n\nshould actually be done.  You should check features, not names of executables.",
    "created_at": "2012-02-13T13:55:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12271#issuecomment-144150",
    "user": "@jdemeyer"
}
```

The SConstruct file doesn't work.  First make a symbolic link "gplusplus" to "g++".  Then:

```
jdemeyer@arcanis:/usr/local/src/sage-5.0.beta1$ gplusplus --version
gplusplus (GCC) 4.6.3 20120123 (prerelease)
Copyright (C) 2011 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

jdemeyer@arcanis:/usr/local/src/sage-5.0.beta1$ CXX="gplusplus" ./sage -b

----------------------------------------------------------
sage: Building and installing modified Sage library files.


Installing c_lib
AttributeError: SConsEnvironment instance has no attribute 'SharedLibrary':
  File "/usr/local/src/sage-5.0.beta1/devel/sage-main/c_lib/SConstruct", line 138:
    lib = env.SharedLibrary( "csage", [ "src/" + x for x in srcFiles ],
ERROR: There was an error building c_lib.

```


So, I think

```
# the following two lines should probably be replaced with a better test
```

should actually be done.  You should check features, not names of executables.



---

archive/issue_comments_144151.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-02-13T13:55:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12271#issuecomment-144151",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_144152.json:
```json
{
    "body": "Ok, I've updated the patch so that it should fix the issue you were having. This ran successfully for me:\n\n```\n$ CC=\"gplusplus -x none\" MAKE=\"make -j8\" ./sage -ba\n```\n\n\nI still don't actually check for suncc since I don't have any (open)solaris system with suncc installed to make a good check, so I just put a guess at what the check might look like.",
    "created_at": "2012-02-22T00:20:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12271#issuecomment-144152",
    "user": "@ohanar"
}
```

Ok, I've updated the patch so that it should fix the issue you were having. This ran successfully for me:

```
$ CC="gplusplus -x none" MAKE="make -j8" ./sage -ba
```


I still don't actually check for suncc since I don't have any (open)solaris system with suncc installed to make a good check, so I just put a guess at what the check might look like.



---

archive/issue_comments_144153.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-02-22T00:20:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12271#issuecomment-144153",
    "user": "@ohanar"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_144154.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-02-22T13:45:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12271#issuecomment-144154",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_144155.json:
```json
{
    "body": "I really don't understand the utter brokenness of this \"tools\" variable.  I should show this to every person who claims that autoconf sucks.\n\nAnyway, `c_lib` still doesn't build with clang:\n\n```\nbsd:sage-5.0.beta4-gcc jdemeyer$ CC=clang ./sage -b\n\n----------------------------------------------------------\nsage: Building and installing modified Sage library files.\n\n\nInstalling c_lib\nscons: *** [libcsage.dylib] Source file: src/convert.c is static and is not compatible with shared target: libcsage.dylib\nERROR: There was an error building c_lib.\n\n```\n",
    "created_at": "2012-02-22T13:45:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12271#issuecomment-144155",
    "user": "@jdemeyer"
}
```

I really don't understand the utter brokenness of this "tools" variable.  I should show this to every person who claims that autoconf sucks.

Anyway, `c_lib` still doesn't build with clang:

```
bsd:sage-5.0.beta4-gcc jdemeyer$ CC=clang ./sage -b

----------------------------------------------------------
sage: Building and installing modified Sage library files.


Installing c_lib
scons: *** [libcsage.dylib] Source file: src/convert.c is static and is not compatible with shared target: libcsage.dylib
ERROR: There was an error building c_lib.

```




---

archive/issue_comments_144156.json:
```json
{
    "body": "The Sun compilers don't understand `--version`.  They do report their version with `-V`.  The output is something like\n\n```\ncc: Sun C 5.9 SunOS_sparc Patch 124867-01 2007/07/12\n```\n\nor\n\n```\nc99: Sun C 5.10 SunOS_i386 2009/06/03\n```\n\n\nSo grepping for \"sunos\" should be fine.",
    "created_at": "2012-02-22T13:54:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12271#issuecomment-144156",
    "user": "@jdemeyer"
}
```

The Sun compilers don't understand `--version`.  They do report their version with `-V`.  The output is something like

```
cc: Sun C 5.9 SunOS_sparc Patch 124867-01 2007/07/12
```

or

```
c99: Sun C 5.10 SunOS_i386 2009/06/03
```


So grepping for "sunos" should be fine.



---

archive/issue_comments_144157.json:
```json
{
    "body": "updated to address issues with earlier version",
    "created_at": "2012-02-22T18:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12271#issuecomment-144157",
    "user": "@ohanar"
}
```

updated to address issues with earlier version



---

archive/issue_comments_144158.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-02-22T18:04:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12271#issuecomment-144158",
    "user": "@ohanar"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_144159.json:
```json
{
    "body": "Attachment [trac12443.patch](tarball://root/attachments/some-uuid/ticket12443/trac12443.patch) by @ohanar created at 2012-02-22 18:04:51\n\nReplying to [comment:8 jdemeyer]:\n> Anyway, `c_lib` still doesn't build with clang\nShould be fixed now, although sage still doesn't build with clang (although I'm fairly confident this is due to other spkgs at this point).\n\nI also threw in something to test for suncc, but I can't test it, so if you can let me know how it works, that would be great.",
    "created_at": "2012-02-22T18:04:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12271#issuecomment-144159",
    "user": "@ohanar"
}
```

Attachment [trac12443.patch](tarball://root/attachments/some-uuid/ticket12443/trac12443.patch) by @ohanar created at 2012-02-22 18:04:51

Replying to [comment:8 jdemeyer]:
> Anyway, `c_lib` still doesn't build with clang
Should be fixed now, although sage still doesn't build with clang (although I'm fairly confident this is due to other spkgs at this point).

I also threw in something to test for suncc, but I can't test it, so if you can let me know how it works, that would be great.



---

archive/issue_comments_144160.json:
```json
{
    "body": "Related, and equally important:\n\nIf `CFLAGS` are set (even to `\"\"`), Python's `CFLAGS` are dropped, which include `-fno-strict-aliasing`, which means that you currently always have to manually add `-fno-strict-aliasing` when setting/modifying `CFLAGS` (and building with GCC), since otherwise invalid code is generated for (at least some) Cython modules.\n\n(`-fstrict-aliasing` in contrast is *enabled* by most of GCC's `O`-levels.)\n\n----\n\nLuckily, if you build Python with `CC` or `CXX` set, the Sage library just picks up these settings, so I personally never had trouble with the main topic of this ticket, while other spkgs (like Lcalc, ratpoints, zn_poly and even Singular!) still suck...",
    "created_at": "2012-03-17T02:01:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12271#issuecomment-144160",
    "user": "@nexttime"
}
```

Related, and equally important:

If `CFLAGS` are set (even to `""`), Python's `CFLAGS` are dropped, which include `-fno-strict-aliasing`, which means that you currently always have to manually add `-fno-strict-aliasing` when setting/modifying `CFLAGS` (and building with GCC), since otherwise invalid code is generated for (at least some) Cython modules.

(`-fstrict-aliasing` in contrast is *enabled* by most of GCC's `O`-levels.)

----

Luckily, if you build Python with `CC` or `CXX` set, the Sage library just picks up these settings, so I personally never had trouble with the main topic of this ticket, while other spkgs (like Lcalc, ratpoints, zn_poly and even Singular!) still suck...



---

archive/issue_comments_144161.json:
```json
{
    "body": "Should we rename the ticket to \"Building c_lib with SCons doesn't respect CC and CXX settings\"? :-P\n\n(And is there anything in Sage besides PolyBoRi that does use SCons, too?)",
    "created_at": "2013-06-03T18:06:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12271#issuecomment-144161",
    "user": "@nexttime"
}
```

Should we rename the ticket to "Building c_lib with SCons doesn't respect CC and CXX settings"? :-P

(And is there anything in Sage besides PolyBoRi that does use SCons, too?)



---

archive/issue_comments_144162.json:
```json
{
    "body": "Replying to [comment:12 leif]:\n> And is there anything in Sage besides PolyBoRi that does use SCons, too?\nAccording to `spkg/standard/deps`, no.\n\nSo we could consider to stop using `SCons` for `c_lib`, since it only adds complications compared to autotools (which respects `CC` and `CXX` out of the box).",
    "created_at": "2013-06-04T09:30:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12271#issuecomment-144162",
    "user": "@jdemeyer"
}
```

Replying to [comment:12 leif]:
> And is there anything in Sage besides PolyBoRi that does use SCons, too?
According to `spkg/standard/deps`, no.

So we could consider to stop using `SCons` for `c_lib`, since it only adds complications compared to autotools (which respects `CC` and `CXX` out of the box).



---

archive/issue_comments_144163.json:
```json
{
    "body": "Replying to [comment:13 jdemeyer]:\n> So we could consider to stop using `SCons` for `c_lib`, since it only adds complications compared to autotools (which respects `CC` and `CXX` out of the box).\n\nI think felix is planning on doing this as part of his gsoc.",
    "created_at": "2013-06-04T19:42:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12271#issuecomment-144163",
    "user": "@ohanar"
}
```

Replying to [comment:13 jdemeyer]:
> So we could consider to stop using `SCons` for `c_lib`, since it only adds complications compared to autotools (which respects `CC` and `CXX` out of the box).

I think felix is planning on doing this as part of his gsoc.



---

archive/issue_comments_144164.json:
```json
{
    "body": "IMHO even a simple Makefile would do better, probably (but not necessarily) also using libtool.",
    "created_at": "2013-06-04T21:59:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12271#issuecomment-144164",
    "user": "@nexttime"
}
```

IMHO even a simple Makefile would do better, probably (but not necessarily) also using libtool.



---

archive/issue_comments_144165.json:
```json
{
    "body": "Replying to [comment:15 leif]:\n> IMHO even a simple Makefile would do better, probably (but not necessarily) also using libtool.\n\n(I.e., the few C and C++ modules could be built with default rules, only creating the shared library from them needs the appropriate platform-specific flags, AFAICS.)",
    "created_at": "2013-06-04T22:03:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12271#issuecomment-144165",
    "user": "@nexttime"
}
```

Replying to [comment:15 leif]:
> IMHO even a simple Makefile would do better, probably (but not necessarily) also using libtool.

(I.e., the few C and C++ modules could be built with default rules, only creating the shared library from them needs the appropriate platform-specific flags, AFAICS.)



---

archive/issue_comments_144166.json:
```json
{
    "body": "Replying to [comment:14 ohanar]:\n> I think felix is planning on doing this as part of his gsoc.\n\nDoesn't seem he already had a trac account...",
    "created_at": "2013-06-04T22:09:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12271#issuecomment-144166",
    "user": "@nexttime"
}
```

Replying to [comment:14 ohanar]:
> I think felix is planning on doing this as part of his gsoc.

Doesn't seem he already had a trac account...



---

archive/issue_comments_144167.json:
```json
{
    "body": "Replying to [comment:15 leif]:\n> IMHO even a simple Makefile would do better, \\[..\\]\nbetter than scons. autotools does more than that. i think VPATH builds, dependency tracking and dist-helpers are absolutely worthwile...",
    "created_at": "2013-06-05T15:52:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12271#issuecomment-144167",
    "user": "felixs"
}
```

Replying to [comment:15 leif]:
> IMHO even a simple Makefile would do better, \[..\]
better than scons. autotools does more than that. i think VPATH builds, dependency tracking and dist-helpers are absolutely worthwile...



---

archive/issue_comments_144168.json:
```json
{
    "body": "ping -c5",
    "created_at": "2014-05-17T22:19:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12271#issuecomment-144168",
    "user": "@nexttime"
}
```

ping -c5



---

archive/issue_comments_144169.json:
```json
{
    "body": "See also #15594",
    "created_at": "2014-05-18T04:22:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12271#issuecomment-144169",
    "user": "@ohanar"
}
```

See also #15594



---

archive/issue_comments_144170.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-06-30T18:30:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12271#issuecomment-144170",
    "user": "@malb"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_144171.json:
```json
{
    "body": "This isn't a git branch",
    "created_at": "2014-06-30T18:30:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12271#issuecomment-144171",
    "user": "@malb"
}
```

This isn't a git branch



---

archive/issue_comments_144172.json:
```json
{
    "body": "Is this still valid?",
    "created_at": "2016-09-17T07:36:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12271#issuecomment-144172",
    "user": "@kiwifb"
}
```

Is this still valid?



---

archive/issue_comments_144173.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2016-10-04T13:22:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12271#issuecomment-144173",
    "user": "@jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_144174.json:
```json
{
    "body": "Sage is built using distutils and distutils supports standard environment variables like `CC`. It does use `CC` instead of `CXX` for compiling C++ files but that is a long-standing upstream issue (it's not the job of Sage to fix that).",
    "created_at": "2016-10-04T13:22:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12271#issuecomment-144174",
    "user": "@jdemeyer"
}
```

Sage is built using distutils and distutils supports standard environment variables like `CC`. It does use `CC` instead of `CXX` for compiling C++ files but that is a long-standing upstream issue (it's not the job of Sage to fix that).



---

archive/issue_comments_144175.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2017-01-21T18:03:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12271",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12271#issuecomment-144175",
    "user": "@vbraun"
}
```

Resolution: invalid
