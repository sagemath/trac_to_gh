# Issue 12271: the sage library doesn't respect global CC and CXX flags

Issue created by migration from https://trac.sagemath.org/ticket/12443

Original creator: ohanar

Original creation time: 2012-02-04 20:43:35

Assignee: GeorgSWeber

Needed so we can build with clang.


---

Comment by ohanar created at 2012-02-04 20:48:44

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2012-02-06 16:09:05

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-02-06 16:09:05

This will break if `$CC` includes arguments:

```
compilerinclude = Popen([os.environ['CC'], '--print-file-name=include'], stdout=PIPE)
```


What's the point of the `use_gnu`, `use_sun` stuff??  What does "tools" do anyway?


---

Comment by ohanar created at 2012-02-06 21:44:32

Replying to [comment:2 jdemeyer]:
> This will break if `$CC` includes arguments:

```
compilerinclude = Popen([os.environ['CC'], '--print-file-name=include'], stdout=PIPE)
```

True, thankfully this is a trivial fix if we assume there are no spaces in compiler path.
> What's the point of the `use_gnu`, `use_sun` stuff??  What does "tools" do anyway?
By default scons searches the system and to set up its environment, if you specify tools it skips this search and just sets stuff up with the given tools. Currently all this does is speed up the configuring process, but this can be used to make sage respect the CC, CXX, LD, AR,... variables.


---

Comment by ohanar created at 2012-02-07 00:19:29

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2012-02-13 13:55:22

The SConstruct file doesn't work.  First make a symbolic link "gplusplus" to "g++".  Then:

```
jdemeyer@arcanis:/usr/local/src/sage-5.0.beta1$ gplusplus --version
gplusplus (GCC) 4.6.3 20120123 (prerelease)
Copyright (C) 2011 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

jdemeyer@arcanis:/usr/local/src/sage-5.0.beta1$ CXX="gplusplus" ./sage -b

----------------------------------------------------------
sage: Building and installing modified Sage library files.


Installing c_lib
AttributeError: SConsEnvironment instance has no attribute 'SharedLibrary':
  File "/usr/local/src/sage-5.0.beta1/devel/sage-main/c_lib/SConstruct", line 138:
    lib = env.SharedLibrary( "csage", [ "src/" + x for x in srcFiles ],
ERROR: There was an error building c_lib.

```


So, I think

```
# the following two lines should probably be replaced with a better test
```

should actually be done.  You should check features, not names of executables.


---

Comment by jdemeyer created at 2012-02-13 13:55:22

Changing status from needs_review to needs_work.


---

Comment by ohanar created at 2012-02-22 00:20:38

Ok, I've updated the patch so that it should fix the issue you were having. This ran successfully for me:

```
$ CC="gplusplus -x none" MAKE="make -j8" ./sage -ba
```


I still don't actually check for suncc since I don't have any (open)solaris system with suncc installed to make a good check, so I just put a guess at what the check might look like.


---

Comment by ohanar created at 2012-02-22 00:20:38

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2012-02-22 13:45:41

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-02-22 13:45:41

I really don't understand the utter brokenness of this "tools" variable.  I should show this to every person who claims that autoconf sucks.

Anyway, `c_lib` still doesn't build with clang:

```
bsd:sage-5.0.beta4-gcc jdemeyer$ CC=clang ./sage -b

----------------------------------------------------------
sage: Building and installing modified Sage library files.


Installing c_lib
scons: *** [libcsage.dylib] Source file: src/convert.c is static and is not compatible with shared target: libcsage.dylib
ERROR: There was an error building c_lib.

```



---

Comment by jdemeyer created at 2012-02-22 13:54:58

The Sun compilers don't understand `--version`.  They do report their version with `-V`.  The output is something like

```
cc: Sun C 5.9 SunOS_sparc Patch 124867-01 2007/07/12
```

or

```
c99: Sun C 5.10 SunOS_i386 2009/06/03
```


So grepping for "sunos" should be fine.


---

Comment by ohanar created at 2012-02-22 18:02:05

updated to address issues with earlier version


---

Comment by ohanar created at 2012-02-22 18:04:51

Changing status from needs_work to needs_review.


---

Attachment

Replying to [comment:8 jdemeyer]:
> Anyway, `c_lib` still doesn't build with clang
Should be fixed now, although sage still doesn't build with clang (although I'm fairly confident this is due to other spkgs at this point).

I also threw in something to test for suncc, but I can't test it, so if you can let me know how it works, that would be great.


---

Comment by leif created at 2012-03-17 02:01:46

Related, and equally important:

If `CFLAGS` are set (even to `""`), Python's `CFLAGS` are dropped, which include `-fno-strict-aliasing`, which means that you currently always have to manually add `-fno-strict-aliasing` when setting/modifying `CFLAGS` (and building with GCC), since otherwise invalid code is generated for (at least some) Cython modules.

(`-fstrict-aliasing` in contrast is _enabled_ by most of GCC's `O`-levels.)

----

Luckily, if you build Python with `CC` or `CXX` set, the Sage library just picks up these settings, so I personally never had trouble with the main topic of this ticket, while other spkgs (like Lcalc, ratpoints, zn_poly and even Singular!) still suck...


---

Comment by leif created at 2013-06-03 18:06:27

Should we rename the ticket to "Building c_lib with SCons doesn't respect CC and CXX settings"? :-P

(And is there anything in Sage besides PolyBoRi that does use SCons, too?)


---

Comment by jdemeyer created at 2013-06-04 09:30:37

Replying to [comment:12 leif]:
> And is there anything in Sage besides PolyBoRi that does use SCons, too?
According to `spkg/standard/deps`, no.

So we could consider to stop using `SCons` for `c_lib`, since it only adds complications compared to autotools (which respects `CC` and `CXX` out of the box).


---

Comment by ohanar created at 2013-06-04 19:42:36

Replying to [comment:13 jdemeyer]:
> So we could consider to stop using `SCons` for `c_lib`, since it only adds complications compared to autotools (which respects `CC` and `CXX` out of the box).

I think felix is planning on doing this as part of his gsoc.


---

Comment by leif created at 2013-06-04 21:59:10

IMHO even a simple Makefile would do better, probably (but not necessarily) also using libtool.


---

Comment by leif created at 2013-06-04 22:03:59

Replying to [comment:15 leif]:
> IMHO even a simple Makefile would do better, probably (but not necessarily) also using libtool.

(I.e., the few C and C++ modules could be built with default rules, only creating the shared library from them needs the appropriate platform-specific flags, AFAICS.)


---

Comment by leif created at 2013-06-04 22:09:25

Replying to [comment:14 ohanar]:
> I think felix is planning on doing this as part of his gsoc.

Doesn't seem he already had a trac account...


---

Comment by felixs created at 2013-06-05 15:52:35

Replying to [comment:15 leif]:
> IMHO even a simple Makefile would do better, \[..\]
better than scons. autotools does more than that. i think VPATH builds, dependency tracking and dist-helpers are absolutely worthwile...


---

Comment by leif created at 2014-05-17 22:19:27

ping -c5


---

Comment by ohanar created at 2014-05-18 04:22:46

See also #15594


---

Comment by malb created at 2014-06-30 18:30:27

Changing status from needs_review to needs_work.


---

Comment by malb created at 2014-06-30 18:30:27

This isn't a git branch


---

Comment by fbissey created at 2016-09-17 07:36:17

Is this still valid?


---

Comment by jdemeyer created at 2016-10-04 13:22:50

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2016-10-04 13:22:50

Sage is built using distutils and distutils supports standard environment variables like `CC`. It does use `CC` instead of `CXX` for compiling C++ files but that is a long-standing upstream issue (it's not the job of Sage to fix that).


---

Comment by vbraun created at 2017-01-21 18:03:11

Resolution: invalid
