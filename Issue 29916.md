# Issue 29916: Repair "sage -b" broken by #29411

Issue created by migration from https://trac.sagemath.org/ticket/30153

Original creator: mkoeppe

Original creation time: 2020-07-16 04:47:30

CC:  jhpalmieri mjo @kliem

(from jhpalmieri, #30123)

Note that sage -b doesn't work any more: it tries to do `cd "$SAGE_SRC" && $MAKE`, but `SAGE_SRC/Makefile.in` was removed in #29411. (If you have done an incremental build, the Makefile is still there.)



---

Comment by mkoeppe created at 2020-07-16 19:31:10

New commits:


---

Comment by mkoeppe created at 2020-07-16 19:31:10

Changing status from new to needs_review.


---

Comment by mjo created at 2020-07-16 19:45:11

Can you base this on #30128 and then source sage-env-config before sage-env in that new Makefile target?


---

Comment by jhpalmieri created at 2020-07-16 20:16:24

- If I touch a `.pyx` file and do `sage -b`, nothing happens: `make: `sagelib-no-deps' is up to date.`
- Same with `sage --ba-force`: nothing happens, even though this is supposed to force rebuilding everything in the Sage library.
- It looks like the logger is invoked, and it didn't used to be. This might be a good change, not sure, but it is a change.
- `git status` reports that the empty file `build/make/sagelib-no-deps` is present and untracked. Does `sagelib-no-deps` need to be added as a phony target, or something like that?


---

Comment by mkoeppe created at 2020-07-16 20:17:59

Replying to [comment:3 mjo]:
> Can you base this on #30128 and then source sage-env-config before sage-env in that new Makefile target?
Sure, will do


---

Comment by mkoeppe created at 2020-07-16 20:18:48

Replying to [comment:4 jhpalmieri]:
> - `git status` reports that the empty file `build/make/sagelib-no-deps` is present and untracked. Does `sagelib-no-deps` need to be added as a phony target, or something like that?
Yes... will fix it


---

Comment by git created at 2020-07-16 20:25:43

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-07-16 20:26:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-16 20:28:34

Replying to [comment:4 jhpalmieri]:
> - If I touch a `.pyx` file and do `sage -b`, nothing happens: `make: `sagelib-no-deps' is up to date.`
> - Same with `sage --ba-force`: nothing happens, even though this is supposed to force rebuilding everything in the Sage library.

This should be fixed now.

> - It looks like the logger is invoked, and it didn't used to be. This might be a good change, not sure, but it is a change.

Yes, it was convenient to go through the Makefile, and I think this change is good as it improves uniformity.


---

Comment by jhpalmieri created at 2020-07-16 22:12:33

I think this works. The first time I got a file `build/make/sagelib-no-deps`, but maybe I forgot to run `./bootstrap`/`.configure`/etc. It's working now.

- Can we add a comment in `Makefile.in` explaining what `$(1)-no-deps` is and how it should be used? I'm guessing that it tries to build the package but ignores its dependencies. Does that have any uses aside from the Sage library? I've made an attempt.

- For pip packages, you have added `$(1)-clean` a second time to the `.PHONY` list. Should there be a `$(1)-uninstall` target for these? In that case, change one `$(1)-clean` to `$(1)-uninstall`.

Could we change the build rules so that

```
$$(INST)/$(1)-$(2)
```

just does `$(1)-build-deps` and `$(1)-no-deps`? It would cut out a tiny bit of code duplication. I guess we can't force the dependencies to be built before the package, so maybe not.


---

Comment by jhpalmieri created at 2020-07-16 22:24:48

By the way, we should deprecate `sage --ba-force`: #30160.
----
New commits:


---

Comment by mkoeppe created at 2020-07-16 22:29:14

Replying to [comment:11 jhpalmieri]:
> - Can we add a comment in `Makefile.in` explaining what `$(1)-no-deps` is and how it should be used? I'm guessing that it tries to build the package but ignores its dependencies. Does that have any uses aside from the Sage library? I've made an attempt.

Thanks very much, this is perfect.

Regarding other uses - we could reimplement `sage -p` in terms of this. I just wasn't sure if we want to do this on the same ticket.

> - For pip packages, you have added `$(1)-clean` a second time to the `.PHONY` list. Should there be a `$(1)-uninstall` target for these? In that case, change one `$(1)-clean` to `$(1)-uninstall`.

Thanks for catching this. I think you fixed it already. For deprecating/renaming `-clean` to `-uninstall`, we have #29097. Probably best not to do everything on one ticket.

> Could we change the build rules so that
> {{{
> $$(INST)/$(1)-$(2)
> }}}
> just does `$(1)-build-deps` and `$(1)-no-deps`? It would cut out a tiny bit of code duplication. I guess we can't force the dependencies to be built before the package, so maybe not.

I don't see an elegant way to do this, unfortunately.


---

Comment by jhpalmieri created at 2020-07-17 20:50:59

This looks okay to me. Positive review on your contributions.


---

Comment by mkoeppe created at 2020-07-17 21:41:55

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-07-17 21:41:55

Thanks!


---

Comment by mjo created at 2020-07-17 23:30:39

Late to the party, sorry. I think my new commit factors out the no-deps code as requested.

If I missed something or if you'd rather do it on another ticket, just put the old branch back and mark it as positive review again. Everything is working now.


---

Comment by mjo created at 2020-07-17 23:30:39

Changing status from positive_review to needs_review.


---

Comment by mkoeppe created at 2020-07-17 23:34:21

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-07-17 23:34:21

Thanks.


---

Comment by mkoeppe created at 2020-07-25 23:13:39

Merged 9.2.beta6
----
New commits:


---

Comment by vbraun created at 2020-07-28 22:34:38

Resolution: fixed


---

Comment by mkoeppe created at 2020-08-13 01:11:17

I think the recursive invocation of $(MAKE) leads to builds with extremely high parallel load when `MAKE="make -j8"` as recommended in Sage build documentation. I think this is part of why lately many builds on GH Actions are failing. To be fixed in #30345
