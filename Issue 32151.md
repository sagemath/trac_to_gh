# Issue 32151: elliptic-curve isogenies probably shouldn't be mutable

archive/issues_032151.json:
```json
{
    "body": "CC:  @defeo @JohnCremona @tscrim\n\nKeywords: elliptic curves, isogenies, mutability\n\nRight now, isogenies of elliptic curves are *slightly* mutable:\nThe three methods `switch_sign`, `set_post_isomorphism`, and `set_pre_isomorphism` all modify `self`.\n\nAs usual, this alone already causes bugs because it breaks hashing:\n\n```sage\nsage: E = EllipticCurve(GF(431), [1,0])\nsage: phi = E.isogeny(E.lift_x(277))\nsage: my_isogenies = {phi}\nsage: iso = phi.codomain().isomorphism_to(phi.codomain().change_weierstrass_model(1,2,3,4))\nsage: phi.set_post_isomorphism(iso)\nsage: phi in my_isogenies\nFalse\nsage: phi in list(my_isogenies)\nTrue\n```\n\nThe bigger issue is that it breaks other constructions that use `EllipticCurveIsogenies` as a building block: The easiest example is the existing `FormalCompositeMap` we already get from composing two isogenies. Mutability means that the factors of the map can be changed after the composition has been constructed, with weird and buggy results:\n\n```sage\nsage: psi = E.multiplication_by_m_isogeny(2)\nsage: f = phi * psi\nsage: f(E(0,0))\n(0 : 1 : 0)\nsage: iso = phi.domain().change_weierstrass_model(1,2,3,4).isomorphism_to(phi.domain())\nsage: psi.set_pre_isomorphism(iso)\nsage: f(E(0,0))\n# ...\nTypeError: Coordinates [11, 145, 1] do not define a point on Elliptic Curve defined by y^2 = x^3 + x over Finite Field of size 431\nsage: f.domain()\nElliptic Curve defined by y^2 = x^3 + x over Finite Field of size 431\nsage: f[0].domain()\nElliptic Curve defined by y^2 + 6*x*y + 8*y = x^3 + 428*x^2 + 420*x + 425 over Finite Field of size 431\n```\n\nThe main reason I care about this is because I'm working on parts of #7368, and this precise issue is causing quite a bit of headache. I suggest deprecating the `set_*_isomorphism()` and `switch_sign()` methods as soon as possible so that isogenies can stop mutating in-place at some point in the not too distant future.\n\nSince I'm sure composing isogenies with isomorphisms will be sorely missed (I use this feature a lot myself), the patch does introduce new syntax for the same operations: We can simply write `iso * phi` to post-compose `phi` with `iso`, and similarly for pre-composition. The `switch_sign` method can already be substituted by the unary negation operator.\n(Note that composing isogenies and isomorphisms using `*` does *not* result in a generic formal composition, but in an `EllipticCurveIsogeny` like before.)\n\nTo facilitate these \"mixed\" compositions, the patch reparents `WeierstrassIsomorphism` and `EllipticCurveIsogeny` under a common parent class `EllipticCurveHom` (mostly just a `Morphism` with a different name). This should also make implementing other classes of elliptic-curve morphisms (e.g., purely inseparable isogenies, formal sums of isogenies for endomorphism rings, etc.) easier in the future. As part of this change, `WeierstrassIsomorphism`s now have actual curves rather than groups of points as their (co)domains. This was the mathematically right choice all along and is consistent with `EllipticCurveIsogenies`.\n\nNote: This patch is intentionally kept small. I'm aware of other things in the elliptic-curve isogeny code that need refactoring or fixing. My hope is that making small changes one at a time has a better chance of actually getting things done.\n\nAlso note: The patch is probably easiest to review by looking at the individual commits rather than the overall diff.\n\nIssue created by migration from https://trac.sagemath.org/ticket/32388\n\n",
    "closed_at": "2021-09-19T09:59:06Z",
    "created_at": "2021-08-17T05:17:00Z",
    "labels": [
        "component: elliptic curves",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "elliptic-curve isogenies probably shouldn't be mutable",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32151",
    "user": "https://github.com/yyyyx4"
}
```
CC:  @defeo @JohnCremona @tscrim

Keywords: elliptic curves, isogenies, mutability

Right now, isogenies of elliptic curves are *slightly* mutable:
The three methods `switch_sign`, `set_post_isomorphism`, and `set_pre_isomorphism` all modify `self`.

As usual, this alone already causes bugs because it breaks hashing:

```sage
sage: E = EllipticCurve(GF(431), [1,0])
sage: phi = E.isogeny(E.lift_x(277))
sage: my_isogenies = {phi}
sage: iso = phi.codomain().isomorphism_to(phi.codomain().change_weierstrass_model(1,2,3,4))
sage: phi.set_post_isomorphism(iso)
sage: phi in my_isogenies
False
sage: phi in list(my_isogenies)
True
```

The bigger issue is that it breaks other constructions that use `EllipticCurveIsogenies` as a building block: The easiest example is the existing `FormalCompositeMap` we already get from composing two isogenies. Mutability means that the factors of the map can be changed after the composition has been constructed, with weird and buggy results:

```sage
sage: psi = E.multiplication_by_m_isogeny(2)
sage: f = phi * psi
sage: f(E(0,0))
(0 : 1 : 0)
sage: iso = phi.domain().change_weierstrass_model(1,2,3,4).isomorphism_to(phi.domain())
sage: psi.set_pre_isomorphism(iso)
sage: f(E(0,0))
# ...
TypeError: Coordinates [11, 145, 1] do not define a point on Elliptic Curve defined by y^2 = x^3 + x over Finite Field of size 431
sage: f.domain()
Elliptic Curve defined by y^2 = x^3 + x over Finite Field of size 431
sage: f[0].domain()
Elliptic Curve defined by y^2 + 6*x*y + 8*y = x^3 + 428*x^2 + 420*x + 425 over Finite Field of size 431
```

The main reason I care about this is because I'm working on parts of #7368, and this precise issue is causing quite a bit of headache. I suggest deprecating the `set_*_isomorphism()` and `switch_sign()` methods as soon as possible so that isogenies can stop mutating in-place at some point in the not too distant future.

Since I'm sure composing isogenies with isomorphisms will be sorely missed (I use this feature a lot myself), the patch does introduce new syntax for the same operations: We can simply write `iso * phi` to post-compose `phi` with `iso`, and similarly for pre-composition. The `switch_sign` method can already be substituted by the unary negation operator.
(Note that composing isogenies and isomorphisms using `*` does *not* result in a generic formal composition, but in an `EllipticCurveIsogeny` like before.)

To facilitate these "mixed" compositions, the patch reparents `WeierstrassIsomorphism` and `EllipticCurveIsogeny` under a common parent class `EllipticCurveHom` (mostly just a `Morphism` with a different name). This should also make implementing other classes of elliptic-curve morphisms (e.g., purely inseparable isogenies, formal sums of isogenies for endomorphism rings, etc.) easier in the future. As part of this change, `WeierstrassIsomorphism`s now have actual curves rather than groups of points as their (co)domains. This was the mathematically right choice all along and is consistent with `EllipticCurveIsogenies`.

Note: This patch is intentionally kept small. I'm aware of other things in the elliptic-curve isogeny code that need refactoring or fixing. My hope is that making small changes one at a time has a better chance of actually getting things done.

Also note: The patch is probably easiest to review by looking at the individual commits rather than the overall diff.

Issue created by migration from https://trac.sagemath.org/ticket/32388





---

archive/issue_comments_458710.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-08-17T05:31:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32151#issuecomment-458710",
    "user": "https://github.com/yyyyx4"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_458711.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-20T05:54:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32151#issuecomment-458711",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_458712.json:
```json
{
    "body": "Replaced the previous, very hacky implementation of compositions between different types of `EllipticCurveHom`s by a slightly less hacky version that should make it easier to get compositions to work with new subclasses of `EllipticCurveHom`.",
    "created_at": "2021-08-20T05:59:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32151#issuecomment-458712",
    "user": "https://github.com/yyyyx4"
}
```

Replaced the previous, very hacky implementation of compositions between different types of `EllipticCurveHom`s by a slightly less hacky version that should make it easier to get compositions to work with new subclasses of `EllipticCurveHom`.



---

archive/issue_comments_458713.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-30T08:11:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32151#issuecomment-458713",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_458714.json:
```json
{
    "body": "Yet another example where this causes things to break:\n\n```sage\nsage: from sage.schemes.elliptic_curves.weierstrass_morphism import WeierstrassIsomorphism\nsage: E = EllipticCurve([1,0])\nsage: phi = E.isogeny(E(0,0))\nsage: psi = phi.dual(); psi\nIsogeny of degree 2 from Elliptic Curve defined by y^2 = x^3 - 4*x over Rational Field to Elliptic Curve defined by y^2 = x^3 + x over Rational Field\nsage: psi.set_post_isomorphism(WeierstrassIsomorphism(E, (1,2,3,4)))\nsage: phi.dual()\nIsogeny of degree 2 from Elliptic Curve defined by y^2 = x^3 - 4*x over Rational Field to Elliptic Curve defined by y^2 + 6*x*y + 8*y = x^3 - 3*x^2 - 11*x - 6 over Rational Field\n```",
    "created_at": "2021-09-10T03:22:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32151#issuecomment-458714",
    "user": "https://github.com/yyyyx4"
}
```

Yet another example where this causes things to break:

```sage
sage: from sage.schemes.elliptic_curves.weierstrass_morphism import WeierstrassIsomorphism
sage: E = EllipticCurve([1,0])
sage: phi = E.isogeny(E(0,0))
sage: psi = phi.dual(); psi
Isogeny of degree 2 from Elliptic Curve defined by y^2 = x^3 - 4*x over Rational Field to Elliptic Curve defined by y^2 = x^3 + x over Rational Field
sage: psi.set_post_isomorphism(WeierstrassIsomorphism(E, (1,2,3,4)))
sage: phi.dual()
Isogeny of degree 2 from Elliptic Curve defined by y^2 = x^3 - 4*x over Rational Field to Elliptic Curve defined by y^2 + 6*x*y + 8*y = x^3 - 3*x^2 - 11*x - 6 over Rational Field
```



---

archive/issue_comments_458715.json:
```json
{
    "body": "For composition you can also consider offering the `_matmul_` operator (#30244, #32212)",
    "created_at": "2021-09-10T04:00:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32151#issuecomment-458715",
    "user": "https://github.com/mkoeppe"
}
```

For composition you can also consider offering the `_matmul_` operator (#30244, #32212)



---

archive/issue_comments_458716.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-10T08:20:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32151#issuecomment-458716",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_458717.json:
```json
{
    "body": "Replying to [comment:7 mkoeppe]:\n> For composition you can also consider offering the `_matmul_` operator (#30244, #32212)\n\n\nSounds reasonable, but feels somewhat orthogonal to this ticket. In any case, to avoid fixing an interface prematurely, we should think about whether we'd like ``@`` and `*` to do different things, in particular regarding #31850. (Personally, I think they should be the same and create isogeny-esque formal composite maps, as outlined in comment:6:ticket:31850.)",
    "created_at": "2021-09-10T08:25:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32151#issuecomment-458717",
    "user": "https://github.com/yyyyx4"
}
```

Replying to [comment:7 mkoeppe]:
> For composition you can also consider offering the `_matmul_` operator (#30244, #32212)


Sounds reasonable, but feels somewhat orthogonal to this ticket. In any case, to avoid fixing an interface prematurely, we should think about whether we'd like ``@`` and `*` to do different things, in particular regarding #31850. (Personally, I think they should be the same and create isogeny-esque formal composite maps, as outlined in comment:6:ticket:31850.)



---

archive/issue_comments_458718.json:
```json
{
    "body": "For the internal call to `_switch_sign`, I think you should just explicitly replace it with the function call and get rid of `_switch_sign` as it is only called in one place in non-deprecated code.",
    "created_at": "2021-09-13T01:19:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32151#issuecomment-458718",
    "user": "https://github.com/tscrim"
}
```

For the internal call to `_switch_sign`, I think you should just explicitly replace it with the function call and get rid of `_switch_sign` as it is only called in one place in non-deprecated code.



---

archive/issue_comments_458719.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-13T03:13:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32151#issuecomment-458719",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_458720.json:
```json
{
    "body": "Only other thing that needs to be done is make sure every method has a doctest.",
    "created_at": "2021-09-13T04:07:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32151#issuecomment-458720",
    "user": "https://github.com/tscrim"
}
```

Only other thing that needs to be done is make sure every method has a doctest.



---

archive/issue_comments_458721.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-13T06:58:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32151#issuecomment-458721",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_458722.json:
```json
{
    "body": "Done, I believe.",
    "created_at": "2021-09-13T07:05:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32151#issuecomment-458722",
    "user": "https://github.com/yyyyx4"
}
```

Done, I believe.



---

archive/issue_comments_458723.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-13T13:30:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32151#issuecomment-458723",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_458724.json:
```json
{
    "body": "Thanks to those who have been working on this and related tickets.  I have just been looking at the threads after returning from holiday and am happy with what is being proposed.\n\nThe issue regarding normalization of isogenies is almost entirely restricted to isogenies over finite fields, where it is easy to achieve by changing the model used for the domain or codomain, but is almost irrelevant for isogenies over Q and other number fields, which I have done most with (and use most), where you often have few units around to scale modles by, and do not care whether the isogenies are normalised.\n\nSecondly, composing with isomorphisms in general is used a lot in the code I wrote for compstructing isogenies over number fields, where there's a generic formula for short Weiertstrass equations but one want an isogeny between other (say minimal) models.  In particular, pre- and post-composing by automorphisms was implemented the way it is (I seem to remember) by the original implemented, who worked over finite fields, and added some features at my request before the first versions of all this were merged years ago.",
    "created_at": "2021-09-13T15:59:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32151#issuecomment-458724",
    "user": "https://github.com/JohnCremona"
}
```

Thanks to those who have been working on this and related tickets.  I have just been looking at the threads after returning from holiday and am happy with what is being proposed.

The issue regarding normalization of isogenies is almost entirely restricted to isogenies over finite fields, where it is easy to achieve by changing the model used for the domain or codomain, but is almost irrelevant for isogenies over Q and other number fields, which I have done most with (and use most), where you often have few units around to scale modles by, and do not care whether the isogenies are normalised.

Secondly, composing with isomorphisms in general is used a lot in the code I wrote for compstructing isogenies over number fields, where there's a generic formula for short Weiertstrass equations but one want an isogeny between other (say minimal) models.  In particular, pre- and post-composing by automorphisms was implemented the way it is (I seem to remember) by the original implemented, who worked over finite fields, and added some features at my request before the first versions of all this were merged years ago.



---

archive/issue_comments_458725.json:
```json
{
    "body": "Thank you. This LGTM.\n\nJohn, forgive me as this is a bit outside my mathematical area, is there something with this ticket, such as removing the pre/post-compose with mutation that you disagree with, such as for performance reasons?",
    "created_at": "2021-09-15T01:51:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32151#issuecomment-458725",
    "user": "https://github.com/tscrim"
}
```

Thank you. This LGTM.

John, forgive me as this is a bit outside my mathematical area, is there something with this ticket, such as removing the pre/post-compose with mutation that you disagree with, such as for performance reasons?



---

archive/issue_comments_458726.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-09-15T07:52:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32151#issuecomment-458726",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_458727.json:
```json
{
    "body": "Replying to [comment:17 tscrim]:\n> Thank you. This LGTM.\n> \n> John, forgive me as this is a bit outside my mathematical area, is there something with this ticket, such as removing the pre/post-compose with mutation that you disagree with, such as for performance reasons?\n\n\nNo, not at all.  I really like these changes, and also the move towards unifying isogenies with isomorphisms (of Weierstrass models) which always were a special case.  This is much better.  I think that implementing W. isomorphisms was the very first thing I ever did in Sage, in 2007, so probably my first ever Python programming, and hence almost certainly in need of attention -- that was before isogenies were implemented at all, and was desperately needed at the time!\n\nI have looked at the changes and am happy to add my name to the reviewers, and give this a positive review.",
    "created_at": "2021-09-15T07:52:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32151#issuecomment-458727",
    "user": "https://github.com/JohnCremona"
}
```

Replying to [comment:17 tscrim]:
> Thank you. This LGTM.
> 
> John, forgive me as this is a bit outside my mathematical area, is there something with this ticket, such as removing the pre/post-compose with mutation that you disagree with, such as for performance reasons?


No, not at all.  I really like these changes, and also the move towards unifying isogenies with isomorphisms (of Weierstrass models) which always were a special case.  This is much better.  I think that implementing W. isomorphisms was the very first thing I ever did in Sage, in 2007, so probably my first ever Python programming, and hence almost certainly in need of attention -- that was before isogenies were implemented at all, and was desperately needed at the time!

I have looked at the changes and am happy to add my name to the reviewers, and give this a positive review.



---

archive/issue_comments_458728.json:
```json
{
    "body": "Great, thank you for clarifying and reviewing.",
    "created_at": "2021-09-15T09:08:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32151#issuecomment-458728",
    "user": "https://github.com/tscrim"
}
```

Great, thank you for clarifying and reviewing.



---

archive/issue_comments_458729.json:
```json
{
    "body": "Thanks both of you! I'm glad you agree that these changes are a step towards making things better. :-)",
    "created_at": "2021-09-15T10:00:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32151#issuecomment-458729",
    "user": "https://github.com/yyyyx4"
}
```

Thanks both of you! I'm glad you agree that these changes are a step towards making things better. :-)



---

archive/issue_comments_458730.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-09-19T09:59:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32151#issuecomment-458730",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_085939.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-09-19T09:59:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32151",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32151#event-85939"
}
```
