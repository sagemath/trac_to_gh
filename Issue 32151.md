# Issue 32151: elliptic-curve isogenies probably shouldn't be mutable

Issue created by migration from https://trac.sagemath.org/ticket/32388

Original creator: lorenz

Original creation time: 2021-08-17 05:17:00

CC:  defeo cremona tscrim

Keywords: elliptic curves, isogenies, mutability

Right now, isogenies of elliptic curves are _slightly_ mutable:
The three methods `switch_sign`, `set_post_isomorphism`, and `set_pre_isomorphism` all modify `self`.

As usual, this alone already causes bugs because it breaks hashing:


```sage
sage: E = EllipticCurve(GF(431), [1,0])
sage: phi = E.isogeny(E.lift_x(277))
sage: my_isogenies = {phi}
sage: iso = phi.codomain().isomorphism_to(phi.codomain().change_weierstrass_model(1,2,3,4))
sage: phi.set_post_isomorphism(iso)
sage: phi in my_isogenies
False
sage: phi in list(my_isogenies)
True
```


The bigger issue is that it breaks other constructions that use `EllipticCurveIsogenies` as a building block: The easiest example is the existing `FormalCompositeMap` we already get from composing two isogenies. Mutability means that the factors of the map can be changed after the composition has been constructed, with weird and buggy results:


```sage
sage: psi = E.multiplication_by_m_isogeny(2)
sage: f = phi * psi
sage: f(E(0,0))
(0 : 1 : 0)
sage: iso = phi.domain().change_weierstrass_model(1,2,3,4).isomorphism_to(phi.domain())
sage: psi.set_pre_isomorphism(iso)
sage: f(E(0,0))
# ...
TypeError: Coordinates [11, 145, 1] do not define a point on Elliptic Curve defined by y^2 = x^3 + x over Finite Field of size 431
sage: f.domain()
Elliptic Curve defined by y^2 = x^3 + x over Finite Field of size 431
sage: f[0].domain()
Elliptic Curve defined by y^2 + 6*x*y + 8*y = x^3 + 428*x^2 + 420*x + 425 over Finite Field of size 431
```



---

Comment by lorenz created at 2021-08-17 05:31:26

Changing status from new to needs_review.


---

Comment by git created at 2021-08-20 05:54:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lorenz created at 2021-08-20 05:59:18

Replaced the previous, very hacky implementation of compositions between different types of `EllipticCurveHom`s by a slightly less hacky version that should make it easier to get compositions to work with new subclasses of `EllipticCurveHom`.


---

Comment by git created at 2021-08-30 08:11:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lorenz created at 2021-09-10 03:22:46

Yet another example where this causes things to break:


```sage
sage: from sage.schemes.elliptic_curves.weierstrass_morphism import WeierstrassIsomorphism
sage: E = EllipticCurve([1,0])
sage: phi = E.isogeny(E(0,0))
sage: psi = phi.dual(); psi
Isogeny of degree 2 from Elliptic Curve defined by y^2 = x^3 - 4*x over Rational Field to Elliptic Curve defined by y^2 = x^3 + x over Rational Field
sage: psi.set_post_isomorphism(WeierstrassIsomorphism(E, (1,2,3,4)))
sage: phi.dual()
Isogeny of degree 2 from Elliptic Curve defined by y^2 = x^3 - 4*x over Rational Field to Elliptic Curve defined by y^2 + 6*x*y + 8*y = x^3 - 3*x^2 - 11*x - 6 over Rational Field
```



---

Comment by mkoeppe created at 2021-09-10 04:00:05

For composition you can also consider offering the `_matmul_` operator (#30244, #32212)


---

Comment by git created at 2021-09-10 08:20:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lorenz created at 2021-09-10 08:25:21

Replying to [comment:7 mkoeppe]:
> For composition you can also consider offering the `_matmul_` operator (#30244, #32212)

Sounds reasonable, but feels somewhat orthogonal to this ticket. In any case, to avoid fixing an interface prematurely, we should think about whether we'd like ``@`` and `*` to do different things, in particular regarding #31850. (Personally, I think they should be the same and create isogeny-esque formal composite maps, as outlined in comment:6:ticket:31850.)


---

Comment by tscrim created at 2021-09-13 01:19:43

For the internal call to `_switch_sign`, I think you should just explicitly replace it with the function call and get rid of `_switch_sign` as it is only called in one place in non-deprecated code.


---

Comment by git created at 2021-09-13 03:13:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-09-13 04:07:39

Only other thing that needs to be done is make sure every method has a doctest.


---

Comment by git created at 2021-09-13 06:58:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lorenz created at 2021-09-13 07:05:31

Done, I believe.


---

Comment by git created at 2021-09-13 13:30:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cremona created at 2021-09-13 15:59:30

Thanks to those who have been working on this and related tickets.  I have just been looking at the threads after returning from holiday and am happy with what is being proposed.

The issue regarding normalization of isogenies is almost entirely restricted to isogenies over finite fields, where it is easy to achieve by changing the model used for the domain or codomain, but is almost irrelevant for isogenies over Q and other number fields, which I have done most with (and use most), where you often have few units around to scale modles by, and do not care whether the isogenies are normalised.

Secondly, composing with isomorphisms in general is used a lot in the code I wrote for compstructing isogenies over number fields, where there's a generic formula for short Weiertstrass equations but one want an isogeny between other (say minimal) models.  In particular, pre- and post-composing by automorphisms was implemented the way it is (I seem to remember) by the original implemented, who worked over finite fields, and added some features at my request before the first versions of all this were merged years ago.


---

Comment by tscrim created at 2021-09-15 01:51:59

Thank you. This LGTM.

John, forgive me as this is a bit outside my mathematical area, is there something with this ticket, such as removing the pre/post-compose with mutation that you disagree with, such as for performance reasons?


---

Comment by cremona created at 2021-09-15 07:52:59

Changing status from needs_review to positive_review.


---

Comment by cremona created at 2021-09-15 07:52:59

Replying to [comment:17 tscrim]:
> Thank you. This LGTM.
> 
> John, forgive me as this is a bit outside my mathematical area, is there something with this ticket, such as removing the pre/post-compose with mutation that you disagree with, such as for performance reasons?

No, not at all.  I really like these changes, and also the move towards unifying isogenies with isomorphisms (of Weierstrass models) which always were a special case.  This is much better.  I think that implementing W. isomorphisms was the very first thing I ever did in Sage, in 2007, so probably my first ever Python programming, and hence almost certainly in need of attention -- that was before isogenies were implemented at all, and was desperately needed at the time!

I have looked at the changes and am happy to add my name to the reviewers, and give this a positive review.


---

Comment by tscrim created at 2021-09-15 09:08:39

Great, thank you for clarifying and reviewing.


---

Comment by lorenz created at 2021-09-15 10:00:57

Thanks both of you! I'm glad you agree that these changes are a step towards making things better. :-)


---

Comment by vbraun created at 2021-09-19 09:59:06

Resolution: fixed
