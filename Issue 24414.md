# Issue 24414: Fix pexpect on Solaris 11

Issue created by migration from https://trac.sagemath.org/ticket/24651

Original creator: dimpase

Original creation time: 2018-02-03 20:09:20

CC:  jdemeyer

pexpect interface is apparently broken (and this causes a lot of breakage everywhere pexpect is used), e.g.

```
sage -t src/sage/interfaces/singular.py  # 172 doctests failed
```

here is a typical error:

```
sage: t=singular(0)
---------------------------------------------------------------------------
IOError                                   Traceback (most recent call last)
<ipython-input-1-43d8f01f1d2c> in <module>()
----> 1 t=singular(Integer(0))

/datapool/dima/Sage/sagetrac-mirror/local/lib/python2.7/site-packages/sage/interfaces/singular.pyc in __call__(self, x, type)
    787             return self(x.sage())
    788         elif not isinstance(x, ExpectElement) and hasattr(x, '_singular_'):
--> 789             return x._singular_(self)
    790 
    791         # some convenient conversions

/datapool/dima/Sage/sagetrac-mirror/src/sage/structure/sage_object.pyx in sage.structure.sage_object.SageObject._singular_ (build/cythonized/sage/structure/sage_object.c:11739)()
    954             import sage.interfaces.singular
    955             G = sage.interfaces.singular.singular
--> 956         return self._interface_(G)
    957 
    958     def _singular_init_(self, have_ring=False):

/datapool/dima/Sage/sagetrac-mirror/src/sage/structure/sage_object.pyx in sage.structure.sage_object.SageObject._interface_ (build/cythonized/sage/structure/sage_object.c:6603)()
    728             except Exception:
    729                 raise NotImplementedError("coercion of object %s to %s not implemented:\n%s\n%s" % (repr(self), I))
--> 730         X = I(s)
    731         if c:
    732             try:

/datapool/dima/Sage/sagetrac-mirror/local/lib/python2.7/site-packages/sage/interfaces/singular.pyc in __call__(self, x, type)
    793             x = str(x)[1:-1]
    794 
--> 795         return SingularElement(self, type, x, False)
    796 
    797     def _coerce_map_from_(self, S):

/datapool/dima/Sage/sagetrac-mirror/local/lib/python2.7/site-packages/sage/interfaces/singular.pyc in __init__(self, parent, type, value, is_name)
   1279         if not is_name:
   1280             try:
-> 1281                 self._name = parent._create( value, type)
   1282             # Convert SingularError to TypeError for
   1283             # coercion to work properly.

/datapool/dima/Sage/sagetrac-mirror/local/lib/python2.7/site-packages/sage/interfaces/singular.pyc in _create(self, value, type)
    754         """
    755         name = self._next_var_name()
--> 756         self.set(type, name, value)
    757         return name
    758 

/datapool/dima/Sage/sagetrac-mirror/local/lib/python2.7/site-packages/sage/interfaces/singular.pyc in set(self, type, name, value)
    697         cmd += '%s %s=%s;'%(type, name, value)
    698         self.__to_clear = []
--> 699         self.eval(cmd)
    700 
    701     def get(self, var):

/datapool/dima/Sage/sagetrac-mirror/local/lib/python2.7/site-packages/sage/interfaces/singular.pyc in eval(self, x, allow_semicolon, strip, **kwds)
    652             x += ';'
    653 
--> 654         s = Expect.eval(self, x, **kwds)
    655 
    656         if s.find("error") != -1 or s.find("Segment fault") != -1:

/datapool/dima/Sage/sagetrac-mirror/local/lib/python2.7/site-packages/sage/interfaces/expect.pyc in eval(self, code, strip, synchronize, locals, allow_use_file, split_lines, **kwds)
   1295                 elif split_lines:
   1296                     return '\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)
-> 1297                                         for L in code.split('\n') if L != ''])
   1298                 else:
   1299                     return self._eval_line(code, allow_use_file=allow_use_file, **kwds)

/datapool/dima/Sage/sagetrac-mirror/local/lib/python2.7/site-packages/sage/interfaces/expect.pyc in _eval_line(self, line, allow_use_file, wait_for_prompt, restart_if_needed)
    905         try:
    906             if self._expect is None:
--> 907                 self._start()
    908             E = self._expect
    909             try:

/datapool/dima/Sage/sagetrac-mirror/local/lib/python2.7/site-packages/sage/interfaces/singular.pyc in _start(self, alt_message)
    437         """
    438         self.__libs = []
--> 439         Expect._start(self, alt_message)
    440         # Load some standard libraries.
    441         self.lib('general')   # assumed loaded by misc/constants.py

/datapool/dima/Sage/sagetrac-mirror/local/lib/python2.7/site-packages/sage/interfaces/expect.pyc in _start(self, alt_message, block_during_init)
    513         # switching echo off until now.
    514         if not self._terminal_echo:
--> 515             self._expect.setecho(0)
    516 
    517         with gc_disabled():

/datapool/dima/Sage/sagetrac-mirror/local/lib/python2.7/site-packages/pexpect/pty_spawn.pyc in setecho(self, state)
    402         Not supported on platforms where ``isatty()`` returns False.
    403         '''
--> 404         return self.ptyproc.setecho(state)
    405 
    406         self.echo = state

/datapool/dima/Sage/sagetrac-mirror/local/lib/python2.7/site-packages/ptyprocess/ptyprocess.pyc in setecho(self, state)
    488         Not supported on platforms where ``isatty()`` returns False.
    489         '''
--> 490         _setecho(self.fd, state)
    491 
    492         self.echo = state

/datapool/dima/Sage/sagetrac-mirror/local/lib/python2.7/site-packages/ptyprocess/ptyprocess.pyc in _setecho(fd, state)
     95     except termios.error as err:
     96         if err.args[0] == errno.EINVAL:
---> 97             raise IOError(err.args[0], '%s: %s.' % (err.args[1], errmsg))
     98         raise
     99 

IOError: [Errno 22] Invalid argument: setecho() may not be called on this platform.
sage:  
```



---

Comment by dimpase created at 2018-02-03 22:11:40

this appears to be relevant: https://github.com/pexpect/ptyprocess/issues/34


---

Comment by dimpase created at 2018-02-03 22:46:52

People who worked on #14371 certainly know much more than me about this issue.


---

Comment by jdemeyer created at 2018-02-07 09:39:16

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2018-02-07 09:39:16

New commits:


---

Comment by jdemeyer created at 2018-02-07 09:45:53

Replying to [comment:1 dimpase]:
> this appears to be relevant: https://github.com/pexpect/ptyprocess/issues/34

I don't think so. The Sage issue is specifically about setting terminal echo.


---

Comment by dimpase created at 2018-02-07 10:09:40

Wow, brilliant catch! Appears to work, trying to build docs now.


---

Comment by jdemeyer created at 2018-02-07 10:17:23

I find it particularly convenient that the option in `pexpect` already existed. We don't even need an upstream patch!


---

Comment by dimpase created at 2018-02-07 10:24:39

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2018-02-07 10:24:39

Good. I can build docs now.


---

Comment by vbraun created at 2018-02-09 23:47:21

Resolution: fixed


---

Comment by saraedum created at 2018-10-10 07:56:14

Sorry, mistyped ticket number.
----
New commits:
