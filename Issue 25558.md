# Issue 25558: minor optimization in comparison between morphisms

Issue created by migration from https://trac.sagemath.org/ticket/25795

Original creator: raghukul01

Original creation time: 2018-07-07 15:11:04

CC:  bhutz raghukul01 chapoton

Keywords: algebraic scheme, gsoc2018

In most of the function we compare all the coordinates, but an early exit, if condition is not met would be more efficient.


---

Comment by raghukul01 created at 2018-07-07 15:35:16

Changing status from new to needs_review.


---

Comment by raghukul01 created at 2018-07-07 15:35:16

Changing type from PLEASE CHANGE to enhancement.


---

Comment by raghukul01 created at 2018-07-07 15:35:16

New commits:


---

Comment by tscrim created at 2018-07-07 17:02:02

All of these look like regressions. The Python `any` and `all` will both short-circuit, and the generator objects have optimizations within Python for speed (e.g., there is less code to parse). Run some timings (using `%timeit`), and while I will be surprised if your changes actually result in a speedup, only then would I give this a positive review.


---

Comment by raghukul01 created at 2018-07-07 18:24:13

Consider this example for `ProjectiveSpace`


```
sage: P = ProjectiveSpace(QQ,2000,'x')
sage: H = End(P); L = P.gens(); LL = []
sage: for i in L:
.....    LL.append(i*i)
sage: f = H(L); g = H(LL)
```



```
%timeit
f == g
False
CPU time: 10.83 s,  Wall time: 10.83 s

%timeit
updated__eq__(f,g)
False
CPU time: 0.00 s,  Wall time: 0.00 s
```

For `AffineSpace`:

```
sage: P = AffineSpace(QQ,30000,'x')
sage: H = End(P); L = P.gens(); LL = []
sage: for i in L:
.....    LL.append(i*i)
sage: f = H(L); g = H(LL)
```



```
%timeit
f == g
False
CPU time: 0.07 s,  Wall time: 0.08 s

updated__eq__(f,g)
False
CPU time: 0.00 s,  Wall time: 0.00 s
```


For Affine space order of algorithm is `O(n)` hence much difference cannot be seen (though we increase dimension, but it that case construction of f,g would take lot of time). However in Projective Space due to `O(n^2)` complexity, efficiency can be seen.

These examples aren't of much importance, but anyways it is an optimization :P


---

Comment by raghukul01 created at 2018-07-07 18:34:31

Better Example for Affine Space

```
sage: P = AffineSpace(QQ,10000,'x')
sage: H = End(P); L = P.gens(); LL = []
sage: for i in L:
.....    LL.append(i*i)
sage: f = H(L); g = H(LL)
```



```
%timeit
for i in range(1000):
    x = (f == g)
CPU time: 7.42 s,  Wall time: 7.43 s

%timeit
for i in range(1000):
    x = (updated__eq__(f,g))
CPU time: 0.16 s,  Wall time: 0.16 s
```



---

Comment by tscrim created at 2018-07-07 19:16:32

You are right, in that you do get a speedup, but it is for a _completely_ different reason than in your ticket description. Why it is faster is because you no longer create the temporary list. So by simply using a generator object instead of a list, you get the same speedup.

So, using the example from comment:5, I get

```
sage: %timeit f == g
The slowest run took 37.08 times longer than the fastest. This could mean that an intermediate result is being cached.
1000000 loops, best of 3: 1.4 µs per loop
```

versus your branch

```
sage: %timeit f == g
10000 loops, best of 3: 65.5 µs per loop
```



---

Comment by tscrim created at 2018-07-07 19:17:54

If my version is good with you (I also did a little bit of extra cleanup), then positive review.
----
New commits:


---

Comment by raghukul01 created at 2018-07-07 22:09:48

Changing status from needs_review to positive_review.


---

Comment by raghukul01 created at 2018-08-29 13:05:42

I think some other ticket fixed this issue.


---

Comment by tscrim created at 2018-08-29 13:15:33

Are you sure all of the things were done? Were there merge conflicts? You should use `git blame` to find the commit and search for that in trac to get the ticket(s) that did the change so I can verify.


---

Comment by tscrim created at 2018-08-29 13:15:33

Changing status from positive_review to needs_info.


---

Comment by raghukul01 created at 2018-08-31 04:02:28

Yes there were merge conflicts, using git blame, last commit on specified lines were made by Frédéric Chapoton. I have cc'ed him, I couldn't find the requested ticket, he might help.


---

Comment by tscrim created at 2018-09-08 22:56:25

Changing status from needs_info to needs_review.


---

Comment by tscrim created at 2018-09-08 22:56:25

I rebased the branch over 8.4.beta4. I still think these changes are useful. So if they are (still) good, then positive review.
----
New commits:


---

Comment by @raghukul01 created at 2018-09-09 07:45:23

Changing status from needs_review to positive_review.


---

Comment by @raghukul01 created at 2018-09-09 07:45:23

Sorry for missing them.


---

Comment by vbraun created at 2018-09-10 19:14:52

Resolution: fixed
