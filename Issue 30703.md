# Issue 30703: src/bin/sage-list-packages: Make it work if SAGE_ROOT is not available

Issue created by migration from https://trac.sagemath.org/ticket/30940

Original creator: mkoeppe

Original creation time: 2020-11-21 01:08:57

CC:  vdelecroix @tobiasdiez slabbe thansen jhpalmieri chapoton @kliem slelievre

In this case we can still retrieve the installed versions from the installation records `$SAGE_LOCAL/var/lib/sage/installed` (in the case of the sage distribution), but we will not be able to provide all details such as `remote_version`.




---

Comment by mkoeppe created at 2020-11-21 01:12:56

New commits:


---

Comment by mkoeppe created at 2020-11-21 01:14:08

Changing status from new to needs_review.


---

Comment by @tobiasdiez created at 2020-12-05 19:17:14

I think the previous code was easier to understand: if SAGE_PKGS is None, we don't need to go through the following for loop. But now one has to understand that the iteration is over an empty list. Better to exit the method early. 

```
-    if not SAGE_PKGS:
-        return {}
-
-    try:
-        lp = os.listdir(SAGE_PKGS)
-    except FileNotFoundError:
-        return {}
+    if SAGE_PKGS:
+        try:
+            lp = os.listdir(SAGE_PKGS)
+        except FileNotFoundError:
+            pass
     for ...
```


Moreover, I was wondering if the name normalization is ok as it changes the output of a public facing method and thus might break user scripts.

Otherwise it looks good to me.


---

Comment by @tobiasdiez created at 2020-12-05 19:17:14

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-12-05 19:29:20

Replying to [comment:6 gh-tobiasdiez]:
> I was wondering if the name normalization is ok as it changes the output of a public facing method and thus might break user scripts.

Good point, I'll make this normalization optional


---

Comment by git created at 2020-12-06 02:25:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-06 02:26:07

Replying to [comment:6 gh-tobiasdiez]:
> I think the previous code was easier to understand: if SAGE_PKGS is None, we don't need to go through the following for loop. But now one has to understand that the iteration is over an empty list. Better to exit the method early. 

Thanks, done.


---

Comment by mkoeppe created at 2020-12-06 02:26:07

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Changing keywords from "" to "sd111".


---

Comment by @tobiasdiez created at 2020-12-06 22:36:50

Changing status from needs_review to positive_review.


---

Comment by @tobiasdiez created at 2020-12-06 22:36:50

Code-wise it looks good to me now, thanks for the update!


---

Comment by git created at 2020-12-07 19:12:34

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2020-12-07 19:12:34

Changing status from positive_review to needs_review.


---

Comment by mkoeppe created at 2020-12-07 19:12:48

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-12-07 19:12:48

Merged current beta


---

Comment by vbraun created at 2020-12-14 06:08:04


```
**********************************************************************
File "src/sage/misc/package.py", line 384, in sage.misc.package.is_package_installed
Failed example:
    for pkg in list_packages(pkg_sources=('pip'), local=True):  # optional - build
        assert not is_package_installed(pkg), "pip package is installed: {}".format(pkg)
Exception raised:
    Traceback (most recent call last):
      File "/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.package.is_package_installed[3]>", line 2, in <module>
        assert not is_package_installed(pkg), "pip package is installed: {}".format(pkg)
    AssertionError: pip package is installed: zope_interface
**********************************************************************
File "src/sage/misc/package.py", line 454, in sage.misc.package.standard_packages
Failed example:
    installed[0], installed[-1]  # optional - build
Expected:
    ('alabaster', 'zn_poly')
Got:
    ('alabaster', 'zope_interface')
**********************************************************************
```



---

Comment by vbraun created at 2020-12-14 06:08:04

Changing status from positive_review to needs_work.


---

Comment by git created at 2020-12-14 17:36:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-14 17:36:31

Changing status from needs_work to needs_review.


---

Comment by git created at 2020-12-16 23:49:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-20 20:07:04

Let's please get this ticket in.


---

Comment by @kliem created at 2020-12-28 09:02:25

I would expect an empty line before and after

```
        def normalize(name):
            if normalization is None:
                return name
            elif normalization == 'spkg':
                return name.lower().replace('-', '_').replace('.', '_')
            else:
                raise NotImplementedError(f'normalization {normalization} is not implemented')
```



---

Comment by @kliem created at 2020-12-28 10:07:59

Why do we do it as a string here?

```
pkg['remote_version'] = 'none'
```



---

Comment by mkoeppe created at 2020-12-29 00:06:02

Replying to [comment:26 gh-kliem]:
> Why do we do it as a string here?
> {{{
> pkg['remote_version'] = 'none'
> }}}
This matches what `m4/sage_spkg_collect.m4` reports as the version of a package without `package-version.txt`


---

Comment by git created at 2020-12-29 00:07:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-29 00:13:48

Changing priority from minor to critical.


---

Comment by @kliem created at 2020-12-29 08:45:40

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2020-12-29 08:45:40

LGTM.


---

Comment by mkoeppe created at 2020-12-29 18:21:31

Thanks!


---

Comment by vbraun created at 2021-01-03 12:15:46

Resolution: fixed
