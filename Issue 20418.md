# Issue 20418: R installation failing on Cygwin

archive/issues_020418.json:
```json
{
    "body": "Keywords: windows cygwin R\n\nWhen running a `make` of Sage on Cygwin the build fails upon installation of R.  I will attach the full log, but the relevant error is:\n\n\n```\nmake[4]: Entering directory '/home/embray/src/sagemath/sage/local/var/tmp/sage/build/r-3.2.4-revised.p0/R-revised/src/library/Recommended'\nbegin installing recommended package MASS\nINSTALL: unknown option -- pkglock\nTry 'INSTALL --help' for more information.\nMakefile:51: recipe for target 'MASS.ts' failed\nmake[4]: *** [MASS.ts] Error 1\nmake[4]: Leaving directory '/home/embray/src/sagemath/sage/local/var/tmp/sage/build/r-3.2.4-revised.p0/R-revised/src/library/Recommended'\nMakefile:39: recipe for target 'recommended-packages' failed\n```\n\n\n`--pkglock` is an argument to the `INSTALL` script for installing R packages.  But it seems it's been passed in as literally `-- pkglock` (with a space).  Not sure why.\n\nThis issue also raises the question again about whether to make R an optional package (as well as whether to allow Sage to use a system install of R).\n\nIssue created by migration from https://trac.sagemath.org/ticket/20655\n\n",
    "created_at": "2016-05-23T08:49:05Z",
    "labels": [
        "porting: Cygwin",
        "major",
        "bug"
    ],
    "title": "R installation failing on Cygwin",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20418",
    "user": "embray"
}
```
Keywords: windows cygwin R

When running a `make` of Sage on Cygwin the build fails upon installation of R.  I will attach the full log, but the relevant error is:


```
make[4]: Entering directory '/home/embray/src/sagemath/sage/local/var/tmp/sage/build/r-3.2.4-revised.p0/R-revised/src/library/Recommended'
begin installing recommended package MASS
INSTALL: unknown option -- pkglock
Try 'INSTALL --help' for more information.
Makefile:51: recipe for target 'MASS.ts' failed
make[4]: *** [MASS.ts] Error 1
make[4]: Leaving directory '/home/embray/src/sagemath/sage/local/var/tmp/sage/build/r-3.2.4-revised.p0/R-revised/src/library/Recommended'
Makefile:39: recipe for target 'recommended-packages' failed
```


`--pkglock` is an argument to the `INSTALL` script for installing R packages.  But it seems it's been passed in as literally `-- pkglock` (with a space).  Not sure why.

This issue also raises the question again about whether to make R an optional package (as well as whether to allow Sage to use a system install of R).

Issue created by migration from https://trac.sagemath.org/ticket/20655





---

archive/issue_comments_281419.json:
```json
{
    "body": "Attachment [r-3.2.4-revised.p0.log](tarball://root/attachments/some-uuid/ticket20655/r-3.2.4-revised.p0.log) by embray created at 2016-05-23 08:49:27",
    "created_at": "2016-05-23T08:49:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20418#issuecomment-281419",
    "user": "embray"
}
```

Attachment [r-3.2.4-revised.p0.log](tarball://root/attachments/some-uuid/ticket20655/r-3.2.4-revised.p0.log) by embray created at 2016-05-23 08:49:27



---

archive/issue_comments_281420.json:
```json
{
    "body": "Ahahahahah  I at least slightly understand better.  I was losing my mind because I could not for the life of me find where this error message could be coming from.\n\nTurns out it's coming from the GNU `install` command, which gets confused for R's `INSTALL` command on Windows because case-insensitivity.",
    "created_at": "2016-05-24T14:12:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20418#issuecomment-281420",
    "user": "embray"
}
```

Ahahahahah  I at least slightly understand better.  I was losing my mind because I could not for the life of me find where this error message could be coming from.

Turns out it's coming from the GNU `install` command, which gets confused for R's `INSTALL` command on Windows because case-insensitivity.



---

archive/issue_comments_281421.json:
```json
{
    "body": "Okay, I think this is a bug in R IMO.\n\nR installs a bunch of \"scripts\" particular to R with names like `BUILD` and `INSTALL`.  R's install mistakenly marks these \"scripts\" as executable even though they do not contain a shebang line, so they are technically not executable in that sense.  Instead it runs those scripts from a main script (called `Rcmd`) using `exec`.\n\nThe problem here is that `Rcmd` only run these R-specific scripts *if* they are executable, and exist in `$R_HOME/bin`.  Realistically just whether they exist and are files in `$R_HOME/bin` should be good enough, since there shouldn't be any non-executable files in there.   If nothing else it should try to exec and if that fails it will return a permission error.  On Cygwin `exec` doesn't care if the file is marked executable or not, for this reason.  It will just try to execute it.",
    "created_at": "2016-05-24T15:38:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20418#issuecomment-281421",
    "user": "embray"
}
```

Okay, I think this is a bug in R IMO.

R installs a bunch of "scripts" particular to R with names like `BUILD` and `INSTALL`.  R's install mistakenly marks these "scripts" as executable even though they do not contain a shebang line, so they are technically not executable in that sense.  Instead it runs those scripts from a main script (called `Rcmd`) using `exec`.

The problem here is that `Rcmd` only run these R-specific scripts *if* they are executable, and exist in `$R_HOME/bin`.  Realistically just whether they exist and are files in `$R_HOME/bin` should be good enough, since there shouldn't be any non-executable files in there.   If nothing else it should try to exec and if that fails it will return a permission error.  On Cygwin `exec` doesn't care if the file is marked executable or not, for this reason.  It will just try to execute it.



---

archive/issue_comments_281422.json:
```json
{
    "body": "I guess on *nix it still has to mark those scripts as executable in order for them to work with `exec`, even though they are not strictly executable on their own.  Without a shebang line the shell will still try to execute them in the current shell process so I guess I rescind my complaint about them being marked executable.\n\nNevertheless the `test -x` used before executing them won't work sometimes on Cygwin :/",
    "created_at": "2016-05-24T15:51:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20418#issuecomment-281422",
    "user": "embray"
}
```

I guess on *nix it still has to mark those scripts as executable in order for them to work with `exec`, even though they are not strictly executable on their own.  Without a shebang line the shell will still try to execute them in the current shell process so I guess I rescind my complaint about them being marked executable.

Nevertheless the `test -x` used before executing them won't work sometimes on Cygwin :/



---

archive/issue_comments_281423.json:
```json
{
    "body": "This adds a patch that is the bare minimum to work around the issue and is essentially harmless.\n----\nNew commits:",
    "created_at": "2016-05-25T12:23:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20418#issuecomment-281423",
    "user": "embray"
}
```

This adds a patch that is the bare minimum to work around the issue and is essentially harmless.
----
New commits:



---

archive/issue_comments_281424.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-05-25T12:23:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20418#issuecomment-281424",
    "user": "embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_281425.json:
```json
{
    "body": "Changed my mind about reporting upstream.  According to [this issue, and a few others](https://bugs.r-project.org/bugzilla/show_bug.cgi?id=15607) it seems they don't want to officially support Cygwin builds and will close Cygwin issues as wontfix.  This is also environment specific.  It only affects you if you're building sage on a Cygwin filesystem that is mounted with noacl.  So maybe this doesn't affect most users.\n\nI still think the patch is worth keeping for the sake of least resistance on trying to build Sage on Cygwin.  This was a very mysterious and hard to track down problem.",
    "created_at": "2016-05-25T12:36:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20418#issuecomment-281425",
    "user": "embray"
}
```

Changed my mind about reporting upstream.  According to [this issue, and a few others](https://bugs.r-project.org/bugzilla/show_bug.cgi?id=15607) it seems they don't want to officially support Cygwin builds and will close Cygwin issues as wontfix.  This is also environment specific.  It only affects you if you're building sage on a Cygwin filesystem that is mounted with noacl.  So maybe this doesn't affect most users.

I still think the patch is worth keeping for the sake of least resistance on trying to build Sage on Cygwin.  This was a very mysterious and hard to track down problem.



---

archive/issue_comments_281426.json:
```json
{
    "body": "needs some documentation (in the patch header)",
    "created_at": "2016-05-25T23:31:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20418#issuecomment-281426",
    "user": "vbraun"
}
```

needs some documentation (in the patch header)



---

archive/issue_comments_281427.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-05-27T22:43:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20418#issuecomment-281427",
    "user": "vbraun"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_281428.json:
```json
{
    "body": "Done!",
    "created_at": "2016-05-30T16:41:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20418#issuecomment-281428",
    "user": "embray"
}
```

Done!



---

archive/issue_comments_281429.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-05-30T16:41:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20418#issuecomment-281429",
    "user": "embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_281430.json:
```json
{
    "body": "I was able to build R on cygwin32 using 7.3 without this. Still waiting on my cygwin64.",
    "created_at": "2016-08-07T14:44:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20418#issuecomment-281430",
    "user": "tscrim"
}
```

I was able to build R on cygwin32 using 7.3 without this. Still waiting on my cygwin64.



---

archive/issue_comments_281431.json:
```json
{
    "body": "Also built okay without this patch on cygwin64. Should we close this as wont-fix?",
    "created_at": "2016-08-07T15:22:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20418#issuecomment-281431",
    "user": "tscrim"
}
```

Also built okay without this patch on cygwin64. Should we close this as wont-fix?



---

archive/issue_comments_281432.json:
```json
{
    "body": "Replying to [comment:11 tscrim]:\n> Also built okay without this patch on cygwin64. Should we close this as wont-fix?\n\nThis issue only impacts if you're building in a directory mounted with `noacl` or with a messed up ACL which happens not infrequently if you have non-Cygwin processes messing with the permissions on files.\n\nThe end result is that setting executable flags may not always work.",
    "created_at": "2016-08-08T08:22:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20418#issuecomment-281432",
    "user": "embray"
}
```

Replying to [comment:11 tscrim]:
> Also built okay without this patch on cygwin64. Should we close this as wont-fix?

This issue only impacts if you're building in a directory mounted with `noacl` or with a messed up ACL which happens not infrequently if you have non-Cygwin processes messing with the permissions on files.

The end result is that setting executable flags may not always work.



---

archive/issue_comments_281433.json:
```json
{
    "body": "So it's something more with the configuration then? I will try rebuilding R with this branch later tonight.",
    "created_at": "2016-08-08T11:37:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20418#issuecomment-281433",
    "user": "tscrim"
}
```

So it's something more with the configuration then? I will try rebuilding R with this branch later tonight.



---

archive/issue_comments_281434.json:
```json
{
    "body": "It worries me when executable permissions don't work correctly. I think that false positives (`test -x` returning true on a non-executable file) are not so bad, but false negatives (`test -x` returning false on an executable file) seem more problematic. I would not be surprised if there would be more programs (even just the shell) behaving badly for this reason.",
    "created_at": "2016-08-08T12:22:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20418#issuecomment-281434",
    "user": "jdemeyer"
}
```

It worries me when executable permissions don't work correctly. I think that false positives (`test -x` returning true on a non-executable file) are not so bad, but false negatives (`test -x` returning false on an executable file) seem more problematic. I would not be surprised if there would be more programs (even just the shell) behaving badly for this reason.



---

archive/issue_comments_281435.json:
```json
{
    "body": "It's not really a problem in the shell so much.  Cygwin relies on a lot more than the `x` flag to determine whether or not a file is executable, precisely because of the unreliability of emulating UNIX permissions on top of Windows ACL.  At most, Cygwin just relies on the `x` permission as a hint.",
    "created_at": "2016-08-08T12:58:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20418#issuecomment-281435",
    "user": "embray"
}
```

It's not really a problem in the shell so much.  Cygwin relies on a lot more than the `x` flag to determine whether or not a file is executable, precisely because of the unreliability of emulating UNIX permissions on top of Windows ACL.  At most, Cygwin just relies on the `x` permission as a hint.



---

archive/issue_comments_281436.json:
```json
{
    "body": "So then should we consider merging this ticket Jeroen? I'm not sure what changing `-x` to `-f` really does with regards to how things are built.",
    "created_at": "2016-08-08T13:03:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20418#issuecomment-281436",
    "user": "tscrim"
}
```

So then should we consider merging this ticket Jeroen? I'm not sure what changing `-x` to `-f` really does with regards to how things are built.



---

archive/issue_comments_281437.json:
```json
{
    "body": "I having nothing against adding this patch to R. I am only saying that it's an ugly workaround and not really a fix.\n\nJust one thing: the patch is missing documentation. At the very least, it should refer to this Trac ticket.",
    "created_at": "2016-08-08T14:00:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20418#issuecomment-281437",
    "user": "jdemeyer"
}
```

I having nothing against adding this patch to R. I am only saying that it's an ugly workaround and not really a fix.

Just one thing: the patch is missing documentation. At the very least, it should refer to this Trac ticket.



---

archive/issue_comments_281438.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-08-08T16:49:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20418#issuecomment-281438",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_281439.json:
```json
{
    "body": "Replying to [comment:17 jdemeyer]:\n> I having nothing against adding this patch to R. I am only saying that it's an ugly workaround and not really a fix.\n\nNo disagreement there.  And really what it's working around is a shortcoming in Cygwin.  If you prefer, it could be a Cygwin-only patch.  It's just there's no real reason that the patched line strictly needs to `test -x` (and the code being patched is an ugly mess to begin with).",
    "created_at": "2016-08-09T09:23:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20418#issuecomment-281439",
    "user": "embray"
}
```

Replying to [comment:17 jdemeyer]:
> I having nothing against adding this patch to R. I am only saying that it's an ugly workaround and not really a fix.

No disagreement there.  And really what it's working around is a shortcoming in Cygwin.  If you prefer, it could be a Cygwin-only patch.  It's just there's no real reason that the patched line strictly needs to `test -x` (and the code being patched is an ugly mess to begin with).



---

archive/issue_comments_281440.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-16T14:04:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20418#issuecomment-281440",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_281441.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-08-16T14:04:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20418#issuecomment-281441",
    "user": "embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_281442.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-08-16T14:04:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20418#issuecomment-281442",
    "user": "embray"
}
```

New commits:



---

archive/issue_comments_281443.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-08-16T14:11:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20418#issuecomment-281443",
    "user": "jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_281444.json:
```json
{
    "body": "If this works for you...",
    "created_at": "2016-08-16T14:11:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20418#issuecomment-281444",
    "user": "jdemeyer"
}
```

If this works for you...



---

archive/issue_comments_281445.json:
```json
{
    "body": "> because they do no contain a shebang line\n\nI guess this is the real bug.",
    "created_at": "2016-08-16T14:12:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20418#issuecomment-281445",
    "user": "jdemeyer"
}
```

> because they do no contain a shebang line

I guess this is the real bug.



---

archive/issue_comments_281446.json:
```json
{
    "body": "Replying to [comment:23 jdemeyer]:\n> > because they do no contain a shebang line\n> \n> I guess this is the real bug.\n\nYes and no.  I think the real bug is that it requires them to be executable, because the way those particular scripts are invoked, IIRC, is by sourcing them from an actual executable.  In other words, they shouldn't be considered executables in their own right in the first place.\n\nOtherwise yes, I agree they should have a shebang line.",
    "created_at": "2016-08-16T14:31:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20418#issuecomment-281446",
    "user": "embray"
}
```

Replying to [comment:23 jdemeyer]:
> > because they do no contain a shebang line
> 
> I guess this is the real bug.

Yes and no.  I think the real bug is that it requires them to be executable, because the way those particular scripts are invoked, IIRC, is by sourcing them from an actual executable.  In other words, they shouldn't be considered executables in their own right in the first place.

Otherwise yes, I agree they should have a shebang line.



---

archive/issue_comments_281447.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-08-19T22:45:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20418#issuecomment-281447",
    "user": "vbraun"
}
```

Resolution: fixed
