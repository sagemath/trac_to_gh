# Issue 12515: Fix Singular doctest error on OpenSolaris

Issue created by migration from https://trac.sagemath.org/ticket/12687

Original creator: jdemeyer

Original creation time: 2012-03-18 11:22:16

Assignee: was

CC:  simonking

The following is caused by #10296.  On hawk (OpenSolaris 06.2009-32):

```
sage -t  --long -force_lib devel/sage/sage/interfaces/expect.py
**********************************************************************
File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.0.beta8/devel/sage-main/sage/interfaces/expect.py", line 717:
    sage: singular._eval_line_using_file('def a=3;', restart_if_needed=False)
Expected:
    Traceback (most recent call last):
    ...
    RuntimeError: Singular terminated unexpectedly while reading in a large line
Got:
    Traceback (most recent call last):
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.0.beta8/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.0.beta8/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.0.beta8/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_15[8]>", line 1, in <module>
        singular._eval_line_using_file('def a=3;', restart_if_needed=False)###line 717:
    sage: singular._eval_line_using_file('def a=3;', restart_if_needed=False)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.0.beta8/local/lib/python/site-packages/sage/interfaces/expect.py", line 768, in _eval_line_using_file
        raise RuntimeError, '%s terminated unexpectedly while reading in a large line:\n%s'%(self,msg[0])
    RuntimeError: Singular terminated unexpectedly while reading in a large line:
    [Errno 22] Invalid argument
    Error evaluating < "/tmp/dot_so48.icq/temp/hawk/8451//interface//tmp8749"; in Singular
**********************************************************************
File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.0.beta8/devel/sage-main/sage/interfaces/expect.py", line 839:
    sage: singular._eval_line_using_file('def a=3;', restart_if_needed=False)
Expected:
    Traceback (most recent call last):
    ...
    RuntimeError: Singular terminated unexpectedly while reading in a large line
Got:
    Traceback (most recent call last):
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.0.beta8/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.0.beta8/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.0.beta8/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_16[14]>", line 1, in <module>
        singular._eval_line_using_file('def a=3;', restart_if_needed=False)###line 839:
    sage: singular._eval_line_using_file('def a=3;', restart_if_needed=False)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.0.beta8/local/lib/python/site-packages/sage/interfaces/expect.py", line 768, in _eval_line_using_file
        raise RuntimeError, '%s terminated unexpectedly while reading in a large line:\n%s'%(self,msg[0])
    RuntimeError: Singular terminated unexpectedly while reading in a large line:
    [Errno 22] Invalid argument
    Error evaluating < "/tmp/dot_so48.icq/temp/hawk/8451//interface//tmp8806"; in Singular
**********************************************************************
```



---

Comment by SimonKing created at 2012-03-18 11:43:12

Can you remind me how I can access the skynet machines? t2 seems to be unavailable.

And what is needed to do in order to build Sage on `OpenSolaris`? IIRC, one needs to set some environment variables.


---

Comment by was created at 2012-03-18 13:04:47

Replying to [comment:1 SimonKing]:
> Can you remind me how I can access the skynet machines? t2 seems to be unavailable.

We turned t2 off again because the UPS's in the math server room were dying after the power outage, and t2 draws quite a lot of power.  They are still not happy.   We probably won't be able to turn t2 on until we buy new UPS's.   The sysadmins are working with a company (APS) to get an estimate done. 

To connect to skynet, connect to sage.math  or boxen.math then ssh to skynet, e.g., 

```
   ssh skynet
```


> And what is needed to do in order to build Sage on `OpenSolaris`? IIRC, one needs to set some environment variables.

I don't think we have any OpenSolaris installs anywhere right now.   ?


---

Comment by SimonKing created at 2012-03-18 13:09:43

Replying to [comment:2 was]:
> To connect to skynet, connect to sage.math  or boxen.math then ssh to skynet, e.g., 
> {{{
>    ssh skynet
> }}}

Thank you!

> I don't think we have any OpenSolaris installs anywhere right now.   ?

Then how can it be claimed that #10296 results in a doctest error on `OpenSolaris`??


---

Comment by was created at 2012-03-18 13:34:46

Replying to [comment:3 SimonKing]:
> > I don't think we have any OpenSolaris installs anywhere right now.   ?
> 
> Then how can it be claimed that #10296 results in a doctest error on `OpenSolaris`??

Sorry, by "we" I meant "I".  The machine "hawk" is in David Kirkby's house, I think.   It has nothing to do with skynet or the sage.math cluster.


---

Comment by SimonKing created at 2012-03-19 07:14:25

Replying to [comment:2 was]:
> To connect to skynet, connect to sage.math  or boxen.math then ssh to skynet, e.g., 
> {{{
>    ssh skynet
> }}}

Too bad. I do have a skynet account (I have already built sage on some of the skynet machines), but apparently I can not recall my login data.

I am quite puzzled about that error. It seems to me that the patch does work, even on Solaris. Note that in the failing doc test, it is expected that a `RuntimeError` be raised with the error message `Singular terminated unexpectedly while reading in a large line`, and in fact it _is_ raised.

However, on `OpenSolaris`, but apparently not on other machines, it seems that the underlying error in Singular is displayed as well. Any idea why?


---

Comment by jdemeyer created at 2012-03-19 09:02:25

Well, #10296 has several code paths to raise the exception.  In some cases, the singular error message is added, in other cases not.  I don't think this is a big deal.  I would be happy to solve this using "..."


---

Comment by SimonKing created at 2012-03-19 09:46:35

Replying to [comment:6 jdemeyer]:
> Well, #10296 has several code paths to raise the exception.  In some cases, the singular error message is added, in other cases not.  I don't think this is a big deal.  I would be happy to solve this using "..."

You mean these lines?

```diff
sage/interfaces/expect.py

diff --git a/sage/interfaces/expect.py b/sage/interfaces/expect.py

 	735	            elif restart_if_needed==True: # the subprocess might have crashed 
 	736	                try: 
 	737	                    self._synchronize() 
 	738	                    return self._post_process_from_file(self._eval_line_using_file(line, restart_if_needed=False)) 
 	739	                except RuntimeError, msg: 
 	740	                    raise RuntimeError, '%s terminated unexpectedly while reading in a large line:\n%s'%(self,msg[0]) 
 	741	                except TypeError: 
 	742	                    pass 
659	743	            raise RuntimeError, '%s terminated unexpectedly while reading in a large line'%self 
```

That would mean: On some machines Singular raises a `RuntimeError`, while in the same setting on `OpenSolaris` it is raising a `TypeError`. Odd.


---

Comment by SimonKing created at 2012-03-19 09:47:34

Replying to [comment:7 SimonKing]:
> That would mean: On some machines Singular raises a `RuntimeError`, while in the same setting on `OpenSolaris` it is raising a `TypeError`. Odd.

The other way around, I mean.


---

Attachment


---

Comment by jdemeyer created at 2012-03-26 19:10:52

Changing status from new to needs_review.


---

Comment by SimonKing created at 2012-03-27 06:31:28

I can not test on openSolaris. But just for the record: The patch looks ok to me, as we have seen that the only difference was what kind of error Singular raises.


---

Comment by jdemeyer created at 2012-03-27 15:50:44

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-03-27 15:50:44

Replying to [comment:10 SimonKing]:
> The patch looks ok to me, as we have seen that the only difference was what kind of error Singular raises.
So, positive_review then?


---

Comment by SimonKing created at 2012-03-27 18:26:03

Replying to [comment:11 jdemeyer]:
> Replying to [comment:10 SimonKing]:
> > The patch looks ok to me, as we have seen that the only difference was what kind of error Singular raises.
> So, positive_review then?

Well, I can not test on openSolaris. From that perspective, I am not entitled to review it. I can only say that it looks ok. If the build bot does not complain, it is a positive review.


---

Comment by jdemeyer created at 2012-03-28 10:06:54

Resolution: fixed
