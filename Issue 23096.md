# Issue 23096: Improve calculation of sigma invariants for projective morphisms

archive/issues_023096.json:
```json
{
    "body": "CC:  gjorgenson\n\nThe sigma invariants are the elementary symmetric functions evaluated at the multipliers. Currently they are computed over QQbar which can be very time consuming. They can be computed via resultants which is much faster and includes maps defined over polynomial rings.\n\nIssue created by migration from https://trac.sagemath.org/ticket/23333\n\n",
    "created_at": "2017-06-28T15:06:38Z",
    "labels": [
        "algebraic geometry",
        "minor",
        "enhancement"
    ],
    "title": "Improve calculation of sigma invariants for projective morphisms",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23096",
    "user": "bhutz"
}
```
CC:  gjorgenson

The sigma invariants are the elementary symmetric functions evaluated at the multipliers. Currently they are computed over QQbar which can be very time consuming. They can be computed via resultants which is much faster and includes maps defined over polynomial rings.

Issue created by migration from https://trac.sagemath.org/ticket/23333





---

archive/issue_comments_322932.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-06-28T15:11:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23096#issuecomment-322932",
    "user": "bhutz"
}
```

New commits:



---

archive/issue_comments_322933.json:
```json
{
    "body": "This is ready for a review.",
    "created_at": "2017-06-28T19:34:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23096#issuecomment-322933",
    "user": "bhutz"
}
```

This is ready for a review.



---

archive/issue_comments_322934.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-06-28T19:34:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23096#issuecomment-322934",
    "user": "bhutz"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_322935.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-06-28T19:43:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23096#issuecomment-322935",
    "user": "bhutz"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_322936.json:
```json
{
    "body": "err. I think the definition here is not right. There should be one multiplier per periodic point (with multiplicity), not one per cycle?",
    "created_at": "2017-06-28T19:43:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23096#issuecomment-322936",
    "user": "bhutz"
}
```

err. I think the definition here is not right. There should be one multiplier per periodic point (with multiplicity), not one per cycle?



---

archive/issue_comments_322937.json:
```json
{
    "body": "well, it seems both definitions are used in the world.\n\n- define the sigma using every period n point (McMullen, Silverman). Really they define it from the fixed points of the nth iterate.\n\n- define the sigma via cycles (Milnor)\n\nIn both cases they define invariants of the moduli space, so it's not that one is right or wrong, they are just different.  I'm tempted to introduce a 'type' parameter that takes values 'cycles' or 'points' to both this function and multiplier_spectrum.\n\n\nWhat do you think?",
    "created_at": "2017-06-28T20:10:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23096#issuecomment-322937",
    "user": "bhutz"
}
```

well, it seems both definitions are used in the world.

- define the sigma using every period n point (McMullen, Silverman). Really they define it from the fixed points of the nth iterate.

- define the sigma via cycles (Milnor)

In both cases they define invariants of the moduli space, so it's not that one is right or wrong, they are just different.  I'm tempted to introduce a 'type' parameter that takes values 'cycles' or 'points' to both this function and multiplier_spectrum.


What do you think?



---

archive/issue_comments_322938.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-06-28T21:29:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23096#issuecomment-322938",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_322939.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-06-28T21:30:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23096#issuecomment-322939",
    "user": "bhutz"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_322940.json:
```json
{
    "body": "I implemented it with the 'type' switch since both version appear in the literature.",
    "created_at": "2017-06-28T21:30:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23096#issuecomment-322940",
    "user": "bhutz"
}
```

I implemented it with the 'type' switch since both version appear in the literature.



---

archive/issue_comments_322941.json:
```json
{
    "body": "That seems good to me also. I'll get started on reviewing the functionality.",
    "created_at": "2017-06-28T21:41:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23096#issuecomment-322941",
    "user": "gjorgenson"
}
```

That seems good to me also. I'll get started on reviewing the functionality.



---

archive/issue_comments_322942.json:
```json
{
    "body": "Ok I looked this over and did some testing. The new method of computing the sigma invariants appears to be correct (and much nicer than the previous implementation!), and everything seems to be working properly. I only found a few really minor issues:\n\nIn sigma_invariants:\n- line 3725, multiplicity is spelled incorrectly (also occurs line 3565 in multiplier_spectra)\n- line 3750, add another space around the hyphen (also occurs line 3579)\n- line 3780, there is an extra newline\n- need an input check in place to make sure the base ring is (or has its coefficients in) a number field\n- perhaps put the \"type\" input check on line 3897 that can raise a value error with the other input checks at the beginning (same comment for multiplier_spectra)\n- it also might be good to add an example with formal=True illustrating the different options type='cycle', 'point'",
    "created_at": "2017-07-03T06:55:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23096#issuecomment-322942",
    "user": "gjorgenson"
}
```

Ok I looked this over and did some testing. The new method of computing the sigma invariants appears to be correct (and much nicer than the previous implementation!), and everything seems to be working properly. I only found a few really minor issues:

In sigma_invariants:
- line 3725, multiplicity is spelled incorrectly (also occurs line 3565 in multiplier_spectra)
- line 3750, add another space around the hyphen (also occurs line 3579)
- line 3780, there is an extra newline
- need an input check in place to make sure the base ring is (or has its coefficients in) a number field
- perhaps put the "type" input check on line 3897 that can raise a value error with the other input checks at the beginning (same comment for multiplier_spectra)
- it also might be good to add an example with formal=True illustrating the different options type='cycle', 'point'



---

archive/issue_comments_322943.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-05T16:53:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23096#issuecomment-322943",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_322944.json:
```json
{
    "body": "I think I fixed all those, so you can take another look.",
    "created_at": "2017-07-05T16:54:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23096#issuecomment-322944",
    "user": "bhutz"
}
```

I think I fixed all those, so you can take another look.



---

archive/issue_comments_322945.json:
```json
{
    "body": "Those changes look good. However I don't think the part of sigma_invariants that looks for a conjugation to avoid the point at infinity makes sense in positive characteristic:\n\n\n```\nsage: P.<x,y> = ProjectiveSpace(GF(3),1)\nsage: H = End(P)\nsage: f = H([x^2 - 2*y^2, y^2])\nsage: f.sigma_invariants(1)\nTraceback (click to the left of this block for traceback)\n...\nZeroDivisionError: Inverse does not exist.\n```\n\n\nWhen working over a finite field, if it is possible to construct a morphism P1-->P1 that has every point of P1 as a n-periodic point that seems like it could also be a problem.",
    "created_at": "2017-07-05T18:12:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23096#issuecomment-322945",
    "user": "gjorgenson"
}
```

Those changes look good. However I don't think the part of sigma_invariants that looks for a conjugation to avoid the point at infinity makes sense in positive characteristic:


```
sage: P.<x,y> = ProjectiveSpace(GF(3),1)
sage: H = End(P)
sage: f = H([x^2 - 2*y^2, y^2])
sage: f.sigma_invariants(1)
Traceback (click to the left of this block for traceback)
...
ZeroDivisionError: Inverse does not exist.
```


When working over a finite field, if it is possible to construct a morphism P1-->P1 that has every point of P1 as a n-periodic point that seems like it could also be a problem.



---

archive/issue_comments_322946.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-07-05T18:19:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23096#issuecomment-322946",
    "user": "bhutz"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_322947.json:
```json
{
    "body": "Good catch. I'll need to rethink how I deal with that case.",
    "created_at": "2017-07-05T18:19:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23096#issuecomment-322947",
    "user": "bhutz"
}
```

Good catch. I'll need to rethink how I deal with that case.



---

archive/issue_comments_322948.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-06T00:21:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23096#issuecomment-322948",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_322949.json:
```json
{
    "body": "ok. Here's another try at this. I'm no longer trying to move infinity out of the fixed points and instead am dealing with the multiplier at infinity and its multiplicities as a special case.\n\nInterestingly, it looks like this exposed an issue with one of the earlier examples and also an issue when there are cycles of different periods with the same multiplier.",
    "created_at": "2017-07-06T00:23:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23096#issuecomment-322949",
    "user": "bhutz"
}
```

ok. Here's another try at this. I'm no longer trying to move infinity out of the fixed points and instead am dealing with the multiplier at infinity and its multiplicities as a special case.

Interestingly, it looks like this exposed an issue with one of the earlier examples and also an issue when there are cycles of different periods with the same multiplier.



---

archive/issue_comments_322950.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-07-06T00:23:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23096#issuecomment-322950",
    "user": "bhutz"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_322951.json:
```json
{
    "body": "on further thought, I think this still fails to do the right thing where there are cycles of different length with the same multipliers.",
    "created_at": "2017-07-06T13:02:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23096#issuecomment-322951",
    "user": "bhutz"
}
```

on further thought, I think this still fails to do the right thing where there are cycles of different length with the same multipliers.



---

archive/issue_comments_322952.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-07-06T13:02:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23096#issuecomment-322952",
    "user": "bhutz"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_322953.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-06T18:12:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23096#issuecomment-322953",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_322954.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-07-06T18:16:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23096#issuecomment-322954",
    "user": "bhutz"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_322955.json:
```json
{
    "body": "I solved the cycle problem by building up the sigmas by divisor of n. Since the product of the dynatomic polys is the periodic point equation, this lets me assign a specific cycle length to each multiplier. Essentially it takes the formal period as the period. This has the advantage of being computable and always returns the same number of sigmas.",
    "created_at": "2017-07-06T18:16:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23096#issuecomment-322955",
    "user": "bhutz"
}
```

I solved the cycle problem by building up the sigmas by divisor of n. Since the product of the dynatomic polys is the periodic point equation, this lets me assign a specific cycle length to each multiplier. Essentially it takes the formal period as the period. This has the advantage of being computable and always returns the same number of sigmas.



---

archive/issue_comments_322956.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-07-09T05:36:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23096#issuecomment-322956",
    "user": "gjorgenson"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_322957.json:
```json
{
    "body": "The new type='cycle' functionality looks good to me. While looking over the code I noticed just a few more superficial issues:\n\n- line 3754: add period after \"Default: False\"\n- line 3962: there's an extra newline\n- the expressions of the form\n\n```\ne_inf = 1\nwhile (y**e_inf).divides(fix_poly):\n    e_inf += 1\ne_inf -= 1\n```\n\n   could be shortened slightly to\n\n```\ne_inf = 0\nwhile (y**(e_inf + 1)).divides(fix_poly):\n    e_inf += 1\n```\n\n- change the code starting on line 3956 from\n\n```\nres = fix_poly.resultant(mult_poly, S.gen(0)).univariate_polynomial()\n#take infinty into consideration\nif inf_per.divides(n):\n   res = res*((S.gen(1) - self.multiplier(inf, n)[0,0])**e_inf)\n   res = res.univariate_polynomial()\n```\n\n   to\n\n```\nres = fix_poly.resultant(mult_poly, S.gen(0))\n#take infinty into consideration\nif inf_per.divides(n):\n   res = res*((S.gen(1) - self.multiplier(inf, n)[0,0])**e_inf)\nres = res.univariate_polynomial()\n```\n\n   otherwise there is a weird multiplication issue:\n\n```\nsage: P.<x,y> = ProjectiveSpace(QQ,1)\nsage: H = End(P)\nsage: f = H([x^2 + x*y + y^2, y^2 + x*y])\nsage: f.sigma_invariants(1)\n```\n\n   The same issue occurs in the formal=True block version of this code starting at 3925. It looks like this actually always occurs with multiplication with elements of the original polynomial ring after calling .univariate_polynomial() for a constant polynomial:\n\n```\nsage: R.<s,t> = PolynomialRing(QQ, 2)\nsage: f = R(1)\nsage: f.univariate_polynomial()*t\n```\n\n   fails, but\n\n```\nsage: R.<s,t> = PolynomialRing(QQ, 2)\nsage: f = s\nsage: f.univariate_polynomial()*t\n```\n\n   is fine.\n- the lines of the form `res = res*((S.gen(1) - self.multiplier(inf, n)[0,0])**e_inf)`\n   could be rewritten `res *= (S.gen(1) - self.multiplier(inf, n)[0,0])**e_inf`",
    "created_at": "2017-07-09T05:36:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23096#issuecomment-322957",
    "user": "gjorgenson"
}
```

The new type='cycle' functionality looks good to me. While looking over the code I noticed just a few more superficial issues:

- line 3754: add period after "Default: False"
- line 3962: there's an extra newline
- the expressions of the form

```
e_inf = 1
while (y**e_inf).divides(fix_poly):
    e_inf += 1
e_inf -= 1
```

   could be shortened slightly to

```
e_inf = 0
while (y**(e_inf + 1)).divides(fix_poly):
    e_inf += 1
```

- change the code starting on line 3956 from

```
res = fix_poly.resultant(mult_poly, S.gen(0)).univariate_polynomial()
#take infinty into consideration
if inf_per.divides(n):
   res = res*((S.gen(1) - self.multiplier(inf, n)[0,0])**e_inf)
   res = res.univariate_polynomial()
```

   to

```
res = fix_poly.resultant(mult_poly, S.gen(0))
#take infinty into consideration
if inf_per.divides(n):
   res = res*((S.gen(1) - self.multiplier(inf, n)[0,0])**e_inf)
res = res.univariate_polynomial()
```

   otherwise there is a weird multiplication issue:

```
sage: P.<x,y> = ProjectiveSpace(QQ,1)
sage: H = End(P)
sage: f = H([x^2 + x*y + y^2, y^2 + x*y])
sage: f.sigma_invariants(1)
```

   The same issue occurs in the formal=True block version of this code starting at 3925. It looks like this actually always occurs with multiplication with elements of the original polynomial ring after calling .univariate_polynomial() for a constant polynomial:

```
sage: R.<s,t> = PolynomialRing(QQ, 2)
sage: f = R(1)
sage: f.univariate_polynomial()*t
```

   fails, but

```
sage: R.<s,t> = PolynomialRing(QQ, 2)
sage: f = s
sage: f.univariate_polynomial()*t
```

   is fine.
- the lines of the form `res = res*((S.gen(1) - self.multiplier(inf, n)[0,0])**e_inf)`
   could be rewritten `res *= (S.gen(1) - self.multiplier(inf, n)[0,0])**e_inf`



---

archive/issue_comments_322958.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-09T15:35:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23096#issuecomment-322958",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_322959.json:
```json
{
    "body": "Thanks. updated.\n\nThe issue with the univariate_polynomial of a constant is actually expected behavior. If you don't pass univeraite_polynomial a polynomial ring it creates it own. There is no reason it should be able to interact well with another polynomial ring. This is actually a little bit relevant to this ticket. In the new version I'm only calling univariate_polynomial once, so I don't rely anymore on Sage trying to 'do the right thing' in the background with multiplication of univariate and multivariate polynomial rings.",
    "created_at": "2017-07-09T15:41:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23096#issuecomment-322959",
    "user": "bhutz"
}
```

Thanks. updated.

The issue with the univariate_polynomial of a constant is actually expected behavior. If you don't pass univeraite_polynomial a polynomial ring it creates it own. There is no reason it should be able to interact well with another polynomial ring. This is actually a little bit relevant to this ticket. In the new version I'm only calling univariate_polynomial once, so I don't rely anymore on Sage trying to 'do the right thing' in the background with multiplication of univariate and multivariate polynomial rings.



---

archive/issue_comments_322960.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-07-09T15:41:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23096#issuecomment-322960",
    "user": "bhutz"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_322961.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-07-09T18:53:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23096#issuecomment-322961",
    "user": "gjorgenson"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_322962.json:
```json
{
    "body": "Ok that makes sense. With these new changes everything looks good to me.",
    "created_at": "2017-07-09T18:53:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23096#issuecomment-322962",
    "user": "gjorgenson"
}
```

Ok that makes sense. With these new changes everything looks good to me.



---

archive/issue_comments_322963.json:
```json
{
    "body": "Changing component from algebraic geometry to dynamics.",
    "created_at": "2017-07-21T19:37:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23096#issuecomment-322963",
    "user": "bhutz"
}
```

Changing component from algebraic geometry to dynamics.



---

archive/issue_comments_322964.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-08-03T22:11:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23096#issuecomment-322964",
    "user": "vbraun"
}
```

Resolution: fixed
