# Issue 30523: Implement parser for Sage

Issue created by migration from https://trac.sagemath.org/ticket/30760

Original creator: embray

Original creation time: 2020-10-13 14:13:11

CC:  @mwageringel slelievre

The Sage interpreter has its own language that is close to, but a slight extension of Python, including various transformations to how literals--particularly numeric literals--are to be interpreted (there is also the issue of automatic variables which traditionally was only implemented by the Sage Notebook REPL itself, rather than in Sage itself; see e.g. #21959).

The Sage preparser which converts Sage code to valid Python code is an unwieldy series of regular expressions and other ad-hoc string parsing and transformation code.  While it has been fairly stable over the years, it is difficult to maintain, especially when new syntax is added to Python (see #28974 and the difficulty of adding support for f-strings).

It would make the code much simpler and easier to understand, make it easier to respond to syntax changes in Python, and make it easier to evolve the Sage language (as a real language that is a superset of Python) by defining a formal grammar for it (again, as an extension of Python's grammar) and using a real lexer/parser in the Sage interpreter to convert code to ASTs, that can then be transformed into ASTs acceptable by Python's bytecode compiler.

This might be made easier by using Python's new PEG parser introduced in Python 3.9: https://www.python.org/dev/peps/pep-0617/  Though this does not necessarily mean making Sage dependent on Python 3.9, as we can generate our own parser using an existing third-party parser generator, or using the one that was written for Python and generates a C parser: https://github.com/python/cpython/tree/master/Tools/peg_generator

(If using this, one would also want to want to add a simple extension module providing an interface to the new parser, so it can be easily used by the Sage interpreter; there is example code for such an extension in the peg_generator package as well).

If it turns out extending the parser generator used by Python is infeasible, I believe Guido was also inspired by the [TatSu](https://pypi.org/project/TatSu/) parser generator; the current version of which requires Python 3.8, though earlier versions are Python 3.6+.

This would be a major task for anyone who want to take it on, though it would be an interesting project and I think highly valuable.


---

Comment by embray created at 2020-10-13 14:15:01

Another useful resource is Guido's blog series on implementing a PEG parser for Python: https://medium.com/`@`gvanrossum_83706/peg-parsing-series-de5d41b2ed60


---

Comment by embray created at 2020-10-14 10:56:58

Python's built-in tokenizer (whether the C version or the plain Python version) is not so easy to extend as I'd hoped either.  Would be nice to have an explicit listing somewhere of exactly what would be needed to support Sage.


---

Comment by @mwageringel created at 2020-10-14 18:37:16

Replying to [comment:3 embray]:
> Python's built-in tokenizer (whether the C version or the plain Python version) is not so easy to extend as I'd hoped either.

For tokenization, it might also be worth taking a look at [parso](https://github.com/davidhalter/parso/blob/master/parso/python/tokenize.py). Its tokenizer is adapted from the Python version, but has some improvements. In particular, it supports tokenizing f-strings (which Python handles in an ad-hoc manner in a later phase).


---

Comment by slelievre created at 2020-10-14 21:29:07

Changing keywords from "" to "parser, syntax".
