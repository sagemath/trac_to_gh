# Issue 31055: sage.features.StaticFile: Use pathlib, add type annotations

Issue created by migration from https://trac.sagemath.org/ticket/31292

Original creator: mkoeppe

Original creation time: 2021-01-25 18:54:52

CC:  @tobiasdiez chapoton slabbe mjo fbissey arojas tornaria

In particular, we change `absolute_path` to return a `Path`


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2022-03-01 20:15:04

Changing priority from minor to major.


---

Comment by mkoeppe created at 2022-03-01 22:56:14

Replying to [ticket:31292 mkoeppe]:
> In particular, we change `StaticFile.absolute_path` to return a `Path`.

Actually this would lead to errors like

```
File "src/sage/databases/cremona.py", line 1552, in sage.databases.cremona.LargeCremonaDatabase.degphi
Failed example:
    c = CremonaDatabase()
Exception raised:
...
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/databases/sql_db.py", line 1066, in __init__
        elif (filename[-3:] != '.db'):
    TypeError: 'PosixPath' object is not subscriptable
```



---

Comment by mkoeppe created at 2022-03-01 23:11:44

New commits:


---

Comment by git created at 2022-03-01 23:31:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-01 23:34:41

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-03-01 23:35:24

Changing status from new to needs_review.


---

Comment by git created at 2022-03-02 05:19:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-03-02 12:23:55

Replying to [comment:7 mkoeppe]:
> Replying to [ticket:31292 mkoeppe]:
> > In particular, we change `StaticFile.absolute_path` to return a `Path`.
> 
> Actually this would lead to errors like
> {{{
> File "src/sage/databases/cremona.py", line 1552, in sage.databases.cremona.LargeCremonaDatabase.degphi
> Failed example:
>     c = CremonaDatabase()
> Exception raised:
> ...
>       File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/databases/sql_db.py", line 1066, in __init__
>         elif (filename[-3:] != '.db'):
>     TypeError: 'PosixPath' object is not subscriptable
> }}}

This is to be expected, since it's a path and not a string that you work with. The extension can easily be obtained using the suffix method: https://docs.python.org/3/library/pathlib.html#pathlib.PurePath.suffixes


---

Comment by @tobiasdiez created at 2022-03-02 12:26:25

Replying to [comment:9 mkoeppe]:
>  Summary changed from sage.features.StaticFile, Executable: Use pathlib, add type annotations to sage.features.Executable: Add method absolute_path 

This completely changes the scope of this ticket whose original intention was to migrate sage.features.absolute_path to return `Path`.


---

Comment by @tobiasdiez created at 2022-03-02 12:27:53


```
def absolute_path(self) -> str:
```

why not make this return a `pathlib.Path`?


---

Comment by @tobiasdiez created at 2022-03-02 12:28:20


```
reason="Executable {executable!r} not found on PATH.".format(executable=self.executable),
```

use f-strings.


---

Comment by @tobiasdiez created at 2022-03-02 12:28:49

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2022-03-02 16:12:00

Replying to [comment:16 gh-tobiasdiez]:
> {{{
> def absolute_path(self) -> str:
> }}}
> why not make this return a `pathlib.Path`?

Because that breaks the public API.


---

Comment by mkoeppe created at 2022-03-02 16:12:53

Replying to [comment:15 gh-tobiasdiez]:
> Replying to [comment:9 mkoeppe]:
> >  Summary changed from sage.features.StaticFile, Executable: Use pathlib, add type annotations to sage.features.Executable: Add method absolute_path 
> 
> This completely changes the scope of this ticket whose original intention was to migrate sage.features.absolute_path to return `Path`.

Yes, when I wrote this ticket I thought that could be done compatibly, but it can't


---

Comment by mkoeppe created at 2022-03-02 16:13:46

Replying to [comment:17 gh-tobiasdiez]:
> use f-strings.

`.format` is not deprecated or anything.


---

Comment by mkoeppe created at 2022-03-02 16:13:52

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2022-03-02 16:17:27

Changing status from needs_review to needs_work.


---

Comment by @tobiasdiez created at 2022-03-02 16:17:27

Replying to [comment:20 mkoeppe]:
> Replying to [comment:15 gh-tobiasdiez]:
> > Replying to [comment:9 mkoeppe]:
> > >  Summary changed from sage.features.StaticFile, Executable: Use pathlib, add type annotations to sage.features.Executable: Add method absolute_path 
> > 
> > This completely changes the scope of this ticket whose original intention was to migrate sage.features.absolute_path to return `Path`.
> 
> Yes, when I wrote this ticket I thought that could be done compatibly, but it can't

Then just introduce a new method, and deprecate the old one.


---

Comment by @tobiasdiez created at 2022-03-02 16:19:12

Replying to [comment:21 mkoeppe]:
> Replying to [comment:17 gh-tobiasdiez]:
> > use f-strings.
> 
> `.format` is not deprecated or anything.

That's right, but f-strings are still easier to read.


---

Comment by mkoeppe created at 2022-03-02 16:50:04

Replying to [comment:23 gh-tobiasdiez]:
> Then just introduce a new method, and deprecate the old one.

I was in the middle of doing this but couldn't come up with a name for the new method, given that the good name, `absolute_path`, is already taken. Suggestions?


---

Comment by mkoeppe created at 2022-03-02 16:51:32

Replying to [comment:24 gh-tobiasdiez]:
> That's right, but f-strings are still easier to read.

I like f-strings too, but in the interest of focus I don't change everything that can be changed. This line of code is copied from a place in the same file.


---

Comment by git created at 2022-03-03 02:20:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-03 02:50:52

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2022-03-04 12:07:26

Changing status from needs_review to needs_work.


---

Comment by @tobiasdiez created at 2022-03-04 12:07:26


```
EXAMPLES::
        sage: from sage.features import StaticFile, Executable, FileFeature
        sage: issubclass(StaticFile, FileFeature)
        True
        sage: issubclass(Executable, FileFeature)
        True
```

Please replace this by a meaningful doctest that actually shows how to use the class.

In FileFeature.absolute_path you call `self.absolute_filename` which doesn't exist. So this should be added at least as an abstract method.


```
try:
            from sage.misc.superseded import deprecation
        except ImportError:
            pass
        deprecation(31292, 'method absolute_path has been replaced by absolute_filename')
```

That looks like a strange construction. Why should the import of the deprecation fail? But even if it fails the call of `deprecation` will throw another error as its not defined then.


---

Comment by git created at 2022-03-04 17:51:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-04 17:53:28

Replying to [comment:31 gh-tobiasdiez]:
> {{{
> try:
>             from sage.misc.superseded import deprecation
>         except ImportError:
>             pass
>         deprecation(31292, 'method absolute_path has been replaced by absolute_filename')
> }}}
> That looks like a strange construction. Why should the import of the deprecation fail? 

Because #29941 puts `sage.features` into a distribution *sagemath-environment*, which does not install-requires *sagemath-objects*, which provides `sage.misc.superseded`.

> But even if it fails the call of `deprecation` will throw another error as its not defined then.

Thanks, forgot the `else:`, fixed now.


---

Comment by mkoeppe created at 2022-03-04 17:57:24

Replying to [comment:31 gh-tobiasdiez]:
> In FileFeature.absolute_path you call `self.absolute_filename` which doesn't exist. So this should be added at least as an abstract method.

Avoiding use of `sage.misc.abstract_method` for the same modularization reason.
I'll not start using https://docs.python.org/3/library/abc.html here for this purpose.

I can make an ad-hoc abstract method that just raises a `NotImplementedError`


---

Comment by git created at 2022-03-04 18:34:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-04 18:36:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-04 18:47:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-04 18:47:56

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-03-04 18:47:56

Replying to [comment:31 gh-tobiasdiez]:
> Please replace this by a meaningful doctest that actually shows how to use the class.

Done now


---

Comment by git created at 2022-03-04 20:44:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-03-05 22:18:41

Changing status from needs_review to needs_work.


---

Comment by @tobiasdiez created at 2022-03-05 22:18:41

Thanks for the follow-up!

One last comment, otherwise it looks good to me:
The docs for absolute_filename in FileFeature now still refers to "executable", which should be replaced by "feature".


---

Comment by @tobiasdiez created at 2022-03-05 22:21:59

By the way, do the inheriting classes (Executable and StaticFile) really need to provide docstrings? Sphinx should copy them from the base class or not?


---

Comment by git created at 2022-03-05 22:28:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-05 22:29:19

Replying to [comment:41 gh-tobiasdiez]:
> By the way, do the inheriting classes (Executable and StaticFile) really need to provide docstrings?

Yes, per our style guide.


---

Comment by mkoeppe created at 2022-03-05 22:29:25

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2022-03-06 09:10:05

Replying to [comment:43 mkoeppe]:
> Replying to [comment:41 gh-tobiasdiez]:
> > By the way, do the inheriting classes (Executable and StaticFile) really need to provide docstrings?
> 
> Yes, per our style guide.
> 

What is the reason behind this requirement/convention?


---

Comment by @tobiasdiez created at 2022-03-06 09:10:22

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-03-06 16:49:18

Thanks for reviewing!


---

Comment by mkoeppe created at 2022-03-06 16:52:31

Replying to [comment:45 gh-tobiasdiez]:
> What is the reason behind this requirement/convention?

It was already there when I started Sage dev. It's a bit annoying at times and leads to a lot of copy+paste, but it does force people to write doctests. And having the policy scales better than renegotiating the style with every new developer.


---

Comment by vbraun created at 2022-03-09 23:38:30

Resolution: fixed
