# Issue 10017: Unhandled SIGSEGV after bnfcertify()

Issue created by migration from https://trac.sagemath.org/ticket/10018

Original creator: jdemeyer

Original creation time: 2010-09-26 11:49:57

Assignee: tba

CC:  leif

Keywords: segfault segmentation fault bnfcertify

Do the following in Sage:

```
sage: K.<z> = CyclotomicField(23); bnf=K.pari_bnf(certify=False)
sage: bnf.bnfcertify()
```

After typing the second line `bnf.bnfcertify()`, hit CTRL-c after 10 seconds or so. It will take a long time before the interrupt registers, but eventually a KeyboardInterrupt will show up.  However, something is wrong after this KeyboardInterrupt, because typing

```
K.<z> = CyclotomicField(23)
```

immediately gives the dreaded

```
------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred in Sage.
This probably occurred because a *compiled* component
of Sage has a bug in it (typically accessing invalid memory)
or is not properly wrapped with _sig_on, _sig_off.
You might want to run Sage under gdb with 'sage -gdb' to debug this.
Sage will now terminate (sorry).
------------------------------------------------------------
```



---

Comment by jdemeyer created at 2010-09-26 12:11:30

Changing keywords from "segfault segmentation fault bnfcertify" to "segfault segmentation fault bnfcertify allocatemem".


---

Comment by jdemeyer created at 2010-09-26 12:11:30

This might be a bug with the handling of `allocatemem()` in PARI.  The same computation in `gp` gives:

```
bash$ sage -gp --fast --stacksize=10000000
                                      GP/PARI CALCULATOR Version 2.4.3 (development svn-12577:12605)
                                       amd64 running linux (x86-64/GMP-4.2.1 kernel) 64-bit version
                                     compiled: Sep 24 2010, gcc-4.6.0 20100705 (experimental) (GCC)
                                              (readline v6.0 enabled, extended help enabled)

                                                  Copyright (C) 2000-2008 The PARI Group

PARI/GP is free software, covered by the GNU General Public License, and comes WITHOUT ANY WARRANTY WHATSOEVER.

Type ? for help, \q to quit.
Type ?12 for how to get moral (and possibly technical) support.

parisize = 10000000, primelimit = 500509
? bnf = bnfinit(polcyclo(23));
? bnfcertify(bnf)
  ***   at top-level: bnfcertify(bnf)
  ***                 ^---------------
  *** bnfcertify: the PARI stack overflows !
  current stack size: 10000000 (9.537 Mbytes)
  [hint] you can increase GP stack with allocatemem()

  ***   Break loop: type 'break' to go back to GP
break>
```



---

Comment by jdemeyer created at 2010-09-27 09:02:30

Changing keywords from "segfault segmentation fault bnfcertify allocatemem" to "segfault segmentation fault allocatemem interrupt _sig_on _sig_retry".


---

Comment by leif created at 2010-09-27 09:57:29

A good place to also add some more case distinctions on PARI's `errnum`... ;-)


---

Comment by jdemeyer created at 2010-09-27 10:55:20

Replying to [comment:7 leif]:
> A good place to also add some more case distinctions on PARI's `errnum`... ;-)

This is planned for #9640 (in the not-so-near future though).


---

Comment by jdemeyer created at 2010-09-27 11:09:16

Changing assignee from tba to jdemeyer.


---

Comment by jdemeyer created at 2010-09-27 11:23:48

Apply on top of #9898


---

Attachment

Replying to [comment:8 jdemeyer]:
> Replying to [comment:7 leif]:
> > A good place to also add some more case distinctions on PARI's `errnum`... ;-)
> 
> This is planned for #9640 (in the not-so-near future though).

Ok. I thought of just adding number 5 (`talker`?) here, mapping it to `ValueError`, which comes nearest (could also be `TypeError` (domain) or `RangeError` etc.).


---

Comment by leif created at 2010-09-27 12:02:37

... because of #9640 _"not-so-near future"_.


---

Comment by jdemeyer created at 2010-09-27 12:56:39

Replying to [comment:10 leif]:
> Ok. I thought of just adding number 5 (`talker`?) here, mapping it to `ValueError`, which comes nearest (could also be `TypeError` (domain) or `RangeError` etc.). 

I think it is good that now all errors thrown by PARI are of the type `PariError`.  If you want to raise a different exception, I think it should be done by higher-level code, like:


```
try:
    # do something with PARI
except PariError, err:
    if err.errnum() == talker:
        raise ValueError
    raise err
```


(this currently only works with Cython because `talker` is defined in a PARI C header).


---

Comment by leif created at 2010-09-27 13:15:18

Replying to [comment:12 jdemeyer]:
> (this currently only works with Cython because `talker` is defined in a PARI C header).

... and would require changing much more code. ;-)

The actual error message should be `vsnprintf()`'ed into a buffer (upstream) such that we can also propagate the real cause.


---

Comment by jdemeyer created at 2010-09-27 13:24:28

Replying to [comment:13 leif]:
> The actual error message should be `vsnprintf()`'ed into a buffer (upstream) such that we can also propagate the real cause.

That is more or less the idea of #9640.

But I also noticed that the whole exception-catching mechanism can be vastly improved (for example, now there is a general signal-handling facility in Sage and a specific error-handling facility for PARI which should be merged into one system).  Also, there is essentially no testing code for this Cython error handling.  Good testing code should have caught #10018.  All this should eventually be in #9678.


---

Comment by leif created at 2010-09-27 13:29:57

Replying to [comment:13 leif]:
> The actual error message should be `vsnprintf()`'ed into a buffer (upstream) such that we can also propagate the real cause.

I added the following in `src/language/init.c` to debug PARI:

```C
void
pari_err(int numerr, ...)
{
  PariOUT *out = pariOut;
  va_list ap;

  va_start(ap,numerr);

  if (numerr==talker) /* added part */
  {
    va_list ap2;
    const char *fmt;

    va_copy(ap2,ap);
    fmt=(char*)va_arg(ap2,char*);

    vfprintf(stderr,fmt,ap2); /* we can equally well write into a global buffer here */
    fflush(stderr);           /* with vsnprintf() to propagate the error message */
  }

  ...
```



---

Comment by leif created at 2010-09-27 14:34:12

I actually added some more `printf()`s:

```C
    ...
    fprintf(stderr,
      "\n******************** PARI ERROR: ********************\n");
    vfprintf(stderr,fmt,ap2);
    fprintf(stderr,
      "\n*****************************************************\n");
    fflush(stderr);
    ...
```


Of course a temporary hack (and a bit odd in the interpreter), but an improvement to just

```
      File "gen.pyx", line 9460, in sage.libs.pari.gen._pari_trap (sage/libs/pari/gen.c:45047)
    PariError:  (5)
```

and trivial enough s.t. it could be merged without any risk. ;-)

(PARI's messages of course aren't always that informative without examining the stack.)


---

Comment by jdemeyer created at 2010-09-27 21:16:01

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2010-09-27 21:16:01

With `10018_sig_retry.patch`, all long doctests pass on a 32-bit PPC OS X 10.4, now testing on `sage.math.washington.edu` (64-bit Intel Linux).

I also tried very hard to break things in PARI using many different combinations of pari.allocatemem(), other PARI functions and CTRL-C and I did not manage :-)


---

Comment by jdemeyer created at 2010-09-28 13:06:39

Changing keywords from "segfault segmentation fault allocatemem interrupt _sig_on _sig_retry" to "pari segfault segmentation fault allocatemem interrupt _sig_on _sig_retry".


---

Comment by jdemeyer created at 2010-10-13 13:27:21

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2010-10-13 13:27:21

Probably this will be absorbed by #9678.


---

Comment by jdemeyer created at 2010-10-17 18:43:33

Changing keywords from "pari segfault segmentation fault allocatemem interrupt _sig_on _sig_retry" to "pari segfault segmentation fault allocatemem interrupt sig_on sig_retry".


---

Attachment

New patch, ignore previous


---

Comment by johanbosman created at 2011-11-12 17:23:49

I cannot reproduce this bug.  Has it been fixed in another ticket?


---

Comment by itaibn created at 2013-09-08 13:27:37

I tried and I also can't reproduce it. The comments mention #9678 which may have fixed it. I suggest figuring out how this bug was fixed before closing it.


---

Comment by pbruin created at 2013-09-09 18:55:48

Changing status from needs_work to needs_info.


---

Comment by pbruin created at 2013-09-09 18:55:48

I can't reproduce it either.  I don't really see the point of trying to find out why this bug existed, since #9678 essentially rewrote the whole error-handling code.

What is the status of [attachment:10018_pari_sig_retry.patch]?  Assuming that this bug has indeed disappeared, is the patch still relevant for the general plan to improve the PARI error handling mechanism (cf. #9640, #14894)?


---

Comment by itaibn created at 2013-09-11 22:47:45

#9678 changed a lot of the error-handling code, but it doesn't seem to make any changes to Pari. That's why I'm cautious. That said, I notice that both of these patches are by jdemeyer. He probably understands how these changes interact and if he abandoned this it's probably safe to close this.

Also, attachment:10018_pari_sig_retry.patch looks like it's many changing the memory management in Pari, while the tickets you mention look like they're about the interaction between error management in sage and in pari. They seem unrelated.


---

Comment by jdemeyer created at 2013-09-12 00:20:13

I don't have much time to think of this now, but [attachment:10018_pari_sig_retry.patchâ€‹] is indeed changing the PARI error handling mechanism. Let's first look at #9640 and then at this patch.


---

Comment by jdemeyer created at 2013-11-01 22:52:51

Changing status from needs_info to needs_work.


---

Comment by jdemeyer created at 2013-11-01 22:52:51

Changing keywords from "pari segfault segmentation fault allocatemem interrupt sig_on sig_retry" to "pari init_stack".


---

Comment by jdemeyer created at 2013-11-02 11:07:01

Changing priority from critical to minor.


---

Comment by jdemeyer created at 2013-11-02 11:17:11

Changing status from needs_work to needs_review.


---

Attachment


---

Comment by pbruin created at 2013-11-04 12:06:56

Changing status from needs_review to positive_review.


---

Comment by pbruin created at 2013-11-04 12:06:56

This looks good, it passes doctests, and I agree with the deprecation of `init_pari_stack()`.


---

Comment by jdemeyer created at 2013-11-22 15:49:00

Resolution: fixed
