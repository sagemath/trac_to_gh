# Issue 17091: incomplete gamma in integral is wrong

Issue created by migration from https://trac.sagemath.org/ticket/17328

Original creator: kcrisman

Original creation time: 2014-11-12 21:14:19

CC:  rws

See [this sage-support thread](https://groups.google.com/forum/#!topic/sage-support/lGGO_q_NVzg) for details.


```
sage: N(integral(1/log(x)^2,(x,2,3)))
0.536566859259958  # quite wrong
sage: integral(1/(ln(x))^2, x,2,3)
gamma(-1, -log(3)) - gamma(-1, -log(2))
```

We get the antiderivative and answer from Maxima, which evaluates this correctly numerically.

```
 (%i1) display2d : false $ 
  (%i2) foo : 1/log(x)^2 $ 
  (%i3) integrate (foo, x, 2, 3); 
  (%o3) gamma_incomplete(-1,-log(3))-gamma_incomplete(-1,-log(2)) 
  (%i4) %, numer; 
  (%o4) 1.273097216447114 
  (%i5) integrate (foo, x); 
  (%o5) gamma_incomplete(-1,-log(x)) 
  (%i6) ev (%, x=3) - ev (%, x=2); 
  (%o6) gamma_incomplete(-1,-log(3))-gamma_incomplete(-1,-log(2)) 
  (%i7) %, numer; 
  (%o7) 1.273097216447114 
```


See in particular this ugly plot.

```
sage: plot(lambda t: numerical_integral(1/ln(x)^2,2,t)[0],2,3)+plot(lambda t: gamma(-1, -log(t)).real(),2,3,color='red')
```

And even that we have to call `real()` to remove the numerical noise is not good...

See possibly also [here](https://groups.google.com/forum/#!topic/sage-support/RrveCpPgoKU) and [here](https://groups.google.com/forum/#!topic/sage-support/RD3YH3jb3qo) and possibly even #16697.


---

Comment by kcrisman created at 2014-11-14 21:08:37

Possibly - even likely - related is #11164.


---

Comment by pbruin created at 2014-11-14 22:08:36

I can't seem to reproduce this in Sage 6.4:

```
sage: numerical_integral(1/log(x)^2,2,3)
(1.273097216447114, 1.4134218422857824e-14)
sage: N(integral(1/log(x)^2,(x,2,3)))
1.27309721644711
```

In fact, the incomplete gamma function is evaluated using PARI, and the bug appears to have been fixed by the latest PARI upgrade (see #15767):

```
gp-2.5 > incgam(-1,-1)
%1 = -1.5817775437849803404714887501837998073
gp-2.5 > incgam(-1,-log(3)) - incgam(-1,-log(2))
%2 = 0.54869101686030432559293241097969276965

gp-2.7 > incgam(-1,-1)
%1 = -0.82316401210310847989376653702102822882 + 3.1415926535897932384626433832795028842*I
gp-2.7 > incgam(-1,-log(3)) - incgam(-1,-log(2))
%2 = 1.2730972164471138219094623429485715030 + 0.E-37*I
```



---

Comment by kcrisman created at 2014-11-15 02:58:05

Interesting and confirmed.  Of course, possibly due to something completely different, we now have

```
sage: plot(lambda t: gamma(-1, -log(t)),2,3,color='red')
AttributeError: type object 'float' has no attribute 'precision'
```

as opposed to a wacky plot, no plot.


---

Comment by pbruin created at 2014-11-15 11:24:23

Replying to [comment:4 kcrisman]:
> Interesting and confirmed.  Of course, possibly due to something completely different, we now have
> {{{
> sage: plot(lambda t: gamma(-1, -log(t)),2,3,color='red')
> AttributeError: type object 'float' has no attribute 'precision'
> }}}
> as opposed to a wacky plot, no plot.
That is because of a patch I made at #7099; it assumed that the parent had a `precision()` method (previously the precision was ignored when converting the arguments into a `ComplexField`).  I will fix this as soon as I have time.

We should also add a doctest for the original bug.


---

Comment by pbruin created at 2014-11-17 12:00:58

Changing priority from critical to major.


---

Comment by pbruin created at 2014-11-17 12:00:58

Changing status from new to needs_review.


---

Comment by pbruin created at 2014-11-17 12:03:45

Replying to [comment:4 kcrisman]:
> Interesting and confirmed.  Of course, possibly due to something completely different, we now have
> {{{
> sage: plot(lambda t: gamma(-1, -log(t)),2,3,color='red')
> AttributeError: type object 'float' has no attribute 'precision'
> }}}
> as opposed to a wacky plot, no plot.
It would be good if you (or someone else) could try plotting this with the above patch and check if it looks good to you.


---

Comment by pbruin created at 2014-11-17 12:03:45

Changing keywords from "" to "incomplete gamma function".


---

Comment by kcrisman created at 2014-11-17 14:54:41

Seems to give correct answers in various precisions.

```
plot(lambda t: gamma(-1, -log(t)).real() - numerical_integral(1/ln(x)^2,2,t)[0],2,3,color='red')
```

is a very nice straight line _just_ below zero now.   And the imaginary part seems to be consistently pi for t>1.  And the fix is a good one.
> We should also add a doctest for the original bug.
Did you want to add 

```
N(integral(1/log(x)^2,(x,2,3)))
```

as well then, or is the example you have with the actual antideriv and floats sufficient?


---

Comment by kcrisman created at 2014-11-17 16:07:06

Passes relevant tests, so other than that question we're good to go.


---

Comment by pbruin created at 2014-11-17 19:27:44

Replying to [comment:8 kcrisman]:
> Seems to give correct answers in various precisions.
> {{{
> plot(lambda t: gamma(-1, -log(t)).real() - numerical_integral(1/ln(x)^2,2,t)[0],2,3,color='red')
> }}}
> is a very nice straight line _just_ below zero now.   And the imaginary part seems to be consistently pi for t>1.  And the fix is a good one.
OK, thanks!
> > We should also add a doctest for the original bug.
> Did you want to add 
> {{{
> N(integral(1/log(x)^2,(x,2,3)))
> }}}
> as well then, or is the example you have with the actual antideriv and floats sufficient?
I don't think it is necessary to add another doctest for the integral; this would just test in addition that Maxima computes the correct antiderivative.  Of course the above command was how the bug was originally found, but I don't really see why we should doctest exactly that command.  What I meant to say is "add a doctest to show that the PARI bug has been fixed".


---

Comment by kcrisman created at 2014-11-17 21:54:40

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-11-19 08:32:10

Resolution: fixed


---

Comment by jdemeyer created at 2014-11-26 08:18:51

Just to let you know: I already had a patch for this at #17130, so the code of this patch will be overwritten again in #17130. I noticed this ticket only now because of a merge conflict.
