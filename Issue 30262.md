# Issue 30262: deepcopy() fails for lift_map from residue field of a number field

archive/issues_030262.json:
```json
{
    "body": "CC:  @pjbruin @mjungmath\n\nKeywords: deepcopy, lift_map\n\nIn sage 9.2 & 9.0 deepcopying the lift_map from a residue field at a prime does not finish because of recursion error\n\n\n```\nsage: R.<x> = ZZ[]\nsage: f = x^2-2\nsage: K.<a> = NumberField(f)\nsage: P = K(2).factor()[0][0]\nsage: F = K.residue_field(P)\nsage: m = F.lift_map()\nsage: deepcopy(m)\n```\n\ngives\n\n\n```\n---------------------------------------------------------------------------\nRecursionError                            Traceback (most recent call last)\n<ipython-input-26-c84bb92e2658> in <module>()\n----> 1 deepcopy(m)\n\n/home/sage/sage/local/lib/python3.7/copy.py in deepcopy(x, memo, _nil)\n    178                     y = x\n    179                 else:\n--> 180                     y = _reconstruct(x, memo, *rv)\n    181\n    182     # If is its own copy, don't memoize.\n\n/home/sage/sage/local/lib/python3.7/copy.py in _reconstruct(x, memo, func, args, state, listiter, dictiter, deepcopy)\n    272     if deep and args:\n    273         args = (deepcopy(arg, memo) for arg in args)\n--> 274     y = func(*args)\n    275     if deep:\n    276         memo[id(x)] = y\n\n/home/sage/sage/local/lib/python3.7/copy.py in <genexpr>(.0)\n    271     deep = memo is not None\n    272     if deep and args:\n--> 273         args = (deepcopy(arg, memo) for arg in args)\n    274     y = func(*args)\n    275     if deep:\n\n/home/sage/sage/local/lib/python3.7/copy.py in deepcopy(x, memo, _nil)\n    148     copier = _deepcopy_dispatch.get(cls)\n    149     if copier:\n--> 150         y = copier(x, memo)\n    151     else:\n    152         try:\n\n/home/sage/sage/local/lib/python3.7/copy.py in _deepcopy_dict(x, memo, deepcopy)\n    238     memo[id(x)] = y\n    239     for key, value in x.items():\n--> 240         y[deepcopy(key, memo)] = deepcopy(value, memo)\n    241     return y\n    242 d[dict] = _deepcopy_dict\n\n... last 5 frames repeated, from the frame below ...\n\n/home/sage/sage/local/lib/python3.7/copy.py in deepcopy(x, memo, _nil)\n    178                     y = x\n    179                 else:\n--> 180                     y = _reconstruct(x, memo, *rv)\n    181\n    182     # If is its own copy, don't memoize.\n\nRecursionError: maximum recursion depth exceeded in comparison\n```\n\n\nand doing the following causes a segfault and crashes Sage\n\n```\nsage: sys.setrecursionlimit(2**30)\nsage: deepcopy(m)\n{{{\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/30499\n\n",
    "created_at": "2020-09-03T18:39:42Z",
    "labels": [
        "number theory",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "deepcopy() fails for lift_map from residue field of a number field",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30262",
    "user": "@walnutmonster"
}
```
CC:  @pjbruin @mjungmath

Keywords: deepcopy, lift_map

In sage 9.2 & 9.0 deepcopying the lift_map from a residue field at a prime does not finish because of recursion error


```
sage: R.<x> = ZZ[]
sage: f = x^2-2
sage: K.<a> = NumberField(f)
sage: P = K(2).factor()[0][0]
sage: F = K.residue_field(P)
sage: m = F.lift_map()
sage: deepcopy(m)
```

gives


```
---------------------------------------------------------------------------
RecursionError                            Traceback (most recent call last)
<ipython-input-26-c84bb92e2658> in <module>()
----> 1 deepcopy(m)

/home/sage/sage/local/lib/python3.7/copy.py in deepcopy(x, memo, _nil)
    178                     y = x
    179                 else:
--> 180                     y = _reconstruct(x, memo, *rv)
    181
    182     # If is its own copy, don't memoize.

/home/sage/sage/local/lib/python3.7/copy.py in _reconstruct(x, memo, func, args, state, listiter, dictiter, deepcopy)
    272     if deep and args:
    273         args = (deepcopy(arg, memo) for arg in args)
--> 274     y = func(*args)
    275     if deep:
    276         memo[id(x)] = y

/home/sage/sage/local/lib/python3.7/copy.py in <genexpr>(.0)
    271     deep = memo is not None
    272     if deep and args:
--> 273         args = (deepcopy(arg, memo) for arg in args)
    274     y = func(*args)
    275     if deep:

/home/sage/sage/local/lib/python3.7/copy.py in deepcopy(x, memo, _nil)
    148     copier = _deepcopy_dispatch.get(cls)
    149     if copier:
--> 150         y = copier(x, memo)
    151     else:
    152         try:

/home/sage/sage/local/lib/python3.7/copy.py in _deepcopy_dict(x, memo, deepcopy)
    238     memo[id(x)] = y
    239     for key, value in x.items():
--> 240         y[deepcopy(key, memo)] = deepcopy(value, memo)
    241     return y
    242 d[dict] = _deepcopy_dict

... last 5 frames repeated, from the frame below ...

/home/sage/sage/local/lib/python3.7/copy.py in deepcopy(x, memo, _nil)
    178                     y = x
    179                 else:
--> 180                     y = _reconstruct(x, memo, *rv)
    181
    182     # If is its own copy, don't memoize.

RecursionError: maximum recursion depth exceeded in comparison
```


and doing the following causes a segfault and crashes Sage

```
sage: sys.setrecursionlimit(2**30)
sage: deepcopy(m)
{{{



Issue created by migration from https://trac.sagemath.org/ticket/30499





---

archive/issue_comments_431505.json:
```json
{
    "body": "I don't think the `deepcopy` protocol is implemented for Sage objects. Most Sage objects are immutable.",
    "created_at": "2020-09-04T17:34:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30262#issuecomment-431505",
    "user": "@mkoeppe"
}
```

I don't think the `deepcopy` protocol is implemented for Sage objects. Most Sage objects are immutable.



---

archive/issue_comments_431506.json:
```json
{
    "body": "Moving this ticket to 9.4, as it seems unlikely that it will be merged in 9.3, which is in the release candidate stage",
    "created_at": "2021-04-02T20:21:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30262#issuecomment-431506",
    "user": "@mkoeppe"
}
```

Moving this ticket to 9.4, as it seems unlikely that it will be merged in 9.3, which is in the release candidate stage



---

archive/issue_comments_431507.json:
```json
{
    "body": "This will be fixed in #32478",
    "created_at": "2021-09-06T05:52:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30262#issuecomment-431507",
    "user": "@mkoeppe"
}
```

This will be fixed in #32478



---

archive/issue_comments_431508.json:
```json
{
    "body": "Replying to [comment:6 mkoeppe]:\n> This will be fixed in #32478\n... actually no",
    "created_at": "2021-09-09T21:39:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30262#issuecomment-431508",
    "user": "@mkoeppe"
}
```

Replying to [comment:6 mkoeppe]:
> This will be fixed in #32478
... actually no
