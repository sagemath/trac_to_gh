# Issue 20024: Coercion of 0 in cyclotomic field fails

archive/issues_020024.json:
```json
{
    "body": "CC:  @bhutz @fchapoton @JohnCremona @jdemeyer @kedlaya @mezzarobba @nbruin @slel @tscrim @videlec\n\nIn some cases the element 0 of one cyclotomic field can not be coerced properly to 0 in another cyclotomic field.\nFor instance tested in Sage 7.1: \nsage: K1=CyclotomicField(12)\nsage: K2=CyclotomicField(6)\nsage: K1(K2(0))\n0\nsage: K2(K1(0))\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n...\nTypeError: unable to coerce <class 'sage.rings.infinity.PlusInfinity'> to an integer\n\nIssue created by migration from https://trac.sagemath.org/ticket/20261\n\n",
    "created_at": "2016-03-23T13:58:30Z",
    "labels": [
        "component: coercion",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.3",
    "title": "Coercion of 0 in cyclotomic field fails",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20024",
    "user": "https://github.com/fredstro"
}
```
CC:  @bhutz @fchapoton @JohnCremona @jdemeyer @kedlaya @mezzarobba @nbruin @slel @tscrim @videlec

In some cases the element 0 of one cyclotomic field can not be coerced properly to 0 in another cyclotomic field.
For instance tested in Sage 7.1: 
sage: K1=CyclotomicField(12)
sage: K2=CyclotomicField(6)
sage: K1(K2(0))
0
sage: K2(K1(0))
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
...
TypeError: unable to coerce <class 'sage.rings.infinity.PlusInfinity'> to an integer

Issue created by migration from https://trac.sagemath.org/ticket/20261





---

archive/issue_comments_275548.json:
```json
{
    "body": "Changing keywords from \"\" to \"cyclotomic\".",
    "created_at": "2016-05-19T08:11:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20024#issuecomment-275548",
    "user": "https://github.com/slel"
}
```

Changing keywords from "" to "cyclotomic".



---

archive/issue_comments_275549.json:
```json
{
    "body": "Fix code typesetting in ticket description. Cc cyclotomic-interested people.",
    "created_at": "2016-05-19T08:11:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20024#issuecomment-275549",
    "user": "https://github.com/slel"
}
```

Fix code typesetting in ticket description. Cc cyclotomic-interested people.



---

archive/issue_comments_275550.json:
```json
{
    "body": "See related #20513 which I am currently testing.  I'll see if it fixes this too, and if so this could be closed.",
    "created_at": "2016-05-19T09:51:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20024#issuecomment-275550",
    "user": "https://github.com/JohnCremona"
}
```

See related #20513 which I am currently testing.  I'll see if it fixes this too, and if so this could be closed.



---

archive/issue_comments_275551.json:
```json
{
    "body": "You might also want to fix more general conversions\n\n```\nsage: K6(K12.one())\n1\nsage: K6(K12.gen()**2)\nzeta6\nsage: K6(K12.one() + K12.gen()**2)\n# BOOM\n```\n\nWhen there is an embedding `K1 -> K2` the conversions from `K2` to `K1` is unambiguous.",
    "created_at": "2016-05-19T13:51:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20024#issuecomment-275551",
    "user": "https://github.com/videlec"
}
```

You might also want to fix more general conversions

```
sage: K6(K12.one())
1
sage: K6(K12.gen()**2)
zeta6
sage: K6(K12.one() + K12.gen()**2)
# BOOM
```

When there is an embedding `K1 -> K2` the conversions from `K2` to `K1` is unambiguous.



---

archive/issue_comments_275552.json:
```json
{
    "body": "I would say this is an issue with *conversion*, not coercion.",
    "created_at": "2016-05-19T13:52:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20024#issuecomment-275552",
    "user": "https://github.com/tscrim"
}
```

I would say this is an issue with *conversion*, not coercion.



---

archive/issue_comments_275553.json:
```json
{
    "body": "It also is more general issue:\n\n```\nsage: K13 = CyclotomicField(13)\nsage: K5 = CyclotomicField(5)\nsage: K5(K13(0))\n# BOOM\n```\n",
    "created_at": "2016-05-19T13:53:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20024#issuecomment-275553",
    "user": "https://github.com/tscrim"
}
```

It also is more general issue:

```
sage: K13 = CyclotomicField(13)
sage: K5 = CyclotomicField(5)
sage: K5(K13(0))
# BOOM
```




---

archive/issue_comments_275554.json:
```json
{
    "body": "Indeed, I did not have a look at the title!",
    "created_at": "2016-05-19T13:53:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20024#issuecomment-275554",
    "user": "https://github.com/videlec"
}
```

Indeed, I did not have a look at the title!



---

archive/issue_events_055009.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2016-05-19T13:53:57Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/20024",
    "milestone": "sage-7.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20024#event-55009"
}
```



---

archive/issue_comments_275555.json:
```json
{
    "body": "Probably the quickest (best?) way around this might be to just special case 0 in the `_element_constructor_`:\n\n```python\nif x == x.parent().zero():\n    return self.zero()\n```\n",
    "created_at": "2016-05-19T13:54:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20024#issuecomment-275555",
    "user": "https://github.com/tscrim"
}
```

Probably the quickest (best?) way around this might be to just special case 0 in the `_element_constructor_`:

```python
if x == x.parent().zero():
    return self.zero()
```




---

archive/issue_comments_275556.json:
```json
{
    "body": "#20513 does fix the first of these: \n\n```\nsage: K12(K6(0))\n0\n```\n\nbut\n\n```\nsage: K6(K12(0))\n```\n\nrather amaingly gives\n\n```\nTypeError: unable to coerce <class 'sage.rings.infinity.PlusInfinity'> to an integer\n```\n\n\nI suggest that #20513 is amended to deal with these cases, with extra doctests, rather than starting a new branch for it.",
    "created_at": "2016-05-19T14:05:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20024#issuecomment-275556",
    "user": "https://github.com/JohnCremona"
}
```

#20513 does fix the first of these: 

```
sage: K12(K6(0))
0
```

but

```
sage: K6(K12(0))
```

rather amaingly gives

```
TypeError: unable to coerce <class 'sage.rings.infinity.PlusInfinity'> to an integer
```


I suggest that #20513 is amended to deal with these cases, with extra doctests, rather than starting a new branch for it.



---

archive/issue_comments_275557.json:
```json
{
    "body": "I think this and #20513 are separate issues and it is better to have a separate ticket (and branch) (which if there are conflicts, base this on #20513). With 7.2:\n\n```\nsage: K12 = CyclotomicField(12)\nsage: K6 = CyclotomicField(6)\nsage: K12(K6(0))\n0\n```\n\nworks just fine for me. If the latter is fails with #20513, then indeed these issues are separate.",
    "created_at": "2016-05-19T14:13:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20024#issuecomment-275557",
    "user": "https://github.com/tscrim"
}
```

I think this and #20513 are separate issues and it is better to have a separate ticket (and branch) (which if there are conflicts, base this on #20513). With 7.2:

```
sage: K12 = CyclotomicField(12)
sage: K6 = CyclotomicField(6)
sage: K12(K6(0))
0
```

works just fine for me. If the latter is fails with #20513, then indeed these issues are separate.



---

archive/issue_comments_275558.json:
```json
{
    "body": "As Travis said `K6 -> K12` is a **coercion** and is working just fine with or without #20513. The latter ticket deals with towers of coercions such as `K6 -> K12 -> K36 -> K64`. \n\nThe (partial) conversion `K12 -> K6` which is the object of this ticket is another story.",
    "created_at": "2016-05-19T14:33:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20024#issuecomment-275558",
    "user": "https://github.com/videlec"
}
```

As Travis said `K6 -> K12` is a **coercion** and is working just fine with or without #20513. The latter ticket deals with towers of coercions such as `K6 -> K12 -> K36 -> K64`. 

The (partial) conversion `K12 -> K6` which is the object of this ticket is another story.



---

archive/issue_comments_275559.json:
```json
{
    "body": "Replying to [comment:7 tscrim]:\n> Probably the quickest (best?) way around this might be to just special case 0 in the `_element_constructor_`:\n> {{{#!python\n> if x == x.parent().zero():\n>     return self.zero()\n> }}}\n\nEven better\n\n```python\nif x.is_rational():\n    return self(QQ(x))\n```\n",
    "created_at": "2016-05-19T14:34:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20024#issuecomment-275559",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:7 tscrim]:
> Probably the quickest (best?) way around this might be to just special case 0 in the `_element_constructor_`:
> {{{#!python
> if x == x.parent().zero():
>     return self.zero()
> }}}

Even better

```python
if x.is_rational():
    return self(QQ(x))
```




---

archive/issue_comments_275560.json:
```json
{
    "body": "It is explicitely mentioned in the documentation of `_coerce_from_other_cycltomic_field` that the method works only for roots of unity. And indeed\n\n```\nsage: K6(K12(2))\n# BOOM\nsage: K6(K12.gen()**2 + 1)\n# BOOM\n```\n",
    "created_at": "2016-05-19T14:38:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20024#issuecomment-275560",
    "user": "https://github.com/videlec"
}
```

It is explicitely mentioned in the documentation of `_coerce_from_other_cycltomic_field` that the method works only for roots of unity. And indeed

```
sage: K6(K12(2))
# BOOM
sage: K6(K12.gen()**2 + 1)
# BOOM
```




---

archive/issue_comments_275561.json:
```json
{
    "body": "Almost all of the BOOMs reported here now work.  Personally I don't think it is worth implemention any partial maps from K_n to K_m (where K_n is the n'th cyclotomic field) when m and n are coprime, so the only elements which would make sense as arguments would be rationals.\n\nMy inclination would be to close this.",
    "created_at": "2021-02-12T10:18:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20024#issuecomment-275561",
    "user": "https://github.com/JohnCremona"
}
```

Almost all of the BOOMs reported here now work.  Personally I don't think it is worth implemention any partial maps from K_n to K_m (where K_n is the n'th cyclotomic field) when m and n are coprime, so the only elements which would make sense as arguments would be rationals.

My inclination would be to close this.



---

archive/issue_comments_275562.json:
```json
{
    "body": "Some of the BOOMs must have been fixed by #29511. The example at the top of the ticket now works. However, this one persists:\n\n```\nsage: K13 = CyclotomicField(13)\nsage: K5 = CyclotomicField(5)\nsage: K5(K13(0))\n# BOOM\n```\n\nAnother example with roots of unity (which might have been broken by #29511, now that I think of it):\n\n```\nsage: K3 = CyclotomicField(3)\nsage: K9 = CyclotomicField(9)                                                   \nsage: K12 = CyclotomicField(12)     \nsage: K12(K3(K9.gen()^3))                                                       \nzeta12^2 - 1                           \nsage: K12(K9.gen()^3) # should be the same?  \n# BOOM\n```\n\nBut it might be worth creating a new ticket (or more than one) that more precisely identifies the remaining issue(s), and then closing this one as a duplicate.",
    "created_at": "2021-02-12T15:29:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20024#issuecomment-275562",
    "user": "https://github.com/kedlaya"
}
```

Some of the BOOMs must have been fixed by #29511. The example at the top of the ticket now works. However, this one persists:

```
sage: K13 = CyclotomicField(13)
sage: K5 = CyclotomicField(5)
sage: K5(K13(0))
# BOOM
```

Another example with roots of unity (which might have been broken by #29511, now that I think of it):

```
sage: K3 = CyclotomicField(3)
sage: K9 = CyclotomicField(9)                                                   
sage: K12 = CyclotomicField(12)     
sage: K12(K3(K9.gen()^3))                                                       
zeta12^2 - 1                           
sage: K12(K9.gen()^3) # should be the same?  
# BOOM
```

But it might be worth creating a new ticket (or more than one) that more precisely identifies the remaining issue(s), and then closing this one as a duplicate.



---

archive/issue_comments_275563.json:
```json
{
    "body": "I think a new ticket is in order here.  To be able to map a in K_m to K_n in a meaningful way, I think you have to think of K_l, where l=lcm(m,n), as a subfield of both, and only allow it if a lies i that common subfield.  Some care will be needed to allow for K_n=K_{2n} for odd n.  As a special case, when m and n are coprime, this will be possible iff a in in Q=K_1.\n\nIf that is mathematically reasonable and well-defined it is probably worth doing.",
    "created_at": "2021-02-12T16:16:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20024#issuecomment-275563",
    "user": "https://github.com/JohnCremona"
}
```

I think a new ticket is in order here.  To be able to map a in K_m to K_n in a meaningful way, I think you have to think of K_l, where l=lcm(m,n), as a subfield of both, and only allow it if a lies i that common subfield.  Some care will be needed to allow for K_n=K_{2n} for odd n.  As a special case, when m and n are coprime, this will be possible iff a in in Q=K_1.

If that is mathematically reasonable and well-defined it is probably worth doing.



---

archive/issue_comments_275564.json:
```json
{
    "body": "If I understand correctly, as long as m and n are even, the partial map K_m ---> K_n is just the composition of the partial map K_m ---> K_{gcd(m,n)} with the genuine map K_{gcd(m,n)} -> K_n, and in particular is defined exactly where the first map is defined.\n\nI believe thanks to #29511 the partial map K_m -> K_n is already fully implemented when n divides m, so it should be an easy fix to upgrade this to the general case.",
    "created_at": "2021-02-12T16:38:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20024#issuecomment-275564",
    "user": "https://github.com/kedlaya"
}
```

If I understand correctly, as long as m and n are even, the partial map K_m ---> K_n is just the composition of the partial map K_m ---> K_{gcd(m,n)} with the genuine map K_{gcd(m,n)} -> K_n, and in particular is defined exactly where the first map is defined.

I believe thanks to #29511 the partial map K_m -> K_n is already fully implemented when n divides m, so it should be an easy fix to upgrade this to the general case.



---

archive/issue_comments_275565.json:
```json
{
    "body": "Looking at what I did on #29511, in `src/sage/rings/number_field/number_field_morphisms.pyx` I defined a class `CyclotomicFieldConversion` which implements canonical conversions between arbitrary cyclotomic fields. What I don't know how to do offhand is to force this to get called when a coercion is needed between two cyclotomic fields, neither one containing the other.",
    "created_at": "2021-02-13T04:17:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20024#issuecomment-275565",
    "user": "https://github.com/kedlaya"
}
```

Looking at what I did on #29511, in `src/sage/rings/number_field/number_field_morphisms.pyx` I defined a class `CyclotomicFieldConversion` which implements canonical conversions between arbitrary cyclotomic fields. What I don't know how to do offhand is to force this to get called when a coercion is needed between two cyclotomic fields, neither one containing the other.
