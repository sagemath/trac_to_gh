# Issue 30408: Optimize `has_edge` of graph backend

Issue created by migration from https://trac.sagemath.org/ticket/30645

Original creator: @kliem

Original creation time: 2020-09-23 14:56:27

CC:  vdelecroix dimpase dcoudert

From #30641:

This ticket improves `has_edge` of the graph backend by calling directly unsafe methods.

Before:


```                                                                                                                                                                                                                                                                                                                                                                  
sage: G = Graph(loops=False, multiedges=False) 
....: G.add_edges([(i, (i+85)%100) for i in range(100)]) 
....: G.add_edges([(i, (i+37)%100) for i in range(100)]) 
....: G.add_edges([(i, (i+85)%100) for i in range(100)])                                                                                                                                                                                                                                                                                                                   
sage: edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                                      
sage: %timeit all(G.has_edge(*edge) for edge in edges)                                                                                                                                                                                                                                                                                                                     
101 µs ± 272 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)

sage: G = Graph(loops=False, multiedges=True) 
....: for j in range(20): 
....:     G.add_edges([(i, (i+85)%100, j) for i in range(100)]) 
....:     G.add_edges([(i, (i+37)%100, j) for i in range(100)]) 
....:     G.add_edges([(i, (i+85)%100, j) for i in range(100)]) 
....:                                                                                                                                                                                                                                                                                                                                                                      
sage: edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                                      
sage: %timeit all(G.has_edge(*edge) for edge in edges)                                                                                                                                                                                                                                                                                                                     
12.8 ms ± 125 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)

sage: G = Graph(loops=False, multiedges=False, sparse=False) 
....: G.add_edges([(i, (i+85)%100) for i in range(100)]) 
....: G.add_edges([(i, (i+37)%100) for i in range(100)]) 
....: G.add_edges([(i, (i+85)%100) for i in range(100)]) 
....:                                                                                                                                                                                                                                                                                                                                                                      
sage: edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                                      
sage: %timeit all(G.has_edge(*edge) for edge in edges)                                                                                                                                                                                                                                                                                                                     
102 µs ± 6.83 µs per loop (mean ± std. dev. of 7 runs, 10000 loops each)
```


After:

```
sage: G = Graph(loops=False, multiedges=False) 
....: G.add_edges([(i, (i+85)%100) for i in range(100)]) 
....: G.add_edges([(i, (i+37)%100) for i in range(100)]) 
....: G.add_edges([(i, (i+85)%100) for i in range(100)]) 
....:                                                                                                                                                                                                                                                                                                                                                                      
sage: edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                                      
sage: %timeit all(G.has_edge(*edge) for edge in edges)                                                                                                                                                                                                                                                                                                                     
67.6 µs ± 110 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)

sage: G = Graph(loops=False, multiedges=True) 
....: for j in range(20): 
....:     G.add_edges([(i, (i+85)%100, j) for i in range(100)]) 
....:     G.add_edges([(i, (i+37)%100, j) for i in range(100)]) 
....:     G.add_edges([(i, (i+85)%100, j) for i in range(100)]) 
....:                                                                                                                                                                                                                                                                                                                                                                      
sage: edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                                      
sage: %timeit all(G.has_edge(*edge) for edge in edges)                                                                                                                                                                                                                                                                                                                     
7.23 ms ± 147 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)

sage: G = Graph(loops=False, multiedges=False, sparse=False) 
....: G.add_edges([(i, (i+85)%100) for i in range(100)]) 
....: G.add_edges([(i, (i+37)%100) for i in range(100)]) 
....: G.add_edges([(i, (i+85)%100) for i in range(100)])                                                                                                                                                                                                                                                                                                                   
sage: edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                                      
sage: %timeit all(G.has_edge(*edge) for edge in edges)                                                                                                                                                                                                                                                                                                                     
75.8 µs ± 10.4 µs per loop (mean ± std. dev. of 7 runs, 10000 loops each)                                                        
```



---

Comment by @kliem created at 2020-09-23 14:56:33

Changing status from new to needs_review.


---

Comment by dcoudert created at 2020-09-23 15:31:54

LGTM.


---

Comment by dcoudert created at 2020-09-23 15:31:54

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2020-09-23 15:32:46

Changing status from positive_review to needs_review.


---

Comment by @kliem created at 2020-09-23 15:32:46

Sorry, wait a second. I'll push another commit in a second.


---

Comment by @kliem created at 2020-09-23 15:34:38

I realized that it might be easier to define `get_vertex_checked`, which acts as `get_vertex` combined with `has_vertex`.

I will also use this for optimizing the iterators, so it makes sense to define a common method.


---

Comment by git created at 2020-09-23 15:40:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-09-23 15:40:48

Ok. Here it is.


---

Comment by dcoudert created at 2020-09-23 16:14:37

I agree it's better this way.


---

Comment by dcoudert created at 2020-09-23 16:14:37

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-10-05 20:12:49

Resolution: fixed
