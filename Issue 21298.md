# Issue 21298: Make src/setup.py independent of SAGE_CYTHONIZED

Issue created by migration from Trac.

Original creator: mkoeppe

Original creation time: 2016-09-18 20:17:39

CC:  jdemeyer embray

This is a follow-up on #21480, which put `src/setup.py` in charge of all `sagelib`building and removed dependencies on various environment variables, as a step towards the goal of making `sagelib` an ordinary Python package (#21507). 

However, there is still a dependency on `$SAGE_CYTHONIZED`, which needs to be set in a way that matches the build-base (set by setup.py build --build-base).

This dependency should be removed.

See also #21508 on other cleanup issues of `src/setup.py`.


---

Comment by embray created at 2016-09-22 15:18:50

I think I've brought this up with jdemeyer before, who had some objections (I think where I brought it up originally was in the context of cysignals, but same applies to sage itself).  Ultimately what it came down to is that he prefers the source tree to always be clean of build artifacts, which I can certainly respect.  But I don't personally have a problem like that, and like to be able to use `./setup.py build_ext --inplace` for in-place testing, which I find cuts down on time spent in the "edit-build-install" cycle.

In any case, these are subjective preferences for development practice, and I think either way should work--eliminating dependency on `$SAGE_CYTHONIZED` should be a step in the right direction.


---

Comment by mkoeppe created at 2016-09-22 17:05:34

Replying to [comment:1 embray]:
> Ultimately what it came down to is that `[`jdemeyer`]` prefers the source tree to always be clean of build artifacts, which I can certainly respect.  But I don't personally have a problem like that, and 

I also like to keep the source tree clean, which is why I usually use VPATH builds. I have created #21469 for that.

> like to be able to use `./setup.py build_ext --inplace` for in-place testing, which I find cuts down on time spent in the "edit-build-install" cycle.

Thanks for pointing out `--inplace`. I'll look into this.


---

Comment by embray created at 2016-10-12 08:44:37

#21682 might help with this one--it makes SAGE_CYTHONIZED mostly irrelevant IMO.


---

Comment by embray created at 2016-11-07 13:27:48

I should be able to fix this with or without #21682, though I think it helps.


---

Comment by embray created at 2016-11-07 13:27:48

Set assignee to embray.


---

Comment by jdemeyer created at 2016-11-07 13:37:58

Wouldn't it be easier to fix with #21682, given that you are adding a `--build-dir` option?


---

Comment by embray created at 2016-11-07 14:37:50

Yes, it would be easier.


---

Comment by embray created at 2016-11-08 12:22:54

So what would be the impact of removing SAGE_CYTHONIZED entirely?  As far as I can tell it is only really used by setup.py/sage_setup.  Implementing this ticket makes it pretty pointless I think--it makes SAGE_CYTHONIZED not even make sense, really.

Would it be a problem to outright remove it?  Or does it need to still be supported somehow?


---

Comment by mkoeppe created at 2016-11-08 12:28:25

+1 for getting rid of SAGE_CYTHONIZED completely if you can.


---

Comment by mkoeppe created at 2017-08-27 04:46:42

Erik and Jeroen, given that #21682 (`setup.py build_cython`) is merged, can we now get rid of `SAGE_CYTHONIZED` and support `setup.py build --build-base`?


---

Comment by embray created at 2017-08-29 10:36:27

I'd be all for that. Do you need me to work on it?


---

Comment by jdemeyer created at 2017-08-29 13:31:33

As a small first step, see #23744.


---

Comment by mkoeppe created at 2017-08-29 17:50:21

Replying to [comment:12 embray]:
> I'd be all for that. Do you need me to work on it?

That would be great!

By the way, in my current attempt at #21469 I noticed that `--build-base` already works. 

This line in `src/setup.py`:

```
build_base = 'build' # the distutils default. Changing it is not supported by this setup.sh.
```

is probably a leftover from my earlier changes, and should probably be removed. The variable `build_base` does not seem to be used, and the comment is no longer correct.


---

Comment by jdemeyer created at 2017-09-01 12:23:09

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2017-09-01 12:23:09

Here is a branch getting rid of `SAGE_CYTHONIZED`. Unfortunately, two doctests in `sage_setup` still require `SAGE_CYTHONIZED`, so I just hardcoded the value there. This clearly goes against DRY, so I'm not so happy with it. Ideas or improvements are welcome.
----
New commits:


---

Comment by embray created at 2017-09-01 12:52:10

Hmm--one idea might be for `setup.py` to write out a sort of build configuration file, similar to what we do with `.cython_version`, logging attributes of interest from the distutils `Distribution`.  The test could then use that to determine the `build_base` that was used for the last build.  Probably overkill just to make a test work, but having such a file might be useful even for debugging/logging purposes if nothing else.


---

Comment by mkoeppe created at 2017-09-01 15:40:19

Replying to [comment:16 jdemeyer]:
> Here is a branch getting rid of `SAGE_CYTHONIZED`. Unfortunately, two doctests in `sage_setup` still require `SAGE_CYTHONIZED`, so I just hardcoded the value there. This clearly goes against DRY, so I'm not so happy with it. Ideas or improvements are welcome.

Commit 33746a2 is good, but I think some of the changes in 769de13 are not going in the right direction.

1) In particular the following, I think, breaks the already working `--build-base` feature (see comment 14)!

```diff
diff --git a/src/setup.py b/src/setup.py
index 6354427..be4036d 100755
--- a/src/setup.py
+++ b/src/setup.py
`@``@` -52,12 +52,16 `@``@` sys.excepthook = excepthook
 
 build_base = 'build' # the distutils default. Changing it is not supported by this setup.sh.
 
+# Directory to store Cython-generated files
+SAGE_CYTHONIZED = os.path.join(build_base, "cythonized")
+
```


2) The hardcoded paths depending on SAGE_SRC make it harder for the VPATH patch. Perhaps it's best to do this work after VPATH (#21469) is done.


---

Comment by mkoeppe created at 2017-09-01 15:47:12

Replying to [comment:17 embray]:
> Hmm--one idea might be for `setup.py` to write out a sort of build configuration file, similar to what we do with `.cython_version`, logging attributes of interest from the distutils `Distribution`.  The test could then use that to determine the `build_base` that was used for the last build.  Probably overkill just to make a test work, but having such a file might be useful even for debugging/logging purposes if nothing else.

Yes, I think this is a good idea. Basically this is part of #21707 (Split `sage-env` into `sage-build-env`, `sagelib-build-env` and `sage-env`) -- `setup.sh` should be responsible for writing out a configuration file concerning sagelib.


---

Comment by mkoeppe created at 2017-09-01 15:48:12

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-09-02 11:00:52

I see. The variable `build_base` was really added by mistake in #21480 when removing support for `--build-base`.


---

Comment by jdemeyer created at 2017-09-02 13:07:17

Working on this...


---

Comment by git created at 2017-09-02 15:06:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-09-02 15:11:18

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-09-02 15:11:18

This should address the concerns about `build_base`. The doctests still hardcode `build/cythonized`, but I prefer to fix that in a different ticket. I think this branch here does enough good things (even if it's not perfect), so I'm setting it back to needs_review.


---

Comment by mkoeppe created at 2017-09-02 21:31:12

Replying to [comment:21 jdemeyer]:
> I see. The variable `build_base` was really added by mistake in #21480 when removing support for `--build-base`.

Well, in #21480 the variable `build_base` was still used, but some of Erik's later tickets seem to have removed all uses of it.


---

Comment by embray created at 2017-09-05 09:19:23

Replying to [comment:25 mkoeppe]:
> Replying to [comment:21 jdemeyer]:
> > I see. The variable `build_base` was really added by mistake in #21480 when removing support for `--build-base`.
> 
> Well, in #21480 the variable `build_base` was still used, but some of Erik's later tickets seem to have removed all uses of it.

I'm not actively concerned about any of my existing open tickets addressing issues in the setup.py.  I'd like to get back to that at some point but if any of those tickets still end up being useful I'll rework them.


---

Comment by mkoeppe created at 2017-09-05 20:48:43

Hi Erik, there's no problem; to the contrary, as a result of these changes that are already merged, `--build-base` already works.


---

Comment by jdemeyer created at 2017-09-06 08:23:41

Indeed. What this ticket does is also use the `build_base` directory for the `cythonized` files.


---

Comment by mkoeppe created at 2017-09-06 22:24:51

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-09-10 22:05:52

Resolution: fixed
