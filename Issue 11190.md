# Issue 11190: showing a Cayley table fails in the notebook due to bad latex code

archive/issues_011190.json:
```json
{
    "body": "Assignee: joyner\n\nCC:  slelievre klee\n\nIn the notebook we have:\n\n```\nsage: T = SymmetricGroup(3).multiplication_table()\nsage: show(T)\nUnknown control sequence '\\setlength'\nsage: latex(T)\n\\setlength{\\arraycolsep}{2\\ex}\n\\begin{array}{r|*{6}{r}}\n\\multicolumn{1}{c|}{\\ast}&a&b&c&d&e&f\\\\\\hline\n{}a&a&b&c&d&e&f\\\\\n{}b&b&a&d&c&f&e\\\\\n{}c&c&e&a&f&b&d\\\\\n{}d&d&f&b&e&a&c\\\\\n{}e&e&c&f&a&d&b\\\\\n{}f&f&d&e&b&c&a\\\\\n\\end{array}}\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/11362\n\n",
    "created_at": "2011-05-20T17:30:56Z",
    "labels": [
        "group theory",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "showing a Cayley table fails in the notebook due to bad latex code",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11190",
    "user": "was"
}
```
Assignee: joyner

CC:  slelievre klee

In the notebook we have:

```
sage: T = SymmetricGroup(3).multiplication_table()
sage: show(T)
Unknown control sequence '\setlength'
sage: latex(T)
\setlength{\arraycolsep}{2\ex}
\begin{array}{r|*{6}{r}}
\multicolumn{1}{c|}{\ast}&a&b&c&d&e&f\\\hline
{}a&a&b&c&d&e&f\\
{}b&b&a&d&c&f&e\\
{}c&c&e&a&f&b&d\\
{}d&d&f&b&e&a&c\\
{}e&e&c&f&a&d&b\\
{}f&f&d&e&b&c&a\\
\end{array}}
```


Issue created by migration from https://trac.sagemath.org/ticket/11362





---

archive/issue_comments_123048.json:
```json
{
    "body": "I thought this was on #10787, but now I see it is not.  I'm going to point it here.\n\nI've been waiting on `MathJax` before tackling this, on the hope it has better support for tables.",
    "created_at": "2011-05-20T17:48:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11190",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11190#issuecomment-123048",
    "user": "rbeezer"
}
```

I thought this was on #10787, but now I see it is not.  I'm going to point it here.

I've been waiting on `MathJax` before tackling this, on the hope it has better support for tables.



---

archive/issue_comments_123049.json:
```json
{
    "body": "Changing keywords from \"\" to \"latex, jupyter, mathjax\".",
    "created_at": "2020-10-14T21:43:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11190",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11190#issuecomment-123049",
    "user": "slelievre"
}
```

Changing keywords from "" to "latex, jupyter, mathjax".



---

archive/issue_comments_123050.json:
```json
{
    "body": "Still a problem in Jupyter Notebook with Sage 9.2.rc0.",
    "created_at": "2020-10-14T21:43:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11190",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11190#issuecomment-123050",
    "user": "slelievre"
}
```

Still a problem in Jupyter Notebook with Sage 9.2.rc0.



---

archive/issue_comments_123051.json:
```json
{
    "body": "The PR adds a variable `sage.misc.latex_macros.sage_configurable_mathjax_macros` that holds a list of macro definitions that `pretty_print` will include in all LaTeX code that is sent to `MathJax`. The PR then solves the problem on this ticket by adding `\\multicolumn` and `\\setlength` to this list as no-ops that swallow their arguments.\n----\nNew commits:",
    "created_at": "2021-02-22T01:26:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11190",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11190#issuecomment-123051",
    "user": "@DaveWitteMorris"
}
```

The PR adds a variable `sage.misc.latex_macros.sage_configurable_mathjax_macros` that holds a list of macro definitions that `pretty_print` will include in all LaTeX code that is sent to `MathJax`. The PR then solves the problem on this ticket by adding `\multicolumn` and `\setlength` to this list as no-ops that swallow their arguments.
----
New commits:



---

archive/issue_comments_123052.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-02-22T01:26:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11190",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11190#issuecomment-123052",
    "user": "@DaveWitteMorris"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_123053.json:
```json
{
    "body": "I don't like the proposed solution. It seems a bandage.\n\nA general solution that would also solve possible future problems would be to introduce a new magic method obj._mathjax_() which provides latex code renderable by mathjax and defaults to an alias of obj._latex_() when it is not defined for obj.",
    "created_at": "2021-03-19T04:56:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11190",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11190#issuecomment-123053",
    "user": "klee"
}
```

I don't like the proposed solution. It seems a bandage.

A general solution that would also solve possible future problems would be to introduce a new magic method obj._mathjax_() which provides latex code renderable by mathjax and defaults to an alias of obj._latex_() when it is not defined for obj.



---

archive/issue_comments_123054.json:
```json
{
    "body": "I sympathize with what you are saying, and I considered that solution (except that my idea was to add a keyword (maybe `style=\"MathJax\"`) to the `_latex_` command. But I don't see how to make it will work without massive changes, because an object that does not have a `_mathjax_` method will presumably call the `_latex_` method of its subobjects (or subexpressions) and will therefore not do the right thing for MathJax.\n\nI think of MathJax as being a version of latex, rather than a completely different format, so I think it is reasonable to just add a tweak to make it work better (as in my PR). The variable I added simply makes it possible to add definitions for latex macros that MathJax does not understand, and is completely analogous to the variable `sage_configurable_latex_macros` that is already in sage, which makes it possible to add definitions for sage macros that vanilla latex does not understand.",
    "created_at": "2021-03-19T06:10:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11190",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11190#issuecomment-123054",
    "user": "@DaveWitteMorris"
}
```

I sympathize with what you are saying, and I considered that solution (except that my idea was to add a keyword (maybe `style="MathJax"`) to the `_latex_` command. But I don't see how to make it will work without massive changes, because an object that does not have a `_mathjax_` method will presumably call the `_latex_` method of its subobjects (or subexpressions) and will therefore not do the right thing for MathJax.

I think of MathJax as being a version of latex, rather than a completely different format, so I think it is reasonable to just add a tweak to make it work better (as in my PR). The variable I added simply makes it possible to add definitions for latex macros that MathJax does not understand, and is completely analogous to the variable `sage_configurable_latex_macros` that is already in sage, which makes it possible to add definitions for sage macros that vanilla latex does not understand.



---

archive/issue_comments_123055.json:
```json
{
    "body": "How about using `_rich_repr_`? This seems a general mechanism to serve the purpose that I have in mind about `_mathjax_`. There are many examples in Sage src.",
    "created_at": "2021-03-20T00:06:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11190",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11190#issuecomment-123055",
    "user": "klee"
}
```

How about using `_rich_repr_`? This seems a general mechanism to serve the purpose that I have in mind about `_mathjax_`. There are many examples in Sage src.



---

archive/issue_comments_123056.json:
```json
{
    "body": "Replying to [comment:11 gh-DaveWitteMorris]:\n> I sympathize with what you are saying, and I considered that solution (except that my idea was to add a keyword (maybe `style=\"MathJax\"`) to the `_latex_` command. But I don't see how to make it will work without massive changes, because an object that does not have a `_mathjax_` method will presumably call the `_latex_` method of its subobjects (or subexpressions) and will therefore not do the right thing for MathJax.\n> \n> I think of MathJax as being a version of latex, rather than a completely different format, ...\n\n`MathJax` is a javascript renderer for latex in html, and also sometimes means the subset of latex it supports. On the other hand `LaTeX` is a format for TeX which primarily targets printing.\n\nIt seems to me currently there is some unfortunate confused code in this respect in the rich output system in Sage. Perhaps straightening the confused code would give a natural solution of this ticket's problem. I will investigate more.",
    "created_at": "2021-03-21T13:29:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11190",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11190#issuecomment-123056",
    "user": "klee"
}
```

Replying to [comment:11 gh-DaveWitteMorris]:
> I sympathize with what you are saying, and I considered that solution (except that my idea was to add a keyword (maybe `style="MathJax"`) to the `_latex_` command. But I don't see how to make it will work without massive changes, because an object that does not have a `_mathjax_` method will presumably call the `_latex_` method of its subobjects (or subexpressions) and will therefore not do the right thing for MathJax.
> 
> I think of MathJax as being a version of latex, rather than a completely different format, ...

`MathJax` is a javascript renderer for latex in html, and also sometimes means the subset of latex it supports. On the other hand `LaTeX` is a format for TeX which primarily targets printing.

It seems to me currently there is some unfortunate confused code in this respect in the rich output system in Sage. Perhaps straightening the confused code would give a natural solution of this ticket's problem. I will investigate more.



---

archive/issue_comments_123057.json:
```json
{
    "body": "Related:\n\n- #31536: Divorce MathJax from LaTeX and let it marry HTML",
    "created_at": "2021-03-22T20:14:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11190",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11190#issuecomment-123057",
    "user": "slelievre"
}
```

Related:

- #31536: Divorce MathJax from LaTeX and let it marry HTML



---

archive/issue_comments_123058.json:
```json
{
    "body": "With #31536, the following patch will solve the problem of this ticket.\n\n\n```diff\ndiff --git a/src/sage/matrix/operation_table.py b/src/sage/matrix/operation_table.py\nindex 6feda2215a..8c066f11a9 100644\n--- a/src/sage/matrix/operation_table.py\n+++ b/src/sage/matrix/operation_table.py\n@@ -1078,3 +1078,26 @@ class OperationTable(SageObject):\n         table.append('\\\\end{array}')\n         table.append('}')\n         return ''.join(table)\n+\n+    def _html_(self):\n+        n = self._n\n+        names = self._names\n+\n+        # Headers\n+        table = ['\\\\begin{array}{r|*{'+str(n)+'}{r}}\\n']\n+        table.append(self._latex_symbol)\n+        table += ['&'+names[i] for i in range(n)]\n+        table.append('\\\\\\\\\\\\hline\\n')\n+\n+        # Row label and body of table\n+        for g in range(n):\n+            table.append('{}')  # Interrupts newline and [], so not line spacing\n+            table.append(names[g])\n+            for h in range(n):\n+                table.append('&'+names[self._table[g][h]])\n+            table.append('\\\\\\\\\\n')\n+\n+        # Finish\n+        table.append('\\\\end{array}')\n+        return ''.join(table)\n+\n```\n",
    "created_at": "2021-03-23T15:33:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11190",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11190#issuecomment-123058",
    "user": "klee"
}
```

With #31536, the following patch will solve the problem of this ticket.


```diff
diff --git a/src/sage/matrix/operation_table.py b/src/sage/matrix/operation_table.py
index 6feda2215a..8c066f11a9 100644
--- a/src/sage/matrix/operation_table.py
+++ b/src/sage/matrix/operation_table.py
@@ -1078,3 +1078,26 @@ class OperationTable(SageObject):
         table.append('\\end{array}')
         table.append('}')
         return ''.join(table)
+
+    def _html_(self):
+        n = self._n
+        names = self._names
+
+        # Headers
+        table = ['\\begin{array}{r|*{'+str(n)+'}{r}}\n']
+        table.append(self._latex_symbol)
+        table += ['&'+names[i] for i in range(n)]
+        table.append('\\\\\\hline\n')
+
+        # Row label and body of table
+        for g in range(n):
+            table.append('{}')  # Interrupts newline and [], so not line spacing
+            table.append(names[g])
+            for h in range(n):
+                table.append('&'+names[self._table[g][h]])
+            table.append('\\\\\n')
+
+        # Finish
+        table.append('\\end{array}')
+        return ''.join(table)
+
```




---

archive/issue_comments_123059.json:
```json
{
    "body": "Moving to 9.4, as 9.3 has been released.",
    "created_at": "2021-05-10T17:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11190",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11190#issuecomment-123059",
    "user": "mkoeppe"
}
```

Moving to 9.4, as 9.3 has been released.



---

archive/issue_comments_123060.json:
```json
{
    "body": "Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11190",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11190#issuecomment-123060",
    "user": "mkoeppe"
}
```

Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_comments_123061.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-08-24T06:03:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11190",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11190#issuecomment-123061",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_123062.json:
```json
{
    "body": "Changing component from group theory to notebook.",
    "created_at": "2021-08-24T06:18:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11190",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11190#issuecomment-123062",
    "user": "klee"
}
```

Changing component from group theory to notebook.



---

archive/issue_comments_123063.json:
```json
{
    "body": "Attachment [trac11362.ipynb](tarball://root/attachments/some-uuid/ticket11362/trac11362.ipynb) by klee created at 2021-08-24 06:19:44\n\nCayley table",
    "created_at": "2021-08-24T06:19:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11190",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11190#issuecomment-123063",
    "user": "klee"
}
```

Attachment [trac11362.ipynb](tarball://root/attachments/some-uuid/ticket11362/trac11362.ipynb) by klee created at 2021-08-24 06:19:44

Cayley table



---

archive/issue_comments_123064.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-24T06:37:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11190",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11190#issuecomment-123064",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_123065.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-24T06:39:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11190",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11190#issuecomment-123065",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_123066.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-25T02:30:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11190",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11190#issuecomment-123066",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_123067.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-31T12:12:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11190",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11190#issuecomment-123067",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_123068.json:
```json
{
    "body": "Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.",
    "created_at": "2021-12-18T19:53:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11190",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11190#issuecomment-123068",
    "user": "mkoeppe"
}
```

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.



---

archive/issue_comments_123069.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-03-10T05:18:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11190",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11190#issuecomment-123069",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
