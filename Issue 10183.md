# Issue 10183: class group iterator is too slow

Issue created by migration from Trac.

Original creator: thome

Original creation time: 2010-10-28 20:57:21

Assignee: davidloeffler

the class group iterator takes evey element in turn, and computes the product of the g^i's. Sure powers are computed by repeated squaring, but for iterators this is suboptimal.

On my laptop, from this situation...


```

sage: K.<v>=NumberField(x^4 + 514*x^2 + 64321)
sage: OK=K.maximal_order()
sage: G=K.class_group()                        
sage: time _=G.list()
CPU times: user 2.48 s, sys: 0.05 s, total: 2.53 s
Wall time: 2.53 s

```


the attached patch improves to...


```

sage: K.<v>=NumberField(x^4 + 514*x^2 + 64321)
sage: OK=K.maximal_order()
sage: G=K.class_group()                        
sage: time _=G.list()
CPU times: user 0.45 s, sys: 0.00 s, total: 0.45 s
Wall time: 0.44 s

```


which is a tad better.

doctest included (actually the previous doctest wasn't doing much, this one is slightly more thorough).

Note: while the code would work for any abelian group, I believe it makes sense only when the group operation is sufficiently non-trivial.


---

Attachment


---

Comment by roed created at 2012-09-17 05:31:40

Is this waiting on something, or does it just need review?


---

Comment by thome created at 2012-09-17 08:24:21

Hi David,

Replying to [comment:1 roed]:

> Is this waiting on something, or does it just need review?

I think it just hasn't been reviewed by anyone.

Cheers,

E.


---

Comment by roed created at 2012-09-17 08:28:00

Changing status from new to needs_review.


---

Comment by roed created at 2012-09-17 08:28:00

I'll mark it as needs review then.  I don't have time to review it at the moment, though I may be able to eventually.


---

Comment by jdemeyer created at 2012-09-27 18:05:07

There are some formatting problems.  The "sage:" indentation should be left as it was:

```
TESTS::

    sage: ...
```

And you really should put a blank line between 2 functions, lines 213--214.

Also: please put your real name in the Author field on the ticket.


---

Comment by jdemeyer created at 2012-09-27 18:05:07

Changing status from needs_review to needs_work.


---

Attachment


---

Comment by ssharif created at 2013-07-25 20:55:24

Rebased to 5.11b3. This included adjusting line numbers. Also, last example had to be changed---the order of the class group elements is different.

Lastly, the new iterator ` __iter_inner__ ` needs a documentation string and a doc test


---

Comment by ssharif created at 2013-07-25 20:55:24

Changing keywords from "" to "sd51".


---

Comment by davidloeffler created at 2013-07-26 11:28:04

Shahed: I am puzzled by the constructs such as

```python
[l for l in reflist[k]]
```

in the doctests in your patch. This is completely equivalent to `reflist[k]`. Why the list comprehension?


---

Comment by ssharif created at 2013-07-26 11:42:11

Hi David,

This is unchanged from Emmanuel's patch, but I can simplify it in a new version. Also, it has been brought to my attention (by you and J. Cremona) that Pari produces the generators for the class group in a different order depending on the implementation. The given doctests were tested on my 32-bit system running sage 5.11b3; someone (probably me given time) will need to test this on a 64-bit system and put in the relevant doc test.

Shahed


---

Comment by AlexGhitza created at 2013-07-26 14:19:39

Replying to [comment:8 ssharif]:
> This is unchanged from Emmanuel's patch, but I can simplify it in a new version. Also, it has been brought to my attention (by you and J. Cremona) that Pari produces the generators for the class group in a different order depending on the implementation. The given doctests were tested on my 32-bit system running sage 5.11b3; someone (probably me given time) will need to test this on a 64-bit system and put in the relevant doc test.

Is it only the order that is different between 32- and 64-bit?  In other words, if the output of the function is sorted, would 32- and 64-bit machines produce the same list of generators?


---

Attachment

Hi.

Thanks for your feedback. I just posted another version of the patch which fixes indentation, and adds documentation and doctests to _iter_inner_.

Looking back at this, and considering your warning on the generators returned by pari, I think that the doctest for the iterator is probably too fragile. What do you think ?

E.


---

Comment by ssharif created at 2013-07-29 16:45:11

Alex and Emmanuel:

Yes, the order is exactly the problem---the output of G.list() is permuted between the 2 cases. Also (though I haven't tested this on 64-bit), I believe the representative ideal in each class is also different; but this should not pose a problem, since G(I) for example returns the class of I. I tried using set() to fix the issue, but that didn't work; not sure why.


---

Comment by chapoton created at 2017-06-22 13:33:16

I made a branch.
----
New commits:


---

Comment by chapoton created at 2017-06-22 13:33:16

Changing status from needs_work to needs_review.


---

Comment by git created at 2017-06-23 23:53:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-06-23 23:57:33

I made some small additional changes for speed and safety (in case inplace multiplication actually becomes inplace, really this does what the previous code was doing). This is really the same algorithm but using less multiplication. So if my changes look good, then positive review.


---

Comment by chapoton created at 2017-07-11 20:44:59

Looks good to me. Let it be.


---

Comment by chapoton created at 2017-07-11 20:44:59

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-07-31 20:18:08

Resolution: fixed
