# Issue 33389: sageinspect.sage_getfile(x) incorrect when using an alternate suffix for extension modules

archive/issues_033389.json:
```json
{
    "body": "Python has in `importlib.machinery.EXTENSION_SUFFIXES` a list of strings representing the recognized file suffixes for extension modules.\n\nSagemath defines `loadable_module_extension()` as the first entry in the list, and assumes extension modules use this suffix only.\n\nThis is normally ok since python setuptools uses that particular suffix when compiling extension modules.\n\nHowever, this may not always be true. For example in void linux the extension modules are renamed to use the shortest suffix (which is `.so`, instead of `.cpython-310-x86_64-linux-gnu.so`).\n\nI don't know what's the rationale behind that rename, but it's \"legal\" from pov of python, so it'd be nice if this was supported in sage.\n\nThere is one doctest failure on this situation:\n\n```\n**********************************************************************\nFile \"src/sage/misc/sageinspect.py\", line 186, in sage.misc.sageinspect.loadable_module_extension\nFailed example:\n    sage.structure.sage_object.__file__.endswith(loadable_module_extension())\nExpected:\n    True\nGot:\n    False\n**********************************************************************\n```\n\n\nMoreover, this causes another (more serious) issue in `sage.misc.sageinspect.sage_getfile`, namely:\n\n```\nsage: sage.misc.sageinspect.sage_getfile(x)\n'/opt/sage/sage-git/develop/pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/symbolic/expression.so'\n```\n\nThe expected output is the full path to `expression.pyx` instead of `.so`.\n\nIt turns out this is handled by a fallback in `sage_getfile` that is not covered by any doctest.\n\nPurpose of this ticket is\na. add a doctest that exercises the above example so it triggers this incorrect behaviour.\nb. fix the incorrect behaviour of `sage_getfile`\nc. look for other possible incorrect uses of `loadable_module_extension()` which are making the same assumption\n\nIssue created by migration from https://trac.sagemath.org/ticket/33626\n\n",
    "created_at": "2022-04-01T23:48:18Z",
    "labels": [
        "component: porting",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "sageinspect.sage_getfile(x) incorrect when using an alternate suffix for extension modules",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33389",
    "user": "https://github.com/tornaria"
}
```
Python has in `importlib.machinery.EXTENSION_SUFFIXES` a list of strings representing the recognized file suffixes for extension modules.

Sagemath defines `loadable_module_extension()` as the first entry in the list, and assumes extension modules use this suffix only.

This is normally ok since python setuptools uses that particular suffix when compiling extension modules.

However, this may not always be true. For example in void linux the extension modules are renamed to use the shortest suffix (which is `.so`, instead of `.cpython-310-x86_64-linux-gnu.so`).

I don't know what's the rationale behind that rename, but it's "legal" from pov of python, so it'd be nice if this was supported in sage.

There is one doctest failure on this situation:

```
**********************************************************************
File "src/sage/misc/sageinspect.py", line 186, in sage.misc.sageinspect.loadable_module_extension
Failed example:
    sage.structure.sage_object.__file__.endswith(loadable_module_extension())
Expected:
    True
Got:
    False
**********************************************************************
```


Moreover, this causes another (more serious) issue in `sage.misc.sageinspect.sage_getfile`, namely:

```
sage: sage.misc.sageinspect.sage_getfile(x)
'/opt/sage/sage-git/develop/pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/symbolic/expression.so'
```

The expected output is the full path to `expression.pyx` instead of `.so`.

It turns out this is handled by a fallback in `sage_getfile` that is not covered by any doctest.

Purpose of this ticket is
a. add a doctest that exercises the above example so it triggers this incorrect behaviour.
b. fix the incorrect behaviour of `sage_getfile`
c. look for other possible incorrect uses of `loadable_module_extension()` which are making the same assumption

Issue created by migration from https://trac.sagemath.org/ticket/33626





---

archive/issue_comments_474811.json:
```json
{
    "body": "I think we should deprecate `loadable_module_extension` and replace all uses by just using `importlib.machinery.EXTENSION_SUFFIXES`.",
    "created_at": "2022-04-02T03:20:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33389#issuecomment-474811",
    "user": "https://github.com/mkoeppe"
}
```

I think we should deprecate `loadable_module_extension` and replace all uses by just using `importlib.machinery.EXTENSION_SUFFIXES`.



---

archive/issue_comments_474812.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-04-03T12:18:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33389#issuecomment-474812",
    "user": "https://github.com/tornaria"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_474813.json:
```json
{
    "body": "This fixes all the doctest failures in the void linux package (where, per distro policy, python extension modules are renamed from `%.cpython*.so` to just `%.so`).\n\nAfter this, `loadable_module_extension()` is only used (twice) in `sage.misc.cython.cython()`.\nFor these I have this tentative change:\n\n```diff\n--- a/src/sage/misc/cython.py\n+++ b/src/sage/misc/cython.py\n@@ -240,13 +240,20 @@ def cython(filename, verbose=0, compile_message=False,\n         # There is already a module here. Maybe we do not have to rebuild?\n         # Find the name.\n         if use_cache:\n-            from sage.misc.sageinspect import loadable_module_extension\n-            prev_so = [F for F in os.listdir(target_dir) if F.endswith(loadable_module_extension())]\n-            if len(prev_so) > 0:\n-                prev_so = prev_so[0]     # should have length 1 because of deletes below\n-                if os.path.getmtime(filename) <= os.path.getmtime('%s/%s' % (target_dir, prev_so)):\n+            from importlib.machinery import EXTENSION_SUFFIXES\n+            for f in os.listdir(target_dir):\n+                for suffix in EXTENSION_SUFFIXES:\n+                    if f.endswith(suffix):\n+                        # use the first matching extension\n+                        prev_file = os.path.join(target_dir, f)\n+                        prev_name = f[:-len(suffix)]\n+                        break\n+                else:\n+                    # no match, try next file\n+                    continue\n+                if os.path.getmtime(filename) <= os.path.getmtime(prev_file):\n                     # We do not have to rebuild.\n-                    return prev_so[:-len(loadable_module_extension())], target_dir\n+                    return prev_name, target_dir\n \n         # Delete all ordinary files in target_dir\n         for F in os.listdir(target_dir):\n@@ -410,9 +417,11 @@ def cython(filename, verbose=0, compile_message=False,\n \n     if create_local_so_file:\n         # Copy module to current directory\n-        from sage.misc.sageinspect import loadable_module_extension\n-        shutil.copy(os.path.join(target_dir, name + loadable_module_extension()),\n-                    os.curdir)\n+        from importlib.machinery import EXTENSION_SUFFIXES\n+        for ext in EXTENSION_SUFFIXES:\n+            path = os.path.join(target_dir, name + ext)\n+            if os.path.exists(path):\n+                shutil.copy(path, os.curdir)\n \n     return name, target_dir\n \n```\n\nNotes:\n- The option `use_cache` is only used in `sage.repl.load.load_cython()` and I'm not sure there's any doctest that will run this code.\n- The option `create_local_so_file` is not used anywhere, and it's not doctested.\n- If both options are given together and the compiled .so file is found in cache, it will //not// save a copy in the current directory (seems to be a bug).\n----\nNew commits:",
    "created_at": "2022-04-03T12:18:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33389#issuecomment-474813",
    "user": "https://github.com/tornaria"
}
```

This fixes all the doctest failures in the void linux package (where, per distro policy, python extension modules are renamed from `%.cpython*.so` to just `%.so`).

After this, `loadable_module_extension()` is only used (twice) in `sage.misc.cython.cython()`.
For these I have this tentative change:

```diff
--- a/src/sage/misc/cython.py
+++ b/src/sage/misc/cython.py
@@ -240,13 +240,20 @@ def cython(filename, verbose=0, compile_message=False,
         # There is already a module here. Maybe we do not have to rebuild?
         # Find the name.
         if use_cache:
-            from sage.misc.sageinspect import loadable_module_extension
-            prev_so = [F for F in os.listdir(target_dir) if F.endswith(loadable_module_extension())]
-            if len(prev_so) > 0:
-                prev_so = prev_so[0]     # should have length 1 because of deletes below
-                if os.path.getmtime(filename) <= os.path.getmtime('%s/%s' % (target_dir, prev_so)):
+            from importlib.machinery import EXTENSION_SUFFIXES
+            for f in os.listdir(target_dir):
+                for suffix in EXTENSION_SUFFIXES:
+                    if f.endswith(suffix):
+                        # use the first matching extension
+                        prev_file = os.path.join(target_dir, f)
+                        prev_name = f[:-len(suffix)]
+                        break
+                else:
+                    # no match, try next file
+                    continue
+                if os.path.getmtime(filename) <= os.path.getmtime(prev_file):
                     # We do not have to rebuild.
-                    return prev_so[:-len(loadable_module_extension())], target_dir
+                    return prev_name, target_dir
 
         # Delete all ordinary files in target_dir
         for F in os.listdir(target_dir):
@@ -410,9 +417,11 @@ def cython(filename, verbose=0, compile_message=False,
 
     if create_local_so_file:
         # Copy module to current directory
-        from sage.misc.sageinspect import loadable_module_extension
-        shutil.copy(os.path.join(target_dir, name + loadable_module_extension()),
-                    os.curdir)
+        from importlib.machinery import EXTENSION_SUFFIXES
+        for ext in EXTENSION_SUFFIXES:
+            path = os.path.join(target_dir, name + ext)
+            if os.path.exists(path):
+                shutil.copy(path, os.curdir)
 
     return name, target_dir
 
```

Notes:
- The option `use_cache` is only used in `sage.repl.load.load_cython()` and I'm not sure there's any doctest that will run this code.
- The option `create_local_so_file` is not used anywhere, and it's not doctested.
- If both options are given together and the compiled .so file is found in cache, it will //not// save a copy in the current directory (seems to be a bug).
----
New commits:



---

archive/issue_comments_474814.json:
```json
{
    "body": "Follow-up in #33636, since the change in `cython()` is more complicated, affects untested code, and it's not urgent.\n\nThe changes in this ticket seem very simple and clear, are doctested, and fix actual issues.",
    "created_at": "2022-04-03T12:32:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33389#issuecomment-474814",
    "user": "https://github.com/tornaria"
}
```

Follow-up in #33636, since the change in `cython()` is more complicated, affects untested code, and it's not urgent.

The changes in this ticket seem very simple and clear, are doctested, and fix actual issues.



---

archive/issue_comments_474815.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2022-04-03T12:32:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33389#issuecomment-474815",
    "user": "https://github.com/tornaria"
}
```

Changing priority from major to critical.



---

archive/issue_comments_474816.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-04-03T16:08:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33389#issuecomment-474816",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_474817.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-04-09T20:59:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33389#issuecomment-474817",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_030179.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2022-04-09T20:59:30Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33389",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33389#event-30179"
}
```
