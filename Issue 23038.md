# Issue 23038: Bipartite graphs should not accept loops

archive/issues_023038.json:
```json
{
    "body": "CC:  @tscrim zgershkoff\n\nLoops should not be allowed in a bipartite graph, but we can currently do:\n\n```\nsage: B = BipartiteGraph(loops=True, multiedges=True)\nsage: B.add_edge(0, 0)\nsage: B.is_bipartite()\nFalse\nsage: B.add_edge(1, 1)\nsage: B.add_edge(2, 2)\nsage: B.edges(labels=0)\n[(0, 0), (1, 1), (2, 2)]\nsage: B.add_edge(0, 1, 'a')\n---------------------------------------------------------------------------\nRuntimeError                              Traceback (most recent call last)\n...\nRuntimeError: Edge vertices must lie in different partitions.\nsage: B.add_edge(3, 3)\nsage: B.edges()\n[(0, 0, None), (1, 1, None), (2, 2, None), (3, 3, None)]\n```\n\nWhen adding edges in a different order, the behavior is more consistent.\n\n```\nsage: B = BipartiteGraph(loops=True, multiedges=True)\nsage: B.add_edge(0, 1, 'a')\nsage: B.add_edge(0, 1, 'b')\nsage: B.is_bipartite()\nTrue\nsage: B.add_edge(0,0)\n---------------------------------------------------------------------------\nRuntimeError                              Traceback (most recent call last)\n...\nRuntimeError: Edge vertices must lie in different partitions.\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/23275\n\n",
    "created_at": "2017-06-19T06:51:56Z",
    "labels": [
        "graph theory",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "Bipartite graphs should not accept loops",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23038",
    "user": "@dcoudert"
}
```
CC:  @tscrim zgershkoff

Loops should not be allowed in a bipartite graph, but we can currently do:

```
sage: B = BipartiteGraph(loops=True, multiedges=True)
sage: B.add_edge(0, 0)
sage: B.is_bipartite()
False
sage: B.add_edge(1, 1)
sage: B.add_edge(2, 2)
sage: B.edges(labels=0)
[(0, 0), (1, 1), (2, 2)]
sage: B.add_edge(0, 1, 'a')
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
...
RuntimeError: Edge vertices must lie in different partitions.
sage: B.add_edge(3, 3)
sage: B.edges()
[(0, 0, None), (1, 1, None), (2, 2, None), (3, 3, None)]
```

When adding edges in a different order, the behavior is more consistent.

```
sage: B = BipartiteGraph(loops=True, multiedges=True)
sage: B.add_edge(0, 1, 'a')
sage: B.add_edge(0, 1, 'b')
sage: B.is_bipartite()
True
sage: B.add_edge(0,0)
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
...
RuntimeError: Edge vertices must lie in different partitions.
```


Issue created by migration from https://trac.sagemath.org/ticket/23275





---

archive/issue_comments_322212.json:
```json
{
    "body": "I don't know which is the best place to forbid loops in `BipartiteGraph`. Any advise is more than welcome.",
    "created_at": "2017-06-19T06:58:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23038#issuecomment-322212",
    "user": "@dcoudert"
}
```

I don't know which is the best place to forbid loops in `BipartiteGraph`. Any advise is more than welcome.



---

archive/issue_comments_322213.json:
```json
{
    "body": "I did some trials and I discovered hidden issues in the `Graph` constructor like: `self.allow_loops(loops if loops else False, check=False)` and `self.allow_loops(False if loops is False else True, check=False)`, but the default value of `loops` is `None` ...\n\nDon't know what to do :(",
    "created_at": "2017-06-19T16:59:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23038#issuecomment-322213",
    "user": "@dcoudert"
}
```

I did some trials and I discovered hidden issues in the `Graph` constructor like: `self.allow_loops(loops if loops else False, check=False)` and `self.allow_loops(False if loops is False else True, check=False)`, but the default value of `loops` is `None` ...

Don't know what to do :(



---

archive/issue_comments_322214.json:
```json
{
    "body": "Replying to [comment:2 dcoudert]:\n> I did some trials and I discovered hidden issues in the `Graph` constructor like: `self.allow_loops(loops if loops else False, check=False)` and `self.allow_loops(False if loops is False else True, check=False)`, but the default value of `loops` is `None` ...\n> \n> Don't know what to do :(\nA bit of reading suggests that this is intentional behavior on the `graph6` and `sparse6` data types, respectively. Makes me wish the code were commented better. https://users.cecs.anu.edu.au/~bdm/data/formats.txt\n\nFor bipartite graphs, the offending code that adds loops is\n\n```\n        if self.left.issuperset((u, v)) or self.right.issuperset((u, v)):\n            raise RuntimeError(\n                \"Edge vertices must lie in different partitions.\")\n```\n\nbecause if `u` is `v` and it's a new vertex, it won't notice that it's making a loop. But loops should be disallowed before this code is reached.\n\nSo `__init__` should definitely have loops turned off, and maybe bipartite_graph.py should have an override for `allow_loops()` that just raises an error. A user determined to break it could go around and call the `Graph` method to enable loops, so maybe have a check in generic_graph.py, like\n\n\n```\n    def allow_loops(self, new, check=True):\n        if isinstance(BipartiteGraph):\n            raise ...\n```\n\nBut that might be overreaching.",
    "created_at": "2017-06-19T21:42:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23038#issuecomment-322214",
    "user": "zgershkoff"
}
```

Replying to [comment:2 dcoudert]:
> I did some trials and I discovered hidden issues in the `Graph` constructor like: `self.allow_loops(loops if loops else False, check=False)` and `self.allow_loops(False if loops is False else True, check=False)`, but the default value of `loops` is `None` ...
> 
> Don't know what to do :(
A bit of reading suggests that this is intentional behavior on the `graph6` and `sparse6` data types, respectively. Makes me wish the code were commented better. https://users.cecs.anu.edu.au/~bdm/data/formats.txt

For bipartite graphs, the offending code that adds loops is

```
        if self.left.issuperset((u, v)) or self.right.issuperset((u, v)):
            raise RuntimeError(
                "Edge vertices must lie in different partitions.")
```

because if `u` is `v` and it's a new vertex, it won't notice that it's making a loop. But loops should be disallowed before this code is reached.

So `__init__` should definitely have loops turned off, and maybe bipartite_graph.py should have an override for `allow_loops()` that just raises an error. A user determined to break it could go around and call the `Graph` method to enable loops, so maybe have a check in generic_graph.py, like


```
    def allow_loops(self, new, check=True):
        if isinstance(BipartiteGraph):
            raise ...
```

But that might be overreaching.



---

archive/issue_comments_322215.json:
```json
{
    "body": "> A bit of reading suggests that this is intentional behavior on the `graph6` and `sparse6` data types, respectively. Makes me wish the code were commented better. https://users.cecs.anu.edu.au/~bdm/data/formats.txt\n\nI fully agree. The graph module is one of the best of sagemath for the quality of its documentation, but it's not enough. An effort was started here #19477 but not finalized.\n\n  \n\n> So `__init__` should definitely have loops turned off, and maybe bipartite_graph.py should have an override for `allow_loops()` that just raises an error. A user determined to break it could go around and call the `Graph` method to enable loops, so maybe have a check in generic_graph.py, like\n> \n> {{{\n>     def allow_loops(self, new, check=True):\n>         if isinstance(BipartiteGraph):\n>             raise ...\n> }}}\n> But that might be overreaching.\nI was thinking to implement something like that.\n\nOne of my concern is the use of `**argv` in `__init__`. One possibility is to \n- explicitly list authorized parameters, so not listing `loops`\n- explicitly set `loops=False` in all calls to other constructors\n- set the loops flag to `False`\n- rewrite `self.allow_loops` to forbid `self.allow_loops(True)`. It would be better to remove methods from the class, but I don't know how to do that.",
    "created_at": "2017-06-20T06:44:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23038#issuecomment-322215",
    "user": "@dcoudert"
}
```

> A bit of reading suggests that this is intentional behavior on the `graph6` and `sparse6` data types, respectively. Makes me wish the code were commented better. https://users.cecs.anu.edu.au/~bdm/data/formats.txt

I fully agree. The graph module is one of the best of sagemath for the quality of its documentation, but it's not enough. An effort was started here #19477 but not finalized.

  

> So `__init__` should definitely have loops turned off, and maybe bipartite_graph.py should have an override for `allow_loops()` that just raises an error. A user determined to break it could go around and call the `Graph` method to enable loops, so maybe have a check in generic_graph.py, like
> 
> {{{
>     def allow_loops(self, new, check=True):
>         if isinstance(BipartiteGraph):
>             raise ...
> }}}
> But that might be overreaching.
I was thinking to implement something like that.

One of my concern is the use of `**argv` in `__init__`. One possibility is to 
- explicitly list authorized parameters, so not listing `loops`
- explicitly set `loops=False` in all calls to other constructors
- set the loops flag to `False`
- rewrite `self.allow_loops` to forbid `self.allow_loops(True)`. It would be better to remove methods from the class, but I don't know how to do that.



---

archive/issue_comments_322216.json:
```json
{
    "body": "This fixes some of the issues but it's neither a smart solution nor a complete fix.\n\nIndeed, the following example should raises an error and not silently remove loops, no ?\n\n```\nsage: G = Graph([(0, 0), (0, 1), (1, 1)], loops=True)\nsage: B = BipartiteGraph(G)\nsage: B.edges(labels=0)\n[(0, 1)]\n```\n\nAt least, we can't add loops.\n\n```\nsage: sage: B.add_edge(0,0)\n---------------------------------------------------------------------------\nRuntimeError                              Traceback (most recent call last)\n...\nRuntimeError: Edge vertices must lie in different partitions.\n```\n\n----\nNew commits:",
    "created_at": "2017-06-20T09:22:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23038#issuecomment-322216",
    "user": "@dcoudert"
}
```

This fixes some of the issues but it's neither a smart solution nor a complete fix.

Indeed, the following example should raises an error and not silently remove loops, no ?

```
sage: G = Graph([(0, 0), (0, 1), (1, 1)], loops=True)
sage: B = BipartiteGraph(G)
sage: B.edges(labels=0)
[(0, 1)]
```

At least, we can't add loops.

```
sage: sage: B.add_edge(0,0)
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
...
RuntimeError: Edge vertices must lie in different partitions.
```

----
New commits:



---

archive/issue_comments_322217.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-06-20T09:22:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23038#issuecomment-322217",
    "user": "@dcoudert"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_322218.json:
```json
{
    "body": "anyone to review ?",
    "created_at": "2017-07-07T03:49:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23038#issuecomment-322218",
    "user": "@dcoudert"
}
```

anyone to review ?



---

archive/issue_comments_322219.json:
```json
{
    "body": "It does what it says it does, although I should note that the module can still be fooled into accepting loops.\n\n\n```\nsage: B = BipartiteGraph()\nsage: Graph.allow_loops(B, True)\nsage: B.add_edge(0,0)\nsage: B.is_bipartite()\nFalse\n```\n",
    "created_at": "2017-09-02T21:46:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23038#issuecomment-322219",
    "user": "zgershkoff"
}
```

It does what it says it does, although I should note that the module can still be fooled into accepting loops.


```
sage: B = BipartiteGraph()
sage: Graph.allow_loops(B, True)
sage: B.add_edge(0,0)
sage: B.is_bipartite()
False
```




---

archive/issue_comments_322220.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-09-02T21:46:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23038#issuecomment-322220",
    "user": "zgershkoff"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_322221.json:
```json
{
    "body": "To avoid that, we should make a backend\n\n```\nsage: B = BipartiteGraph()\nsage: B._backend\n<type 'sage.graphs.base.sparse_graph.SparseGraphBackend'>\n```\n\nThe method `Graph.allow_loops(B, True)` calls `B._backend.loops(True)`.",
    "created_at": "2017-09-03T16:35:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23038#issuecomment-322221",
    "user": "@dcoudert"
}
```

To avoid that, we should make a backend

```
sage: B = BipartiteGraph()
sage: B._backend
<type 'sage.graphs.base.sparse_graph.SparseGraphBackend'>
```

The method `Graph.allow_loops(B, True)` calls `B._backend.loops(True)`.



---

archive/issue_comments_322222.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-09-10T11:57:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23038#issuecomment-322222",
    "user": "@vbraun"
}
```

Resolution: fixed
